<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #55736 for DBD-ODBC: selectcol_arrayref&#40;&#41; fails with SQL-HY104 against SQL Server 2000 &#40;Invalid precision value&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #55736 for DBD-ODBC: selectcol_arrayref&#40;&#41; fails with SQL-HY104 against SQL Server 2000 &#40;Invalid precision value&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-ODBC/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-ODBC/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-ODBC/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-ODBC/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-ODBC">DBD-ODBC CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">55736</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-ODBC/Active/">DBD-ODBC</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bitcard_kiddm [...] ghctechnologies.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-10188-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.23    </td>
  </tr>
  <tr id="CF-10189-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.24    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




odbc-1.22.log<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/752052/388837/odbc-1.22.log">
Tue Mar 23 12:28:11 2010 (14.3k) by bitcard_kiddm [...] ghctechnologies.com
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/751489/388558/odbc-1.22.log">
Mon Mar 22 16:43:31 2010 (8.3k) by bitcard_kiddm [...] ghctechnologies.com
</a>
</font></li>
</ul>


odbc-1.23.log<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/752052/388836/odbc-1.23.log">
Tue Mar 23 12:28:11 2010 (13.2k) by bitcard_kiddm [...] ghctechnologies.com
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/751489/388557/odbc-1.23.log">
Mon Mar 22 16:43:31 2010 (8.3k) by bitcard_kiddm [...] ghctechnologies.com
</a>
</font></li>
</ul>


odbc-1.23_2-patched.log<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/752474/389046/odbc-1.23_2-patched.log">
Wed Mar 24 02:05:53 2010 (13.3k) by matthew.kidd [...] ghctechnologies.com
</a>
</font></li>
</ul>


odbc-1.23_2-patched2.log<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/752474/389047/odbc-1.23_2-patched2.log">
Wed Mar 24 02:05:53 2010 (13.3k) by matthew.kidd [...] ghctechnologies.com
</a>
</font></li>
</ul>


odbc-1.23_2-patched3.log<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/752837/389252/odbc-1.23_2-patched3.log">
Wed Mar 24 14:17:10 2010 (14.3k) by bitcard_kiddm [...] ghctechnologies.com
</a>
</font></li>
</ul>


odbc-1.23_2.log<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/752474/389045/odbc-1.23_2.log">
Wed Mar 24 02:05:52 2010 (13.2k) by matthew.kidd [...] ghctechnologies.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;20&nbsp;03:58:07&nbsp;2010</span>
    <span class="description">bitcard_kiddm [...] ghctechnologies.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> selectcol_arrayref&#40;&#41; fails with SQL-HY104 against SQL Server 2000
 &#40;Invalid precision value&#41;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">selectcol_arrayref&#40;&#41; fails with Invalid precision value &#40;SQL-HY104&#41;
against SQL Server 2000 for certain queries. The initial query that
showed the problem was quite complex. I was able to simply it down to
the following code though upon further simplification &#40;say just the
inner query&#41; the bug disappeared.

my $dbh = DBI-&gt;connect&#40;&#34;dbi:ODBC:testdb&#34;, &#39;&#39;, &#39;&#39;, 
  {AutoCommit =&gt; 1, RaiseError =&gt; 0} &#41;;
if &#40;!defined&#40;$dbh&#41;&#41; { die &#34;Unable to connect to database.&#34;; }
my $sql = &lt;&lt;&#39;DONE&#39;;
  select top 1 st_id from st_name
  where st_specificity = &#39;acc&#39;
  and st_parent_id = &#40;
    select top 1 st_id from st_name
    where st_specificity = &#39;taxon&#39; and st_name = ?
  &#41;
DONE

my $p = $dbh-&gt;selectcol_arrayref&#40;$sql, undef, &#39;Blahblahblahblah&#39;&#41;;

FWIW, the st_name.st_name column is a varchar&#40;64&#41; and I am binding a
string &#40;shorter than 64 characters&#41; to it when it fails. The _id columns
are all integer primary keys. The database is big and it would be some
effort to strip things down further though if it were needed for further
troubleshooting I might be able to construct a complete example, i.e.
with table creation and population statements demonstrating the problem.

I am seeing this problem under ActivePerl 5.10 &#40;both builds 1005 and
1007&#41; running on XP SP3 boxes, fully patched. I do not see this issue
using DBD-ODBC 1.16 package that ships with the 1005 build when I remove
the 1.23 site version. Also I downloaded 1.22 from CPAN and manually
compiled and installed it in the site library and again do not see the
problem. It seems to be a new problem in the 1.23 version.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;21&nbsp;13:22:51&nbsp;2010</span>
    <span class="description">bitcard_kiddm [...] ghctechnologies.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bitcard_kiddm [...] ghctechnologies.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Mar 20 03:58:07 2010, kiddm wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; selectcol_arrayref&#40;&#41; fails with Invalid precision value &#40;SQL-HY104&#41;
&gt; against SQL Server 2000 for certain queries. The initial query that
&gt; showed the problem was quite complex. I was able to simply it down to
&gt; the following code though upon further simplification &#40;say just the
&gt; inner query&#41; the bug disappeared.
&gt; 
&gt; my $dbh = DBI-&gt;connect&#40;&#34;dbi:ODBC:testdb&#34;, &#39;&#39;, &#39;&#39;, 
&gt;   {AutoCommit =&gt; 1, RaiseError =&gt; 0} &#41;;
&gt; if &#40;!defined&#40;$dbh&#41;&#41; { die &#34;Unable to connect to database.&#34;; }
&gt; my $sql = &lt;&lt;&#39;DONE&#39;;
&gt;   select top 1 st_id from st_name
&gt;   where st_specificity = &#39;acc&#39;
&gt;   and st_parent_id = &#40;
&gt;     select top 1 st_id from st_name
&gt;     where st_specificity = &#39;taxon&#39; and st_name = ?
&gt;   &#41;
&gt; DONE
&gt; 
&gt; my $p = $dbh-&gt;selectcol_arrayref&#40;$sql, undef, &#39;Blahblahblahblah&#39;&#41;;
&gt; 
&gt; FWIW, the st_name.st_name column is a varchar&#40;64&#41; and I am binding a
&gt; string &#40;shorter than 64 characters&#41; to it when it fails. The _id columns
&gt; are all integer primary keys. The database is big and it would be some
&gt; effort to strip things down further though if it were needed for further
&gt; troubleshooting I might be able to construct a complete example, i.e.
&gt; with table creation and population statements demonstrating the problem.
&gt; 
&gt; I am seeing this problem under ActivePerl 5.10 &#40;both builds 1005 and
&gt; 1007&#41; running on XP SP3 boxes, fully patched. I do not see this issue
&gt; using DBD-ODBC 1.16 package that ships with the 1005 build when I remove
&gt; the 1.23 site version. Also I downloaded 1.22 from CPAN and manually
&gt; compiled and installed it in the site library and again do not see the
&gt; problem. It seems to be a new problem in the 1.23 version.
</div>
Further investigation reveals that the bug is not seen if a bind
variable is not used, i.e. the string is simply made part of the SQL
statement. In my specific test case &#39;Blahblahblahblah&#39; is 22 characters
long though a similar failure is observed with strings of slightly
different length.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;22&nbsp;05:14:50&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Mar 21 13:22:51 2010, kiddm wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sat Mar 20 03:58:07 2010, kiddm wrote:
<div class="message-stanza open">&gt; &gt; selectcol_arrayref&#40;&#41; fails with Invalid precision value &#40;SQL-HY104&#41;
&gt; &gt; against SQL Server 2000 for certain queries. The initial query that
&gt; &gt; showed the problem was quite complex. I was able to simply it down to
&gt; &gt; the following code though upon further simplification &#40;say just the
&gt; &gt; inner query&#41; the bug disappeared.
&gt; &gt; 
&gt; &gt; my $dbh = DBI-&gt;connect&#40;&#34;dbi:ODBC:testdb&#34;, &#39;&#39;, &#39;&#39;, 
&gt; &gt;   {AutoCommit =&gt; 1, RaiseError =&gt; 0} &#41;;
&gt; &gt; if &#40;!defined&#40;$dbh&#41;&#41; { die &#34;Unable to connect to database.&#34;; }
&gt; &gt; my $sql = &lt;&lt;&#39;DONE&#39;;
&gt; &gt;   select top 1 st_id from st_name
&gt; &gt;   where st_specificity = &#39;acc&#39;
&gt; &gt;   and st_parent_id = &#40;
&gt; &gt;     select top 1 st_id from st_name
&gt; &gt;     where st_specificity = &#39;taxon&#39; and st_name = ?
&gt; &gt;   &#41;
&gt; &gt; DONE
&gt; &gt; 
&gt; &gt; my $p = $dbh-&gt;selectcol_arrayref&#40;$sql, undef, &#39;Blahblahblahblah&#39;&#41;;
&gt; &gt; 
&gt; &gt; FWIW, the st_name.st_name column is a varchar&#40;64&#41; and I am binding a
&gt; &gt; string &#40;shorter than 64 characters&#41; to it when it fails. The _id columns
&gt; &gt; are all integer primary keys. The database is big and it would be some
&gt; &gt; effort to strip things down further though if it were needed for further
&gt; &gt; troubleshooting I might be able to construct a complete example, i.e.
&gt; &gt; with table creation and population statements demonstrating the problem.
&gt; &gt; 
&gt; &gt; I am seeing this problem under ActivePerl 5.10 &#40;both builds 1005 and
&gt; &gt; 1007&#41; running on XP SP3 boxes, fully patched. I do not see this issue
&gt; &gt; using DBD-ODBC 1.16 package that ships with the 1005 build when I remove
&gt; &gt; the 1.23 site version. Also I downloaded 1.22 from CPAN and manually
&gt; &gt; compiled and installed it in the site library and again do not see the
&gt; &gt; problem. It seems to be a new problem in the 1.23 version.
</div>&gt; 
&gt; Further investigation reveals that the bug is not seen if a bind
&gt; variable is not used, i.e. the string is simply made part of the SQL
&gt; statement. In my specific test case &#39;Blahblahblahblah&#39; is 22 characters
&gt; long though a similar failure is observed with strings of slightly
&gt; different length.
</div>
Hi,

The likely problem is that SQL Server was unable to turn your SQL into
the SQL required to obtain parameter information. SQL Server supports
SQLDescribeParam rather poorly in some case. It takes your SQL and
attempts to turn it into SQL which would select the columns equivalent
to your parameters. If you run your code and watch SQL Server you will
see the SQL submitted and I&#39;m guessing it will be wrong.

The easy way to workaround this is to specify SL_VARCHAR in the
bind_param call &#40;see TYPE&#41;.

However, I&#39;ve seen a couple of people saying something changed between
1.22 and 1.23 that may have caused an issue but never managed to get
anyone to help dig into it. Could you run you code against 1.23 with
logging turned on and post the log? It would also be really useful to
repeat with 1.22. You can enable logging by doing this:

Add the following to the top of your script:

use DBD::ODBC;
DBI-&gt;trace&#40;DBD::ODBC-&gt;parse_trace_flags&#40;&#39;odbcconnection|odbcunicode&#39;&#41;&#41;;

set DBI_TRACE=15=x.log. See
<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~mjevans/DBD-ODBC-1.23/ODBC.pm#Tracing">http://search.cpan.org/~mjevans/DBD-ODBC-1.23/ODBC.pm#Tracing</a></span> and
<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~timb/DBI-1.609/DBI.pm#TRACING">http://search.cpan.org/~timb/DBI-1.609/DBI.pm#TRACING</a></span>.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;22&nbsp;05:14:51&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;22&nbsp;16:43:31&nbsp;2010</span>
    <span class="description">bitcard_kiddm [...] ghctechnologies.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bitcard_kiddm [...] ghctechnologies.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Mar 22 05:14:50 2010, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun Mar 21 13:22:51 2010, kiddm wrote:
<div class="message-stanza open">&gt; &gt; On Sat Mar 20 03:58:07 2010, kiddm wrote:
<div class="message-stanza open">&gt; &gt; &gt; selectcol_arrayref&#40;&#41; fails with Invalid precision value &#40;SQL-HY104&#41;
&gt; &gt; &gt; against SQL Server 2000 for certain queries. The initial query that
&gt; &gt; &gt; showed the problem was quite complex. I was able to simply it down to
&gt; &gt; &gt; the following code though upon further simplification &#40;say just the
&gt; &gt; &gt; inner query&#41; the bug disappeared.
&gt; &gt; &gt; 
&gt; &gt; &gt; my $dbh = DBI-&gt;connect&#40;&#34;dbi:ODBC:testdb&#34;, &#39;&#39;, &#39;&#39;, 
&gt; &gt; &gt;   {AutoCommit =&gt; 1, RaiseError =&gt; 0} &#41;;
&gt; &gt; &gt; if &#40;!defined&#40;$dbh&#41;&#41; { die &#34;Unable to connect to database.&#34;; }
&gt; &gt; &gt; my $sql = &lt;&lt;&#39;DONE&#39;;
&gt; &gt; &gt;   select top 1 st_id from st_name
&gt; &gt; &gt;   where st_specificity = &#39;acc&#39;
&gt; &gt; &gt;   and st_parent_id = &#40;
&gt; &gt; &gt;     select top 1 st_id from st_name
&gt; &gt; &gt;     where st_specificity = &#39;taxon&#39; and st_name = ?
&gt; &gt; &gt;   &#41;
&gt; &gt; &gt; DONE
&gt; &gt; &gt; 
&gt; &gt; &gt; my $p = $dbh-&gt;selectcol_arrayref&#40;$sql, undef, &#39;Blahblahblahblah&#39;&#41;;
&gt; &gt; &gt; 
&gt; &gt; &gt; FWIW, the st_name.st_name column is a varchar&#40;64&#41; and I am binding a
&gt; &gt; &gt; string &#40;shorter than 64 characters&#41; to it when it fails. The _id
</div></div></div>columns
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; &gt; are all integer primary keys. The database is big and it would be some
&gt; &gt; &gt; effort to strip things down further though if it were needed for
</div></div>further
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; &gt; troubleshooting I might be able to construct a complete example, i.e.
&gt; &gt; &gt; with table creation and population statements demonstrating the
</div></div>problem.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; &gt; 
&gt; &gt; &gt; I am seeing this problem under ActivePerl 5.10 &#40;both builds 1005 and
&gt; &gt; &gt; 1007&#41; running on XP SP3 boxes, fully patched. I do not see this issue
&gt; &gt; &gt; using DBD-ODBC 1.16 package that ships with the 1005 build when I
</div></div>remove
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; the 1.23 site version. Also I downloaded 1.22 from CPAN and manually
&gt; &gt; &gt; compiled and installed it in the site library and again do not see the
&gt; &gt; &gt; problem. It seems to be a new problem in the 1.23 version.
</div>&gt; &gt; 
&gt; &gt; Further investigation reveals that the bug is not seen if a bind
&gt; &gt; variable is not used, i.e. the string is simply made part of the SQL
&gt; &gt; statement. In my specific test case &#39;Blahblahblahblah&#39; is 22 characters
&gt; &gt; long though a similar failure is observed with strings of slightly
&gt; &gt; different length.
</div>&gt; 
&gt; Hi,
&gt; 
&gt; The likely problem is that SQL Server was unable to turn your SQL into
&gt; the SQL required to obtain parameter information. SQL Server supports
&gt; SQLDescribeParam rather poorly in some case. It takes your SQL and
&gt; attempts to turn it into SQL which would select the columns equivalent
&gt; to your parameters. If you run your code and watch SQL Server you will
&gt; see the SQL submitted and I&#39;m guessing it will be wrong.
&gt; 
&gt; The easy way to workaround this is to specify SQL_VARCHAR in the
&gt; bind_param call &#40;see TYPE&#41;.
&gt; 
&gt; However, I&#39;ve seen a couple of people saying something changed between
&gt; 1.22 and 1.23 that may have caused an issue but never managed to get
&gt; anyone to help dig into it. Could you run you code against 1.23 with
&gt; logging turned on and post the log? It would also be really useful to
&gt; repeat with 1.22. You can enable logging by doing this:
&gt; 
&gt; Add the following to the top of your script:
&gt; 
&gt; use DBD::ODBC;
&gt; DBI-&gt;trace&#40;DBD::ODBC-&gt;parse_trace_flags&#40;&#39;odbcconnection|odbcunicode&#39;&#41;&#41;;
&gt; 
&gt; set DBI_TRACE=15=x.log. See
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~mjevans/DBD-ODBC-1.23/ODBC.pm#Tracing">http://search.cpan.org/~mjevans/DBD-ODBC-1.23/ODBC.pm#Tracing</a></span> and
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~timb/DBI-1.609/DBI.pm#TRACING">http://search.cpan.org/~timb/DBI-1.609/DBI.pm#TRACING</a></span>.
&gt; 
&gt; Martin
</div>
As you suspected, explicitly setting the data type to SQL_VARCHAR via
the bind_param&#40;&#41; method does solve the problem.

I also generated the trace logs &#40;attached&#41; for both 1.22 and 1.23 when
the binding is not done, i.e. when version 1.23 shows the bug. diff
shows the files to be very similar.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> odbc-1.23.log</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/751489/388557/odbc-1.23.log">Download odbc-1.23.log</a><br />
<span class="downloadcontenttype">application/octet-stream 8.3k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> odbc-1.22.log</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/751489/388558/odbc-1.22.log">Download odbc-1.22.log</a><br />
<span class="downloadcontenttype">application/octet-stream 8.3k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;22&nbsp;17:49:38&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Mar 22 16:43:31 2010, kiddm wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Mar 22 05:14:50 2010, MJEVANS wrote:
<div class="message-stanza open">&gt; &gt; On Sun Mar 21 13:22:51 2010, kiddm wrote:
<div class="message-stanza open">&gt; &gt; &gt; On Sat Mar 20 03:58:07 2010, kiddm wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; selectcol_arrayref&#40;&#41; fails with Invalid precision value &#40;SQL-HY104&#41;
&gt; &gt; &gt; &gt; against SQL Server 2000 for certain queries. The initial query that
&gt; &gt; &gt; &gt; showed the problem was quite complex. I was able to simply it
</div></div></div></div>down to
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; &gt; &gt; the following code though upon further simplification &#40;say just the
&gt; &gt; &gt; &gt; inner query&#41; the bug disappeared.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; my $dbh = DBI-&gt;connect&#40;&#34;dbi:ODBC:testdb&#34;, &#39;&#39;, &#39;&#39;, 
&gt; &gt; &gt; &gt;   {AutoCommit =&gt; 1, RaiseError =&gt; 0} &#41;;
&gt; &gt; &gt; &gt; if &#40;!defined&#40;$dbh&#41;&#41; { die &#34;Unable to connect to database.&#34;; }
&gt; &gt; &gt; &gt; my $sql = &lt;&lt;&#39;DONE&#39;;
&gt; &gt; &gt; &gt;   select top 1 st_id from st_name
&gt; &gt; &gt; &gt;   where st_specificity = &#39;acc&#39;
&gt; &gt; &gt; &gt;   and st_parent_id = &#40;
&gt; &gt; &gt; &gt;     select top 1 st_id from st_name
&gt; &gt; &gt; &gt;     where st_specificity = &#39;taxon&#39; and st_name = ?
&gt; &gt; &gt; &gt;   &#41;
&gt; &gt; &gt; &gt; DONE
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; my $p = $dbh-&gt;selectcol_arrayref&#40;$sql, undef, &#39;Blahblahblahblah&#39;&#41;;
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; FWIW, the st_name.st_name column is a varchar&#40;64&#41; and I am binding a
&gt; &gt; &gt; &gt; string &#40;shorter than 64 characters&#41; to it when it fails. The _id
</div>&gt; columns
<div class="message-stanza open">&gt; &gt; &gt; &gt; are all integer primary keys. The database is big and it would
</div></div>be some
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; &gt; &gt; effort to strip things down further though if it were needed for
</div>&gt; further
<div class="message-stanza open">&gt; &gt; &gt; &gt; troubleshooting I might be able to construct a complete example,
</div></div>i.e.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; &gt; &gt; with table creation and population statements demonstrating the
</div>&gt; problem.
<div class="message-stanza open">&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; I am seeing this problem under ActivePerl 5.10 &#40;both builds 1005 and
&gt; &gt; &gt; &gt; 1007&#41; running on XP SP3 boxes, fully patched. I do not see this
</div></div>issue
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; &gt; &gt; using DBD-ODBC 1.16 package that ships with the 1005 build when I
</div>&gt; remove
<div class="message-stanza open">&gt; &gt; &gt; &gt; the 1.23 site version. Also I downloaded 1.22 from CPAN and manually
&gt; &gt; &gt; &gt; compiled and installed it in the site library and again do not
</div></div>see the
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; problem. It seems to be a new problem in the 1.23 version.
</div>&gt; &gt; &gt; 
&gt; &gt; &gt; Further investigation reveals that the bug is not seen if a bind
&gt; &gt; &gt; variable is not used, i.e. the string is simply made part of the SQL
&gt; &gt; &gt; statement. In my specific test case &#39;Blahblahblahblah&#39; is 22
</div></div>characters
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; long though a similar failure is observed with strings of slightly
&gt; &gt; &gt; different length.
</div>&gt; &gt; 
&gt; &gt; Hi,
&gt; &gt; 
&gt; &gt; The likely problem is that SQL Server was unable to turn your SQL into
&gt; &gt; the SQL required to obtain parameter information. SQL Server supports
&gt; &gt; SQLDescribeParam rather poorly in some case. It takes your SQL and
&gt; &gt; attempts to turn it into SQL which would select the columns equivalent
&gt; &gt; to your parameters. If you run your code and watch SQL Server you will
&gt; &gt; see the SQL submitted and I&#39;m guessing it will be wrong.
&gt; &gt; 
&gt; &gt; The easy way to workaround this is to specify SQL_VARCHAR in the
&gt; &gt; bind_param call &#40;see TYPE&#41;.
&gt; &gt; 
&gt; &gt; However, I&#39;ve seen a couple of people saying something changed between
&gt; &gt; 1.22 and 1.23 that may have caused an issue but never managed to get
&gt; &gt; anyone to help dig into it. Could you run you code against 1.23 with
&gt; &gt; logging turned on and post the log? It would also be really useful to
&gt; &gt; repeat with 1.22. You can enable logging by doing this:
&gt; &gt; 
&gt; &gt; Add the following to the top of your script:
&gt; &gt; 
&gt; &gt; use DBD::ODBC;
&gt; &gt; DBI-&gt;trace&#40;DBD::ODBC-&gt;parse_trace_flags&#40;&#39;odbcconnection|odbcunicode&#39;&#41;&#41;;
&gt; &gt; 
&gt; &gt; set DBI_TRACE=15=x.log. See
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~mjevans/DBD-ODBC-1.23/ODBC.pm#Tracing">http://search.cpan.org/~mjevans/DBD-ODBC-1.23/ODBC.pm#Tracing</a></span> and
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~timb/DBI-1.609/DBI.pm#TRACING">http://search.cpan.org/~timb/DBI-1.609/DBI.pm#TRACING</a></span>.
&gt; &gt; 
&gt; &gt; Martin
</div>&gt; 
&gt; As you suspected, explicitly setting the data type to SQL_VARCHAR via
&gt; the bind_param&#40;&#41; method does solve the problem.
&gt; 
&gt; I also generated the trace logs &#40;attached&#41; for both 1.22 and 1.23 when
&gt; the binding is not done, i.e. when version 1.23 shows the bug. diff
&gt; shows the files to be very similar.
</div>
Thanks for the logs and I hope in the mean time you can continue by
specifying the bind type. We obviously have a time difference between us
&#40;it is 21:45 here now&#41;. I will look into the logs but please feel free
to email me and pester me if you do not hear from me in the next few
days. As you can appreciate maintaining DBD::ODBC is not something I&#39;m
paid for and so I have to do it when time permits outside of work. Not
withstanding that I would like to get to the bottom of the difference
between 1.22 and 1.23 and it is useful to have someone who is prepared
to submit the logs so I will try to look at this really soon &#40;before
your interest dies&#41;.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;23&nbsp;04:44:04&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Mar 22 16:43:31 2010, kiddm wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; As you suspected, explicitly setting the data type to SQL_VARCHAR via
&gt; the bind_param&#40;&#41; method does solve the problem.
&gt; 
&gt; I also generated the trace logs &#40;attached&#41; for both 1.22 and 1.23 when
&gt; the binding is not done, i.e. when version 1.23 shows the bug. diff
&gt; shows the files to be very similar.
</div>
It appears the log files were created without DBI_TRACE set.

You generally need to do:

export DBI_TRACE=15=x.log

then run your script.

On Windows I think this may be

set DBI_TRACE=15=x.log

or you need to set $h-&gt;{TraceLevel} = &#34;3|ALL&#34; after connect.

Any chance you could redo them. The files should end up a lot bigger
than the ones you previously submitted.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;23&nbsp;12:28:11&nbsp;2010</span>
    <span class="description">bitcard_kiddm [...] ghctechnologies.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bitcard_kiddm [...] ghctechnologies.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Mar 23 04:44:04 2010, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It appears the log files were created without DBI_TRACE set.
&gt; 
&gt; You generally need to do:
&gt; 
&gt; export DBI_TRACE=15=x.log
&gt; 
&gt; then run your script.
&gt; 
&gt; On Windows I think this may be
&gt; 
&gt; set DBI_TRACE=15=x.log
&gt; 
&gt; or you need to set $h-&gt;{TraceLevel} = &#34;3|ALL&#34; after connect.
&gt; 
&gt; Any chance you could redo them. The files should end up a lot bigger
&gt; than the ones you previously submitted.
&gt; 
&gt; Martin
</div>
I think the newly attached log files have what you need. When I diff
these files the thing that stands out to me is this line.

SQLBindParameter: idx=1: param_type=1, name=1, value_type=-8,
SQL_Type=-9, column_size=0, d_digits=0, value_ptr=3ddf92c,
buffer_length=44, cbValue=44, param_size=0

In DBD-ODBC 1.22, column_size=44, but in DBD-ODBC 1.23 column_size=0.

BTW, previously I did have the environment variable set
DBI_TRACE=15=x.log &#40;well actually DBI_TRACE=15=odbc.log, which shouldn&#39;t
make a difference?!&#41;. print $ENV{&#39;DBI_TRACE&#39;} shows that Perl is picking
it up properly. For whatever reason, I had to add $h-&gt;{TraceLevel} =
&#34;3|ALL&#34; to get the logging of the individual query requests. FWIW, it is
very strange to include an equals sign in the value of an environment
variable. Sure it is valid, but if nothing else it causes one to
reflexively think the documentation has an error. I wish the DBI package
author&#40;s&#41; has come up with a different convention.

As for the time shift, yes I am in California. But I have a fairly
strong interest in having DBD-ODBC &#40;and DBI&#41; work properly.

  - Matthew
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> odbc-1.23.log</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/752052/388836/odbc-1.23.log">Download odbc-1.23.log</a><br />
<span class="downloadcontenttype">application/octet-stream 13.2k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> odbc-1.22.log</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/752052/388837/odbc-1.22.log">Download odbc-1.22.log</a><br />
<span class="downloadcontenttype">application/octet-stream 14.3k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;23&nbsp;12:48:04&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Mar 23 12:28:11 2010, kiddm wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Mar 23 04:44:04 2010, MJEVANS wrote:
<div class="message-stanza open">&gt; &gt; It appears the log files were created without DBI_TRACE set.
&gt; &gt; 
&gt; &gt; You generally need to do:
&gt; &gt; 
&gt; &gt; export DBI_TRACE=15=x.log
&gt; &gt; 
&gt; &gt; then run your script.
&gt; &gt; 
&gt; &gt; On Windows I think this may be
&gt; &gt; 
&gt; &gt; set DBI_TRACE=15=x.log
&gt; &gt; 
&gt; &gt; or you need to set $h-&gt;{TraceLevel} = &#34;3|ALL&#34; after connect.
&gt; &gt; 
&gt; &gt; Any chance you could redo them. The files should end up a lot bigger
&gt; &gt; than the ones you previously submitted.
&gt; &gt; 
&gt; &gt; Martin
</div>&gt; 
&gt; I think the newly attached log files have what you need.
</div>
They do - thanks.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; When I diff
&gt; these files the thing that stands out to me is this line.
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; SQLBindParameter: idx=1: param_type=1, name=1, value_type=-8,
&gt; SQL_Type=-9, column_size=0, d_digits=0, value_ptr=3ddf92c,
&gt; buffer_length=44, cbValue=44, param_size=0
</div>
Yes, that is it.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In DBD-ODBC 1.22, column_size=44, but in DBD-ODBC 1.23 column_size=0.
&gt; 
&gt; BTW, previously I did have the environment variable set
&gt; DBI_TRACE=15=x.log &#40;well actually DBI_TRACE=15=odbc.log, which shouldn&#39;t
&gt; make a difference?!&#41;. print $ENV{&#39;DBI_TRACE&#39;} shows that Perl is picking
&gt; it up properly. For whatever reason, I had to add $h-&gt;{TraceLevel} =
&gt; &#34;3|ALL&#34; to get the logging of the individual query requests.
</div>
Don&#39;t understand why that was not working for you, I just retried it on
my windows machine and it works fine. DBD::ODBC is not responsible for
the logging, DBI is. BTW, 15 would have been better than 3 &#40;3 is
technically less detail&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; FWIW, it is
&gt; very strange to include an equals sign in the value of an environment
&gt; variable. Sure it is valid, but if nothing else it causes one to
&gt; reflexively think the documentation has an error. I wish the DBI package
&gt; author&#40;s&#41; has come up with a different convention.
</div>
First I&#39;ve heard anyone mention this.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; As for the time shift, yes I am in California. But I have a fairly
&gt; strong interest in having DBD-ODBC &#40;and DBI&#41; work properly.
&gt; 
&gt;   - Matthew
</div>
Will try and look at this properly tomorrow latest - unfortunately I&#39;m a
bit busy tonight.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;23&nbsp;13:08:05&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Matthew,

I presume you are ok to build a new DBD::ODBC from scratch. If you are
then I would like you to get DBD::ODBC 1.23_2 from CPAN then before
building it edit dbdimp.c to make the following changes:

Around about line 3523 it should look like this:

   if &#40;phs-&gt;param_size == 0&#41; {
       if &#40;&#40;imp_dbh-&gt;driver_type == DT_SQL_SERVER_NATIVE_CLIENT&#41; ||
           &#40;&#40;strcmp&#40;imp_dbh-&gt;odbc_dbms_name, &#34;Microsoft SQL Server&#34;&#41; ==
0&#41; &#38;&#38;
            &#40;phs-&gt;sql_type == SQL_WVARCHAR&#41; &#38;&#38;
            &#40;phs-&gt;requested_type == 0&#41;&#41;&#41; {
           column_size = 0;
   }

could you change it to:

   if &#40;phs-&gt;param_size == 0&#41; {
       if &#40;&#40;imp_dbh-&gt;driver_type == DT_SQL_SERVER_NATIVE_CLIENT&#41; ||
           &#40;&#40;strcmp&#40;imp_dbh-&gt;odbc_dbms_name, &#34;Microsoft SQL Server&#34;&#41; ==
0&#41; &#38;&#38;
            &#40;phs-&gt;sql_type == SQL_WVARCHAR&#41; &#38;&#38;
            &#40;phs-&gt;requested_type == 0&#41;&#41;&#41; {
           column_size = 0;
           /* start of lines added */
           if &#40;DBIc_TRACE&#40;imp_sth, 0, 0, 4&#41;&#41; {
               TRACE0&#40;imp_dbh,
                      &#34;    Resetting column_size to 0 for &#40;max&#41; column\n&#34;&#41;;
               TRACE1&#40;imp_dbh, &#34;    SQLDescribeParam returned %d\n&#34;,
                      phs-&gt;describe_param_status&#41;;
           }
           /* end of lines added */
       }
   }

Then if you rebuild, set tracing to 15 and run your script again does
the log file contain &#34;Resetting column_size to 0 for &#40;max&#41;&#34; and if so
what is the line output after that saying SQLDescribeParam returned NN.

If NN is not 0 try changing the &#34;if&#34; above from:

   if &#40;phs-&gt;param_size == 0&#41; {

to

   if &#40;&#40;phs-&gt;param_size == 0&#41; &#38;&#38;
       &#40;!SQL_SUCCEEDED&#40;phs-&gt;describe_param_status&#41;&#41;&#41; {

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;24&nbsp;02:05:52&nbsp;2010</span>
    <span class="description">matthew.kidd [...] ghctechnologies.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #55736] selectcol_arrayref&#40;&#41; fails with SQL-HY104 against SQL Server 2000 &#40;Invalid precision value&#41; </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 23 Mar 2010 23:05:36 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-DBD-ODBC [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Matthew Kidd&#34; &lt;matthew.kidd [...] ghctechnologies.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Martin,

The full story is in the log files &#40;tracing level at 15&#41;. The first file
is before applying your patch. The second is after applying the patch
and it shows that SQLDescribeParam returns -1. The final file is after
modifying the IF statement. It is essentially the same as the second
file.

  - Matthew

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Martin J Evans via RT [mailto:bug-DBD-ODBC@rt.cpan.org] 
Sent: Tuesday, March 23, 2010 10:08 AM
To: Matthew Kidd
Subject: [rt.cpan.org #55736] selectcol_arrayref&#40;&#41; fails with SQL-HY104
against SQL Server 2000 &#40;Invalid precision value&#41; 

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=55736">https://rt.cpan.org/Ticket/Display.html?id=55736</a></span> &gt;

Matthew,

I presume you are ok to build a new DBD::ODBC from scratch. If you are
then I would like you to get DBD::ODBC 1.23_2 from CPAN then before
building it edit dbdimp.c to make the following changes:

Around about line 3523 it should look like this:

   if &#40;phs-&gt;param_size == 0&#41; {
       if &#40;&#40;imp_dbh-&gt;driver_type == DT_SQL_SERVER_NATIVE_CLIENT&#41; ||
           &#40;&#40;strcmp&#40;imp_dbh-&gt;odbc_dbms_name, &#34;Microsoft SQL Server&#34;&#41; ==
0&#41; &#38;&#38;
            &#40;phs-&gt;sql_type == SQL_WVARCHAR&#41; &#38;&#38;
            &#40;phs-&gt;requested_type == 0&#41;&#41;&#41; {
           column_size = 0;
   }

could you change it to:

   if &#40;phs-&gt;param_size == 0&#41; {
       if &#40;&#40;imp_dbh-&gt;driver_type == DT_SQL_SERVER_NATIVE_CLIENT&#41; ||
           &#40;&#40;strcmp&#40;imp_dbh-&gt;odbc_dbms_name, &#34;Microsoft SQL Server&#34;&#41; ==
0&#41; &#38;&#38;
            &#40;phs-&gt;sql_type == SQL_WVARCHAR&#41; &#38;&#38;
            &#40;phs-&gt;requested_type == 0&#41;&#41;&#41; {
           column_size = 0;
           /* start of lines added */
           if &#40;DBIc_TRACE&#40;imp_sth, 0, 0, 4&#41;&#41; {
               TRACE0&#40;imp_dbh,
                      &#34;    Resetting column_size to 0 for &#40;max&#41;
column\n&#34;&#41;;
               TRACE1&#40;imp_dbh, &#34;    SQLDescribeParam returned %d\n&#34;,
                      phs-&gt;describe_param_status&#41;;
           }
           /* end of lines added */
       }
   }

Then if you rebuild, set tracing to 15 and run your script again does
the log file contain &#34;Resetting column_size to 0 for &#40;max&#41;&#34; and if so
what is the line output after that saying SQLDescribeParam returned NN.

If NN is not 0 try changing the &#34;if&#34; above from:

   if &#40;phs-&gt;param_size == 0&#41; {

to

   if &#40;&#40;phs-&gt;param_size == 0&#41; &#38;&#38;
       &#40;!SQL_SUCCEEDED&#40;phs-&gt;describe_param_status&#41;&#41;&#41; {

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/752474/389045/odbc-1.23_2.log">Download odbc-1.23_2.log</a><br />
<span class="downloadcontenttype">application/octet-stream 13.2k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/752474/389046/odbc-1.23_2-patched.log">Download odbc-1.23_2-patched.log</a><br />
<span class="downloadcontenttype">application/octet-stream 13.3k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/752474/389047/odbc-1.23_2-patched2.log">Download odbc-1.23_2-patched2.log</a><br />
<span class="downloadcontenttype">application/octet-stream 13.3k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;24&nbsp;04:50:57&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Mar 24 02:05:52 2010, matthew.kidd@ghctechnologies.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Martin,
&gt; 
&gt; The full story is in the log files &#40;tracing level at 15&#41;. The first file
&gt; is before applying your patch. The second is after applying the patch
&gt; and it shows that SQLDescribeParam returns -1. The final file is after
&gt; modifying the IF statement. It is essentially the same as the second
&gt; file.
&gt; 
&gt;   - Matthew
</div>
Oops. As I did not have your schema to verify I could not test and I got
it wrong. The if statement change should be:

    if &#40;&#40;phs-&gt;param_size == 0&#41; &#38;&#38;
        &#40;SQL_SUCCEEDED&#40;phs-&gt;describe_param_status&#41;&#41;&#41; {

Sorry for wasting your time.

To be honest although this should work for you it causes me a problem.
DBD::ODBC in the past did not use SQLDescribeParam to find out about
parameters, it just bound everything as SQL_VARCHAR. However, since the
introduction of unicode support to DBD::ODBC and the addition of
varXXX&#40;MAX&#41; columns in SQL Server DBD::ODBC needs more information to
bind some parameters correctly so it now calls SQLDescribeParam. If the
SQLDescribeParam fails it falls back on binding the parameter as
SQL_VARCHAR or SQL_WVARCHAR depending on whether it is a unicode build
or not.

The problem is that SQL Server&#39;s SQLDescribeParam can fail because MS
have a buggy implementation which attempts to rearrange your SQL to
select the columns where parameters are used. e.g.,

you do &#34;insert into mytable &#40;mycolumn&#41; values&#40;?&#41;&#34; and SQL Server
issues a &#34;select mycolumn from mytable&#34; to find out about the column the
parameter is to be bound to.

This works for many cases but when you bind parameters to items in the
SQL which use functions or use more complicated sub-selects SQL Server
fails to rearrange the SQL and SQLDescribeParam fails. You can monitor
the SQL the driver is issuing in SQL Server and see these erroneous
statements.

So DBD::ODBC attempts to work around this failure. However, to
successfully support varXXX&#40;max&#41; columns the column size in the
SQLBindParameter call has to be 0 and the code you are modifying is the
code which would do this. After the modification varXXX&#40;MAX&#41; columns are
only going to be bound correctly &#40;assuming it is left to DBD::ODBC and
TYPE=&gt;xxx is not added to the bind_param method call&#41; when
SQLDesribeParam succeeds. This is probably ok, since we only know for
sure the parameter is bound to a varXXX&#40;MAX&#41; column is SQLDescribeParam
succeeds but I&#39;ll have to run through all the test code and make sure.

It leaves us pretty much back where we were in that if SQLDescribeParam
fails then the automatic type DBD::ODBC picks will only work if it is
not a varXXX&#40;MAX&#41; column. Otherwise, you need to add TYPE=&gt;xxx to tell
DBD::ODBC what to do.

Little of this really concerns you but I&#39;m explaining it here a&#41; to
record it and b&#41; to show there is really not that much I can do if an
ODBC API call fails which shouldn&#39;t. For almost 2 years now I&#39;ve been
battling with this and I am starting to think that making DBD::ODBC try
and workaround the problem is just causing me more problems since many
people expect bind_param to just work without specifying a TYPE and it
cannot always do that if SQLDescribeParam fails.

It is safer in most situations to specify TYPE on bind_param. The
exceptions are a&#41; when it is a varXXX&#40;max&#41; column and b&#41; if you are
writing portable code which must work with multiple DBDs.

Let me know if this change works and I&#39;ll put it in and probably do a
release since it has been a while since a full release.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;24&nbsp;14:17:10&nbsp;2010</span>
    <span class="description">bitcard_kiddm [...] ghctechnologies.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bitcard_kiddm [...] ghctechnologies.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Mar 24 04:50:57 2010, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Oops. As I did not have your schema to verify I could not test and
&gt; I got it wrong. The if statement change should be:
&gt; 
&gt;     if &#40;&#40;phs-&gt;param_size == 0&#41; &#38;&#38;
&gt;         &#40;SQL_SUCCEEDED&#40;phs-&gt;describe_param_status&#41;&#41;&#41; {
&gt; 
&gt; Sorry for wasting your time.
</div>
I just tested this latest change and it works. A log file is attached.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The problem is that SQL Server&#39;s SQLDescribeParam can fail because MS
&gt; have a buggy implementation...
</div>
I didn&#39;t appreciate how screwed up the situation is on Microsoft&#39;s end.
Now I feel your pain. Do you know if the SQLDescribeParam issue has
improved in SQL Server 2008? We have stayed on SQL Server 2000 out of
inertia, no clear need for 2005/2008 features, and no desire to
troubleshoot the inevitable new issues. But it wouldn&#39;t cost us that
much to upgrade. Maybe the time has come.

  - Matthew
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> odbc-1.23_2-patched3.log</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/752837/389252/odbc-1.23_2-patched3.log">Download odbc-1.23_2-patched3.log</a><br />
<span class="downloadcontenttype">application/octet-stream 14.3k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;24&nbsp;17:25:02&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Mar 24 14:17:10 2010, kiddm wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Mar 24 04:50:57 2010, MJEVANS wrote:
<div class="message-stanza open">&gt; &gt; Oops. As I did not have your schema to verify I could not test and
&gt; &gt; I got it wrong. The if statement change should be:
&gt; &gt; 
&gt; &gt;     if &#40;&#40;phs-&gt;param_size == 0&#41; &#38;&#38;
&gt; &gt;         &#40;SQL_SUCCEEDED&#40;phs-&gt;describe_param_status&#41;&#41;&#41; {
&gt; &gt; 
&gt; &gt; Sorry for wasting your time.
</div>&gt; 
&gt; I just tested this latest change and it works. A log file is attached.
</div>
Excellent and sorry for getting it wrong the first time.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; The problem is that SQL Server&#39;s SQLDescribeParam can fail because MS
&gt; &gt; have a buggy implementation...
</div>&gt; 
&gt; I didn&#39;t appreciate how screwed up the situation is on Microsoft&#39;s end.
</div>
MS SQL Server ODBC Driver is really broken for SQLDescribeParam when the
SQL gets more complicated or uses functions.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Now I feel your pain. Do you know if the SQLDescribeParam issue has
&gt; improved in SQL Server 2008? We have stayed on SQL Server 2000 out of
&gt; inertia, no clear need for 2005/2008 features, and no desire to
&gt; troubleshoot the inevitable new issues. But it wouldn&#39;t cost us that
&gt; much to upgrade. Maybe the time has come.
&gt; 
&gt;   - Matthew
&gt; 
&gt; 
</div>
If you peruse the other rts for DBD::ODBC someone else hit the
SQLDescribeParam bugs recently and apparently reported it to MS but I
don&#39;t have the link at hand - you may even need to be a supported
customer to read it - I don&#39;t know as MS don&#39;t provide me free support
and I cannot afford to buy it.

I doubt at this time there would be much advantage to upgrading although
if you NEED varXX&#40;max&#41; column support the most recent native client
driver is better.

I&#39;ll think about this solution to the problem you reported. I may post
to dbi-dev mailing list &#40;see dbi.perl.org&#41; suggesting I raise a warning
when SQLDescribeParam fails to see what other DBD authors think.

I&#39;ll leave this rt open until I decide on a resolution but at present I
think the solution we have is the best of a bad lot. If you will be
actively using DBD::ODBC then the best things you can do are a&#41; send me
privately your email address to mjevans at cpan.org and I&#39;ll try and
keep you uptodate on potential new releases so you can test them before
final release b&#41; report problems in SQL Server SQLDescribeParam so MS
know about it and the weight of complaints might have the desired effect.

One of the problems I have is that it is almost impossible to keep
copies of all MS SQL Server Windows drivers so when I do a release I can
get a rush of failures because no one bothers to test the development
releases &#40;those ending in _NNN&#41;. I&#39;m trying to get a farm of volunteers
to test releases before they are released - it is no more than a few
official ones a year. Any help with this would be appreciated.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;14&nbsp;13:50:20&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi again,

I am about to do a new development release of DBD::ODBC 1.23_4 which
includes the change I suggested to you in this rt and some other changes
which speed up prepared statements considerably in certain
circumstances. Would you be interested in checking it out before I do a
final release of 1.24? If so get back to me and I&#39;ll let you know when
it is uploaded to CPAN. I&#39;m struggling to find people to test
development releases before final releases and then when the final
release is done I get a bunch of rt reports so I&#39;d appreciate it.

Martin

On Wed Mar 24 17:25:02 2010, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Mar 24 14:17:10 2010, kiddm wrote:
<div class="message-stanza open">&gt; &gt; On Wed Mar 24 04:50:57 2010, MJEVANS wrote:
<div class="message-stanza open">&gt; &gt; &gt; Oops. As I did not have your schema to verify I could not test and
&gt; &gt; &gt; I got it wrong. The if statement change should be:
&gt; &gt; &gt; 
&gt; &gt; &gt;     if &#40;&#40;phs-&gt;param_size == 0&#41; &#38;&#38;
&gt; &gt; &gt;         &#40;SQL_SUCCEEDED&#40;phs-&gt;describe_param_status&#41;&#41;&#41; {
&gt; &gt; &gt; 
&gt; &gt; &gt; Sorry for wasting your time.
</div>&gt; &gt; 
&gt; &gt; I just tested this latest change and it works. A log file is attached.
</div>&gt; 
&gt; Excellent and sorry for getting it wrong the first time.
&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; The problem is that SQL Server&#39;s SQLDescribeParam can fail because MS
&gt; &gt; &gt; have a buggy implementation...
</div>&gt; &gt; 
&gt; &gt; I didn&#39;t appreciate how screwed up the situation is on Microsoft&#39;s end.
</div>&gt; 
&gt; MS SQL Server ODBC Driver is really broken for SQLDescribeParam when the
&gt; SQL gets more complicated or uses functions.
&gt; 
<div class="message-stanza open">&gt; &gt; Now I feel your pain. Do you know if the SQLDescribeParam issue has
&gt; &gt; improved in SQL Server 2008? We have stayed on SQL Server 2000 out of
&gt; &gt; inertia, no clear need for 2005/2008 features, and no desire to
&gt; &gt; troubleshoot the inevitable new issues. But it wouldn&#39;t cost us that
&gt; &gt; much to upgrade. Maybe the time has come.
&gt; &gt; 
&gt; &gt;   - Matthew
&gt; &gt; 
&gt; &gt; 
</div>&gt; 
&gt; If you peruse the other rts for DBD::ODBC someone else hit the
&gt; SQLDescribeParam bugs recently and apparently reported it to MS but I
&gt; don&#39;t have the link at hand - you may even need to be a supported
&gt; customer to read it - I don&#39;t know as MS don&#39;t provide me free support
&gt; and I cannot afford to buy it.
&gt; 
&gt; I doubt at this time there would be much advantage to upgrading although
&gt; if you NEED varXX&#40;max&#41; column support the most recent native client
&gt; driver is better.
&gt; 
&gt; I&#39;ll think about this solution to the problem you reported. I may post
&gt; to dbi-dev mailing list &#40;see dbi.perl.org&#41; suggesting I raise a warning
&gt; when SQLDescribeParam fails to see what other DBD authors think.
&gt; 
&gt; I&#39;ll leave this rt open until I decide on a resolution but at present I
&gt; think the solution we have is the best of a bad lot. If you will be
&gt; actively using DBD::ODBC then the best things you can do are a&#41; send me
&gt; privately your email address to mjevans at cpan.org and I&#39;ll try and
&gt; keep you uptodate on potential new releases so you can test them before
&gt; final release b&#41; report problems in SQL Server SQLDescribeParam so MS
&gt; know about it and the weight of complaints might have the desired effect.
&gt; 
&gt; One of the problems I have is that it is almost impossible to keep
&gt; copies of all MS SQL Server Windows drivers so when I do a release I can
&gt; get a rush of failures because no one bothers to test the development
&gt; releases &#40;those ending in _NNN&#41;. I&#39;m trying to get a farm of volunteers
&gt; to test releases before they are released - it is no more than a few
&gt; official ones a year. Any help with this would be appreciated.
&gt; 
&gt; Martin
</div>
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;17&nbsp;12:22:37&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Fixed in 1.24 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;17&nbsp;12:22:37&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Fixed in 1.16 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;17&nbsp;12:22:38&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Fixed in 1.22 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;17&nbsp;12:23:32&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
