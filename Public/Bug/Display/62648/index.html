<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #62648 for DBIx-Class-Schema-Loader: DCSL crashes with some schemas</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #62648 for DBIx-Class-Schema-Loader: DCSL crashes with some schemas</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBIx-Class-Schema-Loader/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBIx-Class-Schema-Loader/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBIx-Class-Schema-Loader/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBIx-Class-Schema-Loader/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Class-Schema-Loader">DBIx-Class-Schema-Loader CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">62648</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBIx-Class-Schema-Loader/Active/">DBIx-Class-Schema-Loader</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
djh [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-38270-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.07002    </td>
  </tr>
  <tr id="CF-38271-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;02&nbsp;12:41:24&nbsp;2010</span>
    <span class="description">djh [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> DCSL crashes with some schemas</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">DBIx::Class::Schema::Loader &#40;DCSL&#41; crashes when processing some schemas
that contain columns with names that clash with DBIx::Class methods. A
failing test is attached &#40;name-clash-test.pl&#41;. The test script creates a
SQLite database and then uses DCSL to process it. Once the database has
been created, the crash can be reproduced simply by running:

 dbicdump test::schema &#39;dbi:SQLite:dbname=name-clash-test.dbfile&#39;

The data that causes DCSL to crash is a schema that contains a foreign
key column definition &#39;belongs_to&#39; &#40;it predates DBIC&#41;. The same table
also has another column that is a foreign key. DCSL emits code that
injects a belongs_to relationship called &#39;belongs_to&#39; into the package
and then tries to execute it as though it were the built-in method of
the same name.

DCSL::Base has a method called _resolve_col_accessor_collisions that
notices naming conflicts. But DCSL::RelBuilder doesn&#39;t make use of that
information. A possible fix would be to make it do so or otherwise make
an equivalent check before generating code.

But in my view a better solution would be for DCSL to emit warnings
about name clashes and not generate code at all. Quietly generating code
that isn&#39;t going to work even if it doesn&#39;t immediately crash, as it
does in most cases at present, is not very helpful to the user. A patch
for a half-way house that just emits the warnings is also attached.


There also needs to be a POD change, probably in the Known Issues
section of DBIx::Class::Schema::Loader::Base. Perhaps something like:

=head2 Accessor Name Conflicts

Because DBIx::Class accessor and relationship methods are in the same
class as the meta-methods used to generate them &#40;add_columns&#40;&#41; and
belongs_to&#40;&#41; etc&#41; it is possible although unusual for there to be a
conflict between the name of a column in a schema and the name of one of
the built-in methods. DBIx::Class::Schema::Loader detects these
conflicts and prints warnings. The generated schema is unusable and
requires manual editing before use, which must be repeated each time
DBIx::Class::Schema::Loader is run. In rare cases,
DBIx::Class::Schema::Loader may crash after it has generated the schema.

If possible, the recommended solution is to change the name of the
column in the database to avoid the conflict. 


Another question is how to produce a functioning Result class, once one
is made aware of the need for customisation. I have found
custom_column_info but its POD says &#34;Hook for adding *extra* attributes
to the column_info for a column&#34;. I have found that I can use it to
change existing attributes, specifically &#39;accessor&#39;, so code like that
below appears to generate usable classes, even though the replaced
accessor name doesn&#39;t appear in the generated relationship definition:

use DBIx::Class::Schema::Loader qw/ make_schema_at /;

sub my_custom_column_info
{
    my &#40;$table_name, $column_name, $column_info&#41; = @_;
warn &#34;&#40;$table_name, $column_name, $column_info&#41;\n&#34;;

    if &#40;$column_name eq &#39;belongs_to&#39;&#41;
    {
        return { accessor =&gt; &#39;belong_him&#39; };
    }
}


make_schema_at&#40; &#39;NameClash2::Schema&#39;,
                {
                        debug =&gt; 1,
                        dump_directory =&gt; &#39;.&#39;,
                        custom_column_info =&gt; \&#38;my_custom_column_info,
                },
                [
                        &#34;dbi:SQLite:dbname=$file&#34;,
                        &#39;&#39;,
                        &#39;&#39;,
                ],
&#41;;

It&#39;s then possible in a script using the generated classes to say
$t2_obj-&gt;belong_him and get a T1 object in return.


Is that a good way to change accessor names or is there a better way? I
couldn&#39;t find any documentation and am concerned whether it works in all
cases and will keep working in the future? 
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> name-clash-test.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use strict;
use warnings;

=head1 NAME

name-clash-test.pl - crash DBIx::Class::Schema::Loader when there is a
column name that collides with a built-in method name

2010-10-28

=cut

my $file = &#39;name-clash-test.dbfile&#39;;

my $ddl1 = &#39;
CREATE TABLE t1 &#40;
    id         INTEGER PRIMARY KEY,
    noise      TEXT
&#41;;&#39;;

my $ddl2 = &#39;
CREATE TABLE t2 &#40;
    id         INTEGER PRIMARY KEY,
    second_foreign_key INTEGER,
    belongs_to INTEGER,
    FOREIGN KEY &#40;second_foreign_key&#41; REFERENCES t1&#40;id&#41;,
    FOREIGN KEY &#40;belongs_to&#41; REFERENCES t1&#40;id&#41;
&#41;;&#39;;

my $sql1 = &#39;INSERT INTO t1 &#40;noise&#41; VALUES &#40;&#34;art of&#34;&#41;;&#39;;
my $sql2 = &#39;INSERT INTO t2 &#40;belongs_to&#41; VALUES &#40;1&#41;;&#39;;

unlink $file if -e $file;

use DBI;

# DBI-&gt;trace&#40;1&#41;;

my $dbh = DBI-&gt;connect&#40;&#34;dbi:SQLite:dbname=$file&#34;, &#39;&#39;, &#39;&#39;&#41; or die;
$dbh-&gt;do&#40;$ddl1&#41; or die;
$dbh-&gt;do&#40;$ddl2&#41; or die;
$dbh-&gt;do&#40;$sql1&#41; or die;
$dbh-&gt;do&#40;$sql2&#41; or die;
$dbh-&gt;disconnect or die;


use DBIx::Class::Schema::Loader qw/ make_schema_at /;

make_schema_at&#40; &#39;NameClash::Schema&#39;,
		{
			debug =&gt; 1,
			dump_directory =&gt; &#39;.&#39;,
		},
		[
			&#34;dbi:SQLite:dbname=$file&#34;,
			&#39;&#39;,
			&#39;&#39;,
		],
&#41;;

</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;21&nbsp;02:29:50&nbsp;2011</span>
    <span class="description">rkitover [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in 0.07003 .
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;21&nbsp;02:29:52&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;21&nbsp;02:29:52&nbsp;2011</span>
    <span class="description">rkitover [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
