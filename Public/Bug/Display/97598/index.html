<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #97598 for DBD-SQLite: Crash on disconnect with virtual tables &#40;FTS4&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #97598 for DBD-SQLite: Crash on disconnect with virtual tables &#40;FTS4&#41;</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DBD-SQLite">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DBD-SQLite">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DBD-SQLite">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DBD-SQLite">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-SQLite">DBD-SQLite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">97598</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DBD-SQLite">DBD-SQLite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cpan-dbd-qlite [...] twotwentytwo.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10248-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.42    </td>
  </tr>
  <tr id="CF-10249-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




dbd-sqlite-1.42-disconnect.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1392144/739298/dbd-sqlite-1.42-disconnect.patch">
Tue Jul 29 12:04:39 2014 (4.3k) by http://invalid-username.pip.verisignlabs.com/
</a>
</font></li>
</ul>


dbd-sqlite-bug.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1392144/739299/dbd-sqlite-bug.pl">
Tue Jul 29 12:04:39 2014 (978b) by http://invalid-username.pip.verisignlabs.com/
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=97598">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1392144" href="/Public/Bug/Display.html?id=97598#txn-1392144">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;29&nbsp;12:04:39&nbsp;2014</span>
    <span class="description">http://invalid-username.pip.verisignlabs.com/ -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Crash on disconnect with virtual tables &#40;FTS4&#41;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1392144/739297/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/739297">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">DBD::SQLite Version: 1.42
SQLite Version: 3.8.5
Perl Version: perl 5, version 14, subversion 2 &#40;v5.14.2&#41; built for x86_64-linux-gnu-thread-multi
Linux Version: Ubuntu 12.04.4 LTS &#40;precise&#41;, Linux 3.8.0-33-generic x86_64

This bug seems very similar to Bug #50503 reported resolved back in 2009.
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=50503">https://rt.cpan.org/Public/Bug/Display.html?id=50503</a></span>

The attached Perl script will cause one of these 4 crashes:

- Seg fault
- Glibc corrupt double-linked list
- Glibc corrupt unsorted chunks
- Hangs without any activity

Example crash messages:
Segmentation fault &#40;core dumped&#41;
*** glibc detected *** /usr/bin/perl: free&#40;&#41;: corrupted unsorted chunks: 0x0000000001770840 ***
*** glibc detected *** /usr/bin/perl: corrupted double-linked list: 0x0000000000d13ae0 ***

The problem appears to be in the sqlite_db_disconnect&#40;&#41; function in dbdimp.c. This function attempts to call sqlite3_finalize&#40;&#41; on all statements returned by sqlite3_next_stmt&#40;&#41; if sqlite3_close&#40;&#41; does not succeed.

As comments in the code suggest, this is not the proper thing to do if sqlite3_close&#40;&#41; does not succeed: 

    /*
    ** This cause segfaults when we have virtual tables, as sqlite3
    ** seems to try to finalize the statements for the tables &#40;freed
    ** here&#41; while closing. So we need to find other ways to do the
    ** right thing.
    */
    /* COMPAT: sqlite3_next_stmt is only available for 3006000 or newer */
    while &#40; &#40;pStmt = sqlite3_next_stmt&#40;imp_dbh-&gt;db, 0&#41;&#41; != NULL &#41; {
        sqlite3_finalize&#40;pStmt&#41;;
    }

sqlite3_next_stmt&#40;&#41; will return all statements associated with the database connection, even those owned internally by virtual tables such as FTS virtual tables. These statements will end up getting finalized twice when the virtual tables are disconnected by the sqlite implementation.

The solution is to keep a list of only the statements that have been prepared by the module and not finalized. If sqlite3_close&#40;&#41; returns SQLITE_BUSY, loop through the list and finalize only those statements. Then, call sqlite3_close&#40;&#41;  again and close will succeed. The sqlite implementation will finalize the other statements as needed.

I have attached a patch that fixes the issue, although it may not be implemented using the most appropriate or best practices for writing perl modules in C. Unfortunately, I am not very experienced in writing perl modules in C.

The patch works by keeping a simple linked list of statements in imp_dbh_st and adding and removing statements as they are prepared and finalized respectively. Any statements that haven&#39;t been finalized on disconnect get finalized before the last attempt is made to close the connection.

All test cases pass and the attached test script works as expected after applying the patch.

Thanks,
Rob
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dbd-sqlite-1.42-disconnect.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1392144/739298/dbd-sqlite-1.42-disconnect.patch">Download dbd-sqlite-1.42-disconnect.patch</a><br />
<span class="downloadcontenttype">text/x-diff 4.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ruN DBD-SQLite-1.42-orig/dbdimp.c DBD-SQLite-1.42/dbdimp.c
--- DBD-SQLite-1.42-orig/dbdimp.c	2014-01-08 11:44:12.000000000 -0600
+++ DBD-SQLite-1.42/dbdimp.c	2014-07-28 11:29:36.454949336 -0500
@@ -299,6 +299,7 @@
     imp_dbh-&gt;allow_multiple_statements = FALSE;
     imp_dbh-&gt;use_immediate_transaction = TRUE;
     imp_dbh-&gt;see_if_its_a_number       = FALSE;
+    imp_dbh-&gt;stmt_list                 = NULL;
 
     sqlite3_busy_timeout&#40;imp_dbh-&gt;db, SQL_TIMEOUT&#41;;
 
@@ -423,7 +424,34 @@
 
     croak_if_db_is_null&#40;&#41;;
 
-    rc = sqlite3_close&#40;imp_dbh-&gt;db&#41;;
+    sqlite_trace&#40; dbh, imp_dbh, 1, &#34;Closing DB&#34; &#41;;
+    rc = sqlite3_close&#40; imp_dbh-&gt;db &#41;;
+    sqlite_trace&#40; dbh, imp_dbh, 1, form&#40;&#34;rc = %d&#34;, rc&#41; &#41;;
+    if &#40; SQLITE_BUSY == rc &#41; { /* We have unfinalized statements */
+       /* Only close the statements that were prepared by this module */
+        stmt_list_s * s;
+        while &#40; s = imp_dbh-&gt;stmt_list &#41; {
+            sqlite_trace&#40; dbh, imp_dbh, 1, form&#40;&#34;Finalizing statement &#40;%p&#41;&#34;, s-&gt;stmt&#41; &#41;;
+            sqlite3_finalize&#40; s-&gt;stmt &#41;;
+            imp_dbh-&gt;stmt_list = s-&gt;prev;
+            sqlite3_free&#40; s &#41;;
+        }
+        imp_dbh-&gt;stmt_list = NULL;
+        sqlite_trace&#40; dbh, imp_dbh, 1, &#34;Trying to close DB again&#34; &#41;;
+        rc = sqlite3_close&#40; imp_dbh-&gt;db &#41;;
+    }
+    if &#40; SQLITE_OK != rc &#41; {
+        sqlite_error&#40;dbh, rc, sqlite3_errmsg&#40;imp_dbh-&gt;db&#41;&#41;;
+    }
+    /* The list should be empty at this point, but if for some unforseen reason
+       it isn&#39;t, free remaining nodes here */
+    stmt_list_s * s;
+    while&#40; s = imp_dbh-&gt;stmt_list &#41; {
+       imp_dbh-&gt;stmt_list = s-&gt;prev;
+       sqlite3_free&#40; s &#41;;
+    }
+    
+#if 0
     if &#40;rc != SQLITE_OK&#41; {
         /*
         ** Most probably we still have unfinalized statements.
@@ -444,7 +472,7 @@
             sqlite_error&#40;dbh, rc, sqlite3_errmsg&#40;imp_dbh-&gt;db&#41;&#41;;
         }
     }
-
+#endif
     av_undef&#40;imp_dbh-&gt;functions&#41;;
     SvREFCNT_dec&#40;imp_dbh-&gt;functions&#41;;
     imp_dbh-&gt;functions = &#40;AV *&#41;NULL;
@@ -632,6 +660,12 @@
     else {
         imp_sth-&gt;unprepared_statements = NULL;
     }
+    /* Add the statement to the front of the list to keep track of
+       statements that might need to be finalized later on disconnect */
+    stmt_list_s * new_stmt = &#40;stmt_list_s *&#41; sqlite3_malloc&#40; sizeof&#40;stmt_list_s&#41; &#41;;
+    new_stmt-&gt;stmt = imp_sth-&gt;stmt;
+    new_stmt-&gt;prev = imp_dbh-&gt;stmt_list;
+    imp_dbh-&gt;stmt_list = new_stmt;
 
     DBIc_NUM_PARAMS&#40;imp_sth&#41; = sqlite3_bind_parameter_count&#40;imp_sth-&gt;stmt&#41;;
     DBIc_NUM_FIELDS&#40;imp_sth&#41; = sqlite3_column_count&#40;imp_sth-&gt;stmt&#41;;
@@ -1076,11 +1110,29 @@
             croak_if_stmt_is_null&#40;&#41;;
 
             /* finalize sth when active connection */
+            sqlite_trace&#40; sth, imp_sth, 1, form&#40;&#34;Finalizing statement: %p&#34;, imp_sth-&gt;stmt&#41; &#41;;
             rc = sqlite3_finalize&#40;imp_sth-&gt;stmt&#41;;
-            imp_sth-&gt;stmt = NULL;
             if &#40;rc != SQLITE_OK&#41; {
                 sqlite_error&#40;sth, rc, sqlite3_errmsg&#40;imp_dbh-&gt;db&#41;&#41;;
             }
+
+            /* find the statement in the statement list and delete it */
+            stmt_list_s * i = imp_dbh-&gt;stmt_list;
+            stmt_list_s * temp = i;
+            while&#40; i &#41; {
+               if &#40; i-&gt;stmt == imp_sth-&gt;stmt &#41; {
+                  if &#40; temp != i &#41; temp-&gt;prev = i-&gt;prev;
+                  if &#40; i == imp_dbh-&gt;stmt_list &#41; imp_dbh-&gt;stmt_list = i-&gt;prev;
+                  sqlite_trace&#40; sth, imp_sth, 1, form&#40;&#34;Removing statement from list: %p&#34;, imp_sth-&gt;stmt&#41; &#41;;
+                  sqlite3_free&#40; i &#41;;      
+                  break;
+               }
+               else {
+                  temp = i;
+                  i = i-&gt;prev;
+               }
+            }
+            imp_sth-&gt;stmt = NULL;
         }
     }
     SvREFCNT_dec&#40;&#40;SV*&#41;imp_sth-&gt;params&#41;;
diff -ruN DBD-SQLite-1.42-orig/dbdimp.h DBD-SQLite-1.42/dbdimp.h
--- DBD-SQLite-1.42-orig/dbdimp.h	2013-05-29 00:46:50.000000000 -0500
+++ DBD-SQLite-1.42/dbdimp.h	2014-07-28 11:29:39.682949339 -0500
@@ -16,6 +16,14 @@
 #define sqlite3_int64 sqlite_int64
 #endif
 
+/* A linked list of statements prepared by this module */
+typedef struct stmt_list_s stmt_list_s;
+
+struct stmt_list_s {
+   sqlite3_stmt * stmt;
+   stmt_list_s  * prev;
+};
+
 /* Driver Handle */
 struct imp_drh_st {
     dbih_drc_t com;
@@ -36,6 +44,7 @@
     bool allow_multiple_statements;
     bool use_immediate_transaction;
     bool see_if_its_a_number;
+    stmt_list_s * stmt_list;
 };
 
 /* Statement Handle */
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dbd-sqlite-bug.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1392144/739299/dbd-sqlite-bug.pl">Download dbd-sqlite-bug.pl</a><br />
<span class="downloadcontenttype">text/x-perl 978b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use warnings;
use strict;
use DBI;

my $dbfile = &#34;test.db&#34;;

unlink $dbfile;
my $dbh = DBI-&gt;connect&#40;&#34;dbi:SQLite:$dbfile&#34;&#41;;
$dbh-&gt;{AutoCommit} = 0;
$dbh-&gt;{RaiseError} = 1;
$dbh-&gt;do&#40; &lt;&lt;EOF &#41;;
create virtual table test_fts using fts4 &#40;
   col1,
   col2,
&#41;
EOF

$dbh-&gt;commit;

sub insert {
   my &#40;$dbh, $val1, $val2&#41; = @_;
   my $sth = $dbh-&gt;prepare&#40;
      &#34;insert or replace into test_fts &#40; col1, col2 &#41; values &#40; ?, ? &#41;&#34; &#41;;
   $sth-&gt;execute&#40; $val1, $val2 &#41;
      or die &#34;sth-&gt;execute&#40;&#41; failed: $DBI::errstr. Stopped&#34;;
   #$sth-&gt;finish;
   #$dbh-&gt;commit;
}

insert $dbh, &#34;abc&#34;, &#34;123&#34;;
insert $dbh, &#34;def&#34;, &#34;456&#34;;
insert $dbh, &#34;abc&#34;, &#34;123&#34;;
insert $dbh, &#34;def&#34;, &#34;456&#34;;
insert $dbh, &#34;abc&#34;, &#34;123&#34;;
$dbh-&gt;commit;

my $sth = $dbh-&gt;prepare&#40;&#34;select * from test_fts where col2 match &#39;123&#39;&#34;&#41;;
$sth-&gt;execute;

while &#40; my @row = $sth-&gt;fetchrow_array &#41; {
   #print Dumper @row;
   print join &#34; &#34;, @row, &#34;\n&#34;;
}
#$sth-&gt;finish;

$dbh-&gt;commit;
$dbh-&gt;disconnect;

print &#34;The end\n&#34;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1392176" href="/Public/Bug/Display.html?id=97598#txn-1392176">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;29&nbsp;13:04:20&nbsp;2014</span>
    <span class="description">ishigaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1392176/739321/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/739321">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the awesome patch! Applied to the master, and shipped 1.43_07 with the fix.

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/DBD-SQLite/DBD-SQLite/commit/539d79f080bbc0a6db8d2d690b9aa4536931e8c0">https://github.com/DBD-SQLite/DBD-SQLite/commit/539d79f080bbc0a6db8d2d690b9aa4536931e8c0</a></span>

On Wed Jul 30 01:04:39 2014, <span class="clickylink"><a target="new" rel="nofollow" href="http://invalid-username.pip.verisignlabs.com/">http://invalid-username.pip.verisignlabs.com/</a></span> wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; DBD::SQLite Version: 1.42
&gt; SQLite Version: 3.8.5
&gt; Perl Version: perl 5, version 14, subversion 2 &#40;v5.14.2&#41; built for
&gt; x86_64-linux-gnu-thread-multi
&gt; Linux Version: Ubuntu 12.04.4 LTS &#40;precise&#41;, Linux 3.8.0-33-generic
&gt; x86_64
&gt; 
&gt; This bug seems very similar to Bug #50503 reported resolved back in
&gt; 2009.
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=50503">https://rt.cpan.org/Public/Bug/Display.html?id=50503</a></span>
&gt; 
&gt; The attached Perl script will cause one of these 4 crashes:
&gt; 
&gt; - Seg fault
&gt; - Glibc corrupt double-linked list
&gt; - Glibc corrupt unsorted chunks
&gt; - Hangs without any activity
&gt; 
&gt; Example crash messages:
&gt; Segmentation fault &#40;core dumped&#41;
&gt; *** glibc detected *** /usr/bin/perl: free&#40;&#41;: corrupted unsorted
&gt; chunks: 0x0000000001770840 ***
&gt; *** glibc detected *** /usr/bin/perl: corrupted double-linked list:
&gt; 0x0000000000d13ae0 ***
&gt; 
&gt; The problem appears to be in the sqlite_db_disconnect&#40;&#41; function in
&gt; dbdimp.c. This function attempts to call sqlite3_finalize&#40;&#41; on all
&gt; statements returned by sqlite3_next_stmt&#40;&#41; if sqlite3_close&#40;&#41; does not
&gt; succeed.
&gt; 
&gt; As comments in the code suggest, this is not the proper thing to do if
&gt; sqlite3_close&#40;&#41; does not succeed:
&gt; 
&gt; /*
&gt; ** This cause segfaults when we have virtual tables, as sqlite3
&gt; ** seems to try to finalize the statements for the tables &#40;freed
&gt; ** here&#41; while closing. So we need to find other ways to do the
&gt; ** right thing.
&gt; */
&gt; /* COMPAT: sqlite3_next_stmt is only available for 3006000 or newer */
&gt; while &#40; &#40;pStmt = sqlite3_next_stmt&#40;imp_dbh-&gt;db, 0&#41;&#41; != NULL &#41; {
&gt;     sqlite3_finalize&#40;pStmt&#41;;
&gt; }
&gt; 
&gt; sqlite3_next_stmt&#40;&#41; will return all statements associated with the
&gt; database connection, even those owned internally by virtual tables
&gt; such as FTS virtual tables. These statements will end up getting
&gt; finalized twice when the virtual tables are disconnected by the sqlite
&gt; implementation.
&gt; 
&gt; The solution is to keep a list of only the statements that have been
&gt; prepared by the module and not finalized. If sqlite3_close&#40;&#41; returns
&gt; SQLITE_BUSY, loop through the list and finalize only those statements.
&gt; Then, call sqlite3_close&#40;&#41;  again and close will succeed. The sqlite
&gt; implementation will finalize the other statements as needed.
&gt; 
&gt; I have attached a patch that fixes the issue, although it may not be
&gt; implemented using the most appropriate or best practices for writing
&gt; perl modules in C. Unfortunately, I am not very experienced in writing
&gt; perl modules in C.
&gt; 
&gt; The patch works by keeping a simple linked list of statements in
&gt; imp_dbh_st and adding and removing statements as they are prepared and
&gt; finalized respectively. Any statements that haven&#39;t been finalized on
&gt; disconnect get finalized before the last attempt is made to close the
&gt; connection.
&gt; 
&gt; All test cases pass and the attached test script works as expected
&gt; after applying the patch.
&gt; 
&gt; Thanks,
&gt; Rob
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1392177" href="/Public/Bug/Display.html?id=97598#txn-1392177">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;29&nbsp;13:04:21&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1392180" href="/Public/Bug/Display.html?id=97598#txn-1392180">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;29&nbsp;13:04:21&nbsp;2014</span>
    <span class="description">ishigaki [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1401574" href="/Public/Bug/Display.html?id=97598#txn-1401574">#</a>      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;20&nbsp;08:25:20&nbsp;2014</span>
    <span class="description">DAMI [...] cpan.org -  Reference by ticket #86006 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1424076" href="/Public/Bug/Display.html?id=97598#txn-1424076">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;22&nbsp;11:38:26&nbsp;2014</span>
    <span class="description">ishigaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1424076/756466/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/756466">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 36b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Closed as 1.44 was released. Thanks.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1424079" href="/Public/Bug/Display.html?id=97598#txn-1424079">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;22&nbsp;11:38:28&nbsp;2014</span>
    <span class="description">ishigaki [...] cpan.org -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.402844</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
