<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #81219 for Net-Amazon-Glacier: Memory Usage [partial fix included]</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #81219 for Net-Amazon-Glacier: Memory Usage [partial fix included]</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-Amazon-Glacier/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-Amazon-Glacier/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-Amazon-Glacier/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-Amazon-Glacier/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-Amazon-Glacier">Net-Amazon-Glacier CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">81219</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-Amazon-Glacier/Active/">Net-Amazon-Glacier</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
treed [...] imvu.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-245416-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-245417-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;15&nbsp;18:28:15&nbsp;2012</span>
    <span class="description">treed [...] imvu.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Memory Usage [partial fix included]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 15 Nov 2012 15:27:43 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-Amazon-Glacier [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ted Reed &lt;treed [...] imvu.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It turns out that when you&#39;re uploading large files, the memory usage is a
bit extreme. It&#39;s basically 7x the size of the file. It seems like this is
because things are passing the payload around byval instead of byref, so
each function call makes another copy. With 100MB payloads, the memory
usage is pretty noticeable. I&#39;ve got a patch that removes one of the
byvals, but most of the rest can&#39;t be fixed without either going into the
libraries that Net::Amazon::Glacier uses or reimplementing their
functionality.

You may or may not want to look into either of those solutions, but I
thought I&#39;d mention it and pass the limited fix along.

HTTP::Request::Common has a special dynamic mode that will stream payloads,
which you might be able to use, but you wouldn&#39;t be able to use
Net::Amazon::Signature::V4 with it, as far as I can tell.

We &#40;IMVU&#41; contribute this code specifically under the GPL Version 1 and
Artistic License &#40;Perl&#41; Version 1.

Here is the patch:

--- a/lib/Net/Amazon/Glacier.pm
+++ b/lib/Net/Amazon/Glacier.pm
@@ -150,7 +150,7 @@
                        &#39;x-amz-sha256-tree-hash&#39; =&gt; $th-&gt;get_final_hash&#40;&#41;,
                        &#39;x-amz-content-sha256&#39; =&gt; sha256_hex&#40; $content &#41;,
                ],
-               $content
+               \$content
        &#41;;
        return 0 unless $res-&gt;is_success;
        if &#40; $res-&gt;header&#40;&#39;location&#39;&#41; =~
m{^/&#40;[^/]+&#41;/vaults/&#40;[^/]+&#41;/archives/&#40;.*&#41;$} &#41; {
@@ -209,7 +209,7 @@
        my $res = $self-&gt;_send_receive&#40;
                POST =&gt; &#34;/-/vaults/$vault_name/jobs&#34;,
                [ ],
-               encode_json&#40;$content_raw&#41;,
+               \encode_json&#40;$content_raw&#41;,
        &#41;;

        return 0 unless $res-&gt;is_success;
@@ -245,7 +245,7 @@
        my $res = $self-&gt;_send_receive&#40;
                POST =&gt; &#34;/-/vaults/$vault_name/jobs&#34;,
                [ ],
-               encode_json&#40;$content_raw&#41;,
+               \encode_json&#40;$content_raw&#41;,
        &#41;;

        return 0 unless $res-&gt;is_success;
@@ -309,13 +309,15 @@
 sub _craft_request {
        my &#40; $self, $method, $url, $header, $content &#41; = @_;
        my $host = &#39;glacier.&#39;.$self-&gt;{region}.&#39;.amazonaws.com&#39;;
+    $content //= \undef;
+
        my $total_header = [
                &#39;x-amz-glacier-version&#39; =&gt; &#39;2012-06-01&#39;,
                &#39;Host&#39; =&gt; $host,
                &#39;Date&#39; =&gt; strftime&#40; &#39;%Y%m%dT%H%M%SZ&#39;, gmtime &#41;,
                $header ? @$header : &#40;&#41;
        ];
-       my $req = HTTP::Request-&gt;new&#40; $method =&gt; &#34;https://$host$url&#34;,
$total_header, $content&#41;;
+       my $req = HTTP::Request-&gt;new&#40; $method =&gt; &#34;https://$host$url&#34;,
$total_header, $$content&#41;;
        my $signed_req = $self-&gt;{sig}-&gt;sign&#40; $req &#41;;
        return $signed_req;
 }
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;10&nbsp;07:21:33&nbsp;2012</span>
    <span class="description">pyry [...] automattic.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> pyry [...] automattic.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Nov 15 18:28:15 2012, treed@imvu.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It turns out that when you&#39;re uploading large files, the memory usage 
</div>is a
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; bit extreme. It&#39;s basically 7x the size of the file.
</div>
I also noticed this. I submitted a patch to Net::Amazon::Signature::V4, 
that is needed before this patch should be applied:

<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=81864">https://rt.cpan.org/Public/Bug/Display.html?id=81864</a></span>

The attached patch buffers ~1MiB at a time, and it&#39;s now possible to 
upload multi GB files with reasonable memory usage &#40;20 MiB or so&#41;.

The file is still being read twice, once for TreeHash and once for 
content SHA256, it could be optimized, but I didn&#39;t really need it.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Fix-memory-issues-with-large-files.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From a07df000ff5e28e3a27902e8bc5f21a7ae4da309 Mon Sep 17 00:00:00 2001
From: Pyry Hakulinen &lt;pyry@automattic.com&gt;
Date: Sun, 9 Dec 2012 22:46:30 +0200
Subject: [PATCH] Fix memory issues with large files

This patch eliminates content buffering and passing etc. And reduces
memory usage to sane levels even for multi GB files. This was already
reported in:

<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=81219">https://rt.cpan.org/Public/Bug/Display.html?id=81219</a></span>

This patch depends on this:

The SHA calculation could be optimized by moving it to the TreeHash
module, that way we could read it the file only once. But it mostly
affects huge files.
---
 Net-Amazon-Glacier-0.12/lib/Net/Amazon/Glacier.pm |   17 +++++++++++++----
 1 file changed, 13 insertions&#40;+&#41;, 4 deletions&#40;-&#41;

diff --git a/Net-Amazon-Glacier-0.12/lib/Net/Amazon/Glacier.pm b/Net-Amazon-Glacier-0.12/lib/Net/Amazon/Glacier.pm
index 276a405..b695049 100644
--- a/Net-Amazon-Glacier-0.12/lib/Net/Amazon/Glacier.pm
+++ b/Net-Amazon-Glacier-0.12/lib/Net/Amazon/Glacier.pm
@@ -135,22 +135,31 @@ sub upload_archive {
 	croak &#34;no archive path given&#34; unless $archive_path;
 	croak &#39;archive path is not a file&#39; unless -f $archive_path;
 	$description //= &#39;&#39;;
-	my $content = read_file&#40; $archive_path &#41;;
 
 	my $th = Net::Amazon::TreeHash-&gt;new&#40;&#41;;
 	open&#40; my $content_fh, &#39;&lt;&#39;, $archive_path &#41; or croak $!;
 	$th-&gt;eat_file&#40; $content_fh &#41;;
-	close $content_fh;
 	$th-&gt;calc_tree;
 
+	my $content_sha = Digest::SHA-&gt;new&#40;&#34;sha256&#34;&#41;;
+	$content_sha-&gt;addfile&#40; $archive_path &#41;;
+
+	seek&#40; $content_fh, 0, 0 &#41;;
+	my $reader_sub = sub {
+		my $content;
+		read&#40; $content_fh, $content, 1048576 &#41;;
+		return $content;
+	};
+
 	my $res = $self-&gt;_send_receive&#40;
 		POST =&gt; &#34;/-/vaults/$vault_name/archives&#34;, 
 		[
 			&#39;x-amz-archive-description&#39; =&gt; $description,
 			&#39;x-amz-sha256-tree-hash&#39; =&gt; $th-&gt;get_final_hash&#40;&#41;,
-			&#39;x-amz-content-sha256&#39; =&gt; sha256_hex&#40; $content &#41;,
+			&#39;x-amz-content-sha256&#39; =&gt; $content_sha-&gt;hexdigest,
+			&#39;content-length&#39; =&gt; -s $archive_path,
 		],
-		$content
+		$reader_sub
 	&#41;;
 	return 0 unless $res-&gt;is_success;
 	if &#40; $res-&gt;header&#40;&#39;location&#39;&#41; =~ m{^/&#40;[^/]+&#41;/vaults/&#40;[^/]+&#41;/archives/&#40;.*&#41;$} &#41; {
-- 
1.7.10.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;10&nbsp;07:21:35&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;23&nbsp;06:23:47&nbsp;2012</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am the author of TreeHash module.

There is a method eat_data in TreeHash which takes reference to data chunk.

You can read data _chunks_ from file one by one in your code a pass it
by _reference_ to ead_data.

This way you won&#39;t have any performance/memory problems.

Also note that if data size is &lt;= 1M TreeHash&#40;data&#41; == Sha256&#40;Data&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;23&nbsp;07:53:37&nbsp;2012</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I remembered now that parameters to Perl functions are actually passed
always by references.
Copying happen when those parameters get modified or returned or copied
to scalar &#40;like copy-on-write&#41;.


### Small memory usage

#!/usr/bin/perl

use strict;
use warnings;
my $s = &#34;a&#34; x 100_000_000;
sub mysub
{
        print `ps aux|grep $$|grep -v grep|awk &#39;{print \$6}&#39;`;
        return length&#40;$_[0]&#41;;
}


print `ps aux|grep $$|grep -v grep|awk &#39;{print \$6}&#39;`;
my $x = mysub&#40;$s&#41;;


### Double memory usage

#!/usr/bin/perl

use strict;
use warnings;

my $s = &#34;a&#34; x 100_000_000;
sub mysub
{
        my &#40;@a&#41; = @_;
        print `ps aux|grep $$|grep -v grep|awk &#39;{print \$6}&#39;`;
        return length&#40;$a[0]&#41;;
}

print `ps aux|grep $$|grep -v grep|awk &#39;{print \$6}&#39;`;
my $x = mysub&#40;$s&#41;;

### Small momory usage again
#!/usr/bin/perl

use Digest::SHA qw/sha256_hex/;
use strict;
use warnings;
my $s = &#34;a&#34; x 100_000_000;
sub mysub
{
        print `ps aux|grep $$|grep -v grep|awk &#39;{print \$6}&#39;`;
        my $x = \shift;
        return sha256_hex&#40;$$x&#41;;
}


print `ps aux|grep $$|grep -v grep|awk &#39;{print \$6}&#39;`;
print mysub&#40;$s&#41;;
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
