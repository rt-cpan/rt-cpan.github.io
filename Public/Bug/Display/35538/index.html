<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #35538 for POE-Component-Client-HTTP: Content-Encoding is not handled properly</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #35538 for POE-Component-Client-HTTP: Content-Encoding is not handled properly</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/POE-Component-Client-HTTP/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/POE-Component-Client-HTTP/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/POE-Component-Client-HTTP/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/POE-Component-Client-HTTP/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE-Component-Client-HTTP">POE-Component-Client-HTTP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">35538</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/POE-Component-Client-HTTP/Active/">POE-Component-Client-HTTP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
YKAR [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-26420-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26421-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;30&nbsp;04:14:27&nbsp;2008</span>
    <span class="description">YKAR [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Content-Encoding is not handled properly</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello

In method POE::Component::Client::HTTP::return_response if header
Content-Encoding is seen attempt to decode content is performed.

I don&#39;t think that it is proper to do so &#40;I think receiver of
HTTP::Response object should use method &#39;decoded_content&#39;&#41;. I think
PoCoCl::HTTP should niether set Accept-Encoding nor decode contend based
on Content-Encoding. It is all higher level things. On my opinion
PoCoCl::HTTP must only decode Transfer-Encoding &#40;and set TE: which
transfer encodings supported&#41;.

Anyway, if you think that current design is correct, I suggest to add
some fixes to current implementation.

----------------[cut]--------------------
    if &#40;$response-&gt;header&#40;&#39;content-encoding&#39;&#41;&#41; {
      my $content;
      # LWP likes to die on error.
      eval { $content = $response-&gt;decoded_content };
      if &#40;$content&#41; { $response-&gt;content&#40;$content&#41;; }
    }
----------------[cut]---------------------

1. decoded_content not only decode content based on Content-Encoding,
but also does charset decoding. To disable charset decoding need to use

$response-&gt;decoded_content&#40;charset =&gt; &#39;none&#39;&#41;;

2. if content was reset with decoded content, I think it is right to
delete Content-Encoding header. Leaving this header confuse user of
HTTP::Response &#40;I&#39;m using decode_content, and it confusing because
Content-Encoding is set but content already decoded&#41;.

3. some performance improvement

decoded_content can return reference if called with ref =&gt; 1 parameter,
it can save some cpu cycles if Content-Encoding is identity &#40;it would
not copy content, but just return reference to it&#41;

Please either remove code which deals with
Accept-Encoding/Content-Encoding things or at least apply proposed fixes.

It is not possible to work correctly in application which doing requests
with Accept-Encoding header is set.

Thank you in advance!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;30&nbsp;04:38:02&nbsp;2008</span>
    <span class="description">YKAR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">One more thing. I forgot to say why is better to disable charset
decoding. If document charset &#40;obtained from Content-Type or any other
place&#41; is unknown to &#39;Encode&#39; module, decoded_content will fail &#40;even if
content can be unzipped successfully, for example if it Content-Encoding
was gzip&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;30&nbsp;04:38:04&nbsp;2008</span>
    <span class="description">YKAR [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;30&nbsp;23:02:57&nbsp;2008</span>
    <span class="description">overlordq [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> overlordq [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On a related note, it seems that the latest version of libwww-perl makes
this a slightly bigger problem.

===
 Release 5.810
Don&#39;t allow HTTP::Message content to be set to Unicode strings.
===
My problems:
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=683833">http://www.perlmonks.org/?node_id=683833</a></span>

Seems to come back to the above content encoding problems.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;01&nbsp;02:23:17&nbsp;2008</span>
    <span class="description">YKAR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Funny that one small piece of code caused problems for different people
practically at the same time ;&#41;

I&#39;m not yet upgdaded to newer libwww so I didn&#39;t stuck with your
problem. My problem was caused by invalid response &#40;Content-Encoding
header is still set, but content is not gzipped&#41;, so when my program was
trying to get decoded_content it failes because content already decoded.

PS. There is a reply at perlmonks by Juerd. He saying exactlyt what I
said earlier in this ticket and I&#39;m 100% agree with him.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;01&nbsp;13:01:18&nbsp;2008</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu May 01 02:23:17 2008, YKAR wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Funny that one small piece of code caused problems for different people
&gt; practically at the same time ;&#41;
</div>
If time permits, I will address this issue over the coming weekend.

Just so I&#39;m clear, should this reliably produce the error:

1. Upgrade to latest libwww.
2. Fetch a page with a Content-Encoding header.

?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;01&nbsp;13:14:54&nbsp;2008</span>
    <span class="description">overlordq [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu May 01 13:01:18 2008, RCAPUTO wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu May 01 02:23:17 2008, YKAR wrote:
<div class="message-stanza open">&gt; &gt; Funny that one small piece of code caused problems for different people
&gt; &gt; practically at the same time ;&#41;
</div>&gt; 
&gt; If time permits, I will address this issue over the coming weekend.
&gt; 
&gt; Just so I&#39;m clear, should this reliably produce the error:
&gt; 
&gt; 1. Upgrade to latest libwww.
&gt; 2. Fetch a page with a Content-Encoding header.
&gt; 
&gt; ?
</div>
Essentially yes, attached is very simple script which triggers:
HTTP::Message content must be bytes at
/usr/local/share/perl/5.8.8/POE/Component/Client/HTTP/Request.pm line 187
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use POE qw&#40;Component::Client::HTTP&#41;;
use HTTP::Request;

POE::Component::Client::HTTP-&gt;spawn&#40;Alias =&gt; &#39;ua&#39;&#41;;

POE::Session-&gt;create&#40;
        inline_states =&gt; {
                _start =&gt; sub {
                        POE::Kernel-&gt;post&#40;
                                &#39;ua&#39;,
                                &#39;request&#39;,
                                &#39;response&#39;,
                                HTTP::Request-&gt;new&#40;GET =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://en.wikipedia.org/wiki/Main_Page&#39;&#41;">http://en.wikipedia.org/wiki/Main_Page&#39;&#41;</a></span>,
                        &#41;;
                },
                _stop =&gt; sub {},
                response =&gt; \&#38;response_handler,
        },
&#41;;

POE::Kernel-&gt;run&#40;&#41;;
exit;</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;01&nbsp;13:28:31&nbsp;2008</span>
    <span class="description">YKAR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If time permits, I will address this issue over the coming weekend.
</div>
Thank you.
overlordq passed ahead of me with the example ;&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Just so I&#39;m clear, should this reliably produce the error:
&gt; 
&gt; 1. Upgrade to latest libwww.
&gt; 2. Fetch a page with a Content-Encoding header.
&gt; 
&gt; ?
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;04&nbsp;02:58:49&nbsp;2008</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Apr 30 04:14:27 2008, YKAR wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello
&gt; 
&gt; In method POE::Component::Client::HTTP::return_response if header
&gt; Content-Encoding is seen attempt to decode content is performed.
&gt; 
&gt; I don&#39;t think that it is proper to do so &#40;I think receiver of
&gt; HTTP::Response object should use method &#39;decoded_content&#39;&#41;.
</div>
I understand this is probably the more correct behavior, but I currently
expect the user to always call decoded_content&#40;&#41;.  If I understood cases
where the user would avoid decoded_content&#40;&#41;, then I would be more
inclined to change this behavior.  Can you help by explaining such cases?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Anyway, if you think that current design is correct, I suggest to add
&gt; some fixes to current implementation.
</div>
I am undecided, but I&#39;m leaning towards continuing to support the
existing behavior.  I&#39;m willing to break existing code for a good
reason... I just need to know what that is. :&#41;

Here&#39;s an alternative implementation based on your suggestions,
committed as revision 326.  Please let me know what you think of it.

---cut---
    if &#40;$response-&gt;header&#40;&#39;content-encoding&#39;&#41;&#41; {
      # LWP likes to die on error.
      my $content = eval {
        $response-&gt;decoded_content&#40;charset =&gt; &#39;none&#39;, ref =&gt; 1&#41;
      };
      if &#40;$content&#41; {
        $response-&gt;content_ref&#40;$content&#41;;
        $response-&gt;content_length&#40;length&#40;$$content&#41;&#41;;
        $response-&gt;header&#40;&#39;content-encoding&#39; =&gt; undef&#41;;
      }
    }
---cut---

To recap:

1. Disable charset decoding with decoded_content&#40;&#41;

Done.

2. Remove Content-Encoding header if using decoded content.

Done.  I also adjusted the Content-Length to reflect the expanded
content length.

3. Pass by reference to avoid unnecessary copying.

Done.

Also:

* The test case passes, thank you.

* &#34;make test&#34; passes. :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;04&nbsp;08:34:58&nbsp;2008</span>
    <span class="description">YKAR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I understand this is probably the more correct behavior, but I currently
&gt; expect the user to always call decoded_content&#40;&#41;.  If I understood cases
&gt; where the user would avoid decoded_content&#40;&#41;, then I would be more
&gt; inclined to change this behavior.  Can you help by explaining such cases?
</div>
Probably I explained uncertainly. I think user should call
decoded_content&#40;&#41; always, but PoCoCl::HTTP must not call
decoded_content&#40;&#41; at all.

LWP::UserAgent never did decoding transparently. I think better to
maintain compatible behavior &#40;because many developers have expirience of
using LWP::UserAgent&#41;. Gisle Aas &#40;author of libwww-perl&#41; always objected
against handling Content-Encoding transparently. For example here &#40;there
was many discussion on this subject, it is just one from many&#41;:

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.mail-archive.com/libwww@perl.org/msg04703.html">http://www.mail-archive.com/libwww@perl.org/msg04703.html</a></span>

One of reasons he mention, that apache sets Content-Encoding: x-gzip
header for gzipped files. And it is unwise to decode content in library,
probably user want just to save gzipped file, or compute md5 sum or any
other case where user needs original not decoded content.

Other reason is because Transfer-Encoding and Content-Encoding &#34;works at
different levels in the HTTP protocol&#34; &#40;afair I already mentioned this&#41;.

I consider Gisle Aas an authority. He is writting libwww-perl library 
long time, he read HTTP RFC from cover to cover many times, so I
inclined to trust him.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Anyway, if you think that current design is correct, I suggest to add
&gt; &gt; some fixes to current implementation.
</div>&gt; 
&gt; I am undecided, but I&#39;m leaning towards continuing to support the
&gt; existing behavior.  I&#39;m willing to break existing code for a good
&gt; reason... I just need to know what that is. :&#41;
&gt; 
&gt; Here&#39;s an alternative implementation based on your suggestions,
&gt; committed as revision 326.  Please let me know what you think of it.
&gt; 
&gt; ---cut---
&gt;     if &#40;$response-&gt;header&#40;&#39;content-encoding&#39;&#41;&#41; {
&gt;       # LWP likes to die on error.
&gt;       my $content = eval {
&gt;         $response-&gt;decoded_content&#40;charset =&gt; &#39;none&#39;, ref =&gt; 1&#41;
&gt;       };
&gt;       if &#40;$content&#41; {
&gt;         $response-&gt;content_ref&#40;$content&#41;;
&gt;         $response-&gt;content_length&#40;length&#40;$$content&#41;&#41;;
&gt;         $response-&gt;header&#40;&#39;content-encoding&#39; =&gt; undef&#41;;
&gt;       }
&gt;     }
&gt; ---cut---
</div>
Thank you :&#41;

Even better than I thought to do. I did not even knew about existence of
content_ref method ;&#41;

I think problem of overlordq solved just by setting charset =&gt; &#39;none&#39;,
because if charset decoding is not performed no wide characters will appear.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;05&nbsp;01:19:27&nbsp;2008</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun May 04 08:34:58 2008, YKAR wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Probably I explained uncertainly. I think user should call
&gt; decoded_content&#40;&#41; always, but PoCoCl::HTTP must not call
&gt; decoded_content&#40;&#41; at all.
</div>
Thank you for the link to Gisle Aas&#39; discussion about the matter.  He
makes good points, and I will refer to them if anyone gives me a hard
time about the change.

I understand your point that libraries should not transparently decode
content, but I&#39;m reluctant to break everybody&#39;s code just for correctness.

I think the best way to remove the feature would be to phase it out over
several releases.  Here&#39;s the plan I suggested to POE&#39;s mailing list. 
What do you think?

1a. Only decode content for text/* that is gzip encoded.  All other
content would be passed through unchanged.

1b. Add a new option to do transparent decoding, and leave it on by default.

2. Later, throw a warning if the option is turned on.  Remind the
application developer to use decoded_content&#40;&#41; if they want decoded content.

3. Later, throw a hard error &#40;and reminder&#41; at the developer if the
option is enabled.

4. Later, remove the transparent decoding feature and option altogether.

The option lets developers explicitly state what they want, and then
deprecation guides them into the new behavior.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;05&nbsp;04:55:04&nbsp;2008</span>
    <span class="description">YKAR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I understand your point that libraries should not transparently decode
&gt; content, but I&#39;m reluctant to break everybody&#39;s code just for correctness.
</div>
I don&#39;t think that this change will break much &#40;any?&#41; code. Thats why:
There are two cases &#40;at least which I know&#41; when server sends
Content-Encoding header.

1. Request has header Accept-Encoding.
2. Requesting &#34;.gz&#34; file from apache.

In first case if developer setting Accept-Encoding header, developer
knows what he is doing and he ready to get response with encoded
content. In this case transparent decoding even make situation confusing
&#40;expected encoded content but get decoded&#41;.

In second case, transparent decoding, I guess, is not the thing which
developer expected. And I&#39;m doubt that someone relies on such behavior
&#40;I think if developer request some file with .gz suffix it expect to get
gzipped data but not already unzipped file&#41;.

In other cases &#40;when niether Accept-Encoding header is set nor .gz file
requested&#41; developer does not expect to get encoded content &#40;and
developer should not get it&#41;.

Current implementation of PoCoCl::HTTP is adding Accept-Encoding: gzip
to request and trying to handle response with Content-Encoding. 

Actually PoCoCl::HTTP is trying to deceive client program. Even if
program do not want to use compression the PoCoCl::HTTP request a
document with compression and decompress it for program to present it as
uncompressed.

I want to emphasize that http server does not compress document if it is
not asked for. So if Accept-Encoding is not set, server will not respond
with encoded content and Content-Encoding header &#40;The exception is when
document already compressed, like static gzipped file, in this case
server has no other option just like to send content as is and set
Content-Type and Content-Encoding. But it is not the case where
transpared decompression is expected&#41;.

So I think the only consequence of disabling transparent compression is
increased consumed bandwitdh &#40;compression is requested implicitly by
PoCoCl::HTTP, but after disabling transparent compression, compression
will be used only if client application requested it&#41;.

By the way, I see Transfer-Encoding handling code exists in
PoCoCl::HTTP, but a&#41; compression filters is commented out in
te_possible_filters b&#41; TE: header is not added to request. If this code
works, it seems it is not difficult to enable transparent compression on
this level?

PS. I thought out some improvement to current workaround. Currently
PoCoCl::HTTP does not set Accept-Encoding header if user set it already.
But if it sees Content-Encoding, content decoded is unconditionally &#40;no
matter who set Accept-Encoding user or library&#41;.

It is possible to make some flag in PoCoCl::HTTP::Request that
Accept-Encoding was set by library, and handle Content-Encoding only if
flag is set. Thus if user set Accept-Encoding header, user get
&#34;untouched&#34; content.

With this change compatibilty &#40;from application developer&#39;s perspective&#41;
with LWP::UserAgent will be full.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think the best way to remove the feature would be to phase it out over
&gt; several releases.  Here&#39;s the plan I suggested to POE&#39;s mailing list. 
&gt; What do you think?
</div>
As I explained above, I think this change does not hit most of users. So
probably it is ok to disable transparent decoding by default. And if
this will breake some code &#40;either make fixes to work with this code, or
revert change and implement this change by phases like you proposed&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 1a. Only decode content for text/* that is gzip encoded.  All other
&gt; content would be passed through unchanged.
&gt; 
&gt; 1b. Add a new option to do transparent decoding, and leave it on by
</div>default.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 2. Later, throw a warning if the option is turned on.  Remind the
&gt; application developer to use decoded_content&#40;&#41; if they want decoded
</div>content.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 3. Later, throw a hard error &#40;and reminder&#41; at the developer if the
&gt; option is enabled.
&gt; 
&gt; 4. Later, remove the transparent decoding feature and option altogether.
&gt; 
&gt; The option lets developers explicitly state what they want, and then
&gt; deprecation guides them into the new behavior.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;28&nbsp;13:34:26&nbsp;2008</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for your patient explanation.  Now I understand that it&#39;s safe
to remove the transparent gzip handling.  I have done this in revision
327, and I will shortly release the fix in version 0.84.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;28&nbsp;13:34:33&nbsp;2008</span>
    <span class="description">RCAPUTO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
