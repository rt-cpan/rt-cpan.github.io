<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #67292 for Test-TCP: Tests are blocking in Windows 7.  With a prposed patch.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #67292 for Test-TCP: Tests are blocking in Windows 7.  With a prposed patch.</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Test-TCP">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Test-TCP">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Test-TCP">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Test-TCP">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/tokuhirom/Test-TCP/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Test-TCP">Test-TCP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">67292</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Test-TCP">Test-TCP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bo.johansson [...] lsn.se

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-223460-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.12    </td>
  </tr>
  <tr id="CF-223461-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




diff.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1190875/628286/diff.txt">
Thu Mar 14 06:09:38 2013 (6.6k) by bo.johansson [...] lsn.se
</a>
</font></li>
</ul>


log1.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/920041/477324/log1.txt">
Thu Apr 07 01:38:55 2011 (2.9k) by bo.johansson [...] lsn.se
</a>
</font></li>
</ul>


log2.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/920041/477325/log2.txt">
Thu Apr 07 01:38:55 2011 (852b) by bo.johansson [...] lsn.se
</a>
</font></li>
</ul>


patch.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/920041/477326/patch.txt">
Thu Apr 07 01:38:55 2011 (4.1k) by bo.johansson [...] lsn.se
</a>
</font></li>
</ul>


TCP.pm<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1190875/628287/TCP.pm">
Thu Mar 14 06:09:38 2013 (5.7k) by bo.johansson [...] lsn.se
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=67292">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-920041" href="/Public/Bug/Display.html?id=67292#txn-920041">#</a>      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;07&nbsp;01:38:55&nbsp;2011</span>
    <span class="description">bo.johansson [...] lsn.se -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Tests are blocking in Windows 7.  With a prposed patch.</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/920041/477323/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/477323">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Problem:
The tests in Test::TCP are blocking. Sometimes get the system in state,
that it must be restarted.

I am using:
* Strawberry-perl-5.12.2.0
* Perl 5, version 12, subversion 2 &#40;v5.12.2&#41; built for
MSWin32-x86-multi-thread
* Windows 7 Home Premium with Service Pack 1


Proposal of change to Test-TCP.
===============================

Attached is a patch.

The purpose of the patch is to:

1&#41; Reduce the frequency of problems when using kill on a pseudo-proccess
in Windows.

2&#41; To avoid to use kill on a pseudo-process in the test of Test-TCP.

See also &#34;A safer way to kill pseudo-forked processes on Windows?&#34; in
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.gossamer-threads.com/lists/perl/porters/261805">http://www.gossamer-threads.com/lists/perl/porters/261805</a></span>.

This is to reduce the frequency when sub stop or &#34;sub DESTROY&#34; is used:
+    # kill is inherently unsafe for pseudo-processes in Windows
+    # and the process calling kill&#40;9, $pid&#41; may be destabilized
+    # The call to Sleep will decrease the frequency of this problems
+    Win32::Sleep&#40;0&#41; if $^O eq &#34;MSWin32&#34;; # will relinquish the
remainder of its time slice
+
     kill $TERMSIG =&gt; $self-&gt;{pid};
+
+    Win32::Sleep&#40;0&#41; if $^O eq &#34;MSWin32&#34;; # will relinquish the
remainder of its time slice
+


Other things that perhaps all should be changed.
=================================================
In t/01_simple.t

What is the purpose of &#34;for 1..10&#34; in this:

ok $port, &#34;test case for sharedfork&#34; for 1..10;


Can the test for &#34;leaks&#34; be removed? An example is:

if &#40;$?&#41; {
    # It&#39;s maybe ActivePerl&#39;s bug.
    #
<span class="clickylink"><a target="new" rel="nofollow" href="http://ppm4.activestate.com/MSWin32-x86/5.12/1200/T/TO/TOKUHIROM/Test-TCP-1.11.d/log-20101221T221845.txt">http://ppm4.activestate.com/MSWin32-x86/5.12/1200/T/TO/TOKUHIROM/Test-TCP-1.11.d/log-20101221T221845.txt</a></span>
    diag &#34;test_tcp&#40;&#41; leaks \$?. Maybe it&#39;s Perl bug?: $?&#34;;
    $? = 0;
}

Tests made 1.
=============

Batchfile used:

@echo off
set count=0
:loop
set /a count=%count%+1
echo Count %count%
@echo on
perl -Ilib -Iinc t/00_compile.t
perl -Ilib -Iinc t/01_simple.t
perl -Ilib -Iinc t/02_abrt.t
perl -Ilib -Iinc t/03_return_when_sigterm.t
perl -Ilib -Iinc t/04_die.t
perl -Ilib -Iinc t/05_sigint.t
perl -Ilib -Iinc t/06_nest.t
perl -Ilib -Iinc t/07_optional.t
perl -Ilib -Iinc t/08_exit.t
perl -Ilib -Iinc t/09_fork.t
perl -Ilib -Iinc t/10_oo.t
@echo off
goto loop

See example of output in attached file log1.txt.

Run more than 1000 loops without blocking.


Tests made 2.
=============

Batchfile used:
@echo off
set count=0
:loop
set /a count=%count%+1
echo Count %count%
@echo on
perl &#34;-MExtUtils::Command::MM&#34; &#34;-e&#34; &#34;test_harness&#40;0, &#39;inc&#39;, &#39;lib&#39;&#41;&#34;
t/00_compile.t t/01_simple.t t/02_abrt.t t/03_return_when_sigterm.t
t/04_die.t t/05_sigint.t t/06_nest.t t/07_optional.t t/08_exit.t
t/09_fork.t t/10_oo.t
@echo off
goto loop

See example of output in attached file log2.txt.

Run more than 1000 loops without blocking.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> log1.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/920041/477324/log1.txt">Download log1.txt</a><br />
<span class="downloadcontenttype">text/plain 2.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Count 1090

s:\wp\wpPerl\wpTestTcp&gt;perl -Ilib -Iinc t/00_compile.t
1..1
ok 1 - use Test::TCP;
# Test::More: 0.98

s:\wp\wpPerl\wpTestTcp&gt;perl -Ilib -Iinc t/01_simple.t
1..22
ok 1 - test case for sharedfork
ok 2 - test case for sharedfork
ok 3 - test case for sharedfork
ok 4 - test case for sharedfork
ok 5 - test case for sharedfork
ok 6 - test case for sharedfork
ok 7 - test case for sharedfork
ok 8 - test case for sharedfork
ok 9 - test case for sharedfork
ok 10 - test case for sharedfork
ok 11 - test case for sharedfork
ok 12 - test case for sharedfork
ok 13 - test case for sharedfork
ok 14 - test case for sharedfork
ok 15 - test case for sharedfork
ok 16 - test case for sharedfork
ok 17 - test case for sharedfork
ok 18 - test case for sharedfork
ok 19 - test case for sharedfork
ok 20 - test case for sharedfork
# send 1
# new request
ok 21
# send 2
# new request
ok 22
# finalize
# new request
# server exit

s:\wp\wpPerl\wpTestTcp&gt;perl -Ilib -Iinc t/02_abrt.t
1..0 # SKIP win32 doesn&#39;t support embedded function named dump&#40;&#41;

s:\wp\wpPerl\wpTestTcp&gt;perl -Ilib -Iinc t/03_return_when_sigterm.t
1..2
ok 1
ok 2 - test finished.

s:\wp\wpPerl\wpTestTcp&gt;perl -Ilib -Iinc t/04_die.t
1..3
ok 1
ok 2
ok 3 - already killed by test_tcp

s:\wp\wpPerl\wpTestTcp&gt;perl -Ilib -Iinc t/05_sigint.t
1..0 # SKIP this test requires SIGUSR1

s:\wp\wpPerl\wpTestTcp&gt;perl -Ilib -Iinc t/06_nest.t
1..1
ok 1 - 10375, 10635

s:\wp\wpPerl\wpTestTcp&gt;perl -Ilib -Iinc t/07_optional.t
1..2
ok 1 - One
ok 2 - Two

s:\wp\wpPerl\wpTestTcp&gt;perl -Ilib -Iinc t/08_exit.t
1..5
# SEVER: -1120
# CLIENT: -3376
ok 1 # skip not implemented on Win32
ok 2 # skip not implemented on Win32
ok 3 # skip not implemented on Win32
ok 4 # skip not implemented on Win32
ok 5

s:\wp\wpPerl\wpTestTcp&gt;perl -Ilib -Iinc t/09_fork.t
1..6
ok 1 - Successfully forked child -3120
ok 2 - Successfully forked child 0
ok 3 - Successfully executed child -3120
ok 4 - child exited normally
ok 5 - socket is connected
# new request
ok 6 - got expected reply
# finalize
# new request
# server exit
# exit

s:\wp\wpPerl\wpTestTcp&gt;perl -Ilib -Iinc t/10_oo.t
1..22
ok 1 - test case for sharedfork
ok 2 - test case for sharedfork
ok 3 - test case for sharedfork
ok 4 - test case for sharedfork
ok 5 - test case for sharedfork
ok 6 - test case for sharedfork
ok 7 - test case for sharedfork
ok 8 - test case for sharedfork
ok 9 - test case for sharedfork
ok 10 - test case for sharedfork
ok 11 - test case for sharedfork
ok 12 - test case for sharedfork
ok 13 - test case for sharedfork
ok 14 - test case for sharedfork
ok 15 - test case for sharedfork
ok 16 - test case for sharedfork
ok 17 - test case for sharedfork
ok 18 - test case for sharedfork
ok 19 - test case for sharedfork
ok 20 - test case for sharedfork
# send 1
# new request
ok 21
# send 2
# new request
ok 22
# finalize
# new request
# server exit
# exit
Count 1091
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> log2.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/920041/477325/log2.txt">Download log2.txt</a><br />
<span class="downloadcontenttype">text/plain 852b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Count 1056

s:\wp\wpPerl\wpTestTcp&gt;perl &#34;-MExtUtils::Command::MM&#34; &#34;-e&#34; &#34;test_harness&#40;0, &#39;inc&#39;, &#39;lib&#39;&#41;&#34; t/00_compile.t t/01_simple.t t/02_abrt.t t/03_return_when_sigterm.t t/04_die.t t/05_sigint.t t/06_nest.t t/07_optional.t t/08_exit.t t/09_fork.t t/10_oo.t 
t/00_compile.t .............. ok
t/01_simple.t ............... ok
t/02_abrt.t ................. skipped: win32 doesn&#39;t support embedded function named dump&#40;&#41;
t/03_return_when_sigterm.t .. ok
t/04_die.t .................. ok
t/05_sigint.t ............... skipped: this test requires SIGUSR1
t/06_nest.t ................. ok
t/07_optional.t ............. ok
t/08_exit.t ................. ok
t/09_fork.t ................. ok
t/10_oo.t ................... ok
All tests successful.
Files=11, Tests=64, 25 wallclock secs &#40; 0.19 usr +  0.08 sys =  0.27 CPU&#41;
Result: PASS
Count 1057
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/920041/477326/patch.txt">Download patch.txt</a><br />
<span class="downloadcontenttype">text/plain 4.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ur dist/lib/Test/TCP.pm modified/lib/Test/TCP.pm
--- dist/lib/Test/TCP.pm	2011-03-03 08:14:40.000000000 +0100
+++ modified/lib/Test/TCP.pm	2011-04-06 09:50:38.979000000 +0200
@@ -52,7 +52,7 @@
         port =&gt; $args{port} || empty_port&#40;&#41;,
     &#41;;
     $args{client}-&gt;&#40;$server-&gt;port, $server-&gt;pid&#41;;
-    undef $server; # make sure
+    return $server;
 }
 
 sub _check_port {
@@ -130,7 +130,15 @@
     return unless defined $self-&gt;{pid};
     return unless $self-&gt;{_my_pid} == $$;
 
+    # kill is inherently unsafe for pseudo-processes in Windows
+    # and the process calling kill&#40;9, $pid&#41; may be destabilized
+    # The call to Sleep will decrease the frequency of this problems
+    Win32::Sleep&#40;0&#41; if $^O eq &#34;MSWin32&#34;; # will relinquish the remainder of its time slice
+
     kill $TERMSIG =&gt; $self-&gt;{pid};
+
+    Win32::Sleep&#40;0&#41; if $^O eq &#34;MSWin32&#34;; # will relinquish the remainder of its time slice
+
     local $?; # waitpid modifies original $?.
     LOOP: while &#40;1&#41; {
         my $kid = waitpid&#40; $self-&gt;{pid}, 0 &#41;;
diff -ur dist/t/01_simple.t modified/t/01_simple.t
--- dist/t/01_simple.t	2010-08-15 15:21:39.000000000 +0200
+++ modified/t/01_simple.t	2011-04-06 23:21:19.257000000 +0200
@@ -27,6 +27,7 @@
 
         note &#34;finalize&#34;;
         print {$sock} &#34;quit\n&#34;;
+        sleep&#40;1&#41;;
     },
     server =&gt; sub {
         my $port = shift;
@@ -34,8 +35,11 @@
         t::Server-&gt;new&#40;$port&#41;-&gt;run&#40;sub {
             note &#34;new request&#34;;
             my &#40;$remote, $line, $sock&#41; = @_;
+            if &#40;$line eq &#34;quit\n&#34;&#41;{
+                note &#34;server exit&#34;;
+                exit 0;
+            };
             print {$remote} $line;
         }&#41;;
     },
 &#41;;
-
diff -ur dist/t/08_exit.t modified/t/08_exit.t
--- dist/t/08_exit.t	2010-08-24 06:08:16.000000000 +0200
+++ modified/t/08_exit.t	2011-04-06 23:29:18.714200000 +0200
@@ -36,6 +36,7 @@
     test_tcp&#40;
         client =&gt; sub {
             my $port = shift;
+            Win32::Sleep&#40;100&#41; if $^O eq &#34;MSWin32&#34;; # will relinquish the remainder of its time slice
             note &#34;CLIENT: $$&#34;;
             exit 1;
         },
diff -ur dist/t/09_fork.t modified/t/09_fork.t
--- dist/t/09_fork.t	2011-03-03 08:13:54.000000000 +0100
+++ modified/t/09_fork.t	2011-04-06 23:27:41.947400000 +0200
@@ -3,7 +3,7 @@
 use Test::TCP;
 use t::Server;
 
-test_tcp 
+my $server = test_tcp 
     client =&gt; sub {
         my $port = shift;
 
@@ -39,20 +39,32 @@
         print {$sock} &#34;Hello server\n&#34;;
         my $res = &lt;$sock&gt;;
         is $res, &#34;Hello server\n&#34;, &#34;got expected reply&#34;;
+
+        note &#34;finalize&#34;;
+        print {$sock} &#34;quit\n&#34;;
+        sleep&#40;1&#41;;
     },
     server =&gt; sub {
         my $port = shift;
         t::Server-&gt;new&#40;$port&#41;-&gt;run&#40;sub {
             note &#34;new request&#34;;
             my &#40;$remote, $line, $sock&#41; = @_;
+            if &#40;$line eq &#34;quit\n&#34;&#41;{
+                note &#34;server exit&#34;;
+                exit 0;
+            };
             print {$remote} $line;
         }&#41;;
     }
 ;
 
+$server-&gt;stop;
+
 if &#40;$?&#41; {
     # It&#39;s maybe ActivePerl&#39;s bug.
     # <span class="clickylink"><a target="new" rel="nofollow" href="http://ppm4.activestate.com/MSWin32-x86/5.12/1200/T/TO/TOKUHIROM/Test-TCP-1.11.d/log-20101221T221845.txt">http://ppm4.activestate.com/MSWin32-x86/5.12/1200/T/TO/TOKUHIROM/Test-TCP-1.11.d/log-20101221T221845.txt</a></span>
     diag &#34;test_tcp&#40;&#41; leaks \$?. Maybe it&#39;s Perl bug?: $?&#34;;
     $? = 0;
 }
+
+note &#34;exit&#34;;
\ Ingen nyrad vid filslut
diff -ur dist/t/10_oo.t modified/t/10_oo.t
--- dist/t/10_oo.t	2011-03-03 08:13:56.000000000 +0100
+++ modified/t/10_oo.t	2011-04-06 23:29:04.393400000 +0200
@@ -12,6 +12,10 @@
         t::Server-&gt;new&#40;$port&#41;-&gt;run&#40;sub {
             note &#34;new request&#34;;
             my &#40;$remote, $line, $sock&#41; = @_;
+            if &#40;$line eq &#34;quit\n&#34;&#41;{ # shut down server
+                note &#34;server exit&#34;;
+                exit 0;
+            };
             print {$remote} $line;
         }&#41;;
     }
@@ -35,7 +39,8 @@
 is $res2, &#34;bar\n&#34;;
 
 note &#34;finalize&#34;;
-print {$sock} &#34;quit\n&#34;;
+print {$sock} &#34;quit\n&#34;; # Shut down the server
+sleep&#40;1&#41;;
 
 if &#40;$?&#41; {
     # It&#39;s maybe ActivePerl&#39;s bug.
@@ -43,6 +48,6 @@
     diag &#34;test_tcp&#40;&#41; leaks \$?. Maybe it&#39;s Perl bug?: $?&#34;;
     $? = 0;
 }
-
+note &#34;exit&#34;;
 done_testing;
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1187167" href="/Public/Bug/Display.html?id=67292#txn-1187167">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;01&nbsp;18:53:09&nbsp;2013</span>
    <span class="description">tokuhirom+cpan [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1187167/626242/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/626242">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 63b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This patch was applied at 1.13.
&#40;Note, but it&#39;s still failing.&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1187169" href="/Public/Bug/Display.html?id=67292#txn-1187169">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;01&nbsp;18:53:09&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1190873" href="/Public/Bug/Display.html?id=67292#txn-1190873">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;14&nbsp;05:53:48&nbsp;2013</span>
    <span class="description">bo.johansson [...] lsn.se -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bo.johansson [...] lsn.se</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1190873/628282/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/628282">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Vid Fre, 01 Mar 2013 kl. 18.53.09, skrev TOKUHIROM:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This patch was applied at 1.13.
&gt; &#40;Note, but it&#39;s still failing.&#41;
</div>
!!!Only parts of the patch was applied!!!

The part to shut down the server without using kill 9 was omitted. In
Windows kill 9 on a process &#40;block in an I/O-operation&#41; must not be used.
From <span class="clickylink"><a target="new" rel="nofollow" href="http://perldoc.perl.org/perlfork.html">http://perldoc.perl.org/perlfork.html</a></span>: “The outcome of kill on a
pseudo-process is unpredictable and it should not be used except under
dire circumstances, because the operating system may not guarantee
integrity of the process resources when a running thread is terminated.”

I have done some analysis and ask for help. Posted
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=1021771">http://www.perlmonks.org/?node_id=1021771</a></span>, but didn&#39;t get much help. 

One of my conclusions is that there is still a probability that Windows
returns 9 instead of the correct zero. One failing subtest in about 140
test runs is a little bit to high!?

New types of errors seems also to have emerged.
One example is:
[Test::TCP] Child process does not block&#40;PID: -xxxx, PPID: xxxx&#41; at ..
+. \lib/Test/TCP.pm line 121.
t/xxxx.t ................. ok
 
Made a second try to get help with
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=1022364">http://www.perlmonks.org/?node_id=1022364</a></span>. Got there a proposal how to
improve “kill -9 style un-graceful exit” in win32/win32.c. However the
proposed change has limitations: “This code has a race condition: if the
hProcess thread exits with a different exitcode before the
TerminteThread&#40;&#41; manages to kill it. I don&#39;t know if TerminateThread
will still change the exit code of a thread that has already terminated.
I would suspect not, and in that case the following loop will never
terminate.”

If Test::TCP must use fork, at least in windows the server MUST be shut
down without using kill 9.

I have made a rough rewrite of Test::TCP to see if threads could be
used. See the attached files. I do not understand all the applications
so there are probably many mistakes!

Here follows some comments to my changes.

Test-TCP-1.21/lib/Net/EmptyPort.pm:

“`$^X -MNet::EmptyPort -echeck_port $port” does not work if perl is
started with “-I” switches.
Net::EmptyPort::check_port&#40;$port&#41; seem to work without starting a new
process.

Test-TCP-1.21/lib/Test/TCP.pm:
Do not to know what to do with server pid!
Is the pid need?

In Test-TCP-1.21/t/xxx.t

“use Test::TCP;” must come before “use Test::More tests =&gt; 99;”

The test files: 03_return_when_sigterm.t, 04_die.t, t: 08_exit.t and
09_fork.t are coupled to the usage of fork and should be replaced by
tests of the thread based solution.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1190875" href="/Public/Bug/Display.html?id=67292#txn-1190875">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;14&nbsp;06:09:38&nbsp;2013</span>
    <span class="description">bo.johansson [...] lsn.se -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bo.johansson [...] lsn.se</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1190875/628285/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/628285">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 25b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The file wasn&#39;t uploaded!
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> diff.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1190875/628286/diff.txt">Download diff.txt</a><br />
<span class="downloadcontenttype">text/plain 6.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">-*- mode: compilation; default-directory: &#34;s:/wp/wpPerl/wpTestTcp4/&#34; -*-
Compilation started at Thu Mar 14 09:37:48

diff -ru dist/Test-TCP-1.21/ Test-TCP-1.21/
diff -ru dist/Test-TCP-1.21/lib/Net/EmptyPort.pm Test-TCP-1.21/lib/Net/EmptyPort.pm
--- dist/Test-TCP-1.21/lib/Net/EmptyPort.pm	2013-03-03 04:07:54.000000000 +0100
+++ Test-TCP-1.21/lib/Net/EmptyPort.pm	2013-03-13 10:12:22.015757100 +0100
@@ -57,7 +57,7 @@
     $sleep ||= 0.1;
 
     while &#40; $retry-- &#41; {
-        if &#40;$^O eq &#39;MSWin32&#39; ? `$^X -MNet::EmptyPort -echeck_port $port` : check_port&#40; $port &#41;&#41; {
+        if &#40;$^O eq &#39;MSWin32&#39; ? `$^X -ITest-TCP-1.21/lib -MNet::EmptyPort -echeck_port $port` : check_port&#40; $port &#41;&#41; {
             return 1;
         }
         Time::HiRes::sleep&#40;$sleep&#41;;
Only in Test-TCP-1.21/lib/Test/TCP: CheckPort.pm~
diff -ru dist/Test-TCP-1.21/lib/Test/TCP.pm Test-TCP-1.21/lib/Test/TCP.pm
--- dist/Test-TCP-1.21/lib/Test/TCP.pm	2013-03-03 04:34:52.000000000 +0100
+++ Test-TCP-1.21/lib/Test/TCP.pm	2013-03-14 09:24:35.315907700 +0100
@@ -3,21 +3,17 @@
 use warnings;
 use 5.00800;
 our $VERSION = &#39;1.21&#39;;
+use threads;
 use base qw/Exporter/;
 use IO::Socket::INET;
-use Test::SharedFork 0.12;
-use Test::More &#40;&#41;;
-use Config;
-use POSIX;
+#use Config;
+#use POSIX;
 use Time::HiRes &#40;&#41;;
-use Carp &#40;&#41;;
+use Carp        &#40;&#41;;
 use Net::EmptyPort qw&#40;empty_port check_port&#41;;
 
 our @EXPORT = qw/ empty_port test_tcp wait_port /;
 
-# process does not die when received SIGTERM, on win32.
-my $TERMSIG = $^O eq &#39;MSWin32&#39; ? &#39;KILL&#39; : &#39;TERM&#39;;
-
 sub test_tcp {
     my %args = @_;
     for my $k &#40;qw/client server/&#41; {
@@ -27,15 +23,21 @@
         code =&gt; $args{server},
         port =&gt; $args{port} || empty_port&#40;&#41;,
     &#41;;
-    $args{client}-&gt;&#40;$server-&gt;port, $server-&gt;pid&#41;;
-    undef $server; # make sure
+    $args{client}-&gt;&#40; $server-&gt;port&#41;;
+    undef $server;    # make sure
 }
 
 sub wait_port {
     my $port = shift;
 
-    Net::EmptyPort::wait_port&#40;$port, 0.1, 100&#41;
-        or die &#34;cannot open port: $port&#34;;
+    my $retry = 100;
+    my $sleep = 0,1;
+    while &#40; $retry-- &#41;{
+        return 1 if Net::EmptyPort::check_port&#40;$port&#41;;
+        Time::HiRes::sleep&#40;$sleep&#41;;
+    };
+
+    die &#34;cannot open port: $port&#34;;
 }
 
 # ------------------------------------------------------------------------- 
@@ -43,7 +45,7 @@
 
 sub new {
     my $class = shift;
-    my %args = @_==1 ? %{$_[0]} : @_;
+    my %args = @_ == 1 ? %{ $_[0] } : @_;
     Carp::croak&#40;&#34;missing mandatory parameter &#39;code&#39;&#34;&#41; unless exists $args{code};
     my $self = bless {
         auto_start =&gt; 1,
@@ -56,67 +58,22 @@
     return $self;
 }
 
-sub pid  { $_[0]-&gt;{pid} }
+#sub pid  { $_[0]-&gt;{pid} }
 sub port { $_[0]-&gt;{port} }
 
 sub start {
-    my $self = shift;
-    if &#40; my $pid = fork&#40;&#41; &#41; {
-        # parent.
-        $self-&gt;{pid} = $pid;
-        Test::TCP::wait_port&#40;$self-&gt;port&#41;;
-        return;
-    } elsif &#40;$pid == 0&#41; {
-        # child process
-        $self-&gt;{code}-&gt;&#40;$self-&gt;port&#41;;
-        # should not reach here
-        if &#40;kill 0, $self-&gt;{_my_pid}&#41; { # warn only parent process still exists
-            warn&#40;&#34;[Test::TCP] Child process does not block&#40;PID: $$, PPID: $self-&gt;{_my_pid}&#41;&#34;&#41;;
-        }
-        exit 0;
-    } else {
-        die &#34;fork failed: $!&#34;;
-    }
+    my $self   = shift;
+    my $port   = $self-&gt;port;
+    my $server = threads-&gt;create&#40; $self-&gt;{code}, $self-&gt;port &#41;;
+    $self-&gt;{server_thread} = $server;
+    Test::TCP::wait_port&#40; $self-&gt;port &#41;;
+    return $self;
 }
 
 sub stop {
     my $self = shift;
-
-    return unless defined $self-&gt;{pid};
-    return unless $self-&gt;{_my_pid} == $$;
-
-    # This is a workaround for win32 fork emulation&#39;s bug.
-    #
-    # kill is inherently unsafe for pseudo-processes in Windows
-    # and the process calling kill&#40;9, $pid&#41; may be destabilized
-    # The call to Sleep will decrease the frequency of this problems
-    #
-    # SEE ALSO:
-    #   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.gossamer-threads.com/lists/perl/porters/261805">http://www.gossamer-threads.com/lists/perl/porters/261805</a></span>
-    #   <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67292">https://rt.cpan.org/Ticket/Display.html?id=67292</a></span>
-    Win32::Sleep&#40;0&#41; if $^O eq &#34;MSWin32&#34;; # will relinquish the remainder of its time slice
-
-        kill $TERMSIG =&gt; $self-&gt;{pid};
-
-    Win32::Sleep&#40;0&#41; if $^O eq &#34;MSWin32&#34;; # will relinquish the remainder of its time slice
-
-
-    local $?; # waitpid modifies original $?.
-    LOOP: while &#40;1&#41; {
-        my $kid = waitpid&#40; $self-&gt;{pid}, 0 &#41;;
-        if &#40;$^O ne &#39;MSWin32&#39;&#41; { # i&#39;m not in hell
-            if &#40;POSIX::WIFSIGNALED&#40;$?&#41;&#41; {
-                my $signame = &#40;split&#40;&#39; &#39;, $Config{sig_name}&#41;&#41;[POSIX::WTERMSIG&#40;$?&#41;];
-                if &#40;$signame =~ /^&#40;ABRT|PIPE&#41;$/&#41; {
-                    Test::More::diag&#40;&#34;your server received SIG$signame&#34;&#41;;
-                }
-            }
-        }
-        if &#40;$kid == 0 || $kid == -1&#41; {
-            last LOOP;
-        }
-    }
-    undef $self-&gt;{pid};
+    $self-&gt;{server_thread} &#38;&#38; $self-&gt;{server_thread}-&gt;detach;
+    return $self;
 }
 
 sub DESTROY {
diff -ru dist/Test-TCP-1.21/t/01_simple.t Test-TCP-1.21/t/01_simple.t
--- dist/Test-TCP-1.21/t/01_simple.t	2012-04-09 05:25:32.000000000 +0200
+++ Test-TCP-1.21/t/01_simple.t	2013-03-14 07:45:37.162588500 +0100
@@ -1,7 +1,7 @@
 use warnings;
 use strict;
-use Test::More tests =&gt; 22;
 use Test::TCP;
+use Test::More tests =&gt; 22;
 use IO::Socket::INET;
 use t::Server;
 
Only in dist/Test-TCP-1.21/t: 03_return_when_sigterm.t
Only in Test-TCP-1.21/t: 03_return_when_sigterm.t_not_used
diff -ru dist/Test-TCP-1.21/t/04_die.t Test-TCP-1.21/t/04_die.t
--- dist/Test-TCP-1.21/t/04_die.t	2012-04-09 05:25:32.000000000 +0200
+++ Test-TCP-1.21/t/04_die.t	2013-03-14 09:11:08.559776900 +0100
@@ -1,7 +1,7 @@
 use warnings;
 use strict;
-use Test::More tests =&gt; 3;
 use Test::TCP;
+use Test::More tests =&gt; 2;
 use IO::Socket::INET;
 use t::Server;
 
@@ -23,8 +23,8 @@
 my $e = $@;
 ok $e;
 like $e, qr/sinamon/;
-my $killed = kill 9, $child_pid;
-is $killed, 0, &#34;already killed by test_tcp&#34;;
+#my $killed = kill 9, $child_pid;
+#is $killed, 0, &#34;already killed by test_tcp&#34;;
 
 if &#40;$?&#41; {
     # It&#39;s maybe ActivePerl&#39;s bug.
Only in dist/Test-TCP-1.21/t: 08_exit.t
Only in Test-TCP-1.21/t: 08_exit.t_not_used
Only in dist/Test-TCP-1.21/t: 09_fork.t
Only in Test-TCP-1.21/t: 09_fork.t_not_used
diff -ru dist/Test-TCP-1.21/t/10_oo.t Test-TCP-1.21/t/10_oo.t
--- dist/Test-TCP-1.21/t/10_oo.t	2012-04-09 05:25:32.000000000 +0200
+++ Test-TCP-1.21/t/10_oo.t	2013-03-14 07:50:13.310976700 +0100
@@ -1,7 +1,7 @@
 use warnings;
 use strict;
-use Test::More tests =&gt; 22;
 use Test::TCP;
+use Test::More tests =&gt; 22;
 use IO::Socket::INET;
 use t::Server;
 

Compilation exited abnormally with code 1 at Thu Mar 14 09:37:48
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> TCP.pm</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1190875/628287/TCP.pm">Download TCP.pm</a><br />
<span class="downloadcontenttype">text/x-perl 5.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">package Test::TCP;
use strict;
use warnings;
use 5.00800;
our $VERSION = &#39;1.21&#39;;
use threads;
use base qw/Exporter/;
use IO::Socket::INET;
#use Config;
#use POSIX;
use Time::HiRes &#40;&#41;;
use Carp        &#40;&#41;;
use Net::EmptyPort qw&#40;empty_port check_port&#41;;

our @EXPORT = qw/ empty_port test_tcp wait_port /;

sub test_tcp {
    my %args = @_;
    for my $k &#40;qw/client server/&#41; {
        die &#34;missing madatory parameter $k&#34; unless exists $args{$k};
    }
    my $server = Test::TCP-&gt;new&#40;
        code =&gt; $args{server},
        port =&gt; $args{port} || empty_port&#40;&#41;,
    &#41;;
    $args{client}-&gt;&#40; $server-&gt;port&#41;;
    undef $server;    # make sure
}

sub wait_port {
    my $port = shift;

    my $retry = 100;
    my $sleep = 0,1;
    while &#40; $retry-- &#41;{
        return 1 if Net::EmptyPort::check_port&#40;$port&#41;;
        Time::HiRes::sleep&#40;$sleep&#41;;
    };

    die &#34;cannot open port: $port&#34;;
}

# ------------------------------------------------------------------------- 
# OO-ish interface

sub new {
    my $class = shift;
    my %args = @_ == 1 ? %{ $_[0] } : @_;
    Carp::croak&#40;&#34;missing mandatory parameter &#39;code&#39;&#34;&#41; unless exists $args{code};
    my $self = bless {
        auto_start =&gt; 1,
        _my_pid    =&gt; $$,
        %args,
    }, $class;
    $self-&gt;{port} = empty_port&#40;&#41; unless exists $self-&gt;{port};
    $self-&gt;start&#40;&#41;
      if $self-&gt;{auto_start};
    return $self;
}

#sub pid  { $_[0]-&gt;{pid} }
sub port { $_[0]-&gt;{port} }

sub start {
    my $self   = shift;
    my $port   = $self-&gt;port;
    my $server = threads-&gt;create&#40; $self-&gt;{code}, $self-&gt;port &#41;;
    $self-&gt;{server_thread} = $server;
    Test::TCP::wait_port&#40; $self-&gt;port &#41;;
    return $self;
}

sub stop {
    my $self = shift;
    $self-&gt;{server_thread} &#38;&#38; $self-&gt;{server_thread}-&gt;detach;
    return $self;
}

sub DESTROY {
    my $self = shift;
    local $@;
    $self-&gt;stop&#40;&#41;;
}

1;
__END__

=encoding utf8

=head1 NAME

Test::TCP - testing TCP program

=head1 SYNOPSIS

    use Test::TCP;

    my $server = Test::TCP-&gt;new&#40;
        code =&gt; sub {
            my $port = shift;
            ...
        },
    &#41;;
    my $client = MyClient-&gt;new&#40;host =&gt; &#39;127.0.0.1&#39;, port =&gt; $server-&gt;port&#41;;
    undef $server; # kill child process on DESTROY

Using memcached:

    use Test::TCP;

    my $memcached = Test::TCP-&gt;new&#40;
        code =&gt; sub {
            my $port = shift;

            exec $bin, &#39;-p&#39; =&gt; $port;
            die &#34;cannot execute $bin: $!&#34;;
        },
    &#41;;
    my $memd = Cache::Memcached-&gt;new&#40;{servers =&gt; [&#39;127.0.0.1:&#39; . $memcached-&gt;port]}&#41;;
    ...

And functional interface is available:

    use Test::TCP;
    test_tcp&#40;
        client =&gt; sub {
            my &#40;$port, $server_pid&#41; = @_;
            # send request to the server
        },
        server =&gt; sub {
            my $port = shift;
            # run server
        },
    &#41;;

=head1 DESCRIPTION

Test::TCP is test utilities for TCP/IP programs.

=head1 METHODS

=over 4

=item test_tcp

Functional interface.

    test_tcp&#40;
        client =&gt; sub {
            my $port = shift;
            # send request to the server
        },
        server =&gt; sub {
            my $port = shift;
            # run server
        },
        # optional
        port =&gt; 8080
    &#41;;

=item wait_port

    wait_port&#40;8080&#41;;

Waits for a particular port is available for connect.

=back

=head1 OO-ish interface

=over 4

=item my $server = Test::TCP-&gt;new&#40;%args&#41;;

Create new instance of Test::TCP.

Arguments are following:

=over 4

=item $args{auto_start}: Boolean

Call C&lt;&lt; $server-&gt;start&#40;&#41; &gt;&gt; after create instance.

Default: true

=item $args{code}: CodeRef

The callback function. Argument for callback function is: C&lt;&lt; $code-&gt;&#40;$pid&#41; &gt;&gt;.

This parameter is required.

=back

=item $server-&gt;start&#40;&#41;

Start the server process. Normally, you don&#39;t need to call this method.

=item $server-&gt;stop&#40;&#41;

Stop the server process.

=item my $pid = $server-&gt;pid&#40;&#41;;

Get the pid of child process.

=item my $port = $server-&gt;port&#40;&#41;;

Get the port number of child process.

=back

=head1 FAQ

=over 4

=item How to invoke two servers?

You can call test_tcp&#40;&#41; twice!

    test_tcp&#40;
        client =&gt; sub {
            my $port1 = shift;
            test_tcp&#40;
                client =&gt; sub {
                    my $port2 = shift;
                    # some client code here
                },
                server =&gt; sub {
                    my $port2 = shift;
                    # some server2 code here
                },
            &#41;;
        },
        server =&gt; sub {
            my $port1 = shift;
            # some server1 code here
        },
    &#41;;

Or use OO-ish interface instead.

    my $server1 = Test::TCP-&gt;new&#40;code =&gt; sub {
        my $port1 = shift;
        ...
    }&#41;;
    my $server2 = Test::TCP-&gt;new&#40;code =&gt; sub {
        my $port2 = shift;
        ...
    }&#41;;

    # your client code here.
    ...

=item How do you test server program written in other languages like memcached?

You can use C&lt;exec&#40;&#41;&gt; in child process.

    use strict;
    use warnings;
    use utf8;
    use Test::More;
    use Test::TCP 1.08;
    use File::Which;

    my $bin = scalar which &#39;memcached&#39;;
    plan skip_all =&gt; &#39;memcached binary is not found&#39; unless defined $bin;

    my $memcached = Test::TCP-&gt;new&#40;
        code =&gt; sub {
            my $port = shift;

            exec $bin, &#39;-p&#39; =&gt; $port;
            die &#34;cannot execute $bin: $!&#34;;
        },
    &#41;;

    use Cache::Memcached;
    my $memd = Cache::Memcached-&gt;new&#40;{servers =&gt; [&#39;127.0.0.1:&#39; . $memcached-&gt;port]}&#41;;
    $memd-&gt;set&#40;foo =&gt; &#39;bar&#39;&#41;;
    is $memd-&gt;get&#40;&#39;foo&#39;&#41;, &#39;bar&#39;;

    done_testing;

=back

=head1 AUTHOR

Tokuhiro Matsuno E&lt;lt&gt;tokuhirom@gmail.comE&lt;gt&gt;

=head1 THANKS TO

kazuhooku

dragon3

charsbar

Tatsuhiko Miyagawa

lestrrat

=head1 SEE ALSO

=head1 LICENSE

This library is free software; you can redistribute it and/or modify
it under the same terms as Perl itself.

=cut
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1196003" href="/Public/Bug/Display.html?id=67292#txn-1196003">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;29&nbsp;02:59:02&nbsp;2013</span>
    <span class="description">tokuhirom+cpan [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1196003/631201/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/631201">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 78b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I hope the issue was resolved by other ticket. Does the issue still happening?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1199470" href="/Public/Bug/Display.html?id=67292#txn-1199470">#</a>      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;07&nbsp;13:13:23&nbsp;2013</span>
    <span class="description">bo.johansson [...] lsn.se -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bo.johansson [...] lsn.se</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1199470/633228/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/633228">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Vid Fre, 29 Mar 2013 kl. 02.59.02, skrev TOKUHIROM:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I hope the issue was resolved by other ticket. Does the issue still
&gt; happening?
</div>The issue is still happening!

As earlier stated:

In Windows kill 9 on a process &#40;blocked in an I/O-operation&#41; must not be used.

“The outcome of kill on a pseudo-process is unpredictable and it should not be used except under dire circumstances, because the operating system may not guarantee integrity of the process resources when a running thread is terminated.”

If Test::TCP must use fork, at least in windows the server MUST be shut down without using kill 9.

I have used this batch-file to run the tests:

@echo off
set count=0
:loop
set /a count=%count%+1
echo Count %count%
@echo on
perl -ITest-TCP-1.26/lib -ITest-TCP-1.26 Test-TCP-1.26/t/00_compile.t
ECHO.%ERRORLEVEL%
perl -ITest-TCP-1.26/lib -ITest-TCP-1.26 Test-TCP-1.26/t/01_simple.t
ECHO.%ERRORLEVEL%
perl -ITest-TCP-1.26/lib -ITest-TCP-1.26 Test-TCP-1.26/t/02_abrt.t
ECHO.%ERRORLEVEL%
perl -ITest-TCP-1.26/lib -ITest-TCP-1.26 Test-TCP-1.26/t/03_return_when_sigterm.t
ECHO.%ERRORLEVEL%
perl -ITest-TCP-1.26/lib -ITest-TCP-1.26 Test-TCP-1.26/t/04_die.t
ECHO.%ERRORLEVEL%
perl -ITest-TCP-1.26/lib -ITest-TCP-1.26 Test-TCP-1.26/t/05_sigint.t
ECHO.%ERRORLEVEL%
perl -ITest-TCP-1.26/lib -ITest-TCP-1.26 Test-TCP-1.26/t/06_nest.t
ECHO.%ERRORLEVEL%
perl -ITest-TCP-1.26/lib -ITest-TCP-1.26 Test-TCP-1.26/t/07_optional.t
ECHO.%ERRORLEVEL%
perl -ITest-TCP-1.26/lib -ITest-TCP-1.26 Test-TCP-1.26/t/08_exit.t
ECHO.%ERRORLEVEL%
perl -ITest-TCP-1.26/lib -ITest-TCP-1.26 Test-TCP-1.26/t/09_fork.t
ECHO.%ERRORLEVEL%
perl -ITest-TCP-1.26/lib -ITest-TCP-1.26 Test-TCP-1.26/t/10_oo.t
ECHO.%ERRORLEVEL%
@echo off
goto loop

Running the loop in the batch-file 1000 times I typically results in:

- 10 times: Faulty return value 9 from a test.
- One time: Perl is stuck and must be killed.
- One time: Operating system says “Perl has stopped working”.

Running the test from a Perl program or using a more loaded system increases the error rate.
The tests was done using Windows 7, perl 5, version 16, subversion 3 &#40;v5.16.3&#41; built for MSWin32-x64-multi-thread and Test-TCP-1.26.

Note: Test-TCP-1.26/lib/Net/EmptyPort.pm: “`$^X -MNet::EmptyPort -echeck_port $port” does not work if perl is started with “-I” switches.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.540325</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
