<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #56926 for Schedule-Cron: Program quits after 64 launches under Windows</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #56926 for Schedule-Cron: Program quits after 64 launches under Windows</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Schedule-Cron">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Schedule-Cron">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Schedule-Cron">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Schedule-Cron">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Schedule-Cron">Schedule-Cron CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">56926</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Schedule-Cron">Schedule-Cron</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">roland [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
rene [...] margar.fr

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-28310-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.00_1    </td>
  </tr>
  <tr id="CF-28311-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




Cron_patch.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/768364/397572/Cron_patch.txt">
Mon Apr 26 07:20:23 2010 (624b) by rene [...] margar.fr
</a>
</font></li>
</ul>


reaper.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/784464/406379/reaper.pl">
Mon May 31 11:22:00 2010 (1.4k) by rene [...] margar.fr
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/777075/402467/reaper.pl">
Fri May 14 13:25:02 2010 (1.3k) by roland [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=56926">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-768364" href="/Public/Bug/Display.html?id=56926#txn-768364">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;26&nbsp;07:20:23&nbsp;2010</span>
    <span class="description">rene [...] margar.fr -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Program quits after 64 launches under Windows</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/768364/397571/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/397571">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 736b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here you can find a fix to make Schedule::Cron work on a Windows 
platform using activeperl distribution &#40;5.8.4 and above&#41;.

On windows fork is emulated with threads, handler defined for $SIG
{&#39;CHLD&#39;} is never called. Perl can&#39;t handle more than 64 &#34;zombies&#34; 
waiting for the parent to get the return code. When the 65th 
terminates, the main program quits with no error message.

All we need is to acknowledge regularly for terminated sub processes 
using the waitpid function.

Under windows REAPER function has to deal with negative pids to clean 
STARTEDCHILD hash.

As a patch, I send you as an attachment a replacement code for 
functions REAPER and _cleanup_process_list. It makes this module works 
under both UNIX and Windows.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Cron_patch.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/768364/397572/Cron_patch.txt">Download Cron_patch.txt</a><br />
<span class="downloadcontenttype">text/plain 624b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">sub REAPER {
    if &#40;$HAS_POSIX&#41;
    {
		while &#40;my $kid = waitpid&#40;-1, WNOHANG&#41;&#41;
		{
			if &#40;defined $STARTEDCHILD{$kid}&#41;
			{
				$STARTEDCHILD{$kid} = 0;
				dbg &#34;REAPER: Child $kid cleanned&#34;;
			}
		}
    }
    else
    {
        my $waitedpid = 0;
        while&#40;$waitedpid != -1&#41; {
            $waitedpid = wait;
			if &#40;defined $STARTEDCHILD{$waitedpid}&#41;
			{
				$STARTEDCHILD{$waitedpid} = 0;
				dbg &#34;REAPER: Child $waitedpid cleanned&#34;;
			}
        }
    }
}

sub _cleanup_process_list {
	REAPER&#40;&#41; if &#40;$HAS_POSIX&#41;;
    for my $k &#40;keys %STARTEDCHILD&#41; {
        delete $STARTEDCHILD{$k} unless $STARTEDCHILD{$k};
    }
}</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-777071" href="/Public/Bug/Display.html?id=56926#txn-777071">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;14&nbsp;13:23:41&nbsp;2010</span>
    <span class="description">roland [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/777071/402463/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/402463">with headers</a>
<br />
<span class="downloadcontenttype">text/html 868b</span>
</div>
<div class="messagebody">
<div class="message-stanza"><div>Hi Rene,&nbsp;</div>


<div>&nbsp;</div>


<div>thanx for your patch. I 'optimized' it a bit (since there came in <br>
some other patches, too in the meantime)&nbsp;and put it into</div>


<div>a 1.01_1 release (I publish it this evening). Since the patch</div>


<div>affects a very critical place (several tickets were open around</div>


<div>the signal handling), I would like to ask you to review my changes</div>


<div>and whether you see any problems (and whether I understand the issue</div>


<div>right). This would be of great help for me.</div>


<div>&nbsp;</div>


<div>If everything works well, I will put out a 1.01 release rather soon.</div>


<div>&nbsp;</div>


<div>I attachted&nbsp;my changes along with some comments but you can look into&nbsp;</div>


<div>1.01_1 soon directly&nbsp;<br>
<br>
ciao ...<br>
...roland</div>


<div>
<p>&nbsp;</p>

</div>

<br>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-777073" href="/Public/Bug/Display.html?id=56926#txn-777073">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;14&nbsp;13:23:44&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-777074" href="/Public/Bug/Display.html?id=56926#txn-777074">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;14&nbsp;13:24:15&nbsp;2010</span>
    <span class="description">roland [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-777075" href="/Public/Bug/Display.html?id=56926#txn-777075">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;14&nbsp;13:25:02&nbsp;2010</span>
    <span class="description">roland [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/777075/402466/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/402466">with headers</a>
<br />
<span class="downloadcontenttype">text/html 22b</span>
</div>
<div class="messagebody">
<div class="message-stanza">Chanes to sub REAPER()
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> reaper.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/777075/402467/reaper.pl">Download reaper.pl</a><br />
<span class="downloadcontenttype">text/x-perl 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">sub REAPER {
    local &#40;$!,%!&#41;;
    my $kid;
    do {
        # Only on POSIX systems the wait will return immediately only 
        # if there are no finished child processes. Simple &#39;wait&#39; will
        # wait blocking on childs.
        $kid = $HAS_POSIX ? waitpid&#40;-1, WNOHANG&#41; : wait;
        if &#40;$kid &gt; 0 &#38;&#38; defined $STARTEDCHILD{$kid}&#41; {
            # We don&#39;t delete the hash entry here to avoid an issue
            # when modifying a global hash from multiple threads
            $STARTEDCHILD{$kid} = 0;
        }
    } while &#40;$kid &gt; 0&#41;;
}

# Cleaning is done in extra method called from the main 
# process in order to avoid event handlers modifying this
# global hash which can lead to memory errors.
# See RT #55741 for more details on this.
# This method is called in strategic places.
sub _cleanup_process_list {
    # Cleanup processes even on those systems, where the SIGCHLD is not 
    # propagated. Only do this for POSIX, otherwise this call would block 
    # until all child processes would have been finished.
    # See RT #56926 for more details.
    &#38;REAPER&#40;&#41; if $HAS_POSIX;

    # Delete entries from this global hash only from within the main
    # thread/process. Hence, this method must not be called from within 
    # a signalhandler    
    for my $k &#40;keys %STARTEDCHILD&#41; {
        delete $STARTEDCHILD{$k} unless $STARTEDCHILD{$k};
    }
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-781773" href="/Public/Bug/Display.html?id=56926#txn-781773">#</a>      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;25&nbsp;04:35:49&nbsp;2010</span>
    <span class="description">rene [...] margar.fr -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rene [...] margar.fr</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/781773/404897/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/404897">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 494b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you, I&#39;m testing the new code.

With my patch I had some troubles when calling REAPER in
_cleanup_process_list when using the nofork option but with your new
code it works. I don&#39;t know why yet.

The REAPER code must handle negative PIDs as Win32 port of perl uses
windows threads to emulate fork &#38; waitpid functions. Such forked
processes have negative PIDs. If checking for strict $kid &gt; 0, the
%STARTCHILD hash will never be cleared.

I&#39;m still working on this to give you my feedback.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-784464" href="/Public/Bug/Display.html?id=56926#txn-784464">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;31&nbsp;11:22:00&nbsp;2010</span>
    <span class="description">rene [...] margar.fr -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rene [...] margar.fr</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/784464/406378/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/406378">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 333b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hang was caused by an infinite loop in REAPER code when called by
_cleanup_process_list under Windows as PID can be negative. I&#39;ve changed
the conditions in REAPER to enable negative PID except -1 which is an
error code.

Now it works fine in Windows &#38; Unix even when running in nofork mode.

See attached modified code.

Slts,
RenÃ©
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> reaper.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/784464/406379/reaper.pl">Download reaper.pl</a><br />
<span class="downloadcontenttype">text/x-perl 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">sub REAPER {
    local &#40;$!,%!&#41;;
    my $kid;
    do {
        # Only on POSIX systems the wait will return immediately only 
        # if there are no finished child processes. Simple &#39;wait&#39; will
        # wait blocking on childs.
        $kid = $HAS_POSIX ? waitpid&#40;-1, WNOHANG&#41; : wait;
        if &#40;$kid != 0 &#38;&#38; $kid != -1 &#38;&#38; defined $STARTEDCHILD{$kid}&#41; {
            # We don&#39;t delete the hash entry here to avoid an issue
            # when modifying a global hash from multiple threads
            $STARTEDCHILD{$kid} = 0;
			dbg &#34;REAPER: Child $kid cleanned&#34;;
        }
    } while &#40;$kid != 0 &#38;&#38; $kid != -1&#41;;
}

# Cleaning is done in extra method called from the main 
# process in order to avoid event handlers modifying this
# global hash which can lead to memory errors.
# See RT #55741 for more details on this.
# This method is called in strategic places.
sub _cleanup_process_list {
    # Cleanup processes even on those systems, where the SIGCHLD is not 
    # propagated. Only do this for POSIX, otherwise this call would block 
    # until all child processes would have been finished.
    # See RT #56926 for more details.
    &#38;REAPER&#40;&#41; if $HAS_POSIX;

    # Delete entries from this global hash only from within the main
    # thread/process. Hence, this method must not be called from within 
    # a signalhandler    
    for my $k &#40;keys %STARTEDCHILD&#41; {
        delete $STARTEDCHILD{$k} unless $STARTEDCHILD{$k};
    }
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-941562" href="/Public/Bug/Display.html?id=56926#txn-941562">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;02&nbsp;09:50:16&nbsp;2011</span>
    <span class="description">roland [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/941562/489520/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/489520">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza">Thans for the confirmation. However, I had to rework the code again, since<br>

waiting on any PID doesn't work if &nbsp;cron jobs forks processes on their own.&nbsp;<br>

<br>

E.g. if a job uses 'system()' and forks aways, the reaper with 'watpid(-1)' will&nbsp;<br>

also wait on those processes which in turn causes the system() to return&nbsp;<br>

with an error (&quot;No child processes&quot;) since it couldn't reap the process<br>

on its own.&nbsp;<br>

<br>

So I reverted back to the algorithm, which only reaps known childs (waitpid($pid)),&nbsp;<br>

but still call the reaper from strategical points in the code (not only<br>

from the SIGCHLD handler).&nbsp;<br>

<br>

I hope, this still fixes the issues with windows not calling SIGCHLD handler, but&nbsp;<br>

I can't verify this. Could you verify this issue ? (I know, it took me some<br>

time to come back to this bug again ;-). I just released a version 1.01_2 <br>

with this new behaviour.<br>

<br>

thanks ...<br>

... roland<br>

<br>

On Mon May 31 11:22:00 2010, rene@margar.fr wrote: <br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hang was caused by an infinite loop in REAPER code when called by <br>

&gt; _cleanup_process_list under Windows as PID can be negative. I've changed <br>

&gt; the conditions in REAPER to enable negative PID except -1 which is an <br>

&gt; error code. <br>

&gt;  <br>

&gt; Now it works fine in Windows &amp; Unix even when running in nofork mode. <br>

&gt;  <br>

&gt; See attached modified code. <br>

&gt;  <br>

&gt; Slts, <br>

&gt; Ren&eacute; <br>
</div><br>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-943874" href="/Public/Bug/Display.html?id=56926#txn-943874">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;10&nbsp;02:08:45&nbsp;2011</span>
    <span class="description">roland [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/943874/490772/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/490772">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza">Hi Rene,&nbsp;<br>

<br>

i know this ticket is open for quite some time and Schedule::Cron was not under&nbsp;<br>

active development for more than a year now, but release 1.01 has been pushed<br>

to CPAN last week which *should* fix this bug. However, I currently has not the&nbsp;<br>

proper environment for testing this so I'd like you to ask, if you could please<br>

check whether 1.01 really fixes this bug so that I could close this ticket.<br>

<br>

If you don't have time for this, no problem, but please leave me a short note so that<br>

I can try to verify it on my own (when I have time ;-)<br>

<br>

ciao ...<br>

... roland<br>

<br>

On Mon May 31 11:22:00 2010, rene@margar.fr wrote: <br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hang was caused by an infinite loop in REAPER code when called by <br>

&gt; _cleanup_process_list under Windows as PID can be negative. I've changed <br>

&gt; the conditions in REAPER to enable negative PID except -1 which is an <br>

&gt; error code. <br>

&gt;  <br>

&gt; Now it works fine in Windows &amp; Unix even when running in nofork mode. <br>

&gt;  <br>

&gt; See attached modified code. <br>

&gt;  <br>

&gt; Slts, <br>

&gt; Ren&eacute; <br>
</div><br>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-945084" href="/Public/Bug/Display.html?id=56926#txn-945084">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;14&nbsp;05:30:57&nbsp;2011</span>
    <span class="description">rene [...] margar.fr -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rene [...] margar.fr</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/945084/491382/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/491382">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Roland,

I was not available last weeks, I will take a look on your code update 
these days and I&#39;ll tell you what I see on my windows platform.

Thank you,
RenÃ©


Le Ven 10 Juin 2011 02:08:45, ROLAND a Ã©critÂ :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Rene,
&gt; 
&gt; i know this ticket is open for quite some time and Schedule::Cron was
&gt; not under
&gt; active development for more than a year now, but release 1.01 has been
&gt; pushed
&gt; to CPAN last week which *should* fix this bug. However, I currently
&gt; has not the
&gt; proper environment for testing this so I&#39;d like you to ask, if you
&gt; could please
&gt; check whether 1.01 really fixes this bug so that I could close this
&gt; ticket.
&gt; 
&gt; If you don&#39;t have time for this, no problem, but please leave me a
&gt; short note
&gt; so that
&gt; I can try to verify it on my own &#40;when I have time ;-&#41;
&gt; 
&gt; ciao ...
&gt; ... roland
&gt; 
&gt; On Mon May 31 11:22:00 2010, rene@margar.fr wrote:
<div class="message-stanza open">&gt; &gt; Hang was caused by an infinite loop in REAPER code when called by
&gt; &gt; _cleanup_process_list under Windows as PID can be negative. I&#39;ve
</div>&gt; changed
<div class="message-stanza open">&gt; &gt; the conditions in REAPER to enable negative PID except -1 which is
</div>&gt; an
<div class="message-stanza open">&gt; &gt; error code.
&gt; &gt;
&gt; &gt; Now it works fine in Windows &#38; Unix even when running in nofork
</div>&gt; mode.
<div class="message-stanza open">&gt; &gt;
&gt; &gt; See attached modified code.
&gt; &gt;
&gt; &gt; Slts,
&gt; &gt; RenÃ©
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-950867" href="/Public/Bug/Display.html?id=56926#txn-950867">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;29&nbsp;08:09:43&nbsp;2011</span>
    <span class="description">rene [...] margar.fr -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rene [...] margar.fr</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/950867/494514/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/494514">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve been testing intensively Schedule::Cron 1.01_3 for several days.
Here are my conclusions :

Using REAPER with _reaper_specific or _reaper_all makes no difference
for my application &#40;under Unix or Windows&#41;. I added a local SIGCHLD
routine to handle my own forks, this is usefull under Unix only since
Windows never calls $SIG{CHLD}.

I also tested Schedule::Cron with the nofork option &#40;so no REAPER is
used&#41;. It works fine too. I need the nofork option when the scheduled
job needs to modify the current job list.

Windows negative PID are now handled correctly and application can go
beyond the 64 launches limit. Bug is resolved.

nostatus option is a great idea as I needed to comment the $0 alteration
for my application &#40;my monitoring system does not like a process name to
change over time&#41;.

Thank you for your great job,
RenÃ©

Le Mar 14 Juin 2011 05:30:57, rene@margar.fr a Ã©critÂ :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Roland,
&gt; 
&gt; I was not available last weeks, I will take a look on your code update 
&gt; these days and I&#39;ll tell you what I see on my windows platform.
&gt; 
&gt; Thank you,
&gt; RenÃ©
&gt; 
&gt; 
&gt; Le Ven 10 Juin 2011 02:08:45, ROLAND a Ã©critÂ :
<div class="message-stanza open">&gt; &gt; Hi Rene,
&gt; &gt; 
&gt; &gt; i know this ticket is open for quite some time and Schedule::Cron was
&gt; &gt; not under
&gt; &gt; active development for more than a year now, but release 1.01 has been
&gt; &gt; pushed
&gt; &gt; to CPAN last week which *should* fix this bug. However, I currently
&gt; &gt; has not the
&gt; &gt; proper environment for testing this so I&#39;d like you to ask, if you
&gt; &gt; could please
&gt; &gt; check whether 1.01 really fixes this bug so that I could close this
&gt; &gt; ticket.
&gt; &gt; 
&gt; &gt; If you don&#39;t have time for this, no problem, but please leave me a
&gt; &gt; short note
&gt; &gt; so that
&gt; &gt; I can try to verify it on my own &#40;when I have time ;-&#41;
&gt; &gt; 
&gt; &gt; ciao ...
&gt; &gt; ... roland
&gt; &gt; 
&gt; &gt; On Mon May 31 11:22:00 2010, rene@margar.fr wrote:
<div class="message-stanza open">&gt; &gt; &gt; Hang was caused by an infinite loop in REAPER code when called by
&gt; &gt; &gt; _cleanup_process_list under Windows as PID can be negative. I&#39;ve
</div>&gt; &gt; changed
<div class="message-stanza open">&gt; &gt; &gt; the conditions in REAPER to enable negative PID except -1 which is
</div>&gt; &gt; an
<div class="message-stanza open">&gt; &gt; &gt; error code.
&gt; &gt; &gt;
&gt; &gt; &gt; Now it works fine in Windows &#38; Unix even when running in nofork
</div>&gt; &gt; mode.
<div class="message-stanza open">&gt; &gt; &gt;
&gt; &gt; &gt; See attached modified code.
&gt; &gt; &gt;
&gt; &gt; &gt; Slts,
&gt; &gt; &gt; RenÃ©
</div></div>&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.61519</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
