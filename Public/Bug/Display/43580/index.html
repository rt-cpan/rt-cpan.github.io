<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #43580 for Graph: Reversed logic on overload::StrVal&#40;&#41; in AdjacencyMap::Vertex::__set_path</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #43580 for Graph: Reversed logic on overload::StrVal&#40;&#41; in AdjacencyMap::Vertex::__set_path</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Graph/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Graph/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Graph/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Graph/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Graph">Graph CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">43580</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Graph/Active/">Graph</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
chad.a.davis [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-14928-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.91    </td>
  </tr>
  <tr id="CF-14929-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;24&nbsp;08:43:48&nbsp;2009</span>
    <span class="description">chad.a.davis [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Reversed logic on overload::StrVal&#40;&#41; in AdjacencyMap::Vertex::__set_path</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am on perl, v5.10.0 built for i486-linux-gnu-thread-multi using Graph 0.91

I was using the Bio::Network::ProteinNet &#40;1.006&#41;, which extends your
Graph module, with Storable &#40;2.18&#41; when I ran into problems using
Storable::retrieve. The deserialised Graph instances reported no
neighbors&#40;&#41; on any nodes. 

I traced this back to the &#39;refvertexed&#39; option. I was using this option,
because my nodes are objects and the Graph documentation suggested that
this is the proper way to do things. My node objects use overload, to
provide stringification. 

Running through the debugger, I found that refvertexed=&gt;1 results in
using Graph::AdjacencyMap::Vertex whereas refvertexed=&gt;0 results in
using Graph::AdjacencyMap::Light. The G::A::Light calls my overloaded &#34;&#34;
on my node objects, whereas the G::A::Vertex does not call my overloaded
&#34;&#34; on my node objects. 

I inspected G::A::Vertex and found on line 37 &#40;and 78&#41; in version 0.91:

    my $q = ref $k &#38;&#38; &#40;$f &#38; _REF&#41; &#38;&#38; overload::Method&#40;$k, &#39;&#34;&#34;&#39;&#41; ?
overload::StrVal&#40;$k&#41; : $k;

I believe this logic to be reversed from what you seem to intend. The
overload::StrVal&#40;&#41; uses Perl&#39;s builtin stringification, providing
something like MyNode=HASH&#40;0x972e240&#41; and ignores the stringification I
have implemented in my MyNode class. This was the reason e.g.
Graph::neighbors&#40;&#41; was no longer working after Storable::retrieve&#40;&#41;,
because the constructed graph object had indexed the nodes by the memory
address that they had before they were serialized with Storable::store.
I believe the intent is simply:

    my $q = ref $k &#38;&#38; &#40;$f &#38; _REF&#41; &#38;&#38; ! overload::Method&#40;$k, &#39;&#34;&#34;&#39;&#41; ?
overload::StrVal&#40;$k&#41; : $k;

... which would use the objects own stringification, when present,
otherwise using Perl&#39;s generic stringification of hash references. This
is all the attached patch contains. See the script for an example use
case. It doesn&#39;t use Storable, but it just shows that the node keys in
the graph are different when G::A::Vertex is used &#40;via refvertexed=&gt;1&#41;,
though the node objects provide an overloaded &#34;&#34; in any case.

Cheers,
Chad
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> retrieveVertex.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl

use strict;
use warnings;

use Graph;
use Storable;
use Test::More &#39;no_plan&#39;;
use Data::Dumper;
use Carp qw/cluck/;

package MyNode;
use overload &#40;&#39;&#34;&#34;&#39; =&gt; &#39;_asstring&#39;, fallback=&gt;1&#41;;
sub new {
    my &#40;$class, %ops&#41; = @_;
    return bless { %ops }, $class;
}
sub _asstring {
    my &#40;$self&#41; = @_;
    my $str = $self-&gt;{&#39;name&#39;};
    Carp::cluck&#40;&#34;Stringifying $str&#34;&#41;;
    return $self-&gt;{&#39;name&#39;};
}
1;

package main;

my $gnoref = new Graph;
my $gwithref = new Graph&#40;refvertexed=&gt;1&#41;;
my $n1 = new MyNode&#40;&#39;name&#39;=&gt;&#39;alpha&#39;&#41;;
my $n2 = new MyNode&#40;&#39;name&#39;=&gt;&#39;beta&#39;&#41;;
$gnoref-&gt;add_edge&#40;$n1, $n2&#41;;

# If you see no further stack traces from cluck, then : 
print &#34;\nNo more stringification occurs after this point\n\n&#34;;
$gwithref-&gt;add_edge&#40;$n1, $n2&#41;;

# And then this fails, meaning that Storable is also not usable, because the
# nodes are hashed by their memory addresses, which will change on retrieve&#40;&#41;
is_deeply&#40;[sort keys %{$gnoref-&gt;[2]-&gt;[4]}],[sort keys %{$gwithref-&gt;[2]-&gt;[4]}]&#41;;

print &#34;\n&#34;;

__END__




</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Vertex.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Vertex.pm.bak	2009-02-24 14:04:57.000000000 +0100
+++ Vertex.pm	2009-02-24 14:06:14.000000000 +0100
@@ -34,7 +34,7 @@
     my @p = $p;
     my @k;
     my $k = shift;
-    my $q = ref $k &#38;&#38; &#40;$f &#38; _REF&#41; &#38;&#38; overload::Method&#40;$k, &#39;&#34;&#34;&#39;&#41; ? overload::StrVal&#40;$k&#41; : $k;
+    my $q = ref $k &#38;&#38; &#40;$f &#38; _REF&#41; &#38;&#38; ! overload::Method&#40;$k, &#39;&#34;&#34;&#39;&#41; ? overload::StrVal&#40;$k&#41; : $k;
     push @k, $q;
     return &#40;\@p, \@k&#41;;
 }
@@ -75,7 +75,7 @@
     my @p = $p;
     my @k;
     my $k = shift;
-    my $q = ref $k &#38;&#38; &#40;$f &#38; _REF&#41; &#38;&#38; overload::Method&#40;$k, &#39;&#34;&#34;&#39;&#41; ? overload::StrVal&#40;$k&#41; : $k;
+    my $q = ref $k &#38;&#38; &#40;$f &#38; _REF&#41; &#38;&#38; ! overload::Method&#40;$k, &#39;&#34;&#34;&#39;&#41; ? overload::StrVal&#40;$k&#41; : $k;
     push @k, $q;
     return &#40;\@p, \@k&#41;;
 }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;13&nbsp;14:01:54&nbsp;2010</span>
    <span class="description">JHI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&#40;Sorry for the long quiet&#41;

I&#39;m sorry but I think the code is working as intended.  The refvertexed
means that the memory address of the reference is used as the
&#34;identifier&#34; for the vertex.

If I believed the stringified reference, my code could not tell whether
&#34;foo&#34; is the same as &#34;foo&#34;, or a different &#34;foo&#34;.  In other words, it&#39;s
a little bit like a question of believing &#34;values&#34; versus &#34;references&#34;.
 The refvertexed strongly believes the &#34;reference&#34;, and ignores the
stringified &#34;value&#34;.

It&#39;s a pity that this doesn&#39;t scheme seem to interact well with Storable.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;13&nbsp;14:01:56&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;13&nbsp;14:56:20&nbsp;2010</span>
    <span class="description">JHI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">That having been said, I think it&#39;s possible to add a &#34;new style
refvertexed&#34; that behaves as you want.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;13&nbsp;16:07:13&nbsp;2010</span>
    <span class="description">JHI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The new option &#39;refvertexed_stringified&#39; will be in 0.94.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;13&nbsp;16:07:32&nbsp;2010</span>
    <span class="description">JHI [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;18&nbsp;09:11:38&nbsp;2010</span>
    <span class="description">chad.a.davis [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> chad.a.davis [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for the reply.

I&#39;ve just installed Graph 0.94 and my initial tests are passing.

Indeed it must have been a misunderstanding of the intended purpose of 
&#39;refvertexed&#39;. The new documentation on refvertexed_stringified is much 
more clear. 

Interestingly, I&#39;ve been using refvertexed=&gt;0 with objects as nodes this 
whole time and it has been working well with Storable. That seems to 
make sense, probably because the objects are then just coerced to 
strings, providing their own stringification.

In any case, thank you for the update,

Chad
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;18&nbsp;09:11:54&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;18&nbsp;17:19:03&nbsp;2010</span>
    <span class="description">JHI [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
