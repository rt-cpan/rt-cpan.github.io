<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #77691 for IO-Socket-SSL: Allow access to localhost with SSL_verify_mode =&gt; 3</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #77691 for IO-Socket-SSL: Allow access to localhost with SSL_verify_mode =&gt; 3</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/IO-Socket-SSL/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/IO-Socket-SSL/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/IO-Socket-SSL/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/IO-Socket-SSL/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IO-Socket-SSL">IO-Socket-SSL CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">77691</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/IO-Socket-SSL/Active/">IO-Socket-SSL</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
MARSCHAP [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-17228-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-17229-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;07&nbsp;17:05:29&nbsp;2012</span>
    <span class="description">MARSCHAP [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Allow access to localhost with SSL_verify_mode =&gt; 3</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

accessing the localhost with SSL_verify_mode =&gt; 3 fails if the host&#39;s 
certificate does not contain localhost as subjectaltName, which is 
_VERY_MUCH_ frowned upon.

A similar issue applies if one ties to access a server securely via IP 
address,
or the local machione via a UNIX socket.

Do you have an idea how this could be made work without having to 
specify the real host name in PeerAddr?

I am asking because of Bug #77921 
&#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=77291&#41;">https://rt.cpan.org/Ticket/Display.html?id=77291&#41;</a></span> against perl-ldap.

Best
PEter
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;07&nbsp;18:25:56&nbsp;2012</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Do 07. Jun 2012, 17:05:29, marschap schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; accessing the localhost with SSL_verify_mode =&gt; 3 fails if the host&#39;s 
&gt; certificate does not contain localhost as subjectaltName, which is 
&gt; _VERY_MUCH_ frowned upon.
&gt; 
&gt; A similar issue applies if one ties to access a server securely via IP 
&gt; address,
&gt; or the local machione via a UNIX socket.
&gt; 
&gt; Do you have an idea how this could be made work without having to 
&gt; specify the real host name in PeerAddr?
&gt; 
&gt; I am asking because of Bug #77921 
&gt; &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=77291&#41;">https://rt.cpan.org/Ticket/Display.html?id=77291&#41;</a></span> against perl-ldap.
</div>
Hi Peter,

from reading the openssl documentation to SSL_CTX_set_verify it looks 
for me, that SSL_verify_mode =&gt; 3 should be the same as SSL_verify_mode
of 1, e.g 3 is SSL_VERIFY_PEER|SSL_VERIFY_FAIL_IF_NO_PEER_CERT, but
the SSL_VERIFY_FAIL_IF_NO_PEER_CERT gets ignored inside a client.

So in a client only 0 &#40;no verification&#41; and 1 &#40;verify&#41; make sense.
But SSL_verify_mode only determines the verification of the certificate
and chain, it does not control verification of the names in the certificate,
because this is outside of the SSL specification.

Verification of hostnames is specified in various RFCs and is different
for HTTP, LDAP,... : &#40;
To control the verification you need to set the SSL_verifycn_scheme.

From looking at the code of Net::LDAP the verification of the hostname
is tightly bound to the verification of the chain, e.g. in 
_SSL_context_init_args the verification scheme gets set to ldap if
any kind of verification is wanted.

So either you have to change Net::LDAP to make it possible to verify
the chain, but not the certificate contents or you need to explicitly
provide the hostname, which is expected inside the certificate.
This doesn&#39;t need to be in PeerAddr, from the code it looks like that
you should be able to use a -sslserver argument in start_tls to provide
the name to check against.

BTW, the default ssl version is set to &#39;tlsv1&#39; from what I see. That means,
the SSLv3 will not work and also no initial SSLv2 handshake and then upgrade
to SSLv1. I would recommend to net set the SSL_version and just use the
default from IO::Socket::SSL


Hope I could help,
Regards,
Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;07&nbsp;18:25:57&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;08&nbsp;05:55:37&nbsp;2012</span>
    <span class="description">MARSCHAP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Steffen,

thanks for your answer.

On Friday, 8. June 2012, Steffen Ullrich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; from reading the openssl documentation to SSL_CTX_set_verify it looks
&gt; for me, that SSL_verify_mode =&gt; 3 should be the same as 
</div>SSL_verify_mode
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; of 1, e.g 3 is 
</div>SSL_VERIFY_PEER|SSL_VERIFY_FAIL_IF_NO_PEER_CERT, but
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; the SSL_VERIFY_FAIL_IF_NO_PEER_CERT gets ignored inside a 
</div>client.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; So in a client only 0 &#40;no verification&#41; and 1 &#40;verify&#41; make sense.
</div>OK, but then problem persists for 1 &#40;verify&#41;, doesn&#39;t it ;-&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [...]
&gt; Verification of hostnames is specified in various RFCs and is different
&gt; for HTTP, LDAP,... : &#40;
&gt; To control the verification you need to set the SSL_verifycn_scheme.
</div>Which Net::LDAP does, and it sets SSL_verifycn_scheme =&gt; &#39;ldap&#39;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; From looking at the code of Net::LDAP the verification of the hostname
&gt; is tightly bound to the verification of the chain, e.g. in
&gt; _SSL_context_init_args the verification scheme gets set to ldap if
&gt; any kind of verification is wanted.
</div>Which - to me - sounds the right way to do for Net::LDAP that only deals 
with LDAP[IS] ;-&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So either you have to change Net::LDAP to make it possible to verify
&gt; the chain, but not the certificate contents or you need to explicitly
&gt; provide the hostname, which is expected inside the certificate.
&gt; This doesn&#39;t need to be in PeerAddr, from the code it looks like that
&gt; you should be able to use a -sslserver argument in start_tls to provide
&gt; the name to check against.
</div>Net::LDAP-&gt;start_tls&#40;&#41;&#39; sslerver parameter gets mapped to 
SSL_verifycn_name
before calling IO::Socket::SSL-&gt;start_TLS, which internally uses PeerAddr 
and
PeerHost as fallback if SSL_verifycn_name is not set.
So it does not really matter which one is set exactly ;-&#41;

If I understand you correctly, your recommendation is to special case 
Net::LDAP-&gt;start_tls&#40;&#41; calls to localhost by determining &#38; setting the real 
host name.
This is something I&#39;d rather avoid, as it is special casing in only one of the 
libraries using IO::Socket::SSL.

I was much more hoping for an additional verification scheme in 
IO::Socket::SSL, e.g. named &#39;ldap+localhost&#39;, that would do the the name 
checks, but accept localhost too ;-&#41;

Maybe it even can try to find the FQDNs &#38; IPs of the local host and match 
them against the certificate.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; BTW, the default ssl version is set to &#39;tlsv1&#39; from what I see. That means,
&gt; the SSLv3 will not work and also no initial SSLv2 handshake and then
&gt; upgrade to SSLv1. I would recommend to net set the SSL_version and 
</div>just
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; use the default from IO::Socket::SSL
</div>This setting has been in place since 1.10.2001, and we have never had any 
complaints/issues with respect to that specific setting.
I&#39;d rather not change it &#40;never change a running system ;-&#41;.

Best
Peter
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;08&nbsp;10:35:48&nbsp;2012</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #77691] Allow access to localhost with SSL_verify_mode =&gt; 3</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 8 Jun 2012 16:35:28 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Peter Marschall via RT &lt;bug-IO-Socket-SSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steffen Ullrich &lt;Steffen_Ullrich [...] genua.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; So in a client only 0 &#40;no verification&#41; and 1 &#40;verify&#41; make sense.
</div>&gt; OK, but then problem persists for 1 &#40;verify&#41;, doesn&#39;t it ;-&#41;
</div>
Sure, this was only a hint that the setting of &#39;verify&#39; setting in
Net::LDAP probably behaves not like documented.
I guess &#39;optional&#39; and &#39;required&#39; will behave the same and both will fail
if the server does not send a certificate or if the certificate
or certificate chain is wrong.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; From looking at the code of Net::LDAP the verification of the hostname
&gt; &gt; is tightly bound to the verification of the chain, e.g. in
&gt; &gt; _SSL_context_init_args the verification scheme gets set to ldap if
&gt; &gt; any kind of verification is wanted.
</div>&gt; Which - to me - sounds the right way to do for Net::LDAP that only deals 
&gt; with LDAP[IS] ;-&#41;
</div>
Yes, IMHO it is the right way.
But then Net::LDAP must also know the name of the server, otherwise
it cannot verify it. 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ...
&gt; Net::LDAP-&gt;start_tls&#40;&#41;&#39; sslerver parameter gets mapped to 
&gt; SSL_verifycn_name
&gt; before calling IO::Socket::SSL-&gt;start_TLS, which internally uses PeerAddr 
&gt; and
&gt; PeerHost as fallback if SSL_verifycn_name is not set.
&gt; So it does not really matter which one is set exactly ;-&#41;
</div>
No, it does matter.
PeerAddr is the name it connects to, which can be the name in the
certificate, but don&#39;t need to be.

If the user wants to connect to the ldap server using &#39;localhost&#39;
or an IP address, but none of these are valid names in the certificate
the verification will fail - unless the user explicitly provided
a different server name using &#39;sslserver&#39;.

But from the error message I think that problem in RT#77291 is before the 
name verification. The name verification is done in IO::Socket::SSL,
but this is a message from OpenSSL, so there must be something other
be wrong with the certificate, before the name verification event
starts.
Do you have some way to reproduce the problem?


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If I understand you correctly, your recommendation is to special case 
&gt; Net::LDAP-&gt;start_tls&#40;&#41; calls to localhost by determining &#38; setting the real 
&gt; host name.
</div>
No, it&#39;s not only localhost, although this is probably a common case.
It&#39;s just the the user connects to a host and the host provides a certificate
not matching the name/IP from PeerAddr.

And my recommandation is not to add a special case in your code.
IMHO there is nothing you should do here except:
- document, that the name in the certificate will be verified
- document, how one can overwrite the name used for verification &#40;e.g.
  the sslserver setting&#41;
- and maybe cleanup the documentation/behavior of the &#39;verify&#39; option

If the user wants verification it should provide the necessary data,
otherwise we cannot claim to have the certificate verified.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I was much more hoping for an additional verification scheme in 
&gt; IO::Socket::SSL, e.g. named &#39;ldap+localhost&#39;, that would do the the name 
&gt; checks, but accept localhost too ;-&#41;
</div>
No, like I said - if the user wants verification he should get it.
What you propose its something magical &#34;verify hostname unless the name
is localhost or an IP address or a known bad server or whatever...&#34;,
eg intransparently switch off verification in some circumstances even if 
the user required verification. 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Maybe it even can try to find the FQDNs &#38; IPs of the local host and match 
&gt; them against the certificate.
</div>
I doubt that you will be able to do it.
I often do ssh forwarding to some port at localhost - you probably will not
be able to figure out which real server is behind this localhost connection.


Regards,
Steffen

-- 
GeNUA Gesellschaft für Netzwerk - und Unix-Administration mbH
Domagkstr. 7, D-85551 Kirchheim. <span class="clickylink"><a target="new" rel="nofollow" href="http://www.genua.de">http://www.genua.de</a></span>
Tel: &#40;089&#41; 99 19 50-0, Fax: &#40;089&#41; 99 10 50 - 999

Geschäftsführer: Dr. Magnus Harlander, Dr. Michaela Harlander,
Bernhard Schneck. Amtsgericht München HRB 98238
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;08&nbsp;12:13:40&nbsp;2012</span>
    <span class="description">MARSCHAP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

On Friday, 8. June 2012, Steffen Ullrich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sure, this was only a hint that the setting of &#39;verify&#39; setting in
&gt; Net::LDAP probably behaves not like documented.
&gt; I guess &#39;optional&#39; and &#39;required&#39; will behave the same and both will fail
&gt; if the server does not send a certificate or if the certificate
&gt; or certificate chain is wrong.
</div>Did the implementation of IO::Socket::SSL or Net::SSLeay or openssl
change recently w.r.t to this behaviour ?
I may be mistaken, but I am pretty sure it worked with &#39;optional&#39;, but failed 
with &#39;require&#39; in the &#40;not so recent&#41; past.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [...]
&gt; But from the error message I think that problem in RT#77291 is before 
</div>the
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; name verification. The name verification is done in IO::Socket::SSL,
&gt; but this is a message from OpenSSL, so there must be something other
&gt; be wrong with the certificate, before the name verification event
&gt; starts.
&gt; Do you have some way to reproduce the problem?
</div>Sure:
perl -MNet::LDAP -MData::Dumper -e \
&#39;my $ldap = Net::LDAP-&gt;new&#40;&#34;ldapi://&#34;&#41;; 
my $mesg = $ldap-&gt;start_tls&#40;verify =&gt; &#34;require&#34;&#41;; 
print Dumper&#40;$mesg&#41;;&#39;

which will print:
$VAR1 = bless&#40; {
                 &#39;parent&#39; =&gt; bless&#40; {
                                      &#39;net_ldap_version&#39; =&gt; 3,
                                      &#39;net_ldap_scheme&#39; =&gt; &#39;ldapi&#39;,
                                      &#39;net_ldap_debug&#39; =&gt; 0,
                                      &#39;net_ldap_peer&#39; =&gt; &#39;/var/run/ldapi&#39;,
                                      &#39;net_ldap_socket&#39; =&gt; bless&#40; \*Symbol::GEN0, 
&#39;IO::Socket::UNIX&#39; &#41;,
                                      &#39;net_ldap_host&#39; =&gt; &#39;localhost&#39;,
                                      &#39;net_ldap_uri&#39; =&gt; &#39;ldapi://&#39;,
                                      &#39;net_ldap_resp&#39; =&gt; {},
                                      &#39;net_ldap_mesg&#39; =&gt; {},
                                      &#39;net_ldap_async&#39; =&gt; 0,
                                      &#39;net_ldap_refcnt&#39; =&gt; 1
                                    }, &#39;Net::LDAP&#39; &#41;,
                 &#39;errorMessage&#39; =&gt; &#39;Invalid certificate authority locations 
error:00000000:lib&#40;0&#41;:func&#40;0&#41;:reason&#40;0&#41;&#39;,
                 &#39;ctrl_hash&#39; =&gt; undef,
                 &#39;resultCode&#39; =&gt; 1,
                 &#39;callback&#39; =&gt; undef,
                 &#39;mesgid&#39; =&gt; 1,
                 &#39;matchedDN&#39; =&gt; &#39;&#39;,
                 &#39;controls&#39; =&gt; undef,
                 &#39;raw&#39; =&gt; undef
               }, &#39;Net::LDAP::Extension&#39; &#41;;

Note the &#39;errorMessage&#39; hash key.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; No, like I said - if the user wants verification he should get it.
&gt; What you propose its something magical &#34;verify hostname unless the 
</div>name
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; is localhost or an IP address or a known bad server or whatever...&#34;,
&gt; eg intransparently switch off verification in some circumstances even if
&gt; the user required verification.
</div>
Too bad: it was worth a try ;-&#41;

BTW:
I had a look at the OpenLDAP code to which the bug reporter refers:
when hostname is &#39;localhost&#39;, then OpenLDAP calculates the FQDN and 
uses that as the name to check for in the certificate verification.

Best
Peter
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;08&nbsp;13:15:16&nbsp;2012</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #77691] Allow access to localhost with SSL_verify_mode =&gt; 3</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 8 Jun 2012 19:14:49 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Peter Marschall via RT &lt;bug-IO-Socket-SSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steffen Ullrich &lt;Steffen_Ullrich [...] genua.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Jun 08, 2012 at 12:13:41PM -0400, Peter Marschall via RT &lt;bug-IO-Socket-SSL@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: IO-Socket-SSL
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=77691">https://rt.cpan.org/Ticket/Display.html?id=77691</a></span> &gt;
&gt; 
&gt; Hi,
&gt; 
&gt; On Friday, 8. June 2012, Steffen Ullrich via RT wrote:
<div class="message-stanza open">&gt; &gt; Sure, this was only a hint that the setting of &#39;verify&#39; setting in
&gt; &gt; Net::LDAP probably behaves not like documented.
&gt; &gt; I guess &#39;optional&#39; and &#39;required&#39; will behave the same and both will fail
&gt; &gt; if the server does not send a certificate or if the certificate
&gt; &gt; or certificate chain is wrong.
</div>&gt; Did the implementation of IO::Socket::SSL or Net::SSLeay or openssl
&gt; change recently w.r.t to this behaviour ?
&gt; I may be mistaken, but I am pretty sure it worked with &#39;optional&#39;, but failed 
&gt; with &#39;require&#39; in the &#40;not so recent&#41; past.
</div>
not that I&#39;m aware of.
IO::Socket::SSL gives the SSL_verify_mode parameter unchanged to Net::SSLeay,
which IMHO gives it unchanged to OpenSSL.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;                                     }, &#39;Net::LDAP&#39; &#41;,
&gt;                  &#39;errorMessage&#39; =&gt; &#39;Invalid certificate authority locations 
&gt; error:00000000:lib&#40;0&#41;:func&#40;0&#41;:reason&#40;0&#41;&#39;,
&gt; ..
&gt; Note the &#39;errorMessage&#39; hash key.
</div>
the error message means, that you have given a SSL_ca_file or SSL_ca_path,
which could not be used. Probably file does not exist or path does not
contain any certificates.

I see that you set SSL_ca_path and SSL_ca_file to &#39;&#39; if no capath or
cafile is given - because these values are defined this will mean that
it will try to use them, so you should leave them undef if you don&#39;t have
a useful value for them.
The relevant code for this behavior in IO::Socket::SSL is unchanged for 
at least 18 month &#40;according to git blame&#41;

BTW - this error message is different from the one of RT#77291

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; No, like I said - if the user wants verification he should get it.
&gt; &gt; What you propose its something magical &#34;verify hostname unless the 
</div>&gt; name
<div class="message-stanza open">&gt; &gt; is localhost or an IP address or a known bad server or whatever...&#34;,
&gt; &gt; eg intransparently switch off verification in some circumstances even if
&gt; &gt; the user required verification.
</div>&gt; 
&gt; Too bad: it was worth a try ;-&#41;
&gt; 
&gt; BTW:
&gt; I had a look at the OpenLDAP code to which the bug reporter refers:
&gt; when hostname is &#39;localhost&#39;, then OpenLDAP calculates the FQDN and 
&gt; uses that as the name to check for in the certificate verification.
</div>
I don&#39;t like this behavior.
And like I said - there are enough cases were it will not work.

But again - the error message in RT#77291 is in my opinion not related 
to this problem, it occurs before any host name verification.

Regards,
Steffen

-- 
GeNUA Gesellschaft für Netzwerk - und Unix-Administration mbH
Domagkstr. 7, D-85551 Kirchheim. <span class="clickylink"><a target="new" rel="nofollow" href="http://www.genua.de">http://www.genua.de</a></span>
Tel: &#40;089&#41; 99 19 50-0, Fax: &#40;089&#41; 99 10 50 - 999

Geschäftsführer: Dr. Magnus Harlander, Dr. Michaela Harlander,
Bernhard Schneck. Amtsgericht München HRB 98238
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;09&nbsp;02:40:56&nbsp;2012</span>
    <span class="description">MARSCHAP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

On Friday, 8. June 2012, you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; BTW - this error message is different from the one of RT#77291
</div>
Sorry, my bad.
A a slight addition produces the &#34;wanted&#34; error message:

perl -MNet::LDAP -MData::Dumper -e \
&#39;my $ldap = Net::LDAP-&gt;new&#40;&#34;ldapi://&#34;&#41;; 
        my $mesg = $ldap-&gt;start_tls&#40;verify =&gt; &#34;require&#34;,
        cafile =&gt; &#34;/etc/ssl/certs/ADPM-cacert.pem&#34;&#41;; 
        print Dumper&#40;$mesg&#41;;&#39;

The file pointed to by the &#39;cafile&#39; option exists, is readable, contains the 
CA&#39;s certificate in PEM format, and works with connections to the 
machine&#39;s host name.
To reproduce the error, simply replace it with your CA&#39;s cert ;-&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But again - the error message in RT#77291 is in my opinion not related
&gt; to this problem, it occurs before any host name verification.
</div>See test case above.

Best
PEter

PS: Thanks for the interesting &#38; enlightening discussion.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;09&nbsp;09:33:50&nbsp;2012</span>
    <span class="description">peter [...] adpm.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #77691] Allow access to localhost with SSL_verify_mode =&gt; 3</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 9 Jun 2012 15:36:00 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-IO-Socket-SSL [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Marschall &lt;peter [...] adpm.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

On Friday, 8. June 2012, you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; BTW - this error message is different from the one of RT#77291
</div>
Sorry, my bad.
A a slight addition produces the &#34;wanted&#34; error message:

perl -MNet::LDAP -MData::Dumper -e &#39;my $ldap = Net::LDAP-&gt;new&#40;&#34;ldapi://&#34;&#41;; 
        my $mesg = $ldap-&gt;start_tls&#40;verify =&gt; &#34;require&#34;,
        cafile =&gt; &#34;/etc/ssl/certs/ADPM-cacert.pem&#34;&#41;; 
        print Dumper&#40;$mesg&#41;;&#39;

The file pointed to by the &#39;cafile&#39; option exists, is readable, contains the 
CA&#39;s certificate in PEM format, and works with connections to the machine&#39;s 
host name.
To reproduce the error, simply replace it with your CA&#39;s cert.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But again - the error message in RT#77291 is in my opinion not related
&gt; to this problem, it occurs before any host name verification.
</div>See test case above.

Best
PEter

PS: Thanks for the interesting &#38; enlightening discussion.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;09&nbsp;17:05:06&nbsp;2012</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #77691] Allow access to localhost with SSL_verify_mode =&gt; 3</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 9 Jun 2012 23:04:38 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;peter [...] adpm.de via RT&#34; &lt;bug-IO-Socket-SSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steffen Ullrich &lt;Steffen_Ullrich [...] genua.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; perl -MNet::LDAP -MData::Dumper -e &#39;my $ldap = Net::LDAP-&gt;new&#40;&#34;ldapi://&#34;&#41;; 
&gt;       my $mesg = $ldap-&gt;start_tls&#40;verify =&gt; &#34;require&#34;,
&gt;       cafile =&gt; &#34;/etc/ssl/certs/ADPM-cacert.pem&#34;&#41;; 
&gt;       print Dumper&#40;$mesg&#41;;&#39;
</div>
Hi Peter,
after trying to setup openldap on ubuntu and trying to make it speak
TLS I finally get the error message, and yes - there will be no error
if you give the correct sslserver argument:

  $ldap-&gt;start_tls&#40;
    verify =&gt; &#39;require&#39;,
    cafile =&gt; ...,
    sslserver =&gt; hostname_from_certificate
  &#41;;

BTW, the exact same ldapsearch command from RT#77291 behaves differently
then in the bug report for me, e.g. fails also because of a bad 
certificate:

 | $ldapsearch -LLL -x -H ldapi:/// -ZZ -s base -b &#34;&#34;
 | ldap_start_tls: Connect error &#40;-11&#41;
 |         additional info: TLS: hostname does not match CN in peer certificate

I think the original bug report simply had a setting of TLS_REQCERT &#39;never&#39;
or &#39;allow&#39; in the ldap.conf - in this case it will ignore the certificate
or certificate errors. But with &#39;try&#39; or the default setting &#39;hard&#39; it
will fail.
So there is no special way for localhost done in the ldap tools, it&#39;s just
they ignore any errors with the setting the bug report had.

I think with this argumentation you should be able to close the bug, which
in my eyes is a false report. The bug reporter probably did not know, that it 
had a weak certificate check in the config or that the config setting 
overwrites the explicit -ZZ option from the command line. I find this behavior 
from openldap unexpected too.

Regards,
Steffen

-- 
GeNUA Gesellschaft für Netzwerk - und Unix-Administration mbH
Domagkstr. 7, D-85551 Kirchheim. <span class="clickylink"><a target="new" rel="nofollow" href="http://www.genua.de">http://www.genua.de</a></span>
Tel: &#40;089&#41; 99 19 50-0, Fax: &#40;089&#41; 99 10 50 - 999

Geschäftsführer: Dr. Magnus Harlander, Dr. Michaela Harlander,
Bernhard Schneck. Amtsgericht München HRB 98238
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;11&nbsp;09:33:35&nbsp;2012</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;11&nbsp;09:33:35&nbsp;2012</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Severity Wishlist deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
