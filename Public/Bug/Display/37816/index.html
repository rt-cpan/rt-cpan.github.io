<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #37816 for CGI-Application-PhotoGallery: Autorotation support</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #37816 for CGI-Application-PhotoGallery: Autorotation support</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/CGI-Application-PhotoGallery/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/CGI-Application-PhotoGallery/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/CGI-Application-PhotoGallery/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/CGI-Application-PhotoGallery/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/CGI-Application-PhotoGallery">CGI-Application-PhotoGallery CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">37816</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/CGI-Application-PhotoGallery/Active/">CGI-Application-PhotoGallery</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
tlhackque [...] yahoo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-5444-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.01</li>
<li>
0.02</li>
<li>
0.03</li>
<li>
0.04</li>
<li>
0.05</li>
<li>
0.07</li>
<li>
0.08</li>
<li>
0.09</li>
<li>
0.10</li>
<li>
0.11</li>
<li>
0.13</li>
<li>
0.14</li>
</ul>
    </td>
  </tr>
  <tr id="CF-5445-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;20&nbsp;22:03:52&nbsp;2008</span>
    <span class="description">tlhackque [...] yahoo.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Autorotation support</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">With the advent of orientation sensors in newer cameras, other browsers 
automagically rotate images to correct for camera orientation.

When the same photos are displayed in PhotoGallery, people are confused 
because they aren&#39;t automagically rotated.

The attached patch implements auto-rotation for the GD library.  &#40;I 
leave it as an exercise for someone else wants to port the patch to 
ImageMagick.&#41;

The patch is in two parts, although three files are attached:
   rotate_gd_patch is the enabling patch in the graphics library 
interface.
   pg_autorotate_patch is incremental to the patch provided in #37810.
   pg_autorotate_combined_patch combines both patches.

This patch also changes some of the cache keys to ensure uniqueness in 
some imaginary corner cases - it&#39;s a good idea to delete any existing 
cache when upgrading.

Note that rotated images are cached by this patch &#40;but unrotated images 
are not, as that&#39;s just a waste of space.&#41;

The patch adds a dependency on Image::MetaData::JPEG.  If it doesn&#39;t 
support an image file format, autorotation won&#39;t happen, but the image 
will be displayed as before.

Hope this is useful to others.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rotate_gd_patch.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- /usr/lib/perl5/site_perl/5.8.8/CGI/Application/PhotoGallery/GD.pm.10	2008-03-09 19:38:12.000000000 -0400
+++ /usr/lib/perl5/site_perl/5.8.8/CGI/Application/PhotoGallery/GD.pm	2008-07-20 21:03:22.000000000 -0400
@@ -19,6 +19,7 @@
 use warnings;
 
 use GD;
+use Image::MetaData::JPEG;
 
 our $VERSION = &#39;0.10&#39;;
 
@@ -46,7 +47,7 @@
     my $file = shift;
     my $size = shift;
 
-    my $image = $self-&gt;load&#40; $file &#41;;
+    my &#40;$image, $hint&#41; = $self-&gt;load&#40; $file &#41;;
 
     my &#40; $width, $height &#41; = $image-&gt;getBounds&#40;&#41;;
 
@@ -76,6 +77,7 @@
 
 Loads C&lt;$file&gt; and returns a L&lt;GD::Image&gt;.
 
+Also returns a cache hint.
 =cut
 
 sub load {
@@ -97,7 +99,50 @@
         $image = GD::Image-&gt;new&#40; $file &#41;;
     }
 
-    return $image;
+    $Image::MetaData::JPEG::show_warnings = undef;
+
+    my $jpg = new Image::MetaData::JPEG&#40;$file, qr/APP&#40;0|1&#41;/, &#39;FASTREADONLY&#39;&#41;;
+#    die &#39;Error: &#39; . Image::MetaData::JPEG::Error&#40;&#41; unless $jpg;
+    return &#40;$image, 0&#41; unless $jpg;
+
+    my $snum = $jpg-&gt;retrieve_app1_Exif_segment&#40;-1&#41;;
+    for&#40; my $i = 0; $i &lt; $snum; $i++&#41; {
+   
+	my $seg = $jpg-&gt;retrieve_app1_Exif_segment&#40;$i&#41;;
+	my $imgdat = $seg-&gt;get_Exif_data&#40;&#39;IMAGE_DATA&#39;, &#39;TEXTUAL&#39;&#41;;
+  
+	my $o = $imgdat-&gt;{&#39;Orientation&#39;};
+	next unless $o;
+
+	my $orient = @$o[0];
+	if&#40; $orient == 1 &#41; { # Top, Left-Hand
+	    # Normal orientation
+	    return &#40;$image, 0&#41;;
+	} elsif&#40; $orient == 2 &#41; { # Top, Right-Hand
+	    $image-&gt;flipHorizontal&#40;&#41;;
+	    return &#40;$image, 1&#41;;
+	} elsif&#40; $orient == 3 &#41; { # Bottom, Right-Hand
+	    $image-&gt;rotate180&#40;&#41;;
+	    return &#40;$image, 1&#41;;
+	} elsif&#40; $orient == 4 &#41; { # Bottom, Left-Hand
+	    $image-&gt;flipVertical&#40;&#41;;
+	    return &#40;$image, 1&#41;;
+	} elsif&#40; $orient == 5 &#41; { # Left-Hand, Top
+	    $image-&gt;flipVertical&#40;&#41;;
+	    return &#40;$image-&gt;copyRotate90&#40;&#41;, 1&#41;;
+	} elsif&#40; $orient == 6 &#41; { # Right-Hand, Top
+	    return &#40;$image-&gt;copyRotate90&#40;&#41;, 1&#41;;
+	} elsif&#40; $orient == 7 &#41; { # Right-Hand, Bottom
+	    $image-&gt;flipHorizontal&#40;&#41;;
+	    return &#40;$image-&gt;copyRotate90&#40;&#41;, 1&#41;;
+	} elsif&#40; $orient == 8 &#41; { # Left-Hand, Bottom
+	    return &#40;$image-&gt;copyRotate270&#40;&#41;, 1&#41;;
+	}
+    }
+
+    # Orientation unknown or not specified
+
+    return &#40;$image, 0&#41;;
 }
 
 =head2 size&#40; $file &#41;
@@ -110,7 +155,7 @@
     my $self = shift;
     my $file = shift;
 
-    my $image = $self-&gt;load&#40; $file &#41;;
+    my &#40;$image, $hint&#41; = $self-&gt;load&#40; $file &#41;;
 
     return $image-&gt;getBounds&#40;&#41;;
 }
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> pg_autorotate_patch.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- /usr/lib/perl5/site_perl/5.8.8/CGI/Application/PhotoGallery.pm.13+	2008-07-20 11:28:09.000000000 -0400
+++ /usr/lib/perl5/site_perl/5.8.8/CGI/Application/PhotoGallery.pm	2008-07-20 21:32:21.000000000 -0400
@@ -359,9 +359,9 @@
 
     my $output;
     my $cache   = $self-&gt;cache;
-    my $key     = $directory;
+    my $key     = &#34;$directory.#dir&#34;;
     my $lastmod = &#40; stat&#40; $directory &#41; &#41;[ 9 ];
-    my $cstamp  = &#34;$directory/.cachetime&#34;;
+    my $cstamp  = &#34;$directory/#dir.cachetime&#34;;
 
     if &#40; $output = $cache-&gt;get&#40; $key &#41; &#41; {
        my $cachetime = $cache-&gt;get&#40; $cstamp &#41;;
@@ -458,7 +458,7 @@
 
     my $path    = &#34;$dir$photo&#34;;
     my $cache   = $self-&gt;cache;
-    my $key     = &#34;$path$size&#34;;
+    my $key     = &#34;$path.#thumb$size&#34;;
     my $lastmod = &#40; stat&#40; $path &#41; &#41;[ 9 ];
 
     my $data;
@@ -489,7 +489,7 @@
 	    eval {
 		$data = $gfx-&gt;resize&#40; $errimg, $size &#41;;
 	    }; if &#40;$@&#41; {
-		    return $self-&gt;handle_error&#40; &#34;Unable to resize $path; file may be corrupt; error image also corrupt\nError string:$errstr&#34; &#41;;
+		    return $self-&gt;handle_error&#40; &#34;Unable to resize $path; file may be corrupt; error image also corrupt\n&lt;p&gt;Error string:$errstr&#34; &#41;;
 	    }
 
 	    $self-&gt;header_props&#40;
@@ -525,6 +525,10 @@
     my $dir   = $self-&gt;param&#40; &#39;photos_dir&#39; &#41;;
     my $photo = $query-&gt;param&#40; &#39;photo&#39; &#41;;
     my $path  = &#34;$dir$photo&#34;;
+    my $cache = $self-&gt;cache;
+    my $key   = &#34;$path.#image&#34;;
+    my $cstamp=&#34;$key.#cachetime&#34;;
+    my $cmime = &#34;$key.#mime&#34;;
 
     die &#39;ERROR: Missing $photo query argument.&#39; unless $photo;
 
@@ -535,21 +539,71 @@
         $reqmod = HTTP::Date::str2time&#40; &#40; split&#40; /;/, $header, 2 &#41; &#41;[ 0 ] &#41;;
     }
 
+    my &#40;$data, $mime&#41;;
+    if &#40; &#40;$data = $cache-&gt;get&#40; $key &#41;&#41; &#38;&#38; &#40;$mime = $cache-&gt;get&#40; $cmime &#41;&#41; &#38;&#38; &#40;$mime eq $self-&gt;mime_types-&gt;mimeTypeOf&#40; $path &#41;&#41; &#41; {
+	my $cachetime = $cache-&gt;get&#40; $cstamp &#41;;
+       if&#40; $cachetime &#38;&#38; $cachetime == $lastmod &#41; {
+	   if &#40; $reqmod &#38;&#38; $reqmod == $lastmod &#41; {
+	       $self-&gt;header_props&#40; { -status =&gt; &#39;304 Not Modified&#39; } &#41;;
+	       return;
+	   }
+
+	   $self-&gt;header_add&#40; 
+	       {
+#Debug		   -status =&gt; &#34;200 Cached&#34;,
+		   -type          =&gt; $mime,
+		   -last_modified =&gt; HTTP::Date::time2str&#40; $lastmod &#41;
+	       }
+	   &#41;;
+	   return $data;
+       }
+    }
+
+    # Not cached.  Still may be unchanged, as we only cache if rotated &#40;to save space&#41;.
+
     if &#40; $reqmod &#38;&#38; $reqmod == $lastmod &#41; {
         $self-&gt;header_props&#40; { -status =&gt; &#39;304 Not Modified&#39; } &#41;;
         return;
     }
 
-    open&#40; PHOTO, $path &#41; or die &#34;ERROR: Cannot open $path: $!&#34;;
-    binmode PHOTO;
-    my $data = do { local $/; &lt;PHOTO&gt; };
-    close&#40; PHOTO &#41;;
+    $mime = $self-&gt;mime_types-&gt;mimeTypeOf&#40; $path &#41;;
+
+    # The library handles auto-rotation
+
+    my $gfx = $self-&gt;gfx_lib;
+    my $cacheThis;
+    eval {
+	&#40;$data, $cacheThis&#41; = $gfx-&gt;load&#40; $path &#41;;
+    }; if &#40;$@&#41; {
+	die &#34;Unable to load $path: $@\n&#34;;
+    }
+    
+    if&#40; $cacheThis &#41; {
+	# The library did work, such as auto-rotation
+	#
+	# We could figure out how to convert to the original format, but it doesn&#39;t seem worth the effort.
+	# Note that we are accepting a default quality that will often compress the image.
+
+	$data = $data-&gt;jpeg&#40;&#41;;
+	$mime = &#39;image/jpeg&#39;;
+       
+	$cache-&gt;set&#40; $key =&gt; $data &#41;;
+	$cache-&gt;set&#40; $cstamp =&gt; $lastmod &#41;;
+	$cache-&gt;set&#40; $cmime =&gt; $mime &#41;;
+    } else {
+	# No work, read the actual file data
+
+	open&#40; PHOTO, $path &#41; or die &#34;ERROR: Cannot open $path: $!&#34;;
+	binmode PHOTO;
+	$data = do { local $/; &lt;PHOTO&gt; };
+	close&#40; PHOTO &#41;;
+    }
 
     $self-&gt;header_props&#40;
-        {   -type          =&gt; $self-&gt;mime_types-&gt;mimeTypeOf&#40; $path &#41;,
-            -last_modified =&gt; HTTP::Date::time2str&#40; $lastmod &#41;
-        }
-    &#41;;
+			{   -type          =&gt; $mime,
+			    -last_modified =&gt; HTTP::Date::time2str&#40; $lastmod &#41;
+			}
+		       &#41;;
 
     return $data;
 }
@@ -615,7 +669,7 @@
     eval {
 	&#40;$width, $height&#41; = $gfx-&gt;size&#40; $path &#41;;
     }; if &#40;$@&#41; {
-	return $self-&gt;handle_error&#40;&#34;Unable to determine size of $path; file may be corrupt.\nError string:$@&#34;&#41;;
+	return $self-&gt;handle_error&#40;&#34;Unable to determine size of $path; file may be corrupt.\n&lt;p&gt;Error string:$@&#34;&#41;;
     }
 
     # get data for prev/next/parent links
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> pg_autorotate_combined_patch.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- /usr/lib/perl5/site_perl/5.8.8/CGI/Application/PhotoGallery.pm.13	2008-03-11 11:23:32.000000000 -0400
+++ /usr/lib/perl5/site_perl/5.8.8/CGI/Application/PhotoGallery.pm	2008-07-20 21:32:21.000000000 -0400
@@ -138,6 +138,13 @@
 and height attributes on the image tag, thus saving the image will retain the
 full resolution.
 
+=head2 max_height
+
+Setting this value will force the browser to scale images down to this
+particular height and proportioned width. This is done by setting the width
+and height attributes on the image tag, thus saving the image will retain the
+full resolution.
+
 =head2 cache_root
 
 Specifies where the file cache data will be stored.  Defaults to FileCache
@@ -352,9 +359,9 @@
 
     my $output;
     my $cache   = $self-&gt;cache;
-    my $key     = $directory;
+    my $key     = &#34;$directory.#dir&#34;;
     my $lastmod = &#40; stat&#40; $directory &#41; &#41;[ 9 ];
-    my $cstamp  = &#34;$directory/.cachetime&#34;;
+    my $cstamp  = &#34;$directory/#dir.cachetime&#34;;
 
     if &#40; $output = $cache-&gt;get&#40; $key &#41; &#41; {
        my $cachetime = $cache-&gt;get&#40; $cstamp &#41;;
@@ -451,7 +458,7 @@
 
     my $path    = &#34;$dir$photo&#34;;
     my $cache   = $self-&gt;cache;
-    my $key     = &#34;$path$size&#34;;
+    my $key     = &#34;$path.#thumb$size&#34;;
     my $lastmod = &#40; stat&#40; $path &#41; &#41;[ 9 ];
 
     my $data;
@@ -473,7 +480,26 @@
 
     unless &#40; $data &#41; {
         my $gfx = $self-&gt;gfx_lib;
-        $data = $gfx-&gt;resize&#40; $path, $size &#41;;
+	eval {
+	    $data = $gfx-&gt;resize&#40; $path, $size &#41;;
+	}; if &#40;$@&#41; {
+	    my $errstr = $@;
+	    my $errimg = $self-&gt;_dist_file&#40; &#39;nothumb.jpg&#39; &#41;;
+
+	    eval {
+		$data = $gfx-&gt;resize&#40; $errimg, $size &#41;;
+	    }; if &#40;$@&#41; {
+		    return $self-&gt;handle_error&#40; &#34;Unable to resize $path; file may be corrupt; error image also corrupt\n&lt;p&gt;Error string:$errstr&#34; &#41;;
+	    }
+
+	    $self-&gt;header_props&#40;
+				{   -type          =&gt; $self-&gt;mime_types-&gt;mimeTypeOf&#40; $errimg &#41;,
+				    -last_modified =&gt; HTTP::Date::time2str&#40; &#40; stat&#40; $errimg &#41; &#41;[ 9 ] &#41;
+				    }
+				&#41;;
+	    binmode STDOUT;
+	    return $data;
+	}
         $cache-&gt;set&#40; $key =&gt; $data &#41;;
     }
 
@@ -499,6 +525,10 @@
     my $dir   = $self-&gt;param&#40; &#39;photos_dir&#39; &#41;;
     my $photo = $query-&gt;param&#40; &#39;photo&#39; &#41;;
     my $path  = &#34;$dir$photo&#34;;
+    my $cache = $self-&gt;cache;
+    my $key   = &#34;$path.#image&#34;;
+    my $cstamp=&#34;$key.#cachetime&#34;;
+    my $cmime = &#34;$key.#mime&#34;;
 
     die &#39;ERROR: Missing $photo query argument.&#39; unless $photo;
 
@@ -509,21 +539,71 @@
         $reqmod = HTTP::Date::str2time&#40; &#40; split&#40; /;/, $header, 2 &#41; &#41;[ 0 ] &#41;;
     }
 
+    my &#40;$data, $mime&#41;;
+    if &#40; &#40;$data = $cache-&gt;get&#40; $key &#41;&#41; &#38;&#38; &#40;$mime = $cache-&gt;get&#40; $cmime &#41;&#41; &#38;&#38; &#40;$mime eq $self-&gt;mime_types-&gt;mimeTypeOf&#40; $path &#41;&#41; &#41; {
+	my $cachetime = $cache-&gt;get&#40; $cstamp &#41;;
+       if&#40; $cachetime &#38;&#38; $cachetime == $lastmod &#41; {
+	   if &#40; $reqmod &#38;&#38; $reqmod == $lastmod &#41; {
+	       $self-&gt;header_props&#40; { -status =&gt; &#39;304 Not Modified&#39; } &#41;;
+	       return;
+	   }
+
+	   $self-&gt;header_add&#40; 
+	       {
+#Debug		   -status =&gt; &#34;200 Cached&#34;,
+		   -type          =&gt; $mime,
+		   -last_modified =&gt; HTTP::Date::time2str&#40; $lastmod &#41;
+	       }
+	   &#41;;
+	   return $data;
+       }
+    }
+
+    # Not cached.  Still may be unchanged, as we only cache if rotated &#40;to save space&#41;.
+
     if &#40; $reqmod &#38;&#38; $reqmod == $lastmod &#41; {
         $self-&gt;header_props&#40; { -status =&gt; &#39;304 Not Modified&#39; } &#41;;
         return;
     }
 
-    open&#40; PHOTO, $path &#41; or die &#34;ERROR: Cannot open $path: $!&#34;;
-    binmode PHOTO;
-    my $data = do { local $/; &lt;PHOTO&gt; };
-    close&#40; PHOTO &#41;;
+    $mime = $self-&gt;mime_types-&gt;mimeTypeOf&#40; $path &#41;;
+
+    # The library handles auto-rotation
+
+    my $gfx = $self-&gt;gfx_lib;
+    my $cacheThis;
+    eval {
+	&#40;$data, $cacheThis&#41; = $gfx-&gt;load&#40; $path &#41;;
+    }; if &#40;$@&#41; {
+	die &#34;Unable to load $path: $@\n&#34;;
+    }
+    
+    if&#40; $cacheThis &#41; {
+	# The library did work, such as auto-rotation
+	#
+	# We could figure out how to convert to the original format, but it doesn&#39;t seem worth the effort.
+	# Note that we are accepting a default quality that will often compress the image.
+
+	$data = $data-&gt;jpeg&#40;&#41;;
+	$mime = &#39;image/jpeg&#39;;
+       
+	$cache-&gt;set&#40; $key =&gt; $data &#41;;
+	$cache-&gt;set&#40; $cstamp =&gt; $lastmod &#41;;
+	$cache-&gt;set&#40; $cmime =&gt; $mime &#41;;
+    } else {
+	# No work, read the actual file data
+
+	open&#40; PHOTO, $path &#41; or die &#34;ERROR: Cannot open $path: $!&#34;;
+	binmode PHOTO;
+	$data = do { local $/; &lt;PHOTO&gt; };
+	close&#40; PHOTO &#41;;
+    }
 
     $self-&gt;header_props&#40;
-        {   -type          =&gt; $self-&gt;mime_types-&gt;mimeTypeOf&#40; $path &#41;,
-            -last_modified =&gt; HTTP::Date::time2str&#40; $lastmod &#41;
-        }
-    &#41;;
+			{   -type          =&gt; $mime,
+			    -last_modified =&gt; HTTP::Date::time2str&#40; $lastmod &#41;
+			}
+		       &#41;;
 
     return $data;
 }
@@ -585,7 +665,12 @@
 
     my $gfx = $self-&gt;gfx_lib;
 
-    my &#40; $width, $height &#41; = $gfx-&gt;size&#40; $path &#41;;
+    my &#40; $width, $height &#41;;
+    eval {
+	&#40;$width, $height&#41; = $gfx-&gt;size&#40; $path &#41;;
+    }; if &#40;$@&#41; {
+	return $self-&gt;handle_error&#40;&#34;Unable to determine size of $path; file may be corrupt.\n&lt;p&gt;Error string:$@&#34;&#41;;
+    }
 
     # get data for prev/next/parent links
     my &#40; undef, $search_dir &#41; = fileparse&#40; $path &#41;;
@@ -622,6 +707,14 @@
         }
     }
 
+    if &#40; defined&#40; my $max_height = $self-&gt;param&#40; &#39;max_height&#39; &#41; &#41; &#41; {
+        if &#40; $height &gt; $max_height &#41; {
+            my $scale = $max_height / $height;
+            $width  = int&#40; $width * $scale &#41;;
+            $height = int&#40; $height * $scale &#41;;
+        }
+    }
+
     $html-&gt;param&#40;
         photo  =&gt; $photo,
         width  =&gt; $width,
@@ -675,7 +768,7 @@
         $error = &#39;ERROR: File not found.&#39;;
     }
     else {
-        $self-&gt;header_props&#40; { -status =&gt; &#39;500 Error&#39; } &#41;;
+        $self-&gt;header_props&#40; { -status =&gt; &#39;200 Error&#39; } &#41;;
     }
 
     my $html = $self-&gt;load_tmpl&#40;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;09&nbsp;15:16:32&nbsp;2009</span>
    <span class="description">bricas [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
