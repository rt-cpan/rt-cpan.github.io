<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #41632 for MIME-tools: MIME::Field::ParamVal mishandles mixed RFC2231 and non-RFC2231 parameters</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #41632 for MIME-tools: MIME::Field::ParamVal mishandles mixed RFC2231 and non-RFC2231 parameters</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/MIME-tools/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/MIME-tools/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/MIME-tools/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/MIME-tools/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/MIME-tools">MIME-tools CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">41632</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/MIME-tools/Active/">MIME-tools</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bitcard [...] t.themuffin.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-21368-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
5.412    </td>
  </tr>
  <tr id="CF-21369-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;11&nbsp;10:57:28&nbsp;2008</span>
    <span class="description">bitcard [...] t.themuffin.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> MIME::Field::ParamVal mishandles mixed RFC2231 and non-RFC2231
 parameters</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">When long parameter values are split per RFC2231 and a non-RFC2231
version is also present, MIME::Field::ParamVal::parse_params will
concatenate both versions together.  Apple Mail, at least, uses both
parameter styles; for example:
Content-Disposition: inline;
  filename=&#34;Once upon a time, there was a really long filename who lived
in the enchanted Internet&#34;;
  filename*0=&#34;Once upon a time, there was a really long filename who l&#34;;
  filename*1=&#34;ived in the enchanted Internet&#34;

parse_params implicitly assigns the non-RFC2231 version to part 0, which
is fine, except that any parts with the same sequence number are
concatenated together.  The resulting parsed filename is &#34;Once upon a
time, there was a really long filename who lived in the enchanted
InternetOnce upon a time, there was a really long filename who lived in
the enchanted Internet&#34;

The easiest fix is to have parts with the same sequence number replace
each other.  RFC2231 doesn&#39;t say what should be done when the same
number is seen again, but there&#39;s no reason anyone reading the RFC
should want to use the same sequence number for more than one part
either.  The attached patch &#40;against 5.427&#41; does exactly this, which
fixes the reported bug by preferring the RFC2231-style header when it&#39;s
present.


Test case:
use MIME::Field::ParamVal;
my &#40;$res, $headerval&#41;;
$headerval = q{inline;
  filename=&#34;Once upon a time, there was a really long filename who lived
in the enchanted Internet&#34;;
  filename*0=&#34;Once upon a time, there was a really long filename who l&#34;;
  filename*1=&#34;ived in the enchanted Internet&#34;
};
$res = MIME::Field::ParamVal::parse_params&#40;&#34;&#34;, $headerval&#41;;
printf&#40;&#34;Filename: %s\n&#34;, $res-&gt;{filename}&#41;;
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ParamVal.pm.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- MIME/Field/ParamVal.pm.orig	2008-12-10 16:35:51.488762758 -0500
+++ MIME/Field/ParamVal.pm	2008-12-10 16:35:56.965546083 -0500
@@ -266,7 +266,7 @@
 	    if &#40;!defined&#40;$qstr&#41;&#41; {
 		$val = rfc2231decode&#40;$val&#41;;
 	    }
-	    $rfc2231params{$name}{$num} .= $val;
+	    $rfc2231params{$name}{$num} = $val;
 	} else {
 	    # Make a fake &#34;part zero&#34; for non-RFC2231 params
 	    $rfc2231params{$param}{&#34;0&#34;} = $val;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;12&nbsp;10:36:36&nbsp;2008</span>
    <span class="description">dfs+pause [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ben Winslow via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; When long parameter values are split per RFC2231 and a non-RFC2231
&gt; version is also present, MIME::Field::ParamVal::parse_params will
&gt; concatenate both versions together.  Apple Mail, at least, uses both
&gt; parameter styles; for example:
&gt; Content-Disposition: inline;
&gt;   filename=&#34;Once upon a time, there was a really long filename who lived
&gt; in the enchanted Internet&#34;;
&gt;   filename*0=&#34;Once upon a time, there was a really long filename who l&#34;;
&gt;   filename*1=&#34;ived in the enchanted Internet&#34;
</div>
I would call that a bug in Apple Mail.  The &#40;incredibly awful and
badly-written RFC 2231&#41; is silent about what to do when you have
mixed-style parameters like that.  Apple is therefore relying on unspecified
behaviour.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The easiest fix is to have parts with the same sequence number replace
&gt; each other.  RFC2231 doesn&#39;t say what should be done when the same
&gt; number is seen again, but there&#39;s no reason anyone reading the RFC
&gt; should want to use the same sequence number for more than one part
&gt; either.
</div>
The RFC does explicitly say:

    &#34;...the mechanism MUST NOT depend on parameter ordering
     since MIME states that parameters are not order
     sensitive.&#34;

So how would we handle this:

   Content-Disposition: inline;
       filename*1=&#34; blech&#34;;
       filename=&#34;foo bar&#34;;
       filename*0=&#34;foo&#34;;

It so happens that with Apple Mail, filename matches the concatenation
of filename*n.  But I don&#39;t think MIME::Tools should incorporate code
to work around broken MIME generators.

Regards,

David.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;12&nbsp;10:36:37&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;12&nbsp;14:29:05&nbsp;2008</span>
    <span class="description">bitcard [...] t.themuffin.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bitcard [...] t.themuffin.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 12 10:36:36 2008, DSKOLL wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ben Winslow via RT wrote:
<div class="message-stanza open">&gt; &gt; When long parameter values are split per RFC2231 and a non-RFC2231
&gt; &gt; version is also present, MIME::Field::ParamVal::parse_params will
&gt; &gt; concatenate both versions together.  Apple Mail, at least, uses both
&gt; &gt; parameter styles; for example:
</div></div> 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I would call that a bug in Apple Mail.  The &#40;incredibly awful and
&gt; badly-written RFC 2231&#41; is silent about what to do when you have
&gt; mixed-style parameters like that.  Apple is therefore relying on
</div>unspecified
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; behaviour.
</div>
Well, the RFC explicitly states that parameter value continuations are
meant to prevent damage to the value by header wrapping.  Leading
whitespace is fine when wrapping headers, but it might not be fine when
gluing together a parameter -- one of the examples in the RFC is an URI
&#40;for the rarely used message/external-body type&#41;, where whitespace in
the URI is obviously wrong.  It seems logical to me, then, that the
RFC2231-style values should always be preferred when present -- the
non-RFC2231 value is only useful for reverse compatibility.  While the
RFC should definitely have stated this explicitly, I think it&#39;s
reasonable to treat the non-RFC2231 value this way &#40;and I&#39;m sure this
probably seemed obvious when RFC2231 was written and nothing supported
it yet.&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; The easiest fix is to have parts with the same sequence number replace
&gt; &gt; each other.  RFC2231 doesn&#39;t say what should be done when the same
&gt; &gt; number is seen again, but there&#39;s no reason anyone reading the RFC
&gt; &gt; should want to use the same sequence number for more than one part
&gt; &gt; either.
</div>&gt; 
&gt; The RFC does explicitly say:
&gt; 
&gt;     &#34;...the mechanism MUST NOT depend on parameter ordering
&gt;      since MIME states that parameters are not order
&gt;      sensitive.&#34;
</div>
Good point.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So how would we handle this:
&gt; 
&gt;    Content-Disposition: inline;
&gt;        filename*1=&#34; blech&#34;;
&gt;        filename=&#34;foo bar&#34;;
&gt;        filename*0=&#34;foo&#34;;
</div>
Okay, perhaps simply assigning the non-RFC2231 value to part 0 is naïve
-- that&#39;s easy enough to fix, and I&#39;ll post an updated patch later
today.  I still think the RFC2231 value should be used &#40;&#34;foo bleh&#34;&#41;, as
the non-RFC2231 filename may simply be a reduced version of the RFC2231
filename; for example, a file named &#34;genetisch geänderte
Mörderkaninchen.jpg&#34; could be sent as:

Content-Disposition: inline;
  filename*0*=iso-8859-1&#39;de&#39;genetisch%20ge%E4nderte%20M%F6rderkan;
  filename*1=&#34;inchen.jpg&#34;;
  filename=&#34;genetisch geaenderte Moerderkaninchen.jpg&#34;

In this case, I&#39;d want to use the RFC2231 version if I knew how to parse
it.  

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It so happens that with Apple Mail, filename matches the concatenation
&gt; of filename*n.  But I don&#39;t think MIME::Tools should incorporate code
&gt; to work around broken MIME generators.
</div>
We could argue all day about whether Apple Mail&#39;s behavior is correct or
not, but Apple Mail does behave this way right now, and real people are
sending real messages with it.  Failure to cope with these messages
&#40;especially in a gray area between standards&#41; isn&#39;t very robust, and
parsing the message differently than MUAs are parsing it doesn&#39;t benefit
anyone.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Regards,
&gt; 
&gt; David.
</div>
Just for reference, my &#40;very quick&#41; testing with RFC2231-style
attachment filenames before, after, and surrounding the non-RFC2231
filename turned up the following:
Thunderbird - Always uses the non-RFC2231 header when both are present
Claws-mail - Always uses the RFC2231 header when both are present
Opera Mail - Uses whichever version appears first &#40;even when mixed&#41;
Squirrelmail - No support for RFC2231; no support for filename in
Content-Disposition; attachment is untitled unless non-RFC2231 version
is present
Outlook Express 6.00.2800.1933 - No support for RFC2231; no support for
filename in Content-Disposition; attachment is untitled unless
non-RFC2231 version is present
Outlook 2000 - No support for RFC2231; no support for filename in
Content-Disposition; attachment is untitled unless non-RFC2231 version
is present

It&#39;s clear that RFC2231&#39;s ambiguity has lead to inconsistent support,
but MIME::Field::ParamVal&#39;s current behavior isn&#39;t in line with the way
anyone else seems to be supporting it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;12&nbsp;14:31:34&nbsp;2008</span>
    <span class="description">dfs+pause [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 12 14:29:05 2008, raineth wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It seems logical to me, then, that the
&gt; RFC2231-style values should always be preferred when present -- the
&gt; non-RFC2231 value is only useful for reverse compatibility.
</div>
OK.  That does seem reasonable &#40;though it&#39;s not what your patch does.&#41;

We&#39;ll look at implementing this behaviour.

Regards,

David.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;12&nbsp;14:50:24&nbsp;2008</span>
    <span class="description">dfs+pause [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Please try this patch... it ignores the non-RFC-2231 parameter if
at least one RFC-2231 parameter is present.  It should apply cleanly
to MIME-tools-5.427

diff --git a/MANIFEST b/MANIFEST
index 0d79335..c93adb3 100644
--- a/MANIFEST
+++ b/MANIFEST
@@ -73,6 +73,7 @@ t/Ref.t
 t/Smtpsend.t
 t/ticket-11901.t
 t/ticket-37139.t
+t/ticket-41632.t
 t/WordDecoder.t
 t/WordEncoder.t
 t/Words.t
diff --git a/lib/MIME/Field/ParamVal.pm b/lib/MIME/Field/ParamVal.pm
index 715c628..527d0db 100644
--- a/lib/MIME/Field/ParamVal.pm
+++ b/lib/MIME/Field/ParamVal.pm
@@ -268,13 +268,18 @@ sub parse_params {
            }
            $rfc2231params{$name}{$num} .= $val;
        } else {
-           # Make a fake &#34;part zero&#34; for non-RFC2231 params
-           $rfc2231params{$param}{&#34;0&#34;} = $val;
+           # Make a special part for non-RFC2231 params
+           $rfc2231params{$param}{&#34;-1&#34;} = $val;
        }
     }
 
     # Extract reconstructed parameters
     foreach $param &#40;keys %rfc2231params&#41; {
+       # If we have RFC2231 parts and a non-RFC2231 part, don&#39;t
+       # use the non-RFC2231 part.
+       if &#40;exists&#40;$rfc2231params{$param}{&#34;-1&#34;}&#41; &#38;&#38;
scalar&#40;keys&#40;%{$rfc2231params{$param}}&#41;&#41; &gt; 1&#41; {
+               delete&#40;$rfc2231params{$param}{&#34;-1&#34;}&#41;;
+       }
        foreach $part &#40;sort { $a &lt;=&gt; $b } keys %{$rfc2231params{$param}}&#41; {
            $params{$param} .= $rfc2231params{$param}{$part};
        }
diff --git a/t/ticket-41632.t b/t/ticket-41632.t
new file mode 100644
index 0000000..122f211
--- /dev/null
+++ b/t/ticket-41632.t
@@ -0,0 +1,22 @@
+use strict;
+use warnings;
+
+use Test::More tests =&gt; 4;
+
+# Handle the case of both RFC-2231 and non-RFC-2231 parameter values.
+# In this case, we ignore the non-RFC-2231 parameters
+
+use MIME::Field::ParamVal;
+
+my $params;
+
+$params = MIME::Field::ParamVal-&gt;parse_params&#40;&#39;inline; filename=&#34;foo&#34;;
filename*1=&#34;ar&#34;; filename*0=&#34;b&#34;&#39;&#41;;
+
+is&#40;$params-&gt;{&#39;_&#39;}, &#39;inline&#39;, &#39;Got the &#34;inline&#34; right&#39;&#41;;
+is&#40;$params-&gt;{&#39;filename&#39;}, &#39;bar&#39;, &#39;Ignored non-RFC-2331 value if
RFC-2231 parameters are present&#39;&#41;;
+
+$params = MIME::Field::ParamVal-&gt;parse_params&#40;&#39;inline; filename=&#34;foo&#34;&#39;&#41;;
+is&#40;$params-&gt;{&#39;filename&#39;}, &#39;foo&#39;, &#39;Got filename if RFC-2231 parameters
are absent&#39;&#41;;
+
+$params = MIME::Field::ParamVal-&gt;parse_params&#40;&#39;inline; filename*1=&#34;ar&#34;;
filename*0=&#34;b&#34;&#39;&#41;;
+is&#40;$params-&gt;{&#39;filename&#39;}, &#39;bar&#39;, &#39;Got RFC-2231 value&#39;&#41;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;12&nbsp;14:51:44&nbsp;2008</span>
    <span class="description">dfs+pause [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Sorry... the patch was mangled by my browser.  Please try the attached
version.

Regards,

David.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/MANIFEST b/MANIFEST
index 0d79335..c93adb3 100644
--- a/MANIFEST
+++ b/MANIFEST
@@ -73,6 +73,7 @@ t/Ref.t
 t/Smtpsend.t
 t/ticket-11901.t
 t/ticket-37139.t
+t/ticket-41632.t
 t/WordDecoder.t
 t/WordEncoder.t
 t/Words.t
diff --git a/lib/MIME/Field/ParamVal.pm b/lib/MIME/Field/ParamVal.pm
index 715c628..527d0db 100644
--- a/lib/MIME/Field/ParamVal.pm
+++ b/lib/MIME/Field/ParamVal.pm
@@ -268,13 +268,18 @@ sub parse_params {
 	    }
 	    $rfc2231params{$name}{$num} .= $val;
 	} else {
-	    # Make a fake &#34;part zero&#34; for non-RFC2231 params
-	    $rfc2231params{$param}{&#34;0&#34;} = $val;
+	    # Make a special part for non-RFC2231 params
+	    $rfc2231params{$param}{&#34;-1&#34;} = $val;
 	}
     }
 
     # Extract reconstructed parameters
     foreach $param &#40;keys %rfc2231params&#41; {
+	# If we have RFC2231 parts and a non-RFC2231 part, don&#39;t
+	# use the non-RFC2231 part.
+	if &#40;exists&#40;$rfc2231params{$param}{&#34;-1&#34;}&#41; &#38;&#38; scalar&#40;keys&#40;%{$rfc2231params{$param}}&#41;&#41; &gt; 1&#41; {
+		delete&#40;$rfc2231params{$param}{&#34;-1&#34;}&#41;;
+	}
 	foreach $part &#40;sort { $a &lt;=&gt; $b } keys %{$rfc2231params{$param}}&#41; {
 	    $params{$param} .= $rfc2231params{$param}{$part};
 	}
diff --git a/t/ticket-41632.t b/t/ticket-41632.t
new file mode 100644
index 0000000..122f211
--- /dev/null
+++ b/t/ticket-41632.t
@@ -0,0 +1,22 @@
+use strict;
+use warnings;
+
+use Test::More tests =&gt; 4;
+
+# Handle the case of both RFC-2231 and non-RFC-2231 parameter values.
+# In this case, we ignore the non-RFC-2231 parameters
+
+use MIME::Field::ParamVal;
+
+my $params;
+
+$params = MIME::Field::ParamVal-&gt;parse_params&#40;&#39;inline; filename=&#34;foo&#34;; filename*1=&#34;ar&#34;; filename*0=&#34;b&#34;&#39;&#41;;
+
+is&#40;$params-&gt;{&#39;_&#39;}, &#39;inline&#39;, &#39;Got the &#34;inline&#34; right&#39;&#41;;
+is&#40;$params-&gt;{&#39;filename&#39;}, &#39;bar&#39;, &#39;Ignored non-RFC-2331 value if RFC-2231 parameters are present&#39;&#41;;
+
+$params = MIME::Field::ParamVal-&gt;parse_params&#40;&#39;inline; filename=&#34;foo&#34;&#39;&#41;;
+is&#40;$params-&gt;{&#39;filename&#39;}, &#39;foo&#39;, &#39;Got filename if RFC-2231 parameters are absent&#39;&#41;;
+
+$params = MIME::Field::ParamVal-&gt;parse_params&#40;&#39;inline; filename*1=&#34;ar&#34;; filename*0=&#34;b&#34;&#39;&#41;;
+is&#40;$params-&gt;{&#39;filename&#39;}, &#39;bar&#39;, &#39;Got RFC-2231 value&#39;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;12&nbsp;15:59:25&nbsp;2008</span>
    <span class="description">bitcard [...] t.themuffin.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bitcard [...] t.themuffin.net</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 12 14:51:44 2008, DSKOLL wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
</div>
Hello,

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sorry... the patch was mangled by my browser.  Please try the attached
&gt; version.
</div>
I tried your patch, and it applied cleanly and worked as expected.  I
had already fixed it locally in a different way, so I&#39;m attaching a
patch for that as well.  It passes all your testcases, but it doesn&#39;t
check to ensure the RFC2231 value has at least 1 character, which is
probably a good idea.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Regards,
&gt; 
&gt; David.
</div>
Thank you!

Ben
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- ParamVal.pm.orig	2008-12-10 16:35:51.488762758 -0500
+++ ParamVal.pm	2008-12-12 15:46:48.920758498 -0500
@@ -268,13 +268,14 @@
 	    }
 	    $rfc2231params{$name}{$num} .= $val;
 	} else {
-	    # Make a fake &#34;part zero&#34; for non-RFC2231 params
-	    $rfc2231params{$param}{&#34;0&#34;} = $val;
+	    # Assign it directly if it&#39;s not a RFC 2231 value
+	    $params{$param} = $val;
 	}
     }
 
     # Extract reconstructed parameters
     foreach $param &#40;keys %rfc2231params&#41; {
+	$params{$param} = &#34;&#34;;
 	foreach $part &#40;sort { $a &lt;=&gt; $b } keys %{$rfc2231params{$param}}&#41; {
 	    $params{$param} .= $rfc2231params{$param}{$part};
 	}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;12&nbsp;16:19:56&nbsp;2008</span>
    <span class="description">dfs+pause [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, Ben,

I like your patch better; it&#39;s more efficient.  Attached is my
final version &#40;which is basically your patch plus some comments and
additional test cases.&#41;

Regards,

David.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/MANIFEST b/MANIFEST
index 0d79335..c93adb3 100644
--- a/MANIFEST
+++ b/MANIFEST
@@ -73,6 +73,7 @@ t/Ref.t
 t/Smtpsend.t
 t/ticket-11901.t
 t/ticket-37139.t
+t/ticket-41632.t
 t/WordDecoder.t
 t/WordEncoder.t
 t/Words.t
diff --git a/lib/MIME/Field/ParamVal.pm b/lib/MIME/Field/ParamVal.pm
index 715c628..ca12825 100644
--- a/lib/MIME/Field/ParamVal.pm
+++ b/lib/MIME/Field/ParamVal.pm
@@ -268,13 +268,19 @@ sub parse_params {
 	    }
 	    $rfc2231params{$name}{$num} .= $val;
 	} else {
-	    # Make a fake &#34;part zero&#34; for non-RFC2231 params
-	    $rfc2231params{$param}{&#34;0&#34;} = $val;
+	    # Assign non-rfc2231 value directly.  If we
+	    # did get a mix of rfc2231 and non-rfc2231 values,
+            # the non-rfc2231 will be blown away in the
+	    # &#34;extract reconstructed parameters&#34; loop.
+	    $params{$param} = $val;
 	}
     }
 
     # Extract reconstructed parameters
     foreach $param &#40;keys %rfc2231params&#41; {
+	# If we got any rfc-2231 parameters, then
+        # blow away any potential non-rfc-2231 parameter.
+	$params{$param} = &#39;&#39;;
 	foreach $part &#40;sort { $a &lt;=&gt; $b } keys %{$rfc2231params{$param}}&#41; {
 	    $params{$param} .= $rfc2231params{$param}{$part};
 	}
diff --git a/t/ticket-41632.t b/t/ticket-41632.t
new file mode 100644
index 0000000..1ef6f04
--- /dev/null
+++ b/t/ticket-41632.t
@@ -0,0 +1,28 @@
+use strict;
+use warnings;
+
+use Test::More tests =&gt; 6;
+
+# Handle the case of both RFC-2231 and non-RFC-2231 parameter values.
+# In this case, we ignore the non-RFC-2231 parameters
+
+use MIME::Field::ParamVal;
+
+my $params;
+
+$params = MIME::Field::ParamVal-&gt;parse_params&#40;&#39;inline; filename=&#34;foo&#34;; filename*1=&#34;ar&#34;; filename*0=&#34;b&#34;&#39;&#41;;
+
+is&#40;$params-&gt;{&#39;_&#39;}, &#39;inline&#39;, &#39;Got the &#34;inline&#34; right&#39;&#41;;
+is&#40;$params-&gt;{&#39;filename&#39;}, &#39;bar&#39;, &#39;Ignored non-RFC-2231 value if RFC-2231 parameters are present&#39;&#41;;
+
+$params = MIME::Field::ParamVal-&gt;parse_params&#40;&#39;inline; filename=&#34;foo&#34;&#39;&#41;;
+is&#40;$params-&gt;{&#39;filename&#39;}, &#39;foo&#39;, &#39;Got filename if RFC-2231 parameters are absent&#39;&#41;;
+
+$params = MIME::Field::ParamVal-&gt;parse_params&#40;&#39;inline; filename*1=&#34;ar&#34;; filename*0=&#34;b&#34;&#39;&#41;;
+is&#40;$params-&gt;{&#39;filename&#39;}, &#39;bar&#39;, &#39;Got RFC-2231 value&#39;&#41;;
+
+$params = MIME::Field::ParamVal-&gt;parse_params&#40;&#39;inline; filename*1=&#34;ar&#34;; filename=&#34;foo&#34;; filename*0=&#34;b&#34;&#39;&#41;;
+is&#40;$params-&gt;{&#39;filename&#39;}, &#39;bar&#39;, &#39;Ignored non-RFC-2231 value if RFC-2231 parameters are present&#39;&#41;;
+
+$params = MIME::Field::ParamVal-&gt;parse_params&#40;&#39;inline; filename*1=&#34;ar&#34;; filename*0=&#34;b&#34;; filename=&#34;foo&#34;&#39;&#41;;
+is&#40;$params-&gt;{&#39;filename&#39;}, &#39;bar&#39;, &#39;Ignored non-RFC-2231 value if RFC-2231 parameters are present&#39;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;12&nbsp;17:33:43&nbsp;2008</span>
    <span class="description">bitcard [...] t.themuffin.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bitcard [...] t.themuffin.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 12 16:19:56 2008, DSKOLL wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, Ben,
&gt; 
&gt; I like your patch better; it&#39;s more efficient.  Attached is my
&gt; final version &#40;which is basically your patch plus some comments and
&gt; additional test cases.&#41;
</div>
Excellent!  This works for me.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Regards,
&gt; 
&gt; David.
</div>

Thanks again,

Ben
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;22&nbsp;11:34:51&nbsp;2010</span>
    <span class="description">dmo+pause [...] dmo.ca -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in 5.428 release
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;22&nbsp;11:34:52&nbsp;2010</span>
    <span class="description">dmo+pause [...] dmo.ca -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
