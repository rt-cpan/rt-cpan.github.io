<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #108956 for XML-Simple: XML::Simple doesn&#39;t encode unprintable characters</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #108956 for XML-Simple: XML::Simple doesn&#39;t encode unprintable characters</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/XML-Simple/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/XML-Simple/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/XML-Simple/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/XML-Simple/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-Simple">XML-Simple CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">108956</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/XML-Simple/Active/">XML-Simple</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">grantm [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
PJNEWMAN [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-37628-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.18    </td>
  </tr>
  <tr id="CF-37629-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;15&nbsp;05:38:43&nbsp;2015</span>
    <span class="description">PJNEWMAN [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> XML::Simple doesn&#39;t encode unprintable characters</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">XML::Simple doesn&#39;t encode unprintable characters and therefore generates invalid XML:

XML::Simple isn&#39;t escaping the characters, hence the invalid XML being generated. See the example code below:

#!/usr/bin/perl -w
use strict;
use XML::Simple;

my $conf;
$conf-&gt;{baz}[0] = &#34;foo\x07bar&#34;;
print XMLout&#40;$conf, keyattr =&gt; [&#39;&#39;]&#41;;


./testxml | xmllint --noout -
-:2: parser error : PCDATA invalid Char value 7
  &lt;baz&gt;foobar&lt;/baz&gt;
          ^
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;15&nbsp;06:06:14&nbsp;2015</span>
    <span class="description">PJNEWMAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">My workaround is currently this, but it&#39;s not particularly ideal:
#!/usr/bin/perl -w
use strict;
use XML::Simple;

my $conf;
my $string = &#34;foo\x07bar&#34;;
$string =~ s/&#40;[\0-\x08\x0b\x0c\x0e-\x1f\x7f]&#41;/sprintf&#40;&#34;\\x%02x&#34;,ord&#40;$1&#41;&#41;;/xeg;
$conf-&gt;{baz}[0] = $string;
print XMLout&#40;$conf, keyattr =&gt; [&#39;&#39;]&#41;;

On Sun Nov 15 10:38:43 2015, PJNEWMAN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; XML::Simple doesn&#39;t encode unprintable characters and therefore
&gt; generates invalid XML:
&gt; 
&gt; XML::Simple isn&#39;t escaping the characters, hence the invalid XML being
&gt; generated. See the example code below:
&gt; 
&gt; #!/usr/bin/perl -w
&gt; use strict;
&gt; use XML::Simple;
&gt; 
&gt; my $conf;
&gt; $conf-&gt;{baz}[0] = &#34;foo\x07bar&#34;;
&gt; print XMLout&#40;$conf, keyattr =&gt; [&#39;&#39;]&#41;;
&gt; 
&gt; 
&gt; ./testxml | xmllint --noout -
&gt; -:2: parser error : PCDATA invalid Char value 7
&gt;   &lt;baz&gt;foobar&lt;/baz&gt;
&gt;           ^
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;15&nbsp;06:33:50&nbsp;2015</span>
    <span class="description">PJNEWMAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Of course I actually meant the following to correctly escape to XML:
#!/usr/bin/perl -w
use strict;
use XML::Simple;

my $conf;
my $string = &#34;foo\x07bar&#34;;
$string =~ s/&#40;[\0-\x08\x0b\x0c\x0e-\x1f\x7f]&#41;/sprintf&#40;&#34;&#38;#x%02x;&#34;,ord&#40;$1&#41;&#41;;/eg;
$conf-&gt;{baz}[0] = $string;
print XMLout&#40;$conf, keyattr =&gt; [&#39;&#39;]&#41;;


On Sun Nov 15 11:06:14 2015, PJNEWMAN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; My workaround is currently this, but it&#39;s not particularly ideal:
&gt; #!/usr/bin/perl -w
&gt; use strict;
&gt; use XML::Simple;
&gt; 
&gt; my $conf;
&gt; my $string = &#34;foo\x07bar&#34;;
&gt; $string =~ s/&#40;[\0-\x08\x0b\x0c\x0e-
&gt; \x1f\x7f]&#41;/sprintf&#40;&#34;\\x%02x&#34;,ord&#40;$1&#41;&#41;;/xeg;
&gt; $conf-&gt;{baz}[0] = $string;
&gt; print XMLout&#40;$conf, keyattr =&gt; [&#39;&#39;]&#41;;
&gt; 
&gt; On Sun Nov 15 10:38:43 2015, PJNEWMAN wrote:
<div class="message-stanza open">&gt; &gt; XML::Simple doesn&#39;t encode unprintable characters and therefore
&gt; &gt; generates invalid XML:
&gt; &gt;
&gt; &gt; XML::Simple isn&#39;t escaping the characters, hence the invalid XML
&gt; &gt; being
&gt; &gt; generated. See the example code below:
&gt; &gt;
&gt; &gt; #!/usr/bin/perl -w
&gt; &gt; use strict;
&gt; &gt; use XML::Simple;
&gt; &gt;
&gt; &gt; my $conf;
&gt; &gt; $conf-&gt;{baz}[0] = &#34;foo\x07bar&#34;;
&gt; &gt; print XMLout&#40;$conf, keyattr =&gt; [&#39;&#39;]&#41;;
&gt; &gt;
&gt; &gt;
&gt; &gt; ./testxml | xmllint --noout -
&gt; &gt; -:2: parser error : PCDATA invalid Char value 7
&gt; &gt;   &lt;baz&gt;foobar&lt;/baz&gt;
&gt; &gt;           ^
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;04&nbsp;14:42:26&nbsp;2015</span>
    <span class="description">grantm [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Peter

The problem with the characters you&#39;re encountering is that they are not valid characters in an XML document regardless of whether they are represented as simple bytes or as numeric character entities.

The relevant section of the spec is: <span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/TR/REC-xml/#charsets">http://www.w3.org/TR/REC-xml/#charsets</a></span>

and it defines a character as:

  Char ::= #x9 | #xA | #xD | [#x20-#xD7FF] | [#xE000-#xFFFD] | [#x10000-#x10FFFF]

You&#39;ll notice that this excludes characters in the ranges x00-x08 and x0E-x1F.

I think that XML 1.1 does relax this restriction but that won&#39;t help unless you&#39;re passing the XML to a 1.1 compliant parser &#40;you&#39;d probably also need to add an XML declaration with version=&#39;1.1&#39;&#41;.

If you are feeding the resulting XML to a parser that accepts &#38;#x07; as a valid character, then you can subclass XML::Simple to implement your escaping:

==========

package XML::SimpleCustomEscapes;

use parent &#39;XML::Simple&#39;;

sub escape_value {
  my $self = shift;
  my $data = $self-&gt;SUPER::escape_value&#40;shift&#41;;

  $data =~ s/&#40;[\0-\x08\x0b\x0c\x0e-\x1f\x7f]&#41;/sprintf&#40;&#34;&#38;#x%02x;&#34;,ord&#40;$1&#41;&#41;;/eg;

  return $data;
}

1;

==========

Regards
Grant
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;04&nbsp;14:42:26&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;04&nbsp;14:42:29&nbsp;2015</span>
    <span class="description">grantm [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;04&nbsp;14:42:30&nbsp;2015</span>
    <span class="description">grantm [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
