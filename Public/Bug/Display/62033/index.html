<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #62033 for DBD-ODBC: prepared_cache invalid after error</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #62033 for DBD-ODBC: prepared_cache invalid after error</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-ODBC/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-ODBC/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-ODBC/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-ODBC/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-ODBC">DBD-ODBC CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">62033</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-ODBC/Active/">DBD-ODBC</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Damon.Atkins [...] contracted.pmintl.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10188-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10189-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.26_4    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




prepare_cache.log<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/868334/449703/prepare_cache.log">
Mon Dec 13 19:50:37 2010 (36.4k) by Damon.Atkins [...] contracted.pmintl.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;10&nbsp;16:55:59&nbsp;2010</span>
    <span class="description">Damon.Atkins [...] contracted.pmintl.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> prepared_cache invalid after error</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 10 Oct 2010 22:55:28 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBI [...] rt.cpan.org&#34; &lt;bug-DBI [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Atkins, Damon &#40;contracted&#41;&#34; &lt;Damon.Atkins [...] contracted.pmintl.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">For example if you prepare_cache&#40;&#39;insert....&#39;&#41;  &#40;Perl on Win32 ODBC to MSSQL&#41;
and then insert a NULL into a non-null field, an execute error occurs.

Then you come back to do a valid insert, it freezes at the execute. &#40;I thought I had an SQL dead lock&#41;
I found the fix was to delete the dbi hash used by the prepare_cache on execute errror, so that
 when prepare_cache is called again it is completed from scratch &#40;ie no cache&#41;.

DBD.pm 9530 2007-05-09 13:05:23Z
W32ODBC.pm 8696 2007-01-24 23:12:38Z timbo $
This is perl, v5.8.8 built for MSWin32-x86-multi-thread
&#40;with 18 registered patches, see perl -V for more detail&#41;

Cheers
Damon


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">________________________________
NOTICE: This e-mail may contain confidential information, which should not be copied or distributed without authorization. If you have received this e-mail message by mistake, please inform the sender and delete it from your system. Please note that, for the efficient preservation of Company records that may be required for litigation, e-mail messages sent to the author of this message will be copied and may be retained in a secure repository.
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;12&nbsp;07:52:17&nbsp;2010</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Moved to DBD-ODBC as I&#39;m sure this isn&#39;t a bug in DBI itself.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;12&nbsp;07:52:17&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;12&nbsp;07:52:18&nbsp;2010</span>
    <span class="description">TIMB [...] cpan.org -  Queue changed from DBI to DBD-ODBC</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;26&nbsp;14:15:00&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Oct 10 16:55:59 2010, Damon.Atkins@contracted.pmintl.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; For example if you prepare_cache&#40;&#39;insert....&#39;&#41;  &#40;Perl on Win32 ODBC to
&gt;    MSSQL&#41;
&gt; and then insert a NULL into a non-null field, an execute error occurs.
&gt; 
&gt; Then you come back to do a valid insert, it freezes at the execute. &#40;I
&gt;    thought I had an SQL dead lock&#41;
&gt; I found the fix was to delete the dbi hash used by the prepare_cache
&gt;    on execute errror, so that
&gt;  when prepare_cache is called again it is completed from scratch &#40;ie
&gt;    no cache&#41;.
&gt; 
&gt; DBD.pm 9530 2007-05-09 13:05:23Z
&gt; W32ODBC.pm 8696 2007-01-24 23:12:38Z timbo $
&gt; This is perl, v5.8.8 built for MSWin32-x86-multi-thread
&gt; &#40;with 18 registered patches, see perl -V for more detail&#41;
&gt; 
&gt; Cheers
&gt; Damon
&gt; 
&gt; 
</div>
Appologies for not responding earlier but I never got an email from rt
to say this bug was logged so missed it. I will attempt to look into
your problem in the next few days.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;27&nbsp;05:41:08&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Oct 26 14:15:00 2010, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun Oct 10 16:55:59 2010, Damon.Atkins@contracted.pmintl.com wrote:
<div class="message-stanza open">&gt; &gt; For example if you prepare_cache&#40;&#39;insert....&#39;&#41;  &#40;Perl on Win32 ODBC to
&gt; &gt;    MSSQL&#41;
&gt; &gt; and then insert a NULL into a non-null field, an execute error occurs.
&gt; &gt; 
&gt; &gt; Then you come back to do a valid insert, it freezes at the execute. &#40;I
&gt; &gt;    thought I had an SQL dead lock&#41;
&gt; &gt; I found the fix was to delete the dbi hash used by the prepare_cache
&gt; &gt;    on execute errror, so that
&gt; &gt;  when prepare_cache is called again it is completed from scratch &#40;ie
&gt; &gt;    no cache&#41;.
&gt; &gt; 
&gt; &gt; DBD.pm 9530 2007-05-09 13:05:23Z
&gt; &gt; W32ODBC.pm 8696 2007-01-24 23:12:38Z timbo $
&gt; &gt; This is perl, v5.8.8 built for MSWin32-x86-multi-thread
&gt; &gt; &#40;with 18 registered patches, see perl -V for more detail&#41;
&gt; &gt; 
&gt; &gt; Cheers
&gt; &gt; Damon
&gt; &gt; 
&gt; &gt; 
</div>&gt; 
&gt; Appologies for not responding earlier but I never got an email from rt
&gt; to say this bug was logged so missed it. I will attempt to look into
&gt; your problem in the next few days.
&gt; 
&gt; Martin
</div>
Hang on a minute. Are you using WIN32ODBC or DBD::ODBC?

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;29&nbsp;05:27:34&nbsp;2010</span>
    <span class="description">Damon.Atkins [...] contracted.pmintl.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #62033] prepared_cache invalid after error </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 29 Oct 2010 05:38:45 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBD-ODBC [...] rt.cpan.org&#34; &lt;bug-DBD-ODBC [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Atkins, Damon &#40;contracted&#41;&#34; &lt;Damon.Atkins [...] contracted.pmintl.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">        $$pconnectstring = DBI-&gt;connect&#40;&#34;dbi:ODBC:$dsn&#34;, $login, $pwd

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Martin J Evans via RT [mailto:bug-DBD-ODBC@rt.cpan.org]
Sent: Wednesday, 27 October 2010 8:41 PM
To: Atkins, Damon &#40;contracted&#41;
Subject: [rt.cpan.org #62033] prepared_cache invalid after error

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=62033">https://rt.cpan.org/Ticket/Display.html?id=62033</a></span> &gt;


Hang on a minute. Are you using WIN32ODBC or DBD::ODBC?

Martin
--
Martin J. Evans
Wetherby, UK


NOTICE: This e-mail may contain confidential information, which should not be copied or distributed without authorization.  If you have received this e-mail message by mistake, please inform the sender and delete it from your system.  Please note that, for the efficient preservation of Company records that may be required for litigation, e-mail messages sent to the author of this message will be copied and may be retained in a secure repository.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;01&nbsp;14:32:14&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Oct 29 05:27:34 2010, Damon.Atkins@contracted.pmintl.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         $$pconnectstring = DBI-&gt;connect&#40;&#34;dbi:ODBC:$dsn&#34;, $login, $pwd
&gt;    -----Original Message-----
&gt; From: Martin J Evans via RT
&gt;    [mailto:bug-DBD-ODBC@rt.cpan.org]
&gt; Sent: Wednesday, 27 October 2010
&gt;    8:41 PM
&gt; To: Atkins, Damon &#40;contracted&#41;
&gt; Subject: [rt.cpan.org
&gt;    #62033] prepared_cache invalid after error
&gt; 
&gt; &lt;URL:
&gt;    <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=62033">https://rt.cpan.org/Ticket/Display.html?id=62033</a></span> &gt;
&gt; 
&gt; 
&gt; Hang on a
&gt;    minute. Are you using WIN32ODBC or DBD::ODBC?
&gt; 
&gt; Martin
</div>
The following works for me and outputs:

C:\Users\martin\Documents\dbd_odbc\rt62033&gt;perl test.pl
DBD::ODBC::st execute failed: [Microsoft][ODBC SQL Server Driver][SQL
Server]Can
not insert the value NULL into column &#39;b&#39;, table &#39;master.dbo.mje&#39;;
column does n
ot allow nulls. INSERT fails. &#40;SQL-23000&#41; [state was 23000 now 01000]
[Microsoft][ODBC SQL Server Driver][SQL Server]The statement has been
terminated
. &#40;SQL-01000&#41; at test.pl line 14.
&#39;1&#39;, &#39;fred      &#39;
1 rows
1

use DBI;
use strict;

my $h = DBI-&gt;connect&#40;&#34;dbi:ODBC:asus2&#34;,
                     {PrintError =&gt; 0}&#41; or die &#34;connect&#34;;

eval {$h-&gt;do&#40;q/drop table mje/&#41;;};

$h-&gt;do&#40;q/create table mje &#40;a int not null, b char&#40;10&#41; not null&#41;/&#41;;

my $s = $h-&gt;prepare_cached&#40;q/insert into mje values&#40;?,?&#41;/&#41;;

eval {
    $s-&gt;execute&#40;1, undef&#41;;
};
print &#34;insert null died\n&#34; if $@;

$s-&gt;execute&#40;1, &#39;fred&#39;&#41;;

my $r = $h-&gt;prepare&#40;q/select * from mje/&#41;;
$r-&gt;execute;
print DBI::dump_results&#40;$r&#41;;

What are you doing differently?

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;01&nbsp;19:09:35&nbsp;2010</span>
    <span class="description">Damon.Atkins [...] contracted.pmintl.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #62033] prepared_cache invalid after error </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 2 Nov 2010 00:09:19 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBD-ODBC [...] rt.cpan.org&#34; &lt;bug-DBD-ODBC [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Atkins, Damon &#40;contracted&#41;&#34; &lt;Damon.Atkins [...] contracted.pmintl.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Prepare cache is in a function and is called every time

The following works for me and outputs:

C:\Users\martin\Documents\dbd_odbc\rt62033&gt;perl test.pl
DBD::ODBC::st execute failed: [Microsoft][ODBC SQL Server Driver][SQL
Server]Can
not insert the value NULL into column &#39;b&#39;, table &#39;master.dbo.mje&#39;;
column does n
ot allow nulls. INSERT fails. &#40;SQL-23000&#41; [state was 23000 now 01000]
[Microsoft][ODBC SQL Server Driver][SQL Server]The statement has been
terminated
. &#40;SQL-01000&#41; at test.pl line 14.
&#39;1&#39;, &#39;fred      &#39;
1 rows
1

use DBI;
use strict;

# No eval warps, call prepare_cached each time
sub doit
{
 my $dbh=shift @_;
 my $s = $dbh-&gt;prepare_cached&#40;q/insert into mje values&#40;?,?&#41;/&#41;;
 $s-&gt;execute&#40;@_&#41;;
 print &#34;sql errors $DBI::errstr\n&#34;;
}


my $h = DBI-&gt;connect&#40;&#34;dbi:ODBC:asus2&#34;,
                     {PrintError =&gt; 0}&#41; or die &#34;connect&#34;;

eval {$h-&gt;do&#40;q/drop table mje/&#41;;};

$h-&gt;do&#40;q/create table mje &#40;a int not null, b char&#40;10&#41; not null&#41;/&#41;;

  doit&#40;$h,1, undef&#41;;
  doit&#40;$h,1,&#39;fred&#39;&#41;;

my $r = $h-&gt;prepare&#40;q/select * from mje/&#41;;
$r-&gt;execute;
print DBI::dump_results&#40;$r&#41;;

What are you doing differently?

Martin
--
Martin J. Evans
Wetherby, UK


NOTICE: This e-mail may contain confidential information, which should not be copied or distributed without authorization.  If you have received this e-mail message by mistake, please inform the sender and delete it from your system.  Please note that, for the efficient preservation of Company records that may be required for litigation, e-mail messages sent to the author of this message will be copied and may be retained in a secure repository.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;02&nbsp;04:08:11&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Nov 01 19:09:35 2010, Damon.Atkins@contracted.pmintl.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Prepare cache is in a function and is called every time
&gt; 
</div>
The following still works for me. What output do you get when you run it?

use DBI;
use strict;

sub doit
{
 my $dbh=shift @_;
 my $s = $dbh-&gt;prepare_cached&#40;q/insert into mje values&#40;?,?&#41;/&#41;;
 $s-&gt;execute&#40;@_&#41;;
 print &#34;sql errors $DBI::errstr\n&#34;;
}


my $h = DBI-&gt;connect&#40;&#34;dbi:ODBC:asus2&#34;,
                     {PrintError =&gt; 0}&#41; or die &#34;connect&#34;;

eval {$h-&gt;do&#40;q/drop table mje/&#41;;};

$h-&gt;do&#40;q/create table mje &#40;a int not null, b char&#40;10&#41; not null&#41;/&#41;;

  doit&#40;$h,1, undef&#41;;
  doit&#40;$h,1,&#39;fred&#39;&#41;;

my $r = $h-&gt;prepare&#40;q/select * from mje/&#41;;
$r-&gt;execute;
print DBI::dump_results&#40;$r&#41;;

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;02&nbsp;18:59:46&nbsp;2010</span>
    <span class="description">Damon.Atkins [...] contracted.pmintl.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #62033] prepared_cache invalid after error </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 2 Nov 2010 23:59:27 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBD-ODBC [...] rt.cpan.org&#34; &lt;bug-DBD-ODBC [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Atkins, Damon &#40;contracted&#41;&#34; &lt;Damon.Atkins [...] contracted.pmintl.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The value returned by $s = $dbh-&gt;prepare_cached&#40;...&#41; is invalid.
I asume that $s contains a handle to a prepared statement and that ODBC invalidates it &#40;or closes it, or MS SQL invalidates it&#41;
but $s = $dbh-&gt;prepare_cached&#40;...&#41; still returns it.
and so the execute fails.

Assuming your connecting to a MSSQL DB via ODBC

Maybe the next step is just to check versions of DLL&#39;s

Cheers


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Martin J Evans via RT [mailto:bug-DBD-ODBC@rt.cpan.org]
Sent: Tuesday, 2 November 2010 7:08 PM
To: Atkins, Damon &#40;contracted&#41;
Subject: [rt.cpan.org #62033] prepared_cache invalid after error

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=62033">https://rt.cpan.org/Ticket/Display.html?id=62033</a></span> &gt;

On Mon Nov 01 19:09:35 2010, Damon.Atkins@contracted.pmintl.com wrote:
<div class="message-stanza open">&gt;
&gt; Prepare cache is in a function and is called every time
&gt;
</div>
The following still works for me. What output do you get when you run it?

use DBI;
use strict;

sub doit
{
 my $dbh=shift @_;
 my $s = $dbh-&gt;prepare_cached&#40;q/insert into mje values&#40;?,?&#41;/&#41;;
 $s-&gt;execute&#40;@_&#41;;
 print &#34;sql errors $DBI::errstr\n&#34;;
}


my $h = DBI-&gt;connect&#40;&#34;dbi:ODBC:asus2&#34;,
                     {PrintError =&gt; 0}&#41; or die &#34;connect&#34;;

eval {$h-&gt;do&#40;q/drop table mje/&#41;;};

$h-&gt;do&#40;q/create table mje &#40;a int not null, b char&#40;10&#41; not null&#41;/&#41;;

  doit&#40;$h,1, undef&#41;;
  doit&#40;$h,1,&#39;fred&#39;&#41;;

my $r = $h-&gt;prepare&#40;q/select * from mje/&#41;;
$r-&gt;execute;
print DBI::dump_results&#40;$r&#41;;

Martin
--
Martin J. Evans
Wetherby, UK


NOTICE: This e-mail may contain confidential information, which should not be copied or distributed without authorization.  If you have received this e-mail message by mistake, please inform the sender and delete it from your system.  Please note that, for the efficient preservation of Company records that may be required for litigation, e-mail messages sent to the author of this message will be copied and may be retained in a secure repository.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;03&nbsp;04:25:22&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Nov 02 18:59:46 2010, Damon.Atkins@contracted.pmintl.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The value returned by $s = $dbh-&gt;prepare_cached&#40;...&#41; is invalid.
&gt; I
&gt;    asume that $s contains a handle to a prepared statement and that
&gt;    ODBC invalidates it &#40;or closes it, or MS SQL invalidates it&#41;
&gt; but
&gt;    $s = $dbh-&gt;prepare_cached&#40;...&#41; still returns it.
&gt; and so the
&gt;    execute fails.
&gt; 
&gt; Assuming your connecting to a MSSQL DB via ODBC
&gt;    Maybe the next step is just to check versions of DLL&#39;s
&gt; 
&gt; Cheers
</div>
I was connecting to MS SQL Server via ODBC.

Can you send me a trace.

set DBI_TRACE=15=x.log

then run the smallest script which reproduces the problem and send me
the log file.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;22&nbsp;09:02:41&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Nov 03 04:25:22 2010, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Nov 02 18:59:46 2010, Damon.Atkins@contracted.pmintl.com wrote:
<div class="message-stanza open">&gt; &gt; The value returned by $s = $dbh-&gt;prepare_cached&#40;...&#41; is invalid.
&gt; &gt; I
&gt; &gt;    asume that $s contains a handle to a prepared statement and that
&gt; &gt;    ODBC invalidates it &#40;or closes it, or MS SQL invalidates it&#41;
&gt; &gt; but
&gt; &gt;    $s = $dbh-&gt;prepare_cached&#40;...&#41; still returns it.
&gt; &gt; and so the
&gt; &gt;    execute fails.
&gt; &gt; 
&gt; &gt; Assuming your connecting to a MSSQL DB via ODBC
&gt; &gt;    Maybe the next step is just to check versions of DLL&#39;s
&gt; &gt; 
&gt; &gt; Cheers
</div>&gt; 
&gt; I was connecting to MS SQL Server via ODBC.
&gt; 
&gt; Can you send me a trace.
&gt; 
&gt; set DBI_TRACE=15=x.log
&gt; 
&gt; then run the smallest script which reproduces the problem and send me
&gt; the log file.
&gt; 
&gt; Martin
</div>
Have you resolved this issue?

I&#39;ve not heard anything in nearly 3 weeks and cannot see a way to 
progress this without a log as I cannot reproduce your problem.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;13&nbsp;12:12:55&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Nov 22 09:02:41 2010, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Nov 03 04:25:22 2010, MJEVANS wrote:
<div class="message-stanza open">&gt; &gt; On Tue Nov 02 18:59:46 2010, Damon.Atkins@contracted.pmintl.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; The value returned by $s = $dbh-&gt;prepare_cached&#40;...&#41; is invalid.
&gt; &gt; &gt; I
&gt; &gt; &gt;    asume that $s contains a handle to a prepared statement and that
&gt; &gt; &gt;    ODBC invalidates it &#40;or closes it, or MS SQL invalidates it&#41;
&gt; &gt; &gt; but
&gt; &gt; &gt;    $s = $dbh-&gt;prepare_cached&#40;...&#41; still returns it.
&gt; &gt; &gt; and so the
&gt; &gt; &gt;    execute fails.
&gt; &gt; &gt; 
&gt; &gt; &gt; Assuming your connecting to a MSSQL DB via ODBC
&gt; &gt; &gt;    Maybe the next step is just to check versions of DLL&#39;s
&gt; &gt; &gt; 
&gt; &gt; &gt; Cheers
</div>&gt; &gt; 
&gt; &gt; I was connecting to MS SQL Server via ODBC.
&gt; &gt; 
&gt; &gt; Can you send me a trace.
&gt; &gt; 
&gt; &gt; set DBI_TRACE=15=x.log
&gt; &gt; 
&gt; &gt; then run the smallest script which reproduces the problem and send me
&gt; &gt; the log file.
&gt; &gt; 
&gt; &gt; Martin
</div>&gt; 
&gt; Have you resolved this issue?
&gt; 
&gt; I&#39;ve not heard anything in nearly 3 weeks and cannot see a way to 
&gt; progress this without a log as I cannot reproduce your problem.
&gt; 
&gt; Martin
</div>
I will code this issue in a few days.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;13&nbsp;19:50:37&nbsp;2010</span>
    <span class="description">Damon.Atkins [...] contracted.pmintl.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #62033] prepared_cache invalid after error </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 14 Dec 2010 01:50:14 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBD-ODBC [...] rt.cpan.org&#34; &lt;bug-DBD-ODBC [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Atkins, Damon &#40;contracted&#41;&#34; &lt;Damon.Atkins [...] contracted.pmintl.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">0x2a00 DBI::db::get_info
0x10000 DBI::db::take_imp_data
0x10c00 DBI::db::disconnect
0x2000 DBI::db::selectrow_array
0x2200 DBI::db::tables
0x0430 DBI::db::quote_identifier
0x0000 DBI::db::clone
0x0430 DBI::db::quote
0x2200 DBI::db::type_info
0xaa00 DBI::db::statistics_info
0x2000 DBI::db::selectrow_arrayref
0x0400 DBI::db::begin_work
0x2800 DBI::db::last_insert_id
0xaa00 DBI::db::foreign_key_info
0x2200 DBI::db::primary_key
0x0c80 DBI::db::commit
0x0404 DBI::db::ping
0x2000 DBI::db::selectall_arrayref
0x2a00 DBI::db::type_info_all
0x3200 DBI::db::do
0x2000 DBI::db::selectcol_arrayref
0xa200 DBI::db::prepare_cached
0x0004 DBI::db::rows
0x0c80 DBI::db::rollback
0xaa00 DBI::db::column_info
0xaa00 DBI::db::table_info
0xaa00 DBI::db::primary_key_info
0xa200 DBI::db::prepare
0x0000 DBI::db::preparse
0x0004 DBI::db::connected
0x0200 DBI::db::data_sources
0x2000 DBI::db::selectall_hashref
0x2000 DBI::db::selectrow_hashref
0x0000 DBI::dr::default_user
0x0800 DBI::dr::data_sources
0x0800 DBI::dr::disconnect_all
0x8000 DBI::dr::connect_cached
0x8000 DBI::dr::connect
0x0000 DBI::st::more_results
0x0000 DBI::st::blob_read
0x0000 DBI::st::fetchall_hashref
0x0000 DBI::st::bind_param_inout_array
0x0000 DBI::st::finish
0x0004 DBI::st::rows
0x5040 DBI::st::execute_for_fetch
0x0000 DBI::st::fetchrow_hashref
0x0000 DBI::st::_get_fbav
0x0000 DBI::st::_set_fbav
0x0000 DBI::st::fetchrow
0x0000 DBI::st::fetch
0x5040 DBI::st::execute_array
0x0000 DBI::st::dump_results
0x0000 DBI::st::bind_param_array
0x0000 DBI::st::fetchrow_array
0x1040 DBI::st::execute
0x0000 DBI::st::bind_col
0x0000 DBI::st::fetchall_arrayref
0x0000 DBI::st::fetchrow_arrayref
0x0000 DBI::st::bind_param_inout
0x0000 DBI::st::bind_columns
0x0800 DBI::st::cancel
0x0000 DBI::st::blob_copy_to_file
0x0000 DBI::st::bind_param
0x0404 DBI::common::parse_trace_flag
0x0004 DBI::common::errstr
0x0004 DBI::common::trace_msg
0x0004 DBI::common::err
0x0004 DBI::common::CLEAR
0x0004 DBI::common::state
0x0000 DBI::common::_not_impl
0x0004 DBI::common::NEXTKEY
0x0004 DBI::common::trace
0x0004 DBI::common::debug
0x0404 DBI::common::parse_trace_flags
0x0000 DBI::common::private_attribute_info
0x0000 DBI::common::swap_inner_handle
0x0004 DBI::common::EXISTS
0x0404 DBI::common::FETCH
0x0004 DBI::common::FIRSTKEY
0x0010 DBI::common::set_err
0x10004 DBI::common::DESTROY
0x0004 DBI::common::dump_handle
0x0404 DBI::common::FETCH_many
0x0100 DBI::common::can
0x041c DBI::common::STORE
0x0004 DBI::common::private_data
0x0006 DBI::common::func
Try1 Correct
CreateMaint&#40;DBI::db=HASH&#40;0x3e72ac4&#41;,2010-01-01 00:00:00,datkins,2010-01-01 00:00:00,2010-01-01 00:10:00,A Comment1,maint
enance,blackout,Script :,myselftest&#41;
RowId 25576


Try2 NULL to fail
CreateMaint&#40;DBI::db=HASH&#40;0x3e72ac4&#41;,2010-01-01 00:00:00,datkins,,2010-01-01 00:10:00,A Comment2,maintenance,blackout,Scr
ipt :,myselftest&#41;
DBD::ODBC::st execute failed: [Microsoft][ODBC SQL Server Driver][SQL Server]Cannot insert the value NULL into column &#39;S
cheduled_Start_Date_Time&#39;, table &#39;System_Tools_DEV.dbo.T_Alarm_Maintenances&#39;; column does not allow nulls. INSERT fails.
 &#40;SQL-23000&#41;
[Microsoft][ODBC SQL Server Driver][SQL Server]The statement has been terminated. &#40;SQL-01000&#41;&#40;DBD: st_execute/SQLExecute
 err=-1&#41; at bug.pl line 57.
SQLexec: INSERT INTO T_Alarm_Maintenances &#40;Created_Date_Time, Created_By, Scheduled_Start_Date_Time, Scheduled_End_Date_
Time, Comment, Source, Component, Media, Media_data&#41;
VALUES &#40;?, ?, ?, ?, ?, ?, ?, ?, ?&#41;
;SELECT SCOPE_IDENTITY&#40;&#41;
Data:&#39;2010-01-01 00:00:00&#39;,&#39;datkins&#39;,&#39;&#39;,&#39;2010-01-01 00:10:00&#39;,&#39;A Comment2&#39;,&#39;maintenance&#39;,&#39;blackout&#39;,&#39;Script :&#39;,&#39;myselfte
st&#39;
Error: [Microsoft][ODBC SQL Server Driver][SQL Server]Cannot insert the value NULL into column &#39;Scheduled_Start_Date_Tim
e&#39;, table &#39;System_Tools_DEV.dbo.T_Alarm_Maintenances&#39;; column does not allow nulls. INSERT fails. &#40;SQL-23000&#41;
[Microsoft][ODBC SQL Server Driver][SQL Server]The statement has been terminated. &#40;SQL-01000&#41;&#40;DBD: st_execute/SQLExecute
 err=-1&#41; at bug.pl line 62.
RowId


Try3 Correct
CreateMaint&#40;DBI::db=HASH&#40;0x3e72ac4&#41;,2010-01-01 00:00:00,datkins,2010-01-01 00:00:00,2010-01-01 00:10:00,A Comment3,maint
enance,blackout,Script :,myselftest&#41;
---- It Stops, Control-C needed to break it ---
Terminating on signal SIGINT&#40;2&#41;

NOTICE: This e-mail may contain confidential information, which should not be copied or distributed without authorization.  If you have received this e-mail message by mistake, please inform the sender and delete it from your system.  Please note that, for the efficient preservation of Company records that may be required for litigation, e-mail messages sent to the author of this message will be copied and may be retained in a secure repository.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/868334/449703/prepare_cache.log">Download prepare_cache.log</a><br />
<span class="downloadcontenttype">application/octet-stream 36.4k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;14&nbsp;09:12:27&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Dec 13 19:50:37 2010, Damon.Atkins@contracted.pmintl.com wrote:
&lt;snipped some log output&gt;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Try1 Correct
&gt;    CreateMaint&#40;DBI::db=HASH&#40;0x3e72ac4&#41;,2010-01-01
&gt;    00:00:00,datkins,2010-01-01 00:00:00,2010-01-01 00:10:00,A
&gt;    Comment1,maint
&gt; enance,blackout,Script :,myselftest&#41;
&gt; RowId 25576
&gt;    Try2 NULL to fail
&gt; CreateMaint&#40;DBI::db=HASH&#40;0x3e72ac4&#41;,2010-01-01
&gt;    00:00:00,datkins,,2010-01-01 00:10:00,A
&gt;    Comment2,maintenance,blackout,Scr
&gt; ipt :,myselftest&#41;
&gt; DBD::ODBC::st
&gt;    execute failed: [Microsoft][ODBC SQL Server Driver][SQL
&gt;    Server]Cannot insert the value NULL into column &#39;S
&gt;    cheduled_Start_Date_Time&#39;, table
&gt;    &#39;System_Tools_DEV.dbo.T_Alarm_Maintenances&#39;; column does not allow
&gt;    nulls. INSERT fails.
&gt;  &#40;SQL-23000&#41;
&gt; [Microsoft][ODBC SQL Server
&gt;    Driver][SQL Server]The statement has been terminated. &#40;SQL-
&gt;    01000&#41;&#40;DBD: st_execute/SQLExecute
&gt;  err=-1&#41; at bug.pl line 57.
&gt;    SQLexec: INSERT INTO T_Alarm_Maintenances &#40;Created_Date_Time,
&gt;    Created_By, Scheduled_Start_Date_Time, Scheduled_End_Date_
&gt; Time,
&gt;    Comment, Source, Component, Media, Media_data&#41;
&gt; VALUES &#40;?, ?, ?, ?,
&gt;    ?, ?, ?, ?, ?&#41;
&gt; ;SELECT SCOPE_IDENTITY&#40;&#41;
</div>
I don&#39;t think DBI ever intended that you could prepare multiple
statements and cache them like this. If the first fails what should
happen with the second?

Just don&#39;t do this, set up a second prepare for the identity or create a
procedure which does the insert, obtains the identity and returns it.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Data:&#39;2010-01-01
&gt;    00:00:00&#39;,&#39;datkins&#39;,&#39;&#39;,&#39;2010-01-01 00:10:00&#39;,&#39;A
&gt;    Comment2&#39;,&#39;maintenance&#39;,&#39;blackout&#39;,&#39;Script :&#39;,&#39;myselfte
&gt; st&#39;
&gt;    Error: [Microsoft][ODBC SQL Server Driver][SQL Server]Cannot insert
&gt;    the value NULL into column &#39;Scheduled_Start_Date_Tim
&gt; e&#39;, table
&gt;    &#39;System_Tools_DEV.dbo.T_Alarm_Maintenances&#39;; column does not allow
&gt;    nulls. INSERT fails. &#40;SQL-23000&#41;
&gt; [Microsoft][ODBC SQL Server
&gt;    Driver][SQL Server]The statement has been terminated. &#40;SQL-
&gt;    01000&#41;&#40;DBD: st_execute/SQLExecute
&gt;  err=-1&#41; at bug.pl line 62.
&gt;    RowId
&gt; 
&gt; 
&gt; Try3 Correct
&gt; CreateMaint&#40;DBI::db=HASH&#40;0x3e72ac4&#41;,2010-
&gt;    01-01 00:00:00,datkins,2010-01-01 00:00:00,2010-01-01 00:10:00,A
&gt;    Comment3,maint
&gt; enance,blackout,Script :,myselftest&#41;
&gt; ---- It
&gt;    Stops, Control-C needed to break it ---
&gt; Terminating on signal
&gt;    SIGINT&#40;2&#41;
&gt; 
&gt; NOTICE: This e-mail may contain confidential
&gt;    information, which should not be copied or distributed without
&gt;    authorization.  If you have received this e-mail message by
&gt;    mistake, please inform the sender and delete it from your system.
&gt;    Please note that, for the efficient preservation of Company records
&gt;    that may be required for litigation, e-mail messages sent to the
&gt;    author of this message will be copied and may be retained in a
&gt;    secure repository.
</div>
Admittedly, it is more than unfortunate that your script hangs but this
is because the insert statement failed, SQL Server moved on to the
select identity and returned the value down the socket but you never
called odbc_more_results. You&#39;d need to do something like:

use DBI;
use strict;

sub doit
{
    my $dbh=shift @_;
    my $s = $dbh-&gt;prepare_cached&#40;q/insert into mje &#40;b&#41; values&#40;?&#41;;select
@@identity/&#41;;
    $s-&gt;execute&#40;@_&#41;;
    print &#34;sql errors $DBI::errstr\n&#34;;

    $s-&gt;{odbc_more_results};
    my $identity;
    &#40;$identity&#41; = $s-&gt;fetchrow_array;
    print &#34;identity = &#34;, DBI::neat&#40;$identity&#41;, &#34;\n&#34;;
    &#40;$identity&#41; = $s-&gt;fetchrow_array;

}


my $h = DBI-&gt;connect&#40;&#34;dbi:ODBC:mydsn&#34;, &#34;user&#34;, &#34;password&#34;,
{PrintError =&gt; 0}&#41; or die &#34;connect&#34;;

eval {$h-&gt;do&#40;q/drop table mje/&#41;;};

$h-&gt;do&#40;q/create table mje &#40;a int identity, b char&#40;10&#41; not null&#41;/&#41;;

doit&#40;$h,undef&#41;;
#doit&#40;$h,1, undef&#41;;
#doit&#40;$h,1,&#39;fred&#39;&#41;;
#doit&#40;$h,1, undef&#41;;
doit&#40;$h,&#39;fred&#39;&#41;;

my $r = $h-&gt;prepare&#40;q/select * from mje/&#41;;
$r-&gt;execute;
print DBI::dump_results&#40;$r&#41;;

But although that will probably stop the hang I doubt you&#39;ll get the
identity back with DBD::ODBC 1.13 which is over 6 years old now.

There is a small bug in the latest DBD::ODBC which I&#39;ll fix and then the
above example will work completely but I&#39;d strongly suggest you don&#39;t
prepare 2 statements in one go as you will eventually find a MS SQL
Server ODBC Driver this won&#39;t work on &#40;one which batches up the
statements for instance&#41;.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;16&nbsp;03:54:40&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 14 09:12:27 2010, MJEVANS wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; use DBI;
&gt; use strict;
&gt; 
&gt; sub doit
&gt; {
&gt;     my $dbh=shift @_;
&gt;     my $s = $dbh-&gt;prepare_cached&#40;q/insert into mje &#40;b&#41; values&#40;?&#41;;select
&gt; @@identity/&#41;;
&gt;     $s-&gt;execute&#40;@_&#41;;
&gt;     print &#34;sql errors $DBI::errstr\n&#34;;
&gt; 
&gt;     $s-&gt;{odbc_more_results};
&gt;     my $identity;
&gt;     &#40;$identity&#41; = $s-&gt;fetchrow_array;
&gt;     print &#34;identity = &#34;, DBI::neat&#40;$identity&#41;, &#34;\n&#34;;
&gt;     &#40;$identity&#41; = $s-&gt;fetchrow_array;
&gt; 
&gt; }
&gt; 
&gt; 
&gt; my $h = DBI-&gt;connect&#40;&#34;dbi:ODBC:mydsn&#34;, &#34;user&#34;, &#34;password&#34;,
&gt; {PrintError =&gt; 0}&#41; or die &#34;connect&#34;;
&gt; 
&gt; eval {$h-&gt;do&#40;q/drop table mje/&#41;;};
&gt; 
&gt; $h-&gt;do&#40;q/create table mje &#40;a int identity, b char&#40;10&#41; not null&#41;/&#41;;
&gt; 
&gt; doit&#40;$h,undef&#41;;
&gt; #doit&#40;$h,1, undef&#41;;
&gt; #doit&#40;$h,1,&#39;fred&#39;&#41;;
&gt; #doit&#40;$h,1, undef&#41;;
&gt; doit&#40;$h,&#39;fred&#39;&#41;;
&gt; 
&gt; my $r = $h-&gt;prepare&#40;q/select * from mje/&#41;;
&gt; $r-&gt;execute;
&gt; print DBI::dump_results&#40;$r&#41;;
&gt; 
&gt; But although that will probably stop the hang I doubt you&#39;ll get the
&gt; identity back with DBD::ODBC 1.13 which is over 6 years old now.
&gt; 
&gt; There is a small bug in the latest DBD::ODBC which I&#39;ll fix and then the
&gt; above example will work completely but I&#39;d strongly suggest you don&#39;t
&gt; prepare 2 statements in one go as you will eventually find a MS SQL
&gt; Server ODBC Driver this won&#39;t work on &#40;one which batches up the
&gt; statements for instance&#41;.
&gt; 
&gt; Martin
</div>
I have released 1.26_4 which fixed the small issue where
odbc_more_results might not set the Active flag on the statement handle
which could stop the retrieval of the $identity in the above example
from working.

Are you ok for me to right this off now?

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;16&nbsp;04:50:50&nbsp;2010</span>
    <span class="description">Damon.Atkins [...] contracted.pmintl.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #62033] prepared_cache invalid after error </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 16 Dec 2010 10:50:22 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBD-ODBC [...] rt.cpan.org&#34; &lt;bug-DBD-ODBC [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Atkins, Damon &#40;contracted&#41;&#34; &lt;Damon.Atkins [...] contracted.pmintl.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yes , And thanks


NOTICE: This e-mail may contain confidential information, which should not be copied or distributed without authorization.  If you have received this e-mail message by mistake, please inform the sender and delete it from your system.  Please note that, for the efficient preservation of Company records that may be required for litigation, e-mail messages sent to the author of this message will be copied and may be retained in a secure repository.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;16&nbsp;05:41:03&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;16&nbsp;05:41:04&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Fixed in 1.26_4 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
