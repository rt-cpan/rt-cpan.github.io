<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #122586 for Net-DNS: Persistent UDP reports false timeouts.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #122586 for Net-DNS: Persistent UDP reports false timeouts.</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-DNS/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-DNS">Net-DNS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">122586</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-DNS/Active/">Net-DNS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bbkr [...] post.pl

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22454-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.09    </td>
  </tr>
  <tr id="CF-22455-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;24&nbsp;11:34:57&nbsp;2017</span>
    <span class="description">bbkr [...] post.pl -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Persistent UDP reports false timeouts.</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Scenario. This is time dependent so I cannot provide code that will allow to reproduce it with 100% reliability:

    my $resolver = Net::DNS::Resolver-&gt;new&#40;
        &#39;udp_timeout&#39;    =&gt; 2,
        &#39;persistent_udp&#39; =&gt; 1,
        &#39;retrans&#39;        =&gt; 1,
        &#39;retry&#39;          =&gt; 1
    &#41;;

    $resolver-&gt;search&#40; &#39;a.com&#39;, &#39;MX&#39; &#41;;     # domain that triggers timeout
    $resolver-&gt;search&#40; &#39;b.com&#39;, &#39;MX&#39; &#41;;     # valid domain but gets error &#34;FAIL query timed out&#34;

From my code understanding:
1. request is sent to NS about a.com
2. timeout is triggered
3. request is sent to NS about b.com
4. NS socket is added to select 
5. NS socket has answer &#40;from domain a.com!!&#41;
6. NS socket is removed from select
7. response gets parsed by _decode_reply&#40;&#41;
8. it gets rejected because header IDs does not match
9 control goes back to can_read&#40;&#41;, but socket was removed from select in 6
10. socket read loop exits, no sockets to read from
11. domain b.com gets &#34;query timed out&#34; false error
12. true b.com answer is not read from socket and may cause exactly the same issue with next query

Fix: Maybe failed header ID &#40;in 8&#41; should put socket back to select monitoring pool when persistent UDP is enabled?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;24&nbsp;14:02:46&nbsp;2017</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jul 24 11:34:57 2017, bbkr@post.pl wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Scenario. This is time dependent so I cannot provide code that will
&gt; allow to reproduce it with 100% reliability:
</div>
We can not reproduce it with more than 0% reliability unless you provide an example complete with query and nameserver addresses.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;24&nbsp;14:02:47&nbsp;2017</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;24&nbsp;19:57:53&nbsp;2017</span>
    <span class="description">bbkr [...] post.pl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bbkr [...] post.pl</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Please run following script:

cat domains_test.txt | perl dns_test.pl

Test file contains tons of bad domains interleaved with &#39;gmail.com&#39;. You should quickly ran into following scenario:

=====================================================
gmail.com

;; search&#40; gmail.com MX &#41;

;; udp send [31.11.202.254]:53

;; answer from [31.11.202.254] 28 bytes
;; HEADER SECTION
;;      id = 41913
;;      qr = 1  aa = 0  tc = 0  rd = 1  opcode = QUERY
;;      ra = 1  z  = 0  ad = 0  cd = 0  rcode  = SERVFAIL
;;      qdcount = 1     ancount = 0     nscount = 0     arcount = 0
;;      do = 0

;; QUESTION SECTION &#40;1 record&#41;
;; 040307.com.  IN      MX

;; ANSWER SECTION &#40;0 records&#41;

;; AUTHORITY SECTION &#40;0 records&#41;

;; ADDITIONAL SECTION &#40;0 records&#41;


;; query timed out
=====================================================

So the question about gmail.com gets some answer from previous questions. Library rejects this message and has no more sockets to monitor, so it gives false &#34;query timed out&#34; result.

Tested on perl 5.24.1 + Net::DNS 1.09 and also on perl 5.24.2 + Net::DNS 1.11.

Please tell me if that was enough to reproduce issue on your side.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> domains_test.txt</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dns_test.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use v5.24;
use Net::DNS;
use Data::Dumper;

my $resolver = Net::DNS::Resolver-&gt;new&#40;
    &#39;nameservers&#39; =&gt; [&#39;31.11.202.254&#39;],
    &#39;udp_timeout&#39;    =&gt; 1,
    &#39;persistent_udp&#39; =&gt; 1,
    &#39;retrans&#39;        =&gt; 1,
    &#39;retry&#39;          =&gt; 1
&#41;;
$resolver-&gt;searchlist&#40;&#41;;
$resolver-&gt;{&#39;debug&#39;} = 1;

while &#40;&lt;&gt;&#41; {
    chomp;
    my $domain = $_;

    say &#34;=&#34; x 128;
    say $domain;

    $resolver-&gt;search&#40; $domain, &#39;MX&#39; &#41;;
    my $status = $resolver-&gt;errorstring;
    die if $domain eq &#39;gmail.com&#39; and $status =~ /query timed out/;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;25&nbsp;08:10:45&nbsp;2017</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jul 24 19:57:53 2017, bbkr@post.pl wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please run following script:
&gt; 
&gt; cat domains_test.txt | perl dns_test.pl
</div>
Thanks

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Tested on perl 5.24.1 + Net::DNS 1.09 and also on perl 5.24.2 +
&gt; Net::DNS 1.11.
</div>
Which answers the obvious question.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please tell me if that was enough to reproduce issue on your side.
</div>
Your script does time out, as you say; but I am not certain that I am seeing evidence of transactions getting mis-matched in the way you described.  UDP time out is not a rare occurrence, which is why all the retry logic is there.

Also, my result differs from yours:

 ra = 0               [1]
 rcode = REFUSED      [SERVFAIL]

so I am not confident that we really are both doing the same experiment.


gmail.com

 ;; search&#40; gmail.com MX &#41;

 ;; udp send [31.11.202.254]:53

 ;; answer from [31.11.202.254] 27 bytes
 ;; HEADER SECTION
 ;;     id = 60230
 ;;     qr = 1  aa = 0  tc = 0  rd = 1  opcode = QUERY
 ;;     ra = 0  z  = 0  ad = 0  cd = 0  rcode  = REFUSED
 ;;     qdcount = 1     ancount = 0     nscount = 0     arcount = 0
 ;;     do = 0

 ;; QUESTION SECTION &#40;1 record&#41;
 ;; gmail.com.  IN      MX

 ;; ANSWER SECTION &#40;0 records&#41;

 ;; AUTHORITY SECTION &#40;0 records&#41;

 ;; ADDITIONAL SECTION &#40;0 records&#41;


I will try to add some instrumentation inside Net::DNS to report ID mis-matches as they occur.

May take some time to get to the bottom of this!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;25&nbsp;09:36:46&nbsp;2017</span>
    <span class="description">bbkr [...] post.pl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bbkr [...] post.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Your script does time out, as you say; but I am not certain that I am
&gt; seeing evidence of transactions getting mis-matched in the way you
&gt; described.  UDP time out is not a rare occurrence, which is why all
&gt; the retry logic is there.
</div>
In my case I cannot reproduce request-response mismatch on Docker &#40;dunno why&#41;. But on macOS &#40;10.10.5&#41; + perlbrew or Linux &#40;debian Jessie&#41; + perlbrew it pops up usually within first minute of test script running against different nameservers maintained by ISPs in my country.

Can you try some NSes close to you or adjust timeout to 2s?

I know UDP timeouts may happen, however in this particular case that I&#39;ve pasted above this is fake error - there was no timeout on gmail.com - overdue message was consumed and socket monitoring ended prematurely.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;25&nbsp;11:10:52&nbsp;2017</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jul 25 09:36:46 2017, bbkr@post.pl wrote:
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Can you try some NSes close to you or adjust timeout to 2s?
</div>
Using my ISP&#39;s nameserver, script got through 90% of list before a timeout occurred.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I know UDP timeouts may happen, however in this particular case that
&gt; I&#39;ve pasted above this is fake error - there was no timeout on
&gt; gmail.com - overdue message was consumed and socket monitoring ended
&gt; prematurely.
</div>
Your script does not test for that condition, so we will need to devise a better test.

More immediately, we need to explain why I get ra = 0  and rcode = REFUSED whereas your earlier posting had ra = 1 and rcode = SERVFAIL.

I would like to see the result you get from:

 echo &#39;gmail.com&#39; | perl dns_test.pl
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;25&nbsp;13:01:17&nbsp;2017</span>
    <span class="description">bbkr [...] post.pl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bbkr [...] post.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I would like to see the result you get from:
&gt; 
&gt; echo &#39;gmail.com&#39; | perl dns_test.pl
</div>


;; search&#40; gmail.com MX &#41;

;; udp send [31.11.202.254]:53

;; answer from [31.11.202.254] 366 bytes
;; HEADER SECTION
;;      id = 21477
;;      qr = 1  aa = 0  tc = 0  rd = 1  opcode = QUERY
;;      ra = 1  z  = 0  ad = 0  cd = 0  rcode  = NOERROR
;;      qdcount = 1     ancount = 5     nscount = 4     arcount = 9
;;      do = 0

;; QUESTION SECTION &#40;1 record&#41;
;; gmail.com.   IN      MX

;; ANSWER SECTION &#40;5 records&#41;
gmail.com.      2004    IN      MX      20 alt2.gmail-smtp-in.l.google.com.
gmail.com.      2004    IN      MX      30 alt3.gmail-smtp-in.l.google.com.
gmail.com.      2004    IN      MX      5 gmail-smtp-in.l.google.com.
gmail.com.      2004    IN      MX      10 alt1.gmail-smtp-in.l.google.com.
gmail.com.      2004    IN      MX      40 alt4.gmail-smtp-in.l.google.com.

;; AUTHORITY SECTION &#40;4 records&#41;
gmail.com.      86384   IN      NS      ns4.google.com.
gmail.com.      86384   IN      NS      ns3.google.com.
gmail.com.      86384   IN      NS      ns2.google.com.
gmail.com.      86384   IN      NS      ns1.google.com.

;; ADDITIONAL SECTION &#40;9 records&#41;
alt3.gmail-smtp-in.l.google.com.        204     IN      A       74.125.30.26
gmail-smtp-in.l.google.com.     188     IN      A       173.194.222.26
alt1.gmail-smtp-in.l.google.com.        220     IN      A       74.125.23.26
alt4.gmail-smtp-in.l.google.com.        195     IN      A       64.233.182.27
alt2.gmail-smtp-in.l.google.com.        213     IN      A       74.125.28.27
ns2.google.com. 86384   IN      A       216.239.34.10
ns1.google.com. 86384   IN      A       216.239.32.10
ns3.google.com. 86384   IN      A       216.239.36.10
ns4.google.com. 86384   IN      A       216.239.38.10
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;25&nbsp;14:39:55&nbsp;2017</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jul 25 13:01:17 2017, bbkr@post.pl wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I would like to see the result you get from:
&gt; &gt; 
&gt; &gt; echo &#39;gmail.com&#39; | perl dns_test.pl
</div>&gt; 
&gt; 
&gt; 
&gt; ;; search&#40; gmail.com MX &#41;
&gt; 
&gt; ;; udp send [31.11.202.254]:53
&gt; 
&gt; ;; answer from [31.11.202.254] 366 bytes
&gt; ;; HEADER SECTION
&gt; ;;    id = 21477
&gt; ;;    qr = 1  aa = 0  tc = 0  rd = 1  opcode = QUERY
&gt; ;;    ra = 1  z  = 0  ad = 0  cd = 0  rcode  = NOERROR
</div>        ======

So I think you need to explain why this differs from my result above.

My instrumented version ran to completion without ID mismatch and without a timeout. Total of 61104 queries, all refused.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;25&nbsp;15:13:59&nbsp;2017</span>
    <span class="description">bbkr [...] post.pl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bbkr [...] post.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So I think you need to explain why this differs from my result above.
&gt; 
&gt; My instrumented version ran to completion without ID mismatch and
&gt; without a timeout. Total of 61104 queries, all refused.
</div>
Maybe NS hardcoded in test file blocks requests from outside of certain IP range? I&#39;m not administrating it so I cannot tell for sure.

As for test that you ran against your local NS, the one that timeouted on 90% - did you get request-response mismatch there?

I&#39;ll try to reproduce mismatch using Net::DNS::Nameserver to get more reliable test case.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;25&nbsp;15:38:47&nbsp;2017</span>
    <span class="description">bbkr [...] post.pl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bbkr [...] post.pl</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I was able to reproduce mismatch locally. On one console please run server and on second console new client:

cat domains_test.txt | perl dns_test2.pl


Request/response mismatch is reproducible with 100% rate on first pair of domains in my case:

=====================================================000gmail.com

;; search&#40; 000gmail.com A &#41;

;; udp send [127.0.0.1]:15353

;; query timed out
=====================================================gmail.com

;; search&#40; gmail.com A &#41;

;; udp send [127.0.0.1]:15353

;; answer from [127.0.0.1] 46 bytes
;; HEADER SECTION
;;      id = 155
;;      qr = 1  aa = 1  tc = 0  rd = 1  opcode = QUERY
;;      ra = 0  z  = 0  ad = 0  cd = 0  rcode  = NOERROR
;;      qdcount = 1     ancount = 1     nscount = 0     arcount = 0
;;      do = 0

;; QUESTION SECTION &#40;1 record&#41;
;; 000gmail.com.        IN      A

;; ANSWER SECTION &#40;1 record&#41;
000gmail.com.   3600    IN      A       1.1.1.1

;; AUTHORITY SECTION &#40;0 records&#41;

;; ADDITIONAL SECTION &#40;0 records&#41;


;; query timed out
=====================================================



So gmail.com gets response from 000gmail.com and claims false timeout.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dns_test2.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use v5.24;
use Net::DNS;
use Data::Dumper;

my $resolver = Net::DNS::Resolver-&gt;new&#40;
    &#39;nameservers&#39; =&gt; [&#39;127.0.0.1&#39;],
    &#39;udp_timeout&#39;    =&gt; 1,
    &#39;persistent_udp&#39; =&gt; 1,
    &#39;retrans&#39;        =&gt; 1,
    &#39;retry&#39;          =&gt; 1
&#41;;
$resolver-&gt;searchlist&#40;&#41;;
$resolver-&gt;port&#40;15353&#41;;
$resolver-&gt;{&#39;debug&#39;} = 1;

while &#40;&lt;&gt;&#41; {
    chomp;
    my $domain = $_;

    say &#34;=&#34; x 128;
    say $domain;

    $resolver-&gt;search&#40; $domain, &#39;A&#39; &#41;;
    my $status = $resolver-&gt;errorstring;
    die if $domain eq &#39;gmail.com&#39; and $status =~ /query timed out/;
}
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dns_server.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use v5.24;
use strict;
use warnings;

use Net::DNS::Nameserver;

my $nameserver = Net::DNS::Nameserver-&gt;new&#40;
    &#39;LocalAddr&#39;        =&gt; [ &#39;127.0.0.1&#39; ],
    &#39;LocalPort&#39;        =&gt; 15353,
    &#39;ReplyHandler&#39; =&gt; \&#38;reply_handler,
&#41; or die;

sub reply_handler {
    my &#40; $qname, $qclass, $qtype, $peerhost, $query, $conn &#41; = @_;
    my &#40; $rcode, @ans, @auth, @add &#41;;

    sleep 1 unless $qname eq &#39;gmail.com&#39;;
    
    my $rr = Net::DNS::RR-&gt;new&#40;&#34;$qname 3600 $qclass $qtype 1.1.1.1&#34;&#41;;

    return &#40; &#39;NOERROR&#39;, [ $rr ], [], [], { &#39;aa&#39; =&gt; 1 }, {} &#41;;
}

$nameserver-&gt;main_loop;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;25&nbsp;16:30:46&nbsp;2017</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jul 25 15:13:59 2017, bbkr@post.pl wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; As for test that you ran against your local NS, the one that timeouted
&gt; on 90% - did you get request-response mismatch there?
</div>
No, just timed out.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;25&nbsp;17:02:28&nbsp;2017</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jul 25 15:38:47 2017, bbkr@post.pl wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I was able to reproduce mismatch locally. On one console please run
&gt; server and on second console new client:
</div>
Thanks.

Now I have a repeatable example to work on.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;02&nbsp;08:58:18&nbsp;2017</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in Net::DNS 1.12
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;23&nbsp;05:12:00&nbsp;2017</span>
    <span class="description">NLNETLABS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Resolved in 1.12
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;23&nbsp;05:12:01&nbsp;2017</span>
    <span class="description">NLNETLABS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
