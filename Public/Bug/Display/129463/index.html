<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #129463 for IO-Socket-SSL: [PATCH] enable SSL_MODE_RELEASE_BUFFERS by default</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #129463 for IO-Socket-SSL: [PATCH] enable SSL_MODE_RELEASE_BUFFERS by default</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=IO-Socket-SSL">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=IO-Socket-SSL">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=IO-Socket-SSL">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=IO-Socket-SSL">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IO-Socket-SSL">IO-Socket-SSL CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">129463</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=IO-Socket-SSL">IO-Socket-SSL</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
e [...] 80x24.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-17228-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-17229-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




0001-enable-SSL_MODE_RELEASE_BUFFERS-by-default.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1847190/992631/0001-enable-SSL_MODE_RELEASE_BUFFERS-by-default.patch">
Sun May 05 17:33:50 2019 (1.7k) by e [...] 80x24.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=129463">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1847190" href="/Public/Bug/Display.html?id=129463#txn-1847190">#</a>      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;05&nbsp;17:33:50&nbsp;2019</span>
    <span class="description">e [...] 80x24.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] enable SSL_MODE_RELEASE_BUFFERS by default</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 5 May 2019 21:26:11 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-IO-Socket-SSL [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Wong &lt;e [...] 80x24.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1847190/992630/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/992630">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 293b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">SSL_CTX_set_mode&#40;3ssl&#41; manpage states this can save around 34k
per idle connection.

Contributed to OpenSSL by the Tor project, this feature has been
available since OpenSSL 1.0.0a and enabled by default in popular
projects such as: curl, nginx, Ruby, and &#40;of course&#41; tor.

Patch is attached.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1847190/992631/0001-enable-SSL_MODE_RELEASE_BUFFERS-by-default.patch">Download 0001-enable-SSL_MODE_RELEASE_BUFFERS-by-default.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1.7k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1847206" href="/Public/Bug/Display.html?id=129463#txn-1847206">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;06&nbsp;00:13:34&nbsp;2019</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1847206/992642/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/992642">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am So 05. Mai 2019, 17:33:50, e@80x24.org schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; SSL_CTX_set_mode&#40;3ssl&#41; manpage states this can save around 34k
&gt; per idle connection.
&gt; 
&gt; Contributed to OpenSSL by the Tor project, this feature has been
&gt; available since OpenSSL 1.0.0a and enabled by default in popular
&gt; projects such as: curl, nginx, Ruby, and &#40;of course&#41; tor.
&gt; 
&gt; Patch is attached.
</div>
Thanks for the patch - but I&#39;m not completely sure if I should apply it.
First, while Python has this too it comes with specific restrictions there of when to apply it, since some versions of OpenSSL had CVE in this area, see <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/python/cpython/blob/master/Modules/_ssl.c#L3072">https://github.com/python/cpython/blob/master/Modules/_ssl.c#L3072</a></span>

Also, if this would be completely free of side effects then why would this option not be enabled by default in OpenSSL? From my understanding of the code in OpenSSL this option should be useful only if nothing will be read/write for a long time but the SSL object is still allocated. If instead lots of reads and writes are done on the SSL object it will instead continously free memory and allocate new memory, which actually might slow down the application. This is especially true if memory management itself has a large overhead: on some systems unused memory is actually returned to the system which means that syscalls are involved which can slow down everything a lot.

Do you have any real-world experience which suggests that this option should be enabled by default even though OpenSSL has it disabled by default? And which describes the actual use cases where this option is useful and where it is harmful?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1847207" href="/Public/Bug/Display.html?id=129463#txn-1847207">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;06&nbsp;00:13:35&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1847231" href="/Public/Bug/Display.html?id=129463#txn-1847231">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;06&nbsp;03:12:57&nbsp;2019</span>
    <span class="description">e [...] 80x24.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> behroozi [...] www.pls.uni.edu</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #129463] [PATCH] enable SSL_MODE_RELEASE_BUFFERS by default</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 6 May 2019 07:12:48 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Steffen Ullrich via RT &lt;bug-IO-Socket-SSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Wong &lt;e [...] 80x24.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1847231/992657/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/992657">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Steffen Ullrich via RT &lt;bug-IO-Socket-SSL@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=129463">https://rt.cpan.org/Ticket/Display.html?id=129463</a></span> &gt;
&gt; 
&gt; Am So 05. Mai 2019, 17:33:50, e@80x24.org schrieb:
<div class="message-stanza open">&gt; &gt; SSL_CTX_set_mode&#40;3ssl&#41; manpage states this can save around 34k
&gt; &gt; per idle connection.
&gt; &gt; 
&gt; &gt; Contributed to OpenSSL by the Tor project, this feature has been
&gt; &gt; available since OpenSSL 1.0.0a and enabled by default in popular
&gt; &gt; projects such as: curl, nginx, Ruby, and &#40;of course&#41; tor.
&gt; &gt; 
&gt; &gt; Patch is attached.
</div></div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for the patch - but I&#39;m not completely sure if I should
&gt; apply it.  First, while Python has this too it comes with
&gt; specific restrictions there of when to apply it, since some
&gt; versions of OpenSSL had CVE in this area, see
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/python/cpython/blob/master/Modules/_ssl.c#L3072">https://github.com/python/cpython/blob/master/Modules/_ssl.c#L3072</a></span>
</div>
Thanks for the quick response.

Interesting, I wasn&#39;t aware of CVE-2014-0198 specifically
&#40;too many OpenSSL CVEs to keep track of&#41;, but it seemed to only
affect SSLv3 on ancient OpenSSL versions.  I figure those
users have bigger problems and would&#39;ve fallen over by now,
and not keeping IO::Socket::SSL up-to-date :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Also, if this would be completely free of side effects then
&gt; why would this option not be enabled by default in OpenSSL?
</div>
Good question, I would guess inertia.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; From my understanding of the code in OpenSSL this option
&gt; should be useful only if nothing will be read/write for a long
&gt; time but the SSL object is still allocated. If instead lots of
&gt; reads and writes are done on the SSL object it will instead
&gt; continously free memory and allocate new memory, which
&gt; actually might slow down the application. This is especially
&gt; true if memory management itself has a large overhead: on some
&gt; systems unused memory is actually returned to the system which
&gt; means that syscalls are involved which can slow down
&gt; everything a lot.
</div>
In my experience, traffic and throughput on a single socket is
rarely &#40;if ever&#41; significant in terms of CPU usage.  Various
malloc implementations have also improved in throughput over the
years; and they tend to avoid making syscalls to release memory
to the kernel.

So, having memory idle for a &#34;long time&#34; could be milliseconds,
even, which is an eternity for buffers to sit idle.

What adds up is memory usage from multiple sockets, and being
able to reuse idle memory across different sockets means better
overall locality and fewer calls to mmap/brk to request memory
from the kernel.

Perhaps that memory reuse can increase the chance of a data leak
if there&#39;s other bugs in the code; but it may also reduce that
chance as data is frequently clobbered and not sitting idle in
buffers.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Do you have any real-world experience which suggests that this
&gt; option should be enabled by default even though OpenSSL has it
&gt; disabled by default? And which describes the actual use cases
&gt; where this option is useful and where it is harmful?
</div>
I&#39;ve used nginx for TLS for many years; and now run another C10K
server, yahns &#40;which I wrote in Ruby&#41; on my own sites.  I may
replace yahns with another C10K HTTPS/NNTP+TLS server I write in
Perl5.

I&#39;ve yet to encounter a point on a public HTTPS server where TLS
traffic from a single socket caused performance problems.  Maybe
it can happen in extremely high bandwidth situations and giant
files, but that&#39;s not most TLS users.

I&#39;m not sure why OpenSSL does not enable it by default, probably
an abundance of caution since it was &#34;new&#34; at some point.  But
it is enabled on security-sensitive projects, such as Tor, which
also has many concurrent connections to manage.


Along the same lines, I&#39;m glad you enabled
SSL_MODE_ACCEPT_MOVING_WRITE_BUFFER by default.  Ruby didn&#39;t
enable it until I added it, so I had to resort to a nasty
workaround in yahns.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1853547" href="/Public/Bug/Display.html?id=129463#txn-1853547">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;24&nbsp;15:20:19&nbsp;2019</span>
    <span class="description">e [...] 80x24.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> behroozi [...] www.pls.uni.edu</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #129463] [PATCH] enable SSL_MODE_RELEASE_BUFFERS by default</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 24 Jun 2019 19:13:59 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Steffen Ullrich via RT &lt;bug-IO-Socket-SSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Wong &lt;e [...] 80x24.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1853547/995862/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/995862">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 565b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Steffen Ullrich via RT &lt;bug-IO-Socket-SSL@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=129463">https://rt.cpan.org/Ticket/Display.html?id=129463</a></span> &gt;
</div>
Btw, is reaching into $foo-&gt;{context} of a IO::Socket::SSL::SSL_Context
ref something that we can expect to remain supported?

I&#39;m currently doing that to enable SSL_MODE_RELEASE_BUFFERS in
public-inbox-nntpd:

   <span class="clickylink"><a target="new" rel="nofollow" href="https://public-inbox.org/meta/20190624025258.25592-44-e@80x24.org/">https://public-inbox.org/meta/20190624025258.25592-44-e@80x24.org/</a></span>

The 346MB =&gt; 171MB reduction with 10K clients is a significant savings
&#40;but 171MB is still too much for my liking&#41;.

Anyways, thanks for all your work on this!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1879404" href="/Public/Bug/Display.html?id=129463#txn-1879404">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;15&nbsp;03:56:13&nbsp;2020</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1879404/1008495/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1008495">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Mo 24. Jun 2019, 15:20:19, e@80x24.org schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Steffen Ullrich via RT &lt;bug-IO-Socket-SSL@rt.cpan.org&gt; wrote:
<div class="message-stanza open">&gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=129463">https://rt.cpan.org/Ticket/Display.html?id=129463</a></span> &gt;
</div>&gt; 
&gt; Btw, is reaching into $foo-&gt;{context} of a IO::Socket::SSL::SSL_Context
&gt; ref something that we can expect to remain supported?
&gt; 
&gt; I&#39;m currently doing that to enable SSL_MODE_RELEASE_BUFFERS in
&gt; public-inbox-nntpd:
&gt; 
&gt;    <span class="clickylink"><a target="new" rel="nofollow" href="https://public-inbox.org/meta/20190624025258.25592-44-e@80x24.org/">https://public-inbox.org/meta/20190624025258.25592-44-e@80x24.org/</a></span>
&gt; 
&gt; The 346MB =&gt; 171MB reduction with 10K clients is a significant savings
&gt; &#40;but 171MB is still too much for my liking&#41;.
&gt; 
&gt; Anyways, thanks for all your work on this!
</div>
I&#39;ve enabled now easy support to set this option by using SSL_mode_release_buffers on the context, see <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/noxxi/p5-io-socket-ssl/commit/47ad659a706ec19a966f2f62fb64f6493d6d1741">https://github.com/noxxi/p5-io-socket-ssl/commit/47ad659a706ec19a966f2f62fb64f6493d6d1741</a></span>

I did not enable this option by default though since I&#39;m due to a lack of actual performance measurements still not convinced that enabling it makes universally sense. The documentation states that the saving is only for idle connections and from the code it can be seen that if this option is enabled it will need to reallocate and initialize a new read buffer on each call to SSL_read.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1879407" href="/Public/Bug/Display.html?id=129463#txn-1879407">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;15&nbsp;03:56:14&nbsp;2020</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1879409" href="/Public/Bug/Display.html?id=129463#txn-1879409">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;15&nbsp;04:27:03&nbsp;2020</span>
    <span class="description">e [...] 80x24.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> behroozi [...] www.pls.uni.edu</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #129463] [PATCH] enable SSL_MODE_RELEASE_BUFFERS by default</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 15 Jan 2020 09:26:52 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Steffen Ullrich via RT &lt;bug-IO-Socket-SSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Wong &lt;e [...] 80x24.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1879409/1008499/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1008499">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Steffen Ullrich via RT &lt;bug-IO-Socket-SSL@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=129463">https://rt.cpan.org/Ticket/Display.html?id=129463</a></span> &gt;
&gt; 
&gt; Am Mo 24. Jun 2019, 15:20:19, e@80x24.org schrieb:
<div class="message-stanza open">&gt; &gt; Steffen Ullrich via RT &lt;bug-IO-Socket-SSL@rt.cpan.org&gt; wrote:
<div class="message-stanza open">&gt; &gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=129463">https://rt.cpan.org/Ticket/Display.html?id=129463</a></span> &gt;
</div>&gt; &gt; 
&gt; &gt; Btw, is reaching into $foo-&gt;{context} of a IO::Socket::SSL::SSL_Context
&gt; &gt; ref something that we can expect to remain supported?
&gt; &gt; 
&gt; &gt; I&#39;m currently doing that to enable SSL_MODE_RELEASE_BUFFERS in
&gt; &gt; public-inbox-nntpd:
&gt; &gt; 
&gt; &gt;    <span class="clickylink"><a target="new" rel="nofollow" href="https://public-inbox.org/meta/20190624025258.25592-44-e@80x24.org/">https://public-inbox.org/meta/20190624025258.25592-44-e@80x24.org/</a></span>
&gt; &gt; 
&gt; &gt; The 346MB =&gt; 171MB reduction with 10K clients is a significant savings
&gt; &gt; &#40;but 171MB is still too much for my liking&#41;.
&gt; &gt; 
&gt; &gt; Anyways, thanks for all your work on this!
</div></div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve enabled now easy support to set this option by using
&gt; SSL_mode_release_buffers on the context, see
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/noxxi/p5-io-socket-ssl/commit/47ad659a706ec19a966f2f62fb64f6493d6d1741">https://github.com/noxxi/p5-io-socket-ssl/commit/47ad659a706ec19a966f2f62fb64f6493d6d1741</a></span>
</div>
Thanks, seems like a good compromise.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I did not enable this option by default though since I&#39;m due
&gt; to a lack of actual performance measurements still not
&gt; convinced that enabling it makes universally sense. The
&gt; documentation states that the saving is only for idle
&gt; connections and from the code it can be seen that if this
&gt; option is enabled it will need to reallocate and initialize a
&gt; new read buffer on each call to SSL_read.
</div>
Fair enough.  My main concern is memory usage.  For few/single
connections that are always hot, I do expect realising buffers
to be slower.

However, I expect real-world HTTPS, NNTPS, IMAPS connections to
be mostly idle because of persistent connections &#40;driven by TLS
negotiation time&#41; and any overhead of malloc/free to be
inconsequential compared to having to thrash swap as a result of
high memory use.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.293874</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
