<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #50654 for JSON-XS: JSON::XS incorrectly serialized numeric values as strings</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #50654 for JSON-XS: JSON::XS incorrectly serialized numeric values as strings</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=JSON-XS">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=JSON-XS">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=JSON-XS">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=JSON-XS">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/JSON-XS">JSON-XS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">50654</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">deleted</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=JSON-XS">JSON-XS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ilya [...] iponweb.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
JRED [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-42890-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-42891-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




JSON-XS-2.26-fix-stringify.patch.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/681275/350754/JSON-XS-2.26-fix-stringify.patch.txt">
Fri Oct 23 16:53:01 2009 (2.6k) by JRED [...] cpan.org
</a>
</font></li>
</ul>


JSON-XS-2.26-fix-stringify.patch2.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/681311/350777/JSON-XS-2.26-fix-stringify.patch2.txt">
Fri Oct 23 17:31:54 2009 (2.9k) by JRED [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=50654">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-679320" href="/Public/Bug/Display.html?id=50654#txn-679320">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;19&nbsp;11:40:27&nbsp;2009</span>
    <span class="description">ilya [...] iponweb.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> JSON::XS incorrectly serialized numeric values as strings</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 19 Oct 2009 19:40:02 +0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-JSON-XS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Martynov &lt;ilya [...] iponweb.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/679320/349653/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/349653">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 625b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The following simple test script

use JSON::XS;

$x = 10000;
print encode_json&#40;[$x]&#41;, &#34;\n&#34;;
&#34;$x&#34;;
print encode_json&#40;[$x]&#41;, &#34;\n&#34;;

prints

[10000]
[&#34;10000&#34;]

I.e. JSON::XS treats $x as containing string value after it was used once in
string context. My XS-foo is rusty but I think the code in encode_sv in
XS.xs should evalute conditions for SvPOKp &#40;sv&#41; and SvIOKp &#40;sv&#41; / SvNOK &#40;sv&#41;
in different order. SV can contain both string and numeric parts what means
that value is originally numeric but was used once in string context
&#40;exactly like in the test code above&#41;.

-- 
Ilya Martynov, ilya@iponweb.net
CTO IPonWEB &#40;UK&#41; Ltd
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/679320/349654/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/349654">with headers</a>
<br />
<span class="downloadcontenttype">text/html 767b</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-679359" href="/Public/Bug/Display.html?id=50654#txn-679359">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;19&nbsp;13:38:50&nbsp;2009</span>
    <span class="description">schmorp [...] schmorp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #50654] JSON::XS incorrectly serialized numeric values as strings</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 19 Oct 2009 19:38:32 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Ilya Martynov via RT &lt;bug-JSON-XS [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marc Lehmann &lt;schmorp [...] schmorp.de&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/679359/349676/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/349676">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi!

You sent a possible bug report on or via rt.cpan.org. Please read this
mail carefully if you want to be heard.

Most likely, your report will be ignored.

Please close the ticket again and sent it to the official contact address
for the module in question &#40;or send it to rt.cpan.org@schmorp.de&#41;.

Why is this necessary?

rt.cpan.org has many deficiencies which makes it tedious and hard to use,
increasing the workload on the people who provide all the perl modules you
probably appreciate &#40;and that is really to be avoided - module authors
should be able to invest all their time into improving their modules and
not fighting with rt.cpan.org&#39;s bugs&#41;.

Still, for some people, rt.cpan.org is useful to have, and some people
even like it and really want to use it. That is fine, too.

Unfortunately, the designers of rt.cpan.org didn&#39;t make their &#34;service&#34;
optional - you can neither opt-in nor opt-out of rt.cpan.org as a module
author.

Just like a spammer, rt.cpan.org forces its &#34;service&#34; &#40;whether wanted
or unwanted&#41; on everybody. Just like a spammer, they don&#39;t care for the
people they actively hurt. Just like a spammer, they don&#39;t don&#39;t care to
fix these issues and make their &#34;service&#34; ethically acceptable.

You cannot even configure it to redirect tickets to somewhere else.

Unfortunately, ignoring rt.cpan.org is not an option either: for people
reporting possible bugs there is no indication that their report will be
ignored, and for module authors it means they miss possibly vital bug
reports &#40;and of course it&#39;s a great impression if rt.cpan.org has lots of
bug reports that are unanswered, making a module unmaintained when in fact
the opposite might be true&#41;.

This is why it is important that you delete/resolve your ticket.

I am sorry that this wasted a bit of your time, but please understand that
I am just as much a victim as you are - the problem is the unethical stance
of the rt.cpan.org providers who force their &#34;service&#34; on everybody.

Please redirect your bug report as stated in the beginning of this mail,
and please consider petitioning the rt.cpan.org providers to stop their
unethical behaviour and allow opt-in, opt-out, or some redirect option.

Thanks a lot,
Marc Lehmann &lt;rt.cpan.org@schmorp.de&gt;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-679360" href="/Public/Bug/Display.html?id=50654#txn-679360">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;19&nbsp;13:38:51&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-681275" href="/Public/Bug/Display.html?id=50654#txn-681275">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;23&nbsp;16:53:00&nbsp;2009</span>
    <span class="description">JRED [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> jred [...] cpan.org</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/681275/350751/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/350751">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 754b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I encountered exactly this problems a few days ago and after some
private discussion with the author I decided to find a solution for this
problem.

I was about posting my bug report here and found yours, so I attach my
patch to this bug.

It&#39;s indeed that easy: checking SvIOKp before doing the other checks was
the solution.

See the attached patch - it includes a new test for the patch. As well
none of the existent tests fail with my patch.

There is still a side effect, but this time no numbers are suddenly
stringified. Instead strings become numbers once they were used in
numeric context. I think that&#39;s way better than the current integer
stringification. As well turning them back into a string is as simple as
putting them in double quotes.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/681275/350754/JSON-XS-2.26-fix-stringify.patch.txt">Download JSON-XS-2.26-fix-stringify.patch.txt</a><br />
<span class="downloadcontenttype">text/plain 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -urN JSON-XS-2.26/t/22_stringify.t JSON-XS-2.26.patched/t/22_stringify.t
--- JSON-XS-2.26/t/22_stringify.t	1970-01-01 01:00:00.000000000 +0100
+++ JSON-XS-2.26.patched/t/22_stringify.t	2009-10-23 22:35:44.000000000 +0200
@@ -0,0 +1,38 @@
+BEGIN { $| = 1; print &#34;1..8\n&#34;; }
+
+use utf8;
+use JSON::XS;
+
+our $test;
+sub ok&#40;$&#41; {
+   print $_[0] ? &#34;&#34; : &#34;not &#34;, &#34;ok &#34;, ++$test, &#34;\n&#34;;
+}
+
+#-- A number is a number
+my $number = 42;
+ok&#40;&#39;[42]&#39;   eq encode_json&#40;[$number]&#41;&#41;;
+
+#-- Let&#39;s stringify it
+my $stringify1 = &#34;$number&#34;;
+ok&#40;&#39;[&#34;42&#34;]&#39; eq encode_json&#40;[$stringify1]&#41;&#41;;
+
+#-- But it&#39;s still a number!
+ok&#40;&#39;[42]&#39;   eq encode_json&#40;[$number]&#41;&#41;;
+
+#-- Just the same, but stringify by concatenation &#40;makes no difference&#41;
+my $stringify2 = $number.&#34;&#34;;
+ok&#40;&#39;[&#34;42&#34;]&#39; eq encode_json&#40;[$stringify2]&#41;&#41;;
+ok&#40;&#39;[42]&#39;   eq encode_json&#40;[$number]&#41;&#41;;
+
+#-- Turning a string into a number
+my $string2number = $stringify1 + 0;
+
+#-- works so far, but...
+ok&#40;&#39;[42]&#39;   eq encode_json&#40;[$string2number]&#41;&#41;;
+
+#-- ... turns the original string into a number as well
+#-- &#40;better this side effect than suddenly stringifying numbers!&#41;
+ok&#40;&#39;[42]&#39;   eq encode_json&#40;[$stringify1]&#41;&#41;;
+
+#-- you have to explicitly stringify it if you still want a string
+ok&#40;&#39;[&#34;42&#34;]&#39;   eq encode_json&#40;[&#34;$stringify1&#34;]&#41;&#41;;
diff -urN JSON-XS-2.26/XS.xs JSON-XS-2.26.patched/XS.xs
--- JSON-XS-2.26/XS.xs	2009-10-10 03:30:04.000000000 +0200
+++ JSON-XS-2.26.patched/XS.xs	2009-10-23 22:25:06.000000000 +0200
@@ -675,22 +675,7 @@
 {
   SvGETMAGIC &#40;sv&#41;;
 
-  if &#40;SvPOKp &#40;sv&#41;&#41;
-    {
-      STRLEN len;
-      char *str = SvPV &#40;sv, len&#41;;
-      encode_ch &#40;enc, &#39;&#34;&#39;&#41;;
-      encode_str &#40;enc, str, len, SvUTF8 &#40;sv&#41;&#41;;
-      encode_ch &#40;enc, &#39;&#34;&#39;&#41;;
-    }
-  else if &#40;SvNOKp &#40;sv&#41;&#41;
-    {
-      // trust that perl will do the right thing w.r.t. JSON syntax.
-      need &#40;enc, NV_DIG + 32&#41;;
-      Gconvert &#40;SvNVX &#40;sv&#41;, NV_DIG, 0, enc-&gt;cur&#41;;
-      enc-&gt;cur += strlen &#40;enc-&gt;cur&#41;;
-    }
-  else if &#40;SvIOKp &#40;sv&#41;&#41;
+  if &#40;SvIOKp &#40;sv&#41;&#41;
     {
       // we assume we can always read an IV as a UV and vice versa
       // we assume two&#39;s complement
@@ -734,6 +719,21 @@
                 : snprintf &#40;enc-&gt;cur, IVUV_MAXCHARS, &#34;%&#34;IVdf, &#40;IV&#41;SvIVX &#40;sv&#41;&#41;;
         }
     }
+  else if &#40;SvPOKp &#40;sv&#41;&#41;
+    {
+      STRLEN len;
+      char *str = SvPV &#40;sv, len&#41;;
+      encode_ch &#40;enc, &#39;&#34;&#39;&#41;;
+      encode_str &#40;enc, str, len, SvUTF8 &#40;sv&#41;&#41;;
+      encode_ch &#40;enc, &#39;&#34;&#39;&#41;;
+    }
+  else if &#40;SvNOKp &#40;sv&#41;&#41;
+    {
+      // trust that perl will do the right thing w.r.t. JSON syntax.
+      need &#40;enc, NV_DIG + 32&#41;;
+      Gconvert &#40;SvNVX &#40;sv&#41;, NV_DIG, 0, enc-&gt;cur&#41;;
+      enc-&gt;cur += strlen &#40;enc-&gt;cur&#41;;
+    }
   else if &#40;SvROK &#40;sv&#41;&#41;
     encode_rv &#40;enc, SvRV &#40;sv&#41;&#41;;
   else if &#40;!SvOK &#40;sv&#41; || enc-&gt;json.flags &#38; F_ALLOW_UNKNOWN&#41;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-681278" href="/Public/Bug/Display.html?id=50654#txn-681278">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;23&nbsp;16:54:50&nbsp;2009</span>
    <span class="description">JRED [...] cpan.org -  Cc JRED added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-681307" href="/Public/Bug/Display.html?id=50654#txn-681307">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;23&nbsp;17:22:02&nbsp;2009</span>
    <span class="description">schmorp [...] schmorp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #50654] JSON::XS incorrectly serialized numeric values as strings</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 23 Oct 2009 23:21:45 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> JRED via RT &lt;bug-JSON-XS [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marc Lehmann &lt;schmorp [...] schmorp.de&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/681307/350770/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/350770">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi!

You sent a possible bug report on or via rt.cpan.org. Please read this
mail carefully if you want to be heard.

Most likely, your report will be ignored.

Please close the ticket again and sent it to the official contact address
for the module in question &#40;or send it to rt.cpan.org@schmorp.de&#41;.

Why is this necessary?

rt.cpan.org has many deficiencies which makes it tedious and hard to use,
increasing the workload on the people who provide all the perl modules you
probably appreciate &#40;and that is really to be avoided - module authors
should be able to invest all their time into improving their modules and
not fighting with rt.cpan.org&#39;s bugs&#41;.

Still, for some people, rt.cpan.org is useful to have, and some people
even like it and really want to use it. That is fine, too.

Unfortunately, the designers of rt.cpan.org didn&#39;t make their &#34;service&#34;
optional - you can neither opt-in nor opt-out of rt.cpan.org as a module
author.

Just like a spammer, rt.cpan.org forces its &#34;service&#34; &#40;whether wanted
or unwanted&#41; on everybody. Just like a spammer, they don&#39;t care for the
people they actively hurt. Just like a spammer, they don&#39;t don&#39;t care to
fix these issues and make their &#34;service&#34; ethically acceptable.

You cannot even configure it to redirect tickers to somewhere else.

Unfortunately, ignoring rt.cpan.org is not an option either: for people
reporting possible bugs there is no indication that their report will be
ignored, and for module authors it means they miss possibly vital bug
reports &#40;and of course it&#39;s a great impression if rt.cpan.org has lots of
bug reports that are unanswered, making a module unmaintained when in fact
the opposite might be true&#41;.

This is why it is important that you delete your ticket again.

I am sorry that this wasted a bit of your time, but please understand that
I am just as much a victim as you are - the problem is the unethical stance
of the rt.cpan.org providers who force their &#34;service&#34; on everybody.

Please redirect your bug report as stated in the beginning of this mail,
and please consider petitioning the rt.cpan.org providers to stop their
unethical behaviour and allow opt-in, opt-out, or some redirect option.

Thanks a lot,
Marc Lehmann &lt;rt.cpan.org@schmorp.de&gt;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-681310" href="/Public/Bug/Display.html?id=50654#txn-681310">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;23&nbsp;17:22:22&nbsp;2009</span>
    <span class="description">MLEHMANN [...] cpan.org -  Ticket deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-681311" href="/Public/Bug/Display.html?id=50654#txn-681311">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;23&nbsp;17:31:54&nbsp;2009</span>
    <span class="description">JRED [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/681311/350774/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/350774">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 329b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fr. 23. Okt. 2009, 16:53:00, JRED wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It&#39;s indeed that easy: checking SvIOKp before doing the other checks was
&gt; the solution.
</div>
Of course it was not enough to move the integer test only, because
floats still were suddenly stringified. Sorry for shooting too quickly ;&#41;

Attached a new patch which covers floats as well.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/681311/350777/JSON-XS-2.26-fix-stringify.patch2.txt">Download JSON-XS-2.26-fix-stringify.patch2.txt</a><br />
<span class="downloadcontenttype">text/plain 2.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -urN JSON-XS-2.26/t/22_stringify.t JSON-XS-2.26.patched/t/22_stringify.t
--- JSON-XS-2.26/t/22_stringify.t	1970-01-01 01:00:00.000000000 +0100
+++ JSON-XS-2.26.patched/t/22_stringify.t	2009-10-23 23:26:50.000000000 +0200
@@ -0,0 +1,46 @@
+BEGIN { $| = 1; print &#34;1..11\n&#34;; }
+
+use utf8;
+use JSON::XS;
+
+our $test;
+sub ok&#40;$&#41; {
+   print $_[0] ? &#34;&#34; : &#34;not &#34;, &#34;ok &#34;, ++$test, &#34;\n&#34;;
+}
+
+#-- A number is a number
+my $number = 42;
+ok&#40;&#39;[42]&#39;   eq encode_json&#40;[$number]&#41;&#41;;
+
+#-- Let&#39;s stringify it
+my $stringify1 = &#34;$number&#34;;
+ok&#40;&#39;[&#34;42&#34;]&#39; eq encode_json&#40;[$stringify1]&#41;&#41;;
+
+#-- But it&#39;s still a number!
+ok&#40;&#39;[42]&#39;   eq encode_json&#40;[$number]&#41;&#41;;
+
+#-- Just the same, but stringify by concatenation &#40;makes no difference&#41;
+my $stringify2 = $number.&#34;&#34;;
+ok&#40;&#39;[&#34;42&#34;]&#39; eq encode_json&#40;[$stringify2]&#41;&#41;;
+ok&#40;&#39;[42]&#39;   eq encode_json&#40;[$number]&#41;&#41;;
+
+#-- Turning a string into a number
+my $string2number = $stringify1 + 0;
+
+#-- works so far, but...
+ok&#40;&#39;[42]&#39;   eq encode_json&#40;[$string2number]&#41;&#41;;
+
+#-- ... turns the original string into a number as well
+#-- &#40;better this side effect than suddenly stringifying numbers!&#41;
+ok&#40;&#39;[42]&#39;   eq encode_json&#40;[$stringify1]&#41;&#41;;
+
+#-- you have to explicitly stringify it if you still want a string
+ok&#40;&#39;[&#34;42&#34;]&#39;   eq encode_json&#40;[&#34;$stringify1&#34;]&#41;&#41;;
+
+#-- now test that floats don&#39;t get the stringify side effect as well
+my $float = 1.42;
+ok&#40;&#39;[1.42]&#39;   eq encode_json&#40;[$float]&#41;&#41;;
+
+my $stringf = &#34;$float&#34;;
+ok&#40;&#39;[&#34;1.42&#34;]&#39;   eq encode_json&#40;[$stringf]&#41;&#41;;
+ok&#40;&#39;[1.42]&#39;     eq encode_json&#40;[$float]&#41;&#41;;
diff -urN JSON-XS-2.26/XS.xs JSON-XS-2.26.patched/XS.xs
--- JSON-XS-2.26/XS.xs	2009-10-10 03:30:04.000000000 +0200
+++ JSON-XS-2.26.patched/XS.xs	2009-10-23 23:27:12.000000000 +0200
@@ -675,22 +675,7 @@
 {
   SvGETMAGIC &#40;sv&#41;;
 
-  if &#40;SvPOKp &#40;sv&#41;&#41;
-    {
-      STRLEN len;
-      char *str = SvPV &#40;sv, len&#41;;
-      encode_ch &#40;enc, &#39;&#34;&#39;&#41;;
-      encode_str &#40;enc, str, len, SvUTF8 &#40;sv&#41;&#41;;
-      encode_ch &#40;enc, &#39;&#34;&#39;&#41;;
-    }
-  else if &#40;SvNOKp &#40;sv&#41;&#41;
-    {
-      // trust that perl will do the right thing w.r.t. JSON syntax.
-      need &#40;enc, NV_DIG + 32&#41;;
-      Gconvert &#40;SvNVX &#40;sv&#41;, NV_DIG, 0, enc-&gt;cur&#41;;
-      enc-&gt;cur += strlen &#40;enc-&gt;cur&#41;;
-    }
-  else if &#40;SvIOKp &#40;sv&#41;&#41;
+  if &#40;SvIOKp &#40;sv&#41;&#41;
     {
       // we assume we can always read an IV as a UV and vice versa
       // we assume two&#39;s complement
@@ -734,6 +719,21 @@
                 : snprintf &#40;enc-&gt;cur, IVUV_MAXCHARS, &#34;%&#34;IVdf, &#40;IV&#41;SvIVX &#40;sv&#41;&#41;;
         }
     }
+  else if &#40;SvNOKp &#40;sv&#41;&#41;
+    {
+      // trust that perl will do the right thing w.r.t. JSON syntax.
+      need &#40;enc, NV_DIG + 32&#41;;
+      Gconvert &#40;SvNVX &#40;sv&#41;, NV_DIG, 0, enc-&gt;cur&#41;;
+      enc-&gt;cur += strlen &#40;enc-&gt;cur&#41;;
+    }
+  else if &#40;SvPOKp &#40;sv&#41;&#41;
+    {
+      STRLEN len;
+      char *str = SvPV &#40;sv, len&#41;;
+      encode_ch &#40;enc, &#39;&#34;&#39;&#41;;
+      encode_str &#40;enc, str, len, SvUTF8 &#40;sv&#41;&#41;;
+      encode_ch &#40;enc, &#39;&#34;&#39;&#41;;
+    }
   else if &#40;SvROK &#40;sv&#41;&#41;
     encode_rv &#40;enc, SvRV &#40;sv&#41;&#41;;
   else if &#40;!SvOK &#40;sv&#41; || enc-&gt;json.flags &#38; F_ALLOW_UNKNOWN&#41;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-681312" href="/Public/Bug/Display.html?id=50654#txn-681312">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;23&nbsp;17:31:55&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;deleted&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-681317" href="/Public/Bug/Display.html?id=50654#txn-681317">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;23&nbsp;17:44:02&nbsp;2009</span>
    <span class="description">MLEHMANN [...] cpan.org -  Ticket deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.531695</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
