<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #60313 for XML-LibXSLT: Input callbacks registered twice</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #60313 for XML-LibXSLT: Input callbacks registered twice</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/XML-LibXSLT/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/XML-LibXSLT/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/XML-LibXSLT/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/XML-LibXSLT/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-LibXSLT">XML-LibXSLT CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">60313</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/XML-LibXSLT/Active/">XML-LibXSLT</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
NWELLNHOF [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-37372-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-37373-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.89    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;13&nbsp;14:27:01&nbsp;2010</span>
    <span class="description">NWELLNHOF [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Input callbacks registered twice</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">XML::LibXSLT registers input callbacks a second time after XML::LibXML
already registered them. So the match callback is called a twice if it
returns false. Attached is a patch with a fix and a test case.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> double-callback.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/LibXSLT.pm b/LibXSLT.pm
index de5b1d4..945b42d 100644
--- a/LibXSLT.pm
+++ b/LibXSLT.pm
@@ -227,7 +227,6 @@ sub _init_callbacks{
         $icb-&gt;register_callbacks&#40; [$mcb, $ocb, $rcb, $ccb] &#41;;
     }
 
-    $self-&gt;lib_init_callbacks&#40;&#41;;
     $icb-&gt;init_callbacks&#40;&#41;;
 }
 
@@ -431,7 +430,6 @@ sub _init_callbacks {
     if &#40; defined $mcb and defined $ocb and defined $rcb and defined $ccb &#41; {
         $icb-&gt;register_callbacks&#40; [$mcb, $ocb, $rcb, $ccb] &#41;;
     }
-    $self-&gt;XML::LibXSLT::lib_init_callbacks&#40;&#41;;
     $icb-&gt;init_callbacks&#40;&#41;;
 
     my $scb = $self-&gt;{XML_LIBXSLT_SECPREFS};
diff --git a/LibXSLT.xs b/LibXSLT.xs
index d79b83a..460af03 100644
--- a/LibXSLT.xs
+++ b/LibXSLT.xs
@@ -447,186 +447,6 @@ FINISH:
 
 
 int
-LibXSLT_input_match&#40;char const * filename&#41;
-{
-    int results;
-    int count;
-    SV * res;
-
-    results = 0;
-
-    {
-        dTHX;
-        dSP;
-
-        ENTER;
-        SAVETMPS;
-
-        PUSHMARK&#40;SP&#41;;
-        EXTEND&#40;SP, 1&#41;;
-        PUSHs&#40;sv_2mortal&#40;newSVpv&#40;&#40;char*&#41;filename, 0&#41;&#41;&#41;;
-        PUTBACK;
-
-        count = call_pv&#40;&#34;XML::LibXML::InputCallback::_callback_match&#34;, 
-                             G_SCALAR | G_EVAL&#41;;
-
-        SPAGAIN;
-
-        if &#40;count != 1&#41; {
-            croak&#40;&#34;match callback must return a single value&#34;&#41;;
-        }
-
-        if &#40;SvTRUE&#40;ERRSV&#41;&#41; {
-            &#40;void&#41; POPs ;
-            croak&#40;&#34;input match callback died: %s&#34;, SvPV_nolen&#40;ERRSV&#41;&#41;;
-        }
-
-        res = POPs;
-
-        if &#40;SvTRUE&#40;res&#41;&#41; {
-            results = 1;
-        }
-
-        PUTBACK;
-        FREETMPS;
-        LEAVE;
-    }
-    return results;
-}
-
-void *
-LibXSLT_input_open&#40;char const * filename&#41;
-{
-    SV * results;
-    int count;
-
-    dTHX;
-    dSP;
-
-    ENTER;
-    SAVETMPS;
-
-    PUSHMARK&#40;SP&#41;;
-    EXTEND&#40;SP, 1&#41;;
-    PUSHs&#40;sv_2mortal&#40;newSVpv&#40;&#40;char*&#41;filename, 0&#41;&#41;&#41;;
-    PUTBACK;
-
-    count = call_pv&#40;&#34;XML::LibXML::InputCallback::_callback_open&#34;, 
-                              G_SCALAR | G_EVAL&#41;;
-
-    SPAGAIN;
-
-    if &#40;count != 1&#41; {
-        croak&#40;&#34;open callback must return a single value&#34;&#41;;
-    }
-
-    if &#40;SvTRUE&#40;ERRSV&#41;&#41; {
-        &#40;void&#41; POPs ;
-        croak&#40;&#34;input callback died: %s&#34;, SvPV_nolen&#40;ERRSV&#41;&#41;;
-    }
-
-    results = POPs;
-
-    SvREFCNT_inc&#40;results&#41;;
-
-    PUTBACK;
-    FREETMPS;
-    LEAVE;
-
-    return &#40;void *&#41;results;
-}
-
-int
-LibXSLT_input_read&#40;void * context, char * buffer, int len&#41;
-{
-    STRLEN res_len;
-    const char * output;
-    SV * ctxt;
-
-    res_len = 0;
-    ctxt = &#40;SV *&#41;context;
-
-    {
-        int count;
-
-        dTHX;
-        dSP;
-
-        ENTER;
-        SAVETMPS;
-
-        PUSHMARK&#40;SP&#41;;
-        EXTEND&#40;SP, 2&#41;;
-        PUSHs&#40;ctxt&#41;;
-        PUSHs&#40;sv_2mortal&#40;newSViv&#40;len&#41;&#41;&#41;;
-        PUTBACK;
-
-        count = call_pv&#40;&#34;XML::LibXML::InputCallback::_callback_read&#34;, 
-                             G_SCALAR | G_EVAL&#41;;
-
-        SPAGAIN;
-
-        if &#40;count != 1&#41; {
-            croak&#40;&#34;read callback must return a single value&#34;&#41;;
-        }
-
-        if &#40;SvTRUE&#40;ERRSV&#41;&#41; {
-            &#40;void&#41; POPs ;
-            croak&#40;&#34;read callback died: %s&#34;, SvPV_nolen&#40;ERRSV&#41;&#41;;
-        }
-
-        output = POPp;
-        if &#40;output != NULL&#41; {
-            res_len = strlen&#40;output&#41;;
-            if &#40;res_len&#41; {
-                strncpy&#40;buffer, output, res_len&#41;;
-            }
-            else {
-                buffer[0] = 0;
-            }
-        }
-
-	PUTBACK;
-        FREETMPS;
-        LEAVE;
-    }
-    return res_len;
-}
-
-void
-LibXSLT_input_close&#40;void * context&#41;
-{
-    SV * ctxt;
-
-    ctxt = &#40;SV *&#41;context;
-
-    {
-        dTHX;
-        dSP;
-
-        ENTER;
-        SAVETMPS;
-
-        PUSHMARK&#40;SP&#41;;
-        EXTEND&#40;SP, 1&#41;;
-        PUSHs&#40;ctxt&#41;;
-        PUTBACK;
-
-        call_pv&#40;&#34;XML::LibXML::InputCallback::_callback_close&#34;, 
-                             G_SCALAR | G_EVAL | G_DISCARD&#41;;
-
-        SvREFCNT_dec&#40;ctxt&#41;;
-
-        if &#40;SvTRUE&#40;ERRSV&#41;&#41; {
-            croak&#40;&#34;close callback died: %s&#34;, SvPV_nolen&#40;ERRSV&#41;&#41;;
-        }
-
-        FREETMPS;
-        LEAVE;
-    }
-}
-
-int
 LibXSLT_security_check&#40;xsltSecurityOption option,
                        xsltSecurityPrefsPtr sec,
                        xsltTransformContextPtr ctxt,
@@ -934,24 +754,6 @@ _parse_stylesheet_file&#40;self, filename&#41;
         RETVAL
 
 void
-lib_init_callbacks&#40; self &#41;
-        SV * self
-    CODE:
-        PERL_UNUSED_VAR&#40;self&#41;;
-        xmlRegisterInputCallbacks&#40;&#40;xmlInputMatchCallback&#41; LibXSLT_input_match,
-                                  &#40;xmlInputOpenCallback&#41; LibXSLT_input_open,
-                                  &#40;xmlInputReadCallback&#41; LibXSLT_input_read,
-                                  &#40;xmlInputCloseCallback&#41; LibXSLT_input_close&#41;;
-
-void
-lib_cleanup_callbacks&#40; self &#41;
-        SV * self
-    CODE:
-        PERL_UNUSED_VAR&#40;self&#41;;
-        xmlCleanupInputCallbacks&#40;&#41;;
-        xmlRegisterDefaultInputCallbacks&#40;&#41;;
-
-void
 INIT_THREAD_SUPPORT&#40;&#41;
     CODE:
        if &#40;x_PROXY_NODE_REGISTRY_MUTEX != NULL&#41; {
diff --git a/t/03input.t b/t/03input.t
index 4664ebe..d972730 100644
--- a/t/03input.t
+++ b/t/03input.t
@@ -1,5 +1,5 @@
 use Test;
-BEGIN { plan tests =&gt; 25 }
+BEGIN { plan tests =&gt; 26 }
 use XML::LibXSLT;
 use XML::LibXML 1.59;
 
@@ -29,6 +29,7 @@ my $stylsheetstring = &lt;&lt;&#39;EOT&#39;;
 &lt;body&gt;
   &lt;h1&gt;&lt;xsl:apply-templates/&gt;&lt;/h1&gt;
   &lt;p&gt;foo: &lt;xsl:apply-templates select=&#34;document&#40;&#39;foo.xml&#39;&#41;/*&#34; /&gt;&lt;/p&gt;
+  &lt;p&gt;foo: &lt;xsl:apply-templates select=&#34;document&#40;&#39;example/1.xml&#39;&#41;/foo&#34; /&gt;&lt;/p&gt;
 &lt;/body&gt;
 &lt;/html&gt;
 &lt;/xsl:template&gt;
@@ -44,7 +45,9 @@ $icb-&gt;register_callbacks&#40; [ \&#38;match_cb, \&#38;open_cb,
                             \&#38;read_cb, \&#38;close_cb ] &#41;;
 
 $xslt-&gt;input_callbacks&#40;$icb&#41;;
-                
+
+our $no_match_count = 0;
+
 my $stylesheet = $xslt-&gt;parse_stylesheet&#40;$parser-&gt;parse_string&#40;$stylsheetstring&#41;&#41;;
 print &#34;# stylesheet\n&#34;;
 ok&#40;$stylesheet&#41;;
@@ -61,6 +64,9 @@ my $output = $stylesheet-&gt;output_string&#40;$results&#41;;
 print &#34;# output\n&#34;;
 ok&#40;$output&#41;;
 
+print &#34;# no match count\n&#34;;
+ok&#40;$no_match_count == 1&#41;;
+
 # test a dying close callback
 # callbacks can only be registered as a callback group
 $stylesheet-&gt;match_callback&#40; \&#38;match_cb &#41;;
@@ -172,6 +178,7 @@ sub match_cb {
         ok&#40;1&#41;;
         return 1;
     }
+    ++$no_match_count if $uri eq &#34;example/1.xml&#34;;
     return 0;
 }
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;22&nbsp;09:10:44&nbsp;2014</span>
    <span class="description">NWELLNHOF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in 1.89.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;22&nbsp;09:10:45&nbsp;2014</span>
    <span class="description">NWELLNHOF [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;22&nbsp;09:10:46&nbsp;2014</span>
    <span class="description">NWELLNHOF [...] cpan.org -  Fixed in 1.89 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
