<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #77677 for Win32-API: x64 asm is broken for ::API, &gt;4 param crash</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #77677 for Win32-API: x64 asm is broken for ::API, &gt;4 param crash</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Win32-API/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Win32-API/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Win32-API/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Win32-API/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Win32-API">Win32-API CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">77677</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Win32-API/Active/">Win32-API</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">BULKDD [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bulk88 [...] hotmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-35436-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.68    </td>
  </tr>
  <tr id="CF-35437-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.70_01    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;06&nbsp;19:35:56&nbsp;2012</span>
    <span class="description">bulk88&#40;1&#41; [...] hotmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> x64 asm is broken for ::API, &gt;4 param crash</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">If there are over 4 parameters on x64 with GCC, there is a crash.
Remember every function on x64 has 4 parameters without exception. RSI
and R10 is filled with garbage with the 2 POPs at the end. The stack
pusher loop is broken. RSI in Call_asm is the retval struct pointer on
-O2 &#40;strawberry perl&#39;s default&#41;. On -O0 it doesn&#39;t crash, IDK and don&#39;t
care why.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">________________________

.globl Call_x64_real
Call_x64_real:

        pushq   %rbp
        movq    %rsp,%rbp
        subq    $32,%rsp        # keep space for 4 64bit params

ADD 32 to RSP A FIXED AMOUNT

        # Store register parameters 
        movq    %rcx,16&#40;%rbp&#41;   # ApiFunction
        movq    %rdx,24&#40;%rbp&#41;   # int_registers
        movq    %r8,32&#40;%rbp&#41;    # float_registers
        movq    %r9,40&#40;%rbp&#41;    # stack

        # Save regs we are gonna use
        pushq   %rsi
ADD 8 to RSP A FIXED AMOUNT
        pushq   %r10
ADD 8 to RSP A FIXED AMOUNT

        # Load up integer registers first... 
        movq    24&#40;%rbp&#41;,%rax   # rax = int_registers
        movq    &#40;%rax&#41;,%rcx
        movq    8&#40;%rax&#41;,%rdx
        movq    16&#40;%rax&#41;,%r8
        movq    24&#40;%rax&#41;,%r9

        # Now floating-point registers 
        movq    32&#40;%rbp&#41;,%rax   # rax = float_registers
        movsd   &#40;%rax&#41;,%xmm0
        movsd   8&#40;%rax&#41;,%xmm1
        movsd   16&#40;%rax&#41;,%xmm2
        movsd   24&#40;%rax&#41;,%xmm3

        # Now the stack 
        movq    40&#40;%rbp&#41;,%rsi   # rsi = stack
        movq    48&#40;%rbp&#41;,%rax   # rax = nstack
NSTACK IS NUMBER OF STACK PARAMS
FROM Call_asm
        required_stack = nparams &gt; 4 ? nparams - 4 : 0;
NSTACK IS required_stack IN THE CALLER Call_asm
END COMMENT

        # Except not if there isn&#39;t any 
        testq   %rax,%rax
        je      docall

copystack:
        subq    $1,%rax
        movq    &#40;%rsi,%rax,8&#41;,%r10
        pushq   %r10
ADD MANY 8s TO RSP THIS IS A LOOP VARIABLE AMOUNT
        testq   %rax,%rax
        jne     copystack

docall:
        # And call
        movq    16&#40;%rbp&#41;,%r10   # r10 = ApiFunction
        subq    $32,%rsp        # Microsoft x64 calling convention - allocate 32 bytes of
&#34;shadow space&#34; on the stack

ADD 32 TO RSP, A FIXED AMOUNT

        callq   *%r10
        addq    $32,%rsp        # restore stack

REMOVE 32 FROM RSP, A FIXED AMOUNT

        # Store return value
        movq    56&#40;%rbp&#41;,%r10   # r10 = iret
        movq    %rax,&#40;%r10&#41;
        movq    64&#40;%rbp&#41;,%r10   # r10 = dret
        movsd   %xmm0,&#40;%r10&#41;
 
        # Restore regs
        popq    %r10
REMOVE 8 FROM RSP, A FIXED AMOUNT
        popq    %rsi
REMOVE 8 FROM RSP, A FIXED AMOUNT
        movq    %rbp,%rsp
        popq    %rbp
        retq
<div class="message-stanza open">____________________________________________
This bug is in the public 0.68, and my personal API versions
&#40;0.69/0.70&#41;. Its only on x64 and on GCC Perl. I&#39;ll investigate whether
the same bug is in MSVC x64 side.
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;06&nbsp;21:16:33&nbsp;2012</span>
    <span class="description">bulk88&#40;1&#41; [...] hotmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bulk88&#40;1&#41; [...] hotmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">____________________________________
void Call_asm&#40;FARPROC ApiFunction, APIPARAM *params, int nparams,
APIPARAM *retval, BOOL c_call&#41;
{
        
        struct _CONTEXT cxt;
        struct _CONTEXT cxt2;
        size_t nRegisters = 0, nStack = 0;
        size_t required_registers = 0, required_stack = 0;
<div class="message-stanza open">_____________________________________
        RtlCaptureContext&#40;&#38;cxt&#41;;
        Call_x64_real&#40;ApiFunction, int_registers, float_registers, stack,
required_stack, &#38;iret, &#38;dret&#41;;
        RtlCaptureContext&#40;&#38;cxt2&#41;;
        if&#40;cxt.Rsi != cxt2.Rsi&#41; {printf&#40;&#34;bad RSI\n&#34;&#41;;  printf&#40;&#34;%d \n&#34;, *&#40;int*&#41;0&#41;;}
<div class="message-stanza open">_____________________________________
I got a &#34;bad RSI&#34; on Strawberry and VC Perl. Both are broken over 4 params.
</div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;06&nbsp;21:16:36&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;06&nbsp;21:48:53&nbsp;2012</span>
    <span class="description">bulk88&#40;1&#41; [...] hotmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bulk88&#40;1&#41; [...] hotmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">There are 2 separate problems here. MSVC doesn&#39;t save RSI, but it causes
no ill effects since MSVC &#40;atleast my 2008&#41; will not use nonvolatile
registers &#40;and therefore use more stack memory&#41; no matter what the -O
flag or LTCG setting. Ask MS about that one. The GCC code saves RSI and
restores it, and GCC uses RSI alot unlike MSVC, but if the stack
prototype has more than 4 args, the copystack loop runs and &#34;corrupts&#34;
RSP and then later when the POPs happen they POP garbage into RSI and
R10 &#40;why R10 is saved, its volatile, and not a fastcall register, IDK&#41;,
RSP isn&#39;t the same when the PUSHes were done. Since MSVC code doesn&#39;t
ever call POP and uses 100% RBP addressing, the RSP position is
irrelevant but RSI is still not restored.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;16&nbsp;22:07:10&nbsp;2012</span>
    <span class="description">BULKDD [...] cpan.org -  Fixed in 0.70_01 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;19&nbsp;00:44:33&nbsp;2012</span>
    <span class="description">BULKDD [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;19&nbsp;00:44:48&nbsp;2012</span>
    <span class="description">BULKDD [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;19&nbsp;21:17:09&nbsp;2012</span>
    <span class="description">BULKDD [...] cpan.org -  Reference by ticket #55660 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
