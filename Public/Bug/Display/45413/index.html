<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #45413 for IPC-Exe: A chain of trivial scripts is stuck under Win2k, works under Linux</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #45413 for IPC-Exe: A chain of trivial scripts is stuck under Win2k, works under Linux</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/IPC-Exe/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/IPC-Exe/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/IPC-Exe/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/IPC-Exe/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IPC-Exe">IPC-Exe CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">45413</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/IPC-Exe/Active/">IPC-Exe</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">glai [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
sergstesh [...] yahoo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-227002-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.005    </td>
  </tr>
  <tr id="CF-227003-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.006    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;24&nbsp;23:50:13&nbsp;2009</span>
    <span class="description">sergstesh [...] yahoo.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> A chain of trivial scripts is stuck under Win2k, works under Linux</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have created a main program &#40;see the attached &#39;try_ipc_win2k_bug.pl&#39;
file&#41; which call three other scripts &#40;see the attached &#39;left.pl&#39;,
&#39;center.pl&#39;, &#39;right.pl&#39;&#41;.

In order to run the suite the following needs to be done:

1&#41; choose whatever work directory;
2&#41; cd to the above directory;
3&#41; download all the above file into current directory;
2&#41; run

perl -w try_ipc_win2k_bug.pl
.

Output under Linux looks like this, and it is expected:

&#34;
&#40;0&#41; $$=26808 at /mnt/sdb8/sergei/QEMU/portable_perl/try_ipc_win2k_bug.pl
line 9.
&#40;1&#41; $$=26809 at /mnt/sdb8/sergei/QEMU/portable_perl/try_ipc_win2k_bug.pl
line 18.
left.pl: STTDERR: @ARGV=1 at left.pl line 5.
&#40;4&#41; $$=26808 at /mnt/sdb8/sergei/QEMU/portable_perl/try_ipc_win2k_bug.pl
line 39.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">last_pipe&gt; /home/sergei/PERL-5.10.0/bin/perl -w right.pl
</div>left.pl: STTDERR: @ARGV=2 at left.pl line 5.
+++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
STDOUT: @ARGV=1 $rand=0343142
+++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
STDOUT: @ARGV=2 $rand=0198413
left.pl: STTDERR: @ARGV=3 at left.pl line 5.
+++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
STDOUT: @ARGV=3 $rand=0557620
left.pl: STTDERR: @ARGV=4 at left.pl line 5.
+++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
STDOUT: @ARGV=4 $rand=0564594
left.pl: STTDERR: @ARGV=5 at left.pl line 5.
+++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
STDOUT: @ARGV=5 $rand=0665700
left.pl: STTDERR: @ARGV=6 at left.pl line 5.
+++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
STDOUT: @ARGV=6 $rand=0371080
left.pl: STTDERR: @ARGV=7 at left.pl line 5.
+++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
STDOUT: @ARGV=7 $rand=0327316
left.pl: STTDERR: @ARGV=8 at left.pl line 5.
+++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
STDOUT: @ARGV=8 $rand=0668209
left.pl: STTDERR: @ARGV=9 at left.pl line 5.
+++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
STDOUT: @ARGV=9 $rand=0049729
left.pl: STTDERR: @ARGV=10 at left.pl line 5.
+++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
STDOUT: @ARGV=10 $rand=0781647
@pids=26809 26811 26812 0 at
/mnt/sdb8/sergei/QEMU/portable_perl/try_ipc_win2k_bug.pl line 62,
&lt;STDIN&gt; line 10.
&#34;.

When I run the same setup under Windows 2000 &#40;under QEMU to be exact&#41;,
the command line and its screen output is like this:

&#34;
C:\perl_plus_player&gt;C:\Perl\bin\perl.exe -w try_ipc_win2k_bug.pl
&#40;0&#41; $$=580 at try_ipc_win2k_bug.pl line 9.
&#40;1&#41; $$=-860 at try_ipc_win2k_bug.pl line 18.
left.pl: STTDERR: @ARGV=1 at left.pl line 5.
left.pl: STTDERR: @ARGV=2 at left.pl line 5.
left.pl: STTDERR: @ARGV=3 at left.pl line 5.
left.pl: STTDERR: @ARGV=4 at left.pl line 5.
left.pl: STTDERR: @ARGV=5 at left.pl line 5.
left.pl: STTDERR: @ARGV=6 at left.pl line 5.
left.pl: STTDERR: @ARGV=7 at left.pl line 5.
left.pl: STTDERR: @ARGV=8 at left.pl line 5.
&#34;,

after that the script is stuck.

Actually, the script is not always stuck. If in &#39;try_ipc_win2k_bug.pl&#39;
file one changes this line:

     19        for my $ctr&#40;1 .. 10&#41;

to become

       for my $ctr&#40;1 .. 2&#41;

, the script works:

&#34;
C:\perl_plus_player&gt;C:\Perl\bin\perl.exe -w try_ipc_win2k_bug.pl
&#40;0&#41; $$=1024 at try_ipc_win2k_bug.pl line 9.
&#40;1&#41; $$=-968 at try_ipc_win2k_bug.pl line 18.
left.pl: STTDERR: @ARGV=1 at left.pl line 5.
left.pl: STTDERR: @ARGV=2 at left.pl line 5.
&#40;4&#41; $$=1024 at try_ipc_win2k_bug.pl line 39.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">last_pipe&gt; C:\Perl\bin\perl.exe -w right.pl
</div>+++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
STDOUT: @ARGV=1 $rand=0089996
+++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
STDOUT: @ARGV=2 $rand=0420715
@pids=-968 -692 -704 0 at try_ipc_win2k_bug.pl line 62, &lt;STDIN&gt; line 2.

C:\perl_plus_player&gt;
&#34;.

What else ? I&#39;ve noticed that under Win2k if Perl &#39;system&#40;&#34;dir&#34;&#41;;&#39; is
called inside a thread, the whole thing gets stuck - I do not have a
ready code example at hand.

Also, the following bug reports:

<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.activestate.com/show_bug.cgi?id=82846">http://bugs.activestate.com/show_bug.cgi?id=82846</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.activestate.com/show_bug.cgi?id=82870">http://bugs.activestate.com/show_bug.cgi?id=82870</a></span>

might be related.

The failure occurs under the latest ActiveState perl-5.10.0; according
to my tries with other Perl modules and scripts of mine under win2k the
flakiness doesn&#39;t really depend on Perl distro - say, Strawberry Perl is
equally good/bad.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> right.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/home/sergei/PERL-5.10.0/bin/perl -w

$| = 1;

use strict;

while&#40;defined&#40;my $line = &lt;STDIN&gt;&#41;&#41;
  {
  print &#34;+++processed by right.pl+++: $line&#34;
  }

exit&#40;0&#41;;
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> left.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/home/sergei/PERL-5.10.0/bin/perl -w

use strict;

warn &#34;left.pl: STTDERR: \@ARGV=@ARGV&#34;;

my $rand = sprintf&#40;&#39;%07u&#39;, int&#40;rand&#40;1000000&#41;&#41;&#41;;
print STDOUT &#34;left.pl: STDOUT: \@ARGV=@ARGV \$rand=$rand\n&#34;;

exit&#40;0&#41;;
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> try_ipc_win2k_bug.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/home/sergei/PERL-5.10.0/bin/perl -w

use IPC::Exe qw&#40;exe bg&#41;;

use strict;

$| = 1;

warn &#34;&#40;0&#41; \$\$=$$&#34;;
my $program = &#39;/bin/ls&#39;;
my @pids =
  &#38;{
   exe
     &#40;
     sub
       {
       $| = 1;
       warn &#34;&#40;1&#41; \$\$=$$&#34;;
       for my $ctr&#40;1 .. 10&#41;
         {
         #print STDOUT &#34;$ctr\n&#34;;
         &#38;{exe $^X, &#39;-w&#39;, &#39;left.pl&#39;, $ctr};
         }
       },

     # &#39;perl&#39; receives STDOUT of $program via STDIN
     exe
       &#40;
       $^X, &#39;-w&#39;, &#39;center.pl&#39;,

       exe
         &#40;
         $^X, &#39;-w&#39;, &#39;right.pl&#39;,       

         exe
           &#40;
           sub
             {
             warn &#34;&#40;4&#41; \$\$=$$&#34;;
             # find out command of previous pipe process
             # if @_ is empty list, previous process was a [perlsub]
             my &#40;$prog, @args&#41; = @_;

             print STDERR &#34;last_pipe&gt; $prog @args\n&#34;; # output: &#34;last_pipe&gt; sort -n&#34;

             # print sorted, &#39;perl&#39; filtered, output of $program
             print while &lt;STDIN&gt;;

             # find out exit value of previous &#39;sort&#39; pipe process
             close&#40;$IPC::Exe::PIPE&#41;;
             warn&#40;&#34;Bad exit for: @_\n&#34;&#41; if $?;

             return $?;
             },
           &#41;
         &#41;
       &#41;
     &#41;
   };


warn &#34;\@pids=@pids&#34;

</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> center.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/home/sergei/PERL-5.10.0/bin/perl -w

$| = 1;

use strict;

while&#40;defined&#40;my $line = &lt;STDIN&gt;&#41;&#41;
  {
  print &#34;&lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: $line&#34;;
  }

exit&#40;0&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;26&nbsp;14:54:17&nbsp;2009</span>
    <span class="description">glai [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;26&nbsp;15:14:54&nbsp;2009</span>
    <span class="description">glai [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you so much for exercising IPC::Exe, Sergei. I have been able to
reproduce the exact problem of what you&#39;re seeing on my side.

I think I understand the problem now. It comes down to fundamentals of
pipes. You see, writing and reading from a pipe causes blocking. Since
we only have threads in Windows, once it blocks, it blocks forever.
IPC::Exe exists in the thread and needs to carry on. What this means is
you cannot have a writer and a reader in the same thread &#40;unless you can
poll the reader/writer continuously&#41;. This greatly reduces what &#38;PREEXEC
can do.

The cleanest solution is to have the pipe writer and reader in two
separate processes. Since IPC::Exe takes care of pipe readers in the
current process, you have to exec the pipe writer into another process.
That means, if you want a &#38;PREEXEC like your example below, you have to
exec a &#39;perl&#39; process that does the same thing, from scratch.

You have given me a lot to think about, and have helped me expose many
bugs. The next release IPC::Exe 1.006 will be a MAJOR update.

Thanks again.
--
Gerald

On Fri Apr 24 23:50:13 2009, sergstesh wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have created a main program &#40;see the attached &#39;try_ipc_win2k_bug.pl&#39;
&gt; file&#41; which call three other scripts &#40;see the attached &#39;left.pl&#39;,
&gt; &#39;center.pl&#39;, &#39;right.pl&#39;&#41;.
&gt; 
&gt; In order to run the suite the following needs to be done:
&gt; 
&gt; 1&#41; choose whatever work directory;
&gt; 2&#41; cd to the above directory;
&gt; 3&#41; download all the above file into current directory;
&gt; 2&#41; run
&gt; 
&gt; perl -w try_ipc_win2k_bug.pl
&gt; .
&gt; 
&gt; Output under Linux looks like this, and it is expected:
&gt; 
&gt; &#34;
&gt; &#40;0&#41; $$=26808 at /mnt/sdb8/sergei/QEMU/portable_perl/try_ipc_win2k_bug.pl
&gt; line 9.
&gt; &#40;1&#41; $$=26809 at /mnt/sdb8/sergei/QEMU/portable_perl/try_ipc_win2k_bug.pl
&gt; line 18.
&gt; left.pl: STTDERR: @ARGV=1 at left.pl line 5.
&gt; &#40;4&#41; $$=26808 at /mnt/sdb8/sergei/QEMU/portable_perl/try_ipc_win2k_bug.pl
&gt; line 39.
<div class="message-stanza open">&gt; last_pipe&gt; /home/sergei/PERL-5.10.0/bin/perl -w right.pl
</div>&gt; left.pl: STTDERR: @ARGV=2 at left.pl line 5.
&gt; +++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
&gt; STDOUT: @ARGV=1 $rand=0343142
&gt; +++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
&gt; STDOUT: @ARGV=2 $rand=0198413
&gt; left.pl: STTDERR: @ARGV=3 at left.pl line 5.
&gt; +++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
&gt; STDOUT: @ARGV=3 $rand=0557620
&gt; left.pl: STTDERR: @ARGV=4 at left.pl line 5.
&gt; +++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
&gt; STDOUT: @ARGV=4 $rand=0564594
&gt; left.pl: STTDERR: @ARGV=5 at left.pl line 5.
&gt; +++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
&gt; STDOUT: @ARGV=5 $rand=0665700
&gt; left.pl: STTDERR: @ARGV=6 at left.pl line 5.
&gt; +++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
&gt; STDOUT: @ARGV=6 $rand=0371080
&gt; left.pl: STTDERR: @ARGV=7 at left.pl line 5.
&gt; +++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
&gt; STDOUT: @ARGV=7 $rand=0327316
&gt; left.pl: STTDERR: @ARGV=8 at left.pl line 5.
&gt; +++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
&gt; STDOUT: @ARGV=8 $rand=0668209
&gt; left.pl: STTDERR: @ARGV=9 at left.pl line 5.
&gt; +++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
&gt; STDOUT: @ARGV=9 $rand=0049729
&gt; left.pl: STTDERR: @ARGV=10 at left.pl line 5.
&gt; +++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
&gt; STDOUT: @ARGV=10 $rand=0781647
&gt; @pids=26809 26811 26812 0 at
&gt; /mnt/sdb8/sergei/QEMU/portable_perl/try_ipc_win2k_bug.pl line 62,
&gt; &lt;STDIN&gt; line 10.
&gt; &#34;.
&gt; 
&gt; When I run the same setup under Windows 2000 &#40;under QEMU to be exact&#41;,
&gt; the command line and its screen output is like this:
&gt; 
&gt; &#34;
&gt; C:\perl_plus_player&gt;C:\Perl\bin\perl.exe -w try_ipc_win2k_bug.pl
&gt; &#40;0&#41; $$=580 at try_ipc_win2k_bug.pl line 9.
&gt; &#40;1&#41; $$=-860 at try_ipc_win2k_bug.pl line 18.
&gt; left.pl: STTDERR: @ARGV=1 at left.pl line 5.
&gt; left.pl: STTDERR: @ARGV=2 at left.pl line 5.
&gt; left.pl: STTDERR: @ARGV=3 at left.pl line 5.
&gt; left.pl: STTDERR: @ARGV=4 at left.pl line 5.
&gt; left.pl: STTDERR: @ARGV=5 at left.pl line 5.
&gt; left.pl: STTDERR: @ARGV=6 at left.pl line 5.
&gt; left.pl: STTDERR: @ARGV=7 at left.pl line 5.
&gt; left.pl: STTDERR: @ARGV=8 at left.pl line 5.
&gt; &#34;,
&gt; 
&gt; after that the script is stuck.
&gt; 
&gt; Actually, the script is not always stuck. If in &#39;try_ipc_win2k_bug.pl&#39;
&gt; file one changes this line:
&gt; 
&gt;      19        for my $ctr&#40;1 .. 10&#41;
&gt; 
&gt; to become
&gt; 
&gt;        for my $ctr&#40;1 .. 2&#41;
&gt; 
&gt; , the script works:
&gt; 
&gt; &#34;
&gt; C:\perl_plus_player&gt;C:\Perl\bin\perl.exe -w try_ipc_win2k_bug.pl
&gt; &#40;0&#41; $$=1024 at try_ipc_win2k_bug.pl line 9.
&gt; &#40;1&#41; $$=-968 at try_ipc_win2k_bug.pl line 18.
&gt; left.pl: STTDERR: @ARGV=1 at left.pl line 5.
&gt; left.pl: STTDERR: @ARGV=2 at left.pl line 5.
&gt; &#40;4&#41; $$=1024 at try_ipc_win2k_bug.pl line 39.
<div class="message-stanza open">&gt; last_pipe&gt; C:\Perl\bin\perl.exe -w right.pl
</div>&gt; +++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
&gt; STDOUT: @ARGV=1 $rand=0089996
&gt; +++processed by right.pl+++: &lt;&lt;&lt;processed by center.pl&gt;&gt;&gt;: left.pl:
&gt; STDOUT: @ARGV=2 $rand=0420715
&gt; @pids=-968 -692 -704 0 at try_ipc_win2k_bug.pl line 62, &lt;STDIN&gt; line 2.
&gt; 
&gt; C:\perl_plus_player&gt;
&gt; &#34;.
&gt; 
&gt; What else ? I&#39;ve noticed that under Win2k if Perl &#39;system&#40;&#34;dir&#34;&#41;;&#39; is
&gt; called inside a thread, the whole thing gets stuck - I do not have a
&gt; ready code example at hand.
&gt; 
&gt; Also, the following bug reports:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.activestate.com/show_bug.cgi?id=82846">http://bugs.activestate.com/show_bug.cgi?id=82846</a></span>
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.activestate.com/show_bug.cgi?id=82870">http://bugs.activestate.com/show_bug.cgi?id=82870</a></span>
&gt; 
&gt; might be related.
&gt; 
&gt; The failure occurs under the latest ActiveState perl-5.10.0; according
&gt; to my tries with other Perl modules and scripts of mine under win2k the
&gt; flakiness doesn&#39;t really depend on Perl distro - say, Strawberry Perl is
&gt; equally good/bad.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;26&nbsp;15:14:55&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;26&nbsp;16:35:53&nbsp;2009</span>
    <span class="description">sergstesh [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Apr 26 15:14:54 2009, GLAI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thank you so much for exercising IPC::Exe, Sergei. I have been able to
&gt; reproduce the exact problem of what you&#39;re seeing on my side.
&gt; 
&gt; I think I understand the problem now. It comes down to fundamentals of
&gt; pipes. You see, writing and reading from a pipe causes blocking. Since
&gt; we only have threads in Windows, once it blocks, it blocks forever.
&gt; IPC::Exe exists in the thread and needs to carry on. What this means is
&gt; you cannot have a writer and a reader in the same thread &#40;unless you can
&gt; poll the reader/writer continuously&#41;. This greatly reduces what &#38;PREEXEC
&gt; can do.
&gt; 
&gt; The cleanest solution is to have the pipe writer and reader in two
&gt; separate processes. Since IPC::Exe takes care of pipe readers in the
&gt; current process, you have to exec the pipe writer into another process.
&gt; That means, if you want a &#38;PREEXEC like your example below, you have to
&gt; exec a &#39;perl&#39; process that does the same thing, from scratch.
&gt; 
&gt; You have given me a lot to think about, and have helped me expose many
&gt; bugs. The next release IPC::Exe 1.006 will be a MAJOR update.
&gt; 
&gt; Thanks again.
&gt; --
&gt; Gerald
&gt; 
</div>
Gerald, thanks for prompt reaction to my request.

After reading your reply I do not quite understand how it explains the
fact that if I shorten the generating loop the whole thing is not stuck
under Win2k.

Let me explain what the attached scripts are meant to do.

First and simplistically try_ipc_win2k_bug.pl is supposed to do moral
equivalent of

system&#40;&#34;left.pl | center.pl | right.pl&#34;&#41;;

Now, to be more precise, &#39;left.pl&#39; is not supposed to be called just
once, but in a loop inside &#39;try_ipc_win2k_bug.pl&#39;:

     19        for my $ctr&#40;1 .. 10&#41;
     20          {
     21          #print STDOUT &#34;$ctr\n&#34;;
     22          &#38;{exe $^X, &#39;-w&#39;, &#39;left.pl&#39;, $ctr};
     23          }
.

So, as I said, if I just replace 10 in &#34;for my $ctr&#40;1 .. 10&#41;&#34; with 2,
the whole thing is not stuck under Win2k.

I understand there are only threads under Windows, but I do not yet see
how changing number of iterations in the generating loop changes the
fact of &#40;non&#41;blocking.

Had the whole thing behaved in a manned according to the case with 2
iterations, i.e. had it printed first something and then stopped, I
would have understood.

Did you read

<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.activestate.com/show_bug.cgi?id=82846">http://bugs.activestate.com/show_bug.cgi?id=82846</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.activestate.com/show_bug.cgi?id=82870">http://bugs.activestate.com/show_bug.cgi?id=82870</a></span>

?

One of the points mentioned there is that if I just have one father &lt;-&gt;
son pair, the example with pipes works - still with threads and not real
processes.

If, however, I transform the example to father &lt;-&gt; son &lt;-&gt; grandson, it
stops working.

Maybe the problem is not in your module, but in Perl core + threads, but
my knowledge is not enough to really prove it.

I believe that with my examples Win32 Perl &#39;fork&#39; implementation should
be equivalent to real &#39;fork&#39; but maybe I misunderstood the manual.

Thanks,
  Sergei.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;26&nbsp;22:49:24&nbsp;2009</span>
    <span class="description">glai [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Apr 26 16:35:53 2009, sergstesh wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun Apr 26 15:14:54 2009, GLAI wrote:
<div class="message-stanza open">&gt; &gt; Thank you so much for exercising IPC::Exe, Sergei. I have been able to
&gt; &gt; reproduce the exact problem of what you&#39;re seeing on my side.
&gt; &gt; 
&gt; &gt; I think I understand the problem now. It comes down to fundamentals of
&gt; &gt; pipes. You see, writing and reading from a pipe causes blocking. Since
&gt; &gt; we only have threads in Windows, once it blocks, it blocks forever.
&gt; &gt; IPC::Exe exists in the thread and needs to carry on. What this means is
&gt; &gt; you cannot have a writer and a reader in the same thread &#40;unless you can
&gt; &gt; poll the reader/writer continuously&#41;. This greatly reduces what &#38;PREEXEC
&gt; &gt; can do.
&gt; &gt; 
&gt; &gt; The cleanest solution is to have the pipe writer and reader in two
&gt; &gt; separate processes. Since IPC::Exe takes care of pipe readers in the
&gt; &gt; current process, you have to exec the pipe writer into another process.
&gt; &gt; That means, if you want a &#38;PREEXEC like your example below, you have to
&gt; &gt; exec a &#39;perl&#39; process that does the same thing, from scratch.
&gt; &gt; 
&gt; &gt; You have given me a lot to think about, and have helped me expose many
&gt; &gt; bugs. The next release IPC::Exe 1.006 will be a MAJOR update.
&gt; &gt; 
&gt; &gt; Thanks again.
&gt; &gt; --
&gt; &gt; Gerald
&gt; &gt; 
</div>&gt; 
&gt; Gerald, thanks for prompt reaction to my request.
&gt; 
&gt; After reading your reply I do not quite understand how it explains the
&gt; fact that if I shorten the generating loop the whole thing is not stuck
&gt; under Win2k.
&gt; 
&gt; Let me explain what the attached scripts are meant to do.
&gt; 
&gt; First and simplistically try_ipc_win2k_bug.pl is supposed to do moral
&gt; equivalent of
&gt; 
&gt; system&#40;&#34;left.pl | center.pl | right.pl&#34;&#41;;
&gt; 
&gt; Now, to be more precise, &#39;left.pl&#39; is not supposed to be called just
&gt; once, but in a loop inside &#39;try_ipc_win2k_bug.pl&#39;:
&gt; 
&gt;      19        for my $ctr&#40;1 .. 10&#41;
&gt;      20          {
&gt;      21          #print STDOUT &#34;$ctr\n&#34;;
&gt;      22          &#38;{exe $^X, &#39;-w&#39;, &#39;left.pl&#39;, $ctr};
&gt;      23          }
&gt; .
&gt; 
&gt; So, as I said, if I just replace 10 in &#34;for my $ctr&#40;1 .. 10&#41;&#34; with 2,
&gt; the whole thing is not stuck under Win2k.
&gt; 
&gt; I understand there are only threads under Windows, but I do not yet see
&gt; how changing number of iterations in the generating loop changes the
&gt; fact of &#40;non&#41;blocking.
&gt; 
&gt; Had the whole thing behaved in a manned according to the case with 2
&gt; iterations, i.e. had it printed first something and then stopped, I
&gt; would have understood.
&gt; 
&gt; Did you read
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.activestate.com/show_bug.cgi?id=82846">http://bugs.activestate.com/show_bug.cgi?id=82846</a></span>
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.activestate.com/show_bug.cgi?id=82870">http://bugs.activestate.com/show_bug.cgi?id=82870</a></span>
&gt; 
&gt; ?
&gt; 
&gt; One of the points mentioned there is that if I just have one father &lt;-&gt;
&gt; son pair, the example with pipes works - still with threads and not real
&gt; processes.
&gt; 
&gt; If, however, I transform the example to father &lt;-&gt; son &lt;-&gt; grandson, it
&gt; stops working.
&gt; 
&gt; Maybe the problem is not in your module, but in Perl core + threads, but
&gt; my knowledge is not enough to really prove it.
&gt; 
&gt; I believe that with my examples Win32 Perl &#39;fork&#39; implementation should
&gt; be equivalent to real &#39;fork&#39; but maybe I misunderstood the manual.
&gt; 
&gt; Thanks,
&gt;   Sergei.
</div>
Sergei,

Yes, I read your bug reports.

The reason why shortening the loop avoids the deadlock is because then
you won&#39;t be printing out _too much_ to the pipe. It is blocking because
the pipe is full, and the writer is waiting till the reader reads off
some information from the pipe before continuing. However, the writer is
not in its own separate process as in a real fork&#40;&#41; - when it blocks, it
prevents &#38;READER &#40;same process, separate thread&#41; from continuing for
subsequent exe&#39;s.

So, is the reader &#40;center.pl&#41; ready to receive data? Nope.
Unfortunately, center.pl was not even spawned yet because IPC::Exe was
blocked by print&#40;&#41;.

Please allow me time to address this. The documentation will be updated
to explain how to use IPC::Exe effectively in Win32.

Thanks for your patience,
Gerald
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;03&nbsp;22:09:40&nbsp;2009</span>
    <span class="description">glai [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sergei,

I&#39;ve made improvements to v1.006 and updated the POD.

Please read the CAVEAT section.

In your specific case of try_ipc_win2k_bug.pl, you hit a limitation of
threads. If you moved the for-loop inside left.pl and do

    exe $^X, &#39;-w&#39;, &#39;left.pl&#39;, $ctr,

instead of

    exe sub {
       $| = 1;
       warn &#34;&#40;1&#41; \$\$=$$&#34;;
       for my $ctr&#40;1 .. 10&#41;
       {
           &#38;{exe $^X, &#39;-w&#39;, &#39;left.pl&#39;, $ctr};
       }
    },

it will work.

Let me know if you have further questions. Thanks again.
--
Gerald
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;03&nbsp;22:09:41&nbsp;2009</span>
    <span class="description">glai [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;May&nbsp;03&nbsp;22:10:19&nbsp;2009</span>
    <span class="description">glai [...] cpan.org -  Fixed in 1.006 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
