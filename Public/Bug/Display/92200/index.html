<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #92200 for IO-Event: forks2.t fails under heavy load</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #92200 for IO-Event: forks2.t fails under heavy load</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/IO-Event/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/IO-Event/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/IO-Event/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/IO-Event/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IO-Event">IO-Event CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">92200</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/IO-Event/Active/">IO-Event</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dam [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
gregoa [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-17084-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.813    </td>
  </tr>
  <tr id="CF-17085-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;16&nbsp;07:07:44&nbsp;2014</span>
    <span class="description">dam [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> forks2.t fails under heavy load</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">First reported in Debian, while rebuilding all packages to scan for failures. &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/730908&#41;">http://bugs.debian.org/730908&#41;</a></span>.

The symptoms are that under heavy load, forks2.t test sometimes fails. 
Here&#39;s the output with $debug enabled in t/forked.tt:

------------===========-------------
# test paragraph mode, getlines, $/ set funny
# ACCEPTED CONNECTION
ok 110
ok 111
# got &#39;go\n&#39;
# SENDING &#39;this is &#39;
# SENDING &#39;a test\n&#39;
# SIGPIPE recevied in 6846
# Looks like you planned 115 tests but ran 111.
print 6846: Broken pipe
Compilation failed in require at t/forked2.t line 5.
------------===========-------------

6846 is the child PID.

The original failure report &#40;linked in the first message from the link above&#41; ends with
------------===========-------------
# Looks like you planned 115 tests but ran 111.
print 26175: Connection reset by peer
Compilation failed in require at t/forked2.t line 5.
------------===========-------------
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;05&nbsp;07:24:28&nbsp;2014</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne ÄŒt 16.led.2014 07:07:44, DAM napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; First reported in Debian, while rebuilding all packages to scan for
&gt; failures. &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/730908&#41;">http://bugs.debian.org/730908&#41;</a></span>.
&gt; 
&gt; The symptoms are that under heavy load, forks2.t test sometimes fails.
&gt; Here&#39;s the output with $debug enabled in t/forked.tt:
&gt; 
&gt; ------------===========-------------
&gt; # test paragraph mode, getlines, $/ set funny
&gt; # ACCEPTED CONNECTION
&gt; ok 110
&gt; ok 111
&gt; # got &#39;go\n&#39;
&gt; # SENDING &#39;this is &#39;
&gt; # SENDING &#39;a test\n&#39;
&gt; # SIGPIPE recevied in 6846
&gt; # Looks like you planned 115 tests but ran 111.
&gt; print 6846: Broken pipe
&gt; Compilation failed in require at t/forked2.t line 5.
&gt; ------------===========-------------
&gt; 
&gt; 6846 is the child PID.
&gt; 
&gt; The original failure report &#40;linked in the first message from the link
&gt; above&#41; ends with
&gt; ------------===========-------------
&gt; # Looks like you planned 115 tests but ran 111.
&gt; print 26175: Connection reset by peer
&gt; Compilation failed in require at t/forked2.t line 5.
&gt; ------------===========-------------
</div>
This is perfectly reproducible by adding &#34;sleep 1;&#34; between the &#34;&#40;print $s&#34; and &#34;syncany&#40;&#41;&#34; lines.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;05&nbsp;07:24:29&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;17&nbsp;20:35:28&nbsp;2014</span>
    <span class="description">MUIR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I added the sleep but forked2.t still passes for me.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;07&nbsp;07:48:47&nbsp;2014</span>
    <span class="description">gregoa [...] cpan.org -  Cc GREGOA added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;12&nbsp;02:48:09&nbsp;2015</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2014-07-17 20:35:28, MUIR wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I added the sleep but forked2.t still passes for me.
</div>
There are also failures reported at CPAN Testers:
<span class="clickylink"><a target="new" rel="nofollow" href="http://analysis.cpantesters.org/reports_by_field?SUBMIT_xxx=Submit&#38;distv=IO-Event-0.813&#38;field=fail%3At%2Fforked2.t&#38;field=meta%3Aosname%2Bperl&#38;field=fail%3At%2Fforked2.t">http://analysis.cpantesters.org/reports_by_field?SUBMIT_xxx=Submit&#38;distv=IO-Event-0.813&#38;field=fail%3At%2Fforked2.t&#38;field=meta%3Aosname%2Bperl&#38;field=fail%3At%2Fforked2.t</a></span>

A value of zero looks like the same problem as described here. This may happen on all OSes and Perl versions. The value of 30 seems to be another problem and happens only on NetBSD systems.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;13&nbsp;08:08:11&nbsp;2015</span>
    <span class="description">ntyni [...] iki.fi -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ntyni [...] iki.fi</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jan 16 07:07:44 2014, DAM wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; First reported in Debian, while rebuilding all packages to scan for
&gt; failures. &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/730908&#41;">http://bugs.debian.org/730908&#41;</a></span>.
&gt; 
&gt; The symptoms are that under heavy load, forks2.t test sometimes fails.
</div>
I can reproduce this quite reliably. It looks like it happens if the parent gets a new connection event before the eof event from the previous one. This wouldn&#39;t matter otherwise, but if it&#39;s the last test group starting, ie_connection&#40;&#41; decrements the counter to zero first, and ie_eof&#40;&#41; thinks it&#39;s all done even though a new connection has just been accepted.

The attached patch should fix it by making the client synchronize on the eof event from the parent before making a new connection.

-- 
Niko Tyni &#40;Debian Perl Group&#41;
ntyni@debian.org
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Fix-undeterministic-test-failures-in-t-forked2.t.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From e11dc91080151bb59d73e72c3c0a3409c1b999ef Mon Sep 17 00:00:00 2001
From: Niko Tyni &lt;ntyni@debian.org&gt;
Date: Sat, 12 Dec 2015 11:33:34 +0200
Subject: [PATCH] Fix undeterministic test failures in t/forked2.t

The parent process may get both the eof event from an old connection
and the connect event from a new connection at the same time, and in an
unpredictable order. If the connect event comes first, the handler may
decrement the test counter to zero and make the eof handler think the
testing is already over.

Having the child synchronize on the eof event before making a new
connection fixes this race.

Bug-Debian: <span class="clickylink"><a target="new" rel="nofollow" href="https://bugs.debian.org/730908">https://bugs.debian.org/730908</a></span>
Bug: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=92200">https://rt.cpan.org/Ticket/Display.html?id=92200</a></span>
---
 t/forked.tt | 1 +
 1 file changed, 1 insertion&#40;+&#41;

diff --git a/t/forked.tt b/t/forked.tt
index e56c7fa..0d9ce18 100755
--- a/t/forked.tt
+++ b/t/forked.tt
@@ -265,6 +265,7 @@ if &#40;$child = fork&#40;&#41;&#41; {
 		}
 		print &#34;# CHILD closing\n&#34;;
 		close&#40;$s&#41;;
+		syncto&#40;&#34;e&#34;&#41;;
 	}
 } else {
 	die &#34;fork: $!&#34;;
-- 
2.6.2

</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
