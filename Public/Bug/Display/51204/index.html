<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #51204 for Encode: Callback CHECK not supported for UTF-8 decoder/encoder</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #51204 for Encode: Callback CHECK not supported for UTF-8 decoder/encoder</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Encode/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Encode/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Encode/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Encode/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Encode">Encode CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">51204</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Encode/Active/">Encode</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
GAAS [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-12062-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.37    </td>
  </tr>
  <tr id="CF-12063-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;08&nbsp;06:14:43&nbsp;2009</span>
    <span class="description">GAAS [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Callback CHECK not supported for UTF-8 decoder/encoder</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I was surprised how much time I ended up spending debugging why I could
not get:

  Encode::decode&#40;&#34;UTF-8&#34;, $octets, sub { sprintf &#34;%%%02X&#34;, shift }&#41;

to work.  My program behaved very oddly and the behaviour changed in
random ways.  Turns out Encode just sliently turn the CODE address into
an integer and treat that as flags to decide how to behave.  Very confusing.

The least that should happen is that the decoder croaks when a CODE
reference is passed in, but I would be much happier if such callbacks
could simply be made to work.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;08&nbsp;06:18:02&nbsp;2009</span>
    <span class="description">GAAS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Patch to make Encode::decode&#40;&#34;UTF-8&#34;, $bytes, sub {}&#41; croak.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 32ca48a2d4d46aa42855266f4e37da8a7342a92d Mon Sep 17 00:00:00 2001
From: Gisle Aas &lt;gisle@aas.no&gt;
Date: Sun, 8 Nov 2009 12:15:58 +0100
Subject: [PATCH] Make the UTF8 encoder croak when callback CHECK is passed in

---
 Encode.xs |   22 ++++++++++++++++++----
 1 files changed, 18 insertions&#40;+&#41;, 4 deletions&#40;-&#41;

diff --git a/Encode.xs b/Encode.xs
index e5f4c9a..e9ccd3f 100644
--- a/Encode.xs
+++ b/Encode.xs
@@ -401,19 +401,26 @@ MODULE = Encode		PACKAGE = Encode::utf8	PREFIX = Method_
 PROTOTYPES: DISABLE
 
 void
-Method_decode_xs&#40;obj,src,check = 0&#41;
+Method_decode_xs&#40;obj,src,check_sv = &#38;PL_sv_no&#41;
 SV *	obj
 SV *	src
-int	check
+SV *	check_sv
 PREINIT:
     STRLEN slen;
     U8 *s;
     U8 *e;
     SV *dst;
     bool renewed = 0;
+    int check;
 CODE:
 {
     dSP; ENTER; SAVETMPS;
+    if &#40;SvROK&#40;check_sv&#41;&#41; {
+	croak&#40;&#34;UTF-8 decoder doesn&#39;t support callback CHECK&#34;&#41;;
+    }
+    else {
+	check = SvIV&#40;check_sv&#41;;
+    }
     if &#40;src == &#38;PL_sv_undef&#41; src = newSV&#40;0&#41;;
     s = &#40;U8 *&#41; SvPV&#40;src, slen&#41;;
     e = &#40;U8 *&#41; SvEND&#40;src&#41;;
@@ -464,18 +471,25 @@ CODE:
 }
 
 void
-Method_encode_xs&#40;obj,src,check = 0&#41;
+Method_encode_xs&#40;obj,src,check_sv = &#38;PL_sv_no&#41;
 SV *	obj
 SV *	src
-int	check
+SV *	check_sv
 PREINIT:
     STRLEN slen;
     U8 *s;
     U8 *e;
     SV *dst;
     bool renewed = 0;
+    int check;
 CODE:
 {
+    if &#40;SvROK&#40;check_sv&#41;&#41; {
+	croak&#40;&#34;UTF-8 encoder doesn&#39;t support callback CHECK&#34;&#41;;
+    }
+    else {
+	check = SvIV&#40;check_sv&#41;;
+    }
     if &#40;src == &#38;PL_sv_undef&#41; src = newSV&#40;0&#41;;
     s = &#40;U8 *&#41; SvPV&#40;src, slen&#41;;
     e = &#40;U8 *&#41; SvEND&#40;src&#41;;
-- 
1.6.2.95.g934f7

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;08&nbsp;06:18:03&nbsp;2009</span>
    <span class="description">GAAS [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;16&nbsp;03:49:03&nbsp;2009</span>
    <span class="description">DANKOGAI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks, applied in my repo.  VERSION++ soon.

Dan the Maintainer Thereof

On Sun Nov 08 06:18:02 2009, GAAS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Patch to make Encode::decode&#40;&#34;UTF-8&#34;, $bytes, sub {}&#41; croak.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;16&nbsp;03:49:05&nbsp;2009</span>
    <span class="description">DANKOGAI [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;23&nbsp;18:17:14&nbsp;2009</span>
    <span class="description">u-suke [...] kawa.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, the ticket seems closed though.

Some of my modules expected that this wouldn&#39;t croak but be simply ignored.
I would be much happier if such callbacks could work, too. :-&#41;

I tested under Encode.pm 2.23:

perl -MEncode -e &#39;print Encode::decode&#40;&#34;UTF-8&#34;, &#34;\x80&#34;, Encode::FB_XMLCREF&#41;, &#34;\n&#34;&#39;
&#38;#x80;

=&gt; CHECK values works as single ¥x80 octets is malformed in UTF-8.
I guess this is one of cases that CHECK is needed for decode&#40;&#41;.

perl -MEncode -e &#39;print Encode::decode&#40;&#34;UTF-8&#34;, &#34;\x80&#34;, sub { sprintf &#34;%%%02X&#34;, shift }&#41;, 
&#34;\n&#34;&#39;
&#38;#128;

=&gt; CHECK coderef is ignored and doesn&#39;t work. I think this should work however.
This invokes &#34;UTF-8 decoder doesn&#39;t support callback CHECK&#34; under Encode 2.38.

Thank you both for maintaining the great module anyway.

Ref:
<span class="clickylink"><a target="new" rel="nofollow" href="http://kawa.at.webry.info/200911/article_12.html">http://kawa.at.webry.info/200911/article_12.html</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;23&nbsp;18:17:14&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;26&nbsp;04:28:22&nbsp;2009</span>
    <span class="description">DANKOGAI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in Version 2.39.  Thanks for your insight.  Indeed, it&#39;s useful on decode.  For encode, it 
has no use since it always succeeds.

Dan the Encode Maintainer

On Mon Nov 23 18:17:14 2009, KAWASAKI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, the ticket seems closed though.
&gt; 
&gt; Some of my modules expected that this wouldn&#39;t croak but be simply
&gt; ignored.
&gt; I would be much happier if such callbacks could work, too. :-&#41;
&gt; 
&gt; I tested under Encode.pm 2.23:
&gt; 
&gt; perl -MEncode -e &#39;print Encode::decode&#40;&#34;UTF-8&#34;, &#34;\x80&#34;,
&gt; Encode::FB_XMLCREF&#41;, &#34;\n&#34;&#39;
&gt; &#38;#x80;
&gt; 
&gt; =&gt; CHECK values works as single ¥x80 octets is malformed in UTF-8.
&gt; I guess this is one of cases that CHECK is needed for decode&#40;&#41;.
&gt; 
&gt; perl -MEncode -e &#39;print Encode::decode&#40;&#34;UTF-8&#34;, &#34;\x80&#34;, sub { sprintf
&gt; &#34;%%%02X&#34;, shift }&#41;,
&gt; &#34;\n&#34;&#39;
&gt; &#38;#128;
&gt; 
&gt; =&gt; CHECK coderef is ignored and doesn&#39;t work. I think this should work
&gt; however.
&gt; This invokes &#34;UTF-8 decoder doesn&#39;t support callback CHECK&#34; under
&gt; Encode 2.38.
&gt; 
&gt; Thank you both for maintaining the great module anyway.
&gt; 
&gt; Ref:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://kawa.at.webry.info/200911/article_12.html">http://kawa.at.webry.info/200911/article_12.html</a></span>
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;26&nbsp;04:28:23&nbsp;2009</span>
    <span class="description">DANKOGAI [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
