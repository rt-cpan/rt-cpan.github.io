<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #101078 for Term-ReadLine-Gnu: causes debugger to exit immediately on 5.21.7</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #101078 for Term-ReadLine-Gnu: causes debugger to exit immediately on 5.21.7</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Term-ReadLine-Gnu/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Term-ReadLine-Gnu/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Term-ReadLine-Gnu/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Term-ReadLine-Gnu/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Term-ReadLine-Gnu">Term-ReadLine-Gnu CPAN distribution</a>.</p>


<h3>Maintainer&#40;s&#41;&#39; notes</h3>

<p>When you report a bug, please provide the following information;

<pre>
- output of
	perl -V
	perl Makefile.PL verbose
	make test TEST_VERBOSE=1
	perl -Mblib t/00checkver.t
	echo $TERM
- terminal emulator which you are using
- compiler which is used to compile the GNU Readline Library (libreadline.a) if you can know.
</pre>

Read <a href="http://search.cpan.org/src/HAYASHI/Term-ReadLine-Gnu-1.23/INSTALL">INSTALL</a> in the distribution for more details.
</p>



<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">101078</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Term-ReadLine-Gnu/Active/">Term-ReadLine-Gnu</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">HAYASHI [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
rjbs [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-31188-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-31189-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.26    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




bisect-trl-gnu.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1456831/775078/bisect-trl-gnu.pl">
Sun Jan 25 19:17:50 2015 (606b) by TONYC [...] cpan.org
</a>
</font></li>
</ul>


bisect-trl-gnu.sh<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1456837/775088/bisect-trl-gnu.sh">
Sun Jan 25 20:01:51 2015 (554b) by TONYC [...] cpan.org
</a>
</font></li>
</ul>


log_fail<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1456677/774984/log_fail">
Sun Jan 25 10:02:30 2015 (16.9k) by HAYASHI [...] cpan.org
</a>
</font></li>
</ul>


log_fine<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1456677/774985/log_fine">
Sun Jan 25 10:02:30 2015 (15.8k) by HAYASHI [...] cpan.org
</a>
</font></li>
</ul>


make-verbose.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1445229/768407/make-verbose.txt">
Mon Dec 22 11:14:36 2014 (15.5k) by rjbs [...] cpan.org
</a>
</font></li>
</ul>


perl.V<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1445229/768408/perl.V">
Mon Dec 22 11:14:36 2014 (2.9k) by rjbs [...] cpan.org
</a>
</font></li>
</ul>


Term-ReadLine-Gnu-1.26-Propagete-PerlIO_return_value_from_STORE.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1533733/818454/Term-ReadLine-Gnu-1.26-Propagete-PerlIO_return_value_from_STORE.patch">
Wed Sep 09 18:05:42 2015 (1.2k) by emmanuel [...] seyman.fr
</a>
</font></li>
</ul>


Term-ReadLine-Gnu-1.27-Propagete-PerlIO_return_value_from_STORE.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1538089/821009/Term-ReadLine-Gnu-1.27-Propagete-PerlIO_return_value_from_STORE.patch">
Wed Sep 23 06:38:16 2015 (2.4k) by ppisar [...] redhat.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;22&nbsp;11:14:36&nbsp;2014</span>
    <span class="description">rjbs [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> causes debugger to exit immediately on 5.21.7</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This bug seems like it could be in a few different places, but I&#39;m reporting it here first.

I&#39;ve installed perl 5.21.7 and Term::ReadLine::Gnu.  When I run &#34;perl -de0&#34; the debugger exits immediately.

I have attached perl -V output.

I have attached verbose testing results.

My $TERM is xterm-256ocolor.

-- 
rjbs
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> make-verbose.txt</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> perl.V</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1445229/768408/perl.V">Download perl.V</a><br />
<span class="downloadcontenttype">application/octet-stream 2.9k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;22&nbsp;20:50:56&nbsp;2014</span>
    <span class="description">HAYASHI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for your report.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve installed perl 5.21.7 and Term::ReadLine::Gnu.  When I run &#34;perl
&gt; -de0&#34; the debugger exits immediately.
</div>
I cannot reproduce this with my perl 5.14.2 and 5.16.3.
Can you try with other version perls?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;22&nbsp;20:50:56&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;22&nbsp;20:51:01&nbsp;2014</span>
    <span class="description">HAYASHI [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;22&nbsp;21:26:14&nbsp;2014</span>
    <span class="description">rjbs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It&#39;s fine with every other version I had tried, up to and including 5.21.6.  There is some interaction between 5.21.7 and Term::ReadLine::Gnu.

-- 
rjbs
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;23&nbsp;02:41:42&nbsp;2014</span>
    <span class="description">HAYASHI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It&#39;s fine with every other version I had tried, up to and including
&gt; 5.21.6.  There is some interaction between 5.21.7 and
&gt; Term::ReadLine::Gnu.
</div>
Thank you.

I&#39;ve installed 5.21.7 and reproduce the issue.
It seems that handling of filehandle is changed in 5.21.7. 
I don&#39;t know it is a permanent change or not.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;19&nbsp;10:08:30&nbsp;2015</span>
    <span class="description">rjbs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2014-12-23 02:41:42, HAYASHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve installed 5.21.7 and reproduce the issue.
&gt; It seems that handling of filehandle is changed in 5.21.7. 
&gt; I don&#39;t know it is a permanent change or not.
</div>
Right now, I can tell you that there are no major issues known with changes to filehandles, so any current change should be considered permanent unless you can demonstrate that perl is probably wrong.

Or, put another way:  if you tell us a bit more specifically what has changed that is affecting Term-ReadLine-Gnu this way, we can give you a more definitive answer.

Right now there is not a big rush, but as we approach April, this will become a blocker for the release of perl 5.22.0.

Thanks!

-- 
rjbs
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;19&nbsp;21:36:08&nbsp;2015</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jan 19 10:08:30 2015, RJBS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 2014-12-23 02:41:42, HAYASHI wrote:
<div class="message-stanza open">&gt; &gt; I&#39;ve installed 5.21.7 and reproduce the issue.
&gt; &gt;  It seems that handling of filehandle is changed in 5.21.7.
&gt; &gt; I don&#39;t know it is a permanent change or not.
</div>&gt; 
&gt; Right now, I can tell you that there are no major issues known with
&gt; changes to filehandles, so any current change should be considered
&gt; permanent unless you can demonstrate that perl is probably wrong.
&gt; 
&gt; Or, put another way:  if you tell us a bit more specifically what has
&gt; changed that is affecting Term-ReadLine-Gnu this way, we can give you
&gt; a more definitive answer.
&gt; 
&gt; Right now there is not a big rush, but as we approach April, this will
&gt; become a blocker for the release of perl 5.22.0.
</div>
I had a look through the git log between 5.21.6 and 5.21.7, but I did not see anything related to I/O handles.  Admittedly it all started to sound like ‘blah blah blah’ after a while.

If someone is in a position to do a bisect, that would be immensely helpful.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;25&nbsp;10:02:30&nbsp;2015</span>
    <span class="description">HAYASHI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I debugged this issue today. It seems the behavior of PerlIO changed on 5.21.
doio.c are changed from 5.20.  I hope the maintainer of doio.c could solve this issue.

Here is a simplified perl script.

--------------
use Term::ReadLine; # needs Term::ReadLine::Gnu
open&#40;IN,&#34;&lt;&#38;STDIN&#34;&#41;   || warn &#34;Cannot open STDIN for read&#34;;
open&#40;OUT,&#34;&gt;&#38;STDOUT&#34;&#41; || warn &#34;Cannot open STDOUT for write&#34;;
Term::ReadLine::Gnu::Var::_rl_store_iostream&#40;\*IN, 0&#41;;
Term::ReadLine::Gnu::Var::_rl_store_iostream&#40;\*OUT, 1&#41;;
# The followings work.
#Term::ReadLine::Gnu::Var::_rl_store_iostream&#40;STDIN, 0&#41;;
#Term::ReadLine::Gnu::Var::_rl_store_iostream&#40;STDOUT, 1&#41;;

my $instream = Term::ReadLine::Gnu::Var::_rl_fetch_iostream&#40;0&#41;;
while &#40;&lt;$instream&gt;&#41; {
        print;
}
my $outstream = Term::ReadLine::Gnu::Var::_rl_fetch_iostream&#40;1&#41;;
print $outstream &#34;test\n&#34;;
--------------

5.21.8 does not work on this.
--------------
$ PERLIO_DEBUG=/tmp/log_fail ./perl -Mblib test
Warning: unable to close filehandle _GEN_3 properly: Bad file descriptor.
Warning: unable to close filehandle _GEN_2 properly: Bad file descriptor.
$ 
--------------
I&#39;ve attached /tmp/log_fail.

The followings are XS code of _rl_fetch_iostream&#40;&#41; and _rl_store_iostream&#40;&#41;

----------------------
PerlIO *
_rl_store_iostream&#40;stream, id&#41;
        PerlIO *stream
        int id
    PROTOTYPE: $$
    CODE:
        {
          switch &#40;id&#41; {
          case 0:
            rl_instream = PerlIO_findFILE&#40;stream&#41;;
            RETVAL = instreamPIO = stream;
            break;
          case 1:
            rl_outstream = PerlIO_findFILE&#40;stream&#41;;
            RETVAL = outstreamPIO = stream;
            break;
          default:
            warn&#40;&#34;Gnu.xs:_rl_store_iostream: Illegal `id&#39; value: `%d&#39;&#34;, id&#41;;
            XSRETURN_UNDEF;
            break;
          }
          PerlIO_debug&#40;&#34;TRG:store_iostream id %d fd %d\n&#34;,
                       id, PerlIO_fileno&#40;RETVAL&#41;&#41;;
        }
    OUTPUT:
        RETVAL

PerlIO *
_rl_fetch_iostream&#40;id&#41;
        int id
    PROTOTYPE: $
    CODE:
        {
          switch &#40;id&#41; {
          case 0:
            if &#40;instreamPIO == NULL&#41;
              RETVAL = instreamPIO = PerlIO_importFILE&#40;rl_instream, NULL&#41;;
            else
              RETVAL = instreamPIO;
            break;
          case 1:
            if &#40;outstreamPIO == NULL&#41;
              RETVAL = outstreamPIO = PerlIO_importFILE&#40;rl_outstream, NULL&#41;;
            else
              RETVAL = outstreamPIO;
            break;
          default:
            warn&#40;&#34;Gnu.xs:_rl_fetch_iostream: Illegal `id&#39; value: `%d&#39;&#34;, id&#41;;
            XSRETURN_UNDEF;
            break;
          }
          PerlIO_debug&#40;&#34;TRG:fetch_iostream id %d fd %d\n&#34;, 
                       id, PerlIO_fileno&#40;RETVAL&#41;&#41;;
        }
    OUTPUT:
        RETVAL
----------------------

The following test code works.
----------------------
use Term::ReadLine;
Term::ReadLine::Gnu::Var::_rl_store_iostream&#40;STDIN, 0&#41;;
Term::ReadLine::Gnu::Var::_rl_store_iostream&#40;STDOUT, 1&#41;;

my $instream = Term::ReadLine::Gnu::Var::_rl_fetch_iostream&#40;0&#41;;
while &#40;&lt;$instream&gt;&#41; {
        print;
}
my $outstream = Term::ReadLine::Gnu::Var::_rl_fetch_iostream&#40;1&#41;;
print $outstream &#34;test\n&#34;;
----------------------

-------
$ PERLIO_DEBUG=/tmp/log_fine ./perl -Mblib test
sdf
sdf
test
[hiroo@localhost trunk]$
-------
/tmp/log_fine is also attached.

If there are anything I can help, let me know.

Regards,
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> log_fail</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1456677/774984/log_fail">Download log_fail</a><br />
<span class="downloadcontenttype">application/octet-stream 16.9k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> log_fine</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1456677/774985/log_fine">Download log_fine</a><br />
<span class="downloadcontenttype">application/octet-stream 15.8k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;25&nbsp;19:17:50&nbsp;2015</span>
    <span class="description">TONYC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Jan 25 10:02:30 2015, HAYASHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; I debugged this issue today. It seems the behavior of PerlIO changed
&gt; on 5.21.
&gt; doio.c are changed from 5.20.  I hope the maintainer of doio.c could
&gt; solve this issue.
</div>
This may be the result of a bug fix.

I used the attached .sh and .pl &#40;which is just your demo code&#41; scripts to bisect this problem.

It came back with:

50e5165b9638b94be310f15477b42935c79e82d5 is the first bad commit
commit 50e5165b9638b94be310f15477b42935c79e82d5
Author: David Mitchell &lt;davem@iabyn.com&gt;
Date:   Fri Dec 12 19:52:22 2014 +0000

    stop T_IN/OUT/INOUT/STDIO typemaps leaking
    
    These typemaps &#40;which are ancient; mostly going back to 1994 or so&#41;
    each leaked a GV and an RV.

:040000 040000 21d214f612c38dab40f92f2acb3a330aef1d8240 01d1c3d3ba1e839092e970ea5b736176275e7d8b M      lib
bisect run success

_rl_store_iostream&#40;&#41; can return a new GV pointing to the same PerlIO object as its input.

Since your test code calls _rl_store_iostream&#40;&#41; in void context, the returned ref to a GV is immediately destroyed.  Before Dave&#39;s change since there was a leak the GV itselt wasn&#39;t destroyed, keeping the file open, after, there is no extra reference, so the GV is destroyed, closing the file.

_rl_fetch_iostream&#40;&#41; may have a similar problem, explaining why there&#39;s several warnings during global destruction.

Tony
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> bisect-trl-gnu.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use Term::ReadLine; # needs Term::ReadLine::Gnu
open&#40;IN,&#34;&lt;&#38;STDIN&#34;&#41;   || warn &#34;Cannot open STDIN for read&#34;;
open&#40;OUT,&#34;&gt;&#38;STDOUT&#34;&#41; || warn &#34;Cannot open STDOUT for write&#34;;
Term::ReadLine::Gnu::Var::_rl_store_iostream&#40;\*IN, 0&#41;;
Term::ReadLine::Gnu::Var::_rl_store_iostream&#40;\*OUT, 1&#41;;
# The followings work.
#Term::ReadLine::Gnu::Var::_rl_store_iostream&#40;STDIN, 0&#41;;
#Term::ReadLine::Gnu::Var::_rl_store_iostream&#40;STDOUT, 1&#41;;

my $instream = Term::ReadLine::Gnu::Var::_rl_fetch_iostream&#40;0&#41;;
while &#40;&lt;$instream&gt;&#41; {
	print;
}
my $outstream = Term::ReadLine::Gnu::Var::_rl_fetch_iostream&#40;1&#41;;
print $outstream &#34;test\n&#34;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;25&nbsp;20:01:51&nbsp;2015</span>
    <span class="description">TONYC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Jan 25 19:17:50 2015, TONYC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I used the attached .sh and .pl &#40;which is just your demo code&#41; scripts
&gt; to bisect this problem.
</div>
Either I forget to attach the .sh or it got lost.  Attached again now.

Tony
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> bisect-trl-gnu.sh</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1456837/775088/bisect-trl-gnu.sh">Download bisect-trl-gnu.sh</a><br />
<span class="downloadcontenttype">application/octet-stream 554b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;26&nbsp;10:58:21&nbsp;2015</span>
    <span class="description">HAYASHI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Thank you for your feedback.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; _rl_store_iostream&#40;&#41; can return a new GV pointing to the same PerlIO object as its input. Since your test code calls _rl_store_iostream&#40;&#41; in void context, the returned ref to a GV is immediately destroyed. Before Dave&#39;s change since there was a leak the GV itselt wasn&#39;t destroyed, keeping the file open, after, there is no extra reference, so the GV is destroyed, closing the file.
</div>
I see.  I&#39;ve comfirmed the following script works.

-------
use Term::ReadLine;
open&#40;IN,&#34;&lt;&#38;STDIN&#34;&#41;   || warn &#34;Cannot open STDIN for read&#34;;
open&#40;OUT,&#34;&gt;&#38;STDOUT&#34;&#41; || warn &#34;Cannot open STDOUT for write&#34;;
my $instream = Term::ReadLine::Gnu::Var::_rl_store_iostream&#40;\*IN, 0&#41;;
my $outstream = Term::ReadLine::Gnu::Var::_rl_store_iostream&#40;\*OUT, 1&#41;;

#$instream = Term::ReadLine::Gnu::Var::_rl_fetch_iostream&#40;0&#41;;
while &#40;&lt;$instream&gt;&#41; {
        print;
}
#$outstream = Term::ReadLine::Gnu::Var::_rl_fetch_iostream&#40;1&#41;;
print $outstream &#34;test\n&#34;;
-------

I have an idea of a fix.  I will try it on the next weekend.

Thanks.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;31&nbsp;06:44:52&nbsp;2015</span>
    <span class="description">HAYASHI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I think the following change in Perl 5.21 must be wrong.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Since your test code calls _rl_store_iostream&#40;&#41; in void context, the returned ref to a GV is immediately destroyed. Before Dave&#39;s change since there was a leak the GV itselt wasn&#39;t destroyed, keeping the file open, after, there is no extra reference, so the GV is destroyed, closing the file.
</div>
----------------------
use Term::ReadLine; # needs Term::ReadLine::Gnu
open&#40;IN,&#34;&lt;&#38;STDIN&#34;&#41;   || warn &#34;Cannot open STDIN for read&#34;;
open&#40;OUT,&#34;&gt;&#38;STDOUT&#34;&#41; || warn &#34;Cannot open STDOUT for write&#34;;
my $instream = \*IN;
my $outstream = \*OUT;
Term::ReadLine::Gnu::Var::_rl_store_iostream&#40;$instream, 0&#41;;
Term::ReadLine::Gnu::Var::_rl_store_iostream&#40;$outstream, 1&#41;;

while &#40;&lt;$instream&gt;&#41; {
  print;
}
print $outstream &#34;test\n&#34;;
----------------------

As you wrote, the following _rl_store_iostream&#40;&#41; destroy the filehandles &#40;$instream and $outstream&#41;, but they ARE STILL REFERENCED in the Perl script.

---------
PerlIO *
_rl_store_iostream&#40;stream, id&#41;
        PerlIO *stream
        int id
    PROTOTYPE: $$
    CODE:
        {
          switch &#40;id&#41; {
          case 0:
            rl_instream = PerlIO_findFILE&#40;stream&#41;;
            RETVAL = stream;
            break;
          case 1:
            rl_outstream = PerlIO_findFILE&#40;stream&#41;;
            RETVAL = stream;
            break;
          default:
            warn&#40;&#34;Gnu.xs:_rl_store_iostream: Illegal `id&#39; value: `%d&#39;&#34;, id&#41;;
            XSRETURN_UNDEF;
            break;
          }
          PerlIO_debug&#40;&#34;TRG:store_iostream id %d fd %d\n&#34;,
                       id, PerlIO_fileno&#40;stream&#41;&#41;;
        }
    OUTPUT:
        RETVAL
---------

The following _rl_store_iosteam&#40;&#41; DOES NOT destroy filehandles.
---------
void
_rl_store_iostream&#40;stream, id&#41;
        PerlIO *stream
        int id
    PROTOTYPE: $$
    CODE:
        {
          switch &#40;id&#41; {
          case 0:
            rl_instream = PerlIO_findFILE&#40;stream&#41;;
            break;
          case 1:
            rl_outstream = PerlIO_findFILE&#40;stream&#41;;
            break;
          default:
            warn&#40;&#34;Gnu.xs:_rl_store_iostream: Illegal `id&#39; value: `%d&#39;&#34;, id&#41;;
            break;
          }
          PerlIO_debug&#40;&#34;TRG:store_iostream id %d fd %d\n&#34;,
                       id, PerlIO_fileno&#40;stream&#41;&#41;;
        }
---------

The first _rl_store_iostream&#40;&#41; works if the return values are used as follows.
---------
use Term::ReadLine; # needs Term::ReadLine::Gnu
open&#40;IN,&#34;&lt;&#38;STDIN&#34;&#41;   || warn &#34;Cannot open STDIN for read&#34;;
open&#40;OUT,&#34;&gt;&#38;STDOUT&#34;&#41; || warn &#34;Cannot open STDOUT for write&#34;;
my $instream = \*IN;
my $outstream = \*OUT;
$instream = Term::ReadLine::Gnu::Var::_rl_store_iostream&#40;$instream, 0&#41;;
$outstream = Term::ReadLine::Gnu::Var::_rl_store_iostream&#40;$outstream, 1&#41;;

while &#40;&lt;$instream&gt;&#41; {
        print;
}
print $outstream &#34;test\n&#34;;
--------------------------
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;31&nbsp;21:47:31&nbsp;2015</span>
    <span class="description">HAYASHI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Although I think the PerlIO change in Perl 5.21 must be wrong, I released Term-ReadLine-Gnu 1.26 which used the second implementation of _rl_store_iosteam&#40;&#41; in my previous message.  It works even with Perl 5.21.

I stay the status of this ticket as open for a while.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;31&nbsp;21:47:37&nbsp;2015</span>
    <span class="description">HAYASHI [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;31&nbsp;21:47:38&nbsp;2015</span>
    <span class="description">HAYASHI [...] cpan.org -  Untaken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;31&nbsp;21:47:38&nbsp;2015</span>
    <span class="description">HAYASHI [...] cpan.org -  Fixed in 1.26 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;01&nbsp;06:45:06&nbsp;2015</span>
    <span class="description">rjbs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the new release.  While I can&#39;t &#40;yet&#41; comment on the correctness of the perl5 change, being able to use Term-ReadLine-Gnu in the meantime is a *very* big help for me in day to day testing of bleadperl.  I really appreciate it.

-- 
rjbs
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;12&nbsp;09:51:59&nbsp;2015</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne So 31.led.2015 21:47:31, HAYASHI napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Although I think the PerlIO change in Perl 5.21 must be wrong, I
&gt; released Term-ReadLine-Gnu 1.26 which used the second implementation
&gt; of _rl_store_iosteam&#40;&#41; in my previous message.  It works even with
&gt; Perl 5.21.
&gt; 
&gt; I stay the status of this ticket as open for a while.
</div>
I found this change causing a dead-lock in Debug-Client-0.29 tests &#40;see &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/PadreIDE/Debug-Client/issues/1">https://github.com/PadreIDE/Debug-Client/issues/1</a></span>&gt;&#41;. I don&#39;t know which party is more guilty, but I observe that perl debugger does not emit &#34;DB&lt;1&gt;&#34; prompt if it is run from the Debug-Client&#39;s test, so it does not process client &#34;c&#34; command and everything halts.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;12&nbsp;09:52:48&nbsp;2015</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Čt 12.úno.2015 09:51:59, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I found this change causing a dead-lock in Debug-Client-0.29 tests
&gt; &#40;see &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/PadreIDE/Debug-Client/issues/1">https://github.com/PadreIDE/Debug-Client/issues/1</a></span>&gt;&#41;. I don&#39;t
&gt; know which party is more guilty, but I observe that perl debugger does
&gt; not emit &#34;DB&lt;1&gt;&#34; prompt if it is run from the Debug-Client&#39;s test, so
&gt; it does not process client &#34;c&#34; command and everything halts.
</div>
I should note that I use perl 5.20.1.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;14&nbsp;09:55:25&nbsp;2015</span>
    <span class="description">HAYASHI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> ppisar [...] redhat.com, TONYC [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Thank you for your report.

On Thu, 12 Feb 2015 14:52:48 GMT, ppisar wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne Čt 12.úno.2015 09:51:59, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; I found this change causing a dead-lock in Debug-Client-0.29 tests
&gt; &gt; &#40;see &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/PadreIDE/Debug-Client/issues/1">https://github.com/PadreIDE/Debug-Client/issues/1</a></span>&gt;&#41;. I don&#39;t
&gt; &gt; know which party is more guilty, but I observe that perl debugger does
&gt; &gt; not emit &#34;DB&lt;1&gt;&#34; prompt if it is run from the Debug-Client&#39;s test, so
&gt; &gt; it does not process client &#34;c&#34; command and everything halts.
</div>&gt; 
&gt; I should note that I use perl 5.20.1.
</div>
Here is a fix.  I don&#39;t know why 1.26 fails or why this works.

===================================================================
--- Gnu.pm      &#40;revision 481&#41;
+++ Gnu.pm      &#40;working copy&#41;
@@ -725,9 +725,8 @@
     } elsif &#40;$type eq &#39;F&#39;&#41; {
        return _rl_store_function&#40;$value, $id&#41;;
     } elsif &#40;$type eq &#39;IO&#39;&#41; {
-       my $FH = $value;
        # Pass filehandles to the GNU Readline Library
-       _rl_store_iostream&#40;$FH, $id&#41;;
+       my $FH = _rl_store_iostream&#40;$value, $id&#41;;
        # pop stdio layer pushed by PerlIO_findFILE&#40;&#41;.
        # <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=59832">https://rt.cpan.org/Ticket/Display.html?id=59832</a></span>
        my @layers = PerlIO::get_layers&#40;$FH&#41;;
===================================================================
--- Gnu.xs      &#40;revision 481&#41;
+++ Gnu.xs      &#40;working copy&#41;
@@ -3138,7 +3138,7 @@
          }
        }
 
-void
+PerlIO *
 _rl_store_iostream&#40;stream, id&#41;
        PerlIO *stream
        int id
@@ -3148,9 +3148,11 @@
          switch &#40;id&#41; {
          case 0:
            rl_instream = PerlIO_findFILE&#40;stream&#41;;
+           RETVAL = stream;
            break;
          case 1:
            rl_outstream = PerlIO_findFILE&#40;stream&#41;;
+           RETVAL = stream;
 #ifdef __CYGWIN__
            {
              /* Cygwin b20.1 library converts NL to CR-NL
@@ -3167,11 +3169,14 @@
            break;
          default:
            warn&#40;&#34;Gnu.xs:_rl_store_iostream: Illegal `id&#39; value: `%d&#39;&#34;, id&#41;;
+           XSRETURN_UNDEF;
            break;
          }
          PerlIO_debug&#40;&#34;TRG:store_iostream id %d fd %d\n&#34;,
-                      id, PerlIO_fileno&#40;stream&#41;&#41;;
+                      id, PerlIO_fileno&#40;RETVAL&#41;&#41;;
        }
+     OUTPUT:
+       RETVAL
 
 #if 0 /* not used since 1.26 */
 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;17&nbsp;09:10:32&nbsp;2015</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101078] causes debugger to exit immediately on 5.21.7</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 17 Feb 2015 15:10:18 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Hiroo_HAYASHI via RT &lt;bug-Term-ReadLine-Gnu [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Petr Pisar &lt;ppisar [...] redhat.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, Feb 14, 2015 at 09:55:25AM -0500, Hiroo_HAYASHI via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu, 12 Feb 2015 14:52:48 GMT, ppisar wrote:
<div class="message-stanza open">&gt; &gt; Dne Čt 12.úno.2015 09:51:59, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; &gt; I found this change causing a dead-lock in Debug-Client-0.29 tests
&gt; &gt; &gt; &#40;see &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/PadreIDE/Debug-Client/issues/1">https://github.com/PadreIDE/Debug-Client/issues/1</a></span>&gt;&#41;. I don&#39;t
&gt; &gt; &gt; know which party is more guilty, but I observe that perl debugger does
&gt; &gt; &gt; not emit &#34;DB&lt;1&gt;&#34; prompt if it is run from the Debug-Client&#39;s test, so
&gt; &gt; &gt; it does not process client &#34;c&#34; command and everything halts.
</div>&gt; &gt; 
&gt; &gt; I should note that I use perl 5.20.1.
</div>&gt; 
&gt; Here is a fix.  I don&#39;t know why 1.26 fails or why this works.
&gt; 
</div>Thanks a lot. It works for me.

-- Petr
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1464663/779568/">Download &#40;untitled&#41;</a><br />
<span class="downloadcontenttype">application/pgp-signature 213b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;23&nbsp;03:56:14&nbsp;2015</span>
    <span class="description">HAYASHI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> ppisar [...] redhat.com, bowtie [...] cpan.org, gabor [...] szabgab.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dear Petr Pisar, Kevin Dawson, and Gabor Szabo,

I&#39;m working for releasing Term-ReadLine-Gnu 1.27.

I found that the fix for Debug-Client.pm caused warning messages on the latest Perl 5.22.0;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  Warning: unable to close filehandle properly: Bad file descriptor during global destruction.
</div>
I am trying find a way to work with both Perl 5.22.0 and Debug-Client.pm, but cannot find it yet.

I have some questions about Debug-Client.  Could you answer them for me?

Q1. Does Debug-Client call Term-ReadLine[-Gnu]?

Are my following understandings correct?
 - Debug-Client does not call Term-ReadLine directly.
 - Debug-Client invoke perl debugger &#40;perl -d&#41; and it calls Term-ReadLine.

I commented out the lines &#34;use Term::ReadLine;&#34; in Client.pm and t/00-initialize.t.  It works well with Term-ReadLine-Gnu 1.26.

Q2. Is Term::ReadLine enough for Padre IDE?

Are my following understandings correct?
 - The primary use of Debug-Client is Padre IDE.
 - For the purpose it does not call perl debugger from a terminal.
 - For Padre IDE Term::ReadLine is enough, and Term::ReadLine::Gnu is over-kill.

Q3. How does t/00-initialize.t call Term-ReadLine-Gnu?

As Petr Pisar reported, t/07-initialize.t hangs with Term-ReadLine-Gnu 1.26.
It hangs at the line in _get&#40;&#41; function;
                my $ret = $self-&gt;{socket}-&gt;sysread&#40; $buffer, 1024, length $buffer &#41;;

I found this as follows;
==========================================================
[hiroo@localhost Debug-Client-0.29]$ perl -d -Mblib t/07-initialize.t 

Loading DB routines from perl5db.pl version 1.37
Editor support available.

Enter h or &#39;h h&#39; for help, or &#39;man perldebug&#39; for more help.

1..4
main::&#40;t/07-initialize.t:5&#41;:    local $OUTPUT_AUTOFLUSH = 1;
  DB&lt;1&gt; c
ok 1 - initialize with prams
^CDebug::Client::_get&#40;/tmp/Debug-Client-0.29/blib/lib/Debug/Client.pm:506&#41;:
506:                    if &#40; not defined $ret &#41; {
  DB&lt;1&gt; c
Interrupted system call at t/07-initialize.t line 41.
 at /tmp/Debug-Client-0.29/blib/lib/Debug/Client.pm line 507.
        Debug::Client::_get&#40;&#39;Debug::Client=HASH&#40;0x12c00e8&#41;&#39;&#41; called at /tmp/Debug-Client-0.29/blib/lib/Debug/Client.pm line 454
        Debug::Client::get&#40;&#39;Debug::Client=HASH&#40;0x12c00e8&#41;&#39;&#41; called at /tmp/Debug-Client-0.29/blib/lib/Debug/Client.pm line 651
        Debug::Client::_send_get&#40;&#39;Debug::Client=HASH&#40;0x12c00e8&#41;&#39;, &#39;c&#39;&#41; called at /tmp/Debug-Client-0.29/blib/lib/Debug/Client.pm line 218
        Debug::Client::run&#40;&#39;Debug::Client=HASH&#40;0x12c00e8&#41;&#39;&#41; called at t/07-initialize.t line 41
ok 2 - quit with prams
ok 3 - initialize without prams
^CDebug::Client::_get&#40;/tmp/Debug-Client-0.29/blib/lib/Debug/Client.pm:506&#41;:
506:                    if &#40; not defined $ret &#41; {
...
==========================================================

By adding print message in my moudle, I found Term::ReadLine::Gnu::new method is called but Term::ReadLine::Gnu::readline method is never called during t/07-initizalize.t execution.

I cann&#39;t understand how Term-ReadLine-Gnu 1.26 causes the hang-up.

Above _get function, you wrote the following comment.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; # TODO shall we add a time-out and/or a number to count down the number sysread calls that return 0 before deciding it is really done
</div>
If you can fix this issue on your module, I can release Term-ReadLine-Gnu 1.27 without the patch below.


Any clues are welcome.

Thanks in advance.

On Sat, 14 Feb 2015 14:55:25 GMT, HAYASHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; Thank you for your report.
&gt; 
&gt; On Thu, 12 Feb 2015 14:52:48 GMT, ppisar wrote:
<div class="message-stanza open">&gt; &gt; Dne Čt 12.úno.2015 09:51:59, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; &gt; I found this change causing a dead-lock in Debug-Client-0.29 tests
&gt; &gt; &gt; &#40;see &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/PadreIDE/Debug-Client/issues/1">https://github.com/PadreIDE/Debug-Client/issues/1</a></span>&gt;&#41;. I don&#39;t
&gt; &gt; &gt; know which party is more guilty, but I observe that perl debugger does
&gt; &gt; &gt; not emit &#34;DB&lt;1&gt;&#34; prompt if it is run from the Debug-Client&#39;s test, so
&gt; &gt; &gt; it does not process client &#34;c&#34; command and everything halts.
</div>&gt; &gt; 
&gt; &gt; I should note that I use perl 5.20.1.
</div>&gt; 
&gt; Here is a fix.  I don&#39;t know why 1.26 fails or why this works.
&gt; 
&gt; ===================================================================
&gt; --- Gnu.pm    &#40;revision 481&#41;
&gt; +++ Gnu.pm    &#40;working copy&#41;
&gt; @@ -725,9 +725,8 @@
&gt;      } elsif &#40;$type eq &#39;F&#39;&#41; {
&gt;       return _rl_store_function&#40;$value, $id&#41;;
&gt;      } elsif &#40;$type eq &#39;IO&#39;&#41; {
&gt; -     my $FH = $value;
&gt;       # Pass filehandles to the GNU Readline Library
&gt; -     _rl_store_iostream&#40;$FH, $id&#41;;
&gt; +     my $FH = _rl_store_iostream&#40;$value, $id&#41;;
&gt;       # pop stdio layer pushed by PerlIO_findFILE&#40;&#41;.
&gt;       # <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=59832">https://rt.cpan.org/Ticket/Display.html?id=59832</a></span>
&gt;       my @layers = PerlIO::get_layers&#40;$FH&#41;;
&gt; ===================================================================
&gt; --- Gnu.xs    &#40;revision 481&#41;
&gt; +++ Gnu.xs    &#40;working copy&#41;
&gt; @@ -3138,7 +3138,7 @@
&gt;         }
&gt;       }
&gt;  
&gt; -void
&gt; +PerlIO *
&gt;  _rl_store_iostream&#40;stream, id&#41;
&gt;       PerlIO *stream
&gt;       int id
&gt; @@ -3148,9 +3148,11 @@
&gt;         switch &#40;id&#41; {
&gt;         case 0:
&gt;           rl_instream = PerlIO_findFILE&#40;stream&#41;;
&gt; +         RETVAL = stream;
&gt;           break;
&gt;         case 1:
&gt;           rl_outstream = PerlIO_findFILE&#40;stream&#41;;
&gt; +         RETVAL = stream;
&gt;  #ifdef __CYGWIN__
&gt;           {
&gt;             /* Cygwin b20.1 library converts NL to CR-NL
&gt; @@ -3167,11 +3169,14 @@
&gt;           break;
&gt;         default:
&gt;           warn&#40;&#34;Gnu.xs:_rl_store_iostream: Illegal `id&#39; value: `%d&#39;&#34;, id&#41;;
&gt; +         XSRETURN_UNDEF;
&gt;           break;
&gt;         }
&gt;         PerlIO_debug&#40;&#34;TRG:store_iostream id %d fd %d\n&#34;,
&gt; -                    id, PerlIO_fileno&#40;stream&#41;&#41;;
&gt; +                    id, PerlIO_fileno&#40;RETVAL&#41;&#41;;
&gt;       }
&gt; +     OUTPUT:
&gt; +     RETVAL
&gt;  
&gt;  #if 0 /* not used since 1.26 */
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;23&nbsp;03:56:21&nbsp;2015</span>
    <span class="description">HAYASHI [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;06&nbsp;05:34:33&nbsp;2015</span>
    <span class="description">HAYASHI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> ppisar [...] redhat.com, gabor [...] szabgab.com, bowtie [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have released Term::ReadLine::Gnu 1.27.
It does not include the fix for Debug-Client.pm on &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101078#txn-1463705&gt;">https://rt.cpan.org/Ticket/Display.html?id=101078#txn-1463705&gt;</a></span>.
If some of you think it is the bug in Term::ReadLine:Gnu, please open another ticket and answer my questions above.

Regards,

On Sun, 23 Aug 2015 07:56:14 GMT, HAYASHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dear Petr Pisar, Kevin Dawson, and Gabor Szabo,
&gt; 
&gt; I&#39;m working for releasing Term-ReadLine-Gnu 1.27.
&gt; 
&gt; I found that the fix for Debug-Client.pm caused warning messages on
&gt; the latest Perl 5.22.0;
&gt; 
<div class="message-stanza open">&gt; &gt; Warning: unable to close filehandle properly: Bad file descriptor
&gt; &gt; during global destruction.
</div>&gt; 
&gt; I am trying find a way to work with both Perl 5.22.0 and Debug-
&gt; Client.pm, but cannot find it yet.
&gt; 
&gt; I have some questions about Debug-Client.  Could you answer them for
&gt; me?
&gt; 
&gt; Q1. Does Debug-Client call Term-ReadLine[-Gnu]?
&gt; 
&gt; Are my following understandings correct?
&gt;  - Debug-Client does not call Term-ReadLine directly.
&gt;  - Debug-Client invoke perl debugger &#40;perl -d&#41; and it calls Term-
&gt; ReadLine.
&gt; 
&gt; I commented out the lines &#34;use Term::ReadLine;&#34; in Client.pm and t/00-
&gt; initialize.t.  It works well with Term-ReadLine-Gnu 1.26.
&gt; 
&gt; Q2. Is Term::ReadLine enough for Padre IDE?
&gt; 
&gt; Are my following understandings correct?
&gt;  - The primary use of Debug-Client is Padre IDE.
&gt;  - For the purpose it does not call perl debugger from a terminal.
&gt;  - For Padre IDE Term::ReadLine is enough, and Term::ReadLine::Gnu is
&gt; over-kill.
&gt; 
&gt; Q3. How does t/00-initialize.t call Term-ReadLine-Gnu?
&gt; 
&gt; As Petr Pisar reported, t/07-initialize.t hangs with Term-ReadLine-Gnu
&gt; 1.26.
&gt; It hangs at the line in _get&#40;&#41; function;
&gt;                 my $ret = $self-&gt;{socket}-&gt;sysread&#40; $buffer, 1024,
&gt; length $buffer &#41;;
&gt; 
&gt; I found this as follows;
&gt; ==========================================================
&gt; [hiroo@localhost Debug-Client-0.29]$ perl -d -Mblib t/07-initialize.t
&gt; 
&gt; Loading DB routines from perl5db.pl version 1.37
&gt; Editor support available.
&gt; 
&gt; Enter h or &#39;h h&#39; for help, or &#39;man perldebug&#39; for more help.
&gt; 
&gt; 1..4
&gt; main::&#40;t/07-initialize.t:5&#41;:    local $OUTPUT_AUTOFLUSH = 1;
&gt;   DB&lt;1&gt; c
&gt; ok 1 - initialize with prams
&gt; ^CDebug::Client::_get&#40;/tmp/Debug-Client-
&gt; 0.29/blib/lib/Debug/Client.pm:506&#41;:
&gt; 506:                    if &#40; not defined $ret &#41; {
&gt;   DB&lt;1&gt; c
&gt; Interrupted system call at t/07-initialize.t line 41.
&gt;  at /tmp/Debug-Client-0.29/blib/lib/Debug/Client.pm line 507.
&gt;         Debug::Client::_get&#40;&#39;Debug::Client=HASH&#40;0x12c00e8&#41;&#39;&#41; called at
&gt; /tmp/Debug-Client-0.29/blib/lib/Debug/Client.pm line 454
&gt;         Debug::Client::get&#40;&#39;Debug::Client=HASH&#40;0x12c00e8&#41;&#39;&#41; called at
&gt; /tmp/Debug-Client-0.29/blib/lib/Debug/Client.pm line 651
&gt;         Debug::Client::_send_get&#40;&#39;Debug::Client=HASH&#40;0x12c00e8&#41;&#39;, &#39;c&#39;&#41;
&gt; called at /tmp/Debug-Client-0.29/blib/lib/Debug/Client.pm line 218
&gt;         Debug::Client::run&#40;&#39;Debug::Client=HASH&#40;0x12c00e8&#41;&#39;&#41; called at
&gt; t/07-initialize.t line 41
&gt; ok 2 - quit with prams
&gt; ok 3 - initialize without prams
&gt; ^CDebug::Client::_get&#40;/tmp/Debug-Client-
&gt; 0.29/blib/lib/Debug/Client.pm:506&#41;:
&gt; 506:                    if &#40; not defined $ret &#41; {
&gt; ...
&gt; ==========================================================
&gt; 
&gt; By adding print message in my moudle, I found Term::ReadLine::Gnu::new
&gt; method is called but Term::ReadLine::Gnu::readline method is never
&gt; called during t/07-initizalize.t execution.
&gt; 
&gt; I cann&#39;t understand how Term-ReadLine-Gnu 1.26 causes the hang-up.
&gt; 
&gt; Above _get function, you wrote the following comment.
&gt; 
<div class="message-stanza open">&gt; &gt; # TODO shall we add a time-out and/or a number to count down the
&gt; &gt; number sysread calls that return 0 before deciding it is really done
</div>&gt; 
&gt; If you can fix this issue on your module, I can release Term-ReadLine-
&gt; Gnu 1.27 without the patch below.
&gt; 
&gt; 
&gt; Any clues are welcome.
&gt; 
&gt; Thanks in advance.
&gt; 
&gt; On Sat, 14 Feb 2015 14:55:25 GMT, HAYASHI wrote:
<div class="message-stanza open">&gt; &gt; Hi,
&gt; &gt;
&gt; &gt; Thank you for your report.
&gt; &gt;
&gt; &gt; On Thu, 12 Feb 2015 14:52:48 GMT, ppisar wrote:
<div class="message-stanza open">&gt; &gt; &gt; Dne Čt 12.úno.2015 09:51:59, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; &gt; &gt; I found this change causing a dead-lock in Debug-Client-0.29
&gt; &gt; &gt; &gt; tests
&gt; &gt; &gt; &gt; &#40;see &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/PadreIDE/Debug-Client/issues/1">https://github.com/PadreIDE/Debug-Client/issues/1</a></span>&gt;&#41;. I
&gt; &gt; &gt; &gt; don&#39;t
&gt; &gt; &gt; &gt; know which party is more guilty, but I observe that perl debugger
&gt; &gt; &gt; &gt; does
&gt; &gt; &gt; &gt; not emit &#34;DB&lt;1&gt;&#34; prompt if it is run from the Debug-Client&#39;s
&gt; &gt; &gt; &gt; test, so
&gt; &gt; &gt; &gt; it does not process client &#34;c&#34; command and everything halts.
</div>&gt; &gt; &gt;
&gt; &gt; &gt; I should note that I use perl 5.20.1.
</div>&gt; &gt;
&gt; &gt; Here is a fix.  I don&#39;t know why 1.26 fails or why this works.
&gt; &gt;
&gt; &gt; ===================================================================
&gt; &gt; --- Gnu.pm    &#40;revision 481&#41;
&gt; &gt; +++ Gnu.pm    &#40;working copy&#41;
&gt; &gt; @@ -725,9 +725,8 @@
&gt; &gt;      } elsif &#40;$type eq &#39;F&#39;&#41; {
&gt; &gt;       return _rl_store_function&#40;$value, $id&#41;;
&gt; &gt;      } elsif &#40;$type eq &#39;IO&#39;&#41; {
&gt; &gt; -     my $FH = $value;
&gt; &gt;       # Pass filehandles to the GNU Readline Library
&gt; &gt; -     _rl_store_iostream&#40;$FH, $id&#41;;
&gt; &gt; +     my $FH = _rl_store_iostream&#40;$value, $id&#41;;
&gt; &gt;       # pop stdio layer pushed by PerlIO_findFILE&#40;&#41;.
&gt; &gt;       # <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=59832">https://rt.cpan.org/Ticket/Display.html?id=59832</a></span>
&gt; &gt;       my @layers = PerlIO::get_layers&#40;$FH&#41;;
&gt; &gt; ===================================================================
&gt; &gt; --- Gnu.xs    &#40;revision 481&#41;
&gt; &gt; +++ Gnu.xs    &#40;working copy&#41;
&gt; &gt; @@ -3138,7 +3138,7 @@
&gt; &gt;         }
&gt; &gt;       }
&gt; &gt;
&gt; &gt; -void
&gt; &gt; +PerlIO *
&gt; &gt;  _rl_store_iostream&#40;stream, id&#41;
&gt; &gt;       PerlIO *stream
&gt; &gt;       int id
&gt; &gt; @@ -3148,9 +3148,11 @@
&gt; &gt;         switch &#40;id&#41; {
&gt; &gt;         case 0:
&gt; &gt;           rl_instream = PerlIO_findFILE&#40;stream&#41;;
&gt; &gt; +         RETVAL = stream;
&gt; &gt;           break;
&gt; &gt;         case 1:
&gt; &gt;           rl_outstream = PerlIO_findFILE&#40;stream&#41;;
&gt; &gt; +         RETVAL = stream;
&gt; &gt;  #ifdef __CYGWIN__
&gt; &gt;           {
&gt; &gt;             /* Cygwin b20.1 library converts NL to CR-NL
&gt; &gt; @@ -3167,11 +3169,14 @@
&gt; &gt;           break;
&gt; &gt;         default:
&gt; &gt;           warn&#40;&#34;Gnu.xs:_rl_store_iostream: Illegal `id&#39; value: `%d&#39;&#34;,
&gt; &gt; id&#41;;
&gt; &gt; +         XSRETURN_UNDEF;
&gt; &gt;           break;
&gt; &gt;         }
&gt; &gt;         PerlIO_debug&#40;&#34;TRG:store_iostream id %d fd %d\n&#34;,
&gt; &gt; -                    id, PerlIO_fileno&#40;stream&#41;&#41;;
&gt; &gt; +                    id, PerlIO_fileno&#40;RETVAL&#41;&#41;;
&gt; &gt;       }
&gt; &gt; +     OUTPUT:
&gt; &gt; +     RETVAL
&gt; &gt;
&gt; &gt; #if 0 /* not used since 1.26 */
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;06&nbsp;05:34:40&nbsp;2015</span>
    <span class="description">HAYASHI [...] cpan.org -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;09&nbsp;18:05:42&nbsp;2015</span>
    <span class="description">emmanuel [...] seyman.fr -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #101078] causes debugger to exit immediately on 5.21.7</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 10 Sep 2015 00:05:20 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Term-ReadLine-Gnu [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Emmanuel Seyman &lt;emmanuel [...] seyman.fr&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
I&#39;ve rebased Petr&#39;s patch for v1.27. Here is the result.

Emmanuel
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;10&nbsp;10:21:03&nbsp;2015</span>
    <span class="description">HAYASHI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve rebased Petr&#39;s patch for v1.27. Here is the result.
</div>
It was not Petr&#39;s patch.  It was my WRONG patch for Petr.

Please read my comments.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;23&nbsp;06:38:16&nbsp;2015</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne St 09.zář.2015 18:05:42, emmanuel@seyman.fr napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I&#39;ve rebased Petr&#39;s patch for v1.27. Here is the result.
&gt; 
</div>The port is missing final &#34;OUTPUT: RETVAL&#34; statement in Gnu.xs. Attached patch is a proper port.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Term-ReadLine-Gnu-1.27-Propagete-PerlIO_return_value_from_STORE.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From a70e0540b53a137a8b30cd4c2426c33e2c8e9720 Mon Sep 17 00:00:00 2001
From: HAYASHI &lt;HAYASHI@cpan.org&gt;
Date: Wed, 23 Sep 2015 12:22:23 +0200
Subject: [PATCH] Propagete PerlIO return value from STORE
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

On Thu, 12 Feb 2015 14:52:48 GMT, ppisar wrote:
&gt; Dne Ät 12.Ãºno.2015 09:51:59, ppisar napsal&#40;a&#41;:
&gt; &gt; I found this change causing a dead-lock in Debug-Client-0.29 tests
&gt; &gt; &#40;see &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/PadreIDE/Debug-Client/issues/1">https://github.com/PadreIDE/Debug-Client/issues/1</a></span>&gt;&#41;. I don&#39;t
&gt; &gt; know which party is more guilty, but I observe that perl debugger does
&gt; &gt; not emit &#34;DB&lt;1&gt;&#34; prompt if it is run from the Debug-Client&#39;s test, so
&gt; &gt; it does not process client &#34;c&#34; command and everything halts.
&gt;
&gt; I should note that I use perl 5.20.1.

Here is a fix.  I don&#39;t know why 1.26 fails or why this works.

Petr Pisar: Patch for 1.26 ported to 1.27.

CPAN RT#101078

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 Gnu.pm | 3 +--
 Gnu.xs | 9 +++++++--
 2 files changed, 8 insertions&#40;+&#41;, 4 deletions&#40;-&#41;

diff --git a/Gnu.pm b/Gnu.pm
index 4701589..298d567 100644
--- a/Gnu.pm
+++ b/Gnu.pm
@@ -734,9 +734,8 @@ sub STORE {
     } elsif &#40;$type eq &#39;F&#39;&#41; {
 	return _rl_store_function&#40;$value, $id&#41;;
     } elsif &#40;$type eq &#39;IO&#39;&#41; {
-	my $FH = $value;
 	# Pass filehandles to the GNU Readline Library
-	_rl_store_iostream&#40;$value, $id&#41;;
+	my $FH = _rl_store_iostream&#40;$value, $id&#41;;
 	# pop stdio layer pushed by PerlIO_findFILE&#40;&#41;.
 	# <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=59832">https://rt.cpan.org/Ticket/Display.html?id=59832</a></span>
 	my @layers = PerlIO::get_layers&#40;$FH&#41;;
diff --git a/Gnu.xs b/Gnu.xs
index cb91a2c..5bf0845 100644
--- a/Gnu.xs
+++ b/Gnu.xs
@@ -3147,7 +3147,7 @@ _rl_fetch_int&#40;id&#41;
 	  }
 	}
 
-void
+PerlIO *
 _rl_store_iostream&#40;stream, id&#41;
 	PerlIO *stream
 	int id
@@ -3157,9 +3157,11 @@ _rl_store_iostream&#40;stream, id&#41;
 	  switch &#40;id&#41; {
 	  case 0:
 	    rl_instream = PerlIO_findFILE&#40;stream&#41;;
+	    RETVAL = stream;
 	    break;
 	  case 1:
 	    rl_outstream = PerlIO_findFILE&#40;stream&#41;;
+	    RETVAL = stream;
 #ifdef __CYGWIN__
 	    {
 	      /* Cygwin b20.1 library converts NL to CR-NL
@@ -3176,11 +3178,14 @@ _rl_store_iostream&#40;stream, id&#41;
 	    break;
 	  default:
 	    warn&#40;&#34;Gnu.xs:_rl_store_iostream: Illegal `id&#39; value: `%d&#39;&#34;, id&#41;;
+	    XSRETURN_UNDEF;
 	    break;
 	  }
 	  PerlIO_debug&#40;&#34;TRG:store_iostream id %d fd %d\n&#34;,
-		       id, PerlIO_fileno&#40;stream&#41;&#41;;
+		       id, PerlIO_fileno&#40;RETVAL&#41;&#41;;
 	}
+     OUTPUT:
+	RETVAL
 
 #if 0 /* not used since 1.26 */
 
-- 
2.4.3

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;07&nbsp;10:24:11&nbsp;2015</span>
    <span class="description">HAYASHI [...] cpan.org -  Reference by ticket #110121 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
