<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #7272 for Net-Server: Net::Server t\Server_Fork fails on Win32</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #7272 for Net-Server: Net::Server t\Server_Fork fails on Win32</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-Server/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-Server/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-Server/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-Server/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-Server">Net-Server CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">7272</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-Server/Active/">Net-Server</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
tmetro [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-23138-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-23139-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;06&nbsp;03:06:26&nbsp;2004</span>
    <span class="description">tmetro [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 06 Aug 2004 02:31:22 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tom Metro &lt;tmetro [...] cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> paul [...] seamons.com, bbb [...] cpan.org, bug-Net-Server [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net::Server t\Server_Fork fails on Win32</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On my Win32 system &#40;Windows NT 4.0sp6a, perl, v5.8.0, 
MSWin32-x86-multi-thread, ActiveState build 806&#41; the test suite for 
Net::Server hangs on test 5 in Server_Fork. Looking at CPAN testers, it 
appears others have had problems on Win32 as well:

<span class="clickylink"><a target="new" rel="nofollow" href="http://testers.cpan.org/show/Net-Server.html#Net-Server-0.87">http://testers.cpan.org/show/Net-Server.html#Net-Server-0.87</a></span>

though the reported failures are different. I assume, given that earlier 
versions have passed tests on Win32, that the code is expected to work 
on Win32.

With a few clarifications, I might be able to determine why the test 
suite is failing on Win32.

Quoting from t\Server_Fork:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ### find some open ports
</div>[...]
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; my $start_port = 20200;
&gt; my $num_ports  = 1;
&gt; my @ports      = &#40;&#41;;
&gt; for my $i &#40;0..99&#41;{
&gt;   my $sock = IO::Socket::INET-&gt;new&#40;PeerAddr =&gt; &#39;localhost&#39;,
&gt;                                  PeerPort =&gt; &#40;$start_port + $i&#41;,
&gt;                                    Timeout  =&gt; 2,
&gt;                                  Proto    =&gt; &#39;tcp&#39;&#41;;
&gt;   push @ports, &#40;$start_port + $i&#41; if ! defined $sock;
&gt;   last if $num_ports == @ports;
&gt; }
</div>
This might work better if you tested to see if the port is free by 
seeing if you can bind to it, rather than connect to it. Otherwise the 
port you find might be a port that is blocked by a firewall &#40;which will 
fail later anyway&#41; or just a slow or non-responsive server &#40;in which 
case the bind will later fail&#41;. In my testing the code below seemed to 
also run faster.

Secondly, $sock is never explicitly freed &#40;and the port closed&#41;, though 
of course it goes out of scope once the &#39;for&#39; block is exited.


### find some open ports
my $start_port = 20200;
my $port_range = 99;
my $num_ports_needed = 1;
my @ports      = &#40;&#41;;
for my $port &#40;$start_port .. $start_port + $port_range&#41; {
   my $sock = IO::Socket::INET-&gt;new&#40;LocalPort =&gt; $port,
                                   Listen   =&gt; 1,
                                    Timeout  =&gt; 2,
                                   Proto    =&gt; &#39;tcp&#39;&#41;;
   push&#40;@ports, $port&#41; if defined $sock;
   $sock = undef;
   last if $num_ports_needed == @ports;
}


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; if&#40; $num_ports_needed == @ports &#41;{
&gt;   print &#34;ok 4\n&#34;;
&gt; }else{
&gt;   print &#34;not ok 4\n&#34;;
&gt; }
</div>
Might as well do:

[...]
}else{
   print &#34;not ok 4\n&#34;;
   print &#34;not ok 5\n&#34;;
   exit;
}


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;   eval {
&gt;     alarm $alarm;
</div>
alarm&#40;&#41; doesn&#39;t work on Win32. You can use the timeout attribute for the 
sockets and I&#39;d assume select&#40;&#41; on the pipe I/O.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     ### parent does the client
&gt;     if&#40; $pid &#41;{
&gt; 
&gt;       &lt;READ&gt;; ### wait until the child writes to us
&gt; 
&gt;       ### connect to child
&gt;       my $remote = IO::Socket::INET-&gt;new&#40;PeerAddr =&gt; &#39;localhost&#39;,
&gt;                                          PeerPort =&gt; $ports[0],
&gt;                                          Proto    =&gt; &#39;tcp&#39;&#41;;
</div>[...]
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       my $line = &lt;$remote&gt;;
&gt;       die unless $line =~ /Net::Server/;
&gt;       print $remote &#34;exit\n&#34;;
&gt; 
&gt;     ### child does the server
&gt;     }else{
&gt;       close STDERR;
&gt;       Net::Server::Test-&gt;run&#40;port =&gt; $ports[0],
&gt;                              setsid =&gt; 1,
&gt;                              &#41;;
&gt;       exit;
&gt;     }
</div>
So the flow here is...

fork-&gt;
  child                         parent
Net::Server::Test-&gt;run&#40;&#41;        wait for text over the pipe
  run&#40;&#41; calls accept&#40;&#41;
  accept&#40;&#41; writes to pipe       open socket to server
                                grabs a line
                                does it match /Net::Server/
                                send &#34;exit&#34;

Where&#39;s the code that implements the behavior on the server side that 
sends out &#34;Net::Server&#34; on connect and understands an &#34;exit&#34; command? I 
don&#39;t see a process_request&#40;&#41; in the Net::Server::Test subclass. Is this 
behavior part of a default implementation?

That aside, it appears that setsid =&gt; 1 is the culprit. It&#39;s side effect 
of closing off STDERR made it take longer to get to the bottom of 
things, but commenting out that attribute seems to allow the 5th test to 
pass, although the parent process still hangs &#40;it outputs &#34;Server 
closing!&#34;, but run&#40;&#41; doesn&#39;t return; it appears that accept&#40;&#41; gets 
called perpetually every minute or so&#41;.

Here&#39;s the output from a hacked up version of t\Server_Fork:

% perl -I../blib/lib Server_Fork.t
1..5
ok 1
ok 2
ok 3
Port: 20200
ok 4
PARENT: wait for pipe
CHILD: run server on port: 20200
2004/08/06-02:08:43 Net::Server::Test &#40;type Net::Server::Fork&#41; starting! 
pid&#40;-568&#41;
Binding to TCP port 20200 on host *
Group Not Defined.  Defaulting to EGID &#39;0&#39;
User Not Defined.  Defaulting to EUID &#39;0&#39;
CHILD: sending &#34;ready!&#34;
PARENT: connect to child
PARENT: read from child
CHILD: sending &#34;ready!&#34;
ok 5
2004/08/06-02:08:45 Server closing!
CHILD: sending &#34;ready!&#34;
CHILD: sending &#34;ready!&#34;
CHILD: sending &#34;ready!&#34;
CHILD: sending &#34;ready!&#34;
CHILD: sending &#34;ready!&#34;
CHILD: sending &#34;ready!&#34;
CHILD: sending &#34;ready!&#34;
CHILD: sending &#34;ready!&#34;
CHILD: sending &#34;ready!&#34;
CHILD: sending &#34;ready!&#34;
CHILD: sending &#34;ready!&#34;
CHILD: sending &#34;ready!&#34;
CHILD: sending &#34;ready!&#34;
CHILD: sending &#34;ready!&#34;
CHILD: sending &#34;ready!&#34;
CHILD: sending &#34;ready!&#34;
Terminating on signal SIGINT&#40;2&#41;


On a side note, the run&#40;&#41; method doesn&#39;t seem to be formally documented, 
even though it is frequently referenced in the man page. Likewise for 
process_request&#40;&#41;.

  -Tom
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;23&nbsp;03:44:06&nbsp;2005</span>
    <span class="description">paul [...] seamons.com -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
