<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #5282 for GDGraph: [PATCH] Infinite loop in GD::Graph::axestype::_best_ends</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #5282 for GDGraph: [PATCH] Infinite loop in GD::Graph::axestype::_best_ends</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/GDGraph/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/GDGraph/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/GDGraph/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/GDGraph/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/GDGraph">GDGraph CPAN distribution</a>.</p>


<h3>Maintainer&#40;s&#41;&#39; notes</h3>

<p>There are plenty of good ideas of what people can do published here on the queue. Turning a patch from the tracker into a pull request is not one of them. In order to get maintainers' attention way more quickier, PR should have at least a sample included. We know it's hard to test images generating software, but it doesn't mean we can not test numbers produced by intermediate algorithms used to generate these images, so either a test or a sample.</p>



<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">5282</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/GDGraph/Active/">GDGraph</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">bwarfield [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
geofft [...] remasys.com

<br />
imush [...] mail.ru

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-14346-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.43    </td>
  </tr>
  <tr id="CF-14347-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.4305    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;10&nbsp;23:58:31&nbsp;2004</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] Infinite loop in GD::Graph::axestype::_best_ends</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Distribution: GDGraph 1.43
File: axestype.pm &#40;revision 1.44&#41;

Description:
When the min and max values for the y-axis are both negative, halving the minimum and increasing the maximum by 50% results in a minimum greater than the maximum, giving a negative range.  This leads to an infinite loop in the sub _best_ends at the following line:

    1651     while &#40;$s &gt; $range&#41; { $s /= 10 }

as $s is never going to become negative, just closer and closer to zero.  The patch below resolves this issue.

--- axestype.pm.orig    2003-12-09 17:06:53.000000000 +1100
+++ axestype.pm 2004-02-11 15:42:07.000000000 +1100
@@ -1622,15 +1622,15 @@
 
     my &#40;$best_min, $best_max, $best_num&#41; = &#40;$min, $max, 1&#41;;
 
+    # Check that min and max are not the same, and not 0
+    &#40;$min, $max&#41; = &#40;$min != 0&#41; ? &#40;$min * 0.5, $min * 1.5&#41; : &#40;-1,1&#41;
+        if &#40;$max == $min&#41;;
+    
     # mgjv - Sometimes, for odd values, and only one data set, this will be
     # necessary _after_ the previous step, not before. Data sets of one
     # long with negative values were causing infinite loops later on.
     &#40;$min, $max&#41; = &#40;$max, $min&#41; if &#40;$min &gt; $max&#41;;
 
-    # Check that min and max are not the same, and not 0
-    &#40;$min, $max&#41; = &#40;$min != 0&#41; ? &#40;$min * 0.5, $min * 1.5&#41; : &#40;-1,1&#41;
-        if &#40;$max == $min&#41;;
-    
     my @n = ref&#40;$n_ref&#41; ? @$n_ref : $n_ref;
 
     if &#40;@n &lt;= 0&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;11&nbsp;19:10:45&nbsp;2006</span>
    <span class="description">bwarfield [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;11&nbsp;19:10:46&nbsp;2006</span>
    <span class="description">bwarfield [...] cpan.org -  Given to BWARFIELD</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;11&nbsp;19:10:47&nbsp;2006</span>
    <span class="description">bwarfield [...] cpan.org -  Fixed in 1.4305 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;30&nbsp;12:55:20&nbsp;2007</span>
    <span class="description">imush [...] mail.ru - Ticket #25975:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> hang in axestype.pm when the y-range is a single negative value point</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">To reproduce:

#!/usr/bin/perl -w
use GD::Graph::lines;
my $g = GD::Graph::lines-&gt;new&#40;1200, 300&#41;;

my $data = [
  [ &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;],
  [ -1, -1, -1, -1 ]
];

print $g-&gt;plot&#40;$data&#41;-&gt;png;



The following code in axestype.pm &#40;sub _best_ends&#41; seems to bear the blame:

...
    # mgjv - Sometimes, for odd values, and only one data set, this will be
    # necessary _after_ the previous step, not before. Data sets of one
    # long with negative values were causing infinite loops later on.
    &#40;$min, $max&#41; = &#40;$max, $min&#41; if &#40;$min &gt; $max&#41;;

    # Check that min and max are not the same, and not 0
    &#40;$min, $max&#41; = &#40;$min&#41; ? &#40;$min * 0.5, $min * 1.5&#41; : &#40;-1,1&#41;
        if &#40;$max == $min&#41;;
...

This fails when $min==$max and they are negative, because later on 

...
    my $range = $max - $min;

    # create array of interval sizes
    my $s = 1;
    while &#40;$s &lt; $range&#41; { $s *= 10 }
    while &#40;$s &gt; $range&#41; { $s /= 10 }  #### &lt;&lt;&lt;&lt; we are stuck here
...


My fix for this is to do the artificial range widening first, and then
swap if necessary:

...
    # Do this first if we have a constant graph
    &#40;$min, $max&#41; = &#40;$min&#41; ? &#40;$min * 0.5, $min * 1.5&#41; : &#40;-1,1&#41;
        if &#40;$max == $min&#41;;

    # Swap if we ended up with inverted &#40;min, max&#41;
    &#40;$min, $max&#41; = &#40;$max, $min&#41; if &#40;$min &gt; $max&#41;;
...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;30&nbsp;12:59:50&nbsp;2007</span>
    <span class="description">imush [...] mail.ru - Ticket #25975:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> imush [...] mail.ru</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry, if my marking this &#39;critical&#39; sounds like yelling in your face. I
 dod not mean that and cannot find how to downgrade it now. But the bug
did cause my process to hang, so it was critical to me.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;01&nbsp;01:39:47&nbsp;2007</span>
    <span class="description">bwarfield [...] cpan.org - Ticket #25975:  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;01&nbsp;01:39:50&nbsp;2007</span>
    <span class="description">bwarfield [...] cpan.org - Ticket #25975:  Severity Critical changed to Important</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;15&nbsp;01:14:12&nbsp;2007</span>
    <span class="description">bwarfield [...] cpan.org - Ticket #25975:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As far as I can tell, this bug is not present in the current version &#40;1.4308&#41;, the lines you mention 
having been changed &#40;your test script breaks for me under 1.43, but not 1.4308&#41;.  Upgrading 
should solve your problem.  If you do actually have 1.4308 installed, please check to make sure 
that it&#39;s being used by the code that produces this error--this bug should be fixed since 
1.4305.

On Fri Mar 30 12:59:50 2007, imush wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sorry, if my marking this &#39;critical&#39; sounds like yelling in your face. I
&gt;  dod not mean that and cannot find how to downgrade it now. But the bug
&gt; did cause my process to hang, so it was critical to me.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;17&nbsp;09:22:04&nbsp;2007</span>
    <span class="description">bwarfield [...] cpan.org - Ticket #25975:  Merged into ticket #5282</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;17&nbsp;09:22:04&nbsp;2007</span>
    <span class="description">bwarfield [...] cpan.org -  Merged into ticket #5282</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
