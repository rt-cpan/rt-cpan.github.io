<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #31721 for File-Path: rmtree: &#34;evil this way comes&#34; unnecessarily</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #31721 for File-Path: rmtree: &#34;evil this way comes&#34; unnecessarily</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/File-Path/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/File-Path/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/File-Path/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/File-Path/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/File-Path">File-Path CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">31721</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">4/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/File-Path/Active/">File-Path</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">dland [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
alan [...] pair.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-43556-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.04    </td>
  </tr>
  <tr id="CF-43557-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.05    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;19&nbsp;13:58:37&nbsp;2007</span>
    <span class="description">alan [...] pair.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rmtree: &#34;evil this way comes&#34; unnecessarily</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 19 Dec 2007 13:58:15 -0500 &#40;EST&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-File-Path [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Alan Ferrency &lt;alan [...] pair.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

I was inadvertantly able to invoke the fatal error &#34;cannot chdir to
[parent-dir] from [child-dir]: [errmsg], aborting.&#34; error, in a fairly
trivial way.

In short: if your cwd is inside the tree you&#39;re running rmtree&#40;&#41; on, the
error above will occur.

I don&#39;t know whether this should be considered a bug in the code, a bad
error message for this particular case, or an instance of &#34;don&#39;t do
that, it&#39;s dumb&#34; &#40;which may want to be mentioned in the pod alongside
&#34;evil this way comes.&#34;&#41;

I&#39;d consider updating the code to use modern error handling, but this is
happening implicitly when File::Temp&#39;s cleanup&#40;&#41; calls rmtree&#40;&#41;, and I
don&#39;t have control over File::Temp. In any case, I know my real solution
is &#34;don&#39;t do that, it&#39;s dumb,&#34; which I will implement now that I
understand the problem.

A short .t, below, demonstrates the problem. On perl 5.10 and File::Path
2.04, I get:

        Failed 5/7 tests, 28.57% okay
Failed Test     Stat Wstat Total Fail  List of Failed
-------------------------------------------------------------------------------
t/6_file_path.t    5  1280     7    5  1-2 5-7


Thanks!

Alan Ferrency
pair Networks, Inc.
alan@pair.com

#---------------

use strict;
use warnings;

use Test::More tests =&gt; 7;

use File::Path;

my $test_dir = &#34;/tmp/foo&#34;;

ok !-e $test_dir, &#34;ensure our test directory doesn&#39;t exist&#34;;
ok mkdir&#40;$test_dir, 777&#41;, &#34;make test directory&#34;;
ok mkdir&#40;&#34;$test_dir/bar&#34;, 777&#41;, &#34;make test subdirectory&#34;;
ok chdir&#40;&#34;$test_dir/bar&#34;&#41;, &#34;enter test subdirectory&#34;;
ok eval { rmtree&#40;$test_dir&#41; }, &#34;rmtree the test directory&#34;;
ok !$@ or diag &#34;rmtree died: $@&#34;, &#34;no error in rmtree&#34;;
ok !-e $test_dir, &#34;test directory doesn&#39;t exist&#34;;


#------------------
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;20&nbsp;08:10:00&nbsp;2007</span>
    <span class="description">dland [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dland [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 19 13:58:37 2007, alan@pair.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello,
&gt; 
&gt; I was inadvertantly able to invoke the fatal error &#34;cannot chdir to
&gt; [parent-dir] from [child-dir]: [errmsg], aborting.&#34; error, in a fairly
&gt; trivial way.
&gt; 
&gt; In short: if your cwd is inside the tree you&#39;re running rmtree&#40;&#41; on,
&gt; the
&gt; error above will occur.
</div>
Ah yes, indeed it will. This is fall-out from the race condition fix. 

Consider a huge directory tree under /foo/bar/rat/quux, and delete from
./quux onwards. If another process moved quux to under foo directly,
rmtree could have begun to delete the contents of bar as well.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I don&#39;t know whether this should be considered a bug in the code, a
&gt; bad
&gt; error message for this particular case, or an instance of &#34;don&#39;t do
&gt; that, it&#39;s dumb&#34; &#40;which may want to be mentioned in the pod alongside
&gt; &#34;evil this way comes.&#34;&#41;
</div>
I think it&#39;s safe to say that it falls under the banner of  &#34;doctor, it
hurts when I do this&#34;.

Then again, if you can do it, so can someone else. A first level of
defence would be to ask whether the cwd is the same as the directory to
be rmtree&#39;ed. In which case, we just have to set &#39;keep_root&#39; to 1 and
let the code go its merry way. Perhaps spitting out a warning at the
same time.

I&#39;ll have to think about whether there&#39;s anything sane that can be done
if someone wants to do the equivalent of rmtree&#40;&#39;../../&#39;&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;d consider updating the code to use modern error handling, but this
&gt; is
&gt; happening implicitly when File::Temp&#39;s cleanup&#40;&#41; calls rmtree&#40;&#41;, and I
&gt; don&#39;t have control over File::Temp. In any case, I know my real
&gt; solution
&gt; is &#34;don&#39;t do that, it&#39;s dumb,&#34; which I will implement now that I
&gt; understand the problem.
</div>
I&#39;ll get in touch with the current File::Temp maintainer and see if they
can make it smarter about deleting from the parent instead of itself.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; A short .t, below, demonstrates the problem. On perl 5.10 and
&gt; File::Path
</div>
A bug report with a test suite, bless you sir! I&#39;ll make use of it in
some way.

Thanks for the report, I&#39;ll see what I can do.

Regards,
David Landgren
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;20&nbsp;08:10:02&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;20&nbsp;10:54:25&nbsp;2007</span>
    <span class="description">alan [...] pair.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #31721] rmtree: &#34;evil this way comes&#34; unnecessarily</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 20 Dec 2007 10:54:00 -0500 &#40;EST&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> David Landgren via RT &lt;bug-File-Path [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Alan Ferrency &lt;alan [...] pair.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, 20 Dec 2007, David Landgren via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=31721">http://rt.cpan.org/Ticket/Display.html?id=31721</a></span> &gt;
&gt;
<div class="message-stanza open">&gt; &gt; I&#39;d consider updating the code to use modern error handling, but
&gt; &gt; this is happening implicitly when File::Temp&#39;s cleanup&#40;&#41; calls
&gt; &gt; rmtree&#40;&#41;, and I don&#39;t have control over File::Temp. In any case, I
&gt; &gt; know my real solution is &#34;don&#39;t do that, it&#39;s dumb,&#34; which I will
&gt; &gt; implement now that I understand the problem.
</div>&gt;
&gt; I&#39;ll get in touch with the current File::Temp maintainer and see if they
&gt; can make it smarter about deleting from the parent instead of itself.
</div>
Well, it was me, not File::Temp, which was chdir&#39;ing into the temp
directory, so I&#39;m pretty sure this isn&#39;t their fault/problem.

But in this case, it feels questionable whether I did something truly
unreasonable or not... only once I understood why it failed, did I
consider it particularly bad.

From my perspective, it looked like:
- create a temporary directory with File::Temp
- chdir into the directory
- do stuff
- exit

It was only during File::Temp&#39;s implicit &#34;cleanup&#34; step at END time that
the problem showed up.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; A short .t, below, demonstrates the problem. On perl 5.10 and
&gt; &gt; File::Path
</div>&gt;
&gt; A bug report with a test suite, bless you sir!
</div>
No problem :&#41; That&#39;s how I found the exact issue that I originally
thought was in my code...

Alan Ferrency
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;07&nbsp;16:10:43&nbsp;2008</span>
    <span class="description">MSCHILLI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> MSCHILLI [...] cpan.org</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I had a similar issue, looks like there&#39;s two possible solutions if
someone does something like this:

    mkpath&#40;&#34;/tmp/foo/bar&#34;&#41;;
    chdir&#40;&#34;/tmp/foo/bar&#34;&#41;;
    rmtree&#40;&#34;/tmp/foo&#34;&#41;;

which will cause the somewhat confusing

   cannot chdir to /tmp/foo/bar from /tmp/foo:

error:

1&#41; Report the error up-front
2&#41; Change the cwd&#40;&#41; to the directory containing the tree to be rmtree&#40;&#41;d.

While 2&#41; would be the most convenient, it might be confusing to the user
who all of a sudden ends up in a different directory without warning. As
for 1&#41;, please find a simple fix attached. 

-- Mike Schilli
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- File-Path-2.04/Path.pm	2007-11-13 03:54:49.000000000 -0800
+++ File-Path-2.04.patched/Path.pm	2008-02-07 13:01:18.000000000 -0800
@@ -177,6 +177,13 @@
     };
     for &#40;$arg-&gt;{cwd}&#41; { /\A&#40;.*&#41;\Z/; $_ = $1 } # untaint
 
+    for my $path &#40;@$paths&#41; {
+        if&#40;$arg-&gt;{cwd} =~ /^$path/&#41; {
+            _error&#40;$arg, &#34;cannot delete $path while cwd is $arg-&gt;{cwd}&#34;&#41;;
+            return 0;
+        }
+    }
+
     @{$arg}{qw&#40;device inode&#41;} = &#40;stat $arg-&gt;{cwd}&#41;[0,1] or do {
         _error&#40;$arg, &#34;cannot stat initial working directory&#34;, $arg-&gt;{cwd}&#41;;
         return 0;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;07&nbsp;16:36:20&nbsp;2008</span>
    <span class="description">alan [...] pair.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #31721] rmtree: &#34;evil this way comes&#34; unnecessarily</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 7 Feb 2008 16:14:04 -0500 &#40;EST&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Michael_Schilli via RT &lt;bug-File-Path [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Alan Ferrency &lt;alan [...] pair.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">If it is possible to detect &#34;Perl is in the END {} times&#34; &#40;in the
process of shutting everything down&#41;, then I would be more likely to
prefer #2 at least in in this case. But really it seems likely more
trouble than it&#39;s worth.

Alan

On Thu, 7 Feb 2008, Michael_Schilli via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=31721">http://rt.cpan.org/Ticket/Display.html?id=31721</a></span> &gt;
&gt;
&gt; I had a similar issue, looks like there&#39;s two possible solutions if
&gt; someone does something like this:
&gt;
&gt;     mkpath&#40;&#34;/tmp/foo/bar&#34;&#41;;
&gt;     chdir&#40;&#34;/tmp/foo/bar&#34;&#41;;
&gt;     rmtree&#40;&#34;/tmp/foo&#34;&#41;;
&gt;
&gt; which will cause the somewhat confusing
&gt;
&gt;    cannot chdir to /tmp/foo/bar from /tmp/foo:
&gt;
&gt; error:
&gt;
&gt; 1&#41; Report the error up-front
&gt; 2&#41; Change the cwd&#40;&#41; to the directory containing the tree to be rmtree&#40;&#41;d.
&gt;
&gt; While 2&#41; would be the most convenient, it might be confusing to the user
&gt; who all of a sudden ends up in a different directory without warning. As
&gt; for 1&#41;, please find a simple fix attached.
&gt;
&gt; -- Mike Schilli
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;07&nbsp;17:59:31&nbsp;2008</span>
    <span class="description">dland [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dland [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Feb 07 16:36:20 2008, alan@pair.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If it is possible to detect &#34;Perl is in the END {} times&#34; &#40;in the
&gt; process of shutting everything down&#41;, then I would be more likely to
&gt; prefer #2 at least in in this case. But really it seems likely more
&gt; trouble than it&#39;s worth.
</div>
The infrastructure is there to do it:

END {
    f&#40;&#41;
}

sub f {
    my @c = caller&#40;1&#41;;
    print &#34;called by $c[3]\n&#34;;
}

One would just have to walk up the call stack and see if there&#39;s an END
block there.

What makes me hesitate is symlinks. If you&#39;re in a child directory that
is symlinked in from elsewhere, asking to rmtree&#40;&#41; the parent might not
delete what you thought it would, or worse, it might delete what you
thought it wouldn&#39;t. I guess it depends on whether the fact that
rmtree&#40;&#41; will delete a symlink rather than trying to read it is what you
expected.

My personal opinion, not that it amounts to much, is a feeling that it
is wrong to try and delete your own directory out from under you. Where
are you afterwards?

Still, that&#39;s two people bitten in a few months. There&#39;s obviously
something not right with the interface as things stand.

I think I would rather add a flag &#39;updir&#39; =&gt; 1 which would instruct
rmtree to chdir up out out the directory tree it was being asked to
delete. If you want to do something semantically ambiguous I think you
should say so.

David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;07&nbsp;18:39:55&nbsp;2008</span>
    <span class="description">alan [...] pair.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #31721] rmtree: &#34;evil this way comes&#34; unnecessarily</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 7 Feb 2008 18:36:18 -0500 &#40;EST&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> David Landgren via RT &lt;bug-File-Path [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Alan Ferrency &lt;alan [...] pair.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello again,

On Thu, 7 Feb 2008, David Landgren via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; One would just have to walk up the call stack and see if there&#39;s an
&gt; END block there.
</div>
I didn&#39;t only mean an explicit END{} block. I intended to include all
cases where &#34;it&#39;s the end of the program, therefore I don&#39;t care what my
cwd is after this operation.&#34;

For example: if we&#39;re in an object DESTROY call which is implicitly
called at end-of-program, silently ignoring the problem may be okay, but
if we&#39;re in a DESTROY implicitly called at the end of a lexical scope,
generating an error is more appropriate.

&#40;My real preference is to not treat this as an error condition in any
cases, however.&#41;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What makes me hesitate is symlinks. If you&#39;re in a child directory that
&gt; is symlinked in from elsewhere, asking to rmtree&#40;&#41; the parent might not
&gt; delete what you thought it would, or worse, it might delete what you
&gt; thought it wouldn&#39;t. I guess it depends on whether the fact that
&gt; rmtree&#40;&#41; will delete a symlink rather than trying to read it is what you
&gt; expected.
</div>
I think I&#39;m confused. If you expect rmtree&#40;&#41; to behave differently than
it does behave, how does it matter what your cwd happens to be?

It seems to me, you&#39;re describing 2 separate problems:

1. people may not have proper expectations w.r.t rmtree and symlinks.
2. rmtree considers it an error if your cwd is inside the tree
   you&#39;re rm&#39;ing.

However, I don&#39;t think that detecting case 2 is really enough to
prevent case 1 from causing problems.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; My personal opinion, not that it amounts to much, is a feeling that it
&gt; is wrong to try and delete your own directory out from under you.
&gt; Where are you afterwards?
</div>
I have my own opinions, though they&#39;re also not necessarily worth much.


If the program is about to end, then it mostly doesn&#39;t matter what your
cwd is afterwards. &#40;It does matter if not-run-yet END code needs a
working directory.&#41; That&#39;s the source of my compromise above for
ignoring the error at least in the &#34;end of the world&#34; scenario.


However:

In general, I don&#39;t chdir&#40;&#41;. I treat the current working directory as
a global variable which I have no control over. I consider it
suspicious if anyone calls chdir&#40;&#41;, and I prefer to always use full
paths whenever possible.

It&#39;s never truly safe to assume your cwd is valid or unchanged, after
calling someone else&#39;s code. Perl doesn&#39;t &#40;and can&#39;t&#41; provide a &#34;local&#34;-
like way to preserve cwd: cases such as the one we&#39;re describing make it
impossible.

Not only that: at any time, any process on the machine can remove your
current working directory or move it around. It&#39;s _never_ truly safe to
assume that if you chdir&#40;&#41; to a directory, it will be there at the time
your next operation runs &#40;except possibly on systems with OS-enforced
file locking&#41;.

Therefore, I say: give the programmer enough rope to hang themselves.
It&#39;s easy to recover from &#34;I just deleted my cwd:&#34; do a chdir&#40;&#41; after
the call to rmtree&#40;&#41; instead of before the call to rmtree&#40;&#41;.

If you program defensively and always use full paths, then you&#39;re
insulated from problems with your cwd disappearing or changing without
your knowledge.


&#40;In my current case, I was using chdir, and I got bitten by it: more
evidence for my preference. Unfortunately, I don&#39;t think I can avoid
this particular use of chdir, but I also don&#39;t think it would be a Real
problem if File::Temp rmtree&#39;d my cwd at end-of-perl time.&#41;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think I would rather add a flag &#39;updir&#39; =&gt; 1 which would instruct
&gt; rmtree to chdir up out out the directory tree it was being asked to
&gt; delete. If you want to do something semantically ambiguous I think you
&gt; should say so.
</div>
I&#39;m not sure this would be very useful. If you know that what you&#39;re
doing is going to cause this problem, then you can already preempt it
by using a chdir&#40;&#41; prior to your rmtree&#40;&#41; call. That&#39;s how I solved
my problem.


I guess my main point is: Yes, I put myself in the position of removing
my own cwd, and yes it&#39;s easy to prevent or repair this without changing
rmtree&#40;&#41; at all.

I just think it shouldn&#39;t have been a problem in the first place.


I&#39;m fine if this is considered &#34;not a bug.&#34; In my initial RT report, I
mainly just wanted to point out that it&#39;s not as uncommon as it may have
seemed at the time.


Thanks!

Alan Ferrency
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;06&nbsp;05:39:32&nbsp;2008</span>
    <span class="description">dland [...] cpan.org -  Priority changed from &#40;no value&#41; to &#39;4&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;06&nbsp;05:41:29&nbsp;2008</span>
    <span class="description">dland [...] cpan.org -  Given to DLAND</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;07&nbsp;03:26:28&nbsp;2008</span>
    <span class="description">dland [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Feb 07 16:10:43 2008, MSCHILLI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I had a similar issue, looks like there&#39;s two possible solutions if
&gt; someone does something like this:
&gt; 
&gt;     mkpath&#40;&#34;/tmp/foo/bar&#34;&#41;;
&gt;     chdir&#40;&#34;/tmp/foo/bar&#34;&#41;;
&gt;     rmtree&#40;&#34;/tmp/foo&#34;&#41;;
</div>
The more I think about it, the more I like this patch. It stops the
program from dying &#40;since that is a last-ditch attempt to prevent a race
condition&#41;. Adding a conditional to prevent innocuous code from
triggering what should be &#34;can&#39;t-happen&#34; code is a good idea.

Thanks for the patch, I&#39;ll probably go with a substr, but the concept is
sound.

Thanks,
David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;08&nbsp;09:09:58&nbsp;2008</span>
    <span class="description">dland [...] cpan.org -  Severity Important added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;08&nbsp;09:09:58&nbsp;2008</span>
    <span class="description">dland [...] cpan.org -  Fixed in 2.05 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;08&nbsp;09:09:58&nbsp;2008</span>
    <span class="description">dland [...] cpan.org -  Broken in 2.04 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;08&nbsp;09:12:50&nbsp;2008</span>
    <span class="description">dland [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The module now gracefully complains about removing a directory tree if
the cwd is within the tree, rather than aborting.

This fixed in 2.05, but that release will fail during testing if
Test::Output is not installed. Otherwise you should install 2.06, which
contains a fix for another bug that Gisle Aas encountered last night.

Thanks for your feedback,
David Landgren
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;08&nbsp;09:12:53&nbsp;2008</span>
    <span class="description">dland [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
