<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #12383 for Maypole: MP::Application doesn&#39;t work with MasonX::Maypole [patch]</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #12383 for Maypole: MP::Application doesn&#39;t work with MasonX::Maypole [patch]</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Maypole/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Maypole/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Maypole/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Maypole/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Maypole">Maypole CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">12383</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Maypole/Active/">Maypole</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dave [...] riverside-cms.co.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-21076-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.09    </td>
  </tr>
  <tr id="CF-21077-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.10    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;22&nbsp;20:35:46&nbsp;2005</span>
    <span class="description">cpan.zerofive [...] googlemail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> MP::Application doesn&#39;t work with MasonX::Maypole [patch]</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I sent an ugly hack to simon a while ago, but it was pretty poor. This patch is better, so you can just say 

use Maypole::Application qw&#40; -MasonX &#41;;

The format is diff -u

--- /usr/local/lib/perl5/site_perl/5.8.6/Maypole/Application.pm Tue Jan 25 21:53:08 2005
+++ /home/dave/distributions/Maypole-Application/lib/Maypole/Application.pm     Sat Apr 23 01:03:33 2005
@@ -13,6 +13,23 @@
     my &#40; $class, @plugins &#41; = @_;
     my $caller = caller&#40;0&#41;;
 
+    my &#40; $frontend, $masonx &#41;;
+    
+    $frontend = &#39;Apache::MVC&#39; if $ENV{MOD_PERL};
+    
+    if &#40; grep { /^\-MasonX$/ } @plugins &#41;
+    {
+        $masonx++;
+        @plugins = grep { ! /^\-MasonX$/ } @plugins;
+        $frontend = &#39;MasonX::Maypole&#39;;
+    }
+    
+    $frontend ||= &#39;CGI::Maypole&#39;;
+    
+    # should die here, not warn, but die is silent for some reason
+    $frontend-&gt;require or warn &#34;Loading $frontend frontend failed: $@&#34;;
+    push @ISA, $frontend;
+
     my $autosetup=0;
     my @plugin_modules;
     {
@@ -40,16 +57,8 @@
     no strict &#39;refs&#39;;
     push @{&#34;${caller}::ISA&#34;}, @plugin_modules, $class;
     $caller-&gt;config&#40;Maypole::Config-&gt;new&#41;;
+    $caller-&gt;config-&gt;masonx&#40;{}&#41; if $masonx;
     $caller-&gt;setup&#40;&#41; if $autosetup;
-}
-
-if &#40; $ENV{MOD_PERL} &#41; {
-    Apache::MVC-&gt;require or die &#34;Loading Apache frontend failed: $@&#34;;
-    push @ISA, &#39;Apache::MVC&#39;;
-}
-else {
-    CGI::Maypole-&gt;require or die &#34;Loading CGI frontend failed: $@&#34;;
-    push @ISA, &#39;CGI::Maypole&#39;;
 }
 
 1;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;24&nbsp;20:45:14&nbsp;2005</span>
    <span class="description">cpan.zerofive [...] googlemail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[DAVEBAIRD - Fri Apr 22 20:35:46 2005]:

Just realised the regex probably shouldn&#39;t match -MasonX, but should
match MasonX, as it&#39;s more like a plugin than a switch.

d. 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I sent an ugly hack to simon a while ago, but it was pretty poor. This
&gt; patch is better, so you can just say
&gt; 
&gt; use Maypole::Application qw&#40; -MasonX &#41;;
&gt; 
&gt; The format is diff -u
&gt; 
&gt; --- /usr/local/lib/perl5/site_perl/5.8.6/Maypole/Application.pm       Tue
&gt; Jan 25 21:53:08 2005
&gt; +++ /home/dave/distributions/Maypole-
&gt; Application/lib/Maypole/Application.pm        Sat Apr 23 01:03:33 2005
&gt; @@ -13,6 +13,23 @@
&gt;      my &#40; $class, @plugins &#41; = @_;
&gt;      my $caller = caller&#40;0&#41;;
&gt; 
&gt; +    my &#40; $frontend, $masonx &#41;;
&gt; +
&gt; +    $frontend = &#39;Apache::MVC&#39; if $ENV{MOD_PERL};
&gt; +
&gt; +    if &#40; grep { /^\-MasonX$/ } @plugins &#41;
&gt; +    {
&gt; +        $masonx++;
&gt; +        @plugins = grep { ! /^\-MasonX$/ } @plugins;
&gt; +        $frontend = &#39;MasonX::Maypole&#39;;
&gt; +    }
&gt; +
&gt; +    $frontend ||= &#39;CGI::Maypole&#39;;
&gt; +
&gt; +    # should die here, not warn, but die is silent for some reason
&gt; +    $frontend-&gt;require or warn &#34;Loading $frontend frontend failed:
&gt; $@&#34;;
&gt; +    push @ISA, $frontend;
&gt; +
&gt;      my $autosetup=0;
&gt;      my @plugin_modules;
&gt;      {
&gt; @@ -40,16 +57,8 @@
&gt;      no strict &#39;refs&#39;;
&gt;      push @{&#34;${caller}::ISA&#34;}, @plugin_modules, $class;
&gt;      $caller-&gt;config&#40;Maypole::Config-&gt;new&#41;;
&gt; +    $caller-&gt;config-&gt;masonx&#40;{}&#41; if $masonx;
&gt;      $caller-&gt;setup&#40;&#41; if $autosetup;
&gt; -}
&gt; -
&gt; -if &#40; $ENV{MOD_PERL} &#41; {
&gt; -    Apache::MVC-&gt;require or die &#34;Loading Apache frontend failed: $@&#34;;
&gt; -    push @ISA, &#39;Apache::MVC&#39;;
&gt; -}
&gt; -else {
&gt; -    CGI::Maypole-&gt;require or die &#34;Loading CGI frontend failed: $@&#34;;
&gt; -    push @ISA, &#39;CGI::Maypole&#39;;
&gt;  }
&gt; 
&gt;  1;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;28&nbsp;05:00:15&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Me again. The comment in the last patch about die not working turns out
to be a bug somewhere in my own app, not Maypole. So here&#39;s another
patch. This also has a couple of things I find useful. Warnings mention
the class of the caller, which is useful if you run multiple Maypole
apps. Failed plugin loads die instead of warn. And multiple debug levels
are supported, useful for instance in Maypole::Plugin::AutoUntaint.

Regards,

d.


--- /usr/local/lib/perl5/site_perl/5.8.6/Maypole/Application.pm Tue Jan
25 21:53:08 2005
+++
/home/dave/distributions/Maypole-Application/lib/Maypole/Application.pm
Thu Apr 28 09:45:40 2005
@@ -12,26 +12,42 @@
 sub import {
     my &#40; $class, @plugins &#41; = @_;
     my $caller = caller&#40;0&#41;;
+    
+    my $frontend = &#39;Apache::MVC&#39; if $ENV{MOD_PERL};
+    
+    my $masonx;
+    if &#40; grep { /^MasonX$/ } @plugins &#41;
+    {
+        $masonx++;
+        @plugins = grep { ! /^MasonX$/ } @plugins;
+        $frontend = &#39;MasonX::Maypole&#39;;
+    }
+    
+    $frontend ||= &#39;CGI::Maypole&#39;;
+    
+    $frontend-&gt;require or die &#34;Loading $frontend frontend failed: $@&#34;;
+    push @ISA, $frontend;
 
     my $autosetup=0;
     my @plugin_modules;
     {
         foreach &#40;@plugins&#41; {
             if    &#40;/^\-Setup$/&#41; { $autosetup++; }
-            elsif &#40;/^\-Debug$/&#41; {
+            elsif &#40;/^\-Debug&#40;\d*&#41;$/&#41; {
+                my $d = $1 || 1;
                 no strict &#39;refs&#39;;
-                *{&#34;$caller\::debug&#34;} = sub { 1 };
-                warn &#34;Debugging enabled&#34;;
+                *{&#34;$caller\::debug&#34;} = sub { $d };
+                warn &#34;Debugging &#40;level $d&#41; enabled for $caller&#34;;
             }
             elsif &#40;/^-.*$/&#41; { warn &#34;Unknown flag: $_&#34; }
             else {
                 my $plugin = &#34;Maypole::Plugin::$_&#34;;
                 if &#40;$plugin-&gt;require&#41; {
                     push @plugin_modules, &#34;Maypole::Plugin::$_&#34;;
-                    warn &#34;Loaded plugin: $plugin&#34;
+                    warn &#34;Loaded plugin: $plugin for $caller&#34;
                         if $caller-&gt;can&#40;&#39;debug&#39;&#41; &#38;&#38; $caller-&gt;debug;
                 } else {
-                    warn qq&#40;Loading plugin &#34;$plugin&#34; failed: &#41;
+                    die qq&#40;Loading plugin &#34;$plugin&#34; for $caller failed: &#41;
                         . $UNIVERSAL::require::ERROR;
                 }
             }
@@ -40,18 +56,10 @@
     no strict &#39;refs&#39;;
     push @{&#34;${caller}::ISA&#34;}, @plugin_modules, $class;
     $caller-&gt;config&#40;Maypole::Config-&gt;new&#41;;
+    $caller-&gt;config-&gt;masonx&#40;{}&#41; if $masonx;
     $caller-&gt;setup&#40;&#41; if $autosetup;
 }
 
-if &#40; $ENV{MOD_PERL} &#41; {
-    Apache::MVC-&gt;require or die &#34;Loading Apache frontend failed: $@&#34;;
-    push @ISA, &#39;Apache::MVC&#39;;
-}
-else {
-    CGI::Maypole-&gt;require or die &#34;Loading CGI frontend failed: $@&#34;;
-    push @ISA, &#39;CGI::Maypole&#39;;
-}
-
 1;
 
 =head1 NAME
@@ -68,9 +76,11 @@
 
     use Maypole::Application qw&#40;Config::YAML Loader -Setup -Debug&#41;;
 
+    use Maypole::Application qw&#40;-Debug2 MasonX AutoUntaint&#41;;
+
 =head1 DESCRIPTION
 
-This is a universal frontend for mod_perl1, mod_perl2 and CGI.
+This is a universal frontend for mod_perl1, mod_perl2, HTML::Mason and CGI.
 
 You can omit the Maypole::Plugin:: prefix from plugins.
 So Maypole::Plugin::Config::YAML becomes Config::YAML.
@@ -105,6 +115,8 @@
 
     use Maypole::Application;
     sub debug { 1 }
+
+You can specify a higher debug level by saying C&lt;-Debug2&gt; etc. 
 
 =head1 AUTHOR
 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;29&nbsp;14:35:08&nbsp;2005</span>
    <span class="description">TEEJAY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> TeeJay</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Thu Apr 28 05:00:15 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Me again. The comment in the last patch about die not working turns
&gt;    out
&gt; to be a bug somewhere in my own app, not Maypole. So here&#39;s another
&gt; patch. This also has a couple of things I find useful. Warnings
&gt;    mention
&gt; the class of the caller, which is useful if you run multiple Maypole
&gt; apps. Failed plugin loads die instead of warn. And multiple debug
&gt;    levels
&gt; are supported, useful for instance in Maypole::Plugin::AutoUntaint.
</div>
Patch applied to SVN, now in revision 340

A
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;02&nbsp;10:14:13&nbsp;2005</span>
    <span class="description">TEEJAY [...] cpan.org -  Fixed in 2.10 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;02&nbsp;10:14:24&nbsp;2005</span>
    <span class="description">TEEJAY [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
