<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #11813 for Storable: Storable incompatible with singleton classes</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #11813 for Storable: Storable incompatible with singleton classes</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Storable/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Storable/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Storable/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Storable/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="http://rt.perl.org/perlbug/">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Storable">Storable CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">11813</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Storable/Active/">Storable</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cpan [...] ali.as

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-29856-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.13    </td>
  </tr>
  <tr id="CF-29857-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;09&nbsp;00:04:45&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Storable incompatible with singleton classes</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Storable spuriously creates illegal blessed hash references in STORABLE_thaw.

This bug is related to bug #4901 and bug #6641, and will be fixed if point 2&#41; from bug #6641 is implemented, but I&#39;m adding it here as a seperate case, primarily because I&#39;ve encapsulared the issue as a test case you can add to the Storable dist.

------------------------------------------------
singleton.t
------------------------------------------------

#!/usr/bin/perl -w

# Tests the freezing/thawing structures containing Singleton objects,
# which should see both structs pointing to the same object.

# In order to make this test work, ANY method needs to exist that can
# be used in STORABLE_freeze and STORABLE_thaw in order to make the tests
# pass.

use Storable &#40;&#41;;
use Test::More tests =&gt; 7;

# Get the singleton
my $object = My::Singleton-&gt;new;
isa_ok&#40; $object, &#39;My::Singleton&#39; &#41;;

# Confirm &#40;for the record&#41; that the class is actually a Singleton
my $object2 = My::Singleton-&gt;new;
isa_ok&#40; $object2, &#39;My::Singleton&#39; &#41;;
is&#40; &#34;$object&#34;, &#34;$object2&#34;, &#39;Class is a singleton&#39; &#41;;

############
# Main Tests

my $struct = [ 1, $object, 3 ];

# Freeze the struct
my $frozen = Storable::freeze&#40; $struct &#41;;
ok&#40; &#40;defined&#40;$frozen&#41; and ! ref&#40;$frozen&#41; and length&#40;$frozen&#41;&#41;, &#39;freeze returns a string&#39; &#41;;

# Thaw the struct
my $thawed = Storable::thaw&#40; $frozen &#41;;

# Now it should look exactly like the original
is_deeply&#40; $struct, $thawed, &#39;Struct superficially looks like the original&#39; &#41;;

# ... EXCEPT that the Singleton should be the same instance of the object
is&#40; &#34;$struct-&gt;[1]&#34;, &#34;$thawed-&gt;[1]&#34;, &#39;Singleton thaws correctly&#39; &#41;;

# We can also test this empirically
$struct-&gt;[1]-&gt;{value} = &#39;Goodbye cruel world!&#39;;
is_deeply&#40; $struct, $thawed, &#39;Empiric testing corfirms correct behaviour&#39; &#41;;

# End Tests
###########

package My::Singleton;

my $SINGLETON = undef;

sub new {
        $SINGLETON or
        $SINGLETON = bless { value =&gt; &#39;Hello World!&#39; }, $_[0];
}

sub STORABLE_freeze {
        my $self = shift;

        # We don&#39;t actually need to return anything, but provide a null string
        # to avoid the null-list-return behaviour.
        return &#40;&#39;&#39;&#41;;
}

sub STORABLE_thaw {
        my &#40;$obj, $string&#41; = @_;

        # Get the Singleton object
        my $self = My::Singleton-&gt;new;

        ### IS THERE ANY POSSIBLE CODE FOR STORABLE_thaw THAT CAN
        ### BE USED TO PASS THE TESTS???
        ### LET&#39;S TRY TO DOCUMENTED WAY OF CREATING THE OBJECT
        %$obj = %$self;

        return;
}

# This one would work under the proposed changes to Storable
sub STORABLE_thaw_new {
        My::Singleton-&gt;new;
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;10&nbsp;04:03:55&nbsp;2005</span>
    <span class="description">RAM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Indeed, you&#39;ve hit a limitation of the Storable engine.

Fixing this to get the correct behavior requires great care because the
reason Storable creates objects for you to fill is that it handles all
the cross-referencing between ojects to make sure the proper topology is
recreated.

If you want to insist that a particular object instantiated by Storable
be replaced by a singleton instance, then you need to inform the core
about that.  It&#39;s not practical to let STORABLE_thaw return an object of
youts, because when the singleton reference was serialized, it pointed
to some objects &#40;maybe&#41; that will be deserialized as well later on &#40;or
were already re-instantiated&#41;, unless you made your own custom
STORABLE_freeze hook to supersede the default serialization.

Patching the structure after is has been completely instantiated could
be an option, but it may require a retraversal of the whole thing to
break the references to the &#34;singleton&#34; and force them to point back to
your instance.  A way to inform the Storable core about that would be to
call the core from within STORABLE_thaw and inform it about the fact
that the object requires special treatment.

A &#34;cleanup&#34; phase on the the structure recreated could then be performed
whenever this core routine was called during deserialization, so as to
not impose a penalty on the regular cases -- I mean, the problem you&#39;ve
hit is genuine but is not something all that common.

My humble comments as the original author.  I&#39;ve not been following the
recent developments of Perl, so maybe all what precedes is just stupid
and irrelevant.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;10&nbsp;06:17:42&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> cpan [...] ali.as</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Indeed, you&#39;ve hit a limitation of the Storable engine.
&gt; 
&gt; Fixing this to get the correct behavior requires great care
</div>
Correct. You might want to take a look at bug #4901, where most of the
ongoing conversation relating to the changes that will be needed is
being discussed.

Fortunately, I&#39;m not a strange to complex topology algorithms, since
I&#39;ve written some before to deal with manipulation of arbitrarily
complex relational database data sets.

After various comments from people here and in #perl, I think we have an
idea for what will be needed, and I&#39;ll be whiteboarded up some sample
topologies to have a play shortly.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
