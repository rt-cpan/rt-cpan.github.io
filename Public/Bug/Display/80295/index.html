<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #80295 for DBD-SQLite: Can&#39;t load SQLite::VirtualTable extension via DBD::SQLite</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #80295 for DBD-SQLite: Can&#39;t load SQLite::VirtualTable extension via DBD::SQLite</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-SQLite/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-SQLite">DBD-SQLite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">80295</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-SQLite/Active/">DBD-SQLite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
BENBOOTH [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10248-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.38_01    </td>
  </tr>
  <tr id="CF-10249-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;19&nbsp;17:50:39&nbsp;2012</span>
    <span class="description">BENBOOTH [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Can&#39;t load SQLite::VirtualTable extension via DBD::SQLite</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">When I try to load the SQLite::VirtualTable extension module using &#34;select 
load_extension&#40;&#39;perlvtab.so&#39;&#41;&#34;, the next time I try to execute another query, the program exits 
and I get the following error message:

Can&#39;t make DBI com handle for DBD::SQLite::st: unknown package.

Running the same commands under the sqlite3 shell does not have this problem.

I attached a test case that demonstrates the problem. I have only tried it with the 
SQLite::VirtualTable extension module. I have tested it on ArchLinux 64-bit and Mac OS X 10.8 
64-bit.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl
use DBI;
use File::Temp;
use Text::CSV;
use strict;
use warnings;

my $dbh = DBI-&gt;connect&#40;&#34;dbi:SQLite::memory:&#34;, undef, undef, { 
    RaiseError=&gt;1, 
    PrintError=&gt;1,
  }&#41;;

# load the virtual table extension
$dbh-&gt;sqlite_enable_load_extension&#40;1&#41;;
my $libname = shift || &#39;/usr/local/lib/perlvtab.so&#39;;
my $sth;
$sth = $dbh-&gt;prepare&#40;&#39;select load_extension&#40;&#39;.$dbh-&gt;quote&#40;$libname&#41;.&#39;&#41;&#39;&#41;;
$sth-&gt;execute;

my $sth2 = $dbh-&gt;prepare&#40;&#39;create table t &#40;c1 text&#41;;&#39;&#41;;
$sth2-&gt;execute;
ok&#40;1&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;19&nbsp;22:38:40&nbsp;2012</span>
    <span class="description">ishigaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi. Could you also check a few things?

1&#41; Does sqlite_load_extension&#40;&#41; &#40;introduced in 1.38_01&#41; work for you?

2&#41; Have you SQLite::VirtualTable compiled with &#34;correct&#34; &#40;or at least 
recent enough&#41; sqlite3 headers? The module seems to use system-
installed headers, but they are not always the same as used to build 
DBD::SQLite &#40;compare $DBD::SQLite::sqlite_version and `sqlite3 -
version`&#41;.



On Sat Oct 20 06:50:39 2012, BENBOOTH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; When I try to load the SQLite::VirtualTable extension module using
&gt; &#34;select
&gt; load_extension&#40;&#39;perlvtab.so&#39;&#41;&#34;, the next time I try to execute another
&gt; query, the program exits
&gt; and I get the following error message:
&gt; 
&gt; Can&#39;t make DBI com handle for DBD::SQLite::st: unknown package.
&gt; 
&gt; Running the same commands under the sqlite3 shell does not have this
&gt; problem.
&gt; 
&gt; I attached a test case that demonstrates the problem. I have only
&gt; tried it with the
&gt; SQLite::VirtualTable extension module. I have tested it on ArchLinux
&gt; 64-bit and Mac OS X 10.8
&gt; 64-bit.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;19&nbsp;22:38:41&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;25&nbsp;13:43:06&nbsp;2012</span>
    <span class="description">BENBOOTH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry it took so long to reply:

On Fri Oct 19 22:38:40 2012, ISHIGAKI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi. Could you also check a few things?
&gt; 
&gt; 1&#41; Does sqlite_load_extension&#40;&#41; &#40;introduced in 1.38_01&#41; work for you?
</div>
No, I get the same error:

Can&#39;t make DBI com handle for DBD::SQLite::st: unknown package.

I attached the modified version of test.pl which uses sqlite_load_extension&#40;&#41;.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 2&#41; Have you SQLite::VirtualTable compiled with &#34;correct&#34; &#40;or at least 
&gt; recent enough&#41; sqlite3 headers? The module seems to use system-
&gt; installed headers, but they are not always the same as used to build 
&gt; DBD::SQLite &#40;compare $DBD::SQLite::sqlite_version and `sqlite3 -
&gt; version`&#41;.
</div>
Here are the versions on Mac OS X 10.8.2:

$ sqlite3 --version
3.7.14 2012-09-03 15:42:36 c0d89d4a9752922f9e367362366efde4f1b06f2a

$ perl -MDBD::SQLite -le &#39;print $DBD::SQLite::sqlite_version&#39;
3.7.14

And on my up-to-date ArchLinux machine:

$ sqlite3 --version
3.7.14.1 2012-10-04 19:37:12 091570e46d04e84b67228e0bdbcd6e1fb60c6bdb

$ perl -MDBD::SQLite -le &#39;print $DBD::SQLite::sqlite_version&#39;
3.7.14

Ben

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 
&gt; 
&gt; On Sat Oct 20 06:50:39 2012, BENBOOTH wrote:
<div class="message-stanza open">&gt; &gt; When I try to load the SQLite::VirtualTable extension module using
&gt; &gt; &#34;select
&gt; &gt; load_extension&#40;&#39;perlvtab.so&#39;&#41;&#34;, the next time I try to execute another
&gt; &gt; query, the program exits
&gt; &gt; and I get the following error message:
&gt; &gt; 
&gt; &gt; Can&#39;t make DBI com handle for DBD::SQLite::st: unknown package.
&gt; &gt; 
&gt; &gt; Running the same commands under the sqlite3 shell does not have this
&gt; &gt; problem.
&gt; &gt; 
&gt; &gt; I attached a test case that demonstrates the problem. I have only
&gt; &gt; tried it with the
&gt; &gt; SQLite::VirtualTable extension module. I have tested it on ArchLinux
&gt; &gt; 64-bit and Mac OS X 10.8
&gt; &gt; 64-bit.
</div>&gt; 
&gt; 
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl
use Test::Simple tests=&gt;1;
use DBI;
use File::Temp;
use Text::CSV;
use strict;
use warnings;

my $dbh = DBI-&gt;connect&#40;&#34;dbi:SQLite::memory:&#34;, undef, undef, { 
    RaiseError=&gt;1, 
    PrintError=&gt;1,
  }&#41;;

# load the virtual table extension
$dbh-&gt;sqlite_enable_load_extension&#40;1&#41;;
my $libname = shift || &#39;/usr/local/lib/perlvtab.so&#39;;
$dbh-&gt;sqlite_load_extension&#40;$libname&#41;;

my $sth2 = $dbh-&gt;prepare&#40;&#39;create table t &#40;c1 text&#41;;&#39;&#41;;
$sth2-&gt;execute;
ok&#40;1&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;13&nbsp;13:49:21&nbsp;2012</span>
    <span class="description">BENBOOTH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Oct 25 13:43:06 2012, BENBOOTH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; 1&#41; Does sqlite_load_extension&#40;&#41; &#40;introduced in 1.38_01&#41; work for
</div>&gt; you?
&gt; 
&gt; No, I get the same error:
&gt; 
&gt; Can&#39;t make DBI com handle for DBD::SQLite::st: unknown package.
</div>
After some further investigation, I realized that SQLite::VirtualTable is spawning its own perl 
interpreter. I think what&#39;s happening is that, for some reason, having two perl interpreters 
running in the same process is causing perl to throw weird errors and terminate. The two perl 
interpreters are somehow stepping on each other and that&#39;s why it keeps failing. I filed a bug 
report with the SQLite::VirtualTable author, but got no response. 

It seems like perl supports having multiple interpreters in the same process, so I&#39;m not sure 
which module is at fault here, or whether this is a bug in perl itself.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;13&nbsp;14:35:06&nbsp;2012</span>
    <span class="description">BENBOOTH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I tracked down the problem to SQLite::VirtualTable not using Perl_get_context&#40;&#41; and 
PERL_SET_CONTEXT to switch contexts between the main perl interpreter and the interpreter it 
spawns. I wrote a patch and submitted it to the bug report for SQLite::VirtualTable. Since this 
problem isn&#39;t caused by DBD::SQLite I will close this ticket.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;13&nbsp;14:35:08&nbsp;2012</span>
    <span class="description">BENBOOTH [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
