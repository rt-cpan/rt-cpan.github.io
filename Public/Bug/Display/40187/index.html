<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #40187 for libwww-perl: URGENT! https problem starting from 5.816</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #40187 for libwww-perl: URGENT! https problem starting from 5.816</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/libwww-perl/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/libwww-perl/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/libwww-perl/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/libwww-perl/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/libwww-perl">libwww-perl CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">40187</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/libwww-perl/Active/">libwww-perl</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cpan-070814 [...] bilteks.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-18330-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
5.815</li>
<li>
5.816</li>
<li>
5.817</li>
<li>
5.818</li>
</ul>
    </td>
  </tr>
  <tr id="CF-18331-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;20&nbsp;04:49:43&nbsp;2008</span>
    <span class="description">cpan-070814 [...] bilteks.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> URGENT! https problem starting from 5.816</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 20 Oct 2008 11:48:56 +0300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-libwww-perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Alexander Kirpa&#34; &lt;cpan-070814 [...] bilteks.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi All!

Last working edition 5.814
Perl 5.8.8/5.10.0
FreeBSD i386 5.3/7.0

Problem: data corruption &#40;lost some characters&#41; during processing 
https respond
Workaround: downgrade libwww editions 5.818-5.816 to 5.814 edition.

Test commands: 
lwp-download 
&#34;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Dist/libwww-perl/Active/">https://rt.cpan.org/Public/Dist/Display.html?Name=libwww-perl</a></span>&#34; https-
rt-cpan
lwp-download &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Dist/libwww-/Active/">http://rt.cpan.org/Public/Dist/Display.html?Name=libwww-</a></span>
perl&#34; http-rt-cpan

Results for edition 5.814:
-rw-r--r--  1 root  wheel  36441 Oct 20 11:32 http-rt-cpan
-rw-r--r--  1 root  wheel  36441 Oct 20 11:32 https-rt-cpan

Results for edition 5.818:
-rw-r--r--  1 root  wheel  36441 Oct 20 11:33 http-rt-cpan
-rw-r--r--  1 root  wheel  16746 Oct 20 11:33 https-rt-cpan

Best regards,
 Alexander Kirpa
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;20&nbsp;07:46:36&nbsp;2008</span>
    <span class="description">GAAS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This was indeed an ugly one, but it&#39;s not really tied to https at all, but to memory allocation 
patterns.  I&#39;ve now applied the attached patch and uploaded 5.819 with this fix to CPAN.

Thanks for catching this!
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">commit af111a4327d4dfc4750e022c1a20adc803a75fbf
Author: Gisle Aas &lt;gisle@aas.no&gt;
Date:   Mon Oct 20 13:14:48 2008 +0200

    Wrong content handlers would sometimes be skipped [RT#40187]
    
    The handler filtering in LWP::Protocol::collect depends on stable
    handler hashes, but we did not provide that for handlers associated
    directly with the response object.  The result was that handlers
    was skipped randomly based on memory allocation patterns.

diff --git a/lib/LWP/Protocol.pm b/lib/LWP/Protocol.pm
index b4ec93a..792e9a6 100644
--- a/lib/LWP/Protocol.pm
+++ b/lib/LWP/Protocol.pm
@@ -103,19 +103,25 @@ sub collect
         elsif &#40;!ref&#40;$arg&#41; &#38;&#38; length&#40;$arg&#41;&#41; {
             open&#40;my $fh, &#34;&gt;&#34;, $arg&#41; || die &#34;Can&#39;t write to &#39;$arg&#39;: $!&#34;;
 	    binmode&#40;$fh&#41;;
-            push&#40;@{$response-&gt;{handlers}{response_data}}, sub {
-                print $fh $_[3] || die &#34;Can&#39;t write to &#39;$arg&#39;: $!&#34;;
-                1;
-            }&#41;;
-            push&#40;@{$response-&gt;{handlers}{response_done}}, sub {
-                close&#40;$fh&#41; || die &#34;Can&#39;t write to &#39;$arg&#39;: $!&#34;;
-                undef&#40;$fh&#41;;
+            push&#40;@{$response-&gt;{handlers}{response_data}}, {
+                callback =&gt; sub {
+                    print $fh $_[3] || die &#34;Can&#39;t write to &#39;$arg&#39;: $!&#34;;
+                    1;
+                },
             }&#41;;
+            push&#40;@{$response-&gt;{handlers}{response_done}}, {
+                callback =&gt; sub {
+		    close&#40;$fh&#41; || die &#34;Can&#39;t write to &#39;$arg&#39;: $!&#34;;
+		    undef&#40;$fh&#41;;
+		},
+	    }&#41;;
         }
         elsif &#40;ref&#40;$arg&#41; eq &#39;CODE&#39;&#41; {
-            push&#40;@{$response-&gt;{handlers}{response_data}}, sub {
-                &#38;$arg&#40;$_[3], $_[0], $self&#41;;
-                1;
+            push&#40;@{$response-&gt;{handlers}{response_data}}, {
+                callback =&gt; sub {
+		    &#38;$arg&#40;$_[3], $_[0], $self&#41;;
+		    1;
+                },
             }&#41;;
         }
         else {
@@ -125,10 +131,12 @@ sub collect
         $ua-&gt;run_handlers&#40;&#34;response_header&#34;, $response&#41;;
 
         if &#40;delete $response-&gt;{default_add_content}&#41; {
-            push&#40;@{$response-&gt;{handlers}{response_data}}, sub {
-                $_[0]-&gt;add_content&#40;$_[3]&#41;;
-                1;
-            }&#41;;
+            push&#40;@{$response-&gt;{handlers}{response_data}}, {
+		callback =&gt; sub {
+		    $_[0]-&gt;add_content&#40;$_[3]&#41;;
+		    1;
+		},
+	    }&#41;;
         }
 
 
diff --git a/lib/LWP/UserAgent.pm b/lib/LWP/UserAgent.pm
index 5fb3982..1ac12eb 100644
--- a/lib/LWP/UserAgent.pm
+++ b/lib/LWP/UserAgent.pm
@@ -618,10 +618,12 @@ sub parse_head {
                $parser-&gt;xml_mode&#40;1&#41; if $response-&gt;content_is_xhtml;
                $parser-&gt;utf8_mode&#40;1&#41; if $] &gt;= 5.008 &#38;&#38; $HTML::Parser::VERSION &gt;= 3.40;
 
-               push&#40;@{$response-&gt;{handlers}{response_data}}, sub {
-                   return unless $parser;
-                   $parser-&gt;parse&#40;$_[3]&#41; or undef&#40;$parser&#41;;
-               }&#41;;
+               push&#40;@{$response-&gt;{handlers}{response_data}}, {
+		   callback =&gt; sub {
+		       return unless $parser;
+		       $parser-&gt;parse&#40;$_[3]&#41; or undef&#40;$parser&#41;;
+		   },
+	       }&#41;;
 
             } : undef,
             m_media_type =&gt; &#34;html&#34;,
@@ -770,7 +772,7 @@ sub handlers {
     my&#40;$self, $phase, $o&#41; = @_;
     my @h;
     if &#40;$o-&gt;{handlers} &#38;&#38; $o-&gt;{handlers}{$phase}&#41; {
-        push&#40;@h, map +{ callback =&gt; $_ }, @{$o-&gt;{handlers}{$phase}}&#41;;
+        push&#40;@h, @{$o-&gt;{handlers}{$phase}}&#41;;
     }
     if &#40;my $conf = $self-&gt;{handlers}{$phase}&#41; {
         push&#40;@h, $conf-&gt;matching&#40;$o&#41;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;20&nbsp;07:46:43&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;20&nbsp;07:46:47&nbsp;2008</span>
    <span class="description">GAAS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;20&nbsp;07:48:11&nbsp;2008</span>
    <span class="description">GAAS [...] cpan.org -  Severity Critical added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;20&nbsp;07:48:13&nbsp;2008</span>
    <span class="description">GAAS [...] cpan.org -  Broken in 5.815 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;20&nbsp;07:48:13&nbsp;2008</span>
    <span class="description">GAAS [...] cpan.org -  Broken in 5.816 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;20&nbsp;07:48:13&nbsp;2008</span>
    <span class="description">GAAS [...] cpan.org -  Broken in 5.817 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;20&nbsp;07:48:13&nbsp;2008</span>
    <span class="description">GAAS [...] cpan.org -  Broken in 5.818 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
