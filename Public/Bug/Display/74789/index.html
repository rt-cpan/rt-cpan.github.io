<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #74789 for Module-Runtime: require_module needs to work around the perl 5.8 %INC pollution bug</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #74789 for Module-Runtime: require_module needs to work around the perl 5.8 %INC pollution bug</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Module-Runtime/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Module-Runtime/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Module-Runtime/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Module-Runtime/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Module-Runtime">Module-Runtime CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">74789</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Module-Runtime/Active/">Module-Runtime</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ribasushi [...] leporine.io

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21732-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21733-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;08&nbsp;15:08:13&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> require_module needs to work around the perl 5.8 %INC pollution bug</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is just a placeholder ticket to reference by tickets filed against
dependencies. A patch fixing this has been submitted to author and is
also attached to this ticket.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Make-require_module-aware-of-INC-pollution-bug-prese.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 4ce1feef9ba07a3bb482e10100c6e076bb0d3e58 Mon Sep 17 00:00:00 2001
From: Peter Rabbitson &lt;ribasushi@cpan.org&gt;
Date: Wed, 8 Feb 2012 11:58:26 +0100
Subject: [PATCH] Make require_module&#40;&#41; aware of %INC pollution bug present on
 perl &lt;= 5.8

---
 Changes               |    3 ++
 lib/Module/Runtime.pm |   32 ++++++++++++++++++++++-
 t/ModExc.pm           |   11 ++++++++
 t/ModFalse.pm         |    9 ++++++
 t/rm.t                |   66 +++++++++++++++++++++++++++++++++++++++++++++++-
 5 files changed, 117 insertions&#40;+&#41;, 4 deletions&#40;-&#41;
 create mode 100644 t/ModExc.pm
 create mode 100644 t/ModFalse.pm

diff --git a/Changes b/Changes
index 54849fe..ce4fb1e 100644
--- a/Changes
+++ b/Changes
@@ -1,4 +1,7 @@
   * convert .cvsignore to .gitignore
+  * bugfix: require_module&#40;&#41; now maintains correct %INC on perl
+    versions older than 5.10. See t/rm.t for extensive discussion
+    of the problem
 
 version 0.011; 2011-10-24
 
diff --git a/lib/Module/Runtime.pm b/lib/Module/Runtime.pm
index b41889e..2570987 100644
--- a/lib/Module/Runtime.pm
+++ b/lib/Module/Runtime.pm
@@ -203,8 +203,36 @@ sub require_module&#40;$&#41; {
 	# statically, doesn&#39;t have this problem, because the op flags
 	# are forced to scalar.
 	return scalar&#40;require&#40;&#38;module_notional_filename&#41;&#41;;
+	use constant _OUR_REQUIRE_CALL_LINE =&gt; __LINE__ - 1;
 }
 
+# Wrap a safety blanket to guard against the perl &lt; 5.10 %INC bug.
+# This simply restores the semantics of require&#40;&#41; wrt %INC state
+# as described in perlop &#40;see t/rm.t for details&#41;:
+#
+# Done with this weird redefinition to avoid incurring eval-wrap
+# penalties on newer perl versions
+#
+# FIXME: this does not take in consideration 5.9, neither do tests
+# I do not know when the bug is fixed exactly, not sure it matters
+# either.
+#
+BEGIN { if &#40;$] &lt; &#39;5.010&#39;&#41; {
+	my $old_req_mod = \&#38;require_module;
+	local &#40;$@, $SIG{__DIE__}&#41;;
+	no warnings &#39;redefine&#39;;
+	eval &lt;&lt;&#39;EOC&#39;;
+	sub require_module&#40;$&#41; {
+		my $ret = eval { &#38;$old_req_mod };
+		if &#40;$@ ne &#39;&#39;&#41; {
+			delete $INC{&#38;module_notional_filename};
+			die $@;
+		}
+		return $ret;
+	}
+EOC
+}}
+
 =back
 
 =head2 Structured module use
@@ -267,10 +295,10 @@ function work just like L&lt;/use_module&gt;.
 sub use_package_optimistically&#40;$;$&#41; {
 	my&#40;$name, $version&#41; = @_;
 	check_module_name&#40;$name&#41;;
-	eval { local $SIG{__DIE__}; require&#40;module_notional_filename&#40;$name&#41;&#41;; };
+	eval { local $SIG{__DIE__}; require_module&#40;$name&#41; };
 	die $@ if $@ ne &#34;&#34; &#38;&#38; $@ !~ /\A
 		Can&#39;t\ locate\ .+\ at
-		\ \Q@{[__FILE__]}\E\ line\ \Q@{[__LINE__-1]}\E
+		\ \Q@{[__FILE__]}\E\ line\ \Q@{[_OUR_REQUIRE_CALL_LINE]}\E
 	/xs;
 	$name-&gt;VERSION&#40;$version&#41; if defined $version;
 	return $name;
diff --git a/t/ModExc.pm b/t/ModExc.pm
new file mode 100644
index 0000000..3e39761
--- /dev/null
+++ b/t/ModExc.pm
@@ -0,0 +1,11 @@
+package t::ModExc;
+
+{ use 5.006; }
+use warnings;
+use strict;
+
+our $VERSION = 1;
+
+die &#34;NO PASARAN!&#34;;
+
+1;
diff --git a/t/ModFalse.pm b/t/ModFalse.pm
new file mode 100644
index 0000000..cfa0920
--- /dev/null
+++ b/t/ModFalse.pm
@@ -0,0 +1,9 @@
+package t::ModFalse;
+
+{ use 5.006; }
+use warnings;
+use strict;
+
+our $VERSION = 1;
+
+0;  # by design
diff --git a/t/rm.t b/t/rm.t
index b203fd1..2577bbf 100644
--- a/t/rm.t
+++ b/t/rm.t
@@ -1,11 +1,25 @@
 use warnings;
 use strict;
 
-use Test::More tests =&gt; 9;
+# All perls before 5.010 &#40;not sure which 5.009xxx fixes the actual problem&#41;
+# have a bug when requiring a module which throws an exception &#40;syntax error
+# or otherwise&#41; in the process. While the exception is raised and properly
+# propagated the %INC{filename} entry is left incorrectly set, so a future
+# require of the same module will appear to have succeeded, since require
+# never retries to compile a module which has a proper %INC entry. To work
+# around this a require&#40;&#41; shim is compiled on perls with _HAS_INC_BUG, which
+# simply deletes the %INC entry. The deletion is necessary, because the buggy
+# behavior checks for existance of the %INC key, without checking the value.
+# In other words `$INC{&#34;foo.pm&#34;} = undef; require foo;` appears to work and
+# does not throw an exception unlike it does on perl 5.10+
+#
+use constant _HAS_INC_BUG =&gt; $] &lt; &#39;5.009999&#39;;
+
+use Test::More tests =&gt; _HAS_INC_BUG ? 33 : 34;
 
 BEGIN { use_ok &#34;Module::Runtime&#34;, qw&#40;require_module&#41;; }
 
-my&#40;$result, $err&#41;;
+my&#40;$result, $err, $inc&#41;;
 
 sub test_require_module&#40;$&#41; {
 	my&#40;$name&#41; = @_;
@@ -14,23 +28,71 @@ sub test_require_module&#40;$&#41; {
 }
 
 # a module that doesn&#39;t exist
+ok&#40;!exists $INC{&#39;t/NotExist.pm&#39;}&#41;;
 test_require_module&#40;&#34;t::NotExist&#34;&#41;;
 like&#40;$err, qr/^Can&#39;t locate /&#41;;
+is&#40;$result, undef&#41;;
+ok&#40;!exists $INC{&#39;t/NotExist.pm&#39;}, &#39;%INC unchanged after missing module&#39;&#41;;
 
 # a module that&#39;s already loaded
+ok&#40;$inc = $INC{&#39;Test/More.pm&#39;}&#41;;
 test_require_module&#40;&#34;Test::More&#34;&#41;;
 is&#40;$err, &#34;&#34;&#41;;
 is&#40;$result, 1&#41;;
+is&#40;$INC{&#39;Test/More.pm&#39;}, $inc, &#39;%INC unchanged after already loaded module&#39;&#41;;
 
 # a module that we&#39;ll load now
+ok&#40;!exists $INC{&#39;t/Mod0.pm&#39;}&#41;;
 test_require_module&#40;&#34;t::Mod0&#34;&#41;;
 is&#40;$err, &#34;&#34;&#41;;
 is&#40;$result, &#34;t::Mod0 return&#34;&#41;;
+like&#40;$INC{&#39;t/Mod0.pm&#39;}, qr/Mod0.pm$/&#41;;
 
 # re-requiring the module that we just loaded
+ok&#40;$inc = $INC{&#39;t/Mod0.pm&#39;}&#41;;
 test_require_module&#40;&#34;t::Mod0&#34;&#41;;
 is&#40;$err, &#34;&#34;&#41;;
 is&#40;$result, 1&#41;;
+is&#40;$INC{&#39;t/Mod0.pm&#39;}, $inc, &#39;%INC unchanged after already loaded module&#39;&#41;;
+
+# a module that returns false
+ok&#40;!exists $INC{&#39;t/ModFalse.pm&#39;}&#41;;
+test_require_module&#40;&#34;t::ModFalse&#34;&#41;;
+like&#40;$err, qr/\QModFalse.pm did not return a true value/&#41;;
+is&#40;$result, undef&#41;;
+ok&#40;!exists $INC{&#39;t/ModFalse.pm&#39;}, &#39;%INC unchanged after false-returning module load&#39;&#41;;
+
+# re-requiring a module that returns false
+ok&#40;!exists $INC{&#39;t/ModFalse.pm&#39;}&#41;;
+test_require_module&#40;&#34;t::ModFalse&#34;&#41;;
+like&#40;$err, qr/\QModFalse.pm did not return a true value/&#41;;
+is&#40;$result, undef&#41;;
+ok&#40;!exists $INC{&#39;t/ModFalse.pm&#39;}, &#39;%INC unchanged after false-returning module reload&#39;&#41;;
+
+# a module that throws a exception
+ok&#40;!exists $INC{&#39;t/ModExc.pm&#39;}&#41;;
+test_require_module&#40;&#34;t::ModExc&#34;&#41;;
+like&#40;$err, qr/^NO PASARAN.+^Compilation failed in require/ms&#41;;
+is&#40;$result, undef&#41;;
+ok&#40;exists $INC{&#39;t/ModExc.pm&#39;}, &#39;%INC entry is actually set to undef on throwing module&#39;&#41;
+	unless _HAS_INC_BUG;
+is&#40;$INC{&#39;t/ModExc.pm&#39;}, undef, &#39;%INC properly evaluates to undef on throwing module&#39;&#41;;
+
+# re-require a module that throws a exception on 5.10+
+if &#40;_HAS_INC_BUG&#41; {
+	test_require_module&#40;&#34;t::ModExc&#34;&#41;;
+	like&#40;$err, qr/^NO PASARAN.+^Compilation failed in require/ms&#41;;
+	is&#40;$result, undef&#41;;
+	ok&#40;!defined $INC{&#39;t/ModExc.pm&#39;}, &#39;%INC still unset on re-require of throwing module&#39;&#41;;
+} else {
+	test_require_module&#40;&#34;t::ModExc&#34;&#41;;
+	like&#40;$err, qr/^Attempt to reload .+ aborted.+^Compilation failed in require/ms&#41;;
+	is&#40;$result, undef&#41;;
+	ok&#40;
+		&#40;exists $INC{&#39;t/ModExc.pm&#39;} and ! defined $INC{&#39;t/ModExc.pm&#39;}&#41;,
+		&#39;%INC still undef on re-require of throwing module&#39;
+	&#41;;
+}
 
 # module file scope sees scalar context regardless of calling context
 eval { require_module&#40;&#34;t::Mod1&#34;&#41;; 1 };
-- 
1.7.9

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;08&nbsp;15:16:23&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io -  Dependency by ticket #74790 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;08&nbsp;15:16:42&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io -  Dependency by ticket #74791 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;08&nbsp;15:16:45&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io -  Dependency by ticket #74792 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;09&nbsp;07:30:58&nbsp;2012</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #74789] require_module needs to work around the perl 5.8 %INC pollution bug</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 9 Feb 2012 12:30:39 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Peter Rabbitson via RT &lt;bug-Module-Runtime [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m willing to include some workaround for this bug in M:R.  However,
I note that this isn&#39;t a complete solution to the problem.  Even if every
module applies this workaround to every explicit require, or every module
uses M:R &#40;incorporating workaround&#41; instead of the core require, the bug
still affects the implicit require in &#34;use&#34; statements.  Also, although
the workaround avoids polluting %INC with bad entries that mislead future
requires, it can still itself be confused by bad %INC entries created
by previous requires that lack the workaround.  I don&#39;t see any way to
distinguish duff entries outside the process that created them.

It is not practical to get every require and use statement to explicitly
incorporate some workaround.  If you&#39;re interested in really fixing this,
there&#39;ll have to be a more implicit approach.  Lexical::SealRequireHints
is a possible model for this sort of intervention, but it hasn&#39;t been
without difficulty.

Speaking of L:SRH, I think if I&#39;m incorporating a workaround for the %INC
bug into M:R, I should probably incorporate a workaround for the hint
leakage bug too.  This won&#39;t be as tricky as the L:SRH code, because it
doesn&#39;t need to mess with packages: anything required via M:R sees the
M:R package rather than package of M:R&#39;s caller.

I&#39;m not satisfied with the code you propose to work around the %INC bug.
I don&#39;t want an eval frame there at all, and especially if it&#39;s just
for cleanup &#40;as it is&#41;.  I have a better way to do it.

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;09&nbsp;07:31:03&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;09&nbsp;07:41:06&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #74789] require_module needs to work around the perl 5.8 %INC pollution bug</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 09 Feb 2012 13:40:54 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Module-Runtime [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;ribasushi [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Zefram via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=74789">https://rt.cpan.org/Ticket/Display.html?id=74789</a></span> &gt;
&gt; 
&gt; I&#39;m willing to include some workaround for this bug in M:R.  However,
&gt; I note that this isn&#39;t a complete solution to the problem.  Even if every
&gt; module applies this workaround to every explicit require, or every module
&gt; uses M:R &#40;incorporating workaround&#41; instead of the core require, the bug
&gt; still affects the implicit require in &#34;use&#34; statements.  Also, although
&gt; the workaround avoids polluting %INC with bad entries that mislead future
&gt; requires, it can still itself be confused by bad %INC entries created
&gt; by previous requires that lack the workaround.  I don&#39;t see any way to
&gt; distinguish duff entries outside the process that created them.
&gt; 
&gt; It is not practical to get every require and use statement to explicitly
&gt; incorporate some workaround.  If you&#39;re interested in really fixing this,
&gt; there&#39;ll have to be a more implicit approach.  Lexical::SealRequireHints
&gt; is a possible model for this sort of intervention, but it hasn&#39;t been
&gt; without difficulty.
</div>
This is a valid point. In fact I had to do this here specifically for this
reason: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dbsrgits/dbix-class/blob/master/t/55namespaces_cleaned.t#L1">https://github.com/dbsrgits/dbix-class/blob/master/t/55namespaces_cleaned.t#L1</a></span>
In fact the comment pretty much mirrors your observation.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Speaking of L:SRH, I think if I&#39;m incorporating a workaround for the %INC
&gt; bug into M:R, I should probably incorporate a workaround for the hint
&gt; leakage bug too.  This won&#39;t be as tricky as the L:SRH code, because it
&gt; doesn&#39;t need to mess with packages: anything required via M:R sees the
&gt; M:R package rather than package of M:R&#39;s caller.
&gt; 
&gt; I&#39;m not satisfied with the code you propose to work around the %INC bug.
&gt; I don&#39;t want an eval frame there at all, and especially if it&#39;s just
&gt; for cleanup &#40;as it is&#41;.  I have a better way to do it.
&gt; 
</div>
I would be interested to hear how you can avoid the eval frame. In any
case - do you propose a better solution? Currently the only recourse
when needing to repeatedly require a module &#40;and failing&#41; is to do the
cleanup oneself. This is far from ideal &#40;and many get it wrong anyway&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;12&nbsp;06:57:34&nbsp;2012</span>
    <span class="description">ZEFRAM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Done in Module-Runtime-0.012.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;12&nbsp;06:57:35&nbsp;2012</span>
    <span class="description">ZEFRAM [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
