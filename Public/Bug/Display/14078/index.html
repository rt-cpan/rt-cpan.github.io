<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #14078 for IPC-Run: run&#40;&#41; miscalculates length of UTF-8 strings</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #14078 for IPC-Run: run&#40;&#41; miscalculates length of UTF-8 strings</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/IPC-Run/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/IPC-Run/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/IPC-Run/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/IPC-Run/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IPC-Run">IPC-Run CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">14078</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/IPC-Run/Active/">IPC-Run</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">TODDR [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dom [...] idealx.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-17362-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.79    </td>
  </tr>
  <tr id="CF-17363-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;09&nbsp;11:24:37&nbsp;2005</span>
    <span class="description">domq [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> run&#40;&#41; miscalculates length of UTF-8 strings</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">IPC::Run::finish&#40;&#41; appears to rely on length&#40;&#41; to compute the number of bytes to send to the outbound pipe&#40;s&#41;. Unfortunately this won&#39;t add up if the string being sent has the UTF-8 flag set &#40;see L&lt;perlunicode&gt;&#41; because length&#40;&#41; returns the number of characters, not bytes, when applied to an UTF-8 string.

Attached is a test case that demonstrates this by invoking &#34;cat&#34;. Due to the miscalculation, the string sent to &#34;cat&#34; is truncated by two bytes.

Using IPC::Run 0.79 from CPAN, Linux kernel version 2.6.11.7, Debian Woody. The test fails in the same way &#40;subtests 1 to 3 pass, 4 fails&#41; on both the distribution&#39;s stock Perl 5.6.1 and a home-built Perl 5.8.5.
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use Test;
BEGIN { plan tests =&gt; 4 };

use IPC::Run qw&#40;run&#41;;
use strict;
require utf8;

my $utf_in = do { use utf8; &#34;rÃ©sumÃ©...&#34; };
my $bytes_in = pack&#40;&#34;C*&#34;, unpack&#40;&#34;C*&#34;, $utf_in&#41;&#41;;

# $utf_in and $bytes_in now contain the same bytes in Perl&#39;s memory
# &#40;as per the pack/unpack above&#41;, and differ only by the UTF-8 flag.
# Let&#39;s make sure about the latter &#40;$utf_in should have the flag set,
# and $bytes_in should have it cleared&#41;:
skip &#40; &#40;! utf8-&gt;can&#40;&#34;is_utf8&#34;&#41; ?
        &#34;Skipped - Perl 5.8 required for this sub-test&#34; : undef&#41;,
       sub { utf8::is_utf8&#40;$utf_in&#41; &#38;&#38; ! utf8::is_utf8&#40;$bytes_in&#41; }&#41;;

# Same purpose but less precise and also works under Perl 5.6:
ok&#40;length&#40;$bytes_in&#41;, 2 + length&#40;$utf_in&#41;,
   &#34;UTF-8 flags and lengths don&#39;t add up&#34;&#41;;

my $bytes_out;

# Test using the byte string: &#34;cat&#34; should be transparent.
run [&#34;cat&#34;], \$bytes_in, \$bytes_out;
ok&#40;$bytes_out, $bytes_in,
   &#34;non-transparent IPC::Run &#40;or runaway cat ?&#41;&#34;&#41;;

# Same test using the UTF-8 string
run [&#34;cat&#34;], \$utf_in, \$bytes_out;
ok&#40;$bytes_out, $bytes_in,
   &#34;non-transparent IPC::Run when using UTF-8&#34;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;10&nbsp;15:56:28&nbsp;2006</span>
    <span class="description">RSOD [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;10&nbsp;15:56:29&nbsp;2006</span>
    <span class="description">RSOD [...] cpan.org -  Given to RSOD</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;10&nbsp;15:56:29&nbsp;2006</span>
    <span class="description">RSOD [...] cpan.org -  Severity Important changed to Critical</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;02&nbsp;05:25:01&nbsp;2010</span>
    <span class="description">james2vegas [...] aim.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza">This bug keeps GraphViz from working with UTF-8 strings, as the extra bytes not found by length() are usually the end of an edge definition, usually causing it to point to an invalid nodename, and the terminating }.<br>

<br>

&nbsp;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Steal even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;22&nbsp;20:07:24&nbsp;2010</span>
    <span class="description">TODDR [...] cpan.org -  Stolen from RSOD</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;22&nbsp;20:12:26&nbsp;2010</span>
    <span class="description">TODDR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Patches welcome. I&#39;m not a UTF 8 expert. I think the big problem here is 
that any solution would have to be backwards compatible to 5.006.

Alternativley we could simply document that you need to have perl 5.X in 
order for UTF-8 to function.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;04&nbsp;20:21:15&nbsp;2011</span>
    <span class="description">cpan.org [...] mavit.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Mar 22 20:12:26 2010, TODDR wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Patches welcome. I&#39;m not a UTF 8 expert. I think the big problem here is 
&gt; that any solution would have to be backwards compatible to 5.006.
&gt; 
&gt; Alternativley we could simply document that you need to have perl 5.X in 
&gt; order for UTF-8 to function.
</div>
Assuming that the entire package is written expecting byte rather than
character semantics, this simple patch should do the trick.

The bytes pragma is available in Perl 5.6, so I don&#39;t see any reason why
this shouldn&#39;t work there.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ipc-run-utf8.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: t/utf8.t
===================================================================
--- t/utf8.t	&#40;revision 0&#41;
+++ t/utf8.t	&#40;revision 0&#41;
@@ -0,0 +1,30 @@
+use Test;
+BEGIN { plan tests =&gt; 3 };
+
+use IPC::Run qw&#40;run&#41;;
+use strict;
+require utf8;
+use Encode;
+
+my $utf_in = do { use utf8; &#34;rÃ©sumÃ©...&#34; };
+my $bytes_in = pack&#40;&#34;C*&#34;, unpack&#40;&#34;C*&#34;, $utf_in&#41;&#41;;
+
+# $utf_in and $bytes_in now contain the same bytes in Perl&#39;s memory
+# &#40;as per the pack/unpack above&#41;, and differ only by the UTF-8 flag.
+# Let&#39;s make sure about the latter &#40;$utf_in should have the flag set,
+# and $bytes_in should have it cleared&#41;:
+skip &#40; &#40;! utf8-&gt;can&#40;&#34;is_utf8&#34;&#41; ?
+        &#34;Skipped - Perl 5.8 required for this sub-test&#34; : undef&#41;,
+       sub { utf8::is_utf8&#40;$utf_in&#41; &#38;&#38; ! utf8::is_utf8&#40;$bytes_in&#41; }&#41;;
+
+my $bytes_out;
+
+# Test using the byte string: &#34;cat&#34; should be transparent.
+run [&#34;cat&#34;], \$bytes_in, \$bytes_out;
+ok&#40;$bytes_out, $bytes_in,
+   &#34;non-transparent IPC::Run &#40;or runaway cat ?&#41;&#34;&#41;;
+
+# Same test using the UTF-8 string
+run [&#34;cat&#34;], \$utf_in, \$bytes_out;
+ok&#40;decode_utf8&#40;$bytes_out&#41;, $utf_in,
+   &#34;non-transparent IPC::Run when using UTF-8&#34;&#41;;

Property changes on: t/utf8.t
___________________________________________________________________
Added: svn:eol-style
   + native

Index: lib/IPC/Run.pm
===================================================================
--- lib/IPC/Run.pm	&#40;revision 13566&#41;
+++ lib/IPC/Run.pm	&#40;working copy&#41;
@@ -1,4 +1,5 @@
 package IPC::Run;
+use bytes;
 
 =pod
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;28&nbsp;14:24:10&nbsp;2011</span>
    <span class="description">kwilliams [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m getting bitten by this bug too, any timeline for a release fixing it?  Until it&#39;s fixed, the input 
to run&#40;@cmd, &#39;&lt;&#39;, \$input&#41; is chopped off somewhere before the end.

 -Ken
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;29&nbsp;08:44:34&nbsp;2011</span>
    <span class="description">TODDR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Apr 28 14:24:10 2011, KWILLIAMS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m getting bitten by this bug too, any timeline for a release fixing
&gt; it?  Until it&#39;s fixed, the input
&gt; to run&#40;@cmd, &#39;&lt;&#39;, \$input&#41; is chopped off somewhere before the end.
&gt; 
&gt;  -Ken
</div>

Sorry all for the delay. The patch looks pretty good. I&#39;ll try to get a dev release out today.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;29&nbsp;10:47:10&nbsp;2011</span>
    <span class="description">dmuey [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hey Todd, 

You&#39;d asked me about this and basically the current solution of using bytes::length&#40;&#41; is 
probably the way to go here***.

So the solution &#39;use bytes;&#39; should cover it. 

FWIW, my typical stance w/ bytes is to require it in to make its functions available and then 
explicitly use bytes:: or CORE:: so there is less confusion as to what was intended. 

As far as the test goes: I think the test could be simplified and more robust if it didn&#39;t use 
utf8 functions since it varies greatly between perl versions and usually does not do what you 
think it is doing.

*** This demonstrates that bytes::length&#40;&#41; is always accurate regardless of is the string is a 
byte string or unicode string &#40;if it looks garbled then the first command should be the ellipses 
character itself &#40;command-semicolon on OSX&#41; after &#34;string&#34;&#41;:

[dmuey@multivac ~]$ perl -Mstrict -wle &#39;require bytes;my $s=&#34;bytes string…&#34;;print 
bytes::length&#40;$s&#41;;print CORE::length&#40;$s&#41;;&#39;
15
15
[dmuey@multivac ~]$ perl -Mstrict -wle &#39;require bytes;my $s=&#34;bytes 
string\xE2\x80\xA6&#34;;print bytes::length&#40;$s&#41;;print CORE::length&#40;$s&#41;;&#39;
15
15
[dmuey@multivac ~]$ perl -Mstrict -wle &#39;require bytes;my $s=&#34;unicode string\x{2026}&#34;;print 
bytes::length&#40;$s&#41;;print CORE::length&#40;$s&#41;;&#39;
17
15 
[dmuey@multivac ~]$ perl -MEncode -Mstrict -wle &#39;require bytes;my 
$s=Encode::decode_utf8&#40;&#34;bytes string…&#34;&#41;;print bytes::length&#40;$s&#41;;print CORE::length&#40;$s&#41;;&#39;
15
13
[dmuey@multivac ~]$ perl -MEncode -Mstrict -wle &#39;require bytes;my 
$s=Encode::decode_utf8&#40;&#34;bytes string\xE2\x80\xA6&#34;&#41;;print bytes::length&#40;$s&#41;;print 
CORE::length&#40;$s&#41;;&#39;
15
13
[dmuey@multivac ~]$ perl -MEncode -Mstrict -wle &#39;require bytes;my 
$s=Encode::decode_utf8&#40;&#34;unicode string\x{2026}&#34;&#41;;print bytes::length&#40;$s&#41;;print 
CORE::length&#40;$s&#41;;&#39;
17
15
[dmuey@multivac ~]$ 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;29&nbsp;11:31:52&nbsp;2011</span>
    <span class="description">dmuey [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; As far as the test goes: I think the test could be simplified and more
&gt; robust if it didn&#39;t use
&gt; utf8 functions since it varies greatly between perl versions and
&gt; usually does not do what you
&gt; think it is doing.
</div>
`git show HEAD` attached

before &#39;use bytes&#39; fix:

[dmuey@multivac IPC-Run &#40;RT14078&#41;]$ prove -wlv t/utf8.t 
t/utf8....1..4
ok 1 - Encode::decode_utf8&#40;&#41; does not lvalue our bytes string var
ok 2 - byte string and unicode string same string as far as humans are concerned
ok 3 - run&#40;&#41; w/ byte string

#   Failed test &#39;run&#40;&#41; w/ unicode string&#39;
not ok 4 - run&#40;&#41; w/ unicode string
#   at t/utf8.t line 26.
Wide character in print at /System/Library/Perl/5.10.0/Test/Builder.pm line 1266.
#          got: &#39;string�&#39;
#     expected: &#39;string…&#39;
# Looks like you failed 1 test of 4.
dubious
        Test returned status 1 &#40;wstat 256, 0x100&#41;
DIED. FAILED test 4
        Failed 1/4 tests, 75.00% okay
Failed Test Stat Wstat Total Fail  List of Failed
-------------------------------------------------------------------------------
t/utf8.t       1   256     4    1  4
Failed 1/1 test scripts. 1/4 subtests failed.
Files=1, Tests=4,  0 wallclock secs &#40; 0.05 cusr +  0.01 csys =  0.06 CPU&#41;
Failed 1/1 test programs. 1/4 subtests failed.

after &#39;use bytes&#39; fix:

[dmuey@multivac IPC-Run &#40;RT14078&#41;]$ prove -wlv t/utf8.t 
t/utf8....1..4
ok 1 - Encode::decode_utf8&#40;&#41; does not lvalue our bytes string var
ok 2 - byte string and unicode string same string as far as humans are concerned
ok 3 - run&#40;&#41; w/ byte string
ok 4 - run&#40;&#41; w/ unicode string
ok
All tests successful.
Files=1, Tests=4,  0 wallclock secs &#40; 0.05 cusr +  0.01 csys =  0.06 CPU&#41;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt14078.tests.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">commit 4b2111afd1beb4121d3c2a4e7b85586373cffc65
Author: Daniel Muey &lt;dmuey@multivac.local&gt;
Date:   Wed Jun 29 10:26:48 2011 -0500

    simplify/robustify tests regarding utf-8 &#40;via byte strings and unicode strings&#41;

diff --git a/t/utf8.t b/t/utf8.t
index 75b5a59..9b0d668 100644
--- a/t/utf8.t
+++ b/t/utf8.t
@@ -1,30 +1,26 @@
-use Test;
-BEGIN { plan tests =&gt; 3 };
+use Test::More tests =&gt; 4;
 
-use IPC::Run qw&#40;run&#41;;
 use strict;
-require utf8;
-use Encode;
+use warnings;
+use IPC::Run &#40;&#41;;
+use Encode   &#40;&#41;;
 
-my $utf_in = do { use utf8; &#34;râÂ©sumâÂ©...&#34; };
-my $bytes_in = pack&#40;&#34;C*&#34;, unpack&#40;&#34;C*&#34;, $utf_in&#41;&#41;;
+##### data setup and sanity check
+my $unicode_string = &#34;string\x{2026}&#34;;
+my $byte_string    = &#34;string\xE2\x80\xA6&#34;;
 
-# $utf_in and $bytes_in now contain the same bytes in Perl&#39;s memory
-# &#40;as per the pack/unpack above&#41;, and differ only by the UTF-8 flag.
-# Let&#39;s make sure about the latter &#40;$utf_in should have the flag set,
-# and $bytes_in should have it cleared&#41;:
-skip &#40; &#40;! utf8-&gt;can&#40;&#34;is_utf8&#34;&#41; ?
-        &#34;Skipped - Perl 5.8 required for this sub-test&#34; : undef&#41;,
-       sub { utf8::is_utf8&#40;$utf_in&#41; &#38;&#38; ! utf8::is_utf8&#40;$bytes_in&#41; }&#41;;
+## make sure what we&#39;re doing doesn&#39;t incidentally change the data and that the data is what we expect
+my $x = Encode::decode_utf8&#40;$byte_string&#41;;
+isnt&#40; $x, $byte_string, &#34;Encode::decode_utf8&#40;&#41; does not lvalue our bytes string var&#34; &#41;;
+is&#40; $unicode_string, Encode::decode_utf8&#40;$byte_string&#41;, &#34;byte string and unicode string same string as far as humans are concerned&#34; &#41;;
 
+##### actual IPC::Run::run&#40;&#41; tests
 my $bytes_out;
 
-# Test using the byte string: &#34;cat&#34; should be transparent.
-run [&#34;cat&#34;], \$bytes_in, \$bytes_out;
-ok&#40;$bytes_out, $bytes_in,
-   &#34;non-transparent IPC::Run &#40;or runaway cat ?&#41;&#34;&#41;;
+## Test using the byte string: &#34;cat&#34; should be transparent.
+IPC::Run::run&#40; [&#34;cat&#34;], \$byte_string, \$bytes_out &#41;;
+is&#40; $bytes_out, $byte_string, &#34;run&#40;&#41; w/ byte string&#34; &#41;;
 
-# Same test using the UTF-8 string
-run [&#34;cat&#34;], \$utf_in, \$bytes_out;
-ok&#40;decode_utf8&#40;$bytes_out&#41;, $utf_in,
-   &#34;non-transparent IPC::Run when using UTF-8&#34;&#41;;
+##  Same test using the Unicode string
+IPC::Run::run&#40; [&#34;cat&#34;], \$unicode_string, \$bytes_out &#41;;
+is&#40; Encode::decode_utf8&#40;$bytes_out&#41;, $unicode_string, &#34;run&#40;&#41; w/ unicode string&#34; &#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;30&nbsp;10:42:55&nbsp;2011</span>
    <span class="description">dmuey [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached is the test file &#40;instead of the diff&#41; as requested.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; `git show HEAD` attached
&gt; 
&gt; before &#39;use bytes&#39; fix:
&gt; 
&gt; [dmuey@multivac IPC-Run &#40;RT14078&#41;]$ prove -wlv t/utf8.t
&gt; t/utf8....1..4
&gt; ok 1 - Encode::decode_utf8&#40;&#41; does not lvalue our bytes string var
&gt; ok 2 - byte string and unicode string same string as far as humans are
&gt; concerned
&gt; ok 3 - run&#40;&#41; w/ byte string
&gt; 
&gt; #   Failed test &#39;run&#40;&#41; w/ unicode string&#39;
&gt; not ok 4 - run&#40;&#41; w/ unicode string
&gt; #   at t/utf8.t line 26.
&gt; Wide character in print at /System/Library/Perl/5.10.0/Test/Builder.pm
&gt; line 1266.
&gt; #          got: &#39;string�&#39;
&gt; #     expected: &#39;string…&#39;
&gt; # Looks like you failed 1 test of 4.
&gt; dubious
&gt;       Test returned status 1 &#40;wstat 256, 0x100&#41;
&gt; DIED. FAILED test 4
&gt;       Failed 1/4 tests, 75.00% okay
&gt; Failed Test Stat Wstat Total Fail  List of Failed
&gt; -----------------------------------------------------------------------------
</div>--
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; t/utf8.t       1   256     4    1  4
&gt; Failed 1/1 test scripts. 1/4 subtests failed.
&gt; Files=1, Tests=4,  0 wallclock secs &#40; 0.05 cusr +  0.01 csys =  0.06
&gt; CPU&#41;
&gt; Failed 1/1 test programs. 1/4 subtests failed.
&gt; 
&gt; after &#39;use bytes&#39; fix:
&gt; 
&gt; [dmuey@multivac IPC-Run &#40;RT14078&#41;]$ prove -wlv t/utf8.t
&gt; t/utf8....1..4
&gt; ok 1 - Encode::decode_utf8&#40;&#41; does not lvalue our bytes string var
&gt; ok 2 - byte string and unicode string same string as far as humans are
&gt; concerned
&gt; ok 3 - run&#40;&#41; w/ byte string
&gt; ok 4 - run&#40;&#41; w/ unicode string
&gt; ok
&gt; All tests successful.
&gt; Files=1, Tests=4,  0 wallclock secs &#40; 0.05 cusr +  0.01 csys =  0.06
&gt; CPU&#41;
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> utf8.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use Test::More tests =&gt; 4;

use strict;
use warnings;
use IPC::Run &#40;&#41;;
use Encode   &#40;&#41;;

##### data setup and sanity check
my $unicode_string = &#34;string\x{2026}&#34;;
my $byte_string    = &#34;string\xE2\x80\xA6&#34;;

## make sure what we&#39;re doing doesn&#39;t incidentally change the data and that the data is what we expect
my $x = Encode::decode_utf8&#40;$byte_string&#41;;
isnt&#40; $x, $byte_string, &#34;Encode::decode_utf8&#40;&#41; does not lvalue our bytes string var&#34; &#41;;
is&#40; $unicode_string, Encode::decode_utf8&#40;$byte_string&#41;, &#34;byte string and unicode string same string as far as humans are concerned&#34; &#41;;

##### actual IPC::Run::run&#40;&#41; tests
my $bytes_out;

## Test using the byte string: &#34;cat&#34; should be transparent.
IPC::Run::run&#40; [&#34;cat&#34;], \$byte_string, \$bytes_out &#41;;
is&#40; $bytes_out, $byte_string, &#34;run&#40;&#41; w/ byte string&#34; &#41;;

##  Same test using the Unicode string
IPC::Run::run&#40; [&#34;cat&#34;], \$unicode_string, \$bytes_out &#41;;
is&#40; Encode::decode_utf8&#40;$bytes_out&#41;, $unicode_string, &#34;run&#40;&#41; w/ unicode string&#34; &#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;01&nbsp;00:34:28&nbsp;2011</span>
    <span class="description">TODDR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve released The combined patches in 0.90_03. The patch can be found here:

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/toddr/IPC-Run/commit/ed1dd80f31d42e50bf78c27f9b795f6f0741edb2">https://github.com/toddr/IPC-Run/commit/ed1dd80f31d42e50bf78c27f9b795f6f0741edb2</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;01&nbsp;00:34:46&nbsp;2011</span>
    <span class="description">TODDR [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;06&nbsp;17:45:20&nbsp;2011</span>
    <span class="description">TODDR [...] cpan.org -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
