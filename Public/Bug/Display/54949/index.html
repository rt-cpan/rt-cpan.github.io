<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #54949 for DBIx-Class: Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #54949 for DBIx-Class: Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBIx-Class/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Class">DBIx-Class CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">54949</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBIx-Class/Active/">DBIx-Class</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
soporte [...] web-experto.com.ar

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-10410-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.08119    </td>
  </tr>
  <tr id="CF-10411-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.08250    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;24&nbsp;15:24:56&nbsp;2010</span>
    <span class="description">soporte [...] web-experto.com.ar -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, first i apologies about my english, i will try to express my self
the best i can. I found this issue that i detail next. Thanks

DBIx-Class: DBIx-Class-0.08119
Perl Version: 5.8
OS: Ubuntu 8.10

package WEBEXPERTO::Modulos::Catalogue::Model::Product;
use strict;
use warnings;
use base qw/DBIx::Class/;
use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
__PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
__PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
__PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
description_product is_actived_product datetime_added_product
datetime_last_modified_product date_start_publish_product
date_finish_publish_product imagen_product resumen_product
codigo_product destacado_product oferta_product skin_name/&#41;;
__PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
__PACKAGE__-&gt;has_many&#40;
                                                &#39;productPrice&#39; =&gt;
&#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
                                                {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
                                                {cascade_delete =&gt; 0},
                                        &#41;;
__PACKAGE__-&gt;has_one&#40;
                                                &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
                                                {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
                                                {cascade_delete =&gt; 0},
                                        &#41;;
1;

package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;            
use strict;
use warnings;
use base qw/DBIx::Class/;
__PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
__PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
__PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
__PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
__PACKAGE__-&gt;has_one&#40;
                                                &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
                                                {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
                                        &#41;;

__PACKAGE__-&gt;belongs_to&#40;
                                                &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
                                                {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
                                        &#41;;
1;



#CODE
my @productPrefetch;
push&#40;@productPrefetch,&#39;node&#39;&#41;;
push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
my $searchAttributes = {
                          prefetch =&gt; \@productPrefetch,
                          rows =&gt; 3,
                          order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
                          group_by =&gt; &#39;me.id_product&#39;,
                        };
my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
$searchAttributes&#41;;
my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;



What i expect is a set of products with has_many relation &#40;productPrice&#41;
loaded with all prices. What i get is three products but eachone repeted
3 times,
seems that group_by is not working. 

Sql query looks like this:
SELECT me.id_product, me.id_node, me.name_product,
me.description_product, me.is_actived_product,
me.datetime_added_product, me.datetime_last_modified_product,
me.date_start_publish_product, me.date_finish_publish_product,
me.imagen_product, me.resumen_product, me.codigo_product,
me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
productPrice.idProduct, productPrice.idPriceList,
productPrice.idCurrency, productPrice.value, currency.id, currency.name,
currency.symbol FROM 
&#40;SELECT me.id_product, me.id_node, me.name_product,
me.description_product, me.is_actived_product,
me.datetime_added_product, me.datetime_last_modified_product,
me.date_start_publish_product, me.date_finish_publish_product,
me.imagen_product, me.resumen_product, me.codigo_product,
me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
= me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;

The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&#39;RAND&#40;&#41;&#39;&#41; its works just fine.

If you need more details please let me know. Thanks again.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;03:44:49&nbsp;2010</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;03:44:52&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;03:46:02&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 01:51:53 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;Peter Rabbitson via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41; </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 03:44:52 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Peter Rabbitson via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;03:47:12&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 01:53:07 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 03:46:06 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;03:48:23&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 01:54:12 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 03:47:14 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;03:49:34&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 01:55:22 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 03:48:24 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;03:50:34&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 01:56:34 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 03:49:36 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;03:51:50&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 01:57:34 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 03:50:36 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;03:52:51&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 01:58:48 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 03:51:52 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;03:53:52&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 01:59:48 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 03:52:52 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;03:54:56&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 02:00:49 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 03:53:54 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;03:55:57&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 02:01:52 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 03:54:58 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;03:57:02&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 02:02:55 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 03:56:00 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;03:58:03&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 02:03:57 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 03:57:04 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;03:59:07&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 02:04:58 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 03:58:05 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;04:00:17&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 02:06:04 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 03:59:09 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;04:01:22&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 02:07:17 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 04:00:22 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;04:02:26&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 02:08:18 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 04:01:24 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;04:03:30&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 02:09:25 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 04:02:31 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;04:04:31&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 02:10:25 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 04:03:32 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;04:05:34&nbsp;2010</span>
    <span class="description">macevedo [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 02:11:25 -0300 &#40;ART&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> macevedo [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [Autoreply] [rt.cpan.org #54949] Search with has_many relation fails at using ORDER BY RAND&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 04:04:34 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;macevedo via RT&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=54949">http://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

En este momento me encuentro de vacaciones, por favor comunicarse al 527-1070 o enviar el email a soporte@web-experto.com.ar

Saludo Atte.

Martín Acevedo - Atención al cliente
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54949">https://rt.cpan.org/Ticket/Display.html?id=54949</a></span> &gt;

On Wed Feb 24 15:24:56 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, first i apologies about my english, i will try to express my self
&gt; the best i can. I found this issue that i detail next. Thanks
&gt; 
&gt; DBIx-Class: DBIx-Class-0.08119
&gt; Perl Version: 5.8
&gt; OS: Ubuntu 8.10
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; description_product is_actived_product datetime_added_product
&gt; datetime_last_modified_product date_start_publish_product
&gt; date_finish_publish_product imagen_product resumen_product
&gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;
&gt;                                               &#39;productPrice&#39; =&gt;
&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt;                                               {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt;                                               {cascade_delete =&gt; 0},
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;          
&gt; use strict;
&gt; use warnings;
&gt; use base qw/DBIx::Class/;
&gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; __PACKAGE__-&gt;has_one&#40;
&gt;                                               &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt;                                       &#41;;
&gt; 
&gt; __PACKAGE__-&gt;belongs_to&#40;
&gt;                                               &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt;                                               {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt;                                       &#41;;
&gt; 1;
&gt; 
&gt; 
&gt; 
&gt; #CODE
&gt; my @productPrefetch;
&gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; my $searchAttributes = {
&gt;                         prefetch =&gt; \@productPrefetch,
&gt;                         rows =&gt; 3,
&gt;                         order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt;                         group_by =&gt; &#39;me.id_product&#39;,
&gt;                       };
&gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; $searchAttributes&#41;;
&gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; 
&gt; 
&gt; 
&gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; loaded with all prices. What i get is three products but eachone repeted
&gt; 3 times,
&gt; seems that group_by is not working. 
&gt; 
&gt; Sql query looks like this:
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; productPrice.idProduct, productPrice.idPriceList,
&gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; currency.symbol FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, me.is_actived_product,
&gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; 
&gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; 
&gt; If you need more details please let me know. Thanks again.
</div>
First of all this has nothing to do with GROUP BY &#40;which is espected in
the innermost select&#41;.

In order to resolve this bug on the technical level, I need a proposal
for SQL that *will* work in this situation. From all I know it is simply
not possible to express what you want in pure SQL because:

1&#41; All rows relevant to the same catalogue_product need to be grouped
together &#40;appear one after another&#41;. For this the order_by criteria for
the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
fetch rows until the master-PK changes&#41;

2&#41; You want a random ordering of rows which is in direct contradiction
with the above requirement. You either:

2a&#41; Make the outermost select ordered by your criteria, which messes up
the sequencin of different catalogue_products an gies you the result you
observe 

2b&#41; Make the inner catalogue_product-only select ordered by your
criteria - the outer order_by will reorder the results of the join again

2c&#41; Make the inner catalogue_product-only select ordered by your desired
criteria and DO NOT order the outermost join result - this will result
in non-deterministic order of the final result, depending on how the
rows are atually stored in the database. 

So there - 3 scenarios I can think of, none of which really work. If you
can express it in *deterministic* SQL - I can make DBIC execute it, no
questions asked.

Cheers
</div></div>
</div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;08:37:25&nbsp;2010</span>
    <span class="description">soporte [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">El Jue feb 25 03:44:49 2010, RIBASUSHI escribió:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Feb 24 15:24:56 2010, webexperto wrote:
<div class="message-stanza open">&gt; &gt; Hi, first i apologies about my english, i will try to express my self
&gt; &gt; the best i can. I found this issue that i detail next. Thanks
&gt; &gt; 
&gt; &gt; DBIx-Class: DBIx-Class-0.08119
&gt; &gt; Perl Version: 5.8
&gt; &gt; OS: Ubuntu 8.10
&gt; &gt; 
&gt; &gt; package WEBEXPERTO::Modulos::Catalogue::Model::Product;
&gt; &gt; use strict;
&gt; &gt; use warnings;
&gt; &gt; use base qw/DBIx::Class/;
&gt; &gt; use base qw/WEBEXPERTO::Core::MEB::Model::Model/;
&gt; &gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto ResultSetManager Core/&#41;;
&gt; &gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_products&#39;&#41;;
&gt; &gt; __PACKAGE__-&gt;add_columns&#40;qw/id_product id_node name_product
&gt; &gt; description_product is_actived_product datetime_added_product
&gt; &gt; datetime_last_modified_product date_start_publish_product
&gt; &gt; date_finish_publish_product imagen_product resumen_product
&gt; &gt; codigo_product destacado_product oferta_product skin_name/&#41;;
&gt; &gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id_product /&#41;;
&gt; &gt; __PACKAGE__-&gt;has_many&#40;
&gt; &gt;                                             &#39;productPrice&#39; =&gt;
&gt; &gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice&#39;,
&gt; &gt;                                             {&#39;foreign.idProduct&#39; =&gt; &#39;self.id_product&#39;},     
&gt; &gt;                                             {cascade_delete =&gt; 0},
&gt; &gt;                                     &#41;;
&gt; &gt; __PACKAGE__-&gt;has_one&#40;
&gt; &gt;                                             &#39;node&#39; =&gt; &#39;WEBEXPERTO::Modulos::Catalogue::Model::Node&#39;,
&gt; &gt;                                             {&#39;foreign.id&#39; =&gt; &#39;self.id_node&#39;},
&gt; &gt;                                             {cascade_delete =&gt; 0},
&gt; &gt;                                     &#41;;
&gt; &gt; 1;
&gt; &gt; 
&gt; &gt; package WEBEXPERTO::Modulos::Catalogue::Model::ProductPrice;                
&gt; &gt; use strict;
&gt; &gt; use warnings;
&gt; &gt; use base qw/DBIx::Class/;
&gt; &gt; __PACKAGE__-&gt;load_components&#40;qw/PK::Auto Core/&#41;;
&gt; &gt; __PACKAGE__-&gt;table&#40;&#39;catalogue_productPrices&#39;&#41;;
&gt; &gt; __PACKAGE__-&gt;add_columns&#40;qw/id idProduct idPriceList idCurrency value/&#41;;
&gt; &gt; __PACKAGE__-&gt;set_primary_key&#40;qw/ id /&#41;;
&gt; &gt; __PACKAGE__-&gt;has_one&#40;
&gt; &gt;                                             &#39;currency&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::Currency&#39;,
&gt; &gt;                                             {&#39;foreign.id&#39; =&gt; &#39;self.idCurrency&#39; },
&gt; &gt;                                     &#41;;
&gt; &gt; 
&gt; &gt; __PACKAGE__-&gt;belongs_to&#40;
&gt; &gt;                                             &#39;priceList&#39; =&gt;&#39;WEBEXPERTO::Modulos::Catalogue::Model::PriceList&#39;,
&gt; &gt;                                             {&#39;foreign.id&#39; =&gt; &#39;self.idPriceList&#39; },                                                          
&gt; &gt;                                     &#41;;
&gt; &gt; 1;
&gt; &gt; 
&gt; &gt; 
&gt; &gt; 
&gt; &gt; #CODE
&gt; &gt; my @productPrefetch;
&gt; &gt; push&#40;@productPrefetch,&#39;node&#39;&#41;;
&gt; &gt; push&#40;@productPrefetch,{&#39;productPrice&#39;=&gt;&#39;currency&#39;}&#41;;#has_many relation
&gt; &gt; my $searchAttributes = {
&gt; &gt;                       prefetch =&gt; \@productPrefetch,
&gt; &gt;                       rows =&gt; 3,
&gt; &gt;                       order_by=&gt; &#39;RAND&#40;&#41;&#39;,  #&lt;-- cause the bug
&gt; &gt;                       group_by =&gt; &#39;me.id_product&#39;,
&gt; &gt;                     };
&gt; &gt; my $rsProducts = $schema-&gt;resultset&#40;&#39;Product&#39;&#41;-&gt;search&#40;{},
&gt; &gt; $searchAttributes&#41;;
&gt; &gt; my $totalItems = $rsProducts-&gt;pager&#40;&#41;-&gt;total_entries;
&gt; &gt; 
&gt; &gt; 
&gt; &gt; 
&gt; &gt; What i expect is a set of products with has_many relation &#40;productPrice&#41;
&gt; &gt; loaded with all prices. What i get is three products but eachone repeted
&gt; &gt; 3 times,
&gt; &gt; seems that group_by is not working. 
&gt; &gt; 
&gt; &gt; Sql query looks like this:
&gt; &gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; &gt; me.description_product, me.is_actived_product,
&gt; &gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; &gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; &gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; &gt; me.destacado_product, me.oferta_product, me.skin_name, productPrice.id,
&gt; &gt; productPrice.idProduct, productPrice.idPriceList,
&gt; &gt; productPrice.idCurrency, productPrice.value, currency.id, currency.name,
&gt; &gt; currency.symbol FROM 
&gt; &gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; &gt; me.description_product, me.is_actived_product,
&gt; &gt; me.datetime_added_product, me.datetime_last_modified_product,
&gt; &gt; me.date_start_publish_product, me.date_finish_publish_product,
&gt; &gt; me.imagen_product, me.resumen_product, me.codigo_product,
&gt; &gt; me.destacado_product, me.oferta_product, me.skin_name, me.stock_product,
&gt; &gt; me.iva_product, me.marca_product FROM catalogue_products me GROUP BY
&gt; &gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; &gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; &gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; &gt; productPrice.idCurrency ORDER BY RAND&#40;&#41;, productPrice.idProduct;
&gt; &gt; 
&gt; &gt; The last &#39;ORDER BY RAND&#40;&#41;&#39; mix up the  product results &#40;its seems like
&gt; &gt; group_by is ignored&#41;. If you dont specify order_by attribute &#40;with
&gt; &gt; &#39;RAND&#40;&#41;&#39;&#41; its works just fine.
&gt; &gt; 
&gt; &gt; If you need more details please let me know. Thanks again.
</div>&gt; 
&gt; First of all this has nothing to do with GROUP BY &#40;which is espected in
&gt; the innermost select&#41;.
&gt; 
&gt; In order to resolve this bug on the technical level, I need a proposal
&gt; for SQL that *will* work in this situation. From all I know it is simply
&gt; not possible to express what you want in pure SQL because:
&gt; 
&gt; 1&#41; All rows relevant to the same catalogue_product need to be grouped
&gt; together &#40;appear one after another&#41;. For this the order_by criteria for
&gt; the outermost select *must* be &#34;by PK/Unique column&#40;s&#41; of
&gt; catalogue_product. This requirement is necessary to make -&gt;next work &#40;we
&gt; fetch rows until the master-PK changes&#41;
&gt; 
&gt; 2&#41; You want a random ordering of rows which is in direct contradiction
&gt; with the above requirement. You either:
&gt; 
&gt; 2a&#41; Make the outermost select ordered by your criteria, which messes up
&gt; the sequencin of different catalogue_products an gies you the result you
&gt; observe 
&gt; 
&gt; 2b&#41; Make the inner catalogue_product-only select ordered by your
&gt; criteria - the outer order_by will reorder the results of the join again
&gt; 
&gt; 2c&#41; Make the inner catalogue_product-only select ordered by your desired
&gt; criteria and DO NOT order the outermost join result - this will result
&gt; in non-deterministic order of the final result, depending on how the
&gt; rows are atually stored in the database. 
&gt; 
&gt; So there - 3 scenarios I can think of, none of which really work. If you
&gt; can express it in *deterministic* SQL - I can make DBIC execute it, no
&gt; questions asked.
&gt; 
&gt; Cheers
</div>
Thanks for replay, the SQL i excpect looks like this:

SELECT me.id_product, me.id_node, me.name_product,
me.description_product, ........ FROM 
&#40;SELECT me.id_product, me.id_node, me.name_product,
me.description_product, ...... FROM catalogue_products me GROUP BY
me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
= me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
productPrice.idCurrency ORDER BY productPrice.idProduct;

Its the same as last sql query, but in the outer select i remove RAND&#40;&#41;
ordering &#40;see attached files&#41;. The innermost select is ok.
is there any way that dbix keep order_by off from outer select?

Thank you!
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> outer_select_without_rand.jpeg</td>
  </tr>
</table>

<div class="messagebody">
<img alt="outer_select_without_rand.jpeg" title="outer_select_without_rand.jpeg" src="/Ticket/Attachment/739139/382039/" /></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> outer_select_with_rand.jpeg</td>
  </tr>
</table>

<div class="messagebody">
<img alt="outer_select_with_rand.jpeg" title="outer_select_with_rand.jpeg" src="/Ticket/Attachment/739139/382040/" /></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;09:52:14&nbsp;2010</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for replay, the SQL i excpect looks like this:
&gt; 
&gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, ........ FROM 
&gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; me.description_product, ...... FROM catalogue_products me GROUP BY
&gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; productPrice.idCurrency ORDER BY productPrice.idProduct;
&gt; 
&gt; Its the same as last sql query, but in the outer select i remove RAND&#40;&#41;
&gt; ordering &#40;see attached files&#41;. The innermost select is ok.
&gt; is there any way that dbix keep order_by off from outer select?
</div>
This SQL will never return random results, you can run it as many times
as you like, the final set will be ordered by productPrice.idProduct

Or was your objective only to get 3 random rows with their stuff prefetched?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;10:50:40&nbsp;2010</span>
    <span class="description">soporte [...] web-experto.com.ar -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> soporte [...] web-experto.com.ar</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">El Jue feb 25 09:52:14 2010, RIBASUSHI escribió:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Thanks for replay, the SQL i excpect looks like this:
&gt; &gt; 
&gt; &gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; &gt; me.description_product, ........ FROM 
&gt; &gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; &gt; me.description_product, ...... FROM catalogue_products me GROUP BY
&gt; &gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; &gt; LEFT JOIN catalogue_productPrices productPrice ON productPrice.idProduct
&gt; &gt; = me.id_product LEFT JOIN catalogue_currencies currency ON currency.id =
&gt; &gt; productPrice.idCurrency ORDER BY productPrice.idProduct;
&gt; &gt; 
&gt; &gt; Its the same as last sql query, but in the outer select i remove RAND&#40;&#41;
&gt; &gt; ordering &#40;see attached files&#41;. The innermost select is ok.
&gt; &gt; is there any way that dbix keep order_by off from outer select?
</div>&gt; 
&gt; This SQL will never return random results, you can run it as many times
&gt; as you like, the final set will be ordered by productPrice.idProduct
&gt; 
&gt; Or was your objective only to get 3 random rows with their stuff
</div>prefetched?

Yes, that was my objective! and the sql does return random, but in my
opinion the final order_by should not be there, it works fine with just
the innermost order_by. The final order_by is automaticaly added by
DBIx-Class, it&#39;s not seted by me. And it makes rows appear not grouped
by id_product, which cause a wrong prefetched.
I finaly got 3 diferent random products, but in 9 product objects &#40;they
are repeted&#41;.
Thanks!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;10:54:53&nbsp;2010</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Feb 25 10:50:40 2010, webexperto wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; El Jue feb 25 09:52:14 2010, RIBASUSHI escribió:
<div class="message-stanza open">&gt; &gt; &gt; Thanks for replay, the SQL i excpect looks like this:
&gt; &gt; &gt; 
&gt; &gt; &gt; SELECT me.id_product, me.id_node, me.name_product,
&gt; &gt; &gt; me.description_product, ........ FROM 
&gt; &gt; &gt; &#40;SELECT me.id_product, me.id_node, me.name_product,
&gt; &gt; &gt; me.description_product, ...... FROM catalogue_products me GROUP BY
&gt; &gt; &gt; me.id_product ORDER BY RAND&#40;&#41; LIMIT 3&#41; me 
&gt; &gt; &gt; LEFT JOIN catalogue_productPrices productPrice ON
</div></div>productPrice.idProduct
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; &gt; = me.id_product LEFT JOIN catalogue_currencies currency ON
</div></div>currency.id =
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; &gt; productPrice.idCurrency ORDER BY productPrice.idProduct;
&gt; &gt; &gt; 
&gt; &gt; &gt; Its the same as last sql query, but in the outer select i remove
</div></div>RAND&#40;&#41;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; ordering &#40;see attached files&#41;. The innermost select is ok.
&gt; &gt; &gt; is there any way that dbix keep order_by off from outer select?
</div>&gt; &gt; 
&gt; &gt; This SQL will never return random results, you can run it as many times
&gt; &gt; as you like, the final set will be ordered by productPrice.idProduct
&gt; &gt; 
&gt; &gt; Or was your objective only to get 3 random rows with their stuff
</div>&gt; prefetched?
&gt; 
&gt; Yes, that was my objective! and the sql does return random, but in my
&gt; opinion the final order_by should not be there, it works fine with just
&gt; the innermost order_by. The final order_by is automaticaly added by
&gt; DBIx-Class, it&#39;s not seted by me. And it makes rows appear not grouped
&gt; by id_product, which cause a wrong prefetched.
&gt; I finaly got 3 diferent random products, but in 9 product objects &#40;they
&gt; are repeted&#41;.
&gt; Thanks!
</div>
Right... this problem is much deeper than it initially appears, work is
being done to resolve it, possibly by end of week.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;12&nbsp;08:23:23&nbsp;2010</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just a heads up that this bug has not been forgotten. The underlying
machinery rewrite however proved quite the bitch, thus no sane ETA is
currently available on when this will be finally fixed &#40;but it
definitely will be at some point&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;03:34:05&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Stalling until we solve the underlying problem in the DBIC codebase.
Sorry for the delay :&#40;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;03:34:14&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;03:34:14&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io -  Dependency on ticket #74584 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;17&nbsp;09:46:24&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is now fixed in the repo master:
git://git.shadowcat.co.uk/dbsrgits/DBIx-Class.git
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;17&nbsp;09:46:25&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;17&nbsp;09:46:25&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;30&nbsp;13:21:10&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Re-stalling until parent RT#74584 is truly resolved
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;30&nbsp;13:21:11&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;30&nbsp;13:21:11&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;14&nbsp;06:09:59&nbsp;2013</span>
    <span class="description">ribasushi [...] leporine.io -  Fixed in 0.08240-TRIAL added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;14&nbsp;06:09:59&nbsp;2013</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hopefully this time DBIC 0.08240 nails this issue.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;14&nbsp;06:10:00&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;14&nbsp;06:10:00&nbsp;2013</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;30&nbsp;02:49:31&nbsp;2013</span>
    <span class="description">ribasushi [...] leporine.io -  Fixed in 0.08250 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;30&nbsp;02:49:32&nbsp;2013</span>
    <span class="description">ribasushi [...] leporine.io -  Fixed in 0.08240-TRIAL deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;30&nbsp;02:49:32&nbsp;2013</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">And production version resolving this is now on CPAN.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;30&nbsp;02:49:33&nbsp;2013</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
