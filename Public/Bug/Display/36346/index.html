<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #36346 for Apache-DBI: Apache::DBI 1.07 makes it impossible to fetch data through DBI from startup.pl</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #36346 for Apache-DBI: Apache::DBI 1.07 makes it impossible to fetch data through DBI from startup.pl</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Apache-DBI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Apache-DBI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Apache-DBI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Apache-DBI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Apache-DBI">Apache-DBI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">36346</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Apache-DBI/Active/">Apache-DBI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">pgollucci [...] p6m7g8.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
adam.prime [...] utoronto.ca

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
mkent [...] magoazul.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-1546-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.07    </td>
  </tr>
  <tr id="CF-1547-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;01&nbsp;23:41:34&nbsp;2008</span>
    <span class="description">adam.prime [...] utoronto.ca -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Apache::DBI 1.07 makes it impossible to fetch data through DBI
 from startup.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">using this as my startup.pl

use lib qw&#40;/www/perl&#41;;

use ModPerl::Util &#40;&#41;; #for CORE::GLOBAL::exit
use Apache2::RequestRec &#40;&#41;;
use Apache2::RequestIO &#40;&#41;;
use Apache2::RequestUtil &#40;&#41;;
use Apache2::ServerRec &#40;&#41;;
use Apache2::ServerUtil &#40;&#41;;
use Apache2::Connection &#40;&#41;;
use Apache2::Const &#40;&#41;;
use Apache2::Log &#40;&#41;;
use APR::Table &#40;&#41;;

use Apache::DBI;
use DBI;

my $dsn = &#34;dbi:mysql::localhost:3306&#34;;
my $user = &#39;perl&#39;;
my $pw = &#39;xxxxx&#39;;
my $dbh = DBI-&gt;connect&#40;$dsn, $user, $pw&#41;;

1;

configured like

PerlPostConfigRequire /www/conf/startup.pl

i get the following in the error_log

[Sun Jun 01 23:27:36 2008] [error] Global $r object is not available.
Set:\n\tPerlOptions +GlobalRequest\nin httpd.conf at
/usr/lib64/perl5/site_perl/5.8.8/Apache/DBI.pm line 144.\nCompilation
failed in require at &#40;eval 2&#41; line 1.\n
[Sun Jun 01 23:27:36 2008] [error] Can&#39;t load Perl file:
/www/conf/startup.pl for server pooptop:0, exiting...

$r is not available because there is no request occuring. Adding
PerlOptions +GlobalRequest has no effect &#40;which is not surprising, since
there is no request occuring while startup.pl is running&#41;.

i&#39;m running: 

perl -V
Summary of my perl5 &#40;revision 5 version 8 subversion 8&#41; configuration:
  Platform:
    osname=linux, osvers=2.6.23-gentoo-r6, archname=x86_64-linux
    uname=&#39;linux pooptop 2.6.23-gentoo-r6 #1 sat jan 26 22:06:10 est
2008 x86_64 amd turion&#40;tm&#41; 64 mobile technology mk-36 authenticamd
gnulinux &#39;
    config_args=&#39;-des -Darchname=x86_64-linux -Dcccdlflags=-fPIC
-Dccdlflags=-rdynamic -Dcc=x86_64-pc-linux-gnu-gcc -Dprefix=/usr
-Dvendorprefix=/usr -Dsiteprefix=/usr -Dlocincpth= 
-Doptimize=-march=athlon64 -O2 -pipe -Duselargefiles -Dd_semctl_semun
-Dscriptdir=/usr/bin -Dman1dir=/usr/share/man/man1
-Dman3dir=/usr/share/man/man3 -Dinstallman1dir=/usr/share/man/man1
-Dinstallman3dir=/usr/share/man/man3 -Dman1ext=1 -Dman3ext=3pm
-Dinc_version_list=5.8.0 5.8.0/x86_64-linux 5.8.2 5.8.2/x86_64-linux
5.8.4 5.8.4/x86_64-linux 5.8.5 5.8.5/x86_64-linux 5.8.6
5.8.6/x86_64-linux 5.8.7 5.8.7/x86_64-linux  -Dcf_by=Gentoo -Ud_csh
-Dusenm -Di_ndbm -Di_gdbm -Di_db
-Dusrinc=/usr/include/gentoo-multilib/amd64 -Dlibpth=/usr/local/lib64
/lib64 /usr/lib64&#39;
    hint=recommended, useposix=true, d_sigaction=define
    usethreads=undef use5005threads=undef useithreads=undef
usemultiplicity=undef
    useperlio=define d_sfio=undef uselargefiles=define usesocks=undef
    use64bitint=define use64bitall=define uselongdouble=undef
    usemymalloc=n, bincompat5005=undef
  Compiler:
    cc=&#39;x86_64-pc-linux-gnu-gcc&#39;, ccflags =&#39;-fno-strict-aliasing -pipe
-Wdeclaration-after-statement -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
-I/usr/include/gdbm&#39;,
    optimize=&#39;-march=athlon64 -O2 -pipe&#39;,
    cppflags=&#39;-fno-strict-aliasing -pipe -Wdeclaration-after-statement
-I/usr/include/gdbm&#39;
    ccversion=&#39;&#39;, gccversion=&#39;4.1.2 &#40;Gentoo 4.1.2 p1.0.1&#41;&#39;, gccosandvers=&#39;&#39;
    intsize=4, longsize=8, ptrsize=8, doublesize=8, byteorder=12345678
    d_longlong=define, longlongsize=8, d_longdbl=define, longdblsize=16
    ivtype=&#39;long&#39;, ivsize=8, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;off_t&#39;,
lseeksize=8
    alignbytes=8, prototype=define
  Linker and Libraries:
    ld=&#39;x86_64-pc-linux-gnu-gcc&#39;, ldflags =&#39; -L/usr/local/lib64&#39;
    libpth=/usr/local/lib64 /lib64 /usr/lib64
    libs=-lpthread -lnsl -lgdbm -ldb -ldl -lm -lcrypt -lutil -lc
    perllibs=-lpthread -lnsl -ldl -lm -lcrypt -lutil -lc
    libc=/lib/libc-2.6.1.so, so=so, useshrplib=false, libperl=libperl.a
    gnulibc_version=&#39;2.6.1&#39;
  Dynamic Linking:
    dlsrc=dl_dlopen.xs, dlext=so, d_dlsymun=undef, ccdlflags=&#39;-rdynamic&#39;
    cccdlflags=&#39;-fPIC&#39;, lddlflags=&#39;-shared -L/usr/local/lib64&#39;


Characteristics of this binary &#40;from libperl&#41;:
  Compile-time options: PERL_MALLOC_WRAP USE_64_BIT_ALL USE_64_BIT_INT
                        USE_LARGE_FILES USE_PERLIO
  Built under linux
  Compiled at May 19 2008 22:08:38
  @INC:
    /etc/perl
    /usr/lib64/perl5/vendor_perl/5.8.8/x86_64-linux
    /usr/lib64/perl5/vendor_perl/5.8.8
    /usr/lib64/perl5/vendor_perl
    /usr/lib64/perl5/site_perl/5.8.8/x86_64-linux
    /usr/lib64/perl5/site_perl/5.8.8
    /usr/lib64/perl5/site_perl
    /usr/lib64/perl5/5.8.8/x86_64-linux
    /usr/lib64/perl5/5.8.8
    /usr/local/lib/site_perl
    .

libapreq 2.08
mod_perl 2.0.4
httpd 2.2.8
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;02&nbsp;00:55:36&nbsp;2008</span>
    <span class="description">pgollucci [...] p6m7g8.com -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;02&nbsp;00:56:49&nbsp;2008</span>
    <span class="description">pgollucci [...] p6m7g8.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Blast, completely my fault for not testing it.

 <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Bug/Display.html?id=29209">http://rt.cpan.org/Public/Bug/Display.html?id=29209</a></span>

Seems to have caused it.

I&#39;ll look at it on Monday &#40;its 1am my time&#41;, if I can&#39;t figure it out,
I&#39;ll just revert it and release 1.08.

Sorry for the hassle.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;02&nbsp;00:56:52&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;10&nbsp;09:52:17&nbsp;2008</span>
    <span class="description">lubo.rintel [...] gooddata.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> lubo.rintel [...] gooddata.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jun 02 00:56:49 2008, PGOLLUCCI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ll look at it on Monday &#40;its 1am my time&#41;, if I can&#39;t figure it out,
&gt; I&#39;ll just revert it and release 1.08.
</div>
I&#39;m wondering if you have a fix for the issue? What we&#39;ve done to
address the issue was to simply eval {} it, which fixes the
no-http-request issue, but I doubt it is correct for mod_perl 1.x and
would break rollback for people w/o global apache request handler.

diff -up Apache-DBI-1.07/lib/Apache/DBI.pm.noreq
Apache-DBI-1.07/lib/Apache/DBI.pm
--- Apache-DBI-1.07/lib/Apache/DBI.pm.noreq     2008-12-10
15:38:53.000000000 +0100
+++ Apache-DBI-1.07/lib/Apache/DBI.pm   2008-12-10 15:40:50.000000000 +0100
@@ -141,7 +141,9 @@ sub connect {
     if &#40;!$Rollback{$Idx}&#41; {
         my $r;
         if &#40;MP2&#41; {
-            $r = Apache2::RequestUtil-&gt;request;
+            # We may not actually be in a request, but in &lt;Perl&gt; &#40;or
+            # equivalent such as startup.pl&#41;, in which case this would die.
+            eval {$r = Apache2::RequestUtil-&gt;request };
         }
         elsif &#40;Apache-&gt;can&#40;&#39;push_handlers&#39;&#41;&#41; {
             $r = &#39;Apache&#39;;

Thanks!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;17&nbsp;09:13:54&nbsp;2009</span>
    <span class="description">ek [...] univie.ac.at -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ek [...] univie.ac.at</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jun 02 00:56:49 2008, PGOLLUCCI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ll look at it on Monday &#40;its 1am my time&#41;, if I can&#39;t figure it out,
&gt; I&#39;ll just revert it and release 1.08.
</div>
Hi! I was wondering about that new release. We have a similar problem
with a PerlProcessConnectionHandler, which does not have a
Request-object either and have to apply local patches currently. Is
there any chance we can get rid of that in the near future?

Thanks,
Heinz
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;21&nbsp;09:49:53&nbsp;2009</span>
    <span class="description">NWELLNHOF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jun 02 00:56:49 2008, PGOLLUCCI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Blast, completely my fault for not testing it.
&gt; 
&gt;  <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Bug/Display.html?id=29209">http://rt.cpan.org/Public/Bug/Display.html?id=29209</a></span>
&gt; 
&gt; Seems to have caused it.
</div>
Yes, I sent that patch and it&#39;s obviously the culprit.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ll look at it on Monday &#40;its 1am my time&#41;, if I can&#39;t figure it out,
&gt; I&#39;ll just revert it and release 1.08.
</div>
I think it&#39;s important to have the PerlCleanupHandler, but there is no
way to set it up transparently without the global request object.

Note that Apache::DBI checks the restart_count of server right before
the offending code. So everything should work if you connect to the DB
during startup only when restart_count == 1. But this doesn&#39;t work if
you want to open a DB connection when restart_count != 1.

I don&#39;t know if there is a reliable way to detect if Apache is in the
startup phase. But why not add the eval like lkundrak suggested?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;08&nbsp;04:42:36&nbsp;2009</span>
    <span class="description">peter [...] axomic.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Hi Philip,

This bug is now proving to be more of a problem as Apache::DBI 1.07 is
getting included in distributions such as Fedora 10 and 11. A fix &#40;or
rollback as version 1.08&#41; would be great! It is a real showstopper if
you are using database connections at Apache startup.

If you use the following test setup with Apache, setup.pl will run fine
the first time and then bail out when restart_count &gt; 1. Apache won&#39;t
start properly.

Putting an eval around DBI-&gt;connect&#40;&#41; does not seem to be a fix for this
particular case.


/tmp/startup.pl
=================================================================

#! /usr/bin/perl -w

use strict;
use warnings;
use Data::Dumper;
use Apache::DBI;
#use DBI;

eval {
    DBI-&gt;connect&#40;&#39;dbi:mysql:database=Test;host=localhost;port=3306&#39;,
                 &#39;test&#39;,
                 &#39;test&#39;,
                 {&#39;RaiseError&#39;=&gt;&#39;1&#39;}&#41;;
};

1;
=================================================================


/etc/httpd/conf.d/Apache_DBI_Test.conf
=================================================================

ServerName Apache_DBI_Test
User       apache
Group      apache

&lt;IfModule !perl_module&gt;
 LoadModule perl_module modules/mod_perl.so
&lt;/IfModule&gt;

&lt;VirtualHost *:80&gt;
  PerlConfigRequire /tmp/startup.pl
&lt;/VirtualHost&gt;
=================================================================

Many Thanks

Peter Walsham
Axomic Ltd
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;24&nbsp;19:33:22&nbsp;2009</span>
    <span class="description">mkent [...] magoazul.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 10 09:52:17 2008, lkundrak wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Jun 02 00:56:49 2008, PGOLLUCCI wrote:
<div class="message-stanza open">&gt; &gt; I&#39;ll look at it on Monday &#40;its 1am my time&#41;, if I can&#39;t figure it out,
&gt; &gt; I&#39;ll just revert it and release 1.08.
</div>&gt; 
&gt; I&#39;m wondering if you have a fix for the issue? What we&#39;ve done to
&gt; address the issue was to simply eval {} it, which fixes the
&gt; no-http-request issue, but I doubt it is correct for mod_perl 1.x and
&gt; would break rollback for people w/o global apache request handler.
&gt; 
&gt; diff -up Apache-DBI-1.07/lib/Apache/DBI.pm.noreq
&gt; Apache-DBI-1.07/lib/Apache/DBI.pm
&gt; --- Apache-DBI-1.07/lib/Apache/DBI.pm.noreq     2008-12-10
&gt; 15:38:53.000000000 +0100
&gt; +++ Apache-DBI-1.07/lib/Apache/DBI.pm   2008-12-10 15:40:50.000000000
</div>+0100
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; @@ -141,7 +141,9 @@ sub connect {
&gt;      if &#40;!$Rollback{$Idx}&#41; {
&gt;          my $r;
&gt;          if &#40;MP2&#41; {
&gt; -            $r = Apache2::RequestUtil-&gt;request;
&gt; +            # We may not actually be in a request, but in &lt;Perl&gt; &#40;or
&gt; +            # equivalent such as startup.pl&#41;, in which case this
</div>would die.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; +            eval {$r = Apache2::RequestUtil-&gt;request };
&gt;          }
&gt;          elsif &#40;Apache-&gt;can&#40;&#39;push_handlers&#39;&#41;&#41; {
&gt;              $r = &#39;Apache&#39;;
&gt; 
&gt; Thanks!
</div>
This fixes it for me.

Any chance of rolling a new release with this patch?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;24&nbsp;19:34:52&nbsp;2009</span>
    <span class="description">mkent [...] magoazul.com -  Cc mkent added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;14&nbsp;15:00:10&nbsp;2009</span>
    <span class="description">JSWARTZ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I&#39;m wondering if you have a fix for the issue? What we&#39;ve done to
&gt; &gt; address the issue was to simply eval {} it, which fixes the
&gt; &gt; no-http-request issue, but I doubt it is correct for mod_perl 1.x and
&gt; &gt; would break rollback for people w/o global apache request handler.
&gt; &gt; 
&gt; &gt; diff -up Apache-DBI-1.07/lib/Apache/DBI.pm.noreq
&gt; &gt; Apache-DBI-1.07/lib/Apache/DBI.pm
&gt; &gt; --- Apache-DBI-1.07/lib/Apache/DBI.pm.noreq     2008-12-10
&gt; &gt; 15:38:53.000000000 +0100
&gt; &gt; +++ Apache-DBI-1.07/lib/Apache/DBI.pm   2008-12-10 15:40:50.000000000
</div>&gt; +0100
<div class="message-stanza open">&gt; &gt; @@ -141,7 +141,9 @@ sub connect {
&gt; &gt;      if &#40;!$Rollback{$Idx}&#41; {
&gt; &gt;          my $r;
&gt; &gt;          if &#40;MP2&#41; {
&gt; &gt; -            $r = Apache2::RequestUtil-&gt;request;
&gt; &gt; +            # We may not actually be in a request, but in &lt;Perl&gt; &#40;or
&gt; &gt; +            # equivalent such as startup.pl&#41;, in which case this
</div>&gt; would die.
<div class="message-stanza open">&gt; &gt; +            eval {$r = Apache2::RequestUtil-&gt;request };
&gt; &gt;          }
&gt; &gt;          elsif &#40;Apache-&gt;can&#40;&#39;push_handlers&#39;&#41;&#41; {
&gt; &gt;              $r = &#39;Apache&#39;;
&gt; &gt; 
&gt; &gt; Thanks!
</div>&gt; 
&gt; This fixes it for me.
&gt; 
&gt; Any chance of rolling a new release with this patch?
</div>
This fixes it for me as well. But it was frustrating to struggle with
the &#34;PerlOptions +GlobalRequest&#34; red herring before finally finding this
bug report.

Why can&#39;t a new release be rolled with this simple patch? Or at the
*very* least, a comment pointing to this bug report to avoid future
developer confusion?

Is anyone there? :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;03&nbsp;18:07:40&nbsp;2010</span>
    <span class="description">ABH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Paul Orrock asked me to have a look and I took the patch and pushed it out as v1.08.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;03&nbsp;18:07:41&nbsp;2010</span>
    <span class="description">ABH [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
