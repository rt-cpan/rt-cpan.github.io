<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #30588 for Mail-IMAPClient: </title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #30588 for Mail-IMAPClient: </h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Mail-IMAPClient">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Mail-IMAPClient">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Mail-IMAPClient">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Mail-IMAPClient">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-IMAPClient">Mail-IMAPClient CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">30588</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Mail-IMAPClient">Mail-IMAPClient</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
polettix [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-19960-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.99_02    </td>
  </tr>
  <tr id="CF-19961-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




IMAPClient.pm.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/380906/174290/IMAPClient.pm.diff">
Thu Nov 08 16:13:12 2007 (1.1k) by polettix [...] cpan.org
</a>
</font></li>
</ul>


Mail-IMAPClient-2.99_02-NewSocket.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/381236/174484/Mail-IMAPClient-2.99_02-NewSocket.diff">
Fri Nov 09 11:03:43 2007 (9.9k) by polettix [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=30588">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-380906" href="/Public/Bug/Display.html?id=30588#txn-380906">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;08&nbsp;16:13:12&nbsp;2007</span>
    <span class="description">polettix [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/380906/174287/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/174287">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

   using one&#39;s own socket is a nightmare at the moment: you have to setup
the socket &#40;fair&#41;, tell the client which socket to use &#40;fair&#41;, put the
client in Mail::IMAPClient::Connected state &#40;not so fair&#41;, explicitly
get rid of the server welcome message before doing anything with the
client &#40;ABSOLUTELY NOT fair&#41;.

At the moment, the connect&#40;&#41; method does two things: create an
IO::Socket::INET object and initialise the IMAP connection &#40;dealing with
the server welcome message&#41;, then optionally call login&#40;&#41; if some
conditions apply.

I&#39;d suggest factoring out the initialisation part into another method
that gets called by connect&#40;&#41;, and that can be called by anyone wishing
to provide her own socket &#40;i.e. using IO::Socket::SSL&#41;. The Socket&#40;&#41;
method would probably be the best choice for this task, but it would
break the current semantics so the decision is really up to you... the
maintainer.

The attached patch does exactly this, I called the new method
&#34;use_socket&#34; for lack of a better name. With it, you can do:

  my $imap = Mail::IMAPClient-&gt;new&#40;%imapargs&#41;;
  $imap-&gt;use_socket&#40;IO::Socket::SSL-&gt;new&#40;%args&#41;&#41;;

and connect via SSL :&#41; It would be great to have such feature directly
in the constructor, something like:

  my $imap = Mail::IMAPClient-&gt;new&#40;
    %imapargs,
    UseSocket =&gt; IO::Socket::SSL-&gt;new&#40;%sslargs&#41;,
  &#41;;

I also changed a bit in $code extraction and verification, in particular
there were errors in how $code was checked:

* the regexes lacked the /i modifier, which is present in the $code
extraction line;
* the alternative for &#34;NO&#34; had a stray space.

Regards,

   Flavio.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> IMAPClient.pm.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/380906/174290/IMAPClient.pm.diff">Download IMAPClient.pm.diff</a><br />
<span class="downloadcontenttype">text/x-diff 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- IMAPClient.pm.orig	2007-11-08 21:32:55.464707168 +0100
+++ IMAPClient.pm	2007-11-08 21:48:25.905258704 +0100
@@ -248,34 +248,42 @@
     unless&#40;$sock&#41;
     {   $self-&gt;LastError&#40;&#34;Unable to connect to $server: $@&#34;&#41;;
         return undef;
     }
 
     $self-&gt;_debug&#40;&#34;Connected to $server&#34;&#41;;
+
+    return $self-&gt;use_socket&#40;$sock&#41;;
+}
+
+sub use_socket {
+    my $self = shift;
+    my &#40;$sock&#41; = @_;
+
     $self-&gt;Socket&#40;$sock&#41;;
     $self-&gt;State&#40;Connected&#41;;
 
     my $code;
   LINE:
     while&#40;my $output = $self-&gt;_read_line&#41;
     {   foreach my $o &#40;@$output&#41;
         {   $self-&gt;_record&#40;$self-&gt;Count, $o&#41;;
             next unless $o-&gt;[TYPE] eq &#34;OUTPUT&#34;;
 
-            $code = $o-&gt;[DATA] =~ /^\*\s+&#40;OK|BAD|NO|PREAUTH&#41;/i ? $1 : undef;
+            $code = $o-&gt;[DATA] =~ /^\*\s+&#40;OK|BAD|NO|PREAUTH&#41;/i ? uc&#40;$1&#41; : undef;
             last LINE;
         }
     }
     $code or return undef;
 
-    if&#40;$code =~ /BYE|NO /&#41;
+    if&#40;&#40;$code eq &#39;BYE&#39;&#41; || &#40;$code eq &#39;NO&#39;&#41;&#41;
     {   $self-&gt;State&#40;Unconnected&#41;;
         return undef;
     }
 
-    if&#40;$code =~ /PREAUTH/ &#41;
+    if&#40;$code eq &#39;PREAUTH&#39; &#41;
     {   $self-&gt;State&#40;Authenticated&#41;;
         return $self;
     }
 
     $self-&gt;User &#38;&#38; $self-&gt;Password ? $self-&gt;login : $self;
 }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-380939" href="/Public/Bug/Display.html?id=30588#txn-380939">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;08&nbsp;16:59:54&nbsp;2007</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #30588]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 8 Nov 2007 22:58:53 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> via RT &lt;bug-Mail-IMAPClient [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/380939/174315/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/174315">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">*  via RT &#40;bug-Mail-IMAPClient@rt.cpan.org&#41; [071108 21:13]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thu Nov 08 16:13:12 2007: Request 30588 was acted upon.
&gt; Transaction: Ticket created by POLETTIX
&gt;        Queue: Mail-IMAPClient
&gt;    Broken in: 2.99_02
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;    using one&#39;s own socket is a nightmare at the moment:
</div>
I agree

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;   my $imap = Mail::IMAPClient-&gt;new&#40;
&gt;     %imapargs,
&gt;     UseSocket =&gt; IO::Socket::SSL-&gt;new&#40;%sslargs&#41;,
&gt;   &#41;;
</div>
Wouldn&#39;t it be nicer to call use_socket always when a socket is
passed in?  You know: this will be version 3.0 of the module, which
is a major next release... small interface changes are permitted.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I also changed a bit in $code extraction and verification, in particular
&gt; there were errors in how $code was checked:
&gt; 
&gt; * the regexes lacked the /i modifier, which is present in the $code
&gt; extraction line;
&gt; * the alternative for &#34;NO&#34; had a stray space.
</div>
Gladly accepted.
Could you also take a look at the documentation about this subject, in
the pod file.
-- 
Thanks for the patch,

               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-380940" href="/Public/Bug/Display.html?id=30588#txn-380940">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;08&nbsp;16:59:59&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-381236" href="/Public/Bug/Display.html?id=30588#txn-381236">#</a>      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;09&nbsp;11:03:42&nbsp;2007</span>
    <span class="description">polettix [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Proposed change to Socket method/parameter</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> POLETTIX [...] cpan.org</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/381236/174481/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/174481">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Wouldn&#39;t it be nicer to call use_socket always when a socket is
&gt; passed in?  You know: this will be version 3.0 of the module, which
&gt; is a major next release... small interface changes are permitted.
</div>
Following your suggestion, I attach a new patch that does the following:

* rename the previous &#34;Socket&#34; method to &#34;RawSocket&#34;
* handle a &#34;RawSocket&#34; parameter in the constructor
* change &#34;Socket&#34; method/parameter semantics according to what we&#39;re
discussing. In particular, the connect&#40;&#41; method ends with a call to
Socket&#40;&#41; to complete the initialisation phase and call login&#40;&#41; if
applicable.
* changed the documentation where &#40;I thought&#41; it was due. I added
documentation for the new &#34;RawSocket&#34; and changed the documentation for
&#34;Socket&#34;, pointing out the changed semantics. 

The attached patch also fixes a couple of bugs in _read_line&#40;&#41;. There
was also a bug in t/basic.t by the way, as you can see from the patch.
Are these bugs a leftover of your overall code revision/rewrite?

Cheers,

   Flavio.

PS: I apologise for not filling a &#34;Subject&#34; line in my first post, I
hate when this happens...
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/381236/174484/Mail-IMAPClient-2.99_02-NewSocket.diff">Download Mail-IMAPClient-2.99_02-NewSocket.diff</a><br />
<span class="downloadcontenttype">text/x-diff 9.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -r -u Mail-IMAPClient-2.99_02/lib/Mail/IMAPClient.pm Mail-IMAPClient-2.99_02-NewSocket/lib/Mail/IMAPClient.pm
--- Mail-IMAPClient-2.99_02/lib/Mail/IMAPClient.pm	2007-10-26 11:46:16.000000000 +0200
+++ Mail-IMAPClient-2.99_02-NewSocket/lib/Mail/IMAPClient.pm	2007-11-09 16:33:13.260957272 +0100
@@ -108,7 +108,7 @@
 # removed
 sub EnableServerResponseInLiteral {undef}
 
-sub Socket&#40;;$&#41;
+sub RawSocket&#40;;$&#41;
 {   my &#40;$self, $sock&#41; = @_;
     defined $sock
         or return $self-&gt;{Socket};
@@ -222,7 +222,14 @@
     }
 
     if&#40;$self-&gt;{Socket}&#41;    { $self-&gt;Socket&#40;$self-&gt;{Socket}&#41; }
-    elsif&#40;$self-&gt;{Server}&#41; { return $self-&gt;connect }
+    
+    if&#40;$self-&gt;{Rawsocket}&#41; {
+        my $sock = delete $self-&gt;{Rawsocket};
+        # Ignore Rawsocket if Socket has already been set -- TODO carp/croak?
+        $self-&gt;RawSocket&#40;$sock&#41; unless $self-&gt;{Socket};
+    }
+
+    if&#40;!$self-&gt;{Socket} &#38;&#38; $self-&gt;{Server}&#41; { return $self-&gt;connect }
 
     $self;
 }
@@ -251,7 +258,16 @@
     }
 
     $self-&gt;_debug&#40;&#34;Connected to $server&#34;&#41;;
-    $self-&gt;Socket&#40;$sock&#41;;
+
+    return $self-&gt;Socket&#40;$sock&#41;;
+}
+
+sub Socket
+{   my &#40;$self, $sock&#41; = @_;
+    defined $sock
+        or return $self-&gt;{Socket};
+
+    $self-&gt;RawSocket&#40;$sock&#41;;
     $self-&gt;State&#40;Connected&#41;;
 
     my $code;
@@ -261,18 +277,18 @@
         {   $self-&gt;_record&#40;$self-&gt;Count, $o&#41;;
             next unless $o-&gt;[TYPE] eq &#34;OUTPUT&#34;;
 
-            $code = $o-&gt;[DATA] =~ /^\*\s+&#40;OK|BAD|NO|PREAUTH&#41;/i ? $1 : undef;
+            $code = $o-&gt;[DATA] =~ /^\*\s+&#40;OK|BAD|NO|PREAUTH&#41;/i ? uc&#40;$1&#41; : undef;
             last LINE;
         }
     }
     $code or return undef;
 
-    if&#40;$code =~ /BYE|NO /&#41;
+    if&#40;&#40;$code eq &#39;BYE&#39;&#41; || &#40;$code eq &#39;NO&#39;&#41;&#41;
     {   $self-&gt;State&#40;Unconnected&#41;;
         return undef;
     }
 
-    if&#40;$code =~ /PREAUTH/ &#41;
+    if&#40;$code eq &#39;PREAUTH&#39;&#41;
     {   $self-&gt;State&#40;Authenticated&#41;;
         return $self;
     }
@@ -1327,7 +1343,7 @@
 
             my $litstring = $iBuffer;
 
-            while&#40;$expected_size &gt; length $iBuffer&#41;
+            while&#40;$expected_size &gt; length $litstring&#41;
             {   if&#40;$timeout&#41;
                 {    # wait for data from the the IMAP socket.
                      my $rvec = 0;
@@ -1346,7 +1362,7 @@
                     if $fast_io &#38;&#38; defined $self-&gt;{_fcntl};
 
                 my $ret = $self-&gt;_sysread&#40;$socket
-                , \$litstring, $expected_size - $litstring, length $litstring&#41;;
+                , \$litstring, $expected_size - length $litstring, length $litstring&#41;;
 
                 $self-&gt;_debug&#40;&#34;Received ret=$ret and buffer = &#34; .
                    &#34;\n$litstring&lt;END&gt;\nwhile processing LITERAL&#34;&#41;;
diff -r -u Mail-IMAPClient-2.99_02/lib/Mail/IMAPClient.pod Mail-IMAPClient-2.99_02-NewSocket/lib/Mail/IMAPClient.pod
--- Mail-IMAPClient-2.99_02/lib/Mail/IMAPClient.pod	2007-10-26 10:16:30.000000000 +0200
+++ Mail-IMAPClient-2.99_02-NewSocket/lib/Mail/IMAPClient.pod	2007-11-09 15:02:45.293133808 +0100
@@ -119,13 +119,40 @@
 of setting an I&lt;Authmechanism&gt; you can just pass the authmechanism as
 the first argument to AUTHENTICATE.
 
-=item Socket Parameter
+=item Socket, RawSocket Parameters
 
-The I&lt;Socket&gt; parameter holds a reference to the socket
-connection. Normally this is set for you by the L&lt;connect&gt; method, but
+Both parameters hold a reference to the socket connection. 
+Normally this is set for you by the L&lt;connect&gt; method, but
 if you are implementing an advanced authentication technique you may
 choose to set up your own socket connection and then set this parameter
-manually, bypassing the B&lt;connect&gt; method completely.
+manually, bypassing the B&lt;connect&gt; method completely. This is also
+useful if you want to use L&lt;IO::Socket::INET&gt; alternatives, like
+L&lt;IO::Socket::SSL&gt;.
+
+The I&lt;RawSocket&gt; parameter simply records the socket to use for future
+operations, without attempting any interaction on it. In this case, you
+have to be sure to handle all the preliminar operations and to manually
+set the B&lt;Mail::IMAPClient&gt; object in sync with its actual status with
+respect to this socket &#40;see below for additional parameters regarding
+this, especially the I&lt;State&gt; parameter&#41;.
+
+The I&lt;Socket&gt; parameter, instead, also attempts to carry on preliminar
+phases if the conditions apply. If both parameters are present, this
+takes the precedence over I&lt;RawSocket&gt;. It is primarily used to
+provide an alternative socket for communications, e.g. to use
+L&lt;IO::Socket::SSL&gt; instead of L&lt;IO::Socket::INET&gt; used by L&lt;connect&gt;
+by default.
+
+
+B&lt;  NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE&gt;
+
+As of version 3 of this module, the I&lt;Socket&gt; parameter has changed 
+semantics to make it more &#34;DWIM&#34;. The I&lt;RawSocket&gt; parameter was 
+introduced as a replacement for the I&lt;Socket&gt; parameter in older
+version.
+
+B&lt;  NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE&gt;
+
 
 =item State, Server, Proxy, Password, and User Parameters
 
@@ -3229,6 +3256,47 @@
 This parameter has no affect on the B&lt;search&gt; method when B&lt;search&gt;
 is called in a list context.
 
+=head2 RawSocket
+
+Example:
+
+	$Socket = $imap-&gt;RawSocket&#40;&#41;;
+	# or:
+	$imap-&gt;RawSocket&#40;$socket_fh&#41;;
+
+The I&lt;RawSocket&gt; method can be used to obtain the socket handle of the
+current connection &#40;say, to do I/O on the connection that is not
+otherwise supported by B&lt;Mail::IMAPClient&gt;&#41; or to replace the current
+socket with a new handle &#40;for instance an SSL handle, see
+L&lt;IO::Socket::SSL&gt;, but be sure to see the L&lt;Socket&gt; method as well&#41;. 
+
+If you supply a socket handle yourself, either by doing something like:
+
+	 $imap=Mail::IMAPClient-&gt;new&#40;RawSocket=&gt;$sock, User =&gt; ... &#41;;
+
+or by doing something like:
+
+	 $imap=Mail::IMAPClient-&gt;new&#40;User =&gt; $user, Password =&gt; $pass, Server =&gt; $host&#41;;
+	 # blah blah blah
+	 $imap-&gt;RawSocket&#40;$ssl&#41;;
+
+then it will be up to you to establish the connection AND to
+authenticate, either via the L&lt;login&gt; method, or the fancier
+L&lt;authenticate&gt;, or, since you know so much anyway, by just doing raw
+I/O against the socket until you&#39;re logged in. If you do any of this
+then you should also set the L&lt;State&gt; parameter yourself to reflect the
+current state of the object &#40;i.e. Connected, Authenticated, etc&#41;. 
+
+Note that no operation will be attempted on the socket when this method
+is called. In particular, after the TCP connections towards the IMAP
+server is established, the protocol mandates the server to send an
+initial greeting message, and you will have to explicitly cope with
+this message before doing any other operation, e.g. trying to call
+L&lt;login&gt;. Caveat emptor.
+
+For a more DWIM approach to setting the socket see L&lt;Socket&gt;.
+
+
 =head2 Readmethod IMAP, BUFFER, LENGTH, OFFSET
 
 This parameter, if supplied, should contain a reference to a subroutine
@@ -3246,7 +3314,7 @@
 Note that this method completely replaces reads from the connection
 to the server, so if you define one of these then your subroutine will
 have to actually do the read. It is for things like this that we have
-the L&lt;Socket&gt; parameter and eponymous accessor method.
+the L&lt;RawSocket&gt;, L&lt;Socket&gt; parameters and eponymous accessor methods.
 
 Your I&lt;Readmethod&gt; will probably need to know more than this to do
 whatever it does.  It is recommended that you tuck all other pertinent
@@ -3292,6 +3360,14 @@
 
 =head2 Socket
 
+B&lt;  NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE&gt;
+
+The semantics of this method has changed as of version 3 of this module.
+If you need the old semantics, you now have to use L&lt;RawSocket&gt;.
+
+B&lt;  NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE NOTE&gt;
+
+
 Example:
 
 	$Socket = $imap-&gt;Socket&#40;&#41;;
@@ -3314,14 +3390,48 @@
 	 # blah blah blah
 	 $imap-&gt;Socket&#40;$ssl&#41;;
 
-then it will be up to you to establish the connection AND to
-authenticate, either via the L&lt;login&gt; method, or the fancier
-L&lt;authenticate&gt;, or, since you know so much anyway, by just doing raw
-I/O against the socket until you&#39;re logged in. If you do any of this
-then you should also set the L&lt;State&gt; parameter yourself to reflect the
-current state of the object &#40;i.e. Connected, Authenticated, etc&#41;. 
+then it will be up to you to establish the connection, i.e. make sure
+that C&lt;$ssl&gt; in the example is a valid and connected socket.
+
+This method is primarily used to provide a drop-in replacement for
+L&lt;IO::Socket::INET&gt;, used by L&lt;connect&gt; by default. In fact, this method
+is called by L&lt;connect&gt; itself after having established a suitable
+L&lt;IO::Socket::INET&gt; socket connection towards the target server; for
+this reason, this method also carries the normal operations associated
+with L&lt;connect&gt;, namely:
+
+=over 
+
+=item *
+
+read the initial greeting message from the server;
+
+=item *
+
+call L&lt;login&gt; if the conditions apply &#40;see L&lt;connect&gt; for details&#41;;
+
+=item *
+
+leave the I&lt;Mail::IMAPClient&gt; object in a suitable state.
+
+=back
+
+For these reasons, the following example will work &#34;out of the box&#34;:
+
+   use IO::Socket::SSL;
+   my $imap = Mail::IMAPClient-&gt;new&#40;
+      User     =&gt; &#39;your-username&#39;,
+      Password =&gt; &#39;your-password&#39;,
+      Socket   =&gt; IO::Socket::SSL-&gt;new&#40;
+         Proto    =&gt; &#39;tcp&#39;,
+         PeerAddr =&gt; &#39;some.imap.server&#39;,
+         PeerPort =&gt; 993, # IMAP over SSL standard port
+      &#41;,
+   &#41;;
+
+If you need more control over the socket, e.g. you have to implement a fancier
+authentication method, see L&lt;RawSocket&gt;.
 
-=cut
 
 =head2 Timeout
 
diff -r -u Mail-IMAPClient-2.99_02/t/basic.t Mail-IMAPClient-2.99_02-NewSocket/t/basic.t
--- Mail-IMAPClient-2.99_02/t/basic.t	2007-10-26 11:47:03.000000000 +0200
+++ Mail-IMAPClient-2.99_02-NewSocket/t/basic.t	2007-11-09 16:59:20.436710344 +0100
@@ -176,7 +176,7 @@
 my $flaghash = $imap-&gt;flags&#40;\@hits&#41;;
 my $flagflag = 0;
 foreach my $v &#40; values %$flaghash &#41;
-{   $flagflag += grep /\\Deleted/, @$v;
+{   $flagflag++ if grep /\\Deleted/, @$v;
 }
 cmp_ok&#40;$flagflag, &#39;==&#39;, scalar @hits&#41;;
 
@@ -187,9 +187,8 @@
 
 $flaghash = $imap-&gt;flags&#40;\@hits&#41;;
 foreach my $v &#40; values %$flaghash &#41;
-{   for my $f &#40;@$v&#41;
-    {   $flagflag -= 1 unless grep /\\Deleted/, $f;
-    }
+{
+    $flagflag-- unless grep /\\Deleted/, @$v;
 }
 cmp_ok&#40;$flagflag, &#39;==&#39;, 0&#41;;
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-381445" href="/Public/Bug/Display.html?id=30588#txn-381445">#</a>      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;09&nbsp;15:54:38&nbsp;2007</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #30588] Proposed change to Socket method/parameter</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 9 Nov 2007 21:54:10 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> via RT &lt;bug-Mail-IMAPClient [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/381445/174612/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/174612">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">*  via RT &#40;bug-Mail-IMAPClient@rt.cpan.org&#41; [071109 16:03]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Following your suggestion, I attach a new patch that does the following:
&gt; * rename the previous &#34;Socket&#34; method to &#34;RawSocket&#34;
&gt; * handle a &#34;RawSocket&#34; parameter in the constructor
&gt; * change &#34;Socket&#34; method/parameter semantics according to what we&#39;re
&gt; discussing. In particular, the connect&#40;&#41; method ends with a call to
&gt; Socket&#40;&#41; to complete the initialisation phase and call login&#40;&#41; if
&gt; applicable.
&gt; * changed the documentation where &#40;I thought&#41; it was due. I added
&gt; documentation for the new &#34;RawSocket&#34; and changed the documentation for
&gt; &#34;Socket&#34;, pointing out the changed semantics. 
</div>
All marvelous changes!  Great!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The attached patch also fixes a couple of bugs in _read_line&#40;&#41;.
</div>
My IMAP provider sends everything at once, so I did not enter the
while&#40;&#41; loop.  Again thanks!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There
&gt; was also a bug in t/basic.t by the way, as you can see from the patch.
&gt; Are these bugs a leftover of your overall code revision/rewrite?
</div>
Can you explain me why these are bugs?

 foreach my $v &#40; values %$flaghash &#41;
-{   $flagflag += grep /\\Deleted/, @$v;
+{   $flagflag++ if grep /\\Deleted/, @$v;
 }
 cmp_ok&#40;$flagflag, &#39;==&#39;, scalar @hits&#41;;

@@ -187,9 +187,8 @@

 $flaghash = $imap-&gt;flags&#40;\@hits&#41;;
 foreach my $v &#40; values %$flaghash &#41;
-{   for my $f &#40;@$v&#41;
-    {   $flagflag -= 1 unless grep /\\Deleted/, $f;
-    }
+{
+    $flagflag-- unless grep /\\Deleted/, @$v;
 }

In the first case, I increase $flagflags for each Deleted in @$v,
in the second, I decrease it for each Deleted.  Your rewrite adds
one and decreases only one.

In my set-up, the tests pass.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; PS: I apologise for not filling a &#34;Subject&#34; line in my first post, I
&gt; hate when this happens...
</div>
Happens to me often as well.  And I did not find a way to correct it.

By the way: I did not volutarily took over Mail::IMAPClient maintenance,
but had to do it because my MailBox module partly depends on it.  There
are many users, so at least someone has to apply patches.

After a full rewrite &#40;maybe you have noticed&#41; I think the module can
have a new life.  Of course, I will have introduced a few new bugs.
If possible, I would like to find a new maintainer for the new code
base... I have more than enough modules already.  Feel invited ;-&#41;

Thank you very much, so far!
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
drs Mark A.C.J. Overmeer                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-381611" href="/Public/Bug/Display.html?id=30588#txn-381611">#</a>      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;09&nbsp;23:27:22&nbsp;2007</span>
    <span class="description">flavio [...] polettix.it -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #30588] Proposed change to Socket method/parameter</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 10 Nov 2007 05:36:26 +0100 &#40;CET&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-IMAPClient [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Flavio Poletti&#34; &lt;flavio [...] polettix.it&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/381611/174710/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/174710">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; There
&gt;&gt; was also a bug in t/basic.t by the way, as you can see from the patch.
&gt;&gt; Are these bugs a leftover of your overall code revision/rewrite?
</div>&gt;
&gt; Can you explain me why these are bugs?
&gt;
&gt;  foreach my $v &#40; values %$flaghash &#41;
&gt; -{   $flagflag += grep /\\Deleted/, @$v;
&gt; +{   $flagflag++ if grep /\\Deleted/, @$v;
&gt;  }
&gt;  cmp_ok&#40;$flagflag, &#39;==&#39;, scalar @hits&#41;;
&gt;
&gt; @@ -187,9 +187,8 @@
&gt;
&gt;  $flaghash = $imap-&gt;flags&#40;\@hits&#41;;
&gt;  foreach my $v &#40; values %$flaghash &#41;
&gt; -{   for my $f &#40;@$v&#41;
&gt; -    {   $flagflag -= 1 unless grep /\\Deleted/, $f;
&gt; -    }
&gt; +{
&gt; +    $flagflag-- unless grep /\\Deleted/, @$v;
&gt;  }
&gt;
&gt; In the first case, I increase $flagflags for each Deleted in @$v,
&gt; in the second, I decrease it for each Deleted.  Your rewrite adds
&gt; one and decreases only one.
&gt;
&gt; In my set-up, the tests pass.
</div>
Only the second one is a bug &#40;for me&#41;, the first change was actually only
to address my paranoic approach. The original code:

 {   $flagflag += grep /\\Deleted/, @$v;

added the number of &#34;\\Deleted&#34; found in @$v. I don&#39;t really know what&#39;s
supposed to be there, and if it can ever contain more than one &#34;\\Deleted&#34;
given the test&#39;s previous setup and, also, what I think that should be in
@$v. Anyway, so far, so good.

But I then came with a problem in the following test, i.e. the one
decreasing $flagflag:

 {   for my $f &#40;@$v&#41;
     {   $flagflag -= 1 unless grep /\\Deleted/, $f;
     }

This is plain wrong for me. In my test, I got a single, empty @$v &#40;see
example below&#41;, so I don&#39;t ever go inside the for to decrease $flagflag. I
thought that it could be right, i.e. if the message does not have any flag
set, why should @$v contain anything? But again, feel free to be rude in
contradicting me, because I don&#39;t really know what&#39;s supposed to be inside
@$v. Anyway, I changed this into:

 {
     $flagflag-- unless grep /\\Deleted/, @$v;

which made sense: decrease only if &#34;Deleted&#34; is missing from the flags
array. This in turn cried for a &#40;paranoid&#41; modification in the $flagflag
build, in order to make the increase process match with the new decrease
one, which yielded to:

 {   $flagflag++ if grep /\\Deleted/, @$v;

Of course, if the &#39;\\Deleted&#39; flag is present only a single time in @$v
this is exactly equal to your original code. But I don&#39;t give this as a
truth and, moreover, I found it more readable and maintainable to have
these two processes be based on the same idea. Moreover, if &#39;\\Deleted&#39; is
actually present more than one time in the former loop, how can I express
its &#34;is lacking more than one time&#34; in the latter?

To bake up an example, I added a &#34;use Data::Dumper;&#34; and a couple of
&#39;diag&#40;&#34;flaghash:\n&#34; . Dumper&#40;$flaghash&#41;&#41;;&#39; immediately after $flaghash
reading. Running through &#39;prove -vl lib t/basic.t&#39; gives:

...
ok 37 - delete hits
# flaghash:
# $VAR1 = {
#           &#39;1&#39; =&gt; [
#                    &#39;\\Deleted&#39;
#                  ]
#         };
ok 38
ok 39 - no hits expected
ok 40 - restore messages
# flaghash:
# $VAR1 = {
#           &#39;1&#39; =&gt; []
#         };
ok 41
...

which justifies the increment but not the decrement in the original test
code &#40;&#39;1&#39; points to an empty array, so there&#39;s no getting into the for
loop&#41;. I&#39;d be curious to see which flags you get back in your tests, even
if I suspect that you&#39;re increasing on &#39;\\Deleted&#39; and decreasing on
something else, and just getting the correct result by luck ;&#41;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; By the way: I did not volutarily took over Mail::IMAPClient maintenance,
&gt; but had to do it because my MailBox module partly depends on it.  There
&gt; are many users, so at least someone has to apply patches.
&gt;
&gt; After a full rewrite &#40;maybe you have noticed&#41; I think the module can
&gt; have a new life.  Of course, I will have introduced a few new bugs.
&gt; If possible, I would like to find a new maintainer for the new code
&gt; base... I have more than enough modules already.  Feel invited ;-&#41;
</div>
I&#39;ll consider this very carefully, even if I&#39;m using Mail::IMAPClient for
something slightly more than a toy, and I never had issues so far. My
interest in SSL support has popped up only to play a bit with the new
Google IMAP access &#40;see <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=649742&#41;">http://www.perlmonks.org/?node_id=649742&#41;</a></span> -- and
this is *definitively* a toy at the moment.

Maybe the only reason why I could take this module&#39;s maintenance is to get
rid of that awful indentation &gt;:-&gt; And now, let the holy war start! :&#41;

Of course I&#39;m joking -- &#34;de gustibus non disputandum est&#34;, at least when
readability is not compromised. You took the module so far, you have the
right to adapt it to your coding standards.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thank you very much, so far!
</div>
It&#39;s a pleasure to work with someone constructively responsive :&#41;

Cheers,

   Flavio.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-381733" href="/Public/Bug/Display.html?id=30588#txn-381733">#</a>      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;10&nbsp;14:58:12&nbsp;2007</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #30588] Proposed change to Socket method/parameter</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 10 Nov 2007 20:57:41 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Flavio Poletti via RT &lt;bug-Mail-IMAPClient [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/381733/174761/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/174761">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Flavio Poletti via RT &#40;bug-Mail-IMAPClient@rt.cpan.org&#41; [071110 04:27]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Only the second one is a bug &#40;for me&#41;, the first change was actually only
&gt; to address my paranoic approach. The original code:
</div>
Your are correct, &#40;of course&#41;  The second test was wroint.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; added the number of &#34;\\Deleted&#34; found in @$v. I don&#39;t really know what&#39;s
&gt; supposed to be there, and if it can ever contain more than one &#34;\\Deleted&#34;
&gt; given the test&#39;s previous setup and, also, what I think that should be in
&gt; @$v. Anyway, so far, so good.
</div>
Yes, you could find more than one... but not if you check only one
message... I did not try to be smart in translating the messages.

The follow test-script works as expected

   #!/usr/bin/perl
   use warnings;
   use strict;
   
   my $flagflag = 0;
   my %flaghash = &#40; 1 =&gt; [&#39;\\Deleted&#39;], 2 =&gt; [&#39;\\Deleted&#39;] &#41;;
   
   foreach my $v &#40;values %flaghash&#41;
   {   $flagflag++ if grep /\\Deleted/, @$v;
   }
   
   print &#34;1st $flagflag\n&#34;;
   
   %flaghash = &#40;1 =&gt; [], 2 =&gt; [&#39;\\Deleted&#39;]&#41;;
   
   foreach my $v &#40;values %flaghash&#41;
   {  $flagflag -= 1 unless grep /\\Deleted/, @$v;
   }
   
   print &#34;2st $flagflag\n&#34;;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; By the way: I did not voluntarily took over Mail::IMAPClient maintenance,
</div></div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ll consider this very carefully, even if I&#39;m using Mail::IMAPClient for
&gt; something slightly more than a toy, and I never had issues so far.
</div>
I never use IMAP, so you win ;-&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Of course I&#39;m joking -- &#34;de gustibus non disputandum est&#34;, at least when
&gt; readability is not compromised. You took the module so far, you have the
&gt; right to adapt it to your coding standards.
</div>
The style is easier to understand, is my experience as Perl teacher.
And, at least it is an attempt to be consequent.

I will release 2.99_04, with all your fixes in a moment.  Start getting
somewhere, thanks to help.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-382657" href="/Public/Bug/Display.html?id=30588#txn-382657">#</a>      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;13&nbsp;06:04:55&nbsp;2007</span>
    <span class="description">MARKOV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rawsocket/socket</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/382657/175281/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/175281">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 15b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">probably solved
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-382660" href="/Public/Bug/Display.html?id=30588#txn-382660">#</a>      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;13&nbsp;06:05:03&nbsp;2007</span>
    <span class="description">MARKOV [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.631445</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
