<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #65079 for Apache2-AuthNetLDAP: Patch to add group membership criteria</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #65079 for Apache2-AuthNetLDAP: Patch to add group membership criteria</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Apache2-AuthNetLDAP/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Apache2-AuthNetLDAP/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Apache2-AuthNetLDAP/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Apache2-AuthNetLDAP/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Apache2-AuthNetLDAP">Apache2-AuthNetLDAP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">65079</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Apache2-AuthNetLDAP/Active/">Apache2-AuthNetLDAP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
reg.cpan [...] entropy.ch

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-2344-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.01    </td>
  </tr>
  <tr id="CF-2345-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;24&nbsp;17:27:46&nbsp;2011</span>
    <span class="description">reg.cpan [...] entropy.ch -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Patch to add group membership criteria</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Apache2-AuthNetLDAP-groupquery.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- /Users/local/Desktop/AuthNetLDAP.pm	2011-01-24 11:33:54.000000000 -0800
+++ /Library/Perl/5.10.0/Apache2/AuthNetLDAP.pm	2011-01-24 14:20:19.000000000 -0800
@@ -46,6 +46,8 @@
    my $uidattr = $r-&gt;dir_config&#40;&#39;UIDAttr&#39;&#41; || &#34;uid&#34;;
    my $allowaltauth = $r-&gt;dir_config&#40;&#39;AllowAlternateAuth&#39;&#41; || &#34;no&#34;; 
    my $ldapfilter = $r-&gt;dir_config&#40;&#39;LDAPFilter&#39;&#41; || &#34;&#34;;
+   my $groupquery_filter = $r-&gt;dir_config&#40;&#39;LDAPGroupQueryFilter&#39;&#41; || &#34;&#34;;
+   my $groupquery_basedn = $r-&gt;dir_config&#40;&#39;LDAPGroupQueryBaseDN&#39;&#41; || &#34;&#34;;
    my $start_TLS = $r-&gt;dir_config&#40;&#39;UseStartTLS&#39;&#41; || &#34;no&#34;;
    my $scope = $r-&gt;dir_config&#40;&#39;SearchScope&#39;&#41; || &#34;sub&#34;;
    my $pwattr = $r-&gt;dir_config&#40;&#39;AlternatePWAttribute&#39;&#41; || &#34;&#34;;
@@ -104,6 +106,7 @@
    my $filter = $ldapfilter
        ? &#34;&#40;&#38;$ldapfilter&#40;$uidattr=$user&#41;&#41;&#34;
        : &#34;&#40;$uidattr=$user&#41;&#34;;
+
   $mesg = $ldap-&gt;search&#40;
                   base =&gt; $basedn,
                   scope =&gt; $scope,                  
@@ -160,6 +163,7 @@
    }
    else
    {
+warn&#40;&#34;ldap auth via bind&#34;&#41;;
        $mesg = $ldap-&gt;bind&#40;$entry-&gt;dn&#40;&#41;,password=&gt;$password&#41;;
    }
  
@@ -173,6 +177,29 @@
         my $dn = $entry-&gt;dn&#40;&#41;;
         # $r-&gt;log_error&#40;&#34;AUTHDEBUG user $dn:$password bind: $error&#34;,$r-&gt;uri&#41;;
 
+
+   if &#40;$groupquery_filter &#38;&#38; $groupquery_basedn&#41; {
+	$groupquery_filter =~ s/\$uid/$user/g;
+
+	$mesg = $ldap-&gt;search&#40;
+		base =&gt; $groupquery_basedn,
+		scope =&gt; &#39;sub&#39;,                  
+		filter =&gt; $groupquery_filter,
+	&#41;;
+
+	if &#40;my $error = $mesg-&gt;code&#40;&#41;&#41; {
+	        $r-&gt;note_basic_auth_failure;
+	        $r-&gt;log_error&#40;&#34;user $user: LDAP Connection Failed: $error&#34;,$r-&gt;uri&#41;;
+	        return Apache2::Const::HTTP_UNAUTHORIZED;
+	}
+
+	unless &#40;$mesg-&gt;count&#40;&#41;&#41; {
+        	$r-&gt;note_basic_auth_failure;
+		$r-&gt;log_error&#40;&#34;user $user: LDAP group query &#39;$groupquery_filter&#39; returned no results, rejecting for &#34; , $r-&gt;uri&#41;;
+		return Apache2::Const::HTTP_UNAUTHORIZED;
+	}
+   }
+
    return Apache2::Const::OK;
 }
 # Autoload methods go after =cut, and are processed by the autosplit program.
@@ -196,6 +223,13 @@
  PerlSetVar LDAPPort 389
  #PerlSetVar UIDAttr uid
  PerlSetVar UIDAttr mail
+
+ # Use these two if you need to verify group membership in a separate group tree
+ # and your user entries don&#39;t have a memberOf attribute. The string $uid is replaced with
+ # the user id.
+ #PerlSetVar LDAPGroupQueryFilter &#34;&#40;&#38;&#40;|&#40;cn=foo-bar-group&#41;&#40;cn=baz-group&#41;&#41;&#40;memberUid=$uid&#41;&#41;&#34;
+ #PerlSetVar LDAPGroupQueryBaseDN &#34;cn=groups,dc=example,dc=com&#34;
+
  #PerlSetVar AlternatePWAttribute alternateAttribute
  #PerlSetVar SearchScope base | one | sub # default is sub
  #PerlSetVar LDAPFilter &#34;&#40;&#38;&#40;course=CSA&#41;&#40;class=A&#41;&#41;&#34; #optional
@@ -296,6 +330,18 @@
 depends on openssl.  Of course, the LDAP server must support Start TLS
 also.
 
+=item PerlSetVar LDAPGroupQueryFilter
+
+Optional, must be an LDAP search filter expression. A * character will
+be replaced with the user id. This search query is run after a user has
+been authenticated successfully to further restrict the allowed users to
+members of particular groups.
+
+=item PerlSetVar LDAPGroupQueryBaseDN
+
+Mandatory if LDAPGroupQueryFilter is used. This is the search base DND for
+the group query search.
+
 =back
 
 =head2 Uses for UIDAttr
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;24&nbsp;17:31:18&nbsp;2011</span>
    <span class="description">reg.cpan [...] entropy.ch -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Updated patch.

This patch adds the ability to check if a user is a member of one or more groups in a separate 
subtree.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Apache2-AuthNetLDAP-groupquery-1.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- /Users/local/Desktop/AuthNetLDAP.pm	2011-01-24 11:33:54.000000000 -0800
+++ /Library/Perl/5.10.0/Apache2/AuthNetLDAP.pm	2011-01-24 14:20:19.000000000 -0800
@@ -46,6 +46,8 @@
    my $uidattr = $r-&gt;dir_config&#40;&#39;UIDAttr&#39;&#41; || &#34;uid&#34;;
    my $allowaltauth = $r-&gt;dir_config&#40;&#39;AllowAlternateAuth&#39;&#41; || &#34;no&#34;; 
    my $ldapfilter = $r-&gt;dir_config&#40;&#39;LDAPFilter&#39;&#41; || &#34;&#34;;
+   my $groupquery_filter = $r-&gt;dir_config&#40;&#39;LDAPGroupQueryFilter&#39;&#41; || &#34;&#34;;
+   my $groupquery_basedn = $r-&gt;dir_config&#40;&#39;LDAPGroupQueryBaseDN&#39;&#41; || &#34;&#34;;
    my $start_TLS = $r-&gt;dir_config&#40;&#39;UseStartTLS&#39;&#41; || &#34;no&#34;;
    my $scope = $r-&gt;dir_config&#40;&#39;SearchScope&#39;&#41; || &#34;sub&#34;;
    my $pwattr = $r-&gt;dir_config&#40;&#39;AlternatePWAttribute&#39;&#41; || &#34;&#34;;
@@ -104,6 +106,7 @@
    my $filter = $ldapfilter
        ? &#34;&#40;&#38;$ldapfilter&#40;$uidattr=$user&#41;&#41;&#34;
        : &#34;&#40;$uidattr=$user&#41;&#34;;
+
   $mesg = $ldap-&gt;search&#40;
                   base =&gt; $basedn,
                   scope =&gt; $scope,                  
@@ -160,6 +163,7 @@
    }
    else
    {
+warn&#40;&#34;ldap auth via bind&#34;&#41;;
        $mesg = $ldap-&gt;bind&#40;$entry-&gt;dn&#40;&#41;,password=&gt;$password&#41;;
    }
  
@@ -173,6 +177,29 @@
         my $dn = $entry-&gt;dn&#40;&#41;;
         # $r-&gt;log_error&#40;&#34;AUTHDEBUG user $dn:$password bind: $error&#34;,$r-&gt;uri&#41;;
 
+
+   if &#40;$groupquery_filter &#38;&#38; $groupquery_basedn&#41; {
+	$groupquery_filter =~ s/\$uid/$user/g;
+
+	$mesg = $ldap-&gt;search&#40;
+		base =&gt; $groupquery_basedn,
+		scope =&gt; &#39;sub&#39;,                  
+		filter =&gt; $groupquery_filter,
+	&#41;;
+
+	if &#40;my $error = $mesg-&gt;code&#40;&#41;&#41; {
+	        $r-&gt;note_basic_auth_failure;
+	        $r-&gt;log_error&#40;&#34;user $user: LDAP Connection Failed: $error&#34;,$r-&gt;uri&#41;;
+	        return Apache2::Const::HTTP_UNAUTHORIZED;
+	}
+
+	unless &#40;$mesg-&gt;count&#40;&#41;&#41; {
+        	$r-&gt;note_basic_auth_failure;
+		$r-&gt;log_error&#40;&#34;user $user: LDAP group query &#39;$groupquery_filter&#39; returned no results, rejecting for &#34; , $r-&gt;uri&#41;;
+		return Apache2::Const::HTTP_UNAUTHORIZED;
+	}
+   }
+
    return Apache2::Const::OK;
 }
 # Autoload methods go after =cut, and are processed by the autosplit program.
@@ -196,6 +223,13 @@
  PerlSetVar LDAPPort 389
  #PerlSetVar UIDAttr uid
  PerlSetVar UIDAttr mail
+
+ # Use these two if you need to verify group membership in a separate group tree
+ # and your user entries don&#39;t have a memberOf attribute. The string $uid is replaced with
+ # the user id.
+ #PerlSetVar LDAPGroupQueryFilter &#34;&#40;&#38;&#40;|&#40;cn=foo-bar-group&#41;&#40;cn=baz-group&#41;&#41;&#40;memberUid=$uid&#41;&#41;&#34;
+ #PerlSetVar LDAPGroupQueryBaseDN &#34;cn=groups,dc=example,dc=com&#34;
+
  #PerlSetVar AlternatePWAttribute alternateAttribute
  #PerlSetVar SearchScope base | one | sub # default is sub
  #PerlSetVar LDAPFilter &#34;&#40;&#38;&#40;course=CSA&#41;&#40;class=A&#41;&#41;&#34; #optional
@@ -296,6 +330,18 @@
 depends on openssl.  Of course, the LDAP server must support Start TLS
 also.
 
+=item PerlSetVar LDAPGroupQueryFilter
+
+Optional, must be an LDAP search filter expression. A * character will
+be replaced with the user id. This search query is run after a user has
+been authenticated successfully to further restrict the allowed users to
+members of particular groups.
+
+=item PerlSetVar LDAPGroupQueryBaseDN
+
+Mandatory if LDAPGroupQueryFilter is used. This is the search base DND for
+the group query search.
+
 =back
 
 =head2 Uses for UIDAttr
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;24&nbsp;17:31:19&nbsp;2011</span>
    <span class="description">reg.cpan [...] entropy.ch -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;24&nbsp;19:58:46&nbsp;2011</span>
    <span class="description">reg.cpan [...] entropy.ch -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yet another updated patch.

I reworked it completely and group membership checks are now integrated with the &#34;require 
group&#34; directive.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Apache2-AuthNetLDAP-groupquery.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- /Users/local/Desktop/AuthNetLDAP.pm	2011-01-24 11:33:54.000000000 -0800
+++ /Library/Perl/5.10.0/Apache2/AuthNetLDAP.pm	2011-01-24 16:51:31.000000000 -0800
@@ -104,6 +104,7 @@
    my $filter = $ldapfilter
        ? &#34;&#40;&#38;$ldapfilter&#40;$uidattr=$user&#41;&#41;&#34;
        : &#34;&#40;$uidattr=$user&#41;&#34;;
+
   $mesg = $ldap-&gt;search&#40;
                   base =&gt; $basedn,
                   scope =&gt; $scope,                  
@@ -173,8 +174,72 @@
         my $dn = $entry-&gt;dn&#40;&#41;;
         # $r-&gt;log_error&#40;&#34;AUTHDEBUG user $dn:$password bind: $error&#34;,$r-&gt;uri&#41;;
 
+	return check_group_requirements&#40;$r, $ldap, $user&#41;;
+
+}
+
+
+sub check_group_requirements
+{
+	my &#40;$r, $ldap, $user&#41; = @_;
+
+	my @required_groups =
+		grep {$_}
+		map {/&#40;?:&#34;&#40;.+?&#41;&#34;|&#40;\S+&#41;&#41;/g}
+		map {/^group\s+&#40;.+&#41;/i}
+		map {$_-&gt;{requirement}}
+		@{$r-&gt;requires&#40;&#41; || []};
+
+	return Apache2::Const::OK unless @required_groups;
+
+	my $groupquery_filter = $r-&gt;dir_config&#40;&#39;LDAPGroupQueryFilter&#39;&#41; || &#34;&#34;;
+	my $groupquery_basedn = $r-&gt;dir_config&#40;&#39;LDAPGroupQueryBaseDN&#39;&#41; || &#34;&#34;;
+	my $groupquery_groupname_attribute = $r-&gt;dir_config&#40;&#39;LDAPGroupQueryGroupNameAttribute&#39;&#41; || &#34;cn&#34;;
+	my $groupquery_memberuid_attribute = $r-&gt;dir_config&#40;&#39;LDAPGroupQueryMemberUidAttribute&#39;&#41; || &#34;memberUid&#34;;
+
+	my $groupfilter = $groupquery_filter
+		? &#34;&#40;&#38;$groupquery_filter&#40;$groupquery_memberuid_attribute=$user&#41;&#41;&#34;
+		: &#34;&#40;$groupquery_memberuid_attribute=$user&#41;&#34;;
+
+	my $mesg = $ldap-&gt;search&#40;
+		base =&gt; $groupquery_basedn,
+		scope =&gt; &#39;sub&#39;,
+		filter =&gt; $groupfilter,
+		attrs =&gt; [$groupquery_groupname_attribute],
+	&#41;;
+
+	if &#40;my $error = $mesg-&gt;code&#40;&#41;&#41; {
+		$r-&gt;note_basic_auth_failure;
+		$r-&gt;log_error&#40;&#34;user $user: LDAP Connection Failed: $error&#34;,$r-&gt;uri&#41;;
+		return Apache2::Const::HTTP_UNAUTHORIZED;
+	}
+
+	my @assigned_groups =
+		grep {$_}
+		map {$_-&gt;get_value&#40;$groupquery_groupname_attribute&#41;}
+		$mesg-&gt;entries&#40;&#41;;
+
+	my $group_match;
+	foreach my $required_group &#40;@required_groups&#41; {
+		if &#40;grep {$_ eq $required_group} @assigned_groups&#41; {
+			$group_match = 1;
+#				warn&#40;&#34;Group match for $user: $required_group&#34;&#41;;
+			last;
+		}
+	}
+	
+	unless &#40;$group_match&#41; {
+		$r-&gt;note_basic_auth_failure;
+		my $groupstring = join&#40;&#34;, &#34;, @required_groups&#41;;
+		$r-&gt;log_error&#40;&#34;user $user not in one of the required groups &#40;$groupstring&#41;, rejecting for &#34; , $r-&gt;uri&#41;;
+		return Apache2::Const::HTTP_UNAUTHORIZED;
+	}
+
    return Apache2::Const::OK;
+
 }
+
+
 # Autoload methods go after =cut, and are processed by the autosplit program.
 
 # Below is the stub of documentation for your module. You better edit it!
@@ -196,6 +261,21 @@
  PerlSetVar LDAPPort 389
  #PerlSetVar UIDAttr uid
  PerlSetVar UIDAttr mail
+
+ # The following are for looking up LDAP group names and making them available for use with the
+ # &#34;require group&#34; directive.
+ # Use these if you need to verify group membership in a separate group tree
+ # and your user entries don&#39;t have a memberOf attribute &#40;in which case you could just use
+ # the LDAPFilter directive directly&#41;.
+ # You need to set at least LDAPGroupQueryBaseDN, the others might work with the default values
+ # &#40;LDAPGroupQueryGroupNameAttribute and LDAPGroupQueryMemberUidAttribute have the default
+ # values shown below&#41;.
+ #PerlSetVar LDAPGroupQueryGroupNameAttribute cn
+ #PerlSetVar LDAPGroupQueryMemberUidAttribute memberUid
+ #PerlSetVar LDAPGroupQueryFilter &#34;&#40;objectClass=posixGroup&#41;&#34;
+ PerlSetVar LDAPGroupQueryBaseDN &#34;cn=groups,dc=example,dc=com&#34;
+ require group some-ldap-group another-ldap-group
+
  #PerlSetVar AlternatePWAttribute alternateAttribute
  #PerlSetVar SearchScope base | one | sub # default is sub
  #PerlSetVar LDAPFilter &#34;&#40;&#38;&#40;course=CSA&#41;&#40;class=A&#41;&#41;&#34; #optional
@@ -296,6 +376,31 @@
 depends on openssl.  Of course, the LDAP server must support Start TLS
 also.
 
+=item PerlSetVar LDAPGroupQueryBaseDN
+
+Optional. If present, a search is performed in the given subtree for group objects with
+a memberUid attribute value corresponding to the current user. This search is performed
+after the user id itself is already authenticated.
+
+If objects are found, the group names &#40;from the cn attribute&#41; are compared to the values
+of the &#34;require group xxx&#34; directive. If there&#39;s a match, the authentication succeeds.
+If there is no &#34;require group&#34; directive, this directive is ignored.
+
+=item PerlSetVar LDAPGroupQueryGroupNameAttribute
+
+Optional, lets you change the group name attribute from the default &#34;cn&#34; when you use
+LDAPGroupQueryBaseDN.
+
+=item PerlSetVar LDAPGroupQueryMemberUidAttribute
+
+Optional, lets you change the member name attribute from the default &#34;memberUid&#34; when you use
+LDAPGroupQueryBaseDN.
+
+=item PerlSetVar LDAPGroupQueryFilter
+
+Optional, lets you restrict the set of loaded group objects when you use LDAPGroupQueryBaseDN.
+If present, it is combined with the filter that compares the member uid attribute.
+
 =back
 
 =head2 Uses for UIDAttr
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
