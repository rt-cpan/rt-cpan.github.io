<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #101876 for Sereal-Encoder: losing string value of semi-numeric string</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #101876 for Sereal-Encoder: losing string value of semi-numeric string</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Sereal-Encoder">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Sereal-Encoder">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Sereal-Encoder">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Sereal-Encoder">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/Sereal/Sereal/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Sereal-Encoder">Sereal-Encoder CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">101876</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Sereal-Encoder">Sereal-Encoder</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
zefram [...] fysh.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-245624-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-245625-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




seminumeric_simple_fix.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1459548/776649/seminumeric_simple_fix.patch">
Mon Feb 02 12:42:25 2015 (2.8k) by zefram [...] fysh.org
</a>
</font></li>
</ul>


seminumeric_test.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1459548/776648/seminumeric_test.patch">
Mon Feb 02 12:42:25 2015 (520b) by zefram [...] fysh.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=101876">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1459377" href="/Public/Bug/Display.html?id=101876#txn-1459377">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;02&nbsp;05:33:20&nbsp;2015</span>
    <span class="description">zefram [...] fysh.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> losing string value of semi-numeric string</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 2 Feb 2015 10:33:01 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sereal-Encoder [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1459377/776531/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/776531">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">$ perl -MSereal::Encoder=encode_sereal -MSereal::Decoder=decode_sereal -lwe &#39;print $]; print $Sereal::Encoder::VERSION; my $a=&#34;0 but true&#34;; print decode_sereal&#40;encode_sereal&#40;$a&#41;&#41;; my $b = $a+0; print $a; print decode_sereal&#40;encode_sereal&#40;$a&#41;&#41;;&#39;
5.018002
3.005
0 but true
0 but true
0

I believe the first encoding is representing $a as a string but the
second encoding is representing it as a pure integer, based on the IOK
flag.  In the case of this string, along with infinitely many others
such as &#34;00&#34;, &#34;01&#34;, and &#34;1 &#34;, the integer representation is lossy.
It&#39;s particularly significant for strings such as &#34;0 but true&#34; and &#34;00&#34;
which qualify as true but come out as false when mangled by the lossy
encoding.  But even when the truth value doesn&#39;t change, it is not at
all acceptable to lose the string value.

The underlying mistake is that you&#39;ve treated the IOK flag as implying
that the scalar is fully characterised by its IV.  In general that is
not the case.  For scalars that are both IOK and POK, to see whether
integer representation suffices you need to perform the IV-&gt;PV coercion
yourself, and see whether the PV generated from the IV matches the
scalar&#39;s actual PV.  Similar remarks apply to NOK and NV.  For extra fun,
the exact meaning of the [PIN]OK flags varies between Perl versions.

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1459380" href="/Public/Bug/Display.html?id=101876#txn-1459380">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;02&nbsp;05:51:08&nbsp;2015</span>
    <span class="description">demerphq [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> perlbug [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101876] losing string value of semi-numeric string</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 2 Feb 2015 11:50:57 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sereal-Encoder [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> demerphq &lt;demerphq [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1459380/776534/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/776534">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2 February 2015 at 11:33, Zefram via RT
&lt;bug-Sereal-Encoder@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Mon Feb 02 05:33:20 2015: Request 101876 was acted upon.
&gt; Transaction: Ticket created by zefram@fysh.org
&gt;        Queue: Sereal-Encoder
&gt;      Subject: losing string value of semi-numeric string
&gt;    Broken in: &#40;no value&#41;
&gt;     Severity: &#40;no value&#41;
&gt;        Owner: Nobody
&gt;   Requestors: zefram@fysh.org
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101876">https://rt.cpan.org/Ticket/Display.html?id=101876</a></span> &gt;
&gt;
&gt;
&gt; $ perl -MSereal::Encoder=encode_sereal -MSereal::Decoder=decode_sereal -lwe &#39;print $]; print $Sereal::Encoder::VERSION; my $a=&#34;0 but true&#34;; print decode_sereal&#40;encode_sereal&#40;$a&#41;&#41;; my $b = $a+0; print $a; print decode_sereal&#40;encode_sereal&#40;$a&#41;&#41;;&#39;
&gt; 5.018002
&gt; 3.005
&gt; 0 but true
&gt; 0 but true
&gt; 0
&gt;
&gt; I believe the first encoding is representing $a as a string but the
&gt; second encoding is representing it as a pure integer, based on the IOK
&gt; flag.  In the case of this string, along with infinitely many others
&gt; such as &#34;00&#34;, &#34;01&#34;, and &#34;1 &#34;, the integer representation is lossy.
&gt; It&#39;s particularly significant for strings such as &#34;0 but true&#34; and &#34;00&#34;
&gt; which qualify as true but come out as false when mangled by the lossy
&gt; encoding.  But even when the truth value doesn&#39;t change, it is not at
&gt; all acceptable to lose the string value.
&gt;
&gt; The underlying mistake is that you&#39;ve treated the IOK flag as implying
&gt; that the scalar is fully characterised by its IV.  In general that is
&gt; not the case.  For scalars that are both IOK and POK, to see whether
&gt; integer representation suffices you need to perform the IV-&gt;PV coercion
&gt; yourself, and see whether the PV generated from the IV matches the
&gt; scalar&#39;s actual PV.  Similar remarks apply to NOK and NV.  For extra fun,
&gt; the exact meaning of the [PIN]OK flags varies between Perl versions.
</div>
No. I disagree. This is a bug in perl itself.

$ perl -MDevel::Peek -le&#39;my $x=&#34;0 but true&#34;; my $y=0+$x; Dump&#40;$x&#41;&#39;
SV = PVIV&#40;0x7cdd88&#41; at 0x7d9a48
  REFCNT = 1
  FLAGS = &#40;PADMY,IOK,POK,pIOK,pPOK&#41;
  IV = 0
  PV = 0x7d2b90 &#34;0 but true&#34;\0
  CUR = 10
  LEN = 16

The IOK flag should NOT be set here, it should be pIOK only.

IOK means that the integer representation is either a&#41; canonical, or
b&#41; a faithful representation of the PV.

pIOK is supposed to mean that the cached value of the string can be
used, but that it is not a faithful representation of the string it
was derived from.

&#40;If IOK and pIOK do not mean these things then it is a total waste to
have both set of flags, which seems an unreasonable interpretation.&#41;

Compare to this:

$ perl -MDevel::Peek -le&#39;my $x=&#34;0blahblah&#34;; my $y=0+$x; Dump&#40;$x&#41;&#39;
SV = PVNV&#40;0x1bcaf10&#41; at 0x1beaa58
  REFCNT = 1
  FLAGS = &#40;PADMY,POK,pIOK,pNOK,pPOK&#41;
  IV = 0
  NV = 0
  PV = 0x1be3ba0 &#34;0blahblah&#34;\0
  CUR = 9

IMO this is clearly a bug in the special case logic for &#34;0 but true&#34;.
It should NOT set the IOK flag, it should set only the pIOK flag.

I will naturally try to fix this in Sereal, but I consider this a bug
in Perl and I am sending this to perlbug because of it.

cheers,
Yves


perl -Mre=debug -e &#34;/just|another|perl|hacker/&#34;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1459381" href="/Public/Bug/Display.html?id=101876#txn-1459381">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;02&nbsp;05:51:08&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1459392" href="/Public/Bug/Display.html?id=101876#txn-1459392">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;02&nbsp;07:19:14&nbsp;2015</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101876] losing string value of semi-numeric string</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 2 Feb 2015 12:19:00 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> demerphq via RT &lt;bug-Sereal-Encoder [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1459392/776542/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/776542">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">demerphq via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;IMO this is clearly a bug in the special case logic for &#34;0 but true&#34;.
</div>
The bug is certainly not in the &#34;0 but true&#34; special case.  The bug is not
specific to &#34;0 but true&#34;, but is also shared by &#34;00&#34;, &#34;1 &#34;, and the like.

$ perl -MDevel::Peek -lwe &#39;my $a=&#34;1 &#34;; my $b = $a+0; Dump $a&#39;
SV = PVIV&#40;0xb0d1b0&#41; at 0xb09b48
  REFCNT = 1
  FLAGS = &#40;PADMY,IOK,POK,pIOK,pPOK&#41;
  IV = 1
  PV = 0xb02020 &#34;1 &#34;\0
  CUR = 2
  LEN = 16

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;IOK means that the integer representation is either a&#41; canonical, or
&gt;b&#41; a faithful representation of the PV.
</div>
There is certainly a case to be made that the flag *should* mean that,
but de facto it doesn&#39;t mean that and never has.  It&#39;s never even been
close to that.  De facto, in current Perl the IOK flag means that the
scalar has an IV immediately available and *is an acceptable &#40;non-warning&#41;
operand for numeric operations*.  It currently looks rather pointless to
preserve this aspect of a scalar, because non-numeric operands actually
only warn on their first numeric operation, the one that generates the
IV and sets the pIOK flag.  &#40;On subsequent operations the pIOK flag
effectively muffles the warning despite the lack of IOK.&#41;  But that&#39;s
where we are: IOK tells you very little about the relationship between
the IV and PV slots &#40;even excluding dualvars&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&#40;If IOK and pIOK do not mean these things then it is a total waste to
&gt;have both set of flags, which seems an unreasonable interpretation.&#41;
</div>
What IOK actually represents does seem wasteful, considering how little
use is made of it.  Not a *total* waste, but a poor use of a precious
flag bit.  But being wasteful doesn&#39;t mean it isn&#39;t what actually happens.

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1459394" href="/Public/Bug/Display.html?id=101876#txn-1459394">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;02&nbsp;07:31:00&nbsp;2015</span>
    <span class="description">demerphq [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101876] losing string value of semi-numeric string</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 2 Feb 2015 13:30:49 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sereal-Encoder [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> demerphq &lt;demerphq [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1459394/776544/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/776544">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2 February 2015 at 13:19, Zefram via RT
&lt;bug-Sereal-Encoder@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Sereal-Encoder
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101876">https://rt.cpan.org/Ticket/Display.html?id=101876</a></span> &gt;
&gt;
&gt; demerphq via RT wrote:
<div class="message-stanza open">&gt;&gt;IMO this is clearly a bug in the special case logic for &#34;0 but true&#34;.
</div>&gt;
&gt; The bug is certainly not in the &#34;0 but true&#34; special case.  The bug is not
&gt; specific to &#34;0 but true&#34;, but is also shared by &#34;00&#34;, &#34;1 &#34;, and the like.
</div>
As far as I can tell it is a bug in the &#34;0 but true&#34; branch as it does
not set the IS_NUMBER_TRAILING flag.

And it seems to also be a bug in sv_2iuv_common&#40;&#41; which seems to not
check the IS_NUMBER_TRAILING flag that is set on these examples.

Actually I cant find *any* code that checks the IS_NUMBER_TRAILING flag.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; $ perl -MDevel::Peek -lwe &#39;my $a=&#34;1 &#34;; my $b = $a+0; Dump $a&#39;
&gt; SV = PVIV&#40;0xb0d1b0&#41; at 0xb09b48
&gt;   REFCNT = 1
&gt;   FLAGS = &#40;PADMY,IOK,POK,pIOK,pPOK&#41;
&gt;   IV = 1
&gt;   PV = 0xb02020 &#34;1 &#34;\0
&gt;   CUR = 2
&gt;   LEN = 16
&gt;
<div class="message-stanza open">&gt;&gt;IOK means that the integer representation is either a&#41; canonical, or
&gt;&gt;b&#41; a faithful representation of the PV.
</div>&gt;
&gt; There is certainly a case to be made that the flag *should* mean that,
&gt; but de facto it doesn&#39;t mean that and never has.  It&#39;s never even been
&gt; close to that.  De facto, in current Perl the IOK flag means that the
&gt; scalar has an IV immediately available and *is an acceptable &#40;non-warning&#41;
&gt; operand for numeric operations*.  It currently looks rather pointless to
&gt; preserve this aspect of a scalar, because non-numeric operands actually
&gt; only warn on their first numeric operation, the one that generates the
&gt; IV and sets the pIOK flag.  &#40;On subsequent operations the pIOK flag
&gt; effectively muffles the warning despite the lack of IOK.&#41;  But that&#39;s
&gt; where we are: IOK tells you very little about the relationship between
&gt; the IV and PV slots &#40;even excluding dualvars&#41;.
&gt;
<div class="message-stanza open">&gt;&gt;&#40;If IOK and pIOK do not mean these things then it is a total waste to
&gt;&gt;have both set of flags, which seems an unreasonable interpretation.&#41;
</div>&gt;
&gt; What IOK actually represents does seem wasteful, considering how little
&gt; use is made of it.  Not a *total* waste, but a poor use of a precious
&gt; flag bit.  But being wasteful doesn&#39;t mean it isn&#39;t what actually happens.
</div>
I am not sure that &#34;what happens&#34; is relevant here, I think that what
is relevant here is what *should* happen.

It seems to me we have bug on top of bug here that builds up the
status quo, and IMO it is better to fix the status quo than it is to
live with it.

This whole business is *insanely* complex and as you say the flags are
being poorly used. Lets fix this once and for all.

Yves
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1459397" href="/Public/Bug/Display.html?id=101876#txn-1459397">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;02&nbsp;08:01:53&nbsp;2015</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101876] losing string value of semi-numeric string</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 2 Feb 2015 13:01:40 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> demerphq via RT &lt;bug-Sereal-Encoder [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1459397/776547/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/776547">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">demerphq via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;As far as I can tell it is a bug in the &#34;0 but true&#34; branch as it does
&gt;not set the IS_NUMBER_TRAILING flag.
</div>
No, that&#39;s not a bug.  The special handling is precisely that the
trailing &#34;but true&#34; is not regarded as &#34;trailing trash&#34; &#40;which would
render the string non-numeric&#41;.  Note that trailing spaces are likewise
not regarded as trash, nor are leading spaces or leading zeroes.  If you
want grok_number_flags&#40;&#41; to detect non-canonical integer representations,
it would need a new output flag to represent that state and several new
bits of logic to set it.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;And it seems to also be a bug in sv_2iuv_common&#40;&#41; which seems to not
&gt;check the IS_NUMBER_TRAILING flag that is set on these examples.
</div>
sv_2iuv_common&#40;&#41; doesn&#39;t pass in the PERL_SCAN_TRAILING flag that
would request the IS_NUMBER_TRAILING flag to be used.  Without it, the
&#34;trailing trash&#34; case returns numtype==0 rather than a numtype with the
IS_NUMBER_TRAILING flag set.  It is the lack of the IS_NUMBER_IN_UV
flag, rather than the presence of IS_NUMBER_TRAILING, that controls
sv_2iuv_common&#40;&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;Actually I cant find *any* code that checks the IS_NUMBER_TRAILING flag.
</div>
I concur.  There&#39;s only one use of PERL_SCAN_TRAILING, connected with
magic incrementation, and it&#39;s being used to avoid getting numtype==0
rather than to get the IS_NUMBER_TRAILING flag.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;I am not sure that &#34;what happens&#34; is relevant here, I think that what
&gt;is relevant here is what *should* happen.
</div>
What happens is very relevant when processing strings on current Perl
versions and attempting to serialise data structures containing them.
Changing the behaviour of the IOK flag in future Perl versions wouldn&#39;t
invalidate the need for serialisation to preserve string values on
recent versions.

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1459402" href="/Public/Bug/Display.html?id=101876#txn-1459402">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;02&nbsp;08:31:34&nbsp;2015</span>
    <span class="description">demerphq [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101876] losing string value of semi-numeric string</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 2 Feb 2015 14:31:24 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sereal-Encoder [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> demerphq &lt;demerphq [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1459402/776551/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/776551">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2 February 2015 at 14:01, Zefram via RT
&lt;bug-Sereal-Encoder@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Sereal-Encoder
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101876">https://rt.cpan.org/Ticket/Display.html?id=101876</a></span> &gt;
&gt;
&gt; demerphq via RT wrote:
<div class="message-stanza open">&gt;&gt;As far as I can tell it is a bug in the &#34;0 but true&#34; branch as it does
&gt;&gt;not set the IS_NUMBER_TRAILING flag.
</div>&gt;
&gt; No, that&#39;s not a bug.  The special handling is precisely that the
&gt; trailing &#34;but true&#34; is not regarded as &#34;trailing trash&#34; &#40;which would
&gt; render the string non-numeric&#41;.  Note that trailing spaces are likewise
&gt; not regarded as trash, nor are leading spaces or leading zeroes.  If you
&gt; want grok_number_flags&#40;&#41; to detect non-canonical integer representations,
&gt; it would need a new output flag to represent that state and several new
&gt; bits of logic to set it.
</div>
It looks like a bug/oversight to me.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
<div class="message-stanza open">&gt;&gt;And it seems to also be a bug in sv_2iuv_common&#40;&#41; which seems to not
&gt;&gt;check the IS_NUMBER_TRAILING flag that is set on these examples.
</div>&gt;
&gt; sv_2iuv_common&#40;&#41; doesn&#39;t pass in the PERL_SCAN_TRAILING flag that
&gt; would request the IS_NUMBER_TRAILING flag to be used.
</div>
Yes, that is also true, probably because it calls the grok_number&#40;&#41;
wrapper which has  no way to pass in this flag.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Without it, the
&gt; &#34;trailing trash&#34; case returns numtype==0 rather than a numtype with the
&gt; IS_NUMBER_TRAILING flag set.  It is the lack of the IS_NUMBER_IN_UV
&gt; flag, rather than the presence of IS_NUMBER_TRAILING, that controls
&gt; sv_2iuv_common&#40;&#41;.
</div>
Yes I know. And my position is that that is the bug.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt;Actually I cant find *any* code that checks the IS_NUMBER_TRAILING flag.
</div>&gt;
&gt; I concur.  There&#39;s only one use of PERL_SCAN_TRAILING, connected with
&gt; magic incrementation, and it&#39;s being used to avoid getting numtype==0
&gt; rather than to get the IS_NUMBER_TRAILING flag.
</div>
Hrm.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt;I am not sure that &#34;what happens&#34; is relevant here, I think that what
&gt;&gt;is relevant here is what *should* happen.
</div>&gt;
&gt; What happens is very relevant when processing strings on current Perl
&gt; versions and attempting to serialise data structures containing them.
&gt; Changing the behaviour of the IOK flag in future Perl versions wouldn&#39;t
&gt; invalidate the need for serialisation to preserve string values on
&gt; recent versions.
</div>
I think the right plan is to fix Perl, and then fix Sereal to work
around previous versions.

The current state of this logic is completely unacceptable and not fit
for purpose. *an entire bit every sv to prevent &#34;not a number&#34;
warnings*? Wtf?

Yves



-- 
perl -Mre=debug -e &#34;/just|another|perl|hacker/&#34;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1459548" href="/Public/Bug/Display.html?id=101876#txn-1459548">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;02&nbsp;12:42:25&nbsp;2015</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101876] losing string value of semi-numeric string</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 2 Feb 2015 17:42:09 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> demerphq via RT &lt;bug-Sereal-Encoder [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1459548/776647/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/776647">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 702b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached are two patches.  The first adds failing test cases for
various kinds of semi-numeric string.  The second implements the
simplest possible fix: to prefer PV serialisation where multiple OK
flags are set.  This totally fixes strings, but at the expense of
both some space efficiency and, more importantly, behaviour on some
numeric values that have been coerced to string.  &#40;Those get POK set in
a way that&#39;s just as misleading as IOK being set on &#34;00&#34;.&#41;  For example,
Data::Float::nextup&#40;0.5&#41; stringifies as &#34;0.5&#34;, just as 0.5 does, so using
string encoding for it is lossy.  Fully general fix really needs to try
the implicit coercions, to see which slot fully describes the scalar.

-zefram
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1459548/776648/seminumeric_test.patch">Download seminumeric_test.patch</a><br />
<span class="downloadcontenttype">text/x-diff 520b</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1459548/776649/seminumeric_simple_fix.patch">Download seminumeric_simple_fix.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2.8k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.486167</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
