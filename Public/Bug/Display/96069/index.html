<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #96069 for Net-DNS: Protocol specific &#40;TCP or UDP&#41; Nameserver objects  &#40;patch included&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #96069 for Net-DNS: Protocol specific &#40;TCP or UDP&#41; Nameserver objects  &#40;patch included&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-DNS/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-DNS">Net-DNS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">96069</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-DNS/Active/">Net-DNS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jfesler [...] gigo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22454-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.76    </td>
  </tr>
  <tr id="CF-22455-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;29&nbsp;23:34:50&nbsp;2014</span>
    <span class="description">jfesler [...] gigo.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Protocol specific &#40;TCP or UDP&#41; Nameserver objects  &#40;patch included&#41;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Under high load, the CORE::select&#40;&#41; call eats 50% of the total consumed CPU.

The attached patch will

I have been able to work around this by modifying Net::DNS::Nameserver to 
open up just a UDP socket or just a TCP socket.  When opening just a single
UDP socket, and calling loop_once with 0 timeout, I skip select&#40;&#41; entirely
and go straight to read.  This very much doubled my load capacity for the 
Net::DNS::Nameserver based application.

Calls with either TCP or with multiple LocalAddr values will still require IO::Select.

I&#39;m submitting this hoping you&#39;ll accept it upstream.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> single-proto-patch.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">*** /usr/local/lib/perl/5.14.2/Net/DNS/Nameserver.pm	2014-05-23 14:41:23.000000000 -0700
--- lib/Net/DNS/Nameserver.pm	2014-05-29 20:34:25.736867551 -0700
***************
*** 18,23 ****
--- 18,24 ----
      $nameserver = new Net::DNS::Nameserver&#40;
  	LocalAddr	 =&gt; [&#39;::1&#39; , &#39;127.0.0.1&#39; ],
  	LocalPort	 =&gt; &#34;5353&#34;,
+ 	Proto            =&gt; &#34;both&#34;,
  	ReplyHandler =&gt; \&#38;reply_handler,
  	Verbose		 =&gt; 1,
  	Truncate	 =&gt; 0
***************
*** 95,100 ****
--- 96,102 ----
  	my $port = $self{LocalPort} || DEFAULT_PORT;
  	$self{Truncate}	   = 1	 unless defined&#40; $self{Truncate} &#41;;
  	$self{IdleTimeout} = 120 unless defined&#40; $self{IdleTimeout} &#41;;
+ 	$self{Proto}       = &#34;both&#34; unless &#40;defined $self{Proto} &#41;;
  
  	my @sock_tcp;						# All the TCP sockets we will listen to.
  	my @sock_udp;						# All the UDP sockets we will listen to.
***************
*** 107,113 ****
  		#--------------------------------------------------------------------------
  		# Create the TCP socket.
  		#--------------------------------------------------------------------------
! 
  		print &#34;\nCreating TCP socket $addr#$port - &#34; if $self{Verbose};
  
  		my $sock_tcp = inet_new&#40;
--- 109,115 ----
  		#--------------------------------------------------------------------------
  		# Create the TCP socket.
  		#--------------------------------------------------------------------------
!                if &#40;$self{Proto} =~ /^&#40;both|tcp&#41;$/&#41; {
  		print &#34;\nCreating TCP socket $addr#$port - &#34; if $self{Verbose};
  
  		my $sock_tcp = inet_new&#40;
***************
*** 124,135 ****
  		} else {
  			cluck &#34;Couldn&#39;t create TCP socket: $!&#34;;
  		}
  
  		#--------------------------------------------------------------------------
  		# Create the UDP Socket.
  		#--------------------------------------------------------------------------
  
! 		print &#34;Creating UDP socket $addr#$port - &#34; if $self{Verbose};
  
  		my $sock_udp = inet_new&#40;
  			LocalAddr =&gt; $addr,
--- 126,139 ----
  		} else {
  			cluck &#34;Couldn&#39;t create TCP socket: $!&#34;;
  		}
+                }
  
  		#--------------------------------------------------------------------------
  		# Create the UDP Socket.
  		#--------------------------------------------------------------------------
  
!                if &#40;$self{Proto} =~ /^&#40;both|udp&#41;$/&#41; {
!                 print &#34;Creating UDP socket $addr#$port - &#34; if $self{Verbose};
  
  		my $sock_udp = inet_new&#40;
  			LocalAddr =&gt; $addr,
***************
*** 143,149 ****
  		} else {
  			cluck &#34;Couldn&#39;t create UDP socket: $!&#34;;
  		}
! 
  	}
  
  	#--------------------------------------------------------------------------
--- 147,153 ----
  		} else {
  			cluck &#34;Couldn&#39;t create UDP socket: $!&#34;;
  		}
!                }
  	}
  
  	#--------------------------------------------------------------------------
***************
*** 158,163 ****
--- 162,175 ----
  	return undef unless $select-&gt;count;
  
  	#--------------------------------------------------------------------------
+ 	# Optimize for single-UDP-only case
+ 	#--------------------------------------------------------------------------
+         if &#40;$self{Proto} =~ /^&#40;both|udp&#41;$/&#41; {
+             if &#40;scalar @sock_udp == 1&#41; {
+                 $self{&#34;SingleUDPSocket&#34;}=$sock_udp[0];
+             }
+         }               
+ 	#--------------------------------------------------------------------------
  	# Return the object.
  	#--------------------------------------------------------------------------
  
***************
*** 448,453 ****
--- 460,473 ----
  
  	print &#34;;loop_once called with timeout: &#34; . &#40; defined&#40;$timeout&#41; ? $timeout : &#34;undefined&#34; &#41; . &#34;\n&#34;
  			if $self-&gt;{Verbose} &#38;&#38; $self-&gt;{Verbose} &gt; 4;
+ 			
+         # Optimize for single UDP socket case.
+         # Eliminates a large cost from CORE::select&#40;&#41;
+         if &#40;$self-&gt;{SingleUDPSocket}&#41; {
+           $self-&gt;udp_connection&#40;$self-&gt;{SingleUDPSocket}&#41;;
+           return;
+         }
+         
  	foreach my $sock &#40; keys %{$self-&gt;{_tcp}} &#41; {
  
  		# There is TCP traffic to handle
***************
*** 561,566 ****
--- 581,594 ----
  	Verbose		=&gt; 1
  	&#41;;
  
+     my $ns = new Net::DNS::Nameserver&#40;
+ 	LocalAddr	=&gt; &#34;10.1.2.3&#34;,
+ 	LocalPort	=&gt; &#34;5353&#34;,
+ 	ReplyHandler	=&gt; \&#38;reply_handler,
+ 	Verbose		=&gt; 1,
+ 	Proto           =&gt; &#39;udp&#39;
+ 	&#41;;
+ 
  
  
      my $ns = new Net::DNS::Nameserver&#40;
***************
*** 572,577 ****
--- 600,606 ----
  	&#41;;
  
  
+ 
  Returns a Net::DNS::Nameserver object, or undef if the object
  could not be created.
  
***************
*** 579,584 ****
--- 608,615 ----
  
      LocalAddr		IP address on which to listen.	Defaults to INADDR_ANY.
      LocalPort		Port on which to listen.	Defaults to 53.
+     Proto               Protocol to use; tcp, udp,      Defaults to &#34;both&#34;
+                         or both.
      ReplyHandler	Reference to reply-handling
  			subroutine			Required.
      NotifyHandler	Reference to reply-handling
***************
*** 599,604 ****
--- 630,637 ----
  also list IPv6 addresses and the default is &#39;0&#39; &#40;listen on all interfaces on
  IPv6 and IPv4&#41;;
  
+ The Proto setting, if specified, allows for the ability to bind
+ only a single protocol.  See L&lt;/OPTIMIZATIONS&gt;.
  
  The ReplyHandler subroutine is passed the query name, query class,
  query type and optionally an argument containing the peerhost, the
***************
*** 732,737 ****
--- 765,797 ----
  
      $ns-&gt;main_loop;
  
+ =head1 OPTIMIZATIONS
+ 
+ Normally, Net::DNS::Nameserver will bind to both UDP and TCP;
+ and can bind to multiple LocalAddr.  IO::Select is automatically
+ used to respond to the appropriate sockets.  Under high load,
+ CORE::select&#40;&#41; can chew significant CPU.
+ 
+ If you open just a single socket, for a single address,
+ for only UDP, then calls to loop_once&#40;0&#41; or main_loop&#40;&#41;
+ will skip the select&#40;&#41; call, and go straight to read&#40;&#41;;
+ 
+ Keep in mind, you may need to have a seperate process
+ that handles TCP; and/or seperate processes for IPv4 vs IPv6.
+ 
+     my $ns = new Net::DNS::Nameserver&#40;
+         LocalAddr    =&gt; &#34;0.0.0.0&#34;,
+ 	LocalPort    =&gt; 53,
+ 	Proto        =&gt; &#34;udp&#34;,
+ 	ReplyHandler =&gt; \&#38;reply_handler,
+ 	Verbose	     =&gt; 1
+ 	&#41; || die &#34;couldn&#39;t create nameserver object\n&#34;;
+ 
+     while&#40;1&#41; {
+        $ns-&gt;loop_once&#40;0&#41;;
+     }
+ 
+ 
  =head1 BUGS
  
  Limitations in perl 5.8.6 makes it impossible to guarantee that
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;29&nbsp;23:36:57&nbsp;2014</span>
    <span class="description">jfesler [...] gigo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jfesler [...] gigo.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The attached patch will
</div>
Ignore that line. Hit send too soon.

That said, the patch and description of the patch are as intended.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;16&nbsp;17:58:32&nbsp;2014</span>
    <span class="description">jfesler [...] gigo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jfesler [...] gigo.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Any chance of this getting adopted?   

The changes are particularly useful for handling higher volume queries against a single socket; and to maximize queries per second against a single CPU core.  These changes allow me to double my DNS serving capacity *per core*; and allow me to run multiple cores without the traditional pitfalls of multi-process using select&#40;&#41; against the same socket.

Tracking changes against this is a bit of a bummer. :-&#41;

Attached is an updated diff against 0.78
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Nameserver.pm.PATCH-from-0.78.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">*** Nameserver.pm.0.78	2014-08-16 14:49:33.140671435 -0700
--- Nameserver.pm	2014-08-16 14:51:51.875139456 -0700
***************
*** 18,23 ****
--- 18,24 ----
      $nameserver = new Net::DNS::Nameserver&#40;
  	LocalAddr	 =&gt; [&#39;::1&#39; , &#39;127.0.0.1&#39; ],
  	LocalPort	 =&gt; &#34;5353&#34;,
+ 	Proto            =&gt; &#34;both&#34;,
  	ReplyHandler =&gt; \&#38;reply_handler,
  	Verbose		 =&gt; 1,
  	Truncate	 =&gt; 0
***************
*** 95,100 ****
--- 96,102 ----
  	my $port = $self{LocalPort} || DEFAULT_PORT;
  	$self{Truncate}	   = 1	 unless defined&#40; $self{Truncate} &#41;;
  	$self{IdleTimeout} = 120 unless defined&#40; $self{IdleTimeout} &#41;;
+ 	$self{Proto}       = &#34;both&#34; unless &#40;defined $self{Proto} &#41;;
  
  	my @sock_tcp;						# All the TCP sockets we will listen to.
  	my @sock_udp;						# All the UDP sockets we will listen to.
***************
*** 108,113 ****
--- 110,116 ----
  		# Create the TCP socket.
  		#--------------------------------------------------------------------------
  
+                if &#40;$self{Proto} =~ /^&#40;both|tcp&#41;$/&#41; {
  		print &#34;\nCreating TCP socket $addr#$port - &#34; if $self{Verbose};
  
  		my $sock_tcp = inet_new&#40;
***************
*** 124,135 ****
  		} else {
  			cluck &#34;Couldn&#39;t create TCP socket: $!&#34;;
  		}
  
  		#--------------------------------------------------------------------------
  		# Create the UDP Socket.
  		#--------------------------------------------------------------------------
  
! 		print &#34;Creating UDP socket $addr#$port - &#34; if $self{Verbose};
  
  		my $sock_udp = inet_new&#40;
  			LocalAddr =&gt; $addr,
--- 127,140 ----
  		} else {
  			cluck &#34;Couldn&#39;t create TCP socket: $!&#34;;
  		}
+                }
  
  		#--------------------------------------------------------------------------
  		# Create the UDP Socket.
  		#--------------------------------------------------------------------------
  
!                if &#40;$self{Proto} =~ /^&#40;both|udp&#41;$/&#41; {
!                 print &#34;Creating UDP socket $addr#$port - &#34; if $self{Verbose};
  
  		my $sock_udp = inet_new&#40;
  			LocalAddr =&gt; $addr,
***************
*** 143,149 ****
  		} else {
  			cluck &#34;Couldn&#39;t create UDP socket: $!&#34;;
  		}
! 
  	}
  
  	#--------------------------------------------------------------------------
--- 148,154 ----
  		} else {
  			cluck &#34;Couldn&#39;t create UDP socket: $!&#34;;
  		}
!                }
  	}
  
  	#--------------------------------------------------------------------------
***************
*** 158,163 ****
--- 163,176 ----
  	return undef unless $select-&gt;count;
  
  	#--------------------------------------------------------------------------
+ 	# Optimize for single-UDP-only case
+ 	#--------------------------------------------------------------------------
+         if &#40;$self{Proto} =~ /^&#40;both|udp&#41;$/&#41; {
+             if &#40;scalar @sock_udp == 1&#41; {
+                 $self{&#34;SingleUDPSocket&#34;}=$sock_udp[0];
+             }
+         }               
+ 	#--------------------------------------------------------------------------
  	# Return the object.
  	#--------------------------------------------------------------------------
  
***************
*** 448,453 ****
--- 461,474 ----
  
  	print &#34;;loop_once called with timeout: &#34; . &#40; defined&#40;$timeout&#41; ? $timeout : &#34;undefined&#34; &#41; . &#34;\n&#34;
  			if $self-&gt;{Verbose} &#38;&#38; $self-&gt;{Verbose} &gt; 4;
+ 			
+         # Optimize for single UDP socket case.
+         # Eliminates a large cost from CORE::select&#40;&#41;
+         if &#40;$self-&gt;{SingleUDPSocket}&#41; {
+           $self-&gt;udp_connection&#40;$self-&gt;{SingleUDPSocket}&#41;;
+           return;
+         }
+         
  	foreach my $sock &#40; keys %{$self-&gt;{_tcp}} &#41; {
  
  		# There is TCP traffic to handle
***************
*** 561,566 ****
--- 582,595 ----
  	Verbose		=&gt; 1
  	&#41;;
  
+     my $ns = new Net::DNS::Nameserver&#40;
+ 	LocalAddr	=&gt; &#34;10.1.2.3&#34;,
+ 	LocalPort	=&gt; &#34;5353&#34;,
+ 	ReplyHandler	=&gt; \&#38;reply_handler,
+ 	Verbose		=&gt; 1,
+ 	Proto           =&gt; &#39;udp&#39;
+ 	&#41;;
+ 
  
  
      my $ns = new Net::DNS::Nameserver&#40;
***************
*** 572,577 ****
--- 601,607 ----
  	&#41;;
  
  
+ 
  Returns a Net::DNS::Nameserver object, or undef if the object
  could not be created.
  
***************
*** 579,584 ****
--- 609,616 ----
  
      LocalAddr		IP address on which to listen.	Defaults to INADDR_ANY.
      LocalPort		Port on which to listen.	Defaults to 53.
+     Proto               Protocol to use; tcp, udp,      Defaults to &#34;both&#34;
+                         or both.
      ReplyHandler	Reference to reply-handling
  			subroutine			Required.
      NotifyHandler	Reference to reply-handling
***************
*** 599,604 ****
--- 631,638 ----
  also list IPv6 addresses and the default is &#39;0&#39; &#40;listen on all interfaces on
  IPv6 and IPv4&#41;;
  
+ The Proto setting, if specified, allows for the ability to bind
+ only a single protocol.  See L&lt;/OPTIMIZATIONS&gt;.
  
  The ReplyHandler subroutine is passed the query name, query class,
  query type and optionally an argument containing the peerhost, the
***************
*** 732,737 ****
--- 766,798 ----
  
      $ns-&gt;main_loop;
  
+ =head1 OPTIMIZATIONS
+ 
+ Normally, Net::DNS::Nameserver will bind to both UDP and TCP;
+ and can bind to multiple LocalAddr.  IO::Select is automatically
+ used to respond to the appropriate sockets.  Under high load,
+ CORE::select&#40;&#41; can chew significant CPU.
+ 
+ If you open just a single socket, for a single address,
+ for only UDP, then calls to loop_once&#40;0&#41; or main_loop&#40;&#41;
+ will skip the select&#40;&#41; call, and go straight to read&#40;&#41;;
+ 
+ Keep in mind, you may need to have a seperate process
+ that handles TCP; and/or seperate processes for IPv4 vs IPv6.
+ 
+     my $ns = new Net::DNS::Nameserver&#40;
+         LocalAddr    =&gt; &#34;0.0.0.0&#34;,
+ 	LocalPort    =&gt; 53,
+ 	Proto        =&gt; &#34;udp&#34;,
+ 	ReplyHandler =&gt; \&#38;reply_handler,
+ 	Verbose	     =&gt; 1
+ 	&#41; || die &#34;couldn&#39;t create nameserver object\n&#34;;
+ 
+     while&#40;1&#41; {
+        $ns-&gt;loop_once&#40;0&#41;;
+     }
+ 
+ 
  =head1 BUGS
  
  Limitations in perl 5.8.6 makes it impossible to guarantee that
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;16&nbsp;19:32:31&nbsp;2014</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Aug 16 17:58:32 2014, jfesler wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Any chance of this getting adopted?
</div> 
Vanishingly small.

Net::DNS::Nameserver is a plaything intended for creating test responses.

Arguably, it is not even the best tool for doing that.

It is certainly *not* a production-grade nameserver implementation, never was, never will be.

The preamble to your request indicates that your issue was about performance, or rather, lack of it.

The easy way of solving that problem is to use BIND, Unbound, or any of the other dozen or so well supported nameserver implementations available.

All of these are well over an order of magnitude faster than Net::DNS::Nameserver will ever be, even if modified in the way you suggest.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;16&nbsp;19:32:32&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;16&nbsp;20:37:58&nbsp;2014</span>
    <span class="description">jfesler [...] gigo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jfesler [...] gigo.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">TL:DR?  Thanks for rejecting; I&#39;ll fork and move on.

--

Net::DNS has been extremely handy for a poor-man&#39;s GSLB.
Production quality or not, I&#39;m getting enough performance now 
to run out of HTTP before I run out of DNS.  And I&#39;m getting
the ability to act as a GSLB to distribute and route traffic
both based on ISP and on health checks.  Basically, a poor-man&#39;s
Akamai GTM, to support a non-revenue-generating public resource.

The &#34;Easy&#34; solutions you point out are not well suited for this. I actually have looked at the various mainstream DNS products.  For static queries, they&#39;ll all work fine.  For dynamic queries, the answers are less clear.  

bind9: no dynamic interface &#40;other than inserts/deletes using DDNS&#41;.  bind view ACLs too big when looking at the BGP routing table.  
bind10: not a viable product.
unbound: is not an auth
nsd: no dynamic interface &#40;unless I missed it&#41;
djbdns: no dynamic interface. 
pdns: pipe interface does exist; I could hook into that.  
  except it fails one of my critical use cases.
  *might* be possible as a LUA script.

I&#39;ve instead made Net::DNS do my bidding.  And, after profiling, I was able to make changes that cut the CPU utilization by literally half, with little additional CPU overhead for the default use case.

I&#39;m a bit bummed; but I understand.  I&#39;ll fork, and I&#39;ll move on.  I&#39;m even more bummed that I&#34;ll have to fork and stagnate the entire Net::DNS instead of just Net::DNS::Resolver, but such is life.

Thanks.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;17&nbsp;06:55:41&nbsp;2014</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Aug 16 20:37:58 2014, jfesler wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; TL:DR?  Thanks for rejecting; I&#39;ll fork and move on.
&gt; 
</div>[snip]


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m a bit bummed; but I understand.  I&#39;ll fork, and I&#39;ll move on.  I&#39;m
&gt; even more bummed that I&#34;ll have to fork and stagnate the entire
&gt; Net::DNS instead of just Net::DNS::Resolver, but such is life.
&gt; 
</div>Step back a little, and ask yourself whether it is reasonable to demand changes, for which you are the only user, and expect to offload the long-term maintenance commitment onto us. There is no such thing as a free lunch.

The Perl licensing terms allow you to modify the code in any way you choose.  Nothing prevents you from building it into your code, provided that you acknowledge the source and copyrights of the authors and contributors.

There is nothing to prevent your modified nameserver component depending on later versions of Net::DNS in the same way it does already.

If you are still not prepared to do the work, you might consider using the perlcc compiler.  Both the compiler and Net::DNS needed changes to make this work, so please make sure you use the latest revisions.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;17&nbsp;12:34:57&nbsp;2014</span>
    <span class="description">lem [...] itverx.com.ve -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #96069] Protocol specific &#40;TCP or UDP&#41; Nameserver objects  &#40;patch included&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 17 Aug 2014 09:34:33 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Luis Mu√±oz &lt;lem [...] itverx.com.ve&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">While Net:: DNS is commonly blamed to be slow, it&#39;s certainly the most flexible DNS framework out there.

The name server part of it might not be &#34;production grade&#34; as is now, but it can be used to implement interesting services. I&#39;ve done it in the past and the requestor seems to have done the same. I know that what I was doing at my time worked very well, can&#39;t speak for others&#39;  implementations.

Bottom line is, exotic tasks are easier to implement under Net::DNS then under any &#34;real&#34; name server.

To complement the advice to the requestor, you might want to consider putting a caching name server in front of your dynamic application. Responses won&#39;t be authoritative though &#40;but that could be fixed with rpz&#41;

Best regards

-lem

On August 17, 2014 3:55:42 AM PDT, Dick Franks via RT &lt;bug-Net-DNS@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       Queue: Net-DNS
&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=96069">https://rt.cpan.org/Ticket/Display.html?id=96069</a></span> &gt;
&gt;
&gt;On Sat Aug 16 20:37:58 2014, jfesler wrote:
<div class="message-stanza open">&gt;&gt; TL:DR?  Thanks for rejecting; I&#39;ll fork and move on.
&gt;&gt; 
</div>&gt;[snip]
&gt;
&gt;
<div class="message-stanza open">&gt;&gt; I&#39;m a bit bummed; but I understand.  I&#39;ll fork, and I&#39;ll move on. 
</div>&gt;I&#39;m
<div class="message-stanza open">&gt;&gt; even more bummed that I&#34;ll have to fork and stagnate the entire
&gt;&gt; Net::DNS instead of just Net::DNS::Resolver, but such is life.
&gt;&gt; 
</div>&gt;Step back a little, and ask yourself whether it is reasonable to demand
&gt;changes, for which you are the only user, and expect to offload the
&gt;long-term maintenance commitment onto us. There is no such thing as a
&gt;free lunch.
&gt;
&gt;The Perl licensing terms allow you to modify the code in any way you
&gt;choose.  Nothing prevents you from building it into your code, provided
&gt;that you acknowledge the source and copyrights of the authors and
&gt;contributors.
&gt;
&gt;There is nothing to prevent your modified nameserver component
&gt;depending on later versions of Net::DNS in the same way it does
&gt;already.
&gt;
&gt;If you are still not prepared to do the work, you might consider using
&gt;the perlcc compiler.  Both the compiler and Net::DNS needed changes to
&gt;make this work, so please make sure you use the latest revisions.
</div>
-- 
Sent from my Android device with K-9 Mail. Please excuse my brevity.
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;17&nbsp;13:30:54&nbsp;2014</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">So there you have it.

Three choices:

1&#41; Make Net::DNS::Nameserver run an order of magnitude faster by compiling it &#40;and supporting bits&#41; using perlcc.

2&#41; Limit the query load by putting a caching nameserver in front of it, and tune the overall scheme by suitable choice of TTLs.

3&#41; Engineer something faster and/or better.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;08&nbsp;08:18:16&nbsp;2014</span>
    <span class="description">NLNETLABS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
