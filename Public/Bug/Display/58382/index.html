<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #58382 for RT-Extension-CommandByMail: [PATCH] Read commands from headers, other patch integration</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #58382 for RT-Extension-CommandByMail: [PATCH] Read commands from headers, other patch integration</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/RT-Extension-CommandByMail/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/RT-Extension-CommandByMail/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/RT-Extension-CommandByMail/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/RT-Extension-CommandByMail/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/RT-Extension-CommandByMail">RT-Extension-CommandByMail CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">58382</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/RT-Extension-CommandByMail/Active/">RT-Extension-CommandByMail</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
stefan [...] cae.wisc.edu

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-39608-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-39609-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;14&nbsp;14:35:26&nbsp;2010</span>
    <span class="description">stefan [...] cae.wisc.edu -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] Read commands from headers, other patch integration</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">We wanted commands to be able to be read from headers so as to be more
transparent to users.  While the user-submitted patch to strip the
commands from the e-mail body was nice, it didn&#39;t work in all situations.

Here is a patch that allows commands to be read from headers.  The
default header is X-RT-Do: although it can be changed by a configuration
option.

To enable, set $CommandByMailDoHeaders to 1 in RT_SiteConfig.pm

If you want to use a different header, for example X-RT-DoCommand or
something, you can set that with $CommandByMailHeaderString in the file.
 If unset, it defaults to X-RT-Do:

This is based off of the 0.08_01 source.  A second patch will follow in
a second message that integrates several patches, and is more robust.

-stefan
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ReadFromHeaders.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- TakeAction.pm.orig	2010-06-14 13:28:32.000104000 -0500
+++ TakeAction.pm	2010-06-14 13:31:27.000182000 -0500
@@ -196,6 +196,19 @@
         }
     }
 
+	if &#40;$RT::Config-&gt;Get&#40;&#39;CommandByMailDoHeaders&#39;&#41;&#41; {
+		my $header_string = RT::Config-&gt;Get&#40;&#39;CommandByMailHeaderString&#39;&#41;;	
+		$header_string = &#40;defined&#40;$header_string&#41;&#41; ? $header_string : &#39;X-RT-Do&#39;;
+		# Read any X-RT-Do headers
+		my @command_headers = $args{&#39;Message&#39;}-&gt;get&#40;$header_string&#41;;
+	
+		foreach my $cmd &#40;@command_headers&#41; {
+			# make sure they follow the correct format, if good, put it at front
+	        next if $cmd !~ /^&#40;?:&#40;\S+&#40;?:{.*}&#41;?&#41;\s*?:\s*?&#40;.*&#41;\s*?|&#41;$/;
+			unshift @content, $cmd;
+		}
+	}
+
     my @items;
     my $found_pseudoheaders = 0;
     foreach my $line &#40;@content&#41; {
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;14&nbsp;14:46:06&nbsp;2010</span>
    <span class="description">stefan [...] cae.wisc.edu -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> stefan [...] cae.wisc.edu</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As promised, here is the full patch for the our implementation of RT.

This includes our header integration and also includes patches from:

* Francois Deppierraz for Command Stripping from the body &#40;Bug #31795&#41;
* Roderick Schertler for ignoring commands from unprivileged users &#40;Bug
#27333&#41;
* Bryan McLellan for e-mailing errors to a generic address &#40;Bug #40480&#41;

as well as our modifications to those patches.

The full list of variables available for use:

* $CommandByMailStripOut - set to 1 to strip commands from the body
* $CommandByMailErrorEmailAddress - set to whatever address you want
error messages to go to
* $CommandByMailErrorsToPrivileged - if set to 1, will e-mail errors to
the user if the user is privileged.  Use in conjunction with
$CommandByMailErrorEmailAddress.
* $CommandByMailDoHeaders - set to 1 to read commands from headers
* $CommandByMailHeaderString - set to whatever you want to use for a
header.  If unset, defaults to X-RT-Do
* $CommandByMailIgnoreBody - useful in conjunction with
$CommandByMailDoHeaders, if set to 1 will not even attempt to read
commands from the body
* $CommandByMailOnlyPrivileged - if set to 1, will only try commands if
the user is privileged

If none of the options are set, the code should still work.  Any
combination of options should work together as well, although some don&#39;t
make much sense &#40;Ignoring the body while not telling it to do headers,
for example, would make this extension unnecessary, and
ErrorsToPrivileged makes no sense without the ErrorEmailAddress set&#41;

Please let me know if you have any comments or run into any bugs - it
tested OK for us.

-stefan

On Mon Jun 14 14:35:26 2010, shortspecialbus wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; A second patch will follow in
&gt; a second message that integrates several patches, and is more robust.
&gt; 
&gt; -stefan
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> TakeActionAllChanges.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">159a160,170
&gt; 	
&gt; 	# If we have $RT::CommandByMailOnlyPrivileged set, then
&gt;     # Non-privileged users can&#39;t use this extension.  The main benefit
&gt;     # here is they won&#39;t accidentally try to &#40;&#34;Guys: My computer is on
&gt;     # fire!&#34;&#41; and get errors.
&gt; 	if &#40;$RT::CommandByMailOnlyPrivileged&#41; {
&gt; 	    unless &#40; $args{&#39;CurrentUser&#39;}-&gt;Privileged &#41; {
&gt;    			$RT::Logger-&gt;debug&#40;&#34;Filter::TakeAction ignoring non-privileged user&#34;&#41;;
&gt;    	   		return &#40; $args{&#39;CurrentUser&#39;}, $args{&#39;AuthLevel&#39;} &#41;;
&gt;    		}
&gt; 	}
187a199,200
&gt;     my $body;
&gt; 
190c203,205
&lt;         my $body = $part-&gt;bodyhandle or next;
---
&gt; 		# If we&#39;re ignoring the body, skip all this
&gt; 		last if &#40;RT::Config-&gt;Get&#40;&#39;CommandByMailIgnoreBody&#39;&#41;&#41;;
&gt;         $body = $part-&gt;bodyhandle or next;
198a214,226
&gt; 	if &#40;$RT::Config-&gt;Get&#40;&#39;CommandByMailDoHeaders&#39;&#41;&#41; {
&gt; 		my $header_string = RT::Config-&gt;Get&#40;&#39;CommandByMailHeaderString&#39;&#41;;	
&gt; 		$header_string = &#40;defined&#40;$header_string&#41;&#41; ? $header_string : &#39;X-RT-Do&#39;;
&gt; 		# Read any X-RT-Do headers
&gt; 		my @command_headers = $args{&#39;Message&#39;}-&gt;get&#40;$header_string&#41;;
&gt; 	
&gt; 		foreach my $cmd &#40;@command_headers&#41; {
&gt; 			# make sure they follow the correct format, if good, put it at front
&gt; 	        next if $cmd !~ /^&#40;?:&#40;\S+&#40;?:{.*}&#41;?&#41;\s*?:\s*?&#40;.*&#41;\s*?|&#41;$/;
&gt; 			unshift @content, $cmd;
&gt; 		}
&gt; 	}
&gt; 
222a251,268
&gt;     # Strip out commands from content if configuration says so,
&gt; 	# but not if we ignore the body
&gt;     if &#40;&#40;$RT::CommandByMailStripOut&#41; &#38;&#38; !&#40;$RT::CommandByMailIgnoreBody&#41;&#41; {
&gt; 	    my @content = $body-&gt;as_lines;
&gt; 	    my $io = $body-&gt;open&#40;&#34;w&#34;&#41; or die &#34;Cannot open body&#34;;
&gt; 	   
&gt; 	    my $body_top = 1;
&gt; 	    foreach my $line &#40;@content&#41; {
&gt; 		    # Strip out commands only at the top
&gt; 		    next if &#40;$body_top &#38;&#38; $line =~ /^&#40;?:&#40;\S+&#41;\s*?:\s*?&#40;.*&#41;\s*?|&#41;$/&#41;;
&gt; 		    $body_top = 0;
&gt; 		   
&gt; 		    $io-&gt;print&#40;$line&#41;;
&gt; 		    }
&gt; 	   
&gt; 	    $io-&gt;close&#40;&#41; or die &#34;Cannot close body&#34;;
&gt; 	    }
&gt;    
696a743
&gt; 	# default to mailing the user for errors
697a745,755
&gt;     if &#40;defined &#40; $RT::CommandByMailErrorEmailAddress &#41; &#41; {
&gt; 		# If we want to mail privileged users their errors and the current
&gt; 		# user is privileged, mail it to them instead of the error address
&gt; 		if &#40; &#40;defined&#40;$RT::CommandByMailErrorsToPrivileged&#41;&#41; &#38;&#38;
&gt; 			 &#40;$args{&#39;CurrentUser&#39;}-&gt;Privileged&#41; &#41; {
&gt; 	    	$ErrorsTo = RT::Interface::Email::ParseErrorsToAddressFromHead&#40; $args{&#39;Message&#39;}-&gt;head &#41;;
&gt; 		} else {
&gt; 			# We want to mail a generic address
&gt; 	    	$ErrorsTo = $RT::CommandByMailErrorEmailAddress;
&gt; 		}
&gt;     } 
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
