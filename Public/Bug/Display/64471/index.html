<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #64471 for AnyEvent-Twitter-Stream: JSON parsing errors</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #64471 for AnyEvent-Twitter-Stream: JSON parsing errors</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/AnyEvent-Twitter-Stream/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/AnyEvent-Twitter-Stream/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/AnyEvent-Twitter-Stream/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/AnyEvent-Twitter-Stream/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/miyagawa/AnyEvent-Twitter-Stream/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/AnyEvent-Twitter-Stream">AnyEvent-Twitter-Stream CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">64471</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/AnyEvent-Twitter-Stream/Active/">AnyEvent-Twitter-Stream</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bryanpaluch [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-228432-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-228433-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;04&nbsp;15:45:49&nbsp;2011</span>
    <span class="description">bryanpaluch [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> JSON parsing errors</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 4 Jan 2011 15:45:38 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-AnyEvent-Twitter-Stream [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Bryan Paluch &lt;bryanpaluch [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,
When I try to run the example tracker.pl code with my own consumer key I get
issues with parsing JSON objects. There is normally 3 to 4 characters before
the initial { sign and I think that this throwing off the JSON parser.

eg:
malformed JSON string, neither array, object, number, string or atom, at
character offset 0 &#40;before &#34;DD8&#34;&#41; at
/home/bpaluch/perl/lib/AnyEvent/Twitter/Stream.pm line 158.

JSON text must be an object or array &#40;but found number, string, true, false
or null, use allow_nonref to allow this&#41; at
/home/bpaluch/perl/lib/AnyEvent/Twitter/Stream.pm line 158.

garbage after JSON object, at character offset 1 &#40;before &#34;A5&#34;&#41; at
/home/bpaluch/perl/lib/AnyEvent/Twitter/Stream.pm line 158.



using .20  with v5.10.1 &#40;*&#41; built for i486-linux-gnu-thread-multi
on Linux 2.6.32.24+drm33.11-custom-uvc #1 SMP F &#40;Ubuntu 10.04&#41;



Thanks
Bryan Paluch
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;16&nbsp;19:32:23&nbsp;2011</span>
    <span class="description">znmeb [...] borasky-research.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> znmeb [...] borasky-research.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jan 04 15:45:49 2011, bryanpaluch@gmail.com wrote:

Yeah, I&#39;m seeing the same thing. The code worked last year, so I&#39;m 
guessing Twitter changed the format of what they&#39;re sending down the pipe 
slightly. I can run this with Komodo and capture raw data if necessary.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;16&nbsp;19:32:24&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;16&nbsp;20:11:38&nbsp;2011</span>
    <span class="description">znmeb [...] borasky-research.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> znmeb [...] borasky-research.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Feb 16 19:32:23 2011, znmeb@borasky-research.net wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Jan 04 15:45:49 2011, bryanpaluch@gmail.com wrote:
&gt; 
&gt; Yeah, I&#39;m seeing the same thing. The code worked last year, so I&#39;m 
&gt; guessing Twitter changed the format of what they&#39;re sending down the 
</div>pipe 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; slightly. I can run this with Komodo and capture raw data if necessary.
</div>
Actually, I have a successful capture with time stamp 2011-01-
01T08:56:00Z. I shut that collector down, so I don&#39;t know when things 
changed, but this code is dated October 2010. I&#39;m not sure which version 
of AnyEvent::Twitter::Stream I was running at the time, though - maybe I 
should try the previous version.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;16&nbsp;21:20:23&nbsp;2011</span>
    <span class="description">znmeb [...] borasky-research.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> znmeb [...] borasky-research.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hmmm ... I think the &#34;length&#34; field may be what&#39;s either changed or newly 
working. Someone just posted this on the developers&#39; mailing list:

<span class="clickylink"><a target="new" rel="nofollow" href="https://groups.google.com/d/topic/twitter-development-">https://groups.google.com/d/topic/twitter-development-</a></span>
talk/US_ATDzMw8c/discussion
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;17&nbsp;10:01:27&nbsp;2011</span>
    <span class="description">MLEHMANN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just a wild guess: AnyEvent::HTTP now uses http/1.1 requests, and
AnyEvent::Twitter::Strream uses want_body_fh instead of on_body, so it
now has to parse the resulting chunked-encoded stream, which it doesn&#39;t.

So likely neither AnyEvent::Twitter::Stream nor twitter changed
anything, but AnyEvent::HTTP does http/1.1 instead of http/1.0, and
AnyEvent::Twitter::Stream doesn&#39;t cope with that &#40;as it should have used
on_body&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;17&nbsp;18:56:29&nbsp;2011</span>
    <span class="description">znmeb [...] borasky-research.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> znmeb [...] borasky-research.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Feb 17 10:01:27 2011, MLEHMANN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Just a wild guess: AnyEvent::HTTP now uses http/1.1 requests, and
&gt; AnyEvent::Twitter::Strream uses want_body_fh instead of on_body, so it
&gt; now has to parse the resulting chunked-encoded stream, which it 
</div>doesn&#39;t.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; So likely neither AnyEvent::Twitter::Stream nor twitter changed
&gt; anything, but AnyEvent::HTTP does http/1.1 instead of http/1.0, and
&gt; AnyEvent::Twitter::Stream doesn&#39;t cope with that &#40;as it should have 
</div>used
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; on_body&#41;.
&gt; 
&gt; 
</div>
Could be - I have a little more information gleaned from running with 
Komodo but I don&#39;t have the window up at the moment.

1. The JSON response is coming back from Twitter into $handle-&gt;{rbuf}.
2. Sometimes the JSON response has extra spaces at the end, which is 
croaking the JSON parser.
3. Sometimes the JSON response is &#34;\r\n&#34; which is croaking the parser.

I can hack the code to work in Komodo, which I&#39;m planning to do either 
later tonight or some time this weekend, but we really should engage the 
author of the module and Twitter to validate what&#39;s going on - I don&#39;t 
want to fork this module based on my Komodo hacks and what&#39;s currently 
coming down Twitter&#39;s pipes. I&#39;d like to know what changed and when, 
since some version of this was working on January 1, 2011. ;-&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;17&nbsp;22:42:00&nbsp;2011</span>
    <span class="description">MLEHMANN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">well, spaces at the end will not cause a json parser to croak - it&#39;s
valid json.

instead of hacking it to parse chunked encoding &#40;which will break it as
soon as there are any http changes again&#41;, it should use on_body and an
incremental parser, only that way is it future proof against low-level
changes in AnyEvent::HTTP &#40;want_body_fh == raw stream, on_body == proper
http response&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;18&nbsp;03:10:52&nbsp;2011</span>
    <span class="description">james2vegas [...] aim.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza">Unfortunately the AnyEvent::HTTP POD still claims (on_body) ..&nbsp;'is usually preferred over doing your own body handling via &quot;want_body_handle&quot;, but in case of streaming APIs, where HTTP is only used to create a connection, &quot;want_body_handle&quot; is the better alternative, as it allows you to install your own event handler, reducing resource usage.' and (want_body _handle) '.. is useful with some push-type services, where, after the initial headers, an interactive protocol is used (typical example would be the push-style twitter API which starts a JSON/XML stream)'.<br>

<br>

Also, in the code of AnyEvent::Twitter::Stream is this:&nbsp;&quot;want_body_handle =&gt; 1, # for some reason on_body =&gt; sub {} doesn't work :/&quot;, though patching the module to use on_body does seem to work for me, something like this:<br>

<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; want_body_handle =&gt; 0,<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; on_body =&gt; sub {<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my ($content, $headers) = @_;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $set_timeout-&gt;();<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do {<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $on_keepalive-&gt;();<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } unless $content;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $self-&gt;{_json} ||= JSON-&gt;new;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for my $tweet ($self-&gt;{_json}-&gt;incr_parse($content)) {<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($on_delete &amp;&amp; $tweet-&gt;{delete} &amp;&amp; $tweet-&gt;{delete}-&gt;{status}) {<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $on_delete-&gt;($tweet-&gt;{delete}-&gt;{status}-&gt;{id}, $tweet-&gt;{delete}-&gt;{status}-&gt;{user_id});<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }elsif($on_friends &amp;&amp; $tweet-&gt;{friends}) {<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $on_friends-&gt;($tweet-&gt;{friends});<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }elsif($on_event &amp;&amp; $tweet-&gt;{event}) {<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $on_event-&gt;($tweet);<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }else{<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $on_tweet-&gt;($tweet);<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br>

<br>

cleanup and error handling omitted.<br>

<br>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;19&nbsp;01:38:06&nbsp;2011</span>
    <span class="description">znmeb [...] borasky-research.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> znmeb [...] borasky-research.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 18 03:10:52 2011, JWRIGHT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Unfortunately the AnyEvent::HTTP POD still claims &#40;on_body&#41; .. &#39;is
&gt; usually
&gt; preferred over doing your own body handling via &#34;want_body_handle&#34;,
&gt; but in case
&gt; of streaming APIs, where HTTP is only used to create a connection,
&gt; &#34;want_body_handle&#34; is the better alternative, as it allows you to
&gt; install your
&gt; own event handler, reducing resource usage.&#39; and &#40;want_body _handle&#41;
&gt; &#39;.. is
&gt; useful with some push-type services, where, after the initial headers,
&gt; an
&gt; interactive protocol is used &#40;typical example would be the push-style
&gt; twitter
&gt; API which starts a JSON/XML stream&#41;&#39;.
&gt; 
&gt; Also, in the code of AnyEvent::Twitter::Stream is this:
&gt; &#34;want_body_handle =&gt; 1,
&gt; # for some reason on_body =&gt; sub {} doesn&#39;t work :/&#34;, though patching
&gt; the
&gt; module to use on_body does seem to work for me, something like this:
&gt; 
&gt; want_body_handle =&gt; 0,
&gt; on_body =&gt; sub {
&gt; my &#40;$content, $headers&#41; = @_;
&gt; $set_timeout-&gt;&#40;&#41;;
&gt; do {
&gt; $on_keepalive-&gt;&#40;&#41;;
&gt; return;
&gt; } unless $content;
&gt; $self-&gt;{_json} ||= JSON-&gt;new;
&gt; for my $tweet &#40;$self-&gt;{_json}-&gt;incr_parse&#40;$content&#41;&#41; {
&gt; if &#40;$on_delete &#38;&#38; $tweet-&gt;{delete} &#38;&#38; $tweet-&gt;{delete}-&gt;{status}&#41; {
&gt; $on_delete-&gt;&#40;$tweet-&gt;{delete}-&gt;{status}-&gt;{id},
&gt; $tweet-&gt;{delete}-&gt;{status}-&gt;{user_id}&#41;;
&gt; }elsif&#40;$on_friends &#38;&#38; $tweet-&gt;{friends}&#41; {
&gt; $on_friends-&gt;&#40;$tweet-&gt;{friends}&#41;;
&gt; }elsif&#40;$on_event &#38;&#38; $tweet-&gt;{event}&#41; {
&gt; $on_event-&gt;&#40;$tweet&#41;;
&gt; }else{
&gt; $on_tweet-&gt;&#40;$tweet&#41;;
&gt; }
&gt; }
&gt; 1;
&gt; },
&gt; 
&gt; cleanup and error handling omitted.
</div>
Well, the date of the AnyEvent::HTTP change is consistent with the date 
this bug report was opened. ;-&#41; I sent an email to the author of 
AnyEvent::Twitter::Stream.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;31&nbsp;14:32:38&nbsp;2011</span>
    <span class="description">znmeb [...] borasky-research.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> znmeb [...] borasky-research.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As far as I know this has been fixed. How do we mark it as closed?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;18&nbsp;15:59:10&nbsp;2011</span>
    <span class="description">MIYAGAWA [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
