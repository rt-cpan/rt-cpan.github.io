<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #35836 for threads: threads-&gt;list&#40;&#41; in END block blocks</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #35836 for threads: threads-&gt;list&#40;&#41; in END block blocks</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/threads/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/threads/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/threads/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/threads/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/threads">threads CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">35836</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/threads/Active/">threads</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
smueller [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-32716-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
1.57</li>
<li>
1.58</li>
<li>
1.59</li>
<li>
1.61</li>
<li>
1.62</li>
<li>
1.63</li>
<li>
1.64</li>
<li>
1.65</li>
<li>
1.66</li>
<li>
1.67</li>
<li>
1.68</li>
<li>
1.69</li>
</ul>
    </td>
  </tr>
  <tr id="CF-32717-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;13&nbsp;08:09:10&nbsp;2008</span>
    <span class="description">smueller [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> threads-&gt;list&#40;&#41; in END block blocks</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Currently, PAR does not work with threads. I&#39;d love to fix it on the PAR
side of things, but I&#39;m stuck. Along the way, I think I found a bug in
threads:

PAR::Packer has some cleanup-code in an END{} block which must be run by
the last remaining thread only. We can&#39;t do anything about detached
threads, I suppose, but I thought checking that  threads-&gt;list&#40;&#41; == 1
would be sufficient for the usual case &#40;no detached threads&#41;. So I
rebuilt the situation in PAR as simple as possible. See code below.

Turns out the following code gets into some locking problem or similar
during the threads-&gt;list&#40;&#41; call:

#!/usr/bin/perl
use strict; use warnings;
use threads;

sub start_thread {
  eval &#34;use End;&#34;;
  print &#34;I am a thread.\n&#34;;
  #END{eval&#34;threads-&gt;list&#40;&#41;&#34;}
}

threads-&gt;create&#40;&#34;start_thread&#34;&#41;-&gt;join&#40;&#41;;
print &#34;I am not a thread \n&#34;;

Whereas End.pm contains:
package End;
use strict; use warnings;
END {
  print &#34;CLEANUP!\n&#34;;
  my $tid = threads-&gt;list&#40;&#41;;
  if &#40;not defined $tid or $tid == 0&#41; {
    print &#34;MAIN THREAD!\n&#34;;
  } else {
    print &#34;CHILD THREAD: $tid!\n&#34;;
  }
}
1;

When I run the script, I get:
I am a thread.
CLEANUP!

and then, it just spins. &#40;0% CPU use, so it&#39;s not a loop.&#41;

This doesn&#39;t happen if I run the threads-&gt;list&#40;&#41; in the main program,
i.e. if I comment out the &#34;eval&#34;use End;&#34;&#34; and comment in the
END{eval&#34;threads-&gt;list&#40;&#41;&#34;}. Also, in reality, I&#39;d do eval
&#34;threads-&gt;list&#40;&#41;&#34; in End &#40;aka PAR&#41; because that degrades nicely in case
the user isn&#39;t even using threads. That doesn&#39;t make a difference, though.

Best regards,
Steffen

P.S.: I tested this with a very recent 5.10-devel checkout &#40;see below&#41;
as well as a Suse Linux 5.8.8. Both were using the newest threads &#40;1.69&#41;
and both showed the behaviour described. I also tested the 5.8.8 with
various threads releases. It seems that threads 1.57 is the first
release with the locking problem.

P.P.S: If you have any suggestions how to fix the original problem I&#39;m
trying to work around, I&#39;m all ears!

This is perl, v5.10.0 DEVEL33787 built for i686-linux-thread-multi
&#40;with 1 registered patch, see perl -V for more detail&#41;

Copyright 1987-2007, Larry Wall

Perl may be copied only under the terms of either the Artistic License
or the
GNU General Public License, which may be found in the Perl 5 source kit.

Complete documentation for Perl, including FAQ lists, should be found on
this system using &#34;man perl&#34; or &#34;perldoc perl&#34;.  If you have access to the
Internet, point your browser at <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perl.org/">http://www.perl.org/</a></span>, the Perl Home Page.

OKG72|smueller@iklx107:/userdata2/smueller/par&gt; perl -V
Summary of my perl5 &#40;revision 5 version 10 subversion 0 patch 33787&#41;
configuration:
  Platform:
    osname=linux, osvers=2.6.5-7.257-smp, archname=i686-linux-thread-multi
    uname=&#39;linux iklx107 2.6.5-7.257-smp #1 smp mon may 15 14:14:14 utc
2006 i686 athlon i386 gnulinux &#39;
    config_args=&#39;-Dusedevel
-Dprefix=/userdata2/smueller/bleadperl/install5.10.107 -Dusethreads
-Dsiteprefix=/userdata2/smueller/bleadperl/install5.10.107&#39;
    hint=recommended, useposix=true, d_sigaction=define
    useithreads=define, usemultiplicity=define
    useperlio=define, d_sfio=undef, uselargefiles=define, usesocks=undef
    use64bitint=undef, use64bitall=undef, uselongdouble=undef
    usemymalloc=n, bincompat5005=undef
  Compiler:
    cc=&#39;ccache cc -m32&#39;, ccflags =&#39;-D_REENTRANT -D_GNU_SOURCE
-fno-strict-aliasing -pipe -I/usr/local/include -D_LARGEFILE_SOURCE
-D_FILE_OFFSET_BITS=64&#39;,
    optimize=&#39;-O2&#39;,
    cppflags=&#39;-D_REENTRANT -D_GNU_SOURCE -fno-strict-aliasing -pipe
-I/usr/local/include&#39;
    ccversion=&#39;&#39;, gccversion=&#39;3.3.3 &#40;SuSE Linux&#41;&#39;, gccosandvers=&#39;&#39;
    intsize=4, longsize=4, ptrsize=4, doublesize=8, byteorder=1234
    d_longlong=define, longlongsize=8, d_longdbl=define, longdblsize=12
    ivtype=&#39;long&#39;, ivsize=4, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;off_t&#39;,
lseeksize=8
    alignbytes=4, prototype=define
  Linker and Libraries:
    ld=&#39;ccache cc -m32&#39;, ldflags =&#39; -L/usr/local/lib&#39;
    libpth=/usr/local/lib /lib /usr/lib
    libs=-lnsl -ldl -lm -lcrypt -lutil -lpthread -lc
    perllibs=-lnsl -ldl -lm -lcrypt -lutil -lpthread -lc
    libc=, so=so, useshrplib=false, libperl=libperl.a
    gnulibc_version=&#39;2.3.3&#39;
  Dynamic Linking:
    dlsrc=dl_dlopen.xs, dlext=so, d_dlsymun=undef, ccdlflags=&#39;-Wl,-E&#39;
    cccdlflags=&#39;-fPIC&#39;, lddlflags=&#39;-shared -O2 -L/usr/local/lib&#39;


Characteristics of this binary &#40;from libperl&#41;:
  Compile-time options: MULTIPLICITY PERL_DONT_CREATE_GVSV
                        PERL_IMPLICIT_CONTEXT PERL_MALLOC_WRAP USE_ITHREADS
                        USE_LARGE_FILES USE_PERLIO USE_REENTRANT_API
  Locally applied patches:
        MAINT33535
  Built under linux
  Compiled at May  6 2008 13:59:36
  %ENV:
   
PERL5LIB=&#34;/users/ik3al1/smueller/local/perl5lib:/users/ik3al1/smueller/perl/lib/perl5/site_perl/5.10.0:/users/ik3al1/smueller/perl/lib/perl5/5.10.0:/users/ik3al1/smueller/perl/lib/5.10.0:/users/ik3al1/smueller/perl/lib/site_perl/5.10.0&#34;
    PERLVERSION=&#34;5.10.0&#34;
  @INC:
    /users/ik3al1/smueller/local/perl5lib
   
/users/ik3al1/smueller/perl/lib/perl5/site_perl/5.10.0/i686-linux-thread-multi
    /users/ik3al1/smueller/perl/lib/perl5/site_perl/5.10.0
    /users/ik3al1/smueller/perl/lib/perl5/5.10.0/i686-linux-thread-multi
    /users/ik3al1/smueller/perl/lib/perl5/5.10.0
    /users/ik3al1/smueller/perl/lib/5.10.0/i686-linux-thread-multi
    /users/ik3al1/smueller/perl/lib/5.10.0
    /users/ik3al1/smueller/perl/lib/site_perl/5.10.0/i686-linux-thread-multi
    /users/ik3al1/smueller/perl/lib/site_perl/5.10.0
   
/userdata2/smueller/bleadperl/install5.10.107/lib/5.10.0/i686-linux-thread-multi
    /userdata2/smueller/bleadperl/install5.10.107/lib/5.10.0
   
/userdata2/smueller/bleadperl/install5.10.107/lib/site_perl/5.10.0/i686-linux-thread-multi
    /userdata2/smueller/bleadperl/install5.10.107/lib/site_perl/5.10.0
    ~smueller/local/perl5lib
    .
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;13&nbsp;12:00:44&nbsp;2008</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #35836] threads-&gt;list&#40;&#41; in END block blocks</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 13 May 2008 12:00:26 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-threads [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jerry D. Hedden&#34; &lt;jdhedden [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Steffen Mueller wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  PAR::Packer has some cleanup-code in an END{} block which must be run by
&gt;  the last remaining thread only.
&gt;
&gt;  #!/usr/bin/perl
&gt;  use strict; use warnings;
&gt;  use threads;
&gt;
&gt;  sub start_thread {
&gt;   eval &#34;use End;&#34;;
&gt;   print &#34;I am a thread.\n&#34;;
&gt;   #END{eval&#34;threads-&gt;list&#40;&#41;&#34;}
&gt;  }
&gt;
&gt;  threads-&gt;create&#40;&#34;start_thread&#34;&#41;-&gt;join&#40;&#41;;
&gt;  print &#34;I am not a thread \n&#34;;
&gt;
&gt;  Whereas End.pm contains:
&gt;  package End;
&gt;  use strict; use warnings;
&gt;  END {
&gt;   print &#34;CLEANUP!\n&#34;;
&gt;   my $tid = threads-&gt;list&#40;&#41;;
&gt;   if &#40;not defined $tid or $tid == 0&#41; {
&gt;     print &#34;MAIN THREAD!\n&#34;;
&gt;   } else {
&gt;     print &#34;CHILD THREAD: $tid!\n&#34;;
&gt;   }
&gt;  }
&gt;  1;
&gt;
&gt;  When I run the script, I get:
&gt;  I am a thread.
&gt;  CLEANUP!
&gt;
&gt;  and then, it just spins. &#40;0% CPU use, so it&#39;s not a loop.&#41;
</div>
When I try this, I get:

panic: MUTEX_LOCK &#40;45&#41; [threads.xs:1001] at End.pm line 5.
END failed--call queue aborted at ./xxx.pl line 10.
        &#40;in cleanup&#41; panic: MUTEX_LOCK &#40;45&#41; [threads.xs:202] at
./xxx.pl line 11.

In the -&gt;join&#40;&#41; call, the main thread holds a mutex on the
thread being joined during the destruction of its
interperter.  While this mutex is held, the thread&#39;s END
block is executed.  The -&gt;list&#40;&#41; call in the END block then
tries to obtain the same mutex.  This results in the panic.
Thus, running threads calls in a thread&#39;s END block will
most likely fail this way.  These mutex&#39;s are essential for
proper operation of the threads module, and cannot be
circumvented.

I will document this issue for the next release of the
threads module.

However, it is not reliable to use -&gt;list&#40;&#41; to check for the
number of threads.  Two threads could do the same check at
nearly the same time and each see 2 threads running and then
both would terminate without executing the desired code.

Try eliminating the END block all together, and track
threads in the main code.  Increment a counter on -&gt;create&#40;&#41;
and decrement on -&gt;join&#40;&#41;. Then execute the &#34;END&#34; code after
the final -&gt;join&#40;&#41;.

Another way might be to provide threads with initialization
and termination functions that track thread counts:

    use Thread::Semaphore;
    my $sema = Thread-&gt;Semaphore&#40;&#41;;
    my $thread_count = 0;

    sub thr_init&#40;&#41;
    {
        $sema-&gt;down&#40;&#41;;
        $thread_count++;
        $sema-&gt;up&#40;&#41;;
    }

    sub thr_exit&#40;&#41;
    {
        my $thr_cnt;
        $sema-&gt;down&#40;&#41;;
        $thr_cnt = --$thread_count;
        $sema-&gt;up&#40;&#41;;

        if &#40;$thr_cnt == 0&#41; {
            # I&#39;m the last thread, so do extra work
        }

        threads-&gt;exit&#40;&#41;;
    }

    sub thr_func&#40;&#41;
    {
        thr_init&#40;&#41;;

        # Do work

        thr_exit&#40;&#41;;
    }

If you really have to have an END block, it might be safe
to use the thr_exit&#40;&#41; call in it &#40;but I cringe at the
thought&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;13&nbsp;12:00:46&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;13&nbsp;12:15:22&nbsp;2008</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #35836] threads-&gt;list&#40;&#41; in END block blocks</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 13 May 2008 12:15:06 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-threads [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jerry D. Hedden&#34; &lt;jdhedden [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Jerry D. Hedden wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  I will document this issue for the next release of the
&gt;  threads module.
</div>
I have added the following to the BUGS AND LIMITATIONS section of the
threads POD which will appear in the next release:

=item END blocks in threads

It is possible to add L&lt;END blocks|perlmod/&#34;BEGIN, UNITCHECK, CHECK, INIT and
END&#34;&gt; to threads by L&lt;require|perlfunc/&#34;require VERSION&#34;&gt;&#39;ing or
L&lt;eval|perlfunc/&#34;eval EXPR&#34;&gt;&#39;ing the appropriate code.  These C&lt;END&gt; blocks
will then be executed when the thread&#39;s interpreter is destroyed &#40;i.e., either
during a C&lt;-E&lt;gt&gt;join&#40;&#41;&gt; call, or at program termination&#41;.

However, calling any L&lt;threads&gt; methods in such an C&lt;END&gt; block will most
likely I&lt;fail&gt; &#40;e.g., the application may hang, or genereate an error&#41; due to
mutex&#39;s that are needed to control functionality within the L&lt;threads&gt; module.

For this reason, the use of C&lt;END&gt; blocks in threads is B&lt;strongly&gt;
discouraged.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;14&nbsp;05:53:05&nbsp;2008</span>
    <span class="description">wyp3rlx02 [...] sneakemail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #35836] threads-&gt;list&#40;&#41; in END block blocks</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 14 May 2008 11:52:30 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-threads [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steffen Mueller &lt;wyp3rlx02 [...] sneakemail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Jerry,

Jerry D. Hedden via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Try eliminating the END block all together, and track
&gt; threads in the main code.  Increment a counter on -&gt;create&#40;&#41;
&gt; and decrement on -&gt;join&#40;&#41;. Then execute the &#34;END&#34; code after
&gt; the final -&gt;join&#40;&#41;.
</div>
That&#39;s exactly my problem. I&#39;d happily do so, but I&#39;m having the problem
with a library: PAR is used by users unsuspecting of what kind of
cleanup it has to do. They also use threads the same way. When they use
PAR and threads together, PAR can&#39;t do its cleanup for the reasons
described earlier.

Essentially, this pushes an implementation detail of PAR out to become
an obligation of the user. That&#39;s really, really bad.

That being said, I understand that it&#39;s hard to impossible to fix this
on the threads side of things. Unfortunately, the same applies to PAR.
We have to use the END block. I know of no other way to run clean-up
code on exit without user intervention.

Moreover, users expect to be able to take just any arbitrary existing
Perl program and run the PAR packager

pp -o binary threaded-program.pl

to get a working binary package. Quite often, the PAR users aren&#39;t even
those who wrote the application in the first place, so there is no way
we, as the PAR developers, can impose any kind of responsibility for
cleanup and/or tracking of threads on the user.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Another way might be to provide threads with initialization
&gt; and termination functions that track thread counts:
</div>[...]
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If you really have to have an END block, it might be safe
&gt; to use the thr_exit&#40;&#41; call in it &#40;but I cringe at the
&gt; thought&#41;.
</div>
That&#39;s still in user-land, so no, I can&#39;t do this :&#40;

Thanks for your input and explanation. The note you put in the
documentation reads well. I&#39;ll think about the issue some more, but I&#39;m
not confident I&#39;ll have any kind of revelation.

Maybe I&#39;ll just add an if&#40; threads was never use&#40;&#41;d &#41; { # run cleanup }
else { # don&#39;t } to the end block. Then the users using threads would
sometimes have stale caches on their /tmp disk, but that&#39;s better than
segmentation faults or processes locking up.

Best regards,
Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;15&nbsp;08:25:29&nbsp;2008</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Jerry D. Hedden wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  I will document this issue for the next release of the
&gt;  threads module.
</div>Released
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;15&nbsp;08:25:42&nbsp;2008</span>
    <span class="description">jdhedden [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
