<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #116507 for CPAN: CVE-2016-1238: App::Cpan may load an optional module from the current directory</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #116507 for CPAN: CVE-2016-1238: App::Cpan may load an optional module from the current directory</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/CPAN/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/CPAN/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/CPAN/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/CPAN/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/CPAN">CPAN CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">116507</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/CPAN/Active/">CPAN</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
TONYC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-8164-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-8165-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.22    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;26&nbsp;22:19:21&nbsp;2016</span>
    <span class="description">TONYC [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CVE-2016-1238: App::Cpan may load an optional module from the
 current directory</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This can be used by another user on the system to attack the current user if
this code is run from a globally writable directory such as /tmp.

The attached patch temporarily removes . from @INC when attemptting to load
optional modules.

The patch is also available as a pull request at:

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/andk/cpanpm/pull/101">https://github.com/andk/cpanpm/pull/101</a></span>

This change is in maint-5.22, maint-5.24 and blead perl.

Tony
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-CVE-2016-1238-don-t-load-optional-modules-from-defau.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 394ac06dc5e9e94a81c39c43135d1635f516422e Mon Sep 17 00:00:00 2001
From: Tony Cook &lt;tony@develop-help.com&gt;
Date: Wed, 27 Jul 2016 12:14:13 +1000
Subject: [PATCH] CVE-2016-1238: don&#39;t load optional modules from default .

App::Cpan attempts to load several optional modules, which an attacker
can use if cpan is run from a directory writable by other users, such
as /tmp.
---
 lib/App/Cpan.pm | 21 ++++++++++++++++-----
 1 file changed, 16 insertions&#40;+&#41;, 5 deletions&#40;-&#41;

diff --git a/lib/App/Cpan.pm b/lib/App/Cpan.pm
index f43dea9..c654c2c 100644
--- a/lib/App/Cpan.pm
+++ b/lib/App/Cpan.pm
@@ -549,9 +549,20 @@ sub AUTOLOAD { 1 }
 sub DESTROY { 1 }
 }
 
+# load a module without searching the default entry for the current
+# directory
+sub _safe_load_module {
+    my $name = shift;
+
+    local @INC = @INC;
+    pop @INC if $INC[-1] eq &#39;.&#39;;
+
+    eval &#34;require $name; 1&#34;;
+}
+
 sub _init_logger
 	{
-	my $log4perl_loaded = eval &#34;require Log::Log4perl; 1&#34;;
+	my $log4perl_loaded = _safe_load_module&#40;&#34;Log::Log4perl&#34;&#41;;
 
     unless&#40; $log4perl_loaded &#41;
         {
@@ -1020,7 +1031,7 @@ sub _load_local_lib # -I
 	{
 	$logger-&gt;debug&#40; &#34;Loading local::lib&#34; &#41;;
 
-	my $rc = eval { require local::lib; 1; };
+	my $rc = _safe_load_module&#40;&#34;local::lib&#34;&#41;;
 	unless&#40; $rc &#41; {
 		$logger-&gt;die&#40; &#34;Could not load local::lib&#34; &#41;;
 		}
@@ -1160,7 +1171,7 @@ sub _get_file
 	{
 	my $path = shift;
 
-	my $loaded = eval &#34;require LWP::Simple; 1;&#34;;
+	my $loaded = _safe_load_module&#40;&#34;LWP::Simple&#34;&#41;;
 	croak &#34;You need LWP::Simple to use features that fetch files from CPAN\n&#34;
 		unless $loaded;
 
@@ -1182,7 +1193,7 @@ sub _gitify
 	{
 	my $args = shift;
 
-	my $loaded = eval &#34;require Archive::Extract; 1;&#34;;
+	my $loaded = _safe_load_module&#40;&#34;Archive::Extract&#34;&#41;;
 	croak &#34;You need Archive::Extract to use features that gitify distributions\n&#34;
 		unless $loaded;
 
@@ -1245,7 +1256,7 @@ sub _show_Changes
 sub _get_changes_file
 	{
 	croak &#34;Reading Changes files requires LWP::Simple and URI\n&#34;
-		unless eval &#34;require LWP::Simple; require URI; 1&#34;;
+		unless _safe_load_module&#40;&#34;LWP::Simple&#34;&#41; &#38;&#38; _safe_load_module&#40;&#34;URI&#34;&#41;;
 
     my $url = shift;
 
-- 
2.1.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;12&nbsp;10:22:47&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Út 26.čec.2016 22:19:21, TONYC napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This can be used by another user on the system to attack the current user if
&gt; this code is run from a globally writable directory such as /tmp.
&gt; 
&gt; The attached patch temporarily removes . from @INC when attemptting to load
&gt; optional modules.
&gt; 
</div>I can see this change in commit 394ac06dc5e9e94a81c39c43135d1635f516422e.

Unfortunately, the fix does not work because the $INC[-1] is not &#34;.&#34; but an absolute path equivalent to &#34;.&#34; when running the cpan tool.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;12&nbsp;10:22:48&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;12&nbsp;11:41:51&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne St 12.říj.2016 10:22:47, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I can see this change in commit
&gt; 394ac06dc5e9e94a81c39c43135d1635f516422e.
&gt; 
&gt; Unfortunately, the fix does not work because the $INC[-1] is not &#34;.&#34;
&gt; but an absolute path equivalent to &#34;.&#34; when running the cpan tool.
</div>
What about the attached patch?
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CPAN-2.14-Fix-CVE-2016-1238-properly.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 9b0b275d923418306cb3c45bb380bd9dcc71476c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Wed, 12 Oct 2016 16:56:41 +0200
Subject: [PATCH] Fix CVE-2016-1238 properly
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Removing &#34;.&#34; from @INC does not work because CPAN module translates
all relative paths into absolute paths. Check for $INC[-1] eq &#39;.&#39;
sooner.

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 lib/App/Cpan.pm | 8 +++++++-
 1 file changed, 7 insertions&#40;+&#41;, 1 deletion&#40;-&#41;

diff --git a/lib/App/Cpan.pm b/lib/App/Cpan.pm
index c654c2c..ce7afe5 100644
--- a/lib/App/Cpan.pm
+++ b/lib/App/Cpan.pm
@@ -1,5 +1,11 @@
 package App::Cpan;
 
+# CPAN module translantes @INC, CPAN RT#116507
+my $last_inc_is_dot;
+BEGIN {
+    $last_inc_is_dot = $INC[-1] eq &#39;.&#39;;
+}
+
 use strict;
 use warnings;
 use vars qw&#40;$VERSION&#41;;
@@ -555,7 +561,7 @@ sub _safe_load_module {
     my $name = shift;
 
     local @INC = @INC;
-    pop @INC if $INC[-1] eq &#39;.&#39;;
+    pop @INC if $last_inc_is_dot;
 
     eval &#34;require $name; 1&#34;;
 }
-- 
2.7.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;18&nbsp;08:26:29&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne St 12.říj.2016 11:41:51, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne St 12.říj.2016 10:22:47, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; I can see this change in commit
&gt; &gt; 394ac06dc5e9e94a81c39c43135d1635f516422e.
&gt; &gt; 
&gt; &gt; Unfortunately, the fix does not work because the $INC[-1] is not &#34;.&#34;
&gt; &gt; but an absolute path equivalent to &#34;.&#34; when running the cpan tool.
</div>&gt; 
&gt; What about the attached patch?
</div>
Looking at perl-v5.24.1-RC4, there is different fix that is missing from CPAN&#39;s git tree:

--- a/cpan/CPAN/scripts/cpan
+++ b/cpan/CPAN/scripts/cpan
@@ -1,5 +1,6 @@
 #!/usr/local/bin/perl
 
+BEGIN { pop @INC if $INC[-1] eq &#39;.&#39; }
 use strict;
 use vars qw&#40;$VERSION&#41;;
 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;18&nbsp;09:19:36&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Út 18.říj.2016 08:26:29, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne St 12.říj.2016 11:41:51, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; Dne St 12.říj.2016 10:22:47, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; &gt; I can see this change in commit
&gt; &gt; &gt; 394ac06dc5e9e94a81c39c43135d1635f516422e.
&gt; &gt; &gt;
&gt; &gt; &gt; Unfortunately, the fix does not work because the $INC[-1] is not
&gt; &gt; &gt; &#34;.&#34;
&gt; &gt; &gt; but an absolute path equivalent to &#34;.&#34; when running the cpan tool.
</div>&gt; &gt;
&gt; &gt; What about the attached patch?
</div>&gt; 
&gt; Looking at perl-v5.24.1-RC4, there is different fix that is missing
</div>
Actually the code on CPAN is missing more bits comparing the perl sources. The attached patch are all of them I found.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Fix-CVE-2016-1238-completely.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 705b9f68906d584e2d0bf9c2fd634778f1ba9b35 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Tue, 18 Oct 2016 14:35:09 +0200
Subject: [PATCH] Fix CVE-2016-1238 completely
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

These are remains ported from perl-v5.24.1-RC4 commit:

commit 5f66e9fffdc3d0c6e0846cd1f11298e70c786c30
Author: Tony Cook &lt;tony@develop-help.com&gt;
Date:   Tue Jun 21 10:02:02 2016 +1000

    &#40;perl #127834&#41; remove . from the end of @INC if complex modules are loaded

    While currently Encode and Storable are know to attempt to load modules
    not included in the core, updates to other modules may lead to those
    also attempting to load new modules, so be safe and remove . for those
    as well.

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 lib/CPAN.pm  | 4 ++++
 scripts/cpan | 1 +
 2 files changed, 5 insertions&#40;+&#41;

diff --git a/lib/CPAN.pm b/lib/CPAN.pm
index 69cc7b8..ae66eaf 100644
--- a/lib/CPAN.pm
+++ b/lib/CPAN.pm
@@ -1128,6 +1128,8 @@ sub has_usable {
                                ]
               };
     if &#40;$usable-&gt;{$mod}&#41; {
+        local @INC = @INC;
+        pop @INC if $INC[-1] eq &#39;.&#39;;
         for my $c &#40;0..$#{$usable-&gt;{$mod}}&#41; {
             my $code = $usable-&gt;{$mod}[$c];
             my $ret = eval { &#38;$code&#40;&#41; };
@@ -1170,6 +1172,8 @@ sub has_inst {
       $CPAN::META-&gt;{dontload_hash}{$mod}||=1; # unsafe meta access, ok
       return 0;
     }
+    local @INC = @INC;
+    pop @INC if $INC[-1] eq &#39;.&#39;;
     my $file = $mod;
     my $obj;
     $file =~ s|::|/|g;
diff --git a/scripts/cpan b/scripts/cpan
index 5555090..cceab30 100644
--- a/scripts/cpan
+++ b/scripts/cpan
@@ -1,5 +1,6 @@
 #!/usr/local/bin/perl
 
+BEGIN { pop @INC if $INC[-1] eq &#39;.&#39; }
 use strict;
 use vars qw&#40;$VERSION&#41;;
 
-- 
2.7.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;18&nbsp;09:51:20&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Út 18.říj.2016 09:19:36, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne Út 18.říj.2016 08:26:29, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; Looking at perl-v5.24.1-RC4, there is different fix that is missing
</div>&gt; 
&gt; Actually the code on CPAN is missing more bits comparing the perl
&gt; sources. The attached patch are all of them I found.
</div>
After applying this patch, perl panics in Carp:

$ perl -Ilib scripts/cpan -j t/97-lib_cpan1/CPAN/Config.pm -J
panic: attempt to copy freed scalar 6b4d88 to 1ed9010 at /usr/share/perl5/Carp.pm line 229.

The trigger is the BEGIN block in scripts/cpan.

This looks like a perl problem with reference counting discussed in Carp &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=72467">https://rt.cpan.org/Public/Bug/Display.html?id=72467</a></span>&gt; and perl &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/Public/Bug/Display.html?id=125907">https://rt.perl.org/Public/Bug/Display.html?id=125907</a></span>&gt;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;18&nbsp;11:41:29&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Út 18.říj.2016 09:51:20, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne Út 18.říj.2016 09:19:36, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; Dne Út 18.říj.2016 08:26:29, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; &gt; Looking at perl-v5.24.1-RC4, there is different fix that is missing
</div>&gt; &gt;
&gt; &gt; Actually the code on CPAN is missing more bits comparing the perl
&gt; &gt; sources. The attached patch are all of them I found.
</div>&gt; 
&gt; After applying this patch, perl panics in Carp:
&gt; 
&gt; $ perl -Ilib scripts/cpan -j t/97-lib_cpan1/CPAN/Config.pm -J
&gt; panic: attempt to copy freed scalar 6b4d88 to 1ed9010 at
&gt; /usr/share/perl5/Carp.pm line 229.
&gt; 
&gt; The trigger is the BEGIN block in scripts/cpan.
&gt; 
&gt; This looks like a perl problem with reference counting discussed in
&gt; Carp &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=72467">https://rt.cpan.org/Public/Bug/Display.html?id=72467</a></span>&gt; and perl
&gt; &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/Public/Bug/Display.html?id=125907">https://rt.perl.org/Public/Bug/Display.html?id=125907</a></span>&gt;.
</div>
After putting a work-around into Carp, the t/97-return_values.t fails because the `-j&#39; option loads the configuration using:

my $rc = eval &#34;require &#39;$file&#39;&#34;;

That means it searches through @INC and there is no &#34;.&#34; because of the CVE fix. perl tests do not fail because the t/97-return_values.t test is not there.

A work-around is to change the test to  start the -j arguments with &#34;./&#34;. I&#39;m not sure what&#39;s the semantics of the &#34;-j&#34; option. I did not expected it undergoes the @INC look-up. Then the code should be changed to threat -j argument as a path and make it absolute before passing it to require function.

By the way the Carp panic can be triggered even with current CPAN code simply by passing non-existing file:

$ perl -Ilib scripts/cpan -j foo.pm
Loading internal null logger. Install Log::Log4perl for logging messages
panic: attempt to copy freed scalar db74b0 to de6300 at /usr/share/perl5/vendor_perl/Carp.pm line 229.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;18&nbsp;16:10:28&nbsp;2016</span>
    <span class="description">brian.d.foy [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #116507] CVE-2016-1238: App::Cpan may load an optional module from the current directory</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 18 Oct 2016 16:09:34 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-CPAN [...] rt.cpan.org&#34; &lt;bug-CPAN [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> brian d foy &lt;brian.d.foy [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve created a pull request for this: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/andk/cpanpm/pull/105">https://github.com/andk/cpanpm/pull/105</a></span>

It&#39;s in my repo in the master branch:
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/briandfoy/cpanpm">https://github.com/briandfoy/cpanpm</a></span> at  e96764e. I didn&#39;t get the
panic on v5.24.0 on Mac OS X, so I&#39;m curious if you still get it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;21&nbsp;03:37:05&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Út 18.říj.2016 16:10:28, brian.d.foy@gmail.com napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve created a pull request for this:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/andk/cpanpm/pull/105">https://github.com/andk/cpanpm/pull/105</a></span>
&gt; 
&gt; It&#39;s in my repo in the master branch:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/briandfoy/cpanpm">https://github.com/briandfoy/cpanpm</a></span> at  e96764e. I didn&#39;t get the
&gt; panic on v5.24.0 on Mac OS X, so I&#39;m curious if you still get it.
</div>
I still get the panic with v5.24.0 on Linux &#40;perl-5.24.0-378.fc26.x86_64 from Fedora&#41;. I don&#39;t think the panic is something CPAN can solve.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;22&nbsp;11:14:51&nbsp;2018</span>
    <span class="description">ANDK [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;24&nbsp;12:02:40&nbsp;2018</span>
    <span class="description">ANDK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Marking as resolved, Thanks!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;24&nbsp;12:02:41&nbsp;2018</span>
    <span class="description">ANDK [...] cpan.org -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;24&nbsp;12:02:41&nbsp;2018</span>
    <span class="description">ANDK [...] cpan.org -  Fixed in 2.22 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
