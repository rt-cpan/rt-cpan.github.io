<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #89586 for Net-Server: Explicitely rejecting incoming connections when all workers are busy</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #89586 for Net-Server: Explicitely rejecting incoming connections when all workers are busy</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-Server/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-Server/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-Server/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-Server/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-Server">Net-Server CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">89586</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-Server/Active/">Net-Server</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
FGA [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-23138-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.007    </td>
  </tr>
  <tr id="CF-23139-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;17&nbsp;08:21:23&nbsp;2013</span>
    <span class="description">FGA [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Explicitely rejecting incoming connections when all workers are busy</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

We&#39;re using Net::Server::PreFork for an LMTP mail server.  So far so
good, everything works.  Great work on a very useful module.

Our problem is the project specs say when no workers are available and
email arrives, we should return &#34;432 Too many sessions&#34; instead of
waiting until a worker finishes and is able to call accept&#40;&#41; on the
socket.  We have set the *_spare_servers variables to 0 since we don&#39;t
actually want to spawn more children.  &#40;We&#39;re only using PreFork
instead of PreForkSimple to have a chance to get more accurate tallies
of waiting/processing workers, really.&#41;

There doesn&#39;t seem to be a way to do this in Net::Server::PreFork &#40;or
Simple&#41;.  I&#39;ve tried various things with e.g. the idle_loop_hook, but
that doesn&#39;t get run when I need it.  The accept_deny stuff is ideally
placed &#40;even though that&#39;s not what it&#39;s for&#41;, but it only runs in the
workers, who have no idea what the other workers are doing anyway.

Basically I&#39;m looking for:

&#40;a&#41; if and only if all workers are busy

&#40;b&#41; and at least one incoming connection is pending

&#40;c&#41; the master process itself &#40;not necessarily, but it&#39;s the only one
    who has a reasonable expection of knowing if &#40;a&#41; is true&#41; takes
    responsability for servicing the pending connections, if only to
    tell the client that they have to come back later

Is there such a thing in Net::Server, or a workaround for it?

&#40;Also on the wishlist: exposing the various worker tallies as methods
available in the master process, with documentation on when they are
available/correct/out of date.&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;17&nbsp;08:21:55&nbsp;2013</span>
    <span class="description">FGA [...] cpan.org -  Severity Wishlist added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;18&nbsp;17:22:02&nbsp;2013</span>
    <span class="description">paul [...] seamons.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #89586] Explicitely rejecting incoming connections when all workers are busy</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 17 Oct 2013 09:40:44 -0600</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-Server [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Paul Seamons &lt;paul [...] seamons.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">So, the issue you have below is somewhat fun - I have not previously 
been familiar with LMTP.  The protocol and the 432 response message are 
rather odd beasts &#40;actually mysql connections will often return a 
similar message if you exceed the maximum&#41;.

Perhaps something can be woven into Net::Server directly, but this sort 
of checking in a prefork &#40;vs fork or threaded&#41; server such requires the 
use of some sort of central balance checking with all of the race 
condition preventions necessary to keep it safe.

In a Net::Server::Fork server since it is the parent that is doing the 
listening - it could be possible to modify the loop that occurs when 
$n_children &gt; $prop-&gt;{&#39;max_servers&#39;} to attempt to also see if there are 
incoming connections as well, and optionally throw them to some other 
handler &#40;including all of the possible SSL negotiations needed&#41;.

Threaded &#40;which isn&#39;t yet in Net::Server but likely will eventually&#41; 
could use a local shared variable to keep track of the total number of 
connections.

But on PreFork, you have somehow coordinate this work between all of the 
child processes and the parent.  In a PreFork server, the parent does 
know how many children are working and controls how many children there 
are lying around, but the parent is not directly selecting/accepting on 
the open server socket ports and has no easy built in way to communicate 
back to the children &#40;well - it sort of does&#41;.  But here is something I 
could imagine working &#40;pseudo code only&#41;

Turn on child_communication 1 during server start up.

Add a sub child_is_talking_hook {} that listens for requests from 
children in the parent.  When a request is received, it can look at the 
current total number of children vs what the limits are. If the number 
of active children are at the max_servers, or max_servers - 2, or 
whatever threshold you set, then you could send a signal back to the 
child to return a 432.  Otherwise if the parent thinks there is capacity 
left it could just signal to go ahead and process the request.  Perhaps 
something like:

sub child_is_talking_hook {
       my &#40;$self, $child_sock&#41; = @_;
       my $req = &lt;$child_sock&gt;;
       my $prop = $self-&gt;{&#39;server&#39;};
       if &#40;&#40;$prop-&gt;{&#39;tally&#39;}-&gt;{&#39;processing&#39;} || 0&#41; &gt;= 
$prop-&gt;{&#39;max_servers&#39;}&#41; { # potentially stale
           print $child_sock &#34;432\n&#34;;
       } else {
           print $child_sock &#34;proceed\n&#34;;
       }
}


In the child you would have something like this at the top of your 
process_request hook:

sub process_request {
     my $self = shift;

     my $parent_sock = $self-&gt;{&#39;server&#39;}-&gt;{&#39;parent_sock&#39;};
     print $parent_sock &#34;New Request\n&#34;;
     my $line = &lt;$parent_sock&gt;;
     if &#40;$line =~ /^432/&#41; {
          print &#34;432 Too many sessions\r\n&#34;;
          return;
     }

     # do the normal processing here
}

There seem to be two options - both of them require a bit of magic.

Use PreForkSimple with a predetermined number of children.  Use some 
sort of shared p

On 10/17/2013 06:21 AM, Fabrice Gabolde via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thu Oct 17 08:21:23 2013: Request 89586 was acted upon.
&gt; Transaction: Ticket created by FGA
&gt;         Queue: Net-Server
&gt;       Subject: Explicitely rejecting incoming connections when all workers are busy
&gt;     Broken in: 2.007
&gt;      Severity: &#40;no value&#41;
&gt;         Owner: Nobody
&gt;    Requestors: FGA@cpan.org
&gt;        Status: new
&gt;   Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=89586">https://rt.cpan.org/Ticket/Display.html?id=89586</a></span> &gt;
&gt;
&gt;
&gt; Hi,
&gt;
&gt; We&#39;re using Net::Server::PreFork for an LMTP mail server.  So far so
&gt; good, everything works.  Great work on a very useful module.
&gt;
&gt; Our problem is the project specs say when no workers are available and
&gt; email arrives, we should return &#34;432 Too many sessions&#34; instead of
&gt; waiting until a worker finishes and is able to call accept&#40;&#41; on the
&gt; socket.  We have set the *_spare_servers variables to 0 since we don&#39;t
&gt; actually want to spawn more children.  &#40;We&#39;re only using PreFork
&gt; instead of PreForkSimple to have a chance to get more accurate tallies
&gt; of waiting/processing workers, really.&#41;
&gt;
&gt; There doesn&#39;t seem to be a way to do this in Net::Server::PreFork &#40;or
&gt; Simple&#41;.  I&#39;ve tried various things with e.g. the idle_loop_hook, but
&gt; that doesn&#39;t get run when I need it.  The accept_deny stuff is ideally
&gt; placed &#40;even though that&#39;s not what it&#39;s for&#41;, but it only runs in the
&gt; workers, who have no idea what the other workers are doing anyway.
&gt;
&gt; Basically I&#39;m looking for:
&gt;
&gt; &#40;a&#41; if and only if all workers are busy
&gt;
&gt; &#40;b&#41; and at least one incoming connection is pending
&gt;
&gt; &#40;c&#41; the master process itself &#40;not necessarily, but it&#39;s the only one
&gt;      who has a reasonable expection of knowing if &#40;a&#41; is true&#41; takes
&gt;      responsability for servicing the pending connections, if only to
&gt;      tell the client that they have to come back later
&gt;
&gt; Is there such a thing in Net::Server, or a workaround for it?
&gt;
&gt; &#40;Also on the wishlist: exposing the various worker tallies as methods
&gt; available in the master process, with documentation on when they are
&gt; available/correct/out of date.&#41;
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;18&nbsp;17:22:02&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;25&nbsp;08:44:30&nbsp;2013</span>
    <span class="description">FGA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, 18 Oct 2013 17:22:02 -0400, RHANDOM wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So, the issue you have below is somewhat fun - I have not previously
&gt; been familiar with LMTP.  The protocol and the 432 response message
&gt; are rather odd beasts &#40;actually mysql connections will often return
&gt; a similar message if you exceed the maximum&#41;.
</div>
Well, I don&#39;t think &#34;432 Too many sessions&#34; is an actual message
specified by any RFC.  Many MTAs define their own custom error codes,
though.  This appears to be purely an invention of our own, but it
does fit a 4xx temporary error.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [elided]
&gt; 
&gt; [On] PreFork, you have somehow coordinate this work between all of
&gt; the child processes and the parent.  In a PreFork server, the parent
&gt; does know how many children are working and controls how many
&gt; children there are lying around, but the parent is not directly
&gt; selecting/accepting on the open server socket ports and has no easy
&gt; built in way to communicate back to the children &#40;well - it sort of
&gt; does&#41;.  But here is something I could imagine working &#40;pseudo code
&gt; only&#41;
&gt; 
&gt; [solution elided]
</div>
This seems like it could work.  It has the disadvantages of requiring
a couple extra workers, and having every worker block on the master
process so they can check if they can relay messages normally, but
that&#39;s probably manageable.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There seem to be two options - both of them require a bit of magic.
&gt; 
&gt; Use PreForkSimple with a predetermined number of children.  Use some
&gt; sort of shared p
</div>
... It would appear RT cut your reply short :/

It turns out this part of the specs is not necessary after all.  After
we got access to the client&#39;s previous system, which we would replace
with the LMTP server I&#39;m developing, we realized they only have a
couple dozen emails per day that need relaying through this custom
gateway.  So our initial 10 workers are probably already overkill, and
in any case even if somehow all 25 emails arrived at the same time
we&#39;re still managing sub-second delays with the current configuration.
I&#39;m still academically interested in your second solution, though!

Thanks for the pointers

-- 
Fabrice Gabolde
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
