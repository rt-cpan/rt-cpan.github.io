<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #80201 for Clone: [PATCH] Stop skipping SvROK handling for all magical scalars &#40;fixes 67105 and 79730&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #80201 for Clone: [PATCH] Stop skipping SvROK handling for all magical scalars &#40;fixes 67105 and 79730&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Clone/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Clone/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Clone/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Clone/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Clone">Clone CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">80201</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Clone/Active/">Clone</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
garu [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-7432-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.31    </td>
  </tr>
  <tr id="CF-7433-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;15&nbsp;15:04:38&nbsp;2012</span>
    <span class="description">garu [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] Stop skipping SvROK handling for all magical scalars
 &#40;fixes 67105 and 79730&#41;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi there!

upon a more thorough discussion of the bug present in 79730 with Florian
Ragwitz &#40;rafl&#41;, he was able to spot and fix the issue. As his commit
message states, when using clone&#40;&#41; on references with &#40;non-tie, as
references can&#39;t be tied&#41; magic attached, the actual cloning of the
referent has been skipped as magic_ref indicated that it should be.

magic_ref appears to only have been intended to track whether or not a
scalar is tied so the contents of the tied structure aren&#39;t cloned.
However, it actually tracked whether or not a scalar had any kind of
magic attached. That is wrong, and this commit fixes it, making
t/08fieldhash.t pass in the process.

Both a patch and a new test file are attached to this message. After
applied, all tests still pass, plus the new one &#40;which fails if this
patch is not applied&#41;.

Hope this helps!
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> clone_patch_2_of_2.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 2ee5b4e9ad653bbf194359857c0fe61eaab0e9be Mon Sep 17 00:00:00 2001
From: Florian Ragwitz &lt;rafl@debian.org&gt;
Date: Mon, 15 Oct 2012 09:34:07 -0300
Subject: [PATCH 2/2] Stop skipping SvROK handling for all magical scalars

Previously, for references with &#40;non-tie, as references can&#39;t be tied&#41; magic
attached, cloning of the referent has been skipped as magic_ref indicated that
it should be.

magic_ref appears to only have been intended to track whether or not a scalar is
tied so the contents of the tied structure aren&#39;t cloned. However, it actually
tracked whether or not a scalar had any kind of magic attached. That is wrong,
and this commit fixes it, making t/08fieldhash.t pass in the process.
---
 Clone.xs |    6 +++++-
 1 file changed, 5 insertions&#40;+&#41;, 1 deletion&#40;-&#41;

diff --git a/Clone.xs b/Clone.xs
index df975e6..1720e53 100755
--- a/Clone.xs
+++ b/Clone.xs
@@ -253,13 +253,17 @@ sv_clone &#40;SV * ref, HV* hseen, int depth&#41;
             case &#39;@&#39;:  /* PERL_MAGIC_arylen_p */
              continue;
               break;
+            case &#39;P&#39;: /* PERL_MAGIC_tied */
+            case &#39;p&#39;: /* PERL_MAGIC_tiedelem */
+            case &#39;q&#39;: /* PERL_MAGIC_tiedscalar */
+	      magic_ref++;
+	      /* fall through */
             default:
               obj = sv_clone&#40;mg-&gt;mg_obj, hseen, -1&#41;; 
           }
         } else {
           TRACEME&#40;&#40;&#34;magic object for type %c in NULL\n&#34;, mg-&gt;mg_type&#41;&#41;;
         }
-	magic_ref++;
 	/* this is plain old magic, so do the same thing */
         sv_magic&#40;clone, 
                  obj,
-- 
1.7.10.4

</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> clone_patch_1_of_2.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 00c24379baac4fc883cdec7c6fce12a10a02865b Mon Sep 17 00:00:00 2001
From: Florian Ragwitz &lt;rafl@debian.org&gt;
Date: Mon, 15 Oct 2012 09:33:57 -0300
Subject: [PATCH 1/2] Add a failing tests for cloning elements of fieldhashes

---
 t/08fieldhash.t |   19 +++++++++++++++++++
 1 file changed, 19 insertions&#40;+&#41;
 create mode 100644 t/08fieldhash.t

diff --git a/t/08fieldhash.t b/t/08fieldhash.t
new file mode 100644
index 0000000..6c5974c
--- /dev/null
+++ b/t/08fieldhash.t
@@ -0,0 +1,19 @@
+# $Id: 07magic.t,v 1.8 2007/04/20 05:40:48 ray Exp $
+
+use strict;
+use warnings;
+use Test::More;
+
+use Clone &#39;clone&#39;;
+use Hash::Util::FieldHash &#39;fieldhash&#39;;
+
+fieldhash my %hash;
+
+my $var = {};
+
+exists $hash{ \$var };
+
+my $cloned = clone&#40;$var&#41;;
+cmp_ok&#40;$cloned, &#39;!=&#39;, $var&#41;;
+
+done_testing;
-- 
1.7.10.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;30&nbsp;00:30:42&nbsp;2012</span>
    <span class="description">garu [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> rdf [...] cpan.org, flora [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Ray,

this is just a follow-up on the Clone.pm issue. It&#39;s been a couple of
weeks since we submitted the patch :&#41;

Since we haven&#39;t seen any updates in Clone.pm in almost 4 years now
&#40;Jan/2009&#41; and the RT list has issues going as far back as 6 years, we
were wondering if you are maybe too busy or simply lost interest in the
Clone distribution altogether.

If this is the case, Florian and myself gladly volunteer to step in as
co-maintainers, so we are able to ship fixes like this to CPAN and keep
the module as up to date as we can. You would of course still retain
Clone&#39;s authorship and be able to revoke our access whenever you see fit.

I&#39;ve CC&#39;d your only known email address in the off chance you&#39;re not
getting the RT messages. Hopefully we&#39;ll hear from you in the next few
days or so.

If, for whatever reason, you&#39;re unable to reply to the RT system, please
feel free to simply reply to this message via traditional email, to
flora@cpan.org and garu@cpan.org.


Cheers!

Breno &#40;garu&#41;


On Mon Oct 15 15:04:38 2012, GARU wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi there!
&gt; 
&gt; upon a more thorough discussion of the bug present in 79730 with Florian
&gt; Ragwitz &#40;rafl&#41;, he was able to spot and fix the issue. As his commit
&gt; message states, when using clone&#40;&#41; on references with &#40;non-tie, as
&gt; references can&#39;t be tied&#41; magic attached, the actual cloning of the
&gt; referent has been skipped as magic_ref indicated that it should be.
&gt; 
&gt; magic_ref appears to only have been intended to track whether or not a
&gt; scalar is tied so the contents of the tied structure aren&#39;t cloned.
&gt; However, it actually tracked whether or not a scalar had any kind of
&gt; magic attached. That is wrong, and this commit fixes it, making
&gt; t/08fieldhash.t pass in the process.
&gt; 
&gt; Both a patch and a new test file are attached to this message. After
&gt; applied, all tests still pass, plus the new one &#40;which fails if this
&gt; patch is not applied&#41;.
&gt; 
&gt; Hope this helps!
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;30&nbsp;00:30:43&nbsp;2012</span>
    <span class="description">garu [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;22&nbsp;09:28:45&nbsp;2012</span>
    <span class="description">garu [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in 0.32!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;22&nbsp;09:28:45&nbsp;2012</span>
    <span class="description">garu [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
