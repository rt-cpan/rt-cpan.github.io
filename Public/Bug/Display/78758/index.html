<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #78758 for Test-HasVersion: Fix for Test::Builder 1.5</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #78758 for Test-HasVersion: Fix for Test::Builder 1.5</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Test-HasVersion/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Test-HasVersion/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Test-HasVersion/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Test-HasVersion/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Test-HasVersion">Test-HasVersion CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">78758</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Test-HasVersion/Active/">Test-HasVersion</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mschwern [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-40286-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.012    </td>
  </tr>
  <tr id="CF-40287-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.014    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;03&nbsp;02:09:09&nbsp;2012</span>
    <span class="description">mschwern [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Fix for Test::Builder 1.5</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

The attached patch fixes Test::HasVersion&#39;s tests for Test::Builder1.5.
 Test::Builder 1.5 adds a TAP version header to the TAP output, so the
plan is no longer the first thing to come out.  This could be hacked
around in the test, but its safer to use Test::Builder::Tester which
will better roll with TAP formatting changes.

It also fixes the code so all_pm_version_ok&#40;&#41; reports failure from the
point where it&#39;s called, not inside HasVersion.pm.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> tb.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/HasVersion.pm b/HasVersion.pm
index aefc19c..3a6ea58 100644
--- a/HasVersion.pm
+++ b/HasVersion.pm
@@ -167,6 +167,7 @@ the plan is left untouched.
 
 sub all_pm_version_ok {
   my @pm_files = all_pm_files&#40;@_&#41;;
+  local $Test::Builder::Level = $Test::Builder::Level + 1;
   $Test-&gt;plan&#40;tests =&gt; scalar @pm_files&#41; unless $Test-&gt;has_plan;
   for &#40;@pm_files&#41; {
     pm_version_ok&#40;$_&#41;;
diff --git a/t/04_all.ok.t b/t/04_all.ok.t
index f009de7..93f0880 100755
--- a/t/04_all.ok.t
+++ b/t/04_all.ok.t
@@ -1,14 +1,8 @@
 #!/usr/bin/perl
 
-use Test::More tests =&gt; 4 + 3;
-
-use File::Spec;
-my $null = File::Spec-&gt;devnull;
-
-ok&#40;chdir &#34;t/eg/&#34;, &#34;cd t/eg&#34;&#41;;
-my @tap = `$^X -Mblib ../../t/97_has_version.t 2&gt;$null`;
-ok&#40;scalar @tap, &#39;t/97_has_version.t run ok&#39;&#41;;
-ok&#40;chdir &#34;../..&#34;, &#34;cd ../..&#34;&#41;;
+use Test::Builder::Tester tests =&gt; 1;
+use Test::More;
+use Test::HasVersion;
 
 my @expected = &#40;
   &#39;A.pm&#39; =&gt; &#39;ok&#39;,
@@ -16,12 +10,18 @@ my @expected = &#40;
   &#39;lib/B/C.pm&#39; =&gt; &#39;not ok&#39;,
 &#41;;
 
-like&#40;shift @tap, qr/^1\.\.3/, &#39;good plan&#39;&#41;;
+test_out&#40;&#34;1..3&#34;&#41;;
+
+my $count = 1;
+while&#40;@expected&#41; {
+  my $file = shift @expected;
+  my $want = shift @expected;
+  test_out&#40;&#34;$want $count - $file has version&#34;&#41;;
+  test_fail&#40;+5&#41; if $want eq &#39;not ok&#39;;
+  $count++;
+}
 
-for &#40;@tap&#41; {
-  next if /^#/;
-  my $f = shift @expected;
-  my $ans = shift @expected;
-  like&#40;$_, qr/^$ans \d+ - $f/, $ans eq &#39;ok&#39; ? &#34;$f has version&#34; : &#34;$f has no version&#34;&#41;;
+chdir &#34;t/eg/&#34; or die &#34;Can&#39;t chdir to t/eg&#34;;
+all_pm_version_ok&#40;&#41;;
 
-}
\ No newline at end of file
+test_test&#40;&#34;all_pm_version_ok&#40;&#41; including failures&#34;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;03&nbsp;05:26:16&nbsp;2012</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry, that last patch had a mistake in it and wouldn&#39;t work with 0.98.
 This patch will work with 0.98, but it won&#39;t work with 1.5 until the
next release &#40;which will be 1.5.0_06&#41; because it revealed a bug &#40;or at
least a lost accidental feature&#41;.  But its an alpha so its safe to patch
now.
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/schwern/test-more/commit/00d4609f79fef0ad0db954ba9d9982026eb755e0">https://github.com/schwern/test-more/commit/00d4609f79fef0ad0db954ba9d9982026eb755e0</a></span>
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> tb.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/HasVersion.pm b/HasVersion.pm
index aefc19c..3a6ea58 100644
--- a/HasVersion.pm
+++ b/HasVersion.pm
@@ -167,6 +167,7 @@ the plan is left untouched.
 
 sub all_pm_version_ok {
   my @pm_files = all_pm_files&#40;@_&#41;;
+  local $Test::Builder::Level = $Test::Builder::Level + 1;
   $Test-&gt;plan&#40;tests =&gt; scalar @pm_files&#41; unless $Test-&gt;has_plan;
   for &#40;@pm_files&#41; {
     pm_version_ok&#40;$_&#41;;
diff --git a/t/04_all.ok.t b/t/04_all.ok.t
index f009de7..b8be695 100755
--- a/t/04_all.ok.t
+++ b/t/04_all.ok.t
@@ -1,14 +1,8 @@
 #!/usr/bin/perl
 
-use Test::More tests =&gt; 4 + 3;
-
-use File::Spec;
-my $null = File::Spec-&gt;devnull;
-
-ok&#40;chdir &#34;t/eg/&#34;, &#34;cd t/eg&#34;&#41;;
-my @tap = `$^X -Mblib ../../t/97_has_version.t 2&gt;$null`;
-ok&#40;scalar @tap, &#39;t/97_has_version.t run ok&#39;&#41;;
-ok&#40;chdir &#34;../..&#34;, &#34;cd ../..&#34;&#41;;
+use Test::Builder::Tester tests =&gt; 1;
+use Test::More;
+use Test::HasVersion;
 
 my @expected = &#40;
   &#39;A.pm&#39; =&gt; &#39;ok&#39;,
@@ -16,12 +10,16 @@ my @expected = &#40;
   &#39;lib/B/C.pm&#39; =&gt; &#39;not ok&#39;,
 &#41;;
 
-like&#40;shift @tap, qr/^1\.\.3/, &#39;good plan&#39;&#41;;
+my $count = 1;
+while&#40;@expected&#41; {
+  my $file = shift @expected;
+  my $want = shift @expected;
+  test_out&#40;&#34;$want $count - $file has version&#34;&#41;;
+  test_fail&#40;+5&#41; if $want eq &#39;not ok&#39;;
+  $count++;
+}
 
-for &#40;@tap&#41; {
-  next if /^#/;
-  my $f = shift @expected;
-  my $ans = shift @expected;
-  like&#40;$_, qr/^$ans \d+ - $f/, $ans eq &#39;ok&#39; ? &#34;$f has version&#34; : &#34;$f has no version&#34;&#41;;
+chdir &#34;t/eg/&#34; or die &#34;Can&#39;t chdir to t/eg&#34;;
+all_pm_version_ok&#40;&#41;;
 
-}
\ No newline at end of file
+test_test&#40;&#34;all_pm_version_ok&#40;&#41; including failures&#34;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;03&nbsp;05:26:17&nbsp;2012</span>
    <span class="description">mschwern [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;03&nbsp;16:07:31&nbsp;2016</span>
    <span class="description">ferreira [...] shoo.cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;03&nbsp;16:07:32&nbsp;2016</span>
    <span class="description">ferreira [...] shoo.cpan.org -  Fixed in 0.014 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
