<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #93056 for System-Command: corrupted binary pipes on Win32</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #93056 for System-Command: corrupted binary pipes on Win32</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=System-Command">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=System-Command">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=System-Command">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=System-Command">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/System-Command">System-Command CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">93056</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=System-Command">System-Command</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
djerius [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-236680-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.107    </td>
  </tr>
  <tr id="CF-236681-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




sys_cmd.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1389145/737694/sys_cmd.pl">
Tue Jul 22 00:53:53 2014 (2.6k) by djerius [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=93056">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1327059" href="/Public/Bug/Display.html?id=93056#txn-1327059">#</a>      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;16&nbsp;00:18:28&nbsp;2014</span>
    <span class="description">djerius [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> corrupted binary pipes on Win32</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1327059/703866/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/703866">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Executive Summary:

Simply setting binmode on the child&#39;s filehandles will not properly
enable binmode in Win32, due to how IPC::Run implements things.  I
don&#39;t think that a version of IPC::Run which would transparently
support setting binmode on filehandles is likely, so properly
supporting binary data streams in System::Command will require
an explicit binmode parameter.


The hideous details:

Because of the way that pipes are handled on Win32 via IPC::Run,
setting binmode on the child&#39;s filehandles does not actually result in
binary mode.

For example, the following code

------------------------------------------------------------------------------
use System::Command;

my $buf = pack&#40;&#39;N&#39;,13&#41;;

binmode&#40; \*STDOUT &#41;;
$cmd = System::Command-&gt;new&#40; &#39;od&#39;, &#39;-c&#39; &#41;;
binmode $cmd-&gt;stdin;
binmode $cmd-&gt;stdout;

$cmd-&gt;stdin-&gt;print&#40; $buf &#41;;
$cmd-&gt;stdin-&gt;close;
print $cmd-&gt;stdout-&gt;getline;
------------------------------------------------------------------------------

when run with binmode properly on results in

-----------------------
0000000  \0  \0  \0  \r
-----------------------

Note the &#34;\r&#34;.  When this is run on Win32, it results in

-------------------
0000000  \0  \0  \0
-------------------

Note the missing &#34;\r&#34;.

I know almost nothing about Win32, but I think the following analysis
is correct.

System::Command uses IPC::Run on Win32.  IPC::Run uses a helper script
&#40;IPC::Run::Win32Pump&#41; to shuttle data between processes &#40;apparently
using temporary files and copying data from one file to another&#41;.
IPC::Run::Win32Pump has the following code [1]

    110 $buf =~ s/\r//g unless $binmode;

This strips out all carriage returns regardless if they are actually
followed by a new line character.  In the case of my binary data, that
removes the \r, corrupting the stream.  I&#39;ve confirmed that this line
is the culprit by commenting out that line and verifying that the test
program above works as expected.[1]

The &#34;$binmode&#34; parameter on that line is essentially set by specifying
the IPC::Run binary filter.  For example, in System::Command, this

     61     # start the command
     62     if &#40;MSWin32&#41; {
     63         $pid = IPC::Run::start&#40;
     64             [@cmd],
     65             &#39;&lt;pipe&#39;  =&gt; $in,
     66             &#39;&gt;pipe&#39;  =&gt; $out,
     67             &#39;2&gt;pipe&#39; =&gt; $err,
     68         &#41;;
     69     }


becomes this:

     61     # start the command
     62     if &#40;MSWin32&#41; {
     63         $pid = IPC::Run::start&#40;
     64             [@cmd],
     65             &#39;&lt;pipe&#39;  =&gt; IPC::Run::binary&#40;&#41;, $in,
     66             &#39;&gt;pipe&#39;  =&gt; IPC::Run::binary&#40;&#41;, $out,
     67             &#39;2&gt;pipe&#39; =&gt; IPC::Run::binary&#40;&#41;, $err,
     68         &#41;;
     69     }


and the test script works as expected.

Comments to the effect of Perl&#39;s binmode function not seeming to work
on Win32 appear several times in IPC::Run, but at least under 5.18.2,
they do seem to work:

------------------------------------------------------------------------------
perl -E &#39;say pack&#40;&#34;N&#34;, 13&#41;&#39; | od -c
0000000  \0  \0  \0  \0  \r  \r  \n

perl -E &#39;binmode \*STDOUT; say pack&#40;&#34;N&#34;, 13&#41;&#39; | od -c
0000000  \0  \0  \0  \0  \r  \n
------------------------------------------------------------------------------

I really don&#39;t know if it&#39;s possible that IPC::Run could be fixed so
that binmode&#40;&#41; on the child&#39;s filehandles will work, but there&#39;s not
much activity going on in that codebase, so I think that a solution to
get System::Command working on Win32 needs to be done in System::Command.

Unfortunately, I think an explicit binmode option may need to be
provided by System::Command so that it can be appropriately applied
for Windows and other systems.


Thanks,

Diab




[1]

Somewhat more sophisticated code is found elsewhere in IPC::Run::Win32IO

    206       if &#40; $self-&gt;binmode &#41; {
    207          $data_ref = $self-&gt;{SOURCE};
    208       }
    209       else {
    210          my $data = ${$self-&gt;{SOURCE}};  # Ugh, a copy.
    211          $data =~ s/&#40;?&lt;!\r&#41;\n/\r\n/g;
    212          $data_ref = \$data;
    213       }
 
[...]

    272       $s =~ s/\r\n/\n/g unless $self-&gt;binmode;

The code base is complex, so I&#39;m not sure if code to manually fix the
crlf is actually needed. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1389145" href="/Public/Bug/Display.html?id=93056#txn-1389145">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;22&nbsp;00:53:53&nbsp;2014</span>
    <span class="description">djerius [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1389145/737693/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/737693">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry for the long delay.  I&#39;ve been performing what feels like a
random walk through the IPC::Run code.  I believe that there are
two problems:

  * It doesn&#39;t respond to the binmode&#40;&#41; operation
  * It doesn&#39;t properly support the default &#40;text&#41; mode CRLF
    encoding/decoding.

Part of the complexity in the code is that it creates a separate
&#34;pumper&#34; process on each filehandle, as according to the author,
Windows only allows selects on a socket, so there&#39;s some complex
gymnastics involving sockets and pipes and child processes that I
haven&#39;t quite figured out.

Anyway, here&#39;s what I&#39;ve got so far:

From the Perl docs for binmode, binmode indicates that data are
treated as bytes and that no alterations to the bytes are done. In
particular on Win32, that means that the newline character &#34;\n&#34; &#40;which
is used by Perl to indicate end-of-line&#41; is not translated into
&#34;\r\n&#34;, which is the proper sequence on Win32.  This is the same as
the &#39;:raw&#39; PerlIO layer.

On Windows, the default mode PerlIO mode should be :crlf mode, which
is documented &#40;in PerlIO&#41; as

:crlf

   A layer that implements DOS/Windows like CRLF line endings.  On
   read converts pairs of CR,LF to a single &#34;\n&#34; newline character.
   On write converts each &#34;\n&#34; to a CR,LF pair.  Note that this layer
   will silently refuse to be pushed on top of itself.


I&#39;ve attached a test program which illustrates what I think is going on.

All tests use the following string, which has an extra unpaired \r.

    foo\n\r\n

or in hex

    66 6f 6f 0a 0d 0a

All expected results are determined by directly writing the test
string to files and dumping them or by directly reading files
containing the raw &#40;internal Perl, binary&#41; or properly crlf encoded
test string

Here&#39;s the annotated output on Windows XP using Strawberry Perl.

default write to pipe:
expected: 66 6f 6f 0d 0a 0d 0d 0a
got     : 66 6f 6f 0a 0a

  * the 0a characters should have been translated to 0d 0a, but weren&#39;t
  * the extra 0d character is missing.

binary write to pipe:
expected: 66 6f 6f 0a 0d 0a
got     : 66 6f 6f 0a 0a

  * the extra 0d character is missing

default read of non-crlf encoded data:
expected: 66 6f 6f 0a 0a
got     : 66 6f 6f 0a 0a

  * The fiducial result confuses me, as my reading of :crlf mode is
    that *pairs* of \r\n characters are converted to \n.  The extra
    &#39;\r&#39; has &#40;unexpectedly&#41; disappeared from the fiducial output.

binary read of non-crlf encoded data:
expected: 66 6f 6f 0a 0d 0a
got     : 66 6f 6f 0a 0a

  * the extra 0d character is missing

default read of crlf encoded data
expected: 66 6f 6f 0a 0d 0a
got     : 66 6f 6f 0a 0a

  * the extra 0d character is missing

binary read of crlf encoded data
expected: 66 6f 6f 0d 0a 0d 0d 0a
got     : 66 6f 6f 0a 0a

  * all of the 0d characters are missing


The important things to notice are:

  * as mentioned in the original bug report, binary mode is broken; \r is
    stripped.

  * default &#40;text&#41; mode is also  broken.
      * on output, crlf encoding is not performed &#40;and the extra \r is stripped&#41;
      * on input, crlf decoding strips out the extra \r.


Here&#39;s what I think is going on.

IPC::Run transfers data to and from the child process on Win32 using
one of two methods:

1. If the data are read from scalars or named files, temporary files are used.

2. otherwise, a &#34;pumper&#34; process is used.

The latter is what is used when IPC::Run is called by System::Command.
The bugs are a combination of two things:

1. The main program communicates with the pumper process via sockets,
   which default to binmode on Win32.  If I alter the IPC::Run code to
   reset the sockets to text mode, text mode works.

2. IPC::Run::Win32IO implements non-binmode internally, but as far as
   I can tell, doesn&#39;t distinguish between translating to/from &#34;\n&#34; to
   &#34;\r\n&#34;; it always simply removes &#34;\r&#34;, regardless of whether it
   is paired with a &#34;\n&#34;.


I _think_ that a couple of simple changes to IPC::Run might fix things
&#40;removing the internal binmode code, reseting the sockets to text mode&#41;,
but as I mentioned before, there&#39;s not much movement in that code base.

I recommend finding another option for Windows.  If one exists.  I&#39;ve
tried IPC::Exe, but that also has problems
&#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=93112&#41;">https://rt.cpan.org/Ticket/Display.html?id=93112&#41;</a></span>.


I&#39;ll continue working on this, at the least to post a bug report for IPC::Run.

Thanks for your patience.

Diab
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> sys_cmd.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1389145/737694/sys_cmd.pl">Download sys_cmd.pl</a><br />
<span class="downloadcontenttype">text/x-perl 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use System::Command;
use IO::File;

use strict;
use warnings;

my $tstr = &#34;foo\n\r\n&#34;;

our @hd_f = &#40; $^X, &#39;-e&#39;, &#39;$/=undef; open STDIN, $ARGV[0]; binmode STDIN; print join&#40; q/ /, map { unpack&#40; q/H*/, $_&#41; } split //, &lt;STDIN&gt; &#41;, qq/\n/&#39; &#41;;
our @hd_s = &#40; $^X, &#39;-e&#39;, &#39;$/=undef; binmode STDIN; print join&#40; q/ /, map { unpack&#40; q/H*/, $_&#41; } split //, &lt;STDIN&gt; &#41;, qq/\n/&#39; &#41;;

our @cat = &#40; $^X, &#39;-e&#39;, &#39;$/=undef; open STDIN, $ARGV[0]; binmode STDIN; binmode STDOUT; print STDOUT &lt;STDIN&gt;;&#39; &#41;;

sub hd {
    join&#40; q/ /, map { unpack&#40; q/H*/, $_&#41; } split //, shift &#41;, qq/\n/;
}



# these must work, or Perl is borked
sub fiducial_write {

    my &#40; $write_mode &#41; = @_;

    my $mode = $write_mode eq &#39;default&#39; ? &#39;&gt;&#39; : &#39;&gt;:raw&#39; ;

    IO::File-&gt;new&#40; $write_mode, $mode &#41;-&gt;print&#40; $tstr &#41;;

    print &#34;expected: &#34;;
    system&#40; @hd_f, $write_mode &#41;;
}

sub fiducial_read {

    my &#40; $write_mode, $read_mode &#41; = @_;

    my $mode = $read_mode eq &#39;default&#39; ? &#39;&lt;&#39; : &#39;&lt;:raw&#39; ;
    IO::File-&gt;new&#40; $write_mode, $mode &#41;-&gt;read&#40; my $buf, 1000 &#41;;

    print &#34;expected: &#34;, hd&#40; $buf &#41;;
}

{
    my $cmd = System::Command-&gt;new&#40; @hd_s &#41;;
    $cmd-&gt;stdin-&gt;print&#40; $tstr &#41;;
    $cmd-&gt;stdin-&gt;close;
    print &#34;default write to pipe:\n&#34;;
    fiducial_write&#40; &#39;default&#39; &#41;;
    print &#34;got     : &#34;, $cmd-&gt;stdout-&gt;getline;
    print &#34;\n&#34;;
}


{
    my $cmd = System::Command-&gt;new&#40; @hd_s &#41;;
    binmode $cmd-&gt;stdin;
    $cmd-&gt;stdin-&gt;print&#40; $tstr &#41;;
    $cmd-&gt;stdin-&gt;close;
    print &#34;binary write to pipe:\n&#34;;
    fiducial_write&#40; &#39;binary&#39; &#41;;
    print &#34;got     : &#34;, $cmd-&gt;stdout-&gt;getline;
    print &#34;\n&#34;;
}

{
    my $cmd = System::Command-&gt;new&#40; @cat, &#39;binary&#39; &#41;;
    $cmd-&gt;stdin-&gt;close;
    $cmd-&gt;stdout-&gt;read&#40; my $buf, 100 &#41;;
    print &#34;default read of non-crlf encoded data: \n&#34;;
    fiducial_read&#40; &#39;binary&#39;, &#39;default&#39; &#41;;
    print &#34;got     : &#34;, hd&#40; $buf &#41;;
    print &#34;\n&#34;;
}

{
    my $cmd = System::Command-&gt;new&#40; @cat, &#39;binary&#39; &#41;;
    binmode $cmd-&gt;stdout;
    $cmd-&gt;stdin-&gt;close;
    $cmd-&gt;stdout-&gt;read&#40; my $buf, 100 &#41;;
    print &#34;binary read of non-crlf encoded data: \n&#34;;
    fiducial_read&#40; &#39;binary&#39;, &#39;binary&#39; &#41;;
    print &#34;got     : &#34;, hd&#40; $buf &#41;;
    print &#34;\n&#34;;
}

{
    my $cmd = System::Command-&gt;new&#40; @cat, &#39;default&#39; &#41;;
    $cmd-&gt;stdin-&gt;close;
    $cmd-&gt;stdout-&gt;read&#40; my $buf, 100 &#41;;
    print &#34;default read of crlf encoded data\n&#34;;
    fiducial_read&#40; &#39;default&#39;, &#39;default&#39; &#41;;
    print &#34;got     : &#34;, hd&#40; $buf &#41;;
    print &#34;\n&#34;;
}

{
    my $cmd = System::Command-&gt;new&#40; @cat, &#39;default&#39; &#41;;
    binmode $cmd-&gt;stdout;
    $cmd-&gt;stdin-&gt;close;
    $cmd-&gt;stdout-&gt;read&#40; my $buf, 100 &#41;;
    print &#34;binary read of crlf encoded data \n&#34;;
    fiducial_read&#40; &#39;default&#39;, &#39;binary&#39; &#41;;
    print &#34;got     : &#34;, hd&#40; $buf &#41;;
    print &#34;\n&#34;;
}



</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1404042" href="/Public/Bug/Display.html?id=93056#txn-1404042">#</a>      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;27&nbsp;18:07:56&nbsp;2014</span>
    <span class="description">book [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #93056] corrupted binary pipes on Win32</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 28 Aug 2014 00:07:17 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Diab Jerius via RT &lt;bug-System-Command [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Philippe Bruhat &#40;BooK&#41;&#34; &lt;book [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1404042/745362/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/745362">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Jul 22, 2014 at 12:53:53AM -0400, Diab Jerius via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Sorry for the long delay.  I&#39;ve been performing what feels like a
&gt; random walk through the IPC::Run code.  I believe that there are
&gt; two problems:
&gt; 
&gt;   * It doesn&#39;t respond to the binmode&#40;&#41; operation
&gt;   * It doesn&#39;t properly support the default &#40;text&#41; mode CRLF
&gt;     encoding/decoding.
</div>
Many thanks for the detailed reports.

If I understood both your emails correctly, you identified the problem
in detail, but have no solution &#40;yet&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I recommend finding another option for Windows.  If one exists.  I&#39;ve
&gt; tried IPC::Exe, but that also has problems
&gt; &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=93112&#41;">https://rt.cpan.org/Ticket/Display.html?id=93112&#41;</a></span>.
&gt; 
&gt; I&#39;ll continue working on this, at the least to post a bug report for IPC::Run.
</div>
I&#39;m interested in finding/using another option for Windows. If one exists.

I think Capture::Tiny probably has the most comprehensive list of options
for an IPC::Run replacement: <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/Capture::Tiny#SEE-ALSO">https://metacpan.org/pod/Capture::Tiny#SEE-ALSO</a></span>

If I remember correctly, another issue with IPC::Run is that starting
up the pumper program &#40;or spawning the actual process?&#41; takes some time,
and when running a lot of commands through System::Command, the equivalent
programs running under Linux and Windows can be significantly slower.

I noticed that looking at the test suite for Git::Repository &#40;which is
the main user of System::Command&#41; running.

There are several IPC modules that support Win32, most of them for capturing
program output. The specific thing I&#39;m looking for with System::Command is
the ability to obtain filehandles connected to the subprocess STDIN, STDOUT
and STDERR, so that it&#39;s possible to deal with potentially infinite streams
line by line.
 
-- 
 Philippe Bruhat &#40;BooK&#41;

 Treat those you outrank well... you never know when they will outrank you.
                                                 &#40;Moral from Groo #7 &#40;Image&#41;&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1404043" href="/Public/Bug/Display.html?id=93056#txn-1404043">#</a>      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;27&nbsp;18:07:56&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.33366</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
