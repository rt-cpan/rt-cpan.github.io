<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #37149 for threads-shared: shared hashes fail to preserve utf-8ness of keys</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #37149 for threads-shared: shared hashes fail to preserve utf-8ness of keys</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/threads-shared/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/threads-shared/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/threads-shared/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/threads-shared/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/threads-shared">threads-shared CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">37149</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/threads-shared/Active/">threads-shared</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
JGMYERS [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-32722-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.14    </td>
  </tr>
  <tr id="CF-32723-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.24    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;26&nbsp;19:14:21&nbsp;2008</span>
    <span class="description">JGMYERS [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> shared hashes fail to preserve utf-8ness of keys</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Per the attached test case, shared hash tables fail to preserve the
utf8::is_utf8&#40;&#41;-ness of hash keys.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> shared-utf8.t</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#! /usr/bin/perl -w

use strict;
use warnings;
use threads;
use threads::shared;
use Test::More tests =&gt; 2;

binmode STDOUT, &#34;:utf8&#34;;

my $name=&#34;\x{123}\x{84}\x{20F}\x{2C1}&#34;;
my @d;
push @d, $name;

my &#40;$a&#41;;
my %a:shared;

unless &#40;$a&#41; {
  $a = &#38;share&#40;{}&#41;;
}
%$a = &#40;&#41;;
%a = &#40;&#41;;

foreach &#40;@d&#41; {
  my $file=&#34;/tmp/$_&#34;;
  $$a{$_} = $file;
  $a{$_} = $file;
  print &#34;name=$_ file=$file\n&#34;;
}

while &#40;my &#40;$key, $value&#41; = each &#40;%$a&#41;&#41; {
 print &#34;key=$key value=$value\n&#34;;
 ok&#40; $key eq $name, &#34;compare values in shared ref hash a: name and key&#34;&#41;;
}

while &#40;my &#40;$key, $value&#41; = each &#40;%a&#41;&#41; {
 print &#34;key=$key value=$value\n&#34;;
 ok&#40; $key eq $name, &#34;compare values in shared hash a: name and key&#34;&#41;;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;30&nbsp;10:11:54&nbsp;2008</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> bug-threads-shared [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] [rt.cpan.org #37149] shared hashes fail to preserve utf-8ness of keys</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 30 Jun 2008 10:11:05 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> pp &lt;perl5-porters [...] perl.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jerry D. Hedden&#34; &lt;jdhedden [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The attached patch fixes the subject bug.  It also adds a
new file to the test suite.

In addition, t/wait.t and t/waithires.t have been modified
to use the new watchdog&#40;&#41; function that was added to
test.pl.
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;30&nbsp;10:12:04&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;30&nbsp;14:29:23&nbsp;2008</span>
    <span class="description">JGMYERS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Testing the patched threads::shared as a standalone module compiling
with perl 5.8.8, I get failures running the test harness:

t/av_refs........Can&#39;t load
&#39;/u/jgmyers/src/threads-shared-1.23/blib/arch/auto/threads/shared/shared.so&#39;
for module threads::shared:
/u/jgmyers/src/threads-shared-1.23/blib/arch/auto/threads/shared/shared.so:
undefined symbol: DPPP_my_newSVpvn_flags at
/u/jgmyers/perl/lib/5.8.8/i686-linux-thread-multi/DynaLoader.pm line 230.
 at t/av_refs.t line 38

and 

t/wait...........Can&#39;t locate ./t/test.pl in @INC &#40;@INC contains:
/u/jgmyers/src/threads-shared-1.23/blib/lib
/u/jgmyers/src/threads-shared-1.23/blib/arch
/u/jgmyers/perl/lib/5.8.8/i686-linux-thread-multi
/u/jgmyers/perl/lib/5.8.8
/u/jgmyers/perl/lib/site_perl/5.8.8/i686-linux-thread-multi
/u/jgmyers/perl/lib/site_perl/5.8.8 /u/jgmyers/perl/lib/site_perl .&#41; at
t/wait.t line 10.
BEGIN failed--compilation aborted at t/wait.t line 16.
t/wait...........dubious

The fix seems a bit dubious in that it causes any iso-8859-1 keys to be
utf8 upgradeed.  I think a better approach is to copy the UTF8 bit into
the shared hash table, such as done by the attached patch.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- threads-shared-1.23/shared.xs	2008-06-30 11:17:45.000000000 -0700
+++ threads-shared-1.23-fix/shared.xs	2008-06-30 11:19:49.000000000 -0700
@@ -875,7 +875,9 @@
         STRLEN len = mg-&gt;mg_len;
         assert &#40; mg-&gt;mg_ptr != 0 &#41;;
         if &#40;mg-&gt;mg_len == HEf_SVKEY&#41; {
-           key = SvPVutf8&#40;&#40;SV *&#41;mg-&gt;mg_ptr, len&#41;;
+           key = SvPV&#40;&#40;SV *&#41; mg-&gt;mg_ptr, len&#41;;
+	   if &#40;SvUTF8&#40;&#40;SV *&#41; mg-&gt;mg_ptr&#41;&#41;
+	      len = -len;
         }
         SHARED_CONTEXT;
         svp = hv_fetch&#40;&#40;HV*&#41; saggregate, key, len, 0&#41;;
@@ -925,8 +927,11 @@
         char *key = mg-&gt;mg_ptr;
         STRLEN len = mg-&gt;mg_len;
         assert &#40; mg-&gt;mg_ptr != 0 &#41;;
-        if &#40;mg-&gt;mg_len == HEf_SVKEY&#41;
-           key = SvPVutf8&#40;&#40;SV *&#41;mg-&gt;mg_ptr, len&#41;;
+        if &#40;mg-&gt;mg_len == HEf_SVKEY&#41; {
+           key = SvPV&#40;&#40;SV *&#41; mg-&gt;mg_ptr, len&#41;;
+	   if &#40;SvUTF8&#40;&#40;SV *&#41; mg-&gt;mg_ptr&#41;&#41;
+	      len = -len;
+	}
         SHARED_CONTEXT;
         svp = hv_fetch&#40;&#40;HV*&#41; saggregate, key, len, 1&#41;;
     }
@@ -956,8 +961,11 @@
         char *key = mg-&gt;mg_ptr;
         STRLEN len = mg-&gt;mg_len;
         assert &#40; mg-&gt;mg_ptr != 0 &#41;;
-        if &#40;mg-&gt;mg_len == HEf_SVKEY&#41;
-           key = SvPVutf8&#40;&#40;SV *&#41;mg-&gt;mg_ptr, len&#41;;
+        if &#40;mg-&gt;mg_len == HEf_SVKEY&#41; {
+           key = SvPV&#40;&#40;SV *&#41; mg-&gt;mg_ptr, len&#41;;
+	   if &#40;SvUTF8&#40;&#40;SV *&#41; mg-&gt;mg_ptr&#41;&#41;
+	      len = -len;
+        }
         SHARED_CONTEXT;
         hv_delete&#40;&#40;HV*&#41; saggregate, key, len, G_DISCARD&#41;;
     }
@@ -1275,7 +1283,9 @@
             exists = av_exists&#40;&#40;AV*&#41; sobj, SvIV&#40;index&#41;&#41;;
         } else {
             STRLEN len;
-            char *key = SvPVutf8&#40;index, len&#41;;
+            char *key = SvPV&#40;index,len&#41;;
+	    if &#40;SvUTF8&#40;index&#41;&#41;
+	       len = -len;
             SHARED_EDIT;
             exists = hv_exists&#40;&#40;HV*&#41; sobj, key, len&#41;;
         }
@@ -1297,9 +1307,11 @@
         hv_iterinit&#40;&#40;HV*&#41; sobj&#41;;
         entry = hv_iternext&#40;&#40;HV*&#41; sobj&#41;;
         if &#40;entry&#41; {
+            I32 utf8 = HeKWASUTF8&#40;entry&#41;;
             key = hv_iterkey&#40;entry,&#38;len&#41;;
             CALLER_CONTEXT;
-            ST&#40;0&#41; = sv_2mortal&#40;newSVpvn_utf8&#40;key, len, 1&#41;&#41;;
+            ST&#40;0&#41; = sv_2mortal&#40;newSVpvn&#40;key, len&#41;&#41;;
+	    if &#40;utf8&#41; SvUTF8_on&#40;ST&#40;0&#41;&#41;;
         } else {
             CALLER_CONTEXT;
             ST&#40;0&#41; = &#38;PL_sv_undef;
@@ -1323,9 +1335,11 @@
         SHARED_CONTEXT;
         entry = hv_iternext&#40;&#40;HV*&#41; sobj&#41;;
         if &#40;entry&#41; {
+            I32 utf8 = HeKWASUTF8&#40;entry&#41;;
             key = hv_iterkey&#40;entry,&#38;len&#41;;
             CALLER_CONTEXT;
-            ST&#40;0&#41; = sv_2mortal&#40;newSVpvn_utf8&#40;key, len, 1&#41;&#41;;
+            ST&#40;0&#41; = sv_2mortal&#40;newSVpvn&#40;key, len&#41;&#41;;
+	    if &#40;utf8&#41; SvUTF8_on&#40;ST&#40;0&#41;&#41;;
         } else {
             CALLER_CONTEXT;
             ST&#40;0&#41; = &#38;PL_sv_undef;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;30&nbsp;15:08:45&nbsp;2008</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> bug-threads-shared [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH - revised] [rt.cpan.org #37149] shared hashes fail to preserve utf-8ness of keys</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 30 Jun 2008 15:07:20 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> pp &lt;perl5-porters [...] perl.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jerry D. Hedden&#34; &lt;jdhedden [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Jerry D. Hedden wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The attached patch fixes the subject bug.  It also adds a
&gt; new file to the test suite.
&gt;
&gt; In addition, t/wait.t and t/waithires.t have been modified
&gt; to use the new watchdog&#40;&#41; function that was added to
&gt; test.pl.
</div>
JGMYERS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Testing the patched threads::shared as a standalone module
&gt; compiling with perl 5.8.8, I get failures running the test
&gt; harness:
&gt; t/av_refs........Can&#39;t load
&gt; &#39;/u/jgmyers/src/threads-shared-1.23/blib/arch/auto/threads/shared/shared.so&#39;
&gt; for module threads::shared:
&gt; /u/jgmyers/src/threads-shared-1.23/blib/arch/auto/threads/shared/shared.so:
&gt; undefined symbol: DPPP_my_newSVpvn_flags at
&gt; /u/jgmyers/perl/lib/5.8.8/i686-linux-thread-multi/DynaLoader.pm line 230.
&gt;  at t/av_refs.t line 38
</div>
Sorry.  Forgot to run ppport.  Revised patch adds:
  #define NEED_newSVpvn_flags
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;30&nbsp;15:11:34&nbsp;2008</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #37149] shared hashes fail to preserve utf-8ness of keys</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 30 Jun 2008 15:09:40 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-threads-shared [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jerry D. Hedden&#34; &lt;jdhedden [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">JGMYERS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       Queue: threads-shared
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=37149">http://rt.cpan.org/Ticket/Display.html?id=37149</a></span> &gt;
&gt;
&gt; Testing the patched threads::shared as a standalone module compiling
&gt; with perl 5.8.8, I get failures running the test harness:
&gt;
&gt; t/wait...........Can&#39;t locate ./t/test.pl in @INC &#40;@INC contains:
&gt; /u/jgmyers/src/threads-shared-1.23/blib/lib
&gt; /u/jgmyers/src/threads-shared-1.23/blib/arch
&gt; /u/jgmyers/perl/lib/5.8.8/i686-linux-thread-multi
&gt; /u/jgmyers/perl/lib/5.8.8
&gt; /u/jgmyers/perl/lib/site_perl/5.8.8/i686-linux-thread-multi
&gt; /u/jgmyers/perl/lib/site_perl/5.8.8 /u/jgmyers/perl/lib/site_perl .&#41; at
&gt; t/wait.t line 10.
&gt; BEGIN failed--compilation aborted at t/wait.t line 16.
&gt; t/wait...........dubious
</div>
You need an updated version of test.pl in the t/ dir to test with the
blead patch.  See attached.
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;02&nbsp;19:58:21&nbsp;2008</span>
    <span class="description">JGMYERS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">With those extra bits, I&#39;m now able to pass the tests.

I still think that copying the utf8 flag into the shared hash is a
better approach than always upgrading the key, as the added side effect
of upgrading strings can cause astonishing behavior.  Unfortunately, my
proposed patch fails the tests for enumerating the code ref key and I am
unable to puzzle out what the issue is.  Any clues as to the source of
the code ref problem would be appreciated.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;02&nbsp;20:26:41&nbsp;2008</span>
    <span class="description">JGMYERS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ok, found my problem.  Darn type-unsafe accessor macros.  Your utf8.t
test case doesn&#39;t report failures with &#34;each&#34; very well.

Attached find my updated alternate proposal for shared.xs which copies
the utf8 flag into the shared hash instead of always upgrading the key.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- threads-shared-1.23/shared.xs	2008-05-13 14:35:45.000000000 -0700
+++ threads-shared-1.23-copyflag/shared.xs	2008-07-02 17:23:05.000000000 -0700
@@ -123,6 +123,7 @@
 #  define NEED_sv_2pv_flags
 #  define NEED_vnewSVpvf
 #  define NEED_warner
+#  define NEED_newSVpvn_flags
 #  include &#34;ppport.h&#34;
 #  include &#34;shared.h&#34;
 #endif
@@ -876,6 +877,8 @@
         assert &#40; mg-&gt;mg_ptr != 0 &#41;;
         if &#40;mg-&gt;mg_len == HEf_SVKEY&#41; {
            key = SvPV&#40;&#40;SV *&#41; mg-&gt;mg_ptr, len&#41;;
+	   if &#40;SvUTF8&#40;&#40;SV *&#41; mg-&gt;mg_ptr&#41;&#41;
+	      len = -len;
         }
         SHARED_CONTEXT;
         svp = hv_fetch&#40;&#40;HV*&#41; saggregate, key, len, 0&#41;;
@@ -925,8 +928,11 @@
         char *key = mg-&gt;mg_ptr;
         STRLEN len = mg-&gt;mg_len;
         assert &#40; mg-&gt;mg_ptr != 0 &#41;;
-        if &#40;mg-&gt;mg_len == HEf_SVKEY&#41;
+        if &#40;mg-&gt;mg_len == HEf_SVKEY&#41; {
            key = SvPV&#40;&#40;SV *&#41; mg-&gt;mg_ptr, len&#41;;
+	   if &#40;SvUTF8&#40;&#40;SV *&#41; mg-&gt;mg_ptr&#41;&#41;
+	      len = -len;
+	}
         SHARED_CONTEXT;
         svp = hv_fetch&#40;&#40;HV*&#41; saggregate, key, len, 1&#41;;
     }
@@ -956,8 +962,11 @@
         char *key = mg-&gt;mg_ptr;
         STRLEN len = mg-&gt;mg_len;
         assert &#40; mg-&gt;mg_ptr != 0 &#41;;
-        if &#40;mg-&gt;mg_len == HEf_SVKEY&#41;
+        if &#40;mg-&gt;mg_len == HEf_SVKEY&#41; {
            key = SvPV&#40;&#40;SV *&#41; mg-&gt;mg_ptr, len&#41;;
+	   if &#40;SvUTF8&#40;&#40;SV *&#41; mg-&gt;mg_ptr&#41;&#41;
+	      len = -len;
+        }
         SHARED_CONTEXT;
         hv_delete&#40;&#40;HV*&#41; saggregate, key, len, G_DISCARD&#41;;
     }
@@ -1276,6 +1285,8 @@
         } else {
             STRLEN len;
             char *key = SvPV&#40;index,len&#41;;
+	    if &#40;SvUTF8&#40;index&#41;&#41;
+	       len = -len;
             SHARED_EDIT;
             exists = hv_exists&#40;&#40;HV*&#41; sobj, key, len&#41;;
         }
@@ -1297,9 +1308,10 @@
         hv_iterinit&#40;&#40;HV*&#41; sobj&#41;;
         entry = hv_iternext&#40;&#40;HV*&#41; sobj&#41;;
         if &#40;entry&#41; {
+            I32 utf8 = HeKUTF8&#40;entry&#41;;
             key = hv_iterkey&#40;entry,&#38;len&#41;;
             CALLER_CONTEXT;
-            ST&#40;0&#41; = sv_2mortal&#40;newSVpv&#40;key, len&#41;&#41;;
+            ST&#40;0&#41; = sv_2mortal&#40;newSVpvn_utf8&#40;key, len, utf8&#41;&#41;;
         } else {
             CALLER_CONTEXT;
             ST&#40;0&#41; = &#38;PL_sv_undef;
@@ -1323,9 +1335,10 @@
         SHARED_CONTEXT;
         entry = hv_iternext&#40;&#40;HV*&#41; sobj&#41;;
         if &#40;entry&#41; {
+            I32 utf8 = HeKUTF8&#40;entry&#41;;
             key = hv_iterkey&#40;entry,&#38;len&#41;;
             CALLER_CONTEXT;
-            ST&#40;0&#41; = sv_2mortal&#40;newSVpv&#40;key, len&#41;&#41;;
+            ST&#40;0&#41; = sv_2mortal&#40;newSVpvn_utf8&#40;key, len, utf8&#41;&#41;;
         } else {
             CALLER_CONTEXT;
             ST&#40;0&#41; = &#38;PL_sv_undef;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;03&nbsp;22:01:13&nbsp;2008</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #37149] shared hashes fail to preserve utf-8ness of keys</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 3 Jul 2008 10:26:47 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-threads-shared [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jerry D. Hedden&#34; &lt;jdhedden [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Jul 2, 2008 at 8:26 PM, JGMYERS via RT
&lt;bug-threads-shared@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       Queue: threads-shared
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=37149">http://rt.cpan.org/Ticket/Display.html?id=37149</a></span> &gt;
&gt;
&gt; Ok, found my problem.  Darn type-unsafe accessor macros.  Your utf8.t
&gt; test case doesn&#39;t report failures with &#34;each&#34; very well.
&gt;
&gt; Attached find my updated alternate proposal for shared.xs which copies
&gt; the utf8 flag into the shared hash instead of always upgrading the key.
</div>
Thanks.  Patch applied and I made some upgrades to t/utf8.t.  Update
sent to blead perl.  When that&#39;s applied, I&#39;ll release to CPAN.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;08&nbsp;09:36:20&nbsp;2008</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #37149] shared hashes fail to preserve utf-8ness of keys</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 8 Jul 2008 08:34:03 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-threads-shared [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jerry D. Hedden&#34; &lt;jdhedden [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Attached find my updated alternate proposal for shared.xs which copies
&gt; the utf8 flag into the shared hash instead of always upgrading the key.
</div>
Patch applied to blead.  Smoke tests are reporting the following:

Compiler messages&#40;MSWin32&#41;:
shared.xs&#40;881&#41; : warning C4146: unary minus operator applied to
unsigned type, result still unsigned
shared.xs&#40;935&#41; : warning C4146: unary minus operator applied to
unsigned type, result still unsigned
shared.xs&#40;970&#41; : warning C4146: unary minus operator applied to
unsigned type, result still unsigned
shared.xs&#40;1292&#41; : warning C4146: unary minus operator applied to
unsigned type, result still unsigned

These come from the following constructs:

            if &#40;SvUTF8&#40;&#40;SV *&#41;mg-&gt;mg_ptr&#41;&#41; {
                len = -len;
            }

Is this an issue?  If it&#39;s completely harmless, is there a construct
that will suppress the warnings?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;08&nbsp;09:55:43&nbsp;2008</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #37149] shared hashes fail to preserve utf-8ness of keys</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 8 Jul 2008 08:34:03 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-threads-shared [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jerry D. Hedden&#34; &lt;jdhedden [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Attached find my updated alternate proposal for shared.xs which copies
&gt; the utf8 flag into the shared hash instead of always upgrading the key.
</div>
Patch applied to blead.  Smoke tests are reporting the following:

Compiler messages&#40;MSWin32&#41;:
shared.xs&#40;881&#41; : warning C4146: unary minus operator applied to
unsigned type, result still unsigned
shared.xs&#40;935&#41; : warning C4146: unary minus operator applied to
unsigned type, result still unsigned
shared.xs&#40;970&#41; : warning C4146: unary minus operator applied to
unsigned type, result still unsigned
shared.xs&#40;1292&#41; : warning C4146: unary minus operator applied to
unsigned type, result still unsigned

These come from the following constructs:

            if &#40;SvUTF8&#40;&#40;SV *&#41;mg-&gt;mg_ptr&#41;&#41; {
                len = -len;
            }

Is this an issue?  If it&#39;s completely harmless, is there a construct
that will suppress the warnings?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;08&nbsp;12:27:58&nbsp;2008</span>
    <span class="description">JGMYERS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The best way to suppress the warning would probably be to change the
type of len to be I32.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;15&nbsp;05:49:08&nbsp;2008</span>
    <span class="description">jdhedden [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;15&nbsp;05:49:10&nbsp;2008</span>
    <span class="description">jdhedden [...] cpan.org -  Fixed in 1.24 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
