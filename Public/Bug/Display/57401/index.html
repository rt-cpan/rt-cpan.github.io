<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #57401 for Finance-Quote: FinanceCanada.pm module</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #57401 for Finance-Quote: FinanceCanada.pm module</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Finance-Quote/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Finance-Quote/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Finance-Quote/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Finance-Quote/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Finance-Quote">Finance-Quote CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">57401</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Finance-Quote/Active/">Finance-Quote</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
paul.polak [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-13576-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.17    </td>
  </tr>
  <tr id="CF-13577-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;11&nbsp;20:56:07&nbsp;2010</span>
    <span class="description">paul.polak [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FinanceCanada.pm module</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The FinanceCanada module was broken since canada.finance.com changed its
website for financial information.  The new module now uses
www.financialpost.com, and can retrieve quotes for both stocks and
mutual funds.

The module can retrieve information from multiple exchanges &#40;TOR, NYSE,
etc.&#41; and because symbols are not unique among different exchanges, it
is worthwhile to check the stock symbol / ID on the financialpost.com
site before using the module to ensure correct information is retrieved.

Attached is the updated F::Q module and a testing module.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FinanceCanada.pm</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w
#
# FinanceCanada.pm
#
# Version 0.1 Initial version
#
# Version 0.2 Rewrite by David Hampton &lt;hampton@employees.org&gt; for
# changed web site.
#
# Version 0.3 Rewrite by linux_slacker &lt;paul.polak[AT]gmail[DOT]com&gt; for
# changed web site

package Finance::Quote::FinanceCanada;
require 5.004;

use strict;

use LWP::UserAgent;
use HTTP::Request::Common;
use HTML::TokeParser::Simple;


my $VERSION = &#39;0.3&#39;;
my $FINANCECANADA_MAINURL = &#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.financialpost.com/">http://www.financialpost.com/</a></span>&#34;&#41;;
my $FINANCECANADA_STOCKSYM_URL = &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://idms.financialpost.com/stocks/company_overview.idms?SYMBOL=">http://idms.financialpost.com/stocks/company_overview.idms?SYMBOL=</a></span>&#34;;
my $FINANCECANADA_STOCKID_URL = &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://idms.financialpost.com/stocks/company_overview.idms?ID_NOTATION=">http://idms.financialpost.com/stocks/company_overview.idms?ID_NOTATION=</a></span>&#34;;
my $FINANCECANADA_FUND_URL = &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://idms.financialpost.com/funds/snapshot.idms?FUND_KEY=">http://idms.financialpost.com/funds/snapshot.idms?FUND_KEY=</a></span>&#34;;

sub methods {
    return &#40;canada =&gt; \&#38;financecanada,
            financecanada =&gt; \&#38;financecanada&#41;;
}


sub labels {
    my @labels = qw/method source name symbol currency last date isodate nav price/;
    return &#40;canada =&gt; \@labels,
            financecanada =&gt; \@labels&#41;;
}


sub financecanada {
    my $quoter = shift;
    my @symbols = @_;
    my %info;

    return unless @symbols;

    my $ua = $quoter-&gt;user_agent;

    foreach my $symbol &#40;@symbols&#41; {
        $info{$symbol, &#34;success&#34;} = 0;
        $info{$symbol, &#34;symbol&#34;} = $symbol;
        $info{$symbol, &#34;method&#34;} = &#34;financecanada&#34;;
        $info{$symbol, &#34;source&#34;} = $FINANCECANADA_MAINURL;

        my @sites;

        # Figure out which URLs we should use
        if &#40;$symbol =~ /^[A-Za-z]/&#41; {
            @sites = &#40;$FINANCECANADA_STOCKSYM_URL&#41;;
        }
        else {
            @sites = &#40;$symbol =~ /^\d{5}$/&#41;
                ? &#40;$FINANCECANADA_FUND_URL, $FINANCECANADA_STOCKID_URL&#41;
                : &#40;$FINANCECANADA_STOCKID_URL, $FINANCECANADA_FUND_URL&#41;;
        }

        foreach my $root &#40;@sites&#41; {
            my $url = $root.$symbol;

            my $response = $ua-&gt;request&#40;GET $url&#41;;

            if &#40;!$response-&gt;is_success&#41; {
                $info{$symbol, &#34;errormsg&#34;} = &#34;Error contacting URL&#34;;
                next;
            }

            my $parser = HTML::TokeParser::Simple-&gt;new&#40;string =&gt; $response-&gt;content&#41;;
            my %ret = &#40;$root eq $FINANCECANADA_FUND_URL&#41;
                ? ParseFund&#40;\$parser&#41; : ParseStock&#40;\$parser&#41;;

            for my $key &#40;keys %ret&#41; {
                $info{$symbol, $key} = $ret{$key};
            }

            last if &#40;$info{$symbol, &#34;success&#34;}&#41;;
        }

		if &#40;$info{$symbol, &#34;success&#34;} == 1&#41; {

		    if &#40;!defined&#40;$info{$symbol, &#34;currency&#34;}&#41;&#41; {
		        $info{$symbol, &#34;currency&#34;} = &#34;CAD&#34;;
		    }

		    # Use current day at GMT time, since no date given with quote
		    my &#40;$day, $month, $year&#41; = getGMTDate&#40;&#41;;
		    $quoter-&gt;store_date&#40;\%info, $symbol,
		        {month =&gt; $month, day =&gt; $day, year =&gt; $year}&#41;;

            $info{$symbol, &#34;timezone&#34;} = &#34;GMT&#34;;

		    foreach &#40;keys %info&#41; {
		        $info{$_} =~ s/\$//;
		    }

		    if &#40;defined&#40;$info{$symbol, &#34;high&#34;}&#41; &#38;&#38; defined&#40;$info{$symbol, &#34;low&#34;}&#41;&#41; {
		        $info{$symbol, &#34;day_range&#34;} = $info{$symbol, &#34;low&#34;} . &#34; - &#34; . $info{$symbol, &#34;high&#34;};
		    }

		    if &#40;defined&#40;$info{$symbol, &#34;year_high&#34;}&#41; &#38;&#38; defined&#40;$info{$symbol, &#34;year_low&#34;}&#41;&#41; {
		        $info{$symbol, &#34;year_range&#34;} = $info{$symbol, &#34;year_low&#34;}.&#34; - &#34;.$info{$symbol, &#34;year_high&#34;};
		    }
		}
		else {
		    $info{$symbol, &#34;errormsg&#34;} = &#34;Cannot parse quote data&#34;;
		}
	}

	return wantarray&#40;&#41; ? %info : \%info;
}

sub ParseStock&#40;$&#41; {
    my $ref = shift;
    my $parser = $$ref;

    my %info;

    while &#40;my $div = $parser-&gt;get_tag&#40;&#39;div&#39;&#41;&#41; {
        my $id = $div-&gt;get_attr&#40;&#39;id&#39;&#41;;

        if &#40;$id eq &#34;IDMScontainer&#34;&#41; {
            my $header = $parser-&gt;get_tag&#40;&#39;h2&#39;&#41;;
            my $name = trim&#40;$parser-&gt;get_trimmed_text&#40;&#39;/h2&#39;&#41;&#41;;

            $name =~ s/&#38;nbsp;//g;

            # Should have at least 1 alphabetic character...
            last unless &#40;$name =~ /[A-Za-z]/&#41;;

            $info{&#34;name&#34;} = $name;
        }
        elsif &#40;$id eq &#34;fundProfile&#34;&#41; {
            for &#40;my $i=0; $i&lt;6; $i++&#41; {
                my $span = $parser-&gt;get_tag&#40;&#39;span&#39;&#41;;
                my $class = $span-&gt;get_attr&#40;&#39;class&#39;&#41;;

                if &#40;$class eq &#34;price&#34;&#41; {
                    my $price = removedollar&#40;$parser-&gt;get_trimmed_text&#40;&#39;/span&#39;&#41;&#41;;

                    last unless &#40;$price =~ /^\d/&#41;;

                    $info{&#34;price&#34;} = $price;
                    $info{&#34;success&#34;} = 1;
                }
                elsif &#40;&#40;$class eq &#34;positive&#34;&#41; || &#40;$class eq &#34;negative&#34;&#41;&#41; {
                    my $raw = $parser-&gt;get_trimmed_text&#40;&#39;/span&#39;&#41;;
                    $raw =~ /^&#40;\-&#41;?\$&#40;&#40;\d&#41;+&#40;\.\d\d&#41;&#41;/;
                    $info{&#34;net&#34;} = $1.$2;
                }
                elsif &#40;$class eq &#34;high&#34;&#41; {
                    $info{&#34;high&#34;} = removedollar&#40;$parser-&gt;get_trimmed_text&#40;&#39;/span&#39;&#41;&#41;;
                }
                elsif &#40;$class eq &#34;low&#34;&#41; {
                    $info{&#34;low&#34;} = removedollar&#40;$parser-&gt;get_trimmed_text&#40;&#39;/span&#39;&#41;&#41;;
                }
                elsif &#40;$class eq &#34;volume&#34;&#41; {
                    $info{&#34;volume&#34;} = $parser-&gt;get_trimmed_text&#40;&#39;/span&#39;&#41;;
                }
            }
        }
        elsif &#40;$id eq &#34;quoteDetail&#34;&#41; {
            for &#40;my $i=0; $i&lt;18; $i++&#41; {
                my $th = $parser-&gt;get_tag&#40;&#39;th&#39;&#41;;

                if &#40;$i == 3&#41; {
                    $info{&#34;year_high&#34;} = removedollar&#40;$parser-&gt;get_trimmed_text&#40;&#39;th&#39;&#41;&#41;;
                }
                elsif &#40;$i == 5&#41; {
                    $info{&#34;cap&#34;} = removedollar&#40;$parser-&gt;get_trimmed_text&#40;&#39;th&#39;&#41;&#41;;
                }
                elsif &#40;$i == 9&#41; {
                    $info{&#34;year_low&#34;} = removedollar&#40;$parser-&gt;get_trimmed_text&#40;&#39;th&#39;&#41;&#41;;
                }
                elsif &#40;$i == 15&#41; {
                    $info{&#34;exchange&#34;} = $parser-&gt;get_trimmed_text&#40;&#39;th&#39;&#41;;
                }
            }
        }
    }

    return %info;
}

sub ParseFund&#40;$&#41; {
    my $ref = shift;
    my $parser = $$ref;

    my %info;

    my $idmscount = 0;

    while &#40;my $div = $parser-&gt;get_tag&#40;&#39;div&#39;&#41;&#41; {
        my $id = $div-&gt;get_attr&#40;&#39;id&#39;&#41;;

        if &#40;$id eq &#34;IDMScontainer&#34;&#41; {
            $idmscount++;

            if &#40;$idmscount == 1&#41; {
                my $header = $parser-&gt;get_tag&#40;&#39;h2&#39;&#41;;
                my $name = trim&#40;$parser-&gt;get_trimmed_text&#40;&#39;/h2&#39;&#41;&#41;;

                $name =~ s/&#38;nbsp;//g;

                # Should have at least 1 alphabetic character...
                last unless &#40;$name =~ /[A-Za-z]/&#41;;

                $info{&#34;name&#34;} = $name;
            }
            else {
                while &#40;my $tr = $parser-&gt;get_tag&#40;&#39;tr&#39;&#41;&#41; {
                    my $tdcount = 0;

                    while &#40;my $td = $parser-&gt;get_tag&#40;&#39;td&#39;&#41;&#41; {
                        $tdcount++;

                        if &#40;$tdcount == 1&#41; {
                            my $price = removedollar&#40;$parser-&gt;get_trimmed_text&#40;&#39;/td&#39;&#41;&#41;;

                            last unless &#40;$price =~ /^\d/&#41;;

                            $info{&#34;nav&#34;} = $price;
                            $info{&#34;success&#34;} = 1;
                        }
                        elsif &#40;$tdcount == 2&#41; {
                            $info{&#34;net&#34;} =
                                removedollar&#40;$parser-&gt;get_trimmed_text&#40;&#39;/span&#39;&#41;&#41;;
                        }
                        elsif &#40;$tdcount == 7&#41; {
                            $info{&#34;currency&#34;} =
                                $parser-&gt;get_trimmed_text&#40;&#39;/td&#39;&#41;;
                        }
                    }
                }
            }
        }
    }

    return %info;
}

sub getGMTDate&#40;&#41; {
    my @timeData = gmtime&#40;time&#41;;
    my $day = $timeData[3];
    my $month = 1 + $timeData[4];
    my $year = 1900 + $timeData[5];

    return &#40;$day, $month, $year&#41;;
}

sub trim&#40;$&#41; {
    my $string = shift;
    $string =~ s/^\s+//;
    $string =~ s/\s+$//;
    return $string;
}

sub removedollar&#40;$&#41; {
    my $raw = shift;
    $raw =~ /^\$?&#40;.*&#41;$/;
    return $1;
}


1;

=head1 NAME

Finance::Quote::FinanceCanada - Obtain stock and fund prices
from www.financialpost.com

=head1 SYNOPSIS

    use Finance::Quote;

    $q = Finance::Quote-&gt;new;

    # Can failover to other methods
    %quotes = $q-&gt;fetch&#40;&#34;canada&#34;, &#34;stock_code&#34;&#41;;

    # Use this module only
    %quotes = $q-&gt;fetch&#40;&#34;financecanada&#34;, &#34;stock_code&#34;&#41;;

=head1 DESCRIPTION

This module obtains information about Canadian stocks and funds from
www.financialpost.com.  The information source &#34;canada&#34; can be used if the
information source is unimportant, or &#34;financecanada&#34; to specifically use
www.financialpost.com.

=head1 STOCK_CODE

Canadian stocks/mutual funds do not have a unique symbol identifier on
www.financialpost.com.  For example, the symbol &#34;T&#34; can refer to stock
quotes from either &#34;Telus&#34; on the Toronto Stock Exchange &#40;TOR&#41; or
&#34;AT&#38;T Inc.&#34; on NYSE.  The simplest way to fetch the ID for a particular
stock/fund is to go to www.financialpost.com, search for your
particular stock/fund, and note the symbol &#39;id&#39; in the site URL.

Note that www.financialpost.com uses different URLs for stocks and funds.
This module attempts to guess which URL to use based regular expressions tests
on the symbol.

=head1 LABELS RETURNED

Information available from financecanada may include the following labels:

method source name symbol currency date nav last price

=head1 SEE ALSO

Finance Canada.com website - <span class="clickylink"><a target="new" rel="nofollow" href="http://www.financialpost.com/">http://www.financialpost.com/</a></span>

Finance::Quote

=cut
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FinanceCanada.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use Test;
use Data::Dumper;

BEGIN {plan tests =&gt; 22};

use Finance::Quote;

# Test FinanceCanada functions

my $q = Finance::Quote-&gt;new&#40;&#41;;
my @stocks = &#40;&#34;RY&#34;, &#34;T&#34;, &#34;15213&#34;, &#34;283808&#34;&#41;;

my %regexps = &#40;
    RY  =&gt; qr/\bROYAL\b/,
    T   =&gt; qr/\bAT\&#38;T\b/,
    15213   =&gt; qr/\bTD Canadian Index\b/,
    283808  =&gt; qr/\bSPRINT\b/,
&#41;;

my %quotes = $q-&gt;fetch&#40;&#34;financecanada&#34;, @stocks&#41;;
ok&#40;%quotes&#41;;

foreach my $stock &#40;@stocks&#41; {
	my $name = $quotes{$stock, &#34;name&#34;};
	print &#34;#Testing $stock: $name\n&#34;;

	my $regexp = $regexps{$stock};
	ok&#40;$name =~ /$regexp/i&#41;;

	ok&#40;$quotes{$stock, &#34;method&#34;} eq &#39;financecanada&#39;&#41;;

	ok&#40;&#40;$quotes{$stock, &#34;price&#34;} &gt; 0&#41; || &#40;$quotes{$stock, &#34;nav&#34;} &gt; 0&#41;&#41;;
	ok&#40;$quotes{$stock, &#34;net&#34;} =~ /^-?\d+\.\d+$/&#41;;
	ok&#40;$quotes{$stock, &#34;success&#34;}&#41;;
}

# Check that a bogus stock returns no-success.
%quotes = $q-&gt;fetch&#40;&#34;financecanada&#34;, &#34;BOGUS&#34;&#41;;
ok&#40;! $quotes{&#34;BOGUS&#34;, &#34;success&#34;}&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;12&nbsp;22:21:32&nbsp;2011</span>
    <span class="description">https://www.google.com/accounts/o8/id?id=AItOawm70Jm3D-8EAxPOoO2d_clsRNkCl8RxWKc -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> linux_slacker</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is a patch for the FinanceCanada.pm module.  It removes the
extraneous lookups for alphabetic symbols, since these don&#39;t seem to
work anymore.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FinanceCanada.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- /usr/lib64/perl5/vendor_perl/5.12.4/Finance/Quote/FinanceCanada.pm	2011-10-12 21:46:23.322668653 -0400
+++ FinanceCanada.pm	2011-10-12 22:04:20.113131565 -0400
@@ -22,7 +22,6 @@
 
 my $VERSION = &#39;0.3&#39;;
 my $FINANCECANADA_MAINURL = &#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.financialpost.com/">http://www.financialpost.com/</a></span>&#34;&#41;;
-my $FINANCECANADA_STOCKSYM_URL = &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://idms.financialpost.com/stocks/company_overview.idms?SYMBOL=">http://idms.financialpost.com/stocks/company_overview.idms?SYMBOL=</a></span>&#34;;
 my $FINANCECANADA_STOCKID_URL = &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://idms.financialpost.com/stocks/company_overview.idms?ID_NOTATION=">http://idms.financialpost.com/stocks/company_overview.idms?ID_NOTATION=</a></span>&#34;;
 my $FINANCECANADA_FUND_URL = &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://idms.financialpost.com/funds/snapshot.idms?FUND_KEY=">http://idms.financialpost.com/funds/snapshot.idms?FUND_KEY=</a></span>&#34;;
 
@@ -57,14 +56,9 @@
         my @sites;
 
         # Figure out which URLs we should use
-        if &#40;$symbol =~ /^[A-Za-z]/&#41; {
-            @sites = &#40;$FINANCECANADA_STOCKSYM_URL&#41;;
-        }
-        else {
-            @sites = &#40;$symbol =~ /^\d{5}$/&#41;
-                ? &#40;$FINANCECANADA_FUND_URL, $FINANCECANADA_STOCKID_URL&#41;
-                : &#40;$FINANCECANADA_STOCKID_URL, $FINANCECANADA_FUND_URL&#41;;
-        }
+        @sites = &#40;$symbol =~ /^\d{5}$/&#41;
+            ? &#40;$FINANCECANADA_FUND_URL, $FINANCECANADA_STOCKID_URL&#41;
+            : &#40;$FINANCECANADA_STOCKID_URL, $FINANCECANADA_FUND_URL&#41;;
 
         foreach my $root &#40;@sites&#41; {
             my $url = $root.$symbol;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;12&nbsp;22:21:34&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
