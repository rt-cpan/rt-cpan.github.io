<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #79289 for Perl-Critic: False Postive in Perl::Critic::Utils::is_in_void_context&#40;&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #79289 for Perl-Critic: False Postive in Perl::Critic::Utils::is_in_void_context&#40;&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Perl-Critic/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Perl-Critic/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Perl-Critic/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Perl-Critic/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/Perl-Critic/Perl-Critic/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Perl-Critic">Perl-Critic CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">79289</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">patched</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Perl-Critic/Active/">Perl-Critic</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cpan.wade [...] anomaly.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-25198-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.110_001    </td>
  </tr>
  <tr id="CF-25199-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;29&nbsp;14:01:19&nbsp;2012</span>
    <span class="description">cpan.wade [...] anomaly.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> False Postive in Perl::Critic::Utils::is_in_void_context&#40;&#41;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The is_in_void_context&#40;&#41; method returns true when called in a subscript.

This means that BuiltinFunctions::ProhibitVoidGrep generates a false positive for hash slices 
generated with grep.

It looks like the code needs a


        return if $parent-&gt;isa&#40;&#39;PPI::Structure::Subscript&#39;&#41;;

in the group of tests.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;30&nbsp;15:32:04&nbsp;2012</span>
    <span class="description">wyant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Aug 29 14:01:19 2012, GWADEJ wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The is_in_void_context&#40;&#41; method returns true when called in a
&gt; subscript.
&gt; 
&gt; This means that BuiltinFunctions::ProhibitVoidGrep generates a false
&gt; positive for hash slices
&gt; generated with grep.
&gt; 
&gt; It looks like the code needs a
&gt; 
&gt; 
&gt;         return if $parent-&gt;isa&#40;&#39;PPI::Structure::Subscript&#39;&#41;;
&gt; 
&gt; in the group of tests.
</div>
Thank you for your report, and your work to diagnose it.

Can you provide a piece of failing code to include in the test suite? I
tried

    my %hash;
    my @array;

    @hash{ grep { $_ % 2 } 0 .. 9 } = 0 .. 4;
    @array[ grep { $_ % 2 } 0 .. 9 ] = 0 .. 4;

but none of the greps fails the policy.

This is because the policy executes

    return if not is_function_call&#40;$elem&#41;;

and returns before the call to is_in_void_context&#40;&#41; is executed. And
is_in_function_call&#40;&#41; returns because of the PPI::Structure::Subscript.

Thanks,
Tom
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;30&nbsp;15:32:05&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;31&nbsp;13:16:24&nbsp;2012</span>
    <span class="description">cpan.wade [...] anomaly.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Aug 30 15:32:04 2012, WYANT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Aug 29 14:01:19 2012, GWADEJ wrote:
<div class="message-stanza open">&gt; &gt; The is_in_void_context&#40;&#41; method returns true when called in a
&gt; &gt; subscript.
&gt; &gt; 
&gt; &gt; This means that BuiltinFunctions::ProhibitVoidGrep generates a false
&gt; &gt; positive for hash slices
&gt; &gt; generated with grep.
&gt; &gt; 
&gt; &gt; It looks like the code needs a
&gt; &gt; 
&gt; &gt; 
&gt; &gt;         return if $parent-&gt;isa&#40;&#39;PPI::Structure::Subscript&#39;&#41;;
&gt; &gt; 
&gt; &gt; in the group of tests.
</div>&gt; 
&gt; Thank you for your report, and your work to diagnose it.
&gt; 
&gt; Can you provide a piece of failing code to include in the test suite? I
&gt; tried
&gt; 
&gt;     my %hash;
&gt;     my @array;
&gt; 
&gt;     @hash{ grep { $_ % 2 } 0 .. 9 } = 0 .. 4;
&gt;     @array[ grep { $_ % 2 } 0 .. 9 ] = 0 .. 4;
&gt; 
&gt; but none of the greps fails the policy.
&gt; 
&gt; This is because the policy executes
&gt; 
&gt;     return if not is_function_call&#40;$elem&#41;;
&gt; 
&gt; and returns before the call to is_in_void_context&#40;&#41; is executed. And
&gt; is_in_function_call&#40;&#41; returns because of the PPI::Structure::Subscript.
</div>
I apologize for not sending a specific example. I didn&#39;t realize what a special edge case this 
was.

I generated a minimal example. Running

   perlcritic --include Void grep_void.pl

results in the message:

&#34;grep&#34; used in void context at line 7, column 18.  Use a &#34;for&#34; loop instead.  &#40;Severity: 3&#41;

As near as I can tell, it does not misbehave when using the block form of grep. When using 
the expression form, it only fails if I include the parens.

Thanks for all of your work on this.
G. Wade
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> grep_void.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl                                                                                                                                  
                                                                                                                                                   
use strict;                                                                                                                                      
use warnings;                                                                                                                                    
                                                                                                                                                
my %domains;                                                                                                                                     
delete @domains{ grep &#40; /\.cc$/, keys %domains &#41; };  
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;02&nbsp;17:20:44&nbsp;2012</span>
    <span class="description">wyant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you very much for the failing code.

Your correction has been committed as SVN revision 4153.

What follows is cut-and-pasted from the commit message.

The ticket is really about BuiltinFunctions::ProhibitVoidGrep, but the
requester&#39;s diagnosis of the point of failure and the nature of the
correction was correct. This revision applies the requester&#39;s
correction, and adds tests to ProhibitVoidGrep.run and
ProhibitVoidMap.run, since the latter policy had the same problem.

The thing is, it appears to me that most uses of grep and map in slice
subscripts were passing for the wrong reason. Both policies, after
ensuring they have the PPI::Token::Word that they want, call
is_function_call&#40;&#41; on the element in question, and accept the element if
this returns false. The first thing that is_function_call&#40;&#41; does is to
call is_hash_key&#40;&#41;, returning false if is_hash_key&#40;&#41; returns true.

Well, is_hash_key&#40;&#41; is documented as detecting barewords used as hash
keys. But it returns true when handed the &#39;grep&#39; token in the following:
    @hash{ grep { /foo/ } keys %hash }
    @hash{ grep /foo/, keys %hash }
This causes the policy to declare a true negative in the above cases,
but to declare it for the wrong reason. The requester, on the other
hand, was doing
    @hash{ grep &#40; /foo/, keys %hash &#41; &#41;
which is a violation of a couple other policies, but should not be a
violation of this one. But the parens after the &#39;grep&#39; were causing
is_hash_key&#40;&#41; to fail; consequently is_function_call&#40;&#41; succeeded, so the
failure of is_in_void_context&#40;&#41; to return false when called on a token
in a subscript was exposed.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;02&nbsp;17:20:45&nbsp;2012</span>
    <span class="description">wyant [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
