<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #101962 for mod_perl: modperl_env_init&#40;&#41; needs changing for perl &gt;= 5.21.8</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #101962 for mod_perl: modperl_env_init&#40;&#41; needs changing for perl &gt;= 5.21.8</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/mod_perl/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/mod_perl/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/mod_perl/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/mod_perl/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/mod_perl">mod_perl CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">101962</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/mod_perl/Active/">mod_perl</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
shay [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
abe+cpan [...] deuxchevaux.org

<br />
dam [...] cpan.org

<br />
dom [...] cpan.org

<br />
ether [...] cpan.org

<br />
gregoa [...] cpan.org

<br />
PLICEASE [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21786-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.0.9    </td>
  </tr>
  <tr id="CF-21787-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.0.10    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;06&nbsp;03:23:10&nbsp;2015</span>
    <span class="description">shay [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> modperl_env_init&#40;&#41; needs changing for perl &gt;= 5.21.8</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The following commit causes mod_perl &#40;svn trunk&#41; to fail on startup &#40;on Windows, at least&#41; using 5.21.8:

<span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/commit/c910fead78">http://perl5.git.perl.org/perl.git/commit/c910fead78</a></span>

It works fine on the same system &#40;VC++ 2010, with httpd-2.4.10&#41; using 5.21.7. I get an access violation in modperl_env_init&#40;&#41; when trying to replace the now const PL_vtbls with its own versions:

void modperl_env_init&#40;void&#41;
{
    /* save originals */
    StructCopy&#40;&#38;PL_vtbl_env, &#38;MP_PERL_vtbl_env, MGVTBL&#41;;
    StructCopy&#40;&#38;PL_vtbl_envelem, &#38;MP_PERL_vtbl_envelem, MGVTBL&#41;;

    /* replace with our versions */
    StructCopy&#40;&#38;MP_vtbl_env, &#38;PL_vtbl_env, MGVTBL&#41;;
    StructCopy&#40;&#38;MP_vtbl_envelem, &#38;PL_vtbl_envelem, MGVTBL&#41;;
}

I reported this in

<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/Ticket/Display.html?id=123687">https://rt.perl.org/Ticket/Display.html?id=123687</a></span>

but &#40;as I suspected&#41; this was deemed to be a mod_perl problem that we need to resolve, not a bug in perl. In that ticket, Leon suggested, &#34;lookup %ENV&#39;s magic, and then replace the pointer to PL_vtbl_env with a pointer to MP_vtbl_env. You may have to add some svt_copy magic to make it cast MP_vtbl_envelem instead of PL_vtbl_envelem on the elements.&#34;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;04&nbsp;03:25:33&nbsp;2015</span>
    <span class="description">shay [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 06 03:23:10 2015, SHAY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The following commit causes mod_perl &#40;svn trunk&#41; to fail on startup
&gt; &#40;on Windows, at least&#41; using 5.21.8:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/commit/c910fead78">http://perl5.git.perl.org/perl.git/commit/c910fead78</a></span>
&gt; 
</div>
The same has also been seen elsewhere, so this is not a Windows-specific problem:

<span class="clickylink"><a target="new" rel="nofollow" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=787493">https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=787493</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;16&nbsp;18:53:16&nbsp;2015</span>
    <span class="description">ether [...] cpan.org -  Cc ETHER added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;01&nbsp;14:06:54&nbsp;2015</span>
    <span class="description">gregoa [...] cpan.org -  Cc GREGOA added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;02&nbsp;06:13:44&nbsp;2015</span>
    <span class="description">dom [...] cpan.org -  Cc DOM added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;02&nbsp;06:14:20&nbsp;2015</span>
    <span class="description">dom [...] cpan.org -  Broken in 2.0.9 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;27&nbsp;15:35:50&nbsp;2015</span>
    <span class="description">PLICEASE [...] cpan.org -  Cc PLICEASE added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;16&nbsp;06:28:06&nbsp;2015</span>
    <span class="description">dom [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jun 04 08:25:33 2015, SHAY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Feb 06 03:23:10 2015, SHAY wrote:
<div class="message-stanza open">&gt; &gt; The following commit causes mod_perl &#40;svn trunk&#41; to fail on startup
&gt; &gt; &#40;on Windows, at least&#41; using 5.21.8:
&gt; &gt;
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/commit/c910fead78">http://perl5.git.perl.org/perl.git/commit/c910fead78</a></span>
&gt; &gt;
</div>&gt; 
&gt; The same has also been seen elsewhere, so this is not a Windows-
&gt; specific problem:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=787493">https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=787493</a></span>
</div>
Hello Steve,

I wondered if you had any plans to address this? It&#39;s going to be a blocker for perl 5.22 in Debian quite soon. I&#39;m afraid I can&#39;t help myself as I don&#39;t have the necessary expertise.

Thanks,
Dominic &#40;Debian perl maintenance team&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;16&nbsp;06:28:07&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;28&nbsp;11:29:57&nbsp;2015</span>
    <span class="description">MAT [...] cpan.fsck.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Le Dim 16 Aoû 2015 12:28:06, DOM a écrit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I wondered if you had any plans to address this? It&#39;s going to be a
&gt; blocker for perl 5.22 in Debian quite soon. I&#39;m afraid I can&#39;t help
&gt; myself as I don&#39;t have the necessary expertise.
</div>
Hi,

It is also going to be a problem on FreeBSD soon, our plan was to switch the default to 5.22 Perl version in September, and switch to the new Perl release every September from now on.

Thanks,
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;31&nbsp;07:16:46&nbsp;2015</span>
    <span class="description">shay [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Aug 16 06:28:06 2015, DOM wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Jun 04 08:25:33 2015, SHAY wrote:
<div class="message-stanza open">&gt; &gt; On Fri Feb 06 03:23:10 2015, SHAY wrote:
<div class="message-stanza open">&gt; &gt; &gt; The following commit causes mod_perl &#40;svn trunk&#41; to fail on startup
&gt; &gt; &gt; &#40;on Windows, at least&#41; using 5.21.8:
&gt; &gt; &gt;
&gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/commit/c910fead78">http://perl5.git.perl.org/perl.git/commit/c910fead78</a></span>
&gt; &gt; &gt;
</div>&gt; &gt;
&gt; &gt; The same has also been seen elsewhere, so this is not a Windows-
&gt; &gt; specific problem:
&gt; &gt;
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=787493">https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=787493</a></span>
</div>&gt; 
&gt; Hello Steve,
&gt; 
&gt; I wondered if you had any plans to address this? It&#39;s going to be a
&gt; blocker for perl 5.22 in Debian quite soon. I&#39;m afraid I can&#39;t help
&gt; myself as I don&#39;t have the necessary expertise.
&gt; 
</div>
Sorry for the slow response. I&#39;m busy with a couple of Perl maint releases at the moment but I do plan to get to this next if nobody else has done it by then. I haven&#39;t looked at it very much yet, but I&#39;m hoping that the plan outlined by Leon shouldn&#39;t be too difficult to implement.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;31&nbsp;15:37:51&nbsp;2015</span>
    <span class="description">dam [...] cpan.org -  Cc DAM added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;07&nbsp;17:44:23&nbsp;2015</span>
    <span class="description">dom [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Aug 31 12:16:46 2015, SHAY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun Aug 16 06:28:06 2015, DOM wrote:
<div class="message-stanza open">&gt; &gt; On Thu Jun 04 08:25:33 2015, SHAY wrote:
<div class="message-stanza open">&gt; &gt; &gt; On Fri Feb 06 03:23:10 2015, SHAY wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; The following commit causes mod_perl &#40;svn trunk&#41; to fail on
&gt; &gt; &gt; &gt; startup
&gt; &gt; &gt; &gt; &#40;on Windows, at least&#41; using 5.21.8:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/commit/c910fead78">http://perl5.git.perl.org/perl.git/commit/c910fead78</a></span>
&gt; &gt; &gt; &gt;
</div>&gt; &gt; &gt;
&gt; &gt; &gt; The same has also been seen elsewhere, so this is not a Windows-
&gt; &gt; &gt; specific problem:
&gt; &gt; &gt;
&gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=787493">https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=787493</a></span>
</div>&gt; &gt;
&gt; &gt; Hello Steve,
&gt; &gt;
&gt; &gt; I wondered if you had any plans to address this? It&#39;s going to be a
&gt; &gt; blocker for perl 5.22 in Debian quite soon. I&#39;m afraid I can&#39;t help
&gt; &gt; myself as I don&#39;t have the necessary expertise.
&gt; &gt;
</div>&gt; 
&gt; Sorry for the slow response. I&#39;m busy with a couple of Perl maint
&gt; releases at the moment but I do plan to get to this next if nobody
&gt; else has done it by then. I haven&#39;t looked at it very much yet, but
&gt; I&#39;m hoping that the plan outlined by Leon shouldn&#39;t be too difficult
&gt; to implement.
</div>
That&#39;s great, thanks! Do shout if you need help testing.

Cheers,
Dominic.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;01&nbsp;05:35:17&nbsp;2015</span>
    <span class="description">chris [...] netpos.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #101962]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 1 Oct 2015 05:35:03 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-mod_perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Chris Kaltwasser &lt;chris [...] netpos.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

A recent post by DOM regarding the mod_perl bug report 101962 indicates
that a fix might be forth coming. I&#39;m hoping to see if I can obtain that
fix as I&#39;m a bit stuck given my attempt to use mod_perl on my Fedora 22
development environment.

I turns out I&#39;m running into the same bug reported in that bug concerning
mod_perl initialization using Fedora 22.

I have compiled my perl and apache stack in debug mode and recived a core
dump while performing the make test for mod_perl.

I also get the same core dump later when trying to start apache.

The debugger indications the failure is at the exact point discussed in
this bug report.  Indicated below.

void modperl_env_init&#40;void&#41;
{ /* save originals */
    StructCopy&#40;&#38;PL_vtbl_env, &#38;MP_PERL_vtbl_env, MGVTBL&#41;;
    StructCopy&#40;&#38;PL_vtbl_envelem, &#38;MP_PERL_vtbl_envelem, MGVTBL&#41;;

    /* replace with our versions */
--&gt;    StructCopy&#40;&#38;MP_vtbl_env, &#38;PL_vtbl_env, MGVTBL&#41;;
    StructCopy&#40;&#38;MP_vtbl_envelem, &#38;PL_vtbl_envelem, MGVTBL&#41;;
}

Any assistance with this would be greatly appreciated!!!

Thank you
-- 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">____________________________________
Chris Kaltwasser &lt;chris@netpos.com&gt;
 Chief Technical Officer
 NetPOS LLC&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://netpos.com">http://netpos.com</a></span>&gt;
     fon: 734.302.4220
     cel:  734.645.6215

<div class="message-stanza open">____________________________________
</div></div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;28&nbsp;18:49:31&nbsp;2015</span>
    <span class="description">ntyni [...] iki.fi -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ntyni [...] iki.fi</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Aug 31 07:16:46 2015, SHAY wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m hoping that the plan outlined by Leon shouldn&#39;t be too difficult to implement.
</div>
Hi, I&#39;m attaching a work in progress patch that tries to do this. I&#39;m somewhat stuck here. Comments would be appreciated, but please be gentle - I&#39;m quite out of my depth here and only learning the ropes as I go along :&#41;


Main open questions that I can see:
    
- where should modperl_env_init2&#40;&#41; be really called? It needs an  initialized Perl interpreter for ENVHV &#40;%ENV&#41;, so modperl_sys_init&#40;&#41; seems too early

- cleanup &#40;replacement for modperl_env_unload&#40;&#41;&#41; is nonexistent so far

- running t/modperl/env.t and t/modules/cgi.t in the same run makes the latter fail because $ENV{MOD_PERL} is not set

Not sure if the modperl-dev list would be a better place to discuss this?
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-First-steps-at-Perl-5.22-compatibility.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 8bbde4e27e2e38c98934f4b409ba1fb6b9ad1356 Mon Sep 17 00:00:00 2001
From: Niko Tyni &lt;ntyni@debian.org&gt;
Date: Thu, 29 Oct 2015 00:18:53 +0200
Subject: [PATCH] First steps at Perl 5.22 compatibility

As outlined by Leon Timmermans in [perl #123687]:

  lookup %ENV&#39;s magic, and then replace the pointer to PL_vtbl_env with
  a pointer to MP_vtbl_env. You may have to add some svt_copy magic to
  make it cast MP_vtbl_envelem instead of PL_vtbl_envelem on the elements.

with an added svt_local for the &#39;local %ENV&#39; tests.

This is enough to make t/modperl/env.t pass, but is probably mostly
incorrect. Main open questions:

- where should modperl_env_init2&#40;&#41; be really called? It needs an
  initialized Perl interpreter for ENVHV &#40;%ENV&#41;, so modperl_sys_init&#40;&#41;
  seems too early
- cleanup &#40;replacement for modperl_env_unload&#40;&#41;&#41; is nonexistent
- running t/modperl/env.t and t/modules/cgi.t in the same run makes
  the latter fail because $ENV{MOD_PERL} is not set

Bug: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=101962">https://rt.cpan.org/Public/Bug/Display.html?id=101962</a></span>
Bug: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/Ticket/Display.html?id=123687">https://rt.perl.org/Ticket/Display.html?id=123687</a></span>
---
 src/modules/perl/modperl_env.c | 61 ++++++++++++++++++++++++++++++++++++++++++
 src/modules/perl/modperl_env.h |  2 ++
 2 files changed, 63 insertions&#40;+&#41;

diff --git a/src/modules/perl/modperl_env.c b/src/modules/perl/modperl_env.c
index c1a276b..a912994 100644
--- a/src/modules/perl/modperl_env.c
+++ b/src/modules/perl/modperl_env.c
@@ -121,6 +121,9 @@ static void modperl_env_table_populate&#40;pTHX_ apr_table_t *table&#41;
     const apr_array_header_t *array;
     apr_table_entry_t *elts;
 
+#if MP_PERL_VERSION_AT_LEAST&#40;5, 21, 8&#41;
+    modperl_env_init2&#40;aTHX&#41;;
+#endif
     modperl_env_untie&#40;mg_flags&#41;;
 
     array = apr_table_elts&#40;table&#41;;
@@ -612,6 +615,9 @@ static int modperl_env_magic_get&#40;pTHX_ SV *sv, MAGIC *mg&#41;
 }
 #endif
 
+static int modperl_env_magic_copy&#40;pTHX_ SV *sv, MAGIC *mg, SV *nsv, const char *name, I32 namlen&#41;;
+static int modperl_env_magic_local_all&#40;pTHX_ SV *nsv, MAGIC *mg&#41;;
+
 /* override %ENV virtual tables with our own */
 static MGVTBL MP_vtbl_env = {
     0,
@@ -619,6 +625,7 @@ static MGVTBL MP_vtbl_env = {
     0,
     modperl_env_magic_clear_all,
     0
+    , modperl_env_magic_copy, 0, modperl_env_magic_local_all
 };
 
 static MGVTBL MP_vtbl_envelem = {
@@ -629,22 +636,76 @@ static MGVTBL MP_vtbl_envelem = {
     0
 };
 
+static int modperl_env_magic_copy&#40;pTHX_ SV *sv, MAGIC *mg, SV *nsv, const char *name, I32 namlen&#41;
+{
+    MAGIC *nmg = NULL;
+    sv_magic&#40;nsv, mg-&gt;mg_obj,
+                        toLOWER&#40;mg-&gt;mg_type&#41;,
+                        name, namlen&#41;;
+    nmg = mg_find&#40;nsv, toLOWER&#40;mg-&gt;mg_type&#41;&#41;;
+    if &#40;mg-&gt;mg_virtual == &#38;MP_vtbl_env&#41; {
+        MP_TRACE_d&#40;MP_FUNC, &#34;copying magic to %%ENV element&#34;&#41;;
+        nmg-&gt;mg_virtual = &#38;MP_vtbl_envelem;
+    } else {
+        MP_TRACE_d&#40;MP_FUNC, &#34;no %%ENV magic found to copy&#34;&#41;;
+    }
+    return 1;
+}
+
+static int modperl_env_magic_local_all&#40;pTHX_ SV *nsv, MAGIC *mg&#41;
+{
+    MAGIC *nmg;
+    MP_TRACE_e&#40;MP_FUNC, &#34;localizing %%ENV&#34;&#41;;
+    sv_magic&#40;nsv, mg-&gt;mg_obj,
+                        mg-&gt;mg_type,
+                        NULL, 0&#41;;
+    nmg = mg_find&#40;nsv, mg-&gt;mg_type&#41;;
+    nmg-&gt;mg_ptr = mg-&gt;mg_ptr;
+    if &#40;mg-&gt;mg_virtual == &#38;MP_vtbl_env&#41; {
+        nmg-&gt;mg_virtual = &#38;MP_vtbl_env;
+        nmg-&gt;mg_flags |= MGf_COPY;
+        nmg-&gt;mg_flags |= MGf_LOCAL;
+    } else {
+        MP_TRACE_d&#40;MP_FUNC, &#34;no %%ENV magic found to localize&#34;&#41;;
+     }
+     return 1;
+}
+
 void modperl_env_init&#40;void&#41;
 {
     /* save originals */
     StructCopy&#40;&#38;PL_vtbl_env, &#38;MP_PERL_vtbl_env, MGVTBL&#41;;
     StructCopy&#40;&#38;PL_vtbl_envelem, &#38;MP_PERL_vtbl_envelem, MGVTBL&#41;;
 
+#if MP_PERL_VERSION_AT_MOST&#40;5, 21, 7&#41;
     /* replace with our versions */
     StructCopy&#40;&#38;MP_vtbl_env, &#38;PL_vtbl_env, MGVTBL&#41;;
     StructCopy&#40;&#38;MP_vtbl_envelem, &#38;PL_vtbl_envelem, MGVTBL&#41;;
+#endif
+}
+
+void modperl_env_init2&#40;pTHX&#41;
+{
+    MAGIC *mg;
+
+    MP_TRACE_d&#40;MP_FUNC, &#34;changing vtable for %%ENV&#34;&#41;;
+    mg = mg_find&#40;&#40;SV *&#41;ENVHV, PERL_MAGIC_env&#41;;
+    if &#40;mg&#41; {
+        mg-&gt;mg_virtual = &#38;MP_vtbl_env;
+        mg-&gt;mg_flags |= MGf_COPY;
+        mg-&gt;mg_flags |= MGf_LOCAL;
+    } else {
+        MP_TRACE_d&#40;MP_FUNC, &#34;no %%ENV magic found?&#34;&#41;;
+    }
 }
 
 void modperl_env_unload&#40;void&#41;
 {
+#if MP_PERL_VERSION_AT_MOST&#40;5, 21, 7&#41;
     /* restore originals */
     StructCopy&#40;&#38;MP_PERL_vtbl_env, &#38;PL_vtbl_env, MGVTBL&#41;;
     StructCopy&#40;&#38;MP_PERL_vtbl_envelem, &#38;PL_vtbl_envelem, MGVTBL&#41;;
+#endif
 }
 
 /*
diff --git a/src/modules/perl/modperl_env.h b/src/modules/perl/modperl_env.h
index 406e345..d00ebe2 100644
--- a/src/modules/perl/modperl_env.h
+++ b/src/modules/perl/modperl_env.h
@@ -60,6 +60,8 @@ void modperl_env_request_untie&#40;pTHX_ request_rec *r&#41;;
 
 void modperl_env_init&#40;void&#41;;
 
+void modperl_env_init2&#40;pTHX&#41;;
+
 void modperl_env_unload&#40;void&#41;;
 
 #endif /* MODPERL_ENV_H */
-- 
2.5.1

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;28&nbsp;19:47:56&nbsp;2015</span>
    <span class="description">steve.m.hay [...] googlemail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101962] modperl_env_init&#40;&#41; needs changing for perl &gt;= 5.21.8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 28 Oct 2015 23:47:45 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-mod_perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steve Hay &lt;steve.m.hay [...] googlemail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 28 Oct 2015 22:49, &#34;ntyni@iki.fi via RT&#34; &lt;bug-mod_perl@rt.cpan.org&gt;
wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt;        Queue: mod_perl
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101962">https://rt.cpan.org/Ticket/Display.html?id=101962</a></span> &gt;
&gt;
&gt; On Mon Aug 31 07:16:46 2015, SHAY wrote:
&gt;
<div class="message-stanza open">&gt; &gt; I&#39;m hoping that the plan outlined by Leon shouldn&#39;t be too difficult to
</div></div>implement.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; Hi, I&#39;m attaching a work in progress patch that tries to do this. I&#39;m
</div>somewhat stuck here. Comments would be appreciated, but please be gentle -
I&#39;m quite out of my depth here and only learning the ropes as I go along :&#41;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt;
&gt; Main open questions that I can see:
&gt;
&gt; - where should modperl_env_init2&#40;&#41; be really called? It needs an
</div>initialized Perl interpreter for ENVHV &#40;%ENV&#41;, so modperl_sys_init&#40;&#41; seems
too early
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; - cleanup &#40;replacement for modperl_env_unload&#40;&#41;&#41; is nonexistent so far
&gt;
&gt; - running t/modperl/env.t and t/modules/cgi.t in the same run makes the
</div>latter fail because $ENV{MOD_PERL} is not set
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; Not sure if the modperl-dev list would be a better place to discuss this?
&gt;
</div>
Hi,

Oddly enough I&#39;ve also been looking at this, and was asking Leon Timmermans
for advice only just today!

Attached is my effort so far, but I&#39;m told that I&#39;ve gone wrong with
PERL_MAGIC_envelem and I need a mg_copy entry in MP_PERL_vtbl_env. I will
try this tomorrow.

Hopefully we can get this nailed soon between us :-&#41;
</div></div>

<div class="messagebody">
</div>
</div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;30&nbsp;04:58:08&nbsp;2015</span>
    <span class="description">shay [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Oct 28 19:47:56 2015, steve.m.hay@googlemail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 28 Oct 2015 22:49, &#34;ntyni@iki.fi via RT&#34; &lt;bug-mod_perl@rt.cpan.org&gt;
&gt; wrote:
<div class="message-stanza open">&gt; &gt;
&gt; &gt;        Queue: mod_perl
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101962">https://rt.cpan.org/Ticket/Display.html?id=101962</a></span> &gt;
&gt; &gt;
&gt; &gt; On Mon Aug 31 07:16:46 2015, SHAY wrote:
&gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; I&#39;m hoping that the plan outlined by Leon shouldn&#39;t be too difficult to
</div></div>&gt; implement.
<div class="message-stanza open">&gt; &gt;
&gt; &gt; Hi, I&#39;m attaching a work in progress patch that tries to do this. I&#39;m
</div>&gt; somewhat stuck here. Comments would be appreciated, but please be gentle -
&gt; I&#39;m quite out of my depth here and only learning the ropes as I go along :&#41;
<div class="message-stanza open">&gt; &gt;
&gt; &gt;
&gt; &gt; Main open questions that I can see:
&gt; &gt;
&gt; &gt; - where should modperl_env_init2&#40;&#41; be really called? It needs an
</div>&gt; initialized Perl interpreter for ENVHV &#40;%ENV&#41;, so modperl_sys_init&#40;&#41; seems
&gt; too early
<div class="message-stanza open">&gt; &gt;
&gt; &gt; - cleanup &#40;replacement for modperl_env_unload&#40;&#41;&#41; is nonexistent so far
&gt; &gt;
&gt; &gt; - running t/modperl/env.t and t/modules/cgi.t in the same run makes the
</div>&gt; latter fail because $ENV{MOD_PERL} is not set
<div class="message-stanza open">&gt; &gt;
&gt; &gt; Not sure if the modperl-dev list would be a better place to discuss this?
&gt; &gt;
</div>&gt; 
&gt; Hi,
&gt; 
&gt; Oddly enough I&#39;ve also been looking at this, and was asking Leon Timmermans
&gt; for advice only just today!
&gt; 
&gt; Attached is my effort so far, but I&#39;m told that I&#39;ve gone wrong with
&gt; PERL_MAGIC_envelem and I need a mg_copy entry in MP_PERL_vtbl_env. I will
&gt; try this tomorrow.
&gt; 
&gt; Hopefully we can get this nailed soon between us :-&#41;
</div>
The mg_copy function in your patch looks just the ticket to me, but unfortunately I&#39;m getting failures in t/modperl/setupenv2.t &#40;tests 17-23&#41; &#40;in addition to the slew of failures which are now sadly the norm on Windows when using httpd-2.4&#41;.

I&#39;ve also tried combining the init/term changes from my patch &#40;although I&#39;m not sure whether they&#39;re really correct either&#41; with the other good work of your patch. The result is attached &#40;env2.patch&#41;. This fixes the setupenv2.t failures but has a new problem instead - in t/modperl/env.t &#40;planned 71 tests but ran 6&#41;.

I haven&#39;t looked into what the exact cause of either of those failures is yet. Hopefully doing so will shed some more light on this...
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> env2.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: src/modules/perl/mod_perl.c
===================================================================
--- src/modules/perl/mod_perl.c	&#40;revision 1711313&#41;
+++ src/modules/perl/mod_perl.c	&#40;working copy&#41;
@@ -262,6 +262,8 @@
         exit&#40;1&#41;;
     }
 
+    modperl_env_init&#40;aTHX&#41;;
+
     /* suspend END blocks to be run at server shutdown */
     endav = PL_endav;
     PL_endav = &#40;AV *&#41;NULL;
@@ -576,9 +578,6 @@
     /* modifies PL_ppaddr */
     modperl_perl_pp_set_all&#40;&#41;;
 
-    /* modifies PL_vtbl_env{elem} */
-    modperl_env_init&#40;&#41;;
-
     return APR_SUCCESS;
 }
 
@@ -597,8 +596,6 @@
 
     MP_TRACE_i&#40;MP_FUNC, &#34;mod_perl sys term&#34;&#41;;
 
-    modperl_env_unload&#40;&#41;;
-
     modperl_perl_pp_unset_all&#40;&#41;;
 
     PERL_SYS_TERM&#40;&#41;;
Index: src/modules/perl/modperl_env.c
===================================================================
--- src/modules/perl/modperl_env.c	&#40;revision 1711313&#41;
+++ src/modules/perl/modperl_env.c	&#40;working copy&#41;
@@ -612,6 +612,9 @@
 }
 #endif
 
+static int modperl_env_magic_copy&#40;pTHX_ SV *sv, MAGIC *mg, SV *nsv, const char *name, I32 namlen&#41;;
+static int modperl_env_magic_local_all&#40;pTHX_ SV *nsv, MAGIC *mg&#41;;
+
 /* override %ENV virtual tables with our own */
 static MGVTBL MP_vtbl_env = {
     0,
@@ -618,7 +621,10 @@
     modperl_env_magic_set_all,
     0,
     modperl_env_magic_clear_all,
-    0
+    0,
+    modperl_env_magic_copy,
+    0,
+    modperl_env_magic_local_all
 };
 
 static MGVTBL MP_vtbl_envelem = {
@@ -629,24 +635,77 @@
     0
 };
 
-void modperl_env_init&#40;void&#41;
+static int modperl_env_magic_copy&#40;pTHX_ SV *sv, MAGIC *mg, SV *nsv, const char *name, I32 namlen&#41;
 {
-    /* save originals */
-    StructCopy&#40;&#38;PL_vtbl_env, &#38;MP_PERL_vtbl_env, MGVTBL&#41;;
-    StructCopy&#40;&#38;PL_vtbl_envelem, &#38;MP_PERL_vtbl_envelem, MGVTBL&#41;;
+    MAGIC *nmg = NULL;
+    sv_magic&#40;nsv, mg-&gt;mg_obj,
+                        toLOWER&#40;mg-&gt;mg_type&#41;,
+                        name, namlen&#41;;
+    nmg = mg_find&#40;nsv, toLOWER&#40;mg-&gt;mg_type&#41;&#41;;
+    if &#40;mg-&gt;mg_virtual == &#38;MP_vtbl_env&#41; {
+        MP_TRACE_d&#40;MP_FUNC, &#34;copying magic to %%ENV element&#34;&#41;;
+        nmg-&gt;mg_virtual = &#38;MP_vtbl_envelem;
+    } else {
+        MP_TRACE_d&#40;MP_FUNC, &#34;no %%ENV magic found to copy&#34;&#41;;
+    }
+    return 1;
+}
 
-    /* replace with our versions */
-    StructCopy&#40;&#38;MP_vtbl_env, &#38;PL_vtbl_env, MGVTBL&#41;;
-    StructCopy&#40;&#38;MP_vtbl_envelem, &#38;PL_vtbl_envelem, MGVTBL&#41;;
+static int modperl_env_magic_local_all&#40;pTHX_ SV *nsv, MAGIC *mg&#41;
+{
+    MAGIC *nmg;
+    MP_TRACE_e&#40;MP_FUNC, &#34;localizing %%ENV&#34;&#41;;
+    sv_magic&#40;nsv, mg-&gt;mg_obj,
+                        mg-&gt;mg_type,
+                        NULL, 0&#41;;
+    nmg = mg_find&#40;nsv, mg-&gt;mg_type&#41;;
+    nmg-&gt;mg_ptr = mg-&gt;mg_ptr;
+    if &#40;mg-&gt;mg_virtual == &#38;MP_vtbl_env&#41; {
+        nmg-&gt;mg_virtual = &#38;MP_vtbl_env;
+        nmg-&gt;mg_flags |= MGf_COPY;
+        nmg-&gt;mg_flags |= MGf_LOCAL;
+    } else {
+        MP_TRACE_d&#40;MP_FUNC, &#34;no %%ENV magic found to localize&#34;&#41;;
+     }
+     return 1;
 }
 
-void modperl_env_unload&#40;void&#41;
+void modperl_env_init&#40;pTHX&#41;
 {
-    /* restore originals */
-    StructCopy&#40;&#38;MP_PERL_vtbl_env, &#38;PL_vtbl_env, MGVTBL&#41;;
-    StructCopy&#40;&#38;MP_PERL_vtbl_envelem, &#38;PL_vtbl_envelem, MGVTBL&#41;;
+    /* Remove existing &#39;E&#39; magic from %ENV */
+    /* TODO: Should check there is not multiple &#39;E&#39; magic! */
+    if &#40;!my_perl&#41;
+        return;
+    if &#40;!PL_envgv&#41;
+        return;
+    if &#40;!SvRMAGICAL&#40;ENVHV&#41;&#41;
+        return;
+    if &#40;!mg_find&#40;&#40;const SV *&#41;ENVHV, PERL_MAGIC_env&#41;&#41;
+        return;
+    mg_free_type&#40;&#40;SV*&#41;ENVHV, PERL_MAGIC_env&#41;;
+ 
+    /* Add our version instead */
+    sv_magicext&#40;&#40;SV*&#41;ENVHV, &#40;SV*&#41;NULL, PERL_MAGIC_env, &#38;MP_vtbl_env, &#40;char*&#41;NULL, 0&#41;;
 }
 
+void modperl_env_unload&#40;pTHX&#41;
+{
+    /* Remove our &#39;E&#39; magic from %ENV */
+    /* TODO: Should check there is not multiple &#39;E&#39; magic! */
+    if &#40;!my_perl&#41;
+        return;
+    if &#40;!PL_envgv&#41;
+        return;
+    if &#40;!SvRMAGICAL&#40;ENVHV&#41;&#41;
+        return;
+    if &#40;!mg_find&#40;&#40;const SV *&#41;ENVHV, PERL_MAGIC_env&#41;&#41;
+        return;
+    mg_free_type&#40;&#40;SV*&#41;ENVHV, PERL_MAGIC_env&#41;;
+
+    /* Restore original */
+    sv_magicext&#40;&#40;SV*&#41;ENVHV, &#40;SV*&#41;NULL, PERL_MAGIC_env, &#38;PL_vtbl_env, &#40;char*&#41;NULL, 0&#41;;
+}
+
 /*
  * Local Variables:
  * c-basic-offset: 4
Index: src/modules/perl/modperl_env.h
===================================================================
--- src/modules/perl/modperl_env.h	&#40;revision 1711313&#41;
+++ src/modules/perl/modperl_env.h	&#40;working copy&#41;
@@ -58,9 +58,9 @@
 
 void modperl_env_request_untie&#40;pTHX_ request_rec *r&#41;;
 
-void modperl_env_init&#40;void&#41;;
+void modperl_env_init&#40;pTHX&#41;;
 
-void modperl_env_unload&#40;void&#41;;
+void modperl_env_unload&#40;pTHX&#41;;
 
 #endif /* MODPERL_ENV_H */
 
Index: src/modules/perl/modperl_perl.c
===================================================================
--- src/modules/perl/modperl_perl.c	&#40;revision 1711313&#41;
+++ src/modules/perl/modperl_perl.c	&#40;working copy&#41;
@@ -181,6 +181,8 @@
         }
     }
 
+    modperl_env_unload&#40;perl&#41;;
+
     perl_destruct&#40;perl&#41;;
 
     /* XXX: big bug in 5.6.1 fixed in 5.7.2+
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;15&nbsp;15:45:01&nbsp;2015</span>
    <span class="description">abe+cpan [...] deuxchevaux.org -  Cc ABE added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;22&nbsp;17:50:22&nbsp;2015</span>
    <span class="description">ntyni [...] iki.fi -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ntyni [...] iki.fi</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Oct 28 18:49:31 2015, ntyni@iki.fi wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; - running t/modperl/env.t and t/modules/cgi.t in the same run makes
&gt; the latter fail because $ENV{MOD_PERL} is not set
</div>
I seem to have found the cause for this: existing %ENV elements needed their envelem vtable fixed too, otherwise modifying them wouldn&#39;t reflect in subprocess_env.

I&#39;m attaching an updated patch. This passes all tests for me on both 5.20 and 5.22, but I&#39;m sure there are still wrinkles to iron out. Anyway, it&#39;s progress.

Steve: in particular, I&#39;m not seeing the setupenv2.t failures you mentioned. Do they still fail with this?

See the commit message for remaining concerns. Eyeballs would be very welcome.

-- 
Niko
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-First-steps-at-Perl-5.22-compatibility-take-2.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 4fc74e1abe3c3000d39e0fd2efbc9c9dce4f8fd9 Mon Sep 17 00:00:00 2001
From: Niko Tyni &lt;ntyni@debian.org&gt;
Date: Thu, 29 Oct 2015 00:18:53 +0200
Subject: [PATCH] First steps at Perl 5.22 compatibility, take 2

As outlined by Leon Timmermans in [perl #123687]:

  lookup %ENV&#39;s magic, and then replace the pointer to PL_vtbl_env with
  a pointer to MP_vtbl_env. You may have to add some svt_copy magic to
  make it cast MP_vtbl_envelem instead of PL_vtbl_envelem on the elements.

with an added svt_local for the &#39;local %ENV&#39; tests.

While at it, augment t/modperl/env.t to check that deleting %ENV elements
really removes them from subprocess_env. This highlights the need for
modifying their vtable, currently with modperl_env_fix_envelem_vtable&#40;&#41;.

Main open questions:

- where should modperl_env_init2&#40;&#41; be really called? It needs an
  initialized Perl interpreter for ENVHV &#40;%ENV&#41;, so modperl_sys_init&#40;&#41;
  seems too early
- cleanup &#40;replacement for modperl_env_unload&#40;&#41;&#41; is nonexistent
- modperl_env_fix_envelem_vtable&#40;&#41; should probably be merged
  into modperl_envelem_tie&#40;&#41; somehow

Bug: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=101962">https://rt.cpan.org/Public/Bug/Display.html?id=101962</a></span>
Bug: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/Ticket/Display.html?id=123687">https://rt.perl.org/Ticket/Display.html?id=123687</a></span>
---
 src/modules/perl/modperl_env.c         | 71 ++++++++++++++++++++++++++++++++++
 src/modules/perl/modperl_env.h         |  4 ++
 src/modules/perl/modperl_perl_global.c |  1 +
 t/response/TestModperl/env.pm          |  4 +-
 4 files changed, 79 insertions&#40;+&#41;, 1 deletion&#40;-&#41;

diff --git a/src/modules/perl/modperl_env.c b/src/modules/perl/modperl_env.c
index c1a276b..aa27299 100644
--- a/src/modules/perl/modperl_env.c
+++ b/src/modules/perl/modperl_env.c
@@ -34,6 +34,8 @@ static unsigned long modperl_interp_address&#40;pTHX&#41;
 #endif
 }
 
+void modperl_env_fix_envelem_vtable&#40;pTHX_ SV *&#41;;
+
 #define MP_ENV_HV_STORE&#40;hv, key, val&#41; STMT_START {              \
         I32 klen = strlen&#40;key&#41;;                                 \
         SV **svp = hv_fetch&#40;hv, key, klen, FALSE&#41;;              \
@@ -46,6 +48,7 @@ static unsigned long modperl_interp_address&#40;pTHX&#41;
             sv = newSVpv&#40;val, 0&#41;;                               \
             &#40;void&#41;hv_store&#40;hv, key, klen, sv, FALSE&#41;;           \
             modperl_envelem_tie&#40;sv, key, klen&#41;;                 \
+            modperl_env_fix_envelem_vtable&#40;aTHX_ sv&#41;;           \
             svp = &#38;sv;                                          \
         }                                                       \
         MP_TRACE_e&#40;MP_FUNC, &#34;$ENV{%s} = \&#34;%s\&#34;;&#34;, key, val&#41;;    \
@@ -121,6 +124,7 @@ static void modperl_env_table_populate&#40;pTHX_ apr_table_t *table&#41;
     const apr_array_header_t *array;
     apr_table_entry_t *elts;
 
+    modperl_env_init2&#40;aTHX&#41;;
     modperl_env_untie&#40;mg_flags&#41;;
 
     array = apr_table_elts&#40;table&#41;;
@@ -340,6 +344,7 @@ void modperl_env_default_populate&#40;pTHX&#41;
                        sv, ent-&gt;hash&#41;;
         MP_TRACE_e&#40;MP_FUNC, &#34;$ENV{%s} = \&#34;%s\&#34;;&#34;, ent-&gt;key, ent-&gt;val&#41;;
         modperl_envelem_tie&#40;sv, ent-&gt;key, ent-&gt;klen&#41;;
+        modperl_env_fix_envelem_vtable&#40;aTHX_ sv&#41;;
         ent++;
     }
 
@@ -612,6 +617,9 @@ static int modperl_env_magic_get&#40;pTHX_ SV *sv, MAGIC *mg&#41;
 }
 #endif
 
+static int modperl_env_magic_copy&#40;pTHX_ SV *sv, MAGIC *mg, SV *nsv, const char *name, I32 namlen&#41;;
+static int modperl_env_magic_local_all&#40;pTHX_ SV *nsv, MAGIC *mg&#41;;
+
 /* override %ENV virtual tables with our own */
 static MGVTBL MP_vtbl_env = {
     0,
@@ -619,6 +627,7 @@ static MGVTBL MP_vtbl_env = {
     0,
     modperl_env_magic_clear_all,
     0
+    , modperl_env_magic_copy, 0, modperl_env_magic_local_all
 };
 
 static MGVTBL MP_vtbl_envelem = {
@@ -629,22 +638,84 @@ static MGVTBL MP_vtbl_envelem = {
     0
 };
 
+static int modperl_env_magic_copy&#40;pTHX_ SV *sv, MAGIC *mg, SV *nsv, const char *name, I32 namlen&#41;
+{
+    MAGIC *nmg = NULL;
+    sv_magic&#40;nsv, mg-&gt;mg_obj,
+                        toLOWER&#40;mg-&gt;mg_type&#41;,
+                        name, namlen&#41;;
+    nmg = mg_find&#40;nsv, toLOWER&#40;mg-&gt;mg_type&#41;&#41;;
+    if &#40;mg-&gt;mg_virtual == &#38;MP_vtbl_env&#41; {
+        MP_TRACE_d&#40;MP_FUNC, &#34;copying magic to %%ENV element&#34;&#41;;
+        nmg-&gt;mg_virtual = &#38;MP_vtbl_envelem;
+    } else {
+        MP_TRACE_d&#40;MP_FUNC, &#34;no %%ENV magic found to copy&#34;&#41;;
+    }
+    return 1;
+}
+
+static int modperl_env_magic_local_all&#40;pTHX_ SV *nsv, MAGIC *mg&#41;
+{
+    MAGIC *nmg;
+    MP_TRACE_e&#40;MP_FUNC, &#34;localizing %%ENV&#34;&#41;;
+    sv_magic&#40;nsv, mg-&gt;mg_obj,
+                        mg-&gt;mg_type,
+                        NULL, 0&#41;;
+    nmg = mg_find&#40;nsv, mg-&gt;mg_type&#41;;
+    nmg-&gt;mg_ptr = mg-&gt;mg_ptr;
+    if &#40;mg-&gt;mg_virtual == &#38;MP_vtbl_env&#41; {
+        nmg-&gt;mg_virtual = &#38;MP_vtbl_env;
+        nmg-&gt;mg_flags |= MGf_COPY;
+        nmg-&gt;mg_flags |= MGf_LOCAL;
+    } else {
+        MP_TRACE_d&#40;MP_FUNC, &#34;no %%ENV magic found to localize&#34;&#41;;
+     }
+     return 1;
+}
+
 void modperl_env_init&#40;void&#41;
 {
     /* save originals */
     StructCopy&#40;&#38;PL_vtbl_env, &#38;MP_PERL_vtbl_env, MGVTBL&#41;;
     StructCopy&#40;&#38;PL_vtbl_envelem, &#38;MP_PERL_vtbl_envelem, MGVTBL&#41;;
 
+#if 0
     /* replace with our versions */
     StructCopy&#40;&#38;MP_vtbl_env, &#38;PL_vtbl_env, MGVTBL&#41;;
     StructCopy&#40;&#38;MP_vtbl_envelem, &#38;PL_vtbl_envelem, MGVTBL&#41;;
+#endif
+}
+
+void modperl_env_init2&#40;pTHX&#41;
+{
+    MAGIC *mg;
+
+    MP_TRACE_d&#40;MP_FUNC, &#34;changing vtable for %%ENV&#34;&#41;;
+    mg = mg_find&#40;&#40;SV *&#41;ENVHV, PERL_MAGIC_env&#41;;
+    if &#40;mg&#41; {
+        mg-&gt;mg_virtual = &#38;MP_vtbl_env;
+        mg-&gt;mg_flags |= MGf_COPY;
+        mg-&gt;mg_flags |= MGf_LOCAL;
+    } else {
+        MP_TRACE_d&#40;MP_FUNC, &#34;no %%ENV magic found?&#34;&#41;;
+    }
+}
+
+void modperl_env_fix_envelem_vtable&#40;pTHX_ SV *sv&#41;
+{
+    MAGIC *mg = mg_find&#40;sv, PERL_MAGIC_envelem&#41;;
+    if &#40;mg&#41; {
+        mg-&gt;mg_virtual = &#38;MP_vtbl_envelem;
+    }
 }
 
 void modperl_env_unload&#40;void&#41;
 {
+#if 0
     /* restore originals */
     StructCopy&#40;&#38;MP_PERL_vtbl_env, &#38;PL_vtbl_env, MGVTBL&#41;;
     StructCopy&#40;&#38;MP_PERL_vtbl_envelem, &#38;PL_vtbl_envelem, MGVTBL&#41;;
+#endif
 }
 
 /*
diff --git a/src/modules/perl/modperl_env.h b/src/modules/perl/modperl_env.h
index 406e345..9657331 100644
--- a/src/modules/perl/modperl_env.h
+++ b/src/modules/perl/modperl_env.h
@@ -60,6 +60,10 @@ void modperl_env_request_untie&#40;pTHX_ request_rec *r&#41;;
 
 void modperl_env_init&#40;void&#41;;
 
+void modperl_env_init2&#40;pTHX&#41;;
+
+void modperl_env_fix_envelem_vtable&#40;pTHX_ SV *sv&#41;;
+
 void modperl_env_unload&#40;void&#41;;
 
 #endif /* MODPERL_ENV_H */
diff --git a/src/modules/perl/modperl_perl_global.c b/src/modules/perl/modperl_perl_global.c
index f52e42c..99565f8 100644
--- a/src/modules/perl/modperl_perl_global.c
+++ b/src/modules/perl/modperl_perl_global.c
@@ -272,6 +272,7 @@ static HV *copyENV&#40;pTHX_ HV *ohv&#41;
     while &#40;&#40;entry = hv_iternext&#40;ohv&#41;&#41;&#41; {
         SV *sv = newSVsv&#40;HeVAL&#40;entry&#41;&#41;;
         modperl_envelem_tie&#40;sv, HeKEY&#40;entry&#41;, HeKLEN&#40;entry&#41;&#41;;
+        modperl_env_fix_envelem_vtable&#40;aTHX_ sv&#41;;
         &#40;void&#41;hv_store&#40;hv, HeKEY&#40;entry&#41;, HeKLEN&#40;entry&#41;,
                        sv, HeHASH&#40;entry&#41;&#41;;
     }
diff --git a/t/response/TestModperl/env.pm b/t/response/TestModperl/env.pm
index 62eac81..ac057a9 100644
--- a/t/response/TestModperl/env.pm
+++ b/t/response/TestModperl/env.pm
@@ -15,7 +15,7 @@ use Apache2::Const -compile =&gt; &#39;OK&#39;;
 sub handler {
     my $r = shift;
 
-    plan $r, tests =&gt; 23 + keys&#40;%ENV&#41;;
+    plan $r, tests =&gt; 23 + 3 * keys&#40;%ENV&#41;;
 
     my $env = $r-&gt;subprocess_env;
 
@@ -75,6 +75,8 @@ sub handler {
     for my $key &#40;sort keys %ENV&#41; {
         eval { delete $ENV{$key}; };
         ok t_cmp&#40;$@, &#39;&#39;, $key&#41;;
+        ok t_cmp&#40;$ENV{$key}, undef, &#34;ENV{$key} is empty&#34;&#41;;
+        ok t_cmp&#40;$env-&gt;get&#40;$key&#41;, undef, &#34;subprocess_env&#40;$key&#41; is empty&#34;&#41;;
     }
 
     Apache2::Const::OK;
-- 
2.6.2

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;23&nbsp;16:06:56&nbsp;2015</span>
    <span class="description">ntyni [...] iki.fi -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ntyni [...] iki.fi</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Nov 22 17:50:22 2015, ntyni@iki.fi wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m attaching an updated patch. This passes all tests for me on both
&gt; 5.20 and 5.22, but I&#39;m sure there are still wrinkles to iron out.
</div>
Here&#39;s another version, based on Steve&#39;s env2.patch and using sv_magicext&#40;&#41; where applicable to get our own vtables in. It&#39;s somewhat cleaner and still passes all the tests for me. 

I&#39;ve merged the envelem vtable fixup into the modperl_envelem_tie macro, but had to make MP_vtbl_envelem global for that. I&#39;m sure there&#39;s a better way.
-- 
Niko
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Steps-at-Perl-5.22-compatibility-take-3.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 74bd6a91aa7b8ca47d826a1655d06cf295c1365c Mon Sep 17 00:00:00 2001
From: Niko Tyni &lt;ntyni@debian.org&gt;
Date: Wed, 4 Nov 2015 21:51:40 +0200
Subject: [PATCH] Steps at Perl 5.22 compatibility, take 3

As outlined by Leon Timmermans in [perl #123687]:

  lookup %ENV&#39;s magic, and then replace the pointer to PL_vtbl_env with
  a pointer to MP_vtbl_env. You may have to add some svt_copy magic to
  make it cast MP_vtbl_envelem instead of PL_vtbl_envelem on the elements.

with an added svt_local for the &#39;local %ENV&#39; tests.

While at it, augment t/modperl/env.t to check that deleting %ENV elements
really removes them from subprocess_env. This highlights the need for
modifying their vtable, currently in the modperl_envelem_tie&#40;&#41; macro.

Main open questions:

- MP_vtbl_envelem probably shouldn&#39;t be a global variable,
  but the modperl_envelem_tie&#40;&#41; macro needs it.

Based on Steve Hay&#39;s env2.patch in [rt.cpan.org #101962].

Bug: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=101962">https://rt.cpan.org/Public/Bug/Display.html?id=101962</a></span>
Bug: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/Ticket/Display.html?id=123687">https://rt.perl.org/Ticket/Display.html?id=123687</a></span>
---
 src/modules/perl/mod_perl.c     |  7 +---
 src/modules/perl/modperl_env.c  | 88 +++++++++++++++++++++++++++++++++++------
 src/modules/perl/modperl_env.h  |  8 ++--
 src/modules/perl/modperl_perl.c |  2 +
 t/response/TestModperl/env.pm   |  4 +-
 5 files changed, 87 insertions&#40;+&#41;, 22 deletions&#40;-&#41;

diff --git a/src/modules/perl/mod_perl.c b/src/modules/perl/mod_perl.c
index 1148bc0..1e17747 100644
--- a/src/modules/perl/mod_perl.c
+++ b/src/modules/perl/mod_perl.c
@@ -262,6 +262,8 @@ PerlInterpreter *modperl_startup&#40;server_rec *s, apr_pool_t *p&#41;
         exit&#40;1&#41;;
     }
 
+    modperl_env_init&#40;aTHX&#41;;
+
     /* suspend END blocks to be run at server shutdown */
     endav = PL_endav;
     PL_endav = &#40;AV *&#41;NULL;
@@ -576,9 +578,6 @@ static apr_status_t modperl_sys_init&#40;void&#41;
     /* modifies PL_ppaddr */
     modperl_perl_pp_set_all&#40;&#41;;
 
-    /* modifies PL_vtbl_env{elem} */
-    modperl_env_init&#40;&#41;;
-
     return APR_SUCCESS;
 }
 
@@ -597,8 +596,6 @@ static apr_status_t modperl_sys_term&#40;void *data&#41;
 
     MP_TRACE_i&#40;MP_FUNC, &#34;mod_perl sys term&#34;&#41;;
 
-    modperl_env_unload&#40;&#41;;
-
     modperl_perl_pp_unset_all&#40;&#41;;
 
     PERL_SYS_TERM&#40;&#41;;
diff --git a/src/modules/perl/modperl_env.c b/src/modules/perl/modperl_env.c
index c1a276b..1aaf3fc 100644
--- a/src/modules/perl/modperl_env.c
+++ b/src/modules/perl/modperl_env.c
@@ -121,6 +121,7 @@ static void modperl_env_table_populate&#40;pTHX_ apr_table_t *table&#41;
     const apr_array_header_t *array;
     apr_table_entry_t *elts;
 
+    modperl_env_init&#40;aTHX&#41;;
     modperl_env_untie&#40;mg_flags&#41;;
 
     array = apr_table_elts&#40;table&#41;;
@@ -612,16 +613,22 @@ static int modperl_env_magic_get&#40;pTHX_ SV *sv, MAGIC *mg&#41;
 }
 #endif
 
+static int modperl_env_magic_copy&#40;pTHX_ SV *sv, MAGIC *mg, SV *nsv, const char *name, I32 namlen&#41;;
+static int modperl_env_magic_local_all&#40;pTHX_ SV *nsv, MAGIC *mg&#41;;
+
 /* override %ENV virtual tables with our own */
 static MGVTBL MP_vtbl_env = {
     0,
     modperl_env_magic_set_all,
     0,
     modperl_env_magic_clear_all,
-    0
+    0,
+    modperl_env_magic_copy,
+    0,
+    modperl_env_magic_local_all
 };
 
-static MGVTBL MP_vtbl_envelem = {
+MGVTBL MP_vtbl_envelem = {
     0,
     modperl_env_magic_set,
     0,
@@ -629,22 +636,77 @@ static MGVTBL MP_vtbl_envelem = {
     0
 };
 
-void modperl_env_init&#40;void&#41;
+static int modperl_env_magic_copy&#40;pTHX_ SV *sv, MAGIC *mg, SV *nsv, const char *name, I32 namlen&#41;
 {
-    /* save originals */
-    StructCopy&#40;&#38;PL_vtbl_env, &#38;MP_PERL_vtbl_env, MGVTBL&#41;;
-    StructCopy&#40;&#38;PL_vtbl_envelem, &#38;MP_PERL_vtbl_envelem, MGVTBL&#41;;
+    MP_TRACE_e&#40;MP_FUNC, &#34;setting up %%ENV element magic&#34;&#41;;
+    sv_magicext&#40;nsv, mg-&gt;mg_obj,
+                        toLOWER&#40;mg-&gt;mg_type&#41;,
+                        &#38;MP_vtbl_envelem,
+                        name, namlen&#41;;
 
-    /* replace with our versions */
-    StructCopy&#40;&#38;MP_vtbl_env, &#38;PL_vtbl_env, MGVTBL&#41;;
-    StructCopy&#40;&#38;MP_vtbl_envelem, &#38;PL_vtbl_envelem, MGVTBL&#41;;
+    return 1;
 }
 
-void modperl_env_unload&#40;void&#41;
+static int modperl_env_magic_local_all&#40;pTHX_ SV *nsv, MAGIC *mg&#41;
 {
-    /* restore originals */
-    StructCopy&#40;&#38;MP_PERL_vtbl_env, &#38;PL_vtbl_env, MGVTBL&#41;;
-    StructCopy&#40;&#38;MP_PERL_vtbl_envelem, &#38;PL_vtbl_envelem, MGVTBL&#41;;
+    MAGIC *nmg;
+    MP_TRACE_e&#40;MP_FUNC, &#34;localizing %%ENV&#34;&#41;;
+    nmg = sv_magicext&#40;nsv, mg-&gt;mg_obj,
+                        mg-&gt;mg_type,
+                        &#38;MP_vtbl_env,
+                        NULL, 0&#41;;
+    nmg-&gt;mg_ptr = mg-&gt;mg_ptr;
+    nmg-&gt;mg_flags |= MGf_COPY;
+    nmg-&gt;mg_flags |= MGf_LOCAL;
+
+    return 1;
+}
+
+void modperl_env_init&#40;pTHX&#41;
+{
+     /* save originals */
+     StructCopy&#40;&#38;PL_vtbl_env, &#38;MP_PERL_vtbl_env, MGVTBL&#41;;
+     StructCopy&#40;&#38;PL_vtbl_envelem, &#38;MP_PERL_vtbl_envelem, MGVTBL&#41;;
+
+    MAGIC *mg;
+    /* Remove existing &#39;E&#39; magic from %ENV */
+    /* TODO: Should check there is not multiple &#39;E&#39; magic! */
+    if &#40;!my_perl&#41;
+        return;
+    if &#40;!PL_envgv&#41;
+        return;
+    if &#40;!SvRMAGICAL&#40;ENVHV&#41;&#41;
+        return;
+    mg = mg_find&#40;&#40;const SV *&#41;ENVHV, PERL_MAGIC_env&#41;;
+    if &#40;!mg&#41;
+        return;
+    if &#40;mg-&gt;mg_virtual == &#38;MP_vtbl_env&#41;
+        return;
+    MP_TRACE_d&#40;MP_FUNC, &#34;ptr: %x obj: %x flags:%x&#34;, mg-&gt;mg_ptr, mg-&gt;mg_obj, mg-&gt;mg_flags&#41;;
+    mg_free_type&#40;&#40;SV*&#41;ENVHV, PERL_MAGIC_env&#41;;
+
+    /* Add our version instead */
+    mg = sv_magicext&#40;&#40;SV*&#41;ENVHV, &#40;SV*&#41;NULL, PERL_MAGIC_env, &#38;MP_vtbl_env, &#40;char*&#41;NULL, 0&#41;;
+    mg-&gt;mg_flags |= MGf_COPY;
+    mg-&gt;mg_flags |= MGf_LOCAL;
+}
+
+void modperl_env_unload&#40;pTHX&#41;
+{
+    /* Remove our &#39;E&#39; magic from %ENV */
+    /* TODO: Should check there is not multiple &#39;E&#39; magic! */
+    if &#40;!my_perl&#41;
+        return;
+    if &#40;!PL_envgv&#41;
+        return;
+    if &#40;!SvRMAGICAL&#40;ENVHV&#41;&#41;
+        return;
+    if &#40;!mg_find&#40;&#40;const SV *&#41;ENVHV, PERL_MAGIC_env&#41;&#41;
+        return;
+    mg_free_type&#40;&#40;SV*&#41;ENVHV, PERL_MAGIC_env&#41;;
+
+    /* Restore original */
+    sv_magicext&#40;&#40;SV*&#41;ENVHV, &#40;SV*&#41;NULL, PERL_MAGIC_env, &#38;PL_vtbl_env, &#40;char*&#41;NULL, 0&#41;;
 }
 
 /*
diff --git a/src/modules/perl/modperl_env.h b/src/modules/perl/modperl_env.h
index 406e345..05d6bbd 100644
--- a/src/modules/perl/modperl_env.h
+++ b/src/modules/perl/modperl_env.h
@@ -28,7 +28,7 @@
     MP_magical_tie&#40;ENVHV, mg_flags&#41;
 
 #define modperl_envelem_tie&#40;sv, key, klen&#41; \
-    sv_magic&#40;sv, &#40;SV *&#41;NULL, &#39;e&#39;, key, klen&#41;
+    sv_magicext&#40;sv, &#40;SV *&#41;NULL, PERL_MAGIC_envelem, &#38;MP_vtbl_envelem, key, klen&#41;
 
 void modperl_env_hash_keys&#40;pTHX&#41;;
 
@@ -58,9 +58,11 @@ void modperl_env_request_tie&#40;pTHX_ request_rec *r&#41;;
 
 void modperl_env_request_untie&#40;pTHX_ request_rec *r&#41;;
 
-void modperl_env_init&#40;void&#41;;
+void modperl_env_init&#40;pTHX&#41;;
 
-void modperl_env_unload&#40;void&#41;;
+void modperl_env_unload&#40;pTHX&#41;;
+
+MGVTBL MP_vtbl_envelem;
 
 #endif /* MODPERL_ENV_H */
 
diff --git a/src/modules/perl/modperl_perl.c b/src/modules/perl/modperl_perl.c
index dfe4d36..bda988c 100644
--- a/src/modules/perl/modperl_perl.c
+++ b/src/modules/perl/modperl_perl.c
@@ -181,6 +181,8 @@ void modperl_perl_destruct&#40;PerlInterpreter *perl&#41;
         }
     }
 
+    modperl_env_unload&#40;perl&#41;;
+
     perl_destruct&#40;perl&#41;;
 
     /* XXX: big bug in 5.6.1 fixed in 5.7.2+
diff --git a/t/response/TestModperl/env.pm b/t/response/TestModperl/env.pm
index 62eac81..ac057a9 100644
--- a/t/response/TestModperl/env.pm
+++ b/t/response/TestModperl/env.pm
@@ -15,7 +15,7 @@ use Apache2::Const -compile =&gt; &#39;OK&#39;;
 sub handler {
     my $r = shift;
 
-    plan $r, tests =&gt; 23 + keys&#40;%ENV&#41;;
+    plan $r, tests =&gt; 23 + 3 * keys&#40;%ENV&#41;;
 
     my $env = $r-&gt;subprocess_env;
 
@@ -75,6 +75,8 @@ sub handler {
     for my $key &#40;sort keys %ENV&#41; {
         eval { delete $ENV{$key}; };
         ok t_cmp&#40;$@, &#39;&#39;, $key&#41;;
+        ok t_cmp&#40;$ENV{$key}, undef, &#34;ENV{$key} is empty&#34;&#41;;
+        ok t_cmp&#40;$env-&gt;get&#40;$key&#41;, undef, &#34;subprocess_env&#40;$key&#41; is empty&#34;&#41;;
     }
 
     Apache2::Const::OK;
-- 
2.6.2

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;24&nbsp;08:16:32&nbsp;2015</span>
    <span class="description">steve.m.hay [...] googlemail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Steve Hay &lt;shay [...] cpan.org&gt;, PLICEASE [...] cpan.org, abe+cpan [...] deuxchevaux.org,  dam [...] cpan.org, dom [...] cpan.org, ether [...] cpan.org, gregoa [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101962] modperl_env_init&#40;&#41; needs changing for perl &gt;= 5.21.8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 24 Nov 2015 13:16:16 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-mod_perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steve Hay &lt;steve.m.hay [...] googlemail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 22 November 2015 at 22:50, ntyni@iki.fi via RT
&lt;bug-mod_perl@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101962">https://rt.cpan.org/Ticket/Display.html?id=101962</a></span> &gt;
&gt;
&gt; On Wed Oct 28 18:49:31 2015, ntyni@iki.fi wrote:
&gt;
<div class="message-stanza open">&gt;&gt; - running t/modperl/env.t and t/modules/cgi.t in the same run makes
&gt;&gt; the latter fail because $ENV{MOD_PERL} is not set
</div>&gt;
&gt; I seem to have found the cause for this: existing %ENV elements needed their envelem vtable fixed too, otherwise modifying them wouldn&#39;t reflect in subprocess_env.
&gt;
&gt; I&#39;m attaching an updated patch. This passes all tests for me on both 5.20 and 5.22, but I&#39;m sure there are still wrinkles to iron out. Anyway, it&#39;s progress.
&gt;
&gt; Steve: in particular, I&#39;m not seeing the setupenv2.t failures you mentioned. Do they still fail with this?
&gt;
&gt; See the commit message for remaining concerns. Eyeballs would be very welcome.
&gt;
</div>
Sorry for being slow responding to this. This is great news! -- With
this patch I have exactly the same set of failures as without the
patch using perl-5.20.x &#40;which I think are all Windows-specific&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;24&nbsp;08:21:14&nbsp;2015</span>
    <span class="description">steve.m.hay [...] googlemail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Steve Hay &lt;shay [...] cpan.org&gt;, PLICEASE [...] cpan.org, abe+cpan [...] deuxchevaux.org,  dam [...] cpan.org, dom [...] cpan.org, ether [...] cpan.org, gregoa [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101962] modperl_env_init&#40;&#41; needs changing for perl &gt;= 5.21.8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 24 Nov 2015 13:21:00 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-mod_perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steve Hay &lt;steve.m.hay [...] googlemail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 23 November 2015 at 21:06, ntyni@iki.fi via RT
&lt;bug-mod_perl@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101962">https://rt.cpan.org/Ticket/Display.html?id=101962</a></span> &gt;
&gt;
&gt; On Sun Nov 22 17:50:22 2015, ntyni@iki.fi wrote:
&gt;
<div class="message-stanza open">&gt;&gt; I&#39;m attaching an updated patch. This passes all tests for me on both
&gt;&gt; 5.20 and 5.22, but I&#39;m sure there are still wrinkles to iron out.
</div>&gt;
&gt; Here&#39;s another version, based on Steve&#39;s env2.patch and using sv_magicext&#40;&#41; where applicable to get our own vtables in. It&#39;s somewhat cleaner and still passes all the tests for me.
&gt;
&gt; I&#39;ve merged the envelem vtable fixup into the modperl_envelem_tie macro, but had to make MP_vtbl_envelem global for that. I&#39;m sure there&#39;s a better way.
</div>
I liked this version better, despite the MP_vtbl_envelem being global
&#40;the Perl equivalent is global anyway, of course&#41;, but unfortunately
it&#39;s not working for me: I deleted two errant StructCopy&#40;&#41; calls from
the start of modperl_env_init&#40;&#41; which were accidentally left behind,
but httpd is crashing on startup :-&#40;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;24&nbsp;08:38:44&nbsp;2015</span>
    <span class="description">ntyni [...] iki.fi -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ntyni [...] iki.fi</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Nov 24 08:21:14 2015, steve.m.hay@googlemail.com wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I liked this version better, despite the MP_vtbl_envelem being global
&gt; &#40;the Perl equivalent is global anyway, of course&#41;, but unfortunately
&gt; it&#39;s not working for me: I deleted two errant StructCopy&#40;&#41; calls from
&gt; the start of modperl_env_init&#40;&#41; which were accidentally left behind,
&gt; but httpd is crashing on startup :-&#40;
</div>
Hm, I think I restored MP_PERL_vtbl_env and MP_PERL_vtbl_envelem initialization on purpose, as they are used by the MP_PL_vtbl_call&#40;&#41; invocations.

But I guess you had problems already before re-deleting those?

-- 
Niko
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;24&nbsp;08:41:27&nbsp;2015</span>
    <span class="description">steve.m.hay [...] googlemail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101962] modperl_env_init&#40;&#41; needs changing for perl &gt;= 5.21.8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 24 Nov 2015 13:41:18 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-mod_perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steve Hay &lt;steve.m.hay [...] googlemail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 24 November 2015 at 13:38, ntyni@iki.fi via RT
&lt;bug-mod_perl@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: mod_perl
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101962">https://rt.cpan.org/Ticket/Display.html?id=101962</a></span> &gt;
&gt;
&gt; On Tue Nov 24 08:21:14 2015, steve.m.hay@googlemail.com wrote:
&gt;
<div class="message-stanza open">&gt;&gt; I liked this version better, despite the MP_vtbl_envelem being global
&gt;&gt; &#40;the Perl equivalent is global anyway, of course&#41;, but unfortunately
&gt;&gt; it&#39;s not working for me: I deleted two errant StructCopy&#40;&#41; calls from
&gt;&gt; the start of modperl_env_init&#40;&#41; which were accidentally left behind,
&gt;&gt; but httpd is crashing on startup :-&#40;
</div>&gt;
&gt; Hm, I think I restored MP_PERL_vtbl_env and MP_PERL_vtbl_envelem initialization on purpose, as they are used by the MP_PL_vtbl_call&#40;&#41; invocations.
&gt;
&gt; But I guess you had problems already before re-deleting those?
&gt;
</div>
Ah! I hadn&#39;t realized that. I will put them back and fix the problem
that I had by other means -- it was simply that the build failed due
to mg being declared after them. &#40;VC++ doesn&#39;t allow mixed code and
declarations.&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;24&nbsp;08:51:18&nbsp;2015</span>
    <span class="description">steve.m.hay [...] googlemail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101962] modperl_env_init&#40;&#41; needs changing for perl &gt;= 5.21.8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 24 Nov 2015 13:51:03 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-mod_perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steve Hay &lt;steve.m.hay [...] googlemail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 24 November 2015 at 13:41, Steve Hay &lt;steve.m.hay@googlemail.com&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 24 November 2015 at 13:38, ntyni@iki.fi via RT
&gt; &lt;bug-mod_perl@rt.cpan.org&gt; wrote:
<div class="message-stanza open">&gt;&gt;        Queue: mod_perl
&gt;&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101962">https://rt.cpan.org/Ticket/Display.html?id=101962</a></span> &gt;
&gt;&gt;
&gt;&gt; On Tue Nov 24 08:21:14 2015, steve.m.hay@googlemail.com wrote:
&gt;&gt;
<div class="message-stanza open">&gt;&gt;&gt; I liked this version better, despite the MP_vtbl_envelem being global
&gt;&gt;&gt; &#40;the Perl equivalent is global anyway, of course&#41;, but unfortunately
&gt;&gt;&gt; it&#39;s not working for me: I deleted two errant StructCopy&#40;&#41; calls from
&gt;&gt;&gt; the start of modperl_env_init&#40;&#41; which were accidentally left behind,
&gt;&gt;&gt; but httpd is crashing on startup :-&#40;
</div>&gt;&gt;
&gt;&gt; Hm, I think I restored MP_PERL_vtbl_env and MP_PERL_vtbl_envelem initialization on purpose, as they are used by the MP_PL_vtbl_call&#40;&#41; invocations.
&gt;&gt;
&gt;&gt; But I guess you had problems already before re-deleting those?
&gt;&gt;
</div>&gt;
&gt; Ah! I hadn&#39;t realized that. I will put them back and fix the problem
&gt; that I had by other means -- it was simply that the build failed due
&gt; to mg being declared after them. &#40;VC++ doesn&#39;t allow mixed code and
&gt; declarations.&#41;
</div>
Although we still shouldn&#39;t be needing to make copies of the original
Perl vtables now that we aren&#39;t changing them anyway! MP_PL_vtbl_call
should surely just be using PL_vtbl_env* directly instead of
MP_PERL_vtbl_env*?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;24&nbsp;08:58:41&nbsp;2015</span>
    <span class="description">ntyni [...] iki.fi -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ntyni [...] iki.fi</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Nov 24 08:51:18 2015, steve.m.hay@googlemail.com wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Although we still shouldn&#39;t be needing to make copies of the original
&gt; Perl vtables now that we aren&#39;t changing them anyway! MP_PL_vtbl_call
&gt; should surely just be using PL_vtbl_env* directly instead of
&gt; MP_PERL_vtbl_env*?
</div>
Heh, good point. I&#39;m sure you&#39;re right :&#41;
-- 
Niko
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;24&nbsp;09:11:41&nbsp;2015</span>
    <span class="description">steve.m.hay [...] googlemail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101962] modperl_env_init&#40;&#41; needs changing for perl &gt;= 5.21.8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 24 Nov 2015 14:11:29 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-mod_perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steve Hay &lt;steve.m.hay [...] googlemail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 24 November 2015 at 13:58, ntyni@iki.fi via RT
&lt;bug-mod_perl@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: mod_perl
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101962">https://rt.cpan.org/Ticket/Display.html?id=101962</a></span> &gt;
&gt;
&gt; On Tue Nov 24 08:51:18 2015, steve.m.hay@googlemail.com wrote:
&gt;
<div class="message-stanza open">&gt;&gt; Although we still shouldn&#39;t be needing to make copies of the original
&gt;&gt; Perl vtables now that we aren&#39;t changing them anyway! MP_PL_vtbl_call
&gt;&gt; should surely just be using PL_vtbl_env* directly instead of
&gt;&gt; MP_PERL_vtbl_env*?
</div>&gt;
&gt; Heh, good point. I&#39;m sure you&#39;re right :&#41;
</div>
All tests &#40;bar the sadly now usual Windows failures&#41; successful with
the attached slight variation of your take 3 patch.

I will look to tidy this up and get it committed and then get the ball
rolling on 2.0.10 :-&#41;

Thank you for your work on this!
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;24&nbsp;12:40:17&nbsp;2015</span>
    <span class="description">pgollucci [...] p6m7g8.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101962] modperl_env_init&#40;&#41; needs changing for perl &gt;= 5.21.8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 24 Nov 2015 12:40:00 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-mod_perl [...] rt.cpan.org&#34; &lt;bug-mod_perl [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Philip M. Gollucci&#34; &lt;pgollucci [...] p6m7g8.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks guys.  I agree.  Wish I had more time!

On Tuesday, November 24, 2015, steve.m.hay@googlemail.com via RT &lt;
bug-mod_perl@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: mod_perl
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101962">https://rt.cpan.org/Ticket/Display.html?id=101962</a></span> &gt;
&gt;
&gt; On 24 November 2015 at 13:58, ntyni@iki.fi &lt;javascript:;&gt; via RT
&gt; &lt;bug-mod_perl@rt.cpan.org &lt;javascript:;&gt;&gt; wrote:
<div class="message-stanza open">&gt; &gt;        Queue: mod_perl
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101962">https://rt.cpan.org/Ticket/Display.html?id=101962</a></span> &gt;
&gt; &gt;
&gt; &gt; On Tue Nov 24 08:51:18 2015, steve.m.hay@googlemail.com &lt;javascript:;&gt;
</div>&gt; wrote:
<div class="message-stanza open">&gt; &gt;
<div class="message-stanza open">&gt; &gt;&gt; Although we still shouldn&#39;t be needing to make copies of the original
&gt; &gt;&gt; Perl vtables now that we aren&#39;t changing them anyway! MP_PL_vtbl_call
&gt; &gt;&gt; should surely just be using PL_vtbl_env* directly instead of
&gt; &gt;&gt; MP_PERL_vtbl_env*?
</div>&gt; &gt;
&gt; &gt; Heh, good point. I&#39;m sure you&#39;re right :&#41;
</div>&gt;
&gt; All tests &#40;bar the sadly now usual Windows failures&#41; successful with
&gt; the attached slight variation of your take 3 patch.
&gt;
&gt; I will look to tidy this up and get it committed and then get the ball
&gt; rolling on 2.0.10 :-&#41;
&gt;
&gt; Thank you for your work on this!
&gt;
&gt;
</div>
-- 
---------------------------------------------------------------------------------
Curb: Your ride is here
4096R/D21D2752
&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://pgp.mit.edu/pks/lookup?op=get&#38;search=0xF699A450D21D2752">http://pgp.mit.edu/pks/lookup?op=get&#38;search=0xF699A450D21D2752</a></span>&gt; ECDF B597
B54B 7F92 753E  E0EA F699 A450 D21D 2752
Philip M. Gollucci &#40;pgollucci@p6m7g8.com&#41; c: 703.336.9354
Member,                           Apache Software Foundation
Committer,                        FreeBSD Foundation
Consultant,                       P6M7G8 Inc.
Sr. Director IT Operations,       Curb

What doesn&#39;t kill us can only make us stronger;
Except it almost kills you.
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;01&nbsp;12:46:46&nbsp;2015</span>
    <span class="description">shay [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Nov 24 09:11:41 2015, steve.m.hay@googlemail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 24 November 2015 at 13:58, ntyni@iki.fi via RT
&gt; &lt;bug-mod_perl@rt.cpan.org&gt; wrote:
<div class="message-stanza open">&gt; &gt;        Queue: mod_perl
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101962">https://rt.cpan.org/Ticket/Display.html?id=101962</a></span> &gt;
&gt; &gt;
&gt; &gt; On Tue Nov 24 08:51:18 2015, steve.m.hay@googlemail.com wrote:
&gt; &gt;
<div class="message-stanza open">&gt; &gt;&gt; Although we still shouldn&#39;t be needing to make copies of the original
&gt; &gt;&gt; Perl vtables now that we aren&#39;t changing them anyway! MP_PL_vtbl_call
&gt; &gt;&gt; should surely just be using PL_vtbl_env* directly instead of
&gt; &gt;&gt; MP_PERL_vtbl_env*?
</div>&gt; &gt;
&gt; &gt; Heh, good point. I&#39;m sure you&#39;re right :&#41;
</div>&gt; 
&gt; All tests &#40;bar the sadly now usual Windows failures&#41; successful with
&gt; the attached slight variation of your take 3 patch.
&gt; 
&gt; I will look to tidy this up and get it committed and then get the ball
&gt; rolling on 2.0.10 :-&#41;
&gt; 
&gt; Thank you for your work on this!
</div>

Now committed with minor tweaks in rev. 1717474.

One point that I wasn&#39;t entirely clear about: Why is the modperl_env_init&#40;&#41; call required before modperl_env_untie&#40;&#41; in modperl_env_table_populate&#40;&#41;? Things break without it, but I&#39;m not totally clear about what&#39;s happening there. There are other calls to modperl_env_untie&#40;&#41; too... Do any of them similarly need a modperl_env_init&#40;&#41; call beforehand? I can see how modperl_env_clear&#40;&#41; and modperl_env_table_unpopulate&#40;&#41; are rather different, but I do wonder if modperl_env_default_populate&#40;&#41; needs a modperl_env_init&#40;&#41; call too?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;02&nbsp;10:22:16&nbsp;2015</span>
    <span class="description">ntyni [...] iki.fi -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ntyni [...] iki.fi</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 01 12:46:46 2015, SHAY wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Now committed with minor tweaks in rev. 1717474.
</div>
Thanks!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; One point that I wasn&#39;t entirely clear about: Why is the
&gt; modperl_env_init&#40;&#41; call required before modperl_env_untie&#40;&#41; in
&gt; modperl_env_table_populate&#40;&#41;? Things break without it, but I&#39;m not
&gt; totally clear about what&#39;s happening there. There are other calls to
&gt; modperl_env_untie&#40;&#41; too... Do any of them similarly need a
&gt; modperl_env_init&#40;&#41; call beforehand? I can see how modperl_env_clear&#40;&#41;
&gt; and modperl_env_table_unpopulate&#40;&#41; are rather different, but I do
&gt; wonder if modperl_env_default_populate&#40;&#41; needs a modperl_env_init&#40;&#41;
&gt; call too?
</div>
I think I just put it there because it made the test suite crashes go away :&#41; I agree that part needs attention.

Looks like moving it to modperl_env_request_populate&#40;&#41; works 
just as well wrt. the test suite, but that&#39;s as far as I got.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;15:35:35&nbsp;2016</span>
    <span class="description">MAT [...] cpan.fsck.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Le Mar 01 Déc 2015 18:46:46, SHAY a écrit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Nov 24 09:11:41 2015, steve.m.hay@googlemail.com wrote:
<div class="message-stanza open">&gt; &gt; On 24 November 2015 at 13:58, ntyni@iki.fi via RT
&gt; &gt; &lt;bug-mod_perl@rt.cpan.org&gt; wrote:
<div class="message-stanza open">&gt; &gt; &gt; Queue: mod_perl
&gt; &gt; &gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101962">https://rt.cpan.org/Ticket/Display.html?id=101962</a></span> &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; On Tue Nov 24 08:51:18 2015, steve.m.hay@googlemail.com wrote:
&gt; &gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt;&gt; Although we still shouldn&#39;t be needing to make copies of the
&gt; &gt; &gt;&gt; original
&gt; &gt; &gt;&gt; Perl vtables now that we aren&#39;t changing them anyway!
&gt; &gt; &gt;&gt; MP_PL_vtbl_call
&gt; &gt; &gt;&gt; should surely just be using PL_vtbl_env* directly instead of
&gt; &gt; &gt;&gt; MP_PERL_vtbl_env*?
</div>&gt; &gt; &gt;
&gt; &gt; &gt; Heh, good point. I&#39;m sure you&#39;re right :&#41;
</div>&gt; &gt;
&gt; &gt; All tests &#40;bar the sadly now usual Windows failures&#41; successful with
&gt; &gt; the attached slight variation of your take 3 patch.
&gt; &gt;
&gt; &gt; I will look to tidy this up and get it committed and then get the
&gt; &gt; ball
&gt; &gt; rolling on 2.0.10 :-&#41;
&gt; &gt;
&gt; &gt; Thank you for your work on this!
</div>&gt; 
&gt; 
&gt; Now committed with minor tweaks in rev. 1717474.
&gt; 
&gt; One point that I wasn&#39;t entirely clear about: Why is the
&gt; modperl_env_init&#40;&#41; call required before modperl_env_untie&#40;&#41; in
&gt; modperl_env_table_populate&#40;&#41;? Things break without it, but I&#39;m not
&gt; totally clear about what&#39;s happening there. There are other calls to
&gt; modperl_env_untie&#40;&#41; too... Do any of them similarly need a
&gt; modperl_env_init&#40;&#41; call beforehand? I can see how modperl_env_clear&#40;&#41;
&gt; and modperl_env_table_unpopulate&#40;&#41; are rather different, but I do
&gt; wonder if modperl_env_default_populate&#40;&#41; needs a modperl_env_init&#40;&#41;
&gt; call too?
</div>

Has there been some headway made in this regard ? Perl 5.24 is only a couple of months away...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;18:57:23&nbsp;2016</span>
    <span class="description">pgollucci [...] p6m7g8.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101962] modperl_env_init&#40;&#41; needs changing for perl &gt;= 5.21.8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 2 Mar 2016 18:57:02 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-mod_perl [...] rt.cpan.org&#34; &lt;bug-mod_perl [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Philip M. Gollucci&#34; &lt;pgollucci [...] p6m7g8.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Etime.

On Wednesday, March 2, 2016, Mathieu Arnold via RT &lt;bug-mod_perl@rt.cpan.org&gt;
wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: mod_perl
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101962">https://rt.cpan.org/Ticket/Display.html?id=101962</a></span> &gt;
&gt;
&gt; Le Mar 01 Déc 2015 18:46:46, SHAY a écrit :
<div class="message-stanza open">&gt; &gt; On Tue Nov 24 09:11:41 2015, steve.m.hay@googlemail.com &lt;javascript:;&gt;
</div>&gt; wrote:
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; On 24 November 2015 at 13:58, ntyni@iki.fi &lt;javascript:;&gt; via RT
&gt; &gt; &gt; &lt;bug-mod_perl@rt.cpan.org &lt;javascript:;&gt;&gt; wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; Queue: mod_perl
&gt; &gt; &gt; &gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101962">https://rt.cpan.org/Ticket/Display.html?id=101962</a></span> &gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; On Tue Nov 24 08:51:18 2015, steve.m.hay@googlemail.com
</div></div></div>&gt; &lt;javascript:;&gt; wrote:
<div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; &gt;&gt; Although we still shouldn&#39;t be needing to make copies of the
&gt; &gt; &gt; &gt;&gt; original
&gt; &gt; &gt; &gt;&gt; Perl vtables now that we aren&#39;t changing them anyway!
&gt; &gt; &gt; &gt;&gt; MP_PL_vtbl_call
&gt; &gt; &gt; &gt;&gt; should surely just be using PL_vtbl_env* directly instead of
&gt; &gt; &gt; &gt;&gt; MP_PERL_vtbl_env*?
</div>&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Heh, good point. I&#39;m sure you&#39;re right :&#41;
</div>&gt; &gt; &gt;
&gt; &gt; &gt; All tests &#40;bar the sadly now usual Windows failures&#41; successful with
&gt; &gt; &gt; the attached slight variation of your take 3 patch.
&gt; &gt; &gt;
&gt; &gt; &gt; I will look to tidy this up and get it committed and then get the
&gt; &gt; &gt; ball
&gt; &gt; &gt; rolling on 2.0.10 :-&#41;
&gt; &gt; &gt;
&gt; &gt; &gt; Thank you for your work on this!
</div>&gt; &gt;
&gt; &gt;
&gt; &gt; Now committed with minor tweaks in rev. 1717474.
&gt; &gt;
&gt; &gt; One point that I wasn&#39;t entirely clear about: Why is the
&gt; &gt; modperl_env_init&#40;&#41; call required before modperl_env_untie&#40;&#41; in
&gt; &gt; modperl_env_table_populate&#40;&#41;? Things break without it, but I&#39;m not
&gt; &gt; totally clear about what&#39;s happening there. There are other calls to
&gt; &gt; modperl_env_untie&#40;&#41; too... Do any of them similarly need a
&gt; &gt; modperl_env_init&#40;&#41; call beforehand? I can see how modperl_env_clear&#40;&#41;
&gt; &gt; and modperl_env_table_unpopulate&#40;&#41; are rather different, but I do
&gt; &gt; wonder if modperl_env_default_populate&#40;&#41; needs a modperl_env_init&#40;&#41;
&gt; &gt; call too?
</div>&gt;
&gt;
&gt; Has there been some headway made in this regard ? Perl 5.24 is only a
&gt; couple of months away...
&gt;
</div>

-- 
---------------------------------------------------------------------------------
4096R/D21D2752
&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://pgp.mit.edu/pks/lookup?op=get&#38;search=0xF699A450D21D2752">http://pgp.mit.edu/pks/lookup?op=get&#38;search=0xF699A450D21D2752</a></span>&gt; ECDF B597
B54B 7F92 753E  E0EA F699 A450 D21D 2752
Philip M. Gollucci &#40;pgollucci@p6m7g8.com&#41; c: 703.336.9354
Member,                           Apache Software Foundation
Committer,                        FreeBSD Foundation
Consultant,                       P6M7G8 Inc.
Director Cloud Technology,        Capital One

What doesn&#39;t kill us can only make us stronger;
Except it almost kills you.
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;27&nbsp;10:29:23&nbsp;2016</span>
    <span class="description">exodist7 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I hear that a patch for this has been in git for a while now. Would it be possible to get a release of this soon? At $work we are blocked from upgrading our perl simply because of mod_perl.

Thanks for maintaining this and keeping things running!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;27&nbsp;12:43:15&nbsp;2016</span>
    <span class="description">shay [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jun 27 10:29:23 2016, EXODIST wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I hear that a patch for this has been in git for a while now. Would it
&gt; be possible to get a release of this soon? At $work we are blocked
&gt; from upgrading our perl simply because of mod_perl.
&gt; 
&gt; Thanks for maintaining this and keeping things running!
</div>
Yes, it&#39;s tentatively fixed in SVN. Ideally it could do with more eyes to verify its correctness, but it&#39;s been a while now with no further comments on this ticket and in the meantime I believe Debian &#40;at least&#41; have started shipping the current SVN... I&#39;ve not &#40;yet&#41; heard of any problems reported there, so maybe it&#39;s time to make a new release. I will try to make that happen soon.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;27&nbsp;13:22:45&nbsp;2016</span>
    <span class="description">exodist7 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jun 27 09:43:15 2016, SHAY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Jun 27 10:29:23 2016, EXODIST wrote:
<div class="message-stanza open">&gt; &gt; I hear that a patch for this has been in git for a while now. Would
&gt; &gt; it
&gt; &gt; be possible to get a release of this soon? At $work we are blocked
&gt; &gt; from upgrading our perl simply because of mod_perl.
&gt; &gt;
&gt; &gt; Thanks for maintaining this and keeping things running!
</div>&gt; 
&gt; Yes, it&#39;s tentatively fixed in SVN. Ideally it could do with more eyes
&gt; to verify its correctness, but it&#39;s been a while now with no further
&gt; comments on this ticket and in the meantime I believe Debian &#40;at
&gt; least&#41; have started shipping the current SVN... I&#39;ve not &#40;yet&#41; heard
&gt; of any problems reported there, so maybe it&#39;s time to make a new
&gt; release. I will try to make that happen soon.
</div>
Thanks!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;28&nbsp;03:05:33&nbsp;2016</span>
    <span class="description">shay [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Now fixed in mod_perl-2.0.10.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;28&nbsp;03:05:35&nbsp;2016</span>
    <span class="description">shay [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;28&nbsp;03:05:35&nbsp;2016</span>
    <span class="description">shay [...] cpan.org -  Fixed in 2.0.10 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
