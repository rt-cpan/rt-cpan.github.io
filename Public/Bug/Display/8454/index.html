<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #8454 for POE-Component-Client-HTTP: POE::Component::Client::HTTP with compression</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #8454 for POE-Component-Client-HTTP: POE::Component::Client::HTTP with compression</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/POE-Component-Client-HTTP/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/POE-Component-Client-HTTP/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/POE-Component-Client-HTTP/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/POE-Component-Client-HTTP/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE-Component-Client-HTTP">POE-Component-Client-HTTP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">8454</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/POE-Component-Client-HTTP/Active/">POE-Component-Client-HTTP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
britzt [...] student.ethz.ch

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26420-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26421-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;16&nbsp;04:53:23&nbsp;2004</span>
    <span class="description">britzt [...] student.ethz.ch -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> POE::Component::Client::HTTP with compression</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Thibaut Britz &lt;britzt [...] student.ethz.ch&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> rcaputo [...] pobox.com</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 02 Nov 2004 16:29:44 +0100</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I added a few things to the latest version so that the module now also
supports compressed transfers. They are very handy because they save a
lot of bandwith. I also added it in the documentation.
The feature is disabled by default.

Thibaut
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;01&nbsp;06:46:49&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[britzt@student.ethz.ch - Tue Nov 16 04:53:23 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; I added a few things to the latest version so that the module now also
&gt; supports compressed transfers. They are very handy because they save a
&gt; lot of bandwith. I also added it in the documentation.
&gt; The feature is disabled by default.
&gt; 
&gt; Thibaut
&gt; 
</div>
the new version of HTTP::Message now has a decoded_content method which
does something similar, so the returned HTTP::Response object will also
have it.  Your version doesn&#39;t do error handling and Gisle&#39;s is too
harsh &#40;it dies&#41;.  both versions don&#39;t handle the &#39;compress&#39; method.  i&#39;d
personally do something like:

if &#40;$response-&gt;is_success and my $encoding = $Response-&gt;content_encoding&#41;
{
  my $content = $response-&gt;content;

  if &#40;$encoding =~ /gzip/i&#41;
  {
    $content = Compress::Zlib::memGunzip&#40;\$content&#41;;
  }
  elsif &#40;$encoding =~ /deflate/i&#41;
  {
    if &#40;my $i = Compress::Zlib::inflateInit&#41;
    {
      $content = $i-&gt;inflate&#40;\$content&#41;
    }
    else { $content = undef; }
  }
  elsif &#40;$encoding =~ /compress/i&#41;
  {
    $content = Compress::Zlib::uncompress&#40;\$content&#41;;
  }

  ## if decompression fails &#40;and it does sometimes&#41; ...
  unless &#40;defined $content&#41;
  {
    ## Reissue request without accept-encoding
  }
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;01&nbsp;08:19:47&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Thibaut</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [britzt@student.ethz.ch - Tue Nov 16 04:53:23 2004]:
&gt; 
<div class="message-stanza open">&gt; &gt; Hi,
&gt; &gt;
&gt; &gt; I added a few things to the latest version so that the module now
</div>&gt; also
<div class="message-stanza open">&gt; &gt; supports compressed transfers. They are very handy because they save
</div>&gt; a
<div class="message-stanza open">&gt; &gt; lot of bandwith. I also added it in the documentation.
&gt; &gt; The feature is disabled by default.
&gt; &gt;
&gt; &gt; Thibaut
&gt; &gt;
</div>&gt; 
&gt; the new version of HTTP::Message now has a decoded_content method
&gt; which
&gt; does something similar, so the returned HTTP::Response object will
&gt; also
&gt; have it.  Your version doesn&#39;t do error handling and Gisle&#39;s is too
&gt; harsh &#40;it dies&#41;.  both versions don&#39;t handle the &#39;compress&#39; method.
&gt; i&#39;d
&gt; personally do something like:
&gt; 
&gt; if &#40;$response-&gt;is_success and my $encoding = $Response-
<div class="message-stanza open">&gt; &gt;content_encoding&#41;
</div>&gt; {
&gt;   my $content = $response-&gt;content;
&gt; 
&gt;   if &#40;$encoding =~ /gzip/i&#41;
&gt;   {
&gt;     $content = Compress::Zlib::memGunzip&#40;\$content&#41;;
&gt;   }
&gt;   elsif &#40;$encoding =~ /deflate/i&#41;
&gt;   {
&gt;     if &#40;my $i = Compress::Zlib::inflateInit&#41;
&gt;     {
&gt;       $content = $i-&gt;inflate&#40;\$content&#41;
&gt;     }
&gt;     else { $content = undef; }
&gt;   }
&gt;   elsif &#40;$encoding =~ /compress/i&#41;
&gt;   {
&gt;     $content = Compress::Zlib::uncompress&#40;\$content&#41;;
&gt;   }
&gt; 
&gt;   ## if decompression fails &#40;and it does sometimes&#41; ...
&gt;   unless &#40;defined $content&#41;
&gt;   {
&gt;     ## Reissue request without accept-encoding
&gt;   }
&gt; }
</div>
Yes, that would be better.

I just assumed that the server would only send back compressed data if
the client requested it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;01&nbsp;15:07:37&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Wed Dec  1 08:19:47 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Yes, that would be better.
&gt; 
&gt; I just assumed that the server would only send back compressed data if
&gt; the client requested it.
</div>
you are correct, the client must request it first.  but the server may
incorrectly compress it &#40;bad data, sending encoding tag without actually
compressing it, etc.&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;26&nbsp;17:00:40&nbsp;2005</span>
    <span class="description">martijn [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Could you attach a diff between 0.65 and your new version, so we can
look at what you did without having to do this ourselves? Please
make sure it is a unified format diff &#40;diff -u&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;23&nbsp;23:48:33&nbsp;2006</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Apr 26 17:00:40 2005, MARTIJN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Could you attach a diff between 0.65 and your new version, so we can
&gt; look at what you did without having to do this ourselves? Please
&gt; make sure it is a unified format diff &#40;diff -u&#41;
</div>
I checked out 0.65 and built the diff.  My day&#39;s winding down, so I&#39;m
just attaching it here rather than figure out where the code should go.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- POE-Component-Client-HTTP-0.65-orig/HTTP.pm	2006-03-23 23:32:54.000000000 -0500
+++ POE-Component-Client-HTTP-0.66/HTTP.pm	2004-11-02 10:23:08.000000000 -0500
@@ -1,4 +1,4 @@
-# $Id: HTTP.pm 114 2004-10-02 15:37:11Z rcaputo $
+# $Id: HTTP.pm,v 1.58 2004/10/02 15:37:11 rcaputo Exp $
 # License and documentation are after __END__.
 
 package POE::Component::Client::HTTP;
@@ -9,7 +9,7 @@
 sub DEBUG_DATA &#40;&#41; { 0 }
 
 use vars qw&#40;$VERSION&#41;;
-$VERSION = &#39;0.65&#39;;
+$VERSION = &#39;0.66&#39;;
 
 use Carp qw&#40;croak&#41;;
 use POSIX;
@@ -95,6 +95,17 @@
   eval &#34;sub HAS_SSL &#40;&#41; { $has_ssl }&#34;;
 }
 
+
+# Bring in gzip/deflate support
+BEGIN {
+  my $has_gzip = 0;
+  eval { require Compress::Zlib;
+        $has_gzip=1;
+        };
+  
+  eval &#34;sub HAS_GZIP &#40;&#41; { $has_gzip }&#34;;
+}
+
 #------------------------------------------------------------------------------
 # Spawn a new PoCo::Client::HTTP session.  This basically is a
 # constructor, but it isn&#39;t named &#34;new&#34; because it doesn&#39;t create a
@@ -152,7 +163,8 @@
   my $no_proxy   = delete $params{NoProxy};
   my $proxy      = delete $params{Proxy};
   my $frmax      = delete $params{FollowRedirects};
-
+  my $compression = delete $params{UseCompression};
+  
   # Process HTTP_PROXY and NO_PROXY environment variables.
 
   $proxy    = $ENV{HTTP_PROXY} || $ENV{http_proxy} unless defined $proxy;
@@ -225,6 +237,7 @@
       protocol    =&gt; $protocol,
       max_size    =&gt; $max_size,
       streaming   =&gt; $streaming,
+      compression =&gt; $compression,
     },
   &#41;;
 
@@ -343,7 +356,13 @@
         and length $http_request-&gt;from
       &#41;;
   }
-
+  
+  #Add a Accept-Encoding header to get gzipped content if available
+  if &#40;defined $heap-&gt;{compression}&#41;
+    {
+    $http_request-&gt;header&#40;&#34;Accept-Encoding&#34; =&gt; &#34;gzip,deflate&#34;&#41;;  
+    }
+  
   # Create a progress postback if requested.
   my $progress_postback;
   $progress_postback = $sender-&gt;postback&#40;$progress_event, $http_request, $tag&#41;
@@ -1173,6 +1192,16 @@
       }
     }
   }
+  
+  # Check if data is compressed and decompress it.
+  if &#40;HAS_GZIP and $response-&gt;header&#40;&#39;Content-Encoding&#39;&#41; =~m/gzip/io&#41;
+        {
+        $response-&gt;content&#40;Compress::Zlib::memGunzip&#40;$response-&gt;content&#40;&#41;&#41;&#41;;
+        }
+  elsif &#40;HAS_GZIP and $response-&gt;header&#40;&#39;Content-Encoding&#39;&#41; =~m/deflate/io&#41;
+        {
+        $response-&gt;content&#40;Compress::Zlib::uncompress&#40;$response-&gt;content&#40;&#41;&#41;&#41;;
+        }
   $request-&gt;[REQ_POSTBACK]-&gt;&#40;$response&#41;;
 }
 
@@ -1382,6 +1411,12 @@
 C&lt;Timeout&gt; specifies the amount of time a HTTP request will wait for
 an answer.  This defaults to 180 seconds &#40;three minutes&#41;.
 
+=item UseCompression =&gt; 1
+
+C&lt;UseCompression&gt; specifies if we request compressed answers if the
+server supports it. Default is disabled.
+
+
 =back
 
 Sessions communicate asynchronously with PoCo::Client::HTTP.  They
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;23&nbsp;23:48:35&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;16&nbsp;16:13:00&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> guest</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Mar 23 23:48:33 2006, RCAPUTO wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Apr 26 17:00:40 2005, MARTIJN wrote:
<div class="message-stanza open">&gt; &gt; Could you attach a diff between 0.65 and your new version, so we can
&gt; &gt; look at what you did without having to do this ourselves? Please
&gt; &gt; make sure it is a unified format diff &#40;diff -u&#41;
</div>&gt; 
&gt; I checked out 0.65 and built the diff.  My day&#39;s winding down, so I&#39;m
&gt; just attaching it here rather than figure out where the code should go.
</div>
the logic from <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=8454#txn-116208">http://rt.cpan.org/Ticket/Display.html?id=8454#txn-116208</a></span>
seems better since it handles the &#39;compress&#39; encoding in addition to
&#39;gzip&#39; and &#39;deflate&#39;.  plus &#39;deflate&#39; is handled properly &#40;see below&#41;
and the request is retried without compression if there&#39;s a compression
problem &#40;which i&#39;ve seen happen frequently&#41;.

&lt;rfc:2616&gt;
 gzip An encoding format produced by the file compression program &#34;gzip&#34;
&#40;GNU zip&#41; as described in RFC 1952 [25]. This format is a Lempel-Ziv
coding &#40;LZ77&#41; with a 32 bit CRC.

compress The encoding format produced by the common UNIX file
compression program &#34;compress&#34;. This format is an adaptive
Lempel-Ziv-Welch coding &#40;LZW&#41;.

        Use of program names for the identification of encoding formats
        is not desirable and is discouraged for future encodings. Their
        use here is representative of historical practice, not good
        design. For compatibility with previous implementations of HTTP,
        applications SHOULD consider &#34;x-gzip&#34; and &#34;x-compress&#34; to be
        equivalent to &#34;gzip&#34; and &#34;compress&#34; respectively.

deflate The &#34;zlib&#34; format defined in RFC 1950 [31] in combination with
the &#34;deflate&#34; compression mechanism described in RFC 1951 [29].
&lt;/rfc:2616&gt;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;21&nbsp;18:01:20&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">this needs to be implemented as a Filter so it works with &#39;Streaming&#39;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;19&nbsp;01:00:28&nbsp;2006</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve committed preliminary support for filter-based HTTP compression,
but it&#39;s commented out.  This feature is stalled until I can find a
suitable Perl module for decompressing gzip streams.  We&#39;ll need a
POE::Filter module based on whatever turns up.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;23&nbsp;19:49:22&nbsp;2006</span>
    <span class="description">rdb [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">patch against current SVN and rocco&#39;s last work.

includes a test... but I think I forgot to add a SKIP block for clients
without Compress::Zlib installed.

short version: using a filter is a Bad Idea with Content-Encoding, IMO.
 My solution works.  Bug me about it on IRC if you like :&#41;
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -uwrN --exclude=&#39;*~&#39; --exclude=.svn poco-client-http/lib/POE/Component/Client/HTTP/RequestFactory.pm poco-client-http-gzip/lib/POE/Component/Client/HTTP/RequestFactory.pm
--- poco-client-http/lib/POE/Component/Client/HTTP/RequestFactory.pm	2006-10-23 15:59:52.000000000 -0700
+++ poco-client-http-gzip/lib/POE/Component/Client/HTTP/RequestFactory.pm	2006-10-23 16:33:34.000000000 -0700
@@ -429,4 +429,42 @@
   $_[1] = $proxy;
 }
 
+sub decode_content {
+    my &#40;$self, $response, $ce&#41; = @_;
+
+    if &#40;zlib_ok&#40;&#41; and $ce eq &#39;gzip&#39;&#41; {
+        my $content = $response-&gt;content;
+        my $decoded = Compress::Zlib::memGunzip&#40;$content&#41;;
+
+        if &#40;defined $decoded&#41; {
+            $response-&gt;content&#40;$decoded&#41;;
+        }
+    }
+
+}
+
+## stolen from libwww-perl lib/Net/HTTP/Methods.pm
+BEGIN {
+my $zlib_ok;
+
+sub zlib_ok {
+    return $zlib_ok if defined $zlib_ok;
+
+    # Try to load Compress::Zlib.
+    local $@;
+    local $SIG{__DIE__};
+    $zlib_ok = 0;
+
+    eval {
+	require Compress::Zlib;
+	Compress::Zlib-&gt;VERSION&#40;1.10&#41;;
+	$zlib_ok++;
+    };
+
+    return $zlib_ok;
+}
+
+} # BEGIN
+
+
 1;
diff -uwrN --exclude=&#39;*~&#39; --exclude=.svn poco-client-http/lib/POE/Component/Client/HTTP/Request.pm poco-client-http-gzip/lib/POE/Component/Client/HTTP/Request.pm
--- poco-client-http/lib/POE/Component/Client/HTTP/Request.pm	2006-10-23 15:59:52.000000000 -0700
+++ poco-client-http-gzip/lib/POE/Component/Client/HTTP/Request.pm	2006-10-23 16:30:16.000000000 -0700
@@ -167,6 +167,12 @@
   # if we are. that there&#39;s no ARG1 lets the client know we&#39;re done
   # with the content in the latter case
   if &#40;$self-&gt;[REQ_STATE] &#38; RS_DONE&#41; {
+
+    DEBUG and warn &#34;checking $response for content-encoding &#34;, $self-&gt;[REQ_ID];
+    if &#40;defined &#40;my $ce = $response-&gt;header&#40;&#39;content-encoding&#39;&#41;&#41;&#41; {
+        $self-&gt;[REQ_FACTORY]-&gt;decode_content&#40;$response, $ce&#41;;
+    }
+
     DEBUG and warn &#34;done; returning $response for &#34;, $self-&gt;[REQ_ID];
     $self-&gt;[REQ_POSTBACK]-&gt;&#40;$self-&gt;[REQ_RESPONSE]&#41;;
     $self-&gt;[REQ_STATE] |= RS_POSTED;
diff -uwrN --exclude=&#39;*~&#39; --exclude=.svn poco-client-http/lib/POE/Component/Client/HTTP.pm poco-client-http-gzip/lib/POE/Component/Client/HTTP.pm
--- poco-client-http/lib/POE/Component/Client/HTTP.pm	2006-10-23 15:59:55.000000000 -0700
+++ poco-client-http-gzip/lib/POE/Component/Client/HTTP.pm	2006-10-23 16:40:22.000000000 -0700
@@ -74,7 +74,17 @@
   &#34;,&#34;,
   grep { exists $te_filters{$_} }
   qw&#40;x-bzip2 gzip x-gzip deflate compress chunked identity&#41;
-&#41;;
+&#41; if 0;
+
+# The above defaults to &#39;chunked,identity&#39; which is technically
+# correct but arguably useless.  It also stomps on gzip&#39;d transport
+# because in the World Wild Web, Accept-Encoding is used to indicate
+# gzip readiness, but the server responds with &#39;Content-Encoding: gzip&#39;,
+# completely outside of TE encoding.
+#
+# FIXME: should zlib_ok&#40;&#41; be imported?
+$accept_encoding = &#39;gzip&#39;
+  if POE::Component::Client::HTTP::RequestFactory::zlib_ok&#40;&#41;;
 
 my %supported_schemes = &#40;
   http  =&gt; 1,
diff -uwrN --exclude=&#39;*~&#39; --exclude=.svn poco-client-http/t/58_gzipped_content.t poco-client-http-gzip/t/58_gzipped_content.t
--- poco-client-http/t/58_gzipped_content.t	1969-12-31 16:00:00.000000000 -0800
+++ poco-client-http-gzip/t/58_gzipped_content.t	2006-10-23 16:30:47.000000000 -0700
@@ -0,0 +1,177 @@
+#!/usr/bin/perl
+# $Id: 53_response_parser.t 242 2006-03-23 23:46:18Z rcaputo $
+# vim: filetype=perl
+
+# Generic response parser testing, especially for cases where
+# POE::Component::Client::HTTP generates the wrong response.
+
+use warnings;
+use strict;
+
+use IO::Socket::INET;
+use Socket &#39;$CRLF&#39;, &#39;$LF&#39;, &#39;$CR&#39;;
+use HTTP::Request::Common &#39;GET&#39;;
+
+sub DEBUG &#40;&#41; { 0 }
+
+# The number of tests must match scalar&#40;@tests&#41;.
+use Test::More tests =&gt; 1;
+
+use POE;
+use POE::Component::Client::HTTP;
+use POE::Component::Server::TCP;
+
+use Compress::Zlib;
+
+my $test_number = 0;
+
+my @server_ports;
+
+# A list of test responses, each paired with a subroutine to check
+# whether the response was parsed.
+# use YAML;
+
+my $original_content = &lt;&lt;DONE;
+&lt;html&gt;
+ &lt;head&gt;
+  &lt;title&gt;Sample Document&lt;/title&gt;
+ &lt;/head&gt;
+ &lt;body&gt;
+  Sample body content
+ &lt;/body&gt;
+&lt;/html&gt;
+DONE
+
+## content compression lifted from Apache::Dynagzip
+## this is functionally equivalent to mod_gzip, etc.
+## so we have a &#34;real-world&#34; piece of encoded content
+
+my $gzipped_content;
+
+GZIP: {
+    use constant MAGIC1	=&gt; 0x1f ;
+    use constant MAGIC2	=&gt; 0x8b ;
+    use constant OSCODE	=&gt; 3 ;
+    use constant MIN_HDR_SIZE =&gt; 10 ; # minimum gzip header size
+
+    # Create the first outgoing portion of the content:
+
+    my $gzipHeader = pack&#40;&#34;C&#34; . MIN_HDR_SIZE, MAGIC1, MAGIC2, Z_DEFLATED&#40;&#41;, 0,0,0,0,0,0, OSCODE&#41;;
+    $gzipped_content = $gzipHeader;
+
+    my $gzip_handler = deflateInit&#40; -Level      =&gt; Z_BEST_COMPRESSION&#40;&#41;,
+                                    -WindowBits =&gt; - MAX_WBITS&#40;&#41;,
+                                  &#41;;
+
+    $_ = $original_content;
+
+    my &#40;$out, $status&#41; = $gzip_handler-&gt;deflate&#40;\$_&#41;;
+    unless &#40;length&#40;$out&#41;&#41; {
+        &#40;$out, $status&#41; = $gzip_handler-&gt;flush&#40;&#41;;
+    }
+
+    $gzipped_content .= $out;
+
+    # same thing only shorter, but I wanted to go thru all the hoops:
+    if &#40;0&#41; {
+        $_ = $original_content;
+        $gzipped_content = Compress::Zlib::memGzip&#40;$_&#41;;
+    }
+
+}
+
+my @tests = &#40;
+             # Gzipped content decoded correctly.
+             [
+              &#40;
+               &#34;HTTP/1.1 200 OK$CRLF&#34; .
+               &#34;Connection: close$CRLF&#34; .
+               &#34;Content-Encoding: gzip$CRLF&#34; .
+               &#34;Content-type: text/plain$CRLF&#34; .
+               $CRLF .
+               &#34;$gzipped_content$CRLF&#34;
+              &#41;,
+              sub {
+                  my $response = shift;
+
+                  ok&#40;
+                     $response-&gt;code&#40;&#41; == 200 &#38;&#38;
+                     $response-&gt;content eq $original_content,
+                     &#34;gzip encoded transfers decode correctly&#34;
+                    &#41;;
+              },
+             ],
+            &#41;;
+
+# We are testing against a localhost server.
+# Don&#39;t proxy, because localhost takes on new meaning.
+BEGIN {
+	delete $ENV{HTTP_PROXY};
+}
+
+# Spawn one server per test response.
+{
+  foreach &#40;@tests&#41; {
+    POE::Component::Server::TCP-&gt;new&#40;
+      Address             =&gt; &#34;127.0.0.1&#34;,
+      Port                =&gt; 0,
+      Started             =&gt; \&#38;register_port,
+      ClientInputFilter   =&gt; &#34;POE::Filter::Line&#34;,
+      ClientOutputFilter  =&gt; &#34;POE::Filter::Stream&#34;,
+      ClientInput         =&gt; \&#38;parse_next_request,
+    &#41;;
+  }
+
+  sub register_port {
+    push&#40;
+      @server_ports,
+      &#40;sockaddr_in&#40;$_[HEAP]-&gt;{listener}-&gt;getsockname&#40;&#41;&#41;&#41;[0]
+    &#41;;
+  }
+
+  sub parse_next_request {
+    my $input = $_[ARG0];
+
+    DEBUG and diag &#34;got line: [$input]&#34;;
+    return if $input ne &#34;&#34;;
+
+    my $response = $tests[$test_number][0];
+    $_[HEAP]-&gt;{client}-&gt;put&#40;$response&#41;;
+
+    $response =~ s/$CRLF/{CRLF}/g;
+    DEBUG and diag &#34;sending: [$response]&#34;;
+
+    $_[KERNEL]-&gt;yield&#40;&#34;shutdown&#34;&#41;;
+  }
+}
+
+
+# Spawn the HTTP user-agent component.
+POE::Component::Client::HTTP-&gt;spawn&#40;&#41;;
+
+# Create a client session to drive the HTTP component.
+POE::Session-&gt;create&#40;
+                     inline_states =&gt; {
+                                       _start =&gt; sub {
+                                           $_[KERNEL]-&gt;yield&#40;&#34;run_next_test&#34;&#41;;
+                                       },
+                                       run_next_test =&gt; sub {
+                                           my $port    = $server_ports[$test_number];
+                                           $_[KERNEL]-&gt;post&#40;
+                                                            weeble =&gt; request =&gt; response =&gt;
+                                                            GET &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1">http://127.0.0.1</a></span>:${port}/&#34;
+                                                           &#41;;
+                                       },
+                                       response =&gt; sub {
+                                           my $response = $_[ARG1][0];
+                                           my $test     = $tests[$test_number][1];
+                                           $test-&gt;&#40;$response&#41;;
+
+                                           $_[KERNEL]-&gt;yield&#40;&#34;run_next_test&#34;&#41; if ++$test_number &lt; @tests;
+                                       },
+                                       _stop =&gt; sub { exit }, # Nasty but expedient.
+                                      }
+                    &#41;;
+
+POE::Kernel-&gt;run&#40;&#41;;
+exit;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;24&nbsp;17:21:12&nbsp;2006</span>
    <span class="description">rdb [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">OK, new patch, against current svn, disregard last patch.

includes:
automatic request of gzip&#39;d content if Compress::Zlib is present
skips same if the request is streaming
returns decoded content to client transparently
borrows zlib_ok&#40;&#41; from LWP
tests using compression algorithm lifted from Apache::Dynagzip 
  - which in turns follows apache mod_gzip/mod_deflate
skips test if Compress::Zlib is NOT present on system
updated PREREQ_PM in Makefile.PL

docs NOT updated.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -urN --exclude=&#39;*~&#39; --exclude=.svn poco-client-http/lib/POE/Component/Client/HTTP/Request.pm poco-client-http-gzip/lib/POE/Component/Client/HTTP/Request.pm
--- poco-client-http/lib/POE/Component/Client/HTTP/Request.pm	2006-10-24 11:54:57.000000000 -0700
+++ poco-client-http-gzip/lib/POE/Component/Client/HTTP/Request.pm	2006-10-24 13:36:24.000000000 -0700
@@ -167,6 +167,13 @@
   # if we are. that there&#39;s no ARG1 lets the client know we&#39;re done
   # with the content in the latter case
   if &#40;$self-&gt;[REQ_STATE] &#38; RS_DONE&#41; {
+    DEBUG and warn &#34;checking $response for content-encoding &#34;, $self-&gt;[REQ_ID];
+    if &#40;$response-&gt;header&#40;&#39;content-encoding&#39;&#41;&#41; {
+      my $content;
+      eval { $content = $response-&gt;decoded_content }; # LWP likes to die&#40;&#41; on errors
+      if &#40;$content&#41; { $response-&gt;content&#40;$content&#41;; }
+    }
+
     DEBUG and warn &#34;done; returning $response for &#34;, $self-&gt;[REQ_ID];
     $self-&gt;[REQ_POSTBACK]-&gt;&#40;$self-&gt;[REQ_RESPONSE]&#41;;
     $self-&gt;[REQ_STATE] |= RS_POSTED;
diff -urN --exclude=&#39;*~&#39; --exclude=.svn poco-client-http/lib/POE/Component/Client/HTTP.pm poco-client-http-gzip/lib/POE/Component/Client/HTTP.pm
--- poco-client-http/lib/POE/Component/Client/HTTP.pm	2006-10-24 11:54:59.000000000 -0700
+++ poco-client-http-gzip/lib/POE/Component/Client/HTTP.pm	2006-10-24 13:39:13.000000000 -0700
@@ -15,6 +15,7 @@
 
 use Carp qw&#40;croak&#41;;
 use HTTP::Response;
+use Net::HTTP::Methods;
 
 use POE::Component::Client::HTTP::RequestFactory;
 use POE::Component::Client::HTTP::Request qw&#40;:states :fields&#41;;
@@ -74,7 +75,16 @@
   &#34;,&#34;,
   grep { exists $te_filters{$_} }
   qw&#40;x-bzip2 gzip x-gzip deflate compress chunked identity&#41;
-&#41;;
+&#41; if 0;
+
+# The above defaults to &#39;chunked,identity&#39; which is technically
+# correct but arguably useless.  It also stomps on gzip&#39;d transport
+# because in the World Wild Web, Accept-Encoding is used to indicate
+# gzip readiness, but the server responds with &#39;Content-Encoding: gzip&#39;,
+# completely outside of TE encoding.
+#
+# set default here, but DON&#39;T SET later, if the request is streaming.
+$accept_encoding = Net::HTTP::Methods::zlib_ok&#40;&#41; ? &#39;gzip&#39; : &#39;&#39;;
 
 my %supported_schemes = &#40;
   http  =&gt; 1,
@@ -236,7 +246,8 @@
   # Add an Accept-Encoding header if we don&#39;t have one.
   if &#40;
     !defined&#40;$http_request-&gt;header&#40;&#39;Accept-Encoding&#39;&#41;&#41; and
-    length&#40;$accept_encoding&#41;
+    length&#40;$accept_encoding&#41; and
+    !$heap-&gt;{factory}-&gt;is_streaming # don&#39;t offer encoding for streaming. &#39;chunked&#39; doesn&#39;t count.
   &#41; {
     $http_request-&gt;header&#40;&#39;Accept-Encoding&#39;, $accept_encoding&#41;;
   }
diff -urN --exclude=&#39;*~&#39; --exclude=.svn poco-client-http/Makefile.PL poco-client-http-gzip/Makefile.PL
--- poco-client-http/Makefile.PL	2006-10-24 11:55:01.000000000 -0700
+++ poco-client-http-gzip/Makefile.PL	2006-10-24 14:10:25.000000000 -0700
@@ -9,10 +9,11 @@
 open&#40;CHANGES, &#34;&gt;&gt;CHANGES&#34;&#41; and close CHANGES;
 
 my %prereq = &#40;
-  &#39;POE&#39;             =&gt; 0.3202,
-  &#39;HTTP::Request&#39;   =&gt; 1.30,
-  &#39;HTTP::Response&#39;  =&gt; 1.37,
-  &#39;URI&#39;             =&gt; 1.24,
+  &#39;POE&#39;                =&gt; 0.3202,
+  &#39;HTTP::Request&#39;      =&gt; 1.30,
+  &#39;HTTP::Response&#39;     =&gt; 1.37,
+  &#39;URI&#39;                =&gt; 1.24,
+  &#39;Net::HTTP::Methods&#39; =&gt; 0.02,
   &#39;POE::Component::Client::Keepalive&#39; =&gt; 0.09,
 &#41;;
 
diff -urN --exclude=&#39;*~&#39; --exclude=.svn poco-client-http/t/59_gzipped_content.t poco-client-http-gzip/t/59_gzipped_content.t
--- poco-client-http/t/59_gzipped_content.t	1969-12-31 16:00:00.000000000 -0800
+++ poco-client-http-gzip/t/59_gzipped_content.t	2006-10-24 14:20:50.000000000 -0700
@@ -0,0 +1,185 @@
+#!/usr/bin/perl
+# $Id$
+# vim: filetype=perl
+
+# Gzip&#39;d content encoding.
+
+use warnings;
+use strict;
+
+use IO::Socket::INET;
+use Socket &#39;$CRLF&#39;, &#39;$LF&#39;, &#39;$CR&#39;;
+use HTTP::Request::Common &#39;GET&#39;;
+
+sub DEBUG &#40;&#41; { 0 }
+
+# The number of tests must match scalar&#40;@tests&#41;.
+use Test::More;
+
+use POE;
+use POE::Component::Client::HTTP;
+use POE::Component::Server::TCP;
+
+use Net::HTTP::Methods;
+
+if &#40;Net::HTTP::Methods::zlib_ok&#40;&#41;&#41; {
+    plan tests =&gt; 1;
+} else {
+    plan skip_all =&gt; &#39;Compress::Zlib no present&#39;;
+}
+
+# eval this so that if it&#39;s NOT present we don&#39;t barf before we can call zlib_ok&#40;&#41;
+eval &#34;use Compress::Zlib&#34;;
+
+my $test_number = 0;
+
+my @server_ports;
+
+# A list of test responses, each paired with a subroutine to check
+# whether the response was parsed.
+# use YAML;
+
+my $original_content = &lt;&lt;DONE;
+&lt;html&gt;
+ &lt;head&gt;
+  &lt;title&gt;Sample Document&lt;/title&gt;
+ &lt;/head&gt;
+ &lt;body&gt;
+  Sample content
+ &lt;/body&gt;
+&lt;/html&gt;
+DONE
+
+## content compression lifted from Apache::Dynagzip
+## this is functionally equivalent to mod_gzip, etc.
+## so we have a &#34;real-world&#34; piece of encoded content
+
+my $gzipped_content;
+
+GZIP: {
+    use constant MAGIC1	=&gt; 0x1f ;
+    use constant MAGIC2	=&gt; 0x8b ;
+    use constant OSCODE	=&gt; 3 ;
+    use constant MIN_HDR_SIZE =&gt; 10 ; # minimum gzip header size
+
+    # Create the first outgoing portion of the content:
+
+    my $gzipHeader = pack&#40;&#34;C&#34; . MIN_HDR_SIZE, MAGIC1, MAGIC2, Z_DEFLATED&#40;&#41;, 0,0,0,0,0,0, OSCODE&#41;;
+    $gzipped_content = $gzipHeader;
+
+    my $gzip_handler = deflateInit&#40; -Level      =&gt; Z_BEST_COMPRESSION&#40;&#41;,
+                                    -WindowBits =&gt; - MAX_WBITS&#40;&#41;,
+                                  &#41;;
+
+    $_ = $original_content;
+
+    my &#40;$out, $status&#41; = $gzip_handler-&gt;deflate&#40;\$_&#41;;
+    unless &#40;length&#40;$out&#41;&#41; {
+        &#40;$out, $status&#41; = $gzip_handler-&gt;flush&#40;&#41;;
+    }
+
+    $gzipped_content .= $out;
+
+    # almost the same thing, but I wanted to go thru all the hoops:
+    if &#40;0&#41; {
+        $_ = $original_content;
+        $gzipped_content = Compress::Zlib::memGzip&#40;$_&#41;;
+    }
+
+}
+
+my @tests = &#40;
+             # Gzipped content decoded correctly.
+             [
+              &#40;
+               &#34;HTTP/1.1 200 OK$CRLF&#34; .
+               &#34;Connection: close$CRLF&#34; .
+               &#34;Content-Encoding: gzip$CRLF&#34; .
+               &#34;Content-type: text/plain$CRLF&#34; .
+               $CRLF .
+               &#34;$gzipped_content$CRLF&#34;
+              &#41;,
+              sub {
+                  my $response = shift;
+
+                  ok&#40;
+                     $response-&gt;code&#40;&#41; == 200 &#38;&#38;
+                     $response-&gt;content eq $original_content,
+                     &#34;gzip encoded transfers decode correctly&#34;
+                    &#41;;
+              },
+             ],
+            &#41;;
+
+# We are testing against a localhost server.
+# Don&#39;t proxy, because localhost takes on new meaning.
+BEGIN {
+	delete $ENV{HTTP_PROXY};
+}
+
+# Spawn one server per test response.
+{
+  foreach &#40;@tests&#41; {
+    POE::Component::Server::TCP-&gt;new&#40;
+      Address             =&gt; &#34;127.0.0.1&#34;,
+      Port                =&gt; 0,
+      Started             =&gt; \&#38;register_port,
+      ClientInputFilter   =&gt; &#34;POE::Filter::Line&#34;,
+      ClientOutputFilter  =&gt; &#34;POE::Filter::Stream&#34;,
+      ClientInput         =&gt; \&#38;parse_next_request,
+    &#41;;
+  }
+
+  sub register_port {
+    push&#40;
+      @server_ports,
+      &#40;sockaddr_in&#40;$_[HEAP]-&gt;{listener}-&gt;getsockname&#40;&#41;&#41;&#41;[0]
+    &#41;;
+  }
+
+  sub parse_next_request {
+    my $input = $_[ARG0];
+
+    DEBUG and diag &#34;got line: [$input]&#34;;
+    return if $input ne &#34;&#34;;
+
+    my $response = $tests[$test_number][0];
+    $_[HEAP]-&gt;{client}-&gt;put&#40;$response&#41;;
+
+    $response =~ s/$CRLF/{CRLF}/g;
+    DEBUG and diag &#34;sending: [$response]&#34;;
+
+    $_[KERNEL]-&gt;yield&#40;&#34;shutdown&#34;&#41;;
+  }
+}
+
+
+# Spawn the HTTP user-agent component.
+POE::Component::Client::HTTP-&gt;spawn&#40;&#41;;
+
+# Create a client session to drive the HTTP component.
+POE::Session-&gt;create&#40;
+  inline_states =&gt; {
+    _start =&gt; sub {
+      $_[KERNEL]-&gt;yield&#40;&#34;run_next_test&#34;&#41;;
+    },
+    run_next_test =&gt; sub {
+      my $port    = $server_ports[$test_number];
+      $_[KERNEL]-&gt;post&#40;
+        weeble =&gt; request =&gt; response =&gt;
+        GET &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1">http://127.0.0.1</a></span>:${port}/&#34;
+      &#41;;
+    },
+    response =&gt; sub {
+      my $response = $_[ARG1][0];
+      my $test     = $tests[$test_number][1];
+      $test-&gt;&#40;$response&#41;;
+
+      $_[KERNEL]-&gt;yield&#40;&#34;run_next_test&#34;&#41; if ++$test_number &lt; @tests;
+    },
+    _stop =&gt; sub { exit },  # Nasty but expedient.
+  }
+&#41;;
+
+POE::Kernel-&gt;run&#40;&#41;;
+exit;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;25&nbsp;02:55:34&nbsp;2006</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks, Rob.  Your patch is applied and committed as revision 294.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;25&nbsp;02:55:36&nbsp;2006</span>
    <span class="description">RCAPUTO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
