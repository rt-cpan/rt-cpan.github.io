<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #90068 for DBD-Oracle: Problems with DBD::Oracle package: function plsql_errstr</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #90068 for DBD-Oracle: Problems with DBD::Oracle package: function plsql_errstr</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DBD-Oracle">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DBD-Oracle">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DBD-Oracle">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DBD-Oracle">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/pythian/DBD-Oracle/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-Oracle">DBD-Oracle CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">90068</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DBD-Oracle">DBD-Oracle</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
eljot_007 [...] poczta.onet.pl

<br />
bohica [...] ntlworld.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10192-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.64    </td>
  </tr>
  <tr id="CF-10193-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




plsql_errstr.zip<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1283780/680324/plsql_errstr.zip">
Tue Nov 05 13:23:02 2013 (11k) by bohica [...] ntlworld.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=90068">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1283780" href="/Public/Bug/Display.html?id=90068#txn-1283780">#</a>      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;05&nbsp;13:23:02&nbsp;2013</span>
    <span class="description">bohica [...] ntlworld.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Problems with DBD::Oracle package: function plsql_errstr</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1283780/680323/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/680323">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m reporting this on behalf of Jarek Lubczyński as I haven&#39;t got the tuits right now to look at and hope someone else can pick it up.

His email forwarded  by Tim was:

Hi,

I have found two problems with your DBD::Oracle package.

&#40;you have all examples in the attachment plsql_errstr.zip, please read
README.txt file&#41;

problems concern sub plsql_errstr described in
<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~pythian/DBD-Oracle-1.64/lib/DBD/Oracle.pm">http://search.cpan.org/~pythian/DBD-Oracle-1.64/lib/DBD/Oracle.pm</a></span>

What&#39;s the point? You use view *user_errors* to fetch info about
errors in *last* query parsed. But the view returns list of ALL
current user errors - as name of the view means.

So if I execute example code from pod :

EXAMPLE 1: &#40;01-example-1-sub.sh, calls pl/01-example-1-sub.pl&#41;

    # Show the errors if CREATE PROCEDURE fails
    $dbh-&gt;{RaiseError} = 0;
    if &#40; $dbh-&gt;do&#40; q{
        CREATE OR REPLACE PROCEDURE perl_dbd_oracle_test as
        BEGIN
            PROCEDURE filltab&#40; stuff OUT TAB &#41;; asdf
        END; } &#41; &#41; {} # Statement succeeded
    }
    elsif &#40; 6550 != $dbh-&gt;err &#41; { die $dbh-&gt;errstr; } # Utter failure
    else {
        my $msg = $dbh-&gt;func&#40; &#39;plsql_errstr&#39; &#41;;
        die $dbh-&gt;errstr if ! defined $msg;
        die $msg if $msg;
    }

I will get msg as in attachment 01-example-01.log containing the error
info I have expected. But the following code will not work properly:

&#40;please execute 00.example-del-subs.sh first&#41;

EXAMPLE 2: &#40;02-example-2-subs.sh, calls pl/02-example-2-subs.pl&#41;

    # Show the errors if CREATE PROCEDURE fails
    $dbh-&gt;{RaiseError} = 0;
    if &#40; $dbh-&gt;do&#40; q{
        CREATE OR REPLACE PROCEDURE perl_dbd_oracle_test_1st as
        BEGIN
            PROCEDURE filltab&#40; stuff OUT TAB &#41;; asdf
        END; } &#41; &#41; {} # Statement succeeded
    }
    elsif &#40; 6550 != $dbh-&gt;err &#41; { die $dbh-&gt;errstr; } # Utter failure
    else {
        my $msg = $dbh-&gt;func&#40; &#39;plsql_errstr&#39; &#41;;
        warn $dbh-&gt;errstr, &#34;\n&#34; if ! defined $msg &#38;&#38; defined $dbh-&gt;errstr;
        warn $msg, &#34;\n&#34; if $msg;
    }

    # but this works not exactly as one should expect...
    $dbh-&gt;{RaiseError} = 0;
    if &#40; $dbh-&gt;do&#40; q{
        CREATE OR REPLACE PROCEDURE perl_dbd_oracle_test_2nd as
        BEGIN
            PROCEDURE filltab&#40; stuff OUT TAB &#41;; asdf
        END; } &#41; &#41; {} # Statement succeeded
    }
    elsif &#40; 6550 != $dbh-&gt;err &#41; { die $dbh-&gt;errstr; } # Utter failure
    else {
        my $msg = $dbh-&gt;func&#40; &#39;plsql_errstr&#39; &#41;;
        warn $dbh-&gt;errstr, &#34;\n&#34; if ! defined $msg &#38;&#38; defined $dbh-&gt;errstr;
        warn $msg, &#34;\n&#34; if $msg;
    }

ooops - first we&#39;ve got info about procedure perl_dbd_oracle_test_1st
&#40;that&#39;s ok&#41; but then we&#39;ve got info about *both* procedures:
perl_dbd_oracle_test_1st and perl_dbd_oracle_test_2nd as well...

The second problem is more subtle. I think the common idea due to
security reasons is to have only one database user which has resource
and CREATE USER privilege, and the only user creates other users and
tables, views, etc for the them. Other users can do only DML queries.
In this case the view user_errors will obviously return the empty row
list. So the code:

EXAMPLE 3 &#40;03-example-other-user.sh&#41;
    # Show the errors if CREATE PROCEDURE fails
    $dbh-&gt;{RaiseError} = 0;
    if &#40; $dbh-&gt;do&#40; q{
        CREATE OR REPLACE PROCEDURE myuser.perl_dbd_oracle_test as
        BEGIN
            PROCEDURE filltab&#40; stuff OUT TAB &#41;; asdf
        END; } &#41; &#41; {} # Statement succeeded
    }
    elsif &#40; 6550 != $dbh-&gt;err &#41; { die $dbh-&gt;errstr; } # Utter failure
    else {
        my $msg = $dbh-&gt;func&#40; &#39;plsql_errstr&#39; &#41;;
        die $dbh-&gt;errstr if ! defined $msg;
        die $msg if $msg;
    }

will return no info at all!

I have solved both problems, would You look at my version of
plsql_errstr in file 04-example-new-plsql-errstr.pl, please?

As You can see I have defined *sub* *plsql_errarray* which select
error info from database and returns them in array reference much more
convinient for later use; *plsql_errstr* only converts that array into
a single string. Of course one should provide at least two additional
parameters to new plsql_errstr function.

-- Greetings Jarek Lubczyński There are 10 kinds of people: Those who understand binary and those who don&#39;t 


-- 
Martin J. Evans
Wetherby, UK
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> plsql_errstr.zip</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1283780/680324/plsql_errstr.zip">Download plsql_errstr.zip</a><br />
<span class="downloadcontenttype">application/zip 11k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1283784" href="/Public/Bug/Display.html?id=90068#txn-1283784">#</a>      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;05&nbsp;13:24:23&nbsp;2013</span>
    <span class="description">bohica [...] ntlworld.com -  Requestor eljot_007@poczta.onet.pl added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1841399" href="/Public/Bug/Display.html?id=90068#txn-1841399">#</a>      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;06&nbsp;05:11:04&nbsp;2019</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1841399/989818/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/989818">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 37b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Closed as moved to github in issue 85
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1841402" href="/Public/Bug/Display.html?id=90068#txn-1841402">#</a>      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;06&nbsp;05:11:05&nbsp;2019</span>
    <span class="description">bohica [...] ntlworld.com -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.292291</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
