<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #12762 for File-Tail: &#34;uninitialized value&#34; messages when machine experiences I/O issues</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #12762 for File-Tail: &#34;uninitialized value&#34; messages when machine experiences I/O issues</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/File-Tail/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/File-Tail/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/File-Tail/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/File-Tail/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/File-Tail">File-Tail CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">12762</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/File-Tail/Active/">File-Tail</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
michael.protulipac [...] pnc.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-13188-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.99.1    </td>
  </tr>
  <tr id="CF-13189-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;11&nbsp;13:47:51&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> &#34;uninitialized value&#34; messages when machine experiences I/O issues</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Environment:  File-Tail-0.99.1 on Sparc Solaris 2.9 - perl 5.8.5 - both perl and File::Tail built with gcc 3.3.2

I am using File::Tail to monitor 30+ files on a Solaris 2.9 machine.  We experienced disk issues which resulted with the OS taking the disks offline &#40;the disks where the monitored files resided&#41;.  During this time, File::Tail began spewing the following messages repeatedly:

Use of uninitialized value in numeric lt &#40;&lt;&#41; at /usr/local/lib/perl5/site_perl/5.8.5/File/Tail.pm line 405.
Use of uninitialized value in numeric eq &#40;==&#41; at /usr/local/lib/perl5/site_perl/5.8.5/File/Tail.pm line 405.
Use of uninitialized value in subtraction &#40;-&#41; at /usr/local/lib/perl5/site_perl/5.8.5/File/Tail.pm line 413.
Use of uninitialized value in subtraction &#40;-&#41; at /usr/local/lib/perl5/site_perl/5.8.5/File/Tail.pm line 417.

Not sure what could be done to prevent File::Tail from behaving in this manner &#40;want to retain using perl -w&#41;.  I realize this is a rare event, nonetheless wanted to share it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;09&nbsp;14:47:20&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> michael.protulipac [...] pnc.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Wed May 11 13:47:51 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Environment:  File-Tail-0.99.1 on Sparc Solaris 2.9 - perl 5.8.5 -
&gt;    both perl and File::Tail built with gcc 3.3.2
&gt; 
&gt; I am using File::Tail to monitor 30+ files on a Solaris 2.9 machine.
&gt;    We experienced disk issues which resulted with the OS taking the
&gt;    disks offline &#40;the disks where the monitored files resided&#41;.
&gt;    During this time, File::Tail began spewing the following messages
&gt;    repeatedly:
&gt; 
&gt; Use of uninitialized value in numeric lt &#40;&lt;&#41; at
&gt;    /usr/local/lib/perl5/site_perl/5.8.5/File/Tail.pm line 405.
&gt; Use of uninitialized value in numeric eq &#40;==&#41; at
&gt;    /usr/local/lib/perl5/site_perl/5.8.5/File/Tail.pm line 405.
&gt; Use of uninitialized value in subtraction &#40;-&#41; at
&gt;    /usr/local/lib/perl5/site_perl/5.8.5/File/Tail.pm line 413.
&gt; Use of uninitialized value in subtraction &#40;-&#41; at
&gt;    /usr/local/lib/perl5/site_perl/5.8.5/File/Tail.pm line 417.
&gt; 
&gt; Not sure what could be done to prevent File::Tail from behaving in
&gt;    this manner &#40;want to retain using perl -w&#41;.  I realize this is a
&gt;    rare event, nonetheless wanted to share it.
</div>

I found some quiet time to address these issues and included a patch
&#40;attached&#41;.  Please consider adding it into the next release.

Specifically, it addresses the &#34;Use of uninitialized value&#34; warnings. 
In addition, I created another parameter &#40;io_tolerant&#41; to the new&#40;&#41;
method which enables one to control the behavior of File::Tail whenever
the partition/mountpoint of the file goes away.  Testing revealed
sysseek fails to seek to EOF and returns undef.  With io_tolerant set,
it will close the file and treat it as if the file never existed.  If
io_tolerant not set, it will set the EOF location to the last known end
position and quietly resume its monitoring where it left off when the
partition returns.  See the updated &#40;File::Tail perldoc for more
information&#41;.

This was tested on Solaris 8 and 9 using perl 5.8.5 and File::Tail
0.99.1 &#40;with enclosed patch applied&#41;.  The Solaris 9 environment was a
SunCluster &#40;HA active/passive environment&#41;.

Mike
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Tail.pm.orig	2005-05-10 15:34:22.000000000 -0400
+++ Tail.pm	2005-06-09 14:35:17.001250000 -0400
@@ -183,6 +183,12 @@
     return $self-&gt;{ignore_nonexistant};
 }
 
+sub io_tolerant {
+    my $self=shift;
+    $self-&gt;{io_tolerant}=shift if @_;
+    return $self-&gt;{io_tolerant};
+}
+
 sub TIEHANDLE {
     my $ref=new&#40;@_&#41;;
 }
@@ -269,6 +275,8 @@
     }
 #    $object-&gt;{curpos}=0;        # ADDED 25May01: undef warnings when
 #    $object-&gt;{endpos}=0;        #   starting up on a nonexistant file
+    # Added June 9, 2005: handle partition issues
+    $object-&gt;{&#34;io_tolerant&#34;}=&#40;$params{&#34;io_tolerant&#34;} || 0&#41;;
     return $object;
 }
 
@@ -393,15 +401,38 @@
    my $object=shift @_;
 
    my $old_lastcheck = $object-&gt;{lastcheck};
+
+   # Added June 9, 2005: Will complain if not defined &#40;partition issues&#41;
+   # The sysseek below will return undef - therefore, save off old position
+   my $old_endpos = $object-&gt;{&#34;endpos&#34;};
+
    $object-&gt;{&#34;lastcheck&#34;}=time;
-   unless &#40;$object-&gt;{handle}&#41; {
+   unless &#40; defined&#40;$object-&gt;{handle}&#41; &#41; {
        $object-&gt;reset_pointers;
-       unless &#40;$object-&gt;{handle}&#41; { # This try did not open the file either
+       unless &#40; defined&#40;$object-&gt;{handle}&#41; &#41; { # This try did not open the file either
 	   return 0;
        }
    }
    
    $object-&gt;{&#34;endpos&#34;}=sysseek&#40;$object-&gt;{handle},0,SEEK_END&#41;;
+
+   # When filesystem partions are dismounted - File::Tail will complain about null endpos value
+
+   unless &#40; defined&#40;$object-&gt;{&#34;endpos&#34;}&#41; &#41; {
+
+       if &#40; $object-&gt;{&#34;io_tolerant&#34;} &#41; {
+           # Close handle - want to treat it as a new file
+           close&#40;$object-&gt;{handle}&#41;;
+           $object-&gt;{handle} = undef;
+           $object-&gt;reset_pointers;
+           # No need to proceed
+           return 0;
+       } else {
+           # Assign last known endpos
+           $object-&gt;{&#34;endpos&#34;} ||= $old_endpos;
+       }
+   }
+   
    if &#40;$object-&gt;{&#34;endpos&#34;}&lt;$object-&gt;{curpos}&#41; {  # file was truncated
        $object-&gt;position;
    } elsif &#40;&#40;$object-&gt;{curpos}==$object-&gt;{&#34;endpos&#34;}&#41; 
@@ -704,6 +735,26 @@
 opened or when it is to be reopened. &#40;File may be reopened after 
 resetafter seconds have passed since last data was found.&#41;
 
+=item io_tolerant
+
+    Treat file as new &#40;first time opened&#41; when the system loses
+the partition where the file resides.  This is particularly useful
+in high available &#40;HA&#41; systems configured in an active/passive
+configuration.  If not specified, File::Tail remembers the last
+position of the file it monitored and resumes monitoring from the last
+known location &#40;otherwise may duplicate monitored lines especially
+if the file is written to and monitored on the other node&#41;.
+
+Default value is 0 &#40;off&#41;.
+
+In the following case, we would want to set io_tolerant:
+
+    1. Node A monitors a file on an HA partition
+    2. Node B tries to monitor a file that is not there
+    3. Node A fails to node B
+    4. Node B start monitoring the file and app writes to the file
+    5. Node B fails back to node A
+
 =item tail
 
     When first started, read and return C&lt;n&gt; lines from the file. 
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
