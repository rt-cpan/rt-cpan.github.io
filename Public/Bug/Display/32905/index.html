<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #32905 for Perl-Tidy: Broken handling of UTF-8 strings</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #32905 for Perl-Tidy: Broken handling of UTF-8 strings</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Perl-Tidy/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Perl-Tidy/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Perl-Tidy/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Perl-Tidy/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Perl-Tidy">Perl-Tidy CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">32905</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Perl-Tidy/Active/">Perl-Tidy</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
CHOCOLATE [...] cpan.org

<br />
FANY [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-25260-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-25261-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




0001-Fix-indentation-of-wide-characters.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1390391/738326/0001-Fix-indentation-of-wide-characters.patch">
Fri Jul 25 03:59:11 2014 (2.6k) by sebastian [...] podjasek.pl
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1362485/723318/0001-Fix-indentation-of-wide-characters.patch">
Tue May 13 02:44:18 2014 (619b) by sebastian [...] podjasek.pl
</a>
</font></li>
</ul>


fix-utf8-output-for-std-and-files.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1572040/839371/fix-utf8-output-for-std-and-files.patch">
Thu Dec 10 06:16:45 2015 (2.1k) by http://mrakobes86reg.id.bk.ru/
</a>
</font></li>
</ul>


got.pl.tdy<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/417022/203667/got.pl.tdy">
Sun Feb 03 23:42:10 2008 (102b) by CHOCOLATE [...] cpan.org
</a>
</font></li>
</ul>


patch.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1525990/813970/patch.txt">
Sat Aug 15 00:56:35 2015 (1.6k) by ZDM [...] cpan.org
</a>
</font></li>
</ul>


test.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/417022/203661/test.pl">
Sun Feb 03 23:42:09 2008 (90b) by CHOCOLATE [...] cpan.org
</a>
</font></li>
</ul>


utf8.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1620592/867810/utf8.diff">
Mon Apr 25 07:41:13 2016 (1002b) by http://mrakobes86reg.id.bk.ru/
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1620589/867805/utf8.diff">
Mon Apr 25 07:40:41 2016 (1002b) by http://mrakobes86reg.id.bk.ru/
</a>
</font></li>
</ul>


want.pl.tdy<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/417022/203664/want.pl.tdy">
Sun Feb 03 23:42:10 2008 (103b) by CHOCOLATE [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;03&nbsp;23:42:09&nbsp;2008</span>
    <span class="description">CHOCOLATE [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Broken handling of UTF-8 strings</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi.

I can&#39;t get Perl::Tidy to do the right thing with UTF-8 strings.

I&#39;ve attached a test case with a source file &#40;test.pl&#41;, the expected
output &#40;want.pl.tdy&#41; and the actual output &#40;got.pl.tdy&#41;.

The problem arises because Perl::Tidy considers &#34;Für&#34; to be 4 characters
rather than 3, courtesy of length&#40;&#41;, which returns the number of bytes
rather than the number of characters, unless the string &#34;is in Unicode&#34;.

perl 5.8.8
Linux 2.6.22
Perl::Tidy 20071205
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">my $test = [
    &#34;FÃ¼r Elise&#34; =&gt; &#34;Beethoven&#34;,
    &#34;Eine kleine Nachtmusik&#34; =&gt; &#34;Mozart&#34;
];
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> want.pl.tdy</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/417022/203664/want.pl.tdy">Download want.pl.tdy</a><br />
<span class="downloadcontenttype">application/octet-stream 103b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> got.pl.tdy</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/417022/203667/got.pl.tdy">Download got.pl.tdy</a><br />
<span class="downloadcontenttype">application/octet-stream 102b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;04&nbsp;01:21:29&nbsp;2008</span>
    <span class="description">CHOCOLATE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Feb 03 23:42:09 2008, CHOCOLATE wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi.
&gt; 
&gt; I can&#39;t get Perl::Tidy to do the right thing with UTF-8 strings.
&gt; 
&gt; I&#39;ve attached a test case with a source file &#40;test.pl&#41;, the expected
&gt; output &#40;want.pl.tdy&#41; and the actual output &#40;got.pl.tdy&#41;.
&gt; 
&gt; The command was perltidy -fnl test.pl
&gt; 
&gt; The problem arises because Perl::Tidy considers &#34;Für&#34; to be 4 characters
&gt; rather than 3, courtesy of length&#40;&#41;, which returns the number of bytes
&gt; rather than the number of characters, unless the string &#34;is in Unicode&#34;.
&gt; 
&gt; perl 5.8.8
&gt; Linux 2.6.22
&gt; Perl::Tidy 20071205
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;04&nbsp;01:21:48&nbsp;2008</span>
    <span class="description">CHOCOLATE [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;07&nbsp;09:10:15&nbsp;2008</span>
    <span class="description">FANY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think this is no bug as long as you do not &#34;use utf8&#34;, because the
strings should be interpreted as byte strings then.

perltidy, however, does not seem to honor &#34;use utf8&#34; yet, so the
indentation will still be incorrect despite this pragma being in effect,
which I consider a bug, too. :-&#41;

Regards,
fany
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;07&nbsp;09:11:54&nbsp;2008</span>
    <span class="description">FANY [...] cpan.org -  Requestor FANY added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;13&nbsp;02:44:18&nbsp;2014</span>
    <span class="description">sebastian [...] podjasek.pl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> sebastian [...] podjasek.pl</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Nd 07 Gru 2008, 09:10:15, FANY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; perltidy, however, does not seem to honor &#34;use utf8&#34; yet, so the
&gt; indentation will still be incorrect despite this pragma being in effect,
&gt; which I consider a bug, too. :-&#41;
</div>
Just a tiny little change which solves this bug - at least for me.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Fix-indentation-of-wide-characters.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 203ea7adfd66a00ebb104af882c4d96faf244230 Mon Sep 17 00:00:00 2001
From: Sebastian Podjasek &lt;sebastian@podjasek.pl&gt;
Date: Tue, 13 May 2014 08:43:07 +0200
Subject: [PATCH] Fix indentation of wide-characters

---
 lib/Perl/Tidy.pm | 1 +
 1 file changed, 1 insertion&#40;+&#41;

diff --git a/lib/Perl/Tidy.pm b/lib/Perl/Tidy.pm
index c326a8f..19b92bd 100644
--- a/lib/Perl/Tidy.pm
+++ b/lib/Perl/Tidy.pm
@@ -165,6 +165,7 @@ EOM
     }
     $fh = $New-&gt;&#40; $filename, $mode &#41;
       or Warn&#40;&#34;Couldn&#39;t open file:$filename in mode:$mode : $!\n&#34;&#41;;
+    $fh-&gt;binmode&#40;&#39;:utf8&#39;&#41;;
     return $fh, &#40; $ref or $filename &#41;;
 }
 
-- 
1.9.1

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;13&nbsp;09:37:19&nbsp;2014</span>
    <span class="description">s7078hancock [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #32905] Broken handling of UTF-8 strings</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 13 May 2014 06:37:10 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Perl-Tidy [...] rt.cpan.org&#34; &lt;bug-Perl-Tidy [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steven Hancock &lt;s7078hancock [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sebastian, thanks.
Steve

On Tuesday, May 13, 2014, Sebastian Podjasek via RT &lt;
bug-Perl-Tidy@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Perl-Tidy
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=32905">https://rt.cpan.org/Ticket/Display.html?id=32905</a></span> &gt;
&gt;
&gt; On Nd 07 Gru 2008, 09:10:15, FANY wrote:
<div class="message-stanza open">&gt; &gt; perltidy, however, does not seem to honor &#34;use utf8&#34; yet, so the
&gt; &gt; indentation will still be incorrect despite this pragma being in effect,
&gt; &gt; which I consider a bug, too. :-&#41;
</div>&gt;
&gt; Just a tiny little change which solves this bug - at least for me.
&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;25&nbsp;03:59:11&nbsp;2014</span>
    <span class="description">sebastian [...] podjasek.pl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> sebastian [...] podjasek.pl</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Previous patch would cause problems when using Perl::Tidy with string as an argument &#40;Perl::Tidy::IOScalar does not implement binmode method&#41;. Also added some tests for this issue.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Fix-indentation-of-wide-characters.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From c572d03d038eb2c9cb663b2484ae48cef35073ce Mon Sep 17 00:00:00 2001
From: Sebastian Podjasek &lt;sebastian.podjasek@intelliway.pl&gt;
Date: Tue, 13 May 2014 08:43:07 +0200
Subject: [PATCH] Fix indentation of wide-characters

---
 lib/Perl/Tidy.pm  |  1 +
 t/testwide.pl.src |  4 ++++
 t/testwide.t      | 48 ++++++++++++++++++++++++++++++++++++++++++++++++
 3 files changed, 53 insertions&#40;+&#41;
 create mode 100644 t/testwide.pl.src
 create mode 100644 t/testwide.t

diff --git a/lib/Perl/Tidy.pm b/lib/Perl/Tidy.pm
index c326a8f..69d2788 100644
--- a/lib/Perl/Tidy.pm
+++ b/lib/Perl/Tidy.pm
@@ -165,6 +165,7 @@ EOM
     }
     $fh = $New-&gt;&#40; $filename, $mode &#41;
       or Warn&#40;&#34;Couldn&#39;t open file:$filename in mode:$mode : $!\n&#34;&#41;;
+    $fh-&gt;binmode&#40;&#39;:utf8&#39;&#41; if $fh-&gt;can&#40;&#39;binmode&#39;&#41;;
     return $fh, &#40; $ref or $filename &#41;;
 }
 
diff --git a/t/testwide.pl.src b/t/testwide.pl.src
new file mode 100644
index 0000000..10eec3a
--- /dev/null
+++ b/t/testwide.pl.src
@@ -0,0 +1,4 @@
+%pangrams=&#40;&#34;Plain&#34;,&#34;ASCII&#34;,
+&#34;ZwÃ¶lf groÃe BoxkÃ¤mpfer jagen Vik quer Ã¼ber den Sylter.&#34;,&#34;DE&#34;,
+&#34;JeÅ¼ wlÃ³kÅ gÄÅ. Uf! BÄdÅº choÄ przy nim, staÅ!&#34;,&#34;PL&#34;,
+&#34;ÐÑÐ±Ñ, ÑÑÐµÑÑ ÑÐ¸Ð¿ÑÑ, â Ð²Ð·Ð´Ð¾ÑÐ½ÑÑ Ð¼ÑÑ, â ÐºÐ°Ð¹Ñ Ð¶Ð³ÑÑ.&#34;,&#34;RU&#34;&#41;;
\ No newline at end of file
diff --git a/t/testwide.t b/t/testwide.t
new file mode 100644
index 0000000..e96dfdd
--- /dev/null
+++ b/t/testwide.t
@@ -0,0 +1,48 @@
+use strict;
+use utf8;
+use Test;
+use Carp;
+use FindBin;
+BEGIN {plan tests =&gt; 2}
+use Perl::Tidy; 
+
+
+my $source = &lt;&lt;&#39;EOM&#39;;
+%pangrams=&#40;&#34;Plain&#34;,&#34;ASCII&#34;,
+&#34;ZwÃ¶lf groÃe BoxkÃ¤mpfer jagen Vik quer Ã¼ber den Sylter.&#34;,&#34;DE&#34;,
+&#34;JeÅ¼ wlÃ³kÅ gÄÅ. Uf! BÄdÅº choÄ przy nim, staÅ!&#34;,&#34;PL&#34;,
+&#34;ÐÑÐ±Ñ, ÑÑÐµÑÑ ÑÐ¸Ð¿ÑÑ, â Ð²Ð·Ð´Ð¾ÑÐ½ÑÑ Ð¼ÑÑ, â ÐºÐ°Ð¹Ñ Ð¶Ð³ÑÑ.&#34;,&#34;RU&#34;&#41;;
+EOM
+
+my $expected_output=&lt;&lt;&#39;EOM&#39;;
+%pangrams = &#40;
+             &#34;Plain&#34;,                                                  &#34;ASCII&#34;,
+             &#34;ZwÃ¶lf groÃe BoxkÃ¤mpfer jagen Vik quer Ã¼ber den Sylter.&#34;, &#34;DE&#34;,
+             &#34;JeÅ¼ wlÃ³kÅ gÄÅ. Uf! BÄdÅº choÄ przy nim, staÅ!&#34;,           &#34;PL&#34;,
+             &#34;ÐÑÐ±Ñ, ÑÑÐµÑÑ ÑÐ¸Ð¿ÑÑ, â Ð²Ð·Ð´Ð¾ÑÐ½ÑÑ Ð¼ÑÑ, â ÐºÐ°Ð¹Ñ Ð¶Ð³ÑÑ.&#34;,        &#34;RU&#34;
+            &#41;;
+EOM
+
+my $perltidyrc = &lt;&lt;&#39;EOM&#39;;
+-gnu
+EOM
+
+my $output;
+
+Perl::Tidy::perltidy&#40;
+    source      =&gt; \$source,
+    destination =&gt; \$output,
+    perltidyrc  =&gt; \$perltidyrc,
+    argv        =&gt; &#39;-nsyn&#39;,
+&#41;;
+
+ok&#40;$output, $expected_output&#41;;
+
+Perl::Tidy::perltidy&#40;
+    source      =&gt; $FindBin::Bin . &#39;/testwide.pl.src&#39;,
+    destination =&gt; \$output,
+    perltidyrc  =&gt; \$perltidyrc,
+    argv        =&gt; &#39;-nsyn&#39;,
+&#41;;
+
+ok&#40;$output, $expected_output&#41;;
-- 
1.9.1

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;26&nbsp;19:39:07&nbsp;2014</span>
    <span class="description">s7078hancock [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #32905] Broken handling of UTF-8 strings</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 26 Jul 2014 16:38:52 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Perl-Tidy [...] rt.cpan.org&#34; &lt;bug-Perl-Tidy [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steven Hancock &lt;s7078hancock [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sebastian,
Thanks for the updated patch.  I would be interested in putting this in to
the next release on an experimental basis, but at least for now it would
have to be turned on with a flag since otherwise it will cause problems
with some existing scripts. Do you have a suggested name for the flag?
Thanks,
Steve


On Fri, Jul 25, 2014 at 12:59 AM, Sebastian Podjasek via RT &lt;
bug-Perl-Tidy@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Perl-Tidy
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=32905">https://rt.cpan.org/Ticket/Display.html?id=32905</a></span> &gt;
&gt;
&gt; Previous patch would cause problems when using Perl::Tidy with string as
&gt; an argument &#40;Perl::Tidy::IOScalar does not implement binmode method&#41;. Also
&gt; added some tests for this issue.
&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;07&nbsp;19:00:15&nbsp;2014</span>
    <span class="description">sebastian [...] podjasek.pl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> sebastian [...] podjasek.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sob 26 Lip 2014, 19:39:07, s7078hancock@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Do you have a suggested name for the flag?
</div>
-wide / --wide-chars

seems to be related to issue solved. As I&#39;ve seen -wc is already taken.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;08&nbsp;08:30:48&nbsp;2014</span>
    <span class="description">s7078hancock [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #32905] Broken handling of UTF-8 strings</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 8 Nov 2014 05:30:35 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Perl-Tidy [...] rt.cpan.org&#34; &lt;bug-Perl-Tidy [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steven Hancock &lt;s7078hancock [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">That seems okay, or even

-wch  / --wide-characters


Steve

On Fri, Nov 7, 2014 at 4:00 PM, Sebastian Podjasek via RT &lt;
bug-Perl-Tidy@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Perl-Tidy
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=32905">https://rt.cpan.org/Ticket/Display.html?id=32905</a></span> &gt;
&gt;
&gt; On Sob 26 Lip 2014, 19:39:07, s7078hancock@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; Do you have a suggested name for the flag?
</div>&gt;
&gt; -wide / --wide-chars
&gt;
&gt; seems to be related to issue solved. As I&#39;ve seen -wc is already taken.
&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;15&nbsp;00:56:35&nbsp;2015</span>
    <span class="description">ZDM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is the more portable solution, that works with any source type &#40;ScalarRef, handle, ArrayRef&#41;.

--- &#34;d:\\downloads\\Tidy.pm&#34;    2015-08-15 03:18:51.000000000 +0300
+++ &#34;d:\\devel\\perl\\perl\\site\\lib\\Perl\\Tidy.pm&#34;   2015-08-15 07:47:21.570789700 +0300
@@ -173,12 +173,6 @@
     $fh = $New-&gt;&#40; $filename, $mode &#41;
       or Warn&#40;&#34;Couldn&#39;t open file:$filename in mode:$mode : $!\n&#34;&#41;;
 
-    # The first call here will be to read the config file, which is before
-    # the --encoding has been set, so the config file cannot be read as utf8
-    $fh-&gt;binmode&#40;&#39;:encoding&#40;utf8&#41;&#39;&#41;
-      if &#40; $rOpts_character_encoding
-        &#38;&#38; $rOpts_character_encoding eq &#39;utf8&#39;
-        &#38;&#38; $fh-&gt;can&#40;&#39;binmode&#39;&#41; &#41;;
     return $fh, &#40; $ref or $filename &#41;;
 }
 
@@ -811,12 +805,23 @@
         # Prefilters and postfilters: The prefilter is a code reference
         # that will be applied to the source before tidying, and the
         # postfilter is a code reference to the result before outputting.
-        if &#40;$prefilter&#41; {
+        if &#40; $prefilter || &#40; $rOpts_character_encoding &#38;&#38; $rOpts_character_encoding eq &#39;utf8&#39; &#41; &#41; {
             my $buf = &#39;&#39;;
             while &#40; my $line = $source_object-&gt;get_line&#40;&#41; &#41; {
                 $buf .= $line;
             }
-            $buf = $prefilter-&gt;&#40;$buf&#41;;
+
+            $buf = $prefilter-&gt;&#40;$buf&#41; if $prefilter;
+
+                       if &#40; $rOpts_character_encoding &#38;&#38; $rOpts_character_encoding eq &#39;utf8&#39; &#38;&#38; !utf8::is_utf8&#40;$buf&#41; &#41; {
+                               require Encode;
+
+                               eval {
+                                       $buf = Encode::decode&#40;&#39;UTF-8&#39;, $buf, Encode::FB_CROAK | Encode::LEAVE_SRC&#41;;
+                               };
+
+                               Die &#34;unable to decode source\n&#34; if $@;
+                       }
 
             $source_object = Perl::Tidy::LineSource-&gt;new&#40; \$buf, $rOpts,
                 $rpending_logfile_message &#41;; 
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- &#34;d:\\downloads\\Tidy.pm&#34;	2015-08-15 03:18:51.000000000 +0300
+++ &#34;d:\\devel\\perl\\perl\\site\\lib\\Perl\\Tidy.pm&#34;	2015-08-15 07:47:21.570789700 +0300
@@ -173,12 +173,6 @@
     $fh = $New-&gt;&#40; $filename, $mode &#41;
       or Warn&#40;&#34;Couldn&#39;t open file:$filename in mode:$mode : $!\n&#34;&#41;;
 
-    # The first call here will be to read the config file, which is before
-    # the --encoding has been set, so the config file cannot be read as utf8
-    $fh-&gt;binmode&#40;&#39;:encoding&#40;utf8&#41;&#39;&#41;
-      if &#40; $rOpts_character_encoding
-        &#38;&#38; $rOpts_character_encoding eq &#39;utf8&#39;
-        &#38;&#38; $fh-&gt;can&#40;&#39;binmode&#39;&#41; &#41;;
     return $fh, &#40; $ref or $filename &#41;;
 }
 
@@ -811,12 +805,23 @@
         # Prefilters and postfilters: The prefilter is a code reference
         # that will be applied to the source before tidying, and the
         # postfilter is a code reference to the result before outputting.
-        if &#40;$prefilter&#41; {
+        if &#40; $prefilter || &#40; $rOpts_character_encoding &#38;&#38; $rOpts_character_encoding eq &#39;utf8&#39; &#41; &#41; {
             my $buf = &#39;&#39;;
             while &#40; my $line = $source_object-&gt;get_line&#40;&#41; &#41; {
                 $buf .= $line;
             }
-            $buf = $prefilter-&gt;&#40;$buf&#41;;
+
+            $buf = $prefilter-&gt;&#40;$buf&#41; if $prefilter;
+
+			if &#40; $rOpts_character_encoding &#38;&#38; $rOpts_character_encoding eq &#39;utf8&#39; &#38;&#38; !utf8::is_utf8&#40;$buf&#41; &#41; {
+				require Encode;
+
+				eval {
+					$buf = Encode::decode&#40;&#39;UTF-8&#39;, $buf, Encode::FB_CROAK | Encode::LEAVE_SRC&#41;;
+				};
+
+				Die &#34;unable to decode source\n&#34; if $@;
+			}
 
             $source_object = Perl::Tidy::LineSource-&gt;new&#40; \$buf, $rOpts,
                 $rpending_logfile_message &#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;15&nbsp;09:58:34&nbsp;2015</span>
    <span class="description">s7078hancock [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #32905] Broken handling of UTF-8 strings</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 15 Aug 2015 06:58:21 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Perl-Tidy [...] rt.cpan.org&#34; &lt;bug-Perl-Tidy [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steven Hancock &lt;s7078hancock [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dmytro,
Thanks for the patch, this looks like a better way to go.  I changed the
&#39;require&#39; to &#39;use&#39; to get it to work without complaints.  When I tested it
on a file I noticed that the output file was not UTF-8 on my system, so I
think that the previous coding may need to be retained when the $mode is
write.

Any other comments are very welcome.  I assume that I will be getting more
suggestions for improvement once this version starts to get used, so I will
probably need to do another release fairly soon.
Steve

On Fri, Aug 14, 2015 at 9:56 PM, Dmytro Zagashev via RT &lt;
bug-Perl-Tidy@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Perl-Tidy
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=32905">https://rt.cpan.org/Ticket/Display.html?id=32905</a></span> &gt;
&gt;
&gt; Here is the more portable solution, that works with any source type
&gt; &#40;ScalarRef, handle, ArrayRef&#41;.
&gt;
&gt; --- &#34;d:\\downloads\\Tidy.pm&#34;    2015-08-15 03:18:51.000000000 +0300
&gt; +++ &#34;d:\\devel\\perl\\perl\\site\\lib\\Perl\\Tidy.pm&#34;   2015-08-15
&gt; 07:47:21.570789700 +0300
&gt; @@ -173,12 +173,6 @@
&gt;      $fh = $New-&gt;&#40; $filename, $mode &#41;
&gt;        or Warn&#40;&#34;Couldn&#39;t open file:$filename in mode:$mode : $!\n&#34;&#41;;
&gt;
&gt; -    # The first call here will be to read the config file, which is before
&gt; -    # the --encoding has been set, so the config file cannot be read as
&gt; utf8
&gt; -    $fh-&gt;binmode&#40;&#39;:encoding&#40;utf8&#41;&#39;&#41;
&gt; -      if &#40; $rOpts_character_encoding
&gt; -        &#38;&#38; $rOpts_character_encoding eq &#39;utf8&#39;
&gt; -        &#38;&#38; $fh-&gt;can&#40;&#39;binmode&#39;&#41; &#41;;
&gt;      return $fh, &#40; $ref or $filename &#41;;
&gt;  }
&gt;
&gt; @@ -811,12 +805,23 @@
&gt;          # Prefilters and postfilters: The prefilter is a code reference
&gt;          # that will be applied to the source before tidying, and the
&gt;          # postfilter is a code reference to the result before outputting.
&gt; -        if &#40;$prefilter&#41; {
&gt; +        if &#40; $prefilter || &#40; $rOpts_character_encoding &#38;&#38;
&gt; $rOpts_character_encoding eq &#39;utf8&#39; &#41; &#41; {
&gt;              my $buf = &#39;&#39;;
&gt;              while &#40; my $line = $source_object-&gt;get_line&#40;&#41; &#41; {
&gt;                  $buf .= $line;
&gt;              }
&gt; -            $buf = $prefilter-&gt;&#40;$buf&#41;;
&gt; +
&gt; +            $buf = $prefilter-&gt;&#40;$buf&#41; if $prefilter;
&gt; +
&gt; +                       if &#40; $rOpts_character_encoding &#38;&#38;
&gt; $rOpts_character_encoding eq &#39;utf8&#39; &#38;&#38; !utf8::is_utf8&#40;$buf&#41; &#41; {
&gt; +                               require Encode;
&gt; +
&gt; +                               eval {
&gt; +                                       $buf = Encode::decode&#40;&#39;UTF-8&#39;,
&gt; $buf, Encode::FB_CROAK | Encode::LEAVE_SRC&#41;;
&gt; +                               };
&gt; +
&gt; +                               Die &#34;unable to decode source\n&#34; if $@;
&gt; +                       }
&gt;
&gt;              $source_object = Perl::Tidy::LineSource-&gt;new&#40; \$buf, $rOpts,
&gt;                  $rpending_logfile_message &#41;;
&gt;
&gt; --- &#34;d:\\downloads\\Tidy.pm&#34;    2015-08-15 03:18:51.000000000 +0300
&gt; +++ &#34;d:\\devel\\perl\\perl\\site\\lib\\Perl\\Tidy.pm&#34;   2015-08-15
&gt; 07:47:21.570789700 +0300
&gt; @@ -173,12 +173,6 @@
&gt;      $fh = $New-&gt;&#40; $filename, $mode &#41;
&gt;        or Warn&#40;&#34;Couldn&#39;t open file:$filename in mode:$mode : $!\n&#34;&#41;;
&gt;
&gt; -    # The first call here will be to read the config file, which is before
&gt; -    # the --encoding has been set, so the config file cannot be read as
&gt; utf8
&gt; -    $fh-&gt;binmode&#40;&#39;:encoding&#40;utf8&#41;&#39;&#41;
&gt; -      if &#40; $rOpts_character_encoding
&gt; -        &#38;&#38; $rOpts_character_encoding eq &#39;utf8&#39;
&gt; -        &#38;&#38; $fh-&gt;can&#40;&#39;binmode&#39;&#41; &#41;;
&gt;      return $fh, &#40; $ref or $filename &#41;;
&gt;  }
&gt;
&gt; @@ -811,12 +805,23 @@
&gt;          # Prefilters and postfilters: The prefilter is a code reference
&gt;          # that will be applied to the source before tidying, and the
&gt;          # postfilter is a code reference to the result before outputting.
&gt; -        if &#40;$prefilter&#41; {
&gt; +        if &#40; $prefilter || &#40; $rOpts_character_encoding &#38;&#38;
&gt; $rOpts_character_encoding eq &#39;utf8&#39; &#41; &#41; {
&gt;              my $buf = &#39;&#39;;
&gt;              while &#40; my $line = $source_object-&gt;get_line&#40;&#41; &#41; {
&gt;                  $buf .= $line;
&gt;              }
&gt; -            $buf = $prefilter-&gt;&#40;$buf&#41;;
&gt; +
&gt; +            $buf = $prefilter-&gt;&#40;$buf&#41; if $prefilter;
&gt; +
&gt; +                       if &#40; $rOpts_character_encoding &#38;&#38;
&gt; $rOpts_character_encoding eq &#39;utf8&#39; &#38;&#38; !utf8::is_utf8&#40;$buf&#41; &#41; {
&gt; +                               require Encode;
&gt; +
&gt; +                               eval {
&gt; +                                       $buf = Encode::decode&#40;&#39;UTF-8&#39;,
&gt; $buf, Encode::FB_CROAK | Encode::LEAVE_SRC&#41;;
&gt; +                               };
&gt; +
&gt; +                               Die &#34;unable to decode source\n&#34; if $@;
&gt; +                       }
&gt;
&gt;              $source_object = Perl::Tidy::LineSource-&gt;new&#40; \$buf, $rOpts,
&gt;                  $rpending_logfile_message &#41;;
&gt;
&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;10&nbsp;06:16:45&nbsp;2015</span>
    <span class="description">http://mrakobes86reg.id.bk.ru/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> qsimpleq</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Update Dmytro&#39;s patch.
Add utf8 support for output files too.

Суб Авг 15 09:58:34 2015, s7078hancock@gmail.com писал:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dmytro,
&gt; Thanks for the patch, this looks like a better way to go.  I changed
&gt; the
&gt; &#39;require&#39; to &#39;use&#39; to get it to work without complaints.  When I
&gt; tested it
&gt; on a file I noticed that the output file was not UTF-8 on my system,
&gt; so I
&gt; think that the previous coding may need to be retained when the $mode
&gt; is
&gt; write.
&gt; 
&gt; Any other comments are very welcome.  I assume that I will be getting
&gt; more
&gt; suggestions for improvement once this version starts to get used, so I
&gt; will
&gt; probably need to do another release fairly soon.
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> fix-utf8-output-for-std-and-files.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Tidy.pm.orig	2015-12-10 15:20:42.236631385 +0500
+++ Tidy.pm	2015-12-10 15:19:01.052440351 +0500
@@ -74,6 +74,7 @@
 @EXPORT = qw&#40; &#38;perltidy &#41;;
 
 use Cwd;
+use Encode &#40;&#41;;
 use IO::File;
 use File::Basename;
 use File::Copy;
@@ -173,12 +174,6 @@
     $fh = $New-&gt;&#40; $filename, $mode &#41;
       or Warn&#40;&#34;Couldn&#39;t open file:$filename in mode:$mode : $!\n&#34;&#41;;
 
-    # The first call here will be to read the config file, which is before
-    # the --encoding has been set, so the config file cannot be read as utf8
-    $fh-&gt;binmode&#40;&#39;:encoding&#40;utf8&#41;&#39;&#41;
-      if &#40; $rOpts_character_encoding
-        &#38;&#38; $rOpts_character_encoding eq &#39;utf8&#39;
-        &#38;&#38; $fh-&gt;can&#40;&#39;binmode&#39;&#41; &#41;;
     return $fh, &#40; $ref or $filename &#41;;
 }
 
@@ -811,12 +806,20 @@
         # Prefilters and postfilters: The prefilter is a code reference
         # that will be applied to the source before tidying, and the
         # postfilter is a code reference to the result before outputting.
-        if &#40;$prefilter&#41; {
+        if &#40; $prefilter || &#40; $rOpts_character_encoding &#38;&#38; $rOpts_character_encoding eq &#39;utf8&#39; &#41; &#41; {
             my $buf = &#39;&#39;;
             while &#40; my $line = $source_object-&gt;get_line&#40;&#41; &#41; {
                 $buf .= $line;
             }
-            $buf = $prefilter-&gt;&#40;$buf&#41;;
+
+            $buf = $prefilter-&gt;&#40;$buf&#41; if $prefilter;
+
+            if &#40; $rOpts_character_encoding &#38;&#38; $rOpts_character_encoding eq &#39;utf8&#39; &#38;&#38; !utf8::is_utf8&#40;$buf&#41; &#41; {
+                eval {
+                    $buf = Encode::decode&#40;&#39;UTF-8&#39;, $buf, Encode::FB_CROAK | Encode::LEAVE_SRC&#41;;
+                };
+                Die &#34;unable to decode source\n&#34; if $@;
+            }
 
             $source_object = Perl::Tidy::LineSource-&gt;new&#40; \$buf, $rOpts,
                 $rpending_logfile_message &#41;;
@@ -3935,7 +3938,10 @@
         $output_file_open = 1;
         if &#40;$binmode&#41; {
             if &#40; ref&#40;$fh&#41; eq &#39;IO::File&#39; &#41; {
-                binmode $fh;
+                if &#40; $rOpts-&gt;{&#39;character-encoding&#39;} &#38;&#38; $rOpts-&gt;{&#39;character-encoding&#39;} eq &#39;utf8&#39; &#41; {
+                    binmode $fh, &#34;:encoding&#40;UTF-8&#41;&#34;;
+                }
+                else { binmode $fh }
             }
             if &#40; $output_file eq &#39;-&#39; &#41; { binmode STDOUT }
         }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;27&nbsp;12:50:24&nbsp;2016</span>
    <span class="description">perltidy [...] users.sourceforge.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Version 20160301 of perltidy has the latest patch, thanks. I think this issue is closed now but will leave the RT ticket open for a while.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;25&nbsp;07:40:40&nbsp;2016</span>
    <span class="description">http://mrakobes86reg.id.bk.ru/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> qsimpleq</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Суб Фев 27 12:50:24 2016, SHANCOCK :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; this issue is closed now but will leave the RT ticket open for a
&gt; while.
</div>
And it was the right decision. -st -utf8 continued to be broken. fixed by patch
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> utf8.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Tidy.pm_old	2016-03-01 19:46:22.000000000 +0500
+++ Tidy.pm	2016-04-25 16:04:09.984426450 +0500
@@ -3955,15 +3959,13 @@
         unless &#40;$fh&#41; { Perl::Tidy::Die &#34;Cannot write to output stream\n&#34;; }
         $output_file_open = 1;
         if &#40;$binmode&#41; {
-            if &#40; ref&#40;$fh&#41; eq &#39;IO::File&#39; &#41; {
-                if &#40;   $rOpts-&gt;{&#39;character-encoding&#39;}
-                    &#38;&#38; $rOpts-&gt;{&#39;character-encoding&#39;} eq &#39;utf8&#39; &#41;
+            if &#40; $rOpts-&gt;{&#39;character-encoding&#39;}
+                 &#38;&#38; $rOpts-&gt;{&#39;character-encoding&#39;} eq &#39;utf8&#39; &#41;
                 {
-                    binmode $fh, &#34;:encoding&#40;UTF-8&#41;&#34;;
+                    if &#40; ref&#40;$fh&#41; eq &#39;IO::File&#39; &#41; { $fh-&gt;binmode&#40;&#34;:encoding&#40;UTF-8&#41;&#34;&#41;; }
+                    elsif &#40; $output_file eq &#39;-&#39; &#41; { binmode STDOUT, &#34;:encoding&#40;UTF-8&#41;&#34;; }
                 }
-                else { binmode $fh }
-            }
-            if &#40; $output_file eq &#39;-&#39; &#41; { binmode STDOUT }
+            elsif &#40; $output_file eq &#39;-&#39; &#41; { binmode STDOUT }
         }
     }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;25&nbsp;07:41:13&nbsp;2016</span>
    <span class="description">http://mrakobes86reg.id.bk.ru/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> qsimpleq</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Суб Фев 27 12:50:24 2016, SHANCOCK :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; this issue is closed now but will leave the RT ticket open for a
&gt; while.
</div>
And it was the right decision. -st -utf8 continued to be broken. fixed by patch
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> utf8.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Tidy.pm_old	2016-03-01 19:46:22.000000000 +0500
+++ Tidy.pm	2016-04-25 16:04:09.984426450 +0500
@@ -3955,15 +3959,13 @@
         unless &#40;$fh&#41; { Perl::Tidy::Die &#34;Cannot write to output stream\n&#34;; }
         $output_file_open = 1;
         if &#40;$binmode&#41; {
-            if &#40; ref&#40;$fh&#41; eq &#39;IO::File&#39; &#41; {
-                if &#40;   $rOpts-&gt;{&#39;character-encoding&#39;}
-                    &#38;&#38; $rOpts-&gt;{&#39;character-encoding&#39;} eq &#39;utf8&#39; &#41;
+            if &#40; $rOpts-&gt;{&#39;character-encoding&#39;}
+                 &#38;&#38; $rOpts-&gt;{&#39;character-encoding&#39;} eq &#39;utf8&#39; &#41;
                 {
-                    binmode $fh, &#34;:encoding&#40;UTF-8&#41;&#34;;
+                    if &#40; ref&#40;$fh&#41; eq &#39;IO::File&#39; &#41; { $fh-&gt;binmode&#40;&#34;:encoding&#40;UTF-8&#41;&#34;&#41;; }
+                    elsif &#40; $output_file eq &#39;-&#39; &#41; { binmode STDOUT, &#34;:encoding&#40;UTF-8&#41;&#34;; }
                 }
-                else { binmode $fh }
-            }
-            if &#40; $output_file eq &#39;-&#39; &#41; { binmode STDOUT }
+            elsif &#40; $output_file eq &#39;-&#39; &#41; { binmode STDOUT }
         }
     }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;25&nbsp;15:22:13&nbsp;2016</span>
    <span class="description">perltidy [...] users.sourceforge.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #32905] Broken handling of UTF-8 strings</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 25 Apr 2016 12:22:01 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Perl-Tidy [...] rt.cpan.org&#34; &lt;bug-Perl-Tidy [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steven Hancock &lt;perltidy [...] users.sourceforge.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the report and patch.
Steve

On Mon, Apr 25, 2016 at 4:40 AM, <span class="clickylink"><a target="new" rel="nofollow" href="http://mrakobes86reg.id.bk.ru/">http://mrakobes86reg.id.bk.ru/</a></span> via RT &lt;
bug-Perl-Tidy@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Perl-Tidy
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=32905">https://rt.cpan.org/Ticket/Display.html?id=32905</a></span> &gt;
&gt;
&gt; Суб Фев 27 12:50:24 2016, SHANCOCK :
<div class="message-stanza open">&gt; &gt; this issue is closed now but will leave the RT ticket open for a
&gt; &gt; while.
</div>&gt;
&gt; And it was the right decision. -st -utf8 continued to be broken. fixed by
&gt; patch
&gt;
&gt; --- Tidy.pm_old 2016-03-01 19:46:22.000000000 +0500
&gt; +++ Tidy.pm     2016-04-25 16:04:09.984426450 +0500
&gt; @@ -3955,15 +3959,13 @@
&gt;          unless &#40;$fh&#41; { Perl::Tidy::Die &#34;Cannot write to output stream\n&#34;;
&gt; }
&gt;          $output_file_open = 1;
&gt;          if &#40;$binmode&#41; {
&gt; -            if &#40; ref&#40;$fh&#41; eq &#39;IO::File&#39; &#41; {
&gt; -                if &#40;   $rOpts-&gt;{&#39;character-encoding&#39;}
&gt; -                    &#38;&#38; $rOpts-&gt;{&#39;character-encoding&#39;} eq &#39;utf8&#39; &#41;
&gt; +            if &#40; $rOpts-&gt;{&#39;character-encoding&#39;}
&gt; +                 &#38;&#38; $rOpts-&gt;{&#39;character-encoding&#39;} eq &#39;utf8&#39; &#41;
&gt;                  {
&gt; -                    binmode $fh, &#34;:encoding&#40;UTF-8&#41;&#34;;
&gt; +                    if &#40; ref&#40;$fh&#41; eq &#39;IO::File&#39; &#41; {
&gt; $fh-&gt;binmode&#40;&#34;:encoding&#40;UTF-8&#41;&#34;&#41;; }
&gt; +                    elsif &#40; $output_file eq &#39;-&#39; &#41; { binmode STDOUT,
&gt; &#34;:encoding&#40;UTF-8&#41;&#34;; }
&gt;                  }
&gt; -                else { binmode $fh }
&gt; -            }
&gt; -            if &#40; $output_file eq &#39;-&#39; &#41; { binmode STDOUT }
&gt; +            elsif &#40; $output_file eq &#39;-&#39; &#41; { binmode STDOUT }
&gt;          }
&gt;      }
&gt;
&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;21&nbsp;12:37:11&nbsp;2017</span>
    <span class="description">perltidy [...] users.sourceforge.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This patch is implemented in version 20170521.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;20:20:06&nbsp;2020</span>
    <span class="description">perltidy [...] users.sourceforge.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think this can be closed now
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;20:20:07&nbsp;2020</span>
    <span class="description">perltidy [...] users.sourceforge.net -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
