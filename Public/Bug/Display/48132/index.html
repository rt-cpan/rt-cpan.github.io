<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #48132 for Net-SSLeay: Looping connection fix by ssl error checking</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #48132 for Net-SSLeay: Looping connection fix by ssl error checking</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-SSLeay/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SSLeay">Net-SSLeay CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">48132</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">20 min

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-SSLeay/Active/">Net-SSLeay</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">MIKEM [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
eli [...] dvns.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
mj [...] ucw.cz

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-44414-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
1.31_01</li>
<li>
1.31_02</li>
<li>
1.32</li>
<li>
1.33_01</li>
<li>
1.34</li>
<li>
1.35</li>
</ul>
    </td>
  </tr>
  <tr id="CF-44415-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;23&nbsp;19:41:18&nbsp;2009</span>
    <span class="description">eli [...] dvns.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> mj [...] ucw.cz</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Looping connection fix by ssl error checking</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Outstanding bug &#40;see 44170 requested by marm&#41; where a disconnect socket
that occurs during a ssl_write_all loops forever attempting to retry.

However marm&#39;s patch breaks the contract of attempting again on -1 under
certain conditions.  After in-depth study the SSL_write and
SSL_get_error man pages, under certain conditions we should continue to
loop and call the same IO function again.  It appears that this patch
would break this by always reporting the errno if the ERR_get_errors did
not have return values.

The correct way is to check for SSL_get_errors via get_errors, and
ignore certain errors that occur during session renegotiation that are
non fatal to attempting to write the data again.

I believe my attached patch should be applied instead, and marm&#39;s
backed-out.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> netssley-ssl_write_all-error_checking.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -r -U 3 -N Net-SSLeay-1.35/lib/Net/SSLeay.pm Net-SSLeay-1.35_ssl_write_all_checkSSLErrors/lib/Net/SSLeay.pm
--- Net-SSLeay-1.35/lib/Net/SSLeay.pm	2008-07-24 17:09:26.000000000 -0500
+++ Net-SSLeay-1.35_ssl_write_all_checkSSLErrors/lib/Net/SSLeay.pm	2009-07-23 18:06:52.000000000 -0500
@@ -1924,11 +1924,122 @@
 	if &#40;defined $wrote &#38;&#38; &#40;$wrote &gt; 0&#41;&#41; {  # write_partial can return -1
 	    $written += $wrote;
 	    $to_write -= $wrote;
-	}
+	} else {
+	  if &#40;defined $wrote&#41; {
+	    # check error conditions via SSL_get_error per man page
+	    if &#40; my $sslerr = get_error&#40;$ssl, $wrote&#41; &#41; {
+	      my $errstr = ERR_error_string&#40;$sslerr&#41;;
+	      my $errname = &#39;&#39;;
+	      SWITCH: {
+		$sslerr == constant&#40;&#34;ERROR_NONE&#34;&#41; &#38;&#38; do {
+		  # according to map page SSL_get_error&#40;3ssl&#41;:
+		  #  The TLS/SSL I/O operation completed.  
+		  #  This result code is returned if and only if ret &gt; 0
+                  # so if we received it here complain...
+		  warn &#34;ERROR_NONE unexpected with invalid return value!&#34; 
+		    if $trace;
+		  $errname = &#34;SSL_ERROR_NONE&#34;;
+		};
+		$sslerr == constant&#40;&#34;ERROR_WANT_READ&#34;&#41; &#38;&#38; do {
+		  # operation did not complete, call again later, so do not
+		  # set errname and empty err_que since this is a known
+		  # error that is expected but, we should continue to try
+		  # writing the rest of our data with same io call and params.
+		  warn &#34;ERROR_WANT_READ &#40;TLS/SSL Handshake, will continue&#41;\n&#34;
+		    if $trace;
+		  print_errs&#40;&#39;SSL_write&#40;want read&#41;&#39;&#41;;
+		  last SWITCH;
+		};
+		$sslerr == constant&#40;&#34;ERROR_WANT_WRITE&#34;&#41; &#38;&#38; do {
+		  # operation did not complete, call again later, so do not
+		  # set errname and empty err_que since this is a known
+		  # error that is expected but, we should continue to try
+		  # writing the rest of our data with same io call and params.
+		  warn &#34;ERROR_WANT_WRITE &#40;TLS/SSL Handshake, will continue&#41;\n&#34;
+		    if $trace;
+		  print_errs&#40;&#39;SSL_write&#40;want write&#41;&#39;&#41;;
+		  last SWITCH;
+		};
+		$sslerr == constant&#40;&#34;ERROR_ZERO_RETURN&#34;&#41; &#38;&#38; do {
+		  # valid protocol closure from other side, no longer able to
+		  # write, since there is no longer a session...
+		  warn &#34;ERROR_ZERO_RETURN&#40;$wrote&#41;: TLS/SSLv3 Closure alert\n&#34;
+		    if $trace;
+		  $errname = &#34;SSL_ERROR_ZERO_RETURN&#34;;
+		  last SWITCH;
+		};
+		$sslerr == constant&#40;&#34;ERROR_SSL&#34;&#41; &#38;&#38; do {
+		  # library/protocol error
+		  warn &#34;ERROR_SSL&#40;$wrote&#41;: Library/Protocol error occured\n&#34;
+		    if $trace;
+		  $errname = &#34;SSL_ERROR_SSL&#34;;
+		  last SWITCH;
+		};
+		$sslerr == constant&#40;&#34;ERROR_WANT_CONNECT&#34;&#41; &#38;&#38; do {
+		  # according to man page, should never happen on call to
+		  # SSL_write, so complain, but handle as known error type
+		  warn &#34;ERROR_WANT_CONNECT: Unexpected error for SSL_write\n&#34;
+		    if $trace;
+		  $errname = &#34;SSL_ERROR_WANT_CONNECT&#34;;
+		  last SWITCH;
+		};
+		$sslerr == constant&#40;&#34;ERROR_WANT_ACCEPT&#34;&#41; &#38;&#38; do { 
+		  # according to man page, should never happen on call to
+		  # SSL_write, so complain, but handle as known error type
+		  warn &#34;ERROR_WANT_ACCEPT: Unexpected error for SSL_write\n&#34;
+		    if $trace;
+		  $errname = &#34;SSL_ERROR_WANT_ACCEPT&#34;;
+		  last SWITCH;
+		};
+		$sslerr == constant&#40;&#34;ERROR_WANT_X509_LOOKUP&#34;&#41; &#38;&#38; do {
+		  # operation did not complete: waiting on call back,  
+		  # call again later, so do not set errname and empty err_que
+		  # since this is a known error that is expected but, we should
+		  # continue to try writing the rest of our data with same io
+		  # call parameter.
+		  warn &#34;ERROR_WANT_X509_LOOKUP: &#40;Cert Callback asked for in &#34;.
+		    &#34;SSL_write will contine&#41;\n&#34; if $trace;
+		  print_errs&#40;&#39;SSL_write&#40;want x509&#39;&#41;;
+		  last SWITCH;
+		};
+		$sslerr == constant&#40;&#34;ERROR_SYSCALL&#34;&#41; &#38;&#38; do {
+		  # some IO error occured. According to man page: 
+		  # Check retval, ERR, fallback to errno
+		  if &#40;$wrote==0&#41; { # EOF
+		    warn &#34;ERROR_SYSCALL&#40;$wrote&#41;: EOF violates protocol.\n&#34;
+		      if $trace;
+		    $errname = &#34;SSL_ERROR_SYSCALL&#40;EOF&#41;&#34;;
+		  } else { # -1 underlying BIO error reported.
+		    # check error que for details, don&#39;t set errname since we
+		    # are directly appending to errs
+		    my $chkerrs = print_errs&#40;&#39;SSL_write &#40;syscall&#41;&#39;&#41;;
+		    if &#40;$chkerrs&#41; { 
+		      warn &#34;ERROR_SYSCALL&#40;$wrote&#41;: Have errors\n&#34; if $trace;
+		      $errs .= &#34;ssl_write_all $$: 1 - ERROR_SYSCALL&#40;$wrote,&#34;.
+			&#34;$sslerr,$errstr,$!&#41;\n$chkerrs&#34;;
+		    } else { # que was empty, use errno
+		      warn &#34;ERROR_SYSCALL&#40;$wrote&#41;: errno&#40;$!&#41;\n&#34; if $trace;
+		      $errs .= &#34;ssl_write_all $$: 1 - ERROR_SYSCALL&#40;$wrote,&#34;.
+			&#34;$sslerr&#41; : $!\n&#34;;
+		    }
+		  }
+		  last SWITCH;
+		};
+		warn &#34;Unhandled val $sslerr from SSL_get_error&#40;SSL,$wrote&#41;\n&#34;
+		  if $trace;
+		$errname = &#34;SSL_ERROR_?&#40;$sslerr&#41;&#34;;
+	      } # end of SWITCH block
+	      if &#40;$errname&#41; { # if we had an errname set add the error
+		$errs .= &#34;ssl_write_all $$: 1 - $errname&#40;$wrote,$sslerr,&#34;.
+		  &#34;$errstr,$!&#41;\n&#34;;
+	      }	      
+	    } # endif on have SSL_get_error val
+	  } # endif on $wrote defined
+	} # endelse on $wrote &gt; 0
 	$vm = $trace&gt;2 &#38;&#38; $linux_debug ?
 	    &#40;split &#39; &#39;, `cat /proc/$$/stat`&#41;[22] : &#39;vm_unknown&#39;;
 	warn &#34;  written so far $wrote:$written bytes &#40;VM=$vm&#41;\n&#34; if $trace&gt;2;
-	
+	# append remaining errors in que and report if errs exist
 	$errs .= print_errs&#40;&#39;SSL_write&#39;&#41;;
 	return &#40;wantarray ? &#40;undef, $errs&#41; : undef&#41; if $errs;
     }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;26&nbsp;17:54:17&nbsp;2009</span>
    <span class="description">MIKEM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">20 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for your patch. The previous patch has been backed out as 
suggested and yours applied. Now available in SVN.

Cheers.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;26&nbsp;17:54:17&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;26&nbsp;17:54:18&nbsp;2009</span>
    <span class="description">MIKEM [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;26&nbsp;17:54:19&nbsp;2009</span>
    <span class="description">MIKEM [...] cpan.org -  Given to MIKEM</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
