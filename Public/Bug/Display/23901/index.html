<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #23901 for Data-Serializer: Data::Serializer::Retrieve doesn&#39;t slurp files</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #23901 for Data-Serializer: Data::Serializer::Retrieve doesn&#39;t slurp files</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Data-Serializer/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Data-Serializer/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Data-Serializer/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Data-Serializer/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Data-Serializer">Data-Serializer CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">23901</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time estimated">
    <td class="label">Estimated:</td>
    <td class="value">15 min

</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">15 min

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Data-Serializer/Active/">Data-Serializer</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">neil [...] neely.cx
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jamie.lentin [...] bbc.co.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-9312-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-9313-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;12&nbsp;10:50:49&nbsp;2006</span>
    <span class="description">jamie.lentin [...] bbc.co.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Data::Serializer::Retrieve doesn&#39;t slurp files</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">If you try to use retrieve to read a file that contains a newline, the 
deserialization won&#39;t work.  When retrieve&#40;&#41; reads a file into $input, 
it will stop at any \n in the file since $/ is still defined.

A &#34;local $/&#34; at the beginning of the function should sort it.  Or 
alternatively using File::Slurp or something.

Cheers for all your work!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;02&nbsp;15:14:51&nbsp;2007</span>
    <span class="description">neil [...] frii.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> jamie.lentin [...] bbc.co.uk</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #23901] Data::Serializer::Retrieve doesn&#39;t slurp files </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 2 Mar 2007 13:14:32 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Data-Serializer [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Neil Neely &lt;neil [...] frii.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I don&#39;t normally manipulate $/ so wanted to give your report some  
proper study before determining the correct course of action -  
unfortunately nearly 4 months snuck in between that thought and my  
first serious attempt to get to the bottom of what you reported.

When I tried to reproduce the error you were reporting, I could not  
actually do so under normal operations.  No matter how many newlines  
one put at the end of a serialized data structure, it would  
deserialize just fine.

What I was able to determine was that if you undefine $/ in the  
global context I could reproduce what you were describing.  Looking  
at perldoc perlvar, it has this to say on the subject:

[snip]
        You should be very careful when modifying the default values  
of most
        special variables described in this document. In most cases  
you want to
        localize these variables before changing them, since if you  
don&#39;t, the
        change may affect other modules which rely on the default  
values of the
        special variables that you have changed. This is one of the  
correct
        ways to read the whole file at once:

            open my $fh, &#34;foo&#34; or die $!;
            local $/; # enable localized slurp mode
            my $content = &lt;$fh&gt;;
            close $fh;

        But the following code is quite bad:

            open my $fh, &#34;foo&#34; or die $!;
            undef $/; # enable slurp mode
            my $content = &lt;$fh&gt;;
            close $fh;

        since some other module, may want to read data from some file  
in the
        default &#34;line mode&#34;, so if the code we have just presented  
has been
        executed, the global value of $/ is now changed for any other  
code run-
        ning inside the same Perl interpreter.

        Usually when a variable is localized you want to make sure  
that this
        change affects the shortest scope possible. So unless you are  
already
        inside some short &#34;{}&#34; block, you should create one yourself.  
For exam-
        ple:

            my $content = &#39;&#39;;
            open my $fh, &#34;foo&#34; or die $!;
            {
                local $/;
                $content = &lt;$fh&gt;;
            }
            close $fh;

[/snip]

With this said, can you reproduce this problem with the following  
test code:

[snip]
#!/usr/bin/perl

use warnings;
use strict;
use Data::Serializer;
use Data::Dumper;

my $d = Data::Serializer-&gt;new&#40;&#41;;
{
         local $/;

         my $ref = {a =&gt; &#39;b&#39;};
         my $serialized = $d-&gt;serialize&#40;$ref&#41;;

         #$d-&gt;store&#40;$ref,&#39;store.txt&#39;&#41;;

         open&#40;OUT, &#39;&gt;&#39;, &#39;store.txt&#39;&#41; || die &#34;Couldn&#39;t write to  
store.txt: $!\n&#34;;
         print OUT &#34;$serialized\n\n\n&#34;;
         close&#40;OUT&#41;;
}

#File method
my $thaw = $d-&gt;retrieve&#40;&#39;store.txt&#39;&#41;;
print Dumper $thaw;

#Filehandle method
open&#40;IN, &#39;&lt;&#39;, &#39;store.txt&#39;&#41;;
my $fh_thaw = $d-&gt;retrieve&#40;\*IN&#41;;
close&#40;IN&#41;;
print Dumper $fh_thaw;

[/snip]

As you can see from the above, that is storing a serialized value  
followed with three newlines, with a localized $/ undefined.  As long  
as $/ remains correctly defined on the reading side these functions  
should operate correctly.

My main hesitation with altering this behavior is that I like the  
functionality of $/ as it varies per OS, and by relying on it being  
correctly set it keeps Data::Serializer from having to understand or  
care about what that value happens to be.  That said, I am open to  
being convinced otherwise and making Data::Serializer play nicer with  
those who mess with their $/ in the global namespace.

--
Neil





On Dec 12, 2006, at 8:50 AM, Jamie Lentin via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; Tue Dec 12 10:50:49 2006: Request 23901 was acted upon.
&gt; Transaction: Ticket created by lentinj
&gt;        Queue: Data-Serializer
&gt;      Subject: Data::Serializer::Retrieve doesn&#39;t slurp files
&gt;    Broken in: 0.32, 0.36
&gt;     Severity: Normal
&gt;        Owner: Nobody
&gt;   Requestors: jamie.lentin@bbc.co.uk
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=23901">http://rt.cpan.org/Ticket/Display.html?id=23901</a></span> &gt;
&gt;
&gt;
&gt; If you try to use retrieve to read a file that contains a newline, the
&gt; deserialization won&#39;t work.  When retrieve&#40;&#41; reads a file into $input,
&gt; it will stop at any \n in the file since $/ is still defined.
&gt;
&gt; A &#34;local $/&#34; at the beginning of the function should sort it.  Or
&gt; alternatively using File::Slurp or something.
&gt;
&gt; Cheers for all your work!
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;02&nbsp;15:14:53&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;05&nbsp;11:50:55&nbsp;2007</span>
    <span class="description">neil [...] neely.cx -  TimeEstimated changed from &#40;no value&#41; to &#39;15&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;05&nbsp;11:50:55&nbsp;2007</span>
    <span class="description">neil [...] neely.cx -  TimeWorked changed from &#40;no value&#41; to &#39;15&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;05&nbsp;11:50:56&nbsp;2007</span>
    <span class="description">neil [...] neely.cx -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;05&nbsp;11:51:03&nbsp;2007</span>
    <span class="description">neil [...] neely.cx -  Given to NEELY</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;05&nbsp;11:51:05&nbsp;2007</span>
    <span class="description">neil [...] neely.cx -  Broken in 0.32 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;05&nbsp;11:51:05&nbsp;2007</span>
    <span class="description">neil [...] neely.cx -  Broken in 0.36 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
