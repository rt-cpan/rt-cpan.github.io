<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #100546 for Rose-DB-Object: add_relname does not add object if relationship list is still undefined</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #100546 for Rose-DB-Object: add_relname does not add object if relationship list is still undefined</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Rose-DB-Object/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Rose-DB-Object/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Rose-DB-Object/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Rose-DB-Object/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Rose-DB-Object">Rose-DB-Object CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">100546</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Rose-DB-Object/Active/">Rose-DB-Object</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
m.bunkus [...] linet-services.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-28000-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-28001-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




signature.asc<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1436519/763660/signature.asc">
Tue Nov 25 10:27:54 2014 (181b) by m.bunkus [...] linet-services.de
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1436473/763627/signature.asc">
Tue Nov 25 08:34:27 2014 (181b) by m.bunkus [...] linet-services.de
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;25&nbsp;08:34:27&nbsp;2014</span>
    <span class="description">m.bunkus [...] linet-services.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> add_relname does not add object if relationship list is still undefined</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 25 Nov 2014 14:33:55 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Rose-DB-Object [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Moritz Bunkus &lt;m.bunkus [...] linet-services.de&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hey,

We noticed this with a one-to-many relationship. Let&#39;s assume you have a
customer with many contacts. The classes are named
MyDB::Customer and MyDB::Contact, and inside MyDB::Customer there&#39;s the
normal __PACKAGE__-&gt;add_relationship&#40;…&#41; with &#39;contacts&#39; being the name.

The problem is the following:

my $customer = MyDB::Customer-&gt;new;
$customer-&gt;add_contacts&#40;MyDB::Contact-&gt;new&#41;;
print scalar&#40;@{ $customer-&gt;contacts || [] }&#41;; # this will output 0

After adding the contact the contact will not show up in
$customer-&gt;contacts until you save the $customer. Instead
$customer-&gt;contacts returns undef.

The same happens with existing customers if you forcefully unset the
relationship before:

my $customer = MyDB::Customer-&gt;new;
$customer-&gt;contacts&#40;undef&#41;;
$customer-&gt;add_contacts&#40;MyDB::Contact-&gt;new&#41;;
print scalar&#40;@{ $customer-&gt;contacts || [] }&#41;; # this will output 0

You can circumvent the whole sharade if you forcefully set the
relationship to an empty array reference. The first example now looks
like this:

my $customer = MyDB::Customer-&gt;new&#40;contacts =&gt; []&#41;;
$customer-&gt;add_contacts&#40;MyDB::Contact-&gt;new&#41;;
print scalar&#40;@{ $customer-&gt;contacts || [] }&#41;; # this will output 1

This is extremely unpredictable behavior and makes working with RDBO as
an object system pretty nasty; point in case: we&#39;ve just spent roughly
three hours digging through Rose&#39;s code in order to track down why it
happens.

The culprit seems to be the way Rose handles the local cache of
add_on_save interfaces. As far as I can tell all new additions seem to
be saved in a post-save hook in $self-&gt;{ON_SAVE_ATTR_NAME&#40;&#41;}{post} and
_additionally_ also in $self-&gt;{$key}, but only if that already exists.

Since $self-&gt;{$key} will also get cleared when calling $obj-&gt;rel&#40;undef&#41;, the
add_on_save interface stops working there, too.

Kind regards,
Moritz Bunkus

-- 
Dipl.-Inform. Moritz Bunkus
Geschäftsführer/CTO

LINET Services GmbH | Cyriaksring 10a | 38118 Braunschweig
Tel. 0531-180508-0 | Fax 0531-180508-29 | <span class="clickylink"><a target="new" rel="nofollow" href="http://www.linet-services.de">http://www.linet-services.de</a></span>

LINET in den sozialen Netzwerken:
<span class="clickylink"><a target="new" rel="nofollow" href="https://twitter.com/linetservices">https://twitter.com/linetservices</a></span> | <span class="clickylink"><a target="new" rel="nofollow" href="https://www.facebook.com/linetservices">https://www.facebook.com/linetservices</a></span>
Wissenswertes aus der IT-Welt: <span class="clickylink"><a target="new" rel="nofollow" href="http://www.linet-services.de/blog/">http://www.linet-services.de/blog/</a></span>

Geschäftsführung: Moritz Bunkus, Philip Reetz und Timo Springmann
HR B 9170 Amtsgericht Braunschweig

USt-IdNr. DE 259 526 516
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1436473/763627/signature.asc">Download signature.asc</a><br />
<span class="downloadcontenttype">application/pgp-signature 181b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;25&nbsp;09:48:35&nbsp;2014</span>
    <span class="description">siracusa [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This behavior is correct. When you call an add_* method, an accurate representation of the full set of items requires knowing the existing set of items. If you set the existing items by calling the set method &#40;e.g., by setting it to []&#41; then the existing set of items is known &#40;now empty&#41; and the added items can be added to it directly.  If the existing set of items is unknown, we can&#39;t just add items because then the relationship method&#40;s&#41; will return an incorrect population that does not include items from the set that existed before the addition.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;25&nbsp;09:48:35&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;25&nbsp;09:48:36&nbsp;2014</span>
    <span class="description">siracusa [...] gmail.com -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;25&nbsp;10:27:53&nbsp;2014</span>
    <span class="description">m.bunkus [...] linet-services.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #100546] add_relname does not add object if relationship list is still undefined</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 25 Nov 2014 16:27:29 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Rose-DB-Object [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Moritz Bunkus &lt;m.bunkus [...] linet-services.de&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hey,

first of all thanks for replying so quickly.

On Tuesday 25 November 2014 09:48:35 John Siracusa via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This behavior is correct. When you call an add_* method, an accurate
&gt; representation of the full set of items requires knowing the existing set
&gt; of items.
</div>…

Granted, that explains why $obj-&gt;add_stuff&#40;undef&#41; acts like it
does. However, if the object itself is brand new &#40;MyDB::Class-&gt;new…&#41;
then there can be no set of existing items in the database and
add_stuff&#40;&#41; could simply create a new set of items. The existing set of
items is known in that case: it&#39;s empty.

The case that&#39;s more troubling to me is indeed the one with the new
instance. For example, if I have some generic code that wants to add
an element to an object no matter if the object is new or comes from the
database then that code has to check whether or not the object is new
and the relationship is still undef, if so, set the relationship to an
empty array and call add_stuff&#40;&#41; afterwards. Yes, we can do that, of
course, but it&#39;s very, very surprising to the user of that code.

Generic code that wants to use $obj-&gt;add_stuff&#40;&#41; in a way that ensures
that following code can simply access $obj-&gt;stuff&#40;&#41; has to do these
steps &#40;pseudo-code&#41;:

1. If $obj is a new instance &#40;think Rose::DB::Object::Util::is_in_db&#40;&#41;
   is falsish&#41;: initialize with an empty array ref to force »yeah we
   know it&#39;s empty«: $obj-&gt;stuff&#40;[]&#41;

2. Otherwise: read the relationship at least once in order to make sure
   that its state is not unknown anymore; $obj-&gt;stuff

3. Finally the $obj is sure about the state of the relationship and we
   can $obj-&gt;add_stuff&#40;&#41;

So please reconsider changing this behavior for the »new object«
case at least. Thanks.

Kind regards,
Moritz

-- 
Dipl.-Inform. Moritz Bunkus
Geschäftsführer/CTO

LINET Services GmbH | Cyriaksring 10a | 38118 Braunschweig
Tel. 0531-180508-0 | Fax 0531-180508-29 | <span class="clickylink"><a target="new" rel="nofollow" href="http://www.linet-services.de">http://www.linet-services.de</a></span>

LINET in den sozialen Netzwerken:
<span class="clickylink"><a target="new" rel="nofollow" href="https://twitter.com/linetservices">https://twitter.com/linetservices</a></span> | <span class="clickylink"><a target="new" rel="nofollow" href="https://www.facebook.com/linetservices">https://www.facebook.com/linetservices</a></span>
Wissenswertes aus der IT-Welt: <span class="clickylink"><a target="new" rel="nofollow" href="http://www.linet-services.de/blog/">http://www.linet-services.de/blog/</a></span>

Geschäftsführung: Moritz Bunkus, Philip Reetz und Timo Springmann
HR B 9170 Amtsgericht Braunschweig

USt-IdNr. DE 259 526 516
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1436519/763660/signature.asc">Download signature.asc</a><br />
<span class="downloadcontenttype">application/pgp-signature 181b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;25&nbsp;10:35:55&nbsp;2014</span>
    <span class="description">siracusa [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Nov 25 10:27:53 2014, m.bunkus@linet-services.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Granted, that explains why $obj-&gt;add_stuff&#40;undef&#41; acts like it
&gt; does. However, if the object itself is brand new &#40;MyDB::Class-&gt;new…&#41;
&gt; then there can be no set of existing items in the database
</div>
That&#39;s not true. You could set the primary key column&#40;s&#41; on the newly constructed object at any time, making it an as-yet-un-load&#40;&#41;ed incarnation of an existing database row.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
