<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #64836 for ZeroMQ: Message Corruption/Loss </title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #64836 for ZeroMQ: Message Corruption/Loss </h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/ZeroMQ/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/ZeroMQ/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/ZeroMQ/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/ZeroMQ/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/ZeroMQ">ZeroMQ CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">64836</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/ZeroMQ/Active/">ZeroMQ</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jason [...] ball.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-233900-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.05    </td>
  </tr>
  <tr id="CF-233901-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;17&nbsp;01:55:49&nbsp;2011</span>
    <span class="description">jason [...] ball.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Message Corruption/Loss</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have found I get a lot of corrupted messages and it looks like a race
condition where a message partially overwrites a prior message that was
sent a few hundred microseconds earlier.

I have attached a new test case/torture test demonstrating this
behaviour.  I have found that this only occurs when a number of messages
are sent in rapid succession - and introducing a delay in the sender
does reduce the ocurrence of the problem suggesting the race condition.

This test script sets up a publisher and a subscriber, the publisher
then sends 1000 messages &#40;the content being 0-999&#41;.   The subscriber
should receive these in order, or at the very least receive them all.

I don&#39;t think I&#39;ve stuffed up the test... always possible ;&#41;

The final message should be &#39;end&#39;.

An example failed test:

[root@bjbld02 t]# perl 999_messagecorruptions.t |less
#   Failed test &#39;Error -- messages not received in sequence or corrupt&#39;
#   at /usr/lib/perl5/5.8.8/Test/More.pm line 372.
#          got: &#39;end&#39;
#     expected: &#39;859&#39;
#   Failed test &#39;Error -- messages not received in sequence or corrupt&#39;
#   at /usr/lib/perl5/5.8.8/Test/More.pm line 372.
#          got: &#39;end&#39;
#     expected: &#39;860&#39;
#   Failed test &#39;Error -- messages not received in sequence or corrupt&#39;
#   at /usr/lib/perl5/5.8.8/Test/More.pm line 372.
#          got: &#39;end&#39;
#     expected: &#39;861&#39;
#   Failed test &#39;Error -- messages not received in sequence or corrupt&#39;
#   at /usr/lib/perl5/5.8.8/Test/More.pm line 372.
#          got: &#39;end&#39;
#     expected: &#39;862&#39;
#   Failed test &#39;Error -- messages not received in sequence or corrupt&#39;
#   at /usr/lib/perl5/5.8.8/Test/More.pm line 372.
#          got: &#39;end&#39;
#     expected: &#39;863&#39;
#   Failed test &#39;Error -- messages not received in sequence or corrupt&#39;
#   at /usr/lib/perl5/5.8.8/Test/More.pm line 372.
#          got: &#39;end&#39;
#     expected: &#39;864&#39;
#   Failed test &#39;Error -- messages not received in sequence or corrupt&#39;
#   at /usr/lib/perl5/5.8.8/Test/More.pm line 372.
#          got: &#39;end&#39;
#     expected: &#39;865&#39;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 999_messagecorruptions.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use Test::More;
use Test::Requires qw&#40; Test::TCP AnyEvent &#41;;
use ZeroMQ qw&#40;ZMQ_PUB ZMQ_SUB ZMQ_SNDMORE&#41;;
use Time::HiRes qw&#40;usleep&#41;;

BEGIN {
    use_ok &#34;ZeroMQ&#34;;
    use_ok &#34;ZeroMQ::Constants&#34;, &#34;:all&#34;;
}


my $port = empty_port&#40;&#41;;

test_tcp&#40;
    client =&gt; sub {
        my $port = shift;
        my $ctxt = ZeroMQ::Context-&gt;new&#40;&#41;;
        my $sock = $ctxt-&gt;socket&#40;ZMQ_SUB&#41;;

	sleep&#40;1&#41;;
        $sock-&gt;connect&#40;&#34;tcp://127.0.0.1:$port&#34; &#41;;
	$sock-&gt;setsockopt&#40;ZMQ_SUBSCRIBE, &#39;&#39;&#41;;
        my $data = join &#39;.&#39;, time&#40;&#41;, $$, rand, {};

	my $cnt=0;

	while&#40;$cnt&lt;1000&#41; {		# expect to receive numbers 1..1000...
          my $msg = undef;
	  $msg = $sock-&gt;recv&#40;&#41;;
	  is&#40;$msg-&gt;data, $cnt++, &#34;Error -- messages not received in sequence or corrupt&#34;&#41;;
	} 

	note &#34;OK&#34;;
    },
    server =&gt; sub {
        my $port = shift;
        my $ctxt = ZeroMQ::Context-&gt;new&#40;&#41;;
        my $sock = $ctxt-&gt;socket&#40;ZMQ_PUB&#41;;

	note &#34;Server Binding to port $port\n&#34;;
        $sock-&gt;bind&#40;&#34;tcp://127.0.0.1:$port&#34;&#41;;

	note &#34;Waiting on client to bind...&#34;;
	sleep 5;

	note &#34;Server sending ordered data... &#40;numbers 1..1000&#41;&#34;;
	for &#40;my $c=0; $c&lt;1000; $c++&#41; {
        	$sock-&gt;send&#40;$c, ZMQ_SNDMORE&#41;;
		#usleep&#40;1000&#41;;
	}
	$sock-&gt;send&#40;&#34;end&#34;&#41;; # end of data stream...
	note &#34;OK&#34;;
    }
&#41;;

done_testing;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;17&nbsp;02:01:29&nbsp;2011</span>
    <span class="description">dmaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

thanks for the report.
I haven&#39;t looked at your report closely yet, but do you think this is a Perl binding issue? Have you 
tried with, say, just the C binding?

Just curious -- if it&#39;s zeromq itself, I&#39;d save myself a ton of debug time ;&#41;

--d
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;17&nbsp;02:01:34&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;17&nbsp;02:50:57&nbsp;2011</span>
    <span class="description">jason [...] ball.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #64836] Message Corruption/Loss</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 17 Jan 2011 18:50:46 +1100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-ZeroMQ [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Ball &lt;jason [...] ball.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ll code a version using the raw sockets shortly.  I was going to do so
tonight to see if that solves the problem ;&#41;

Cheers
J.


On Mon, Jan 17, 2011 at 6:01 PM, Daisuke Maki via RT &lt;bug-ZeroMQ@rt.cpan.org
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; wrote:
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=64836">https://rt.cpan.org/Ticket/Display.html?id=64836</a></span> &gt;
&gt;
&gt; Hi,
&gt;
&gt; thanks for the report.
&gt; I haven&#39;t looked at your report closely yet, but do you think this is a
&gt; Perl binding issue? Have you
&gt; tried with, say, just the C binding?
&gt;
&gt; Just curious -- if it&#39;s zeromq itself, I&#39;d save myself a ton of debug time
&gt; ;&#41;
&gt;
&gt; --d
&gt;
</div>


-- 
--
Illegitimi non carborundum
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;17&nbsp;03:20:41&nbsp;2011</span>
    <span class="description">jason [...] ball.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jason [...] ball.net</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
I&#39;ve coded a test using the ZeroMQ::Raw API and sadly the same behaviour is present.   I&#39;ll look 
at a C version shortly to determine if it&#39;s ZeroMQ or the Perl binding.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 999_messagecorruptions_lowlevel.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use Test::More;
use Test::Requires qw&#40; Test::TCP &#41;;
use Data::Dumper;

BEGIN {
    use_ok &#34;ZeroMQ::Raw&#34;;
    use_ok &#34;ZeroMQ::Constants&#34;, &#34;:all&#34;;
}


my $port = empty_port&#40;&#41;;

test_tcp&#40;
    client =&gt; sub {
        my $port = shift;
        my $ctxt = zmq_init&#40;&#41;;
        my $sock = zmq_socket&#40;$ctxt, ZMQ_SUB&#41;;

	sleep&#40;1&#41;;
        zmq_connect&#40;$sock,&#34;tcp://127.0.0.1:$port&#34; &#41;;
	zmq_setsockopt&#40;$sock, ZMQ_SUBSCRIBE, &#39;&#39;&#41;;

	my $cnt=0;

	while&#40;$cnt&lt;1000&#41; {		# expect to receive numbers 1..1000...
          my $rawmsg = undef;
	  $rawmsg = zmq_recv&#40;$sock&#41;;
	  my $msg = zmq_msg_data&#40;$rawmsg&#41;;
	  is&#40;$msg, $cnt++, &#34;Error -- messages not received in sequence or corrupt&#34;&#41;;
	} 

	note &#34;OK&#34;;
    },
    server =&gt; sub {
        my $port = shift;
        my $ctxt = zmq_init&#40;&#41;;
        my $sock = zmq_socket&#40;$ctxt, ZMQ_PUB&#41;;

	note &#34;Server Binding to port $port\n&#34;;
        zmq_bind&#40;$sock, &#34;tcp://127.0.0.1:$port&#34;&#41;;

	note &#34;Waiting on client to bind...&#34;;
	sleep 5;

	note &#34;Server sending ordered data... &#40;numbers 1..1000&#41;&#34;;
	for &#40;my $c=0; $c&lt;1000; $c++&#41; {
		my $msg = zmq_msg_init_data&#40;$c&#41;;
        	zmq_send&#40;$sock, $msg&#41;;
		zmq_msg_close&#40;$msg&#41;;
	}
	note &#34;OK&#34;;
    }
&#41;;

done_testing;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;17&nbsp;04:11:31&nbsp;2011</span>
    <span class="description">jason [...] ball.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jason [...] ball.net</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This problem does not occur at the &#39;C&#39; level, so it&#39;s in the binding.  I suspect it is a sender side 
issue &#40;zmq_send&#41;.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> torture_server.c</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#include &lt;zmq.h&gt;
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;

int main&#40;&#41; {
	void *context = zmq_init&#40;1&#41;;
	
	void *pub = zmq_socket&#40;context, ZMQ_PUB&#41;;
	zmq_bind&#40;pub, &#34;tcp://*:14567&#34;&#41;;

	int c;	
	printf&#40;&#34;Server: Waiting for client to connect\n&#34;&#41;;
	sleep&#40;10&#41;;
	printf&#40;&#34;Server: Sending Messages\n&#34;&#41;;
	for&#40;c=0; c&lt;10000; c++&#41; {
		char buffer[10];
		zmq_msg_t msg;

		snprintf&#40;&#40;char *&#41;&#38;buffer, 10, &#34;%d&#34;, c&#41;;

		zmq_msg_init_size&#40;&#38;msg, sizeof&#40;buffer&#41;&#41;;
		memcpy&#40;&#40;void *&#41; zmq_msg_data&#40;&#38;msg&#41;, buffer, 10&#41;;
		zmq_send&#40;pub, &#38;msg, 0&#41;;
		zmq_msg_close&#40;&#38;msg&#41;;
	}
	printf&#40;&#34;Server: Waiting to exit\n&#34;&#41;;
	sleep&#40;20&#41;;
	printf&#40;&#34;Server: Exiting\n&#34;&#41;;
	zmq_term&#40;context&#41;;
}
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> torture_client.c</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#include &lt;zmq.h&gt;
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;

int main&#40;&#41; {
	void *context = zmq_init&#40;1&#41;;
	
	void *sub = zmq_socket&#40;context, ZMQ_SUB&#41;;
	printf&#40;&#34;Connecting to Server\n&#34;&#41;;
	zmq_connect&#40;sub, &#34;tcp://*:14567&#34;&#41;;
	zmq_setsockopt&#40;sub, ZMQ_SUBSCRIBE, &#34;&#34;, 0&#41;;

	int c;	
	printf&#40;&#34;Waiting for messages\n&#34;&#41;;
	for&#40;c=0; c&lt;10000; c++&#41; {
		char buffer[10];
		zmq_msg_t msg;
		zmq_msg_init&#40;&#38;msg&#41;;
		zmq_recv&#40;sub, &#38;msg, 0&#41;;
		printf&#40;&#34;Received Message\n&#34;&#41;;

		int value = atoi&#40;&#40;char *&#41;zmq_msg_data&#40;&#38;msg&#41;&#41;;
		
		if&#40;c != value&#41; {
			printf&#40;&#34;ERROR: expected %d, got %d\n&#34;, c, value&#41;;
		} else {
			printf&#40;&#34;OK: Got %d\n&#34;, value&#41;;
		}
		zmq_msg_close&#40;&#38;msg&#41;;
	}
	zmq_term&#40;context&#41;;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;17&nbsp;04:25:00&nbsp;2011</span>
    <span class="description">dmaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you, you rock!

The bad news is I&#39;m going to be a bit tied for the next couple of days :/
I&#39;ll get back to this as soon as I can.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;17&nbsp;04:35:00&nbsp;2011</span>
    <span class="description">jason [...] ball.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jason [...] ball.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jan 17 04:25:00 2011, DMAKI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thank you, you rock!
&gt; 
&gt; The bad news is I&#39;m going to be a bit tied for the next couple of days :/
&gt; I&#39;ll get back to this as soon as I can.
</div>
I&#39;ll see if I can patch it in the meantime...  
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;17&nbsp;06:08:03&nbsp;2011</span>
    <span class="description">jason [...] ball.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jason [...] ball.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Definitely a race condition.  Adding:

 threads-&gt;yield&#40;&#41;;

to the test immediately following the &#39;zmq_send... zmq_msg_close&#39; significantly reduces the 
ocurrences of the problem.  I&#39;m not sure &#40;at this time&#41; how to debug this one :/

J.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;17&nbsp;07:06:55&nbsp;2011</span>
    <span class="description">dmaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the work!

While I&#39;m agree this smells fishy, I&#39;m not so sure about the threading problem bit.
As far as I can see, there&#39;s no threading involved in my part of the code :/

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Definitely a race condition.  Adding:
&gt; 
&gt;  threads-&gt;yield&#40;&#41;;
&gt; 
</div>
Where are you adding this threads-&gt;yield&#40;&#41; ?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;17&nbsp;07:11:59&nbsp;2011</span>
    <span class="description">jason [...] ball.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jason [...] ball.net</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">calling it a day.  I have attached a patch with the tests developed so far -- once I work out 
the basics for github I&#39;ll submit updates there to make life simpler,

I get consistent results with these tests:

t/999_messagecorruptions.t ........... Failed 100/102 subtests 
t/999_messagecorruptions_lowlevel.t .. ok   

The tests _should_ be identical.  Note that increasing the number of messages in these tests 
will induce errors in the low level code -- nowhere near as badly as the higher level binding.  
Removing the &#39;threads-&gt;yield&#39; guarantees a 100% failure rate in both tests -- I&#39;m afraid I 
need to spend more time reviewing the code to understand why this would make any 
difference at all.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ZeroMQ-Perl-message-curruption-tests.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">commit ded0374098e3014b2fe73e9c7cfbec4e618e6243
Author: Jason Ball &lt;jason.ball@tibra.com&gt;
Date:   Mon Jan 17 22:55:14 2011 +1100

    Test cases for low level corruptions

diff --git a/t/999_messagecorruptions.t b/t/999_messagecorruptions.t
new file mode 100644
index 0000000..5a00340
--- /dev/null
+++ b/t/999_messagecorruptions.t
@@ -0,0 +1,57 @@
+use strict;
+use Test::More;
+use Test::Requires qw&#40; Test::TCP AnyEvent &#41;;
+use ZeroMQ qw&#40;ZMQ_PUB ZMQ_SUB ZMQ_SNDMORE&#41;;
+use Time::HiRes qw&#40;usleep&#41;;
+
+BEGIN {
+    use_ok &#34;ZeroMQ&#34;;
+    use_ok &#34;ZeroMQ::Constants&#34;, &#34;:all&#34;;
+}
+
+
+my $port = empty_port&#40;&#41;;
+
+test_tcp&#40;
+    client =&gt; sub {
+        my $port = shift;
+        my $ctxt = ZeroMQ::Context-&gt;new&#40;&#41;;
+        my $sock = $ctxt-&gt;socket&#40;ZMQ_SUB&#41;;
+
+	sleep&#40;1&#41;;
+        $sock-&gt;connect&#40;&#34;tcp://127.0.0.1:$port&#34; &#41;;
+	$sock-&gt;setsockopt&#40;ZMQ_SUBSCRIBE, &#39;&#39;&#41;;
+        my $data = join &#39;.&#39;, time&#40;&#41;, $$, rand, {};
+
+	my $cnt=0;
+
+	while&#40;$cnt&lt;1000&#41; {		# expect to receive numbers 1..1000...
+          my $msg = undef;
+	  $msg = $sock-&gt;recv&#40;&#41;;
+	  is&#40;$msg-&gt;data, $cnt++, &#34;Error -- messages not received in sequence or corrupt&#34;&#41;;
+	} 
+
+	note &#34;OK&#34;;
+    },
+    server =&gt; sub {
+        my $port = shift;
+        my $ctxt = ZeroMQ::Context-&gt;new&#40;&#41;;
+        my $sock = $ctxt-&gt;socket&#40;ZMQ_PUB&#41;;
+
+	note &#34;Server Binding to port $port\n&#34;;
+        $sock-&gt;bind&#40;&#34;tcp://127.0.0.1:$port&#34;&#41;;
+
+	note &#34;Waiting on client to bind...&#34;;
+	sleep 5;
+
+	note &#34;Server sending ordered data... &#40;numbers 1..1000&#41;&#34;;
+	for &#40;my $c=0; $c&lt;1000; $c++&#41; {
+        	$sock-&gt;send&#40;$c, ZMQ_SNDMORE&#41;;
+		#usleep&#40;1000&#41;;
+	}
+	$sock-&gt;send&#40;&#34;end&#34;&#41;; # end of data stream...
+	note &#34;OK&#34;;
+    }
+&#41;;
+
+done_testing;
diff --git a/t/999_messagecorruptions_lowlevel.t b/t/999_messagecorruptions_lowlevel.t
new file mode 100644
index 0000000..caf2bd9
--- /dev/null
+++ b/t/999_messagecorruptions_lowlevel.t
@@ -0,0 +1,56 @@
+use strict;
+use Test::More;
+use Test::Requires qw&#40; Test::TCP &#41;;
+use Data::Dumper;
+
+BEGIN {
+    use_ok &#34;ZeroMQ::Raw&#34;;
+    use_ok &#34;ZeroMQ::Constants&#34;, &#34;:all&#34;;
+}
+
+
+my $port = empty_port&#40;&#41;;
+
+test_tcp&#40;
+    client =&gt; sub {
+        my $port = shift;
+        my $ctxt = zmq_init&#40;&#41;;
+        my $sock = zmq_socket&#40;$ctxt, ZMQ_SUB&#41;;
+
+	sleep&#40;1&#41;;
+        zmq_connect&#40;$sock,&#34;tcp://127.0.0.1:$port&#34; &#41;;
+	zmq_setsockopt&#40;$sock, ZMQ_SUBSCRIBE, &#39;&#39;&#41;;
+
+	my $cnt=0;
+
+	while&#40;$cnt&lt;1000&#41; {		# expect to receive numbers 1..1000...
+          my $rawmsg = undef;
+	  $rawmsg = zmq_recv&#40;$sock&#41;;
+	  my $msg = zmq_msg_data&#40;$rawmsg&#41;;
+	  is&#40;$msg, $cnt++, &#34;Error -- messages not received in sequence or corrupt&#34;&#41;;
+	} 
+
+	note &#34;OK&#34;;
+    },
+    server =&gt; sub {
+        my $port = shift;
+        my $ctxt = zmq_init&#40;&#41;;
+        my $sock = zmq_socket&#40;$ctxt, ZMQ_PUB&#41;;
+
+	note &#34;Server Binding to port $port\n&#34;;
+        zmq_bind&#40;$sock, &#34;tcp://127.0.0.1:$port&#34;&#41;;
+
+	note &#34;Waiting on client to bind...&#34;;
+	sleep 5;
+
+	note &#34;Server sending ordered data... &#40;numbers 1..1000&#41;&#34;;
+	for &#40;my $c=0; $c&lt;1000; $c++&#41; {
+		my $msg = zmq_msg_init_data&#40;$c&#41;;
+        	zmq_send&#40;$sock, $msg&#41;;
+		zmq_msg_close&#40;$msg&#41;;
+	}
+	note &#34;OK&#34;;
+    }
+&#41;;
+
+done_testing;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;17&nbsp;07:31:18&nbsp;2011</span>
    <span class="description">dmaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">thanks!

I&#39;ll check your work -- meanwhile, I think I&#39;m onto something.
using zmq_msg_init_size + zmq_msg_data like you&#39;re doing in your torture_server.c
fixes the problem ... so I&#39;m starting to think that I&#39;m not using the zmq_msg_* API
correctly.

Will work on it for a couple of more hours.
Thank you so much for your work!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;17&nbsp;07:53:28&nbsp;2011</span>
    <span class="description">dmaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed! I was able to pin-point the problem because you provided me with a working C example. 
Thank you so much.

Please checkout the current HEAD, or the tarball from master: 

<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/lestrrat/ZeroMQ-Perl/tarball/master">http://github.com/lestrrat/ZeroMQ-Perl/tarball/master</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;17&nbsp;15:12:05&nbsp;2011</span>
    <span class="description">jason [...] ball.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jason [...] ball.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dude!

That is awesome news, thanks!  

Cheers
J.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;17&nbsp;15:55:29&nbsp;2011</span>
    <span class="description">jason [...] ball.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jason [...] ball.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Confirmed as working.

Cheers.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;17&nbsp;17:25:09&nbsp;2011</span>
    <span class="description">dmaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Cool, just shipped 0.06. should be on CPAN sonn-ish.

Closing ticket :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;17&nbsp;17:25:10&nbsp;2011</span>
    <span class="description">dmaki [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
