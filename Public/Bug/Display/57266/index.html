<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #57266 for DBD-mysql: Error in 40server_prepare.t</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #57266 for DBD-mysql: Error in 40server_prepare.t</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-mysql/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-mysql">DBD-mysql CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">57266</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-mysql/Active/">DBD-mysql</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">CAPTTOFU [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
atsekhan [...] cox.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10170-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
4.014    </td>
  </tr>
  <tr id="CF-10171-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
4.034    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;06&nbsp;14:40:56&nbsp;2010</span>
    <span class="description">atsekhan [...] cox.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Error in 40server_prepare.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On AIX 5.3 &#40;oslevel - 5300-09-02-0849&#41; with 64-bit PERL 5.8.2 and MySQL 
Binary distribution 5.1.46 I get this error in make test:

t/40server_prepare.t ........ 1/21
#   Failed test at t/40server_prepare.t line 67.
#     Structures begin differing at:
#          $got-&gt;[0][0] = &#39;0&#39;
#     $expected-&gt;[0][0] = &#39;101&#39;
# Looks like you failed 1 test of 21.
t/40server_prepare.t ........ Dubious, test returned 1 &#40;wstat 256, 
0x100&#41;
Failed 1/21 subtests

Total statistics:

Test Summary Report
-------------------
t/40server_prepare.t      &#40;Wstat: 256 Tests: 21 Failed: 1&#41;
  Failed test:  20
  Non-zero exit status: 1
Files=38, Tests=777,  6 wallclock secs &#40; 0.37 usr  0.09 sys +  2.45 
cusr  0.25 csys =  3.16 CPU&#41;
Result: FAIL
Failed 1/38 test programs. 1/777 subtests failed.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;16&nbsp;08:52:26&nbsp;2010</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;16&nbsp;08:53:30&nbsp;2010</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for reporting this! I haven&#39;t seen this error on Linux, OSX,
or other operating systems I have access to. Is there any way I could
have access to your machine to investigate this? 

On Thu May 06 14:40:56 2010, atsekhan wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On AIX 5.3 &#40;oslevel - 5300-09-02-0849&#41; with 64-bit PERL 5.8.2 and MySQL 
&gt; Binary distribution 5.1.46 I get this error in make test:
&gt; 
&gt; t/40server_prepare.t ........ 1/21
&gt; #   Failed test at t/40server_prepare.t line 67.
&gt; #     Structures begin differing at:
&gt; #          $got-&gt;[0][0] = &#39;0&#39;
&gt; #     $expected-&gt;[0][0] = &#39;101&#39;
&gt; # Looks like you failed 1 test of 21.
&gt; t/40server_prepare.t ........ Dubious, test returned 1 &#40;wstat 256, 
&gt; 0x100&#41;
&gt; Failed 1/21 subtests
&gt; 
&gt; Total statistics:
&gt; 
&gt; Test Summary Report
&gt; -------------------
&gt; t/40server_prepare.t      &#40;Wstat: 256 Tests: 21 Failed: 1&#41;
&gt;   Failed test:  20
&gt;   Non-zero exit status: 1
&gt; Files=38, Tests=777,  6 wallclock secs &#40; 0.37 usr  0.09 sys +  2.45 
&gt; cusr  0.25 csys =  3.16 CPU&#41;
&gt; Result: FAIL
&gt; Failed 1/38 test programs. 1/777 subtests failed.
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;16&nbsp;08:53:43&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;16&nbsp;09:38:12&nbsp;2010</span>
    <span class="description">atsekhan [...] cox.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #57266] Error in 40server_prepare.t </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 16 May 2010 09:38:01 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-DBD-mysql [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Alex Tsekhansky&#34; &lt;atsekhan [...] cox.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">That would be difficult as it&#39;s behind firewall, and requires special 
provisions for access.

However, if you want me to run test scripts there, I can do it for you and 
report results.

In a mean time I simply ignored the error and forced the install. I do not 
have datatypes in my database that cause this, so everything is working fine 
so far.

--------------------------------------------------
From: &#34;Patrick Galbraith via RT&#34; &lt;bug-DBD-mysql@rt.cpan.org&gt;
Sent: Sunday, May 16, 2010 8:53 AM
To: &lt;atsekhan@cox.net&gt;
Subject: [rt.cpan.org #57266] Error in 40server_prepare.t

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=57266">https://rt.cpan.org/Ticket/Display.html?id=57266</a></span> &gt;
&gt;
&gt; Thank you for reporting this! I haven&#39;t seen this error on Linux, OSX,
&gt; or other operating systems I have access to. Is there any way I could
&gt; have access to your machine to investigate this?
&gt;
&gt; On Thu May 06 14:40:56 2010, atsekhan wrote:
<div class="message-stanza open">&gt;&gt; On AIX 5.3 &#40;oslevel - 5300-09-02-0849&#41; with 64-bit PERL 5.8.2 and MySQL
&gt;&gt; Binary distribution 5.1.46 I get this error in make test:
&gt;&gt;
&gt;&gt; t/40server_prepare.t ........ 1/21
&gt;&gt; #   Failed test at t/40server_prepare.t line 67.
&gt;&gt; #     Structures begin differing at:
&gt;&gt; #          $got-&gt;[0][0] = &#39;0&#39;
&gt;&gt; #     $expected-&gt;[0][0] = &#39;101&#39;
&gt;&gt; # Looks like you failed 1 test of 21.
&gt;&gt; t/40server_prepare.t ........ Dubious, test returned 1 &#40;wstat 256,
&gt;&gt; 0x100&#41;
&gt;&gt; Failed 1/21 subtests
&gt;&gt;
&gt;&gt; Total statistics:
&gt;&gt;
&gt;&gt; Test Summary Report
&gt;&gt; -------------------
&gt;&gt; t/40server_prepare.t      &#40;Wstat: 256 Tests: 21 Failed: 1&#41;
&gt;&gt;   Failed test:  20
&gt;&gt;   Non-zero exit status: 1
&gt;&gt; Files=38, Tests=777,  6 wallclock secs &#40; 0.37 usr  0.09 sys +  2.45
&gt;&gt; cusr  0.25 csys =  3.16 CPU&#41;
&gt;&gt; Result: FAIL
&gt;&gt; Failed 1/38 test programs. 1/777 subtests failed.
&gt;&gt;
</div>&gt;
&gt;
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;26&nbsp;11:04:03&nbsp;2010</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">resolving this bug.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;26&nbsp;11:04:04&nbsp;2010</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;16&nbsp;03:48:54&nbsp;2016</span>
    <span class="description">vlmarek [...] volny.cz -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;16&nbsp;05:03:57&nbsp;2016</span>
    <span class="description">vlmarek [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> vlmarek [...] volny.cz</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I&#39;m having the same issue on Sparc, which is big-endian. Moreover I&#39;m compiling 64bit which is probably contributing factor. I have taken some steps in fixing the issue, but I&#39;m nowhere done. I want to post my findings and hope to receive some comments on the approach. I have not tested yet my changes on little-endian machine, so I may be breaking it at the moment :&#41;

I&#39;m attaching DBI trace log file from the unchanged sources named &#39;dbitrace.log.orig&#39;. On line 301 you can see that &#39;101&#39; is being bound. After the test executed the sql table dbd_mysql_t40serverprepare2 contains only four zeros &#40;verified via command line mysql client&#41;.

    -&gt; bind_param for DBD::mysql::st &#40;DBI::st=HASH&#40;0xf118985b58&#41;~0xf1188715e0 1 101 4&#41; thr#f1182eb880
   Called: dbd_bind_ph
   SCALAR type 4 -&gt;0&lt;- IS A INT NUMBER
   FORCE REBIND: buffer type changed from 254 to 3, sql-type=4

There are two points to note
a&#41; line 303 says that the number is &#39;0&#39;. But this is red herring, this is not the issue, but rather broken number printing.

dbdimp.c: 4878
   char *buffer= NULL;
   ...
   buffer=&#40;void*&#41;&#38;&#40;imp_sth-&gt;fbind[idx].numeric_val.lval&#41;;
   if &#40;DBIc_TRACE_LEVEL&#40;imp_xxh&#41; &gt;= 2&#41;
     PerlIO_printf&#40;DBIc_LOGPIO&#40;imp_xxh&#41;,
                   &#34;   SCALAR type %d -&gt;%ld&lt;- IS A INT NUMBER\n&#34;,
                   &#40;int&#41; sql_type, &#40;long&#41; &#40;*buffer&#41;&#41;;

&#40;long&#41;&#40;*buffer&#41; means &#39;dereference&#39; char* and convert result to long &#40;I think :&#41; &#41;. If I change the conversion to
&#40;*&#40;long*&#41;buffer&#41;, the debug line starts to print correctly &#39;101&#39;. But the test outcome is still the same.

b&#41; line 304 &#34;FORCE REBIND: buffer type changed from 254 to 3, sql-type=4&#34;. I am not sure what that means exactly, but the dbdimp.c has a comment:

    /* Type of column was changed. Force to rebind */
    if &#40;imp_sth-&gt;bind[idx].buffer_type != buffer_type&#41; {
      /* Note: this looks like being another bug:
       * if type of parameter N changes, then a bind is triggered
       * with an only partially filled bind structure ??
       */
      if &#40;DBIc_TRACE_LEVEL&#40;imp_xxh&#41; &gt;= 2&#41;
          PerlIO_printf&#40;DBIc_LOGPIO&#40;imp_xxh&#41;,
                        &#34;   FORCE REBIND: buffer type changed from %d to %d, sql-type=%d\n&#34;,
                        &#40;int&#41; imp_sth-&gt;bind[idx].buffer_type, buffer_type, &#40;int&#41; sql_type&#41;;
      imp_sth-&gt;has_been_bound = 0;
    }

That does not look too assuring.





To fix the data storing to database I have modified struct imp_sth_phb_st to contain int32_t:

typedef struct imp_sth_phb_st {
    union
    {
      long lval;
      double dval;
      int32_t i32;
    } numeric_val;
    unsigned long   length;
    char            is_null;
} imp_sth_phb_t;


Back at dbdimp.c, I can now use:

          buffer_length = sizeof imp_sth-&gt;fbind[idx].numeric_val.i32;
          imp_sth-&gt;fbind[idx].numeric_val.i32= SvIV&#40;imp_sth-&gt;params[idx].value&#41;;
          buffer=&#40;void*&#41;&#38;&#40;imp_sth-&gt;fbind[idx].numeric_val.i32&#41;;
          break;           

&#40; using long does not work because it&#39;s 8 bytes long in my case &#41;.

And that stores the numbers mostly corerctly to DB. It does not work for BIGINT
&#40;I have tried int64_t, but somehow that did not work for me&#41;. Also I can&#39;t
store 4294967295 to DBI::SQL_INTEGER and 18446744073709551615 to
DBI::SQL_BIGINT because it says that the value is too large, but that might be
problem elsewhere. I did no investigation on this yet.



So storing a number to mysql mostly works for now, another problem is reading
it back. I suspect that there is similar problem - using long. But I fell
asleep before finding where this happens.


Sorry for the erratic report, its work in progress. Any comments welcome!

Cheers
__ 
  Vlad
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dbitrace.log.orig</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;16&nbsp;06:07:51&nbsp;2016</span>
    <span class="description">vlmarek [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> vlmarek [...] volny.cz</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So storing a number to mysql mostly works for now, another problem is
&gt; reading it back. I suspect that there is similar problem - using long.
&gt; But I fell asleep before finding where this happens.
</div>
Yup, if I change struct imp_sth_fbh_st member &#39;ldata&#39; to int32_t, and in
function dbd_st_fetch change &#40;long&#41; to &#40;int32_t&#41; the tests start to pass.

          if &#40;DBIc_TRACE_LEVEL&#40;imp_xxh&#41; &gt;= 2&#41;
            PerlIO_printf&#40;DBIc_LOGPIO&#40;imp_xxh&#41;, &#34;\t\tst_fetch int data %d, unsigned? %d\n&#34;,
                          &#40;int32_t&#41; fbh-&gt;ldata, buffer-&gt;is_unsigned&#41;;


My next steps will be to put my patches together and test it on both x86 and
sparc. Once that starts working I want to add
 - tests for minimum and maximum values for all supported INT types
 - take a look why BIGINT does not work


Cheers
__ 
  Vlad
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;16&nbsp;08:39:35&nbsp;2016</span>
    <span class="description">vlmarek [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> vlmarek [...] volny.cz</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m attaching the patch I have at the moment. But I found more issues, perl is
core dumping on exit with the DBD::mysql module.

$ pstack core
core &#39;core&#39; of 818825:  /usr/perl5/5.20/bin/perl t/00base.t
 0000000000000000 ???????? &#40;fffffe26fe0a95b1, 0, 1, 0, 7ff9b961272c0, 0&#41;
 0007ff9b95ef60b8 _exithandle &#40;2880, 7ff9b96124a40, 2800, 100004aac, ffffffffffd0e7b0, 2f1800&#41; + 60
 0007ff9b95ee506c exit &#40;0, 0, 7ff9b9585e7b0, 0, 7ff9b95b50000, 0&#41; + 4
 0000000100004aac main &#40;0, 7ff9b95b5f8c0, 100106000, 7ff9b9585c0d4, 7ff9b95b5ac38, 100200000&#41; + 1ac
 0000000100001c68 _start &#40;0, 0, 0, 0, 0, 100106000&#41; + 108


My suspicion is that there is some function registered via atexit. I added

exec &#34;/bin/true&#34;; at the end of the test script and really perl no longer
crashes &#40;exec discards any atexit registered calls&#41;.


The crashing occured even before me starting patching the sources, I just never
noticed before :&#41;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> endian.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- DBD-mysql-4.033/dbdimp.c	2016-02-16 04:39:12.852079166 -0800
+++ DBD-mysql-4.033/dbdimp.c	2016-02-16 04:38:42.856000275 -0800
@@ -4879,7 +4879,7 @@ int dbd_bind_ph&#40;SV *sth, imp_sth_t *imp_
           if &#40;DBIc_TRACE_LEVEL&#40;imp_xxh&#41; &gt;= 2&#41;
             PerlIO_printf&#40;DBIc_LOGPIO&#40;imp_xxh&#41;,
                           &#34;   SCALAR type %d -&gt;%ld&lt;- IS A INT NUMBER\n&#34;,
-                          &#40;int&#41; sql_type, &#40;long&#41; &#40;*buffer&#41;&#41;;
+                          &#40;int&#41; sql_type, *&#40;&#40;int32_t *&#41;buffer&#41;&#41;;
           break;
 
         case MYSQL_TYPE_DOUBLE:
--- DBD-mysql-4.033/dbdimp.h	2016-02-16 04:39:55.405194264 -0800
+++ DBD-mysql-4.033/dbdimp.h	2016-02-16 04:39:48.165925859 -0800
@@ -212,7 +212,7 @@ typedef struct imp_sth_ph_st {
 typedef struct imp_sth_phb_st {
     union
     {
-      long lval;
+      int32_t lval;
       double dval;
     } numeric_val;
     unsigned long   length;
@@ -233,7 +233,7 @@ typedef struct imp_sth_fbh_st {
     char           *data;
     int            charsetnr;
     double         ddata;
-    long           ldata;
+    int32_t        ldata;
 #if MYSQL_VERSION_ID &lt; FIELD_CHARSETNR_VERSION 
     unsigned int   flags;
 #endif
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;26&nbsp;09:02:09&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I stumble on this problem on s390x machine which is 64-bit big-endian platform. Attached is a little more thorough fix.

A table at &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://dev.mysql.com/doc/refman/5.7/en/mysql-stmt-fetch.html">http://dev.mysql.com/doc/refman/5.7/en/mysql-stmt-fetch.html</a></span>&gt; explains that MYSQL_TYPE_LONG is 4-byte long, thus you correctly changed the type to int32_t.

What bothers me is that if I try to store larger value than a column type allows, it will silently pass and the stored value will be wrapped. But the mysql&#40;1&#41; client works the same way. It only warns about out-of-range values. Maybe it&#39;s MysSQL feature.

Maybe the DBD::MySQL could check a stored value against requested type that was declared in the bind_param&#40;&#41; call and return a failure.

Also the fourth value from the the tests inserted by:

ok&#40;$sth2-&gt;bind_param&#40;4, 104, DBI::SQL_INTEGER&#41;, &#34;binding bigint&#34;&#41;;

should be spelled as

ok&#40;$sth2-&gt;bind_param&#40;4, 104, DBI::SQL_BIGINT&#41;, &#34;binding bigint&#34;&#41;;

But even with DBI::SQL_BIGINT, the value is transferred as MYSQL_TYPE_LONG instead of MYSQL_TYPE_LONGLONG. Something is fishy there.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Fix-transferring-MYSQL_TYPE_LONG-values-on-64-bit-bi.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 95b210810301f0a5c87adc0d682bc8424dfb41d0 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Fri, 26 Feb 2016 13:32:31 +0100
Subject: [PATCH] Fix transferring MYSQL_TYPE_LONG values on 64-bit big endian
 systems
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

t/40server_prepare.t test failed on s390x platform. Server-prepared
values of types int, smallint, and tinyint are passed to application
as 32-bit integer. The same buffer was interpreted as long integer
by DBD::MySQL. This caused missaligned read/write and bogus
interpretation of the values.

<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=57266">https://rt.cpan.org/Public/Bug/Display.html?id=57266</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="https://bugzilla.redhat.com/show_bug.cgi?id=1311646">https://bugzilla.redhat.com/show_bug.cgi?id=1311646</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://dev.mysql.com/doc/refman/5.7/en/mysql-stmt-fetch.html">http://dev.mysql.com/doc/refman/5.7/en/mysql-stmt-fetch.html</a></span>
Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 dbdimp.c | 20 +++++++++++++-------
 dbdimp.h |  5 +++--
 2 files changed, 16 insertions&#40;+&#41;, 9 deletions&#40;-&#41;

diff --git a/dbdimp.c b/dbdimp.c
index d507588..9a1be20 100644
--- a/dbdimp.c
+++ b/dbdimp.c
@@ -18,6 +18,7 @@
 #endif
 
 #include &#34;dbdimp.h&#34;
+#include &lt;inttypes.h&gt; /* for PRId32 */
 
 #if defined&#40;WIN32&#41;  &#38;&#38;  defined&#40;WORD&#41;
 #undef WORD
@@ -3753,8 +3754,8 @@ int dbd_describe&#40;SV* sth, imp_sth_t* imp_sth&#41;
 
       if &#40;DBIc_TRACE_LEVEL&#40;imp_xxh&#41; &gt;= 2&#41;
       {
-        PerlIO_printf&#40;DBIc_LOGPIO&#40;imp_xxh&#41;,&#34;\t\ti %d col_type %d fbh-&gt;length %d\n&#34;,
-                      i, col_type, &#40;int&#41; fbh-&gt;length&#41;;
+        PerlIO_printf&#40;DBIc_LOGPIO&#40;imp_xxh&#41;,&#34;\t\ti %d col_type %d fbh-&gt;length %lu\n&#34;,
+                      i, col_type, fbh-&gt;length&#41;;
         PerlIO_printf&#40;DBIc_LOGPIO&#40;imp_xxh&#41;,
                       &#34;\t\tfields[i].length %lu fields[i].max_length %lu fields[i].type %d fields[i].charsetnr %d\n&#34;,
                       &#40;long unsigned int&#41; fields[i].length, &#40;long unsigned int&#41; fields[i].max_length, fields[i].type,
@@ -4015,8 +4016,8 @@ process:
 
         case MYSQL_TYPE_LONG:
           if &#40;DBIc_TRACE_LEVEL&#40;imp_xxh&#41; &gt;= 2&#41;
-            PerlIO_printf&#40;DBIc_LOGPIO&#40;imp_xxh&#41;, &#34;\t\tst_fetch int data %d, unsigned? %d\n&#34;,
-                          &#40;int&#41; fbh-&gt;ldata, buffer-&gt;is_unsigned&#41;;
+            PerlIO_printf&#40;DBIc_LOGPIO&#40;imp_xxh&#41;, &#34;\t\tst_fetch int data %&#34;PRId32&#34;, unsigned? %d\n&#34;,
+                          fbh-&gt;ldata, buffer-&gt;is_unsigned&#41;;
           if &#40;buffer-&gt;is_unsigned&#41;
             sv_setuv&#40;sv, fbh-&gt;ldata&#41;;
           else
@@ -4787,6 +4788,7 @@ int dbd_bind_ph&#40;SV *sth, imp_sth_t *imp_sth, SV *param, SV *value,
   int buffer_is_null= 0;
   int buffer_length= slen;
   unsigned int buffer_type= 0;
+  IV tmp;
 #endif
 
   D_imp_dbh_from_sth;
@@ -4874,12 +4876,16 @@ int dbd_bind_ph&#40;SV *sth, imp_sth_t *imp_sth, SV *param, SV *value,
           if &#40;!SvIOK&#40;imp_sth-&gt;params[idx].value&#41; &#38;&#38; DBIc_TRACE_LEVEL&#40;imp_xxh&#41; &gt;= 2&#41;
             PerlIO_printf&#40;DBIc_LOGPIO&#40;imp_xxh&#41;, &#34;\t\tTRY TO BIND AN INT NUMBER\n&#34;&#41;;
           buffer_length = sizeof imp_sth-&gt;fbind[idx].numeric_val.lval;
-          imp_sth-&gt;fbind[idx].numeric_val.lval= SvIV&#40;imp_sth-&gt;params[idx].value&#41;;
+
+          tmp = SvIV&#40;imp_sth-&gt;params[idx].value&#41;;
+          if &#40;tmp &gt; INT32_MAX&#41;
+	        croak&#40;&#34;Could not bind %ld: Integer too large for MYSQL_TYPE_LONG&#34;, tmp&#41;;
+          imp_sth-&gt;fbind[idx].numeric_val.lval= tmp;
           buffer=&#40;void*&#41;&#38;&#40;imp_sth-&gt;fbind[idx].numeric_val.lval&#41;;
           if &#40;DBIc_TRACE_LEVEL&#40;imp_xxh&#41; &gt;= 2&#41;
             PerlIO_printf&#40;DBIc_LOGPIO&#40;imp_xxh&#41;,
-                          &#34;   SCALAR type %d -&gt;%ld&lt;- IS A INT NUMBER\n&#34;,
-                          &#40;int&#41; sql_type, &#40;long&#41; &#40;*buffer&#41;&#41;;
+                          &#34;   SCALAR type %d -&gt;%&#34;PRId32&#34;&lt;- IS A INT NUMBER\n&#34;,
+                          &#40;int&#41; sql_type, *&#40;int32_t *&#41;buffer&#41;;
           break;
 
         case MYSQL_TYPE_DOUBLE:
diff --git a/dbdimp.h b/dbdimp.h
index 8723bcc..1ef5d72 100644
--- a/dbdimp.h
+++ b/dbdimp.h
@@ -22,6 +22,7 @@
 #include &lt;mysqld_error.h&gt;  /* Comes MySQL */
 
 #include &lt;errmsg.h&gt; /* Comes with MySQL-devel */
+#include &lt;stdint.h&gt; /* For int32_t */
 
 /* For now, we hardcode this, but in the future,
  * we can detect capabilities of the MySQL libraries
@@ -212,7 +213,7 @@ typedef struct imp_sth_ph_st {
 typedef struct imp_sth_phb_st {
     union
     {
-      long lval;
+      int32_t lval;
       double dval;
     } numeric_val;
     unsigned long   length;
@@ -233,7 +234,7 @@ typedef struct imp_sth_fbh_st {
     char           *data;
     int            charsetnr;
     double         ddata;
-    long           ldata;
+    int32_t        ldata;
 #if MYSQL_VERSION_ID &lt; FIELD_CHARSETNR_VERSION 
     unsigned int   flags;
 #endif
-- 
2.5.0

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;29&nbsp;18:55:49&nbsp;2016</span>
    <span class="description">vlmarek [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> vlmarek [...] volny.cz</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 26 09:02:09 2016, ppisar wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I stumble on this problem on s390x machine which is 64-bit big-endian
&gt; platform. Attached is a little more thorough fix.
</div>
Many thanks, I was just about to go tackle the improperly read INT values when I found your patch :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What bothers me is that if I try to store larger value than a column
&gt; type allows, it will silently pass and the stored value will be
&gt; wrapped. But the mysql&#40;1&#41; client works the same way. It only warns
&gt; about out-of-range values. Maybe it&#39;s MysSQL feature.
&gt; 
&gt; Maybe the DBD::MySQL could check a stored value against requested type
&gt; that was declared in the bind_param&#40;&#41; call and return a failure.
</div>
That would make sense to me, but I guess it depends on DBD::mysql author.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Also the fourth value from the the tests inserted by:
&gt; 
&gt; ok&#40;$sth2-&gt;bind_param&#40;4, 104, DBI::SQL_INTEGER&#41;, &#34;binding bigint&#34;&#41;;
&gt; 
&gt; should be spelled as
&gt; 
&gt; ok&#40;$sth2-&gt;bind_param&#40;4, 104, DBI::SQL_BIGINT&#41;, &#34;binding bigint&#34;&#41;;
&gt; 
&gt; But even with DBI::SQL_BIGINT, the value is transferred as
&gt; MYSQL_TYPE_LONG instead of MYSQL_TYPE_LONGLONG. Something is fishy
&gt; there.
</div>
I&#39;m just writing tests for minimal, maximal and over the limit values storing. We&#39;ll see if it poses any real problem.

Thanks again
__ 
  Vlad
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;01&nbsp;17:25:39&nbsp;2016</span>
    <span class="description">vlmarek [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> vlmarek [...] volny.cz</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But even with DBI::SQL_BIGINT, the value is transferred as
&gt; MYSQL_TYPE_LONG instead of MYSQL_TYPE_LONGLONG. Something is fishy
&gt; there.
</div>
Seems to work fine on my side, although it does not appear to be correct on first sight.

I am attaching the test file I used to make sure d.various integer types work as expected.

So to me the patch from Petr is a final fix. If you like, you may add the tests I created.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 41int_min_max.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use warnings;
use bigint;

use DBI;
use Test::More;
use lib &#39;t&#39;, &#39;.&#39;;
require &#39;lib.pl&#39;;
use vars qw&#40;$test_dsn $test_user $test_password&#41;;

my $dbh;
eval {$dbh= DBI-&gt;connect&#40;$test_dsn, $test_user, $test_password,
                      { RaiseError =&gt; 1, PrintError =&gt; 1, AutoCommit =&gt; 1 }&#41;;};
if &#40;$@&#41; {
    plan skip_all =&gt; &#34;no database connection&#34;;
}

if &#40;!MinimumVersion&#40;$dbh, &#39;4.1&#39;&#41;&#41; {
    plan skip_all =&gt; &#34;ERROR: $DBI::errstr. Can&#39;t continue test&#34;;
    plan skip_all =&gt;
        &#34;SKIP TEST: You must have MySQL version 4.1 and greater for this test to run&#34;;
}

my $table = &#39;dbd_mysql_t41minmax&#39;; # name of the table we will be using
plan tests =&gt; 11*8 + 2;

sub test_int_type &#40;$$$$&#41; {
    my &#40;$perl_type, $mysql_type, $min, $max&#41; = @_;

    # Disable the warning text clobbering our output
    local $SIG{__WARN__} = sub { 1; };

    # Create the table
    ok&#40;$dbh-&gt;do&#40;qq{DROP TABLE IF EXISTS $table}&#41;, &#34;removing $table&#34;&#41;;
    ok&#40;$dbh-&gt;do&#40;qq{CREATE TABLE `$table` &#40;`val` $mysql_type&#41;}&#41;, &#34;creating minmax table for type $mysql_type&#34;&#41;;

    my $minmax;
    ok&#40;$minmax = $dbh-&gt;prepare&#40;&#34;INSERT INTO $table VALUES &#40;?&#41;&#34;&#41;&#41;;

    # Insert allowed in and max value
    ok&#40;$minmax-&gt;bind_param&#40; 1, $min-&gt;bstr&#40;&#41;, $perl_type &#41;, &#34;binding minimal $mysql_type&#34;&#41;;
    ok&#40;$minmax-&gt;execute&#40;&#41;, &#34;inserting min data for type $mysql_type&#34;&#41;;
    ok&#40;$minmax-&gt;bind_param&#40; 1, $max-&gt;bstr&#40;&#41;, $perl_type &#41;, &#34;binding maximal $mysql_type&#34;&#41;;
    ok&#40;$minmax-&gt;execute&#40;&#41;, &#34;inserting max data for type $mysql_type&#34;&#41;;

    # Try to insert over the limit value
    ok&#40;$minmax-&gt;bind_param&#40; 1, &#40;$min-1&#41;-&gt;bstr&#40;&#41;, $perl_type &#41;, &#34;binding less than minimal $mysql_type&#34;&#41;;
    $@ = &#39;&#39;;
    eval{$minmax-&gt;execute&#40;&#41;};
    like&#40;$@, qr/Out of range value for column &#39;val&#39;/, &#34;less than min exception thrown for $mysql_type&#34;&#41;;

    ok&#40;$minmax-&gt;bind_param&#40; 1, &#40;$max+1&#41;-&gt;bstr&#40;&#41;, $perl_type &#41;, &#34;binding more than maximal $mysql_type&#34;&#41;;
    $@ = &#39;&#39;;
    eval{$minmax-&gt;execute&#40;&#41;};
    like&#40;$@, qr/Out of range value for column &#39;val&#39;/, &#34;more than max exception thrown for $mysql_type&#34;&#41;;
}

test_int_type&#40;DBI::SQL_TINYINT,  &#39;tinyint signed&#39;,     -2**7,  2**7-1&#41;;
test_int_type&#40;DBI::SQL_TINYINT,  &#39;tinyint unsigned&#39;,       0,  2**8-1&#41;;
test_int_type&#40;DBI::SQL_SMALLINT, &#39;smallint signed&#39;,   -2**15, 2**15-1&#41;;
test_int_type&#40;DBI::SQL_SMALLINT, &#39;smallint unsigned&#39;,      0, 2**16-1&#41;;
test_int_type&#40;DBI::SQL_INTEGER,  &#39;int signed&#39;,        -2**31, 2**31-1&#41;;
test_int_type&#40;DBI::SQL_INTEGER,  &#39;int unsigned&#39;,           0, 2**32-1&#41;;
test_int_type&#40;DBI::SQL_BIGINT,   &#39;bigint signed&#39;,     -2**63, 2**63-1&#41;;
test_int_type&#40;DBI::SQL_BIGINT,   &#39;bigint unsigned&#39;,        0, 2**64-1&#41;;

ok &#40;$dbh-&gt;do&#40;&#34;DROP TABLE $table&#34;&#41;&#41;;

ok $dbh-&gt;disconnect;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;02:35:20&nbsp;2016</span>
    <span class="description">MICHIELB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> ppisar [...] redhat.com, vlmarek [...] volny.cz</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the patch and tests!

The test from Vladimir however fails on little-endian test systems, at least on my Debian laptop and also on Travis:
<span class="clickylink"><a target="new" rel="nofollow" href="https://travis-ci.org/perl5-dbi/DBD-mysql/jobs/113055676">https://travis-ci.org/perl5-dbi/DBD-mysql/jobs/113055676</a></span>

this is with or without Petrs patch.
@Vladimir, can you look into that?

--
Michiel


On Tue Mar 01 17:25:39 2016, neuron wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; But even with DBI::SQL_BIGINT, the value is transferred as
&gt; &gt; MYSQL_TYPE_LONG instead of MYSQL_TYPE_LONGLONG. Something is fishy
&gt; &gt; there.
</div>&gt; 
&gt; Seems to work fine on my side, although it does not appear to be
&gt; correct on first sight.
&gt; 
&gt; I am attaching the test file I used to make sure d.various integer
&gt; types work as expected.
&gt; 
&gt; So to me the patch from Petr is a final fix. If you like, you may add
&gt; the tests I created.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;11:14:06&nbsp;2016</span>
    <span class="description">vlmarek [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> vlmarek [...] volny.cz</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; this is with or without Petrs patch.
&gt; @Vladimir, can you look into that?
</div>
Ah, live and learn. mysql has something called &#34;strict sql&#34; mode.
<span class="clickylink"><a target="new" rel="nofollow" href="http://dev.mysql.com/doc/refman/5.6/en/sql-mode.html#sqlmode_strict_all_tables">http://dev.mysql.com/doc/refman/5.6/en/sql-mode.html#sqlmode_strict_all_tables</a></span>
It seems that in my case strict mode is enabled by default, while on linux it is not.

I have updated the tests to go through both strict and no-strict modes, plus I added testing that the over-the-limit value is rounded correctly.

Maybe I&#39;m overthinking it, but I would like to do the porting to 64bit right on first try :&#41;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 41int_min_max.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use warnings;
use bigint;

use DBI;
use Test::More;
use lib &#39;t&#39;, &#39;.&#39;;
use Data::Dumper;
require &#39;lib.pl&#39;;
use vars qw&#40;$test_dsn $test_user $test_password&#41;;

my $dbh;
eval {$dbh= DBI-&gt;connect&#40;$test_dsn, $test_user, $test_password,
                      { RaiseError =&gt; 1, PrintError =&gt; 1, AutoCommit =&gt; 1 }&#41;;};
if &#40;$@&#41; {
    plan skip_all =&gt; &#34;no database connection&#34;;
}

if &#40;!MinimumVersion&#40;$dbh, &#39;4.1&#39;&#41;&#41; {
    plan skip_all =&gt; &#34;ERROR: $DBI::errstr. Can&#39;t continue test&#34;;
    plan skip_all =&gt;
        &#34;SKIP TEST: You must have MySQL version 4.1 and greater for this test to run&#34;;
}
# nostrict tests + strict tests + init/tear down commands
plan tests =&gt; 19*8 + 17*8 + 4;

my $table = &#39;dbd_mysql_t41minmax&#39;; # name of the table we will be using
my $mode; # &#39;strict&#39; or &#39;nostrict&#39; corresponds to strict SQL mode

sub test_int_type &#40;$$$$&#41; {
    my &#40;$perl_type, $mysql_type, $min, $max&#41; = @_;

    # Disable the warning text clobbering our output
    local $SIG{__WARN__} = sub { 1; };

    # Create the table
    ok&#40;$dbh-&gt;do&#40;qq{DROP TABLE IF EXISTS $table}&#41;, &#34;removing $table&#34;&#41;;
    ok&#40;$dbh-&gt;do&#40;qq{
            CREATE TABLE `$table` &#40;
                `id` int not null auto_increment,
                `val` $mysql_type,
                primary key &#40;id&#41;
            &#41;
    }&#41;, &#34;creating minmax table for type $mysql_type&#34;&#41;;

    my &#40;$store, $retrieve&#41;; # statements
    my $read_value;         # retrieved value
    ok&#40;$store = $dbh-&gt;prepare&#40;&#34;INSERT INTO $table &#40;val&#41; VALUES &#40;?&#41;&#34;&#41;&#41;;
    ok&#40;$retrieve = $dbh-&gt;prepare&#40;&#34;SELECT val from $table where id=&#40;SELECT MAX&#40;id&#41; FROM $table&#41;&#34;&#41;&#41;;

    ########################################
    # Insert allowed min value
    ########################################
    ok&#40;$store-&gt;bind_param&#40; 1, $min-&gt;bstr&#40;&#41;, $perl_type &#41;, &#34;binding minimal $mysql_type, mode=$mode&#34;&#41;;
    ok&#40;$store-&gt;execute&#40;&#41;, &#34;inserting min data for type $mysql_type, mode=$mode&#34;&#41;;

    ########################################
    # Read it back and compare
    ########################################
    ok{$retrieve-&gt;execute&#40;&#41;};
    &#40;$read_value&#41; = $retrieve-&gt;fetchrow_array&#40;&#41;;
    cmp_ok&#40;$read_value, &#39;eq&#39;, $min, &#34;retrieved minimal value for $mysql_type, mode=$mode&#34;&#41;;

    ########################################
    # Insert allowed max value
    ########################################
    ok&#40;$store-&gt;bind_param&#40; 1, $max-&gt;bstr&#40;&#41;, $perl_type &#41;, &#34;binding maximal $mysql_type, mode=$mode&#34;&#41;;
    ok&#40;$store-&gt;execute&#40;&#41;, &#34;inserting max data for type $mysql_type, mode=$mode&#34;&#41;;

    ########################################
    # Read it back and compare
    ########################################
    ok{$retrieve-&gt;execute&#40;&#41;};
    &#40;$read_value&#41; = $retrieve-&gt;fetchrow_array&#40;&#41;;
    cmp_ok&#40;$read_value, &#39;eq&#39;, $max, &#34;retrieved maximal value for $mysql_type, mode=$mode&#34;&#41;;

    ########################################
    # Try to insert under the limit value
    ########################################
    ok&#40;$store-&gt;bind_param&#40; 1, &#40;$min-1&#41;-&gt;bstr&#40;&#41;, $perl_type &#41;, &#34;binding less than minimal $mysql_type, mode=$mode&#34;&#41;;
    if &#40;$mode eq &#39;strict&#39;&#41; {
        $@ = &#39;&#39;;
        eval{$store-&gt;execute&#40;&#41;};
        like&#40;$@, qr/Out of range value for column &#39;val&#39;/, &#34;Error, you stored &#34;.&#40;$min-1&#41;.&#34; into $mysql_type, mode=$mode\n&#34;.
            Data::Dumper-&gt;Dump&#40;[$dbh-&gt;selectall_arrayref&#40;&#34;SELECT * FROM $table&#34;&#41;]&#41;.
            Data::Dumper-&gt;Dump&#40;[$dbh-&gt;selectall_arrayref&#40;&#34;describe $table&#34;&#41;]&#41;
        &#41;;
    } else {
        ok{$store-&gt;execute&#40;&#41;};
        ########################################
        # Check that it was rounded correctly
        ########################################
        ok{$retrieve-&gt;execute&#40;&#41;};
        &#40;$read_value&#41; = $retrieve-&gt;fetchrow_array&#40;&#41;;
        cmp_ok&#40;$read_value, &#39;eq&#39;, $min, &#34;retrieved minimal value for type $mysql_type, mode=$mode&#34;&#41;;
    };

    ########################################
    # Try to insert over the limit value
    ########################################
    ok&#40;$store-&gt;bind_param&#40; 1, &#40;$max+1&#41;-&gt;bstr&#40;&#41;, $perl_type &#41;, &#34;binding more than maximal $mysql_type, mode=$mode&#34;&#41;;
    if &#40;$mode eq &#39;strict&#39;&#41; {
        $@ = &#39;&#39;;
        eval{$store-&gt;execute&#40;&#41;};
        like&#40;$@, qr/Out of range value for column &#39;val&#39;/, &#34;Error, you stored &#34;.&#40;$max+1&#41;.&#34; into $mysql_type, mode=$mode\n&#34;.
            Data::Dumper-&gt;Dump&#40;[$dbh-&gt;selectall_arrayref&#40;&#34;SELECT * FROM $table&#34;&#41;]&#41;.
            Data::Dumper-&gt;Dump&#40;[$dbh-&gt;selectall_arrayref&#40;&#34;describe $table&#34;&#41;]&#41;
        &#41;;
    } else {
        ok{$store-&gt;execute&#40;&#41;};
        ########################################
        # Check that it was rounded correctly
        ########################################
        ok{$retrieve-&gt;execute&#40;&#41;};
        &#40;$read_value&#41; = $retrieve-&gt;fetchrow_array&#40;&#41;;
        cmp_ok&#40;$read_value, &#39;eq&#39;, $max, &#34;retrieved maximal value for type $mysql_type, mode=$mode&#34;&#41;;
    };
}

# Set strict SQL mode
ok&#40;$dbh-&gt;do&#40;&#34;SET SQL_MODE=&#39;STRICT_ALL_TABLES&#39;&#34;&#41;,&#34;Enter strict SQL mode.&#34;&#41;;
$mode = &#39;strict&#39;;

test_int_type&#40;DBI::SQL_TINYINT,  &#39;tinyint signed&#39;,     -2**7,  2**7-1&#41;;
test_int_type&#40;DBI::SQL_TINYINT,  &#39;tinyint unsigned&#39;,       0,  2**8-1&#41;;
test_int_type&#40;DBI::SQL_SMALLINT, &#39;smallint signed&#39;,   -2**15, 2**15-1&#41;;
test_int_type&#40;DBI::SQL_SMALLINT, &#39;smallint unsigned&#39;,      0, 2**16-1&#41;;
test_int_type&#40;DBI::SQL_INTEGER,  &#39;int signed&#39;,        -2**31, 2**31-1&#41;;
test_int_type&#40;DBI::SQL_INTEGER,  &#39;int unsigned&#39;,           0, 2**32-1&#41;;
test_int_type&#40;DBI::SQL_BIGINT,   &#39;bigint signed&#39;,     -2**63, 2**63-1&#41;;
test_int_type&#40;DBI::SQL_BIGINT,   &#39;bigint unsigned&#39;,        0, 2**64-1&#41;;

# Do not use strict SQL mode
ok&#40;$dbh-&gt;do&#40;&#34;SET SQL_MODE=&#39;&#39;&#34;&#41;,&#34;Leave strict SQL mode.&#34;&#41;;
$mode = &#39;nostrict&#39;;

test_int_type&#40;DBI::SQL_TINYINT,  &#39;tinyint signed&#39;,     -2**7,  2**7-1&#41;;
test_int_type&#40;DBI::SQL_TINYINT,  &#39;tinyint unsigned&#39;,       0,  2**8-1&#41;;
test_int_type&#40;DBI::SQL_SMALLINT, &#39;smallint signed&#39;,   -2**15, 2**15-1&#41;;
test_int_type&#40;DBI::SQL_SMALLINT, &#39;smallint unsigned&#39;,      0, 2**16-1&#41;;
test_int_type&#40;DBI::SQL_INTEGER,  &#39;int signed&#39;,        -2**31, 2**31-1&#41;;
test_int_type&#40;DBI::SQL_INTEGER,  &#39;int unsigned&#39;,           0, 2**32-1&#41;;
test_int_type&#40;DBI::SQL_BIGINT,   &#39;bigint signed&#39;,     -2**63, 2**63-1&#41;;
test_int_type&#40;DBI::SQL_BIGINT,   &#39;bigint unsigned&#39;,        0, 2**64-1&#41;;

ok &#40;$dbh-&gt;do&#40;&#34;DROP TABLE $table&#34;&#41;&#41;;

ok $dbh-&gt;disconnect;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;09&nbsp;15:43:32&nbsp;2016</span>
    <span class="description">MICHIELB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I added Petrs patch in 4.033_03 but forgot to add it to the change log. I did that now, and added Vladimirs&#39; test as well.

Thanks all for your contributions!
--
Michiel

On Wed 02 Mar 2016 11:14:06, neuron wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; this is with or without Petrs patch.
&gt; &gt; @Vladimir, can you look into that?
</div>&gt; 
&gt; Ah, live and learn. mysql has something called &#34;strict sql&#34; mode.
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://dev.mysql.com/doc/refman/5.6/en/sql-">http://dev.mysql.com/doc/refman/5.6/en/sql-</a></span>
&gt; mode.html#sqlmode_strict_all_tables
&gt; It seems that in my case strict mode is enabled by default, while on
&gt; linux it is not.
&gt; 
&gt; I have updated the tests to go through both strict and no-strict
&gt; modes, plus I added testing that the over-the-limit value is rounded
&gt; correctly.
&gt; 
&gt; Maybe I&#39;m overthinking it, but I would like to do the porting to 64bit
&gt; right on first try :&#41;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;09&nbsp;15:43:33&nbsp;2016</span>
    <span class="description">MICHIELB [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;09&nbsp;15:43:34&nbsp;2016</span>
    <span class="description">MICHIELB [...] cpan.org -  Fixed in 4.034 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
