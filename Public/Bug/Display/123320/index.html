<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #123320 for Text-CSV_XS: Text::CSV_XS bug w/Mac format files</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #123320 for Text-CSV_XS: Text::CSV_XS bug w/Mac format files</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Text-CSV_XS/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Text-CSV_XS/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Text-CSV_XS/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Text-CSV_XS/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Text-CSV_XS">Text-CSV_XS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">123320</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Text-CSV_XS/Active/">Text-CSV_XS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
CLemmen [...] excelsiorintegrated.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-31868-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.22    </td>
  </tr>
  <tr id="CF-31869-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.33    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;18&nbsp;11:30:53&nbsp;2017</span>
    <span class="description">CLemmen [...] excelsiorintegrated.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Text::CSV_XS bug w/Mac format files</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 Oct 2017 13:56:31 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Text-CSV_XS [...] rt.cpan.org&#34; &lt;bug-Text-CSV_XS [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Charles Stuart Lemmen &lt;CLemmen [...] excelsiorintegrated.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I believe I&#39;ve found a bug in the Text::CSV_XS package with regards to Mac type files &#40;eol as single carriage return&#41; and handling successive files with one csv object ref. Below are the relevant details.

Dist name/ver: Text::CSV_XS-1.32
Perl version: This is perl 5, version 24, subversion 0 &#40;v5.24.0&#41; built for MSWin32-x64-multi-thread
O/S: Windows 10 Home &#40;Major version: 10  Minor Version: 0.15063&#41;

Bug details:

If you create one Text::CSV_XS handle and use it with two different files &#40;one with a bad header and one with a good header&#41; that use carriage returns only as end-of-line markers and the first has an invalid header, attempting to get the second &#40;good&#41; file&#39;s header will also fail. Skip getting the first file&#39;s header and the second one succeeds. If you attempt to get the first &#40;bad&#41; file&#39;s header but then clear the &#39;_AHEAD&#39; instance var before getting the second &#40;good&#41; file&#39;s header the second will succeed whereas before it did not.

There are some things about this first file with the bad header that help to cause the second header call to fail:


  1.  If it has only one non-header data record and that record does not end with the end-of-line carriage return.
  2.  If there are multiple non-header records, they all have proper end-of-line carriage returns but the first non-header data record &#40;record #2&#41; has an empty column &#40;,,&#41; - this empty column can be double quoted or not, doesn&#39;t matter.

So it sounds like &#34;leftover&#34; &#39;_AHEAD&#39; data is somehow negatively influencing the handling of other files. Here&#39;s a short code example:

    # First make two csv files, one with an empty &#40;dangling&#41; header column, one that&#39;s ok.
    # These are both &#34;Mac&#34; format meaning only carriage returns for EOL.
    my $bad_csv_file = &#39;test_bad_csv.csv&#39;;
    my $good_csv_file = &#39;test_good_csv.csv&#39;;
    my $bfh;
    my $gfh;
    if&#40;open&#40;$bfh, &#39;&gt;&#39;, $bad_csv_file&#41;&#41; {
        print&#40;$bfh &#34;col1,col2,col3,\r\&#34;One\&#34;,\&#34;\&#34;,\&#34;Three\&#34;\r\&#34;Four\&#34;,\&#34;Five and a half\&#34;,\&#34;Six\&#34;\r&#34;&#41;;
        close $bfh;
    }
    if&#40;open&#40;$gfh, &#39;&gt;&#39;, $good_csv_file&#41;&#41; {
        print&#40;$gfh &#34;col1,col2,col3\r\&#34;One\&#34;,\&#34;Two\&#34;,\&#34;Three\&#34;\r&#34;&#41;;
        close $gfh;
    }
    -e $bad_csv_file or croak &#34;No bad file!\n&#34;;
    -e $good_csv_file or croak &#34;No good file!\n&#34;;

    # Init csv ref to handle files.
    my $csv = Text::CSV_XS-&gt;new&#40;{binary =&gt; 1, auto_diag =&gt; 1, eol =&gt; &#34;\r&#34;}&#41;;

    # Open and use the new files.
    open&#40;$bfh, &#39;&lt;&#39;, $bad_csv_file&#41; or croak &#34;$!\n&#34;;
    open&#40;$gfh, &#39;&lt;&#39;, $good_csv_file&#41; or croak &#34;$!\n&#34;;

    # Get the header of the bad file &#40;this will fail&#41;.
    my @bad_header;
    eval {
        local $@;
        @bad_header = $csv-&gt;header&#40;$bfh&#41;;
        print &#34;Got bad header ok:\n\n&#34; . Dumper&#40;\@bad_header&#41; . &#34;\n\n&#34;;
        1;
    }
    or do {
        print &#34;Failed to get header from bad csv file!\n&#34;;
    };

    # Get the header of the good file &#40;this will fail too but should not&#41;.
    my @good_header;
    eval {
        local $@;
        @good_header = $csv-&gt;header&#40;$gfh&#41;;
        print &#34;Got good header ok:\n\n&#34; . Dumper&#40;\@good_header&#41; . &#34;\n\n&#34;;
        1;
    }
    or do {
        print &#34;Failed to get header from good csv file!\n&#34;;
    };

    close $bfh;
    close $gfh;

My current workaround is going to be, before I call header on the next file, to check if &#39;_AHEAD&#39; exists and is not empty and if so clear it &#40;this should be safe if the name ever changes since we check first&#41;. If &#39;_AHEAD&#39; is not present then attempt the header call using eval and if it fails, create a new Text::CSV_XS instance &#40;with the same options as the original&#41; and attempt the header call a second time. If the second call fails then we can be sure the second file is broken too.

Thanks!

Stuart Lemmen
IT Development &#38; Support
Excelsior Integrated LLC
413-394-4340
clemmen@excelsiorintegrated.com&lt;mailto:clemmen@excelsiorintegrated.com&gt;
www.excelsiorintegrated.com&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.excelsiorintegrated.com/">http://www.excelsiorintegrated.com/</a></span>&gt;
[Excelsior Integrated Small][MCM 3PL seal vector][MCM2017 logo-small2]
</div></div>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>

<div class="messagebody">
<img alt="image001.png" title="image001.png" src="/Ticket/Attachment/1752770/942992/" /></div>

<div class="messagebody">
<img alt="image004.png" title="image004.png" src="/Ticket/Attachment/1752770/942993/" /></div>

<div class="messagebody">
<img alt="image003.jpg" title="image003.jpg" src="/Ticket/Attachment/1752770/942994/" /></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;18&nbsp;12:09:25&nbsp;2017</span>
    <span class="description">h.m.brand [...] xs4all.nl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #123320] Text::CSV_XS bug w/Mac format files</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 Oct 2017 18:09:05 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Text-CSV_XS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;H.Merijn Brand&#34; &lt;h.m.brand [...] xs4all.nl&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, 18 Oct 2017 11:30:54 -0400, &#34;Charles Stuart Lemmen via RT&#34;
&lt;bug-Text-CSV_XS@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I believe I&#39;ve found a bug in the Text::CSV_XS package with regards
&gt; to Mac type files &#40;eol as single carriage return&#41; and handling
&gt; successive files with one csv object ref. Below are the relevant
&gt; details.
</div>
Thanks for the report

I think this is very much related to ticket #122764
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=122764">https://rt.cpan.org/Public/Bug/Display.html?id=122764</a></span>

which has been resolved in 1.32 but got a fix for an additional problem
that surfaced when using a BOM in combination with the \r EOL. The fix
is applied in the upcoming 1.33.

If you too think it is related, could you try

     $ wget --output-document=Text-CSV_XS-git.tgz \
           <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/Tux/Text-CSV_XS/archive/master.tar.gz">https://github.com/Tux/Text-CSV_XS/archive/master.tar.gz</a></span>

and see if that fixes this issue too?

If not, I will start digging. That will not be quick, as I do not have
a Windows development box right here. &#40;It might be related to Windows&#41;

-- 
H.Merijn Brand  <span class="clickylink"><a target="new" rel="nofollow" href="http://tux.nl">http://tux.nl</a></span>   Perl Monger  <span class="clickylink"><a target="new" rel="nofollow" href="http://amsterdam.pm.org/">http://amsterdam.pm.org/</a></span>
using perl5.00307 .. 5.27   porting perl5 on HP-UX, AIX, and openSUSE
<span class="clickylink"><a target="new" rel="nofollow" href="http://mirrors.develooper.com/hpux/">http://mirrors.develooper.com/hpux/</a></span>        <span class="clickylink"><a target="new" rel="nofollow" href="http://www.test-smoke.org/">http://www.test-smoke.org/</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://qa.perl.org">http://qa.perl.org</a></span>   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.goldmark.org/jeff/stupid-disclaimers/">http://www.goldmark.org/jeff/stupid-disclaimers/</a></span>
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;18&nbsp;12:09:26&nbsp;2017</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;18&nbsp;13:52:17&nbsp;2017</span>
    <span class="description">CLemmen [...] excelsiorintegrated.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #123320] Text::CSV_XS bug w/Mac format files</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 Oct 2017 17:52:03 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Text-CSV_XS [...] rt.cpan.org&#34; &lt;bug-Text-CSV_XS [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Charles Stuart Lemmen &lt;CLemmen [...] excelsiorintegrated.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just a quick update that may be relevant and/or shed some light on this issue.

I&#39;m experiencing some odd behavior with my test and your ver. 1.33 of this package &#40;compiled and installed locally&#41; on Linux. Keep in mind the perl binary being used is old:

This is perl, v5.10.1 &#40;*&#41; built for x86_64-linux-thread-multi

So that may play into this too. 

If I use the following code &#40;which includes my kludgy fix&#41;:

### START ###
#!/usr/bin/perl

use strict;
use warnings;
use Carp;

BEGIN: {
    use lib &#39;/home/clemmen/bin/pm/lib/perl5/x86_64-linux-thread-multi&#39;;
}

use Text::CSV_XS;

# First make two csv files, one with an empty &#40;dangling&#41; header column, one that&#39;s ok.
# These are both &#34;Mac&#34; format meaning only carriage returns for EOL.
my $bad_csv_file = &#39;test_bad_csv.csv&#39;;
my $good_csv_file = &#39;test_good_csv.csv&#39;;
my $bfh;
my $gfh;
if&#40;open&#40;$bfh, &#39;&gt;&#39;, $bad_csv_file&#41;&#41; {
    print&#40;$bfh &#34;col1,col2,col3,\r\&#34;One\&#34;,\&#34;\&#34;,\&#34;Three\&#34;\r\&#34;Four\&#34;,\&#34;Five and a half\&#34;,\&#34;Six\&#34;\r&#34;&#41;;
    close $bfh;
}
if&#40;open&#40;$gfh, &#39;&gt;&#39;, $good_csv_file&#41;&#41; {
    print&#40;$gfh &#34;col1,col2,col3\r\&#34;One\&#34;,\&#34;Two\&#34;,\&#34;Three\&#34;\r&#34;&#41;;
    close $gfh;
}
-e $bad_csv_file or croak &#34;No bad file!\n&#34;;
-e $good_csv_file or croak &#34;No good file!\n&#34;;

# Init csv ref to handle files.
my $csv = Text::CSV_XS-&gt;new&#40;{binary =&gt; 1, auto_diag =&gt; 1, eol =&gt; &#34;\r&#34;}&#41;;

# Open and use the new files.
open&#40;$bfh, &#39;&lt;&#39;, $bad_csv_file&#41; or croak &#34;$!\n&#34;;
open&#40;$gfh, &#39;&lt;&#39;, $good_csv_file&#41; or croak &#34;$!\n&#34;;

# Get the header of the bad file &#40;this will fail&#41;.
my @bad_header;
eval {
    local $@;
    @bad_header = $csv-&gt;header&#40;$bfh&#41;;
    print &#34;Got bad header ok:\n\n&#34; . Dumper&#40;\@bad_header&#41; . &#34;\n\n&#34;;
    1;
}
or do {
    print &#34;Failed to get header from bad csv file!\n&#34;;
};

# Get the header of the good file &#40;this will fail too&#41;.
$csv-&gt;{_AHEAD} = &#39;&#39;;
my @good_header;
eval {
    local $@;
    @good_header = $csv-&gt;header&#40;$gfh&#41;;
    print &#34;Got good header ok:\n\n&#34; . Dumper&#40;\@good_header&#41; . &#34;\n\n&#34;;
    1;
}
or do {
    print &#34;Failed to get header from good csv file!\n&#34;;
};

close $bfh;
close $gfh;

exit 0;
### END ###

this way from the command line I get two errors: 

$ perl test_csv_bug.pl
# CSV_XS ERROR: 1012 - INI - the header contains an empty field @ rec 1 pos 0
Failed to get header from bad csv file!
Failed to get header from good csv file!

However, if I simply include a debugging package I often use, the second error goes away!:

$ perl -MData::Dumper test_csv_bug_clean.pl
# CSV_XS ERROR: 1012 - INI - the header contains an empty field @ rec 1 pos 0
Failed to get header from bad csv file!
Got good header ok:

$VAR1 = [
          &#39;col1&#39;,
          &#39;col2&#39;,
          &#39;col3&#39;
        ];

I&#39;m not at this point sure why including that package fixes the issue.

-Stu

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: h.m.brand@xs4all.nl via RT [mailto:bug-Text-CSV_XS@rt.cpan.org] 
Sent: Wednesday, October 18, 2017 12:09 PM
To: Charles Stuart Lemmen &lt;CLemmen@excelsiorintegrated.com&gt;
Subject: Re: [rt.cpan.org #123320] Text::CSV_XS bug w/Mac format files

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=123320">https://rt.cpan.org/Ticket/Display.html?id=123320</a></span> &gt;

On Wed, 18 Oct 2017 11:30:54 -0400, &#34;Charles Stuart Lemmen via RT&#34;
&lt;bug-Text-CSV_XS@rt.cpan.org&gt; wrote:

<div class="message-stanza open">&gt; I believe I&#39;ve found a bug in the Text::CSV_XS package with regards to 
&gt; Mac type files &#40;eol as single carriage return&#41; and handling successive 
&gt; files with one csv object ref. Below are the relevant details.
</div>
Thanks for the report

I think this is very much related to ticket #122764
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=122764">https://rt.cpan.org/Public/Bug/Display.html?id=122764</a></span>

which has been resolved in 1.32 but got a fix for an additional problem that surfaced when using a BOM in combination with the \r EOL. The fix is applied in the upcoming 1.33.

If you too think it is related, could you try

     $ wget --output-document=Text-CSV_XS-git.tgz \
           <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/Tux/Text-CSV_XS/archive/master.tar.gz">https://github.com/Tux/Text-CSV_XS/archive/master.tar.gz</a></span>

and see if that fixes this issue too?

If not, I will start digging. That will not be quick, as I do not have a Windows development box right here. &#40;It might be related to Windows&#41;

-- 
H.Merijn Brand  <span class="clickylink"><a target="new" rel="nofollow" href="http://tux.nl">http://tux.nl</a></span>   Perl Monger  <span class="clickylink"><a target="new" rel="nofollow" href="http://amsterdam.pm.org/">http://amsterdam.pm.org/</a></span>
using perl5.00307 .. 5.27   porting perl5 on HP-UX, AIX, and openSUSE
<span class="clickylink"><a target="new" rel="nofollow" href="http://mirrors.develooper.com/hpux/">http://mirrors.develooper.com/hpux/</a></span>        <span class="clickylink"><a target="new" rel="nofollow" href="http://www.test-smoke.org/">http://www.test-smoke.org/</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://qa.perl.org">http://qa.perl.org</a></span>   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.goldmark.org/jeff/stupid-disclaimers/">http://www.goldmark.org/jeff/stupid-disclaimers/</a></span>

</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;18&nbsp;14:49:45&nbsp;2017</span>
    <span class="description">CLemmen [...] excelsiorintegrated.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #123320] Text::CSV_XS bug w/Mac format files</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 Oct 2017 17:18:28 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Text-CSV_XS [...] rt.cpan.org&#34; &lt;bug-Text-CSV_XS [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Charles Stuart Lemmen &lt;CLemmen [...] excelsiorintegrated.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">H,

Just installed the .pm in the .tar.gz you linked in my Windows environment and same problem persists.

I tried to test that 1.33 package on linux but I am experiencing some odd behavior that seems unrelated to Text::CSV_XS. Nonetheless, there does appear to be a difference with how this potential bug works on Windows vs. Linux vs. ? Sorry I don&#39;t have more info for you at this time.

-Stu

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: h.m.brand@xs4all.nl via RT [mailto:bug-Text-CSV_XS@rt.cpan.org] 
Sent: Wednesday, October 18, 2017 12:09 PM
To: Charles Stuart Lemmen &lt;CLemmen@excelsiorintegrated.com&gt;
Subject: Re: [rt.cpan.org #123320] Text::CSV_XS bug w/Mac format files

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=123320">https://rt.cpan.org/Ticket/Display.html?id=123320</a></span> &gt;

On Wed, 18 Oct 2017 11:30:54 -0400, &#34;Charles Stuart Lemmen via RT&#34;
&lt;bug-Text-CSV_XS@rt.cpan.org&gt; wrote:

<div class="message-stanza open">&gt; I believe I&#39;ve found a bug in the Text::CSV_XS package with regards to 
&gt; Mac type files &#40;eol as single carriage return&#41; and handling successive 
&gt; files with one csv object ref. Below are the relevant details.
</div>
Thanks for the report

I think this is very much related to ticket #122764
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=122764">https://rt.cpan.org/Public/Bug/Display.html?id=122764</a></span>

which has been resolved in 1.32 but got a fix for an additional problem that surfaced when using a BOM in combination with the \r EOL. The fix is applied in the upcoming 1.33.

If you too think it is related, could you try

     $ wget --output-document=Text-CSV_XS-git.tgz \
           <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/Tux/Text-CSV_XS/archive/master.tar.gz">https://github.com/Tux/Text-CSV_XS/archive/master.tar.gz</a></span>

and see if that fixes this issue too?

If not, I will start digging. That will not be quick, as I do not have a Windows development box right here. &#40;It might be related to Windows&#41;

-- 
H.Merijn Brand  <span class="clickylink"><a target="new" rel="nofollow" href="http://tux.nl">http://tux.nl</a></span>   Perl Monger  <span class="clickylink"><a target="new" rel="nofollow" href="http://amsterdam.pm.org/">http://amsterdam.pm.org/</a></span>
using perl5.00307 .. 5.27   porting perl5 on HP-UX, AIX, and openSUSE
<span class="clickylink"><a target="new" rel="nofollow" href="http://mirrors.develooper.com/hpux/">http://mirrors.develooper.com/hpux/</a></span>        <span class="clickylink"><a target="new" rel="nofollow" href="http://www.test-smoke.org/">http://www.test-smoke.org/</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://qa.perl.org">http://qa.perl.org</a></span>   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.goldmark.org/jeff/stupid-disclaimers/">http://www.goldmark.org/jeff/stupid-disclaimers/</a></span>

</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;19&nbsp;06:59:14&nbsp;2017</span>
    <span class="description">HMBRAND [...] cpan.org -  Broken in 1.22 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;19&nbsp;06:59:14&nbsp;2017</span>
    <span class="description">HMBRAND [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;19&nbsp;06:59:46&nbsp;2017</span>
    <span class="description">h.m.brand [...] xs4all.nl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #123320] Text::CSV_XS bug w/Mac format files</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 19 Oct 2017 12:58:09 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Text-CSV_XS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;H.Merijn Brand&#34; &lt;h.m.brand [...] xs4all.nl&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, 18 Oct 2017 11:30:54 -0400, &#34;Charles Stuart Lemmen via RT&#34;
&lt;bug-Text-CSV_XS@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If you create one Text::CSV_XS handle and use it with two different
&gt; files &#40;one with a bad header and one with a good header&#41; that use
&gt; carriage returns only as end-of-line markers and the first has an
&gt; invalid header, attempting to get the second &#40;good&#41; file&#39;s header
&gt; will also fail. Skip getting the first file&#39;s header and the second
&gt; one succeeds. If you attempt to get the first &#40;bad&#41; file&#39;s header but
&gt; then clear the &#39;_AHEAD&#39; instance var before getting the second &#40;good&#41;
&gt; file&#39;s header the second will succeed whereas before it did not.
</div>
So, I rewrote your test to what you see below and immediately see now
what is the cause of the failure ...

Before the fix:

$ perl -Mblib sandbox/rt123320.pl
# CSV_XS ERROR: 1012 - INI - the header contains an empty field @ rec 1 pos 0
Failed to get header from rt123320_bad.csv!
# CSV_XS ERROR: 1012 - INI - the header contains an empty field @ rec 2 pos 0
Failed to get header from rt123320_good.csv!

After the fix:

$ perl -Mblib sandbox/rt123320.pl
# CSV_XS ERROR: 1012 - INI - the header contains an empty field @ rec 1 pos 0
Failed to get header from rt123320_bad.csv!
Use of uninitialized value in subroutine entry at /data/pro/3gl/CPAN/Text-CSV_XS/blib/lib/Text/CSV_XS.pm line 885, &lt;$gfh&gt; chunk 1.
{   header_from_good =&gt; [
        &#39;col1&#39;,
        &#39;col2&#39;,
        &#39;col3&#39;
        ]
    }

Fetch again to test this.

Though I think it is a bad idea to simply re-use $csv after a FAIL in
use for one file for another file, it should not fail like this.

Thanks again for spotting

--8&lt;--- rt123320.pl
#!/pro/bin/perl

use 5.18.2;
use warnings;

use Data::Peek;
use Text::CSV_XS;

# First make two csv files, one with an empty &#40;dangling&#41; header column, one that&#39;s ok.
# These are both &#34;Mac&#34; format meaning only carriage returns for EOL.
my $fn_bad  = &#34;rt123320_bad.csv&#34;;
my $fn_good = &#34;rt123320_good.csv&#34;;
if &#40;open my $bfh, &#34;&gt;&#34;, $fn_bad&#41; {
    print $bfh join &#34;\r&#34; =&gt;
        q{col1,col2,col3,},
        q{&#34;One&#34;,&#34;&#34;,&#34;Three&#34;},
        q{&#34;Four&#34;,&#34;Five and a half&#34;,&#34;Six&#34;},
        q{};
    close $bfh;
    }
if &#40;open my $gfh, &#34;&gt;&#34;, $fn_good&#41; {
    print $gfh join &#34;\r&#34; =&gt;
        q{col1,col2,col3},
        q{&#34;One&#34;,&#34;Two&#34;,&#34;Three&#34;},
        &#34;&#34;;
    close $gfh;
    }
-e $fn_bad  or die &#34;$fn_bad missing!\n&#34;;
-e $fn_good or die &#34;$fn_good missing!\n&#34;;

my $csv = Text::CSV_XS-&gt;new &#40;{ binary =&gt; 1, auto_diag =&gt; 1, eol =&gt; &#34;\r&#34;, }&#41;;

open my $bfh, &#34;&lt;&#34;, $fn_bad  or die &#34;$!\n&#34;;
open my $gfh, &#34;&lt;&#34;, $fn_good or die &#34;$!\n&#34;;

# Get the header of the bad file &#40;this will fail&#41;.
my @bad_header;
eval {
    local $@;
    @bad_header = $csv-&gt;header &#40;$bfh&#41;;
    DDumper { header_from_bad =&gt; \@bad_header };
    1;
    } or warn &#34;Failed to get header from $fn_bad!\n&#34;;

# Get the header of the good file &#40;this will fail too but should not&#41;.
my @good_header;
eval {
    local $@;
    @good_header = $csv-&gt;header &#40;$gfh&#41;;
    DDumper { header_from_good =&gt; \@good_header };
    1;
    } or print &#34;Failed to get header from $fn_good!\n&#34;;

close $bfh;
close $gfh;
--&gt;8---

-- 
H.Merijn Brand  <span class="clickylink"><a target="new" rel="nofollow" href="http://tux.nl">http://tux.nl</a></span>   Perl Monger  <span class="clickylink"><a target="new" rel="nofollow" href="http://amsterdam.pm.org/">http://amsterdam.pm.org/</a></span>
using perl5.00307 .. 5.27   porting perl5 on HP-UX, AIX, and openSUSE
<span class="clickylink"><a target="new" rel="nofollow" href="http://mirrors.develooper.com/hpux/">http://mirrors.develooper.com/hpux/</a></span>        <span class="clickylink"><a target="new" rel="nofollow" href="http://www.test-smoke.org/">http://www.test-smoke.org/</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://qa.perl.org">http://qa.perl.org</a></span>   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.goldmark.org/jeff/stupid-disclaimers/">http://www.goldmark.org/jeff/stupid-disclaimers/</a></span>
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;19&nbsp;16:25:17&nbsp;2017</span>
    <span class="description">HMBRAND [...] cpan.org -  Fixed in 1.33 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;19&nbsp;16:25:17&nbsp;2017</span>
    <span class="description">HMBRAND [...] cpan.org -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
