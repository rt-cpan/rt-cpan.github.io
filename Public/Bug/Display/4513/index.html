<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #4513 for XML-Generator: Memory leak on XML::Generator-0.93 &#40;included&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #4513 for XML-Generator: Memory leak on XML::Generator-0.93 &#40;included&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/XML-Generator/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/XML-Generator/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/XML-Generator/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/XML-Generator/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-Generator">XML-Generator CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">4513</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/XML-Generator/Active/">XML-Generator</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mrk21 [...] infradead.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-37230-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.93    </td>
  </tr>
  <tr id="CF-37231-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;27&nbsp;22:03:29&nbsp;2003</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Memory leak on XML::Generator-0.93 &#40;included&#41;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Module: XML::Geenrator-0.93
perl: v5.8.0
uname output: Linux, 2.4.20-4GB, i686, GNU/Linux

Creating an XML::Generator object with XML::Generator-&gt;new generates a memory leak: The &#34;new&#34; method places a reference to a subroutine in the %tag_factory hash, the subroutine contains a reference to the corresponding object. Objects that are no longer used will never go out of scope.

Supplied is a patch to the XML::Generator module &#40;v 0.93&#41; which fixes this plus a test script for the t/ directory, which is repeated below [ ps: please contact me if the server doesn&#39;t accept patch file and I&#39;ll email it ].

#!/usr/bin/perl -w

use strict;
use XML::Generator;

# assumes presence of a /proc filesystem 
# and that the file /proc/&lt;process id&gt;/statm
# contains the memory useage information

print &#34;1..1\n&#34;;

sub printmem
{
    my $text = shift;
    local *FILE;
    open FILE, &#34;&lt;/proc/$$/statm&#34;;
    my $line = &lt;FILE&gt;;
    close FILE;
    chomp $line;
    my @figures = map { $_ * 4 } split /\s+/, $line;
    print &#34;$text $figures[0]\n&#34;;
    return $figures[0];
}

print &#34;# memory use with XML::Generator-&gt;new call inside loop\n&#34;;

my %a = map {$_,1}  qw &#40; 1 10 100 1000 10000 &#41;;
my %mem = %a;
foreach my $i &#40; 1 .. 10000 &#41;
{
    my $x = new XML::Generator&#40; &#39;escape&#39; =&gt; &#39;always&#39;,
                                &#39;conformance&#39; =&gt; &#39;strict&#39; &#41;;
    my $s = $x-&gt;xml&#40; $x-&gt;a&#40; $x-&gt;b &#41;&#41;;
    $a{$i} and $mem{$i} = &#38;printmem&#40; &#34;# Program size after $i iterations : &#34; &#41;;
}

print $mem{1000} eq $mem{10000} ? 
    &#34;ok 1 # memory stays at around $mem{1000}kB\n&#34; : 
    &#34;not ok 1 # memory grown from $mem{100}kB =&gt; $mem{10000}kB after 10,000 iterations\n&#34;;
    
#
# TODO: make test more fuzzy?
#
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -N -r -u XML-Generator-0.93/Generator.pm XML-Generator-0.93-patched/Generator.pm
--- XML-Generator-0.93/Generator.pm	2003-01-22 15:41:05.000000000 +0000
+++ XML-Generator-0.93-patched/Generator.pm	2003-11-28 02:40:42.000000000 +0000
@@ -271,6 +271,7 @@
   my &#40;$tag&#41; = $AUTOLOAD =~ /.*::&#40;.*&#41;/;
 
   unshift @_, $tag;
+  unshift @_, $this;
 
   goto &#38;{ $tag_factory{$this} };
 }
@@ -459,6 +460,7 @@
   return XML::Generator::cdata-&gt;new&#40;[$xml]&#41;;
 }
 
+=pod
 =head2 xml
 
 &#34;Final&#34; XML document.  Must be called with one and exactly one
@@ -657,21 +659,30 @@
 # the tag.
 
 sub tag {
-  my $sub  = XML::Generator::util::c_tag&#40;shift&#41;;
+  my $sub  = XML::Generator::util::c_tag&#40;$_[0]&#41;;
   goto &#38;{ $sub } if $sub;
 }
  
 # Generate a closure that encapsulates all the behavior to generate a tag
 sub c_tag {
-  my $this = shift;
+  my $arg = shift;
+
+  my $strict = $arg-&gt;{&#39;conformance&#39;} eq &#39;strict&#39;;
+  $arg-&gt;{&#39;always&#39;} = &#40;my $escape = $arg-&gt;{&#39;escape&#39;}&#41; &#38; XML::Generator::ESCAPE_ALWAYS;
+  $arg-&gt;{&#39;high_bit&#39;} = $escape &#38; XML::Generator::ESCAPE_HIGH_BIT;
+  my $empty  = $arg-&gt;{&#39;empty&#39;};
+  my $pretty = $arg-&gt;{&#39;pretty&#39;};
+  undef $arg;
 
+  return sub {
+
+      my $this = shift;
   my $strict = $this-&gt;{&#39;conformance&#39;} eq &#39;strict&#39;;
-  my $always = &#40;my $escape = $this-&gt;{&#39;escape&#39;}&#41; &#38; XML::Generator::ESCAPE_ALWAYS;
-  my $high_bit = $escape &#38; XML::Generator::ESCAPE_HIGH_BIT;
+  my $always = $this-&gt;{&#39;always&#39;};
+  my $high_bit = $this-&gt;{&#39;high_bit&#39;} ;
   my $empty  = $this-&gt;{&#39;empty&#39;};
   my $pretty = $this-&gt;{&#39;pretty&#39;};
 
-  return sub {
     my $tag = shift || return undef;   # catch for bad usage
 
     # parse our argument list to check for hashref/arrayref properties
diff -N -r -u XML-Generator-0.93/t/Generator_memoryleak.t XML-Generator-0.93-patched/t/Generator_memoryleak.t
--- XML-Generator-0.93/t/Generator_memoryleak.t	1970-01-01 01:00:00.000000000 +0100
+++ XML-Generator-0.93-patched/t/Generator_memoryleak.t	2003-11-28 02:34:53.000000000 +0000
@@ -0,0 +1,53 @@
+#!/usr/bin/perl -w
+
+use strict;
+use XML::Generator;
+
+# assumes presence of a /proc filesystem 
+# and that the file /proc/&lt;process id&gt;/statm
+# contains the memory useage information
+
+sub exit_txt
+{
+    print &#34;$_[0]\n&#34;;
+    exit;
+}
+
+print &#34;1..1\n&#34;;
+-d &#34;/proc&#34; or &#38;exit_txt&#40; &#34;ok 1 \# skip Filesystem /proc does not seem to exist on this OS&#34; &#41;;
+-d &#34;/proc/$$&#34; or &#38;exit_txt&#40; &#34;not ok 1 \# todo /proc filesystem seems to exist, but cannot /proc/&lt;process id&gt; directory in filesystem&#34; &#41;;
+-f &#34;/proc/$$/statm&#34; or &#38;exit_txt&#40; &#34;ok 1 \# skip /proc filesystem seems to exists but /proc/&lt;process id&gt;/statm memory status file does not seem to exist&#34; &#41;;
+
+
+sub printmem
+{
+    my $text = shift;
+    local *FILE;
+    open FILE, &#34;&lt;/proc/$$/statm&#34;;
+    my $line = &lt;FILE&gt;;
+    close FILE;
+    chomp $line;
+    my @figures = map { $_ * 4 } split /\s+/, $line;
+    print &#34;$text $figures[0]\n&#34;;
+    return $figures[0];
+}
+
+print &#34;# memory use with XML::Generator-&gt;new call inside loop\n&#34;;
+
+my %a = map {$_,1}  qw &#40; 1 10 100 1000 10000 &#41;;
+my %mem = %a;
+foreach my $i &#40; 1 .. 10000 &#41;
+{
+    my $x = new XML::Generator&#40; &#39;escape&#39; =&gt; &#39;always&#39;,
+				&#39;conformance&#39; =&gt; &#39;strict&#39; &#41;;
+    my $s = $x-&gt;xml&#40; $x-&gt;a&#40; $x-&gt;b &#41;&#41;;
+    $a{$i} and $mem{$i} = &#38;printmem&#40; &#34;# Program size after $i iterations : &#34; &#41;;
+}
+
+print $mem{1000} eq $mem{10000} ? 
+    &#34;ok 1 # memory stays at around $mem{1000}kB\n&#34; : 
+    &#34;not ok 1 # memory grown from $mem{100}kB =&gt; $mem{10000}kB after 10,000 iterations\n&#34;;
+    
+#
+# TODO: make test more fuzzy?
+#
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;01&nbsp;09:08:58&nbsp;2003</span>
    <span class="description">bholzman [...] earthlink.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Benjamin Holzman&#34; &lt;bholzman [...] earthlink.net&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-XML-Generator [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #4513] Memory leak on XML::Generator-0.93 &#40;included&#41; </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 1 Dec 2003 09:09:09 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the bug report!  Unfortunately, the patch file you sent never
made it to me, so could you resend it?

Thanks,

Benjamin Holzman

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">----- Original Message ----- 
From: &#34;Guest via RT&#34; &lt;bug-XML-Generator@rt.cpan.org&gt;
To: &lt;AdminCc of cpan Ticket #4513 :&gt;
Sent: Thursday, November 27, 2003 10:03 PM
Subject: [cpan #4513] Memory leak on XML::Generator-0.93 &#40;included&#41;


<div class="message-stanza open">&gt;
&gt; This message about XML-Generator was sent to you by guest &lt;&gt; via
</div>rt.cpan.org
<div class="message-stanza open">&gt;
&gt; Full context and any attached attachments can be found at:
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=4513">https://rt.cpan.org/Ticket/Display.html?id=4513</a></span> &gt;
&gt;
&gt;
&gt; Module: XML::Geenrator-0.93
&gt; perl: v5.8.0
&gt; uname output: Linux, 2.4.20-4GB, i686, GNU/Linux
&gt;
&gt; Creating an XML::Generator object with XML::Generator-&gt;new generates a
</div>memory leak: The &#34;new&#34; method places a reference to a subroutine in the
%tag_factory hash, the subroutine contains a reference to the corresponding
object. Objects that are no longer used will never go out of scope.
<div class="message-stanza open">&gt;
&gt; Supplied is a patch to the XML::Generator module &#40;v 0.93&#41; which fixes this
</div>plus a test script for the t/ directory, which is repeated below [ ps:
please contact me if the server doesn&#39;t accept patch file and I&#39;ll email
it ].
<div class="message-stanza open">&gt;
&gt; #!/usr/bin/perl -w
&gt;
&gt; use strict;
&gt; use XML::Generator;
&gt;
&gt; # assumes presence of a /proc filesystem
&gt; # and that the file /proc/&lt;process id&gt;/statm
&gt; # contains the memory useage information
&gt;
&gt; print &#34;1..1\n&#34;;
&gt;
&gt; sub printmem
&gt; {
&gt;     my $text = shift;
&gt;     local *FILE;
&gt;     open FILE, &#34;&lt;/proc/$$/statm&#34;;
&gt;     my $line = &lt;FILE&gt;;
&gt;     close FILE;
&gt;     chomp $line;
&gt;     my @figures = map { $_ * 4 } split /\s+/, $line;
&gt;     print &#34;$text $figures[0]\n&#34;;
&gt;     return $figures[0];
&gt; }
&gt;
&gt; print &#34;# memory use with XML::Generator-&gt;new call inside loop\n&#34;;
&gt;
&gt; my %a = map {$_,1}  qw &#40; 1 10 100 1000 10000 &#41;;
&gt; my %mem = %a;
&gt; foreach my $i &#40; 1 .. 10000 &#41;
&gt; {
&gt;     my $x = new XML::Generator&#40; &#39;escape&#39; =&gt; &#39;always&#39;,
&gt; &#39;conformance&#39; =&gt; &#39;strict&#39; &#41;;
&gt;     my $s = $x-&gt;xml&#40; $x-&gt;a&#40; $x-&gt;b &#41;&#41;;
&gt;     $a{$i} and $mem{$i} = &#38;printmem&#40; &#34;# Program size after $i iterations :
</div>&#34; &#41;;
<div class="message-stanza open">&gt; }
&gt;
&gt; print $mem{1000} eq $mem{10000} ?
&gt;     &#34;ok 1 # memory stays at around $mem{1000}kB\n&#34; :
&gt;     &#34;not ok 1 # memory grown from $mem{100}kB =&gt; $mem{10000}kB after
</div>10,000 iterations\n&#34;;
<div class="message-stanza open">&gt;
&gt; #
&gt; # TODO: make test more fuzzy?
&gt; #
&gt;
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;01&nbsp;09:25:20&nbsp;2004</span>
    <span class="description">BHOLZMAN [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
