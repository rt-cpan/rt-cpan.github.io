<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #104133 for PDF-API2: bounding box improvements</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #104133 for PDF-API2: bounding box improvements</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/PDF-API2/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/PDF-API2">PDF-API2 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">104133</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/PDF-API2/Active/">PDF-API2</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
don.huettl [...] grantstreet.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24958-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.023    </td>
  </tr>
  <tr id="CF-24959-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.024    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;30&nbsp;17:00:03&nbsp;2015</span>
    <span class="description">don.huettl [...] grantstreet.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> bounding box improvements</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixes how the various bounding box objects are handled when copying a page to a new document.  I had a PDF with crop marks that were hidden in the original document, but were displayed in the copy.  This was due to the fact that we only copied the object used to set the new page&#39;s dimensions, which would always be the MediaBox if the PDF is written to spec.  In my case, the CropBox should override the MediaBox to hide all the crop marks.

The fix is to make sure all bounding box objects get copied to the new page.  In addition, the order being used to determine the correct value for any unspecified box objects has been updated to better match the spec.  The BleedBox, TrimBox, and ArtBox will all default to the value of the CropBox.  The CropBox defaults to MediaBox.

If this is applied, please credit my employer, Grant Street Group &lt;gsg@cpan.org&gt;, in addition to myself.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> PDF-API2-2.023-Boxes.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">commit fd595694e773
Author: Don Huettl &lt;don.huettl@grantstreet.com&gt;
Date:   Thu Mar 19 15:32:33 2015 -0400

    handle boundary boxes correctly when copying pages
    
    This reverts the fix added in v2.023.1 and takes a better approach.
    
    The BBox object for the frame we are using to embed the new page takes
    its dimensions in the same manner as before, but the new page will
    have all its boundary box objects persisted to the new copy.
    Previously, only the MediaBox object was being copied.
    
    In addition, updates the order being used to determine the correct
    value for any unspecified box objects to better match the spec.  The
    BleedBox, TrimBox, and ArtBox will all default to the value of the
    CropBox.  The CropBox defaults to the MediaBox.

diff --git a/PDF-API2/lib/PDF/API2.pm b/PDF-API2/lib/PDF/API2.pm
index 7c7182eacbc6..f93e0c8404bb 100644
--- a/PDF-API2/lib/PDF/API2.pm
+++ b/PDF-API2/lib/PDF/API2.pm
@@ -1288,12 +1288,13 @@ sub importPageIntoForm {
     $self-&gt;{apiimportcache}||={};
     $self-&gt;{apiimportcache}-&gt;{$s_pdf}||={};
 
+    # Should never get past MediaBox, since it is a required object.
     foreach my $k &#40;qw&#40; MediaBox ArtBox TrimBox BleedBox CropBox &#41;&#41; {
         #next unless&#40;defined $s_page-&gt;{$k}&#41;;
         #my $box = walk_obj&#40;$self-&gt;{apiimportcache}-&gt;{$s_pdf},$s_pdf-&gt;{pdf},$self-&gt;{pdf},$s_page-&gt;{$k}&#41;;
         next unless&#40;defined $s_page-&gt;find_prop&#40;$k&#41;&#41;;
         my $box = walk_obj&#40;$self-&gt;{apiimportcache}-&gt;{$s_pdf},$s_pdf-&gt;{pdf},$self-&gt;{pdf},$s_page-&gt;find_prop&#40;$k&#41;&#41;;
         $xo-&gt;bbox&#40;map { $_-&gt;val } $box-&gt;elementsof&#41;;
     }
     $xo-&gt;bbox&#40; 0, 0, 612, 792&#41; unless&#40;defined $xo-&gt;{BBox}&#41;;
 
@@ -1406,7 +1407,18 @@ sub import_page {
     # all that nasty resources from polluting
     # our very own resource naming space.
     my $xo = $self-&gt;importPageIntoForm&#40;$s_pdf,$s_page&#41;;
-    $t_page-&gt;mediabox&#40; map { $_-&gt;val } $xo-&gt;{BBox}-&gt;elementsof&#41; if&#40;defined $xo-&gt;{BBox}&#41;;
+
+    # copy all page dimensions
+    foreach my $k &#40;qw&#40; MediaBox ArtBox TrimBox BleedBox CropBox &#41;&#41; {
+        my $prop = $s_page-&gt;find_prop&#40;$k&#41;;
+        next unless defined $prop;
+
+        my $box = walk_obj&#40;{}, $s_pdf-&gt;{pdf}, $self-&gt;{pdf}, $prop&#41;;
+        my $method = lc&#40;$k&#41;;
+
+        $t_page-&gt;$method&#40;map { $_-&gt;val } $box-&gt;elementsof&#41;;
+    }
+
     $t_page-&gt;gfx-&gt;formimage&#40;$xo,0,0,1&#41;;
 
     # copy annotations and/or form elements as well
diff --git a/PDF-API2/lib/PDF/API2/Page.pm b/PDF-API2/lib/PDF/API2/Page.pm
index 20552d5a2975..185b0e2170c6 100644
--- a/PDF-API2/lib/PDF/API2/Page.pm
+++ b/PDF-API2/lib/PDF/API2/Page.pm
@@ -144,7 +144,7 @@ Gets the cropbox based one best estimates or the default.
 
 sub get_cropbox {
     my $self = shift&#40;&#41;;
-    return _get_bbox&#40;$self, [qw&#40;CropBox BleedBox TrimBox ArtBox MediaBox&#41;]&#41;;
+    return _get_bbox&#40;$self, [qw&#40;CropBox MediaBox BleedBox TrimBox ArtBox&#41;]&#41;;
 }
 
 =item $page-&gt;bleedbox $w, $h
@@ -169,7 +169,7 @@ Gets the bleedbox based one best estimates or the default.
 
 sub get_bleedbox {
     my $self = shift&#40;&#41;;
-    return _get_bbox&#40;$self, [qw&#40;BleedBox TrimBox ArtBox MediaBox CropBox&#41;]&#41;;
+    return _get_bbox&#40;$self, [qw&#40;BleedBox CropBox MediaBox TrimBox ArtBox&#41;]&#41;;
 }
 
 =item $page-&gt;trimbox $w, $h
@@ -192,7 +192,7 @@ Gets the trimbox based one best estimates or the default.
 
 sub get_trimbox {
     my $self = shift&#40;&#41;;
-    return _get_bbox&#40;$self, [qw&#40;TrimBox ArtBox MediaBox CropBox BleedBox&#41;]&#41;;
+    return _get_bbox&#40;$self, [qw&#40;TrimBox CropBox MediaBox ArtBox BleedBox&#41;]&#41;;
 }
 
 =item $page-&gt;artbox $w, $h
@@ -217,7 +217,7 @@ Gets the artbox based one best estimates or the default.
 
 sub get_artbox {
     my $self = shift&#40;&#41;;
-    return _get_bbox&#40;$self, [qw&#40;ArtBox TrimBox BleedBox CropBox MediaBox&#41;]&#41;;
+    return _get_bbox&#40;$self, [qw&#40;ArtBox CropBox MediaBox TrimBox BleedBox&#41;]&#41;;
 }
 
 =item $page-&gt;rotate $deg
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;04&nbsp;17:34:02&nbsp;2015</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This looks good.  While it&#39;s introducing a change of behavior to copy the other bounding boxes when importing a page, I think it&#39;s appropriate to do so.  If you&#39;re reading this post-release and think otherwise, please include details as to why you think it shouldn&#39;t be done.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;04&nbsp;17:34:03&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;04&nbsp;17:34:08&nbsp;2015</span>
    <span class="description">steve [...] deefs.net -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;04&nbsp;17:45:49&nbsp;2015</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Patched on BitBucket, and will be included in the next release.  Thanks!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;04&nbsp;17:45:55&nbsp;2015</span>
    <span class="description">steve [...] deefs.net -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;23&nbsp;17:54:49&nbsp;2015</span>
    <span class="description">steve [...] deefs.net -  Fixed in 2.024 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
