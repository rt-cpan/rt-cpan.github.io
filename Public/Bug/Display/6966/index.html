<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #6966 for Data-Compare: </title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #6966 for Data-Compare: </h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Data-Compare/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Data-Compare/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Data-Compare/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Data-Compare/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/DrHyde/perl-modules-Data-Compare/issues/new">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Data-Compare">Data-Compare CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">6966</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">5 min

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Data-Compare/Active/">Data-Compare</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">dcantrell [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
adamk [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-8954-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.11    </td>
  </tr>
  <tr id="CF-8955-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;14&nbsp;22:37:35&nbsp;2004</span>
    <span class="description">adamk [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">There is a fairly major race condition in Data::Compare

I&#39;ll start with the following moderately deeply nested structure

my $c = bless { foo =&gt; 1 }, &#39;Foo&#39;;
my $d = bless { c =&gt; $c }, &#34;Foo::D&#34;;
my $e = bless { d =&gt; $d }, &#34;Foo::E&#34;;
my $f = bless { e =&gt; $e }, &#34;Foo::F&#34;;
my $g = bless { f =&gt; $f }, &#34;Foo::G&#34;;
my $h = bless { g =&gt; $g }, &#34;Foo::H&#34;;
my $i = bless { h =&gt; $h }, &#34;Foo::I&#34;;
my $j = bless { i =&gt; $i }, &#34;Foo::J&#34;;
my $k = Clone::clone $j;
Data::Compare::Compare&#40; $j, $k &#41;;


By the time we get somewhere near the bottom of the pile, we have a %been_there index similar to the following

0  HASH&#40;0x8247cd0&#41;
   &#39;Foo::D=HASH&#40;0x83681f4&#41;&#39; =&gt; 1
   &#39;Foo::D=HASH&#40;0x843c36c&#41;&#39; =&gt; 1
   &#39;Foo::E=HASH&#40;0x84288e8&#41;&#39; =&gt; 1
   &#39;Foo::E=HASH&#40;0x843c2e8&#41;&#39; =&gt; 1
   &#39;Foo::F=HASH&#40;0x8428978&#41;&#39; =&gt; 1
   &#39;Foo::F=HASH&#40;0x843c300&#41;&#39; =&gt; 1
   &#39;Foo::G=HASH&#40;0x84289b4&#41;&#39; =&gt; 1
   &#39;Foo::G=HASH&#40;0x843c30c&#41;&#39; =&gt; 1
   &#39;Foo::H=HASH&#40;0x84289f0&#41;&#39; =&gt; 1
   &#39;Foo::H=HASH&#40;0x843c330&#41;&#39; =&gt; 1
   &#39;Foo::I=HASH&#40;0x8428a2c&#41;&#39; =&gt; 1
   &#39;Foo::I=HASH&#40;0x8428a50&#41;&#39; =&gt; 1
   &#39;Foo::J=HASH&#40;0x8428a68&#41;&#39; =&gt; 1
   &#39;Foo::J=HASH&#40;0x843c2dc&#41;&#39; =&gt; 1
   &#39;HASH&#40;0x836e2c4&#41;&#39; =&gt; 1
   &#39;HASH&#40;0x836e300&#41;&#39; =&gt; 1
   &#39;HASH&#40;0x8486eb4&#41;&#39; =&gt; 1
   &#39;HASH&#40;0x8486ed8&#41;&#39; =&gt; 1
   &#39;HASH&#40;0x84951e8&#41;&#39; =&gt; 1
   &#39;HASH&#40;0x849520c&#41;&#39; =&gt; 1
   &#39;HASH&#40;0x8497dd8&#41;&#39; =&gt; 1
   &#39;HASH&#40;0x8497e68&#41;&#39; =&gt; 1
   &#39;HASH&#40;0x849a8dc&#41;&#39; =&gt; 1
   &#39;HASH&#40;0x849a900&#41;&#39; =&gt; 1
   &#39;HASH&#40;0x849c87c&#41;&#39; =&gt; 1
   &#39;HASH&#40;0x849c8d0&#41;&#39; =&gt; 1
   &#39;HASH&#40;0x849ea10&#41;&#39; =&gt; 1
   &#39;HASH&#40;0x849ea7c&#41;&#39; =&gt; 1

Now, while it&#39;s all well and good to do a been_there check on the ACTUAL objects we are testing, where the hell are the HASH&#40;...&#41; entries coming from.

In this case it&#39;s from somewhere like the following.

Data::Compare::Compare&#40;/usr/lib/perl5/site_perl/5.8.0/Data/Compare.pm:188&#41;:
188:          my %x = %$x;

This creates a NEW temporary hash at a somewhat random memory location, and then adds it to %been_there when we go inside it. Looking at the following...

{
    a =&gt; &#40;lots of deep nested objects&#41;,
    b =&gt; &#40;lots of deep nested objects&#41;,
}

... you imagine that a LOT of these temporary hashes will get created during the testing of &#39;a&#39; and these won&#39;t be cleared. The been_there entries still exist, even though the temporary hashes no longer exist.

When we head down the &#39;b&#39; branch, one of these temporary hashes can be created and the same memory location can be reused. This results in the temporary hashes colliding in the been_there index, and the Compare returning false.

This is not theoretical, it&#39;s happening in the main test script for PPI::Analysis::Compare on my system.

I forsee a couple of solutions.

The easiest would be to decrement the been_there value after you are done with the temporary hash, just before they fall out of scope. This would prevent collisions later on, but otherwise leave the function unchanged.

The second would be to completely overhaul been_there using Scalar::Util::refaddr or something similar that doesn&#39;t rely on stringification.

To quickly provide the solution, change

  else { # a package name &#40;object blessed&#41;
    my &#40;$type&#41; = &#34;$x&#34; =~ m/^$refx=&#40;\S+&#41;\&#40;/;
    if &#40;$type eq &#39;HASH&#39;&#41; {
      my %x = %$x;
      my %y = %$y;
      return Compare&#40;\%x, \%y, $opts&#41;;
    }
    elsif &#40;$type eq &#39;ARRAY&#39;&#41; {
      my @x = @$x;
      my @y = @$y;
      return Compare&#40;\@x, \@y, $opts&#41;;
    }

to 

  else { # a package name &#40;object blessed&#41;
    my &#40;$type&#41; = &#34;$x&#34; =~ m/^$refx=&#40;\S+&#41;\&#40;/;
    if &#40;$type eq &#39;HASH&#39;&#41; {
      my %x = %$x;
      my %y = %$y;
      my $rv = Compare&#40;\%x, \%y, $opts&#41;;
      $been_there{\%x}--;
      $been_there{\%y}--;
      return $rv;
    }
    elsif &#40;$type eq &#39;ARRAY&#39;&#41; {
      my @x = @$x;
      my @y = @$y;
      my $rv = Compare&#40;\@x, \@y, $opts&#41;;
      $been_there{\@x}--;
      $been_there{\@y}--;
      return $rv;
    }

Anyways, I hope you see my point, and apply the changes listed, or an equivalent.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;01&nbsp;10:47:57&nbsp;2006</span>
    <span class="description">dcantrell [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">5 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Thanks, fix applied in 0.14</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">My apologies for taking so long to deal with this - I&#39;ve applied your
suggested quick fix and added a test.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;01&nbsp;10:47:59&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;01&nbsp;10:48:04&nbsp;2006</span>
    <span class="description">dcantrell [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;01&nbsp;10:48:14&nbsp;2006</span>
    <span class="description">dcantrell [...] cpan.org -  Given to DCANTRELL</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;01&nbsp;10:50:02&nbsp;2006</span>
    <span class="description">dcantrell [...] cpan.org -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;01&nbsp;10:50:50&nbsp;2006</span>
    <span class="description">dcantrell [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
