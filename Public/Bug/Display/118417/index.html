<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #118417 for DateTimeX-Start: Incorrect behaviour with DateTime objects</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #118417 for DateTimeX-Start: Incorrect behaviour with DateTime objects</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DateTimeX-Start/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DateTimeX-Start/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DateTimeX-Start/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DateTimeX-Start/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DateTimeX-Start">DateTimeX-Start CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">118417</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DateTimeX-Start/Active/">DateTimeX-Start</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">IKEGAMI [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
DLAMBLEY [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-264228-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
v1.2.0</li>
<li>
v1.0.0</li>
</ul>
    </td>
  </tr>
  <tr id="CF-264229-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
v1.4.0    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;17&nbsp;13:51:31&nbsp;2016</span>
    <span class="description">DLAMBLEY [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Incorrect behaviour with DateTime objects</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I believe I have found some incorrect behaviour when determining the start of day from a DateTime object.

Consider,

$ perl -Ilib -e&#39;use DateTimeX::Start qw/ start_of_date /; $dt = start_of_date&#40;DateTime-&gt;new&#40; year =&gt;  2016, month =&gt; 10, day =&gt; 30, hour =&gt; 23, time_zone =&gt; &#34;Europe/London&#34; &#41;&#41;; $dt-&gt;set_time_zone&#40;&#34;Europe/London&#34;&#41;; print $dt-&gt;iso8601.&#34;\n&#34;;&#39;
2016-10-30T00:01:00

I believe the correct result here should be &#34;2016-10-30T00:00:00&#34;.

The attached patch should resolve this problem, as far as I understand it. I have also created a pull request at <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/ikegami/perl-DateTimeX-Start/pull/1">https://github.com/ikegami/perl-DateTimeX-Start/pull/1</a></span>

Best regards,
Dave Lambley
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> DateTime.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 8332cecd56d8dff3671506a583442ba2c779d629 Mon Sep 17 00:00:00 2001
From: Dave Lambley &lt;dave@adzuna.com&gt;
Date: Mon, 17 Oct 2016 16:20:45 +0100
Subject: [PATCH 1/3] Add more tests.

Check correct behaviour this year and in the UK.
---
 t/07_basic.t | 18 ++++++++++++++++++
 1 file changed, 18 insertions&#40;+&#41;

diff --git a/t/07_basic.t b/t/07_basic.t
index b8cc713..863dafd 100755
--- a/t/07_basic.t
+++ b/t/07_basic.t
@@ -26,9 +26,27 @@ sub dt {
 
 {
    my @tests = &#40;
+      # Toronto
       [ &#39;An ordinary day&#39;,          &#39;0.18&#39;, sub { start_of_date&#40;[ 2014,  2,  3 ], &#39;America/Toronto&#39;  &#41; }, sub { dt&#40;2014,  2,  3, 5, 0, 0&#41;-&gt;set_time_zone&#40;&#39;America/Toronto&#39;  &#41; } ],
+
+      # Sao Paulo
       [ &#39;A day without midnight&#39;,   &#39;0.26&#39;, sub { start_of_date&#40;[ 2013, 10, 20 ], &#39;America/Sao_Paulo&#39;&#41; }, sub { dt&#40;2013, 10, 20, 3, 0, 0&#41;-&gt;set_time_zone&#40;&#39;America/Sao_Paulo&#39;&#41; } ],
+      [ &#39;An ordinary day 2&#39;,        &#39;0.26&#39;, sub { start_of_date&#40;[ 2016, 10, 15 ], &#39;America/Sao_Paulo&#39;&#41; }, sub { dt&#40;2016, 10, 15, 3, 0, 0&#41;-&gt;set_time_zone&#40;&#39;America/Sao_Paulo&#39;&#41; } ],
+      [ &#39;An ordinary day 2 local&#39;,  &#39;0.26&#39;, sub { start_of_date&#40;[ 2016, 10, 15 ], &#39;America/Sao_Paulo&#39;&#41; }, sub { dt&#40;2016, 10, 15, 0, 0, 0, &#39;America/Sao_Paulo&#39;&#41; } ],
+      [ &#39;A day without midnight 2&#39;, &#39;0.26&#39;, sub { start_of_date&#40;[ 2016, 10, 16 ], &#39;America/Sao_Paulo&#39;&#41; }, sub { dt&#40;2016, 10, 16, 3, 0, 0&#41;-&gt;set_time_zone&#40;&#39;America/Sao_Paulo&#39;&#41; } ],
+      [ &#39;A day without midnight 2 local&#39;, &#39;0.26&#39;, sub { start_of_date&#40;[ 2016, 10, 16 ], &#39;America/Sao_Paulo&#39;&#41; }, sub { dt&#40;2016, 10, 16, 1, 0, 0, &#39;America/Sao_Paulo&#39;&#41; } ],
+      [ &#39;An ordinary day 3&#39;,        &#39;0.26&#39;, sub { start_of_date&#40;[ 2016, 10, 17 ], &#39;America/Sao_Paulo&#39;&#41; }, sub { dt&#40;2016, 10, 17, 2, 0, 0&#41;-&gt;set_time_zone&#40;&#39;America/Sao_Paulo&#39;&#41; } ],
+      [ &#39;An ordinary day 3 local&#39;,  &#39;0.26&#39;, sub { start_of_date&#40;[ 2016, 10, 17 ], &#39;America/Sao_Paulo&#39;&#41; }, sub { dt&#40;2016, 10, 17, 0, 0, 0, &#39;America/Sao_Paulo&#39;&#41; } ],
+
+      # Havana
       [ &#39;A day with two midnights&#39;, &#39;1.53&#39;, sub { start_of_date&#40;[ 2013, 11,  3 ], &#39;America/Havana&#39;   &#41; }, sub { dt&#40;2013, 11,  3, 4, 0, 0&#41;-&gt;set_time_zone&#40;&#39;America/Havana&#39;   &#41; } ],
+
+      # UK
+      [ &#39;UK, BST&#39;,                  &#39;1.53&#39;, sub { start_of_date&#40;[ 2016, 10, 30 ], &#39;Europe/London&#39;    &#41; }, sub { dt&#40;2016, 10, 29,23, 0, 0&#41;-&gt;set_time_zone&#40;&#39;Europe/London&#39;&#41; } ],
+      [ &#39;UK, BST local&#39;,            &#39;1.53&#39;, sub { start_of_date&#40;[ 2016, 10, 30 ], &#39;Europe/London&#39;    &#41; }, sub { dt&#40;2016, 10, 30, 0, 0, 0, &#39;Europe/London&#39;&#41; } ],
+      [ &#39;UK, UTC local&#39;,            &#39;1.53&#39;, sub { start_of_date&#40;[ 2016, 10, 31 ], &#39;Europe/London&#39;    &#41; }, sub { dt&#40;2016, 10, 31, 0, 0, 0, &#39;Europe/London&#39;&#41; } ],
+      [ &#39;UK, UTC&#39;,                  &#39;1.53&#39;, sub { start_of_date&#40;[ 2016, 10, 31 ], &#39;Europe/London&#39;    &#41; }, sub { dt&#40;2016, 10, 31, 0, 0, 0&#41;-&gt;set_time_zone&#40;&#39;Europe/London&#39;&#41; } ],
+      [ &#39;UK, UTC local&#39;,            &#39;1.53&#39;, sub { start_of_date&#40;[ 2016, 10, 31 ], &#39;Europe/London&#39;    &#41; }, sub { dt&#40;2016, 10, 31, 0, 0, 0, &#39;Europe/London&#39;&#41; } ],
    &#41;;
 
    plan tests =&gt; 0+@tests;
-- 
1.9.1


From 0fdc773ec321a14d91830ba0cc9a837bb14e98de Mon Sep 17 00:00:00 2001
From: Dave Lambley &lt;dave@adzuna.com&gt;
Date: Mon, 17 Oct 2016 18:34:37 +0100
Subject: [PATCH 2/3] Test behaviour with objects.

---
 t/07_basic.t | 11 +++++++++++
 1 file changed, 11 insertions&#40;+&#41;

diff --git a/t/07_basic.t b/t/07_basic.t
index 863dafd..7578362 100755
--- a/t/07_basic.t
+++ b/t/07_basic.t
@@ -41,12 +41,21 @@ sub dt {
       # Havana
       [ &#39;A day with two midnights&#39;, &#39;1.53&#39;, sub { start_of_date&#40;[ 2013, 11,  3 ], &#39;America/Havana&#39;   &#41; }, sub { dt&#40;2013, 11,  3, 4, 0, 0&#41;-&gt;set_time_zone&#40;&#39;America/Havana&#39;   &#41; } ],
 
+      [ &#39;Sao Paulo, A&#39;, &#39;1.53&#39;, sub { start_of_date&#40;DateTime-&gt;new&#40; year =&gt; 2016, month =&gt; 10, day =&gt; 15, hour =&gt; 0, time_zone =&gt; &#39;America/Sao_Paulo&#39; &#41;&#41; }, sub { dt&#40;2016, 10, 15, 0, 0, 0, &#39;America/Sao_Paulo&#39;&#41; } ],
+      [ &#39;Sao Paulo, B&#39;, &#39;1.53&#39;, sub { start_of_date&#40;DateTime-&gt;new&#40; year =&gt; 2016, month =&gt; 10, day =&gt; 15, hour =&gt; 23, minute =&gt; 59, second =&gt; 59, time_zone =&gt; &#39;America/Sao_Paulo&#39; &#41;&#41; }, sub { dt&#40;2016, 10, 15, 0, 0, 0, &#39;America/Sao_Paulo&#39;&#41; } ],
+      [ &#39;Sao Paulo, C&#39;, &#39;1.53&#39;, sub { start_of_date&#40;DateTime-&gt;new&#40; year =&gt; 2016, month =&gt; 10, day =&gt; 15, hour =&gt; 23, minute =&gt; 59, second =&gt; 59, time_zone =&gt; &#39;America/Sao_Paulo&#39; &#41;-&gt;add&#40;seconds =&gt; 1&#41;&#41; }, sub { dt&#40;2016, 10, 16, 1, 0, 0, &#39;America/Sao_Paulo&#39;&#41; } ],
+
       # UK
       [ &#39;UK, BST&#39;,                  &#39;1.53&#39;, sub { start_of_date&#40;[ 2016, 10, 30 ], &#39;Europe/London&#39;    &#41; }, sub { dt&#40;2016, 10, 29,23, 0, 0&#41;-&gt;set_time_zone&#40;&#39;Europe/London&#39;&#41; } ],
       [ &#39;UK, BST local&#39;,            &#39;1.53&#39;, sub { start_of_date&#40;[ 2016, 10, 30 ], &#39;Europe/London&#39;    &#41; }, sub { dt&#40;2016, 10, 30, 0, 0, 0, &#39;Europe/London&#39;&#41; } ],
       [ &#39;UK, UTC local&#39;,            &#39;1.53&#39;, sub { start_of_date&#40;[ 2016, 10, 31 ], &#39;Europe/London&#39;    &#41; }, sub { dt&#40;2016, 10, 31, 0, 0, 0, &#39;Europe/London&#39;&#41; } ],
       [ &#39;UK, UTC&#39;,                  &#39;1.53&#39;, sub { start_of_date&#40;[ 2016, 10, 31 ], &#39;Europe/London&#39;    &#41; }, sub { dt&#40;2016, 10, 31, 0, 0, 0&#41;-&gt;set_time_zone&#40;&#39;Europe/London&#39;&#41; } ],
       [ &#39;UK, UTC local&#39;,            &#39;1.53&#39;, sub { start_of_date&#40;[ 2016, 10, 31 ], &#39;Europe/London&#39;    &#41; }, sub { dt&#40;2016, 10, 31, 0, 0, 0, &#39;Europe/London&#39;&#41; } ],
+
+      [ &#39;UK, BST floating&#39;, &#39;1.53&#39;, sub { start_of_date&#40;DateTime-&gt;new&#40; year =&gt;  2016, month =&gt; 10, day =&gt; 30, time_zone =&gt; &#39;floating&#39; &#41;, &#39;Europe/London&#39; &#41; }, sub { dt&#40;2016, 10, 29,23, 0, 0&#41;-&gt;set_time_zone&#40;&#39;Europe/London&#39;&#41; } ],
+      [ &#39;UK, BST floating late&#39;, &#39;1.53&#39;, sub { start_of_date&#40;DateTime-&gt;new&#40; year =&gt;  2016, month =&gt; 10, day =&gt; 30, hour =&gt; 23, time_zone =&gt; &#39;floating&#39; &#41;, &#39;Europe/London&#39; &#41; }, sub { dt&#40;2016, 10, 29,23, 0, 0&#41;-&gt;set_time_zone&#40;&#39;Europe/London&#39;&#41; } ],
+      [ &#39;UK, BST tz&#39;, &#39;1.53&#39;, sub { start_of_date&#40;DateTime-&gt;new&#40; year =&gt;  2016, month =&gt; 10, day =&gt; 30, time_zone =&gt; &#39;Europe/London&#39; &#41;, &#39;Europe/London&#39; &#41; }, sub { dt&#40;2016, 10, 29,23, 0, 0&#41;-&gt;set_time_zone&#40;&#39;Europe/London&#39;&#41; } ],
+      [ &#39;UK, BST tz late&#39;, &#39;1.53&#39;, sub { start_of_date&#40;DateTime-&gt;new&#40; year =&gt;  2016, month =&gt; 10, day =&gt; 30, hour =&gt; 23, time_zone =&gt; &#39;Europe/London&#39; &#41;, &#39;Europe/London&#39; &#41; }, sub { dt&#40;2016, 10, 29,23, 0, 0&#41;-&gt;set_time_zone&#40;&#39;Europe/London&#39;&#41; } ],
    &#41;;
 
    plan tests =&gt; 0+@tests;
@@ -58,6 +67,7 @@ sub dt {
          skip&#40;&#34;DateTime::TimeZone $min_ver required&#34;, 1&#41;
             if $DateTime::TimeZone::VERSION &lt; $min_ver;
 
+         local $@;
          my $got_dt = eval { $test_code-&gt;&#40;&#41; };
          if &#40;!$got_dt&#41; {
             my $e = $@;
@@ -67,6 +77,7 @@ sub dt {
             next;
          }
 
+         local $@;
          my $expected_dt = eval { $expected_code-&gt;&#40;&#41; };
          if &#40;!$expected_dt&#41; {
             my $e = $@;
-- 
1.9.1


From 89491f00406447c31ee8b3e880b309574db1b4d0 Mon Sep 17 00:00:00 2001
From: Dave Lambley &lt;dave@adzuna.com&gt;
Date: Mon, 17 Oct 2016 18:41:30 +0100
Subject: [PATCH 3/3] Correctly truncate date objects.

---
 lib/DateTimeX/Start.pm | 4 ++--
 1 file changed, 2 insertions&#40;+&#41;, 2 deletions&#40;-&#41;

diff --git a/lib/DateTimeX/Start.pm b/lib/DateTimeX/Start.pm
index 51354eb..a46f0d1 100644
--- a/lib/DateTimeX/Start.pm
+++ b/lib/DateTimeX/Start.pm
@@ -52,10 +52,10 @@ sub _start_of_date {
    return DateTime-&gt;from_epoch&#40;epoch =&gt; $max_epoch*60, time_zone =&gt; $tz&#41;;
 }
 
-sub start_of_date  { _start_of_date&#40;undef,   @_&#41; }
+sub start_of_date  { _start_of_date&#40;&#39;day&#39;,   @_&#41; }
 sub start_of_month { _start_of_date&#40;&#39;month&#39;, @_&#41; }
 sub start_of_year  { _start_of_date&#40;&#39;year&#39;,  @_&#41; }
-sub start_of_today { _start_of_date&#40;undef, DateTime-&gt;now&#40; time_zone =&gt; $_[0] || &#39;local&#39; &#41;&#41; }
+sub start_of_today { _start_of_date&#40;&#39;day&#39;, DateTime-&gt;now&#40; time_zone =&gt; $_[0] || &#39;local&#39; &#41;&#41; }
 
 {
    no warnings qw&#40; once &#41;;
-- 
1.9.1

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;17&nbsp;14:29:07&nbsp;2016</span>
    <span class="description">ikegami [...] adaelis.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #118417] Incorrect behaviour with DateTime objects</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 17 Oct 2016 14:28:59 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DateTimeX-Start [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Brine &lt;ikegami [...] adaelis.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Looking into this.
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;17&nbsp;14:29:08&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;17&nbsp;14:35:27&nbsp;2016</span>
    <span class="description">ikegami [...] adaelis.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #118417] Incorrect behaviour with DateTime objects</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 17 Oct 2016 14:35:10 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DateTimeX-Start [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Brine &lt;ikegami [...] adaelis.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">There does indeed appear to be a bug.

$ perl -e&#39;
   use DateTimeX::Start qw/ start_of_date /;
   my $dt = start_of_date&#40;DateTime-&gt;new&#40; year =&gt; 2016, month =&gt; 10, day =&gt;
30, hour =&gt; 23, time_zone =&gt; &#34;Europe/London&#34; &#41;&#41;;
   CORE::say $dt-&gt;epoch, &#34; &#34;, $dt;
   $dt-&gt;subtract&#40; seconds =&gt; 1 &#41;;
   CORE::say $dt-&gt;epoch, &#34; &#34;, $dt;
&#39;
1477782060 2016-10-30T00:01:00
1477782059 2016-10-30T00:00:59
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;17&nbsp;14:46:50&nbsp;2016</span>
    <span class="description">ikegami [...] adaelis.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #118417] Incorrect behaviour with DateTime objects</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 17 Oct 2016 14:46:41 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DateTimeX-Start [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Brine &lt;ikegami [...] adaelis.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m not convinced the correct fix was provided. I&#39;ll look into this further
in 10 hours.

On Mon, Oct 17, 2016 at 2:35 PM, ikegami@adaelis.com via RT &lt;
bug-DateTimeX-Start@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: DateTimeX-Start
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=118417">https://rt.cpan.org/Ticket/Display.html?id=118417</a></span> &gt;
&gt;
&gt; There does indeed appear to be a bug.
&gt;
&gt; $ perl -e&#39;
&gt;    use DateTimeX::Start qw/ start_of_date /;
&gt;    my $dt = start_of_date&#40;DateTime-&gt;new&#40; year =&gt; 2016, month =&gt; 10, day =&gt;
&gt; 30, hour =&gt; 23, time_zone =&gt; &#34;Europe/London&#34; &#41;&#41;;
&gt;    CORE::say $dt-&gt;epoch, &#34; &#34;, $dt;
&gt;    $dt-&gt;subtract&#40; seconds =&gt; 1 &#41;;
&gt;    CORE::say $dt-&gt;epoch, &#34; &#34;, $dt;
&gt; &#39;
&gt; 1477782060 2016-10-30T00:01:00
&gt; 1477782059 2016-10-30T00:00:59
&gt;
&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;19&nbsp;01:04:20&nbsp;2016</span>
    <span class="description">ikegami [...] adaelis.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #118417] Incorrect behaviour with DateTime objects</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 19 Oct 2016 01:04:00 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DateTimeX-Start [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Brine &lt;ikegami [...] adaelis.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ll fix it this weekend.

The module performs a binary search on epoch timestamps to find the right
timestamp. As an optimization, the search space is restricted to timestamps
near the initial point. Unfortunately, the search space is too restricted.
I&#39;ll need to figured out what the correct restriction is, and add tests to
check this.


On Mon, Oct 17, 2016 at 2:46 PM, Eric Brine &lt;ikegami@adaelis.com&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m not convinced the correct fix was provided. I&#39;ll look into this
&gt; further in 10 hours.
&gt;
&gt; On Mon, Oct 17, 2016 at 2:35 PM, ikegami@adaelis.com via RT &lt;
&gt; bug-DateTimeX-Start@rt.cpan.org&gt; wrote:
&gt;
<div class="message-stanza open">&gt;&gt;        Queue: DateTimeX-Start
&gt;&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=118417">https://rt.cpan.org/Ticket/Display.html?id=118417</a></span> &gt;
&gt;&gt;
&gt;&gt; There does indeed appear to be a bug.
&gt;&gt;
&gt;&gt; $ perl -e&#39;
&gt;&gt;    use DateTimeX::Start qw/ start_of_date /;
&gt;&gt;    my $dt = start_of_date&#40;DateTime-&gt;new&#40; year =&gt; 2016, month =&gt; 10, day =&gt;
&gt;&gt; 30, hour =&gt; 23, time_zone =&gt; &#34;Europe/London&#34; &#41;&#41;;
&gt;&gt;    CORE::say $dt-&gt;epoch, &#34; &#34;, $dt;
&gt;&gt;    $dt-&gt;subtract&#40; seconds =&gt; 1 &#41;;
&gt;&gt;    CORE::say $dt-&gt;epoch, &#34; &#34;, $dt;
&gt;&gt; &#39;
&gt;&gt; 1477782060 2016-10-30T00:01:00
&gt;&gt; 1477782059 2016-10-30T00:00:59
&gt;&gt;
&gt;&gt;
</div>&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;24&nbsp;14:08:33&nbsp;2016</span>
    <span class="description">ikegami [...] adaelis.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #118417] Incorrect behaviour with DateTime objects</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 24 Oct 2016 14:08:19 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DateTimeX-Start [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Brine &lt;ikegami [...] adaelis.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Changing undef to &#39;day&#39; is indeed a sufficient fix because the start of the
day in the target time zone will always be within +/-24 hours of the start
of the in UTC. In fact, it will be within -12..+14, so searching in
-24..+24 gives a buffer.

My plan:
- Change undef to &#39;day&#39; as per your patch.
- Document &#34;the start of the day in the target time zone will always be
within +/-24 hours of the start of the in UTC&#34; to the list of assumption.
- Cause the search to fail if no result is found, rather than silently
returning the wrong result.
- Add tests.

I&#39;m dealing with medical issues which prevented me to actually make these
changes this weekend, but at least you know your fix is legitimate if you
need the module to work right away.
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;29&nbsp;00:44:30&nbsp;2016</span>
    <span class="description">IKEGAMI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">There are actually two bugs:

1&#41; When the result is exactly 24 hours before the input.
2&#41; When the result is more than 24 hours before the input.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;01&nbsp;15:41:50&nbsp;2016</span>
    <span class="description">IKEGAMI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in v1.4.0, on its way to your local CPAN mirror.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;01&nbsp;15:41:50&nbsp;2016</span>
    <span class="description">IKEGAMI [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;01&nbsp;15:41:51&nbsp;2016</span>
    <span class="description">IKEGAMI [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;01&nbsp;15:42:05&nbsp;2016</span>
    <span class="description">IKEGAMI [...] cpan.org -  Broken in v1.0.0 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;02&nbsp;00:27:04&nbsp;2016</span>
    <span class="description">IKEGAMI [...] cpan.org -  Fixed in v1.4.0 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
