<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #38996 for Catalyst-Plugin-RequireSSL: code duplication: $c-&gt;uri_for&#40;&#41; is reimplemented in RequireSSL.pm</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #38996 for Catalyst-Plugin-RequireSSL: code duplication: $c-&gt;uri_for&#40;&#41; is reimplemented in RequireSSL.pm</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Catalyst-Plugin-RequireSSL/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Catalyst-Plugin-RequireSSL/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Catalyst-Plugin-RequireSSL/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Catalyst-Plugin-RequireSSL/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Catalyst-Plugin-RequireSSL">Catalyst-Plugin-RequireSSL CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">38996</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Catalyst-Plugin-RequireSSL/Active/">Catalyst-Plugin-RequireSSL</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
norbi [...] nix.hu

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-5254-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-5255-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;04&nbsp;14:14:00&nbsp;2008</span>
    <span class="description">norbi [...] nix.hu -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> code duplication: $c-&gt;uri_for&#40;&#41; is reimplemented in RequireSSL.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 4 Sep 2008 20:13:24 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Catalyst-Plugin-RequireSSL [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> BUCHMULLER Norbert &lt;norbi [...] nix.hu&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It seems that for some reason the code that recreates the path part of
the URL &#40;from the controller, action, arguments and query parameters&#41; is
reimplemented from scratch in
Catalyst::Plugin::RequireSSL::_redirect_uri&#40;&#41;.

This is unfortunate not only because it is code duplication &#40;this
functionality is already present in Catalyst::uri_for&#40;&#41;&#41;, but as this
code path does not use $c-&gt;uri_for&#40;&#41;, the user-defined uri_for&#40;&#41; hooks
are are ignored when constructing the URL.

For example, our webapp stores the interface language code as a prefix to
the path part of the URL &#40;eg. <span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/en/some/page&#41;">http://example.com/en/some/page&#41;</a></span>. It strips
the language code off in a prepare_path&#40;&#41; hook &#40;and saves its value in
the stash&#41;, thus the Catalyst dispatcher does not see it &#40;and the
controllers layout is not affected by it&#41;. Finally in an uri_for&#40;&#41; hook
the language prefix is prepended back to the URL path, so the URLs will
have the language code prefix again. In this scenario RequireSSL.pm
breaks the application, as it bypasses the uri_for&#40;&#41; hook &#40;and the
language code will be missing from the URL&#41;.

See the attached patch for an implementation that uses uri_for&#40;&#41;.

norbi
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;10&nbsp;13:12:08&nbsp;2008</span>
    <span class="description">mst [...] shadowcat.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #38996] code duplication: $c-&gt;uri_for&#40;&#41; is reimplemented in RequireSSL.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 10 Sep 2008 18:11:47 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> BUCHMULLER Norbert via RT &lt;bug-Catalyst-Plugin-RequireSSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Matt S Trout &lt;mst [...] shadowcat.co.uk&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Sep 04, 2008 at 02:14:03PM -0400, BUCHMULLER Norbert via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thu Sep 04 14:14:00 2008: Request 38996 was acted upon.
&gt; Transaction: Ticket created by norbi@nix.hu
&gt;        Queue: Catalyst-Plugin-RequireSSL
&gt;      Subject: code duplication: $c-&gt;uri_for&#40;&#41; is reimplemented in RequireSSL.pm
&gt;    Broken in: &#40;no value&#41;
&gt;     Severity: &#40;no value&#41;
&gt;        Owner: Nobody
&gt;   Requestors: norbi@nix.hu
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=38996">http://rt.cpan.org/Ticket/Display.html?id=38996</a></span> &gt;
&gt; 
&gt; 
&gt; It seems that for some reason the code that recreates the path part of
&gt; the URL &#40;from the controller, action, arguments and query parameters&#41; is
&gt; reimplemented from scratch in
&gt; Catalyst::Plugin::RequireSSL::_redirect_uri&#40;&#41;.
&gt; 
&gt; This is unfortunate not only because it is code duplication &#40;this
&gt; functionality is already present in Catalyst::uri_for&#40;&#41;&#41;, but as this
&gt; code path does not use $c-&gt;uri_for&#40;&#41;, the user-defined uri_for&#40;&#41; hooks
&gt; are are ignored when constructing the URL.
&gt; 
&gt; For example, our webapp stores the interface language code as a prefix to
&gt; the path part of the URL &#40;eg. <span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/en/some/page&#41;">http://example.com/en/some/page&#41;</a></span>. It strips
&gt; the language code off in a prepare_path&#40;&#41; hook &#40;and saves its value in
&gt; the stash&#41;, thus the Catalyst dispatcher does not see it &#40;and the
&gt; controllers layout is not affected by it&#41;. Finally in an uri_for&#40;&#41; hook
&gt; the language prefix is prepended back to the URL path, so the URLs will
&gt; have the language code prefix again. In this scenario RequireSSL.pm
&gt; breaks the application, as it bypasses the uri_for&#40;&#41; hook &#40;and the
&gt; language code will be missing from the URL&#41;.
&gt; 
&gt; See the attached patch for an implementation that uses uri_for&#40;&#41;.
</div>
Your patch doesn&#39;t include captures and won&#39;t work for complex regexp
actions even if it did. However, if you were to supply a patch -with tests-
that simply did $c-&gt;uri_for&#40;&#39;/&#39;.$c-&gt;req-&gt;path,$c-&gt;req-&gt;query_parameters&#41;
I think -that- would work in all cases and work around your problem.

A better solution for -you- IMO would be if you captured the language via a

sub lang :Chained&#40;&#39;/&#39;&#41; :CaptureArgs&#40;1&#41; {

action - then this would all work already; mangling $c-&gt;req-&gt;path is
dangerous and highly inadvisable.

-- 
      Matt S Trout       Need help with your Catalyst or DBIx::Class project?
   Technical Director                    <span class="clickylink"><a target="new" rel="nofollow" href="http://www.shadowcat.co.uk/catalyst/">http://www.shadowcat.co.uk/catalyst/</a></span>
 Shadowcat Systems Ltd.  Want a managed development or deployment platform?
<span class="clickylink"><a target="new" rel="nofollow" href="http://chainsawblues.vox.com/">http://chainsawblues.vox.com/</a></span>            <span class="clickylink"><a target="new" rel="nofollow" href="http://www.shadowcat.co.uk/servers/">http://www.shadowcat.co.uk/servers/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;10&nbsp;13:12:10&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;17&nbsp;18:26:04&nbsp;2008</span>
    <span class="description">norbi [...] nix.hu -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #38996] code duplication: $c-&gt;uri_for&#40;&#41; is reimplemented in RequireSSL.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 18 Sep 2008 00:25:21 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Catalyst-Plugin-RequireSSL [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> BUCHMULLER Norbert &lt;norbi [...] nix.hu&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, 10 Sep 2008 13:12:10 -0400 &#34;Matt S Trout via RT&#34;
&lt;bug-Catalyst-Plugin-RequireSSL@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Your patch doesn&#39;t include captures and won&#39;t work for complex regexp
&gt; actions even if it did. However, if you were to supply a patch -with
&gt; tests- that simply did
&gt; $c-&gt;uri_for&#40;&#39;/&#39;.$c-&gt;req-&gt;path,$c-&gt;req-&gt;query_parameters&#41; I think -that-
&gt; would work in all cases and work around your problem.
</div>
You&#39;re right, I did not take the captures into account. OTOH
$c-&gt;req-&gt;path does not necessarily correspond to the path argument of
$c-&gt;uri_for&#40;&#41; &#40;that&#39;s exactly the reason why we have $c-&gt;uri_for&#40;&#41;,
isn&#39;t it?:-&#41;. What do you think of this solution:

$c-&gt;uri_for&#40;
 $c-&gt;action, $c-&gt;req-&gt;captures,
 @{$c-&gt;req-&gt;arguments},
 $c-&gt;req-&gt;params
&#41;;

According the documentation of Catalyst::uri_for&#40;&#41;, if $path is an action
object and the first argument after it is an array ref, it is considered
as the list of captures, and is passed to
$c-&gt;dispatcher-&gt;uri_for_action&#40;&#41; along with the action object. So, if the
dispatcher can reconstruct the path from the action object and the
captures, it works. Now the question is how much can we depend on it &#40;ie.
that uri_for_action&#40;&#41; works well&#41;.

For Catalyst::DispatchType::Regex I just filed a bug report &#40;rt.cpan.org
#39369&#41;, as its uri_for_action&#40;&#41; is totally broken. But even if my patch
is accepted, the implementation is still admittedly weak &#40;eg. it cannot
cope with nested parentheses according to the documentation&#41;, and it&#39;s no
surprise, as the task is inherently very tough &#40;to reconstruct the
original string that was matched from the regex and captures&#41;.

So, it&#39;s still not clear for me if it&#39;s worth to try to push the
$c-&gt;action plus $c-&gt;req-&gt;captures version in favour of the $c-&gt;req-&gt;path
version.. it gives more freedom in the &#40;mis&#41;use of $c-&gt;uri_for&#40;&#41;, at the
price of depending on shaky uri_for_action&#40;&#41; implementations. Not that it
would be my role to decide in this question. ;-&#41;

Can you please check the attached patch? &#40;Even if you&#39;d reject the
$c-&gt;action + $c-&gt;req-&gt;captures solution; in that case pls review it only
for the style and some general issues regarding the tests.&#41; I created a
test case for a Regex action, and a test case for a scenario where the
user mangles $c-&gt;req-&gt;path from prepare_path&#40;&#41; and uri_for&#40;&#41;. &#40;I plan to
create a test case for a Chained action, too.&#41;

An implementation detail, to explain some changes: I ran into an issue
after switching to using uri_for&#40;&#41;: the order of the query parameters in
the URI created by uri_for&#40;&#41; is randomly shuffled. &#40;For Catalyst the order
does not matter - you can only access the query parameters in a hash ref;
so in uri_for&#40;&#41; it uses the order in which Perl returns the hash keys.&#41;
As in text comparison or using the comparison function of the URI module
the order of query parameters is significant, I klugded all URI
comparisons by wrapping the URI returned from Catalyst in a function
&#40;URI::UnorderedQueryParams::uri&#40;&#41;&#41; that returns an URI object with the
query params in lexicographic order. If you know anything better/cleaner,
pls tell me.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; A better solution for -you- IMO would be if you captured the language
&gt; via a
&gt; 
&gt; sub lang :Chained&#40;&#39;/&#39;&#41; :CaptureArgs&#40;1&#41; {
&gt; 
&gt; action - then this would all work already; mangling $c-&gt;req-&gt;path is
&gt; dangerous and highly inadvisable.
</div>
Thanks for pointing it out. In fact I perused the manual of
Catalyst::DispatchType::Chained twice before we settled with the
prepare_path&#40;&#41; + uri_for&#40;&#41; hack, as I felt that it&#39;s something very
close, but somehow it did not lend itself as the solution we looked for.
It did not get through for me that there need not be one predetermined
endpoint for each chain. I&#39;ll convert our app to use Chained soon.

Best regards,

norbi
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;24&nbsp;11:24:00&nbsp;2008</span>
    <span class="description">mst [...] shadowcat.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #38996] code duplication: $c-&gt;uri_for&#40;&#41; is reimplemented in RequireSSL.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 24 Sep 2008 16:23:26 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> BUCHMULLER Norbert via RT &lt;bug-Catalyst-Plugin-RequireSSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Matt S Trout &lt;mst [...] shadowcat.co.uk&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Sep 17, 2008 at 06:26:07PM -0400, BUCHMULLER Norbert via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Catalyst-Plugin-RequireSSL
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=38996">http://rt.cpan.org/Ticket/Display.html?id=38996</a></span> &gt;
&gt; 
&gt; On Wed, 10 Sep 2008 13:12:10 -0400 &#34;Matt S Trout via RT&#34;
&gt; &lt;bug-Catalyst-Plugin-RequireSSL@rt.cpan.org&gt; wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; Your patch doesn&#39;t include captures and won&#39;t work for complex regexp
&gt; &gt; actions even if it did. However, if you were to supply a patch -with
&gt; &gt; tests- that simply did
&gt; &gt; $c-&gt;uri_for&#40;&#39;/&#39;.$c-&gt;req-&gt;path,$c-&gt;req-&gt;query_parameters&#41; I think -that-
&gt; &gt; would work in all cases and work around your problem.
</div>&gt; 
&gt; You&#39;re right, I did not take the captures into account. OTOH
&gt; $c-&gt;req-&gt;path does not necessarily correspond to the path argument of
&gt; $c-&gt;uri_for&#40;&#41; &#40;that&#39;s exactly the reason why we have $c-&gt;uri_for&#40;&#41;,
&gt; isn&#39;t it?:-&#41;. What do you think of this solution:
&gt; 
&gt; $c-&gt;uri_for&#40;
&gt;  $c-&gt;action, $c-&gt;req-&gt;captures,
&gt;  @{$c-&gt;req-&gt;arguments},
&gt;  $c-&gt;req-&gt;params
&gt; &#41;;
&gt; 
&gt; According the documentation of Catalyst::uri_for&#40;&#41;, if $path is an action
&gt; object and the first argument after it is an array ref, it is considered
&gt; as the list of captures, and is passed to
&gt; $c-&gt;dispatcher-&gt;uri_for_action&#40;&#41; along with the action object. So, if the
&gt; dispatcher can reconstruct the path from the action object and the
&gt; captures, it works. Now the question is how much can we depend on it &#40;ie.
&gt; that uri_for_action&#40;&#41; works well&#41;.
</div>
My note about &#34;complex regexp actions&#34; was specifically because
uri_for_action can&#39;t work universally.

How about reusing $c-&gt;req-&gt;uri to get the query string?

I honestly don&#39;t think uri_for_action is safe enough for this.

Hmm. You still want to go via uri_for of course.

What about

my $uri = $c-&gt;uri_for&#40;&#39;/&#39;.$c-&gt;req-&gt;path&#41;;
$uri-&gt;query&#40;$c-&gt;req-&gt;uri-&gt;query&#41;;

?

That seems to fix the query param problem you have and still not rely
on uri_for_action. If $c-&gt;req-&gt;path isn&#39;t the right thing then that&#39;s a
separate problem and probably belongs on catalyst-dev@lists.scsys.co.uk

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; For Catalyst::DispatchType::Regex I just filed a bug report &#40;rt.cpan.org
&gt; #39369&#41;, as its uri_for_action&#40;&#41; is totally broken. But even if my patch
&gt; is accepted, the implementation is still admittedly weak &#40;eg. it cannot
&gt; cope with nested parentheses according to the documentation&#41;, and it&#39;s no
&gt; surprise, as the task is inherently very tough &#40;to reconstruct the
&gt; original string that was matched from the regex and captures&#41;.
</div>
Yes, I know. I wrote the original code for that &#40;and all of Chained&#41; and
basically implemented uri_for_action for regexp to &#34;mostly work&#34; - I didn&#39;t
try and cover many edge cases because once you go into edge cases it gets
harder and harder, and was frankly pleasantly surprised I managed to make
it work at all :&#41; - but please note that the correct place to discuss
changes to things is the catalyst-dev@ list, most of the relevant people
aren&#39;t on rt so you&#39;ll get long ping times like we&#39;ve had here.

Once we get capture matching for Chained so you can do something like

CaptureArgs&#40;qr/\d+/&#41;

or similar, then Regexp basically becomes obsolete, which was always my
intention, and then it becomes a much simpler thing.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; A better solution for -you- IMO would be if you captured the language
&gt; &gt; via a
&gt; &gt; 
&gt; &gt; sub lang :Chained&#40;&#39;/&#39;&#41; :CaptureArgs&#40;1&#41; {
&gt; &gt; 
&gt; &gt; action - then this would all work already; mangling $c-&gt;req-&gt;path is
&gt; &gt; dangerous and highly inadvisable.
</div>&gt; 
&gt; Thanks for pointing it out. In fact I perused the manual of
&gt; Catalyst::DispatchType::Chained twice before we settled with the
&gt; prepare_path&#40;&#41; + uri_for&#40;&#41; hack, as I felt that it&#39;s something very
&gt; close, but somehow it did not lend itself as the solution we looked for.
&gt; It did not get through for me that there need not be one predetermined
&gt; endpoint for each chain. I&#39;ll convert our app to use Chained soon.
</div>
Well, there is a predetermined end point, but you can chain lots of
things off one start point :&#41;

Anyway, that conversation should continue on the mailing list if at all.

-- 
      Matt S Trout       Need help with your Catalyst or DBIx::Class project?
   Technical Director                    <span class="clickylink"><a target="new" rel="nofollow" href="http://www.shadowcat.co.uk/catalyst/">http://www.shadowcat.co.uk/catalyst/</a></span>
 Shadowcat Systems Ltd.  Want a managed development or deployment platform?
<span class="clickylink"><a target="new" rel="nofollow" href="http://chainsawblues.vox.com/">http://chainsawblues.vox.com/</a></span>            <span class="clickylink"><a target="new" rel="nofollow" href="http://www.shadowcat.co.uk/servers/">http://www.shadowcat.co.uk/servers/</a></span>
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
