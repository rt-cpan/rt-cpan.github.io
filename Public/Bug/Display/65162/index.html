<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #65162 for MIME-tools: Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #65162 for MIME-tools: Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=MIME-tools">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=MIME-tools">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=MIME-tools">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=MIME-tools">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/MIME-tools">MIME-tools CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">65162</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=MIME-tools">MIME-tools</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">dfs+pause [...] roaringpenguin.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Mark.Martinec [...] ijs.si

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21368-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21369-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




0.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/892136/462490/0.diff">
Thu Feb 03 19:26:34 2011 (4.8k) by Mark.Martinec [...] ijs.si
</a>
</font></li>
</ul>


encoded-filename.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/887650/460067/encoded-filename.diff">
Wed Jan 26 14:16:54 2011 (2.5k) by dfs [...] roaringpenguin.com
</a>
</font></li>
</ul>


mime-tools.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/890228/461422/mime-tools.diff">
Mon Jan 31 16:05:12 2011 (13.7k) by dfs [...] roaringpenguin.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=65162">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-887614" href="/Public/Bug/Display.html?id=65162#txn-887614">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;26&nbsp;13:03:00&nbsp;2011</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 26 Jan 2011 19:02:47 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Martinec &lt;Mark.Martinec [...] ijs.si&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/887614/460062/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/460062">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 837b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">A change RT #63739 between MIME-tools-5.428 and MIME-tools-5.500
is now causing mail parsing to flop fatally with a die&#40;&#41; in MIME::Words.

The problem occurs because the MIME decoding of Content-Type.name
&#40;and similar fields&#41; now occurs twice: once in MIME/Field/ParamVal.pm
converting the file name to Perl characters &#40;Unicode&#41;, then again in
MIME::Words::decode_mimewords called from MIME::WordDecoder::decode,
which dies on seeing a non-byte character.

To reproduce:

$ perl -MMIME::Parser -e &#39;MIME::Parser-&gt;new-&gt;parse&#40;\*STDIN&#41;&#39; &lt;0.txt
MIME::Words: unexpected case:
&#40;ÃŽÂ²CURE.txt&#41; pos 0
        Please alert developer.

A sample message 0.txt:

  From: test@example.com
  Subject: test
  Date: Tue, 25 Jan 2011 14:35:04 +0100
  Message-Id: &lt;123@example.com&gt;
  Content-Type: text/plain; name*=utf-8&#39;&#39;%CE%B2CURE%2Etxt

  test




Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-887649" href="/Public/Bug/Display.html?id=65162#txn-887649">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;26&nbsp;14:15:06&nbsp;2011</span>
    <span class="description">dfs+pause [...] roaringpenguin.com -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-887650" href="/Public/Bug/Display.html?id=65162#txn-887650">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;26&nbsp;14:16:54&nbsp;2011</span>
    <span class="description">dfs [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 26 Jan 2011 14:16:41 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David F. Skoll&#34; &lt;dfs [...] roaringpenguin.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/887650/460066/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/460066">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 191b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Thanks for your bug report.  Could you please try the attached patch?
I feel quite dirty doing it this way, but it was the only sensible solution
I could come up with.

Regards,

David.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/887650/460067/encoded-filename.diff">Download encoded-filename.diff</a><br />
<span class="downloadcontenttype">text/x-diff 2.5k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-887653" href="/Public/Bug/Display.html?id=65162#txn-887653">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;26&nbsp;14:16:55&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-887669" href="/Public/Bug/Display.html?id=65162#txn-887669">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;26&nbsp;15:11:27&nbsp;2011</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 26 Jan 2011 21:11:12 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Martinec &lt;Mark.Martinec [...] ijs.si&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/887669/460078/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/460078">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">David,

Thanks, that was quick!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Could you please try the attached patch? I feel quite dirty
&gt; doing it this way, but it was the only sensible solution
&gt; I could come up with.
</div>
Well, it does fix the immediate issue, although I fear it might break
some expected uses &#40;like banned filenames checks in amavisd :&#41;

The sample message &#40;having a name: utf-8&#39;&#39;%CE%B2CURE%2Etxt &#41;
as returned by $head-&gt;mime_attr&#40;&#39;content-type.name&#39;&#41;
and as $head-&gt;recommended_filename yielded
a \316\262CURE.txt with 5.428, and a \x{03b2}CURE.txt  with 5.500.

Either of the two choices made a sensible candidate for checking rules.
Now both attributes give =?UTF-8?B?zrJDVVJFLnR4dA==?=,
so a caller must now do a &#39;MIME-Header&#39; decoding &#40;which is
what I expected the change in #63739 tried to avoid&#41;.
The docs on mime_attr&#40;&#41; doesn&#39;t say anything about 
re-encoding attributes from RFC 2184 into RFC 2047 form.

Perhaps we need an additional method besides mime_attr&#40;&#41;, e.g.
a mime_attr_raw, which could provide a: utf-8&#39;&#39;%CE%B2CURE%2Etxt
in case of this sample message. Then the mime_attr could continue
to provide a decoded name, either as UTF-8 encoded  bytes, or as
perl Unicode characters.

Somehow it sounds wrong that the MIME::WordDecoder::decode
even tried to decode what was known to already have been decoded.

  Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-887681" href="/Public/Bug/Display.html?id=65162#txn-887681">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;26&nbsp;15:43:50&nbsp;2011</span>
    <span class="description">dfs [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 26 Jan 2011 15:43:39 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David F. Skoll&#34; &lt;dfs [...] roaringpenguin.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/887681/460080/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/460080">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, 26 Jan 2011 15:11:28 -0500
&#34;Mark.Martinec@ijs.si via RT&#34; &lt;bug-MIME-tools@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Well, it does fix the immediate issue, although I fear it might break
&gt; some expected uses &#40;like banned filenames checks in amavisd :&#41;
</div>
Yes, it&#39;s not a good solution.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Either of the two choices made a sensible candidate for checking
&gt; rules. Now both attributes give =?UTF-8?B?zrJDVVJFLnR4dA==?=,
&gt; so a caller must now do a &#39;MIME-Header&#39; decoding &#40;which is
&gt; what I expected the change in #63739 tried to avoid&#41;.
&gt; The docs on mime_attr&#40;&#41; doesn&#39;t say anything about 
&gt; re-encoding attributes from RFC 2184 into RFC 2047 form.
</div>
Right.  The problem is that RFC 2184 is completely evil.  Consider
something like:

Content-Type: text/plain;
              name*0*=ISO-8859-1&#39;&#39;%61%74%74
              name*1*=UTF-8&#39;&#39;Something_else
              name*2*=BIG5&#39;&#39;%FE%45

I think the only sensible thing is to return a utf-8 value because
utf-8 is a superset of all the other encodings.  The only question
is whether to return a native Perl UTF-8 string or the horrible
re-encoded =?UTF-8?B?....?= string.  MIME::tools is ancient and creaky
and needs an overhaul. :&#40;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Perhaps we need an additional method besides mime_attr&#40;&#41;, e.g.
&gt; a mime_attr_raw, which could provide a: utf-8&#39;&#39;%CE%B2CURE%2Etxt
&gt; in case of this sample message. Then the mime_attr could continue
&gt; to provide a decoded name, either as UTF-8 encoded  bytes, or as
&gt; perl Unicode characters.
</div>
The issue is that RFC 2184 allows you to mix different encodings in
the same parameter.  The rest of the MIME::tools API does not handle
that well.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Somehow it sounds wrong that the MIME::WordDecoder::decode
&gt; even tried to decode what was known to already have been decoded.
</div>
Yes, I agree.  Let me dig into the code a bit more to see if I can
come up with a better fix.

Regards,

David.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-887684" href="/Public/Bug/Display.html?id=65162#txn-887684">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;26&nbsp;15:47:53&nbsp;2011</span>
    <span class="description">dfs [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 26 Jan 2011 15:47:43 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David F. Skoll&#34; &lt;dfs [...] roaringpenguin.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/887684/460083/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/460083">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 344b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, 26 Jan 2011 15:43:39 -0500
&#34;David F. Skoll&#34; &lt;dfs@roaringpenguin.com&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Content-Type: text/plain;
&gt;             name*0*=ISO-8859-1&#39;&#39;%61%74%74
&gt;             name*1*=UTF-8&#39;&#39;Something_else
&gt;             name*2*=BIG5&#39;&#39;%FE%45
</div>
Never mind; I&#39;m an idiot... you can&#39;t change encoding within the same
parameter &#40;according to RFC 2184&#41;

Regards,

David.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-887693" href="/Public/Bug/Display.html?id=65162#txn-887693">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;26&nbsp;16:18:20&nbsp;2011</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 26 Jan 2011 22:18:06 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Martinec &lt;Mark.Martinec [...] ijs.si&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/887693/460090/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/460090">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 607b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think the only sensible thing is to return a utf-8 value because
&gt; utf-8 is a superset of all the other encodings.  The only question
&gt; is whether to return a native Perl UTF-8 string or the horrible
&gt; re-encoded =?UTF-8?B?....?= string.  MIME::tools is ancient and creaky
&gt; and needs an overhaul. :&#40;
</div>
Agreed. Sounds to me like the properly decoded and then utf-8
encoded &#40;as a string of octets&#41; form would cause least surprise.
This is what 4.* was returning, so it remains compatible,
while solving the previous sloppy decoding.

I would settle for a native Perl Unicode character string too.

  Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-887858" href="/Public/Bug/Display.html?id=65162#txn-887858">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;26&nbsp;20:44:13&nbsp;2011</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 27 Jan 2011 02:44:01 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Martinec &lt;Mark.Martinec [...] ijs.si&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/887858/460170/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/460170">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 818b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I think the only sensible thing is to return a utf-8 value because
&gt; &gt; utf-8 is a superset of all the other encodings.  The only question
&gt; &gt; is whether to return a native Perl UTF-8 string or the horrible
&gt; &gt; re-encoded =?UTF-8?B?....?= string.  MIME::tools is ancient and creaky
&gt; &gt; and needs an overhaul. :&#40;
</div>&gt; 
&gt; Agreed. Sounds to me like the properly decoded and then utf-8
&gt; encoded &#40;as a string of octets&#41; form would cause least surprise.
&gt; 
&gt; I would settle for a native Perl Unicode character string too.
</div>
On a second thought, your suggestion of native Perl string
makes more sense to me now &#40;not utf-8 encoded octets, and
certainly not re-encoded to mime =?...? encoding&#41;.

So that would be what 5.500 returns now, if it would not die.
&#40;it doesn&#39;t die if a caller supplies his own $parser-&gt;filer&#41;

  Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-888200" href="/Public/Bug/Display.html?id=65162#txn-888200">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;27&nbsp;10:33:20&nbsp;2011</span>
    <span class="description">dfs [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 27 Jan 2011 10:33:09 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David F. Skoll&#34; &lt;dfs [...] roaringpenguin.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/888200/460372/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/460372">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, Mark,

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On a second thought, your suggestion of native Perl string
&gt; makes more sense to me now &#40;not utf-8 encoded octets, and
&gt; certainly not re-encoded to mime =?...? encoding&#41;.
</div>
OK... please try this much simpler patch.

Regards,

David.

diff --git a/lib/MIME/Words.pm b/lib/MIME/Words.pm
index 92824c5..d8aac7d 100644
--- a/lib/MIME/Words.pm
+++ b/lib/MIME/Words.pm
@@ -211,7 +211,7 @@ sub decode_mimewords {
        ### Case 3: are we looking at ordinary text?
        pos&#40;$encstr&#41; = $pos;               # reset the pointer.
        if &#40;$encstr =~ m{\G                # from where we left off...
-                        &#40;[\x00-\xFF]*?    #   shortest possible string,
+                        &#40;.*?    #   shortest possible string,
                          \n*&#41;             #   followed by 0 or more NLs,
                         &#40;?=&#40;\Z|=\?&#41;&#41;      # terminated by &#34;=?&#34; or EOS
                        }xg&#41; {
diff --git a/t/attachment-filename-encoding.t b/t/attachment-filename-encoding.t
index 54693df..f7e36a8 100644
--- a/t/attachment-filename-encoding.t
+++ b/t/attachment-filename-encoding.t
@@ -8,7 +8,7 @@ use utf8;
 binmode STDOUT, &#34;:utf8&#34;;
 binmode STDERR, &#34;:utf8&#34;;
 
-plan tests =&gt; 5;
+plan tests =&gt; 7;
 
 main: {
     #-- Load MIME::Parser
@@ -41,6 +41,16 @@ main: {
     #-- Check if parsed recommended filename matches the expected string
     is&#40;$filename, &#34;attachment.&lt;C3&gt;&lt;A4&gt;&lt;C3&gt;&lt;B6&gt;&lt;C3&gt;&lt;BC&gt;&#34;,
        &#34;Parsed filename should match expectation&#34;&#41;;
+
+    # CPAN ticket #65162
+    # We need the default parser to tickle the bug
+    $parser = MIME::Parser-&gt;new&#40;&#41;;
+    $parser-&gt;output_to_core&#40;0&#41;;
+    $parser-&gt;output_under&#40;&#39;/tmp&#39;&#41;;
+    $entity = $parser-&gt;parse_data&#40;&#34;From: test\@example.com\nSubject: test\nDate: Tue, 25 Jan 2011 14:35:04 +0100\nMessage-Id: &lt;123\@example.com&gt;\nContent-Type: text/plain; name*=utf-8&#39;&#39;%CE%B2CURE%2Etxt\n\ntest\n&#34;&#41;;
+    $filename = $entity-&gt;head-&gt;recommended_filename;
+    is&#40;utf8::is_utf8&#40;$filename&#41;, 1, &#34;Parsed filename should have UTF-8 flag on&#34;&#41;;
+    is&#40;$filename, &#34;\x{3b2}CURE.txt&#34;, &#39;Got expected filename&#39;&#41;;
 }
 
 #-- Parse quoted printable file and return MIME::Entity
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-888446" href="/Public/Bug/Display.html?id=65162#txn-888446">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;27&nbsp;13:49:26&nbsp;2011</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 27 Jan 2011 19:49:07 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Martinec &lt;Mark.Martinec [...] ijs.si&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/888446/460525/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/460525">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 369b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; OK... please try this much simpler patch.
</div>
Well, it avoids the immediate problem,
but allowing implicit nested decoding is evil.

Take this one:
  Content-Type: text/plain; name*=&#39;&#39;%3d%3futf-8?b?BEFORE%3f%3d

The $entity-&gt;head-&gt;recommended_filename 
will report a filename:
  =?utf-8?b?BEFORE?=

yet the file actually generated file will be named:
  %04AND.dat

Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-888455" href="/Public/Bug/Display.html?id=65162#txn-888455">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;27&nbsp;13:51:46&nbsp;2011</span>
    <span class="description">dfs [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 27 Jan 2011 13:51:36 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David F. Skoll&#34; &lt;dfs [...] roaringpenguin.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/888455/460530/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/460530">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 373b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, 27 Jan 2011 13:49:27 -0500
&#34;Mark.Martinec@ijs.si via RT&#34; &lt;bug-MIME-tools@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Well, it avoids the immediate problem,
&gt; but allowing implicit nested decoding is evil.
</div>
No, there&#39;s no nested decoding.  Did you apply the patch against
a pristine copy of 5.500?  The patch replaces my earlier attempt...
it shouldn&#39;t be added to it.

Regards,

David.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-888458" href="/Public/Bug/Display.html?id=65162#txn-888458">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;27&nbsp;14:17:12&nbsp;2011</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 27 Jan 2011 20:16:58 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Martinec &lt;Mark.Martinec [...] ijs.si&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/888458/460533/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/460533">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 613b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Did you apply the patch against a pristine copy of 5.500?
&gt; The patch replaces my earlier attempt... it shouldn&#39;t be added to it.
</div>
I did.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; No, there&#39;s no nested decoding.  
</div>
There is, try it for yourself:

$ perl -MMIME::Parser -e &#39;
  print MIME::Parser-&gt;new-&gt;parse&#40;\*STDIN&#41;-&gt;head-&gt;recommended_filename,&#34;\n&#34;&#39; &lt;1.msg

=?utf-8?b?BEFORE?=


$ ll -tr | tail -3
-rw-r-----    1 xxx xxx       5 Jan 27 20:13 %04AND.dat


1.msg:

 From: test@example.com
 Subject: test
 Date: Tue, 25 Jan 2011 14:35:04 +0100
 Message-Id: &lt;123@example.com&gt;
 Content-Type: text/plain; name*=&#39;&#39;%3d%3futf-8?b?BEFORE%3f%3d

 test



Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-888460" href="/Public/Bug/Display.html?id=65162#txn-888460">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;27&nbsp;14:38:55&nbsp;2011</span>
    <span class="description">dfs [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 27 Jan 2011 14:38:45 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David F. Skoll&#34; &lt;dfs [...] roaringpenguin.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/888460/460535/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/460535">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 360b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

OK... I see the problem.

This will take me some time to untangle.  In some places,
recommended_filename is preceded with an unmime call and in others
it is not.  I don&#39;t believe the original author was consistent in
assuming whether or not recommended_filename had already done the
decoding. :&#40;

For now, I&#39;d recommend not using 5.500.

Regards,

David.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-890228" href="/Public/Bug/Display.html?id=65162#txn-890228">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;31&nbsp;16:05:12&nbsp;2011</span>
    <span class="description">dfs [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 31 Jan 2011 16:04:52 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David F. Skoll&#34; &lt;dfs [...] roaringpenguin.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/890228/461421/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/461421">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 498b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

So far, what I&#39;ve come up with is the attached patch against 5.500.
It&#39;s pretty evil.

We have to re-encode rfc2231-encoded parameters; I choose to encode them
as =?UTF8?B?....?=

That&#39;s because everything else in MIME::tools assumes that
$head-&gt;mime_attr&#40;...&#41; gets encoded MIME-words.

$head-&gt;recommended_filename now decodes the parameter it gets back.  It
returns an internal Perl string that may have the UTF-8 flag set.

Please let me know how this patch works for you.

Regards,

David.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/890228/461422/mime-tools.diff">Download mime-tools.diff</a><br />
<span class="downloadcontenttype">text/x-diff 13.7k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-890872" href="/Public/Bug/Display.html?id=65162#txn-890872">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;01&nbsp;14:23:26&nbsp;2011</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 1 Feb 2011 20:23:13 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Martinec &lt;Mark.Martinec [...] ijs.si&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/890872/461714/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/461714">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 611b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So far, what I&#39;ve come up with is the attached patch against 5.500.
&gt; It&#39;s pretty evil.
&gt; We have to re-encode rfc2231-encoded parameters; I choose to encode
&gt; them as =?UTF8?B?....?=
&gt; That&#39;s because everything else in MIME::tools assumes that
&gt; $head-&gt;mime_attr&#40;...&#41; gets encoded MIME-words.
&gt; $head-&gt;recommended_filename now decodes the parameter it gets back.
&gt; It returns an internal Perl string that may have the UTF-8 flag set.
&gt; 
&gt; Please let me know how this patch works for you.
</div>
Thanks! So far so good, it seems it does the job.

Let me observe our logs for a day or two before committing.

  Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-892136" href="/Public/Bug/Display.html?id=65162#txn-892136">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;03&nbsp;19:26:34&nbsp;2011</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 4 Feb 2011 01:26:16 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Martinec &lt;Mark.Martinec [...] ijs.si&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/892136/462489/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/462489">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $head-&gt;recommended_filename now decodes the parameter it gets back.
&gt; It returns an internal Perl string that may have the UTF-8 flag set.
</div>
That is very nice now.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; We have to re-encode rfc2231-encoded parameters;
&gt; I choose to encode them as =?UTF8?B?....?=
&gt; That&#39;s because everything else in MIME::tools assumes that
&gt; $head-&gt;mime_attr&#40;...&#41; gets encoded MIME-words.
</div>
I would prefer to retain the same character set *and* language
information, just transcode rfc2231 into rfc2047 Q-encoding.

This would allow a mail scanning software to obtain richer
original information about MIME attributes for names,
avoiding a &#39;Lost in translation&#39; syndrome :&#41;

Please try my attached patch. It applies on top of yours.
I started implementing my suggestion above, but ended up
also fixing some potentially lurking taint issues regarding
global $1, $2, ... variables [perl #67962, fixed in perl 5.13],
and removed some redundancies &#40;like assigning an empty hash
to a known empty &#40;just created&#41; hash, saves 6 perl opcodes&#41;,
and replacing a $ with \z in some regexps where we really want
to match the end-of-string, not some complex interpretation
of the end-of-something.

I also think that the changed code now better follows rfc2231:
the &#39;chset&#39;lang&#39; decoding should not be applied independently
to each continuation, but only when parts are already assembled
&#40;see example in rfc2231 section 4.1&#41;. Also, this decoding only
applies when a final &#39;*&#39; enables it, otherwise it does not apply.

I have one terminology concern regarding the name chosen for
the new &#39;UTF-8&#39; decoder in WordDecoder.pm, but more on this
perhaps next time.

  Mark
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/892136/462490/0.diff">Download 0.diff</a><br />
<span class="downloadcontenttype">text/x-diff 4.8k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-892542" href="/Public/Bug/Display.html?id=65162#txn-892542">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;04&nbsp;10:16:51&nbsp;2011</span>
    <span class="description">dfs [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 4 Feb 2011 10:16:34 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David F. Skoll&#34; &lt;dfs [...] roaringpenguin.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/892542/462709/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/462709">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 759b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, Mark,

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I would prefer to retain the same character set *and* language
&gt; information, just transcode rfc2231 into rfc2047 Q-encoding.
</div>
That&#39;s a good suggestion.  I agree it&#39;s a better option.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please try my attached patch. It applies on top of yours.
</div>
I tried it and all tests pass, so I think it&#39;s good.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I also think that the changed code now better follows rfc2231:
&gt; the &#39;chset&#39;lang&#39; decoding should not be applied independently
&gt; to each continuation, but only when parts are already assembled
</div>
Yep.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have one terminology concern regarding the name chosen for
&gt; the new &#39;UTF-8&#39; decoder in WordDecoder.pm, but more on this
&gt; perhaps next time.
</div>
OK.  Let me know. :&#41;

I&#39;ve applied your patch and committed it in my git repo.

Regards,

David.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-892609" href="/Public/Bug/Display.html?id=65162#txn-892609">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;04&nbsp;13:20:54&nbsp;2011</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 4 Feb 2011 19:20:34 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Martinec &lt;Mark.Martinec [...] ijs.si&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/892609/462738/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/462738">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve applied your patch and committed it in my git repo.
</div>
Thanks!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I have one terminology concern regarding the name chosen for
&gt; &gt; the new &#39;UTF-8&#39; decoder in WordDecoder.pm, but more on this
&gt; &gt; perhaps next time.
</div>&gt; 
&gt; OK.  Let me know. :&#41;
</div>
I can understand that WordDecoder.pm probably pre-dates the Perl native
handling of Unicode, so its structure, documentation and examples
probably reflect that. From a current point of view, its terminology
can be confusing &#40;and it was for me, took several passes of browsing
through code to grasp what it is that it is supposed to do&#41;.

As I &#40;think I&#41; understand it now, it offers a couple of simple
*transcoders* with poorly defined semantics, plus one genuine
decoder &#40;the &#39;UTF-8&#39;&#41;.

I&#39;ll try to explain the underlying conceptual model in Perl parlance,
the way I see it was supposed to be, or at least the way I would
expect it &#40;bear with me, I know the steps 2 and 3 are integrated&#41;:

1. text in RFC 2047 is *decoded* into chunks, each chunk is a pair
of: a character set name &#40;with optional language&#41;, plus a string
of octets. A non-  RFC 2047 string is just represented as an
empty &#40;unknown&#41; character set name, plus a verbatim copy of
octets. This first step is done by MIME::Words::decode_mimewords,
called from decode&#40;&#41;.

2. the list of chunks &#40;chset+octets&#41; is further *decoded* into Perl native
&#40;Unicode&#41; characters &#40;not bytes&#41; &#40;we must not care or believe-we-know-better
how it is represented internally&#41;. The resulting strings from all chunks are
joined, forming a correct native characters string representation of a
text from a mail header field.

3. the native character string is then optionally *encoded* into
a requested encoding, resulting in a string of octets, i.e. an external
representation of the given text in the requested encoding.


The provided &#39;UTF-8&#39; &#34;decoder&#34; is indeed the only true *decoder*, skipping
the last encoding step.  It does the #1 and #2, and returns a native
perl characters string. Its name &#39;UTF-8&#39; is a misnomer and is misleading,
one would expect from its name that it does the final step #3 and
encodes into UTF-8, but it doesn&#39;t, it returns a native &#40;Unicode&#41; string.
In my view it should be renamed to something like &#39;native&#39; or
&#39;Unicode&#39; or &#39;perl string&#39;.

Remaining traditional &#34;decoders&#34; are actually *transcoders*. They integrate
steps #2 and #3 into one operation, and do it halfheartedly: for example
given an RFC 2047 text in Latin-15 and transcoding it into Latin-1,
a small handful of characters does not have their equivalent and should
be nuked &#40;by &#39;?&#39; or whatever&#41;, the rest is fine and can be retained.

For completeness one might expect there exists a &#39;UTF-8&#39; *transcoder*,
which would as a step #3 encode the native string into UTF-8 octets
and return that. It would be even better if one could provide an
arbitrary encoding &#40;known to Perl&#41; as an argument to such a
general-purpose transcoder - it should be trivial to implement,
just needs to call Encoder::encode on a native string as obtained
from step #2.



I think at least the documentation should be updated, some
examples are misleading &#40;like the:
    ### Decode a MIME string &#40;e.g., into Latin1&#41; via the default decoder:
    $str = $wd-&gt;decode&#40;&#39;To: =?ISO-8859-1?Q?Keld_J=F8rn_Simonsen?= &lt;keld&gt;&#39;&#41;;
which somehow leads a reader into thinking that the #3 encoding &#34;into Latin1&#34;
is in any way related to the &#34;ISO-8859-1&#34; in the example RFC 2047 string&#41;,

and perhaps the &#39;UTF-8&#39; *decoder* renamed or at least documented
that it is *not* a *transcoder* like all the rest, and maybe an &#39;UTF-8&#39;
*transcoder* implemented.

Just though I should relieve it off my chest, sorry for being long
and for giving you a headache :&#41;

Regards
   Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-892997" href="/Public/Bug/Display.html?id=65162#txn-892997">#</a>      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;05&nbsp;10:22:28&nbsp;2011</span>
    <span class="description">dfs [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 5 Feb 2011 10:22:13 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David F. Skoll&#34; &lt;dfs [...] roaringpenguin.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/892997/462944/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/462944">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 819b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, 4 Feb 2011 13:20:55 -0500
&#34;Mark.Martinec@ijs.si via RT&#34; &lt;bug-MIME-tools@rt.cpan.org&gt; wrote:

[Thoughts about &#34;decoding&#34; vs &#34;transcoding&#34;]

I agree with all of your points. :&#41;  Maybe I&#39;ll call the
UTF-8 decoder MIME::WordDecoder::PerlString to make it clear it decodes
to an internal Perl string.

In the long term, I need to take a chainsaw to that code.  It was
written for ancient Perl and most of it&#39;s pretty lousy.  It&#39;s time
to stop worrying about Perl 5.6. :&#41;

I think we should only have one function: MIME-encoded string =&gt;
internal Perl string.  If you want to transcode to another character
set, that&#39;s what Perl&#39;s Encode module is for.

I will write a helper global function called &#34;mimewords_to_perl_string&#34; or
something, and start deprecating all of the other decoding functions.

Regards,

David.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-893195" href="/Public/Bug/Display.html?id=65162#txn-893195">#</a>      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;05&nbsp;19:35:58&nbsp;2011</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 6 Feb 2011 01:35:40 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Martinec &lt;Mark.Martinec [...] ijs.si&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/893195/463043/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/463043">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 911b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [Thoughts about &#34;decoding&#34; vs &#34;transcoding&#34;]
&gt; I agree with all of your points. :&#41;  Maybe I&#39;ll call the
&gt; UTF-8 decoder MIME::WordDecoder::PerlString to make it clear
&gt; it decodes to an internal Perl string.
</div>
Yes, that would be nice.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In the long term, I need to take a chainsaw to that code.
</div>
:&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It was written for ancient Perl and most of it&#39;s pretty lousy.
&gt; It&#39;s time to stop worrying about Perl 5.6. :&#41;
&gt; 
&gt; I think we should only have one function: MIME-encoded string =&gt;
&gt; internal Perl string.  If you want to transcode to another character
&gt; set, that&#39;s what Perl&#39;s Encode module is for.
</div>
Agreed, that&#39;s a sensible thing to do. No need to duplicate
functionality offered by the Encode module.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I will write a helper global function called &#34;mimewords_to_perl_string&#34;
&gt; or something, and start deprecating all of the other decoding functions.
</div>
Thanks for your understanding and efforts!

  Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-898810" href="/Public/Bug/Display.html?id=65162#txn-898810">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;17&nbsp;12:04:12&nbsp;2011</span>
    <span class="description">dfs [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 17 Feb 2011 12:03:59 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David F. Skoll&#34; &lt;dfs [...] roaringpenguin.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/898810/466084/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/466084">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 581b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hi, Mark,

Please try:

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.roaringpenguin.com/MIME-tools-5.501.tar.gz">http://www.roaringpenguin.com/MIME-tools-5.501.tar.gz</a></span>
Signature: <span class="clickylink"><a target="new" rel="nofollow" href="http://www.roaringpenguin.com/MIME-tools-5.501.tar.gz.sig">http://www.roaringpenguin.com/MIME-tools-5.501.tar.gz.sig</a></span>

My public key: <span class="clickylink"><a target="new" rel="nofollow" href="http://www.roaringpenguin.com/files/dskoll-key-2005.txt">http://www.roaringpenguin.com/files/dskoll-key-2005.txt</a></span>

Please DO NOT distribute this because it isn&#39;t yet the &#34;official&#34;
5.501 release.

Regards,

David.
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.10 &#40;GNU/Linux&#41;

iD8DBQFNXVT/wYQuKhJvQuARAqmKAJ9QHk/XTvYdhCzuGuvRK/qM4GU8hACgmPfY
IdGVz7s0J+GccZDls2cj9cA=
=JW7F
-----END PGP SIGNATURE-----
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-898890" href="/Public/Bug/Display.html?id=65162#txn-898890">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;17&nbsp;13:12:54&nbsp;2011</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 17 Feb 2011 19:12:41 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Martinec &lt;Mark.Martinec [...] ijs.si&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/898890/466147/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/466147">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 516b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please try:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.roaringpenguin.com/MIME-tools-5.501.tar.gz">http://www.roaringpenguin.com/MIME-tools-5.501.tar.gz</a></span>
</div>
Thanks, looks good, works as expected! &#40;tested with amavisd-new&#41;


Btw, one unrelated minor wish: could you please increase a bit
the 2 kB I/O buffer size in MIME/Entity.pm and MIME/Body.pm,
perhaps to 4k or 8k. For some operations I need to pass my own
perl methods as a tied glob to MIME-tools, which end up being
accessed &#40;read&#41; through MIME::Entity::print_body. Larger buffer
would reduce a bit the overhead of calls for large mail.

  Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-898892" href="/Public/Bug/Display.html?id=65162#txn-898892">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;17&nbsp;13:18:06&nbsp;2011</span>
    <span class="description">dfs [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65162] Double-decoding failure in 5.500, caused by a &#39;fix&#39; #63739</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 17 Feb 2011 13:17:57 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David F. Skoll&#34; &lt;dfs [...] roaringpenguin.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/898892/466149/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/466149">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 304b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, 17 Feb 2011 13:12:55 -0500
&#34;Mark.Martinec@ijs.si via RT&#34; &lt;bug-MIME-tools@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Btw, one unrelated minor wish: could you please increase a bit
&gt; the 2 kB I/O buffer size in MIME/Entity.pm and MIME/Body.pm,
&gt; perhaps to 4k or 8k.
</div>
Sure.  I&#39;ve increased it to 8k.

Regards,

David.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-898961" href="/Public/Bug/Display.html?id=65162#txn-898961">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;17&nbsp;16:20:49&nbsp;2011</span>
    <span class="description">dfs+pause [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/898961/466202/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/466202">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 99b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

I believe the just-released 5.501 version of MIME::tools fixes this bug.

Regards,

David.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-898964" href="/Public/Bug/Display.html?id=65162#txn-898964">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;17&nbsp;16:20:51&nbsp;2011</span>
    <span class="description">dfs+pause [...] roaringpenguin.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 1.061425</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
