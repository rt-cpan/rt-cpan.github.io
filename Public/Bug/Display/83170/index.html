<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #83170 for Mail-DKIM: Fixing incompatibilities with Net::DNS</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #83170 for Mail-DKIM: Fixing incompatibilities with Net::DNS</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Mail-DKIM">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Mail-DKIM">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Mail-DKIM">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Mail-DKIM">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-DKIM">Mail-DKIM CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">83170</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Mail-DKIM">Mail-DKIM</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">jason [...] long.name
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Mark.Martinec [...] ijs.si

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-38938-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-38939-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.39_6    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




Mail-DKIM-0.39_6.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1178024/621414/Mail-DKIM-0.39_6.patch">
Wed Feb 06 13:55:51 2013 (6.2k) by Mark.Martinec [...] ijs.si
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=83170">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178024" href="/Public/Bug/Display.html?id=83170#txn-1178024">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;06&nbsp;13:55:51&nbsp;2013</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Fixing incompatibilities with Net::DNS</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1178024/621413/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/621413">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The attached patch addresses some DNS-resolver issues which
arose either due to changes brought by Net::DNS 0.69 and later,
or by revealing some hidden problems in Mail::DKIM which went by
unnoticed due to previous behaviour of Net::DNS.


1. Net::DNS [rt.cpan.org #81787]
&#40;NXDOMAIN is no longer reported by $r-&gt;errorstring&#41;

Net::DNS 0.69 &#40;and 0.70&#41; breaks Mail::DKIM, which unwarrantedly
expected that NXDOMAIN would show up in $r-&gt;errorstring.
The NLNetLabs folks were kind enough to revert the change,
nevertheless this needs to be fixed in Mail::DKIM, which
should examine rcode in a DNS reply.  A NXDOMAIN is a
valid response and is not an error.


2. The Net::DNS 0.69 declares the $rr-&gt;char_str_list method
as &#39;historic&#39;. As a replacement, the use of $rr-&gt;txtdata
is suggested. Because DKIM and ADSP specs require that
multiple strings in a TXT RR must be joined with no intervening
spaces the $rr-&gt;txtdata needs to be called in a list context
and letting the application join the strings the way it likes.
Unfortunately the txtdata method in Net::DNS older than 0.69
would always return a single scalar and insert spaces, so for
older versions of Net::DNS the char_str_list is still our
only choice.

See also SpamAssassin bug report:
  <span class="clickylink"><a target="new" rel="nofollow" href="https://issues.apache.org/SpamAssassin/show_bug.cgi?id=6872">https://issues.apache.org/SpamAssassin/show_bug.cgi?id=6872</a></span>
&#40;especially comment 12&#41; for more insight.

3. A small update to a change in Mail::DKIM [rt.cpan.org #80425]:
reduce a default udppacketsize from 2048 to 1240, which should
be able to avoid UDP packet fragmentation in most cases
&#40;which some environments/firewalls don&#39;t like&#41;.
Also avoid early creating a DNS resolver object which
an application may later ditch and replace with its own.

&#40;as a side note: some packet inspecting firewalls may
choke on DNS UDP packets using EDNS0 with sizes beyond 512
bytes. Users of Mail::DKIM which do not use a local DNS
recursive server may suffer from Mail::DKIM turning on the
EDNS0 by default, so perhaps this choice should be reconsidered&#41;


4. Some small changes to error handling: eval {} is capable
of exiting without setting the $@ &#40;like on some signals&#41;.
The reliable way to fetch a $@ is only when eval returns
a false.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Mail-DKIM-0.39_6.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1178024/621414/Mail-DKIM-0.39_6.patch">Download Mail-DKIM-0.39_6.patch</a><br />
<span class="downloadcontenttype">text/x-diff 6.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Mail-DKIM-0.39_6/lib/Mail/DKIM/DNS.pm	2013-02-04 17:38:40.000000000 +0100
+++ Mail-DKIM-0.39_6-new/lib/Mail/DKIM/DNS.pm	2013-02-06 18:58:52.000000000 +0100
@@ -61,6 +61,5 @@
 use Net::DNS;
 our $TIMEOUT = 10;
-our $RESOLVER = Net::DNS::Resolver-&gt;new&#40;&#41;;
-$RESOLVER-&gt;udppacketsize&#40;2048&#41;; # enables EDNS0, sets acceptable UDP packet size
+our $RESOLVER;
 
 # query- returns a list of RR objects
@@ -77,10 +76,21 @@
 	my &#40;$domain, $type&#41; = @_;
 
-	my $rslv = $RESOLVER || Net::DNS::Resolver-&gt;new&#40;&#41;;
-	if &#40;not $rslv&#41;
+	if &#40;! $RESOLVER&#41;
 	{
-		die &#34;can&#39;t create DNS resolver&#34;;
+		$RESOLVER = Net::DNS::Resolver-&gt;new&#40;&#41;;
+		$RESOLVER or die &#34;can&#39;t create DNS resolver: $@&#34;;
+
+		# enable EDNS0, set acceptable UDP packet size to a
+		# conservative payload size that should fit into a single
+		# packet &#40;MTU less the IP header size&#41; in most cases;
+		# See also draft-andrews-dnsext-udp-fragmentation
+		# and RFC 3542 section 11.3.
+		#
+		$RESOLVER-&gt;udppacketsize&#40;1280-40&#41;;
 	}
 
+	my $rslv = $RESOLVER;
+	$rslv or die &#34;DNS resolver not available&#34;;
+
 	#
 	# perform the DNS query
@@ -90,7 +100,8 @@
 	my $remaining_time = alarm&#40;0&#41;;  # check time left, stop the timer
 	my $deadline = time + $remaining_time;
+	my $E;
 	eval
 	{
-		# set a 10 second timeout
+		# set a timeout, 10 seconds by default
 		local $SIG{ALRM} = sub { die &#34;DNS query timeout for $domain\n&#34; };
 		alarm $TIMEOUT;
@@ -99,13 +110,18 @@
 		# us from resetting the alarm before leaving the eval {} block
 		# so we wrap the query in a nested eval {} block
+		my $E2;
 		eval
 		{
 			$resp = $rslv-&gt;send&#40;$domain, $type&#41;;
+			1;
+		} or do {
+			$E2 = $@;
 		};
-		my $E = $@;
 		alarm 0;
-		die $E if $E;
+		if &#40;$E2&#41; { chomp $E2; die &#34;$E2\n&#34; }  # no line number here
+		1;
+	} or do {
+		$E = $@;  # the $@ only makes sense if eval returns a false
 	};
-	my $E = $@;
 	alarm 0;
 	# restart the timer if it was active
@@ -117,15 +133,35 @@
 		alarm&#40;$dt &lt; 1 ? 1 : $dt&#41;;
 	}
-	die $E if $E;
+	if &#40;$E&#41; { chomp $E; die $E }  # ensure a line number
+
+# RFC 2308: NODATA is indicated by an answer with the RCODE set to NOERROR
+# and no relevant answers in the answer section.  The authority section
+# will contain an SOA record, or there will be no NS records there.
+# NODATA responses have to be algorithmically determined from the
+# response&#39;s contents as there is no RCODE value to indicate NODATA.
+# In some cases to determine with certainty that NODATA is the correct
+# response it can be necessary to send another query.
 
 	if &#40;$resp&#41;
 	{
-		my @result = grep { lc $_-&gt;type eq lc $type } $resp-&gt;answer;
-		return @result if @result;
-	}
+		my $header = $resp-&gt;header;
+		if &#40;$header&#41;
+		{
+			# NOERROR, NXDOMAIN, SERVFAIL, FORMERR, REFUSED, ...
+			my $rcode = $header-&gt;rcode;
 
-	$@ = $rslv-&gt;errorstring;
-	return &#40;&#41; if &#40;$@ eq &#34;NOERROR&#34; || $@ eq &#34;NXDOMAIN&#34;&#41;;
-	die &#34;DNS error: $@\n&#34;;
+			$@ = $rcode;
+			if &#40;$rcode eq &#39;NOERROR&#39;&#41; {
+				# may or may not contain RRs in the answer sect
+				my @result = grep { lc $_-&gt;type eq lc $type }
+						  $resp-&gt;answer;
+				$@ = &#39;NODATA&#39;  if !@result;
+				return @result;  # possibly empty
+			} elsif &#40;$rcode eq &#39;NXDOMAIN&#39;&#41; {
+				return;  # empty list, rcode in $@
+			}
+		}
+	}
+	die &#34;DNS error: &#34; . $rslv-&gt;errorstring . &#34;\n&#34;;
 }
 
@@ -150,12 +186,13 @@
 	my $waiter = sub {
 		my @resp;
-		my $warning;
+		my $rcode;
 		eval {
 			@resp = query&#40;$domain, $type&#41;;
-			$warning = $@;
-			undef $@;
+			$rcode = $@;
+			1;
+		} or do {
+			return $on_error-&gt;&#40;$@&#41;;
 		};
-		$@ and return $on_error-&gt;&#40;$@&#41;;
-		$@ = $warning;
+		$@ = $rcode;
 		return $on_success-&gt;&#40;@resp&#41;;
 	};
--- Mail-DKIM-0.39_6/lib/Mail/DKIM/Policy.pm	2013-02-04 16:31:34.000000000 +0100
+++ Mail-DKIM-0.39_6-new/lib/Mail/DKIM/Policy.pm	2013-02-06 17:24:20.000000000 +0100
@@ -66,15 +66,24 @@
 	my $on_success = $callbacks{Success} || sub { $_[0] };
 	$callbacks{Success} = sub {
-			my $resp = shift;
-			unless &#40;$resp&#41;
+			my @resp = @_;
+			unless &#40;@resp&#41;
 			{
-				# no response =&gt; NXDOMAIN, use default policy
+				# no requested resource records or NXDOMAIN,
+				# use default policy
 				return $on_success-&gt;&#40;$class-&gt;default&#41;;
 			}
 
 			my $strn;
-			foreach my $ans &#40;$resp&#41; {
-				next unless $ans-&gt;type eq &#34;TXT&#34;;
-				$strn = join &#34;&#34;, $ans-&gt;char_str_list;
+			foreach my $rr &#40;@resp&#41; {
+				next unless $rr-&gt;type eq &#34;TXT&#34;;
+
+				# join with no intervening spaces, RFC 5617
+				if &#40;Net::DNS-&gt;VERSION &gt;= 0.69&#41; {
+					# must call txtdata&#40;&#41; in a list context
+					$strn = join &#34;&#34;, $rr-&gt;txtdata;
+				} else {
+					# char_str_list method is &#39;historical&#39;
+					$strn = join &#34;&#34;, $rr-&gt;char_str_list;
+				}
 			}
 
--- Mail-DKIM-0.39_6/lib/Mail/DKIM/PublicKey.pm	2013-02-04 17:06:41.000000000 +0100
+++ Mail-DKIM-0.39_6-new/lib/Mail/DKIM/PublicKey.pm	2013-02-06 17:24:27.000000000 +0100
@@ -102,12 +102,20 @@
 			unless &#40;@resp&#41;
 			{
-				# no response =&gt; NXDOMAIN
+				# no requested resource records or NXDOMAIN,
 				return $on_success-&gt;&#40;&#41;;
 			}
 
 			my $strn;
-			foreach my $ans &#40;@resp&#41; {
-				next unless $ans-&gt;type eq &#34;TXT&#34;;
-				$strn = join &#34;&#34;, $ans-&gt;char_str_list;
+			foreach my $rr &#40;@resp&#41; {
+				next unless $rr-&gt;type eq &#34;TXT&#34;;
+
+				# join with no intervening spaces, RFC 6376
+				if &#40;Net::DNS-&gt;VERSION &gt;= 0.69&#41; {
+					# must call txtdata&#40;&#41; in a list context
+					$strn = join &#34;&#34;, $rr-&gt;txtdata;
+				} else {
+					# char_str_list method is &#39;historical&#39;
+					$strn = join &#34;&#34;, $rr-&gt;char_str_list;
+				}
 				last;
 			}
--- Mail-DKIM-0.39_6/t/verifier.t	2012-11-28 15:23:28.000000000 +0100
+++ Mail-DKIM-0.39_6-new/t/verifier.t	2013-02-06 19:07:50.000000000 +0100
@@ -217,5 +217,21 @@
 		warn &#34;did not cache that DNS entry: $domain\n&#34;;
 		print STDERR &#34;&gt;&gt;&gt;\n&#34;;
-		print STDERR join&#40;&#34;&#34;, &#40;Mail::DKIM::DNS::orig_query&#40;$domain, $type&#41;&#41;[0]-&gt;char_str_list&#41; . &#34;\n&#34;;
+		my @result = Mail::DKIM::DNS::orig_query&#40;$domain, $type&#41;;
+		if &#40;!@result&#41; {
+			print STDERR &#34;No results: $@\n&#34;;
+		} else {
+			foreach my $rr &#40;@result&#41; {
+				# join with no intervening spaces, RFC 6376
+				if &#40;Net::DNS-&gt;VERSION &gt;= 0.69&#41; {
+					# must call txtdata&#40;&#41; in a list context
+					printf STDERR &#40;&#34;%s\n&#34;,
+						join&#40;&#34;&#34;, $rr-&gt;txtdata&#41;&#41;;
+				} else {
+					# char_str_list method is &#39;historical&#39;
+					printf STDERR &#40;&#34;%s\n&#34;,
+						join&#40;&#34;&#34;, $rr-&gt;char_str_list&#41;&#41;;
+				}
+			}
+		}
 		print STDERR &#34;&lt;&lt;&lt;\n&#34;;
 		die;
@@ -251,2 +267,7 @@
 	return ${$_[0]};
 }
+
+sub txtdata
+{
+	return ${$_[0]};
+}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178053" href="/Public/Bug/Display.html?id=83170#txn-1178053">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;06&nbsp;14:09:32&nbsp;2013</span>
    <span class="description">jason [...] long.name -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178054" href="/Public/Bug/Display.html?id=83170#txn-1178054">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;06&nbsp;14:25:28&nbsp;2013</span>
    <span class="description">jason [...] long.name -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1178054/621434/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/621434">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 638b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Feb 06 13:55:51 2013, Mark.Martinec@ijs.si wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; &#40;as a side note: some packet inspecting firewalls may
&gt; choke on DNS UDP packets using EDNS0 with sizes beyond 512
&gt; bytes. Users of Mail::DKIM which do not use a local DNS
&gt; recursive server may suffer from Mail::DKIM turning on the
&gt; EDNS0 by default, so perhaps this choice should be reconsidered&#41;
</div>

Hmm.... yeah, if there are firewalls doing that then I would prefer to 
stick to the default setting &#40;off&#41;. You said Net::DNS will fall-back to 
using TCP if the 512-byte packet proves too small, right?

Thanks for the patch, I&#39;ve applied it to my local repository.


Jason
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178056" href="/Public/Bug/Display.html?id=83170#txn-1178056">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;06&nbsp;14:25:29&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178057" href="/Public/Bug/Display.html?id=83170#txn-1178057">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;06&nbsp;14:44:23&nbsp;2013</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark.Martinec [...] ijs.si</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1178057/621436/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/621436">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 966b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; some packet inspecting firewalls may
&gt; &gt; choke on DNS UDP packets using EDNS0 with sizes beyond 512
</div></div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hmm.... yeah, if there are firewalls doing that then I would prefer 
</div>to 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; stick to the default setting &#40;off&#41;. You said Net::DNS will fall-back 
</div>to 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; using TCP if the 512-byte packet proves too small, right?
</div>
Right. Better stick to a sure-fire default.

Perhaps a note in the documentation should state that when using
a local recursive DNS resolver, enabling packets larger than 512
bytes of UDP payload is beneficial and can avoid retries over TCP.
When there a firewall on a path to a DNS resolver the EDNS0 should
be tested before enabling &#40;packet inspection may reject DNS queries
larger than a historic default, or IP fragments may be blocked&#41;.
A sensible size may be 1240 bytes, which would avoid IP fragmentation
in most cases, while still benefiting from EDNS0.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for the patch, I&#39;ve applied it to my local repository.
</div>
Great, thanks a lot!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178113" href="/Public/Bug/Display.html?id=83170#txn-1178113">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;06&nbsp;17:04:30&nbsp;2013</span>
    <span class="description">jason [...] long.name -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1178113/621461/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/621461">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 260b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve posted a new developer release &#40;version 0.39_7&#41; to CPAN.

This release reverts the change that enabled EDNS0 by default.

Also, I&#39;ve now defined a couple subroutines for controlling the DNS resolver.
See the Mail::DKIM::DNS manual for the details.


Jason
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178260" href="/Public/Bug/Display.html?id=83170#txn-1178260">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;06&nbsp;21:16:29&nbsp;2013</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark.Martinec [...] ijs.si</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1178260/621552/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/621552">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1000b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve posted a new developer release &#40;version 0.39_7&#41; to CPAN.
&gt; This release reverts the change that enabled EDNS0 by default.
&gt; Also, I&#39;ve now defined a couple subroutines for controlling
&gt; the DNS resolver.
&gt; See the Mail::DKIM::DNS manual for the details.
</div>
Thanks, looks fine.

One has to test for Mail::DKIM-&gt;VERSION before calling
Mail::DKIM::DNS::resolver&#40;&#41;, the Mail::DKIM::DNS-&gt;can&#40;&#34;resolver&#34;&#41;
can&#39;t be used because old versions of Mail::DKIM did not have
a module Mail::DKIM::DNS.  But that&#39;s alright.

I noticed a small mistake of mine. Not sure about failure
modes in Net::DNS::Resolver-&gt;new &#40;possibly there are none&#41;,
but the following probably makes more sense:

--- DNS.pm~     2013-02-06 21:47:00.000000000 +0100
+++ DNS.pm      2013-02-07 03:12:34.000000000 +0100
@@ -110,3 +110,3 @@
                $RESOLVER = Net::DNS::Resolver-&gt;new&#40;&#41;;
-               $RESOLVER or die &#34;can&#39;t create DNS resolver: $@&#34;;
+               $RESOLVER or die &#34;can&#39;t create DNS resolver: $!&#34;;
        }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178523" href="/Public/Bug/Display.html?id=83170#txn-1178523">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;07&nbsp;15:36:12&nbsp;2013</span>
    <span class="description">jason [...] long.name -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1178523/621692/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/621692">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 480b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Version 0.40, containing this patch, is now on its way to CPAN. It should 
appear there within a few hours. I&#39;m going to mark this ticket resolved.


PS- Regarding the failure modes of Net::DNS::Resolver-&gt;new&#40;&#41;, I checked 
the source for that library and verified that the constructor will never 
return a non-object... i.e. it will either return a Net::DNS::Resolver or 
throw an error. So no need to worry about &#34;$!&#34; vs &#34;$@&#34; to report the 
error; neither will contain an error.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178525" href="/Public/Bug/Display.html?id=83170#txn-1178525">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;07&nbsp;15:36:13&nbsp;2013</span>
    <span class="description">jason [...] long.name -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.510717</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
