<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #17451 for HTML-Tidy: utf8 behavior with HTML::Tidy and clean&#40;&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #17451 for HTML-Tidy: utf8 behavior with HTML::Tidy and clean&#40;&#41;</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=HTML-Tidy">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=HTML-Tidy">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=HTML-Tidy">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=HTML-Tidy">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="http://github.com/petdance/html-tidy/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/HTML-Tidy">HTML-Tidy CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">17451</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=HTML-Tidy">HTML-Tidy</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bhirt [...] mobygames.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-16122-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-16123-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




HTML-Tidy-1.50-unicode.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/738159/381283/HTML-Tidy-1.50-unicode.patch">
Tue Feb 23 11:50:29 2010 (1.6k) by paul [...] city-fan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=17451">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-161923" href="/Public/Bug/Display.html?id=17451#txn-161923">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;02&nbsp;22:00:08&nbsp;2006</span>
    <span class="description">bhirt [...] mobygames.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Brian Hirt &lt;bhirt [...] mobygames.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> utf8 behavior with HTML::Tidy and clean&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 2 Feb 2006 19:47:31 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> andy [...] petdance.com</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Brian Hirt &lt;bhirt [...] mobygames.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/161923/50923/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/50923">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 994b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Andy,

I&#39;ve been using HTML::Tidy and it&#39;s working well.   I did run across  
something that seems like strange behavior with UTF8 string.  When  
you pass a UTF8 string into clean&#40;&#41;, clean&#40;&#41; returns a non-utf8  
string, the data is there in octets, but you have to manually decode  
the octets into a UTF8 string.  So basically my code ends up looking  
like this:

     my $tidy = HTML::Tidy-&gt;new&#40; { config_file =&gt; $tidyConf } &#41;;
     my $tidyClean = $tidy-&gt;clean&#40; $tidyCheck &#41;;
     $tidyClean = Encode::decode_utf8&#40;$tidyClean,Encode::FB_CROAK&#41;;


I didn&#39;t know if this is how the API is supposed to work, but it  
seems reasonable that if a UTF8 string is supplied to clean, one  
should be returned.    Requiring Encode would require perl 5.8.   
Currently your module supports perl 5.6.

Tidy.pm could easily be changed to have an extra line added &#40;around 258&#41;

     $cleaned = Encode::decode_utf8&#40;$cleaned,Encode::FB_CROAK&#41; if  
Encode::is_utf8&#40;$text&#41;;

Any thoughts or ideas?

--brian
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-161926" href="/Public/Bug/Display.html?id=17451#txn-161926">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;02&nbsp;22:03:15&nbsp;2006</span>
    <span class="description">andy [...] petdance.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17451] utf8 behavior with HTML::Tidy and clean&#40;&#41; </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 2 Feb 2006 19:02:13 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-HTML-Tidy [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Andy Lester &lt;andy [...] petdance.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/161926/50926/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/50926">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 348b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Tidy.pm could easily be changed to have an extra line added &#40;around  
&gt; 258&#41;
&gt;
&gt;      $cleaned = Encode::decode_utf8&#40;$cleaned,Encode::FB_CROAK&#41; if
&gt; Encode::is_utf8&#40;$text&#41;;
</div>
Sounds reasonable.  I&#39;m no utf8 guy, but I do need to revsiit  
HTML::Tidy some time soon.

xoa

--
Andy Lester =&gt; andy@petdance.com =&gt; www.petdance.com =&gt; AIM:petdance
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-161927" href="/Public/Bug/Display.html?id=17451#txn-161927">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;02&nbsp;22:03:16&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-221411" href="/Public/Bug/Display.html?id=17451#txn-221411">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;10&nbsp;20:09:08&nbsp;2006</span>
    <span class="description">mods [...] hank.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> moseley [...] hank.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/221411/90570/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/90570">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 323b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Andy,

I&#39;ve run into this problem, too, and I think this needs to be addresses.

One problem is that the tidy config can be used to re-encode the html,
so probably need some way to specify tidy&#39;s output encoding so that it
can be decoded correctly.  Can&#39;t depend on the input incoding to be the
same as the output encoding.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-433719" href="/Public/Bug/Display.html?id=17451#txn-433719">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;12&nbsp;10:27:08&nbsp;2008</span>
    <span class="description">cpan [...] tobias-tacke.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/433719/212348/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/212348">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 127b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This behavior is the same, if you use ISO-8859-1 for example. I put in 
ISO and get back UTF8 &#40;intern the utf-flag is changed&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-624201" href="/Public/Bug/Display.html?id=17451#txn-624201">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;25&nbsp;06:32:42&nbsp;2009</span>
    <span class="description">cpan [...] tobias-tacke.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/624201/317604/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/317604">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 131b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Another encoding problem: it seems to be, that Tidy wants ISO. If you 
put in UTF the result is corrupt &#40;unreadable higher chars&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-738159" href="/Public/Bug/Display.html?id=17451#txn-738159">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;23&nbsp;11:50:29&nbsp;2010</span>
    <span class="description">paul [...] city-fan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> paul [...] city-fan.org</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/738159/381282/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/381282">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Feb 02 22:00:08 2006, bhirt@mobygames.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve been using HTML::Tidy and it&#39;s working well.   I did run across  
&gt; something that seems like strange behavior with UTF8 string.  When  
&gt; you pass a UTF8 string into clean&#40;&#41;, clean&#40;&#41; returns a non-utf8  
&gt; string, the data is there in octets, but you have to manually decode  
&gt; the octets into a UTF8 string.  So basically my code ends up looking  
&gt; like this:
&gt; 
&gt;      my $tidy = HTML::Tidy-&gt;new&#40; { config_file =&gt; $tidyConf } &#41;;
&gt;      my $tidyClean = $tidy-&gt;clean&#40; $tidyCheck &#41;;
&gt;      $tidyClean = Encode::decode_utf8&#40;$tidyClean,Encode::FB_CROAK&#41;;
&gt; 
&gt; 
&gt; I didn&#39;t know if this is how the API is supposed to work, but it  
&gt; seems reasonable that if a UTF8 string is supplied to clean, one  
&gt; should be returned.    Requiring Encode would require perl 5.8.   
&gt; Currently your module supports perl 5.6.
&gt; 
&gt; Tidy.pm could easily be changed to have an extra line added &#40;around 258&#41;
&gt; 
&gt;      $cleaned = Encode::decode_utf8&#40;$cleaned,Encode::FB_CROAK&#41; if  
&gt; Encode::is_utf8&#40;$text&#41;;
</div>
HTML::Tidy 1.50 &#40;and probably some of the older releases&#41; actually
require perl 5.8.1 as they use utf8:is_utf8. Switching to
Encode::is_utf8 would help for users of 5.8.0.

Having built HTML::Tidy for a bunch of different Red Hat perl versions,
I found that the problem described in this ticket manifested itself as
test failures in t/unicode.t for perl versions &lt; 5.8.5. The attached
patch uses Brian&#39;s approach &#40;albeit patching the test rather than the
HTML::Tidy code itself&#41; to resolve the issue and gets the package
building for everything back to RHEL3 with perl 5.8.0, although I
resorted to skipping the unicode test in 5.8.0.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> HTML-Tidy-1.50-unicode.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/738159/381283/HTML-Tidy-1.50-unicode.patch">Download HTML-Tidy-1.50-unicode.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- HTML-Tidy-1.50/lib/HTML/Tidy.pm	2010-02-16 18:00:11.000000000 +0000
+++ HTML-Tidy-1.50/lib/HTML/Tidy.pm	2010-02-22 14:32:34.044482810 +0000
@@ -4,6 +4,7 @@
 use strict;
 use warnings;
 use Carp &#40;&#41;;
+use Encode;
 
 use HTML::Tidy::Message;
 
@@ -219,7 +220,7 @@
     }
     my $html = join&#40; &#39;&#39;, @_ &#41;;
 
-    utf8::encode&#40;$html&#41; unless utf8::is_utf8&#40;$html&#41;;
+    utf8::encode&#40;$html&#41; unless Encode::is_utf8&#40;$html&#41;;
     my &#40;$errorblock,$newline&#41; = _tidy_messages&#40; $html,
                                                 $self-&gt;{config_file},
                                                 $self-&gt;{tidy_options}
@@ -304,7 +305,7 @@
     }
     my $text = join&#40; &#39;&#39;, @_ &#41;;
 
-    utf8::encode&#40;$text&#41; unless utf8::is_utf8&#40;$text&#41;;
+    utf8::encode&#40;$text&#41; unless Encode::is_utf8&#40;$text&#41;;
     if &#40; defined $text &#41; {
         $text .= &#34;\n&#34;;
     }
--- HTML-Tidy-1.50/t/unicode.t	2010-02-16 15:48:40.000000000 +0000
+++ HTML-Tidy-1.50/t/unicode.t	2010-02-22 15:04:37.023464001 +0000
@@ -4,9 +4,14 @@
 
 use warnings;
 use strict;
-use Test::More tests =&gt; 7;
+use Encode;
+use Test::More;
 
+# utf8:is_utf8 only available from perl 5.8.1
 BEGIN {
+    plan skip_all =&gt; &#34;This test requires perl &gt;= 5.8.1&#34;
+        if $] &lt; 5.008001;
+    plan tests =&gt; 7;
     use_ok&#40; &#39;HTML::Tidy&#39; &#41;;
 }
 
@@ -29,6 +34,8 @@
 ok&#40;utf8::is_utf8&#40;$reference&#41;, &#39;reference is utf8&#39;&#41;;
 
 my $clean = $tidy-&gt;clean&#40; $html &#41;;
+# Need to manually reconvert to utf8 with perl &lt; 5.8.5 &#40;CPAN RT#17451&#41;
+$clean = Encode::decode_utf8&#40;$clean, Encode::FB_CROAK&#41; if $^V lt 5.8.5;
 ok&#40;utf8::is_utf8&#40;$clean&#41;, &#39;cleaned output is also unicode&#39;&#41;;
 
 $clean =~ s/&#34;HTML Tidy.+w3\.org&#34;/&#34;Tidy&#34;/;
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.481209</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
