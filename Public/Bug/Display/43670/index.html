<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #43670 for Net-FTPSSL: hang and busy loop if premature EOF while reading response</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #43670 for Net-FTPSSL: hang and busy loop if premature EOF while reading response</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-FTPSSL/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-FTPSSL/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-FTPSSL/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-FTPSSL/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-FTPSSL">Net-FTPSSL CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">43670</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-FTPSSL/Active/">Net-FTPSSL</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
agrow [...] iobound.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-22628-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.04</li>
<li>
0.05</li>
<li>
0.06</li>
<li>
0.07</li>
</ul>
    </td>
  </tr>
  <tr id="CF-22629-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.08    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;26&nbsp;12:13:58&nbsp;2009</span>
    <span class="description">agrow [...] thegotonerd.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> hang and busy loop if premature EOF while reading response</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Review the response sub -- if the read returns zero &#40;EOF&#41;, we just keep
looping.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;26&nbsp;17:30:54&nbsp;2009</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Alan,

I&#39;ll need some sample code &#38; the trace in order to reproduce the 
problem &#38; see what&#39;s happening.  Hopefully your FTP server isn&#39;t doing 
someting non-standard.  To turn on the trace, you&#39;ll need to 
add &#34;Debug =&gt; 1&#34; to your call to new&#40;&#41;.  That will cause the trace to 
write to STDERR.

You can either redirect STDERR to a file or modify your test program 
to just reopen STDERR to the file to dump to.  If it&#39;s ./t/10-
complex.t that&#39;s hanging, then just send me 
the ./t/test_trace_log_new.txt file that this test automatically 
generates.

Just be aware that you are to never call response&#40;&#41; yourself in your 
code.  That&#39;s an internal method &#38; calling it yourself will always 
hang your program.  So call last_message&#40;&#41; if you needed the response 
in your program.

Curtis
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;26&nbsp;17:30:55&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;26&nbsp;18:11:22&nbsp;2009</span>
    <span class="description">agrow [...] thegotonerd.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just consider what happens when an FTP server, for whatever reason,
decides to shutdown the socket before writing back a response. The
sysread below returns 0 but nothing handles this condition. To the
contrary, $data remains the empty string, and we keep on looping and
getting 0 from the sysread.


  while &#40;$sep eq &#34;-&#34;&#41; {
     my $read = sysread&#40; $self, $data, 4096&#41;;
     unless&#40; defined $read &#41; {
         $self-&gt;_croak_or_return &#40;0, &#34;Can&#39;t read ftps socket: $!&#34;&#41;;
         return &#40;$code&#41;;
     }
     ...
  }


On Thu Feb 26 17:30:54 2009, CLEACH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Alan,
&gt; 
&gt; I&#39;ll need some sample code &#38; the trace in order to reproduce the 
&gt; problem &#38; see what&#39;s happening.  Hopefully your FTP server isn&#39;t doing 
&gt; someting non-standard.  To turn on the trace, you&#39;ll need to 
&gt; add &#34;Debug =&gt; 1&#34; to your call to new&#40;&#41;.  That will cause the trace to 
&gt; write to STDERR.
&gt; 
&gt; You can either redirect STDERR to a file or modify your test program 
&gt; to just reopen STDERR to the file to dump to.  If it&#39;s ./t/10-
&gt; complex.t that&#39;s hanging, then just send me 
&gt; the ./t/test_trace_log_new.txt file that this test automatically 
&gt; generates.
&gt; 
&gt; Just be aware that you are to never call response&#40;&#41; yourself in your 
&gt; code.  That&#39;s an internal method &#38; calling it yourself will always 
&gt; hang your program.  So call last_message&#40;&#41; if you needed the response 
&gt; in your program.
&gt; 
&gt; Curtis
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;27&nbsp;12:12:12&nbsp;2009</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I believe that sysread&#40;&#41; is supposed to return undef in that case, not 
zero.  But since I can&#39;t reproduce what you are seeing, and I have no 
sample code with a trace or server to exploit it, please try out the 
following code change to see if it resolves your issue.  If it does, 
I&#39;ll make it part of v0.08 if it works for you &#38; doesn&#39;t hurt other 
servers I test against.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;   while &#40;$sep eq &#34;-&#34;&#41; {
&gt;      my $read = sysread&#40; $self, $data, 4096&#41;;
&gt;      # unless&#40; defined $read &#41; {
&gt;      unless&#40; $read &#41; {
&gt;          $self-&gt;_croak_or_return &#40;0, &#34;Can&#39;t read ftps socket: $!&#34;&#41;;
&gt;          return &#40;$code&#41;;
&gt;      }
</div>
With this change it will treat either undef or a value of zero as an 
error.  If it still hangs it means IO::Socket::SSL::sysread&#40;&#41; and 
Net::SSLeay::read&#40;&#41; are the culprits or how you wrote your code or you 
are working with a real flakey server.

If your FTP server regularly returns zero byte records before 
continuing with valid data, we&#39;ll have to look into another option for 
new&#40;&#41; to say after a specific # of sequential zero byte records to 
consider the connection hosed.  The default being to just ignore them 
like it does today if the new option isn&#39;t used.

Please let me know how your test goes with the above code change.  
Also please advise which FTPSSL method your program is calling when 
you hit this problem.  I can&#39;t really give you any more help without 
sample code &#38; it&#39;s trace or being able to connect to your server 
myself.  Since all you&#39;ve said is you&#39;ve found a bug, but not given me 
a way to trigger it.  Nor have you given me your environment &#38; version 
of Perl.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;27&nbsp;13:43:09&nbsp;2009</span>
    <span class="description">agrow [...] thegotonerd.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 27 12:12:12 2009, CLEACH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I believe that sysread&#40;&#41; is supposed to return undef in that case, not
</div>zero.

From perldoc -f sysread:

  &#34;Returns the number of bytes actually read, 0 at end of file, or undef
if there was an error &#40;in the latter case $! is also set&#41;.&#34;

Both 0 and undef are error cases, albeit different ones. In the
premature EOF case, $! will either not be set or will correspond to some
earlier error, so it&#39;s misleading to print it out if you just see EOF.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But since I can&#39;t reproduce what you are seeing, and I have no 
&gt; sample code with a trace or server to exploit it, please try out the 
&gt; following code change to see if it resolves your issue.  If it does, 
&gt; I&#39;ll make it part of v0.08 if it works for you &#38; doesn&#39;t hurt other 
&gt; servers I test against.
</div>
This should work with the above caveat about $!.

From the start, I probably should have mentioned that this bug was
actually encountered in the wild, and given you the patch I ended up
applying--basically your change except that the error cases are
distinguished.

Debug logging was on when this occurred and a PBSZ command had just been
issued. Not that it really matters...an FTP server could misbehave and
shutdown prematurely in response to any command, and the client should
report this error immediately.

To add a little bit more concrete evidence to the busy loop claim, I
decided to strace the process after noticing it was at 100% cpu usage.
Here&#39;s what I saw:

  $ strace -p 32082
  ...
  read&#40;3, &#34;&#34;..., 5&#41;                       = 0
  read&#40;3, &#34;&#34;..., 5&#41;                       = 0
  read&#40;3, &#34;&#34;..., 5&#41;                       = 0
  read&#40;3, &#34;&#34;..., 5&#41;                       = 0
  read&#40;3, &#34;&#34;..., 5&#41;                       = 0
  read&#40;3, &#34;&#34;..., 5&#41;                       = 0
  read&#40;3, &#34;&#34;..., 5&#41;                       = 0
  read&#40;3, &#34;&#34;..., 5&#41;                       = 0
  read&#40;3, &#34;&#34;..., 5&#41;                       = 0
  read&#40;3, &#34;&#34;..., 5&#41;                       = 0
  read&#40;3, &#34;&#34;..., 5&#41;                       = 0
  read&#40;3, &#34;&#34;..., 5&#41;                       = 0
  read&#40;3, &#34;&#34;..., 5&#41;                       = 0
  ...

  $ cd /proc/32082/fd/
  $ ls -l
  total 0
  lr-x------  1 user user 64 Feb 26 11:37 0 -&gt; pipe:[45840078]
  l-wx------  1 user user 64 Feb 26 11:37 1 -&gt; pipe:[11266942]
  l-wx------  1 user user 64 Feb 26 11:37 2 -&gt; pipe:[11266942]
  lrwx------  1 user user 64 Feb 26 11:37 3 -&gt; socket:[45840086]
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;02&nbsp;11:25:35&nbsp;2009</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for the details provided.  I have made the change in my base 
code to detect this error as a separate error condition and this fix 
will be included in v0.08.  I&#39;ll be closing this ticket once v0.08 
comes out.

In the mean time the full work arround is fairly simple in v0.07.  
Posted here again for everyone else to see since this same piece of 
code in response&#40;&#41; had another issue as well:
  while &#40;$sep eq &#34;-&#34;&#41; {
     my $read = sysread&#40; $self, $data, 4096&#41;;
     unless&#40; $read &#41; {
          # Not called as an object member in case $self not FTPSSL obj
          _croak_or_return &#40;$self, 0, &#40;defined $read&#41;
                       ? &#34;Can&#39;t read command channel socket: $!&#34;
                       : &#34;Unexpected EOF on command channel socket!&#34;&#41;;
         return &#40;$code&#41;;
     }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;03&nbsp;12:13:14&nbsp;2009</span>
    <span class="description">agrow [...] thegotonerd.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Great, thanks Curtis.

On Mon Mar 02 11:25:35 2009, CLEACH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thank you for the details provided.  I have made the change in my base 
&gt; code to detect this error as a separate error condition and this fix 
&gt; will be included in v0.08.  I&#39;ll be closing this ticket once v0.08 
&gt; comes out.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;23&nbsp;18:09:10&nbsp;2009</span>
    <span class="description">CLEACH [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;23&nbsp;18:09:10&nbsp;2009</span>
    <span class="description">CLEACH [...] cpan.org -  Fixed in 0.08 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
