<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #67015 for Net-SNMP: SNMPv3 authentication failures, but data gets retrieved</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #67015 for Net-SNMP: SNMPv3 authentication failures, but data gets retrieved</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-SNMP/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-SNMP/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-SNMP/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-SNMP/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SNMP">Net-SNMP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">67015</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">15 min

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-SNMP/Active/">Net-SNMP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">dtown [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
C.Arnold [...] le-mail.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-23238-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-23239-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;28&nbsp;04:50:52&nbsp;2011</span>
    <span class="description">C.Arnold [...] le-mail.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SNMPv3 authentication failures, but data gets retrieved</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 28 Mar 2011 10:50:39 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;&#39;bug-Net-SNMP [...] rt.cpan.org&#39;&#34; &lt;bug-Net-SNMP [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Arnold, Christian&#34; &lt;C.Arnold [...] le-mail.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi there,

I have installed Net::SNMP on my Ubuntu Linux box via CPAN, and I get an authentication failed message from two different type of machines when I use SNMPv3 to access data from them.

Net::SNMP is the latest version from CPAN &#40;v6.0.1&#41; on Perl 5.10.1 from Ubuntu 10.4 32bit
One type of machine is from Alcatel &#40;OmniStack switches&#41; and the other is from Funkwerk AG &#40;a media gateway and two WLAN bridges&#41;.
The thing is, that Net::SNMP successfully retrieves the data requested, but seems to try it in different ways. Also no auth failed messages are logged when using snmpget with AuthPriv from console &#40;v5.6.1&#41;, so it has to be the Perl module.

I hope you can help me, it took a while until I noticed that net-snmp &#40;snmpget, snmpwalk, ...&#41; and Net::SNMP are not the same, but net-snmp also has a SNMP perl module &#40;which is &#34;SNMP&#34;&#41;.

Regards
Christian
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;05&nbsp;14:12:58&nbsp;2011</span>
    <span class="description">dtown [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">5 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The Net::SNMP module uses the discovery process described in Section 4
of RFC 3414 when first communicating with a SNMPv3 agent.  In this
section, it is recommended that two distinct and intentionally invalid
messages be sent for discovery, if authentication is being used.  My
guess is that the second message being sent by the module is triggering
the &#34;authentication failures&#34;. 

== From RFC 3414 ==

The User-based Security Model requires that a discovery process obtains
sufficient information about other SNMP engines in order to communicate
with them. Discovery requires an non-authoritative SNMP engine to learn
the authoritative SNMP engine&#39;s snmpEngineID value before communication
may proceed. This may be accomplished by generating a Request message
with a securityLevel of noAuthNoPriv, a msgUserName of zero-length, a
msgAuthoritativeEngineID value of zero length, and the varBindList left
empty. The response to this message will be a Report message containing
the snmpEngineID of the authoritative SNMP engine as the value of the
msgAuthoritativeEngineID field within the msgSecurityParameters field.
It contains a Report PDU with the usmStatsUnknownEngineIDs counter in
the varBindList.

If authenticated communication is required, then the discovery process
should also establish time synchronization with the authoritative SNMP
engine. This may be accomplished by sending an authenticated Request
message with the value of msgAuthoritativeEngineID set to the newly
learned snmpEngineID and with the values of msgAuthoritativeEngineBoots
and msgAuthoritativeEngineTime set to zero. For an authenticated Request
message, a valid userName must be used in the msgUserName field. The
response to this authenticated message will be a Report message
containing the up to date values of the authoritative SNMP engine&#39;s
snmpEngineBoots and snmpEngineTime as the value of the
msgAuthoritativeEngineBoots and msgAuthoritativeEngineTime fields
respectively. It also contains the usmStatsNotInTimeWindows counter in
the varBindList of the Report PDU

====

I know that the &#40;UCD&#41; NET-SNMP utilities only sends the first message. 
I would like to keep the Net::SNMP module inline with RFC 3414, so it
sends both messages.

You can modify the module to only send the first message by overriding
the discovered&#40;&#41;
method in the Net::SNMP::Security::USM module.  Declare the following
after specifically loading the Net::SNMP::Security::USM module:

use Net::SNMP;
use Net::SNMP::Security::USM;

...

sub Net::SNMP::Security::USM::discovered
{
  my &#40;$this&#41; = @_;

  return $this-&gt;{_discovered};
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;05&nbsp;14:12:58&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;05&nbsp;14:12:59&nbsp;2011</span>
    <span class="description">dtown [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;05&nbsp;14:12:59&nbsp;2011</span>
    <span class="description">dtown [...] cpan.org -  Given to DTOWN</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;06&nbsp;02:26:56&nbsp;2011</span>
    <span class="description">C.Arnold [...] le-mail.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> AW: [rt.cpan.org #67015] SNMPv3 authentication failures, but data gets retrieved </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 6 Apr 2011 08:26:44 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;&#39;bug-Net-SNMP [...] rt.cpan.org&#39;&#34; &lt;bug-Net-SNMP [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Arnold, Christian&#34; &lt;C.Arnold [...] le-mail.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks David for your reply, but it isn&#39;t working correctly. If I put the lines you mentioned into my script, it returns:

Subroutine Net::SNMP::Security::USM::discovered redefined at ./iftraffic_test.pl line 80. 
$VAR1 = &#39;1.3.6.1.2.1.2.2.1.5.1000&#39;;
$VAR2 = &#39;1.3.6.1.2.1.2.2.1.8.1000&#39;;
$VAR3 = &#39;1.3.6.1.2.1.2.2.1.10.1000&#39;;
$VAR4 = &#39;1.3.6.1.2.1.2.2.1.16.1000&#39;;
Host: 10.176.201.129
SNMP version: 3
SNMPv2 community: public
WARNING: SNMP error: Received usmStatsNotInTimeWindows.0 Report-PDU with value 510

The general output is generated by the script, populated by $session-&gt;error which was triggered by

 if &#40; !defined&#40; $response = $session-&gt;get_request&#40;@snmpoids&#41; &#41; &#41; 

How fix this issue?

Secondly, the devices are still logging &#34;Authentication Failed&#34; messages.

Kind Regards
Christian
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;06&nbsp;02:26:57&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;13&nbsp;16:39:20&nbsp;2011</span>
    <span class="description">dtown [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">10 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">In order to eliminate the second message from being sent during the
SNMPv3 discovery/synchronization process you will have manually edit the
installed &#34;Net/SNMP/Security/USM.pm&#34; and add the following line of code
at line 461:

$this-&gt;_synchronize&#40;$msg_engine_boots, $msg_engine_time&#41;;


454   } else {
455
456      # Handle authoritativeEngineID discovery
457      if &#40;!defined $this-&gt;_engine_id_discovery&#40;$msg_engine_id&#41;&#41; {
458         return $this-&gt;_error&#40;&#41;;
459      }
460
461+     $this-&gt;_synchronize&#40;$msg_engine_boots, $msg_engine_time&#41;;
462
463   }


The line numbers apply to &#34;$Id: USM.pm,v 4.1 2010/09/10 00:01:22 dtown
Rel $&#34; packaged with Net-SNMP v6.0.1.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;14&nbsp;02:14:31&nbsp;2011</span>
    <span class="description">C.Arnold [...] le-mail.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> AW: [rt.cpan.org #67015] SNMPv3 authentication failures, but data gets retrieved </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 14 Apr 2011 08:09:52 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;&#39;bug-Net-SNMP [...] rt.cpan.org&#39;&#34; &lt;bug-Net-SNMP [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Arnold, Christian&#34; &lt;C.Arnold [...] le-mail.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks David, 

this at least works for devices of one manufacturer, the Alcatel switches are still logging authentication failures. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;08&nbsp;10:08:14&nbsp;2011</span>
    <span class="description">dtown [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The Net::SNMP module is following the discovery process described in RFC
3414.  A work around was provided to reduce the &#34;perceived&#34;
authentication failures by short circuiting part of the discovery process.

The vendor of the agent generating the authentication failures must be
contacted to determine the reason these errors are being logged. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;08&nbsp;10:08:15&nbsp;2011</span>
    <span class="description">dtown [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
