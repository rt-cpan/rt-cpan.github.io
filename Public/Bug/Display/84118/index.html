<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #84118 for future: I really beg you to take back the exception catching feature in Future 0.11</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #84118 for future: I really beg you to take back the exception catching feature in Future 0.11</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/future/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/future/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/future/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/future/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/future">future CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">84118</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/future/Active/">future</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
TOSHIOITO [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-13900-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.11    </td>
  </tr>
  <tr id="CF-13901-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;21&nbsp;08:36:07&nbsp;2013</span>
    <span class="description">TOSHIOITO [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> I really beg you to take back the exception catching feature in
 Future 0.11</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I really beg you to take back the new feature in Future 0.11, in which
exceptions are caught by Future in followed_by&#40;&#41;, and_then&#40;&#41; and
or_else&#40;&#41; callbacks.

This is because it can unintensionally hide critical errors and lead
to hard-to-solve bugs.

Suppose I use a function from someone&#39;s module.

    package Someones::Module;
    
    sub bad_func {
        die __PACKAGE__ . &#34;: something bad happened.&#34;;
    }

It is often the case that a function throws an exception in some cases.
And sometimes it is NOT EVEN DOCUMENTED.

Then, when I use it in Future&#39;s callback,

    package main;
    my $start = Future-&gt;new;
    $start-&gt;and_then&#40;sub {
        my &#40;$arg&#41; = shift-&gt;get;
        my $result = Someones::Module::bad_func&#40;$arg&#41;;
        print &#34;We get the result: $result&#34;;
        return Future-&gt;new-&gt;done&#40;$result&#41;;
    }&#41;;
    $start-&gt;done&#40;&#39;a&#39;&#41;;

with Future 0.11, the above code prints nothing. If I didn&#39;t read
Future&#39;s documentation from page to page, I would have no idea what&#39;s
going on.

The thrown exception lives in the sense that it makes the resulting
future fail. However, the failed future can be easily ignored unless
the user has explicit intension to check errors. I believe errors as
important as exceptions must be visible regardless of the user&#39;s
intension or carefulness.

Therefore, I really beg you to take back the exception catching
feature in Future 0.11.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;21&nbsp;09:23:24&nbsp;2013</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Mar 21 08:36:07 2013, TOSHIOITO wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Then, when I use it in Future&#39;s callback,
&gt; 
&gt;     package main;
&gt;     my $start = Future-&gt;new;
&gt;     $start-&gt;and_then&#40;sub {
&gt;         my &#40;$arg&#41; = shift-&gt;get;
&gt;         my $result = Someones::Module::bad_func&#40;$arg&#41;;
&gt;         print &#34;We get the result: $result&#34;;
&gt;         return Future-&gt;new-&gt;done&#40;$result&#41;;
&gt;     }&#41;;
&gt;     $start-&gt;done&#40;&#39;a&#39;&#41;;
&gt; 
&gt; with Future 0.11, the above code prints nothing. If I didn&#39;t read
&gt; Future&#39;s documentation from page to page, I would have no idea what&#39;s
&gt; going on.
</div>
I would say the trouble here is that you are using -&gt;and_then, which returns a Future, but calling it in void context and ignoring the Future it yields.

If you wanted to do that, you in fact want to use the -&gt;on_done method to attach a callback, because that version specifically /does not/ catch exceptions for this exact reason. Your code should read:

    my $start = Future-&gt;new;
    $start-&gt;on_done&#40;sub {
        my $arg = shift;
        my $result = Someones::Module::bad_func&#40;$arg&#41;;
        print &#34;We get the result: $result&#34;;
    }&#41;;
    $start-&gt;done&#40;&#39;a&#39;&#41;;

Now, if the bad_func&#40;&#41; throws an exception, this will not be caught and the exception will be propagated through to the  $start-&gt;done&#40;&#41;  call.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The thrown exception lives in the sense that it makes the resulting
&gt; future fail. However, the failed future can be easily ignored unless
&gt; the user has explicit intension to check errors. I believe errors as
&gt; important as exceptions must be visible regardless of the user&#39;s
&gt; intension or carefulness.
&gt; 
&gt; Therefore, I really beg you to take back the exception catching
&gt; feature in Future 0.11.
</div>
How about instead making the methods that return a Future give a warning if called in void context; which means that the Future would be ignored, including any failures that might come from it. That feels like it would also catch a bigger class of error that way.

Would that work better for you?

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;21&nbsp;09:23:25&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;21&nbsp;09:25:21&nbsp;2013</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Mar 21 09:23:24 2013, PEVANS wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; How about instead making the methods that return a Future give a
&gt;    warning if called in void context; which means that the Future
&gt;    would be ignored, including any failures that might come from it.
&gt;    That feels like it would also catch a bigger class of error that
&gt;    way.
</div>
I guess also this point could be clearer made in the docs, and pointing out that and_then/etc.. all catch exceptions; and that the on_done version doesn&#39;t. 

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;22&nbsp;07:14:46&nbsp;2013</span>
    <span class="description">TOSHIOITO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
I see your point. So the best practice is, &#40;1&#41; always call
on_{ready,done,fail} methods on leaf Futures, &#40;2&#41; don&#39;t ignore
Futures.

However, checking void context is not enough to detect whether the
Future is ignored. I suppose it&#39;s better to use DESTROY method just
like PERL_FUTURE_DEBUG option does.

I suggest when a failed Future is DESTROYed, it throw an exception if
the failure is not &#34;handled&#34;. We can determine whether a Future has
been handled or not by keeping track of method calls on it.

I think the above strategy is a good idea. If you are OK, I will try
to implement it as a subclass module &#40;like Future::Strict or something&#41;



On 2013-3月-21 木 09:25:21, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Mar 21 09:23:24 2013, PEVANS wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; How about instead making the methods that return a Future give a
&gt; &gt;    warning if called in void context; which means that the Future
&gt; &gt;    would be ignored, including any failures that might come from it.
&gt; &gt;    That feels like it would also catch a bigger class of error that
&gt; &gt;    way.
</div>&gt; 
&gt; I guess also this point could be clearer made in the docs, and
&gt; pointing out that and_then/etc.. all catch exceptions; and that the
&gt; on_done version doesn&#39;t.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;22&nbsp;12:19:57&nbsp;2013</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Mar 22 07:14:46 2013, TOSHIOITO wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I see your point. So the best practice is, &#40;1&#41; always call
&gt; on_{ready,done,fail} methods on leaf Futures, &#40;2&#41; don&#39;t ignore
&gt; Futures.
</div>
If you&#39;re not expecting to return another Future and use the returned Future from -&gt;and_then/etc.. then yes.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; However, checking void context is not enough to detect whether the
&gt; Future is ignored.
</div>
It&#39;s not an infallible solution but it should help quite a few of the common errors. It is of course still possible to save the Future to a variable then not do anything with it.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I suppose it&#39;s better to use DESTROY method just
&gt; like PERL_FUTURE_DEBUG option does.
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I suggest when a failed Future is DESTROYed, it throw an exception if
&gt; the failure is not &#34;handled&#34;. We can determine whether a Future has
&gt; been handled or not by keeping track of method calls on it.
</div>
Yes; that might be a useful idea. Since we&#39;re now catching exceptions and turning them into Future failures, we should probably alert to the fact that a Future was dropped with nothing handling its failure.

It should be careful though not to alert on the fact that a successful Future was dropped - it may be the case that the Future was executed simply for a side-effect of some kind, and losing its return value may not be a problem.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think the above strategy is a good idea. If you are OK, I will try
&gt; to implement it as a subclass module &#40;like Future::Strict or something&#41;
</div>
Hmm.. A ::Strict subclass sounds interesting, yes. Have a go at implementing that, but if it looks sufficiently useful it may be worth just putting that in the base Future class itself. Offhand I can&#39;t think of a great reason why not, but there may be complications as yet unforeseen.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;23&nbsp;09:30:26&nbsp;2013</span>
    <span class="description">TOSHIOITO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It should be careful though not to alert on the fact that a successful
&gt;    Future was dropped
</div>
Thank you for the advice. Yes, it is no problem to ignore successful Futures.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Offhand I
&gt;    can&#39;t think of a great reason why not, but there may be
&gt;    complications as yet unforeseen.
</div>
I agree. So the &#34;strict&#34; Future should be optional, even if it is incorporated into the base Future class.

I started writing Future::Strict at Github.

   <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/debug-ito/Future-Strict">https://github.com/debug-ito/Future-Strict</a></span>

The implementation is not gonna be complicated, I guess, but
it may take some time for me to write enough test cases.

Since my problem will be solved with Future::Strict, I closed
this ticket. Thank you for the valuable discussion.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;23&nbsp;09:30:27&nbsp;2013</span>
    <span class="description">TOSHIOITO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
