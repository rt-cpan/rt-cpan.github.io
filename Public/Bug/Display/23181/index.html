<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #23181 for POE: POE::Wheel::Run ref count problems</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #23181 for POE: POE::Wheel::Run ref count problems</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/POE/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/POE/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/POE/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/POE/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE">POE CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">23181</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/POE/Active/">POE</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
perl [...] pied.nu

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-26342-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.38    </td>
  </tr>
  <tr id="CF-26343-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.32    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;13&nbsp;16:27:17&nbsp;2006</span>
    <span class="description">perl [...] pied.nu -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> POE::Wheel::Run ref count problems</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">A session&#39;s ref count isn&#39;t maintained properly when using
POE::Wheel::Run.  I suspect it is being decremented 1 time to many in
the Wheel&#39;s DESTROY.

I&#39;ve tested this with multiple POE versions :

- 0.38
- 0.37
- 0.9500

Perl : 5.8.8, 5.8.6.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test-sub.t</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w
# $Id$

use strict;

sub POE::Kernel::TRACE_REFCNT &#40;&#41; { 0 }
sub POE::Kernel::ASSERT_DATA &#40;&#41; { 1 }

use POE;
use Data::Dumper;
use Test::More &#40; tests =&gt; 2 &#41;;

sub DEBUG &#40;&#41; { 0 }

SKIP: {

    eval &#39;use POE::API::Peek;&#39;;
    skip &#34;Must have POE::API::Peek installed&#34;, 2 if $@;

    my $object = Tester-&gt;spawn&#40; [qw&#40;client&#41;] &#41;;

    diag&#40; &#34;This test takes about 20 seconds&#34; &#41;;
    $poe_kernel-&gt;run&#40;&#41;;

    pass&#40; &#34;Everything exited&#34; &#41;;

    is&#40; $object-&gt;{refcnt}, 0, &#34;Session refcnt is zero to exit&#34; &#41;;

#    DEBUG and warn Dumper $object;
}


##########################################################################
package Tester;

use strict;
use POE;

use POE::Wheel::Run;

my&#40; $NODE, $SERVER, $CLIENT &#41;;

BEGIN { 
    *DEBUG = \&#38;main::DEBUG;
    $CLIENT = sub {
        use strict;
        $|++;

        print &#34;I am PID=$$\n&#34;;

        my $N=5;

        my $server = shift @_;

        while&#40; $N-- &#41; {
            sleep 1;
            print &#34;still here\n&#34;;
        }

    };
}

my $HAVE_DAEMON=0;
eval q{
    use POE::Component::Daemon;
    $HAVE_DAEMON=1;
};



sub spawn 
{
    my&#40; $package, $todo &#41; = @_;

    my $self = bless { STARTUP=&gt;$todo }, $package;

    $self-&gt;create_session;

    return $self;
}
sub create_session
{
    my&#40; $self &#41; = @_;

    POE::Session-&gt;create&#40;
        inline_states =&gt; {
            client_stdout =&gt; sub { $self-&gt;client_stdout&#40; @_[ARG0..$#_] &#41; },
            client_stderr =&gt; sub { $self-&gt;client_stderr&#40; @_[ARG0..$#_] &#41; },
            client_close  =&gt; sub { $self-&gt;client_close&#40; @_[ARG0..$#_] &#41; },
            
            error         =&gt; sub { $self-&gt;error&#40; @_[ARG0..$#_] &#41; },

            shutdown      =&gt; sub { $self-&gt;shutdown&#40; @_[ARG0..$#_] &#41; },
            _start        =&gt; sub { $self-&gt;start&#40; @_[ARG0..$#_] &#41; },
            _stop         =&gt; sub { $self-&gt;stop&#40; @_[ARG0..$#_] &#41; },
            do_next       =&gt; sub { $self-&gt;do_next&#40; @_[ARG0..$#_] &#41; },

            CHLD          =&gt; sub { $self-&gt;CHLD&#40; @_[ARG0..$#_] &#41; },

            USR2          =&gt; sub { Daemon-&gt;peek&#40; 1 &#41; if $HAVE_DAEMON; },

        }
    &#41;;
}

###################################################
sub start
{
    my&#40; $self &#41; = @_;

    if&#40; $HAVE_DAEMON &#41; {
        # ::diag&#40; &#34;$0 is $$&#34; &#41;;
        $poe_kernel-&gt;sig&#40; USR2 =&gt; &#39;USR2&#39; &#41;;
    }
    $poe_kernel-&gt;sig&#40; CHLD =&gt; &#39;CHLD&#39; &#41;;

    $poe_kernel-&gt;yield&#40; &#39;do_next&#39; &#41;;
}

###################################################
sub stop
{
    my&#40; $self &#41; = @_;
    
    my $api = POE::API::Peek-&gt;new&#40;&#41;;

    $self-&gt;{refcnt} = $api-&gt;get_session_refcount;

    DEBUG and warn &#34;Tester: STOP\n&#34;;
}

###################################################
sub do_next
{
    my&#40; $self &#41; = @_;

    my $next = shift @{ $self-&gt;{STARTUP} };
    unless&#40; $next &#41; {
        DEBUG and warn &#34;Tester: Startup completed\n&#34;;
        return;
    }
    $self-&gt;can&#40; $next &#41;-&gt;&#40; $self &#41;;
    $poe_kernel-&gt;delay&#40; &#39;do_next&#39;, 2 &#41;;
}

###################################################
# Spawn node-client, which will connect to ikc-node and wait for node-server
# Also spawn a second ikc-node, which connects to first and listens
sub client
{
    my&#40; $self &#41; = @_;

#    die &#34;No server PID???!&#34; unless $self-&gt;{server_PID};

    DEBUG and warn &#34;Tester: Launching client $self-&gt;{server_PID}\n&#34;;
#    $poe_kernel-&gt;refcount_increment&#40; $poe_kernel-&gt;get_active_session-&gt;ID, &#34;Wheel::Run bug&#34; &#41;;
    $self-&gt;{client_wheel} = POE::Wheel::Run-&gt;new&#40; 
        Program =&gt; $CLIENT,
        ProgramArgs =&gt; [ $self-&gt;{server_PID} ],
        ErrorEvent =&gt; &#39;error&#39;,
        CloseEvent =&gt; &#39;client_close&#39;,
        StdoutEvent =&gt; &#39;client_stdout&#39;,
        StderrEvent =&gt; &#39;client_stderr&#39;,
        Conduit    =&gt; &#39;socketpair&#39;
    &#41;;

    $self-&gt;{ PIDs }{ $self-&gt;{client_wheel}-&gt;PID } = 1;
}






######################################################
sub error
{
    my&#40; $self, $syscall, $errno, $errstr, $id, $handle &#41; = @_;

    return if $errno == 0;

    warn &#34;Error in wheel $id during $syscall: $errno &#40;$errstr&#41; handle=$handle\n&#34;;
}

######################################################
sub CHLD
{
    my&#40; $self, $signal, $PID, $status &#41; = @_;

    unless&#40; delete $self-&gt;{ PIDs }{ $PID } &#41; {
        warn &#34;CHLD for someone else: PID=$PID status=$status&#34;;
    }
    else {
        DEBUG and warn &#34;Tester: CHLD for $PID\n&#34;;
    }
}


######################################################
sub node_stdout
{
    my&#40; $self, $input, $wid &#41; = @_;

    DEBUG and 
        warn &#34;NODE: $input\n&#34;;
    if&#40; $input =~ /PID=&#40;\d+&#41;/ &#41; {
        $self-&gt;{node_PID} = $1;
        $self-&gt;child_pid&#40; $self-&gt;{node_PID} &#41;;
        END { kill 15, $self-&gt;{node_PID} if $self-&gt;{node_PID} };
    }
    else {
        push @{ $self-&gt;{node_output} }, $input;
    }
}

sub node_stderr
{
    my&#40; $self, $input, $wid &#41; = @_;

    # DEBUG and 
        warn &#34;NODE err: $input\n&#34;;
    push @{ $self-&gt;{node_error} }, $input;
}

sub node_close
{
    my&#40; $self, $wid &#41; = @_;

    DEBUG and warn &#34;NODE wheel: closed\n&#34;;
    delete $self-&gt;{node_wheel};
    $self-&gt;{node_close}++;
}


######################################################
sub node2_stdout
{
    my&#40; $self, $input, $wid &#41; = @_;

    DEBUG and warn &#34;NODE2: $input\n&#34;;
    if&#40; $input =~ /PID=&#40;\d+&#41;/ &#41; {
        $self-&gt;{node2_PID} = $1;
        $self-&gt;child_pid&#40; $self-&gt;{node2_PID} &#41;;
        END { kill 15, $self-&gt;{node2_PID} if $self-&gt;{node2_PID} };
    }
    else {
        push @{ $self-&gt;{node2_output} }, $input;
    }
}

sub node2_stderr
{
    my&#40; $self, $input, $wid &#41; = @_;

    DEBUG and warn &#34;NODE2 err: $input\n&#34;;
    if&#40; $input =~ /An address was in use/ &#41; {
        $self-&gt;{node2_in_use}++;   
    }
    else {
        push @{ $self-&gt;{node2_error} }, $input;
    }
}

sub node2_close
{
    my&#40; $self, $wid &#41; = @_;

    DEBUG and warn &#34;NODE2 wheel: closed\n&#34;;
    delete $self-&gt;{node2_wheel};
    $self-&gt;{node2_close}++;
}

######################################################
sub server_stdout
{
    my&#40; $self, $input, $wid &#41; = @_;

    DEBUG and warn &#34;SERVER: $input\n&#34;;

    if&#40; $input =~ /PID=&#40;\d+&#41;/ &#41; {
        $self-&gt;{server_PID} = $1;
        $self-&gt;child_pid&#40; $self-&gt;{server_PID} &#41;;
        END { kill 15, $self-&gt;{server_PID} if $self-&gt;{server_PID} };
    }
    elsif&#40; $input =~ /^I am &#40;[-.\w]+-[0-9a-f]+&#41;/ &#41; {
        $self-&gt;{server_ID} = $1;
    }
    elsif&#40; $input =~ /^Remote kernel &#40;?:alias &#41;?&#40;[-:.\w]+&#41; went HELLO!/ &#41; {
        $self-&gt;{server_connect}{$1}++;
    }
    elsif&#40; $input =~ m&#40;^Connected poe://&#40;Client\d+&#41;/me/pulse&#41; &#41; {
        $self-&gt;{client_connect}{$1}++;
    }
    elsif&#40; $input =~ /^&#40;Running server|Sending time|Done|Server exited&#41;.../ &#41; {
        $self-&gt;{$1}++;
    }
    elsif&#40; $input =~ m&#40;^poe://&#40;Client\d+&#41;/me/pulse -- &#41; &#41; {
        $self-&gt;{client_pulse}{$1}++;
    }
    elsif&#40; $input =~ /\S/ &#41; {
        push @{ $self-&gt;{server_output} }, $input;
    }
}

sub server_stderr
{
    my&#40; $self, $input, $wid &#41; = @_;

    if&#40; $input =~ /Not connected to proxy-node/ &#41; {
        die &#34;Race-condition in server! &#40;$input&#41;\n&#34;;
    }

    DEBUG and warn &#34;SERVER err: $input\n&#34;;
    push @{ $self-&gt;{server_error} }, $input;
}

sub server_close
{
    my&#40; $self, $wid &#41; = @_;
    DEBUG and warn &#34;SERVER wheel: close\n&#34;;
    delete $self-&gt;{server_wheel};
    $self-&gt;{server_close}++;
}

######################################################
sub client_stdout
{
    my&#40; $self, $input, $wid &#41; = @_;

    DEBUG and warn &#34;CLIENT: $input\n&#34;;

    if&#40; $input =~ /PID=&#40;\d+&#41;/ &#41; {
        $self-&gt;{client_PID} = $1;
        $self-&gt;child_pid&#40; $self-&gt;{client_PID} &#41;;
        END { kill 15, $self-&gt;{client_PID} if $self-&gt;{client_PID} };
    }
    elsif&#40; $input =~ /^I am &#40;[-.\w]+-[0-9a-f]+&#41;/ &#41; {
        $self-&gt;{client_ID} = $1;
    }
    elsif&#40; $input =~ /^\* connection to &#40;[-:.\w]+&#41;/ &#41; {
        $self-&gt;{client_connect}{$1}++;
    }
    elsif&#40; $input =~ m&#40;^\*\*\*\*\* Connected to &#40;Pulse&#41;&#41; &#41; {
        $self-&gt;{client_connect_Pulse}++;
    }
    elsif&#40; $input =~ m&#40;^\*\*\*\*\* Disconnected from &#40;Pulse&#41;&#41; &#41; {
        $self-&gt;{client_connect_Pulse}--;
    }
    elsif&#40; $input =~ m&#40;^HONK HONK&#41; &#41; {
        $self-&gt;{client_honk}++;
    }
    elsif&#40; $input =~ /^&#40;Running client|Creating sessions&#41;.../ &#41; {
        $self-&gt;{$1}++;
    }
    elsif&#40; $input =~ m&#40;Subscribed to HASH.+ on &#40;[-:.\w]+&#41;&#41; &#41; {
        $self-&gt;{client_subscribe}{$1}++;
    }
    elsif&#40; $input =~ m&#40;\|+ Foreign time is &#40;.+&#41;&#41; &#41; {
        $self-&gt;{client_time} = $1;
    }
    elsif&#40; $input =~ m&#40;[+|]+\* disconnection from Pulse&#41; &#41; {
        $self-&gt;{client_disconnect} = &#39;Pulse&#39;;
    }
    elsif&#40; $input =~ /\S/ &#41; {
        push @{ $self-&gt;{client_output} }, $input;
    }
}

sub client_stderr
{
    my&#40; $self, $input, $wid &#41; = @_;

    DEBUG and warn &#34;CLIENT err: $input\n&#34;;
    push @{ $self-&gt;{client_error} }, $input;
}

sub client_close
{
    my&#40; $self, $wid &#41; = @_;

    DEBUG and warn &#34;Tester: Client closed; All done&#34;;
    die &#34;NO node2_PID!!&#34; unless $self-&gt;{node2_PID};
    # POE now waits for all children to exit before exiting
    kill 15, $self-&gt;{node2_PID} if $self-&gt;{node2_PID};


    $self-&gt;{client_close}++;

    DEBUG and warn &#34;Tester: Client close: shutdown\n&#34;;

    if&#40; $HAVE_DAEMON &#41; {
        ::diag&#40; &#34;kill -USR2 $$ # to find out why this isn&#39;t exiting&#34; &#41;;
    }

    delete $self-&gt;{client_wheel};
    delete $self-&gt;{server_wheel};
    delete $self-&gt;{node_wheel};
    delete $self-&gt;{node2_wheel};

    die &#34;NO node_PID!!&#34; unless $self-&gt;{node_PID};
    # POE now waits for all children to exit before exiting
    kill 15, $self-&gt;{node_PID} if $self-&gt;{node_PID};
}

sub child_pid
{
    my&#40; $self, $pid &#41; = @_;
    return unless $pid;
    return unless $poe_kernel-&gt;can&#40; &#39;sig_child&#39; &#41;;
    $poe_kernel-&gt;sig_child&#40; $pid &#41;;
}


1;

__END__

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;16&nbsp;11:21:08&nbsp;2006</span>
    <span class="description">perl [...] pied.nu -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Turns out this had nothing to do with POE::Wheel::Run and everything to
do with me not using sig_child&#40;&#41; properly.  The included patch makes
sure sig_child&#40;&#41; can&#39;t be abused.  And includes a test case.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ruN POE-0.9500/lib/POE/Resource/Signals.pm POE-0.9500-PG/lib/POE/Resource/Signals.pm
--- POE-0.9500/lib/POE/Resource/Signals.pm	2006-09-16 01:34:11.000000000 -0400
+++ POE-0.9500-PG/lib/POE/Resource/Signals.pm	2006-11-16 11:16:36.000000000 -0500
@@ -276,6 +276,14 @@
 sub _data_sig_pid_watch {
   my &#40;$self, $session, $pid, $event&#41; = @_;
 
+  my $already = 0;
+
+  # had the session previously registered a PID watcher?
+  if&#40; $kr_pids_to_events{$pid}{$session} &#41; {
+    # don&#39;t increment refcount a second time
+    $already = 1;
+  }
+
   $kr_pids_to_events{$pid}{$session} = [
     $session, # PID_SESSION
     $event,   # PID_EVENT
@@ -284,28 +292,43 @@
   $self-&gt;_data_sig_signal_watch&#40;$session, &#34;CHLD&#34;&#41;;
 
   $kr_sessions_to_pids{$session}{$pid} = 1;
-  $self-&gt;_data_ses_refcount_inc&#40;$session&#41;;
+  $self-&gt;_data_ses_refcount_inc&#40;$session&#41; unless $already;
 }
 
 sub _data_sig_pid_ignore {
   my &#40;$self, $session, $pid&#41; = @_;
 
+  my $removed = 0;
+
   # Remove PID to event mapping.
 
-  delete $kr_pids_to_events{$pid}{$session};
-  delete $kr_pids_to_events{$pid} unless &#40;
-    keys %{$kr_pids_to_events{$pid}}
-  &#41;;
+  if&#40; delete $kr_pids_to_events{$pid}{$session} &#41; {
+    $removed++;
+    delete $kr_pids_to_events{$pid} unless &#40;
+      keys %{$kr_pids_to_events{$pid}}
+    &#41;;
+  }
 
   # Remove session to PID mapping.
 
-  delete $kr_sessions_to_pids{$session}{$pid};
-  unless &#40;keys %{$kr_sessions_to_pids{$session}}&#41; {
-    delete $kr_sessions_to_pids{$session};
-    $self-&gt;_data_sig_signal_ignore&#40;$session, &#34;CHLD&#34;&#41;;
+  if&#40; delete $kr_sessions_to_pids{$session}{$pid} &#41; {
+    $removed++;
+    unless &#40;keys %{$kr_sessions_to_pids{$session}}&#41; {
+      delete $kr_sessions_to_pids{$session};
+      $self-&gt;_data_sig_signal_ignore&#40;$session, &#34;CHLD&#34;&#41;;
+    }
+  }
+  if&#40; $removed &#41; {
+    $self-&gt;_data_ses_refcount_dec&#40;$session&#41;;
+    if&#40; ASSERT_DATA and $removed != 2 &#41; {
+      _trap&#40; &#34;&lt;dt&gt; $session/$pid was not present in both structures &#40;$removed&#41;&#34; &#41;;
+    }
+  } 
+  else {
+    if&#40; ASSERT_USAGE &#41; {
+       _carp&#40; &#34;&lt;us&gt; Trying to ignore a signal you never watched in the first place&#34; &#41;;
+    }
   }
-
-  $self-&gt;_data_ses_refcount_dec&#40;$session&#41;;
 }
 
 sub _data_sig_pids_ses {
diff -ruN POE-0.9500/t/90_regression/leolo_sig_child.t POE-0.9500-PG/t/90_regression/leolo_sig_child.t
--- POE-0.9500/t/90_regression/leolo_sig_child.t	1969-12-31 19:00:00.000000000 -0500
+++ POE-0.9500-PG/t/90_regression/leolo_sig_child.t	2006-11-16 11:11:38.000000000 -0500
@@ -0,0 +1,49 @@
+#!/usr/bin/perl -w
+# $Id$
+# Make sure that pid_child&#40; $pid &#41; w/o the pid_child&#40; $pid, $event
+# doesn&#39;t blow up in our face.
+
+use strict;
+
+# The next line is the entire point of this unit test; It will cause the
+# test to blow up because of the edge cases we trip below
+
+sub POE::Kernel::ASSERT_DATA &#40;&#41; { 1 }
+
+use POE;
+use Data::Dumper;
+use Test::More &#40; tests =&gt; 2 &#41;;
+
+sub DEBUG &#40;&#41; { 1 }
+
+POE::Session-&gt;create&#40;
+        inline_states =&gt; {
+            _start =&gt; sub {
+                    # Ignore an unwatched child.  Previously this
+                    # would cause a solitary refcount_dec
+                    $poe_kernel-&gt;sig_child&#40; 1234 &#41;; 
+                    $poe_kernel-&gt;yield&#40; &#39;work&#39; &#41;;
+                },
+            work =&gt; sub {
+                    # This is the proper way
+                    $poe_kernel-&gt;sig_child&#40; 1234, &#34;HONK&#34; &#41;;
+                    $poe_kernel-&gt;yield&#40; &#39;more&#39; &#41;;
+                },
+            more =&gt; sub {
+                    # Change a watcher.  Previously this would cause
+                    # a second refcount_inc&#40;&#41;
+                    $poe_kernel-&gt;sig_child&#40; 1234, &#34;HONK1&#34; &#41;;
+                    $poe_kernel-&gt;yield&#40; &#39;done&#39; &#41;;
+                },
+            done =&gt; sub {
+                    # Our refcount could be back to 0
+                    $poe_kernel-&gt;sig_child&#40; 1234 &#41;;
+                    pass&#40; &#34;done&#34; &#41;;
+                },
+            HONK  =&gt; sub { die &#34;Why did I get a SIGCHLD!&#34;; },
+            HONK1 =&gt; sub { die &#34;Why did I get a SIGCHLD!&#34;; },
+        }
+&#41;;
+
+$poe_kernel-&gt;run&#40;&#41;;
+pass&#40; &#34;Didn&#39;t blow up&#34; &#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;16&nbsp;12:26:05&nbsp;2006</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the problem description in IRC.  I&#39;ve added a much smaller
test case and fixed the underlying issue.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;16&nbsp;12:26:06&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;16&nbsp;12:26:07&nbsp;2006</span>
    <span class="description">RCAPUTO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
