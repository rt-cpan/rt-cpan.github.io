<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #29640 for Tk: Memory Issus with TK::Photo and -data option</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #29640 for Tk: Memory Issus with TK::Photo and -data option</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Tk/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Tk/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Tk/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Tk/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Tk">Tk CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">29640</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Tk/Active/">Tk</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
J.Steinblock [...] kesseboehmer.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-33610-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-33611-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;27&nbsp;05:35:08&nbsp;2007</span>
    <span class="description">J.Steinblock [...] kesseboehmer.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Memory Issus with TK::Photo and -data option</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 27 Sep 2007 11:32:00 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-Tk [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Steinblock, Juergen&#34; &lt;J.Steinblock [...] kesseboehmer.de&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

I think I found a bug in TK::Photo and at <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Dist/Tk/Active/">http://rt.cpan.org/Public/Bug/Report.html?Queue=Tk</a></span> bug reports could be send to this mail-adress.

I tried to write a TK app that show´s a slideshow of images.
Now I noticed that the memory usage increases about 1 mb every time I swap the images and tracked down the problem to TK::Photo with the &#34;-data&#34; option. All my efforts to free the memory didn´t work.


System:
- Windows XP SP2
- Perl 5.8.8
- TK 804.27.0.5


Error:
If I create a Photo Object with
$img = $mw-&gt;Photo&#40; &#39;image&#39;, -file =&gt; $imgfile&#41;
there is no memory leak.

But if I use this code
---------------------------
use GD::Image;
use MIME::Base64;
my %image_data;
...
$img = $mw-&gt;Photo&#40; &#39;image&#39;, -data =&gt; encode_base64&#40;resize_image&#40;$imgfile, 1024, 768&#41;&#41;&#41;;

sub resize_image {
    my $file = shift; my $x = shift; my $y = shift;
    if&#40;defined&#40;$image_data{$file}&#41;&#41; { return&#40;$image_data{$file}&#41;}
    my $image = GD::Image-&gt;new&#40;$file&#41;;
    my $image_resized = GD::Image-&gt;new&#40;$x, $y&#41;;
    $image_resized-&gt;copyResampled&#40;$image,0,0,0,0,$x,$y,$image-&gt;width,$image-&gt;height&#41;;
    $image_data{$file} = $image_resized-&gt;gif&#40;&#41;;
    return&#40;$image_data{$file}&#41;;
}
-------------------------
the memory increases.
The function resize_image has no leak, it´s stores every image in an hash-element, but I have only 10 images to swap and after the first full cycle no additional memory is used.




Mit freundlichen Grüßen

Jürgen Steinblock
Systemadministrator

Heinrich J. Kesseböhmer KG
Mindener Str. 208
49152 Bad Essen
Deutschland

Telefon:        +49 &#40;5742&#41; 46-1462
Fax:            +49 &#40;5742&#41; 4661462
E-Mail:         mailto:j.steinblock@kesseboehmer.de
Internet:       www.kesseboehmer.de




Here is a fully working example that doesn´t show the images in the TK-Window but reproduces the bug:
use Tk;
use GD::Image;
use MIME::Base64;

my %image_data;
my @images = &#40;&#34;0051520000_01.gif&#34;, &#34;0051520000_02.gif&#34;, &#34;0051520000_03.gif&#34;&#41;;
my $images_path = &#34;c:/temp/visu/&#34;;
my $images_count = 0;

my $mw = new MainWindow;
#~ my $imagit = $mw
    #~ -&gt;Label
    #~ -&gt;pack&#40; -expand =&gt; 1, -fill =&gt; &#39;both&#39;, &#41;;
#~ my $img2;
$mw-&gt;bind&#40; &#39;&lt;Left&gt;&#39;  =&gt; \&#38;prev_image &#41;;
$mw-&gt;bind&#40; &#39;&lt;Right&gt;&#39; =&gt; \&#38;next_image &#41;;
MainLoop;

sub next_image {
my $img = $mw-&gt;Photo&#40; &#39;image&#39;, -data =&gt; encode_base64&#40;resize_image&#40;$images_path . $images[$images_count], 1024, 768&#41;&#41;&#41;;

if&#40;$images_count == 2&#41; { $images_count = 0 }
else {$images_count++}
}

sub resize_image {
    my $file = shift; my $x = shift; my $y = shift;
    if&#40;defined&#40;$image_data{$file}&#41;&#41; { return&#40;$image_data{$file}&#41;}
    my $image = GD::Image-&gt;new&#40;$file&#41;;
    my $image_resized = GD::Image-&gt;new&#40;$x, $y&#41;;
    $image_resized-&gt;copyResampled&#40;$image,0,0,0,0,$x,$y,$image-&gt;width,$image-&gt;height&#41;;
    $image_data{$file} = $image_resized-&gt;gif&#40;&#41;;
    return&#40;$image_data{$file}&#41;;
}

************************************************
Heinrich J. Kesseböhmer KG
Mindener Str. 208
D-49152 Bad Essen
HR A 4013 Amtsgericht Osnabrück
USt-IdNr. DE206585880
Komplementär: Heinrich J. Kesseböhmer
************************************************
</div></div>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;04&nbsp;10:16:37&nbsp;2007</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Sep 27 05:35:08 2007, J.Steinblock@kesseboehmer.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello,
&gt; 
&gt; I think I found a bug in TK::Photo and at
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Dist/Tk/Active/">http://rt.cpan.org/Public/Bug/Report.html?Queue=Tk</a></span> bug reports could
&gt; be send to this mail-adress.
&gt; 
&gt; I tried to write a TK app that show´s a slideshow of images.
&gt; Now I noticed that the memory usage increases about 1 mb every time I
&gt; swap the images and tracked down the problem to TK::Photo with the &#34;-
&gt; data&#34; option. All my efforts to free the memory didn´t work.
&gt; 
&gt; 
&gt; System:
&gt; - Windows XP SP2
&gt; - Perl 5.8.8
&gt; - TK 804.27.0.5
&gt; 
&gt; 
&gt; Error:
&gt; If I create a Photo Object with
&gt; $img = $mw-&gt;Photo&#40; &#39;image&#39;, -file =&gt; $imgfile&#41;
&gt; there is no memory leak.
&gt; 
&gt; But if I use this code
&gt; ---------------------------
&gt; use GD::Image;
&gt; use MIME::Base64;
&gt; my %image_data;
&gt; ...
&gt; $img = $mw-&gt;Photo&#40; &#39;image&#39;, -data =&gt;
&gt; encode_base64&#40;resize_image&#40;$imgfile, 1024, 768&#41;&#41;&#41;;
&gt; 
&gt; sub resize_image {
&gt;     my $file = shift; my $x = shift; my $y = shift;
&gt;     if&#40;defined&#40;$image_data{$file}&#41;&#41; { return&#40;$image_data{$file}&#41;}
&gt;     my $image = GD::Image-&gt;new&#40;$file&#41;;
&gt;     my $image_resized = GD::Image-&gt;new&#40;$x, $y&#41;;
&gt;     $image_resized-&gt;copyResampled&#40;$image,0,0,0,0,$x,$y,$image-
<div class="message-stanza open">&gt; &gt;width,$image-&gt;height&#41;;
</div>&gt;     $image_data{$file} = $image_resized-&gt;gif&#40;&#41;;
&gt;     return&#40;$image_data{$file}&#41;;
&gt; }
&gt; -------------------------
&gt; the memory increases.
&gt; The function resize_image has no leak, it´s stores every image in an
&gt; hash-element, but I have only 10 images to swap and after the first
&gt; full cycle no additional memory is used.
&gt; 
</div>
Confirmed. It seems that the SV with the raw base64 data is stored
somewhere in the Perl/Tk interna and never freed. It also does not help
 not using the base64 encoded data, but raw gif data using the new
Tk804.027_50x. The only workaround for now seems to be the usage of
temporary files. Maybe it could also help to use the data&#40;&#41; method of
Tk::Photo.

Regards,
    Slaven
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;04&nbsp;10:16:40&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
