<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #47005 for DBIx-Class: txn_do should provide a way to disable retry</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #47005 for DBIx-Class: txn_do should provide a way to disable retry</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DBIx-Class">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DBIx-Class">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DBIx-Class">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DBIx-Class">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Class">DBIx-Class CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">47005</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DBIx-Class">DBIx-Class</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
TIMB [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10410-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10411-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=47005">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-619629" href="/Public/Bug/Display.html?id=47005#txn-619629">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;16&nbsp;10:10:18&nbsp;2009</span>
    <span class="description">TIMB [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> txn_do should provide a way to disable retry</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/619629/314992/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/314992">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 75b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">mst: right
mst: maybe we should allow a hashref of flags before the coderef
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-650546" href="/Public/Bug/Display.html?id=47005#txn-650546">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;20&nbsp;02:22:46&nbsp;2009</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/650546/333291/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/333291">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 53b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Stalling until Tim finds some time to get this going.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-650547" href="/Public/Bug/Display.html?id=47005#txn-650547">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;20&nbsp;02:22:47&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-650550" href="/Public/Bug/Display.html?id=47005#txn-650550">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;20&nbsp;02:22:48&nbsp;2009</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-674387" href="/Public/Bug/Display.html?id=47005#txn-674387">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;09&nbsp;04:06:07&nbsp;2009</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/674387/346859/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/346859">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 465b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jun 16 10:10:18 2009, TIMB wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; mst: right
&gt; mst: maybe we should allow a hashref of flags before the coderef
</div>
It looks like a good time to resurrect this issue - David Wheeler
factored out most of this code into DBIx::Connector[1] &#40;and soon DBIC
will switch over to it&#41;. As D::C provids *_do&#40;&#41; with the same semantics
as DBIC, this RT applies to it fully.

Thoughts?

[1]
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.justatheory.com/computers/programming/perl/modules/dbix-connector.html">http://www.justatheory.com/computers/programming/perl/modules/dbix-connector.html</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-674388" href="/Public/Bug/Display.html?id=47005#txn-674388">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;09&nbsp;04:06:08&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-674415" href="/Public/Bug/Display.html?id=47005#txn-674415">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;09&nbsp;04:51:42&nbsp;2009</span>
    <span class="description">Tim.Bunce [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> TIMB [...] cpan.org, &#34;David E. Wheeler&#34; &lt;david [...] kineticode.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #47005] txn_do should provide a way to disable retry</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 9 Oct 2009 09:51:15 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Peter Rabbitson via RT &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Bunce &lt;Tim.Bunce [...] pobox.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/674415/346865/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/346865">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On Fri, Oct 09, 2009 at 04:06:11AM -0400, Peter Rabbitson via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=47005">https://rt.cpan.org/Ticket/Display.html?id=47005</a></span> &gt;
&gt; 
&gt; On Tue Jun 16 10:10:18 2009, TIMB wrote:
<div class="message-stanza open">&gt; &gt; mst: right
&gt; &gt; mst: maybe we should allow a hashref of flags before the coderef
</div>&gt; 
&gt; It looks like a good time to resurrect this issue - David Wheeler
&gt; factored out most of this code into DBIx::Connector[1] &#40;and soon DBIC
&gt; will switch over to it&#41;. As D::C provids *_do&#40;&#41; with the same semantics
&gt; as DBIC, this RT applies to it fully.
&gt; 
&gt; Thoughts?
</div>
I don&#39;t think provides *_do&#40;&#41; with the same semantics as DBIC.
It looks like D::C doesn&#39;t offer automatic retry functionality.
&#40;I&#39;m happy about that.&#41;

I&#39;d also be happy if David adds support for retries so long as it&#39;s not
the default and the caller can provide the logic to decide if a retry
should be performed. That way the possibility of retries is explicit.

David, FYI this ticket relates to my observation that the automatic
retry performed by DBIC&#39;s *_do&#40;&#41; in some circumstances is dangerous.

It&#39;s dangerous because, to be safe, it requires the code to be
idempotent and that&#39;s a&#41; easier said than done for non trivial cases,
and b&#41; likely to be forgotten as the code is maintained over time.

Tim.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-674554" href="/Public/Bug/Display.html?id=47005#txn-674554">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;09&nbsp;11:17:53&nbsp;2009</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> david [...] kineticode.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/674554/346947/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/346947">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Oct 09 04:51:42 2009, Tim.Bunce@pobox.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; On Fri, Oct 09, 2009 at 04:06:11AM -0400, Peter Rabbitson via RT wrote:
<div class="message-stanza open">&gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=47005">https://rt.cpan.org/Ticket/Display.html?id=47005</a></span> &gt;
&gt; &gt; 
&gt; &gt; On Tue Jun 16 10:10:18 2009, TIMB wrote:
<div class="message-stanza open">&gt; &gt; &gt; mst: right
&gt; &gt; &gt; mst: maybe we should allow a hashref of flags before the coderef
</div>&gt; &gt; 
&gt; &gt; It looks like a good time to resurrect this issue - David Wheeler
&gt; &gt; factored out most of this code into DBIx::Connector[1] &#40;and soon DBIC
&gt; &gt; will switch over to it&#41;. As D::C provids *_do&#40;&#41; with the same semantics
&gt; &gt; as DBIC, this RT applies to it fully.
&gt; &gt; 
&gt; &gt; Thoughts?
</div>&gt; 
&gt; I don&#39;t think provides *_do&#40;&#41; with the same semantics as DBIC.
&gt; It looks like D::C doesn&#39;t offer automatic retry functionality.
&gt; &#40;I&#39;m happy about that.&#41;
&gt; 
&gt; I&#39;d also be happy if David adds support for retries so long as it&#39;s not
&gt; the default and the caller can provide the logic to decide if a retry
&gt; should be performed. That way the possibility of retries is explicit.
&gt; 
&gt; David, FYI this ticket relates to my observation that the automatic
&gt; retry performed by DBIC&#39;s *_do&#40;&#41; in some circumstances is dangerous.
&gt; 
&gt; It&#39;s dangerous because, to be safe, it requires the code to be
&gt; idempotent and that&#39;s a&#41; easier said than done for non trivial cases,
&gt; and b&#41; likely to be forgotten as the code is maintained over time.
&gt; 
&gt; Tim.
</div>

Well we can&#39;t both be right :&#41; Grep Connector.pm[1] for the string:
&#39;# Not connected. Try again.&#39;

[1]
<span class="clickylink"><a target="new" rel="nofollow" href="http://cpansearch.perl.org/src/DWHEELER/DBIx-Connector-0.12/lib/DBIx/Connector.pm">http://cpansearch.perl.org/src/DWHEELER/DBIx-Connector-0.12/lib/DBIx/Connector.pm</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-674596" href="/Public/Bug/Display.html?id=47005#txn-674596">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;09&nbsp;12:27:27&nbsp;2009</span>
    <span class="description">Tim.Bunce [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> TIMB [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #47005] txn_do should provide a way to disable retry</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 9 Oct 2009 17:26:58 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Peter Rabbitson via RT &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Bunce &lt;Tim.Bunce [...] pobox.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/674596/346969/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/346969">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 420b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Oct 09, 2009 at 11:17:54AM -0400, Peter Rabbitson via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Well we can&#39;t both be right :&#41; Grep Connector.pm[1] for the string:
&gt; &#39;# Not connected. Try again.&#39;
</div>
You&#39;re right. Don&#39;t know how I missed that. So yes, DBIx::Connector
should be extended to give the user control over this behaviour.

And I strongly believe automatic retries should be easy to enable, but
should not be enabled by default.

Tim.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-674599" href="/Public/Bug/Display.html?id=47005#txn-674599">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;09&nbsp;12:32:46&nbsp;2009</span>
    <span class="description">dwheeler [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/674599/346972/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/346972">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 450b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Oct 09 12:27:27 2009, Tim.Bunce@pobox.com wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You&#39;re right. Don&#39;t know how I missed that. So yes, DBIx::Connector
&gt; should be extended to give the user control over this behaviour.
&gt; 
&gt; And I strongly believe automatic retries should be easy to enable, but
&gt; should not be enabled by default.
</div>
I&#39;ve been thinking about this. I&#39;m not sure how to proceed, really, because if the retry is 
disabled, there is no point to do&#40;&#41;.

Best,

David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-674647" href="/Public/Bug/Display.html?id=47005#txn-674647">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;09&nbsp;15:50:09&nbsp;2009</span>
    <span class="description">Tim.Bunce [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> TIMB [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #47005] txn_do should provide a way to disable retry</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 9 Oct 2009 20:44:41 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> David Wheeler via RT &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Bunce &lt;Tim.Bunce [...] pobox.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/674647/346994/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/346994">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Oct 09, 2009 at 12:32:47PM -0400, David Wheeler via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=47005">https://rt.cpan.org/Ticket/Display.html?id=47005</a></span> &gt;
&gt; 
&gt; On Fri Oct 09 12:27:27 2009, Tim.Bunce@pobox.com wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; You&#39;re right. Don&#39;t know how I missed that. So yes, DBIx::Connector
&gt; &gt; should be extended to give the user control over this behaviour.
&gt; &gt; 
&gt; &gt; And I strongly believe automatic retries should be easy to enable, but
&gt; &gt; should not be enabled by default.
</div>&gt; 
&gt; I&#39;ve been thinking about this. I&#39;m not sure how to proceed, really, because if the retry is 
&gt; disabled, there is no point to do&#40;&#41;.
</div>
Some options that spring to mind:

- rename do&#40;&#41; to do_with_retry&#40;&#41; and txn_do&#40;&#41; to txn_do_with_retry&#40;&#41;
- add arguments to new&#40;&#41; to control retrying.

Random observations:

- Note that do&#40;&#41; and txn_do&#40;&#41; retry but svp_do&#40;&#41; doesn&#39;t, which is
reasonable in practical terms but inconsistent in naming terms.

- The docs say &#34;In the event of a failure **due** to a broken database
connection, C&lt;do&#40;&#41;&gt; will re-connect to the database and execute the code
reference a second time.&#34; &#40;my emphasis&#41; but should say &#34;In the event the
code throws an exception the code will be rexecuted if the database
handle is no longer connected.&#34; A subtle but significant difference.

- I&#39;d be very reluctant to rely on $dbh-&gt;{Active} as an indicator of
  connected-ness. $dbh-&gt;ping is the only guaranteed way.

Tim.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-674650" href="/Public/Bug/Display.html?id=47005#txn-674650">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;09&nbsp;15:53:01&nbsp;2009</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> TIMB [...] cpan.org, david [...] kineticode.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/674650/346997/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/346997">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Oct 09 12:32:46 2009, DWHEELER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Oct 09 12:27:27 2009, Tim.Bunce@pobox.com wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; You&#39;re right. Don&#39;t know how I missed that. So yes, DBIx::Connector
&gt; &gt; should be extended to give the user control over this behaviour.
&gt; &gt;
&gt; &gt; And I strongly believe automatic retries should be easy to enable,
</div>&gt; but
<div class="message-stanza open">&gt; &gt; should not be enabled by default.
</div>&gt; 
&gt; I&#39;ve been thinking about this. I&#39;m not sure how to proceed, really,
&gt; because if the retry is
&gt; disabled, there is no point to do&#40;&#41;.
&gt; 
</div>
This is not entirely true. _seems_connected&#40;&#41; is virtually free - you
can always call it before do/txn_do. This way do&#40;&#41; without retry makes
sense in forked environments - i.e. you reconnect before even calling
the coderef. In fact we did something similar in DBIC with _get_dbh
&#40;this is in fact the reason _seems_connected was factored out&#41;. For
txn_do&#40;&#41; the benefits are even broader, as you are most likely going to
use it for the nesting benefits, thus a single execution cycle can in
fact be much desired.

I side with Tim here - if it is not too late, making the auto-retry
non-default would be sound design. In DBIC we would still turn it on by
default but that&#39;s for backcompat reasons, which you &#40;yet&#41; don&#39;t have.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-674654" href="/Public/Bug/Display.html?id=47005#txn-674654">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;09&nbsp;15:54:39&nbsp;2009</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/674654/347001/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347001">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 340b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Oct 09 15:50:09 2009, Tim.Bunce@pobox.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;snip&gt;
&gt; - I&#39;d be very reluctant to rely on $dbh-&gt;{Active} as an indicator of
&gt;   connected-ness. $dbh-&gt;ping is the only guaranteed way.
&gt; 
</div>
This is a pre-ping stage. The current assumption is that if {Active} is
0, then ping&#40;&#41; can not possible succeed and is not even attempted.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-674669" href="/Public/Bug/Display.html?id=47005#txn-674669">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;09&nbsp;16:12:06&nbsp;2009</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/674669/347007/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347007">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 415b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Oct 09 15:54:39 2009, RIBASUSHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Oct 09 15:50:09 2009, Tim.Bunce@pobox.com wrote:
<div class="message-stanza open">&gt; &gt; &lt;snip&gt;
&gt; &gt; - I&#39;d be very reluctant to rely on $dbh-&gt;{Active} as an indicator of
&gt; &gt;   connected-ness. $dbh-&gt;ping is the only guaranteed way.
</div></div>                                 ^^^^^^^^^^^^^^^^^^^^^^
In fact if you look at the e.g. Oracle special handling of ping&#40;&#41; you&#39;ll
see that even this is not the case :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-674736" href="/Public/Bug/Display.html?id=47005#txn-674736">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;09&nbsp;18:13:19&nbsp;2009</span>
    <span class="description">Tim.Bunce [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> TIMB [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #47005] txn_do should provide a way to disable retry</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 9 Oct 2009 23:12:49 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Peter Rabbitson via RT &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Bunce &lt;Tim.Bunce [...] pobox.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/674736/347053/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347053">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 641b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Oct 09, 2009 at 04:12:09PM -0400, Peter Rabbitson via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=47005">https://rt.cpan.org/Ticket/Display.html?id=47005</a></span> &gt;
&gt; 
&gt; On Fri Oct 09 15:54:39 2009, RIBASUSHI wrote:
<div class="message-stanza open">&gt; &gt; On Fri Oct 09 15:50:09 2009, Tim.Bunce@pobox.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; &lt;snip&gt;
&gt; &gt; &gt; - I&#39;d be very reluctant to rely on $dbh-&gt;{Active} as an indicator of
&gt; &gt; &gt;   connected-ness. $dbh-&gt;ping is the only guaranteed way.
</div></div>&gt;                                  ^^^^^^^^^^^^^^^^^^^^^^
&gt; In fact if you look at the e.g. Oracle special handling of ping&#40;&#41; you&#39;ll
&gt; see that even this is not the case :&#41;
</div>
Umm, not even a comment in the code to explain why ping isn&#39;t used.

Tim.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-674739" href="/Public/Bug/Display.html?id=47005#txn-674739">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;09&nbsp;18:48:12&nbsp;2009</span>
    <span class="description">dwheeler [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> TIMB [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #47005] txn_do should provide a way to disable retry </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 9 Oct 2009 15:47:47 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David E. Wheeler&#34; &lt;dwheeler [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/674739/347056/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347056">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 938b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Oct 9, 2009, at 12:53 PM, Peter Rabbitson via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is not entirely true. _seems_connected&#40;&#41; is virtually free - you
&gt; can always call it before do/txn_do. This way do&#40;&#41; without retry makes
&gt; sense in forked environments - i.e. you reconnect before even calling
&gt; the coderef. In fact we did something similar in DBIC with _get_dbh
&gt; &#40;this is in fact the reason _seems_connected was factored out&#41;. For
&gt; txn_do&#40;&#41; the benefits are even broader, as you are most likely going  
&gt; to
&gt; use it for the nesting benefits, thus a single execution cycle can in
&gt; fact be much desired.
</div>
It seems to me that if do&#40;&#41; &#40;and txn_do&#40;&#41;&#41; aren&#39;t going to retry, then  
they have to ping&#40;&#41;, no?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I side with Tim here - if it is not too late, making the auto-retry
&gt; non-default would be sound design. In DBIC we would still turn it on  
&gt; by
&gt; default but that&#39;s for backcompat reasons, which you &#40;yet&#41; don&#39;t have.
</div>
I&#39;m on the fence.

David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-674780" href="/Public/Bug/Display.html?id=47005#txn-674780">#</a>      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;10&nbsp;05:14:51&nbsp;2009</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/674780/347086/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347086">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Oct 09 18:13:19 2009, Tim.Bunce@pobox.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri, Oct 09, 2009 at 04:12:09PM -0400, Peter Rabbitson via RT wrote:
<div class="message-stanza open">&gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=47005">https://rt.cpan.org/Ticket/Display.html?id=47005</a></span> &gt;
&gt; &gt; 
&gt; &gt; On Fri Oct 09 15:54:39 2009, RIBASUSHI wrote:
<div class="message-stanza open">&gt; &gt; &gt; On Fri Oct 09 15:50:09 2009, Tim.Bunce@pobox.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &lt;snip&gt;
&gt; &gt; &gt; &gt; - I&#39;d be very reluctant to rely on $dbh-&gt;{Active} as an indicator of
&gt; &gt; &gt; &gt;   connected-ness. $dbh-&gt;ping is the only guaranteed way.
</div></div>&gt; &gt;                                  ^^^^^^^^^^^^^^^^^^^^^^
&gt; &gt; In fact if you look at the e.g. Oracle special handling of ping&#40;&#41; you&#39;ll
&gt; &gt; see that even this is not the case :&#41;
</div>&gt; 
&gt; Umm, not even a comment in the code to explain why ping isn&#39;t used.
&gt; 
</div>
You are right, and I can&#39;t find the pertaining ML discussion. Basically
it came down to the fact that DBD::Oracle has some shutdown state in
which it will return 1 on ping as long as the socket is still open. This
however did not guarantee the server is any longer in a state to execute
queries. So what happened was:

1&#41; the weird state is reached
2&#41; a txn_do takes place and fails on the first sql command
3&#41; the code calls ping&#40;&#41; and gets a connected reply
4&#41; the txn_do is not retried
5&#41; ...
6&#41; users lose profit

P.S. I never used Oracle, I just remember what the deal was. No idea if
a bug was ever filed against the DBD or whatnot.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-674783" href="/Public/Bug/Display.html?id=47005#txn-674783">#</a>      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;10&nbsp;06:08:32&nbsp;2009</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/674783/347089/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347089">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Oct 09 18:48:12 2009, DWHEELER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Oct 9, 2009, at 12:53 PM, Peter Rabbitson via RT wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; This is not entirely true. _seems_connected&#40;&#41; is virtually free - you
&gt; &gt; can always call it before do/txn_do. This way do&#40;&#41; without retry makes
&gt; &gt; sense in forked environments - i.e. you reconnect before even calling
&gt; &gt; the coderef. In fact we did something similar in DBIC with _get_dbh
&gt; &gt; &#40;this is in fact the reason _seems_connected was factored out&#41;. For
&gt; &gt; txn_do&#40;&#41; the benefits are even broader, as you are most likely going  
&gt; &gt; to
&gt; &gt; use it for the nesting benefits, thus a single execution cycle can in
&gt; &gt; fact be much desired.
</div>&gt; 
&gt; It seems to me that if do&#40;&#41; &#40;and txn_do&#40;&#41;&#41; aren&#39;t going to retry, then  
&gt; they have to ping&#40;&#41;, no?
&gt; 
<div class="message-stanza open">&gt; &gt; I side with Tim here - if it is not too late, making the auto-retry
&gt; &gt; non-default would be sound design. In DBIC we would still turn it on  
&gt; &gt; by
&gt; &gt; default but that&#39;s for backcompat reasons, which you &#40;yet&#41; don&#39;t have.
</div>&gt; 
&gt; I&#39;m on the fence.
&gt; 
</div>
Ok,then more explanation is in order. Sorry I didn&#39;t bring this up
earlier, leaky memory :&#40; In fact I now realize that the API has a very
serious deficiency, which I will try to highlight below. Also I am not
trying to mock your module needlessly, I am just sharing all the
thoughts that came up once I opened this can of worms. Still I think all
of us can get out of this rather happier:

What does D::C provide? - a service that allows the user not to care how
did he get a specific $dbh. The two &#34;atomic parts&#34; that D::C uses are:

*&#41; Is said $dbh apparently usable &#40;let&#39;s call this AU&#41;. It checks:
  - is there a $dbh in the first place
  - is it still in the same fork/thread
  - has it been closed by the *user* &#40;{ACTIVE}&#41;

*&#41; Is said $dbh *guaranteed* to be usable, at least for the SQL
statement that immediately follows &#40;let&#39;s call this GU&#41;. Check is either
via ping&#40;&#41; or with some equivalent kludge.

Now, what potential users might expect:

1&#41; You want to run some non-persistent code. You want to connect only
if/when necessary, and want this to happen transparently, even if you
fork somewhere along the way. You do not expect transactions nor any
code-retries:

This can be achieved without using a coderef, but with writing code
directly around $conn. Nothing to see here.

2&#41; You want to do the same as 1&#41;, but your code will run for a while,
and there is a pretty good chance that the connection will timeout
somewhere along the way. This is where you need a wrapper around the
coderef - once an exception is thrown, it will run the GU code once, and
retry only if the result is negative. However we now brokesome behavior
of 1&#41; - if the coderef never needs the $dbh, we just wasted cycles
connecting. This would work if instead of $dbh, do&#40;&#41; would pass $conn as
its first attribute, or if you just used the coderef as a closure - e.g.:

my $res = $conn-&gt;do_with_retry &#40;sub { my $dbh = $conn-&gt;dbh; ... } &#41;;

This subtle difference allows the coderef to do whatever it wants,
including never calling -&gt;dbh&#40;&#41;. Which is a substantial saving.
Additionally every call to -&gt;dbh&#40;&#41; will run the AU code, and will
re-connect if the last cached $dbh is deemed useless &#40;i.e. a fork within
the do_with_retry&#40;&#41; coderef&#41;. Once an exception is caught a single GU
check taks place and the code is retried if the results are negative. 

3&#41; You want to do the same as 1&#41;, but want to write things in a
transaction. No retries expected. Here unlike with 1&#41; we need a wrapper
to issue the begin/commit statements. The concept is currently buggy in
both DBIC and D::C. Suppose your coderef forks. At this point nothing
protects the $dbh given to the user - he will just keep calling it,
across processes. If we in turn switch to dbh&#40;&#41; as a method call, we
will have the benefit of die&#40;&#41;ing right then an there, when it is
detected that the process which started the transaction and the current
one do in fact differ.

4&#41; You want to txn_do_with_retry&#40;&#41; - nothing special - again you run the
AU code on every call to dbh&#40;&#41;, an run the GU code as an indicator on
whether to retry. Any time AU detects a process change a non-retriable
exception is thrown, as the outermost transaction will no longer be atomic.

5&#41; &#40;bonus&#41; I can&#39;t find the ML post, but there was once a user who
wanted to do N retries per txn_do, not just 1. Granted it was a horrific
hack, but a txn_do_with_retry argument would make this possible :&#41;

To sum it up:

*&#41; Passing a bare $dbh to the coderefs is a pessimization - the coderef
may never need it.
*&#41; do&#40;&#41; without retries is not very useful, but can be added for claity
*&#41; do_with_retry&#40;&#41;, txn_do&#40;&#41;, and txn_do_with_retry&#40;&#41; each has its very
legitimate uses.

Sorry for the long write up :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675601" href="/Public/Bug/Display.html?id=47005#txn-675601">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;12&nbsp;15:04:27&nbsp;2009</span>
    <span class="description">dwheeler [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/675601/347529/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347529">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 305b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You are right, and I can&#39;t find the pertaining ML discussion. Basically
&gt; it came down to the fact that DBD::Oracle has some shutdown state in
&gt; which it will return 1 on ping as long as the socket is still open.
</div>
I just added this information as a comment in DBIx::Connection::Driver::Oracle.

â€”David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675609" href="/Public/Bug/Display.html?id=47005#txn-675609">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;12&nbsp;15:14:02&nbsp;2009</span>
    <span class="description">dwheeler [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/675609/347535/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347535">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">2&#41; Based on [this report]&#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/theory/dbix-connector/issues/#issue/4&#41;">http://github.com/theory/dbix-connector/issues/#issue/4&#41;</a></span>, I plan 
to change `dbh&#40;&#41;` so that it does not do the `ping&#40;&#41;` when called from within a `do*&#40;&#41;` 
block. I think that this will address your concern. For shits and giggles, I&#39;m also going to stick 
`$dbh` in `$_`, so that the blocks feel even more blockish. I&#39;m going to work on these 
changes today.

3&#41; The above-described change will help with this scenario too, as long as the user calls 
`$conn-&gt;dbh` for the situation you describe. But I still want to pass it in and assign it to 
`$_` for the simple cases, which I expect will be the most common. Does this make sense?

Anyone who `fork`s within a transaction sub is asking for trouble, though. It&#39;s just insane.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; *&#41; Passing a bare $dbh to the coderefs is a pessimization - the coderef
&gt; may never need it.
</div>
If the code ref never needs it, why would one call the blocks? They&#39;re specifically for 
accessing the database. What&#39;s the point otherwise?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; *&#41; do&#40;&#41; without retries is not very useful, but can be added for claity
</div>
Yes, the lack of utility was what I didn&#39;t like.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; *&#41; do_with_retry&#40;&#41;, txn_do&#40;&#41;, and txn_do_with_retry&#40;&#41; each has its very
&gt; legitimate uses.
</div>
Agreed. I&#39;m going to make some changes now and think on it. More later.

David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675612" href="/Public/Bug/Display.html?id=47005#txn-675612">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;12&nbsp;15:15:03&nbsp;2009</span>
    <span class="description">dwheeler [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/675612/347538/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347538">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 92b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Peter, can you re-assign this ticket to DBIx-Connector? I&#39;m unable to do so.

Thanks,

David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675655" href="/Public/Bug/Display.html?id=47005#txn-675655">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;12&nbsp;17:11:21&nbsp;2009</span>
    <span class="description">dwheeler [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/675655/347568/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347568">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 478b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Oct 09 15:50:09 2009, Tim.Bunce@pobox.com wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; - The docs say &#34;In the event of a failure **due** to a broken database
&gt; connection, C&lt;do&#40;&#41;&gt; will re-connect to the database and execute the
&gt; code
&gt; reference a second time.&#34; &#40;my emphasis&#41; but should say &#34;In the event
&gt; the
&gt; code throws an exception the code will be rexecuted if the database
&gt; handle is no longer connected.&#34; A subtle but significant difference.
</div>
Thanks Tim, I changed it to your wording.

â€”Theory
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675662" href="/Public/Bug/Display.html?id=47005#txn-675662">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;12&nbsp;18:18:34&nbsp;2009</span>
    <span class="description">dwheeler [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/675662/347573/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347573">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Reading this more carefully:

On Sat Oct 10 06:08:32 2009, RIBASUSHI wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2&#41; You want to do the same as 1&#41;, but your code will run for a while,
&gt; and there is a pretty good chance that the connection will timeout
&gt; somewhere along the way. This is where you need a wrapper around the
&gt; coderef - once an exception is thrown, it will run the GU code once, and
&gt; retry only if the result is negative. However we now brokesome behavior
&gt; of 1&#41; - if the coderef never needs the $dbh, we just wasted cycles
&gt; connecting. This would work if instead of $dbh, do&#40;&#41; would pass $conn as
&gt; its first attribute, or if you just used the coderef as a closure - e.g.:
&gt; 
&gt; my $res = $conn-&gt;do_with_retry &#40;sub { my $dbh = $conn-&gt;dbh; ... } &#41;;
&gt; 
&gt; This subtle difference allows the coderef to do whatever it wants,
&gt; including never calling -&gt;dbh&#40;&#41;. Which is a substantial saving.
</div>
I do not view this as the purpose of DBIx::Connector. If you have long-running code that 
doesn&#39;t touch the database, do *not* run it inside a `txn_do&#40;&#41;` or `do&#40;&#41;` block. Run it 
somewhere else.

Now, you might have long-running code that *does* touch the datbase that you want to run 
inside a transaction block. Perhaps you want to have an entire HTTP request run inside a 
transaction. But really, you should only do this if the work you&#39;re doing is fast -- or if it&#39;s 
mostly database-intensive &#40;and then only for updates&#41;. Otherwise, from a design POV, you 
should do your expensive computation before you enter the transaction. This will minimize 
the chance of deadlocks, as well.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Additionally every call to -&gt;dbh&#40;&#41; will run the AU code, and will
&gt; re-connect if the last cached $dbh is deemed useless &#40;i.e. a fork within
&gt; the do_with_retry&#40;&#41; coderef&#41;. Once an exception is caught a single GU
&gt; check taks place and the code is retried if the results are negative. 
</div>
With a commit I made today, if you only use `$conn-&gt;dbh` inside your blocks, you get that 
behavior. It&#39;s a choice.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 3&#41; You want to do the same as 1&#41;, but want to write things in a
&gt; transaction. No retries expected. Here unlike with 1&#41; we need a wrapper
&gt; to issue the begin/commit statements. The concept is currently buggy in
&gt; both DBIC and D::C. Suppose your coderef forks. At this point nothing
&gt; protects the $dbh given to the user - he will just keep calling it,
&gt; across processes. If we in turn switch to dbh&#40;&#41; as a method call, we
&gt; will have the benefit of die&#40;&#41;ing right then an there, when it is
&gt; detected that the process which started the transaction and the current
&gt; one do in fact differ.
</div>
This is assuming no retry?

Otherwise this too is dealt with in the commit I made today. Basically, if `dbh&#40;&#41;` is called 
from within a `do&#40;&#41;` or `txn_do&#40;&#41;` block, it won&#39;t `ping&#40;&#41;`, but will check for `fork`ing, 
threading, and the DBI `Active` flag.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 4&#41; You want to txn_do_with_retry&#40;&#41; - nothing special - again you run the
&gt; AU code on every call to dbh&#40;&#41;, an run the GU code as an indicator on
&gt; whether to retry. Any time AU detects a process change a non-retriable
&gt; exception is thrown, as the outermost transaction will no longer be atomic.
</div>
How is this different from 2&#41;?
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 5&#41; &#40;bonus&#41; I can&#39;t find the ML post, but there was once a user who
&gt; wanted to do N retries per txn_do, not just 1. Granted it was a horrific
&gt; hack, but a txn_do_with_retry argument would make this possible :&#41;
</div>
Yeah, not really interested in that, at least not until we get all the other kinks worked out.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; To sum it up:
&gt; 
&gt; *&#41; Passing a bare $dbh to the coderefs is a pessimization - the coderef
&gt; may never need it.
</div>
I reject this assertion. If it doesn&#39;t need it, don&#39;t use `txn_do&#40;&#41;`. If you think it may not need 
it becaus an exception will be thrown before it gets to using the database handle, well, in 
the vast majority of environments the database handle will be used sooner or later -- 
usually sooner. Maybe you don&#39;t need it on the current request, but you&#39;ll need it on the 
next request. So I don&#39;t view this as much of a loss.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; *&#41; do&#40;&#41; without retries is not very useful, but can be added for claity
</div>
Agreed.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; *&#41; do_with_retry&#40;&#41;, txn_do&#40;&#41;, and txn_do_with_retry&#40;&#41; each has its very
&gt; legitimate uses.
</div>
Yes, I can see that. 

So in addition to the changes I&#39;ve already made today, I&#39;m thinking of renaming `do&#40;&#41;` and 
`txn_do&#40;&#41;` to `do_with_retry&#40;&#41;` and `txn_with_retry&#40;&#41;` &#40;or something better, if I can think of 
it&#41;, and then add `do&#40;&#41;` and `txn_do&#40;&#41;` with no retries. This should address the primary 
issue, yes?

Best,

David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675665" href="/Public/Bug/Display.html?id=47005#txn-675665">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;12&nbsp;18:18:36&nbsp;2009</span>
    <span class="description">dwheeler [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/675665/347576/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347576">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Reading this more carefully:

On Sat Oct 10 06:08:32 2009, RIBASUSHI wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2&#41; You want to do the same as 1&#41;, but your code will run for a while,
&gt; and there is a pretty good chance that the connection will timeout
&gt; somewhere along the way. This is where you need a wrapper around the
&gt; coderef - once an exception is thrown, it will run the GU code once, and
&gt; retry only if the result is negative. However we now brokesome behavior
&gt; of 1&#41; - if the coderef never needs the $dbh, we just wasted cycles
&gt; connecting. This would work if instead of $dbh, do&#40;&#41; would pass $conn as
&gt; its first attribute, or if you just used the coderef as a closure - e.g.:
&gt; 
&gt; my $res = $conn-&gt;do_with_retry &#40;sub { my $dbh = $conn-&gt;dbh; ... } &#41;;
&gt; 
&gt; This subtle difference allows the coderef to do whatever it wants,
&gt; including never calling -&gt;dbh&#40;&#41;. Which is a substantial saving.
</div>
I do not view this as the purpose of DBIx::Connector. If you have long-running code that 
doesn&#39;t touch the database, do *not* run it inside a `txn_do&#40;&#41;` or `do&#40;&#41;` block. Run it 
somewhere else.

Now, you might have long-running code that *does* touch the datbase that you want to run 
inside a transaction block. Perhaps you want to have an entire HTTP request run inside a 
transaction. But really, you should only do this if the work you&#39;re doing is fast -- or if it&#39;s 
mostly database-intensive &#40;and then only for updates&#41;. Otherwise, from a design POV, you 
should do your expensive computation before you enter the transaction. This will minimize 
the chance of deadlocks, as well.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Additionally every call to -&gt;dbh&#40;&#41; will run the AU code, and will
&gt; re-connect if the last cached $dbh is deemed useless &#40;i.e. a fork within
&gt; the do_with_retry&#40;&#41; coderef&#41;. Once an exception is caught a single GU
&gt; check taks place and the code is retried if the results are negative. 
</div>
With a commit I made today, if you only use `$conn-&gt;dbh` inside your blocks, you get that 
behavior. It&#39;s a choice.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 3&#41; You want to do the same as 1&#41;, but want to write things in a
&gt; transaction. No retries expected. Here unlike with 1&#41; we need a wrapper
&gt; to issue the begin/commit statements. The concept is currently buggy in
&gt; both DBIC and D::C. Suppose your coderef forks. At this point nothing
&gt; protects the $dbh given to the user - he will just keep calling it,
&gt; across processes. If we in turn switch to dbh&#40;&#41; as a method call, we
&gt; will have the benefit of die&#40;&#41;ing right then an there, when it is
&gt; detected that the process which started the transaction and the current
&gt; one do in fact differ.
</div>
This is assuming no retry?

Otherwise this too is dealt with in the commit I made today. Basically, if `dbh&#40;&#41;` is called 
from within a `do&#40;&#41;` or `txn_do&#40;&#41;` block, it won&#39;t `ping&#40;&#41;`, but will check for `fork`ing, 
threading, and the DBI `Active` flag.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 4&#41; You want to txn_do_with_retry&#40;&#41; - nothing special - again you run the
&gt; AU code on every call to dbh&#40;&#41;, an run the GU code as an indicator on
&gt; whether to retry. Any time AU detects a process change a non-retriable
&gt; exception is thrown, as the outermost transaction will no longer be atomic.
</div>
How is this different from 2&#41;?
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 5&#41; &#40;bonus&#41; I can&#39;t find the ML post, but there was once a user who
&gt; wanted to do N retries per txn_do, not just 1. Granted it was a horrific
&gt; hack, but a txn_do_with_retry argument would make this possible :&#41;
</div>
Yeah, not really interested in that, at least not until we get all the other kinks worked out.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; To sum it up:
&gt; 
&gt; *&#41; Passing a bare $dbh to the coderefs is a pessimization - the coderef
&gt; may never need it.
</div>
I reject this assertion. If it doesn&#39;t need it, don&#39;t use `txn_do&#40;&#41;`. If you think it may not need 
it becaus an exception will be thrown before it gets to using the database handle, well, in 
the vast majority of environments the database handle will be used sooner or later -- 
usually sooner. Maybe you don&#39;t need it on the current request, but you&#39;ll need it on the 
next request. So I don&#39;t view this as much of a loss.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; *&#41; do&#40;&#41; without retries is not very useful, but can be added for claity
</div>
Agreed.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; *&#41; do_with_retry&#40;&#41;, txn_do&#40;&#41;, and txn_do_with_retry&#40;&#41; each has its very
&gt; legitimate uses.
</div>
Yes, I can see that. 

So in addition to the changes I&#39;ve already made today, I&#39;m thinking of renaming `do&#40;&#41;` and 
`txn_do&#40;&#41;` to `do_with_retry&#40;&#41;` and `txn_with_retry&#40;&#41;` &#40;or something better, if I can think of 
it&#41;, and then add `do&#40;&#41;` and `txn_do&#40;&#41;` with no retries. This should address the primary 
issue, yes?

Best,

David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675696" href="/Public/Bug/Display.html?id=47005#txn-675696">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;12&nbsp;20:23:12&nbsp;2009</span>
    <span class="description">dwheeler [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/675696/347591/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347591">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 883b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Trying to come up with better names than the awful do_with_retry&#40;&#41; and txn_do_with_retry&#40;&#41;. 
The best I&#39;ve seen so far is this, suggested by ribasushi:

do&#40;&#41;
redo&#40;&#41;
txn_do&#40;&#41;
txn_redo&#40;&#41;

I like that these are simple, but if I was reading code and wasn&#39;t familiar with with 
DBIx::Connector, I would think that redo&#40;&#41; was trying to redo something, not to do 
something and then redo in the case of a specific failure.

I was also looking for another term to use than &#34;do&#34;, in response to the complaint 
[here]&#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/theory/dbix-connector/issues#issue/3&#41;">http://github.com/theory/dbix-connector/issues#issue/3&#41;</a></span>. The best I can come up 
with is &#34;run&#34;, in which case we have:

run&#40;&#41;
rerun&#40;&#41;
txn_run&#40;&#41;
txn_rerun&#40;&#41;

The use of &#34;run&#34; is okay, though not as good as do&#40;&#41;. But at least it would remove the 
confusion vis-a-vis DBI&#39;s do&#40;&#41; method. But it suffers from the same problem as redo&#40;&#41;.

Thoughts? Any other ideas?

Thanks,

David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675731" href="/Public/Bug/Display.html?id=47005#txn-675731">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;12&nbsp;23:10:50&nbsp;2009</span>
    <span class="description">dwheeler [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/675731/347611/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347611">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 592b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Oct 12 20:23:12 2009, DWHEELER wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The use of &#34;run&#34; is okay, though not as good as do&#40;&#41;. But at least it
&gt; would remove the
&gt; confusion vis-a-vis DBI&#39;s do&#40;&#41; method. But it suffers from the same
&gt; problem as redo&#40;&#41;.
&gt; 
&gt; Thoughts? Any other ideas?
</div>
Now leaning towards

run
runup
txn_run
txn_runup
svp_run

The &#34;runup&#34; versions will assume that the connection is up, unless there&#39;s a failure, and 
then it will check the connection and re-up it if necessary. And yes, I think I&#39;ll pass the 
connection object &#40;and put it into $_&#41; rather than the $dbh. Maybe.

Thoughts?

â€”Theory
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675753" href="/Public/Bug/Display.html?id=47005#txn-675753">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;13&nbsp;01:44:28&nbsp;2009</span>
    <span class="description">dwheeler [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/675753/347624/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347624">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 493b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Oct 12 23:10:50 2009, DWHEELER wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Now leaning towards
&gt; 
&gt; run
&gt; runup
&gt; txn_run
&gt; txn_runup
&gt; svp_run
</div>
I&#39;ve committed this change [here]&#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/theory/dbix-">http://github.com/theory/dbix-</a></span>
connector/commit/faa1f8df4330bb738b1532b6e97a678378974d87&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think I&#39;ll pass the
&gt; connection object &#40;and put it into $_&#41; rather than the $dbh. Maybe.
</div>
I&#39;ve not done this, yet. Still working out whether I want to or not. At any rate, please do 
holler if you think of better method names than these.

David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675756" href="/Public/Bug/Display.html?id=47005#txn-675756">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;13&nbsp;01:55:29&nbsp;2009</span>
    <span class="description">dwheeler [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/675756/347627/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347627">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 314b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Oct 13 01:44:28 2009, DWHEELER wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve not done this, yet. Still working out whether I want to or not.
</div>
I don&#39;t think I will, because otherwise how can you start the transaction in `txn_run&#40;&#41;` or 
`txn_runup&#40;&#41;` without first getting the database handle and issuing a `BEGIN`? You can&#39;t.

Best,

David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675955" href="/Public/Bug/Display.html?id=47005#txn-675955">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;13&nbsp;09:49:10&nbsp;2009</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/675955/347713/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347713">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 771b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Oct 13 01:55:29 2009, DWHEELER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Oct 13 01:44:28 2009, DWHEELER wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; I&#39;ve not done this, yet. Still working out whether I want to or not.
</div>&gt; 
&gt; I don&#39;t think I will, because otherwise how can you start the
&gt; transaction in `txn_run&#40;&#41;` or
&gt; `txn_runup&#40;&#41;` without first getting the database handle and issuing a
&gt; `BEGIN`? You can&#39;t.
&gt; 
</div>
Duh. This is what I get when commenting without thinking. Of course you
are totally right, and this is what DBIC does as well. I just got
mindlocked in my perfect universe. Sorry for the ensuing confusion.

At least we got better names, I like runup. It also yields itself to
runup &#40;$upto_num_retries...&#41;

I will look over the final code probably this weekend, will holler if I
spot something else.

Cheers
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-676033" href="/Public/Bug/Display.html?id=47005#txn-676033">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;13&nbsp;10:52:50&nbsp;2009</span>
    <span class="description">dwheeler [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/676033/347765/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347765">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 370b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Oct 13 01:44:28 2009, DWHEELER wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; At any rate, please do
&gt; holler if you think of better method names than these.
</div>
Now I&#39;m thinking

run&#40;&#41;
rerun&#40;&#41;
txn_run&#40;&#41;
txn_rerun&#40;&#41;
svp_run&#40;&#41;

It has the same issue as do/redo, but it seems a little more emphatic, more casual to me, like 
a television rerun. It also makes a bit more sense than runup. Thoughts?

David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-676082" href="/Public/Bug/Display.html?id=47005#txn-676082">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;13&nbsp;11:17:10&nbsp;2009</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/676082/347792/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347792">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 528b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Oct 13 07:52:50 2009, DWHEELER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Oct 13 01:44:28 2009, DWHEELER wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; At any rate, please do
&gt; &gt; holler if you think of better method names than these.
</div>&gt; 
&gt; Now I&#39;m thinking
&gt; 
&gt; run&#40;&#41;
&gt; rerun&#40;&#41;
&gt; txn_run&#40;&#41;
&gt; txn_rerun&#40;&#41;
&gt; svp_run&#40;&#41;
&gt; 
&gt; It has the same issue as do/redo, but it seems a little more emphatic,
&gt; more casual to me, like
&gt; a television rerun. It also makes a bit more sense than runup.
&gt; Thoughts?
</div>
I like *run best so far. It implies a coderef to be run and implies
redo... I like it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-806842" href="/Public/Bug/Display.html?id=47005#txn-806842">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;20&nbsp;13:22:21&nbsp;2010</span>
    <span class="description">dwheeler [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> Tim.Bunce [...] pobox.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/806842/418334/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/418334">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 903b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">So I think that this issue is resolved. But should a bug be opened against DBD::Oracle so that 
there&#39;s a chance for them to fix their ping&#40;&#41; issue? Based on Peter&#39;s explanation, I have this 
comment in DBIx::Connector::Driver::Oracle:

# Note from <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=47005">https://rt.cpan.org/Ticket/Display.html?id=47005</a></span>:
# DBD::Oracle has some shutdown state in which it will return 1 on ping as
# long as the socket is still open. This however did not guarantee the server
# is any longer in a state to execute queries. So what happened was:
#
# 1&#41; the weird state is reached
# 2&#41; a txn_do takes place and fails on the first sql command
# 3&#41; the code calls ping&#40;&#41; and gets a connected reply
# 4&#41; the txn_do is not retried
# 5&#41; ...
# 6&#41; users lose profit

Peter, is that right? If so, should it not be reported?

Otherwise, I think that this issue is resolved, at least as far as DBIx::Connector is concerned.

Thanks,

David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-808055" href="/Public/Bug/Display.html?id=47005#txn-808055">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;23&nbsp;09:38:04&nbsp;2010</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/808055/418897/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/418897">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jul 20 13:22:21 2010, DWHEELER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So I think that this issue is resolved. But should a bug be opened
&gt; against DBD::Oracle so that
&gt; there&#39;s a chance for them to fix their ping&#40;&#41; issue? Based on Peter&#39;s
&gt; explanation, I have this
&gt; comment in DBIx::Connector::Driver::Oracle:
&gt; 
&gt; # Note from <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=47005">https://rt.cpan.org/Ticket/Display.html?id=47005</a></span>:
&gt; # DBD::Oracle has some shutdown state in which it will return 1 on
&gt; ping as
&gt; # long as the socket is still open. This however did not guarantee the
&gt; server
&gt; # is any longer in a state to execute queries. So what happened was:
&gt; #
&gt; # 1&#41; the weird state is reached
&gt; # 2&#41; a txn_do takes place and fails on the first sql command
&gt; # 3&#41; the code calls ping&#40;&#41; and gets a connected reply
&gt; # 4&#41; the txn_do is not retried
&gt; # 5&#41; ...
&gt; # 6&#41; users lose profit
&gt; 
&gt; Peter, is that right? If so, should it not be reported?
</div>
It probably has been reported, if it hasn&#39;t - it totally should be.
DBIC&#39;s philosophy so far has been to get a quick and reliable fix into
the storage overlays, and have the specific user bug the DBD::
maintainer if he wants it fixed for the general case.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Otherwise, I think that this issue is resolved, at least as far as
&gt; DBIx::Connector is concerned.
&gt; 
</div>
Right... but this is a DBIx::Class bug, which does not use D::C yet &#40;and
may not be able to, but I have not really assessed this to claim either
way&#41;. Besides disabling automatic reconnection is something we *do* want
in dbic regardless of underlying connector mechanism.

So bug remains open, tuits remain scarce :&#40;
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 1.058948</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
