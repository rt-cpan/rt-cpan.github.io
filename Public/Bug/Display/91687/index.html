<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #91687 for Test-Trap: Wrong exit code after die</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #91687 for Test-Trap: Wrong exit code after die</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Test-Trap/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Test-Trap/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Test-Trap/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Test-Trap/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Test-Trap">Test-Trap CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">91687</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Test-Trap/Active/">Test-Trap</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
zurom [...] mail.ru

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-40950-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-40951-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;27&nbsp;07:06:01&nbsp;2013</span>
    <span class="description">http://zurom.id.mail.ru/ -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Wrong exit code after die</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This prints &#39;undef&#39; instead of 255

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; perl -MTest::Trap -e &#39;trap{ die &#34;aa&#34; }; print $trap-&gt;exit // &#34;undef&#34;&#39;
</div>undef

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; echo $?
</div>0

But ..
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; perl -e &#39;die &#34;aa&#34;&#39;
&gt; echo $?
</div>255
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;27&nbsp;12:06:27&nbsp;2013</span>
    <span class="description">sidhekin [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #91687] Wrong exit code after die</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 27 Dec 2013 18:06:18 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Test-Trap [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> The Sidhekin &lt;sidhekin [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Dec 27, 2013 at 1:06 PM, <span class="clickylink"><a target="new" rel="nofollow" href="http://zurom.id.mail.ru/">http://zurom.id.mail.ru/</a></span> via RT &lt;
bug-Test-Trap@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This prints &#39;undef&#39; instead of 255
&gt;
<div class="message-stanza open">&gt; &gt; perl -MTest::Trap -e &#39;trap{ die &#34;aa&#34; }; print $trap-&gt;exit // &#34;undef&#34;&#39;
</div>&gt; undef
&gt;
<div class="message-stanza open">&gt; &gt; echo $?
</div>&gt; 0
&gt;
</div>
  It&#39;s supposed to, and documented to: &#34;Any property will be undef if not
actually trapped&#34; and, for the C&lt;exit&gt; accessor: &#34;The exit code, if the
latest trap tried to exit.&#34;

  C&lt;die&#40;&#41;&gt; is not C&lt;exit&#40;&#41;&gt;: It throws an exception, and only an uncaught
exception will cause an exit, from the outermost scope.  C&lt;trap {}&gt;, like
C&lt;eval {}&gt;, by default traps the exception, so it doesn&#39;t go uncaught.
&#40;And even if you&#39;re using a custom C&lt;trap {}&gt; that does not capture
exceptions, the exception will just propagate out of the C&lt;trap {}&gt; and
cause an exit from the outermost scope; the C&lt;trap {}&gt; will in that case
never return.&#41;


But ..
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; perl -e &#39;die &#34;aa&#34;&#39;
&gt; &gt; echo $?
</div>&gt; 255
&gt;
</div>
  C&lt;trap {}&gt; is an analogue to C&lt;eval {}&gt;, so the comparison should not be
with a bare C&lt;die&#40;&#41;&gt;, but one inside an C&lt;eval{}&gt;:

$ perl -e &#39;eval { die &#34;aa&#34; }&#39;
$ echo $?
0


  I think I&#39;ll be closing this as not-a-bug.  At most, I could clarify the
documentation of the C&lt;exit&gt; accessor.

  Perhaps: &#34;&#40;Will never be set by exceptions; these will be trapped without
exit by the default C&lt;:die&gt; layer, or else propagate out of the trap
function.&#41;&#34;

  Would that help?


Eirik
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;27&nbsp;12:06:28&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;27&nbsp;12:22:00&nbsp;2013</span>
    <span class="description">http://zurom.id.mail.ru/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> zurom [...] mail.ru</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think it will be more clear if you show the right code to get exit set to 255 after die &#40;as it realy happens without trap{..}&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;27&nbsp;13:01:51&nbsp;2013</span>
    <span class="description">sidhekin [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #91687] Wrong exit code after die</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 27 Dec 2013 19:01:42 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Test-Trap [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> The Sidhekin &lt;sidhekin [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Dec 27, 2013 at 6:22 PM, <span class="clickylink"><a target="new" rel="nofollow" href="http://zurom.id.mail.ru/">http://zurom.id.mail.ru/</a></span> via RT &lt;
bug-Test-Trap@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Test-Trap
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=91687">https://rt.cpan.org/Ticket/Display.html?id=91687</a></span> &gt;
&gt;
&gt; I think it will be more clear if you show the right code to get exit set
&gt; to 255 after die &#40;as it realy happens without trap{..}&#41;
&gt;
</div>
  As I said, by intention &#40;and documentation&#41; trap {} compares to eval {}.
Not to &#34;without trap {}&#34;.

  You could set exit to 255 after die, using a &#40;user defined&#41; layer, like
so:

use Test::Trap sub {
  my $self = shift;
  $self-&gt;Teardown&#40;sub { defined $self-&gt;{die} and $self-&gt;{exit}=255 }&#41;;
  $self-&gt;Next;
};

  ... but I suspect you&#39;re just going to end up with more trouble along
this route.  I certainly won&#39;t document that kind of thing.

  If you tell me what you&#39;re trying to do, perhaps I can suggest a better
route?


Eirik
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;30&nbsp;04:44:06&nbsp;2013</span>
    <span class="description">http://zurom.id.mail.ru/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;   If you tell me what you&#39;re trying to do, perhaps I can suggest a better
&gt; route?
</div>
I&#39;ve wrote unit-test fo cgi scripts where all inner code covered by sub _run. And the only thing that i can test is that sub.
And of cource the HTTP status depends on exit status, so we&#39;ve got 500 after die...

So the tests should show that script ends with exit code no equal to zero. 
It is important i think
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;30&nbsp;04:54:46&nbsp;2013</span>
    <span class="description">http://zurom.id.mail.ru/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">... and in my case the die itself is not so important as the exit status
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;30&nbsp;08:38:58&nbsp;2013</span>
    <span class="description">sidhekin [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #91687] Wrong exit code after die</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 30 Dec 2013 14:38:49 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Test-Trap [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> The Sidhekin &lt;sidhekin [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, Dec 30, 2013 at 10:54 AM, <span class="clickylink"><a target="new" rel="nofollow" href="http://zurom.id.mail.ru/">http://zurom.id.mail.ru/</a></span> via RT &lt;
bug-Test-Trap@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; I&#39;ve wrote unit-test fo cgi scripts where all inner code covered by sub
&gt; _run. And the only thing that i can test is that sub.
&gt; And of cource the HTTP status depends on exit status, so we&#39;ve got 500
&gt; after die...
&gt;
&gt; So the tests should show that script ends with exit code no equal to zero.
&gt; It is important i think
</div>
...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ... and in my case the die itself is not so important as the exit status
&gt;
</div>
  Right.  Assuming you have already considered and dismissed the frameworks
for tests with &#40;real or mocked&#41; webservers ... they can be rather heavy,
after all ...

  If you&#39;re treating &#38;_run as a black box, there is no way an ordinary exit
layer could trap all kinds of non-zero exits, so conceptually, it&#39;s
insufficient.  Perl is just too powerful for a pure-purl trap to properly
contain it ...

  For instance:

$ perl -e &#39;exec &#34;false&#34;&#39;
$ echo $?
1
$ perl -MTest::Trap -e &#39;trap { exec &#34;false&#34; }; print $trap-&gt;exit // &#34;undef&#34;&#39;
$ echo $?
1

  &#40;See the caveats for more ways to escape the trap.&#41;

  1&#41; The only way to safely handle every kind of exit from black boxes, is
in a process of its own.  A bit heavier and slower, but it will work.  I
might even want to write up a special layer for that ... sounds like it
could be useful ... haven&#39;t needed it yet, though.  And I&#39;ll need to sleep
on it, in any case.  It&#39;s kinda orthogonal to what I was originally trying
to do with Test::Trap.

  2&#41; If &#38;_run is not a black box, but you control it and the code it calls,
you could rewrite them so that they never exec&#40;&#41;, never POSIX::_exit&#40;&#41;,
never throw exceptions &#40;that they don&#39;t themselves catch&#41;, perhaps never
even return, but always just exit&#40;&#41;.  Or at least, so that you know in each
&#40;test&#41; case whether it will return, exit, or throw an exception.  And then
write the tests accordingly.

  3&#41; If it is not specified whether the code should return or exit with
zero on success, nor whether it should throw an exception or exit with
non-zero on failure, the test code must allow for either.  But we cannot
safely trap every kind of exit in the standard layers.  As a middle way,
you may decide to avoid troublesome exits, and just write the tests so as
to allow for either of return/exception and zero/non-zero trappable exit.
Perhaps with helpers:

sub did_succeed {
  my $trap = shift;
  my $name = shift // &#34;Expecting return or zero exit value&#34;;
  if &#40;$trap-&gt;leaveby eq &#34;exit&#34;&#41; {
    $trap-&gt;exit_is&#40;0, $name&#41;;
  }
  else {
    $trap-&gt;did_return&#40;$name&#41;;
  }
}

sub did_fail {
  my $trap = shift;
  my $name = shift // &#34;Expecting exception or non-zero exit value&#34;;
  if &#40;$trap-&gt;leaveby eq &#34;exit&#34;&#41; {
    $trap-&gt;exit_isnt&#40;0, $name&#41;;
  }
  else {
    $trap-&gt;did_die&#40;$name&#41;;
  }
}

  ... or even drop them in a C&lt;&lt; { package Test::Trap; ... } &gt;&gt; for
monkey-patched helper methods. :&#41;

  But again, this will not help you if &#38;_run or code called from it may use
exec&#40;&#41; or CORE::exit&#40;&#41; or other non-pure-perl stuff, as mentioned in the
caveats.  For that, a subprocess will be needed, and Test::Trap does not
&#40;as yet&#41; have any such mechanism.


Eirik
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;30&nbsp;10:42:48&nbsp;2013</span>
    <span class="description">http://zurom.id.mail.ru/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Assuming you have already considered and dismissed the frameworks for tests with &#40;real or mocked&#41; webservers 
</div>Yes you&#39;re right, such frameworks is too heavy. I&#39;d prefer more simple approach

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;   If you&#39;re treating &#38;_run as a black box
</div>Yes, it is really a black box, as most of the scripts were written a long time ago and the task is to cover them with tests and do not touch if possible. In any case, it is quite dangerous to do refactoring without unit tests. Scripts are important enough

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I might even want to write up a special layer for that ... sounds like it could be useful 
</div>Yes it could help

2&#38;3 are not an option unfortunatly as it is a black box
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;14&nbsp;13:36:22&nbsp;2018</span>
    <span class="description">ebhanssen [...] allverden.no -  Severity Wishlist added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
