<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #130641 for Net-SFTP-Foreign: Couldn&#39;t write to remote file: bad packet sequence with net-sftp-foreign</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #130641 for Net-SFTP-Foreign: Couldn&#39;t write to remote file: bad packet sequence with net-sftp-foreign</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-SFTP-Foreign/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-SFTP-Foreign/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-SFTP-Foreign/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-SFTP-Foreign/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SFTP-Foreign">Net-SFTP-Foreign CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">130641</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-SFTP-Foreign/Active/">Net-SFTP-Foreign</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dkolev [...] acats.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-23164-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-23165-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;03&nbsp;11:17:25&nbsp;2019</span>
    <span class="description">dkolev [...] acats.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Couldn&#39;t write to remote file: bad packet sequence with net-sftp-foreign</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 3 Oct 2019 15:10:40 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Net-SFTP-Foreign [...] rt.cpan.org&#34; &lt;bug-Net-SFTP-Foreign [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dimitar Kolev &lt;dkolev [...] acats.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,
We are utilizing SFTP client net-sftp-foreign <span class="clickylink"><a target="new" rel="nofollow" href="http://manpages.ubuntu.com/manpages/bionic/man3/Net::SFTP::Foreign.3pm.html">http://manpages.ubuntu.com/manpages/bionic/man3/Net::SFTP::Foreign.3pm.html</a></span> , with perl v5.26.1 on Ubuntu 18.04.2
The general process used is to build an array of the files that are waiting to be sent, then connect to the AWS SFTP Transfer service, and then loop through the array,

if &#40; !$remoteConnection-&gt;put&#40; $localFile, $remoteFileName, copy_perm =&gt; 0, copy_time =&gt; 0 &#41; &#41; {
$error = 1;
&#38;broadcast&#40; $remoteConnection-&gt;error &#41;;
}

We get 100% upload failure with larger than 34KB files:
09/26/2019 10:41:41 Connection to sftp.MyAWSsFTPservice.com successful.
09/26/2019 10:41:41 Uploading file: 20190925_ABC.XYZ
09/26/2019 10:41:41 Couldn&#39;t write to remote file: bad packet sequence, expected 2, got 3
09/26/2019 10:41:41 Could not upload 20190925_ABC.XYZ
09/26/2019 10:41:41 Uploading file: 20190925_ABC.RST
09/26/2019 10:41:41 Connection to remote server stalled

Would you verify that the &#39;net-sftp-foreign&#39; client is working with AWS SFTP Service?
Not sure if it is a bug in the module or AWS SFTP Service itself.

The exact same code works fine with other SFTP Servers like CerberusFTP.
I created tickets with AWS too:
<span class="clickylink"><a target="new" rel="nofollow" href="https://forums.aws.amazon.com/thread.jspa?threadID=310692">https://forums.aws.amazon.com/thread.jspa?threadID=310692</a></span>

Dimitar G. Kolev
ACA Surveillance Technology | Sr. Product Engineer
1370 Broadway, 12th Floor
New York, NY 10018
Office 212-951-1030 x1094 | Mobile 917-946-4844
dkolev@acats.com&lt;mailto:dkolev@acats.com&gt;
www.acatechnologysolutions.com&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.acatechnologysolutions.com/">http://www.acatechnologysolutions.com/</a></span>&gt;
Follow us: LinkedIn&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.linkedin.com/company/aca-compliance-group">http://www.linkedin.com/company/aca-compliance-group</a></span>&gt; | Twitter&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://twitter.com/ACACompliance">https://twitter.com/ACACompliance</a></span>&gt; @ACACompliance

[ACA Technology Solutions]&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.acacompliancegroup.com/aca-technology-solutions">http://www.acacompliancegroup.com/aca-technology-solutions</a></span>&gt;
This message is intended only for the designated recipient&#40;s&#41;.  It may contain confidential, privileged or proprietary information.  If you are not a designated recipient, you may not review, copy or distribute this message.  If you receive this message in error, please notify the sender by reply email and delete this message.  Thank you.
</div></div>

<div class="messagebody">
</div>
</div>

<div class="messagebody">
<img alt="image001.jpg" title="image001.jpg" src="/Ticket/Attachment/1866010/1001960/" /></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;04&nbsp;05:22:01&nbsp;2019</span>
    <span class="description">sfandino [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #130641] Couldn&#39;t write to remote file: bad packet sequence with net-sftp-foreign</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 4 Oct 2019 09:21:47 +0000 &#40;UTC&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Dimitar Kolev via RT &lt;bug-Net-SFTP-Foreign [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Salvador Fandino &lt;sfandino [...] yahoo.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space"> It seems that AWS SFTP server can process request out of order. It is allowed by the standard, but so far, no implementation has ever done that and Net::SFTP::Foreign was dependent on it not happening.

As a work around, you can set queue_size to 1 on the constructor. Transfers would be much slower, but successful.
It that doesn&#39;t work, enable debugging and attach the output to the bug report.
  $Net::SFTP::Foreign::debug = -1;





    On Thursday, October 3, 2019, 6:33:52 PM GMT+2, Dimitar Kolev via RT &lt;bug-Net-SFTP-Foreign@rt.cpan.org&gt; wrote:  
 
 Thu Oct 03 11:17:25 2019: Request 130641 was acted upon.
Transaction: Ticket created by dkolev@acats.com
      Queue: Net-SFTP-Foreign
    Subject: Couldn&#39;t write to remote file: bad packet sequence with net-sftp-foreign
  Broken in: &#40;no value&#41;
    Severity: &#40;no value&#41;
      Owner: Nobody
  Requestors: dkolev@acats.com
      Status: new
 Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=130641">https://rt.cpan.org/Ticket/Display.html?id=130641</a></span> &gt;


Hello,
We are utilizing SFTP client net-sftp-foreign <span class="clickylink"><a target="new" rel="nofollow" href="http://manpages.ubuntu.com/manpages/bionic/man3/Net::SFTP::Foreign.3pm.html">http://manpages.ubuntu.com/manpages/bionic/man3/Net::SFTP::Foreign.3pm.html</a></span> , with perl v5.26.1 on Ubuntu 18.04.2
The general process used is to build an array of the files that are waiting to be sent, then connect to the AWS SFTP Transfer service, and then loop through the array,

if &#40; !$remoteConnection-&gt;put&#40; $localFile, $remoteFileName, copy_perm =&gt; 0, copy_time =&gt; 0 &#41; &#41; {
$error = 1;
&#38;broadcast&#40; $remoteConnection-&gt;error &#41;;
}

We get 100% upload failure with larger than 34KB files:
09/26/2019 10:41:41 Connection to sftp.MyAWSsFTPservice.com successful.
09/26/2019 10:41:41 Uploading file: 20190925_ABC.XYZ
09/26/2019 10:41:41 Couldn&#39;t write to remote file: bad packet sequence, expected 2, got 3
09/26/2019 10:41:41 Could not upload 20190925_ABC.XYZ
09/26/2019 10:41:41 Uploading file: 20190925_ABC.RST
09/26/2019 10:41:41 Connection to remote server stalled

Would you verify that the &#39;net-sftp-foreign&#39; client is working with AWS SFTP Service?
Not sure if it is a bug in the module or AWS SFTP Service itself.

The exact same code works fine with other SFTP Servers like CerberusFTP.
I created tickets with AWS too:
<span class="clickylink"><a target="new" rel="nofollow" href="https://forums.aws.amazon.com/thread.jspa?threadID=310692">https://forums.aws.amazon.com/thread.jspa?threadID=310692</a></span>

Dimitar G. Kolev
ACA Surveillance Technology | Sr. Product Engineer
1370 Broadway, 12th Floor
New York, NY 10018
Office 212-951-1030 x1094 | Mobile 917-946-4844
dkolev@acats.com&lt;mailto:dkolev@acats.com&gt;
www.acatechnologysolutions.com&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.acatechnologysolutions.com/">http://www.acatechnologysolutions.com/</a></span>&gt;
Follow us: LinkedIn&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.linkedin.com/company/aca-compliance-group">http://www.linkedin.com/company/aca-compliance-group</a></span>&gt; | Twitter&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://twitter.com/ACACompliance">https://twitter.com/ACACompliance</a></span>&gt; @ACACompliance

[ACA Technology Solutions]&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.acacompliancegroup.com/aca-technology-solutions">http://www.acacompliancegroup.com/aca-technology-solutions</a></span>&gt;
This message is intended only for the designated recipient&#40;s&#41;.  It may contain confidential, privileged or proprietary information.  If you are not a designated recipient, you may not review, copy or distribute this message.  If you receive this message in error, please notify the sender by reply email and delete this message.  Thank you.


  
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;04&nbsp;05:22:02&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;04&nbsp;06:06:11&nbsp;2019</span>
    <span class="description">dkolev [...] acats.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Oleg Kashansky &lt;okashansky [...] acats.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #130641] Couldn&#39;t write to remote file: bad packet sequence with net-sftp-foreign</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 4 Oct 2019 10:05:54 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Net-SFTP-Foreign [...] rt.cpan.org&#34; &lt;bug-Net-SFTP-Foreign [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dimitar Kolev &lt;dkolev [...] acats.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Also posted at
<span class="clickylink"><a target="new" rel="nofollow" href="https://forums.aws.amazon.com/thread.jspa?messageID=918460&#38;#918460">https://forums.aws.amazon.com/thread.jspa?messageID=918460&#38;#918460</a></span>
to verify that AWS SFTP server can process request out of order.

We will try the workaround and bug report you requested.

Thanks

From: Salvador \&#34;Fandiño\&#34; via RT &lt;bug-Net-SFTP-Foreign@rt.cpan.org&gt;
Sent: Friday, October 4, 2019 5:22 AM
To: Dimitar Kolev &lt;dkolev@acats.com&gt;
Subject: Re: [rt.cpan.org #130641] Couldn&#39;t write to remote file: bad packet sequence with net-sftp-foreign

[[EXTERNAL EMAIL]]

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=130641">https://rt.cpan.org/Ticket/Display.html?id=130641</a></span>&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=130641">https://rt.cpan.org/Ticket/Display.html?id=130641</a></span>&gt; &gt;

It seems that AWS SFTP server can process request out of order. It is allowed by the standard, but so far, no implementation has ever done that and Net::SFTP::Foreign was dependent on it not happening.

As a work around, you can set queue_size to 1 on the constructor. Transfers would be much slower, but successful.
It that doesn&#39;t work, enable debugging and attach the output to the bug report.
  $Net::SFTP::Foreign::debug = -1;





On Thursday, October 3, 2019, 6:33:52 PM GMT+2, Dimitar Kolev via RT &lt;bug-Net-SFTP-Foreign@rt.cpan.org&lt;mailto:bug-Net-SFTP-Foreign@rt.cpan.org&gt;&gt; wrote:

Thu Oct 03 11:17:25 2019: Request 130641 was acted upon.
Transaction: Ticket created by dkolev@acats.com&lt;mailto:dkolev@acats.com&gt;
      Queue: Net-SFTP-Foreign
    Subject: Couldn&#39;t write to remote file: bad packet sequence with net-sftp-foreign
  Broken in: &#40;no value&#41;
    Severity: &#40;no value&#41;
      Owner: Nobody
  Requestors: dkolev@acats.com&lt;mailto:dkolev@acats.com&gt;
      Status: new
Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=130641">https://rt.cpan.org/Ticket/Display.html?id=130641</a></span>&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=130641">https://rt.cpan.org/Ticket/Display.html?id=130641</a></span>&gt; &gt;


Hello,
We are utilizing SFTP client net-sftp-foreign <span class="clickylink"><a target="new" rel="nofollow" href="http://manpages.ubuntu.com/manpages/bionic/man3/Net::SFTP::Foreign.3pm.html">http://manpages.ubuntu.com/manpages/bionic/man3/Net::SFTP::Foreign.3pm.html</a></span>&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://manpages.ubuntu.com/manpages/bionic/man3/Net::SFTP::Foreign.3pm.html">http://manpages.ubuntu.com/manpages/bionic/man3/Net::SFTP::Foreign.3pm.html</a></span>&gt; , with perl v5.26.1 on Ubuntu 18.04.2
The general process used is to build an array of the files that are waiting to be sent, then connect to the AWS SFTP Transfer service, and then loop through the array,

if &#40; !$remoteConnection-&gt;put&#40; $localFile, $remoteFileName, copy_perm =&gt; 0, copy_time =&gt; 0 &#41; &#41; {
$error = 1;
&#38;broadcast&#40; $remoteConnection-&gt;error &#41;;
}

We get 100% upload failure with larger than 34KB files:
09/26/2019 10:41:41 Connection to sftp.MyAWSsFTPservice.com successful.
09/26/2019 10:41:41 Uploading file: 20190925_ABC.XYZ
09/26/2019 10:41:41 Couldn&#39;t write to remote file: bad packet sequence, expected 2, got 3
09/26/2019 10:41:41 Could not upload 20190925_ABC.XYZ
09/26/2019 10:41:41 Uploading file: 20190925_ABC.RST
09/26/2019 10:41:41 Connection to remote server stalled

Would you verify that the &#39;net-sftp-foreign&#39; client is working with AWS SFTP Service?
Not sure if it is a bug in the module or AWS SFTP Service itself.

The exact same code works fine with other SFTP Servers like CerberusFTP.
I created tickets with AWS too:
<span class="clickylink"><a target="new" rel="nofollow" href="https://forums.aws.amazon.com/thread.jspa?threadID=310692">https://forums.aws.amazon.com/thread.jspa?threadID=310692</a></span>&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://forums.aws.amazon.com/thread.jspa?threadID=310692">https://forums.aws.amazon.com/thread.jspa?threadID=310692</a></span>&gt;

Dimitar G. Kolev
ACA Surveillance Technology | Sr. Product Engineer
1370 Broadway, 12th Floor
New York, NY 10018
Office 212-951-1030 x1094 | Mobile 917-946-4844
dkolev@acats.com&lt;mailto:dkolev@acats.com&lt;mailto:dkolev@acats.com%3cmailto:dkolev@acats.com&gt;&gt;
www.acatechnologysolutions.com&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.acatechnologysolutions.com">http://www.acatechnologysolutions.com</a></span>&gt;&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.acatechnologysolutions.com/">http://www.acatechnologysolutions.com/</a></span>&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.acatechnologysolutions.com/">http://www.acatechnologysolutions.com/</a></span>&gt;&gt;
Follow us: LinkedIn&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.linkedin.com/company/aca-compliance-group">http://www.linkedin.com/company/aca-compliance-group</a></span>&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.linkedin.com/company/aca-compliance-group">http://www.linkedin.com/company/aca-compliance-group</a></span>&gt;&gt; | Twitter&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://twitter.com/ACACompliance">https://twitter.com/ACACompliance</a></span>&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://twitter.com/ACACompliance">https://twitter.com/ACACompliance</a></span>&gt;&gt; @ACACompliance

[ACA Technology Solutions]&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.acacompliancegroup.com/aca-technology-solutions">http://www.acacompliancegroup.com/aca-technology-solutions</a></span>&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.acacompliancegroup.com/aca-technology-solutions">http://www.acacompliancegroup.com/aca-technology-solutions</a></span>&gt;&gt;
This message is intended only for the designated recipient&#40;s&#41;.  It may contain confidential, privileged or proprietary information.  If you are not a designated recipient, you may not review, copy or distribute this message.  If you receive this message in error, please notify the sender by reply email and delete this message.  Thank you.


</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;04&nbsp;09:02:22&nbsp;2019</span>
    <span class="description">dkolev [...] acats.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #130641] Couldn&#39;t write to remote file: bad packet sequence with net-sftp-foreign</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 4 Oct 2019 13:01:51 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Net-SFTP-Foreign [...] rt.cpan.org&#34; &lt;bug-Net-SFTP-Foreign [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dimitar Kolev &lt;dkolev [...] acats.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">We can confirm on our side that the workaround you suggested works:
- set the queue_size to 1 in the constructor parameters which makes the upload a lot slower.

Example:
use Net::SFTP::Foreign;
my $host = &#39;sftp.MyAwsTransferSFTPservice.com&#39;;
my $sftp = Net::SFTP::Foreign-&gt;new&#40;$host, more =&gt; queue_size =&gt; 1&#41;;

Thank You

From: Dimitar Kolev
Sent: Friday, October 4, 2019 6:06 AM
To: bug-Net-SFTP-Foreign@rt.cpan.org
Cc: Oleg Kashansky &lt;okashansky@acats.com&gt;
Subject: RE: [rt.cpan.org #130641] Couldn&#39;t write to remote file: bad packet sequence with net-sftp-foreign

Also posted at
<span class="clickylink"><a target="new" rel="nofollow" href="https://forums.aws.amazon.com/thread.jspa?messageID=918460&#38;#918460">https://forums.aws.amazon.com/thread.jspa?messageID=918460&#38;#918460</a></span>
to verify that AWS SFTP server can process request out of order.

We will try the workaround and bug report you requested.

Thanks

From: Salvador \&#34;Fandiño\&#34; via RT &lt;bug-Net-SFTP-Foreign@rt.cpan.org&lt;mailto:bug-Net-SFTP-Foreign@rt.cpan.org&gt;&gt;
Sent: Friday, October 4, 2019 5:22 AM
To: Dimitar Kolev &lt;dkolev@acats.com&lt;mailto:dkolev@acats.com&gt;&gt;
Subject: Re: [rt.cpan.org #130641] Couldn&#39;t write to remote file: bad packet sequence with net-sftp-foreign

[[EXTERNAL EMAIL]]

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=130641">https://rt.cpan.org/Ticket/Display.html?id=130641</a></span>&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=130641">https://rt.cpan.org/Ticket/Display.html?id=130641</a></span>&gt; &gt;

It seems that AWS SFTP server can process request out of order. It is allowed by the standard, but so far, no implementation has ever done that and Net::SFTP::Foreign was dependent on it not happening.

As a work around, you can set queue_size to 1 on the constructor. Transfers would be much slower, but successful.
It that doesn&#39;t work, enable debugging and attach the output to the bug report.
  $Net::SFTP::Foreign::debug = -1;





On Thursday, October 3, 2019, 6:33:52 PM GMT+2, Dimitar Kolev via RT &lt;bug-Net-SFTP-Foreign@rt.cpan.org&lt;mailto:bug-Net-SFTP-Foreign@rt.cpan.org&gt;&gt; wrote:

Thu Oct 03 11:17:25 2019: Request 130641 was acted upon.
Transaction: Ticket created by dkolev@acats.com&lt;mailto:dkolev@acats.com&gt;
      Queue: Net-SFTP-Foreign
    Subject: Couldn&#39;t write to remote file: bad packet sequence with net-sftp-foreign
  Broken in: &#40;no value&#41;
    Severity: &#40;no value&#41;
      Owner: Nobody
  Requestors: dkolev@acats.com&lt;mailto:dkolev@acats.com&gt;
      Status: new
Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=130641">https://rt.cpan.org/Ticket/Display.html?id=130641</a></span>&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=130641">https://rt.cpan.org/Ticket/Display.html?id=130641</a></span>&gt; &gt;


Hello,
We are utilizing SFTP client net-sftp-foreign <span class="clickylink"><a target="new" rel="nofollow" href="http://manpages.ubuntu.com/manpages/bionic/man3/Net::SFTP::Foreign.3pm.html">http://manpages.ubuntu.com/manpages/bionic/man3/Net::SFTP::Foreign.3pm.html</a></span>&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://manpages.ubuntu.com/manpages/bionic/man3/Net::SFTP::Foreign.3pm.html">http://manpages.ubuntu.com/manpages/bionic/man3/Net::SFTP::Foreign.3pm.html</a></span>&gt; , with perl v5.26.1 on Ubuntu 18.04.2
The general process used is to build an array of the files that are waiting to be sent, then connect to the AWS SFTP Transfer service, and then loop through the array,

if &#40; !$remoteConnection-&gt;put&#40; $localFile, $remoteFileName, copy_perm =&gt; 0, copy_time =&gt; 0 &#41; &#41; {
$error = 1;
&#38;broadcast&#40; $remoteConnection-&gt;error &#41;;
}

We get 100% upload failure with larger than 34KB files:
09/26/2019 10:41:41 Connection to sftp.MyAWSsFTPservice.com successful.
09/26/2019 10:41:41 Uploading file: 20190925_ABC.XYZ
09/26/2019 10:41:41 Couldn&#39;t write to remote file: bad packet sequence, expected 2, got 3
09/26/2019 10:41:41 Could not upload 20190925_ABC.XYZ
09/26/2019 10:41:41 Uploading file: 20190925_ABC.RST
09/26/2019 10:41:41 Connection to remote server stalled

Would you verify that the &#39;net-sftp-foreign&#39; client is working with AWS SFTP Service?
Not sure if it is a bug in the module or AWS SFTP Service itself.

The exact same code works fine with other SFTP Servers like CerberusFTP.
I created tickets with AWS too:
<span class="clickylink"><a target="new" rel="nofollow" href="https://forums.aws.amazon.com/thread.jspa?threadID=310692">https://forums.aws.amazon.com/thread.jspa?threadID=310692</a></span>&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://forums.aws.amazon.com/thread.jspa?threadID=310692">https://forums.aws.amazon.com/thread.jspa?threadID=310692</a></span>&gt;

Dimitar G. Kolev
ACA Surveillance Technology | Sr. Product Engineer
1370 Broadway, 12th Floor
New York, NY 10018
Office 212-951-1030 x1094 | Mobile 917-946-4844
dkolev@acats.com&lt;mailto:dkolev@acats.com&lt;mailto:dkolev@acats.com%3cmailto:dkolev@acats.com&gt;&gt;
www.acatechnologysolutions.com&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.acatechnologysolutions.com">http://www.acatechnologysolutions.com</a></span>&gt;&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.acatechnologysolutions.com/">http://www.acatechnologysolutions.com/</a></span>&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.acatechnologysolutions.com/">http://www.acatechnologysolutions.com/</a></span>&gt;&gt;
Follow us: LinkedIn&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.linkedin.com/company/aca-compliance-group">http://www.linkedin.com/company/aca-compliance-group</a></span>&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.linkedin.com/company/aca-compliance-group">http://www.linkedin.com/company/aca-compliance-group</a></span>&gt;&gt; | Twitter&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://twitter.com/ACACompliance">https://twitter.com/ACACompliance</a></span>&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://twitter.com/ACACompliance">https://twitter.com/ACACompliance</a></span>&gt;&gt; @ACACompliance

[ACA Technology Solutions]&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.acacompliancegroup.com/aca-technology-solutions">http://www.acacompliancegroup.com/aca-technology-solutions</a></span>&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.acacompliancegroup.com/aca-technology-solutions">http://www.acacompliancegroup.com/aca-technology-solutions</a></span>&gt;&gt;
This message is intended only for the designated recipient&#40;s&#41;.  It may contain confidential, privileged or proprietary information.  If you are not a designated recipient, you may not review, copy or distribute this message.  If you receive this message in error, please notify the sender by reply email and delete this message.  Thank you.

</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;26&nbsp;04:13:14&nbsp;2020</span>
    <span class="description">salva [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Oct 03 11:17:25 2019, dkolev@acats.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello,
&gt; We are utilizing SFTP client net-sftp-foreign
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://manpages.ubuntu.com/manpages/bionic/man3/Net::SFTP::Foreign.3pm.html">http://manpages.ubuntu.com/manpages/bionic/man3/Net::SFTP::Foreign.3pm.html</a></span>
&gt; , with perl v5.26.1 on Ubuntu 18.04.2
&gt; The general process used is to build an array of the files that are
&gt; waiting to be sent, then connect to the AWS SFTP Transfer service, and
&gt; then loop through the array,
&gt; 
&gt; if &#40; !$remoteConnection-&gt;put&#40; $localFile, $remoteFileName, copy_perm
&gt; =&gt; 0, copy_time =&gt; 0 &#41; &#41; {
&gt; $error = 1;
&gt; &#38;broadcast&#40; $remoteConnection-&gt;error &#41;;
&gt; }
&gt; 
&gt; We get 100% upload failure with larger than 34KB files:
&gt; 09/26/2019 10:41:41 Connection to sftp.MyAWSsFTPservice.com
&gt; successful.
&gt; 09/26/2019 10:41:41 Uploading file: 20190925_ABC.XYZ
&gt; 09/26/2019 10:41:41 Couldn&#39;t write to remote file: bad packet
&gt; sequence, expected 2, got 3
&gt; 09/26/2019 10:41:41 Could not upload 20190925_ABC.XYZ
&gt; 09/26/2019 10:41:41 Uploading file: 20190925_ABC.RST
&gt; 09/26/2019 10:41:41 Connection to remote server stalled
&gt; 
&gt; Would you verify that the &#39;net-sftp-foreign&#39; client is working with
&gt; AWS SFTP Service?
&gt; Not sure if it is a bug in the module or AWS SFTP Service itself.
&gt; 
&gt; The exact same code works fine with other SFTP Servers like
&gt; CerberusFTP.
&gt; I created tickets with AWS too:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://forums.aws.amazon.com/thread.jspa?threadID=310692">https://forums.aws.amazon.com/thread.jspa?threadID=310692</a></span>
&gt; 
&gt; Dimitar G. Kolev
&gt; ACA Surveillance Technology | Sr. Product Engineer
&gt; 1370 Broadway, 12th Floor
&gt; New York, NY 10018
&gt; Office 212-951-1030 x1094 | Mobile 917-946-4844
&gt; dkolev@acats.com&lt;mailto:dkolev@acats.com&gt;
&gt; www.acatechnologysolutions.com&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.acatechnologysolutions.com/">http://www.acatechnologysolutions.com/</a></span>&gt;
&gt; Follow us: LinkedIn&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.linkedin.com/company/aca-compliance-">http://www.linkedin.com/company/aca-compliance-</a></span>
<div class="message-stanza open">&gt; group&gt; | Twitter&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://twitter.com/ACACompliance">https://twitter.com/ACACompliance</a></span>&gt; @ACACompliance
</div>&gt; 
&gt; [ACA Technology Solutions]&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.acacompliancegroup.com/aca-">http://www.acacompliancegroup.com/aca-</a></span>
&gt; technology-solutions&gt;
&gt; This message is intended only for the designated recipient&#40;s&#41;.  It may
&gt; contain confidential, privileged or proprietary information.  If you
&gt; are not a designated recipient, you may not review, copy or distribute
&gt; this message.  If you receive this message in error, please notify the
&gt; sender by reply email and delete this message.  Thank you.
</div>

I have added support for the out or order responses in 1.92_02.

I would appreciate having people testing it.

So, if you are still using Net::SFTP::Foreign against the AWS SFTP server, could you try the new version?
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
