<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #5135 for DBD-mysql: fork disrupts the database connection 2.9002 and 2.9003</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #5135 for DBD-mysql: fork disrupts the database connection 2.9002 and 2.9003</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-mysql/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-mysql">DBD-mysql CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">5135</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-mysql/Active/">DBD-mysql</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dankney [...] network1.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10170-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
2.9002</li>
<li>
2.9003</li>
</ul>
    </td>
  </tr>
  <tr id="CF-10171-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;30&nbsp;14:38:57&nbsp;2004</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> fork disrupts the database connection 2.9002 and 2.9003</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Distribution names: DBD-MySQL-2.9002 and DBD-mysql-2.9003
Perl versions:  5.8.0 and 5.8.1
Operating systems: 

Linux cartman.network1.net 2.4.22-1.2115.nptl #1 Wed Oct 29 15:20:17 EST 2003 i586 i586 i386 GNU/Linux

FreeBSD skipper.network1.net 4.8-RC FreeBSD 4.8-RC #0: Wed Mar  5 16:45:13 EST 2003     root@skipper.network1.net:/usr/obj/usr/src/sys/FNGi  i386

After an initial select, and then a fork, the database connection still exists, but is unusable.  That is as specific as I can be...

Here is some example code that does not work under the above mentioned dbd versions, but does work on dbd-mysql-2.1026:

#!/usr/bin/perl


my $db_host=&#39;localhost&#39;;
my $db=&#39;fngimon&#39;;
my $db_user=&#39;&lt;hidden&gt;&#39;;
my $db_pass=&#39;&lt;hidden&gt;&#39;;

use strict;
use DBI;
use POSIX &#34;:sys_wait_h&#34;;

my $dbh=&#38;db_connect&#40;$db_host,$db,$db_user,$db_pass&#41;;

while &#40;1&#41; {

        my $sqlquery=&#34;select id from interfaces order by rand&#40;&#41; limit 0, 5&#34;;
        my $obj=&#38;db_query&#40;$dbh,$sqlquery&#41;;
        my $ntuples=$obj-&gt;rows&#40;&#41;;
        my $debug=1;

        while &#40;my $ref = $obj-&gt;fetchrow_hashref&#40;&#41;&#41; {


                        my $interfaces_id=$ref-&gt;{&#39;id&#39;};
                        print &#34;interfaces_id:$interfaces_id &#34; if &#40;$debug&#41;;

                        &#38;safefork;
        }

        print &#34;-----------------------------------------------------------------------------------------------------------------\n&#34;;
}


##############################################################
# This subroutine forks the recv&#40;&#41; so the script doesnt hang!#
##############################################################
sub safefork {

        my $pid_;
        my $return;
        my %SIG;

        $SIG{CHLD} = \&#38;REAPER;
        # do something that forks...
        FORK: {
                if &#40;$pid_ = fork&#41; {

                        # parent here
                        # child process pid is available in $pid_
                        return &#40;$pid_&#41;;

                } elsif &#40;defined $pid_&#41; { # $pid_ is zero here if defined

                        # child here
                        # Child code goes here!
                        # parent process pid is available with getppid

                        exit;

                } elsif &#40;$! =~ /No more process/&#41; {

                        # EAGAIN, supposedly recoverable fork error
                        #sleep 5;
                        #redo FORK;
                        # Just exit:
                        exit;

                } else {

                        # weird fork error
                        print &#40;&#34;Can&#39;t fork: $!\n&#34;&#41;;
                        exit;

                }

        }
} # end safefork sub-routine
########################################################################
# This subroutine is REAPER that prevents Zombies with his shiny scythe#
# This is necessary on sysv due to the way it handles signals          #
########################################################################
sub REAPER {
        my $child;
        my %Kid_Status;
        my %SIG;

        # If a second child dies while in the signal handler caused by the
        # first death, we won&#39;t get another signal. So must loop here else
        # we will leave the unreaped child as a zombie. And the next time
        # two children die we get another zombie. And so on.
        while &#40;&#40;$child = waitpid&#40;-1,WNOHANG&#41;&#41; &gt; 0&#41; {
                $Kid_Status{$child} = $?;
        }
        $SIG{CHLD} = \&#38;REAPER;  # still loathe sysV
} # end REAPER sub-routine
sub db_connect {

        my &#40;$db_host,$db,$db_user,$db_pass&#41; = @_;
        my &#40;$dbh&#41;;
        my &#40;$note_connect&#41;=0;

        while &#40;!$dbh&#41; {

                $dbh = DBI-&gt;connect&#40;&#34;DBI:mysql:$db:$db_host&#34;, &#34;$db_user&#34;, &#34;$db_pass&#34;, {PrintError =&gt; 0}&#41;;

                if &#40;!$dbh&#41; {
                        $note_connect=1;
                        sleep 2;
                }
        }

        if &#40;$note_connect==1&#41; {
                $note_connect=0;
        }

        return &#40;$dbh&#41;;

}
sub db_query {
        my &#40;$dbh,$sqlquery&#41; = @_;
        my &#40;$obj&#41; = $dbh-&gt;prepare&#40;&#34;$sqlquery&#34;&#41;;
        if &#40;!$obj&#41; {
                exit;
        }
        if &#40;!$obj-&gt;execute&#41; {
                exit;
        }

        return &#40;$obj&#41;;

} # end db_query sub-routine;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;30&nbsp;16:48:11&nbsp;2004</span>
    <span class="description">jwied [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The described behaviour is correct, because the forked child exits.

Think of it as follows: Both the child and the parent contain an
open database connection. The connection is attached to some Perl
object.

If the child exits, then Perl&#39;s garbage collector becomes active
and destroys the child. Destroying the child means in our case,
that the child closes the connection silently. Of course, the
same connection and the socket remain open in the parent. However,
from the servers point of view, the connection is closed anyways.

If you are interested in further discussions, please do so on the
mailing list perl@lists.mysql.com.


Jochen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;30&nbsp;16:48:12&nbsp;2004</span>
    <span class="description">jwied [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;31&nbsp;12:41:34&nbsp;2004</span>
    <span class="description">jwied [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Darren,

it may very well be, that my diagnosis is wrong. And that
is exactly the reason why the discussion is better held on
perl@lists.mysql.com: It&#39;s a place where Rudy Lippan, the current
module maintainer will read your postings.


Jochen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;31&nbsp;12:41:35&nbsp;2004</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;14&nbsp;20:58:40&nbsp;2004</span>
    <span class="description">rlippan [...] remotelinux.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
