<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #42348 for Parse-RecDescent: Negative lookahead not working</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #42348 for Parse-RecDescent: Negative lookahead not working</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Parse-RecDescent/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Parse-RecDescent/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Parse-RecDescent/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Parse-RecDescent/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Parse-RecDescent">Parse-RecDescent CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">42348</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Parse-RecDescent/Active/">Parse-RecDescent</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
polettix [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-24792-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.96.0    </td>
  </tr>
  <tr id="CF-24793-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;12&nbsp;19:25:24&nbsp;2009</span>
    <span class="description">polettix [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Negative lookahead not working</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

   unless I completely missed the point about negative look-aheads &#40;and
this may well be!&#41;, I think there might be a bug in its handling inside
Parse::RecDescent. Please find attached a minimal test file, complete
with its output with &#34;prove -v&#34; &#40;perl 5.8.8 and P::RD 1.96.0&#41;.

Cheers,

   Flavio.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> prd.t</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"># vim: filetype=perl :
use strict;
use warnings;
use Test::More tests =&gt; 1;
use Parse::RecDescent;
$::RD_TRACE = 1;

my $grammar = &lt;&lt;&#39;END_OF_GRAMMAR&#39;;
foo : &#39;a&#39;
bar : &#39;z&#39;
not_before_bar : foo ...!bar
whatever       : not_before_bar foo
END_OF_GRAMMAR

my $parser = Parse::RecDescent-&gt;new&#40;$grammar&#41;;
ok&#40;$parser-&gt;whatever&#40;$_&#41;, $_&#41; for qw&#40; aa &#41;;

__END__
$ prove prd.t
prd......    Parse::RecDescent: Treating &#34;foo :&#34; as a rule declaration
    Parse::RecDescent: Treating &#34;a&#34; as a literal terminal
    Parse::RecDescent: Treating &#34;bar :&#34; as a rule declaration
    Parse::RecDescent: Treating &#34;z&#34; as a literal terminal
    Parse::RecDescent: Treating &#34;not_before_bar :&#34; as a rule declaration
    Parse::RecDescent: Treating &#34;foo&#34; as a subrule match
    Parse::RecDescent: Treating &#34;...!&#34; as a negative lookahead
    Parse::RecDescent: Treating &#34;bar&#34; as a subrule match
    Parse::RecDescent: Treating &#34;whatever :&#34; as a rule declaration
    Parse::RecDescent: Treating &#34;not_before_bar&#34; as a subrule match
    Parse::RecDescent: Treating &#34;foo&#34; as a subrule match
printing code &#40;20115&#41; to RD_TRACE
 1| whatever |Trying rule: [whatever]               |
 1| whatever |                                      |&#34;aa&#34;
 1| whatever |Trying production: [not_before_bar    |
  |          |foo]                                  |
 1| whatever |Trying subrule: [not_before_bar]      |
 2|not_before|Trying rule: [not_before_bar]         |
 2|not_before|Trying production: [foo bar]          |
 2|not_before|Trying subrule: [foo]                 |
 3|   foo    |Trying rule: [foo]                    |
 3|   foo    |Trying production: [&#39;a&#39;]              |
 3|   foo    |Trying terminal: [&#39;a&#39;]                |
 3|   foo    |&gt;&gt;Matched terminal&lt;&lt; &#40;return value:   |
  |          |[a]&#41;                                  |
 3|   foo    |                                      |&#34;a&#34;
 3|   foo    |&gt;&gt;Matched production: [&#39;a&#39;]&lt;&lt;         |
 3|   foo    |&gt;&gt;Matched rule&lt;&lt; &#40;return value: [a]&#41;  |
 3|   foo    |&#40;consumed: [a]&#41;                       |
 2|not_before|&gt;&gt;Matched subrule: [foo]&lt;&lt; &#40;return    |
  |          |value: [a]                            |
 2|not_before|Trying subrule: [bar]                 |
 3|   bar    |Trying rule: [bar]                    |
 3|   bar    |Trying production: [&#39;z&#39;]              |
 3|   bar    |Trying terminal: [&#39;z&#39;]                |
 3|   bar    |&lt;&lt;Didn&#39;t match terminal&gt;&gt;             |
 3|   bar    |&lt;&lt;Didn&#39;t match rule&gt;&gt;                 |
 2|not_before|&gt;&gt;Matched subrule: [bar]&lt;&lt; &#40;return    |
  |          |value: []                             |
 2|not_before|&gt;&gt;Matched production: [foo bar]&lt;&lt;     |
 2|not_before|&gt;&gt;Matched rule&lt;&lt; &#40;return value: []&#41;   |
 2|not_before|&#40;consumed: [a]&#41;                       |
 1| whatever |&lt;&lt;Didn&#39;t match subrule:               |
  |          |[not_before_bar]&gt;&gt;                    |
 1| whatever |&lt;&lt;Didn&#39;t match rule&gt;&gt;                 |
prd......1/1
#   Failed test &#39;aa&#39;
#   at prd.t line 16.
# Looks like you failed 1 test of 1.
prd...... Dubious, test returned 1 &#40;wstat 256, 0x100&#41;
 Failed 1/1 subtests

Test Summary Report
-------------------
prd.t &#40;Wstat: 256 Tests: 1 Failed: 1&#41;
  Failed test:  1
  Non-zero exit status: 1
Files=1, Tests=1,  0 wallclock secs &#40; 0.01 usr  0.01 sys +  0.00 cusr  0.07 csys =  0.09 CPU&#41;
Result: FAIL
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;09&nbsp;17:56:11&nbsp;2010</span>
    <span class="description">mhhollomon [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mhhollomon [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jan 12 19:25:24 2009, POLETTIX wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello,
&gt; 
&gt;    unless I completely missed the point about negative look-aheads &#40;and
&gt; this may well be!&#41;, I think there might be a bug in its handling inside
&gt; Parse::RecDescent. Please find attached a minimal test file, complete
&gt; with its output with &#34;prove -v&#34; &#40;perl 5.8.8 and P::RD 1.96.0&#41;.
&gt; 
&gt; Cheers,
&gt; 
&gt;    Flavio.
</div>
There is definitely a problem with the way returns from the negative
look ahead is handled. If you change the rule to say ...

not_before_bar : foo ...!bar { 1 }

it works as expected.

$_tok is assigned the return from bar, but if bar fails &#40;as you would
want&#41; it is undefined. So, the default action of $item[-1] takes the
undef and fails the production.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;09&nbsp;17:56:12&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;10&nbsp;12:32:36&nbsp;2010</span>
    <span class="description">mhhollomon [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Patch for Negative lookahead not working</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mhhollomon [...] gmail.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached is a proof of concept patch that fixes at the specific problem
reported. I suspect, however that there other paths in the code that
need correcting.

I ran this against some of my heavy grammars and didn&#39;t see any regressions.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> neg_lookahead_bug.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">*** RecDescent.pm.orig	2010-11-10 07:02:39.607127500 -0500
--- RecDescent.pm	2010-11-10 08:30:21.156426200 -0500
*************** sub &#39; . $namespace . &#39;::&#39; . $self-&gt;{&#34;nam
*** 441,447 ****
                &#39;
              : &#39;&#39;&#41; . &#39;
  
!         $_[1] = $text;  # NOT SURE THIS IS NEEDED
          Parse::RecDescent::_trace&#40;q{&lt;&lt;Didn\&#39;t match rule&gt;&gt;},
                       Parse::RecDescent::_tracefirst&#40;$_[1]&#41;,
                       q{&#39; . $self-&gt;{&#34;name&#34;} .&#39;},
--- 441,447 ----
                &#39;
              : &#39;&#39;&#41; . &#39;
  
!         #$_[1] = $text;  # NOT SURE THIS IS NEEDED
          Parse::RecDescent::_trace&#40;q{&lt;&lt;Didn\&#39;t match rule&gt;&gt;},
                       Parse::RecDescent::_tracefirst&#40;$_[1]&#41;,
                       q{&#39; . $self-&gt;{&#34;name&#34;} .&#39;},
*************** sub code&#40;$$$$&#41;
*** 884,889 ****
--- 884,890 ----
                      if defined $::RD_TRACE;
              last;
          }
+         &#39; . &#40;$self-&gt;{&#34;lookahead&#34;}&lt;0?&#39;$_tok = 0;&#39;:&#39;&#39;&#41; . &#39;
          Parse::RecDescent::_trace&#40;q{&gt;&gt;Matched action&lt;&lt; &#40;return value: [}
                        . $_tok . q{]&#41;},
                        Parse::RecDescent::_tracefirst&#40;$text&#41;&#41;
*************** sub code&#40;$$$$&#41;
*** 947,952 ****
--- 948,954 ----
          &#39; . &#40;$self-&gt;{&#34;lookahead&#34;} ? &#39;$text = $_savetext and &#39; : &#39;&#39; &#41; .&#39;
          last &#39;
          . &#40;$self-&gt;{&#34;lookahead&#34;}&lt;0?&#39;if&#39;:&#39;unless&#39;&#41; . &#39; defined $_tok;
+         &#39; . &#40;$self-&gt;{&#34;lookahead&#34;}&lt;0?&#39;$_tok = 0;&#39;:&#39;&#39;&#41; . &#39;
          push @item, $item{&#39;.$self-&gt;{hashname}.&#39;}=$_tok;
          &#39; . &#40;$self-&gt;{&#34;lookahead&#34;} ? &#39;$text = $_savetext;&#39; : &#39;&#39; &#41; .&#39;
  &#39;
*************** sub code&#40;$$$$&#41;
*** 1376,1381 ****
--- 1378,1384 ----
              $expectation-&gt;failed&#40;&#41;;
              last;
          }
+         &#39; . &#40;$self-&gt;{&#34;lookahead&#34;}&lt;0?&#39;$_tok = 0;&#39;:&#39;&#39;&#41; . &#39;
          Parse::RecDescent::_trace&#40;q{&gt;&gt;Matched subrule: [&#39;
                      . $self-&gt;{subrule} . &#39;]&lt;&lt; &#40;return value: [}
                      . $_tok . q{]},
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;10&nbsp;14:19:04&nbsp;2010</span>
    <span class="description">mhhollomon [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Lookahead on implied subrule not working</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mhhollomon [...] gmail.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Nov 10 12:32:36 2010, markhh wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Attached is a proof of concept patch that fixes at the specific problem
&gt; reported. I suspect, however that there other paths in the code that
&gt; need correcting.
</div>
I was right ...

The form:

not_before_bar : foo ...!&#40;&#39;z&#39; | &#39;x&#39;&#41;

did not work at all. The problem was that _generate was not respecting
the $lookahead setting when modifying the grammar to replace the inline
subrule with the autogenerated rule.

Version 2 patch attached. Season to taste.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> neg_lookahead_bug_v2.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">*** RecDescent.pm.orig	2010-11-10 07:02:39.607127500 -0500
--- lib/Parse/RecDescent.pm	2010-11-10 14:12:43.222205500 -0500
*************** sub &#39; . $namespace . &#39;::&#39; . $self-&gt;{&#34;nam
*** 441,447 ****
                &#39;
              : &#39;&#39;&#41; . &#39;
  
!         $_[1] = $text;  # NOT SURE THIS IS NEEDED
          Parse::RecDescent::_trace&#40;q{&lt;&lt;Didn\&#39;t match rule&gt;&gt;},
                       Parse::RecDescent::_tracefirst&#40;$_[1]&#41;,
                       q{&#39; . $self-&gt;{&#34;name&#34;} .&#39;},
--- 441,447 ----
                &#39;
              : &#39;&#39;&#41; . &#39;
  
!         #$_[1] = $text;  # NOT SURE THIS IS NEEDED
          Parse::RecDescent::_trace&#40;q{&lt;&lt;Didn\&#39;t match rule&gt;&gt;},
                       Parse::RecDescent::_tracefirst&#40;$_[1]&#41;,
                       q{&#39; . $self-&gt;{&#34;name&#34;} .&#39;},
*************** sub code&#40;$$$$&#41;
*** 884,889 ****
--- 884,890 ----
                      if defined $::RD_TRACE;
              last;
          }
+         &#39; . &#40;$self-&gt;{&#34;lookahead&#34;}&lt;0?&#39;$_tok = 0;&#39;:&#39;&#39;&#41; . &#39;
          Parse::RecDescent::_trace&#40;q{&gt;&gt;Matched action&lt;&lt; &#40;return value: [}
                        . $_tok . q{]&#41;},
                        Parse::RecDescent::_tracefirst&#40;$text&#41;&#41;
*************** sub code&#40;$$$$&#41;
*** 947,952 ****
--- 948,954 ----
          &#39; . &#40;$self-&gt;{&#34;lookahead&#34;} ? &#39;$text = $_savetext and &#39; : &#39;&#39; &#41; .&#39;
          last &#39;
          . &#40;$self-&gt;{&#34;lookahead&#34;}&lt;0?&#39;if&#39;:&#39;unless&#39;&#41; . &#39; defined $_tok;
+         &#39; . &#40;$self-&gt;{&#34;lookahead&#34;}&lt;0?&#39;$_tok = 0;&#39;:&#39;&#39;&#41; . &#39;
          push @item, $item{&#39;.$self-&gt;{hashname}.&#39;}=$_tok;
          &#39; . &#40;$self-&gt;{&#34;lookahead&#34;} ? &#39;$text = $_savetext;&#39; : &#39;&#39; &#41; .&#39;
  &#39;
*************** sub code&#40;$$$$&#41;
*** 1376,1381 ****
--- 1378,1384 ----
              $expectation-&gt;failed&#40;&#41;;
              last;
          }
+         &#39; . &#40;$self-&gt;{&#34;lookahead&#34;}&lt;0?&#39;$_tok = 0;&#39;:&#39;#--no look ahead&#39;&#41; . &#39;
          Parse::RecDescent::_trace&#40;q{&gt;&gt;Matched subrule: [&#39;
                      . $self-&gt;{subrule} . &#39;]&lt;&lt; &#40;return value: [}
                      . $_tok . q{]},
*************** sub _generate&#40;$$$;$$&#41;
*** 1940,1946 ****
              my $implicit = $rule-&gt;nextimplicit;
              $self-&gt;_generate&#40;&#34;$implicit : $code&#34;,$replace,1&#41;;
              my $pos = pos $grammar;
!             substr&#40;$grammar,$pos,0,$implicit&#41;;
              pos $grammar = $pos;;
          }
          elsif &#40;$grammar =~ m/$ENDDIRECTIVEMK/gco&#41;
--- 1943,1950 ----
              my $implicit = $rule-&gt;nextimplicit;
              $self-&gt;_generate&#40;&#34;$implicit : $code&#34;,$replace,1&#41;;
              my $pos = pos $grammar;
!             my $lookahead_str = &#40;$lookahead &gt; 0&#41; ? &#39;...&#39; : &#40;$lookahead &lt; 0&#41; ? &#39;...!&#39; : &#39;&#39;;
!             substr&#40;$grammar,$pos,0,$lookahead_str . $implicit&#41;;
              pos $grammar = $pos;;
          }
          elsif &#40;$grammar =~ m/$ENDDIRECTIVEMK/gco&#41;
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
