<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #63768 for DBIx-Class-MooseColumns: Feature Request: Make MooseColumns work with DBIx Components</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #63768 for DBIx-Class-MooseColumns: Feature Request: Make MooseColumns work with DBIx Components</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBIx-Class-MooseColumns/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBIx-Class-MooseColumns/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBIx-Class-MooseColumns/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBIx-Class-MooseColumns/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Class-MooseColumns">DBIx-Class-MooseColumns CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">63768</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBIx-Class-MooseColumns/Active/">DBIx-Class-MooseColumns</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
j.bonte [...] legian.nl

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-233524-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.15    </td>
  </tr>
  <tr id="CF-233525-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;09&nbsp;04:40:05&nbsp;2010</span>
    <span class="description">j.bonte [...] legian.nl -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Feature Request: Make MooseColumns work with DBIx Components</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am experimenting with DBIx-Class-MooseColumns to add the power of
Moose validation to the DBIx storage/retreival facilities.
Initial experiments are promising, but there seems to be a problem with
DBIx::Class components / Moose Roles

It does not appear to be supported.
I will try to explain from a simplified example, which I hope has enough
information.

package MyApp::Component::DateTimeInsert;
use base &#39;DBIx::Class&#39;;
use DateTime;

sub table {
    my &#40; $class, $table &#41; = @_;
    $class-&gt;next::method&#40;$table&#41;;
    $class-&gt;load_components&#40; &#39;DynamicDefault&#39;, &#39;Core&#39;, &#41;;
    $class-&gt;add_columns&#40;
        created_date =&gt; {
            data_type                 =&gt; &#39;datetime&#39;,
            dynamic_default_on_create =&gt; sub { DateTime-&gt;now&#40;&#41;; },
            default_value             =&gt; undef,
        },
    &#41;;
    return;
}

Which is then loaded by the other modules:

__PACKAGE__-&gt;load_components&#40; &#39;+MyApp::Component::DateTimeInsert&#39;,
&#39;UUIDColumns&#39;, &#39;Core&#39;, &#41;;

In a way the DBIx::Class components act like Moose Roles. 
The functionality is inlined into the loading class
This gives a date-time stamp on insertion on every row without any
additional coding. Just load the component in every table that needs it.

I have already verified that I can still load these components from
modules that are using MooseColumns.
Deploying schema to database still works
Accessing the date info still works.

But it does not seem possible to turn the Components into MooseColumns
capable components
e.g. has_created_date

changing the Components code:

package MyApp::Component::DateTimeInsert;
use Moose;
use MooseX::NonMoose;
use namespace::autoclean;

BEGIN {
    use DBIx::Class::MooseColumns;
    extends &#39;DBIx::Class&#39;;
}

use DateTime;
use MooseX::Types::Moose qw&#40;Str&#41;;

sub table {
    my &#40; $class, $table &#41; = @_;
    $class-&gt;next::method&#40;$table&#41;;
    $class-&gt;load_components&#40; &#39;DynamicDefault&#39;, &#39;Core&#39;, &#41;;
    has created_date =&gt; &#40;
        isa        =&gt; Str,
        is         =&gt; &#39;rw&#39;,
        predicate  =&gt; &#39;has_created_date&#39;,
        add_column =&gt; {
            data_type                 =&gt; &#39;datetime&#39;,
            dynamic_default_on_create =&gt; sub { DateTime-&gt;now&#40;&#41;; },
        },
    &#41;;
    return;
}

Gives the following error:

DBIx::Class::Schema::throw_exception&#40;&#41;: Can&#39;t locate object method
&#34;add_column&#34; via package &#34;MyApp::Component::DateTimeInsert&#34; 


The DBIx Components extends &#39;DBIx::Class&#39; But MooseColumns uses extends
&#39;DBIx::Class::Core&#39;

Changing the DBIX Compents to use DBIx::Class::Core instead of
DBIx::Class gives the following

DBIx::Class::Schema::throw_exception&#40;&#41;: Can&#39;t locate object method
&#34;result_source_instance&#34; via package &#34;MyApp::Component::DateTimeInsert&#34; 


Trying to resolve this by using Moose::Role instead of Moose &#40;requires
the removal of &#39;use MooseX::NonMoose&#39;&#41; gives the following:

DBIx::Class::Schema::throw_exception&#40;&#41;:
DBIx::Class::Row::throw_exception&#40;&#41;: MyApp::Component::DateTimeInsert
already has a metaclass, but it does not inherit Moose::Meta::Class
&#40;Moose::Meta::Role=HASH&#40;0xdc69d4&#41;&#41;. You cannot make the same thing a
role and a class. Remove either Moose or Moose::Role


Could support for this be added to DBIx-Class-MooseColumns?
Or a example on how to do this be added to the docs?

Thanks.
If there are any questions please let me know.

Tested against:
DBIx-Class-MooseColumns-0.15
SunOS 5.8 Generic_117350-57 sun4u sparc SUNW,Sun-Fire-V240 Solaris
perl version v5.8.7 

Note: it required some tinkering to install this module.
As the required DBIx::Class::Schema::PopulateMore module requires
version v5.8.8 in the default install.
It appears however that this is only the case as the autor does not have
access to a 5.8.7 system for testin. All tests passes cleanly.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
