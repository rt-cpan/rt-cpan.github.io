<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #98372 for IO-Socket-SSL: Should utf8::downgrade data in syswrite</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #98372 for IO-Socket-SSL: Should utf8::downgrade data in syswrite</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=IO-Socket-SSL">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=IO-Socket-SSL">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=IO-Socket-SSL">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=IO-Socket-SSL">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IO-Socket-SSL">IO-Socket-SSL CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">98372</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=IO-Socket-SSL">IO-Socket-SSL</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
victor [...] vsespb.ru

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
ether [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-17228-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-17229-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




RT98372.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1509959/805060/RT98372.patch">
Fri Jun 19 18:49:26 2015 (2.5k) by leonerd-cpan [...] leonerd.org.uk
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=98372">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1404053" href="/Public/Bug/Display.html?id=98372#txn-1404053">#</a>      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;27&nbsp;18:10:41&nbsp;2014</span>
    <span class="description">victor [...] vsespb.ru -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Should utf8::downgrade data in syswrite</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1404053/745367/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/745367">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 296b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">There is issue in Net::SSLeay <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=98368">https://rt.cpan.org/Ticket/Display.html?id=98368</a></span>
Unfortunately it cannot be fixed.

IO::Socket::SSL::syswrite/write is affected too. i.e. it behaves different way depending on scalar&#39;s UTF-8 flag.
I propose utf8::downgrade input string &#40;in _generic_write probably&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1404334" href="/Public/Bug/Display.html?id=98372#txn-1404334">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;28&nbsp;12:49:22&nbsp;2014</span>
    <span class="description">ether [...] cpan.org -  Cc ETHER added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1404428" href="/Public/Bug/Display.html?id=98372#txn-1404428">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;28&nbsp;16:03:16&nbsp;2014</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1404428/745556/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/745556">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 691b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Mi 27. Aug 2014, 18:10:41, vsespb schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There is issue in Net::SSLeay
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=98368">https://rt.cpan.org/Ticket/Display.html?id=98368</a></span>
&gt; Unfortunately it cannot be fixed.
&gt; 
&gt; IO::Socket::SSL::syswrite/write is affected too. i.e. it behaves
&gt; different way depending on scalar&#39;s UTF-8 flag.
&gt; I propose utf8::downgrade input string &#40;in _generic_write probably&#41;.
</div>
Thanks for reporting the problem, but I think a real fix is more complex.

We cannot simply assume latin1 for output, but there might be a binmode of :utf8 on the file handle. 
In this case one would need to do an utf8 upgrade and not a downgrade and one would need to take care of sysread too. And, because a single utf8 character ca
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1404429" href="/Public/Bug/Display.html?id=98372#txn-1404429">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;28&nbsp;16:03:16&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1404432" href="/Public/Bug/Display.html?id=98372#txn-1404432">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;28&nbsp;16:04:18&nbsp;2014</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1404432/745559/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/745559">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 830b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Mi 27. Aug 2014, 18:10:41, vsespb schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There is issue in Net::SSLeay
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=98368">https://rt.cpan.org/Ticket/Display.html?id=98368</a></span>
&gt; Unfortunately it cannot be fixed.
&gt; 
&gt; IO::Socket::SSL::syswrite/write is affected too. i.e. it behaves
&gt; different way depending on scalar&#39;s UTF-8 flag.
&gt; I propose utf8::downgrade input string &#40;in _generic_write probably&#41;.
</div>
Thanks for reporting the problem, but I think a real fix is more complex.

We cannot simply assume latin1 for output, but there might be a binmode of :utf8 on the file handle. 
In this case one would need to do an utf8 upgrade and not a downgrade and one would need to take care of sysread too. And, because a single utf8 character can spread over multiple octets one would need to handle the cases where read or write stop inside an utf8 character &#40;e.g. needs buffering&#41;. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1509956" href="/Public/Bug/Display.html?id=98372#txn-1509956">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;18:37:22&nbsp;2015</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1509956/805055/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/805055">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 801b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">A regular -&gt;syswrite call on a native &#40;non-SSL&#41; socket handle in Perl always takes bytes, not Unicode characters.

A -&gt;syswrite call on an IO::Socket::SSL seems to be interpreting its input as Unicode characters if the SvUTF8 flag is set on the PV. This is wrong.

I have observed a bug in my client &#40;Net::Async::IRC&#41; that causes double-encoding of UTF-8 over the wire, but only when SSL is enabled. I eventually tracked it down to this problem.

It can easily be worked around at the Perl level by applying  utf8::downgrade  to the byte sequence I pass in to -&gt;syswrite just before I call it.

That *ought* never be necessary, but since it causes a demonstrable change in behaviour here, it indicates that IO::Socket::SSL &#40;or maybe a lower dependency still&#41; is doing the wrong thing.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1509959" href="/Public/Bug/Display.html?id=98372#txn-1509959">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;18:49:26&nbsp;2015</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1509959/805059/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/805059">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 333b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jun 19 18:37:22 2015, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It can easily be worked around at the Perl level by applying
&gt; utf8::downgrade  to the byte sequence I pass in to -&gt;syswrite just
&gt; before I call it.
</div>
The attached patch contains a test case demonstrating the failure, and the trivial oneline fix in IO::Async::SSL&#39;s case.

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RT98372.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1509959/805060/RT98372.patch">Download RT98372.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== modified file &#39;lib/IO/Async/SSL.pm&#39;
--- lib/IO/Async/SSL.pm	2015-05-29 18:53:19 +0000
+++ lib/IO/Async/SSL.pm	2015-06-19 22:48:30 +0000
@@ -117,6 +117,10 @@
    my $stream = shift;
    my &#40; $fh, undef, $len &#41; = @_;
 
+   # Placate RT98372
+   utf8::downgrade&#40; $_[1] &#41; or
+      carp &#34;Wide character in sslwrite&#34;;
+
    my $ret = $stream-&gt;_syswrite&#40; $fh, $_[1], $len &#41;;
 
    my $write_wants_read = !defined $ret &#38;&#38;

=== added file &#39;t/05utf8.t&#39;
--- t/05utf8.t	1970-01-01 00:00:00 +0000
+++ t/05utf8.t	2015-06-19 22:48:30 +0000
@@ -0,0 +1,83 @@
+#!/usr/bin/perl
+
+use strict;
+use warnings;
+use utf8;
+
+use Test::More;
+use Test::Identity;
+
+use IO::Async::Test;
+
+use IO::Async::OS;
+use IO::Async::Loop;
+use IO::Async::SSL;
+use IO::Async::Stream;
+
+use Encode qw&#40; encode_utf8 decode_utf8 &#41;;
+
+my $loop = IO::Async::Loop-&gt;new;
+
+# A message containing non-8859-1 characters as this tests Perl more interestingly
+my $message = &#34;Ã„Âˆu vi Ã„Â‰i tio vidas?&#34;;
+
+sub chomped { chomp&#40; my $tmp = $_[0] &#41;; return $tmp }
+
+testing_loop&#40; $loop &#41;;
+
+{
+   my &#40; $server_sock, $client_sock &#41; = IO::Async::OS-&gt;socketpair or
+      die &#34;Cannot socketpair - $!&#34;;
+
+   $server_sock-&gt;blocking&#40; 0 &#41;;
+   $client_sock-&gt;blocking&#40; 0 &#41;;
+
+   my $server_stream = IO::Async::Stream-&gt;new&#40;
+      handle =&gt; $server_sock,
+      on_read =&gt; sub { 0 },
+   &#41;;
+   $loop-&gt;add&#40; $server_stream &#41;;
+
+   my $client_stream = IO::Async::Stream-&gt;new&#40;
+      handle =&gt; $client_sock,
+      on_read =&gt; sub { 0 },
+   &#41;;
+   $loop-&gt;add&#40; $client_stream &#41;;
+
+   my $server_f = $loop-&gt;SSL_upgrade&#40;
+      handle =&gt; $server_stream,
+      SSL_server =&gt; 1,
+      SSL_key_file  =&gt; &#34;t/privkey.pem&#34;,
+      SSL_cert_file =&gt; &#34;t/server.pem&#34;,
+   &#41;;
+
+   my $client_f = $loop-&gt;SSL_upgrade&#40;
+      handle =&gt; $client_stream,
+      SSL_verify_mode =&gt; 0,
+   &#41;;
+
+   wait_for { $server_f-&gt;is_ready and $client_f-&gt;is_ready };
+
+   # Check that we can pass UTF-8 bytes unmolested
+   my $bytes = encode_utf8&#40; $message &#41;;
+
+   $client_stream-&gt;write&#40; &#34;$bytes\n&#34; &#41;;
+
+   my $read_f = $server_stream-&gt;read_until&#40; &#34;\n&#34; &#41;;
+   wait_for { $read_f-&gt;is_ready };
+   is&#40; decode_utf8&#40; chomped $read_f-&gt;get &#41;, $message,
+      &#39;UTF-8 string unmolested&#39; &#41;;
+
+   # Check further that the bytes remain umolested even if they somehow end
+   # up with the SvUTF8 flag set
+   utf8::upgrade&#40; $bytes &#41;;
+
+   $client_stream-&gt;write&#40; &#34;$bytes\n&#34; &#41;;
+
+   $read_f = $server_stream-&gt;read_until&#40; &#34;\n&#34; &#41;;
+   wait_for { $read_f-&gt;is_ready };
+   is&#40; decode_utf8&#40; chomped $read_f-&gt;get &#41;, $message,
+      &#39;UTF-8 string unmolested even with SvUTF8&#39; &#41;;
+}
+
+done_testing;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1574381" href="/Public/Bug/Display.html?id=98372#txn-1574381">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;18&nbsp;14:04:33&nbsp;2015</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1574381/840654/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/840654">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jun 19 18:49:26 2015, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Jun 19 18:37:22 2015, PEVANS wrote:
<div class="message-stanza open">&gt; &gt; It can easily be worked around at the Perl level by applying
&gt; &gt; utf8::downgrade  to the byte sequence I pass in to -&gt;syswrite just
&gt; &gt; before I call it.
</div>&gt; 
&gt; The attached patch contains a test case demonstrating the failure, and
&gt; the trivial oneline fix in IO::Async::SSL&#39;s case.
</div>
Hi, 
Sorry that it took me such a long time to follow up on your message.

My argument is, that writing on a socket should be done only with bytes and never with
strings, because the underlying layer for sockets works only at the granularity of 
bytes. Any attempt to properly supporting strings will thus conflict with this layer and
might lead to problems. Take the following example:

    my $cl = IO::Socket::INET-&gt;new&#40;&#39;127.0.0.1:1234&#39;&#41; or die $!;
    $cl-&gt;blocking&#40;0&#41;;
    my $buf = &#34;\N{U+20AC}&#34;; # EUR - 3 Byte in UTF-8
    binmode&#40;$cl,&#39;:utf8&#39;&#41;;
    while &#40;1&#41; {
        my $n = syswrite&#40;$cl,$buf&#41; or last;
        print STDERR &#34;&lt;$n&gt;&#34;
    }
 
In this example syswrite will report each time that 1 character is written, but internally
3 bytes are send into the socket buffer. If the server stops receiving data the socket 
buffer will fill up and if we have a bad luck the full 3 bytes from the EUR character will
not fit into the buffer. Since we are non-blocking syswrite will not block but return.

It will return with undef even though maybe 1 of the 2 bytes from the character are written
to the socket buffer. Additionally it will complain because &#34;Malformed UTF-8 character 
&#40;unexpected end of string&#41; in syswrite ...&#34;.
The information how many bytes are written is not known to the application which only sees
that writing the character failed. So if it retries the write later it would start again
with writing the full 3 bytes of the character - which completely messes up the data send
to the server because there is now an incomplete utf-8 character in the data stream.


What you request is that in all cases it should be assumed that the output is latin1, 
i.e. simply utf8::downgrade should be called on each write and consequently utf8::upgrade
must be called on each read. This would be similar to what IO::Socket::INET does, only
that it does not automatically upgrade the output to treat it as latin1 and that it does
the automatic downgrade only if there is no explicit binmode set. 


Like I said, I think that sockets and strings do not match but that sockets must be used
with bytes. Apart from this it would be costly to call utf8::downgrade all the time
for input data which is typically bytes and not strings. 
But you might ask the maintainers of Net::SSLeay if they would add this functionality 
to SSL_write since checking inside the XS code for SvUTF8 has probably only negligible
impact on the performance, compared to doing the same from inside Perl. And since 
IO::Socket::SSL just uses Net::SSLeay for all I/O you would get what you want this way.

Regards,
Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1574384" href="/Public/Bug/Display.html?id=98372#txn-1574384">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;18&nbsp;14:04:35&nbsp;2015</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1575016" href="/Public/Bug/Display.html?id=98372#txn-1575016">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;21&nbsp;11:52:40&nbsp;2015</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1575016/841019/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/841019">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 18 22:04:33 2015, SULLR wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; My argument is, that writing on a socket should be done only with
&gt; bytes and never with
&gt;  strings
</div>
Exactly! I agree.
However I think there is misunderstanding of perl string concept.

In short:
There is &#34;character string&#34; and &#34;byte string&#34;. _both_ can have UTF-8 flag on.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;because the underlying layer for sockets works only at the
&gt; granularity of
&gt; bytes. Any attempt to properly supporting strings will thus conflict
&gt; with this layer and
&gt; might lead to problems. Take the following example:
&gt; 
&gt; my $cl = IO::Socket::INET-&gt;new&#40;&#39;127.0.0.1:1234&#39;&#41; or die $!;
&gt; $cl-&gt;blocking&#40;0&#41;;
&gt; my $buf = &#34;\N{U+20AC}&#34;; # EUR - 3 Byte in UTF-8
&gt; binmode&#40;$cl,&#39;:utf8&#39;&#41;;
&gt; while &#40;1&#41; {
&gt;     my $n = syswrite&#40;$cl,$buf&#41; or last;
&gt;     print STDERR &#34;&lt;$n&gt;&#34;
&gt; }
&gt; 
&gt; In this example syswrite will report each time that 1 character is
&gt; written, but internally
&gt;  3 bytes are send into the socket buffer. If the server stops
&gt; receiving data the socket
&gt; buffer will fill up and if we have a bad luck the full 3 bytes from
&gt; the EUR character will
&gt; not fit into the buffer. Since we are non-blocking syswrite will not
&gt; block but return.
&gt; 
</div>
This example is irrelevant here. It&#39;s about writing character string to socket with encoding specified. And we talk about writing byte string. Forget characters!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It will return with undef even though maybe 1 of the 2 bytes from the
&gt; character are written
&gt;  to the socket buffer. Additionally it will complain because
&gt; &#34;Malformed UTF-8 character
&gt; &#40;unexpected end of string&#41; in syswrite ...&#34;.
&gt; The information how many bytes are written is not known to the
&gt; application which only sees
&gt; that writing the character failed. So if it retries the write later it
&gt; would start again
&gt; with writing the full 3 bytes of the character - which completely
&gt; messes up the data send
&gt; to the server because there is now an incomplete utf-8 character in
&gt; the data stream.
&gt; 
&gt; 
&gt; What you request is that in all cases it should be assumed that the
&gt; output is latin1,
</div>
No, no latin1. Forget characters. We talk about byte strings only.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; i.e. simply utf8::downgrade should be called on each write
</div>
Yes.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; and
&gt; consequently utf8::upgrade
&gt; must be called on each read.
</div>
No.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This would be similar to what
&gt; IO::Socket::INET does, only
&gt; that it does not automatically upgrade the output to treat it as
</div>
Yes, it does not utf8::upgrade, because it would be wrong.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; latin1 and that it does
&gt; the automatic downgrade only if there is no explicit binmode set.
&gt; 
&gt; 
&gt; Like I said, I think that sockets and strings do not match but that
&gt; sockets must be used
&gt; with bytes.
</div>
exactly. but utf8::downgrade should be called.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Apart from this it would be costly to call utf8::downgrade
&gt; all the time
&gt;  for input data which is typically bytes and not strings.
</div>
not really probably. for byte string without utf8 flag it will return immediately, with O&#40;1&#41;, I belived.

for byte string with utf8 flag it will do what it does.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  But you might ask the maintainers of Net::SSLeay if they would add
&gt; this functionality
&gt; to SSL_write since checking inside the XS code for SvUTF8 has probably
&gt; only negligible
&gt;  impact on the performance, compared to doing the same from inside
&gt; Perl. And since
&gt; IO::Socket::SSL just uses Net::SSLeay for all I/O you would get what
&gt; you want this way.
&gt; 
&gt; Regards,
&gt; Steffen
</div>
I am original bug reporter, but I agree with leonerd-cpan@leonerd.org.uk, there should be utf8::downgrade for consistency with perl string model.
And it what Perl does in similar cases.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.497185</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
