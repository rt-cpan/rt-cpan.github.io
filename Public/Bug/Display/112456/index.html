<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #112456 for PDF-API2: xref stream file in 2.026: Can&#39;t call method &#34;elementsof&#34; on an undefined value</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #112456 for PDF-API2: xref stream file in 2.026: Can&#39;t call method &#34;elementsof&#34; on an undefined value</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/PDF-API2/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/PDF-API2">PDF-API2 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">112456</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/PDF-API2/Active/">PDF-API2</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
stu [...] spacehopper.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24958-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24959-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.027    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




xrefstm.bin<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1603231/857529/xrefstm.bin">
Wed Mar 02 23:12:18 2016 (21.1k) by stu [...] spacehopper.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;26&nbsp;10:11:25&nbsp;2016</span>
    <span class="description">stu [...] spacehopper.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> xref stream file in 2.026: Can&#39;t call method &#34;elementsof&#34; on an undefined value</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 26 Feb 2016 15:10:46 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Stuart Henderson &lt;stu [...] spacehopper.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m running PDF::API2 2.026 on perl 5.20.2 on OpenBSD. I have some
awkward input files with xref streams which I&#39;ve been pre-processing
with mutool clean to get them into a format usable with PDF::API2,
but thought I&#39;d try them directly using the new xref stream support.

Some such files now seem to be working OK but I have one that fails
at open - if I do this:

use PDF::API2;
my $pdf = PDF::API2-&gt;open&#40;&#39;letter.pdf&#39;&#41;;

I get:

Can&#39;t call method &#34;elementsof&#34; on an undefined value at /usr/local/libdata/perl5/site_perl/PDF/API2.pm line 870.

Tracing it back, in open_scalar, this is returning undef:

    $self-&gt;{&#39;pages&#39;} = $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;{&#39;Pages&#39;}-&gt;realise&#40;&#41;;

My knowledge of perl OO and the PDF::API2 code is limited so I&#39;m not
sure where to go next, can you give me any pointers to help track
it down further please?

Unfortunately I can&#39;t make the file itself available.

A bit more information about the file:

$ pdfinfo file.pdf
Title:          &lt;redacted&gt;
Author:         Compiled Xerox JDL file.
Creator:        Paris
Producer:       Normalizer demonorm
CreationDate:   Tue Feb 16 08:04:11 2016
ModDate:        Tue Feb 16 09:38:37 2016
Tagged:         no
UserProperties: no
Suspects:       no
Form:           none
JavaScript:     no
Pages:          7276
Encrypted:      no
Page size:      595 x 842 pts &#40;A4&#41;
Page rot:       0
File size:      9422943 bytes
Optimized:      yes
PDF version:    1.6

I have other files generated by approximately the same procedure
&#40;certainly the same Producer etc&#41; which I am now able to open
with 2.026.

Thanks,
Stuart
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;27&nbsp;17:12:51&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Can&#39;t call method &#34;elementsof&#34; on an undefined value</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Are you able to send the file to me privately?  If so, that will let me help you troubleshoot the problem and figure out if it&#39;s a problem with PDF::API2 or a problem with the PDF file not following the spec &#40;which may or may not be something that I can have the module work around&#41;.

If not, the problem would seem to be that the PDF has a Pages dictionary &#40;which contains information about a set of pages&#41; that doesn&#39;t have the required Kids element &#40;which contains an array of Page or Pages nodes&#41;.

At a glance, the problem wouldn&#39;t necessarily be linked to adding support for cross-reference streams &#40;other than it being possible to read that file now&#41;, but anything is possible.

Steve


On Fri Feb 26 10:11:25 2016, stu@spacehopper.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m running PDF::API2 2.026 on perl 5.20.2 on OpenBSD. I have some
&gt; awkward input files with xref streams which I&#39;ve been pre-processing
&gt; with mutool clean to get them into a format usable with PDF::API2,
&gt; but thought I&#39;d try them directly using the new xref stream support.
&gt; 
&gt; Some such files now seem to be working OK but I have one that fails
&gt; at open - if I do this:
&gt; 
&gt; use PDF::API2;
&gt; my $pdf = PDF::API2-&gt;open&#40;&#39;letter.pdf&#39;&#41;;
&gt; 
&gt; I get:
&gt; 
&gt; Can&#39;t call method &#34;elementsof&#34; on an undefined value at
&gt; /usr/local/libdata/perl5/site_perl/PDF/API2.pm line 870.
&gt; 
&gt; Tracing it back, in open_scalar, this is returning undef:
&gt; 
&gt; $self-&gt;{&#39;pages&#39;} = $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;{&#39;Pages&#39;}-&gt;realise&#40;&#41;;
&gt; 
&gt; My knowledge of perl OO and the PDF::API2 code is limited so I&#39;m not
&gt; sure where to go next, can you give me any pointers to help track
&gt; it down further please?
&gt; 
&gt; Unfortunately I can&#39;t make the file itself available.
&gt; 
&gt; A bit more information about the file:
&gt; 
&gt; $ pdfinfo file.pdf
&gt; Title:          &lt;redacted&gt;
&gt; Author:         Compiled Xerox JDL file.
&gt; Creator:        Paris
&gt; Producer:       Normalizer demonorm
&gt; CreationDate:   Tue Feb 16 08:04:11 2016
&gt; ModDate:        Tue Feb 16 09:38:37 2016
&gt; Tagged:         no
&gt; UserProperties: no
&gt; Suspects:       no
&gt; Form:           none
&gt; JavaScript:     no
&gt; Pages:          7276
&gt; Encrypted:      no
&gt; Page size:      595 x 842 pts &#40;A4&#41;
&gt; Page rot:       0
&gt; File size:      9422943 bytes
&gt; Optimized:      yes
&gt; PDF version:    1.6
&gt; 
&gt; I have other files generated by approximately the same procedure
&gt; &#40;certainly the same Producer etc&#41; which I am now able to open
&gt; with 2.026.
&gt; 
&gt; Thanks,
&gt; Stuart
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;27&nbsp;17:12:51&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;27&nbsp;17:12:52&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;27&nbsp;20:50:46&nbsp;2016</span>
    <span class="description">stu [...] spacehopper.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #112456] Can&#39;t call method &#34;elementsof&#34; on an undefined value</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 28 Feb 2016 01:50:11 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Steve Simms via RT &lt;bug-PDF-API2 [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Stuart Henderson &lt;stu [...] spacehopper.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for looking into this Steve. Good point that it&#39;s not necessarily
linked to cross-reference stream support, sorry I should have thought of
that possibility.

I have a couple of dozen files generated in the same way and having now
checked all of them this is the only one with this error. Unfortunately
they are from a print job for a fairly sensitive mailing from a 3rd
party that I&#39;m doing some processing on and, much as I&#39;d like to,
I really can&#39;t share them.

If I add &#39;use Data::Dumper;&#39; and &#39;print Dumper&#40;$self-&gt;{&#39;pages&#39;}&#41;;&#39;
after line 200 of PDF/API2.pm, i.e.

    198     $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;realise&#40;&#41;;
    199     $self-&gt;{&#39;pages&#39;} = $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;{&#39;Pages&#39;}-&gt;realise&#40;&#41;;
    200     $self-&gt;{&#39;pdf&#39;}-&gt;{&#39; version&#39;} ||= 3;
    201     use Data::Dumper;
-&gt;  202     print Dumper&#40;$self-&gt;{&#39;pages&#39;}&#41;;
    203     my @pages = proc_pages&#40;$self-&gt;{&#39;pdf&#39;}, $self-&gt;{&#39;pages&#39;}&#41;;
    204     $self-&gt;{&#39;pagestack&#39;} = [sort { $a-&gt;{&#39; pnum&#39;} &lt;=&gt; $b-&gt;{&#39; pnum&#39;} } @pages];
    205     $self-&gt;{&#39;catalog&#39;} = $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;};
    206     $self-&gt;{&#39;reopened&#39;} = 1;

for the working files the structure is dumped, but for this broken one
I get &#39;$VAR1 = undef;&#39;, that&#39;s what I meant by &#34;Tracing it back, in
open_scalar, this is returning undef: $self-&gt;{&#39;pages&#39;} = [...]&#34;,
so it doesn&#39;t seem like lack of a Kids element, rather that the
Pages dictionaries aren&#39;t getting processed correctly, but I&#39;m not
sure which code is responsible for {&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;{&#39;Pages&#39;}-&gt;realise&#40;&#41;
otherwise I would have looked there as well to look for differences
between the problem file and the working ones.

Also looking at all of the objects with &#34;mutool show&#34; and grepping for
any mentioning /Pages without /Kids, I don&#39;t see any problems, I also
had a look through with &#34;itext rups&#34; which was also happy with the
file and I didn&#39;t spot any unusual Pages dictionaries. &#40;there it
looks like <span class="clickylink"><a target="new" rel="nofollow" href="http://junkpile.org/pdfstructure-112456-1.png">http://junkpile.org/pdfstructure-112456-1.png</a></span>, basic
file structure is a couple of levels of Pages, each of them having
a Kids element with usually 10 entries, with Page at the deepest
level&#41;.

Stuart


On 2016/02/27 17:12, Steve Simms via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=112456">https://rt.cpan.org/Ticket/Display.html?id=112456</a></span> &gt;
&gt; 
&gt; Are you able to send the file to me privately?  If so, that will let me help you troubleshoot the problem and figure out if it&#39;s a problem with PDF::API2 or a problem with the PDF file not following the spec &#40;which may or may not be something that I can have the module work around&#41;.
&gt; 
&gt; If not, the problem would seem to be that the PDF has a Pages dictionary &#40;which contains information about a set of pages&#41; that doesn&#39;t have the required Kids element &#40;which contains an array of Page or Pages nodes&#41;.
&gt; 
&gt; At a glance, the problem wouldn&#39;t necessarily be linked to adding support for cross-reference streams &#40;other than it being possible to read that file now&#41;, but anything is possible.
&gt; 
&gt; Steve
&gt; 
&gt; 
&gt; On Fri Feb 26 10:11:25 2016, stu@spacehopper.org wrote:
<div class="message-stanza open">&gt; &gt; I&#39;m running PDF::API2 2.026 on perl 5.20.2 on OpenBSD. I have some
&gt; &gt; awkward input files with xref streams which I&#39;ve been pre-processing
&gt; &gt; with mutool clean to get them into a format usable with PDF::API2,
&gt; &gt; but thought I&#39;d try them directly using the new xref stream support.
&gt; &gt; 
&gt; &gt; Some such files now seem to be working OK but I have one that fails
&gt; &gt; at open - if I do this:
&gt; &gt; 
&gt; &gt; use PDF::API2;
&gt; &gt; my $pdf = PDF::API2-&gt;open&#40;&#39;letter.pdf&#39;&#41;;
&gt; &gt; 
&gt; &gt; I get:
&gt; &gt; 
&gt; &gt; Can&#39;t call method &#34;elementsof&#34; on an undefined value at
&gt; &gt; /usr/local/libdata/perl5/site_perl/PDF/API2.pm line 870.
&gt; &gt; 
&gt; &gt; Tracing it back, in open_scalar, this is returning undef:
&gt; &gt; 
&gt; &gt; $self-&gt;{&#39;pages&#39;} = $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;{&#39;Pages&#39;}-&gt;realise&#40;&#41;;
&gt; &gt; 
&gt; &gt; My knowledge of perl OO and the PDF::API2 code is limited so I&#39;m not
&gt; &gt; sure where to go next, can you give me any pointers to help track
&gt; &gt; it down further please?
&gt; &gt; 
&gt; &gt; Unfortunately I can&#39;t make the file itself available.
&gt; &gt; 
&gt; &gt; A bit more information about the file:
&gt; &gt; 
&gt; &gt; $ pdfinfo file.pdf
&gt; &gt; Title:          &lt;redacted&gt;
&gt; &gt; Author:         Compiled Xerox JDL file.
&gt; &gt; Creator:        Paris
&gt; &gt; Producer:       Normalizer demonorm
&gt; &gt; CreationDate:   Tue Feb 16 08:04:11 2016
&gt; &gt; ModDate:        Tue Feb 16 09:38:37 2016
&gt; &gt; Tagged:         no
&gt; &gt; UserProperties: no
&gt; &gt; Suspects:       no
&gt; &gt; Form:           none
&gt; &gt; JavaScript:     no
&gt; &gt; Pages:          7276
&gt; &gt; Encrypted:      no
&gt; &gt; Page size:      595 x 842 pts &#40;A4&#41;
&gt; &gt; Page rot:       0
&gt; &gt; File size:      9422943 bytes
&gt; &gt; Optimized:      yes
&gt; &gt; PDF version:    1.6
&gt; &gt; 
&gt; &gt; I have other files generated by approximately the same procedure
&gt; &gt; &#40;certainly the same Producer etc&#41; which I am now able to open
&gt; &gt; with 2.026.
&gt; &gt; 
&gt; &gt; Thanks,
&gt; &gt; Stuart
</div>&gt; 
&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;27&nbsp;20:50:47&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;15:55:55&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Try commenting out line 492 in lib/PDF/API2/Basic/PDF/File.pm:

$result-&gt;{&#39; streamloc&#39;}-- if $fh-&gt;eof;

Does that let you open the file?


On Sat Feb 27 20:50:46 2016, stu@spacehopper.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for looking into this Steve. Good point that it&#39;s not
&gt; necessarily
&gt; linked to cross-reference stream support, sorry I should have thought
&gt; of
&gt; that possibility.
&gt; 
&gt; I have a couple of dozen files generated in the same way and having
&gt; now
&gt; checked all of them this is the only one with this error.
&gt; Unfortunately
&gt; they are from a print job for a fairly sensitive mailing from a 3rd
&gt; party that I&#39;m doing some processing on and, much as I&#39;d like to,
&gt; I really can&#39;t share them.
&gt; 
&gt; If I add &#39;use Data::Dumper;&#39; and &#39;print Dumper&#40;$self-&gt;{&#39;pages&#39;}&#41;;&#39;
&gt; after line 200 of PDF/API2.pm, i.e.
&gt; 
&gt; 198     $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;realise&#40;&#41;;
&gt; 199     $self-&gt;{&#39;pages&#39;} = $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;{&#39;Pages&#39;}-
<div class="message-stanza open">&gt; &gt;realise&#40;&#41;;
</div>&gt; 200     $self-&gt;{&#39;pdf&#39;}-&gt;{&#39; version&#39;} ||= 3;
&gt; 201     use Data::Dumper;
&gt; -&gt;  202     print Dumper&#40;$self-&gt;{&#39;pages&#39;}&#41;;
&gt; 203     my @pages = proc_pages&#40;$self-&gt;{&#39;pdf&#39;}, $self-&gt;{&#39;pages&#39;}&#41;;
&gt; 204     $self-&gt;{&#39;pagestack&#39;} = [sort { $a-&gt;{&#39; pnum&#39;} &lt;=&gt; $b-&gt;{&#39; pnum&#39;}
&gt; } @pages];
&gt; 205     $self-&gt;{&#39;catalog&#39;} = $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;};
&gt; 206     $self-&gt;{&#39;reopened&#39;} = 1;
&gt; 
&gt; for the working files the structure is dumped, but for this broken one
&gt; I get &#39;$VAR1 = undef;&#39;, that&#39;s what I meant by &#34;Tracing it back, in
&gt; open_scalar, this is returning undef: $self-&gt;{&#39;pages&#39;} = [...]&#34;,
&gt; so it doesn&#39;t seem like lack of a Kids element, rather that the
&gt; Pages dictionaries aren&#39;t getting processed correctly, but I&#39;m not
&gt; sure which code is responsible for {&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;{&#39;Pages&#39;}-
<div class="message-stanza open">&gt; &gt;realise&#40;&#41;
</div>&gt; otherwise I would have looked there as well to look for differences
&gt; between the problem file and the working ones.
&gt; 
&gt; Also looking at all of the objects with &#34;mutool show&#34; and grepping for
&gt; any mentioning /Pages without /Kids, I don&#39;t see any problems, I also
&gt; had a look through with &#34;itext rups&#34; which was also happy with the
&gt; file and I didn&#39;t spot any unusual Pages dictionaries. &#40;there it
&gt; looks like <span class="clickylink"><a target="new" rel="nofollow" href="http://junkpile.org/pdfstructure-112456-1.png">http://junkpile.org/pdfstructure-112456-1.png</a></span>, basic
&gt; file structure is a couple of levels of Pages, each of them having
&gt; a Kids element with usually 10 entries, with Page at the deepest
&gt; level&#41;.
&gt; 
&gt; Stuart
&gt; 
&gt; 
&gt; On 2016/02/27 17:12, Steve Simms via RT wrote:
<div class="message-stanza open">&gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=112456">https://rt.cpan.org/Ticket/Display.html?id=112456</a></span> &gt;
&gt; &gt;
&gt; &gt; Are you able to send the file to me privately?  If so, that will let
&gt; &gt; me help you troubleshoot the problem and figure out if it&#39;s a problem
&gt; &gt; with PDF::API2 or a problem with the PDF file not following the spec
&gt; &gt; &#40;which may or may not be something that I can have the module work
&gt; &gt; around&#41;.
&gt; &gt;
&gt; &gt; If not, the problem would seem to be that the PDF has a Pages
&gt; &gt; dictionary &#40;which contains information about a set of pages&#41; that
&gt; &gt; doesn&#39;t have the required Kids element &#40;which contains an array of
&gt; &gt; Page or Pages nodes&#41;.
&gt; &gt;
&gt; &gt; At a glance, the problem wouldn&#39;t necessarily be linked to adding
&gt; &gt; support for cross-reference streams &#40;other than it being possible to
&gt; &gt; read that file now&#41;, but anything is possible.
&gt; &gt;
&gt; &gt; Steve
&gt; &gt;
&gt; &gt;
&gt; &gt; On Fri Feb 26 10:11:25 2016, stu@spacehopper.org wrote:
<div class="message-stanza open">&gt; &gt; &gt; I&#39;m running PDF::API2 2.026 on perl 5.20.2 on OpenBSD. I have some
&gt; &gt; &gt; awkward input files with xref streams which I&#39;ve been pre-
&gt; &gt; &gt; processing
&gt; &gt; &gt; with mutool clean to get them into a format usable with PDF::API2,
&gt; &gt; &gt; but thought I&#39;d try them directly using the new xref stream
&gt; &gt; &gt; support.
&gt; &gt; &gt;
&gt; &gt; &gt; Some such files now seem to be working OK but I have one that fails
&gt; &gt; &gt; at open - if I do this:
&gt; &gt; &gt;
&gt; &gt; &gt; use PDF::API2;
&gt; &gt; &gt; my $pdf = PDF::API2-&gt;open&#40;&#39;letter.pdf&#39;&#41;;
&gt; &gt; &gt;
&gt; &gt; &gt; I get:
&gt; &gt; &gt;
&gt; &gt; &gt; Can&#39;t call method &#34;elementsof&#34; on an undefined value at
&gt; &gt; &gt; /usr/local/libdata/perl5/site_perl/PDF/API2.pm line 870.
&gt; &gt; &gt;
&gt; &gt; &gt; Tracing it back, in open_scalar, this is returning undef:
&gt; &gt; &gt;
&gt; &gt; &gt; $self-&gt;{&#39;pages&#39;} = $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;{&#39;Pages&#39;}-&gt;realise&#40;&#41;;
&gt; &gt; &gt;
&gt; &gt; &gt; My knowledge of perl OO and the PDF::API2 code is limited so I&#39;m
&gt; &gt; &gt; not
&gt; &gt; &gt; sure where to go next, can you give me any pointers to help track
&gt; &gt; &gt; it down further please?
&gt; &gt; &gt;
&gt; &gt; &gt; Unfortunately I can&#39;t make the file itself available.
&gt; &gt; &gt;
&gt; &gt; &gt; A bit more information about the file:
&gt; &gt; &gt;
&gt; &gt; &gt; $ pdfinfo file.pdf
&gt; &gt; &gt; Title:          &lt;redacted&gt;
&gt; &gt; &gt; Author:         Compiled Xerox JDL file.
&gt; &gt; &gt; Creator:        Paris
&gt; &gt; &gt; Producer:       Normalizer demonorm
&gt; &gt; &gt; CreationDate:   Tue Feb 16 08:04:11 2016
&gt; &gt; &gt; ModDate:        Tue Feb 16 09:38:37 2016
&gt; &gt; &gt; Tagged:         no
&gt; &gt; &gt; UserProperties: no
&gt; &gt; &gt; Suspects:       no
&gt; &gt; &gt; Form:           none
&gt; &gt; &gt; JavaScript:     no
&gt; &gt; &gt; Pages:          7276
&gt; &gt; &gt; Encrypted:      no
&gt; &gt; &gt; Page size:      595 x 842 pts &#40;A4&#41;
&gt; &gt; &gt; Page rot:       0
&gt; &gt; &gt; File size:      9422943 bytes
&gt; &gt; &gt; Optimized:      yes
&gt; &gt; &gt; PDF version:    1.6
&gt; &gt; &gt;
&gt; &gt; &gt; I have other files generated by approximately the same procedure
&gt; &gt; &gt; &#40;certainly the same Producer etc&#41; which I am now able to open
&gt; &gt; &gt; with 2.026.
&gt; &gt; &gt;
&gt; &gt; &gt; Thanks,
&gt; &gt; &gt; Stuart
</div>&gt; &gt;
&gt; &gt;
&gt; &gt;
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;16:14:56&nbsp;2016</span>
    <span class="description">stu [...] spacehopper.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #112456] xref stream file in 2.026: Can&#39;t call method &#34;elementsof&#34; on an undefined value</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 2 Mar 2016 21:14:09 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Steve Simms via RT &lt;bug-PDF-API2 [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Stuart Henderson &lt;stu [...] spacehopper.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2016/03/02 15:56, Steve Simms via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=112456">https://rt.cpan.org/Ticket/Display.html?id=112456</a></span> &gt;
&gt; 
&gt; Try commenting out line 492 in lib/PDF/API2/Basic/PDF/File.pm:
&gt; 
&gt; $result-&gt;{&#39; streamloc&#39;}-- if $fh-&gt;eof;
&gt; 
&gt; Does that let you open the file?
</div>
No change with this.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;16:30:11&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">You may also need to change line 1147 from:

            @index = &#40;0, $tdict-&gt;{Size}-&gt;val - 1&#41;;

to

            @index = &#40;0, $tdict-&gt;{Size}-&gt;val&#41;;

The last entry in a cross reference table is getting skipped when Index isn&#39;t present.


On Wed Mar 02 15:55:55 2016, SSIMMS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Try commenting out line 492 in lib/PDF/API2/Basic/PDF/File.pm:
&gt; 
&gt; $result-&gt;{&#39; streamloc&#39;}-- if $fh-&gt;eof;
&gt; 
&gt; Does that let you open the file?
&gt; 
&gt; 
&gt; On Sat Feb 27 20:50:46 2016, stu@spacehopper.org wrote:
<div class="message-stanza open">&gt; &gt; Thanks for looking into this Steve. Good point that it&#39;s not
&gt; &gt; necessarily
&gt; &gt; linked to cross-reference stream support, sorry I should have thought
&gt; &gt; of
&gt; &gt; that possibility.
&gt; &gt; 
&gt; &gt; I have a couple of dozen files generated in the same way and having
&gt; &gt; now
&gt; &gt; checked all of them this is the only one with this error.
&gt; &gt; Unfortunately
&gt; &gt; they are from a print job for a fairly sensitive mailing from a 3rd
&gt; &gt; party that I&#39;m doing some processing on and, much as I&#39;d like to,
&gt; &gt; I really can&#39;t share them.
&gt; &gt; 
&gt; &gt; If I add &#39;use Data::Dumper;&#39; and &#39;print Dumper&#40;$self-&gt;{&#39;pages&#39;}&#41;;&#39;
&gt; &gt; after line 200 of PDF/API2.pm, i.e.
&gt; &gt; 
&gt; &gt; 198     $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;realise&#40;&#41;;
&gt; &gt; 199     $self-&gt;{&#39;pages&#39;} = $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;{&#39;Pages&#39;}-
<div class="message-stanza open">&gt; &gt; &gt;realise&#40;&#41;;
</div>&gt; &gt; 200     $self-&gt;{&#39;pdf&#39;}-&gt;{&#39; version&#39;} ||= 3;
&gt; &gt; 201     use Data::Dumper;
&gt; &gt; -&gt;  202     print Dumper&#40;$self-&gt;{&#39;pages&#39;}&#41;;
&gt; &gt; 203     my @pages = proc_pages&#40;$self-&gt;{&#39;pdf&#39;}, $self-&gt;{&#39;pages&#39;}&#41;;
&gt; &gt; 204     $self-&gt;{&#39;pagestack&#39;} = [sort { $a-&gt;{&#39; pnum&#39;} &lt;=&gt; $b-&gt;{&#39; pnum&#39;}
&gt; &gt; } @pages];
&gt; &gt; 205     $self-&gt;{&#39;catalog&#39;} = $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;};
&gt; &gt; 206     $self-&gt;{&#39;reopened&#39;} = 1;
&gt; &gt; 
&gt; &gt; for the working files the structure is dumped, but for this broken one
&gt; &gt; I get &#39;$VAR1 = undef;&#39;, that&#39;s what I meant by &#34;Tracing it back, in
&gt; &gt; open_scalar, this is returning undef: $self-&gt;{&#39;pages&#39;} = [...]&#34;,
&gt; &gt; so it doesn&#39;t seem like lack of a Kids element, rather that the
&gt; &gt; Pages dictionaries aren&#39;t getting processed correctly, but I&#39;m not
&gt; &gt; sure which code is responsible for {&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;{&#39;Pages&#39;}-
<div class="message-stanza open">&gt; &gt; &gt;realise&#40;&#41;
</div>&gt; &gt; otherwise I would have looked there as well to look for differences
&gt; &gt; between the problem file and the working ones.
&gt; &gt; 
&gt; &gt; Also looking at all of the objects with &#34;mutool show&#34; and grepping for
&gt; &gt; any mentioning /Pages without /Kids, I don&#39;t see any problems, I also
&gt; &gt; had a look through with &#34;itext rups&#34; which was also happy with the
&gt; &gt; file and I didn&#39;t spot any unusual Pages dictionaries. &#40;there it
&gt; &gt; looks like <span class="clickylink"><a target="new" rel="nofollow" href="http://junkpile.org/pdfstructure-112456-1.png">http://junkpile.org/pdfstructure-112456-1.png</a></span>, basic
&gt; &gt; file structure is a couple of levels of Pages, each of them having
&gt; &gt; a Kids element with usually 10 entries, with Page at the deepest
&gt; &gt; level&#41;.
&gt; &gt; 
&gt; &gt; Stuart
&gt; &gt; 
&gt; &gt; 
&gt; &gt; On 2016/02/27 17:12, Steve Simms via RT wrote:
<div class="message-stanza open">&gt; &gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=112456">https://rt.cpan.org/Ticket/Display.html?id=112456</a></span> &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; Are you able to send the file to me privately?  If so, that will let
&gt; &gt; &gt; me help you troubleshoot the problem and figure out if it&#39;s a problem
&gt; &gt; &gt; with PDF::API2 or a problem with the PDF file not following the spec
&gt; &gt; &gt; &#40;which may or may not be something that I can have the module work
&gt; &gt; &gt; around&#41;.
&gt; &gt; &gt;
&gt; &gt; &gt; If not, the problem would seem to be that the PDF has a Pages
&gt; &gt; &gt; dictionary &#40;which contains information about a set of pages&#41; that
&gt; &gt; &gt; doesn&#39;t have the required Kids element &#40;which contains an array of
&gt; &gt; &gt; Page or Pages nodes&#41;.
&gt; &gt; &gt;
&gt; &gt; &gt; At a glance, the problem wouldn&#39;t necessarily be linked to adding
&gt; &gt; &gt; support for cross-reference streams &#40;other than it being possible to
&gt; &gt; &gt; read that file now&#41;, but anything is possible.
&gt; &gt; &gt;
&gt; &gt; &gt; Steve
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; On Fri Feb 26 10:11:25 2016, stu@spacehopper.org wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; I&#39;m running PDF::API2 2.026 on perl 5.20.2 on OpenBSD. I have some
&gt; &gt; &gt; &gt; awkward input files with xref streams which I&#39;ve been pre-
&gt; &gt; &gt; &gt; processing
&gt; &gt; &gt; &gt; with mutool clean to get them into a format usable with PDF::API2,
&gt; &gt; &gt; &gt; but thought I&#39;d try them directly using the new xref stream
&gt; &gt; &gt; &gt; support.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Some such files now seem to be working OK but I have one that fails
&gt; &gt; &gt; &gt; at open - if I do this:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; use PDF::API2;
&gt; &gt; &gt; &gt; my $pdf = PDF::API2-&gt;open&#40;&#39;letter.pdf&#39;&#41;;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; I get:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Can&#39;t call method &#34;elementsof&#34; on an undefined value at
&gt; &gt; &gt; &gt; /usr/local/libdata/perl5/site_perl/PDF/API2.pm line 870.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Tracing it back, in open_scalar, this is returning undef:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; $self-&gt;{&#39;pages&#39;} = $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;{&#39;Pages&#39;}-&gt;realise&#40;&#41;;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; My knowledge of perl OO and the PDF::API2 code is limited so I&#39;m
&gt; &gt; &gt; &gt; not
&gt; &gt; &gt; &gt; sure where to go next, can you give me any pointers to help track
&gt; &gt; &gt; &gt; it down further please?
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Unfortunately I can&#39;t make the file itself available.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; A bit more information about the file:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; $ pdfinfo file.pdf
&gt; &gt; &gt; &gt; Title:          &lt;redacted&gt;
&gt; &gt; &gt; &gt; Author:         Compiled Xerox JDL file.
&gt; &gt; &gt; &gt; Creator:        Paris
&gt; &gt; &gt; &gt; Producer:       Normalizer demonorm
&gt; &gt; &gt; &gt; CreationDate:   Tue Feb 16 08:04:11 2016
&gt; &gt; &gt; &gt; ModDate:        Tue Feb 16 09:38:37 2016
&gt; &gt; &gt; &gt; Tagged:         no
&gt; &gt; &gt; &gt; UserProperties: no
&gt; &gt; &gt; &gt; Suspects:       no
&gt; &gt; &gt; &gt; Form:           none
&gt; &gt; &gt; &gt; JavaScript:     no
&gt; &gt; &gt; &gt; Pages:          7276
&gt; &gt; &gt; &gt; Encrypted:      no
&gt; &gt; &gt; &gt; Page size:      595 x 842 pts &#40;A4&#41;
&gt; &gt; &gt; &gt; Page rot:       0
&gt; &gt; &gt; &gt; File size:      9422943 bytes
&gt; &gt; &gt; &gt; Optimized:      yes
&gt; &gt; &gt; &gt; PDF version:    1.6
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; I have other files generated by approximately the same procedure
&gt; &gt; &gt; &gt; &#40;certainly the same Producer etc&#41; which I am now able to open
&gt; &gt; &gt; &gt; with 2.026.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Thanks,
&gt; &gt; &gt; &gt; Stuart
</div>&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt;
</div></div>&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;16:33:10&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">And one more fix -- change line 1132 from:

        $tdict-&gt;read_stream&#40;&#41;;

to

        $tdict-&gt;read_stream&#40;1&#41;;

Given the number of pages in your file, the stream may be large enough that it got output to a file rather than staying in memory.  Adding &#34;1&#34; forces the stream to be read into memory, which is what the subsequent code assumes.

On Wed Mar 02 16:30:11 2016, SSIMMS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You may also need to change line 1147 from:
&gt; 
&gt; @index = &#40;0, $tdict-&gt;{Size}-&gt;val - 1&#41;;
&gt; 
&gt; to
&gt; 
&gt; @index = &#40;0, $tdict-&gt;{Size}-&gt;val&#41;;
&gt; 
&gt; The last entry in a cross reference table is getting skipped when
&gt; Index isn&#39;t present.
&gt; 
&gt; 
&gt; On Wed Mar 02 15:55:55 2016, SSIMMS wrote:
<div class="message-stanza open">&gt; &gt; Try commenting out line 492 in lib/PDF/API2/Basic/PDF/File.pm:
&gt; &gt;
&gt; &gt; $result-&gt;{&#39; streamloc&#39;}-- if $fh-&gt;eof;
&gt; &gt;
&gt; &gt; Does that let you open the file?
&gt; &gt;
&gt; &gt;
&gt; &gt; On Sat Feb 27 20:50:46 2016, stu@spacehopper.org wrote:
<div class="message-stanza open">&gt; &gt; &gt; Thanks for looking into this Steve. Good point that it&#39;s not
&gt; &gt; &gt; necessarily
&gt; &gt; &gt; linked to cross-reference stream support, sorry I should have
&gt; &gt; &gt; thought
&gt; &gt; &gt; of
&gt; &gt; &gt; that possibility.
&gt; &gt; &gt;
&gt; &gt; &gt; I have a couple of dozen files generated in the same way and having
&gt; &gt; &gt; now
&gt; &gt; &gt; checked all of them this is the only one with this error.
&gt; &gt; &gt; Unfortunately
&gt; &gt; &gt; they are from a print job for a fairly sensitive mailing from a 3rd
&gt; &gt; &gt; party that I&#39;m doing some processing on and, much as I&#39;d like to,
&gt; &gt; &gt; I really can&#39;t share them.
&gt; &gt; &gt;
&gt; &gt; &gt; If I add &#39;use Data::Dumper;&#39; and &#39;print Dumper&#40;$self-&gt;{&#39;pages&#39;}&#41;;&#39;
&gt; &gt; &gt; after line 200 of PDF/API2.pm, i.e.
&gt; &gt; &gt;
&gt; &gt; &gt; 198     $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;realise&#40;&#41;;
&gt; &gt; &gt; 199     $self-&gt;{&#39;pages&#39;} = $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;{&#39;Pages&#39;}-
<div class="message-stanza open">&gt; &gt; &gt; &gt; realise&#40;&#41;;
</div>&gt; &gt; &gt; 200     $self-&gt;{&#39;pdf&#39;}-&gt;{&#39; version&#39;} ||= 3;
&gt; &gt; &gt; 201     use Data::Dumper;
&gt; &gt; &gt; -&gt;  202     print Dumper&#40;$self-&gt;{&#39;pages&#39;}&#41;;
&gt; &gt; &gt; 203     my @pages = proc_pages&#40;$self-&gt;{&#39;pdf&#39;}, $self-&gt;{&#39;pages&#39;}&#41;;
&gt; &gt; &gt; 204     $self-&gt;{&#39;pagestack&#39;} = [sort { $a-&gt;{&#39; pnum&#39;} &lt;=&gt; $b-&gt;{&#39;
&gt; &gt; &gt; pnum&#39;}
&gt; &gt; &gt; } @pages];
&gt; &gt; &gt; 205     $self-&gt;{&#39;catalog&#39;} = $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;};
&gt; &gt; &gt; 206     $self-&gt;{&#39;reopened&#39;} = 1;
&gt; &gt; &gt;
&gt; &gt; &gt; for the working files the structure is dumped, but for this broken
&gt; &gt; &gt; one
&gt; &gt; &gt; I get &#39;$VAR1 = undef;&#39;, that&#39;s what I meant by &#34;Tracing it back, in
&gt; &gt; &gt; open_scalar, this is returning undef: $self-&gt;{&#39;pages&#39;} = [...]&#34;,
&gt; &gt; &gt; so it doesn&#39;t seem like lack of a Kids element, rather that the
&gt; &gt; &gt; Pages dictionaries aren&#39;t getting processed correctly, but I&#39;m not
&gt; &gt; &gt; sure which code is responsible for {&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;{&#39;Pages&#39;}-
<div class="message-stanza open">&gt; &gt; &gt; &gt; realise&#40;&#41;
</div>&gt; &gt; &gt; otherwise I would have looked there as well to look for differences
&gt; &gt; &gt; between the problem file and the working ones.
&gt; &gt; &gt;
&gt; &gt; &gt; Also looking at all of the objects with &#34;mutool show&#34; and grepping
&gt; &gt; &gt; for
&gt; &gt; &gt; any mentioning /Pages without /Kids, I don&#39;t see any problems, I
&gt; &gt; &gt; also
&gt; &gt; &gt; had a look through with &#34;itext rups&#34; which was also happy with the
&gt; &gt; &gt; file and I didn&#39;t spot any unusual Pages dictionaries. &#40;there it
&gt; &gt; &gt; looks like <span class="clickylink"><a target="new" rel="nofollow" href="http://junkpile.org/pdfstructure-112456-1.png">http://junkpile.org/pdfstructure-112456-1.png</a></span>, basic
&gt; &gt; &gt; file structure is a couple of levels of Pages, each of them having
&gt; &gt; &gt; a Kids element with usually 10 entries, with Page at the deepest
&gt; &gt; &gt; level&#41;.
&gt; &gt; &gt;
&gt; &gt; &gt; Stuart
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; On 2016/02/27 17:12, Steve Simms via RT wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=112456">https://rt.cpan.org/Ticket/Display.html?id=112456</a></span> &gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Are you able to send the file to me privately?  If so, that will
&gt; &gt; &gt; &gt; let
&gt; &gt; &gt; &gt; me help you troubleshoot the problem and figure out if it&#39;s a
&gt; &gt; &gt; &gt; problem
&gt; &gt; &gt; &gt; with PDF::API2 or a problem with the PDF file not following the
&gt; &gt; &gt; &gt; spec
&gt; &gt; &gt; &gt; &#40;which may or may not be something that I can have the module
&gt; &gt; &gt; &gt; work
&gt; &gt; &gt; &gt; around&#41;.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; If not, the problem would seem to be that the PDF has a Pages
&gt; &gt; &gt; &gt; dictionary &#40;which contains information about a set of pages&#41; that
&gt; &gt; &gt; &gt; doesn&#39;t have the required Kids element &#40;which contains an array
&gt; &gt; &gt; &gt; of
&gt; &gt; &gt; &gt; Page or Pages nodes&#41;.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; At a glance, the problem wouldn&#39;t necessarily be linked to adding
&gt; &gt; &gt; &gt; support for cross-reference streams &#40;other than it being possible
&gt; &gt; &gt; &gt; to
&gt; &gt; &gt; &gt; read that file now&#41;, but anything is possible.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Steve
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; On Fri Feb 26 10:11:25 2016, stu@spacehopper.org wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; I&#39;m running PDF::API2 2.026 on perl 5.20.2 on OpenBSD. I have
&gt; &gt; &gt; &gt; &gt; some
&gt; &gt; &gt; &gt; &gt; awkward input files with xref streams which I&#39;ve been pre-
&gt; &gt; &gt; &gt; &gt; processing
&gt; &gt; &gt; &gt; &gt; with mutool clean to get them into a format usable with
&gt; &gt; &gt; &gt; &gt; PDF::API2,
&gt; &gt; &gt; &gt; &gt; but thought I&#39;d try them directly using the new xref stream
&gt; &gt; &gt; &gt; &gt; support.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Some such files now seem to be working OK but I have one that
&gt; &gt; &gt; &gt; &gt; fails
&gt; &gt; &gt; &gt; &gt; at open - if I do this:
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; use PDF::API2;
&gt; &gt; &gt; &gt; &gt; my $pdf = PDF::API2-&gt;open&#40;&#39;letter.pdf&#39;&#41;;
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; I get:
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Can&#39;t call method &#34;elementsof&#34; on an undefined value at
&gt; &gt; &gt; &gt; &gt; /usr/local/libdata/perl5/site_perl/PDF/API2.pm line 870.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Tracing it back, in open_scalar, this is returning undef:
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; $self-&gt;{&#39;pages&#39;} = $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;{&#39;Pages&#39;}-
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt;realise&#40;&#41;;
</div>&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; My knowledge of perl OO and the PDF::API2 code is limited so
&gt; &gt; &gt; &gt; &gt; I&#39;m
&gt; &gt; &gt; &gt; &gt; not
&gt; &gt; &gt; &gt; &gt; sure where to go next, can you give me any pointers to help
&gt; &gt; &gt; &gt; &gt; track
&gt; &gt; &gt; &gt; &gt; it down further please?
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Unfortunately I can&#39;t make the file itself available.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; A bit more information about the file:
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; $ pdfinfo file.pdf
&gt; &gt; &gt; &gt; &gt; Title:          &lt;redacted&gt;
&gt; &gt; &gt; &gt; &gt; Author:         Compiled Xerox JDL file.
&gt; &gt; &gt; &gt; &gt; Creator:        Paris
&gt; &gt; &gt; &gt; &gt; Producer:       Normalizer demonorm
&gt; &gt; &gt; &gt; &gt; CreationDate:   Tue Feb 16 08:04:11 2016
&gt; &gt; &gt; &gt; &gt; ModDate:        Tue Feb 16 09:38:37 2016
&gt; &gt; &gt; &gt; &gt; Tagged:         no
&gt; &gt; &gt; &gt; &gt; UserProperties: no
&gt; &gt; &gt; &gt; &gt; Suspects:       no
&gt; &gt; &gt; &gt; &gt; Form:           none
&gt; &gt; &gt; &gt; &gt; JavaScript:     no
&gt; &gt; &gt; &gt; &gt; Pages:          7276
&gt; &gt; &gt; &gt; &gt; Encrypted:      no
&gt; &gt; &gt; &gt; &gt; Page size:      595 x 842 pts &#40;A4&#41;
&gt; &gt; &gt; &gt; &gt; Page rot:       0
&gt; &gt; &gt; &gt; &gt; File size:      9422943 bytes
&gt; &gt; &gt; &gt; &gt; Optimized:      yes
&gt; &gt; &gt; &gt; &gt; PDF version:    1.6
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; I have other files generated by approximately the same
&gt; &gt; &gt; &gt; &gt; procedure
&gt; &gt; &gt; &gt; &gt; &#40;certainly the same Producer etc&#41; which I am now able to open
&gt; &gt; &gt; &gt; &gt; with 2.026.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Thanks,
&gt; &gt; &gt; &gt; &gt; Stuart
</div>&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
</div></div>&gt; &gt;
&gt; &gt;
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;18:23:58&nbsp;2016</span>
    <span class="description">stu [...] spacehopper.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #112456] xref stream file in 2.026: Can&#39;t call method &#34;elementsof&#34; on an undefined value</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 2 Mar 2016 23:23:25 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Steve Simms via RT &lt;bug-PDF-API2 [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Stuart Henderson &lt;stu [...] spacehopper.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Aha - this changes things. I now have this instead:

Invalid XRefStm entry type: 205 at /usr/local/libdata/perl5/site_perl/PDF/API2/Basic/PDF/File.pm line 1166.

And I have received additional files from the same source, which did
not hit the original problem, but some do also see the &#34;Invalid XrefStm
entry type&#34;, with different type numbers &#40;100, 153&#41;. Those files are
smaller &#40;2.5MB&#41;.



On 2016/03/02 16:33, Steve Simms via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=112456">https://rt.cpan.org/Ticket/Display.html?id=112456</a></span> &gt;
&gt; 
&gt; And one more fix -- change line 1132 from:
&gt; 
&gt;         $tdict-&gt;read_stream&#40;&#41;;
&gt; 
&gt; to
&gt; 
&gt;         $tdict-&gt;read_stream&#40;1&#41;;
&gt; 
&gt; Given the number of pages in your file, the stream may be large enough that it got output to a file rather than staying in memory.  Adding &#34;1&#34; forces the stream to be read into memory, which is what the subsequent code assumes.
&gt; 
&gt; On Wed Mar 02 16:30:11 2016, SSIMMS wrote:
<div class="message-stanza open">&gt; &gt; You may also need to change line 1147 from:
&gt; &gt; 
&gt; &gt; @index = &#40;0, $tdict-&gt;{Size}-&gt;val - 1&#41;;
&gt; &gt; 
&gt; &gt; to
&gt; &gt; 
&gt; &gt; @index = &#40;0, $tdict-&gt;{Size}-&gt;val&#41;;
&gt; &gt; 
&gt; &gt; The last entry in a cross reference table is getting skipped when
&gt; &gt; Index isn&#39;t present.
&gt; &gt; 
&gt; &gt; 
&gt; &gt; On Wed Mar 02 15:55:55 2016, SSIMMS wrote:
<div class="message-stanza open">&gt; &gt; &gt; Try commenting out line 492 in lib/PDF/API2/Basic/PDF/File.pm:
&gt; &gt; &gt;
&gt; &gt; &gt; $result-&gt;{&#39; streamloc&#39;}-- if $fh-&gt;eof;
&gt; &gt; &gt;
&gt; &gt; &gt; Does that let you open the file?
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; On Sat Feb 27 20:50:46 2016, stu@spacehopper.org wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; Thanks for looking into this Steve. Good point that it&#39;s not
&gt; &gt; &gt; &gt; necessarily
&gt; &gt; &gt; &gt; linked to cross-reference stream support, sorry I should have
&gt; &gt; &gt; &gt; thought
&gt; &gt; &gt; &gt; of
&gt; &gt; &gt; &gt; that possibility.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; I have a couple of dozen files generated in the same way and having
&gt; &gt; &gt; &gt; now
&gt; &gt; &gt; &gt; checked all of them this is the only one with this error.
&gt; &gt; &gt; &gt; Unfortunately
&gt; &gt; &gt; &gt; they are from a print job for a fairly sensitive mailing from a 3rd
&gt; &gt; &gt; &gt; party that I&#39;m doing some processing on and, much as I&#39;d like to,
&gt; &gt; &gt; &gt; I really can&#39;t share them.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; If I add &#39;use Data::Dumper;&#39; and &#39;print Dumper&#40;$self-&gt;{&#39;pages&#39;}&#41;;&#39;
&gt; &gt; &gt; &gt; after line 200 of PDF/API2.pm, i.e.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; 198     $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;realise&#40;&#41;;
&gt; &gt; &gt; &gt; 199     $self-&gt;{&#39;pages&#39;} = $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;{&#39;Pages&#39;}-
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; realise&#40;&#41;;
</div>&gt; &gt; &gt; &gt; 200     $self-&gt;{&#39;pdf&#39;}-&gt;{&#39; version&#39;} ||= 3;
&gt; &gt; &gt; &gt; 201     use Data::Dumper;
&gt; &gt; &gt; &gt; -&gt;  202     print Dumper&#40;$self-&gt;{&#39;pages&#39;}&#41;;
&gt; &gt; &gt; &gt; 203     my @pages = proc_pages&#40;$self-&gt;{&#39;pdf&#39;}, $self-&gt;{&#39;pages&#39;}&#41;;
&gt; &gt; &gt; &gt; 204     $self-&gt;{&#39;pagestack&#39;} = [sort { $a-&gt;{&#39; pnum&#39;} &lt;=&gt; $b-&gt;{&#39;
&gt; &gt; &gt; &gt; pnum&#39;}
&gt; &gt; &gt; &gt; } @pages];
&gt; &gt; &gt; &gt; 205     $self-&gt;{&#39;catalog&#39;} = $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;};
&gt; &gt; &gt; &gt; 206     $self-&gt;{&#39;reopened&#39;} = 1;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; for the working files the structure is dumped, but for this broken
&gt; &gt; &gt; &gt; one
&gt; &gt; &gt; &gt; I get &#39;$VAR1 = undef;&#39;, that&#39;s what I meant by &#34;Tracing it back, in
&gt; &gt; &gt; &gt; open_scalar, this is returning undef: $self-&gt;{&#39;pages&#39;} = [...]&#34;,
&gt; &gt; &gt; &gt; so it doesn&#39;t seem like lack of a Kids element, rather that the
&gt; &gt; &gt; &gt; Pages dictionaries aren&#39;t getting processed correctly, but I&#39;m not
&gt; &gt; &gt; &gt; sure which code is responsible for {&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;{&#39;Pages&#39;}-
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; realise&#40;&#41;
</div>&gt; &gt; &gt; &gt; otherwise I would have looked there as well to look for differences
&gt; &gt; &gt; &gt; between the problem file and the working ones.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Also looking at all of the objects with &#34;mutool show&#34; and grepping
&gt; &gt; &gt; &gt; for
&gt; &gt; &gt; &gt; any mentioning /Pages without /Kids, I don&#39;t see any problems, I
&gt; &gt; &gt; &gt; also
&gt; &gt; &gt; &gt; had a look through with &#34;itext rups&#34; which was also happy with the
&gt; &gt; &gt; &gt; file and I didn&#39;t spot any unusual Pages dictionaries. &#40;there it
&gt; &gt; &gt; &gt; looks like <span class="clickylink"><a target="new" rel="nofollow" href="http://junkpile.org/pdfstructure-112456-1.png">http://junkpile.org/pdfstructure-112456-1.png</a></span>, basic
&gt; &gt; &gt; &gt; file structure is a couple of levels of Pages, each of them having
&gt; &gt; &gt; &gt; a Kids element with usually 10 entries, with Page at the deepest
&gt; &gt; &gt; &gt; level&#41;.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Stuart
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; On 2016/02/27 17:12, Steve Simms via RT wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=112456">https://rt.cpan.org/Ticket/Display.html?id=112456</a></span> &gt;
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Are you able to send the file to me privately?  If so, that will
&gt; &gt; &gt; &gt; &gt; let
&gt; &gt; &gt; &gt; &gt; me help you troubleshoot the problem and figure out if it&#39;s a
&gt; &gt; &gt; &gt; &gt; problem
&gt; &gt; &gt; &gt; &gt; with PDF::API2 or a problem with the PDF file not following the
&gt; &gt; &gt; &gt; &gt; spec
&gt; &gt; &gt; &gt; &gt; &#40;which may or may not be something that I can have the module
&gt; &gt; &gt; &gt; &gt; work
&gt; &gt; &gt; &gt; &gt; around&#41;.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; If not, the problem would seem to be that the PDF has a Pages
&gt; &gt; &gt; &gt; &gt; dictionary &#40;which contains information about a set of pages&#41; that
&gt; &gt; &gt; &gt; &gt; doesn&#39;t have the required Kids element &#40;which contains an array
&gt; &gt; &gt; &gt; &gt; of
&gt; &gt; &gt; &gt; &gt; Page or Pages nodes&#41;.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; At a glance, the problem wouldn&#39;t necessarily be linked to adding
&gt; &gt; &gt; &gt; &gt; support for cross-reference streams &#40;other than it being possible
&gt; &gt; &gt; &gt; &gt; to
&gt; &gt; &gt; &gt; &gt; read that file now&#41;, but anything is possible.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Steve
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; On Fri Feb 26 10:11:25 2016, stu@spacehopper.org wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; I&#39;m running PDF::API2 2.026 on perl 5.20.2 on OpenBSD. I have
&gt; &gt; &gt; &gt; &gt; &gt; some
&gt; &gt; &gt; &gt; &gt; &gt; awkward input files with xref streams which I&#39;ve been pre-
&gt; &gt; &gt; &gt; &gt; &gt; processing
&gt; &gt; &gt; &gt; &gt; &gt; with mutool clean to get them into a format usable with
&gt; &gt; &gt; &gt; &gt; &gt; PDF::API2,
&gt; &gt; &gt; &gt; &gt; &gt; but thought I&#39;d try them directly using the new xref stream
&gt; &gt; &gt; &gt; &gt; &gt; support.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Some such files now seem to be working OK but I have one that
&gt; &gt; &gt; &gt; &gt; &gt; fails
&gt; &gt; &gt; &gt; &gt; &gt; at open - if I do this:
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; use PDF::API2;
&gt; &gt; &gt; &gt; &gt; &gt; my $pdf = PDF::API2-&gt;open&#40;&#39;letter.pdf&#39;&#41;;
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; I get:
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Can&#39;t call method &#34;elementsof&#34; on an undefined value at
&gt; &gt; &gt; &gt; &gt; &gt; /usr/local/libdata/perl5/site_perl/PDF/API2.pm line 870.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Tracing it back, in open_scalar, this is returning undef:
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; $self-&gt;{&#39;pages&#39;} = $self-&gt;{&#39;pdf&#39;}-&gt;{&#39;Root&#39;}-&gt;{&#39;Pages&#39;}-
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt;realise&#40;&#41;;
</div>&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; My knowledge of perl OO and the PDF::API2 code is limited so
&gt; &gt; &gt; &gt; &gt; &gt; I&#39;m
&gt; &gt; &gt; &gt; &gt; &gt; not
&gt; &gt; &gt; &gt; &gt; &gt; sure where to go next, can you give me any pointers to help
&gt; &gt; &gt; &gt; &gt; &gt; track
&gt; &gt; &gt; &gt; &gt; &gt; it down further please?
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Unfortunately I can&#39;t make the file itself available.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; A bit more information about the file:
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; $ pdfinfo file.pdf
&gt; &gt; &gt; &gt; &gt; &gt; Title:          &lt;redacted&gt;
&gt; &gt; &gt; &gt; &gt; &gt; Author:         Compiled Xerox JDL file.
&gt; &gt; &gt; &gt; &gt; &gt; Creator:        Paris
&gt; &gt; &gt; &gt; &gt; &gt; Producer:       Normalizer demonorm
&gt; &gt; &gt; &gt; &gt; &gt; CreationDate:   Tue Feb 16 08:04:11 2016
&gt; &gt; &gt; &gt; &gt; &gt; ModDate:        Tue Feb 16 09:38:37 2016
&gt; &gt; &gt; &gt; &gt; &gt; Tagged:         no
&gt; &gt; &gt; &gt; &gt; &gt; UserProperties: no
&gt; &gt; &gt; &gt; &gt; &gt; Suspects:       no
&gt; &gt; &gt; &gt; &gt; &gt; Form:           none
&gt; &gt; &gt; &gt; &gt; &gt; JavaScript:     no
&gt; &gt; &gt; &gt; &gt; &gt; Pages:          7276
&gt; &gt; &gt; &gt; &gt; &gt; Encrypted:      no
&gt; &gt; &gt; &gt; &gt; &gt; Page size:      595 x 842 pts &#40;A4&#41;
&gt; &gt; &gt; &gt; &gt; &gt; Page rot:       0
&gt; &gt; &gt; &gt; &gt; &gt; File size:      9422943 bytes
&gt; &gt; &gt; &gt; &gt; &gt; Optimized:      yes
&gt; &gt; &gt; &gt; &gt; &gt; PDF version:    1.6
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; I have other files generated by approximately the same
&gt; &gt; &gt; &gt; &gt; &gt; procedure
&gt; &gt; &gt; &gt; &gt; &gt; &#40;certainly the same Producer etc&#41; which I am now able to open
&gt; &gt; &gt; &gt; &gt; &gt; with 2.026.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Thanks,
&gt; &gt; &gt; &gt; &gt; &gt; Stuart
</div>&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt;
</div></div>&gt; &gt; &gt;
&gt; &gt; &gt;
</div></div>&gt; 
&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;18:35:46&nbsp;2016</span>
    <span class="description">stu [...] spacehopper.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #112456] xref stream file in 2.026: Can&#39;t call method &#34;elementsof&#34; on an undefined value</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 2 Mar 2016 23:35:13 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Steve Simms via RT &lt;bug-PDF-API2 [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Stuart Henderson &lt;stu [...] spacehopper.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">.. If I disable the &#34;Invalid XrefStm entry type&#34; check, I then get

Cannot find the compressed object stream at /usr/local/libdata/perl5/site_perl/PDF/API2/Basic/PDF/File.pm line 696.

As it can&#39;t read it in at all, I can&#39;t give output from your new
pdf-debug.pl; if output from any other tools would be useful, there
are:

&#34;mutool show $file xref&#34; <span class="clickylink"><a target="new" rel="nofollow" href="https://pbot.rmdir.de/XeJ-kZtBSK6Q5WMwC9ph6w">https://pbot.rmdir.de/XeJ-kZtBSK6Q5WMwC9ph6w</a></span>
&#34;qpdf --show-xref $file&#34; <span class="clickylink"><a target="new" rel="nofollow" href="https://pbot.rmdir.de/pqZ6vuMp-61hQJltIhp1jQ">https://pbot.rmdir.de/pqZ6vuMp-61hQJltIhp1jQ</a></span>

On 2016/03/02 23:23, Stuart Henderson wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Aha - this changes things. I now have this instead:
&gt; 
&gt; Invalid XRefStm entry type: 205 at /usr/local/libdata/perl5/site_perl/PDF/API2/Basic/PDF/File.pm line 1166.
&gt; 
&gt; And I have received additional files from the same source, which did
&gt; not hit the original problem, but some do also see the &#34;Invalid XrefStm
&gt; entry type&#34;, with different type numbers &#40;100, 153&#41;. Those files are
&gt; smaller &#40;2.5MB&#41;.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;21:35:02&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Mar 02 18:23:58 2016, stu@spacehopper.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Aha - this changes things. I now have this instead:
&gt; 
&gt; Invalid XRefStm entry type: 205 at
&gt; /usr/local/libdata/perl5/site_perl/PDF/API2/Basic/PDF/File.pm line
&gt; 1166.
</div>
That means the module isn&#39;t reading or decoding the stream correctly -- entry types should only be 0, 1, or 2.

Can you update to the latest code on GitHub and try again?  That error should now give you the object number and generation of the XRef stream that&#39;s not being read properly.

You should then be able to find that &#34;# # obj&#34; string in the PDF &#40;using a text editor&#41;, which will be followed by a dictionary between &lt;&lt; and &gt;&gt; characters.  Can you paste that dictionary here, please?  It might give some hints as to what&#39;s happening.

If you have an editor that won&#39;t mangle binary characters, can you also attach everything from the &#34;# # obj&#34; until the next occurrence of &#34;endstream&#34;?  As long as the dictionary has a Type of XRef, the stream only contains an encoded set of object numbers and locations -- there won&#39;t be any sensitive data &#40;see PDF 1.7 section 7.5.8.3 if you want to double-check&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;23:12:18&nbsp;2016</span>
    <span class="description">stu [...] spacehopper.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #112456] xref stream file in 2.026: Can&#39;t call method &#34;elementsof&#34; on an undefined value</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 3 Mar 2016 04:11:44 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Steve Simms via RT &lt;bug-PDF-API2 [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Stuart Henderson &lt;stu [...] spacehopper.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You should then be able to find that &#34;# # obj&#34; string in the PDF &#40;using a text editor&#41;, which will be followed by a dictionary between &lt;&lt; and &gt;&gt; characters.  Can you paste that dictionary here, please?  It might give some hints as to what&#39;s happening.
</div>
Here&#39;s the dictionary:

&lt;&lt;/DecodeParms&lt;&lt;/Columns 5/Predictor 12&gt;&gt;/Filter/FlateDecode/ID[&lt;0382CD380585BB83E6E114E743A2319F&gt;&lt;1B7FABFCA277174AB014EEE3459651E0&gt;]/Info 29923 0 R/Length 21377/Root 29925 0 R/Size 29924/Type/XRef/W[1 3 1]&gt;&gt;

The rest is attached and also at <span class="clickylink"><a target="new" rel="nofollow" href="https://junkpile.org/xrefstm.bin">https://junkpile.org/xrefstm.bin</a></span> in
case the attachment gets mangled.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1603231/857529/xrefstm.bin">Download xrefstm.bin</a><br />
<span class="downloadcontenttype">application/octet-stream 21.1k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;03&nbsp;00:23:24&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I just fixed another bug that could have resulted in a corrupt stream.  Could you update again and give it a shot, please?  You&#39;re getting a different error than I was, but the cause could&#39;ve been the same.

On Wed Mar 02 23:12:18 2016, stu@spacehopper.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; You should then be able to find that &#34;# # obj&#34; string in the PDF
&gt; &gt; &#40;using a text editor&#41;, which will be followed by a dictionary between
&gt; &gt; &lt;&lt; and &gt;&gt; characters.  Can you paste that dictionary here, please?
&gt; &gt; It might give some hints as to what&#39;s happening.
</div>&gt; 
&gt; Here&#39;s the dictionary:
&gt; 
&gt; &lt;&lt;/DecodeParms&lt;&lt;/Columns 5/Predictor
<div class="message-stanza open">&gt; 12&gt;&gt;/Filter/FlateDecode/ID[&lt;0382CD380585BB83E6E114E743A2319F&gt;&lt;1B7FABFCA277174AB014EEE3459651E0&gt;]/Info
</div>&gt; 29923 0 R/Length 21377/Root 29925 0 R/Size 29924/Type/XRef/W[1 3 1]&gt;&gt;
&gt; 
&gt; The rest is attached and also at <span class="clickylink"><a target="new" rel="nofollow" href="https://junkpile.org/xrefstm.bin">https://junkpile.org/xrefstm.bin</a></span> in
&gt; case the attachment gets mangled.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;03&nbsp;06:58:09&nbsp;2016</span>
    <span class="description">stu [...] spacehopper.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #112456] xref stream file in 2.026: Can&#39;t call method &#34;elementsof&#34; on an undefined value</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 3 Mar 2016 11:57:36 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Steve Simms via RT &lt;bug-PDF-API2 [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Stuart Henderson &lt;stu [...] spacehopper.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Steve, sorry that&#39;s not the bug I&#39;m hitting - but the good news
is I&#39;ve dumped the stream at various points in the code and tracked
it down further.

In Basic/PDF/File.pm around line 1151 there&#39;s $tdict-&gt;read_stream&#40;1&#41;.
Looking at the contents of $tdict-&gt;{&#39; stream&#39;} around there:

Before read_stream: bad+good files both match the encoded stream as
dumped by &#34;mutool show -e -b&#34;.

After: good file matches the uncompressed stream as dumped by &#34;mutool
show -b&#34;, *but* the bad file does not match.

So I&#39;m now looking at Basic/PDF/Dict.pm.

One difference between working/broken files is that the compressed
stream in the working one is &lt;4096 bytes and the broken one is &gt;4096.
So as a hack I&#39;ve bumped everything in Dict.pm to read in 32K chunks
instead; I&#39;m now able to read these files.

So if you go the other way and reduce these from 4096 to, say, 512
bytes, I expect you will be able to reproduce the corrupted stream.

$ ./pdf-debug.pl $file xref
XRef at 116
-----------
Filter: FlateDecode
ID:     [ &lt;0382cd380585bb83e6e114e743a2319f&gt; &lt;1b7fabfca277174ab014eee3459651e0&gt; ]
Index:  [ 29924 264 ]
Info:   &lt;Object 29923&gt;
Length: 479
Prev:   9401296
Root:   &lt;Object 29925&gt;
Size:   30188
Type:   XRef
W:      [ 1 3 1 ]
DecodeParms: 
    Columns:   5
    Predictor: 12

Stream
------
[Stream contains non-printable characters]
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;03&nbsp;15:16:25&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">That sounds promising.  Thanks for digging into it.

On Thu Mar 03 06:58:09 2016, stu@spacehopper.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Steve, sorry that&#39;s not the bug I&#39;m hitting - but the good news
&gt; is I&#39;ve dumped the stream at various points in the code and tracked
&gt; it down further.
&gt; 
&gt; In Basic/PDF/File.pm around line 1151 there&#39;s $tdict-&gt;read_stream&#40;1&#41;.
&gt; Looking at the contents of $tdict-&gt;{&#39; stream&#39;} around there:
&gt; 
&gt; Before read_stream: bad+good files both match the encoded stream as
&gt; dumped by &#34;mutool show -e -b&#34;.
&gt; 
&gt; After: good file matches the uncompressed stream as dumped by &#34;mutool
&gt; show -b&#34;, *but* the bad file does not match.
&gt; 
&gt; So I&#39;m now looking at Basic/PDF/Dict.pm.
&gt; 
&gt; One difference between working/broken files is that the compressed
&gt; stream in the working one is &lt;4096 bytes and the broken one is &gt;4096.
&gt; So as a hack I&#39;ve bumped everything in Dict.pm to read in 32K chunks
&gt; instead; I&#39;m now able to read these files.
&gt; 
&gt; So if you go the other way and reduce these from 4096 to, say, 512
&gt; bytes, I expect you will be able to reproduce the corrupted stream.
&gt; 
&gt; $ ./pdf-debug.pl $file xref
&gt; XRef at 116
&gt; -----------
&gt; Filter: FlateDecode
&gt; ID:     [ &lt;0382cd380585bb83e6e114e743a2319f&gt;
&gt; &lt;1b7fabfca277174ab014eee3459651e0&gt; ]
&gt; Index:  [ 29924 264 ]
&gt; Info:   &lt;Object 29923&gt;
&gt; Length: 479
&gt; Prev:   9401296
&gt; Root:   &lt;Object 29925&gt;
&gt; Size:   30188
&gt; Type:   XRef
&gt; W:      [ 1 3 1 ]
&gt;  DecodeParms:
&gt;     Columns:   5
&gt;     Predictor: 12
&gt; 
&gt; Stream
&gt; ------
&gt; [Stream contains non-printable characters]
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;09&nbsp;10:12:42&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Mar 03 06:58:09 2016, stu@spacehopper.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; One difference between working/broken files is that the compressed
&gt; stream in the working one is &lt;4096 bytes and the broken one is &gt;4096.
&gt; So as a hack I&#39;ve bumped everything in Dict.pm to read in 32K chunks
&gt; instead; I&#39;m now able to read these files.
&gt; 
&gt; So if you go the other way and reduce these from 4096 to, say, 512
&gt; bytes, I expect you will be able to reproduce the corrupted stream.
</div>
As it turned out, it also required that the buffer size not be a multiple of the row length, but I was able to reproduce it.  There&#39;s a fix on GitHub now -- can you confirm that it works for your file?

Thanks again for helping troubleshoot this bug!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;09&nbsp;10:12:48&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;09&nbsp;18:12:54&nbsp;2016</span>
    <span class="description">stu [...] spacehopper.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #112456] xref stream file in 2.026: Can&#39;t call method &#34;elementsof&#34; on an undefined value</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 9 Mar 2016 23:11:55 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Steve Simms via RT &lt;bug-PDF-API2 [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Stuart Henderson &lt;stu [...] spacehopper.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2016/03/09 10:12, Steve Simms via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=112456">https://rt.cpan.org/Ticket/Display.html?id=112456</a></span> &gt;
&gt; 
&gt; On Thu Mar 03 06:58:09 2016, stu@spacehopper.org wrote:
<div class="message-stanza open">&gt; &gt; One difference between working/broken files is that the compressed
&gt; &gt; stream in the working one is &lt;4096 bytes and the broken one is &gt;4096.
&gt; &gt; So as a hack I&#39;ve bumped everything in Dict.pm to read in 32K chunks
&gt; &gt; instead; I&#39;m now able to read these files.
&gt; &gt; 
&gt; &gt; So if you go the other way and reduce these from 4096 to, say, 512
&gt; &gt; bytes, I expect you will be able to reproduce the corrupted stream.
</div>&gt; 
&gt; As it turned out, it also required that the buffer size not be a multiple of the row length, but I was able to reproduce it.  There&#39;s a fix on GitHub now -- can you confirm that it works for your file?
&gt; 
&gt; Thanks again for helping troubleshoot this bug!
</div>
Great, I&#39;m glad you were able to reproduce and track it down!
Yes, I can confirm this is now working for my files.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;13&nbsp;13:37:25&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;13&nbsp;13:37:26&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Fixed in 2.027 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
