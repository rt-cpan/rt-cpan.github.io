<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #73711 for Server-Starter: Failing test / install</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #73711 for Server-Starter: Failing test / install</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Server-Starter/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Server-Starter/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Server-Starter/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Server-Starter/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/kazuho/p5-Server-Starter/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Server-Starter">Server-Starter CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">73711</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Server-Starter/Active/">Server-Starter</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
landsidel.allen [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-229244-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-229245-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;03&nbsp;16:03:11&nbsp;2012</span>
    <span class="description">landsidel.allen [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Failing test / install</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 03 Jan 2012 16:02:43 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Server-Starter [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Allen Landsidel &lt;landsidel.allen [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">OS: FreeBSD 8.2-STABLE &#40;Oct 14th, 2011&#41;
Platform: amd64
Perl version: 5.12.4
Mod version: Server-Starter-0.11 &#40;install via CPAN &#34;install 
Server::Starter&#34; failing&#41;


One failing test:
#   Failed test &#39;status during restart&#39;
#   at t/01-starter.t line 51.
#                   &#39;2:54944
# &#39;
#     doesn&#39;t match &#39;&#40;?s-xim:^1:\d+\n2:\d+$&#41;&#39;

The test itself looks a little dodgy..
             kill &#39;HUP&#39;, $server_pid;
             sleep 3;
             like&#40;get_status&#40;&#41;, qr/^1:\d+\n2:\d+$/s, &#39;status during 
restart&#39;&#41;;
             sleep 2;
             like&#40;get_status&#40;&#41;, qr/^2:\d+\n$/s, &#39;status after restart&#39;&#41;;

Like the &#39;during restart&#39; is never happening; maybe it&#39;s restarting too 
fast?  3 seconds is a long time to wait.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;16&nbsp;11:37:36&nbsp;2014</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Út 03.led.2012 16:03:11, landsidel.allen@gmail.com napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; OS: FreeBSD 8.2-STABLE &#40;Oct 14th, 2011&#41;
&gt; Platform: amd64
&gt; Perl version: 5.12.4
&gt; Mod version: Server-Starter-0.11 &#40;install via CPAN &#34;install 
&gt; Server::Starter&#34; failing&#41;
&gt; 
&gt; 
&gt; One failing test:
&gt; #   Failed test &#39;status during restart&#39;
&gt; #   at t/01-starter.t line 51.
&gt; #                   &#39;2:54944
&gt; # &#39;
&gt; #     doesn&#39;t match &#39;&#40;?s-xim:^1:\d+\n2:\d+$&#41;&#39;
&gt; 
&gt; The test itself looks a little dodgy..
&gt;              kill &#39;HUP&#39;, $server_pid;
&gt;              sleep 3;
&gt;              like&#40;get_status&#40;&#41;, qr/^1:\d+\n2:\d+$/s, &#39;status during 
&gt; restart&#39;&#41;;
&gt;              sleep 2;
&gt;              like&#40;get_status&#40;&#41;, qr/^2:\d+\n$/s, &#39;status after restart&#39;&#41;;
&gt; 
</div>I experience similar problem with t/07-envdir.t. Removing the sleep&#39;s around the kill call make the failures fairly reproducible.

Attached two patches fixes the problem. The 0001-Synchronize-to-PID-in-t-07-envdir.t.patch patch fixes the t/07-envdir.t test, the 0002-Fix-loading-envdir.patch fixes loading the environment directory.

-- Petr
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Synchronize-to-PID-in-t-07-envdir.t.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 9fc8c81a018ba6cb5f3f0ad3fbc836e301468978 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Mon, 16 Jun 2014 15:20:43 +0200
Subject: [PATCH 1/2] Synchronize to PID in t/07-envdir.t
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The t/07-envdir.t used various sleeps to deal with races. This broke obviously
when the timing was abnormal like on have loaded machine. This patch
synchronizes on the status file by checking only the new worker is
running.

Similar to CPAN RT#73711.

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 t/07-envdir-print.pl |  3 ++-
 t/07-envdir.t        | 29 ++++++++++++++++++++++++++---
 2 files changed, 28 insertions&#40;+&#41;, 4 deletions&#40;-&#41;

diff --git a/t/07-envdir-print.pl b/t/07-envdir-print.pl
index 22cb01a..fb14225 100755
--- a/t/07-envdir-print.pl
+++ b/t/07-envdir-print.pl
@@ -11,6 +11,7 @@ use Server::Starter qw&#40;server_ports&#41;;
 $SIG{TERM} = $SIG{USR1} = sub {
     exit 0;
 };
+$ENV{PID} = $$;
 
 my $listener = IO::Socket::INET-&gt;new&#40;
     Proto =&gt; &#39;tcp&#39;,
@@ -21,7 +22,7 @@ $listener-&gt;fdopen&#40;&#40;values %{server_ports&#40;&#41;}&#41;[0], &#39;w&#39;&#41;
 while &#40;1&#41; {
     if &#40;my $conn = $listener-&gt;accept&#41; {
         my $s = &#34;&#34;;
-        for my $envkey &#40;keys %ENV&#41; {
+        for my $envkey &#40;sort keys %ENV&#41; {
             $s .= $envkey . &#34;=&#34; . $ENV{$envkey} . &#34;\n&#34;;
         }
         $conn-&gt;syswrite&#40;$s&#41;;
diff --git a/t/07-envdir.t b/t/07-envdir.t
index 8bf2352..2050706 100644
--- a/t/07-envdir.t
+++ b/t/07-envdir.t
@@ -46,13 +46,36 @@ test_tcp&#40;
             $buf;
         };
         my $restart = sub {
-            sleep 1;
+            sub getstatus {
+                my &#40;$file, $value&#41;;
+                open&#40;$file, &#39;&lt;&#39;, &#34;$tempdir/status&#34;&#41; or return &#39;&#39;;
+                do { local $/ = undef; $value = &lt;$file&gt;; };
+                close $file;
+                $value // &#39;&#39;;
+            }
+            sub getsinglegeneration {
+                my $status;
+                do {
+                    sleep 1 if defined $status;
+                    $status = getstatus;
+                } until &#40;$status =~ /\A\d+:\d+\n\z/&#41;;
+                chomp $status;
+                $status;
+            }
+            my $previous_generation = getsinglegeneration;
             kill &#34;HUP&#34;, $server_pid;
-            sleep 2;
+            my $current_generation;
+            while &#40;&#40;$current_generation = getsinglegeneration&#41; eq
+                    $previous_generation&#41; {
+                sleep 1;
+            }
+            diag &#34;Server changed from &lt;$previous_generation&gt; &#34;,
+                &#34;to &lt;$current_generation&gt;\n&#34;;
         };
         # Initial worker does not read envdir
         my $buf = $fetch_env-&gt;&#40;&#41;;
-        unlike&#40;$buf, qr/^FOO=foo-value1$/m, &#39;changed env&#39;&#41;;
+        unlike&#40;$buf, qr/^FOO=foo-value1$/m,
+            &#39;environment not read for the first time&#39;&#41;;
         # rewrite envdir
         open my $envfh, &#34;&gt;&#34;, &#34;$tempdir/env/FOO&#34; or die $!;
         print $envfh &#34;foo-value2&#34;;
-- 
1.9.3

</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0002-Fix-loading-envdir.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 6d965848ff8905f82da0f1ac142000b12a05905e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Mon, 16 Jun 2014 17:25:08 +0200
Subject: [PATCH 2/2] Fix loading envdir
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The envdir was scanned each second regardless of signal received. This
caused random failures of the &#39;removed env&#39; t/07-envdir.t test.

This patch fixes it by loading the environment only just before
intended restart. It also documents this start_server&#40;&#41; option.

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 lib/Server/Starter.pm | 31 ++++++++++++++++++++++---------
 1 file changed, 22 insertions&#40;+&#41;, 9 deletions&#40;-&#41;

diff --git a/lib/Server/Starter.pm b/lib/Server/Starter.pm
index 47bc18a..c171307 100644
--- a/lib/Server/Starter.pm
+++ b/lib/Server/Starter.pm
@@ -179,15 +179,13 @@ sub start_server {
     
     # the main loop
     my $term_signal = 0;
-    $current_worker = _start_worker&#40;$opts&#41;;
+    my %loaded_env;
+    $current_worker = _start_worker&#40;$opts, \%loaded_env&#41;;
     $update_status-&gt;&#40;&#41;;
     my $auto_restart_interval = 0;
     my $last_restart_time = time&#40;&#41;;
     my $restart_flag = 0;
     while &#40;1&#41; {
-        my %loaded_env = _reload_env&#40;&#41;;
-        my @loaded_env_keys = keys %loaded_env;
-        local @ENV{@loaded_env_keys} = map { $loaded_env{$_} } &#40;@loaded_env_keys&#41;;
         if &#40;$ENV{ENABLE_AUTO_RESTART}&#41; {
             # restart workers periodically
             $auto_restart_interval = $ENV{AUTO_RESTART_INTERVAL} ||= 360;
@@ -201,7 +199,7 @@ sub start_server {
             last if &#40;$died_worker &lt;= 0&#41;;
             if &#40;$died_worker == $current_worker&#41; {
                 print STDERR &#34;worker $died_worker died unexpectedly with status:$status, restarting\n&#34;;
-                $current_worker = _start_worker&#40;$opts&#41;;
+                $current_worker = _start_worker&#40;$opts, \%loaded_env&#41;;
                 $last_restart_time = time&#40;&#41;;
             } else {
                 print STDERR &#34;old worker $died_worker died, status:$status\n&#34;;
@@ -232,9 +230,10 @@ sub start_server {
             }
         }
         if &#40;$restart_flag &gt; 1 || &#40;$restart_flag &gt; 0 &#38;&#38; $num_old_workers == 0&#41;&#41; {
+            %loaded_env = _reload_env&#40;&#41;;
             print STDERR &#34;spawning a new worker &#40;num_old_workers=$num_old_workers&#41;\n&#34;;
             $old_workers{$current_worker} = $ENV{SERVER_STARTER_GENERATION};
-            $current_worker = _start_worker&#40;$opts&#41;;
+            $current_worker = _start_worker&#40;$opts, \%loaded_env&#41;;
             $last_restart_time = time&#40;&#41;;
             $restart_flag = 0;
             $update_status-&gt;&#40;&#41;;
@@ -342,7 +341,7 @@ sub _reload_env {
 }
 
 sub _start_worker {
-    my $opts = shift;
+    my &#40;$opts, $loaded_env&#41; = @_;
     my $pid;
     while &#40;1&#41; {
         $ENV{SERVER_STARTER_GENERATION}++;
@@ -350,6 +349,8 @@ sub _start_worker {
         die &#34;fork&#40;2&#41; failed:$!&#34;
             unless defined $pid;
         if &#40;$pid == 0&#41; {
+            my @loaded_env_keys = keys %$loaded_env;
+            @ENV{@loaded_env_keys} = map { $loaded_env-&gt;{$_} } &#40;@loaded_env_keys&#41;;
             my @args = @{$opts-&gt;{exec}};
             # child process
             if &#40;defined $opts-&gt;{dir}&#41; {
@@ -418,9 +419,21 @@ A Net::Server personality that can be run under L&lt;Server::Starter&gt; exists under
 
 Returns zero or more file descriptors on which the server program should call accept&#40;2&#41; in a hashref.  Each element of the hashref is: &#40;host:port|port|path_of_unix_socket&#41; =&gt; file_descriptor.
 
-=item start_server
+=item start_server&#40;%options&#41;
 
-Starts the superdaemon.  Used by the C&lt;start_server&gt; script.
+Starts the superdaemon.  Used by the C&lt;start_server&gt; script. Options are:
+
+=over 4
+
+=item envdir
+
+Defines a directory whose content is added into server&#39;s environment. Each file name specifies an environment variable, the file&#39;s content specifies a value of the environment variable. Files with names starting with a dot are ignored.  
+
+The environment directory is scanned and read only on time-based autorestart or SIGHUP signal. The first server instances have default environment. To remove an enviroment variable added before, remove the file and send the signal.
+
+This option is not mandatory.
+
+=back
 
 =back
 
-- 
1.9.3

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;16&nbsp;11:37:37&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;10&nbsp;09:46:03&nbsp;2014</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Út 03.led.2012 16:03:11, landsidel.allen@gmail.com napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; OS: FreeBSD 8.2-STABLE &#40;Oct 14th, 2011&#41;
&gt; Platform: amd64
&gt; Perl version: 5.12.4
&gt; Mod version: Server-Starter-0.11 &#40;install via CPAN &#34;install 
&gt; Server::Starter&#34; failing&#41;
&gt; 
&gt; 
&gt; One failing test:
&gt; #   Failed test &#39;status during restart&#39;
&gt; #   at t/01-starter.t line 51.
&gt; #                   &#39;2:54944
&gt; # &#39;
&gt; #     doesn&#39;t match &#39;&#40;?s-xim:^1:\d+\n2:\d+$&#41;&#39;
&gt; 
</div>There are similar problems in t/06-autorestart.t. Attached patch should fix them.

-- Petr
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Synchronize-to-PID-in-t-06-autorestart.t.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From b2cee396fea96266a95a829b94cdf759d0eae76d Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Thu, 10 Jul 2014 15:37:47 +0200
Subject: [PATCH] Synchronize to PID in t/06-autorestart.t
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

There were races between various sleeps and 4s auto_restart_interval.
This patch replaces the sleeps by waiting for status with a single PID
entry.

Similar to CPAN RT#73711.

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 t/06-autorestart.t | 35 +++++++++++++++++++++++++++--------
 1 file changed, 27 insertions&#40;+&#41;, 8 deletions&#40;-&#41;

diff --git a/t/06-autorestart.t b/t/06-autorestart.t
index bab9241..9401500 100644
--- a/t/06-autorestart.t
+++ b/t/06-autorestart.t
@@ -3,7 +3,7 @@ use warnings;
 
 use File::Temp &#40;&#41;;
 use Test::TCP;
-use Test::More tests =&gt; 28;
+use Test::More tests =&gt; 26;
 
 use Server::Starter qw&#40;start_server&#41;;
 
@@ -46,13 +46,19 @@ for my $signal_on_hup &#40;&#39;TERM&#39;, &#39;USR1&#39;&#41; {
             $buf =~ /^&#40;\d+&#41;:/;
             my $worker_pid = $1;
             # switch to next gen
-            sleep 2;
-            my $status = get_status&#40;&#41;;
-            like&#40;get_status&#40;&#41;, qr/^1:\d+\n$/s, &#39;status before auto-restart&#39;&#41;;
-            sleep 5;
-            like&#40;get_status&#40;&#41;, qr/^1:\d+\n2:\d+$/s, &#39;status during transient state&#39;&#41;;
-            sleep 4;
-            like&#40;get_status&#40;&#41;, qr/^2:\d+\n$/s, &#39;status after auto-restart&#39;&#41;;
+            my $previous_generation = get_single_generation&#40;&#41;;
+            like&#40;$previous_generation, qr/^\d+:\d+\n$/s,
+                &#39;status before auto-restart&#39;&#41;;
+            my $current_generation;
+            while &#40;&#40;$current_generation = get_single_generation&#40;&#41;&#41; eq
+                    $previous_generation&#41; {
+               sleep 1;
+            }
+            diag &#34;Server changed from &lt;$previous_generation&gt; &#34;,
+                &#34;to &lt;$current_generation&gt;\n&#34;;
+
+            like&#40;$current_generation, qr/^\d+:\d+\n$/s,
+                &#39;status after auto-restart&#39;&#41;;
             is&#40;
                 do {
                     open my $fh, &#39;&lt;&#39;, &#34;$tempdir/signame&#34;
@@ -78,7 +84,20 @@ for my $signal_on_hup &#40;&#39;TERM&#39;, &#39;USR1&#39;&#41; {
 }
 
 sub get_status {
+    while &#40;! -e &#34;$tempdir/status&#34;&#41; {
+        sleep 1;
+    }
     open my $fh, &#39;&lt;&#39;, &#34;$tempdir/status&#34;
         or die &#34;failed to open file:$tempdir/status:$!&#34;;
     do { undef $/; &lt;$fh&gt; };
 }
+
+sub get_single_generation {
+    my $status;
+    do {
+        sleep 1 if defined $status;
+        $status = get_status;
+    } until &#40;$status =~ /\A\d+:\d+\n\z/&#41;;
+    chomp $status;
+    $status;
+}
-- 
1.9.3

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;08&nbsp;07:07:39&nbsp;2014</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Út 03.led.2012 16:03:11, landsidel.allen@gmail.com napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; OS: FreeBSD 8.2-STABLE &#40;Oct 14th, 2011&#41;
&gt; Platform: amd64
&gt; Perl version: 5.12.4
&gt; Mod version: Server-Starter-0.11 &#40;install via CPAN &#34;install 
&gt; Server::Starter&#34; failing&#41;
&gt; 
&gt; 
&gt; One failing test:
&gt; #   Failed test &#39;status during restart&#39;
&gt; #   at t/01-starter.t line 51.
&gt; #                   &#39;2:54944
&gt; # &#39;
&gt; #     doesn&#39;t match &#39;&#40;?s-xim:^1:\d+\n2:\d+$&#41;&#39;
&gt; 
&gt; The test itself looks a little dodgy..
&gt;              kill &#39;HUP&#39;, $server_pid;
&gt;              sleep 3;
&gt;              like&#40;get_status&#40;&#41;, qr/^1:\d+\n2:\d+$/s, &#39;status during 
&gt; restart&#39;&#41;;
&gt;              sleep 2;
&gt;              like&#40;get_status&#40;&#41;, qr/^2:\d+\n$/s, &#39;status after restart&#39;&#41;;
&gt; 
&gt; Like the &#39;during restart&#39; is never happening; maybe it&#39;s restarting too 
&gt; fast?  3 seconds is a long time to wait.
</div>
Attached patch fixes this reported race in t/01-starter.t.

-- Petr
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Server-Starter-0.17-Synchronize-to-PID-in-t-01-starter.t.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From f7d5f6bfb5e94a3ea01e53c5b69186ff7172b4bf Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Fri, 8 Aug 2014 12:58:40 +0200
Subject: [PATCH] Synchronize to PID in t/01-starter.t
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

There were races between various sleeps and the restarting server.
THis patch fixes it by waiting for complete generation change in the
status file.

This fixes CPAN RT#73711.

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 t/01-starter.t | 33 +++++++++++++++++++++++++--------
 1 file changed, 25 insertions&#40;+&#41;, 8 deletions&#40;-&#41;

diff --git a/t/01-starter.t b/t/01-starter.t
index ec671f0..1ddb925 100644
--- a/t/01-starter.t
+++ b/t/01-starter.t
@@ -3,7 +3,7 @@ use warnings;
 
 use File::Temp &#40;&#41;;
 use Test::TCP;
-use Test::More tests =&gt; 28;
+use Test::More tests =&gt; 26;
 
 use Server::Starter qw&#40;start_server&#41;;
 
@@ -43,14 +43,17 @@ for my $signal_on_hup &#40;&#39;TERM&#39;, &#39;USR1&#39;&#41; {
             $buf =~ /^&#40;\d+&#41;:/;
             my $worker_pid = $1;
             # switch to next gen
-            sleep 2;
-            my $status = get_status&#40;&#41;;
-            like&#40;get_status&#40;&#41;, qr/^1:\d+\n$/s, &#39;status before restart&#39;&#41;;
+            my $previous_generation = get_single_generation&#40;&#41;;
+            like&#40;$previous_generation, qr/^1:\d+\n$/s, &#39;status before restart&#39;&#41;;
             kill &#39;HUP&#39;, $server_pid;
-            sleep 3;
-            like&#40;get_status&#40;&#41;, qr/^1:\d+\n2:\d+$/s, &#39;status during restart&#39;&#41;;
-            sleep 2;
-            like&#40;get_status&#40;&#41;, qr/^2:\d+\n$/s, &#39;status after restart&#39;&#41;;
+            my $current_generation;
+            while &#40;&#40;$current_generation = get_single_generation&#40;&#41;&#41; eq
+                    $previous_generation&#41; {
+               sleep 1;
+            }
+            diag &#34;Server changed from &lt;$previous_generation&gt; &#34;,
+                &#34;to &lt;$current_generation&gt;\n&#34;;
+            like&#40;$current_generation, qr/^2:\d+\n$/s, &#39;status after restart&#39;&#41;;
             is&#40;
                 do {
                     open my $fh, &#39;&lt;&#39;, &#34;$tempdir/signame&#34;
@@ -76,7 +79,21 @@ for my $signal_on_hup &#40;&#39;TERM&#39;, &#39;USR1&#39;&#41; {
 }
 
 sub get_status {
+    while &#40;! -e &#34;$tempdir/status&#34;&#41; {
+        sleep 1;
+    }
     open my $fh, &#39;&lt;&#39;, &#34;$tempdir/status&#34;
         or die &#34;failed to open file:$tempdir/status:$!&#34;;
     do { undef $/; &lt;$fh&gt; };
 }
+
+sub get_single_generation {
+    my $status;
+    do {
+        sleep 1 if defined $status;
+        $status = get_status;
+    } until &#40;$status =~ /\A\d+:\d+\n\z/&#41;;
+    chomp $status;
+    $status;
+}
+
-- 
1.9.3

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;21&nbsp;08:23:22&nbsp;2014</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Út 03.led.2012 16:03:11, landsidel.allen@gmail.com napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; OS: FreeBSD 8.2-STABLE &#40;Oct 14th, 2011&#41;
&gt; Platform: amd64
&gt; Perl version: 5.12.4
&gt; Mod version: Server-Starter-0.11 &#40;install via CPAN &#34;install 
&gt; Server::Starter&#34; failing&#41;
&gt; 
&gt; 
&gt; One failing test:
&gt; #   Failed test &#39;status during restart&#39;
&gt; #   at t/01-starter.t line 51.
&gt; #                   &#39;2:54944
&gt; # &#39;
&gt; #     doesn&#39;t match &#39;&#40;?s-xim:^1:\d+\n2:\d+$&#41;&#39;
&gt; 
</div>There is similar bug in t/05-killolddelay.t. Attached patch fixes it.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Server-Starter-0.17-Synchronize-to-PID-in-t-05-killolddelay.t.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 046fb1328e76851a1398a624b77e746c37c62a67 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Thu, 21 Aug 2014 14:17:25 +0200
Subject: [PATCH] Synchronize to PID in t/05-killolddelay.t
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

There were races between various sleeps and the restarting server.
This patch fixes it by waiting for complete generation change in the
status file.

Similar to CPAN RT#73711.

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 t/05-killolddelay.t | 36 +++++++++++++++++++++++++-----------
 1 file changed, 25 insertions&#40;+&#41;, 11 deletions&#40;-&#41;

diff --git a/t/05-killolddelay.t b/t/05-killolddelay.t
index 19856af..457bdd9 100644
--- a/t/05-killolddelay.t
+++ b/t/05-killolddelay.t
@@ -3,7 +3,7 @@ use warnings;
 
 use File::Temp &#40;&#41;;
 use Test::TCP;
-use Test::More tests =&gt; 28;
+use Test::More tests =&gt; 26;
 
 use Server::Starter qw&#40;start_server&#41;;
 
@@ -45,17 +45,18 @@ for my $signal_on_hup &#40;&#39;TERM&#39;, &#39;USR1&#39;&#41; {
             $buf =~ /^&#40;\d+&#41;:/;
             my $worker_pid = $1;
             # switch to next gen
-            sleep 2;
-            my $status = get_status&#40;&#41;;
-            like&#40;get_status&#40;&#41;, qr/^1:\d+\n$/s, &#39;status before restart&#39;&#41;;
+            my $previous_generation = get_single_generation&#40;&#41;;
+            like&#40;$previous_generation, qr/^1:\d+\n$/s, &#39;status before restart&#39;&#41;;
             kill &#39;HUP&#39;, $server_pid;
-            sleep 4;
-            like&#40;get_status&#40;&#41;, qr/^1:\d+\n2:\d+$/s, &#39;status during restart&#39;&#41;;
-            # Child process has finished in 2 seconds but the parent
-            # checks and calls waitpid every second, so wait for an
-            # additional 1 second.
-            sleep 3;
-            like&#40;get_status&#40;&#41;, qr/^2:\d+\n$/s, &#39;status after restart&#39;&#41;;
+            my $current_generation;
+            while &#40;&#40;$current_generation = get_single_generation&#40;&#41;&#41; eq
+                    $previous_generation&#41; {
+               sleep 1;
+            }
+            diag &#34;Server changed from &lt;$previous_generation&gt; &#34;,
+                &#34;to &lt;$current_generation&gt;\n&#34;;
+
+            like&#40;$current_generation, qr/^2:\d+\n$/s, &#39;status after restart&#39;&#41;;
             is&#40;
                 do {
                     open my $fh, &#39;&lt;&#39;, &#34;$tempdir/signame&#34;
@@ -81,7 +82,20 @@ for my $signal_on_hup &#40;&#39;TERM&#39;, &#39;USR1&#39;&#41; {
 }
 
 sub get_status {
+    while &#40;! -e &#34;$tempdir/status&#34;&#41; {
+        sleep 1;
+    }
     open my $fh, &#39;&lt;&#39;, &#34;$tempdir/status&#34;
         or die &#34;failed to open file:$tempdir/status:$!&#34;;
     do { undef $/; &lt;$fh&gt; };
 }
+
+sub get_single_generation {
+    my $status;
+    do {
+        sleep 1 if defined $status;
+        $status = get_status;
+    } until &#40;$status =~ /\A\d+:\d+\n\z/&#41;;
+    chomp $status;
+    $status;
+}
-- 
1.9.3

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;09&nbsp;03:20:00&nbsp;2014</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">There is another race between t/06-autorestart.t and t/05-killolddelay-echod.pl. If t/05-killolddelay-echod.pl is not fast enough with writing received signal name &#40;e.g. by adding &#34;sleep 2;&#34; in the beginning of a signal handler&#41;, the t/06-autorestart.t will get empty signame file and the test for the signal name will fail. Example:


t/05-killolddelay.t .. ok
start_server &#40;pid:17417&#41; starting now...
starting new worker 17418
autorestart triggered &#40;interval=4&#41;
spawning a new worker &#40;num_old_workers=0&#41;
starting new worker 17421
new worker is now running, sending TERM to old workers:17418
sleep 1 secs
killing old workers
old worker 17418 died, status:0
autorestart triggered &#40;interval=4&#41;
spawning a new worker &#40;num_old_workers=0&#41;
starting new worker 17431
# Server changed from &lt;1:17418
# &gt; to &lt;2:17421
# &gt;
#   Failed test &#39;signal sent on hup&#39;
#   at t/06-autorestart.t line 63.
#          got: &#39;&#39;
#     expected: &#39;TERM&#39;
new worker is now running, sending TERM to old workers:17421

Attached patch fixes it. &#40;Applicable on top of the previous ones&#41;.

-- Petr
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Synchronize-to-content-in-signame-file.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 3ec63d1650f9199d6d2b2413c7e855bc108646a4 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Mon, 8 Sep 2014 19:03:08 +0200
Subject: [PATCH] Synchronize to content in signame file
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

There is a race between t/06-autorestart.t and
t/05-killolddelay-echod.pl. If t/05-killolddelay-echod.pl is not fast
enough with writing received signal name &#40;e.g. by adding &#34;sleep 2;&#34; in
the beginning of a signal handler&#41;, the t/06-autorestart.t will get
empty signame file and the test for the signal name will fail.

This patch adds synchornization by locking the signame file.

Similar to CPAN RT#73711.

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 t/05-killolddelay-echod.pl | 3 +++
 t/06-autorestart.t         | 8 ++++++--
 2 files changed, 9 insertions&#40;+&#41;, 2 deletions&#40;-&#41;

diff --git a/t/05-killolddelay-echod.pl b/t/05-killolddelay-echod.pl
index 5b48ca5..bd6be30 100755
--- a/t/05-killolddelay-echod.pl
+++ b/t/05-killolddelay-echod.pl
@@ -5,16 +5,19 @@ use warnings;
 
 use lib qw&#40;blib/lib lib&#41;;
 
+use Fcntl qw&#40;:flock&#41;;
 use IO::Socket::INET;
 use Server::Starter qw&#40;server_ports&#41;;
 
 my $sigfn = shift @ARGV;
 open my $sigfh, &#39;&gt;&#39;, $sigfn
     or die &#34;could not open file:$sigfn:$!&#34;;
+flock $sigfh, LOCK_EX or die &#34;could lock file:$sigfh:$!&#34;;
 
 $SIG{TERM} = $SIG{USR1} = sub {
     my $signame = shift;
     print $sigfh $signame;
+    flock $sigfh, LOCK_UN or die $!;
     sleep 1;
     exit 0;
 };
diff --git a/t/06-autorestart.t b/t/06-autorestart.t
index 9401500..58e98d1 100644
--- a/t/06-autorestart.t
+++ b/t/06-autorestart.t
@@ -1,6 +1,7 @@
 use strict;
 use warnings;
 
+use Fcntl qw&#40;:flock&#41;;
 use File::Temp &#40;&#41;;
 use Test::TCP;
 use Test::More tests =&gt; 26;
@@ -61,9 +62,12 @@ for my $signal_on_hup &#40;&#39;TERM&#39;, &#39;USR1&#39;&#41; {
                 &#39;status after auto-restart&#39;&#41;;
             is&#40;
                 do {
-                    open my $fh, &#39;&lt;&#39;, &#34;$tempdir/signame&#34;
+                    open my $fh, &#39;+&lt;&#39;, &#34;$tempdir/signame&#34;
                         or die $!;
-                    &lt;$fh&gt;;
+                    flock $fh, LOCK_EX or die $!;
+                    my $signal = &lt;$fh&gt;;
+                    flock $fh, LOCK_UN or die $!;
+                    $signal;
                 },
                 $signal_on_hup,
                 &#39;signal sent on hup&#39;,
-- 
1.9.3

</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
