<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #122252 for Future-AsyncAwait: Support perl version 5.14</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #122252 for Future-AsyncAwait: Support perl version 5.14</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Future-AsyncAwait">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Future-AsyncAwait">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Future-AsyncAwait">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Future-AsyncAwait">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Future-AsyncAwait">Future-AsyncAwait CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">122252</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">stalled</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Future-AsyncAwait">Future-AsyncAwait</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
leonerd-cpan [...] leonerd.org.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-267710-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-267711-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=122252">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1735509" href="/Public/Bug/Display.html?id=122252#txn-1735509">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;27&nbsp;11:54:01&nbsp;2017</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Support perl versions prior to 5.24</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1735509/933247/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/933247">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 415b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Current implementation of the code requires 5.24+ for a variety of reasons, most notably the context stack rework that turned up around then.

Ideally it would be nice to be able to support all the way to 5.14, when custom keywords were added. This may require some amount of compatibility shim around the context stack however.

&#40;&#40;split out from <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=121569&#41;&#41;">https://rt.cpan.org/Ticket/Display.html?id=121569&#41;&#41;</a></span>

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1735523" href="/Public/Bug/Display.html?id=122252#txn-1735523">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;27&nbsp;12:09:17&nbsp;2017</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1735523/933257/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/933257">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 111b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Or, so as not to confuse RT&#39;s URL parser:

  <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=121569">https://rt.cpan.org/Ticket/Display.html?id=121569</a></span>

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1764781" href="/Public/Bug/Display.html?id=122252#txn-1764781">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;07&nbsp;13:05:25&nbsp;2018</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1764781/949796/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/949796">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 126b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Some information may be found in

  <span class="clickylink"><a target="new" rel="nofollow" href="https://www.nntp.perl.org/group/perl.perl5.porters/2016/01/msg233631.html">https://www.nntp.perl.org/group/perl.perl5.porters/2016/01/msg233631.html</a></span>

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1764796" href="/Public/Bug/Display.html?id=122252#txn-1764796">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;07&nbsp;16:58:42&nbsp;2018</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1764796/949808/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/949808">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 148b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span class="clickylink"><a target="new" rel="nofollow" href="https://perl5.git.perl.org/perl.git/commitdiff/9d876b687d12d77fcb1012f1b865783476f00c7a?hp=d5eedefea11231da8139c9478d2c9069346b6560">https://perl5.git.perl.org/perl.git/commitdiff/9d876b687d12d77fcb1012f1b865783476f00c7a?hp=d5eedefea11231da8139c9478d2c9069346b6560</a></span>

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1765794" href="/Public/Bug/Display.html?id=122252#txn-1765794">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;15&nbsp;12:26:54&nbsp;2018</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1765794/950293/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/950293">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 473b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I now have an almost-working initial attempt on 5.22. Most things work, but one does not.

The not-working test is the one about foreach loops, as it seems to have trouble saving and restoring the iterator variable which is part of the pre-5.24 context stack entries. There doesn&#39;t seem to be equivalent in the 5.24 reworked version of that for me to copy from, so it seems new things need adding. As yet I&#39;ve not quite worked out how it all fits together.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1765818" href="/Public/Bug/Display.html?id=122252#txn-1765818">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;15&nbsp;13:23:23&nbsp;2018</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1765818/950305/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/950305">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 211b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jan 15 12:26:54 2018, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I now have an almost-working initial attempt on 5.22. Most things
&gt; work, but one does not.
</div>
perl 5.22 now works as of -r121

I&#39;m now looking at 5.20

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1765822" href="/Public/Bug/Display.html?id=122252#txn-1765822">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;15&nbsp;14:06:17&nbsp;2018</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1765822/950307/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/950307">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 78b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Future-AsyncAwait 0.12 now supports back as far as perl 5.20.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1765823" href="/Public/Bug/Display.html?id=122252#txn-1765823">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;15&nbsp;14:06:27&nbsp;2018</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Subject changed from &#39;Support perl versions prior to 5.24&#39; to &#39;Support perl versions prior to 5.20&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1765982" href="/Public/Bug/Display.html?id=122252#txn-1765982">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;16&nbsp;11:13:32&nbsp;2018</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Subject changed from &#39;Support perl versions prior to 5.20&#39; to &#39;Support perl versions prior to 5.18&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1765983" href="/Public/Bug/Display.html?id=122252#txn-1765983">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;16&nbsp;11:16:57&nbsp;2018</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1765983/950394/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/950394">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 624b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Latest development version now supports 5.18.

Earlier than that, looking at 5.16.

Making it compile isn&#39;t too hard - SAVEt_STRLEN needs to be #ifdef&#39;ed out and a suitable SAVEt_INT_SMALL in replacement. The PADNAMEs structures need some compatibility macros.

However, actually making it work and pass tests seems more difficult. There appears to be something odd about closures, that mean inner closures created after the first &#39;await&#39; op don&#39;t work as expected, with captured lexical failing to stay shared. It may need some more research on how to make that work, but I think for now I&#39;ll stop at 5.18.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1765998" href="/Public/Bug/Display.html?id=122252#txn-1765998">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;16&nbsp;12:04:58&nbsp;2018</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1765998/950401/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/950401">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jan 16 11:16:57 2018, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Latest development version now supports 5.18.
&gt; 
&gt; Earlier than that, looking at 5.16.
&gt; 
&gt; Making it compile isn&#39;t too hard - SAVEt_STRLEN needs to be #ifdef&#39;ed
&gt; out and a suitable SAVEt_INT_SMALL in replacement. The PADNAMEs
&gt; structures need some compatibility macros.
&gt; 
&gt; However, actually making it work and pass tests seems more difficult.
&gt; There appears to be something odd about closures, that mean inner
&gt; closures created after the first &#39;await&#39; op don&#39;t work as expected,
&gt; with captured lexical failing to stay shared. It may need some more
&gt; research on how to make that work, but I think for now I&#39;ll stop at
&gt; 5.18.
</div>
I tried running ‘git log v5.16.0..v5.18.0 pad.c’ to jog my memory of what changed regarding closures, an area I have been involved in in recent years.  It looks as though you may be running into old bugs that have since been fixed.  See this commit, for instance:

commit cae5dbbe30ba4a96ff5e570be0d90779f06fee71
Author: Father Chrysostomos &lt;sprout@cpan.org&gt;
Date:   Sat Aug 4 14:42:47 2012 -0700

    Close over stale vars in active subs

&#40;I won’t repeat the whole commit message here.  It’s long.&#41;

But most of the other bugs fixed back then had to do with formats closing over the wrong pad and crashing.  And in the git log output there is a whole bunch of lexical sub stuff that you probably want to skip.

I know I’m not being that helpful.  But I thought I would at least take a look and report my meagre findings.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1765999" href="/Public/Bug/Display.html?id=122252#txn-1765999">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;16&nbsp;12:04:59&nbsp;2018</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1766005" href="/Public/Bug/Display.html?id=122252#txn-1766005">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;16&nbsp;12:23:45&nbsp;2018</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1766005/950407/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/950407">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jan 16 12:04:58 2018, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I tried running ‘git log v5.16.0..v5.18.0 pad.c’ to jog my memory of
&gt; what changed regarding closures, an area I have been involved in in
&gt; recent years.  It looks as though you may be running into old bugs
&gt; that have since been fixed.  See this commit, for instance:
&gt; 
&gt; commit cae5dbbe30ba4a96ff5e570be0d90779f06fee71
&gt; Author: Father Chrysostomos &lt;sprout@cpan.org&gt;
&gt; Date:   Sat Aug 4 14:42:47 2012 -0700
&gt; 
&gt; Close over stale vars in active subs
&gt; 
&gt; &#40;I won’t repeat the whole commit message here.  It’s long.&#41;
</div>
For convenience the full commit is at

  <span class="clickylink"><a target="new" rel="nofollow" href="https://perl5.git.perl.org/perl.git/commit/cae5dbbe30ba4a96ff5e570be0d90779f06fee71">https://perl5.git.perl.org/perl.git/commit/cae5dbbe30ba4a96ff5e570be0d90779f06fee71</a></span>

The full description does indeed sound like it might be related though.

Looking at the commit diff though, it suggests that if my test was affected by this bug I&#39;d be seeing lots of

  Variable $foo is not available

warnings, which I&#39;m not.

Still, an easy test might be to temporarily SvPADSTALE_off&#40;&#41; all the PAD slots during cloning, just to artificially trick clone_sv&#40;&#41; into keeping them.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1767180" href="/Public/Bug/Display.html?id=122252#txn-1767180">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;22&nbsp;10:39:43&nbsp;2018</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1767180/951106/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/951106">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Actually, most of the failures in 5.16 turn out to be fixed by bugfixes applied in F-AA 0.14, relating to the way that outer lexical captures are handled by `cv_clone&#40;&#41;`. Now, running against 5.16 the only failure is

t/10pad.t .............. 1/? 
#   Failed test &#39;$captured in subD&#39;
#   at t/10pad.t line 118.
#          got: undef
#     expected: &#39;ABC&#39;

#   Failed test &#39;$fret now ready after done for inner subs&#39;
#   at t/10pad.t line 137.
#          got: &#39;ABCE&#39;
#     expected: &#39;ABCDE&#39;
# Looks like you failed 2 tests of 10.
t/10pad.t .............. Dubious, test returned 2 &#40;wstat 512, 0x200&#41;

Ignoring that momentarily and looking ahead to 5.14, it seems it won&#39;t compile because 5.14 doesn&#39;t provide a `cv_clone&#40;&#41;`. That feels a potentially harder one to work around at 5.14.

That said, given all the hackery F-AA 0.14 has had to add to work around the fact that `cv_clone&#40;&#41;` doesn&#39;t do the right thing for the odd case that we&#39;re presenting to it here, it might be worth looking into whether a different solution can be found that implements a CV copying function that will work better for us, than calling cv_clone - the latter being designed to copy protosubs into new anonsubs, which isn&#39;t really what we&#39;re using it for.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1767527" href="/Public/Bug/Display.html?id=122252#txn-1767527">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;23&nbsp;21:46:58&nbsp;2018</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1767527/951296/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/951296">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jan 22 10:39:43 2018, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ignoring that momentarily and looking ahead to 5.14, it seems it won&#39;t
&gt; compile because 5.14 doesn&#39;t provide a `cv_clone&#40;&#41;`. That feels a
&gt; potentially harder one to work around at 5.14.
&gt; 
&gt; That said, given all the hackery F-AA 0.14 has had to add to work
&gt; around the fact that `cv_clone&#40;&#41;` doesn&#39;t do the right thing for the
&gt; odd case that we&#39;re presenting to it here, it might be worth looking
&gt; into whether a different solution can be found that implements a CV
&gt; copying function that will work better for us, than calling cv_clone -
&gt; the latter being designed to copy protosubs into new anonsubs, which
&gt; isn&#39;t really what we&#39;re using it for.
</div>
With the new replacement of cv_clone&#40;&#41; now in latest development commit, 5.16 looks exactly the same - still fails this test. I might have to deploy Devel::MAT at the moment $subD is created to inspect its pad and see what happened there.

Looking at 5.14 the situation is *slightly* improved - fails to compile still due to lack of `pad_new&#40;&#41;` but as the pad structure on 5.14 was all bare AVs, this should be an easy one to provide by hax.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1767528" href="/Public/Bug/Display.html?id=122252#txn-1767528">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;23&nbsp;22:13:15&nbsp;2018</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1767528/951297/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/951297">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1004b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jan 23 21:46:58 2018, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; With the new replacement of cv_clone&#40;&#41; now in latest development
&gt; commit, 5.16 looks exactly the same - still fails this test. I might
&gt; have to deploy Devel::MAT at the moment $subD is created to inspect
&gt; its pad and see what happened there.
</div>
As I suspected; `$captured` has captured the wrong thing. On t/10pad.t line 122 after $subD has been created, it already looks like:

    [  4/$captured]=SCALAR&#40;PV&#41; at 0x1e771c8 = &#34;ABC&#34;
  ...
    [  9/$subD    ]=REF&#40;&#41; at 0x1e77090 =&gt; CODE&#40;PP,C&#41; at 0x1e3e0b8

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">  pmat&gt; show 0x1e3e0b8
</div>  CODE&#40;PP,C&#41; at 0x1e3e0b8 with refcount 1
  ...
    pad[0]=PAD&#40;4&#41; at 0x1e3e3e8

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">  pmat&gt; show 0x1e3e3e8
</div>  PAD&#40;4&#41; at 0x1e3e3e8 with refcount 1
  ...
    [  1/$captured]=NULL

So it appears that the 5.16 implementation of cv_clone&#40;&#41; here that&#39;s called as part of the OP_REFGEN op in the optree to implement

  my $subD = sub { ... };

has found the wrong `$captured` lexical. I wonder if we can patch this up somehow.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1767544" href="/Public/Bug/Display.html?id=122252#txn-1767544">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;23&nbsp;23:04:06&nbsp;2018</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Subject changed from &#39;Support perl versions prior to 5.18&#39; to &#39;Support perl version 5.14&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1767545" href="/Public/Bug/Display.html?id=122252#txn-1767545">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;23&nbsp;23:05:19&nbsp;2018</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1767545/951309/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/951309">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 267b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jan 23 22:13:15 2018, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I wonder if we can patch this up somehow.
</div>
Turns out in summary: yes we can.

Latest devel &#40;will become 0.15&#41; supports 5.16.

All that remains now is 5.14, and that has /lots/ of test failures right now :&#40;

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1828353" href="/Public/Bug/Display.html?id=122252#txn-1828353">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;09&nbsp;10:17:39&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.610348</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
