<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #74653 for ZeroMQ: segmentation fault using send</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #74653 for ZeroMQ: segmentation fault using send</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/ZeroMQ/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/ZeroMQ/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/ZeroMQ/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/ZeroMQ/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/ZeroMQ">ZeroMQ CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">74653</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/ZeroMQ/Active/">ZeroMQ</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mark [...] blackmans.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-233900-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.20    </td>
  </tr>
  <tr id="CF-233901-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;03&nbsp;05:03:04&nbsp;2012</span>
    <span class="description">mark [...] blackmans.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> segmentation fault using send</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Using gdb I get the following backtrace when using a script that has a
problem with zmq send after about 1800 message sends.


Program received signal EXC_BAD_ACCESS, Could not access memory.
Reason: KERN_INVALID_ADDRESS at address: 0x0000000136373831
0x0000000100001d47 in Perl_malloc &#40;&#41;
&#40;gdb&#41; bt
#0  0x0000000100001d47 in Perl_malloc &#40;&#41;
#1  0x0000000100002eaf in Perl_calloc &#40;&#41;
#2  0x00000001017b6098 in XS_ZeroMQ__Raw_zmq_send &#40;cv=0x104aa3fd0&#41; at 
perl_zeromq.xs:537
#3  0x00000001000874ae in Perl_pp_entersub &#40;&#41;
#4  0x000000010007f456 in Perl_runops_standard &#40;&#41;
#5  0x000000010007bc35 in perl_run &#40;&#41;
#6  0x00000001000010bc in main &#40;&#41;

This ZeroMQ 0.20 with Perl 5.10.0 on OS X SnowLeopard. The perl was built with Perl&#39;s malloc.

Summary of my perl5 &#40;revision 5 version 10 subversion 0&#41; configuration:
  Platform:
    osname=darwin, osvers=10.8.0, archname=darwin-2level
    uname=&#39;darwin markimac.fairfx.local 10.8.0 darwin kernel version 10.8.0: tue jun 7 
16:33:36 pdt 2011; root:xnu-1504.15.3~1release_i386 i386 &#39;
    config_args=&#39;-de -Dprefix=/Volumes/cs/MBlackman/perl5/perlbrew/perls/perl-5.10.0 -
Dusemymalloc -Accflags=-DPERL_DEBUGGING_MSTATS&#39;
    hint=recommended, useposix=true, d_sigaction=define
    useithreads=undef, usemultiplicity=undef
    useperlio=define, d_sfio=undef, uselargefiles=define, usesocks=undef
    use64bitint=define, use64bitall=define, uselongdouble=undef
    usemymalloc=y, bincompat5005=undef
  Compiler:
    cc=&#39;cc&#39;, ccflags =&#39;-fno-common -DPERL_DARWIN -DPERL_DEBUGGING_MSTATS -fno-
strict-aliasing -pipe -I/usr/local/include -I/opt/local/include&#39;,
    optimize=&#39;-O3&#39;,
    cppflags=&#39;-fno-common -DPERL_DARWIN -DPERL_DEBUGGING_MSTATS -fno-strict-
aliasing -pipe -I/usr/local/include -I/opt/local/include&#39;
    ccversion=&#39;&#39;, gccversion=&#39;4.2.1 &#40;Apple Inc. build 5666&#41; &#40;dot 3&#41;&#39;, gccosandvers=&#39;&#39;
    intsize=4, longsize=8, ptrsize=8, doublesize=8, byteorder=12345678
    d_longlong=define, longlongsize=8, d_longdbl=define, longdblsize=16
    ivtype=&#39;long&#39;, ivsize=8, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;off_t&#39;, lseeksize=8
    alignbytes=8, prototype=define
  Linker and Libraries:
    ld=&#39;env MACOSX_DEPLOYMENT_TARGET=10.3 cc&#39;, ldflags =&#39; -L/usr/local/lib -L/opt/local/
lib&#39;
    libpth=/usr/local/lib /opt/local/lib /usr/lib
    libs=-lgdbm -ldbm -ldl -lm -lutil -lc
    perllibs=-ldl -lm -lutil -lc
    libc=, so=dylib, useshrplib=false, libperl=libperl.a
    gnulibc_version=&#39;&#39;
  Dynamic Linking:
    dlsrc=dl_dlopen.xs, dlext=bundle, d_dlsymun=undef, ccdlflags=&#39; &#39;
    cccdlflags=&#39; &#39;, lddlflags=&#39; -bundle -undefined dynamic_lookup -L/usr/local/lib -L/opt/
local/lib&#39;


Characteristics of this binary &#40;from libperl&#41;: 
  Compile-time options: MYMALLOC PERL_DONT_CREATE_GVSV PERL_MALLOC_WRAP
                        USE_64_BIT_ALL USE_64_BIT_INT USE_LARGE_FILES
                        USE_PERLIO
  Built under darwin
  Compiled at Dec 15 2011 11:07:41
  %ENV:
    PERL5LIB=&#34;FX/lib:/Volumes/cs/MBlackman/perl5/profiles/main/lib/perl5/darwin-2level:/
Volumes/cs/MBlackman/perl5/profiles/main/lib/perl5&#34;
    PERLBREW_HOME=&#34;/Volumes/cs/MBlackman/.perlbrew&#34;
    PERLBREW_PATH=&#34;/Volumes/cs/MBlackman/perl5/perlbrew/bin:/Volumes/cs/MBlackman/
perl5/perlbrew/perls/perl-5.10.0/bin&#34;
    PERLBREW_PERL=&#34;perl-5.10.0&#34;
    PERLBREW_ROOT=&#34;/Volumes/cs/MBlackman/perl5/perlbrew&#34;
    PERLBREW_VERSION=&#34;0.29&#34;
    PERL_LOCAL_LIB_ROOT=&#34;/Volumes/cs/MBlackman/perl5/profiles/main&#34;
    PERL_MB_OPT=&#34;--install_base /Volumes/cs/MBlackman/perl5/profiles/main&#34;
    PERL_MM_OPT=&#34;INSTALL_BASE=/Volumes/cs/MBlackman/perl5/profiles/main&#34;
  @INC:
    FX/lib
    /Volumes/cs/MBlackman/perl5/profiles/main/lib/perl5/darwin-2level
    /Volumes/cs/MBlackman/perl5/profiles/main/lib/perl5/darwin-2level
    /Volumes/cs/MBlackman/perl5/profiles/main/lib/perl5
    /Volumes/cs/MBlackman/perl5/perlbrew/perls/perl-5.10.0/lib/5.10.0/darwin-2level
    /Volumes/cs/MBlackman/perl5/perlbrew/perls/perl-5.10.0/lib/5.10.0
    /Volumes/cs/MBlackman/perl5/perlbrew/perls/perl-5.10.0/lib/site_perl/5.10.0/
darwin-2level
    /Volumes/cs/MBlackman/perl5/perlbrew/perls/perl-5.10.0/lib/site_perl/5.10.0
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;03&nbsp;05:20:17&nbsp;2012</span>
    <span class="description">mark [...] blackmans.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mark [...] blackmans.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">While the seg. fault is within Perl_malloc, I&#39;ve got a feeling this is how a memory leak is being 
manifested, as malloc is hitting some ulimit size limits and segfaulting.

I&#39;ve not looked hard, but perhaps &#34;send&#34; is allocating objects that it&#39;s not releasing?

The code in question is just a simple loop around send like so.


my $ident=0;
while &#40;1&#41;{
  print STDERR &#34;sending &#34;.$ident++,&#34;\n&#34;;
  $sender-&gt;send&#40;$ident&#41;;
}

Usually around iteration 2000, we get the seg. fault. Increasing the ulimit stack size has 
sometimes but not always allowed us to get to iteration 17000


On Fri Feb 03 05:03:04 2012, mark@blackmans.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Using gdb I get the following backtrace when using a script that has a
&gt; problem with zmq send after about 1800 message sends.
&gt; 
&gt; 
&gt; Program received signal EXC_BAD_ACCESS, Could not access memory.
&gt; Reason: KERN_INVALID_ADDRESS at address: 0x0000000136373831
&gt; 0x0000000100001d47 in Perl_malloc &#40;&#41;
&gt; &#40;gdb&#41; bt
&gt; #0  0x0000000100001d47 in Perl_malloc &#40;&#41;
&gt; #1  0x0000000100002eaf in Perl_calloc &#40;&#41;
&gt; #2  0x00000001017b6098 in XS_ZeroMQ__Raw_zmq_send &#40;cv=0x104aa3fd0&#41; at
&gt; perl_zeromq.xs:537
&gt; #3  0x00000001000874ae in Perl_pp_entersub &#40;&#41;
&gt; #4  0x000000010007f456 in Perl_runops_standard &#40;&#41;
&gt; #5  0x000000010007bc35 in perl_run &#40;&#41;
&gt; #6  0x00000001000010bc in main &#40;&#41;
&gt; 
&gt; This ZeroMQ 0.20 with Perl 5.10.0 on OS X SnowLeopard. The perl was
&gt; built with Perl&#39;s malloc.
&gt; 
&gt; Summary of my perl5 &#40;revision 5 version 10 subversion 0&#41;
&gt; configuration:
&gt;   Platform:
&gt;     osname=darwin, osvers=10.8.0, archname=darwin-2level
&gt;     uname=&#39;darwin markimac.fairfx.local 10.8.0 darwin kernel version
&gt; 10.8.0: tue jun 7
&gt; 16:33:36 pdt 2011; root:xnu-1504.15.3~1release_i386 i386 &#39;
&gt;     config_args=&#39;-de
&gt; -Dprefix=/Volumes/cs/MBlackman/perl5/perlbrew/perls/perl-5.10.0 -
&gt; Dusemymalloc -Accflags=-DPERL_DEBUGGING_MSTATS&#39;
&gt;     hint=recommended, useposix=true, d_sigaction=define
&gt;     useithreads=undef, usemultiplicity=undef
&gt;     useperlio=define, d_sfio=undef, uselargefiles=define,
&gt; usesocks=undef
&gt;     use64bitint=define, use64bitall=define, uselongdouble=undef
&gt;     usemymalloc=y, bincompat5005=undef
&gt;   Compiler:
&gt;     cc=&#39;cc&#39;, ccflags =&#39;-fno-common -DPERL_DARWIN
&gt; -DPERL_DEBUGGING_MSTATS -fno-
&gt; strict-aliasing -pipe -I/usr/local/include -I/opt/local/include&#39;,
&gt;     optimize=&#39;-O3&#39;,
&gt;     cppflags=&#39;-fno-common -DPERL_DARWIN -DPERL_DEBUGGING_MSTATS
&gt; -fno-strict-
&gt; aliasing -pipe -I/usr/local/include -I/opt/local/include&#39;
&gt;     ccversion=&#39;&#39;, gccversion=&#39;4.2.1 &#40;Apple Inc. build 5666&#41; &#40;dot 3&#41;&#39;,
&gt; gccosandvers=&#39;&#39;
&gt;     intsize=4, longsize=8, ptrsize=8, doublesize=8, byteorder=12345678
&gt;     d_longlong=define, longlongsize=8, d_longdbl=define,
&gt; longdblsize=16
&gt;     ivtype=&#39;long&#39;, ivsize=8, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;off_t&#39;,
&gt; lseeksize=8
&gt;     alignbytes=8, prototype=define
&gt;   Linker and Libraries:
&gt;     ld=&#39;env MACOSX_DEPLOYMENT_TARGET=10.3 cc&#39;, ldflags =&#39;
&gt; -L/usr/local/lib -L/opt/local/
&gt; lib&#39;
&gt;     libpth=/usr/local/lib /opt/local/lib /usr/lib
&gt;     libs=-lgdbm -ldbm -ldl -lm -lutil -lc
&gt;     perllibs=-ldl -lm -lutil -lc
&gt;     libc=, so=dylib, useshrplib=false, libperl=libperl.a
&gt;     gnulibc_version=&#39;&#39;
&gt;   Dynamic Linking:
&gt;     dlsrc=dl_dlopen.xs, dlext=bundle, d_dlsymun=undef, ccdlflags=&#39; &#39;
&gt;     cccdlflags=&#39; &#39;, lddlflags=&#39; -bundle -undefined dynamic_lookup
&gt; -L/usr/local/lib -L/opt/
&gt; local/lib&#39;
&gt; 
&gt; 
&gt; Characteristics of this binary &#40;from libperl&#41;:
&gt;   Compile-time options: MYMALLOC PERL_DONT_CREATE_GVSV
&gt; PERL_MALLOC_WRAP
&gt;                         USE_64_BIT_ALL USE_64_BIT_INT USE_LARGE_FILES
&gt;                         USE_PERLIO
&gt;   Built under darwin
&gt;   Compiled at Dec 15 2011 11:07:41
&gt;   %ENV:
&gt;     PERL5LIB=&#34;FX/lib:/Volumes/cs/MBlackman/perl5/profiles/main/lib/perl5/darwin-
&gt; 2level:/
&gt; Volumes/cs/MBlackman/perl5/profiles/main/lib/perl5&#34;
&gt;     PERLBREW_HOME=&#34;/Volumes/cs/MBlackman/.perlbrew&#34;
&gt;     PERLBREW_PATH=&#34;/Volumes/cs/MBlackman/perl5/perlbrew/bin:/Volumes/cs/
</div>MBlackman/
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; perl5/perlbrew/perls/perl-5.10.0/bin&#34;
&gt;     PERLBREW_PERL=&#34;perl-5.10.0&#34;
&gt;     PERLBREW_ROOT=&#34;/Volumes/cs/MBlackman/perl5/perlbrew&#34;
&gt;     PERLBREW_VERSION=&#34;0.29&#34;
&gt;     PERL_LOCAL_LIB_ROOT=&#34;/Volumes/cs/MBlackman/perl5/profiles/main&#34;
&gt;     PERL_MB_OPT=&#34;--install_base
&gt; /Volumes/cs/MBlackman/perl5/profiles/main&#34;
&gt;     PERL_MM_OPT=&#34;INSTALL_BASE=/Volumes/cs/MBlackman/perl5/profiles/main&#34;
&gt;   @INC:
&gt;     FX/lib
&gt;     /Volumes/cs/MBlackman/perl5/profiles/main/lib/perl5/darwin-2level
&gt;     /Volumes/cs/MBlackman/perl5/profiles/main/lib/perl5/darwin-2level
&gt;     /Volumes/cs/MBlackman/perl5/profiles/main/lib/perl5
&gt;     /Volumes/cs/MBlackman/perl5/perlbrew/perls/perl-
&gt; 5.10.0/lib/5.10.0/darwin-2level
&gt;     /Volumes/cs/MBlackman/perl5/perlbrew/perls/perl-5.10.0/lib/5.10.0
&gt;     /Volumes/cs/MBlackman/perl5/perlbrew/perls/perl-
&gt; 5.10.0/lib/site_perl/5.10.0/
&gt; darwin-2level
&gt;     /Volumes/cs/MBlackman/perl5/perlbrew/perls/perl-
&gt; 5.10.0/lib/site_perl/5.10.0
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;03&nbsp;06:36:36&nbsp;2012</span>
    <span class="description">dmaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2012-2月-03 金 05:20:17, mark@blackmans.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; While the seg. fault is within Perl_malloc, I&#39;ve got a feeling this is
&gt; how a memory leak is being
&gt; manifested, as malloc is hitting some ulimit size limits and
&gt; segfaulting.
&gt; 
&gt; I&#39;ve not looked hard, but perhaps &#34;send&#34; is allocating objects that
&gt; it&#39;s not releasing?
&gt; 
&gt; The code in question is just a simple loop around send like so.
&gt; 
&gt; 
&gt; my $ident=0;
&gt; while &#40;1&#41;{
&gt;   print STDERR &#34;sending &#34;.$ident++,&#34;\n&#34;;
&gt;   $sender-&gt;send&#40;$ident&#41;;
&gt; }
&gt; 
&gt; Usually around iteration 2000, we get the seg. fault. Increasing the
&gt; ulimit stack size has
&gt; sometimes but not always allowed us to get to iteration 17000
&gt; 
</div>
Is the above code all that&#39;s required to reproduce the seg fault?
Can you make it a test case? 

If you can make it into a reliable test case, I&#39;d love to see it as a pull req to 
<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/lestrrat/ZeroMQ-Perl">http://github.com/lestrrat/ZeroMQ-Perl</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;03&nbsp;06:36:37&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;03&nbsp;10:02:37&nbsp;2012</span>
    <span class="description">mark [...] blackmans.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mark [...] blackmans.org</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 03 06:36:36 2012, DMAKI wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Is the above code all that&#39;s required to reproduce the seg fault?
</div>
Not quite, there&#39;s a bit of 0MQ initialization work to do as well and
and some receiver code. I&#39;ve attached both sides as scripts.
The point at which a segfault happens seems a bit variable
but always within 20k iterations, so far.

Not quite sure how to make this a test case that catches a perl segfault, unless
the work is spawned externally.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Can you make it a test case?
&gt; 
&gt; If you can make it into a reliable test case, I&#39;d love to see it as a
&gt; pull req to
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/lestrrat/ZeroMQ-Perl">http://github.com/lestrrat/ZeroMQ-Perl</a></span>
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> vent_zmq.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl

=pod

Task ventilator

Binds PUSH socket to tcp://localhost:5557

Sends batch of tasks to workers via that socket

Author: Alexander D&#39;Archangel &#40;darksuji&#41; &lt;darksuji&#40;at&#41;gmail&#40;dot&#41;com&gt;

=cut

use strict;
use warnings;
use 5.10.0;

use ZeroMQ qw/:all/;

sub within {
  my &#40;$upper&#41; = @_;

  return int&#40;rand&#40;$upper&#41;&#41; + 1;
}

my $context = ZeroMQ::Context-&gt;new&#40;&#41;;

#  Socket to send messages on
my $sender = $context-&gt;socket&#40;ZMQ_PUSH&#41;;
$sender-&gt;bind&#40;&#39;tcp://*:5557&#39;&#41;;

print &#39;Press Enter when the workers are ready: &#39;;
&lt;STDIN&gt;;
say &#39;Sending tasks to workers &#39;;

# The first message is &#34;0&#34; and signals start of batch
#$sender-&gt;send&#40;&#39;0&#39;&#41;;

my $ident=0;
while &#40;1&#41;{
  print STDERR &#34;sending &#34;.$ident++,&#34;\n&#34;;
  $sender-&gt;send&#40;$ident&#41;;
}
print STDERR &#34;done sending\n&#34;;
sleep&#40;1&#41;;              # Give 0MQ time to deliver
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> worker_zmq.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl

=pod

Task worker

Connects PULL socket to tcp://localhost:5557

Collects workloads from ventilator via that socket

Connects PUSH socket to tcp://localhost:5558

Sends results to sink via that socket

Author: Alexander D&#39;Archangel &#40;darksuji&#41; &lt;darksuji&#40;at&#41;gmail&#40;dot&#41;com&gt;

=cut

use strict;
use warnings;
use 5.10.0;

use IO::Handle;

use ZeroMQ qw/:all/;
use Time::HiRes qw/nanosleep/;
use English qw/-no_match_vars/;

use constant NSECS_PER_MSEC =&gt; 1000000;

my $nchild = 20;
my @pids;

foreach my $n &#40;1 .. $nchild&#41; {
  my $pid = fork&#40;&#41;;

  # if child start the worker, otherwise start another
  if &#40;!$pid&#41; {
    ############## WORKER CODE START #################
    my $context = ZeroMQ::Context-&gt;new&#40;&#41;;

    # Socket to receive messages on
    my $receiver = $context-&gt;socket&#40;ZMQ_PULL&#41;;
    $receiver-&gt;connect&#40;&#39;tcp://localhost:5557&#39;&#41;;

    # Socket to send messages to
    my $sender = $context-&gt;socket&#40;ZMQ_PUSH&#41;;
    $sender-&gt;connect&#40;&#39;tcp://localhost:5558&#39;&#41;;

    # Process tasks forever
    while &#40;1&#41; {
      my $string = $receiver-&gt;recv&#40;&#41;-&gt;data;
      my $time   = $string * NSECS_PER_MSEC;
      # Simple progress indicator for the viewer
      STDOUT-&gt;printflush&#40;&#34;$string.&#34;&#41;;

      # Send results to sink
      $sender-&gt;send&#40;&#39;&#39;&#41;;
    }
    exit&#40;0&#41;;    #exit the child
    ############## WORKER CODE END #################
  }
  # this is executed only in parent
  say &#34;started $pid\n&#34;;
  push&#40;@pids, $pid&#41;;
}

while &#40;wait &gt; 0&#41;{ say &#34;child exited&#34; };    #wait for all children to die

# send a message back to the &#34;ventilator&#34; saying we&#39;re all done
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;03&nbsp;17:12:58&nbsp;2012</span>
    <span class="description">dmaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Not quite, there&#39;s a bit of 0MQ initialization work to do as well and
&gt; and some receiver code. I&#39;ve attached both sides as scripts.
&gt; The point at which a segfault happens seems a bit variable
&gt; but always within 20k iterations, so far.
&gt; 
&gt; Not quite sure how to make this a test case that catches a perl
&gt; segfault, unless
&gt; the work is spawned externally.
</div>
Attached is what distilled from your script. Does this cause a segfault?
FYI, on my mac with perl-5.14.2 non-threaded, this works fine.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt74653.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use Test::More;
use Test::TCP;
use ZeroMQ qw&#40;:all&#41;;

my $MAX_MESSAGES = 2_500;

my $server = Test::TCP-&gt;new&#40;code =&gt; sub {
    my $port = shift;
    my $context = ZeroMQ::Context-&gt;new&#40;&#41;;
    my $sender = $context-&gt;socket&#40;ZMQ_PUSH&#41;;
    $sender-&gt;bind&#40;&#34;tcp://*:$port&#34;&#41;;

    # XXX hacky synchronization
    sleep 3;

    # The first message is &#34;0&#34; and signals start of batch
    #$sender-&gt;send&#40;&#39;0&#39;&#41;;

    my $ident=0;
    while &#40;$ident &lt; $MAX_MESSAGES&#41; {
        note &#34;sending &#34;.$ident++,&#34;\n&#34;;
        $sender-&gt;send&#40;$ident&#41;;
    }

    note &#34;Done sending&#34;;
    sleep&#40;1&#41;;              # Give 0MQ time to deliver
}&#41;;

{
    my $context = ZeroMQ::Context-&gt;new&#40;&#41;;

    # Socket to receive messages on
    my $receiver = $context-&gt;socket&#40;ZMQ_PULL&#41;;
    $receiver-&gt;connect&#40;&#34;tcp://localhost:&#34; . $server-&gt;port&#41;;

    for my $expected &#40;1..$MAX_MESSAGES&#41; {
        my $msg = $receiver-&gt;recv&#40;&#41;;
        is $msg-&gt;data, $expected;
    }
}

undef $server;

done_testing;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;04&nbsp;10:40:55&nbsp;2012</span>
    <span class="description">mark [...] blackmans.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mark [...] blackmans.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Looks like perl-5.10.0 OS X Lion no perlmalloc also exhibits a problem.

  501 15698  3004   0  31  0  2439348   8392 -      S+   s002    0:00.52 /Users/mark/perl5/
perlbrew/perls/perl-5.10.0/bin/perl -w /Users/mark/perl5/perlbrew/perls/perl-5.10.0/bin/
prove -v rt74653.t
  501 15699 15698   0  31  0  2448976   8568 -      S+   s002    0:09.48 /Users/mark/perl5/
perlbrew/perls/perl-5.10.0/bin/perl rt74653.t
  501 15700 15699   0   0  0        0      0 -      Z+   s002    0:00.00 &#40;perl&#41;
  501 15829 15498   0  31  0  2434892    532 -      S+   s003    0:00.00 grep perl

Died around iteration 763 and just hung &#40;as you can see the Zombie process that was the 
feeder thread presumably&#41;

I also get a segfault when I run my script pair. I&#39;ve seen a few positive results on other perl 
versions, so it feels like a perl 5.10.0 allocation bug being exercised.  But I&#39;ll try 5.10.1 next 
and confirm the segfault goes away there.

On Fri Feb 03 17:12:58 2012, DMAKI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt; Not quite, there&#39;s a bit of 0MQ initialization work to do as well and
&gt; &gt; and some receiver code. I&#39;ve attached both sides as scripts.
&gt; &gt; The point at which a segfault happens seems a bit variable
&gt; &gt; but always within 20k iterations, so far.
&gt; &gt; 
&gt; &gt; Not quite sure how to make this a test case that catches a perl
&gt; &gt; segfault, unless
&gt; &gt; the work is spawned externally.
</div>&gt; 
&gt; Attached is what distilled from your script. Does this cause a segfault?
&gt; FYI, on my mac with perl-5.14.2 non-threaded, this works fine.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;06&nbsp;06:20:28&nbsp;2012</span>
    <span class="description">mark [...] blackmans.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mark [...] blackmans.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Running the test scripts on OS X Snow Leopard, perl 5.10.0 with system
malloc results in *NO* segmentation fault, which is a bit inconsistent with
the result indicated below as it&#39;s hard to imagine that OS X Lion would
result in this kind of regression. 

I think I&#39;ll have to retest Lion with system malloc.

In any case, this is not a ZeroMQ bug I&#39;m sure,  so I&#39;ll treat it as resolved.


On Sat Feb 04 10:40:55 2012, mark@blackmans.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Looks like perl-5.10.0 OS X Lion no perlmalloc also exhibits a
&gt; problem.
&gt; 
&gt;   501 15698  3004   0  31  0  2439348   8392 -      S+   s002
&gt; 0:00.52 /Users/mark/perl5/
&gt; perlbrew/perls/perl-5.10.0/bin/perl -w
&gt; /Users/mark/perl5/perlbrew/perls/perl-5.10.0/bin/
&gt; prove -v rt74653.t
&gt;   501 15699 15698   0  31  0  2448976   8568 -      S+   s002
&gt; 0:09.48 /Users/mark/perl5/
&gt; perlbrew/perls/perl-5.10.0/bin/perl rt74653.t
&gt;   501 15700 15699   0   0  0        0      0 -      Z+   s002
&gt; 0:00.00 &#40;perl&#41;
&gt;   501 15829 15498   0  31  0  2434892    532 -      S+   s003
&gt; 0:00.00 grep perl
&gt; 
&gt; Died around iteration 763 and just hung &#40;as you can see the Zombie
&gt; process that was the
&gt; feeder thread presumably&#41;
&gt; 
&gt; I also get a segfault when I run my script pair. I&#39;ve seen a few
&gt; positive results on other perl
&gt; versions, so it feels like a perl 5.10.0 allocation bug being
&gt; exercised.  But I&#39;ll try 5.10.1 next
&gt; and confirm the segfault goes away there.
&gt; 
&gt; On Fri Feb 03 17:12:58 2012, DMAKI wrote:
<div class="message-stanza open">&gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; Not quite, there&#39;s a bit of 0MQ initialization work to do as well
</div></div>&gt; and
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; and some receiver code. I&#39;ve attached both sides as scripts.
&gt; &gt; &gt; The point at which a segfault happens seems a bit variable
&gt; &gt; &gt; but always within 20k iterations, so far.
&gt; &gt; &gt;
&gt; &gt; &gt; Not quite sure how to make this a test case that catches a perl
&gt; &gt; &gt; segfault, unless
&gt; &gt; &gt; the work is spawned externally.
</div>&gt; &gt;
&gt; &gt; Attached is what distilled from your script. Does this cause a
</div>&gt; segfault?
<div class="message-stanza open">&gt; &gt; FYI, on my mac with perl-5.14.2 non-threaded, this works fine.
</div>&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;06&nbsp;09:58:56&nbsp;2012</span>
    <span class="description">mark [...] blackmans.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mark [...] blackmans.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve confirmed that the original report on Lion must have been mistaken and
perl 5.10.0 with system malloc on Lion doesn&#39;t result in the segmentation
fault and I&#39;m concluding this bug is exclusive to perl malloc in 5.10.0
at least. I&#39;ve not tested later versions with perl malloc.

On Mon Feb 06 06:20:28 2012, mark@blackmans.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Running the test scripts on OS X Snow Leopard, perl 5.10.0 with system
&gt; malloc results in *NO* segmentation fault, which is a bit inconsistent
&gt; with
&gt; the result indicated below as it&#39;s hard to imagine that OS X Lion
&gt; would
&gt; result in this kind of regression.
&gt; 
&gt; I think I&#39;ll have to retest Lion with system malloc.
&gt; 
&gt; In any case, this is not a ZeroMQ bug I&#39;m sure,  so I&#39;ll treat it as
&gt; resolved.
&gt; 
&gt; 
&gt; On Sat Feb 04 10:40:55 2012, mark@blackmans.org wrote:
<div class="message-stanza open">&gt; &gt; Looks like perl-5.10.0 OS X Lion no perlmalloc also exhibits a
&gt; &gt; problem.
&gt; &gt;
&gt; &gt;   501 15698  3004   0  31  0  2439348   8392 -      S+   s002
&gt; &gt; 0:00.52 /Users/mark/perl5/
&gt; &gt; perlbrew/perls/perl-5.10.0/bin/perl -w
&gt; &gt; /Users/mark/perl5/perlbrew/perls/perl-5.10.0/bin/
&gt; &gt; prove -v rt74653.t
&gt; &gt;   501 15699 15698   0  31  0  2448976   8568 -      S+   s002
&gt; &gt; 0:09.48 /Users/mark/perl5/
&gt; &gt; perlbrew/perls/perl-5.10.0/bin/perl rt74653.t
&gt; &gt;   501 15700 15699   0   0  0        0      0 -      Z+   s002
&gt; &gt; 0:00.00 &#40;perl&#41;
&gt; &gt;   501 15829 15498   0  31  0  2434892    532 -      S+   s003
&gt; &gt; 0:00.00 grep perl
&gt; &gt;
&gt; &gt; Died around iteration 763 and just hung &#40;as you can see the Zombie
&gt; &gt; process that was the
&gt; &gt; feeder thread presumably&#41;
&gt; &gt;
&gt; &gt; I also get a segfault when I run my script pair. I&#39;ve seen a few
&gt; &gt; positive results on other perl
&gt; &gt; versions, so it feels like a perl 5.10.0 allocation bug being
&gt; &gt; exercised.  But I&#39;ll try 5.10.1 next
&gt; &gt; and confirm the segfault goes away there.
&gt; &gt;
&gt; &gt; On Fri Feb 03 17:12:58 2012, DMAKI wrote:
<div class="message-stanza open">&gt; &gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; &gt; Not quite, there&#39;s a bit of 0MQ initialization work to do as
</div></div></div>&gt; well
<div class="message-stanza open">&gt; &gt; and
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; and some receiver code. I&#39;ve attached both sides as scripts.
&gt; &gt; &gt; &gt; The point at which a segfault happens seems a bit variable
&gt; &gt; &gt; &gt; but always within 20k iterations, so far.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Not quite sure how to make this a test case that catches a perl
&gt; &gt; &gt; &gt; segfault, unless
&gt; &gt; &gt; &gt; the work is spawned externally.
</div>&gt; &gt; &gt;
&gt; &gt; &gt; Attached is what distilled from your script. Does this cause a
</div>&gt; &gt; segfault?
<div class="message-stanza open">&gt; &gt; &gt; FYI, on my mac with perl-5.14.2 non-threaded, this works fine.
</div>&gt; &gt;
</div>&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
