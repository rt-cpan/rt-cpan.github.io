<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #24256 for RDF-Core: RDF::Core::Storage::Memory is slow for large files</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #24256 for RDF-Core: RDF::Core::Storage::Memory is slow for large files</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/RDF-Core/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/RDF-Core/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/RDF-Core/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/RDF-Core/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/RDF-Core">RDF-Core CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">24256</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/RDF-Core/Active/">RDF-Core</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">dan [...] gingerall.cz
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
nwetters [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-27598-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-27599-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;07&nbsp;03:03:21&nbsp;2007</span>
    <span class="description">nwetters [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RDF::Core::Storage::Memory is slow for large files</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">When parsing RDF files larger than a few megabytes, Memory.pm uses too
much RAM and is too slow to be usable. I wrote a replacement, which is
attached.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Memory.pm</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">package RDF::Core::Storage::Memory;
use warnings;
use strict;
use Carp;

use vars qw &#40; $VERSION &#41;;
$RDF::Core::Storage::Memory::VERSION = &#39;1.00&#39;;

use RDF::Core::Enumerator::Memory;
use constant _SUBJECT      =&gt; 0;
use constant _SUBJECTS     =&gt; 0;
use constant _OBJECT       =&gt; 1;
use constant _OBJECTS      =&gt; 1;
use constant _PREDICATE    =&gt; 2;
use constant _DATA         =&gt; 2;
use constant _DELETED_DATA =&gt; 3;
use constant _COUNTER      =&gt; 4;

sub new
{
    my &#40;$pkg,%options&#41; = @_;
    my $class = ref $pkg || $pkg;
    
    my $struct = [ 
		   {},   # index of subjects
		   {},   # index of objects

		   [],   # data
		   [],   # deleted data indices

		   0     # next index ID
    ];

    my $self = bless $struct, $class;
    return $self;
}

sub addStmt
{
    my &#40;$self,$stmt&#41; = @_;
    my $subject = $stmt-&gt;getSubject&#40;&#41;;
    my $object = $stmt-&gt;getObject&#40;&#41;;
    my $predicate = $stmt-&gt;getPredicate&#40;&#41;;
    return 0 if $self-&gt;existsStmt&#40;$subject,$predicate,$object&#41;;

    my $subjectURI = $subject-&gt;getURI&#40;&#41;;
    if&#40;exists $self-&gt;[_SUBJECTS]-&gt;{$subjectURI}&#41;{
	$self-&gt;[_SUBJECTS]-&gt;{$subjectURI} .= pack&#40;&#39;L&#39;,$self-&gt;[_COUNTER]&#41;;
    } else {
	$self-&gt;[_SUBJECTS]-&gt;{$subjectURI} = pack&#40;&#39;L&#39;,$self-&gt;[_COUNTER]&#41;;
    }

    my $objectLabel = $object-&gt;getLabel&#40;&#41;;
    if&#40;exists $self-&gt;[_OBJECTS]-&gt;{$objectLabel}&#41;{
	$self-&gt;[_OBJECTS]-&gt;{$objectLabel} .= pack&#40;&#39;L&#39;,$self-&gt;[_COUNTER]&#41;;
    } else {
	$self-&gt;[_OBJECTS]-&gt;{$objectLabel} = pack&#40;&#39;L&#39;,$self-&gt;[_COUNTER]&#41;;
    }

    my $data = [];
    $data-&gt;[_SUBJECT]   = $subject;
    $data-&gt;[_OBJECT]    = $object;
    $data-&gt;[_PREDICATE] = $predicate;
    if&#40;$#{$self-&gt;[_DELETED_DATA]} &gt; -1&#41;{
	$self-&gt;[_DATA]-&gt;[pop @{$self-&gt;[_DELETED_DATA]}] = $data;
    } else {
	$self-&gt;[_DATA]-&gt;[$self-&gt;[_COUNTER]] = $data;
	$self-&gt;[_COUNTER]++;
    }
    return 1;
}

sub removeStmt
{
    my &#40;$self,$stmt&#41; = @_;
    
    my $subjectURI   = $stmt-&gt;getSubject-&gt;getURI&#40;&#41;   || return;
    my $predicateURI = $stmt-&gt;getPredicate-&gt;getURI&#40;&#41; || return;
    my $objectLabel  = $stmt-&gt;getObject-&gt;getLabel&#40;&#41;  || return;
    
    my $subjectIndices   = $self-&gt;_getSubjectIndicesByLabel&#40;$subjectURI&#41;   || return;
    my $objectIndices    = $self-&gt;_getObjectIndicesByLabel&#40;_OBJECTS,   $objectLabel&#41;  || return;
    
    my &#40;$index,%indexArrayCount&#41;;
    foreach&#40;@{$objectIndices}&#41;{
	$indexArrayCount{$_} = 1;
    }
    foreach&#40;@{$subjectIndices}&#41;{
	if&#40;exists $indexArrayCount{$_}&#41;{
	    if&#40;$self-&gt;[_DATA]-&gt;[$_]-&gt;[_PREDICATE]-&gt;getURI&#40;&#41; eq $predicateURI&#41;{
		$index = $_;
		last;
	    }
	}
    }
    return unless defined $index;
    
    $self-&gt;_removeIndexByTypeAndLabel&#40;_SUBJECTS,  $subjectURI,  $index&#41;;
    $self-&gt;_removeIndexByTypeAndLabel&#40;_OBJECTS,   $objectLabel, $index&#41;;
    $self-&gt;[_DATA]-&gt;[$index] = undef;
    push @{$self-&gt;[_DELETED_DATA]}, $index;
}

sub getStmts {
    my &#40;$self, $subject, $predicate, $object&#41; = @_;
    my $data = [];
    my $indices = $self-&gt;_getStmts&#40;$subject, $predicate, $object&#41;;
    foreach my $index&#40;@{$indices}&#41;{
	my $d = $self-&gt;[_DATA]-&gt;[$index];
	push @{$data}, RDF::Core::Statement-&gt;new&#40;$d-&gt;[_SUBJECT]-&gt;clone&#40;&#41;,
						 $d-&gt;[_PREDICATE]-&gt;clone&#40;&#41;,
						 $d-&gt;[_OBJECT]-&gt;clone&#40;&#41;&#41;;
    }
    return RDF::Core::Enumerator::Memory-&gt;new&#40;$data&#41; ;
}

sub countStmts
{
    my &#40;$self, $subject, $predicate, $object&#41; = @_;
    my $data = $self-&gt;_getStmts&#40;$subject, $predicate, $object&#41;;
    return $#{$data} + 1;
}

*existsStmt = \&#38;countStmts;

# PRIVATE METHODS BELOW
# DO NOT USE OUTSIDE THIS FILE!

sub _getSubjectIndicesByLabel
{
    my&#40;$self,$label&#41; = @_;
    if&#40;exists $self-&gt;[_SUBJECTS]-&gt;{$label}&#41;{
	return [unpack&#40;&#39;L*&#39;,$self-&gt;[_SUBJECTS]-&gt;{$label}&#41;];
    }
}

sub _getObjectIndicesByLabel
{
    my&#40;$self,$label&#41; = @_;
    if&#40;exists $self-&gt;[_OBJECTS]-&gt;{$label}&#41;{
	return [unpack&#40;&#39;L*&#39;,$self-&gt;[_OBJECTS]-&gt;{$label}&#41;];
    }
}

## FIXME! NEEDS TO BE REMOVED ###
sub _getPredicateIndicesByLabel
{
    my&#40;$self,$label&#41; = @_;
    my @matches;
    my $matched = 0;
    for&#40;my $i=0;$i&lt;=$#{$self-&gt;[_DATA]};$i++&#41;{
	if&#40;defined $self-&gt;[_DATA]-&gt;[$i]&#41;{
	    if&#40;$self-&gt;[_DATA]-&gt;[$i]-&gt;[_PREDICATE]-&gt;getURI&#40;&#41; eq $label&#41;{
		push @matches, $i;
		$matched = 1;
	    }
	}
    }
    if&#40;$matched&#41;{
	return \@matches;
    } else {
	return undef;
    }
}

sub _removeIndexByTypeAndLabel
{
    my &#40;$self,$type,$label,$index&#41; = @_;
    if&#40;exists $self-&gt;[$type]-&gt;{$label}&#41;{
	my $p = pack&#40;&#39;L&#39;,$index&#41;;
	if &#40;$self-&gt;[$type]-&gt;{$label} eq $p&#41;{
	    delete $self-&gt;[$type]-&gt;{$label};
	} else {
	    $self-&gt;[$type]-&gt;{$label} =~ s/^&#40;....&#41;*?$p&#40;....&#41;*?$/$1$2/s;
	}
    }
}

sub _getStmts
{
    my &#40;$self, $subject, $predicate, $object&#41; = @_;

    # this is a grim conditional, but it&#39;s the fastest way - I&#39;m sorry
    if &#40;defined $subject&#41;{
	my $subjects = $self-&gt;_getSubjectIndicesByLabel&#40;$subject-&gt;getURI&#40;&#41;&#41; || return [];
	if &#40;defined $object&#41;{
	    my $objects = $self-&gt;_getObjectIndicesByLabel&#40;$object-&gt;getLabel&#40;&#41;&#41; || return [];
	    my %matches;
	    my $continue = 0;
	    foreach my $index&#40;@{$subjects}&#41;{
		$matches{$index} = 1;
	    }
	    if &#40;defined $predicate&#41;{  # $subject, $object and $predicate defined
		my @matches;
		my $predicateURI = $predicate-&gt;getURI&#40;&#41;;
		foreach my $index&#40;@{$objects}&#41;{
		    if&#40;exists $matches{$index}&#41;{
			if&#40;$self-&gt;[_DATA]-&gt;[$index]-&gt;[_PREDICATE]-&gt;getURI&#40;&#41; eq $predicateURI&#41;{
			    push @matches, $index;
			}
		    }
		}
		return \@matches;
	    } else {                  # $subject and $object defined
		my @matches;
		foreach my $index&#40;@{$objects}&#41;{
		    if&#40;exists $matches{$index}&#41;{
			push @matches, $index;
		    }
		}
		return \@matches;
	    }
	} elsif &#40;defined $predicate&#41;{ # $subject and $predicate defined
	    # TODO: the following line should replicate the predicate search in the block above
	    my $predicates = $self-&gt;_getPredicateIndicesByLabel&#40;$predicate-&gt;getURI&#40;&#41;&#41; || return [];
	    my %matches;
	    my @matches;
	    foreach my $index&#40;@{$subjects}&#41;{
		$matches{$index} = 1;
	    }
	    foreach my $index&#40;@{$predicates}&#41;{
		if&#40;exists $matches{$index}&#41;{
		    push @matches, $index;
		}
	    }
	    return \@matches;
	} else {                      # $subject defined
	    return $subjects;
	}
    } elsif &#40;defined $object&#41;{
	my $objects = $self-&gt;_getObjectIndicesByLabel&#40;$object-&gt;getLabel&#40;&#41;&#41; || return [];
	if &#40;defined $predicate&#41;{      # $object and $predicate defined
	    my $predicates = $self-&gt;_getPredicateIndicesByLabel&#40;$predicate-&gt;getURI&#40;&#41;&#41; || return [];
	    my %matches;
	    my @matches;
	    foreach my $index&#40;@{$objects}&#41;{
		$matches{$index} = 1;
	    }
	    foreach my $index&#40;@{$predicates}&#41;{
		if&#40;exists $matches{$index}&#41;{
		    push @matches, $index;
		}
	    }
	    return \@matches;
	} else {                      # $object defined
	    return $objects;
	}
    } elsif &#40;defined $predicate&#41;{     # $predicate defined
	my $predicates = $self-&gt;_getPredicateIndicesByLabel&#40;$predicate-&gt;getURI&#40;&#41;&#41; || return [];
	return $predicates;
    } else {                          # nothing defined
	my @defined;
	for &#40;my $i=0;$i&lt;=$#{$self-&gt;[_DATA]};$i++&#41;{
	    if &#40;defined $self-&gt;[_DATA]-&gt;[$i]&#41;{
		push @defined, $i;
	    }
	}
	return \@defined;
    }
    carp&#40;&#34;oops - this shouldn&#39;t happen&#34;&#41;;
}

1;
__END__

=head1 NAME

RDF::Core::Storage::Memory - a fast, light storage solution for RDF::Core

=head2 Interface

=over 4

=item * new&#40;&#41;

=item * addStmt&#40;$statement&#41;

=item * removeStmt&#40;$statement&#41;

=item * existsStmt&#40;$subject,$predicate,$object&#41;

=item * countStmts&#40;$subject,$predicate,$object&#41;

=item * getStmts&#40;$subject,$predicate,$object&#41;

=back

=head1 LICENSE

This program is free software; you can redistribute it and/or modify it under the same terms as Perl itself.

=head1 AUTHOR

Copyright &#40;c&#41; 2006, Nigel Wetters Gourlay, based on interface from RDF::Core::Storage.

=head1 SEE ALSO

RDF::Core::Storage

=cut
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;16&nbsp;08:21:35&nbsp;2007</span>
    <span class="description">dan [...] gingerall.cz -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;16&nbsp;08:59:13&nbsp;2007</span>
    <span class="description">dan [...] gingerall.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Jan 07 03:03:21 2007, NWETTERS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; When parsing RDF files larger than a few megabytes, Memory.pm uses too
&gt; much RAM and is too slow to be usable. I wrote a replacement, which is
&gt; attached.
</div>
Hi Nigel, again, thanks for your help. 
Your replacement seems to incorrectly handle literals with datatypes
and/or language tags. I&#39;m enclosing a test file.
&#40;Shame on me these tests aren&#39;t part of distribution yet.&#41;

Regards, Dan
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use lib  qw&#40;../blib/lib ../blib/lib/auto &#41;;
use strict;
use warnings;
use Data::Dumper;

use Test::More qw&#40;no_plan&#41;;
use File::Temp qw&#40;tempfile&#41;;

use RDF::Core::Model;
use RDF::Core::Literal;
use RDF::Core::Storage::Memory;
use RDF::Core::Storage::DB_File;
use RDF::Core::Storage::Postgres;




my @storage = 
  &#40; [&#39;Memory&#39;, sub { return &#40;RDF::Core::Storage::Memory-&gt;new&#40;&#41;, sub{}&#41; }],
    [&#39;DB_File&#39;, sub {
	 my &#40;$fh, $filename&#41; = tempfile&#40;&#41;;
	 return &#40;RDF::Core::Storage::DB_File-&gt;new&#40; Name =&gt; $filename &#41;, sub { unlink $filename }&#41;;
     }],
    [&#39;Postgres&#39;, sub{
	 my $s = new RDF::Core::Storage::Postgres
	   &#40; ConnectStr=&gt;&#39;dbi:Pg:dbname=rdf&#39;, DBUser=&gt;&#39;postgres&#39;, Model=&gt;&#39;rdf-test-01&#39;&#41;;
	 sub cleanup {
	     my $enum = $s-&gt;getStmts&#40;&#41;;
	     my $stmt = $enum-&gt;getNext;
	     while &#40;defined $stmt&#41; {
		 $s-&gt;removeStmt&#40;$stmt&#41;;
		 $stmt = $enum-&gt;getNext;
	     }
	 }
	 cleanup&#40;&#41;;
	 return &#40;$s,sub{},\&#38;cleanup&#41;;
     }],
    &#41;;


my $subj = RDF::Core::Resource-&gt;new&#40; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://kr.newco.com/test.owl#Restaurants_fctsont_restaurantsF&#39;">http://kr.newco.com/test.owl#Restaurants_fctsont_restaurantsF&#39;</a></span> &#41;;
my $pred = RDF::Core::Resource-&gt;new&#40; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/2000/01/rdf-schema#label&#39;">http://www.w3.org/2000/01/rdf-schema#label&#39;</a></span> &#41;;
my @obj = &#40;RDF::Core::Literal-&gt;new&#40;&#34;Restaurant&#34;&#41;,
	   RDF::Core::Literal-&gt;new&#40;&#34;Restaurant&#34;,&#34;en&#34;&#41;,
	   RDF::Core::Literal-&gt;new&#40;&#34;Restaurant&#34;,&#34;fr&#34;&#41;,
	   RDF::Core::Literal-&gt;new&#40;&#34;Restaurant&#34;,undef,&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/2001/XMLSchema#string&#34;&#41;">http://www.w3.org/2001/XMLSchema#string&#34;&#41;</a></span>,
	   RDF::Core::Literal-&gt;new&#40;&#34;Restaurant&#34;,&#34;en&#34;,&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/2001/XMLSchema#string&#34;&#41;">http://www.w3.org/2001/XMLSchema#string&#34;&#41;</a></span>,
	   RDF::Core::Literal-&gt;new&#40;&#34;Restaurant&#34;,&#34;fr&#34;,&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/2001/XMLSchema#string&#34;&#41;">http://www.w3.org/2001/XMLSchema#string&#34;&#41;</a></span>,
	  &#41;; 

foreach my $storage_data &#40;@storage&#41; {
    my &#40;$storage_name, $storage_factory&#41;	= @{ $storage_data };
    warn &#34;# $storage_name\n&#34;;
    
    my &#40;$storage, $storage_cleanup&#41; = &#38;$storage_factory;
    my $model = new RDF::Core::Model &#40;Storage =&gt; $storage&#41;;

    # Empty model initiated ####################################################
    is &#40;$model-&gt;existsStmt, 0, &#34;empty model&#34;&#41;;
    
    my $cnt = 1;
    foreach &#40;@obj&#41; {
	$model-&gt;addStmt&#40;new RDF::Core::Statement&#40;$subj, $pred, $_&#41;&#41;;
	is &#40;$model-&gt;countStmts, $cnt, &#34;countStmts raised to $cnt&#34;&#41;;
	is &#40;get_and_count&#40;$model&#41;, $cnt, &#34;getStmts count raised to $cnt&#34;&#41;;
	$cnt++;
    }

    # statements added #########################################################
    is &#40;$model-&gt;existsStmt, 1, &#34;not empty model &#40;statements added&#41;&#34;&#41;;


    $storage_cleanup-&gt;&#40;&#41;;

}	

# TOOLS ########################################################################
sub get_and_count {
    my &#40;$model, $sub, $pred, $obj&#41; = @_;
    my $enum = $model-&gt;getStmts&#40;$sub, $pred, $obj&#41;;
    my $cnt = 0;
    while &#40;defined $enum-&gt;getNext&#41; {
	    $cnt++;
    }
    $enum-&gt;close;
    return $cnt;
}




</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;16&nbsp;08:59:17&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
