<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #86287 for Data-FormValidator: Empty optional values that would normally be skipped are run through the validation routines if there are multiple values</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #86287 for Data-FormValidator: Empty optional values that would normally be skipped are run through the validation routines if there are multiple values</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Data-FormValidator/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Data-FormValidator/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Data-FormValidator/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Data-FormValidator/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Data-FormValidator">Data-FormValidator CPAN distribution</a>.</p>


<h3>Maintainer&#40;s&#41;&#39; notes</h3>

<p>This is the bug queue for Data::FormValidator. </p>



<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">86287</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Data-FormValidator/Active/">Data-FormValidator</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
wonko [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-9052-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
4.80    </td>
  </tr>
  <tr id="CF-9053-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;20&nbsp;15:35:12&nbsp;2013</span>
    <span class="description">wonko [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Empty optional values that would normally be skipped are run
 through the validation routines if there are multiple values</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It&#39;s not uncommon to have multiple fields with the same name, but not require that they all &#40;or any of them&#41; be filled in. If this is the case D::FV will run the constraints on the missing &#40;undef&#41; values when they would normally be skipped. And since constraint routines can&#39;t return undef+but+true it will fail.

For example, this &#40;an optional field w 2 defined valid values&#41; doesn&#39;t fail:

perl -MData::FormValidator -le &#39;print Data::FormValidator-&gt;check&#40;{foo =&gt; [1,2]}, {optional =&gt; q&#40;foo&#41;, constraint_methods =&gt; { foo =&gt; qr/^\d$/ }}&#41;-&gt;invalid;&#39;

Neither does this &#40;an optional field w 2 undef values&#41;:

perl -MData::FormValidator -le &#39;print Data::FormValidator-&gt;check&#40;{foo =&gt; [undef, undef]}, {optional =&gt; q&#40;foo&#41;, constraint_methods =&gt; { foo =&gt; qr/^\d$/ }}&#41;-&gt;invalid;&#39;

But if you mix them, it fails on the undef &#40;missing&#41; value:

perl -MData::FormValidator -le &#39;print Data::FormValidator-&gt;check&#40;{foo =&gt; [1,undef]}, {optional =&gt; q&#40;foo&#41;, constraint_methods =&gt; { foo =&gt; qr/^\d$/ }}&#41;-&gt;invalid;&#39;

It should treat the 2nd value as just missing and not run it through the validation routine since the field itself is optional.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;20&nbsp;15:45:17&nbsp;2013</span>
    <span class="description">wonko [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This patch fixes this problem and doesn&#39;t cause any failures in the test suite.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt_86287.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- lib/Data/FormValidator/Results.pm	2012-11-01 11:11:19.000000000 -0400
+++ /home/mpeters/development/arcos/lib/Data/FormValidator/Results.pm	2013-06-20 15:40:19.544633425 -0400
@@ -201,12 +201,10 @@
     for my $field &#40;keys %valid&#41; {
         if &#40;ref $valid{$field}&#41; {
             if &#40; ref $valid{$field} eq &#39;ARRAY&#39; &#41; {
-                for &#40;my $i = 0; $i &lt; scalar @{ $valid{$field} }; $i++&#41; {
-                    $valid{$field}-&gt;[$i] = undef unless &#40;defined $valid{$field}-&gt;[$i] and length $valid{$field}-&gt;[$i] and $valid{$field}-&gt;[$i] !~ /^\x00$/&#41;;
-                }
+                # remove any undef/empty values
+                @{$valid{$field}} = grep { defined $_ &#38;&#38; length $_ &#38;&#38; $_ !~ /^\x00$/ } @{$valid{$field}};
                 # If all fields are empty, we delete it.
-                delete $valid{$field} unless grep { defined $_ } @{$valid{$field}};
-
+                delete $valid{$field} unless @{$valid{$field}};
             }
         }
         else {
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;20&nbsp;16:06:45&nbsp;2013</span>
    <span class="description">mark [...] summersault.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #86287] Empty optional values that would normally be skipped are run  through the validation routines if there are multiple values</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 20 Jun 2013 16:06:28 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Data-FormValidator [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Stosberg &lt;mark [...] summersault.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But if you mix them, it fails on the undef &#40;missing&#41; value:
&gt; 
&gt; perl -MData::FormValidator -le &#39;print Data::FormValidator-&gt;check&#40;{foo
&gt; =&gt; [1,undef]}, {optional =&gt; q&#40;foo&#41;, constraint_methods =&gt; { foo =&gt;
&gt; qr/^\d$/ }}&#41;-&gt;invalid;&#39;
&gt; 
&gt; It should treat the 2nd value as just missing and not run it through
&gt; the validation routine since the field itself is optional.
</div>
Michael,

Thanks for the feedback.

I agree that we treat missing optional fields as just missing.

But we also treat fields as atomic: The field itself is missing, invalid
or valid. A field is /not/ treated as a collection of values, of which
each may be missing, invalid, or valid.

So, if a field is a &#34;half valid&#34;, we have to decide:
Is it valid or not.

The safe answer is &#34;not valid&#34;.

You may be agreeing so far, but arguing that in this case a &#34;half
missing&#34; field should be treated as &#34;missing&#34;, instead of running it
through validation and treating the field as &#34;invalid&#34;. Is that right?

I would see either outcome as about equally true-- the field is not
really missing-- it has one value. It&#39;s also not really invalid either--
it has one valid value.

Given the imperfect options, I would just assume leave the current
behavior.

I think what I would recommend is to use your own filter on that field
which throws away undef values in a case like this.

I don&#39;t think we can declare that the behavior is generally desirable,
though. Consider a value like this:

 [1,undef,3]

You can&#39;t throw away the middle value without collapsing the array, and
it might be meaningful that the &#34;3&#34; is the third value, and not the
second.

    Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;20&nbsp;16:06:46&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;20&nbsp;16:16:36&nbsp;2013</span>
    <span class="description">wonko [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jun 20 16:06:45 2013, mark@summersault.com wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You may be agreeing so far, but arguing that in this case a &#34;half
&gt; missing&#34; field should be treated as &#34;missing&#34;, instead of running it
&gt; through validation and treating the field as &#34;invalid&#34;. Is that right?
</div>
Kind of, except that this is an optional field so it&#39;s not missing either. It just doesn&#39;t get validated.
If this was a required field then I agree the whole field should be marked as missing.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I don&#39;t think we can declare that the behavior is generally desirable,
&gt; though. Consider a value like this:
&gt; 
&gt;  [1,undef,3]
&gt; 
&gt; You can&#39;t throw away the middle value without collapsing the array, and
&gt; it might be meaningful that the &#34;3&#34; is the third value, and not the
&gt; second.
</div>
That makes sense. So would you accept a different patch that has the same results &#40;skips validations for optional fields with missing values&#41; that doesn&#39;t also remove those missing values from the data structure?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;20&nbsp;16:53:55&nbsp;2013</span>
    <span class="description">mark [...] summersault.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #86287] Empty optional values that would normally be skipped are run through the validation routines if there are multiple values</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 20 Jun 2013 16:53:38 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Data-FormValidator [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Stosberg &lt;mark [...] summersault.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt;  [1,undef,3]
&gt;&gt;
&gt;&gt; You can&#39;t throw away the middle value without collapsing the array, and
&gt;&gt; it might be meaningful that the &#34;3&#34; is the third value, and not the
&gt;&gt; second.
</div>&gt; 
&gt; That makes sense. So would you accept a different patch that has the
&gt; same results &#40;skips validations for optional fields with missing
&gt; values&#41; that doesn&#39;t also remove those missing values from the data
&gt; structure?
</div>
While I agree the the current situation isn&#39;t perfect, there&#39;s still
some risk with the proposed change. Normally DFV doesn&#39;t return &#34;undef&#34;
as a valid value-- it returns it as &#34;missing&#34;.

With the proposed patch, you could get back a result like this,
expecting that all the values had passed validation:

    [1,undef,3]

You aren&#39;t supposed to need to recheck or re-validate after DFV gets
done, but with the proposed patch you might need to re-check that you
have a real value for each of 3 values returned, because now one value
is undef-but-valid.

I don&#39;t feel like there&#39;s a globally applicable intuitive solution that
can be applied here.

I think good choices include filter&#39;ing out the undefs if that&#39;s
appropriate for your project, or even considering a design where fields
are named differently, and only single values are accepted.

The regex options allow to easily work with similiarly named fields,
marking them all required, optional in one go, or apply constraints.

Something like CGI::Expand names it easy to unpack fields that are named
like  &#34;field.0, &#34;field.1&#34;, etc:

    <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/module/CGI::Expand">https://metacpan.org/module/CGI::Expand</a></span>

For my own work, I plan to use FV_num_values&#40;1&#41; more &#40;from DFV 4.80&#41;,
ideally set it as a default, so I only get one value unless I explicitly
expect more.

    Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;19&nbsp;08:12:12&nbsp;2013</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">No further feedback. Closing. Re-open if there&#39;s more to discuss here. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;19&nbsp;08:12:13&nbsp;2013</span>
    <span class="description">MARKSTOS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
