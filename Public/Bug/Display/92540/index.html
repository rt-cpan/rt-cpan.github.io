<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #92540 for version: odd interactions with version::vxs and Readonly on 5.12</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #92540 for version: odd interactions with version::vxs and Readonly on 5.12</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=version">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=version">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=version">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=version">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/version">version CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">92540</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=version">version</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cja987 [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
BULKDD [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-34940-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-34941-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=92540">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1319094" href="/Public/Bug/Display.html?id=92540#txn-1319094">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;28&nbsp;13:57:19&nbsp;2014</span>
    <span class="description">cja987 [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> odd interactions with version::vxs and Readonly on 5.12</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1319094/699537/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/699537">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 801b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
perl -Mversion -e &#39;Readonly::Scalar our $ver =&gt; 1.01; version-&gt;new&#40;$ver&#41;&#39;
Invalid version format &#40;non-numeric data&#41; at -e 

This is with the latest versions of version, Readonly, and Readonly::XS, but on an older perl &#40;5.12&#41;.  I don&#39;t have this exact setup on later perl versions, so I&#39;m not sure if it&#39;s perl-version-dependent or not.  This also does not occur with version::vpp, nor with a non-readonly version, and if I either stringify &#40;with &#34;$ver&#34;&#41; or numify &#40;with 0+$ver&#41;, the problem disappears, so I suspect it&#39;s something to do with the SV flags that Readonly::XS fiddles with not interacting right with version::vxs.  

I&#39;ve had to compile version with XS disabled to get around it.  A way of disabling version::vxs at import time with an environment variable would be much appreciated.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1319313" href="/Public/Bug/Display.html?id=92540#txn-1319313">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;29&nbsp;05:23:27&nbsp;2014</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1319313/699662/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/699662">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jan 28 13:57:19 2014, sproingie wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; perl -Mversion -e &#39;Readonly::Scalar our $ver =&gt; 1.01; version-
<div class="message-stanza open">&gt; &gt;new&#40;$ver&#41;&#39;
</div>&gt;  Invalid version format &#40;non-numeric data&#41; at -e
&gt; 
&gt; This is with the latest versions of version, Readonly, and
&gt; Readonly::XS, but on an older perl &#40;5.12&#41;.  I don&#39;t have this exact
&gt; setup on later perl versions, so I&#39;m not sure if it&#39;s perl-version-
&gt; dependent or not.  This also does not occur with version::vpp, nor
&gt; with a non-readonly version, and if I either stringify &#40;with &#34;$ver&#34;&#41;
&gt; or numify &#40;with 0+$ver&#41;, the problem disappears, so I suspect it&#39;s
&gt; something to do with the SV flags that Readonly::XS fiddles with not
&gt; interacting right with version::vxs.
&gt; 
&gt; I&#39;ve had to compile version with XS disabled to get around it.  A way
&gt; of disabling version::vxs at import time with an environment variable
&gt; would be much appreciated.
</div>
Your code does not run.
---------------------------------------------------
C:\Documents and Settings\Owner\Desktop\cpan libs\version&gt;perl -Mversion -e &#34;Rea
donly::Scalar our $ver =&gt; 1.01; version-&gt;new&#40;$ver&#41;&#34;
syntax error at -e line 1, near &#34;Readonly::Scalar our &#34;
Execution of -e aborted due to compilation errors.

C:\Documents and Settings\Owner\Desktop\cpan libs\version&gt;perl -v

This is perl 5, version 12, subversion 2 &#40;v5.12.2&#41; built for MSWin32-x86-multi-t
hread
---------------------------------------------------

after fixing it to 
------------------------------------------------------
perl -Mversion -MReadonly -e &#34;Readonly::Scalar our $ver =&gt; 1.01; system&#40;&#39;pause&#39;&#41;; version-&gt;new&#40;$ver&#41;&#34;
------------------------------------------------------

I also noticed there is a SV leak in new_version if there is a croak in upg_version, ill try to make a patch.

The reason it says non-numeric is, the SV* from Readonly::Scalar gives this kind of SV
------------------------------------------------------
SV = PVMG&#40;0x822164&#41; at 0x82b504
  REFCNT = 1
  FLAGS = &#40;pNOK&#41;
  IV = 0
  NV = 1.01
  PV = 0
------------------------------------------------------

None of the flag tests in Perl_upg_version check private flags, only public flags so it falls through to &#34;Invalid version format &#40;non-numeric data&#41;&#34;. Notice the pNOK but not NOK. The rest i need to think more about.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1319314" href="/Public/Bug/Display.html?id=92540#txn-1319314">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;29&nbsp;05:23:27&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1319317" href="/Public/Bug/Display.html?id=92540#txn-1319317">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;29&nbsp;05:26:30&nbsp;2014</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1319317/699665/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/699665">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 480b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Actual RO scalar SV is 
--------------------------------------------
SV = PVMG&#40;0x822144&#41; at 0x82baa4
  REFCNT = 2
  FLAGS = &#40;GMG,SMG,RMG,pNOK&#41;
  IV = 0
  NV = 1.01
  PV = 0
  MAGIC = 0x83e914
    MG_VIRTUAL = &#38;PL_vtbl_packelem
    MG_TYPE = PERL_MAGIC_tiedscalar&#40;q&#41;
    MG_FLAGS = 0x02
      REFCOUNTED
    MG_OBJ = 0x397ca4
        SV = IV&#40;0x397ca0&#41; at 0x397ca4
          REFCNT = 1
          FLAGS = &#40;ROK&#41;
          RV = 0x8b30c4
------------------------------------------------
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1319491" href="/Public/Bug/Display.html?id=92540#txn-1319491">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;29&nbsp;14:27:25&nbsp;2014</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1319491/699769/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/699769">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 721b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 5.19.8
-------------------------------------------------------
C:\Documents and Settings\Owner\Desktop\cpan libs\version&gt;perl -Mversion -MReado
nly -e &#34;Readonly::Scalar our $ver =&gt; 1.01; print version-&gt;new&#40;$ver&#41;;&#34;
1.01
C:\Documents and Settings\Owner\Desktop\cpan libs\version&gt;
--------------------------------------------------------
on 5.12.2
----------------------------------------------------
C:\Documents and Settings\Owner\Desktop\cpan libs\version&gt;perl -Mversion -MReado
nly -e &#34;Readonly::Scalar our $ver =&gt; 1.01; print version-&gt;new&#40;$ver&#41;;&#34;
Invalid version format &#40;non-numeric data&#41; at -e line 1.

C:\Documents and Settings\Owner\Desktop\cpan libs\version&gt;
----------------------------------------------------
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1319506" href="/Public/Bug/Display.html?id=92540#txn-1319506">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;29&nbsp;15:33:10&nbsp;2014</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1319506/699778/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/699778">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 5.16.3
---------------------------------------------------
C:\Documents and Settings\Administrator\Desktop\version-master&gt;perl -Mversion -M
Readonly -e &#34;Readonly::Scalar our $ver =&gt; 1.01; print version-&gt;new&#40;$ver&#41;;&#34;
Invalid version format &#40;non-numeric data&#41; at -e line 1.

C:\Documents and Settings\Administrator\Desktop\version-master&gt;
----------------------------------------------------
on 5.19, notice the mg sv is NOK, it plain pNOK on older perls
----------------------------------------------------
SV = PVMG&#40;0x8f379c&#41; at 0x36801c
  REFCNT = 1
  FLAGS = &#40;GMG,SMG,RMG,NOK,pNOK&#41;
  IV = 0
  NV = 1.01
  PV = 0
  MAGIC = 0x9123cc
    MG_VIRTUAL = &#38;PL_vtbl_packelem
    MG_TYPE = PERL_MAGIC_tiedscalar&#40;q&#41;
    MG_FLAGS = 0x02
      REFCOUNTED
    MG_OBJ = 0x36805c
        SV = IV&#40;0x368058&#41; at 0x36805c
          REFCNT = 1
          FLAGS = &#40;ROK&#41;
          RV = 0x9559f4
SV = PVMG&#40;0x8f381c&#41; at 0x8fcdac
  REFCNT = 1
  FLAGS = &#40;NOK,pNOK&#41;
  IV = 0
  NV = 1.01
  PV = 0
-------------------------------------
on 5.18.1
---------------------------------------
C:\Documents and Settings\Administrator\Desktop\version-master&gt;perl -Mversion -M
Readonly -e &#34;Readonly::Scalar our $ver =&gt; 1.01; print version-&gt;new&#40;$ver&#41;;&#34;
1.01
C:\Documents and Settings\Administrator\Desktop\version-master&gt;
-----------------------

I&#39;m going to make a guess, based on comments from #p5p, that this was fixed in 5.17.2 in <span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/commit/4bac9ae47b5ad7845a24e26b0e95609805de688a">http://perl5.git.perl.org/perl.git/commit/4bac9ae47b5ad7845a24e26b0e95609805de688a</a></span> .
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1319518" href="/Public/Bug/Display.html?id=92540#txn-1319518">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;29&nbsp;17:14:48&nbsp;2014</span>
    <span class="description">BULKDD [...] cpan.org -  Cc BULKDD added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1320748" href="/Public/Bug/Display.html?id=92540#txn-1320748">#</a>      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;01&nbsp;11:47:29&nbsp;2014</span>
    <span class="description">jpeacock [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1320748/700456/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/700456">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 635b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jan 29 15:33:10 2014, BULKDD wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m going to make a guess, based on comments from #p5p, that this was
&gt; fixed in 5.17.2 in
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/commit/4bac9ae47b5ad7845a24e26b0e95609805de688a">http://perl5.git.perl.org/perl.git/commit/4bac9ae47b5ad7845a24e26b0e95609805de688a</a></span>
&gt; .
</div>

I cannot see that error, no matter what Perl version I run:

bash-4.2$ perl -Mversion -MReadonly -e &#34;Readonly::Scalar our $ver =&gt; 1.01; version-&gt;new&#40;$ver&#41;&#34;
Attempt to reassign a readonly scalar at -e line 1

bash-4.2$ perl -v

This is perl 5, version 12, subversion 4 &#40;v5.12.4&#41; built for x86_64-linux

I&#39;m mystified.  In any case, I don&#39;t see that there is anything that the version.pm code could do to help.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1320753" href="/Public/Bug/Display.html?id=92540#txn-1320753">#</a>      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;01&nbsp;11:56:54&nbsp;2014</span>
    <span class="description">cja987 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #92540] odd interactions with version::vxs and Readonly on 5.12</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 1 Feb 2014 08:56:44 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-version [...] rt.cpan.org&#34; &lt;bug-version [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Chuck Adams &lt;cja987 [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1320753/700460/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/700460">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">What could help is if it were possible to disable the XS side with an
environment variable.  As it is now, the only way I&#39;ve found is either
brutally hacking up @LIB before using version &#40;which won&#39;t work if
something already used it&#41; or to rebuild version without XS.

On Saturday, February 1, 2014, John Peacock via RT &lt;bug-version@rt.cpan.org&gt;
wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=92540">https://rt.cpan.org/Ticket/Display.html?id=92540</a></span> &gt;
&gt;
&gt; On Wed Jan 29 15:33:10 2014, BULKDD wrote:
<div class="message-stanza open">&gt; &gt; I&#39;m going to make a guess, based on comments from #p5p, that this was
&gt; &gt; fixed in 5.17.2 in
&gt; &gt;
</div>&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/commit/4bac9ae47b5ad7845a24e26b0e95609805de688a">http://perl5.git.perl.org/perl.git/commit/4bac9ae47b5ad7845a24e26b0e95609805de688a</a></span>
<div class="message-stanza open">&gt; &gt; .
</div>&gt;
&gt;
&gt; I cannot see that error, no matter what Perl version I run:
&gt;
&gt; bash-4.2$ perl -Mversion -MReadonly -e &#34;Readonly::Scalar our $ver =&gt; 1.01;
&gt; version-&gt;new&#40;$ver&#41;&#34;
&gt; Attempt to reassign a readonly scalar at -e line 1
&gt;
&gt; bash-4.2$ perl -v
&gt;
&gt; This is perl 5, version 12, subversion 4 &#40;v5.12.4&#41; built for x86_64-linux
&gt;
&gt; I&#39;m mystified.  In any case, I don&#39;t see that there is anything that the
&gt; version.pm code could do to help.
&gt;
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1320753/700461/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/700461">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1.5k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1320760" href="/Public/Bug/Display.html?id=92540#txn-1320760">#</a>      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;01&nbsp;12:06:23&nbsp;2014</span>
    <span class="description">john.peacock [...] havurah-software.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #92540] odd interactions with version::vxs and Readonly on 5.12</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 01 Feb 2014 12:06:13 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-version [...] rt.cpan.org, undisclosed-recipients:;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Peacock &lt;john.peacock [...] havurah-software.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1320760/700467/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/700467">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 867b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 02/01/2014 11:56 AM, Chuck Adams via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         Queue: version
&gt;   Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=92540">https://rt.cpan.org/Ticket/Display.html?id=92540</a></span> &gt;
&gt;
&gt; What could help is if it were possible to disable the XS side with an
&gt; environment variable.  As it is now, the only way I&#39;ve found is either
&gt; brutally hacking up @LIB before using version &#40;which won&#39;t work if
&gt; something already used it&#41; or to rebuild version without XS.
</div>
I would much rather understand why you are seeing an error that I am not 
seeing.  Adding a hack to disable the XS code won&#39;t solve any problems, 
since the built in version code in the core will not share that new 
behavior.  Unless you could guarantee that you would always be the first 
to &#39;use version&#39; there is no way to make such a hack even work.

Please attach your &#39;perl -V&#39; output to the ticket and I&#39;ll try and 
recreate here.

John
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1320763" href="/Public/Bug/Display.html?id=92540#txn-1320763">#</a>      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;01&nbsp;12:23:13&nbsp;2014</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1320763/700470/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/700470">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Feb 01 12:06:23 2014, john.peacock@havurah-software.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I would much rather understand why you are seeing an error that I am not 
&gt; seeing.  Adding a hack to disable the XS code won&#39;t solve any problems, 
&gt; since the built in version code in the core will not share that new 
&gt; behavior.  Unless you could guarantee that you would always be the first 
&gt; to &#39;use version&#39; there is no way to make such a hack even work.
&gt; 
&gt; Please attach your &#39;perl -V&#39; output to the ticket and I&#39;ll try and 
&gt; recreate here.
&gt; 
&gt; John
</div>
I can reproduce it, and I know why he gets non-numeric. The reason is in Perl_upg_version only public flags are checked. Tieds/magic NEVER get public OK flags set on older perls apparently. so on &lt; 5.17.2 Perl_upg_version needs to check SvNOKp and SvPOKp and etc.  There is also a leak in Perl_new_version since if UPG_VERSION croaks, SV &#34;rv&#34; is leaked. Either a early sv_2mortal and at the very end, after UPG_VERSION &#40;and it is guarenteed we can&#39;t croak&#41;, a SvREFCNT_inc_optimized is required. Or replace the sv_2mortal with SAVEFREESV. I will try to get a fix in someone this week. My idea is to add more else if blocks to upg_version towards the end of the branch tree, with gotos to their public flag counterparts. the private flag blocks are #if&#39;ed out on &gt;= 5.17.2.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1320766" href="/Public/Bug/Display.html?id=92540#txn-1320766">#</a>      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;01&nbsp;12:38:00&nbsp;2014</span>
    <span class="description">john.peacock [...] havurah-software.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #92540] odd interactions with version::vxs and Readonly on 5.12</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 01 Feb 2014 12:37:50 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-version [...] rt.cpan.org, undisclosed-recipients:;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Peacock &lt;john.peacock [...] havurah-software.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1320766/700473/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/700473">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 02/01/2014 12:23 PM, Daniel Dragan via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; I can reproduce it, and I know why he gets non-numeric. The reason is
&gt; in Perl_upg_version only public flags are checked. Tieds/magic NEVER
&gt; get public OK flags set on older perls apparently. so on &lt; 5.17.2
&gt; Perl_upg_version needs to check SvNOKp and SvPOKp and etc.  There is
&gt; also a leak in Perl_new_version since if UPG_VERSION croaks, SV &#34;rv&#34;
&gt; is leaked. Either a early sv_2mortal and at the very end, after
&gt; UPG_VERSION &#40;and it is guarenteed we can&#39;t croak&#41;, a
&gt; SvREFCNT_inc_optimized is required. Or replace the sv_2mortal with
&gt; SAVEFREESV. I will try to get a fix in someone this week. My idea is
&gt; to add more else if blocks to upg_version towards the end of the
&gt; branch tree, with gotos to their public flag counterparts. the
&gt; private flag blocks are #if&#39;ed out on &gt;= 5.17.2.
&gt;
</div>
No, I understand why it goes down that code path; I would be much 
happier being able to recreate the error locally.  I agree with your 
plan to fix the tied/magic bits and I&#39;ll take a crack at it.  With Perl 
5.20.0 nearing the station, I&#39;d like to get this all wrapped up and 
blead synced to a good CPAN release before the 20th, so I&#39;ll take a 
crack at your scheme today if possible.

John
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1320769" href="/Public/Bug/Display.html?id=92540#txn-1320769">#</a>      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;01&nbsp;12:40:55&nbsp;2014</span>
    <span class="description">john.peacock [...] havurah-software.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #92540] odd interactions with version::vxs and Readonly on 5.12</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 01 Feb 2014 12:40:42 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-version [...] rt.cpan.org, undisclosed-recipients:;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Peacock &lt;john.peacock [...] havurah-software.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1320769/700476/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/700476">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 497b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 02/01/2014 12:38 PM, John Peacock via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; No, I understand why it goes down that code path; I would be much
&gt; happier being able to recreate the error locally.
</div>
Never mind, I&#39;ve got it sussed out.  You must both be running on 
Windows, where double quotes are default.  I&#39;m running Linux, of course, 
so using double-quotes cause the $ver inside to get interpreted by the 
shell to nothingness, hence the error I was getting.  Once I switch to 
single quotes, the error pops out.

John
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1320773" href="/Public/Bug/Display.html?id=92540#txn-1320773">#</a>      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;01&nbsp;12:47:06&nbsp;2014</span>
    <span class="description">cja987 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #92540] odd interactions with version::vxs and Readonly on 5.12</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 1 Feb 2014 09:46:56 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-version [...] rt.cpan.org&#34; &lt;bug-version [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Chuck Adams &lt;cja987 [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1320773/700479/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/700479">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 812b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m running on Linux &#40;EL5&#41;, but I typed the original error report from
memory, and I guessed I messed it up. :-/  So nothing windows-specific
there.




On Sat, Feb 1, 2014 at 9:40 AM, John Peacock via RT
&lt;bug-version@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=92540">https://rt.cpan.org/Ticket/Display.html?id=92540</a></span> &gt;
&gt;
&gt; On 02/01/2014 12:38 PM, John Peacock via RT wrote:
<div class="message-stanza open">&gt;&gt; No, I understand why it goes down that code path; I would be much
&gt;&gt; happier being able to recreate the error locally.
</div>&gt;
&gt; Never mind, I&#39;ve got it sussed out.  You must both be running on
&gt; Windows, where double quotes are default.  I&#39;m running Linux, of course,
&gt; so using double-quotes cause the $ver inside to get interpreted by the
&gt; shell to nothingness, hence the error I was getting.  Once I switch to
&gt; single quotes, the error pops out.
&gt;
&gt; John
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1320795" href="/Public/Bug/Display.html?id=92540#txn-1320795">#</a>      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;01&nbsp;13:22:48&nbsp;2014</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1320795/700499/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/700499">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 655b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Feb 01 12:38:00 2014, john.peacock@havurah-software.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; No, I understand why it goes down that code path; I would be much 
&gt; happier being able to recreate the error locally.  I agree with your 
&gt; plan to fix the tied/magic bits and I&#39;ll take a crack at it.  With Perl 
&gt; 5.20.0 nearing the station, I&#39;d like to get this all wrapped up and 
&gt; blead synced to a good CPAN release before the 20th, so I&#39;ll take a 
&gt; crack at your scheme today if possible.
&gt; 
&gt; John
</div>
Remember to check private flags after all attemtps at checking public flags failed since private flags also supposedly &#40;from what I read&#41; represent lossy type conversions.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1320798" href="/Public/Bug/Display.html?id=92540#txn-1320798">#</a>      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;01&nbsp;13:25:20&nbsp;2014</span>
    <span class="description">john.peacock [...] havurah-software.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #92540] odd interactions with version::vxs and Readonly on 5.12</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 01 Feb 2014 13:25:09 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-version [...] rt.cpan.org, undisclosed-recipients:;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Peacock &lt;john.peacock [...] havurah-software.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1320798/700502/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/700502">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 929b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 02/01/2014 12:40 PM, John Peacock via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         Queue: version
&gt;   Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=92540">https://rt.cpan.org/Ticket/Display.html?id=92540</a></span> &gt;
&gt;
&gt; On 02/01/2014 12:38 PM, John Peacock via RT wrote:
<div class="message-stanza open">&gt;&gt; No, I understand why it goes down that code path; I would be much
&gt;&gt; happier being able to recreate the error locally.
</div></div>
Trivially speaking, this works:

diff -r 5e76102adf1a vutil/vutil.c
--- a/vutil/vutil.c     Sat Feb 01 08:55:41 2014 -0500
+++ b/vutil/vutil.c     Sat Feb 01 13:22:11 2014 -0500
@@ -558,7 +558,11 @@
  #endif
      PERL_ARGS_ASSERT_UPG_VERSION;

-    if &#40; SvNOK&#40;ver&#41; &#38;&#38; !&#40; SvPOK&#40;ver&#41; &#38;&#38; SvCUR&#40;ver&#41; == 3 &#41; &#41;
+    if &#40;SvNOK&#40;ver&#41;
+#if PERL_VERSION_LT&#40;5,17,2&#41;
+       || &#40;SvTYPE&#40;ver&#41; == SVt_PVMG &#38;&#38; SvNOKp&#40;ver&#41;&#41;
+#endif
+       &#38;&#38; !&#40; SvPOK&#40;ver&#41; &#38;&#38; SvCUR&#40;ver&#41; == 3 &#41; &#41;
      {
         STRLEN len;

but I wonder if there are other sorts of magical things that could look 
like that &#40;not just tied scalars&#41;.

John
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1320801" href="/Public/Bug/Display.html?id=92540#txn-1320801">#</a>      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;01&nbsp;13:39:09&nbsp;2014</span>
    <span class="description">john.peacock [...] havurah-software.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #92540] odd interactions with version::vxs and Readonly on 5.12</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 01 Feb 2014 13:38:57 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-version [...] rt.cpan.org, undisclosed-recipients:;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Peacock &lt;john.peacock [...] havurah-software.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1320801/700505/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/700505">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 440b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 02/01/2014 01:22 PM, Daniel Dragan via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; Remember to check private flags after all attemtps at checking public flags failed since private flags also supposedly &#40;from what I read&#41; represent lossy type conversions.
&gt;
</div>
I think what I just pushed is sufficiently paranoid.  Notionally:

Take SvNOK or if magical and not SvPOK, accept SvNOKp
else take SvPOK or if magical, accept SvPOKp

Does that seem to cover everything?

John
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1320804" href="/Public/Bug/Display.html?id=92540#txn-1320804">#</a>      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;01&nbsp;13:50:08&nbsp;2014</span>
    <span class="description">john.peacock [...] havurah-software.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #92540] odd interactions with version::vxs and Readonly on 5.12</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 01 Feb 2014 13:49:54 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-version [...] rt.cpan.org, undisclosed-recipients:;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Peacock &lt;john.peacock [...] havurah-software.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1320804/700508/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/700508">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 311b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 02/01/2014 01:39 PM, John Peacock via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think what I just pushed is sufficiently paranoid.  Notionally:
</div>
One more branch:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Take SvNOK or if magical and not SvPOK, accept SvNOKp
</div>
else take SvIOK or if magical and not SvPOK, accept SvIOKp

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; else take SvPOK or if magical, accept SvPOKp
&gt;
</div>
John
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1320817" href="/Public/Bug/Display.html?id=92540#txn-1320817">#</a>      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;01&nbsp;14:17:42&nbsp;2014</span>
    <span class="description">john.peacock [...] havurah-software.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #92540] odd interactions with version::vxs and Readonly on 5.12</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 01 Feb 2014 14:17:32 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-version [...] rt.cpan.org, undisclosed-recipients:;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Peacock &lt;john.peacock [...] havurah-software.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1320817/700516/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/700516">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 428b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 02/01/2014 12:23 PM, Daniel Dragan via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There is
&gt; also a leak in Perl_new_version since if UPG_VERSION croaks, SV &#34;rv&#34;
&gt; is leaked. Either a early sv_2mortal and at the very end, after
&gt; UPG_VERSION &#40;and it is guarenteed we can&#39;t croak&#41;, a
&gt; SvREFCNT_inc_optimized is required. Or replace the sv_2mortal with
&gt; SAVEFREESV.
</div>
New ticket for the leak only:

   <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=92642">https://rt.cpan.org/Ticket/Display.html?id=92642</a></span>

John
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1320848" href="/Public/Bug/Display.html?id=92540#txn-1320848">#</a>      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;01&nbsp;15:56:06&nbsp;2014</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1320848/700539/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/700539">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Feb 01 13:25:20 2014, john.peacock@havurah-software.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 02/01/2014 12:40 PM, John Peacock via RT wrote:
<div class="message-stanza open">&gt; &gt;         Queue: version
&gt; &gt;   Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=92540">https://rt.cpan.org/Ticket/Display.html?id=92540</a></span> &gt;
&gt; &gt;
&gt; &gt; On 02/01/2014 12:38 PM, John Peacock via RT wrote:
<div class="message-stanza open">&gt; &gt;&gt; No, I understand why it goes down that code path; I would be much
&gt; &gt;&gt; happier being able to recreate the error locally.
</div></div>&gt; 
&gt; Trivially speaking, this works:
&gt; 
&gt; diff -r 5e76102adf1a vutil/vutil.c
&gt; --- a/vutil/vutil.c     Sat Feb 01 08:55:41 2014 -0500
&gt; +++ b/vutil/vutil.c     Sat Feb 01 13:22:11 2014 -0500
&gt; @@ -558,7 +558,11 @@
&gt;   #endif
&gt;       PERL_ARGS_ASSERT_UPG_VERSION;
&gt; 
&gt; -    if &#40; SvNOK&#40;ver&#41; &#38;&#38; !&#40; SvPOK&#40;ver&#41; &#38;&#38; SvCUR&#40;ver&#41; == 3 &#41; &#41;
&gt; +    if &#40;SvNOK&#40;ver&#41;
&gt; +#if PERL_VERSION_LT&#40;5,17,2&#41;
&gt; +       || &#40;SvTYPE&#40;ver&#41; == SVt_PVMG &#38;&#38; SvNOKp&#40;ver&#41;&#41;
</div>
SVt_PVMG does not determine if a SV is magical or not. A magical can also be SVt_PVLV. Checking the type only matters if you want to make something magical that wasn&#39;t magical before or you are setting new flags that were previously off. A SvUPGRADE will be hanging near by too. That check is wrong. Just check flags alone. I suggest checking the private flags after all public flags are checked, otherwise there will be more complaints over &#40;some details ahead may be wrong&#41;, a version number that is IV 2^54 on a 64 bit IV machine, that had something like
----------------------------------------
$v =  2**54;
say $v+0.5;
version-&gt;new&#40;$v&#41;
----------------------------------------

I tried to simulate that ona  64 bit perl but its not working and #p5p hasn&#39;t given me an answer.
----------------------------------------
C:\Documents and Settings\Administrator&gt;perl -MDevel::Peek -E &#34;{use integer; $v=
 &#40;2**55&#41;+0;} {no integer; say $v*1.3; Dump&#40;$v&#41;;}&#34;
4.68374361246532e+016
SV = PVNV&#40;0x4e1ab8&#41; at 0x1d47c48
  REFCNT = 1
  FLAGS = &#40;IOK,NOK,pIOK,pNOK&#41;
  IV = 36028797018963968
  NV = 3.6028797018964e+016
  PV = 0

----------------------------------------
NOK should be off on that according to perlguts.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1320891" href="/Public/Bug/Display.html?id=92540#txn-1320891">#</a>      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;01&nbsp;17:52:13&nbsp;2014</span>
    <span class="description">john.peacock [...] havurah-software.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #92540] odd interactions with version::vxs and Readonly on 5.12</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 01 Feb 2014 17:52:00 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-version [...] rt.cpan.org, undisclosed-recipients:;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Peacock &lt;john.peacock [...] havurah-software.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1320891/700564/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/700564">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 02/01/2014 03:56 PM, Daniel Dragan via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; SVt_PVMG does not determine if a SV is magical or not. A magical can also be SVt_PVLV.
</div>
As you can probably imagine, I was trying to determine if I was dealing 
with a tied hash &#40;as produced by Readonly&#41;, but I was unable to come up 
with a test that would work.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Just check flags alone. I suggest checking the private
&gt; flags after all public flags are checked, otherwise there will be
&gt; more complaints over &#40;some details ahead may be wrong&#41;, a version
&gt; number that is IV 2^54 on a 64 bit IV machine, that had something
&gt; like
</div>
That isn&#39;t a case we need to directly handle, since it will trigger the 
VERSION_MAX code.  I reordered to the tests to check IV, NV, then PV, 
which I think will always DTRT &#40;SvIOK will still be set for those overly 
large numbers where the NV might no longer be accurate&#41;.

I moved all of the private flags to the end as you suggested.  I was 
resistant to the goto methodology, but it does make the extra code 
slightly tidier.  I&#39;ve pushed my changes to both repos.

John
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1320912" href="/Public/Bug/Display.html?id=92540#txn-1320912">#</a>      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;01&nbsp;19:19:29&nbsp;2014</span>
    <span class="description">jpeacock [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1320912/700574/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/700574">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 15b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in 0.9908
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1320914" href="/Public/Bug/Display.html?id=92540#txn-1320914">#</a>      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;01&nbsp;19:19:31&nbsp;2014</span>
    <span class="description">jpeacock [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.795204</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
