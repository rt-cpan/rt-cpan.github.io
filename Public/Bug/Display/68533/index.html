<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #68533 for Schedule-Cron: Thou shalt not REAP what thou has not forked...</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #68533 for Schedule-Cron: Thou shalt not REAP what thou has not forked...</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Schedule-Cron/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Schedule-Cron/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Schedule-Cron/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Schedule-Cron/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Schedule-Cron">Schedule-Cron CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">68533</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Schedule-Cron/Active/">Schedule-Cron</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
tlhackque [...] yahoo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-28310-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-28311-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;29&nbsp;12:00:00&nbsp;2011</span>
    <span class="description">tlhackque [...] yahoo.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Thou shalt not REAP what thou has not forked...</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I do not specify the detach option &#38; so run tasks sequentially.

However, some of these tasks do wish to fork.

It turns out that Schedule::Cron installs it&#39;s SIG{CLD} handler and 
runs its REAPER unconditionally in its main loop 
&#40;_cleanup_process_list&#41;.  Of course, it&#39;s reaping forks that it did not 
create.  This makes forking by the scheduled tasks unreliable.

Although callers can overwrite the SIG{CLD} handler, we can&#39;t stop the 
loop level call to REAPER.

Schedule::Cron should not install a CLD handler or call REAPER in 
_cleanup_process_list unless the &#39;detach&#39; option is specified.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;29&nbsp;12:07:42&nbsp;2011</span>
    <span class="description">tlhackque [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> tlhackque [...] yahoo.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry, I didn&#39;t mean detach, I meant nofork.

Handler and polling need to be suppressed with nofork set to 1; this 
has nothing to do with detach.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;29&nbsp;15:20:17&nbsp;2011</span>
    <span class="description">tlhackque [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Patch for several RTs, including this</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> tlhackque [...] yahoo.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I was able to create a patch to fix most of the outstanding bugs.

It&#39;s received limited testing so far, but seems worth distributing.

RT#58841 - typo in log message
           Agree &#40;actually, noticed while doing other work&#41;, fixed
T#68450 - scheduler crash when a job calls clean_timetable and does not
           add another job.  run&#40;&#41; will die in this case - caller can
           put an eval in place if it knows how to handle this.

RT#68530 - Exposes too much information, performance issues.
           Fixed.  Added nostatus item to prevent updating $0, 
           loglevel to control logging callbacks &#38; control whether
           $0 updates include arglists.  

RT#68533 - &#40;this&#41; Do not reap unless forking.
           Fixed.

POD is updated for all changes, and all the defaults keep the current 
behaviors, even those that I would do differently.  It should be 
compatible with any current application.

I also conditioned some of the more expensive dbg calls on $DEBUG to 
save the computes used to generate argument lists to dbg.

I looked at #62846, but don&#39;t see how an add can happen during a sleep.
If we&#39;re not forking, it&#39;s &#40;almost&#41; self-evident.  If we are forking, 
the fork can&#39;t update the parent queues.  And if one tries to do an add 
in signal handler - well, there are other reentracy problems.  If 
that&#39;s what was attempted, my solution is to have a job that looks for 
a config file change at some frequency - then updates are done at job 
level and should work. 

Not being the maintainer/owner and not having a windows environment, I 
didn&#39;t feel that I could include the 56926 patch.  It looks reasonable, 
but as I don&#39;t have the problem and am unable to test, I&#39;m not the one 
to handle the issue.

It would be really great if you could take this patch and relase a new 
kit.

&#40;If I find any more issues, including with this patch, I&#39;ll add another 
RT.&#41;

Thanks in advance.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Schedule-Cron.patch.1</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;29&nbsp;16:29:01&nbsp;2011</span>
    <span class="description">roland [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza">Thanks a lot for your investigations. As you might have noticed, the efforts on&nbsp;<br>

Schedule::Cron has been throttled for some time. However, I will look at your patch<br>

this week (we have a public holiday on thursday, so there should be some spare<br>

time ;-) and if it looks of for me release a new version at the end of this week (with the<br>

patch applied).<br>

<br>

Thanks again ....<br>

...roland<br>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;29&nbsp;16:29:02&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;31&nbsp;22:57:48&nbsp;2011</span>
    <span class="description">tlhackque [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> tlhackque [...] yahoo.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">That would be great.

I have another request - arguably it&#39;s a fix for RT#62846 that I didn&#39;t 
understand.

In any case, I want to be able to use select where $mainloop goes to 
sleep.  This allows me to service network IO - among other things.  
Thus, queue listings can be extracted and entries to the queue.  &#40;Which 
is what the reporter of #62846 was probably trying to do.&#41;

I updated my patch to allow this, by allowing specification of a sleep 
hook.  Basically, the hook is responsible for sleeping for a while and 
returning.  It&#39;s allowed to add and delete entries, which is why on 
return we check for entries_changed &#38; rescan the queue.  Of course it 
can list the queue too.  

I included a sample sleep routine in the pod that just wakes if you hit 
&lt;CR&gt; on STDIN.  But there&#39;s a lot more one can do with this.  I think 
it&#39;s a powerful addition.

Attached is Schedule-Cron.patch.2.  It combines all my patches, and is 
only a few more lines than the original.

Many thanks.  And enjoy your holiday!
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Schedule-Cron.patch.2</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;02&nbsp;09:50:41&nbsp;2011</span>
    <span class="description">roland [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;02&nbsp;09:58:45&nbsp;2011</span>
    <span class="description">roland [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza">Hi,&nbsp;<br>

<br>

I just uploaded 1.02 with your patch applied. Thanks again ;-)<br>

<br>

I did the following slight modifications:<br>

<br>

* I set the default loglevel to 0, since has you stated correctly,&nbsp;<br>

&nbsp; -1 can pose a security issue (args list in 'ps'), so we should provide<br>

&nbsp; a save default.<br>

<br>

* For the 'sleep' option, I changed the signature so that the first&nbsp;<br>

&nbsp; argument will be the time in seconds to sleep (as before) and an&nbsp;<br>

&nbsp; additional second argument contains the Cron::Schedule object<br>

&nbsp; itself (which then can be used to add extra entries). This also&nbsp;<br>

&nbsp; slims down the example that you provided and makes sense IMO<br>

<br>

I don't know, whether you want do this, but it would be super cool if&nbsp;<br>

you could provide a full example with the 'sleep' options showing&nbsp;<br>

how to do the dynamic reload and maybe even add a unit test.<br>

But if not, no problem, I really appreciate the patch you delivered.<br>

<br>

1.01 will be no release rather soon, I need still to wait on feedback of<br>

the other two open bugs (
<a href="https://rt.cpan.org/Ticket/Display.html?id=56926">56926</a>&nbsp;and&nbsp;
<a href="https://rt.cpan.org/Ticket/Display.html?id=55741">55741</a>), which should be&nbsp;<br>

fixed as well. (Even this very bug should now work without the exrta<br>

check on $config{nofork}, since the reaper now only waits on the PID<br>

it has started on its own (as it was in 1.00 but was changed for&nbsp;
<a href="https://rt.cpan.org/Ticket/Display.html?id=56926">56926</a>&nbsp;and<br>

now reverted back. But I still leave the patch here, it doesnt harm and provides<br>

and extra check level)<br>

<br>

bye, nice weekend ...<br>

... roland<br>

<br>

On Tue May 31 22:57:48 2011, tlhackque wrote: <br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That would be great. <br>

&gt;  <br>

&gt; I have another request - arguably it's a fix for RT#62846 that I didn't  <br>

&gt; understand. <br>

&gt;  <br>

&gt; In any case, I want to be able to use select where $mainloop goes to  <br>

&gt; sleep.  This allows me to service network IO - among other things.   <br>

&gt; Thus, queue listings can be extracted and entries to the queue.  (Which  <br>

&gt; is what the reporter of #62846 was probably trying to do.) <br>

&gt;  <br>

&gt; I updated my patch to allow this, by allowing specification of a sleep  <br>

&gt; hook.  Basically, the hook is responsible for sleeping for a while and  <br>

&gt; returning.  It's allowed to add and delete entries, which is why on  <br>

&gt; return we check for entries_changed &amp; rescan the queue.  Of course it  <br>

&gt; can list the queue too.   <br>

&gt;  <br>

&gt; I included a sample sleep routine in the pod that just wakes if you hit  <br>

&gt; &lt;CR&gt; on STDIN.  But there's a lot more one can do with this.  I think  <br>

&gt; it's a powerful addition. <br>

&gt;  <br>

&gt; Attached is Schedule-Cron.patch.2.  It combines all my patches, and is  <br>

&gt; only a few more lines than the original. <br>

&gt;  <br>

&gt; Many thanks.  And enjoy your holiday! <br>
</div><br>

<br>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;02&nbsp;09:58:46&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;02&nbsp;09:59:04&nbsp;2011</span>
    <span class="description">roland [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;02&nbsp;14:15:52&nbsp;2011</span>
    <span class="description">tlhackque [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> tlhackque [...] yahoo.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Roland,

Thanks for accepting the changes.  That&#39;s a big help.

I agree that 0 is the correct default for loglevel - I was just being 
super cautious about changing behaviour for existing users.

The reason I didn&#39;t provide the $cron in the sleep call-out was that 
it&#39;s easy to do that in a closure - which can also provide other 
application-specific arguments.

But what you describe should be OK.  &#40;Your upload hasn&#39;t made it to 
CPAN yet.&#41;

On the sleep hook - I&#39;m not quite sure what you&#39;re looking for.  My 
real code is rather involved &#38; not suitable for an example.  What I put 
in the POD works, as can be seen by putting some logging at the 
beginning and end.  It&#39;s an advanced user option - mostly if you know 
how to use it, you&#39;ll recognize it instantly.  If not, it takes a LOT 
of explaining.

The simplest example I can think of is: where I put the &#34;handle_io&#34; 
stub, just call $cron-&gt;add_entry&#40; &#34;1/5 * * * * 30&#34;, sub { print &#34;New 
entry\n&#34;; } &#41;;  It&#39;s not useful &#40;except for debugging&#41;, but it is an 
example.

Now startup as usual - you do need some other entry in the queue.  
Nothing will happen until you type a line on STDIN.  Then on the next 
05:30 tick, the &#34;New entry&#34; message will appear.  

But, since you were kind enough to take my patches, I wrote the 
simplest useful tool for demonstrating the utility of sleep-callouts 
that I could think of.  I think it&#39;s too much for an example &#40;about 250 
lines of perl&#41;.  But you may find it useful for debugging.  I&#39;m not 
an &#34;expect&#34; guy, but you should also be able to use it for a unit test 
if you are.

It shows how one can have a network server that runs with 
Schedule::Cron and provides rudimentary control.  NOT production.  But 
it shows how you can &#40;must&#41; thread non-blocking I/O to keep 
Schedule::Cron on-time, yet be responsive to requests.

You&#39;ll notice that the sleep routine doesn&#39;t need $cron because all the 
callbacks that it generates need closures...

I&#39;ve attached it to this note.  Here&#39;s a little user documentation:

Run CronSleepExample &#40;from an unpriv&#39;d account, please!&#41;.

Wait untl it says &#34;my port is localhost:65331&#34;.

From another window, telnet to localhost:65331.

Enter the Password &#40;&#39;Purfect&#39;&#41;.
You have the following commands:

status
   Shows queue
add name &#34;schedule&#34; A string to be printed when executed
  Adds a new task
delete name
  Deletes a task &#40;by name&#41;
load file
  Loads a crontab file - Caution, this is with server permissions.  If 
the server can read /etc/passwd &#40;or anything else&#41;, it will display it 
in the error messages.  As I said, NOT production...
quit
  Exits.

Note that all this seems to happen while your code is scheduling and 
executing tasks.  But it&#39;s at a safe point with regard to your data 
structures.

If your feel adventurous, open another telnet session and see that each 
runs independently.

Here&#39;s a sample session.

Uses a small crontab file &#40;also attached&#41;.

Server first:
./CronSleepExample
Please wait while initialization is scheduled
Schedule::Cron - Starting job 0
Ready, my port is localhost::65331
Schedule::Cron - Finished job 0
Schedule::Cron - Starting job 5
Now: Periodic
Schedule::Cron - Finished job 5

And a client:

# telnet localhost 65331
Trying 127.0.0.1...
Connected to localhost.localdomain &#40;127.0.0.1&#41;.
Escape character is &#39;^]&#39;.
Password: Purfect
Password accepted
status
Job 0    0 0 1 1 * Next: Sun Jan  1 00:00:00 2012 - NewYear&#40;  &#41;
End of job queue
load cron.tab
Loaded cron.tab
status
Job 1    34 2 * * Mon Next: Mon Jun  6 02:34:00 2011 - &#34;make_stats&#34;&#40;  &#41;
Job 2    43 8 * * Wed Next: Wed Jun  8 08:43:00 2011 - &#34;Make Peace&#34;&#40;  &#41;
Job 0    0 0 1 1 *    Next: Sun Jan  1 00:00:00 2012 - NewYear&#40;  &#41;
End of job queue
add Halloween &#34;30 18 31 10 *&#34; Pumpkin time
Added 30 18 31 10 *
Add Today &#34;11 15 * * *&#34; Something to do
Added 11 15 * * *
add Now &#34;*/2 * * * * 30&#34; Periodic
Added */2 * * * * 30
status
Job 5    */2 * * * * 30 Next: Thu Jun  2 13:40:30 2011 - Now&#40; Periodic &#41;
Job 4    11 15 * * *    Next: Thu Jun  2 15:11:00 2011 - Today&#40; 
Something to do &#41;
Job 1    34 2 * * Mon   Next: Mon Jun  6 02:34:00 2011 -
 &#34;make_stats&#34;&#40;  &#41;
Job 2    43 8 * * Wed   Next: Wed Jun  8 08:43:00 2011 - &#34;Make 
Peace&#34;&#40;  &#41;
Job 3    30 18 31 10 *  Next: Mon Oct 31 18:30:00 2011 - Halloween&#40; 
Pumpkin time &#41;
Job 0    0 0 1 1 *      Next: Sun Jan  1 00:00:00 2012 - NewYear&#40;  &#41;
End of job queue
delete Today
Deleted Today
status
Job 4    */2 * * * * 30 Next: Thu Jun  2 13:42:30 2011 - Now&#40; Periodic &#41;
Job 1    34 2 * * Mon   Next: Mon Jun  6 02:34:00 2011 -
 &#34;make_stats&#34;&#40;  &#41;
Job 2    43 8 * * Wed   Next: Wed Jun  8 08:43:00 2011 - &#34;Make 
Peace&#34;&#40;  &#41;
Job 3    30 18 31 10 *  Next: Mon Oct 31 18:30:00 2011 - Halloween&#40; 
Pumpkin time &#41;
Job 0    0 0 1 1 *      Next: Sun Jan  1 00:00:00 2012 - NewYear&#40;  &#41;
End of job queue
q
Connection closed by foreign host.
#

I have more complex uses, but this should demonstrate the utility.

Thanks again for so promptly taking the patches.

Hope this helps.

On Thu Jun 02 09:58:45 2011, ROLAND wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; I just uploaded 1.02 with your patch applied. Thanks again ;-&#41;
&gt; 
&gt; I did the following slight modifications:
&gt; 
&gt; * I set the default loglevel to 0, since has you stated correctly,
&gt; -1 can pose a security issue &#40;args list in &#39;ps&#39;&#41;, so we should provide
&gt; a save default.
&gt; 
&gt; * For the &#39;sleep&#39; option, I changed the signature so that the first
&gt; argument will be the time in seconds to sleep &#40;as before&#41; and an
&gt; additional second argument contains the Cron::Schedule object
&gt; itself &#40;which then can be used to add extra entries&#41;. This also
&gt; slims down the example that you provided and makes sense IMO
&gt; 
&gt; I don&#39;t know, whether you want do this, but it would be super cool if
&gt; you could provide a full example with the &#39;sleep&#39; options showing
&gt; how to do the dynamic reload and maybe even add a unit test.
&gt; But if not, no problem, I really appreciate the patch you delivered.
&gt; 
&gt; 1.01 will be no release rather soon, I need still to wait on feedback 
</div>of
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; the other two open bugs &#40; 56926 and 55741&#41;, which should be
&gt; fixed as well. &#40;Even this very bug should now work without the exrta
&gt; check on $config{nofork}, since the reaper now only waits on the PID
&gt; it has started on its own &#40;as it was in 1.00 but was changed for 
</div>56926 and
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; now reverted back. But I still leave the patch here, it doesnt harm 
</div>and
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; provides
&gt; and extra check level&#41;
&gt; 
&gt; bye, nice weekend ...
&gt; ... roland
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> cron.tab</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">34 2 * * Mon  &#34;make_stats&#34;
43 8 * * Wed &#34;Make Peace&#34;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CronSleepExample</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

# Copyright &#40;c&#41; 2011 Timothe Litt &lt;litt at acm dot org&gt;
#
# May be used on the same terms as Perl.

# Sleep hook demo, showing how it enables a background thread
# to provide a simple command interface to a daemon.

use strict;
use warnings;

use Schedule::Cron;
use Socket &#39;:crlf&#39;;
use IO::Socket::INET;

my $port = 65331;
our $password = &#39;Purfect&#39;;

our&#40; $lsock, $rin, $win, $maxfd, %servers &#41;;

my $cron = new Schedule::Cron&#40; sub { print &#39;Loaded entry: &#39;, join&#40;&#39;&#39;, @_ &#41;, &#34;\n&#34;; }, {
					nofork =&gt; 1,
					loglevel =&gt; 0,
					log =&gt; sub { print $_[1], &#34;\n&#34;; },
					sleep =&gt; \&#38;idler
				       } &#41;;

$cron-&gt;add_entry&#40; &#34;* * * * *&#34;, \&#38;init, &#39;Init&#39;, $cron &#41;;
$cron-&gt;add_entry&#40; &#34;0 0 1 1 *&#34;, sub { print &#34;Happy New Year\n&#34;; }, &#34;NewYear&#34; &#41;;

print &#34;Please wait while initialization is scheduled\n&#34;;

$cron-&gt;run&#40; { detach =&gt; 0 } &#41;;

exit;


sub idler {
    my&#40; $time &#41; = @_;

    my&#40; $rout, $wout &#41;;

    my&#40; $nfound, $ttg &#41; = select&#40; $rout=$rin, $wout=$win, undef, $time &#41;;
    if&#40; $nfound &#41; {
	if&#40; $nfound == -1 &#41; {
	    die &#34;select&#40;&#41; error: $!\n&#34;; # This will be an internal error, such as a stale fd.
	}
	for&#40; my $n = 0; $n &lt;= $maxfd; $n++ &#41; {
	    if&#40; vec&#40; $rout, $n, 1 &#41; &#41; {
		my $s = $servers{$n};
		$s-&gt;{rsub}-&gt;&#40; &#41;;
	    }
	}
	for&#40; my $n = 0; $n &lt;= $maxfd; $n++ &#41; {
	    if&#40; vec&#40; $wout, $n, 1 &#41; &#41; {
		my $s = $servers{$n};
		$s-&gt;{wsub}-&gt;&#40; &#41;;
	    }
	}
    }
}

# First task run initializes &#40;usually in daemon, after forking closed open files&#41;
# I suppose this could be a postfork callback, but there isn&#39;t one...

sub init {
    my&#40; $name, $cron &#41; = @_;

    $cron-&gt;delete_entry&#40; &#39;Init&#39; &#41;;

    $rin = &#39;&#39;;
    $win = &#39;&#39;;

    $lsock = IO::Socket::INET-&gt;new&#40;
				   LocalAddr =&gt; &#34;localhost:$port&#34;,
				   Proto =&gt; &#39;tcp&#39;,
				   Type =&gt; SOCK_STREAM,
				   Listen =&gt; 5,
				   ReuseAddr =&gt; 1,
				   Blocking =&gt; 0,
				  &#41;,
				    or die &#34;Unable to open status port $port $!\n&#34;;
    vec&#40; $rin, &#40;$maxfd = $lsock-&gt;fileno&#40;&#41;&#41;, 1 &#41; = 1;
    $servers{$maxfd} = { rsub=&gt;sub { newConn&#40; $lsock, $cron &#41;; } };

    print &#34;Ready, my port is localhost::$port\n&#34;;

    return;
}

sub newConn {
    my&#40; $lsock, $cron &#41; = @_;

    my $sock = $lsock-&gt;accept&#40;&#41;;

    $sock-&gt;blocking&#40;0&#41;;
    my $cx = {
	      rbuf =&gt; &#39;&#39;,
	      wbuf =&gt; &#39;Password: &#39;,
	      };
    my $fd = $sock-&gt;fileno&#40;&#41;;
    $maxfd = $fd if&#40; $maxfd &lt; $fd &#41;;

    vec&#40; $rin, $fd, 1 &#41; = 1;
    vec&#40; $win, $fd, 1 &#41; = 1;
    $servers{$fd} = { rsub=&gt;sub { serverRd&#40; $sock, $cx, $fd &#41;; },
		      wsub=&gt;sub { serverWr&#40; $sock, $cx, $fd &#41;; },
		      cron=&gt;$cron,
		    };
}

sub serverRd {
    my&#40; $sock, $cx, $fd &#41; = @_;

    # Read whatever is available.  1000 is arbitrary, 1 will work &#40;with lots of overhead&#41;.
    # Huge will prevent any other thread from running.

    my $rn= $sock-&gt;sysread&#40; $cx -&gt;{rbuf}, 1000, length $cx-&gt;{rbuf} &#41;;
    unless&#40; defined $rn &#41; {
	print &#34;Read error: $!\n&#34;;
    }
    unless&#40; $rn &#41; { # Connection closed by client
	vec&#40; $rin, $fd, 1 &#41; = 0;
	vec&#40; $win, $fd, 1 &#41; = 0;
	$sock-&gt;close&#40;&#41;;
	undef $cx;
	return;
    }

    # Assemble reads to form whole lines
    # Decode each line as a command.

    while&#40; $cx-&gt;{rbuf} =~ /$LF/sm &#41; {
	$cx-&gt;{rbuf} =~ s/$CR//g;
	my&#40; $line, $rest &#41;;
	&#40;$line, $rest&#41; = split&#40; /$LF/, $cx-&gt;{rbuf}, 2 &#41;;
	$rest = &#39;&#39; unless&#40; defined $rest &#41;;
	$cx-&gt;{rbuf} = $rest;

	# This is not secure, but one has to do something.
	# Demos always get used for more than they should..
	# Please do better...like user/account validation
	# using the system services.

	unless&#40; $cx-&gt;{authenticated} &#41;{
	    if&#40; $line eq $password &#41; {
		$cx-&gt;{authenticated} = 1;
		$cx-&gt;{wbuf} .= &#34;Password accepted$CR$LF&#34;;
	    } else {
		$cx-&gt;{wbuf} .= &#34;Password refused.$CR${LF}Password: &#34;;
	    }
	    next;
	}

	if&#40; $line =~ /^STATUS$/i &#41; {
	    $cx-&gt;{wbuf} .= status&#40; $cron &#41;;
	} elsif&#40; $line =~ /^ADD\s+&#40;\w+&#41;\s+&#34;&#40;.*?&#41;&#34;\s+&#40;.*&#41;$/i &#41; {
	    $cron-&gt;add_entry&#40; $2, \&#38;announce, $1, $3 &#41;;
	    $cx-&gt;{wbuf} .= &#34;Added $2$CR$LF&#34;;
	} elsif&#40; $line =~ /^DEL&#40;?:ETE&#41;?\s+&#40;\w+&#41;$/i &#41; {
	    my $name = $1;
	    my $idx = $cron-&gt;check_entry&#40; $name &#41;;
	    if&#40; defined $idx &#41; {
		$cron-&gt;delete_entry&#40; $idx &#41;;
		$cx-&gt;{wbuf} .= &#34;Deleted $name$CR$LF&#34;;
	    } else {
		$cx-&gt;{wbuf} .= &#34;$name not found$CR$LF&#34;;
	    }
	} elsif&#40; $line =~ /^LOAD\s&#40;.*&#41;$/i &#41; {
	    my $cfg = $1; # Danger: File permissions of server are used here.
	      eval {
		  $cron-&gt;load_crontab&#40; $cfg &#41;;
	      };
	    my $emsg = $@;
	    $emsg =~ s/\n/$CR$LF/gms;
	    $cx-&gt;{wbuf} .= $emsg || &#34;Loaded $cfg$CR$LF&#34;;
	} elsif&#40; $line =~ /^Q&#40;?:uit&#41;?$/i &#41; {
	    $cx-&gt;{wbuf} .= &#34;Bye$CR$LF&#34;;
	    $cx-&gt;{wend} = 1;
	} else {
	    $cx-&gt;{wbuf} .= &#34;Unrecognized command: $line$CR$LF&#34;;
	}
    }
    serverWr&#40; $sock, $cx, $fd &#41;;
}

# Server write process
#
# Output as much as possible from our buffer.
# If more remains, keep select mask active
# If done, clear select mask.  If last write, close socket.

sub serverWr {
    my&#40; $sock, $cx, $fd &#41; = @_;

    if&#40; length $cx-&gt;{wbuf} &#41; {
	my $written = $sock-&gt;syswrite&#40; $cx-&gt;{wbuf} &#41;;

	$cx-&gt;{wbuf} = substr&#40; $cx-&gt;{wbuf}, $written &#41;;
    }
    if&#40; length $cx-&gt;{wbuf} &#41; {
	vec&#40; $win, $fd, 1 &#41; = 1;
	return;
    } else {
	vec&#40; $win, $fd, 1 &#41; = 0;
	if&#40; $cx-&gt;{wend} &#41; {
	    vec&#40; $rin, $fd, 1 &#41; = 0;
	    $sock-&gt;close&#40;&#41;;
	    return;
	}
    }
}

sub announce {
    my&#40; $id, $msg &#41; = @_;

    print &#34;$id: $msg\n&#34;;
    return;
}

sub status {
    my $cron = shift;

    my $maxtwid = 0;
    my @entries = map { $_-&gt;[0] } sort { $a-&gt;[1] &lt;=&gt; $b-&gt;[1] }
                                           map { 
					         my $time = $_-&gt;{time};
						 $maxtwid = length $time if&#40; $maxtwid &lt; length $time &#41;;
					         [ $_, 
						   $cron-&gt;get_next_execution_time&#40; $time &#41;,
						 ]
					       } $cron-&gt;list_entries&#40;&#41;;
    my $msg = &#39;&#39;;
    foreach my $qe &#40; @entries &#41; {
	my $job = $cron-&gt;check_entry&#40; $qe-&gt;{args}-&gt;[0] &#41;;
	next unless&#40; defined $job &#41;; #??
	$msg .= sprintf&#40; &#34;Job %-4s %-*s Next: %s - %s&#34;, 
			 $job, $maxtwid, $qe-&gt;{time},
			 &#40;scalar localtime&#40; $cron-&gt;get_next_execution_time&#40; $qe-&gt;{time}, 0 &#41; &#41;&#41;,
			 $qe-&gt;{args}-&gt;[0] ||  &#39;&lt;Unnamed&gt;&#39;, # Task name
		       &#41;;
	if&#40; 1 &#41; {
	    $msg .= &#39;&#40; &#39;;
	    my @uargs = @{$qe-&gt;{args}};
	    $msg .= join&#40; &#39;, &#39;, @uargs[1..$#uargs] &#41; . &#39; &#41;&#39;;
	}
	$msg .= &#34;\n&#34;;
    }
    $msg .= &#34;End of job queue\n&#34;;

    return $msg;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;02&nbsp;14:15:53&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;02&nbsp;15:07:56&nbsp;2011</span>
    <span class="description">roland [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza">Hi Timothe,<br>

<br>

On Thu Jun 02 14:15:52 2011, tlhackque wrote: <br>

<br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for accepting the changes.  That's a big help. <br>
</div><br>

No problem, I have to thank you.<br>

<br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The reason I didn't provide the $cron in the sleep call-out was that  <br>

&gt; it's easy to do that in a closure - which can also provide other  <br>

&gt; application-specific arguments. <br>
</div><br>

This can be still done, but I think the most common use case will<br>

be to modify the cron entry queue like in your example, so you would<br>

need the $cron object most of the time. And it doesn't hurt either ;-)<br>

<br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But what you describe should be OK.  (Your upload hasn't made it to  <br>

&gt; CPAN yet.) <br>
</div><br>

Sorry, it it version 1.01_2 (not 1.02), which should be available at the mirrors <br>

now (at&nbsp;least I could download it from there). I will release 1.01 final on sunday <br>

if no big&nbsp;veto comes from the other two open ticket holders.<br>

<br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But, since you were kind enough to take my patches, I wrote the  <br>

&gt; simplest useful tool for demonstrating the utility of sleep-callouts  <br>

&gt; that I could think of.  I think it's too much for an example (about 250  <br>

&gt; lines of perl).  But you may find it useful for debugging.  I'm not  <br>

&gt; an &quot;expect&quot; guy, but you should also be able to use it for a unit test  <br>

&gt; if you are. <br>
</div><br>

That's exactly what I was looking for. If you don't mind, I would like to include<br>

it into the example/ directory of Schedule::Cron (and add the user documentation<br>

and&nbsp;warning you pointed out as top comments).&nbsp;<br>

<br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have more complex uses, but this should demonstrate the utility. <br>
</div><br>

the example is perfect, thanks !<br>

<br>

... roland<br>

<br>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;02&nbsp;16:13:42&nbsp;2011</span>
    <span class="description">tlhackque [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> tlhackque [...] yahoo.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">You can ship the example - with a BIG warning about &#34;Intended to 
demonstrate how to use the sleep-callout, but NOT suitable for 
production use.&#34;  Real secuity would have made it even bigger - and is 
hard to make platform-independent.  I think the only API that I don&#39;t 
exercise is &#34;update&#34; &#40;and eval, which is another security trap&#41;.  You 
might want to add an &#34;update&#34; command for your testing.  Also, note 
that I only parse \w+ for task names - the cron.tab tasks are 
undeletable due to the double-quotes in the names.  &#40;I took them direct 
from your examples.&#41;  Not important - I wanted to provide the shortest 
useful example, not a worked-out tool.

I don&#39;t want to belabor the point, but a little more explanation: I 
don&#39;t think it hurts to call-out with $cron, as I said, it&#39;s fine with 
me.  

It&#39;s just that most of the time you either need nothing &#40;using a 
closure or perhaps a global variable&#41;, or you need your own structures 
in addition to $cron.  My trivial example is hard-coded; in any real 
case the entry to be added or accessed has to be specified from 
somewhere.  And so do the dispatch routine, its arguments, where to 
send errors...  And that&#39;s either a closure, or another case where we&#39;d 
have to pass user arguments to the call-out.

The only unique data that must come from the schedular is the maximum 
sleep time.  Everything else - it&#39;s as much style as anything else.  I 
like simple.  Especially in this case where it&#39;s a frequently-executed 
code path &#40;every I/O will wake the select.&#41;  But passing one extra 
scalar isn&#39;t a big deal.  &#40;Dumping 200KB user args was!&#41;

I&#39;ll switch to your code as soon as I have a chance.

It&#39;s been good working with you; thanks again.

On Thu Jun 02 15:07:56 2011, ROLAND wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Timothe,
&gt; 
&gt; On Thu Jun 02 14:15:52 2011, tlhackque wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; Thanks for accepting the changes. That&#39;s a big help.
</div>&gt; 
&gt; No problem, I have to thank you.
&gt; 
<div class="message-stanza open">&gt; &gt; The reason I didn&#39;t provide the $cron in the sleep call-out was that
&gt; &gt; it&#39;s easy to do that in a closure - which can also provide other
&gt; &gt; application-specific arguments.
</div>&gt; 
&gt; This can be still done, but I think the most common use case will
&gt; be to modify the cron entry queue like in your example, so you would
&gt; need the $cron object most of the time. And it doesn&#39;t hurt either ;-&#41;
&gt; 
<div class="message-stanza open">&gt; &gt; But what you describe should be OK. &#40;Your upload hasn&#39;t made it to
&gt; &gt; CPAN yet.&#41;
</div>&gt; 
&gt; Sorry, it it version 1.01_2 &#40;not 1.02&#41;, which should be available at 
</div>the
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; mirrors
&gt; now &#40;at least I could download it from there&#41;. I will release 1.01 
</div>final on
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; sunday
&gt; if no big veto comes from the other two open ticket holders.
&gt; 
<div class="message-stanza open">&gt; &gt; But, since you were kind enough to take my patches, I wrote the
&gt; &gt; simplest useful tool for demonstrating the utility of sleep-callouts
&gt; &gt; that I could think of. I think it&#39;s too much for an example &#40;about 
</div></div>250
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; lines of perl&#41;. But you may find it useful for debugging. I&#39;m not
&gt; &gt; an &#34;expect&#34; guy, but you should also be able to use it for a unit 
</div></div>test
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; if you are.
</div>&gt; 
&gt; That&#39;s exactly what I was looking for. If you don&#39;t mind, I would 
</div>like to
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; include
&gt; it into the example/ directory of Schedule::Cron &#40;and add the user
&gt; documentation
&gt; and warning you pointed out as top comments&#41;.
&gt; 
<div class="message-stanza open">&gt; &gt; I have more complex uses, but this should demonstrate the utility.
</div>&gt; 
&gt; the example is perfect, thanks !
&gt; 
&gt; ... roland
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;03&nbsp;06:54:05&nbsp;2011</span>
    <span class="description">tlhackque [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Sleep example</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> tlhackque [...] yahoo.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Since you plan to include CronSleepExample in the kit, I added a help 
display and also made it *slightly* less insecure by restricting 
filenames for LOAD.  Attached.

I intentionally didn&#39;t put the password in the help display so people 
will have to read the source - thereby encouraging them to read the 
warnings.

Enjoy.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CronSleepExample</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

# Copyright &#40;c&#41; 2011 Timothe Litt &lt;litt at acm dot org&gt;
#
# May be used on the same terms as Perl.

# Sleep hook demo, showing how it enables a background thread
# to provide a simple command interface to a daemon.

use strict;
use warnings;

use Schedule::Cron;
use Socket &#39;:crlf&#39;;
use IO::Socket::INET;

my $port = 65331;
our $password = &#39;Purfect&#39;;

our&#40; $lsock, $rin, $win, $maxfd, %servers &#41;;

my $cron = new Schedule::Cron&#40; sub { print &#39;Loaded entry: &#39;, join&#40;&#39;&#39;, @_ &#41;, &#34;\n&#34;; }, {
					nofork =&gt; 1,
					loglevel =&gt; 0,
					log =&gt; sub { print $_[1], &#34;\n&#34;; },
					sleep =&gt; \&#38;idler
				       } &#41;;

$cron-&gt;add_entry&#40; &#34;* * * * * *&#34;, \&#38;init, &#39;Init&#39;, $cron &#41;;
$cron-&gt;add_entry&#40; &#34;0 0 1 1 *&#34;, sub { print &#34;Happy New Year\n&#34;; }, &#34;NewYear&#34; &#41;;

print &#34;Please wait while initialization is scheduled\n&#34;;
print help&#40;&#41;;

$cron-&gt;run&#40; { detach =&gt; 0 } &#41;;

exit;


sub idler {
    my&#40; $time &#41; = @_;

    my&#40; $rout, $wout &#41;;

    my&#40; $nfound, $ttg &#41; = select&#40; $rout=$rin, $wout=$win, undef, $time &#41;;
    if&#40; $nfound &#41; {
	if&#40; $nfound == -1 &#41; {
	    die &#34;select&#40;&#41; error: $!\n&#34;; # This will be an internal error, such as a stale fd.
	}
	for&#40; my $n = 0; $n &lt;= $maxfd; $n++ &#41; {
	    if&#40; vec&#40; $rout, $n, 1 &#41; &#41; {
		my $s = $servers{$n};
		$s-&gt;{rsub}-&gt;&#40; &#41;;
	    }
	}
	for&#40; my $n = 0; $n &lt;= $maxfd; $n++ &#41; {
	    if&#40; vec&#40; $wout, $n, 1 &#41; &#41; {
		my $s = $servers{$n};
		$s-&gt;{wsub}-&gt;&#40; &#41;;
	    }
	}
    }
}

# First task run initializes &#40;usually in daemon, after forking closed open files&#41;
# I suppose this could be a postfork callback, but there isn&#39;t one...

sub init {
    my&#40; $name, $cron &#41; = @_;

    $cron-&gt;delete_entry&#40; &#39;Init&#39; &#41;;

    $rin = &#39;&#39;;
    $win = &#39;&#39;;

    $lsock = IO::Socket::INET-&gt;new&#40;
				   LocalAddr =&gt; &#34;localhost:$port&#34;,
				   Proto =&gt; &#39;tcp&#39;,
				   Type =&gt; SOCK_STREAM,
				   Listen =&gt; 5,
				   ReuseAddr =&gt; 1,
				   Blocking =&gt; 0,
				  &#41;,
				    or die &#34;Unable to open status port $port $!\n&#34;;
    vec&#40; $rin, &#40;$maxfd = $lsock-&gt;fileno&#40;&#41;&#41;, 1 &#41; = 1;
    $servers{$maxfd} = { rsub=&gt;sub { newConn&#40; $lsock, $cron &#41;; } };

    print &#34;Ready, my port is localhost:$port\nTo connect:\n    telnet localhost $port\n&#34;;

    return;
}

sub newConn {
    my&#40; $lsock, $cron &#41; = @_;

    my $sock = $lsock-&gt;accept&#40;&#41;;

    $sock-&gt;blocking&#40;0&#41;;
    my $cx = {
	      rbuf =&gt; &#39;&#39;,
	      wbuf =&gt; &#39;Password: &#39;,
	      };
    my $fd = $sock-&gt;fileno&#40;&#41;;
    $maxfd = $fd if&#40; $maxfd &lt; $fd &#41;;

    vec&#40; $rin, $fd, 1 &#41; = 1;
    vec&#40; $win, $fd, 1 &#41; = 1;
    $servers{$fd} = { rsub=&gt;sub { serverRd&#40; $sock, $cx, $fd &#41;; },
		      wsub=&gt;sub { serverWr&#40; $sock, $cx, $fd &#41;; },
		      cron=&gt;$cron,
		    };
}

sub serverRd {
    my&#40; $sock, $cx, $fd &#41; = @_;

    # Read whatever is available.  1000 is arbitrary, 1 will work &#40;with lots of overhead&#41;.
    # Huge will prevent any other thread from running.

    my $rn= $sock-&gt;sysread&#40; $cx -&gt;{rbuf}, 1000, length $cx-&gt;{rbuf} &#41;;
    unless&#40; defined $rn &#41; {
	print &#34;Read error: $!\n&#34;;
    }
    unless&#40; $rn &#41; { # Connection closed by client
	vec&#40; $rin, $fd, 1 &#41; = 0;
	vec&#40; $win, $fd, 1 &#41; = 0;
	$sock-&gt;close&#40;&#41;;
	undef $cx;
	return;
    }

    # Assemble reads to form whole lines
    # Decode each line as a command.

    while&#40; $cx-&gt;{rbuf} =~ /$LF/sm &#41; {
	$cx-&gt;{rbuf} =~ s/$CR//g;
	my&#40; $line, $rest &#41;;
	&#40;$line, $rest&#41; = split&#40; /$LF/, $cx-&gt;{rbuf}, 2 &#41;;
	$rest = &#39;&#39; unless&#40; defined $rest &#41;;
	$cx-&gt;{rbuf} = $rest;

	# This is not secure, but one has to do something.
	# Demos always get used for more than they should..
	# Please do better...like user/account validation
	# using the system services.

	unless&#40; $cx-&gt;{authenticated} &#41;{
	    if&#40; $line eq $password &#41; {
		$cx-&gt;{authenticated} = 1;
		$cx-&gt;{wbuf} .= &#34;Password accepted$CR$LF&#34;;
	    } else {
		$cx-&gt;{wbuf} .= &#34;Password refused.$CR${LF}Password: &#34;;
	    }
	    next;
	}

	if&#40; $line =~ /^STAT&#40;?:US&#41;?&#40;?: &#40;\w+&#41;&#41;?$/i &#41; {
	    $cx-&gt;{wbuf} .= status&#40; $cron, &#40;$1 || &#39;normal&#39;&#41; &#41;;
	} elsif&#40; $line =~ /^ADD\s+&#40;\w+&#41;\s+&#34;&#40;.*?&#41;&#34;\s+&#40;.*&#41;$/i &#41; {
	    my&#40; $name, $sched &#41; = &#40;$1, $2&#41;;
	    $cron-&gt;add_entry&#40; $sched, \&#38;announce, $1, $3 &#41;;
	    $cx-&gt;{wbuf} .= &#34;Added $name &#39;$sched&#39;$CR$LF&#34;;
	} elsif&#40; $line =~ /^DEL&#40;?:ETE&#41;?\s+&#40;[&#34;\w]+&#41;$/i &#41; {
	    my $name = $1;
	    my $idx = $cron-&gt;check_entry&#40; $name &#41;;
	    if&#40; defined $idx &#41; {
		$cron-&gt;delete_entry&#40; $idx &#41;;
		$cx-&gt;{wbuf} .= &#34;Deleted $name$CR$LF&#34;;
	    } else {
		$cx-&gt;{wbuf} .= &#34;$name not found$CR$LF&#34;;
	    }
	} elsif&#40; $line =~ /^HELP$/i &#41; {
	    $cx-&gt;{wbuf} .= help&#40;&#41;;
	} elsif&#40; $line =~ /^LOAD\s&#40;[\w\._-]+&#41;$/i &#41; {
	    my $cfg = $1; # Danger: File permissions of server are used here.
	      eval {
		  $cron-&gt;load_crontab&#40; $cfg &#41;;
	      };
	    my $emsg = $@;
	    $emsg =~ s/\n/$CR$LF/gms;
	    $cx-&gt;{wbuf} .= $emsg || &#34;Loaded $cfg$CR$LF&#34;;
	} elsif&#40; $line =~ /^Q&#40;?:uit&#41;?$/i &#41; {
	    $cx-&gt;{wbuf} .= &#34;Bye$CR$LF&#34;;
	    $cx-&gt;{wend} = 1;
	} else {
	    $cx-&gt;{wbuf} .= &#34;Unrecognized command: $line$CR$LF&#34;;
	}
    }
    serverWr&#40; $sock, $cx, $fd &#41;;
}

# Server write process
#
# Output as much as possible from our buffer.
# If more remains, keep select mask active
# If done, clear select mask.  If last write, close socket.

sub serverWr {
    my&#40; $sock, $cx, $fd &#41; = @_;

    if&#40; length $cx-&gt;{wbuf} &#41; {
	my $written = $sock-&gt;syswrite&#40; $cx-&gt;{wbuf} &#41;;

	$cx-&gt;{wbuf} = substr&#40; $cx-&gt;{wbuf}, $written &#41;;
    }
    if&#40; length $cx-&gt;{wbuf} &#41; {
	vec&#40; $win, $fd, 1 &#41; = 1;
	return;
    } else {
	vec&#40; $win, $fd, 1 &#41; = 0;
	if&#40; $cx-&gt;{wend} &#41; {
	    vec&#40; $rin, $fd, 1 &#41; = 0;
	    $sock-&gt;close&#40;&#41;;
	    return;
	}
    }
}

sub announce {
    my&#40; $id, $msg &#41; = @_;

    print &#34;$id: $msg\n&#34;;
    return;
}

sub status {
    my $cron = shift;
    my $level = shift;

    my $maxtwid = 0;
    my @entries = map { $_-&gt;[0] } sort { $a-&gt;[1] &lt;=&gt; $b-&gt;[1] }
                                           map { 
					         my $time = $_-&gt;{time};
						 $maxtwid = length $time if&#40; $maxtwid &lt; length $time &#41;;
					         [ $_, 
						   $cron-&gt;get_next_execution_time&#40; $time &#41;,
						 ]
					       } $cron-&gt;list_entries&#40;&#41;;
    my $msg = &#34;Job queue\n&#34;;
    foreach my $qe &#40; @entries &#41; {
	my $job = $cron-&gt;check_entry&#40; $qe-&gt;{args}-&gt;[0] &#41;;
	next unless&#40; defined $job &#41;; #??
	$msg .= sprintf&#40; &#34;Job %-4s %-*s Next: %s - %s&#34;, 
			 $job, $maxtwid, $qe-&gt;{time},
			 &#40;scalar localtime&#40; $cron-&gt;get_next_execution_time&#40; $qe-&gt;{time}, 0 &#41; &#41;&#41;,
			 $qe-&gt;{args}-&gt;[0] ||  &#39;&lt;Unnamed&gt;&#39;, # Task name
		       &#41;;
	if&#40; $level =~ /^debug$/i &#41; {
	    $msg .= &#39;&#40; &#39;;
	    my @uargs = @{$qe-&gt;{args}};
	    $msg .= join&#40; &#39;, &#39;, @uargs[1..$#uargs] &#41; . &#39; &#41;&#39;;
	}
	$msg .= &#34;\n&#34;;
    }
    $msg .= &#34;End of job queue\n&#34;;
    $msg =~ s/\n/$CR$LF/mgs;

    return $msg;
}

use Cwd &#39;getcwd&#39;;
sub help {
    my $wd = getcwd&#40;&#41;;
   my $msg = &lt;&lt;&#34;HELP&#34;;
CAUTION: Not production code.  NOT secure.
Do NOT run from privileged account.

Commands:
    status
       Shows queue

    status debug
       With argument lists

    add name &#34;schedule&#34; A string to be printed when executed
       Adds a new task on specified schedule

    delete name
       Deletes a task &#40;by name&#41;

    help
      This message.

    load file
        Loads a crontab file from $wd
        CAUTION, this is with server permissions.  If 
        the server can read /etc/passwd &#40;or anything else&#41;, 
        it will display it in the error messages.  
        As I said, NOT production...

    quit
        Exits.

HELP

   $msg =~ s/\n/$CRLF/gms;

   return $msg;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;03&nbsp;09:31:51&nbsp;2011</span>
    <span class="description">roland [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza"><br>

I put the sample from yesterday already into 1.01_3 release<br>

as 'examples/custom_sleep.pl' and added some documentation inline<br>

as POD into the example. I will update it with the sample you just<br>

posted before the final release on sunday.&nbsp;<br>

<br>

I put the cron.tab also into the examples/ directory, so playing around&nbsp;<br>

should be easy.&nbsp;<br>

<br>

Although I appreciate your security awareness, I don't think people<br>

will use this example other than, well, an example. Since it is stated<br>

everywhere in the source and the documentation, there should be no<br>

problem at all.<br>

<br>

Thanks again ...<br>

... roland<br>

<br>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;10&nbsp;02:04:43&nbsp;2011</span>
    <span class="description">roland [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza">&nbsp;So that 1.01 is out since a week now, its time to close this ticket.<br>

<br>

Thank you very much again for this nice patch and the example for the custom 'sleep' method. &nbsp;<br>

<br>

... roland.<br>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;10&nbsp;02:04:44&nbsp;2011</span>
    <span class="description">roland [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
