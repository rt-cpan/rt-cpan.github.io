<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #50196 for TVDB-API: Crashes, incorrect checks and typos</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #50196 for TVDB-API: Crashes, incorrect checks and typos</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/TVDB-API/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/TVDB-API/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/TVDB-API/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/TVDB-API/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/TVDB-API">TVDB-API CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">50196</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/TVDB-API/Active/">TVDB-API</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
gerph [...] gerph.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-224064-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.33    </td>
  </tr>
  <tr id="CF-224065-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;04&nbsp;17:27:25&nbsp;2009</span>
    <span class="description">gerph [...] gerph.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Crashes, incorrect checks and typos</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Summary:

There are a couple of mistakes in the TVDB::API 0.33 which mean that 
the update operations will always fail on updated episodes. 
Additionally there were typos in the warnings, and a mistake in the 
operator used to assign to the database which meant that episodes could 
be erased from the database by calling getEpisodeId.


Details:

There are a number of issues in the 0.33 version of TVDB::API. I have 
addressed those that I can in the patch, attached. I shall describe 
each and how it was observed, together with examples from the patch.

The first problem I saw was that the updates were not pulling in 
episode changes at all - in particular, FlashForward 1x01 had been 
fetched the day it was shown and contained no information other than 
the episode title. As of today, when an update was attempted, the TVDB 
contains a description for this episode, and even after repeatedly 
doing updates for the &#39;month&#39; type, no more data was obtained. 
Debugging in the code showed that in the updates, the following line 
was being triggered:

next unless defined $series-&gt;{$ep-&gt;{Series}};

Indeed, $series-&gt;{$ep-&gt;{Series}} is not defined. This is because $ep-&gt;
{Series} is an arrayref - because ForceArray has been set on &#39;Series&#39;. 
This has had two effects - firstly the database has filled with large 
numbers of keys marked &#39;ARRAY&#40;0x########&#41;&#39;, which are probably making 
it slower and larger than it needs to be.

A fix for this was to change the behaviour so that we read the single 
seriesid from the arrayref, thus:

  my $sid = $ep-&gt;{Series};
  $sid = $sid-&gt;[0] if &#40;ref $sid eq &#39;ARRAY&#39;&#41;;
                
  # Don&#39;t update if we don&#39;t already have this series
  next unless defined $series-&gt;{$sid};

A similar change is necessary for the banners code that follows it in 
the database to ensure that it updates images which have been 
downloaded. In my own cache db, I added some code to clear up the ARRAY
&#40;0x########&#41; keys which were redundant, but this has not been included 
in this patch.

Having fixed this, fetches of episodes were failing with errors &#40;die-
ing out of perl&#41; complaining that a numeric value could not be used as 
a hashref. Debugging showed that the expression:

$episodes-&gt;{$eid}-&gt;{lastupdated}

was the problem; $episodes-&gt;{$eid} was not a hashref, but instead it 
was a number. Hunting for how this was assigned pointed to 
getEpisodeId, thus:

$cache-&gt;{Episode}-&gt;{$eid} = $new-&gt;{Episode}-{$eid};

which shouldn&#39;t be a subtraction; it should be a -&gt;.

As a consequence of this breakage, previous use of the getEpisodeId 
function might have inserted rubbish into the database. To clear this 
up and thus prevent the library from crashing due to the use of a 
number as a hashref, a small protection is added to the update routines:

  if &#40;defined $episodes-&gt;{$eid} &#38;&#38; !ref $episodes-&gt;{$eid}&#41;
  {
    $episodes-&gt;{$eid} = { lastupdated=&gt;0 };
  }

which will force the update of that episode id, replacing the old value.

I found it difficult to understand the &#39;unless&#39; clause which followed 
this, and the updates were not happening properly for the episodes, so 
I restructured the code to use:

  next unless defined $episodes-&gt;{$eid};

  # Update if there is a more recent version
  if &#40;$ep-&gt;{time} &gt; $episodes-&gt;{$eid}-&gt;{lastupdated}&#41; {
    ...

which is closer to what the series code does, and looks more obvious 
&#40;plus it caused all the episodes to update as I expected&#41;.

Finally there were a lot of typos of TVDB as TBDB which I fixed. Those 
might confuse the diffs slightly, but they were easy enough to include.

I have attached both the diffs and the patched version of the API.pm 
file.


Admin:

Perl version in use here: 5.8.8.
Distribution: Debian &#39;etch&#39;.
Kernel: 2.6.30.1

Flagged as Important because the functioning of the Updates is failing, 
and the issue with the numeric values used as hashrefs can cause the 
library to crash.

Although I&#39;ve observed the problem in 0.33, I believe these issues have 
been present in quite a few earlier versions.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> diffs-033.txt</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> API.pm</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
