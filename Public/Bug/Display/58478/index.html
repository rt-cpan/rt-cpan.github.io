<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #58478 for perl-ldap: SASL-related host canonicalisation misfeature </title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #58478 for perl-ldap: SASL-related host canonicalisation misfeature </h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/perl-ldap/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/perl-ldap/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/perl-ldap/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/perl-ldap/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/perl-ldap">perl-ldap CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">58478</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/perl-ldap/Active/">perl-ldap</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dom [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-25226-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.37    </td>
  </tr>
  <tr id="CF-25227-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;17&nbsp;06:46:43&nbsp;2010</span>
    <span class="description">dom [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SASL-related host canonicalisation misfeature</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Please see &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=573596">http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=573596</a></span>&gt; for
a full discussion, but it looks like the change introduced in #35263 is
horribly broken and should be reverted &#40;sorry&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;17&nbsp;06:46:56&nbsp;2010</span>
    <span class="description">dom [...] cpan.org -  Reference to ticket #35263 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;17&nbsp;10:20:42&nbsp;2010</span>
    <span class="description">GBARR [...] CPAN.ORG -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It is not broken. It is that there is more than one way to do it and there are users on both side of 
the fence.

As a result it was change so that the caller call $sasl-&gt;client_new and pass the result instead of 
the sasl object itself. 

  $sasl-&gt;client_new&#40;&#39;ldap&#39;,$hostname&#41;;

This way the caller has control over what hostname is used.

See

<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~gbarr/perl-ldap-0.4001/lib/Net/LDAP.pod#sasl">http://search.cpan.org/~gbarr/perl-ldap-0.4001/lib/Net/LDAP.pod#sasl</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;17&nbsp;10:20:43&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;17&nbsp;10:20:44&nbsp;2010</span>
    <span class="description">GBARR [...] CPAN.ORG -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;17&nbsp;16:57:35&nbsp;2010</span>
    <span class="description">dom [...] earth.li -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> 573596 [...] bugs.debian.org, rra [...] debian.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #58478] SASL-related host canonicalisation misfeature</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 17 Jun 2010 21:57:23 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Graham_Barr via RT &lt;bug-perl-ldap [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dominic Hargreaves &lt;dom [...] earth.li&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[CCing Russ in case I need correcting at any point]

On Thu, Jun 17, 2010 at 10:20:43AM -0400, Graham_Barr via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It is not broken. It is that there is more than one way to do it and there are users on both side of 
&gt; the fence.
&gt; 
&gt; As a result it was change so that the caller call $sasl-&gt;client_new and pass the result instead of 
&gt; the sasl object itself. 
&gt; 
&gt;   $sasl-&gt;client_new&#40;&#39;ldap&#39;,$hostname&#41;;
&gt; 
&gt; This way the caller has control over what hostname is used.
</div>
Hi,

I appreciate that the decision on whether to canonicalise is not always
obvious and that you support overriding, but I believe that the reported
issue with the code still applies in the current version: that peerhost
returns a stringified IP address, not any form of actual hostname.

Given you&#39;ve decided to retain the canonicalisation feature, it would
surely still be necessary to look up the name of the IP address.

Note that the current behaviour happens to work with MIT kerberos but
does not work with Heimdal.

Dominic.

-- 
Dominic Hargreaves | <span class="clickylink"><a target="new" rel="nofollow" href="http://www.larted.org.uk/~dom/">http://www.larted.org.uk/~dom/</a></span>
PGP key 5178E2A5 from the.earth.li &#40;keyserver,web,email&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;17&nbsp;16:57:36&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;rejected&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;17&nbsp;16:59:03&nbsp;2010</span>
    <span class="description">dom [...] earth.li -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> 573596 [...] bugs.debian.org, rra [...] debian.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #58478] SASL-related host canonicalisation misfeature</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 17 Jun 2010 21:58:56 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Graham_Barr via RT &lt;bug-perl-ldap [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dominic Hargreaves &lt;dom [...] earth.li&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Jun 17, 2010 at 09:57:23PM +0100, Dominic Hargreaves wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [CCing Russ in case I need correcting at any point]
&gt; 
&gt; On Thu, Jun 17, 2010 at 10:20:43AM -0400, Graham_Barr via RT wrote:
<div class="message-stanza open">&gt; &gt; It is not broken. It is that there is more than one way to do it and there are users on both side of 
&gt; &gt; the fence.
&gt; &gt; 
&gt; &gt; As a result it was change so that the caller call $sasl-&gt;client_new and pass the result instead of 
&gt; &gt; the sasl object itself. 
&gt; &gt; 
&gt; &gt;   $sasl-&gt;client_new&#40;&#39;ldap&#39;,$hostname&#41;;
&gt; &gt; 
&gt; &gt; This way the caller has control over what hostname is used.
</div>&gt; 
&gt; Hi,
&gt; 
&gt; I appreciate that the decision on whether to canonicalise is not always
&gt; obvious and that you support overriding, but I believe that the reported
&gt; issue with the code still applies in the current version: that peerhost
&gt; returns a stringified IP address, not any form of actual hostname.
&gt; 
&gt; Given you&#39;ve decided to retain the canonicalisation feature, it would
&gt; surely still be necessary to look up the name of the IP address.
&gt; 
&gt; Note that the current behaviour happens to work with MIT kerberos but
&gt; does not work with Heimdal.
</div>
And just to make explicit, there is a suggested improvement in the
Debian BTS:

    # If we&#39;re talking to a round-robin, the canonical name of
    # the host we are talking to might not match the name we
    # requested
    my $connected_ip = $ldap-&gt;{net_ldap_socket}-&gt;peeraddr;
    my $connected_domain = $ldap-&gt;{net_ldap_socket}-&gt;sockdomain;
    my $connected_name = gethostbyaddr&#40;$connected_ip, $connected_domain&#41;;
    $connected_name ||= $ldap-&gt;{net_ldap_host};

-- 
Dominic Hargreaves | <span class="clickylink"><a target="new" rel="nofollow" href="http://www.larted.org.uk/~dom/">http://www.larted.org.uk/~dom/</a></span>
PGP key 5178E2A5 from the.earth.li &#40;keyserver,web,email&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;18&nbsp;20:35:44&nbsp;2010</span>
    <span class="description">gbarr [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #58478] SASL-related host canonicalisation misfeature</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 18 Jun 2010 17:35:18 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-perl-ldap [...] rt.cpan.org&#34; &lt;bug-perl-ldap [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Graham Barr &lt;gbarr [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Because there are people which the current code works for and some it  
does not. There will be upset users either way. The decision has benn  
made to supply an alternate method to give more control over the API.  
As a result the existing code will not be changed again. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;19&nbsp;13:49:58&nbsp;2010</span>
    <span class="description">rra [...] debian.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Graham_Barr via RT &lt;bug-perl-ldap [...] rt.cpan.org&gt;,  573596 [...] bugs.debian.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #58478] SASL-related host canonicalisation misfeature</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 19 Jun 2010 10:49:49 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Dominic Hargreaves &lt;dom [...] earth.li&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Russ Allbery &lt;rra [...] debian.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dominic Hargreaves &lt;dom@earth.li&gt; writes:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; And just to make explicit, there is a suggested improvement in the
&gt; Debian BTS:
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     # If we&#39;re talking to a round-robin, the canonical name of
&gt;     # the host we are talking to might not match the name we
&gt;     # requested
&gt;     my $connected_ip = $ldap-&gt;{net_ldap_socket}-&gt;peeraddr;
&gt;     my $connected_domain = $ldap-&gt;{net_ldap_socket}-&gt;sockdomain;
&gt;     my $connected_name = gethostbyaddr&#40;$connected_ip, $connected_domain&#41;;
&gt;     $connected_name ||= $ldap-&gt;{net_ldap_host};
</div>
Graham, the current code cannot possibly work with Kerberos GSS-API SASL
authentications.  Here&#39;s what it currently says:

      # If we&#39;re talking to a round-robin, the canonical name of
      # the host we are talking to might not match the name we
      # requested
      my $connected_name = $ldap-&gt;{net_ldap_socket}-&gt;peerhost;
      $connected_name ||= $ldap-&gt;{net_ldap_host};

And from IO::Socket::INET:

    peerhost &#40;&#41;
        Return the address part of the sockaddr structure for the socket on
        the peer host in a text form xx.xx.xx.xx

You cannot do a Kerberos SASL authentication to an IP address.  It will
never work; Kerberos doesn&#39;t support it.  Kerberos requires a hostname.
So setting the connected name to an IP address will always, always fail if
you&#39;re using GSS-API authentication.

Right now, everyone who wants to use Net::LDAP with Kerberos GSS-API
authentication needs to patch Net::LDAP; otherwise, the module is
completely unusable if that&#39;s the required authentication mechanism.

-- 
Russ Allbery &#40;rra@debian.org&#41;               &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.eyrie.org/~eagle/">http://www.eyrie.org/~eagle/</a></span>&gt;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;19&nbsp;14:00:29&nbsp;2010</span>
    <span class="description">rra [...] debian.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Dominic Hargreaves &lt;dom [...] earth.li&gt;,  Graham_Barr via RT &lt;bug-perl-ldap [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: Bug#573596: [rt.cpan.org #58478] SASL-related host canonicalisation misfeature</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 19 Jun 2010 11:00:18 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> 573596 [...] bugs.debian.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Russ Allbery &lt;rra [...] debian.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Russ Allbery &lt;rra@debian.org&gt; writes:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dominic Hargreaves &lt;dom@earth.li&gt; writes:
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; And just to make explicit, there is a suggested improvement in the
&gt;&gt; Debian BTS:
</div></div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt;     # If we&#39;re talking to a round-robin, the canonical name of
&gt;&gt;     # the host we are talking to might not match the name we
&gt;&gt;     # requested
&gt;&gt;     my $connected_ip = $ldap-&gt;{net_ldap_socket}-&gt;peeraddr;
&gt;&gt;     my $connected_domain = $ldap-&gt;{net_ldap_socket}-&gt;sockdomain;
&gt;&gt;     my $connected_name = gethostbyaddr&#40;$connected_ip, $connected_domain&#41;;
&gt;&gt;     $connected_name ||= $ldap-&gt;{net_ldap_host};
</div></div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Graham, the current code cannot possibly work with Kerberos GSS-API SASL
&gt; authentications.  Here&#39;s what it currently says:
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       # If we&#39;re talking to a round-robin, the canonical name of
&gt;       # the host we are talking to might not match the name we
&gt;       # requested
&gt;       my $connected_name = $ldap-&gt;{net_ldap_socket}-&gt;peerhost;
&gt;       $connected_name ||= $ldap-&gt;{net_ldap_host};
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; And from IO::Socket::INET:
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     peerhost &#40;&#41;
&gt;         Return the address part of the sockaddr structure for the socket on
&gt;         the peer host in a text form xx.xx.xx.xx
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You cannot do a Kerberos SASL authentication to an IP address.  It will
&gt; never work; Kerberos doesn&#39;t support it.  Kerberos requires a hostname.
&gt; So setting the connected name to an IP address will always, always fail if
&gt; you&#39;re using GSS-API authentication.
</div>
I reviewed the rest of the bug log and now I remember the rest of the
situation.  The reason why you may not have seen this in previous testing
is that apparently some versions of the MIT Kerberos library, when told to
authenticate to an IP address, will under the hood do the work that I
suggested in my proposed modification silently for you, canonicalizing the
IP address to a hostname.  But this is not part of the GSS-API library
guarantee and other GSS-API implementations, such as Heimdal, do not do
this.  Furthermore, MIT doesn&#39;t do this always; it only does this if it&#39;s
told to do DNS canonicalization.

So while a Kerberos authentication to an IP address will always fail, I
forgot that MIT Kerberos will in some cases fix up this bug for you.  It
still, however, breaks the module completely for people using Heimdal,
which is why we ran into this.  &#40;Heimdal is a considerably faster Kerberos
implementation for LDAP under most circumstances.&#41;

If you want to rely on the DNS canonicalization, you need to do it
directly, not assume that the GSS-API library will do it for you, since
only some of them will do that and in only some situations.

What makes this bug particularly nasty is that, with a GSS-API
implementation that doesn&#39;t do this lookup for you, there&#39;s no way to work
around the bug without surgery on the Net::LDAP module.  If you really
don&#39;t believe me that the code is incorrect as written, please at least
add some way for the caller to override the remote hostname for SASL
authentication so that at least we can work around this bug without having
to maintain a forked version of Net::LDAP.

-- 
Russ Allbery &#40;rra@debian.org&#41;               &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.eyrie.org/~eagle/">http://www.eyrie.org/~eagle/</a></span>&gt;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;19&nbsp;14:07:07&nbsp;2010</span>
    <span class="description">rra [...] debian.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Graham_Barr via RT &lt;bug-perl-ldap [...] rt.cpan.org&gt;,  Dominic Hargreaves &lt;dom [...] earth.li&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: Bug#573596: [rt.cpan.org #58478] SASL-related host canonicalisation misfeature</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 19 Jun 2010 11:06:58 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> 573596 [...] bugs.debian.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Russ Allbery &lt;rra [...] debian.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Russ Allbery &lt;rra@debian.org&gt; writes:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What makes this bug particularly nasty is that, with a GSS-API
&gt; implementation that doesn&#39;t do this lookup for you, there&#39;s no way to
&gt; work around the bug without surgery on the Net::LDAP module.  If you
&gt; really don&#39;t believe me that the code is incorrect as written, please at
&gt; least add some way for the caller to override the remote hostname for
&gt; SASL authentication so that at least we can work around this bug without
&gt; having to maintain a forked version of Net::LDAP.
</div>
Which, of course, is exactly what you did in the first message of this
thread.  Aie.  I&#39;m really sorry about that -- I can only plead that it&#39;s
been a very long week.

That will let us work around the issue, which will be okay.  I do still
disagree with your decision on the canonicalization code, but that will
let us use the module without patching it, which is, at the end of the
day, the goal.

I&#39;m sorry for not having thought through the entire thread and paid
attention before responding further.

-- 
Russ Allbery &#40;rra@debian.org&#41;               &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.eyrie.org/~eagle/">http://www.eyrie.org/~eagle/</a></span>&gt;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;28&nbsp;16:17:10&nbsp;2010</span>
    <span class="description">GBARR [...] CPAN.ORG -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
