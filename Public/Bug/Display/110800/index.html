<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #110800 for DBD-Pg: Queries containing intervals of format &#34;INTERVAL &#39;X period&#39;&#34; fail when pg_server_prepare is enabled </title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #110800 for DBD-Pg: Queries containing intervals of format &#34;INTERVAL &#39;X period&#39;&#34; fail when pg_server_prepare is enabled </h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-Pg/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-Pg/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-Pg/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-Pg/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-Pg">DBD-Pg CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">110800</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-Pg/Active/">DBD-Pg</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
KAMELKEV [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10200-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10201-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;30&nbsp;20:05:22&nbsp;2015</span>
    <span class="description">KAMELKEV [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Queries containing intervals of format &#34;INTERVAL &#39;X period&#39;&#34; fail
 when pg_server_prepare is enabled</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Discovered an unusual bug with DBI after recently doing some updates. Basically a common query just completely fails. It&#39;s not immediately clear why, but it&#39;s easy to reproduce.

We use Postgres &#40;9.4.5&#41;, running under FreeBSD &#40;9.3&#41;, with recent versions of nearly every library that is part of our stack, DBI included &#40;1.634&#41;. The issue occurs both when a database is either in UTF8 or SQL_ASCII.

The failing queries use the &#34;INTERVAL &#39;X period&#39;&#34; format, along the lines of:
&#34;SELECT now&#40;&#41; &gt; now&#40;&#41; - INTERVAL &#39;1 day&#39;&#34;

Upon updating our system we started receiving syntax errors like:
&#34;ERROR:  syntax error at or near &#34;$1&#34;
LINE 1: SELECT now&#40;&#41; &gt; now&#40;&#41; - INTERVAL $1
                                        ^&#34;

I found this to be very unusual, as the query executes fine from the Postgres CLI, and the alternative formats such as &#34;::interval&#34; and &#34;CAST&#40;X as INTERVAL&#41;&#34; both work as well. Only the format above fails.

I&#39;ve since rewritten our failing queries to use an alternative format, but ideally we can get this fixed. It&#39;s not clear what sort of materials are necessary to resolve a bug like this, please let me know and I can provide those details.

In addition I have attached a basic script which reproduces the issue.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dbi.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use warnings;
use strict;

use DBI;

my $username = &#39;&#39;;
my $password = &#39;&#39;;
my $host = &#39;&#39;;
my $dbname = &#39;&#39;;

my $datasource = &#34;dbi:Pg:dbname=$dbname;host=$host;port=5432;&#34;;
my $dbh = DBI-&gt;connect&#40;$datasource, $username, $password, { PrintError =&gt; 0 }&#41;
  or die &#39;dbi connect failure: &#39; . $DBI::errstr;

my $sth0 = $dbh-&gt;prepare&#40;&#39;SELECT now&#40;&#41; &gt; now&#40;&#41; - ?::interval&#39;&#41;;
$sth0-&gt;execute&#40;&#39;1 day&#39;&#41; or die $dbh-&gt;errstr&#40;&#41;;
print &#34;Result of &#39;SELECT now&#40;&#41; &gt; now&#40;&#41; - ?::interval&#39; = &#34; . $sth0-&gt;fetchrow&#40;&#41; . &#34;\n&#34;;

my $sth1 = $dbh-&gt;prepare&#40;&#39;SELECT now&#40;&#41; &gt; now&#40;&#41; - INTERVAL ?&#39;&#41;;
$sth1-&gt;execute&#40;&#39;1 day&#39;&#41; or die $dbh-&gt;errstr&#40;&#41;;
print &#34;Result of &#39;SELECT now&#40;&#41; &gt; now&#40;&#41; - ?::interval&#39; = &#34; . $sth1-&gt;fetchrow&#40;&#41; . &#34;\n&#34;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;31&nbsp;11:10:31&nbsp;2015</span>
    <span class="description">TIMB [...] cpan.org -  Queue changed from DBI to DBD-Pg</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;31&nbsp;11:11:13&nbsp;2015</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the report. I&#39;ve moved to the DBD::Pg queue.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;31&nbsp;11:11:13&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;03&nbsp;15:31:10&nbsp;2016</span>
    <span class="description">KAMELKEV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I simplified the test a bit, see the following attachment.

I didn&#39;t realize an interval can exist standalone, so I&#39;ve updated them to only query the interval without any associated operations.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dbi2.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use warnings;
use strict;

use DBI;

my $username = &#39;&#39;;
my $password = &#39;&#39;;
my $host = &#39;&#39;;
my $dbname = &#39;&#39;;

my $datasource = &#34;dbi:Pg:dbname=$dbname;host=$host;port=5432;&#34;;
my $dbh = DBI-&gt;connect&#40;$datasource, $username, $password, { PrintError =&gt; 0 }&#41;
  or die &#39;dbi connect failure: &#39; . $DBI::errstr;

print &#34;Result of &#39;SELECT ?::interval&#39; = \n&#34;;
my $sth0 = $dbh-&gt;prepare&#40;&#39;SELECT ?::interval&#39;&#41;;
$sth0-&gt;execute&#40;&#39;1 day&#39;&#41; or die $dbh-&gt;errstr&#40;&#41;;
print $sth0-&gt;fetchrow&#40;&#41; . &#34;\n&#34;;

print &#34;Result of &#39;SELECT INTERVAL ?&#39; = \n&#34;;
my $sth1 = $dbh-&gt;prepare&#40;&#39;SELECT INTERVAL ?&#39;&#41;;
$sth1-&gt;execute&#40;&#39;1 day&#39;&#41; or die $dbh-&gt;errstr&#40;&#41;;
print $sth1-&gt;fetchrow&#40;&#41; . &#34;\n&#34;;</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;06&nbsp;18:30:29&nbsp;2016</span>
    <span class="description">KAMELKEV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It was suggested by a coworker that this might actually be a bug with Postgres having a bug, or possibly correcting an earlier bug relating to sql syntax.

To that end I experimented a bit. For the &#39;::interval&#39; case:

vkmlm=&gt; PREPARE test &#40;text&#41; AS SELECT &#40;$1::interval&#41;;
PREPARE
vkmlm=&gt; EXECUTE test&#40;&#39;1 day&#39;&#41;;
 ?column?
----------
 1 day
&#40;1 row&#41;

For the &#39;INTERVAL X&#39; case:

vkmlm=&gt; PREPARE test2 &#40;text&#41; AS SELECT &#40;INTERVAL $1&#41;;
ERROR:  syntax error at or near &#34;$1&#34;

Note that the above is literally what my test is providing to DBI/DBD::Pg.

The following prepares correctly, but generates the wrong result, which jives with what the Postgres documentation indicates for a query formatted this way:

vkmlm=&gt; PREPARE test3 &#40;text&#41; AS SELECT &#40;INTERVAL &#39;$1&#39;&#41;;
PREPARE
vkmlm=&gt; EXECUTE test3&#40;&#39;1 day&#39;&#41;;
 interval
----------
 00:00:01
&#40;1 row&#41;


Finally there is this format, which works, but is not really what I was looking to do:

vkmlm=&gt; prepare test4 &#40;text&#41; as select &#40;INTERVAL &#39;$1&#39; DAY&#41;;
PREPARE
vkmlm=&gt; execute test4&#40;&#39;1&#39;&#41;;
 interval
----------
 1 day
&#40;1 row&#41;

So in this particular case I think that the suggestion that Postgres has fixed a bug is the most likely explanation why this query, which has literally worked for years in production, suddenly stopped working.

If so then we can close this ticket out as invalid. I&#39;d love to hear some other opinions here though.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;07&nbsp;14:49:52&nbsp;2016</span>
    <span class="description">KAMELKEV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Considering this issue resolved. The query is simply not compatible with server side prepared transactions. The only explanation is user error on my side, which I accept.

On Wed Jan 06 18:30:29 2016, KAMELKEV wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It was suggested by a coworker that this might actually be a bug with
&gt; Postgres having a bug, or possibly correcting an earlier bug relating
&gt; to sql syntax.
&gt; 
&gt; To that end I experimented a bit. For the &#39;::interval&#39; case:
&gt; 
&gt; vkmlm=&gt; PREPARE test &#40;text&#41; AS SELECT &#40;$1::interval&#41;;
&gt; PREPARE
&gt; vkmlm=&gt; EXECUTE test&#40;&#39;1 day&#39;&#41;;
&gt;  ?column?
&gt; ----------
&gt; 1 day
&gt; &#40;1 row&#41;
&gt; 
&gt; For the &#39;INTERVAL X&#39; case:
&gt; 
&gt; vkmlm=&gt; PREPARE test2 &#40;text&#41; AS SELECT &#40;INTERVAL $1&#41;;
&gt; ERROR:  syntax error at or near &#34;$1&#34;
&gt; 
&gt; Note that the above is literally what my test is providing to
&gt; DBI/DBD::Pg.
&gt; 
&gt; The following prepares correctly, but generates the wrong result,
&gt; which jives with what the Postgres documentation indicates for a query
&gt; formatted this way:
&gt; 
&gt; vkmlm=&gt; PREPARE test3 &#40;text&#41; AS SELECT &#40;INTERVAL &#39;$1&#39;&#41;;
&gt; PREPARE
&gt; vkmlm=&gt; EXECUTE test3&#40;&#39;1 day&#39;&#41;;
&gt;  interval
&gt; ----------
&gt; 00:00:01
&gt; &#40;1 row&#41;
&gt; 
&gt; 
&gt; Finally there is this format, which works, but is not really what I
&gt; was looking to do:
&gt; 
&gt; vkmlm=&gt; prepare test4 &#40;text&#41; as select &#40;INTERVAL &#39;$1&#39; DAY&#41;;
&gt; PREPARE
&gt; vkmlm=&gt; execute test4&#40;&#39;1&#39;&#41;;
&gt;  interval
&gt; ----------
&gt; 1 day
&gt; &#40;1 row&#41;
&gt; 
&gt; So in this particular case I think that the suggestion that Postgres
&gt; has fixed a bug is the most likely explanation why this query, which
&gt; has literally worked for years in production, suddenly stopped
&gt; working.
&gt; 
&gt; If so then we can close this ticket out as invalid. I&#39;d love to hear
&gt; some other opinions here though.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;07&nbsp;14:50:48&nbsp;2016</span>
    <span class="description">KAMELKEV [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
