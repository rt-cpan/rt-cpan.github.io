<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #102809 for Net-DNS: CAA broken</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #102809 for Net-DNS: CAA broken</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Net-DNS">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Net-DNS">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Net-DNS">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Net-DNS">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-DNS">Net-DNS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">102809</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Net-DNS">Net-DNS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
tlhackque [...] yahoo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-22454-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22455-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=102809">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1474165" href="/Public/Bug/Display.html?id=102809#txn-1474165">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;16&nbsp;16:34:05&nbsp;2015</span>
    <span class="description">tlhackque [...] yahoo.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CAA broken</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1474165/785078/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/785078">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">1&#41; CAA records don&#39;t decode properly.  An extra byte of garbage appears with the value.

In Net::DNS::RR::CAA:
  sub decode_rdata {                    ## decode rdata from wire-format octet string
        my $self = shift;
        my &#40; $data, $offset &#41; = @_;

        my $taglen = unpack &#34;\@$offset x C&#34;, $$data;
        my $vallen = $self-&gt;{rdlength} - $taglen - 1;

 The -1 should be -2.  

Value length is rdata_length - length&#40;tag&#41; - 1_for_flags - 1_for_tag_length_byte.

2&#41; Entering values seems to be impossible for at least one required value.  Or at least it&#39;s so confusing that I haven&#39;t figured out how.

Consider this record

   example.net.  CAA 128 issue ;

This means &#34;Don&#39;t issue any cert for this domain&#34;

rdstring&#40;&#41; doesn&#39;t display the quotes shown in the RFC.

If entered this way, the ; is treated as a comment character, and the result is a zero-length value.  That&#39;s reasonable, except that 

If entered per the RFC &#40;6844 ss 5.2&#41;
 example.net CAA 128 issue &#34;;&#34;
we get the quotes in the value

If entered as \;, we get \059

Examples &#40;with the value decode bug fixed&#41;:

 perl -MNet::DNS::RR -de1
printf&#40;&#34;%02x &#34;,ord $_&#41; for split&#40; //, Net::DNS::RR-&gt;new&#40; q&#40;example.net. CAA 128 issue ;&#41; &#41;-&gt;encode &#41;
07 65 78 61 6d 70 6c 65 03 6e 65 74 00 01 01 00 01 00 00 00 00 00 07 80 05 69 73 73 75 65
                                                                     fl tl  s  s  s  u  e

printf&#40;&#34;%02x &#34;,ord $_&#41; for split&#40; //, Net::DNS::RR-&gt;new&#40; q&#40;example.net. CAA 128 issue &#34;;&#34;&#41; &#41;-&gt;encode &#41;
07 65 78 61 6d 70 6c 65 03 6e 65 74 00 01 01 00 01 00 00 00 00 00 0a 80 05 69 73 73 75 65 22 3b 22
                                                                     Fl tl  i  s  s  u  e  &#34;  ;  &#34;
printf&#40;&#34;%02x &#34;,ord $_&#41; for split&#40; //, Net::DNS::RR-&gt;new&#40; q&#40;example.net. CAA 128 issue \\;&#41; &#41;-&gt;encode &#41;
07 65 78 61 6d 70 6c 65 03 6e 65 74 00 01 01 00 01 00 00 00 00 00 0b 80 05 69 73 73 75 65 5c 30 35 39
                                                                     fl tl  i  s  s  u  e  \  0  5  9

In my decode, &#34;fl&#34; is the flags byte &#40;128.&#41;, &#34;tl&#34; is the tag length &#40;5&#41;, and the rest are printable ascii.

plain&#40;&#41; is misleading too.  This is the same as the second example.  nsupdate will not include the quotes
in the value &#40;which is correct&#41;.  But the dump I showed demonstrates that they are encoded onto the wire if fed back into new&#40;&#41;;

x Net::DNS::RR-&gt;new&#40; q&#40;example.net. CAA 128 issue &#34;;&#34;&#41; &#41;-&gt;plain
0  &#39;example.net. 0 IN CAA 128 issue &#34;;&#34;&#39;

Note that you need recent named &#40;I think 9.10&#41; for dig to have CAA support.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1474831" href="/Public/Bug/Display.html?id=102809#txn-1474831">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;17&nbsp;21:19:15&nbsp;2015</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1474831/785446/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/785446">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 538b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Mar 16 16:34:05 2015, tlhackque wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 1&#41; CAA records don&#39;t decode properly.  An extra byte of garbage
&gt; appears with the value.
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2&#41; Entering values seems to be impossible for at least one required
&gt; value.  Or at least it&#39;s so confusing that I haven&#39;t figured out how.
</div>
Probably best to start again using Net::DNS::Text elements to provide proper quote and escape handling.

 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Note that you need recent named &#40;I think 9.10&#41; for dig to have CAA
&gt; support.
</div>Unfortunately CAA support not available when this code was written.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1474832" href="/Public/Bug/Display.html?id=102809#txn-1474832">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;17&nbsp;21:19:16&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1475085" href="/Public/Bug/Display.html?id=102809#txn-1475085">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;18&nbsp;15:03:50&nbsp;2015</span>
    <span class="description">tlhackque [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> tlhackque [...] yahoo.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1475085/785621/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/785621">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 250b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Mar 17 21:19:15 2015, rwfranks@acm.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Unfortunately CAA support not available when this code was written.
</div>

Understood.  It was a fair effort; just didn&#39;t work out.  Axiomatically: &#34;If you can&#39;t test it, it probably doesn&#39;t work...&#34;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1475617" href="/Public/Bug/Display.html?id=102809#txn-1475617">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;20&nbsp;07:50:10&nbsp;2015</span>
    <span class="description">tlhackque [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CAA RFC errata</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> tlhackque [...] yahoo.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1475617/785908/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/785908">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 617b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">A note for the new implementation: there are some errata to the CAA RFC.

See:
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.rfc-editor.org/errata_search.php?rfc=6844">http://www.rfc-editor.org/errata_search.php?rfc=6844</a></span>

In particular, one clarifies that unlike other text values, CAA &#34;value&#34; has no length byte and is not limited to 255 characters, or segmented like TXT record values...

I think this means that using TEXT elements would require some care.  

A quick look at Net::DNS::Text.pm indicates that some of the code there expects a length byte and new wants to carve the input string into 255 byte chunks.

Not insurmountable &#38; you probably already have noticed, but thought I&#39;d mention it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1479284" href="/Public/Bug/Display.html?id=102809#txn-1479284">#</a>      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;28&nbsp;08:49:35&nbsp;2015</span>
    <span class="description">tlhackque [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CAA in trunk still has issues.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> tlhackque [...] yahoo.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1479284/788029/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/788029">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I peeked at trunk and noticed a check-in for CAA.  Thanks for working on it.  

I hope it&#39;s not improper to comment on what might be a work in progress,
but assuming that feedback sooner is better than later:

By inspection, the new code does not handle all CAA &#34;value&#34; fields correctly.
Specifically, any &#34;value&#34; field longer than 255 bytes will be mishandled.

Here&#39;s what I saw in the new Net::DNS::RR::CAA::decode:
        my $tmp = pack &#39;Ca*&#39;, $limit - $offset, substr $$data, $offset, $limit - $offset;
        $self-&gt;{value} = decode Net::DNS::Text&#40; \$tmp &#41;;

This attempts to use Net::DNS::Text to parse the value string by packing the string
length into a temporary.  The intent is that Net::DNS::Text::decode will see a
counted text string; that is a byte length + the string.

Unfortunately &#40;as I noted in a previous reply&#41;, the length of the value can be
greater than 255 characters.  And unlike TXT and SPF records, longer value
strings are not divided into multiple segments, each with its own length byte.

This is implicit in the RFC, and made explicit in the erratum that I referenced.

The maximum length of &#34;value&#34; is rdlength - &#40;1_flag_byte+1_tag_length_byte+length&#40;tag&#41;&#41;.  
rdlength is a 16-bit unsigned int. &#40;RFC 1035, 3.2.1., bottom of page 10&#41;

So packing $limit - $offset into &#34;C&#34; &#40;an 8-bit unsigned int/char&#41; can overflow.

In the worst case, rdlength can be 65535, tag length 1.  So we have 65532 bytes
for the value.  This is &gt;&gt; 255.  The code will only return the first 252 bytes
due to the overflow/truncation by pack.

In encode, there is a cousin issue for values longer than 255 bytes.  

When creating the record from text, Net::DNS::Text::new will break input values
into chunks of 255 bytes &#40;or less for the last&#41;.  

When encode calls Net::DNS::Text::encode, the returned string will have a length byte
for each segment.  &#40;Correct for SPF/TXT.&#41;

Although CAA::encode will discard the first length byte, the second
and subsequent length bytes will erroneously be included in the wire data.

Consider:
   my $rec = Net::DNS::RR::new-&gt;&#40;&#39;example.net. 60 CAA 128 issue &#34;&#39; . &#40;&#39;x&#39; x 256&#41; . &#39;&#34;&#39;&#41;;

The flow for this is CAA::parse_rdata -&gt; CAA::value&#40;&#39;x&#39; x 256&#41; -&gt; 
new Net::DNS::Text:
    while &#40; length $_ &gt; 255 &#41;  # Segment into chunks
      $chunk = substr&#40; $_, 0, 255 &#41;;
      push @$self, $chunk;

-&gt;CAA::encode_rdata -&gt; substr&#40; Net::DNS::Text::encode, 1 &#41; # Encode string and discard first length byte
    Net::DNS::Text::encode:
      join &#39;&#39;, map pack&#40; &#39;C a*&#39;, length $_, $_ &#41;, @$self  #&lt;&lt; one length byte for each chunk.

Thus the wire would have:
  [bytes 0-254] &#40;1&#41; [byte 255]
                 ^-- this length byte does not belong on the wire

Obviously, for 511 byte strings, there would be 2 extra length bytes, and so on.

This is what I meant when I wrote
 -- I think this means that using TEXT elements would require some care.

I hope that this review is useful.

Thanks again for your efforts.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1479558" href="/Public/Bug/Display.html?id=102809#txn-1479558">#</a>      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;29&nbsp;09:59:02&nbsp;2015</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1479558/788163/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/788163">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 792b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Mar 28 08:49:35 2015, tlhackque wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I peeked at trunk and noticed a check-in for CAA.  Thanks for working
&gt; on it.
&gt; 
&gt; I hope it&#39;s not improper to comment on what might be a work in
&gt; progress,
&gt; but assuming that feedback sooner is better than later:
&gt; 
&gt; By inspection, the new code does not handle all CAA &#34;value&#34; fields
&gt; correctly.
&gt; Specifically, any &#34;value&#34; field longer than 255 bytes will be
&gt; mishandled.
&gt; 
</div>The version on trunk is intended to fix the string parsing problem you identified while still having it work for the majority of cases for which the 255 byte restriction is not an issue.

Dealing with the general case is not a priority right now and will be fixed when time permits, or a real-world user cites a live and verifiable example with &gt; 255 bytes.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1479598" href="/Public/Bug/Display.html?id=102809#txn-1479598">#</a>      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;29&nbsp;10:50:29&nbsp;2015</span>
    <span class="description">tlhackque [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> tlhackque [...] yahoo.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1479598/788181/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/788181">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Mar 29 09:59:02 2015, rwfranks@acm.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dealing with the general case is not a priority right now and will be
&gt; fixed when time permits, or a real-world user cites a live and
&gt; verifiable example with &gt; 255 bytes.
</div>
OK. Although I *am* a &#34;real-word user&#34;, I agree that it seems unlikely that 256+ byte values will be required by CAs soon.  The CAs I&#39;ve talked with don&#39;t yet have definite plans for CAA, nor sophisticated use models that would drive longer strings.  A few users are using CAA to put CAs that they don&#39;t use on public notice that they aren&#39;t authorized to issue certificates for those users.

However, I think it would be a good idea to die&#40;&#41; if you decode or are asked to create such a record.  Sooner or later one will appear, no doubt first from someone testing their software.  &#40;As I am. But I&#39;m aware of the issue.&#41;

A &#34;CAA values longer than 255 not yet supported&#34; exception is better than producing incorrect data, especially when you know of the restriction vs. the RFC.  It could save someone quite a bit of debugging, and a frustrating &#34;known restriction&#34; response.

Thanks for your consideration and for the work you&#39;ve done so far.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1480098" href="/Public/Bug/Display.html?id=102809#txn-1480098">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;30&nbsp;20:30:19&nbsp;2015</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1480098/788452/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/788452">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 565b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Mar 29 10:50:29 2015, tlhackque wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun Mar 29 09:59:02 2015, rwfranks@acm.org wrote:
<div class="message-stanza open">&gt; &gt; Dealing with the general case is not a priority right now and will be
&gt; &gt; fixed when time permits, or a real-world user cites a live and
&gt; &gt; verifiable example with &gt; 255 bytes.
</div>&gt; 
&gt; OK. Although I *am* a &#34;real-word user&#34;,
</div>
without a CAA with &gt; 255 bytes, your reported problem solved.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ... I agree that it seems unlikely
&gt; that 256+ byte values will be required by CAs soon.
</div>
which is why I do not propose to make the required changes to Text.pm right now.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1512735" href="/Public/Bug/Display.html?id=102809#txn-1512735">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;29&nbsp;09:25:34&nbsp;2015</span>
    <span class="description">NLNETLABS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.51011</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
