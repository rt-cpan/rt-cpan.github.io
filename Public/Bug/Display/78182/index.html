<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #78182 for Perl-Tidy: Strange side effects on STDERR</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #78182 for Perl-Tidy: Strange side effects on STDERR</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Perl-Tidy">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Perl-Tidy">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Perl-Tidy">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Perl-Tidy">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Perl-Tidy">Perl-Tidy CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">78182</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Perl-Tidy">Perl-Tidy</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
thaljef [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
dev [...] perlcritic.tigris.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-25260-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
20120701    </td>
  </tr>
  <tr id="CF-25261-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




ex_mp.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1099097/577911/ex_mp.pl">
Sat Jul 14 10:24:09 2012 (1.3k) by perltidy [...] users.sourceforge.net
</a>
</font></li>
</ul>


Perl-Tidy-20120701_STDERR.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1095843/576125/Perl-Tidy-20120701_STDERR.patch">
Wed Jul 04 01:44:49 2012 (3.6k) by jeff [...] imaginative-software.com
</a>
</font></li>
</ul>


stderr.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1095790/576089/stderr.pl">
Tue Jul 03 20:38:46 2012 (1.4k) by perltidy [...] users.sourceforge.net
</a>
</font></li>
</ul>


test.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1095698/576038/test.pl">
Tue Jul 03 13:58:25 2012 (786b) by thaljef [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=78182">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1095698" href="/Public/Bug/Display.html?id=78182#txn-1095698">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;03&nbsp;13:58:25&nbsp;2012</span>
    <span class="description">thaljef [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> dev [...] perlcritic.tigris.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Strange side effects on STDERR</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1095698/576037/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/576037">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 712b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I noticed that the latest version of Perl::Tidy requires the stderr
parameter to be an actual filehandle, not just a scalar reference.  So
if I want to capture stderr into a scalar, I must use an IO::String
object or something similar.

The problem is that Perl::Tidy assigns that object directly to *STDERR.
 And when that object goes out of scope, it closes STDERR.  So
subsequent calls to warn&#40;&#41; fail because the output handle is now gone. 
The attached file demonstrates this.

I think the solution might be for Perl::Tidy to use a lexical &#40;or
localized&#41; filehandle rather than STDERR directly.

Thanks for your consideration.

-- 
Jeffrey Thalhammer
Imaginative Software Systems
www.imaginative-software.com
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1095698/576038/test.pl">Download test.pl</a><br />
<span class="downloadcontenttype">text/x-perl 786b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!perl

use strict;
use warnings;

use IO::String;
use Perl::Tidy 20120701;

my $tidy_src = &#39;&#39;;
my $raw_src  = q{ print &#40;&#39;Hello World&#39;&#41; ; };

{
  my $stderr_buffer = &#39;&#39;;
  my $stderr_fh     = IO::String-&gt;new&#40; \$stderr_buffer &#41;;

  local @ARGV = qw&#40;-nst -nse&#41;;
  Perl::Tidy::perltidy&#40; destination =&gt; \$tidy_src,
                        source      =&gt; \$raw_src,
                        stderr      =&gt; $stderr_fh &#41;;
}

# This next line throws a fatal exception because Perl::Tidy has tied
# STDERR to our $stderr_fh &#40;which is an IO::String object&#41;, and when
# that object is destroyed, it closes the handle &#40;thus closing
# STDERR&#41;.  So calling warn&#40;&#41; will fail because the output handle
# isn&#39;t there any more.  Strangely, calling CORE::warn still works.
warn &#34;Tidied code is $tidy_src&#34;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1095790" href="/Public/Bug/Display.html?id=78182#txn-1095790">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;03&nbsp;20:38:46&nbsp;2012</span>
    <span class="description">perltidy [...] users.sourceforge.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1095790/576088/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/576088">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Jeffrey,
Thanks for the example. Getting STDERR output to a string is tricky
because it&#39;s very easy to lose it under certain error conditions. I
played with the example and found that localizing *STDERR solves part of
the problem but I had to make some additional changes to the test case
avoid losing the error output.  I had to move the string buffer outside
of the block because for certain errors it will be lost before it can be
printed.  Also, I had to eval the block to avoid losing everything in
some cases. See the attached example.

In the example I localized *STDERR in the block, but I also got the same
result by localizing it inside of the Tidy.pm module. So I may localize
it in the next release if I don&#39;t discover any problems, but meanwhile
you could localize it in the calling routine as a workaround.

But note that what you actually may want to capture is the &#39;errorfile&#39;,
which is what would go to a .ERR file in case problems are detected in
the source code, and there is no problem sending that to a string
reference.  Also, sending STDERR to a real file seems to work reliably.
If you make any progress on this issue I would be interested.
Steve
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> stderr.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1095790/576089/stderr.pl">Download stderr.pl</a><br />
<span class="downloadcontenttype">text/x-perl 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!perl

use strict;
use warnings;

use IO::String;
use Perl::Tidy 20120701;

# Trying to capture perltidy STDERR output into a string
my $tidy_src = &#39;&#39;;
my $raw_src  = q{ print [&#39;Hello World&#39;&#41; ; };  # NOTE ERROR
my $stderr_buffer = &#39;&#39;;  # Note: must define outside of eval block
my $stderr_fh     = IO::String-&gt;new&#40; \$stderr_buffer &#41;;
my $errorfile;

eval {  # we lose standard error output without eval

    # This is a good parameter set:
    local @ARGV   = qw&#40;-nst -nse &#41;; 

    # But uncomment this to generate an error condition:
    # push @ARGV,&#34;-xyzzy&#34;;

    local *STDERR = *STDERR;  # this localization could go inside of Tidy.pm

    Perl::Tidy::perltidy&#40;
        destination =&gt; \$tidy_src,
        source      =&gt; \$raw_src,
        stderr      =&gt; $stderr_fh,
        errorfile   =&gt; \$errorfile,
    &#41;;

    # we will never get here for some error conditions
    print STDOUT &#34;May never get here if serious error\n&#34;;  
};

# send something to stderr
warn &#34;Tidied code is $tidy_src&#34;;
print &#34;\n&#34;;
print &#34;..............Begin Error Buffer...........\n&#34;;
print &#34;$stderr_buffer&#34;;
print &#34;..............End Error Buffer...........\n&#34;;
print &#34;\n&#34;;
if &#40;$errorfile&#41; {
    print &#34;..............Begin .ERR file ...........\n&#34;;
    print &#34;$errorfile&#34;;
    print &#34;..............End .ERR file...........\n&#34;;
}
else {
    print &#34;..............Empty .ERR file ...........\n&#34;;
}
print &#34;\n&#34;;
print &#34;..............Begin Tidied Code ...........\n&#34;;
print &#34;$tidy_src&#34;;
print &#34;..............End Tidied Code...........\n&#34;;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1095792" href="/Public/Bug/Display.html?id=78182#txn-1095792">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;03&nbsp;20:38:47&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1095843" href="/Public/Bug/Display.html?id=78182#txn-1095843">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;04&nbsp;01:44:49&nbsp;2012</span>
    <span class="description">jeff [...] imaginative-software.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #78182] Strange side effects on STDERR</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 3 Jul 2012 22:44:33 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Perl-Tidy [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jeffrey Thalhammer &lt;jeff [...] imaginative-software.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1095843/576124/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/576124">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On Jul 3, 2012, at 5:38 PM, Steve Hancock via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=78182">https://rt.cpan.org/Ticket/Display.html?id=78182</a></span> &gt;
&gt; 
&gt; Thanks for the example. Getting STDERR output to a string is tricky
&gt; because it&#39;s very easy to lose it under certain error conditions.
</div>
What conditions do you have in mind?  Are you concerned about trapping warnings from your code or from someone else&#39;s code?  The former should be pretty straightforward to trap.  For the latter, I&#39;ve had good luck with exploiting $SIG{__WARN__}.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I played with the example and found that localizing *STDERR solves part of
&gt; the problem but I had to make some additional changes to the test case
&gt; avoid losing the error output.  I had to move the string buffer outside
&gt; of the block because for certain errors it will be lost before it can be
&gt; printed.  Also, I had to eval the block to avoid losing everything in
&gt; some cases.
</div>
It&#39;s not lost -- the program just stops because Perl::Tidy throws an exception for those &#34;certain errors&#34; &#40;like bogus options in @ARGV&#41;.  But since STDERR has been globally reassigned to another handle, the error message never becomes visible.  Wrapping it in an eval{} traps the exception and gives you a chance to examine the messages on that handle afterwards.  

But that shouldn&#39;t be mandatory. Without the eval{}, exceptions should come out on whatever *my* STDERR is, not Perl::Tidy&#39;s notion of STDERR.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In the example I localized *STDERR in the block, but I also got the same
&gt; result by localizing it inside of the Tidy.pm module. So I may localize
&gt; it in the next release if I don&#39;t discover any problems, but meanwhile
&gt; you could localize it in the calling routine as a workaround.
</div>
I would probably use a scalar that points to either \*STDERR or the handle specified by the &#39;stderr&#39; option &#40;if given&#41;.  Then print all the warnings to that scalar, instead of STDERR.  See the attached patch for an example.  That eliminates the need for an eval{} and fixes the problem with inadvertently closing the real STDERR.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But note that what you actually may want to capture is the &#39;errorfile&#39;,
&gt; which is what would go to a .ERR file in case problems are detected in
&gt; the source code, and there is no problem sending that to a string
&gt; reference.  
</div>
I didn&#39;t know about the errorfile -- thanks for pointing that out!  So what I really want now is to just trap stderr *and* all the log messages into one scalar.  I can do that by giving &#39;stderr&#39; and &#39;errorfile&#39; the same IO::String.  So that problem is solved :&#41;

In my use case, the distinction between stderr and the errorfile is a bit artificial.  Perl::Critic feeds one file at a time to Perl::Tidy.  So from that perspective, there only needs to be two output channels: 1&#41; the tidied code;  2&#41; everything else &#40;errors, warnings, diagnostics, etc.&#41;  But I realize that there are other use cases too.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Also, sending STDERR to a real file seems to work reliably.
</div>
That would be my last resort.  But it is good to know I can fall back to that if necessary.

Thanks for making such a useful tool!

-Jeff
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1095843/576125/Perl-Tidy-20120701_STDERR.patch">Download Perl-Tidy-20120701_STDERR.patch</a><br />
<span class="downloadcontenttype">text/x-diff 3.6k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1096413" href="/Public/Bug/Display.html?id=78182#txn-1096413">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;05&nbsp;18:12:15&nbsp;2012</span>
    <span class="description">perltidy [...] users.sourceforge.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1096413/576441/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/576441">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 744b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Jeff,
Thanks for your suggestions. Either localizing STDERR or your patch will 
solve the immediate problem of losing the standard error output, but the 
key issue that I see is: can an eval be avoided if standard error output 
goes to a string. 

Right now the best solution that I see is to modify Perl::Tidy to 
eliminate the &#39;stderr&#39; call parameter and at the same time make all non-
catastrophic errors &#40;1&#41; write messages to the &#39;errorfile&#39;, if it is 
available, and STDERR if not &#40;2&#41; set an error return flag, and &#40;3&#41; do a 
normal return.  With this change, the only output to STDERR should be 
programming errors that require immediate attention, which might occur 
during program development. I am going to look into this further.
Steve
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1098058" href="/Public/Bug/Display.html?id=78182#txn-1098058">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;11&nbsp;13:24:14&nbsp;2012</span>
    <span class="description">jeff [...] imaginative-software.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &#34;thaljef [...] cpan.org&#34; &lt;thaljef [...] cpan.org&gt;, &#34;dev [...] perlcritic.tigris.org&#34; &lt;dev [...] perlcritic.tigris.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #78182] Strange side effects on STDERR</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 11 Jul 2012 10:23:46 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Perl-Tidy [...] rt.cpan.org&#34; &lt;bug-Perl-Tidy [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jeffrey Thalhammer &lt;jeff [...] imaginative-software.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1098058/577322/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/577322">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 387b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just a little more clarity on the root cause...

STDERR becomes undefined after running perltidy&#40;&#41; because it is being  
assigned to a lexical variable. So when it goes out of scope, so does  
STDERR.  It has nothing to do with the use of IO::String.

I think the right thing todo is to just localize STDERR inside perltidy 
&#40;&#41;. That also eliminates the need to wrap it with an eval{}. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1099097" href="/Public/Bug/Display.html?id=78182#txn-1099097">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;14&nbsp;10:24:08&nbsp;2012</span>
    <span class="description">perltidy [...] users.sourceforge.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1099097/577910/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/577910">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 476b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is fixed in version 20120714. The attached example illustrates 
usage.  From the Changelog:


 - Fixed RT #78182, side effects with STDERR.  Error handling has been
   revised and the documentation has been updated.  STDERR can now be
   redirected to a string reference, and perltidy now returns an
   error flag instead of calling die when input errors are detected.
   If the error flag is set then no tidied output was produced.
   See man Perl::Tidy for an example.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ex_mp.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1099097/577911/ex_mp.pl">Download ex_mp.pl</a><br />
<span class="downloadcontenttype">text/x-perl 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w

# example call to perltidy from man page documentation of Perl::Tidy

use strict;
use Perl::Tidy;

my $source_string = &lt;&lt;&#39;EOT&#39;;
my$error=Perl::Tidy::perltidy&#40;argv=&gt;$argv,source=&gt;\$source_string,
    destination=&gt;\$dest_string,stderr=&gt;\$stderr_string,
errorfile=&gt;\$errorfile_string,&#41;;
EOT

my $dest_string;
my $stderr_string;
my $errorfile_string;
my $argv = &#34;-npro&#34;;   # Ignore any .perltidyrc at this site
$argv .= &#34; -pbp&#34;;     # Format according to perl best practices
$argv .= &#34; -nst&#34;;     # Must turn off -st in case -pbp is specified
$argv .= &#34; -se&#34;;      # -se appends the errorfile to stderr
## $argv .= &#34; --spell-check&#34;;  # uncomment to trigger an error

print &#34;&lt;&lt;RAW SOURCE&gt;&gt;\n$source_string\n&#34;;

my $error = Perl::Tidy::perltidy&#40;
    argv        =&gt; $argv,
    source      =&gt; \$source_string,
    destination =&gt; \$dest_string,
    stderr      =&gt; \$stderr_string,
    errorfile   =&gt; \$errorfile_string,    # not used when -se flag is set
    ##phasers     =&gt; &#39;stun&#39;,                # uncomment to trigger an error
&#41;;

if &#40;$error&#41; {

    # serious error in input parameters, no tidied output
    print &#34;&lt;&lt;STDERR&gt;&gt;\n$stderr_string\n&#34;;
    die &#34;Exiting because of serious errors\n&#34;;
}

if &#40;$dest_string&#41;      { print &#34;&lt;&lt;TIDIED SOURCE&gt;&gt;\n$dest_string\n&#34; }
if &#40;$stderr_string&#41;    { print &#34;&lt;&lt;STDERR&gt;&gt;\n$stderr_string\n&#34; }
if &#40;$errorfile_string&#41; { print &#34;&lt;&lt;.ERR file&gt;&gt;\n$errorfile_string\n&#34; }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1099099" href="/Public/Bug/Display.html?id=78182#txn-1099099">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;14&nbsp;10:24:09&nbsp;2012</span>
    <span class="description">perltidy [...] users.sourceforge.net -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.548804</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
