<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #73402 for namespace-clean: Problems with tying %^H</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #73402 for namespace-clean: Problems with tying %^H</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/namespace-clean/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/namespace-clean/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/namespace-clean/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/namespace-clean/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/namespace-clean">namespace-clean CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">73402</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/namespace-clean/Active/">namespace-clean</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
&#39;spro^^*%*^6ut# [...] &#38;$%*c

<br />
ANDK [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-42514-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-42515-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.22    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;15&nbsp;02:14:13&nbsp;2011</span>
    <span class="description">ANDK [...] cpan.org - Ticket #73274:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Bleadperl v5.15.5-306-gb50b205 breaks RIBASUSHI/namespace-clean-0.21.tar.gz</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just a cross reference

<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org:443/rt3/Ticket/Display.html?id=106282">https://rt.perl.org:443/rt3/Ticket/Display.html?id=106282</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Create even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;20&nbsp;20:59:15&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Problems with tying %^H</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">namespace::clean tickles a bug in perl 5.10-5.15.6, which crashes when cloning a tied hint 
hash:

    use Devel::Hide &#39;B::Hooks::EndOfScope&#39;;
    use sort &#34;stable&#34;;
    use namespace::clean;
    use sort &#34;stable&#34;;
    {;}

I haven’t written tests to prove it, but I believe there are other problems with it, too:  It does 
not save the existing values in %^H before tying, so whatever keys are there will appear to 
vanish from the point of view of other BEGIN blocks in the same scope.  Tying hint hashes 
can’t really work, because tied hashes do not really have elements.  When you fetch a hash 
element, you get a magical scalar that calls methods on the tie object, but that scalar is not 
really a hash element.  Hint hashes work by attaching magic to their elements, so the 
underlying he chain is modified when the hash is modified.  Tie magic intercepts the usual 
element lookup, so you never get to the magic hint hash element.  Hence, anything assigned 
to the tied hash will fail to ‘stick’ and will not show in caller&#40;&#41; output at run time.

I don’t think it’s even possible to make tied hint hashes work in any useful way.

I suspect that you are using a tied hash instead of an object in one of the keys in order to 
avoid having string eval hang on to that object.

In 5.14, you can solve that by tying a single element of the hint hash &#40;instead of the whole 
hash&#41;.  Try running the script below.  Notice that even with the eval &#34;&#34; destruction happens 
before the ‘exited’ warning.  Unfortunately, it doesn’t work in 5.12 and earlier, due to a tie 
bug.  I haven’t been able to come up with a way to make it work.

package bomb;
sub TIESCALAR { $_[1]||bless [] }
sub DESTROY { warn &#34;destroying $_[0]&#34; }
sub FETCH { $_[0][0] }
sub STORE { $_[0][0] = $_[1] }

package main;

{
   BEGIN {
      $^H{foo}=bar; # activate localisation magic
      tie $^H{foo}, &#39;bomb&#39;;
   }

   BEGIN { warn &#39;about to exit scope&#39; }

   eval &#34;&#34;
}
BEGIN { warn &#39;exited&#39;; }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;20&nbsp;21:07:45&nbsp;2011</span>
    <span class="description">doy [...] tozt.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73402] Problems with tying %^H</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 20 Dec 2011 20:07:37 -0600</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Father Chrysostomos via RT &lt;bug-namespace-clean [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jesse Luehrs &lt;doy [...] tozt.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Dec 20, 2011 at 08:59:16PM -0500, Father Chrysostomos via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; namespace::clean tickles a bug in perl 5.10-5.15.6, which crashes when cloning a tied hint 
&gt; hash:
&gt; 
&gt;     use Devel::Hide &#39;B::Hooks::EndOfScope&#39;;
&gt;     use sort &#34;stable&#34;;
&gt;     use namespace::clean;
&gt;     use sort &#34;stable&#34;;
&gt;     {;}
&gt; 
&gt; I haven’t written tests to prove it, but I believe there are other problems with it, too:  It does 
&gt; not save the existing values in %^H before tying, so whatever keys are there will appear to 
&gt; vanish from the point of view of other BEGIN blocks in the same scope.
</div>
  $ perl -E&#39;BEGIN { $^H{foo} = 1 } use namespace::clean; BEGIN { warn $^H{foo} }&#39;
  Warning: something&#39;s wrong at -e line 1.
  $ perl -E&#39;BEGIN { $^H{foo} = 1 } BEGIN { warn $^H{foo} }&#39;
  1 at -e line 1.

and with B::Hooks::EndOfScope installed:

  $ perl -E&#39;BEGIN { $^H{foo} = 1 } use namespace::clean; BEGIN { warn $^H{foo} }&#39;
  1 at -e line 1.

So yeah, this is broken.

-doy
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;20&nbsp;21:07:47&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;20&nbsp;21:17:02&nbsp;2011</span>
    <span class="description">doy [...] tozt.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73402] Problems with tying %^H</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 20 Dec 2011 20:16:54 -0600</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jesse Luehrs via RT &lt;bug-namespace-clean [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jesse Luehrs &lt;doy [...] tozt.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Dec 20, 2011 at 09:07:46PM -0500, Jesse Luehrs via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: namespace-clean
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73402">https://rt.cpan.org/Ticket/Display.html?id=73402</a></span> &gt;
&gt; 
&gt; On Tue, Dec 20, 2011 at 08:59:16PM -0500, Father Chrysostomos via RT wrote:
<div class="message-stanza open">&gt; &gt; namespace::clean tickles a bug in perl 5.10-5.15.6, which crashes when cloning a tied hint 
&gt; &gt; hash:
&gt; &gt; 
&gt; &gt;     use Devel::Hide &#39;B::Hooks::EndOfScope&#39;;
&gt; &gt;     use sort &#34;stable&#34;;
&gt; &gt;     use namespace::clean;
&gt; &gt;     use sort &#34;stable&#34;;
&gt; &gt;     {;}
&gt; &gt; 
&gt; &gt; I haven’t written tests to prove it, but I believe there are other problems with it, too:  It does 
&gt; &gt; not save the existing values in %^H before tying, so whatever keys are there will appear to 
&gt; &gt; vanish from the point of view of other BEGIN blocks in the same scope.
</div>&gt; 
&gt;   $ perl -E&#39;BEGIN { $^H{foo} = 1 } use namespace::clean; BEGIN { warn $^H{foo} }&#39;
&gt;   Warning: something&#39;s wrong at -e line 1.
&gt;   $ perl -E&#39;BEGIN { $^H{foo} = 1 } BEGIN { warn $^H{foo} }&#39;
&gt;   1 at -e line 1.
&gt; 
&gt; and with B::Hooks::EndOfScope installed:
&gt; 
&gt;   $ perl -E&#39;BEGIN { $^H{foo} = 1 } use namespace::clean; BEGIN { warn $^H{foo} }&#39;
&gt;   1 at -e line 1.
&gt; 
&gt; So yeah, this is broken.
</div>
And, since 5.15.6 modifies &#34;use strict&#34; to use the hint hash, this will
break &#34;use strict; use namespace::clean;&#34;, which is a fairly serious issue.

-doy
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;02:16:24&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 20 21:17:02 2011, doy@tozt.net wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue, Dec 20, 2011 at 09:07:46PM -0500, Jesse Luehrs via RT wrote:
<div class="message-stanza open">&gt; &gt;        Queue: namespace-clean
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73402">https://rt.cpan.org/Ticket/Display.html?id=73402</a></span> &gt;
&gt; &gt;
&gt; &gt; On Tue, Dec 20, 2011 at 08:59:16PM -0500, Father Chrysostomos via RT
</div>&gt; wrote:
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; namespace::clean tickles a bug in perl 5.10-5.15.6, which crashes
</div></div>&gt; when cloning a tied hint
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; hash:
&gt; &gt; &gt;
&gt; &gt; &gt;     use Devel::Hide &#39;B::Hooks::EndOfScope&#39;;
&gt; &gt; &gt;     use sort &#34;stable&#34;;
&gt; &gt; &gt;     use namespace::clean;
&gt; &gt; &gt;     use sort &#34;stable&#34;;
&gt; &gt; &gt;     {;}
&gt; &gt; &gt;
&gt; &gt; &gt; I haven’t written tests to prove it, but I believe there are other
</div></div>&gt; problems with it, too:  It does
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; not save the existing values in %^H before tying, so whatever keys
</div></div>&gt; are there will appear to
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; vanish from the point of view of other BEGIN blocks in the same
</div></div>&gt; scope.
<div class="message-stanza open">&gt; &gt;
&gt; &gt;   $ perl -E&#39;BEGIN { $^H{foo} = 1 } use namespace::clean; BEGIN {
</div>&gt; warn $^H{foo} }&#39;
<div class="message-stanza open">&gt; &gt;   Warning: something&#39;s wrong at -e line 1.
&gt; &gt;   $ perl -E&#39;BEGIN { $^H{foo} = 1 } BEGIN { warn $^H{foo} }&#39;
&gt; &gt;   1 at -e line 1.
&gt; &gt;
&gt; &gt; and with B::Hooks::EndOfScope installed:
&gt; &gt;
&gt; &gt;   $ perl -E&#39;BEGIN { $^H{foo} = 1 } use namespace::clean; BEGIN {
</div>&gt; warn $^H{foo} }&#39;
<div class="message-stanza open">&gt; &gt;   1 at -e line 1.
&gt; &gt;
&gt; &gt; So yeah, this is broken.
</div>&gt; 
&gt; And, since 5.15.6 modifies &#34;use strict&#34; to use the hint hash, this
&gt; will
&gt; break &#34;use strict; use namespace::clean;&#34;, which is a fairly serious
&gt; issue.
</div>
That won’t be broken.  $^H is still the canonical place used in the core for strictures.  If the 
strict hints are missing from %^H, it means that strict was enabled implicitly by ‘use 5.012’, 
so it can be disabled implicitly by a lower version declaration.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;02:20:51&nbsp;2011</span>
    <span class="description">doy [...] tozt.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73402] Problems with tying %^H</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 21 Dec 2011 01:20:40 -0600</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Father Chrysostomos via RT &lt;bug-namespace-clean [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jesse Luehrs &lt;doy [...] tozt.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Dec 21, 2011 at 02:16:25AM -0500, Father Chrysostomos via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Dec 20 21:17:02 2011, doy@tozt.net wrote:
<div class="message-stanza open">&gt; &gt; And, since 5.15.6 modifies &#34;use strict&#34; to use the hint hash, this
&gt; &gt; will
&gt; &gt; break &#34;use strict; use namespace::clean;&#34;, which is a fairly serious
&gt; &gt; issue.
</div>&gt; 
&gt; That won’t be broken.  $^H is still the canonical place used in the core for strictures.  If the 
&gt; strict hints are missing from %^H, it means that strict was enabled implicitly by ‘use 5.012’, 
&gt; so it can be disabled implicitly by a lower version declaration.
</div>
Ah, okay. But still, this means that

  use strict;
  use namespace::clean;
  {
      use 5.010;
      ...;
  }

breaks, which is still something of a big deal.

-doy
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;02:26:43&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 20 20:59:15 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In 5.14, you can solve that by tying a single element of the hint hash
&gt; &#40;instead of the whole
&gt; hash&#41;.  Try running the script below.  Notice that even with the eval
&gt; &#34;&#34; destruction happens
&gt; before the ‘exited’ warning.  Unfortunately, it doesn’t work in 5.12
&gt; and earlier, due to a tie
&gt; bug.  I haven’t been able to come up with a way to make it work.
&gt; 
&gt; package bomb;
&gt; sub TIESCALAR { $_[1]||bless [] }
&gt; sub DESTROY { warn &#34;destroying $_[0]&#34; }
&gt; sub FETCH { $_[0][0] }
&gt; sub STORE { $_[0][0] = $_[1] }
&gt; 
&gt; package main;
&gt; 
&gt; {
&gt;    BEGIN {
&gt;       $^H{foo}=bar; # activate localisation magic
&gt;       tie $^H{foo}, &#39;bomb&#39;;
&gt;    }
&gt; 
&gt;    BEGIN { warn &#39;about to exit scope&#39; }
&gt; 
&gt;    eval &#34;&#34;
&gt; }
&gt; BEGIN { warn &#39;exited&#39;; }
</div>
And I tried another method, hoping it would work back to 5.10, but it doesn’t even work on 
bleadperl, and I don’t know why:

use Hash::Util::FieldHash;

my %hh;
BEGIN { &#38;Hash::Util::FieldHash::fieldhash&#40;\%hh&#41;; }

package bomb;
sub DESTROY { warn &#34;destroying $_[0]&#34; }

package main;

{
   BEGIN {
      $^H{foo}=&#39;bar&#39;; # activate localisation magic
      $hh{\%^H} = bless [], &#39;bomb&#39;;
   }

   BEGIN { warn &#39;about to exit scope&#39; }

   eval &#34;&#34;
}
BEGIN { warn &#39;exited&#39;; }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;05:07:06&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io - Ticket #73274:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Merging with the ticket discussing underlying issue.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;05:07:08&nbsp;2011</span>
    <span class="description">The RT System itself - Ticket #73274:  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;05:07:09&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io - Ticket #73274:  Merged into ticket #73402</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;05:07:09&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Merged into ticket #73402</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;05:16:28&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> doy [...] tozt.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 20 20:59:15 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; namespace::clean tickles a bug in perl 5.10-5.15.6, which crashes when
&gt; cloning a tied hint
&gt; hash:
&gt; 
&gt;     use Devel::Hide &#39;B::Hooks::EndOfScope&#39;;
&gt;     use sort &#34;stable&#34;;
&gt;     use namespace::clean;
&gt;     use sort &#34;stable&#34;;
&gt;     {;}
&gt; 
&gt; I haven’t written tests to prove it, but I believe there are other
&gt; problems with it, too:  It does
&gt; not save the existing values in %^H before tying, so whatever keys are
&gt; there will appear to
&gt; vanish from the point of view of other BEGIN blocks in the same scope.
</div>
This looks like the actual problem - I simply forgot to do the proper
cloning myself. Doing so passes on all 5.10+ perls. The cloner of
5.8.any still dies a fiery death, I am trying to figure out a trick for
this.

In any case - I think the result is rather satisfactory on 5.10+, and
far from &#34;is broken/can&#39;t be made to work&#34;. What do you guys think? :&#41;

diff --git a/lib/namespace/clean.pm b/lib/namespace/clean.pm
index 84d203e..65f9567 100644
--- a/lib/namespace/clean.pm
+++ b/lib/namespace/clean.pm
@@ -19,7 +19,7 @@ BEGIN {
   # when changing also change in Makefile.PL
   my $b_h_eos_req = &#39;0.07&#39;;
 
-  if &#40;eval {
+  if &#40;! $ENV{NAMESPACE_CLEAN_USE_PP} and eval {
     require B::Hooks::EndOfScope;
     B::Hooks::EndOfScope-&gt;VERSION&#40;$b_h_eos_req&#41;;
     1
@@ -80,7 +80,9 @@ EOE
       push @$stack, namespace::clean::_ScopeGuard-&gt;arm&#40;shift&#41;;
     }
     else {
+      my %old_contents = %^H;
       tie&#40; %^H, &#39;namespace::clean::_TieHintHash&#39;,
namespace::clean::_ScopeGuard-&gt;arm&#40;shift&#41; &#41;;
+      %^H = %old_contents if %old_contents;
     }
   }
 
diff --git a/t/09-fiddle-hinthash.t b/t/09-fiddle-hinthash.t
new file mode 100644
index 0000000..c37112b
--- /dev/null
+++ b/t/09-fiddle-hinthash.t
@@ -0,0 +1,36 @@
+use strict;
+use warnings;
+
+use Test::More 0.88;
+
+{
+  package Bar;
+  use sort &#39;stable&#39;;
+  use namespace::clean;
+  use sort &#39;stable&#39;;
+  {
+    1;
+  }
+
+  Test::More::pass&#40;&#39;no segfault&#39;&#41;;
+}
+
+{
+  package Foo;
+  BEGIN {
+    $^H{&#39;foo&#39;} = &#39;bar&#39;;
+  }
+
+  use namespace::clean;
+
+  BEGIN {
+    Test::More::is&#40; $^H{&#39;foo&#39;}, &#39;bar&#39;, &#39;hinthash intact&#39; &#41;;
+  }
+
+  {
+    1;
+  }
+}
+
+
+done_testing;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;06:41:23&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> doy [...] tozt.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">In fact I was trivially able to stop perl 5.8 from segfaulting too.
Shipped n::c 0.21_01 for smoke trials, if no objections will ship this
as 0.22 proper within couple of days.

Relevant changes and test:
<span class="clickylink"><a target="new" rel="nofollow" href="http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=p5sagit/namespace-clean.git;a=commitdiff;h=656ec55b51c454ca3d8a06a728a4f6c06d6db5d5">http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=p5sagit/namespace-clean.git;a=commitdiff;h=656ec55b51c454ca3d8a06a728a4f6c06d6db5d5</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;06:41:25&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;11:39:11&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 21 05:16:28 2011, RIBASUSHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Dec 20 20:59:15 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; namespace::clean tickles a bug in perl 5.10-5.15.6, which crashes when
&gt; &gt; cloning a tied hint
&gt; &gt; hash:
&gt; &gt; 
&gt; &gt;     use Devel::Hide &#39;B::Hooks::EndOfScope&#39;;
&gt; &gt;     use sort &#34;stable&#34;;
&gt; &gt;     use namespace::clean;
&gt; &gt;     use sort &#34;stable&#34;;
&gt; &gt;     {;}
&gt; &gt; 
&gt; &gt; I haven’t written tests to prove it, but I believe there are other
&gt; &gt; problems with it, too:  It does
&gt; &gt; not save the existing values in %^H before tying, so whatever keys are
&gt; &gt; there will appear to
&gt; &gt; vanish from the point of view of other BEGIN blocks in the same scope.
</div>&gt; 
&gt; This looks like the actual problem - I simply forgot to do the proper
&gt; cloning myself. Doing so passes on all 5.10+ perls. The cloner of
&gt; 5.8.any still dies a fiery death, I am trying to figure out a trick for
&gt; this.
&gt; 
&gt; In any case - I think the result is rather satisfactory on 5.10+, and
&gt; far from &#34;is broken/can&#39;t be made to work&#34;. What do you guys think? :&#41;
</div>
It’s a lot better, but there’s still a snag.  Due to another perl bug, still present in blead, the 
hints become invisible to inner scopes at compile time, but not run time.  BTW, I was wrong 
about ties preventing the hint magic from coming into play.  Devel::Peek shows that the 
magically generated elements have both tie *and* hint magic.


use Data::Dumper;
sub dump_runtime_hints {
    print Dumper +&#40;caller 0&#41;[10]; warn &#39; &#39;
}

BEGIN {
    $ENV{NAMESPACE_CLEAN_USE_PP} = 1;
    %^H = &#39;a&#39;..&#39;h&#39;;
}
use namespace::clean;
BEGIN {
    print Dumper \%^H;
    warn &#39; &#39;;
}
dump_runtime_hints;
{
    BEGIN {
        print Dumper \%^H;
        warn &#39; &#39;;
    }
    dump_runtime_hints;
}
__END__
$VAR1 = {
          &#39;e&#39; =&gt; &#39;f&#39;,
          &#39;c&#39; =&gt; &#39;d&#39;,
          &#39;a&#39; =&gt; &#39;b&#39;,
          &#39;g&#39; =&gt; &#39;h&#39;
        };
  at - line 14.
$VAR1 = {};
  at - line 20.
$VAR1 = {
          &#39;e&#39; =&gt; &#39;f&#39;,
          &#39;c&#39; =&gt; &#39;d&#39;,
          &#39;a&#39; =&gt; &#39;b&#39;,
          &#39;g&#39; =&gt; &#39;h&#39;
        };
  at - line 4.
$VAR1 = {
          &#39;e&#39; =&gt; &#39;f&#39;,
          &#39;c&#39; =&gt; &#39;d&#39;,
          &#39;a&#39; =&gt; &#39;b&#39;,
          &#39;g&#39; =&gt; &#39;h&#39;
        };
  at - line 4.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;11:39:12&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;12:08:16&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 21 11:39:11 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; It’s a lot better, but there’s still a snag.  Due to another perl bug,
&gt; still present in blead, the
&gt; hints become invisible to inner scopes at compile time, but not run
&gt; time.
</div>
I am confused... isn&#39;t this the *documented* behavior of %^H? Can you
perhaps make an addition to t/09-fiddle-hinthash.t that illustrates the
problem better?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; use Data::Dumper;
&gt; sub dump_runtime_hints {
&gt;     print Dumper +&#40;caller 0&#41;[10]; warn &#39; &#39;
&gt; }
&gt; 
&gt; BEGIN {
&gt;     $ENV{NAMESPACE_CLEAN_USE_PP} = 1;
&gt;     %^H = &#39;a&#39;..&#39;h&#39;;
&gt; }
&gt; use namespace::clean;
&gt; BEGIN {
&gt;     print Dumper \%^H;  ***1***
&gt;     warn &#39; &#39;;
&gt; }
&gt; dump_runtime_hints; ***3***
&gt; {
&gt;     BEGIN {
&gt;       print Dumper \%^H; ***2***
&gt;       warn &#39; &#39;;
&gt;     }
&gt;     dump_runtime_hints; ***4***
&gt; }
&gt; __END__
&gt; $VAR1 = {
&gt;           &#39;e&#39; =&gt; &#39;f&#39;,
&gt;           &#39;c&#39; =&gt; &#39;d&#39;,
&gt;           &#39;a&#39; =&gt; &#39;b&#39;,
&gt;           &#39;g&#39; =&gt; &#39;h&#39;
&gt;         };
&gt;   at - line 14.
&gt; $VAR1 = {};
&gt;   at - line 20.
&gt; $VAR1 = {
&gt;           &#39;e&#39; =&gt; &#39;f&#39;,
&gt;           &#39;c&#39; =&gt; &#39;d&#39;,
&gt;           &#39;a&#39; =&gt; &#39;b&#39;,
&gt;           &#39;g&#39; =&gt; &#39;h&#39;
&gt;         };
&gt;   at - line 4.
&gt; $VAR1 = {
&gt;           &#39;e&#39; =&gt; &#39;f&#39;,
&gt;           &#39;c&#39; =&gt; &#39;d&#39;,
&gt;           &#39;a&#39; =&gt; &#39;b&#39;,
&gt;           &#39;g&#39; =&gt; &#39;h&#39;
&gt;         };
&gt;   at - line 4.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;13:00:33&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 21 12:08:16 2011, RIBASUSHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Dec 21 11:39:11 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; It’s a lot better, but there’s still a snag.  Due to another perl bug,
&gt; &gt; still present in blead, the
&gt; &gt; hints become invisible to inner scopes at compile time, but not run
&gt; &gt; time.
</div>&gt; 
&gt; I am confused... isn&#39;t this the *documented* behavior of %^H?
</div>
I’m afraid I know this so well at this point that I’m confused as to what you could be confused 
about. :-&#41;

The hints set in the BEGIN block or in any code it calls apply to the scope surrounding it.  Any 
inner compile-time scopes in *that* scope obviously have to inherit hints, otherwise this 
wouldn’t work:

BEGIN { require &#34;sort.pm&#34;; sort::-&gt;import&#40;&#34;stable&#34;&#41; }
# stable sort here
{
    # stable sort here, too
}

Therefore, since BEGIN sees the compile-time hints of its surrounding scope in %^H, the 
second BEGIN block here should see the hints set in the first:

BEGIN { require &#34;sort.pm&#34;; sort::-&gt;import&#40;&#34;stable&#34;&#41; }
# stable sort here
{
    # stable sort here, too
    BEGIN { use Data::Dumper; print Dumper \%^H }
}
__END__
$VAR1 = {
          &#39;sort&#39; =&gt; 256
        };



<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Can you
&gt; perhaps make an addition to t/09-fiddle-hinthash.t that illustrates the
&gt; problem better?
</div>
See the attachment.

Where ‘perl’ is 5.10.1 &#40;later versions should produce the same results&#41;:

$ perl -Ilib t/09-fiddle-hinthash.t 
ok 1 - hinthash intact
ok 2 - compile-time hinthash intact in inner scope
ok 3 - hinthash values visible in caller
ok 4 - no segfault
1..4

$ NAMESPACE_CLEAN_USE_PP=1 perl -Ilib t/09-fiddle-hinthash.t 
ok 1 - hinthash intact
not ok 2 - compile-time hinthash intact in inner scope
#   Failed test &#39;compile-time hinthash intact in inner scope&#39;
#   at t/09-fiddle-hinthash.t line 32.
#          got: undef
#     expected: &#39;bar&#39;
ok 3 - hinthash values visible in caller
ok 4 - no segfault
1..4
# Looks like you failed 1 test of 4.

Again, I don’t know of a way to fix this in 5.12-, but tying a single element will fix it in 5.14.  
If I get to it, your current approach will work in 5.15.7.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> open_qg0dExGk.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -rup namespace-clean-0.21_01-pGIR9v/t/09-fiddle-hinthash.t namespace-clean-0.21_01-pGIR9v-copy/t/09-fiddle-hinthash.t
--- namespace-clean-0.21_01-pGIR9v/t/09-fiddle-hinthash.t	2011-12-21 03:33:16.000000000 -0800
+++ namespace-clean-0.21_01-pGIR9v-copy/t/09-fiddle-hinthash.t	2011-12-21 09:50:30.000000000 -0800
@@ -28,6 +28,11 @@ use Test::More 0.88;
   }
 
   {
+    BEGIN {
+      Test::More::is&#40;
+        $^H{&#39;foo&#39;}, &#39;bar&#39;, &#39;compile-time hinthash intact in inner scope&#39;
+      &#41;;
+    }
     1;
   }
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;15:35:52&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 21 13:00:33 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Again, I don’t know of a way to fix this in 5.12-, but tying a single
&gt; element will fix it in 5.14.
&gt; If I get to it, your current approach will work in 5.15.7.
</div>
It’s fixed in blead with cb1f05e, so namespace::clean as it is currently will work in 5.15.7 
without B::Hooks::EndOfScope installed, but not in any earlier version.  &#40;I havent’t actually 
tested 5.8, so I could be wrong.&#41;

Perl_hv_copy_hints_hv was checking for the number of real keys in the hash &#40;i.e., the number 
it had before it was tied&#41;, which doesn’t apply to tied hashes.  It was skipping the copying for 
apparently empty hashes.

So by putting %^H = &#40;&#41; before the tie, you were preventing the values from propagating to 
inner scopes.  But the underlying he-chain structure, which is what Perl actually uses at run 
time, was being copied.  The two &#40;the hh and the he-chain&#41; were getting out of sync.

So, for 5.14, you can tie a single element of the hint hash, as I demonstrated earlier.  For 
5.15.7, you don’t have to make any changes.  Tying either a single element or the whole thing 
will work.  For 5.12- you have to choose the least of several weevils:

• Require B::Hooks::EndOfScope.
• Allow string eval to break end-of-scope detection &#40;$^H{foo} = $guard&#41;.
• Allow the hh and the he-chain to get out of sync, which will work *most* of the time, as 
most hint-manipulation code just sets or deletes things, without reading them.
• Warst ava: Use a source filter.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;22&nbsp;02:03:19&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 21 02:26:43 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; And I tried another method, hoping it would work back to 5.10, but it
&gt; doesn’t even work on
&gt; bleadperl, and I don’t know why:
&gt; 
&gt; use Hash::Util::FieldHash;
&gt; 
&gt; my %hh;
&gt; BEGIN { &#38;Hash::Util::FieldHash::fieldhash&#40;\%hh&#41;; }
&gt; 
&gt; package bomb;
&gt; sub DESTROY { warn &#34;destroying $_[0]&#34; }
&gt; 
&gt; package main;
&gt; 
&gt; {
&gt;    BEGIN {
&gt;       $^H{foo}=&#39;bar&#39;; # activate localisation magic
&gt;       $hh{\%^H} = bless [], &#39;bomb&#39;;
&gt;    }
&gt; 
&gt;    BEGIN { warn &#39;about to exit scope&#39; }
&gt; 
&gt;    eval &#34;&#34;
&gt; }
&gt; BEGIN { warn &#39;exited&#39;; }
</div>
You’re not going to believe what I’ve discovered.  This is even crazier than tying the hint hash 
to begin with.

Hash::Util::FieldHash is not deleting elements in void context.  When you call delete&#40;&#41; in non-
void context, a mortal scalar is returned.  A mortal scalar is one whose reference count 
decreases at the end of the current statement.  During scope exit, ‘statement’ is not clearly 
defined, so more scope unwinding could happen before the mortal gets freed.

&#40;As long as the stack is not reference-counted, I don’t think we can fix that safely, as there 
could be code relying on it.&#41;

By forcing the deletion into void context, one can overcome that problem, so this approach 
works back to 5.10:

package hhfh;
use Tie::Hash;
BEGIN { @ISA = Tie::StdHash;}
sub DELETE {
    SUPER::DELETE{@_}; # didn’t know this trick, did you?
    1; # put the preceding statement in void context
}

use Hash::Util::FieldHash;
my %hh;
BEGIN {
    &#38;Hash::Util::FieldHash::fieldhash&#40;\%hh&#41;;
    tie %hh, &#39;hhfh&#39;;
}

package bomb;
sub DESTROY { warn &#34;destroying $_[0]&#34; }

package main;

{
   BEGIN {
      $^H{foo}=&#39;bar&#39;; # activate localisation magic
      $hh{\%^H} = bless [], &#39;bomb&#39;;
   }

   BEGIN { warn &#39;about to exit scope&#39; }

   eval &#34;&#34;
}
BEGIN { warn &#39;exited&#39;; }
__END__

$ pbpaste|perl
about to exit scope at - line 26.
destroying bomb=ARRAY&#40;0x82b2e0&#41; at - line 15.
exited at - line 30.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;22&nbsp;02:31:10&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Dec 22 02:03:19 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Dec 21 02:26:43 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; And I tried another method, hoping it would work back to 5.10, but
</div>&gt; it
<div class="message-stanza open">&gt; &gt; doesn’t even work on
&gt; &gt; bleadperl, and I don’t know why:
&gt; &gt;
&gt; &gt; use Hash::Util::FieldHash;
&gt; &gt;
&gt; &gt; my %hh;
&gt; &gt; BEGIN { &#38;Hash::Util::FieldHash::fieldhash&#40;\%hh&#41;; }
&gt; &gt;
&gt; &gt; package bomb;
&gt; &gt; sub DESTROY { warn &#34;destroying $_[0]&#34; }
&gt; &gt;
&gt; &gt; package main;
&gt; &gt;
&gt; &gt; {
&gt; &gt;    BEGIN {
&gt; &gt;       $^H{foo}=&#39;bar&#39;; # activate localisation magic
&gt; &gt;       $hh{\%^H} = bless [], &#39;bomb&#39;;
&gt; &gt;    }
&gt; &gt;
&gt; &gt;    BEGIN { warn &#39;about to exit scope&#39; }
&gt; &gt;
&gt; &gt;    eval &#34;&#34;
&gt; &gt; }
&gt; &gt; BEGIN { warn &#39;exited&#39;; }
</div>&gt; 
&gt; You’re not going to believe what I’ve discovered.  This is even
&gt; crazier than tying the hint hash
&gt; to begin with.
&gt; 
&gt; Hash::Util::FieldHash is not deleting elements in void context.  When
&gt; you call delete&#40;&#41; in non-
&gt; void context, a mortal scalar is returned.  A mortal scalar is one
&gt; whose reference count
&gt; decreases at the end of the current statement.  During scope exit,
&gt; ‘statement’ is not clearly
&gt; defined, so more scope unwinding could happen before the mortal gets
&gt; freed.
&gt; 
&gt; &#40;As long as the stack is not reference-counted, I don’t think we can
&gt; fix that safely, as there
&gt; could be code relying on it.&#41;
&gt; 
&gt; By forcing the deletion into void context, one can overcome that
&gt; problem, so this approach
&gt; works back to 5.10:
&gt; 
&gt; package hhfh;
&gt; use Tie::Hash;
&gt; BEGIN { @ISA = Tie::StdHash;}
&gt; sub DELETE {
&gt;     SUPER::DELETE{@_}; # didn’t know this trick, did you?
&gt;     1; # put the preceding statement in void context
&gt; }
&gt; 
&gt; use Hash::Util::FieldHash;
&gt; my %hh;
&gt; BEGIN {
&gt;     &#38;Hash::Util::FieldHash::fieldhash&#40;\%hh&#41;;
&gt;     tie %hh, &#39;hhfh&#39;;
&gt; }
&gt; 
&gt; package bomb;
&gt; sub DESTROY { warn &#34;destroying $_[0]&#34; }
&gt; 
&gt; package main;
&gt; 
&gt; {
&gt;    BEGIN {
&gt;       $^H{foo}=&#39;bar&#39;; # activate localisation magic
&gt;       $hh{\%^H} = bless [], &#39;bomb&#39;;
&gt;    }
&gt; 
&gt;    BEGIN { warn &#39;about to exit scope&#39; }
&gt; 
&gt;    eval &#34;&#34;
&gt; }
&gt; BEGIN { warn &#39;exited&#39;; }
&gt; __END__
&gt; 
&gt; $ pbpaste|perl
&gt; about to exit scope at - line 26.
&gt; destroying bomb=ARRAY&#40;0x82b2e0&#41; at - line 15.
&gt; exited at - line 30.
&gt; 
</div>
More good news: %^H doesn’t propagate into string eval in 5.8, so the classic object-in-the-
hint-hash approach works.

Behold, a patch attached hereto!
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> big patch.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -rup namespace-clean-0.21_01-pGIR9v/lib/namespace/clean.pm namespace-clean-0.21_01-pGIR9v-copy/lib/namespace/clean.pm
--- namespace-clean-0.21_01-pGIR9v/lib/namespace/clean.pm	2011-12-21 03:36:49.000000000 -0800
+++ namespace-clean-0.21_01-pGIR9v-copy/lib/namespace/clean.pm	2011-12-21 23:28:09.000000000 -0800
@@ -26,70 +26,86 @@ BEGIN {
   } &#41; {
     B::Hooks::EndOfScope-&gt;import&#40;&#39;on_scope_end&#39;&#41;;
   }
-  else {
+  elsif &#40;$] &lt; 5.009_999_9&#41; {
     eval &lt;&lt;&#39;PP&#39; or die $@;
 
-  use Tie::Hash &#40;&#41;;
-
   {
-    package namespace::clean::_TieHintHash;
+    package namespace::clean::_ScopeGuard;
 
     use warnings;
     use strict;
 
-    use base &#39;Tie::ExtraHash&#39;;
+    sub arm { bless [ $_[1] ] }
+
+    sub DESTROY { $_[0]-&gt;[0]-&gt;&#40;&#41; }
   }
 
+
+  sub on_scope_end &#40;&#38;&#41; {
+    $^H |= 0x020000;
+
+    if&#40; my $stack = $^H{&#39;namespace::clean/g&#39;} &#41; {
+      push @$stack, namespace::clean::_ScopeGuard-&gt;arm&#40;shift&#41;;
+    }
+    else {
+      $^H{&#39;namespace::clean/g&#39;} =
+        namespace::clean::_ScopeGuard-&gt;arm&#40;shift&#41;;
+    }
+  }
+
+  1;
+
+PP
+
+  }
+  else {
+    eval &lt;&lt;&#39;PP10&#39; or die $@;
+
+  use Tie::Hash &#40;&#41;;
+  use Hash::Util::FieldHash &#40;&#41;;
+
   {
-    package namespace::clean::_ScopeGuard;
+    # Hash::Util::FieldHash does not delete elements in void context, so
+    # they live on a bit longer on the mortals stack.  By tying it and
+    # overriding DELETE, we can force the deletion into void context.
+    package namespace::clean::_TieHintHashFieldHash;
+    use base &#39;Tie::StdHash&#39;;
+    sub DELETE {
+      SUPER::DELETE{@_};
+      1; # put the preceding statement in void context
+    }
+  }
 
-    use warnings;
-    use strict;
+  {
+    package namespace::clean::_ScopeGuard;
 
     sub arm { bless [ $_[1] ] }
 
     sub DESTROY { $_[0]-&gt;[0]-&gt;&#40;&#41; }
   }
 
+  Hash::Util::FieldHash::fieldhash my %hh;
 
   sub on_scope_end &#40;&#38;&#41; {
     $^H |= 0x020000;
 
-    if&#40; my $stack = tied&#40; %^H &#41; &#41; {
-      if &#40; &#40;my $c = ref $stack&#41; ne &#39;namespace::clean::_TieHintHash&#39;&#41; {
-        die &lt;&lt;EOE;
-========================================================================
-               !!!   F A T A L   E R R O R   !!!
-
-                 foreign tie&#40;&#41; of %^H detected
-========================================================================
-
-namespace::clean is currently operating in pure-perl fallback mode, because
-your system is lacking the necessary dependency B::Hooks::EndOfScope $b_h_eos_req.
-In this mode namespace::clean expects to be able to tie&#40;&#41; the hinthash %^H,
-however it is apparently already tied by means unknown to the tie-class
-$c
-
-Since this is a no-win situation execution will abort here and now. Please
-try to find out which other module is relying on hinthash tie&#40;&#41; ability,
-and file a bug for both the perpetrator and namespace::clean, so that the
-authors can figure out an acceptable way of moving forward.
+    if &#40;!tied %hh&#41; {
+      tie&#40;%hh, &#39;namespace::clean::_TieHintHashFieldHash&#39;&#41;;
+    }
 
-EOE
-      }
-      push @$stack, namespace::clean::_ScopeGuard-&gt;arm&#40;shift&#41;;
+    my $guard = namespace::clean::_ScopeGuard-&gt;arm&#40;shift&#41;;
+
+    if&#40; my $stack = $hh{\%^H} &#41; {
+      push @$stack, $guard;
     }
     else {
-      my %old_contents = %^H;
-      %^H = &#40;&#41;;
-      tie&#40; %^H, &#39;namespace::clean::_TieHintHash&#39;, namespace::clean::_ScopeGuard-&gt;arm&#40;shift&#41; &#41;;
-      $^H{$_} = $old_contents{$_} for keys %old_contents;
+      $hh{\%^H} = $guard;
     }
   }
 
   1;
 
-PP
+PP10
 
   }
 }
diff -rup namespace-clean-0.21_01-pGIR9v/t/09-fiddle-hinthash.t namespace-clean-0.21_01-pGIR9v-copy/t/09-fiddle-hinthash.t
--- namespace-clean-0.21_01-pGIR9v/t/09-fiddle-hinthash.t	2011-12-21 03:33:16.000000000 -0800
+++ namespace-clean-0.21_01-pGIR9v-copy/t/09-fiddle-hinthash.t	2011-12-21 23:25:18.000000000 -0800
@@ -28,6 +28,11 @@ use Test::More 0.88;
   }
 
   {
+    BEGIN {
+      Test::More::is&#40;
+        $^H{&#39;foo&#39;}, &#39;bar&#39;, &#39;compile-time hinthash intact in inner scope&#39;
+      &#41;;
+    }
     1;
   }
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;22&nbsp;06:38:05&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Dec 22 02:31:10 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; More good news: %^H doesn’t propagate into string eval in 5.8, so the
&gt; classic object-in-the-
&gt; hint-hash approach works.
</div>
Shipped <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/release/RIBASUSHI/namespace-clean-0.21_02">https://metacpan.org/release/RIBASUSHI/namespace-clean-0.21_02</a></span>
with all proposed tricks included. I factored things apart a little, so
mere mortals can actually read this stuff ;&#41; Also added you to authors,
the current incarnation of n::c would not have been possible without
your help. Thank you very much for getting to the bottom of this!

<span class="clickylink"><a target="new" rel="nofollow" href="http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=p5sagit/namespace-clean.git;a=commitdiff;h=b2e54862c91ba576736e1889a84733d11cb1b675">http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=p5sagit/namespace-clean.git;a=commitdiff;h=b2e54862c91ba576736e1889a84733d11cb1b675</a></span>

Cheers
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;22&nbsp;06:38:06&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;22&nbsp;18:31:06&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Once I finally wrapped my head around your patch I simplified it to
arrive at this:

<span class="clickylink"><a target="new" rel="nofollow" href="http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=p5sagit/namespace-clean.git;a=blob;f=lib/namespace/clean/_PP_OSE.pm">http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=p5sagit/namespace-clean.git;a=blob;f=lib/namespace/clean/_PP_OSE.pm</a></span>

Please check the comment and code for correctness when time permits.

Cheers!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;22&nbsp;18:31:08&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;22&nbsp;19:08:19&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Dec 22 18:31:06 2011, RIBASUSHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Once I finally wrapped my head around your patch I simplified it to
&gt; arrive at this:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=p5sagit/namespace-">http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=p5sagit/namespace-</a></span>
&gt; clean.git;a=blob;f=lib/namespace/clean/_PP_OSE.pm
&gt; 
&gt; Please check the comment and code for correctness when time permits.
</div>
Local firewalls prevent me from looking at that URL.  If the code is what is in 
RIBASUSHI/namespace-clean-0.21_02.tar.gz, it looks correct.  When I wrote the patch, I was 
trying to preserve the existing coding style at least somewhat, and I wondered at the 
complexity of the code, not realising it was because the thing behind tied&#40;%^H&#41; has to be an 
object, not just a plain array.  Your simplified version in the tarball is a lot clearer.

The comments in the tarball are just copied from what I wrote.  I don’t know whether you 
have changed them since, but there is a slight mistake in what I wrote:

# Hash::Util::FieldHash is not deleting elements in void context. When
# you call delete&#40;&#41; in non-void context, a mortal scalar is returned. A
# mortal scalar is one whose reference count decreases at the end of the
# current statement. During scope exit, ‘statement’ is not clearly
# defined, so more scope unwinding could happen before the mortal gets
# freed.

I don’t know for certain, but my observations suggest that an entire compilation unit counts 
as one ‘statement’, as far as the mortals stack goes.  Items mortalised during *compile-time* 
scope exit are local to that compilation unit, so they are not freed until that code’s run time 
&#40;or probably UNITCHECK time, but I haven’t checked&#41;.

If you change the comment to say the following, I think it will be accurate enough: ‘At 
compile time, an entire compilation unit counts as one “statement”, so the mortal will not be 
freed until the current file or eval finishes compiling.’
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;23&nbsp;06:31:40&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Dec 22 19:08:19 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Dec 22 18:31:06 2011, RIBASUSHI wrote:
<div class="message-stanza open">&gt; &gt; Once I finally wrapped my head around your patch I simplified it to
&gt; &gt; arrive at this:
&gt; &gt;
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=p5sagit/namespace-">http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=p5sagit/namespace-</a></span>
&gt; &gt; clean.git;a=blob;f=lib/namespace/clean/_PP_OSE.pm
&gt; &gt;
&gt; &gt; Please check the comment and code for correctness when time permits.
</div>&gt; 
&gt; Local firewalls prevent me from looking at that URL.  If the code is
&gt; what is in
&gt; RIBASUSHI/namespace-clean-0.21_02.tar.gz, it looks correct. 
</div>
Actually no, I reduced it even further throwing away the destructor
entirely. Let me know if this one is just as sane &#40;it passes smokes&#41;:

package # hide from the pauses
  namespace::clean::_PP_OSE;

use warnings;
use strict;

use Tie::Hash;
use Hash::Util::FieldHash &#39;fieldhash&#39;;

# Here we rely on a combination of several behaviors:
#
# * %^H is deallocated on scope exit, so any references to it disappear
# * A lost weakref in a fieldhash causes the corresponding key to be deleted
# * Deletion of a key on a tied hash triggers DELETE
#
# Therefore the DELETE of a tied fieldhash containing a %^H reference will
# be the hook to fire all our callbacks.

fieldhash my %hh;
{
  package # hide from pause too
    namespace::clean::_TieHintHashFieldHash;
  use base &#39;Tie::StdHash&#39;;
  sub DELETE {
    my $ret = shift-&gt;SUPER::DELETE&#40;@_&#41;;
    $_-&gt;&#40;&#41; for @$ret;
    $ret;
  }
}

sub on_scope_end &#40;&#38;&#41; {
  $^H |= 0x020000;

  tie&#40;%hh, &#39;namespace::clean::_TieHintHashFieldHash&#39;&#41;
    unless tied %hh;

  push @{ $hh{\%^H} ||= [] }, shift;
}

1;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;23&nbsp;09:25:20&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 23 06:31:40 2011, RIBASUSHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Dec 22 19:08:19 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; On Thu Dec 22 18:31:06 2011, RIBASUSHI wrote:
<div class="message-stanza open">&gt; &gt; &gt; Once I finally wrapped my head around your patch I simplified it to
&gt; &gt; &gt; arrive at this:
&gt; &gt; &gt;
&gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=p5sagit/namespace-">http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=p5sagit/namespace-</a></span>
&gt; &gt; &gt; clean.git;a=blob;f=lib/namespace/clean/_PP_OSE.pm
&gt; &gt; &gt;
&gt; &gt; &gt; Please check the comment and code for correctness when time permits.
</div>&gt; &gt; 
&gt; &gt; Local firewalls prevent me from looking at that URL.  If the code is
&gt; &gt; what is in
&gt; &gt; RIBASUSHI/namespace-clean-0.21_02.tar.gz, it looks correct. 
</div>&gt; 
&gt; Actually no, I reduced it even further throwing away the destructor
&gt; entirely. Let me know if this one is just as sane &#40;it passes smokes&#41;:
</div>
Well, now I’m having a ‘why didn’t I think of that?’ moment.  I was so close to the problem 
&#40;trying to trigger destructors&#41; that I didn’t see the obvious.  What you have should certainly 
work.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; package # hide from the pauses
&gt;   namespace::clean::_PP_OSE;
&gt; 
&gt; use warnings;
&gt; use strict;
&gt; 
&gt; use Tie::Hash;
&gt; use Hash::Util::FieldHash &#39;fieldhash&#39;;
&gt; 
&gt; # Here we rely on a combination of several behaviors:
&gt; #
&gt; # * %^H is deallocated on scope exit, so any references to it disappear
&gt; # * A lost weakref in a fieldhash causes the corresponding key to be deleted
&gt; # * Deletion of a key on a tied hash triggers DELETE
&gt; #
&gt; # Therefore the DELETE of a tied fieldhash containing a %^H reference will
&gt; # be the hook to fire all our callbacks.
&gt; 
&gt; fieldhash my %hh;
&gt; {
&gt;   package # hide from pause too
&gt;     namespace::clean::_TieHintHashFieldHash;
&gt;   use base &#39;Tie::StdHash&#39;;
&gt;   sub DELETE {
&gt;     my $ret = shift-&gt;SUPER::DELETE&#40;@_&#41;;
&gt;     $_-&gt;&#40;&#41; for @$ret;
&gt;     $ret;
&gt;   }
&gt; }
&gt; 
&gt; sub on_scope_end &#40;&#38;&#41; {
&gt;   $^H |= 0x020000;
&gt; 
&gt;   tie&#40;%hh, &#39;namespace::clean::_TieHintHashFieldHash&#39;&#41;
&gt;     unless tied %hh;
&gt; 
&gt;   push @{ $hh{\%^H} ||= [] }, shift;
&gt; }
&gt; 
&gt; 1;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;26&nbsp;13:38:16&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Fixed in 0.22 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;26&nbsp;13:38:16&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
