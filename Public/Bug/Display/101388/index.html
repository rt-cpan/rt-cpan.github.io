<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #101388 for Net-FTPSSL: SSL_reuse_ctx is missing certain options</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #101388 for Net-FTPSSL: SSL_reuse_ctx is missing certain options</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-FTPSSL/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-FTPSSL/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-FTPSSL/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-FTPSSL/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-FTPSSL">Net-FTPSSL CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">101388</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-FTPSSL/Active/">Net-FTPSSL</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
arthurdent99 [...] hotmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-22628-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.25    </td>
  </tr>
  <tr id="CF-22629-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.26    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;07&nbsp;19:07:21&nbsp;2015</span>
    <span class="description">arthurdent99 [...] hotmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SSL_reuse_ctx is missing certain options</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am submitting a patch to Net::FTPSSL to correct an issue when using the SSL_Client_Certificate option to trigger both the SSL_reuse_ctx option and the certificate and hostname verification options of IO::Socket::SSL.

A particular vendor that I have to deal with runs an FTPS server of unknown origin.  &#40;They&#39;ve overridden the connect messages, so I can&#39;t tell what program their server is running.&#41;  I have a Perl script that automatically uploads a file to their server.  They recently changed their server settings due to the POODLE vulnerability, and they only support TLS ciphers now.  Once their server settings changed, the upload stopped functioning.  My script could log in to the site, but as soon as it opened the data channel to upload the file, the connection was dropped by their server immediately.

In the initial connection settings, I am forcing a TLS connection by setting useSSL =&gt; 0.  When the script first logged in, it did indeed do a TLS handshake and connect to the server just fine, with my client offering 20 TLS ciphers for the server to choose from.  When it came time to open the data channel to transfer the file, however, the data channel reverted to an SSL handshake instead of a TLS handshake, and my client offered 26 ciphers instead of the original 20 ciphers, with the extra 6 ciphers being all SSLv2 ciphers for some reason &#40;not even SSLv3&#41;.  Their server settings are set to reject SSL ciphers now, so as soon as their server saw the extra old SSLv2 ciphers, they dropped the connection.

I eventually found the setting in your module for SSL_Client_Certificate.  Even using an empty hash causes your module to use the SSL_reuse_ctx option in IO::Socket::SSL.  As soon as I set this value, then the script started to work properly again.  The data channel reused the SSL context of the command channel, so it did a TLS handshake and offered the same 20 ciphers that the command channel did, instead of the behavior mentioned above.

By itself, this works great, and it solved my issue.  When I discovered that no hostname verification was going on, however, I added the IO::Socket::SSL settings for hostname verification, and that&#39;s when things started to break.

Apparently, reusing the SSL context does not reuse all of the initial settings, but only &#34;context-related&#34; settings, whatever those are &#40;according to the IO::Socket::SSL documentation&#41;.  Also apparently, the settings for SSL_ca_path, SSL_verifycn_name, and SSL_verifycn_scheme &#40;which I am using for hostname verification&#41; are not included in the &#34;context-related&#34; settings.  So while the context is indeed being reused for the data channel, by dropping the path to the CA certificate file, the data channel connection fails because it cannot properly verify the certificate anymore.

According to the IO::Socket::SSL documentation, you can send additional settings when reusing an SSL context, but any settings inside the context itself will override any duplicate settings also sent separately, so there should be no danger from sending a setting twice.  And since the SSL_ca_path, SSL_verifycn_name, and SSL_verifycn_scheme settings are not inside the SSL context, those need to be re-sent separately when opening the data channel or else they will not be present at all.

Also, when your module prints an error message inside _get_data_channel, it was trying to print the contents of the variable $ssl_opts{SSL_version}, but this variable is not present when reusing an SSL context.

To fix everything, I added a simple patch to your code.  If the arguments for SSL_version, SSL_ca_path, SSL_verifycn_name, and SSL_verifycn_scheme are present, they are added into the %ssl_reuse hash used for context reuse, so that they will be present if the context is indeed reused later.

To test everything out, I set up my own FTPS-I server internally, running vsftpd 2.2.2 on Red Hat Enterprise Linux 6.  I created my own SSL certificate for the server, using my company&#39;s private certificate authority, and I added this private CA certificate to the certificate bundle used by my Perl script so that it would validate successfully.  Once I applied the simple patch to your code, then both certificate verification and hostname verification worked properly, and the data channel opened successfully and transferred the file.  Without the patch, the command channel would open successfully, but certificate verification would fail when opening the data channel because IO::Socket::SSL had lost the path to the CA certificate file and the settings for hostname verification were also missing.

FYI, the server I was running the script on was Red Hat Enterprise Linux 5.11, with Perl 5.8.8, Net::FTPSSL 0.25, and IO::Socket::SSL 2.008.

Thanks,

Chris Thompson
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net-FTPSSL-0.25.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -rupN Net-FTPSSL-0.25/FTPSSL.pm Net-FTPSSL-0.25-new/FTPSSL.pm
--- Net-FTPSSL-0.25/FTPSSL.pm	2014-09-05 13:24:16.000000000 -0500
+++ Net-FTPSSL-0.25-new/FTPSSL.pm	2015-01-06 18:52:42.000000000 -0600
@@ -352,6 +352,18 @@ sub new {
        &#40;ref &#40;$arg-&gt;{SSL_Advanced}&#41; eq &#34;HASH&#34;&#41; &#41; {
      # Reuse the command channel context ...
      my %ssl_reuse = &#40; SSL_reuse_ctx =&gt; ${*$obj}{_SSL_ctx} &#41;;
+     if &#40;defined&#40;$ssl_args{SSL_version}&#41;&#41; {
+       $ssl_reuse{SSL_version} = $ssl_args{SSL_version};
+     }
+     if &#40;defined&#40;$ssl_args{SSL_ca_file}&#41;&#41; {
+       $ssl_reuse{SSL_ca_file} = $ssl_args{SSL_ca_file};
+     }
+     if &#40;defined&#40;$ssl_args{SSL_verifycn_name}&#41;&#41; {
+       $ssl_reuse{SSL_verifycn_name} = $ssl_args{SSL_verifycn_name};
+     }
+     if &#40;defined&#40;$ssl_args{SSL_verifycn_scheme}&#41;&#41; {
+       $ssl_reuse{SSL_verifycn_scheme} = $ssl_args{SSL_verifycn_scheme};
+     }
      ${*$obj}{myContext}   = \%ssl_reuse;
   }
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;07&nbsp;20:38:42&nbsp;2015</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Chris,

Thanks for your research &#38; patch.  Going through IO::Socket::SSL to figure things out is always a pain.  Especially if I&#39;m not allowed to connect to the problem server to try things out.  There are just too many variables involved.

I&#39;ll see if I can get a beta ready for you to try out in the next couple of days.

I&#39;m assuming your patch goes towards the end of function &#34;new&#40;&#41;&#34;.

I&#39;d also appreciate it if you could turn on the logs so that I can follow the trace of what is happening to help me better understand the issues you are hitting.  Both a before &#38; after trace would help me out the most.

Curtis

On Wed Jan 07 19:07:21 2015, christhompson wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I am submitting a patch to Net::FTPSSL to correct an issue when using
&gt; the SSL_Client_Certificate option to trigger both the SSL_reuse_ctx
&gt; option and the certificate and hostname verification options of
&gt; IO::Socket::SSL.
&gt; 
</div>......
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Thanks,
&gt; 
&gt; Chris Thompson
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;07&nbsp;20:38:42&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;09&nbsp;20:18:43&nbsp;2015</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Chris,

Here&#39;s my promised patch for you to test out.  It&#39;s slightly different from what you provided.  But I&#39;m hopping it will still work for you.  The other changes were all minor and doesn&#39;t affect this functionality.

Please give me some feedback on whether or not it works for you along with the logs.  Once I hear it works, I&#39;ll look into making it a formal release in the next week or so.

Curtis

On Wed Jan 07 20:38:42 2015, CLEACH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Chris,
&gt; 
&gt; Thanks for your research &#38; patch.  Going through IO::Socket::SSL to
&gt; figure things out is always a pain.  Especially if I&#39;m not allowed to
&gt; connect to the problem server to try things out.  There are just too
&gt; many variables involved.
&gt; 
&gt; I&#39;ll see if I can get a beta ready for you to try out in the next
&gt; couple of days.
&gt; 
&gt; I&#39;m assuming your patch goes towards the end of function &#34;new&#40;&#41;&#34;.
&gt; 
&gt; I&#39;d also appreciate it if you could turn on the logs so that I can
&gt; follow the trace of what is happening to help me better understand the
&gt; issues you are hitting.  Both a before &#38; after trace would help me out
&gt; the most.
&gt; 
&gt; Curtis
&gt; 
&gt; On Wed Jan 07 19:07:21 2015, christhompson wrote:
<div class="message-stanza open">&gt; &gt; I am submitting a patch to Net::FTPSSL to correct an issue when using
&gt; &gt; the SSL_Client_Certificate option to trigger both the SSL_reuse_ctx
&gt; &gt; option and the certificate and hostname verification options of
&gt; &gt; IO::Socket::SSL.
&gt; &gt;
</div>&gt; ......
<div class="message-stanza open">&gt; &gt;
&gt; &gt; Thanks,
&gt; &gt;
&gt; &gt; Chris Thompson
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;12&nbsp;20:48:32&nbsp;2015</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Chris,

Did you have a chance to test out my patch?  I did a bit more reading over the weekend and it&#39;s beginning to look like all 4 variables should have been included as part of the context.  Some of the older versions of IO-Socket-SSL lists what options make up the context, and say that adding these options will be ignored, while the latest release suggests that it overrides the context but doesn&#39;t list what makes up the context.  Confusing.

So I&#39;ll have to do a bit more reading of the code to figure it out.  In my latest beta, I dropped SSL_version from the list since you implied you only added it to remove a warning in my code.  So I fixed my code to get the SSL_version elsewhere since it was only needed for an error message.

Curtis


On Fri Jan 09 20:18:43 2015, CLEACH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Chris,
&gt; 
&gt; Here&#39;s my promised patch for you to test out.  It&#39;s slightly different
&gt; from what you provided.  But I&#39;m hopping it will still work for you.
&gt; The other changes were all minor and doesn&#39;t affect this
&gt; functionality.
&gt; 
&gt; Please give me some feedback on whether or not it works for you along
&gt; with the logs.  Once I hear it works, I&#39;ll look into making it a
&gt; formal release in the next week or so.
&gt; 
&gt; Curtis
&gt; 
&gt; On Wed Jan 07 20:38:42 2015, CLEACH wrote:
<div class="message-stanza open">&gt; &gt; Hi Chris,
&gt; &gt;
&gt; &gt; Thanks for your research &#38; patch.  Going through IO::Socket::SSL to
&gt; &gt; figure things out is always a pain.  Especially if I&#39;m not allowed to
&gt; &gt; connect to the problem server to try things out.  There are just too
&gt; &gt; many variables involved.
&gt; &gt;
&gt; &gt; I&#39;ll see if I can get a beta ready for you to try out in the next
&gt; &gt; couple of days.
&gt; &gt;
&gt; &gt; I&#39;m assuming your patch goes towards the end of function &#34;new&#40;&#41;&#34;.
&gt; &gt;
&gt; &gt; I&#39;d also appreciate it if you could turn on the logs so that I can
&gt; &gt; follow the trace of what is happening to help me better understand
&gt; &gt; the
&gt; &gt; issues you are hitting.  Both a before &#38; after trace would help me
&gt; &gt; out
&gt; &gt; the most.
&gt; &gt;
&gt; &gt; Curtis
&gt; &gt;
&gt; &gt; On Wed Jan 07 19:07:21 2015, christhompson wrote:
<div class="message-stanza open">&gt; &gt; &gt; I am submitting a patch to Net::FTPSSL to correct an issue when
&gt; &gt; &gt; using
&gt; &gt; &gt; the SSL_Client_Certificate option to trigger both the SSL_reuse_ctx
&gt; &gt; &gt; option and the certificate and hostname verification options of
&gt; &gt; &gt; IO::Socket::SSL.
&gt; &gt; &gt;
</div>&gt; &gt; ......
<div class="message-stanza open">&gt; &gt; &gt;
&gt; &gt; &gt; Thanks,
&gt; &gt; &gt;
&gt; &gt; &gt; Chris Thompson
</div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;12&nbsp;20:48:43&nbsp;2015</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Chris,

Did you have a chance to test out my patch?  I did a bit more reading over the weekend and it&#39;s beginning to look like all 4 variables should have been included as part of the context.  Some of the older versions of IO-Socket-SSL lists what options make up the context, and say that adding these options will be ignored, while the latest release suggests that it overrides the context but doesn&#39;t list what makes up the context.  Confusing.

So I&#39;ll have to do a bit more reading of the code to figure it out.  In my latest beta, I dropped SSL_version from the list since you implied you only added it to remove a warning in my code.  So I fixed my code to get the SSL_version elsewhere since it was only needed for an error message.

Curtis


On Fri Jan 09 20:18:43 2015, CLEACH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Chris,
&gt; 
&gt; Here&#39;s my promised patch for you to test out.  It&#39;s slightly different
&gt; from what you provided.  But I&#39;m hopping it will still work for you.
&gt; The other changes were all minor and doesn&#39;t affect this
&gt; functionality.
&gt; 
&gt; Please give me some feedback on whether or not it works for you along
&gt; with the logs.  Once I hear it works, I&#39;ll look into making it a
&gt; formal release in the next week or so.
&gt; 
&gt; Curtis
&gt; 
&gt; On Wed Jan 07 20:38:42 2015, CLEACH wrote:
<div class="message-stanza open">&gt; &gt; Hi Chris,
&gt; &gt;
&gt; &gt; Thanks for your research &#38; patch.  Going through IO::Socket::SSL to
&gt; &gt; figure things out is always a pain.  Especially if I&#39;m not allowed to
&gt; &gt; connect to the problem server to try things out.  There are just too
&gt; &gt; many variables involved.
&gt; &gt;
&gt; &gt; I&#39;ll see if I can get a beta ready for you to try out in the next
&gt; &gt; couple of days.
&gt; &gt;
&gt; &gt; I&#39;m assuming your patch goes towards the end of function &#34;new&#40;&#41;&#34;.
&gt; &gt;
&gt; &gt; I&#39;d also appreciate it if you could turn on the logs so that I can
&gt; &gt; follow the trace of what is happening to help me better understand
&gt; &gt; the
&gt; &gt; issues you are hitting.  Both a before &#38; after trace would help me
&gt; &gt; out
&gt; &gt; the most.
&gt; &gt;
&gt; &gt; Curtis
&gt; &gt;
&gt; &gt; On Wed Jan 07 19:07:21 2015, christhompson wrote:
<div class="message-stanza open">&gt; &gt; &gt; I am submitting a patch to Net::FTPSSL to correct an issue when
&gt; &gt; &gt; using
&gt; &gt; &gt; the SSL_Client_Certificate option to trigger both the SSL_reuse_ctx
&gt; &gt; &gt; option and the certificate and hostname verification options of
&gt; &gt; &gt; IO::Socket::SSL.
&gt; &gt; &gt;
</div>&gt; &gt; ......
<div class="message-stanza open">&gt; &gt; &gt;
&gt; &gt; &gt; Thanks,
&gt; &gt; &gt;
&gt; &gt; &gt; Chris Thompson
</div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;12&nbsp;20:48:49&nbsp;2015</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Chris,

Did you have a chance to test out my patch?  I did a bit more reading over the weekend and it&#39;s beginning to look like all 4 variables should have been included as part of the context.  Some of the older versions of IO-Socket-SSL lists what options make up the context, and say that adding these options will be ignored, while the latest release suggests that it overrides the context but doesn&#39;t list what makes up the context.  Confusing.

So I&#39;ll have to do a bit more reading of the code to figure it out.  In my latest beta, I dropped SSL_version from the list since you implied you only added it to remove a warning in my code.  So I fixed my code to get the SSL_version elsewhere since it was only needed for an error message.

Curtis


On Fri Jan 09 20:18:43 2015, CLEACH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Chris,
&gt; 
&gt; Here&#39;s my promised patch for you to test out.  It&#39;s slightly different
&gt; from what you provided.  But I&#39;m hopping it will still work for you.
&gt; The other changes were all minor and doesn&#39;t affect this
&gt; functionality.
&gt; 
&gt; Please give me some feedback on whether or not it works for you along
&gt; with the logs.  Once I hear it works, I&#39;ll look into making it a
&gt; formal release in the next week or so.
&gt; 
&gt; Curtis
&gt; 
&gt; On Wed Jan 07 20:38:42 2015, CLEACH wrote:
<div class="message-stanza open">&gt; &gt; Hi Chris,
&gt; &gt;
&gt; &gt; Thanks for your research &#38; patch.  Going through IO::Socket::SSL to
&gt; &gt; figure things out is always a pain.  Especially if I&#39;m not allowed to
&gt; &gt; connect to the problem server to try things out.  There are just too
&gt; &gt; many variables involved.
&gt; &gt;
&gt; &gt; I&#39;ll see if I can get a beta ready for you to try out in the next
&gt; &gt; couple of days.
&gt; &gt;
&gt; &gt; I&#39;m assuming your patch goes towards the end of function &#34;new&#40;&#41;&#34;.
&gt; &gt;
&gt; &gt; I&#39;d also appreciate it if you could turn on the logs so that I can
&gt; &gt; follow the trace of what is happening to help me better understand
&gt; &gt; the
&gt; &gt; issues you are hitting.  Both a before &#38; after trace would help me
&gt; &gt; out
&gt; &gt; the most.
&gt; &gt;
&gt; &gt; Curtis
&gt; &gt;
&gt; &gt; On Wed Jan 07 19:07:21 2015, christhompson wrote:
<div class="message-stanza open">&gt; &gt; &gt; I am submitting a patch to Net::FTPSSL to correct an issue when
&gt; &gt; &gt; using
&gt; &gt; &gt; the SSL_Client_Certificate option to trigger both the SSL_reuse_ctx
&gt; &gt; &gt; option and the certificate and hostname verification options of
&gt; &gt; &gt; IO::Socket::SSL.
&gt; &gt; &gt;
</div>&gt; &gt; ......
<div class="message-stanza open">&gt; &gt; &gt;
&gt; &gt; &gt; Thanks,
&gt; &gt; &gt;
&gt; &gt; &gt; Chris Thompson
</div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;14&nbsp;14:37:40&nbsp;2015</span>
    <span class="description">arthurdent99 [...] hotmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> arthurdent99 [...] hotmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

Sorry it&#39;s taken me a few days to get to this.  Things have been pretty busy at work.

Your patch was not attached to the email that I received, and I don&#39;t see your patch attached on the website either.  If you want to try to re-post your patch on the website, or if you want to email it to me directly, then I&#39;ll download it and give it a try.


Thanks,

Chris Thompson


On Mon Jan 12 20:48:49 2015, CLEACH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Chris,
&gt; 
&gt; Did you have a chance to test out my patch?
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;14&nbsp;14:59:19&nbsp;2015</span>
    <span class="description">cleach [...] Caesars.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #101388] SSL_reuse_ctx is missing certain options</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 14 Jan 2015 19:59:03 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Net-FTPSSL [...] rt.cpan.org&#34; &lt;bug-Net-FTPSSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Curtis Leach &lt;cleach [...] Caesars.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here it is again.  The latest beta

Curtis

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Chris Thompson via RT [mailto:bug-Net-FTPSSL@rt.cpan.org] 
Sent: Wednesday, January 14, 2015 11:38 AM
Subject: [rt.cpan.org #101388] SSL_reuse_ctx is missing certain options

       Queue: Net-FTPSSL
 Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101388">https://rt.cpan.org/Ticket/Display.html?id=101388</a></span> &gt;

Hello,

Sorry it&#39;s taken me a few days to get to this.  Things have been pretty busy at work.

Your patch was not attached to the email that I received, and I don&#39;t see your patch attached on the website either.  If you want to try to re-post your patch on the website, or if you want to email it to me directly, then I&#39;ll download it and give it a try.


Thanks,

Chris Thompson


On Mon Jan 12 20:48:49 2015, CLEACH wrote:
<div class="message-stanza open">&gt; Chris,
&gt; 
&gt; Did you have a chance to test out my patch?
</div></div></div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;14&nbsp;16:37:43&nbsp;2015</span>
    <span class="description">arthurdent99 [...] hotmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> arthurdent99 [...] hotmail.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for your patch.

In the patch I sent, I was checking for $ssl_args{SSL_verifycn_name}, etc.  In the patch that you sent, you changed it to ${*$obj}{SSL_verifycn_name}, etc.  But those options are not directly within the main object, they are inside a hash called _SSL_arguments.

So, if you change:
${*$obj}{SSL_verifycn_name}
to
${*$obj}{_SSL_arguments}{SSL_verifycn_name}
and so on, then it would almost work.

The only reason it doesn&#39;t quite work is that the value for SSL_verifycn_scheme isn&#39;t going into the _SSL_arguments hash for some reason.  All the other options are there, but SSL_verifycn_scheme is missing, and I don&#39;t know why.  Without that option changed from the default, then the strict name checking simply doesn&#39;t happen.  That&#39;s why I pulled the values from the $ssl_args instead, just to pull that missing value for SSL_verifycn_scheme.

Since the PASV command could potentially return a different IP address for the data channel, then not having the SSL_verifycn_scheme option carried over to the data channel means that the strict name checking wouldn&#39;t happen on that other IP address.

I&#39;ve attached what the screen looks like when I turn on debugging and transfer a file &#40;after inserting the {_SSL_arguments} hash to your patch as I mentioned above&#41;.  The transfer actually happens, but the SSL_verifycn_scheme is not passed to the data channel, because it&#39;s not present in the _SSL_arguments hash for some reason.  If I leave the code as it was originally when I sent my patch, then you can see the SSL_verifycn_scheme option within the myContext hash, so I know it&#39;s being used for the data channel when looking under $ssl_args instead.

Please let me know if you have any questions or need anything else.


Thanks,

Chris Thompson

-----

On Wed Jan 14 14:59:19 2015, cleach@Caesars.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Here it is again.  The latest beta
&gt; 
&gt; Curtis
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FTPSSL-debug.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Net-FTPSSL Version: 0.26

Perl: 5.008008  [5.8.8],  OS: linux

Server &#40;port&#41;: testserver.testdomain.com &#40;990&#41;

Keys: &#40;OverridePASV&#41;, &#40;Debug&#41;, &#40;Encryption&#41;, &#40;OverrideHELP&#41;, &#40;Port&#41;, &#40;SSL_Client_Certificate&#41;, &#40;useSSL&#41;
Values: &#40;&#41;, &#40;1&#41;, &#40;I&#41;, &#40;ARRAY&#40;0x9cd7094&#41;&#41;, &#40;&#41;, &#40;HASH&#40;0x9cd7340&#41;&#41;, &#40;0&#41;

&lt;&lt;&lt; 220 &#40;vsFTPd 2.2.2&#41;

Object Net::FTPSSL Details ... &#40;testserver.testdomain.com:990 - I&#41;
  Croak ==&gt; &#40;undef&#41;
  Crypt ==&gt; I
  FixGetTs ==&gt; 0
  FixPutTs ==&gt; 0
  Host ==&gt; testserver.testdomain.com
  OverridePASV ==&gt;
  Pret ==&gt; 0
  Timeout ==&gt; 120
  _SSL_arguments ==&gt; HASH&#40;0x9dc1a10&#41;
        -- PeerAddr ===&gt; 10.10.66.188
        -- PeerPort ===&gt; 990
        -- Proto ===&gt; tcp
        -- SSL_ca_file ===&gt; /etc/pki/tls/certs/ca-bundle.crt
        -- SSL_check_crl ===&gt; 0
        -- SSL_cipher_list ===&gt; ECDHE-ECDSA-AES128-GCM-SHA256 ECDHE-ECDSA-AES128-SHA256 ECDHE-ECDSA-AES256-GCM-SHA384 ECDHE-ECDSA-AES256-SHA384 ECDHE-ECDSA-AES128-SHA ECDHE-ECDSA-AES256-SHA ECDHE-RSA-AES128-SHA256 ECDHE-RSA-AES128-SHA ECDHE-RSA-AES256-SHA DHE-DSS-AES128-SHA256 DHE-DSS-AES128-SHA DHE-DSS-AES256-SHA256 DHE-DSS-AES256-SHA AES128-SHA256 AES128-SHA AES256-SHA256 AES256-SHA EDH-DSS-DES-CBC3-SHA DES-CBC3-SHA RC4-SHA !EXP !LOW !eNULL !aNULL !DES !MD5 !PSK !SRP
        -- SSL_server ===&gt; 0
        -- SSL_use_cert ===&gt; 0
        -- SSL_verify_callback ===&gt; CODE&#40;0x9dc1a34&#41;
        -- SSL_verify_mode ===&gt; 1
        -- SSL_verifycn_name ===&gt; testserver.testdomain.com
        -- SSL_version ===&gt; TLSv1
  _SSL_ctx ==&gt; IO::Socket::SSL::SSL_Context=HASH&#40;0x9dc1af4&#41;
        -- context ===&gt; 165381768
        -- ocsp_mode ===&gt; 16
        -- verify_mode ===&gt; 1
        -- verify_name_ref ===&gt; SCALAR&#40;0x9b28808&#41;
  _SSL_fileno ==&gt; 4
  _SSL_ioclass_upgraded ==&gt; IO::Socket::INET
  _SSL_last_err ==&gt; SSL wants a read first
  _SSL_object ==&gt; 165878256
  _SSL_opened ==&gt; 1
  buf_size ==&gt; 10240
  data_prot ==&gt; P
  dcsc_mode ==&gt; 1
  debug ==&gt; 1
  debug_extra ==&gt; 0
  help_SITE_msg ==&gt; 214 HELP Command Overriden by request.
  help_cmds_found ==&gt; HASH&#40;0x9cbe0e4&#41;
        -- ABOR ===&gt; 1
        -- ACCT* ===&gt; 1
        -- ALLO ===&gt; 1
        -- APPE ===&gt; 1
        -- AUTH ===&gt; 1
        -- CCC ===&gt; 1
        -- CDUP ===&gt; 1
        -- CWD ===&gt; 1
        -- DELE ===&gt; 1
        -- HELP ===&gt; 1
        -- LIST ===&gt; 1
        -- MAIL* ===&gt; 1
        -- MDTM ===&gt; 1
        -- MKD ===&gt; 1
        -- MLFL* ===&gt; 1
        -- MODE ===&gt; 1
        -- MRCP* ===&gt; 1
        -- MRSQ* ===&gt; 1
        -- MSAM* ===&gt; 1
        -- MSND* ===&gt; 1
        -- MSOM* ===&gt; 1
        -- NLST ===&gt; 1
        -- NOOP ===&gt; 1
        -- PASS ===&gt; 1
        -- PASV ===&gt; 1
        -- PBSZ ===&gt; 1
        -- PORT ===&gt; 1
        -- PROT ===&gt; 1
        -- PWD ===&gt; 1
        -- QUIT ===&gt; 1
        -- REIN* ===&gt; 1
        -- REST ===&gt; 1
        -- RETR ===&gt; 1
        -- RMD ===&gt; 1
        -- RNFR ===&gt; 1
        -- RNTO ===&gt; 1
        -- SITE ===&gt; 1
        -- SIZE ===&gt; 1
        -- SMNT* ===&gt; 1
        -- STAT ===&gt; 1
        -- STOR ===&gt; 1
        -- STOU ===&gt; 1
        -- STRU ===&gt; 1
        -- SYST ===&gt; 1
        -- TYPE ===&gt; 1
        -- USER ===&gt; 1
        -- XCUP ===&gt; 1
        -- XCWD ===&gt; 1
        -- XMKD ===&gt; 1
        -- XPWD ===&gt; 1
        -- XRMD ===&gt; 1
  help_cmds_msg ==&gt; 214 HELP Command Overriden by request.
  help_cmds_no_syntax_available ==&gt; 1
  io_socket_domain ==&gt; 2
  io_socket_proto ==&gt; 6
  io_socket_timeout ==&gt; 120
  io_socket_type ==&gt; 1
  last_ftp_msg ==&gt; 220 &#40;vsFTPd 2.2.2&#41;
  myContext ==&gt; HASH&#40;0x9cbe2a0&#41;
        -- SSL_ca_file ===&gt; /etc/pki/tls/certs/ca-bundle.crt
        -- SSL_reuse_ctx ===&gt; IO::Socket::SSL::SSL_Context=HASH&#40;0x9dc1af4&#41;
            -- context ----&gt; 165381768
            -- ocsp_mode ----&gt; 16
            -- verify_mode ----&gt; 1
            -- verify_name_ref ----&gt; SCALAR&#40;0x9b28808&#41;
        -- SSL_verifycn_name ===&gt; testserver.testdomain.com
  mySocketOpts ==&gt; HASH&#40;0x9c2f834&#41;
        -- PeerAddr ===&gt; testserver.testdomain.com
        -- PeerPort ===&gt; 990
        -- Proto ===&gt; tcp
        -- Timeout ===&gt; 120
  trace ==&gt; 0
  type ==&gt; A

&gt;&gt;&gt; USER +++++++
&lt;&lt;&lt; 331 Please specify the password.
&gt;&gt;&gt; PASS *******
&lt;&lt;&lt; 230 Login successful.
&lt;&lt;+ 214 The HELP command is supported.
&gt;&gt;&gt; TYPE I
&lt;&lt;&lt; 200 Switching to Binary mode.
&gt;&gt;&gt; PBSZ 0
&lt;&lt;&lt; 200 PBSZ set to 0.
&gt;&gt;&gt; PROT P
&lt;&lt;&lt; 200 PROT now Private.
&gt;&gt;&gt; PASV
&lt;&lt;&lt; 227 Entering Passive Mode &#40;10,10,66,188,230,192&#41;.
--- Host &#40;10.10.66.188&#41;  Port &#40;59072&#41;
&lt;&lt;+ 214 The ALLO command is supported.
&gt;&gt;&gt; ALLO 25
&lt;&lt;&lt; 202 ALLO command ignored.
&gt;&gt;&gt; STOR testfile.txt
&lt;&lt;&lt; 150 Ok to send data.
&lt;&lt;&lt; 226 Transfer complete.
&gt;&gt;&gt; QUIT
&lt;&lt;&lt; 221 Goodbye.
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;14&nbsp;22:44:59&nbsp;2015</span>
    <span class="description">cleach [...] Caesars.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #101388] SSL_reuse_ctx is missing certain options</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 15 Jan 2015 01:58:01 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Net-FTPSSL [...] rt.cpan.org&#34; &lt;bug-Net-FTPSSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Curtis Leach &lt;cleach [...] Caesars.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for the log file and the more detailed explanation on why it failed.  It strongly suggests a bug in your code or in IO-Socket-SSL if it&#39;s not including that value as part of the context in _SSL_arguments.

But to prove it, I&#39;m including another beta for you to look at.  The main change is to dump the contents of SSL_Client_Certificate to the log file as well as your commented changes below.

But I did see one thing when looking at the log file.  Why didn&#39;t you set &#34;SSL_use_cert=&gt;1&#34; in your SSL_Client_Certificate hash?  You are using certificates?  That might be the root cause of your issue if you are.  Give it a try &#38; let me know.  I&#39;m very interested if it fixes your problem.

But I do have a couple of quick questions/comments?  Not all are related to your problem.
1&#41; Is there a reason you&#39;re using OverrideHELP
 It&#39;s not necessary for most servers.  But if you are going to enable everything use OverrideHELP=&gt;1 instead of OverrideHELP=&gt;\@help_list.  It looks like you manually did a HELP on some system and hard coded them into your program.  You only need this option if the module bombs if you leave it out or if your server doesn&#39;t support the HELP command.  It&#39;s a work around option.

2&#41; You are not providing any values, so drop OverridePASV &#38; Port.  In both cases here these options are being ignored &#38; default values are being used.

3&#41; useSSL =&gt; 0 isn&#39;t needed.  That&#39;s the default behavior.  To use SSL do useSSL=&gt;1, otherwise TLS is always used without this option.



So a good constructor based on your logs should be:
My $ftps = Net::FTPSSL-&gt;new&#40;&#39;testserver.testdomain.com&#39;, Debug=&gt;1, DebugLogFile=&gt;&#39;FTPSSL-debug.txt&#39;, Encryption=&gt;IMP_CRYPT, Croak=&gt;1, SSL_Client_Certificate=&gt;\%options, OverrideHELP=&gt;1&#41;;

Drop OverrideHELLP entirely if it&#39;s not needed.

Curtis

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Chris Thompson via RT [mailto:bug-Net-FTPSSL@rt.cpan.org] 
Sent: Wednesday, January 14, 2015 1:38 PM
Subject: [rt.cpan.org #101388] SSL_reuse_ctx is missing certain options

       Queue: Net-FTPSSL
 Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101388">https://rt.cpan.org/Ticket/Display.html?id=101388</a></span> &gt;

Thank you for your patch.

In the patch I sent, I was checking for $ssl_args{SSL_verifycn_name}, etc.  In the patch that you sent, you changed it to ${*$obj}{SSL_verifycn_name}, etc.  But those options are not directly within the main object, they are inside a hash called _SSL_arguments.

So, if you change:
${*$obj}{SSL_verifycn_name}
to
${*$obj}{_SSL_arguments}{SSL_verifycn_name}
and so on, then it would almost work.

The only reason it doesn&#39;t quite work is that the value for SSL_verifycn_scheme isn&#39;t going into the _SSL_arguments hash for some reason.  All the other options are there, but SSL_verifycn_scheme is missing, and I don&#39;t know why.  Without that option changed from the default, then the strict name checking simply doesn&#39;t happen.  That&#39;s why I pulled the values from the $ssl_args instead, just to pull that missing value for SSL_verifycn_scheme.

Since the PASV command could potentially return a different IP address for the data channel, then not having the SSL_verifycn_scheme option carried over to the data channel means that the strict name checking wouldn&#39;t happen on that other IP address.

I&#39;ve attached what the screen looks like when I turn on debugging and transfer a file &#40;after inserting the {_SSL_arguments} hash to your patch as I mentioned above&#41;.  The transfer actually happens, but the SSL_verifycn_scheme is not passed to the data channel, because it&#39;s not present in the _SSL_arguments hash for some reason.  If I leave the code as it was originally when I sent my patch, then you can see the SSL_verifycn_scheme option within the myContext hash, so I know it&#39;s being used for the data channel when looking under $ssl_args instead.

Please let me know if you have any questions or need anything else.


Thanks,

Chris Thompson

-----

On Wed Jan 14 14:59:19 2015, cleach@Caesars.com wrote:
<div class="message-stanza open">&gt; Here it is again.  The latest beta
&gt; 
&gt; Curtis
</div>
</div></div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;14&nbsp;22:46:01&nbsp;2015</span>
    <span class="description">cleach [...] Caesars.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #101388] SSL_reuse_ctx is missing certain options</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 15 Jan 2015 01:59:01 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Net-FTPSSL [...] rt.cpan.org&#34; &lt;bug-Net-FTPSSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Curtis Leach &lt;cleach [...] Caesars.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry, I included the wrong beta last time.  It had a bug in it.



<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Curtis Leach 
Sent: Wednesday, January 14, 2015 5:58 PM
To: &#39;bug-Net-FTPSSL@rt.cpan.org&#39;
Subject: RE: [rt.cpan.org #101388] SSL_reuse_ctx is missing certain options

Thank you for the log file and the more detailed explanation on why it failed.  It strongly suggests a bug in your code or in IO-Socket-SSL if it&#39;s not including that value as part of the context in _SSL_arguments.

But to prove it, I&#39;m including another beta for you to look at.  The main change is to dump the contents of SSL_Client_Certificate to the log file as well as your commented changes below.

But I did see one thing when looking at the log file.  Why didn&#39;t you set &#34;SSL_use_cert=&gt;1&#34; in your SSL_Client_Certificate hash?  You are using certificates?  That might be the root cause of your issue if you are.  Give it a try &#38; let me know.  I&#39;m very interested if it fixes your problem.

But I do have a couple of quick questions/comments?  Not all are related to your problem.
1&#41; Is there a reason you&#39;re using OverrideHELP  It&#39;s not necessary for most servers.  But if you are going to enable everything use OverrideHELP=&gt;1 instead of OverrideHELP=&gt;\@help_list.  It looks like you manually did a HELP on some system and hard coded them into your program.  You only need this option if the module bombs if you leave it out or if your server doesn&#39;t support the HELP command.  It&#39;s a work around option.

2&#41; You are not providing any values, so drop OverridePASV &#38; Port.  In both cases here these options are being ignored &#38; default values are being used.

3&#41; useSSL =&gt; 0 isn&#39;t needed.  That&#39;s the default behavior.  To use SSL do useSSL=&gt;1, otherwise TLS is always used without this option.



So a good constructor based on your logs should be:
My $ftps = Net::FTPSSL-&gt;new&#40;&#39;testserver.testdomain.com&#39;, Debug=&gt;1, DebugLogFile=&gt;&#39;FTPSSL-debug.txt&#39;, Encryption=&gt;IMP_CRYPT, Croak=&gt;1, SSL_Client_Certificate=&gt;\%options, OverrideHELP=&gt;1&#41;;

Drop OverrideHELLP entirely if it&#39;s not needed.

Curtis

<div class="message-stanza open">-----Original Message-----
From: Chris Thompson via RT [mailto:bug-Net-FTPSSL@rt.cpan.org]
Sent: Wednesday, January 14, 2015 1:38 PM
Subject: [rt.cpan.org #101388] SSL_reuse_ctx is missing certain options

       Queue: Net-FTPSSL
 Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101388">https://rt.cpan.org/Ticket/Display.html?id=101388</a></span> &gt;

Thank you for your patch.

In the patch I sent, I was checking for $ssl_args{SSL_verifycn_name}, etc.  In the patch that you sent, you changed it to ${*$obj}{SSL_verifycn_name}, etc.  But those options are not directly within the main object, they are inside a hash called _SSL_arguments.

So, if you change:
${*$obj}{SSL_verifycn_name}
to
${*$obj}{_SSL_arguments}{SSL_verifycn_name}
and so on, then it would almost work.

The only reason it doesn&#39;t quite work is that the value for SSL_verifycn_scheme isn&#39;t going into the _SSL_arguments hash for some reason.  All the other options are there, but SSL_verifycn_scheme is missing, and I don&#39;t know why.  Without that option changed from the default, then the strict name checking simply doesn&#39;t happen.  That&#39;s why I pulled the values from the $ssl_args instead, just to pull that missing value for SSL_verifycn_scheme.

Since the PASV command could potentially return a different IP address for the data channel, then not having the SSL_verifycn_scheme option carried over to the data channel means that the strict name checking wouldn&#39;t happen on that other IP address.

I&#39;ve attached what the screen looks like when I turn on debugging and transfer a file &#40;after inserting the {_SSL_arguments} hash to your patch as I mentioned above&#41;.  The transfer actually happens, but the SSL_verifycn_scheme is not passed to the data channel, because it&#39;s not present in the _SSL_arguments hash for some reason.  If I leave the code as it was originally when I sent my patch, then you can see the SSL_verifycn_scheme option within the myContext hash, so I know it&#39;s being used for the data channel when looking under $ssl_args instead.

Please let me know if you have any questions or need anything else.


Thanks,

Chris Thompson

-----

On Wed Jan 14 14:59:19 2015, cleach@Caesars.com wrote:
<div class="message-stanza open">&gt; Here it is again.  The latest beta
&gt; 
&gt; Curtis
</div>
</div></div></div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;21&nbsp;18:11:41&nbsp;2015</span>
    <span class="description">cleach [...] Caesars.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #101388] SSL_reuse_ctx is missing certain options</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 21 Jan 2015 23:11:22 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Net-FTPSSL [...] rt.cpan.org&#34; &lt;bug-Net-FTPSSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Curtis Leach &lt;cleach [...] Caesars.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Chris,

Will you be trying out the attached patch &#38; returning the logs to me?

I&#39;d just like to verify I fully understood your problem &#40;via the logs&#41; and that the patch resolved any issues you were encountering.

Curtis

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Curtis Leach 
Sent: Wednesday, January 14, 2015 5:59 PM
To: &#39;bug-Net-FTPSSL@rt.cpan.org&#39;
Subject: RE: [rt.cpan.org #101388] SSL_reuse_ctx is missing certain options

Sorry, I included the wrong beta last time.  It had a bug in it.



<div class="message-stanza open">-----Original Message-----
From: Curtis Leach 
Sent: Wednesday, January 14, 2015 5:58 PM
To: &#39;bug-Net-FTPSSL@rt.cpan.org&#39;
Subject: RE: [rt.cpan.org #101388] SSL_reuse_ctx is missing certain options

Thank you for the log file and the more detailed explanation on why it failed.  It strongly suggests a bug in your code or in IO-Socket-SSL if it&#39;s not including that value as part of the context in _SSL_arguments.

But to prove it, I&#39;m including another beta for you to look at.  The main change is to dump the contents of SSL_Client_Certificate to the log file as well as your commented changes below.

But I did see one thing when looking at the log file.  Why didn&#39;t you set &#34;SSL_use_cert=&gt;1&#34; in your SSL_Client_Certificate hash?  You are using certificates?  That might be the root cause of your issue if you are.  Give it a try &#38; let me know.  I&#39;m very interested if it fixes your problem.

But I do have a couple of quick questions/comments?  Not all are related to your problem.
1&#41; Is there a reason you&#39;re using OverrideHELP  It&#39;s not necessary for most servers.  But if you are going to enable everything use OverrideHELP=&gt;1 instead of OverrideHELP=&gt;\@help_list.  It looks like you manually did a HELP on some system and hard coded them into your program.  You only need this option if the module bombs if you leave it out or if your server doesn&#39;t support the HELP command.  It&#39;s a work around option.

2&#41; You are not providing any values, so drop OverridePASV &#38; Port.  In both cases here these options are being ignored &#38; default values are being used.

3&#41; useSSL =&gt; 0 isn&#39;t needed.  That&#39;s the default behavior.  To use SSL do useSSL=&gt;1, otherwise TLS is always used without this option.



So a good constructor based on your logs should be:
My $ftps = Net::FTPSSL-&gt;new&#40;&#39;testserver.testdomain.com&#39;, Debug=&gt;1, DebugLogFile=&gt;&#39;FTPSSL-debug.txt&#39;, Encryption=&gt;IMP_CRYPT, Croak=&gt;1, SSL_Client_Certificate=&gt;\%options, OverrideHELP=&gt;1&#41;;

Drop OverrideHELLP entirely if it&#39;s not needed.

Curtis

<div class="message-stanza open">-----Original Message-----
From: Chris Thompson via RT [mailto:bug-Net-FTPSSL@rt.cpan.org]
Sent: Wednesday, January 14, 2015 1:38 PM
Subject: [rt.cpan.org #101388] SSL_reuse_ctx is missing certain options

       Queue: Net-FTPSSL
 Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101388">https://rt.cpan.org/Ticket/Display.html?id=101388</a></span> &gt;

Thank you for your patch.

In the patch I sent, I was checking for $ssl_args{SSL_verifycn_name}, etc.  In the patch that you sent, you changed it to ${*$obj}{SSL_verifycn_name}, etc.  But those options are not directly within the main object, they are inside a hash called _SSL_arguments.

So, if you change:
${*$obj}{SSL_verifycn_name}
to
${*$obj}{_SSL_arguments}{SSL_verifycn_name}
and so on, then it would almost work.

The only reason it doesn&#39;t quite work is that the value for SSL_verifycn_scheme isn&#39;t going into the _SSL_arguments hash for some reason.  All the other options are there, but SSL_verifycn_scheme is missing, and I don&#39;t know why.  Without that option changed from the default, then the strict name checking simply doesn&#39;t happen.  That&#39;s why I pulled the values from the $ssl_args instead, just to pull that missing value for SSL_verifycn_scheme.

Since the PASV command could potentially return a different IP address for the data channel, then not having the SSL_verifycn_scheme option carried over to the data channel means that the strict name checking wouldn&#39;t happen on that other IP address.

I&#39;ve attached what the screen looks like when I turn on debugging and transfer a file &#40;after inserting the {_SSL_arguments} hash to your patch as I mentioned above&#41;.  The transfer actually happens, but the SSL_verifycn_scheme is not passed to the data channel, because it&#39;s not present in the _SSL_arguments hash for some reason.  If I leave the code as it was originally when I sent my patch, then you can see the SSL_verifycn_scheme option within the myContext hash, so I know it&#39;s being used for the data channel when looking under $ssl_args instead.

Please let me know if you have any questions or need anything else.


Thanks,

Chris Thompson

-----

On Wed Jan 14 14:59:19 2015, cleach@Caesars.com wrote:
<div class="message-stanza open">&gt; Here it is again.  The latest beta
&gt; 
&gt; Curtis
</div>
</div></div></div></div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;22&nbsp;11:21:17&nbsp;2015</span>
    <span class="description">arthurdent99 [...] hotmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> arthurdent99 [...] hotmail.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

The patch that you sent works fine, except that the four print_LOG&#40;&#41; statements that you added cause the file transfer to crash.  I noticed the same thing when I was experimenting with my initial patch.  The _debug_print_hash&#40;&#41; that you added works fine, but apparently you can&#39;t use print_LOG&#40;&#41; in that section of the code without causing it to fail.  So I just commented out those four lines &#40;lines 360, 364, 368, and 371&#41;.  After I commented out those lines, the test ran fine.

I&#39;m not actually using an SSL client certificate in this case.  I&#39;m only setting the SSL_Client_Certificate option to trigger the reuse of the SSL context and to pass the options for strict hostname verification.

I&#39;ve attached the debug log from the test &#40;after I commented out the four lines mentioned above&#41;.


Thanks,

Chris Thompson

-----

On Wed Jan 21 18:11:41 2015, cleach@Caesars.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Chris,
&gt; 
&gt; Will you be trying out the attached patch &#38; returning the logs to me?
&gt; 
&gt; I&#39;d just like to verify I fully understood your problem &#40;via the logs&#41;
&gt; and that the patch resolved any issues you were encountering.
&gt; 
&gt; Curtis
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FTPSSL-debug.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Net-FTPSSL Version: 0.26

Perl: 5.008008  [5.8.8],  OS: linux

Server &#40;port&#41;: testserver.testdomain.com &#40;990&#41;

Keys: &#40;Croak&#41;, &#40;Debug&#41;, &#40;Encryption&#41;, &#40;SSL_Client_Certificate&#41;, &#40;DebugLogFile&#41;
Values: &#40;1&#41;, &#40;1&#41;, &#40;I&#41;, &#40;HASH&#40;0xa31f0b0&#41;&#41;, &#40;FTPSSL-debug.txt&#41;

&lt;&lt;&lt; 220 &#40;vsFTPd 2.2.2&#41;

Object HASH Details ... &#40;SSL_Client_Certificate:options - I&#41;
  SSL_ca_file ==&gt; /etc/pki/tls/certs/ca-bundle.crt
  SSL_verify_mode ==&gt; 1
  SSL_verifycn_name ==&gt; testserver.testdomain.com
  SSL_verifycn_scheme ==&gt; ftp


Object Net::FTPSSL Details ... &#40;testserver.testdomain.com:990 - I&#41;
  Croak ==&gt; 1
  Crypt ==&gt; I
  FixGetTs ==&gt; 0
  FixPutTs ==&gt; 0
  Host ==&gt; testserver.testdomain.com
  OverridePASV ==&gt; &#40;undef&#41;
  Pret ==&gt; 0
  Timeout ==&gt; 120
  _SSL_arguments ==&gt; HASH&#40;0xa4013d8&#41;
        -- PeerAddr ===&gt; 10.10.66.188
        -- PeerPort ===&gt; 990
        -- Proto ===&gt; tcp
        -- SSL_ca_file ===&gt; /etc/pki/tls/certs/ca-bundle.crt
        -- SSL_check_crl ===&gt; 0
        -- SSL_cipher_list ===&gt; ECDHE-ECDSA-AES128-GCM-SHA256 ECDHE-ECDSA-AES128-SHA256 ECDHE-ECDSA-AES256-GCM-SHA384 ECDHE-ECDSA-AES256-SHA384 ECDHE-ECDSA-AES128-SHA ECDHE-ECDSA-AES256-SHA ECDHE-RSA-AES128-SHA256 ECDHE-RSA-AES128-SHA ECDHE-RSA-AES256-SHA DHE-DSS-AES128-SHA256 DHE-DSS-AES128-SHA DHE-DSS-AES256-SHA256 DHE-DSS-AES256-SHA AES128-SHA256 AES128-SHA AES256-SHA256 AES256-SHA EDH-DSS-DES-CBC3-SHA DES-CBC3-SHA RC4-SHA !EXP !LOW !eNULL !aNULL !DES !MD5 !PSK !SRP
        -- SSL_server ===&gt; 0
        -- SSL_use_cert ===&gt; 0
        -- SSL_verify_callback ===&gt; CODE&#40;0xa4013fc&#41;
        -- SSL_verify_mode ===&gt; 1
        -- SSL_verifycn_name ===&gt; testserver.testdomain.com
        -- SSL_version ===&gt; TLSv1
  _SSL_ctx ==&gt; IO::Socket::SSL::SSL_Context=HASH&#40;0xa4014bc&#41;
        -- context ===&gt; 171939576
        -- ocsp_mode ===&gt; 16
        -- verify_mode ===&gt; 1
        -- verify_name_ref ===&gt; SCALAR&#40;0xa1b8808&#41;
  _SSL_fileno ==&gt; 5
  _SSL_ioclass_upgraded ==&gt; IO::Socket::INET
  _SSL_last_err ==&gt; SSL wants a read first
  _SSL_object ==&gt; 172428400
  _SSL_opened ==&gt; 1
  buf_size ==&gt; 10240
  data_prot ==&gt; P
  dcsc_mode ==&gt; 1
  debug ==&gt; 2
  debug_extra ==&gt; 0
  ftpssl_filehandle ==&gt; GLOB&#40;0xa3ec764&#41;
  io_socket_domain ==&gt; 2
  io_socket_proto ==&gt; 6
  io_socket_timeout ==&gt; 120
  io_socket_type ==&gt; 1
  last_ftp_msg ==&gt; 220 &#40;vsFTPd 2.2.2&#41;
  myContext ==&gt; HASH&#40;0xa2d0d64&#41;
        -- SSL_ca_file ===&gt; /etc/pki/tls/certs/ca-bundle.crt
        -- SSL_reuse_ctx ===&gt; IO::Socket::SSL::SSL_Context=HASH&#40;0xa4014bc&#41;
            -- context ----&gt; 171939576
            -- ocsp_mode ----&gt; 16
            -- verify_mode ----&gt; 1
            -- verify_name_ref ----&gt; SCALAR&#40;0xa1b8808&#41;
        -- SSL_verifycn_name ===&gt; testserver.testdomain.com
        -- SSL_verifycn_scheme ===&gt; ftp
  mySocketOpts ==&gt; HASH&#40;0xa2d0860&#41;
        -- PeerAddr ===&gt; testserver.testdomain.com
        -- PeerPort ===&gt; 990
        -- Proto ===&gt; tcp
        -- Timeout ===&gt; 120
  trace ==&gt; 0
  type ==&gt; A

&gt;&gt;&gt; USER +++++++
&lt;&lt;&lt; 331 Please specify the password.
&gt;&gt;&gt; PASS *******
&lt;&lt;&lt; 230 Login successful.
&gt;&gt;&gt; HELP
&lt;&lt;&lt; 214-The following commands are recognized.
&lt;&lt;&lt;  ABOR ACCT ALLO APPE CDUP CWD  DELE EPRT EPSV FEAT HELP LIST MDTM MKD
&lt;&lt;&lt;  MODE NLST NOOP OPTS PASS PASV PORT PWD  QUIT REIN REST RETR RMD  RNFR
&lt;&lt;&lt;  RNTO SITE SIZE SMNT STAT STOR STOU STRU SYST TYPE USER XCUP XCWD XMKD
&lt;&lt;&lt;  XPWD XRMD
&lt;&lt;&lt; 214 Help OK.
&gt;&gt;&gt; FEAT
&lt;&lt;&lt; 211-Features:
&lt;&lt;&lt;  AUTH SSL
&lt;&lt;&lt;  AUTH TLS
&lt;&lt;&lt;  EPRT
&lt;&lt;&lt;  EPSV
&lt;&lt;&lt;  MDTM
&lt;&lt;&lt;  PASV
&lt;&lt;&lt;  PBSZ
&lt;&lt;&lt;  PROT
&lt;&lt;&lt;  REST STREAM
&lt;&lt;&lt;  SIZE
&lt;&lt;&lt;  TVFS
&lt;&lt;&lt;  UTF8
&lt;&lt;&lt; 211 End
&lt;&lt;+ 214 The HELP command is supported.
&gt;&gt;&gt; TYPE I
&lt;&lt;&lt; 200 Switching to Binary mode.
&gt;&gt;&gt; PBSZ 0
&lt;&lt;&lt; 200 PBSZ set to 0.
&gt;&gt;&gt; PROT P
&lt;&lt;&lt; 200 PROT now Private.
&gt;&gt;&gt; PASV
&lt;&lt;&lt; 227 Entering Passive Mode &#40;10,10,66,188,188,152&#41;.
--- Host &#40;10.10.66.188&#41;  Port &#40;48280&#41;
&lt;&lt;+ 214 The ALLO command is supported.
&gt;&gt;&gt; ALLO 25
&lt;&lt;&lt; 202 ALLO command ignored.
&gt;&gt;&gt; STOR testfile.txt
&lt;&lt;&lt; 150 Ok to send data.
&lt;&lt;&lt; 226 Transfer complete.
&gt;&gt;&gt; QUIT
&lt;&lt;&lt; 221 Goodbye.
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;22&nbsp;14:34:52&nbsp;2015</span>
    <span class="description">cleach [...] Caesars.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #101388] SSL_reuse_ctx is missing certain options</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 22 Jan 2015 19:34:34 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Net-FTPSSL [...] rt.cpan.org&#34; &lt;bug-Net-FTPSSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Curtis Leach &lt;cleach [...] Caesars.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for the logs &#38; the clarification on the issue.  The log helped a  lot.

I found the typos.  It was missing the leading underscore in the function name.

$obj-&gt;print_LOG &#40;...&#41;
Should have been
$obj-&gt;_print_LOG&#40;...&#41;

But you are right about calls in new&#40;&#41;, calling member functions don&#39;t always work.  It doesn&#39;t work until the command channel is opened &#38; it gets blessed to be an FTPSSL object.  If you need to call one before that you have to call it in a different way.

I have a couple more tweaks to make for the logging, but I should have an official release uploaded by early next week.

But I&#39;m going to have to re-read the IO-Socket-SSL pod text more closely before I do.  It&#39;s changed quite a bit since I last reviewed things.   And it&#39;s probably time to closely review it again for new surprises.

Thank you for your help in this.  

Curtis

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Chris Thompson via RT [mailto:bug-Net-FTPSSL@rt.cpan.org] 
Sent: Thursday, January 22, 2015 8:21 AM
Subject: [rt.cpan.org #101388] SSL_reuse_ctx is missing certain options

       Queue: Net-FTPSSL
 Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101388">https://rt.cpan.org/Ticket/Display.html?id=101388</a></span> &gt;

Hello,

The patch that you sent works fine, except that the four print_LOG&#40;&#41; statements that you added cause the file transfer to crash.  I noticed the same thing when I was experimenting with my initial patch.  The _debug_print_hash&#40;&#41; that you added works fine, but apparently you can&#39;t use print_LOG&#40;&#41; in that section of the code without causing it to fail.  So I just commented out those four lines &#40;lines 360, 364, 368, and 371&#41;.  After I commented out those lines, the test ran fine.

I&#39;m not actually using an SSL client certificate in this case.  I&#39;m only setting the SSL_Client_Certificate option to trigger the reuse of the SSL context and to pass the options for strict hostname verification.

I&#39;ve attached the debug log from the test &#40;after I commented out the four lines mentioned above&#41;.


Thanks,

Chris Thompson

-----

On Wed Jan 21 18:11:41 2015, cleach@Caesars.com wrote:
<div class="message-stanza open">&gt; Chris,
&gt; 
&gt; Will you be trying out the attached patch &#38; returning the logs to me?
&gt; 
&gt; I&#39;d just like to verify I fully understood your problem &#40;via the logs&#41; 
&gt; and that the patch resolved any issues you were encountering.
&gt; 
&gt; Curtis
</div>
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;13&nbsp;20:14:15&nbsp;2015</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Chris,

Thank you for your help outside the chain of this ticket.  I&#39;ve finally uploaded the official release.  There were just minor changes to the beta I provided earlier.

So I&#39;m closing this ticket.

Thanks for using my module.

Curtis
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;13&nbsp;20:14:21&nbsp;2015</span>
    <span class="description">CLEACH [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;13&nbsp;20:14:21&nbsp;2015</span>
    <span class="description">CLEACH [...] cpan.org -  Fixed in 0.26 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
