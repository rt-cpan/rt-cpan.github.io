<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #6340 for DBD-SQLite: multiple INSERTIONs won&#39;t work if you have more than 1 STH opened/cached</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #6340 for DBD-SQLite: multiple INSERTIONs won&#39;t work if you have more than 1 STH opened/cached</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-SQLite/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-SQLite">DBD-SQLite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">6340</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-SQLite/Active/">DBD-SQLite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
gm [...] virtuasites.com.br

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-10248-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.27    </td>
  </tr>
  <tr id="CF-10249-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;18&nbsp;00:56:57&nbsp;2004</span>
    <span class="description">gmpassos [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> multiple INSERTIONs won&#39;t work if you have more than 1 STH
 opened/cached</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m sending to you a script that shows a strange error when using insertions. The problems exits when you open a STH for insertion, create and execute a 2nd STH, than you execute the 1st STH.

When I was using DBD::SQlite 0.25 everything worked fine, but from version 0.27 not! I tested with this versions:

 0.25 - OK
 0.26 - OK
 0.27 - ERROR
 0.29 - ERROR
 0.31 - ERROR

I&#39;m on Win32 with Perl-5.6.1 &#40;standart&#41;.

I also have tested with DBI 1.37 and 1.42, and the DBI version is not influencing in the error. I tried to isolate the error in the script attached to help in the fix.

Thanks to turn SQLITE available for the Perl community.

Best regards,
Graciliano M. P.
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
  use DBI ;

  my $db = &#39;testerror.db&#39; ;

  unlink&#40;$db&#41; ;

my $dbh = DBI-&gt;connect&#40;&#34;dbi:SQLite:dbname=$db&#34;, &#39;&#39; , &#39;&#39; , { RaiseError =&gt; 0 , PrintError =&gt; 1 , AutoCommit =&gt; 1 }&#41; ;

$dbh-&gt;do&#40;&#39;CREATE TABLE words &#40;word TEXT , ids TEXT , id INTEGER PRIMARY KEY&#41;&#39;&#41; ;

for &#40;1..3&#41; {

  print &#34;______________________________________\n&#34; ;
  
  print &#34;LOOP $_\n&#34; ;

  my $sth = $dbh-&gt;prepare&#40;&#39;INSERT INTO words VALUES &#40;?,?,?&#41;&#39;&#41; ;
  $sth-&gt;{ShowErrorStatement} = 1 ;

  my $sth2 ;
  $sth2 = $dbh-&gt;prepare&#40; &#39;SELECT * FROM words LIMIT 1&#39; &#41; ;
  $sth2-&gt;execute ;

  $sth-&gt;execute&#40;&#39;q&#39;,2,undef&#41; ;

}

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;22&nbsp;06:23:25&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> david_dick [...] iprimus.com.au</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">G&#39;day Graciliano,
Thank you for the excellent bug report.  I can only hope you find this
reply as useful.  The feature that changed in the versions you mentioned
is the method for retrieving data from the database.  A full discussion
on the old and new methods for retrieving data can be found at
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.sqlite.org/c_interface.html">http://www.sqlite.org/c_interface.html</a></span>.  DBD::SQLite switched from using
sqlite_exec, to using the replacement functions of sqlite_compile,
sqlite_step and sqlite_finalize.  Your problem was actually one
statement locking the database and not releasing the lock in time.  The
second problem was that the error message that is returned is incorrect.
 The attached patch contains a quick patch that, when applied, will
produce the following output from your sample program:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">______________________________________
LOOP 1
<div class="message-stanza open">______________________________________
LOOP 2
DBD::SQLite::st execute failed: database table is locked [for Statement
&#34;INSERT INTO words VALUES &#40;?,?,?&#41;&#34;] at ./SQLITE-ERROR.pl line 27.
<div class="message-stanza open">______________________________________
LOOP 3
DBD::SQLite::st execute failed: database table is locked [for Statement
&#34;INSERT INTO words VALUES &#40;?,?,?&#41;&#34;] at ./SQLITE-ERROR.pl line 27.

I hope this is helpful.
Uru
-Dave
</div></div></div></div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -Naur DBD-SQLite-0.31/vdbe.c new/vdbe.c
--- DBD-SQLite-0.31/vdbe.c	Sun Feb 15 06:14:50 2004
+++ new/vdbe.c	Sat May 22 20:07:42 2004
@@ -4809,6 +4809,7 @@
 vdbe_halt:
   if&#40; rc &#41;{
     p-&gt;rc = rc;
+    sqliteSetString&#40;&#38;p-&gt;zErrMsg, sqlite_error_string&#40;rc&#41;, &#40;char*&#41;0&#41;;
     rc = SQLITE_ERROR;
   }else{
     rc = SQLITE_DONE;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;22&nbsp;19:16:46&nbsp;2004</span>
    <span class="description">gmpassos [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Sat May 22 06:23:25 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; G&#39;day Graciliano,
&gt; Thank you for the excellent bug report.  I can only hope you find this
&gt; reply as useful.  The feature that changed in the versions you
&gt; mentioned
&gt; is the method for retrieving data from the database.  A full
&gt; discussion
&gt; on the old and new methods for retrieving data can be found at
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.sqlite.org/c_interface.html">http://www.sqlite.org/c_interface.html</a></span>.  DBD::SQLite switched from
&gt; using
&gt; sqlite_exec, to using the replacement functions of sqlite_compile,
&gt; sqlite_step and sqlite_finalize.  Your problem was actually one
&gt; statement locking the database and not releasing the lock in time.
&gt; The
</div>
Ok, this is the main problem, that the database/table is locked when I 
declare the STH. Note that in my example I have 2 sth,  the 1st is for 
insertion and the 2nd just make a select to get the name of the 
columns. So, the process is &#40;all over the same table&#41;:

1 STH1 -&gt; declared &#40;INSERT INTO...&#41;
2 STH2 -&gt; declared &#40;SELECT * FROM...&#41;
3 STH2 -&gt; executed
4 STH2 -&gt; is hloded in a cache table just in case to need to be used in 
the future.
5 STH1 -&gt; executed &#40;GOT ERROR!&#41;

Note that if I don&#39;t cache STH2 &#40;step 4&#41; I won&#39;t get the error for STH1.

So, STH2 is locking the table?! First, STH2 is not a insertion comand, 
is just a select and don&#39;t need lock. Second, after execute the command 
the table should be freed! The main idea to hold a STH, actually to 
exists STH in DBI, is to avoid the compilation of the SQL command each 
time that we need to make the same interaction. So, we really need to 
keep cache of STH working for SQLite or we will lose desempenho 
&#40;without talk aboute resources&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; second problem was that the error message that is returned is
&gt; incorrect.
&gt;  The attached patch contains a quick patch that, when applied, will
&gt; produce the following output from your sample program:
</div>
Thanks for the patch, but this is just fixing the alert message, and 
not the locking error that is not compatible with the DBI architecture.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ______________________________________
&gt; LOOP 1
&gt; ______________________________________
&gt; LOOP 2
&gt; DBD::SQLite::st execute failed: database table is locked [for
&gt; Statement
&gt; &#34;INSERT INTO words VALUES &#40;?,?,?&#41;&#34;] at ./SQLITE-ERROR.pl line 27.
&gt; ______________________________________
&gt; LOOP 3
&gt; DBD::SQLite::st execute failed: database table is locked [for
&gt; Statement
&gt; &#34;INSERT INTO words VALUES &#40;?,?,?&#41;&#34;] at ./SQLITE-ERROR.pl line 27.
&gt; 
&gt; I hope this is helpful.
&gt; Uru
&gt; -Dave
&gt; 
</div>
Regards,
Graciliano M. P.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;22&nbsp;23:06:27&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[GMPASSOS - Sat May 22 19:16:46 2004]:

[snip]

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So, STH2 is locking the table?! First, STH2 is not a insertion comand,
&gt; is just a select and don&#39;t need lock. Second, after execute the
&gt; command
&gt; the table should be freed! The main idea to hold a STH, actually to
&gt; exists STH in DBI, is to avoid the compilation of the SQL command each
&gt; time that we need to make the same interaction. So, we really need to
&gt; keep cache of STH working for SQLite or we will lose desempenho
&gt; &#40;without talk aboute resources&#41;.
</div>
I should have also mentioned that currently, DBD::SQLite starts a
transaction for _every_ statement, including when it is a SELECT type
statement.  As you point out, this is unnecessary.  If you check out Bug
5568 at <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/NoAuth/Bug.html?id=5568">http://rt.cpan.org/NoAuth/Bug.html?id=5568</a></span> you will find a patch
from chris@ex-parrot.com that is designed to fix this issue.  However, i
haven&#39;t tried it myself yet, so good luck and let us know how it goes!!! :&#41;

Uru
-Dave
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;24&nbsp;23:22:46&nbsp;2004</span>
    <span class="description">gmpassos [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The path have worked and seems that will not create problems, since it 
only add a new attribute/flag at imp_sth, that show if it&#39;s a select 
command or not.

My question is, DBD::SQLite should hanlde by it self the transactions, 
or force the user to always use a transaction?

With this architecture &#40;from version 0.31+&#41; I always need to be 
handling 1 transaction, I can&#39;t interpolate different process!

I think that some option to enable or disable this process at runtime 
need to be added. So, will be possible to use automatic transanctions 
or not.

About the patch, it can be added to DBD::SQLite, since we can see by 
the code that it won&#39;t create problems and is a simple fix. I actually 
strongly recommend to include this path now to DBD::SQLite, since by 
definition a consultation is not an operation that change data in the 
database and is not defined as a transaction by the design pattners. It 
will only be a transaction if we have multiple selections with 
references between them, that some change between this selections can 
make the final selection invalid. But in our case we have a unique 
selection, so, definitely is not a transaction.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [GMPASSOS - Sat May 22 19:16:46 2004]:
&gt; 
&gt; [snip]
&gt; 
<div class="message-stanza open">&gt; &gt; So, STH2 is locking the table?! First, STH2 is not a insertion
</div>&gt; comand,
<div class="message-stanza open">&gt; &gt; is just a select and don&#39;t need lock. Second, after execute the
&gt; &gt; command
&gt; &gt; the table should be freed! The main idea to hold a STH, actually to
&gt; &gt; exists STH in DBI, is to avoid the compilation of the SQL command
</div>&gt; each
<div class="message-stanza open">&gt; &gt; time that we need to make the same interaction. So, we really need
</div>&gt; to
<div class="message-stanza open">&gt; &gt; keep cache of STH working for SQLite or we will lose desempenho
&gt; &gt; &#40;without talk aboute resources&#41;.
</div>&gt; 
&gt; I should have also mentioned that currently, DBD::SQLite starts a
&gt; transaction for _every_ statement, including when it is a SELECT type
&gt; statement.  As you point out, this is unnecessary.  If you check out
&gt; Bug
&gt; 5568 at <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/NoAuth/Bug.html?id=5568">http://rt.cpan.org/NoAuth/Bug.html?id=5568</a></span> you will find a
&gt; patch
&gt; from chris@ex-parrot.com that is designed to fix this issue.  However,
&gt; i
&gt; haven&#39;t tried it myself yet, so good luck and let us know how it
&gt; goes!!! :&#41;
&gt; 
&gt; Uru
&gt; -Dave
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;24&nbsp;23:28:57&nbsp;2004</span>
    <span class="description">gmpassos [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Other thing, the patch own&#39;t fix the bug that I have reported! I&#39;m 
still unable to do this process:

1 STH1 -&gt; declared &#40;INSERT INTO...&#41;
2 STH2 -&gt; declared &#40;SELECT * FROM...&#41;
3 STH2 -&gt; executed
4 STH2 -&gt; is holded in a cache table just in case to need to be used in
the future.
5 STH1 -&gt; executed &#40;GOT ERROR!&#41;

A simple way to see that I still have this error is to disable 
autocommit, since we can see in this line at DBD-SQLite-0.31/dbdimp.c

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;    if &#40; &#40;!DBIc_is&#40;imp_dbh, DBIcf_AutoCommit&#41;&#41; &#38;&#38; &#40;!imp_dbh-
&gt;in_tran&#41; &#41; {
</div>

[guest - Sat May 22 23:06:27 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [GMPASSOS - Sat May 22 19:16:46 2004]:
&gt; 
&gt; [snip]
&gt; 
<div class="message-stanza open">&gt; &gt; So, STH2 is locking the table?! First, STH2 is not a insertion
</div>&gt; comand,
<div class="message-stanza open">&gt; &gt; is just a select and don&#39;t need lock. Second, after execute the
&gt; &gt; command
&gt; &gt; the table should be freed! The main idea to hold a STH, actually to
&gt; &gt; exists STH in DBI, is to avoid the compilation of the SQL command
</div>&gt; each
<div class="message-stanza open">&gt; &gt; time that we need to make the same interaction. So, we really need
</div>&gt; to
<div class="message-stanza open">&gt; &gt; keep cache of STH working for SQLite or we will lose desempenho
&gt; &gt; &#40;without talk aboute resources&#41;.
</div>&gt; 
&gt; I should have also mentioned that currently, DBD::SQLite starts a
&gt; transaction for _every_ statement, including when it is a SELECT type
&gt; statement.  As you point out, this is unnecessary.  If you check out
&gt; Bug
&gt; 5568 at <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/NoAuth/Bug.html?id=5568">http://rt.cpan.org/NoAuth/Bug.html?id=5568</a></span> you will find a
&gt; patch
&gt; from chris@ex-parrot.com that is designed to fix this issue.  However,
&gt; i
&gt; haven&#39;t tried it myself yet, so good luck and let us know how it
&gt; goes!!! :&#41;
&gt; 
&gt; Uru
&gt; -Dave
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;24&nbsp;23:52:07&nbsp;2004</span>
    <span class="description">gmpassos [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">To apply the patch on windows with VS C++ 6+ you need to add the 
function strncasecmp to the source. Here&#39;s the code for that compatible 
with gcc:

#ifndef HAVE_STRNCASECMP

#include &lt;string.h&gt;
#include &lt;ctype.h&gt;

int 
strncasecmp&#40;const char *s1, const char *s2, unsigned int n&#41;
{
        if &#40;n == 0&#41;
                return 0;

        while &#40;&#40;n-- != 0&#41;
            &#38;&#38; &#40;tolower&#40;*&#40;unsigned char *&#41;s1&#41; == tolower&#40;*&#40;unsigned 
char *&#41;s2&#41;&#41;&#41;
        {
                if &#40;n == 0 || *s1 == &#39;\0&#39; || *s2 == &#39;\0&#39;&#41;
                        return 0;
                s1++;
                s2++;
        }

        return tolower&#40;*&#40;unsigned char *&#41; s1&#41; - tolower&#40;*&#40;unsigned char 
*&#41; s2&#41;;
}

#endif


[GMPASSOS - Mon May 24 23:22:46 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The path have worked and seems that will not create problems, since it
&gt; only add a new attribute/flag at imp_sth, that show if it&#39;s a select
&gt; command or not.
&gt; 
&gt; My question is, DBD::SQLite should hanlde by it self the transactions,
&gt; or force the user to always use a transaction?
&gt; 
&gt; With this architecture &#40;from version 0.31+&#41; I always need to be
&gt; handling 1 transaction, I can&#39;t interpolate different process!
&gt; 
&gt; I think that some option to enable or disable this process at runtime
&gt; need to be added. So, will be possible to use automatic transanctions
&gt; or not.
&gt; 
&gt; About the patch, it can be added to DBD::SQLite, since we can see by
&gt; the code that it won&#39;t create problems and is a simple fix. I actually
&gt; strongly recommend to include this path now to DBD::SQLite, since by
&gt; definition a consultation is not an operation that change data in the
&gt; database and is not defined as a transaction by the design pattners.
&gt;    It
&gt; will only be a transaction if we have multiple selections with
&gt; references between them, that some change between this selections can
&gt; make the final selection invalid. But in our case we have a unique
&gt; selection, so, definitely is not a transaction.
&gt; 
<div class="message-stanza open">&gt; &gt; [GMPASSOS - Sat May 22 19:16:46 2004]:
&gt; &gt;
&gt; &gt; [snip]
&gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; So, STH2 is locking the table?! First, STH2 is not a insertion
</div>&gt; &gt; comand,
<div class="message-stanza open">&gt; &gt; &gt; is just a select and don&#39;t need lock. Second, after execute the
&gt; &gt; &gt; command
&gt; &gt; &gt; the table should be freed! The main idea to hold a STH, actually
</div></div>&gt;    to
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; exists STH in DBI, is to avoid the compilation of the SQL command
</div>&gt; &gt; each
<div class="message-stanza open">&gt; &gt; &gt; time that we need to make the same interaction. So, we really need
</div>&gt; &gt; to
<div class="message-stanza open">&gt; &gt; &gt; keep cache of STH working for SQLite or we will lose desempenho
&gt; &gt; &gt; &#40;without talk aboute resources&#41;.
</div>&gt; &gt;
&gt; &gt; I should have also mentioned that currently, DBD::SQLite starts a
&gt; &gt; transaction for _every_ statement, including when it is a SELECT
</div>&gt;    type
<div class="message-stanza open">&gt; &gt; statement.  As you point out, this is unnecessary.  If you check out
&gt; &gt; Bug
&gt; &gt; 5568 at <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/NoAuth/Bug.html?id=5568">http://rt.cpan.org/NoAuth/Bug.html?id=5568</a></span> you will find a
&gt; &gt; patch
&gt; &gt; from chris@ex-parrot.com that is designed to fix this issue.
</div>&gt;    However,
<div class="message-stanza open">&gt; &gt; i
&gt; &gt; haven&#39;t tried it myself yet, so good luck and let us know how it
&gt; &gt; goes!!! :&#41;
&gt; &gt;
&gt; &gt; Uru
&gt; &gt; -Dave
</div>&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;31&nbsp;15:51:54&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Chris Lightfoot &lt;chris [...] ex-parrot.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">You can use _strnicmp in Visual C/C++, rather than strncasecmp. The
prototype is the same.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;25&nbsp;15:32:49&nbsp;2004</span>
    <span class="description">msergeant [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;06&nbsp;14:32:41&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat May 22 19:16:46 2004, GMPASSOS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [guest - Sat May 22 06:23:25 2004]:
&gt; 
<div class="message-stanza open">&gt; &gt; G&#39;day Graciliano,
&gt; &gt; Thank you for the excellent bug report.  I can only hope you find this
&gt; &gt; reply as useful.  The feature that changed in the versions you
&gt; &gt; mentioned
&gt; &gt; is the method for retrieving data from the database.  A full
&gt; &gt; discussion
&gt; &gt; on the old and new methods for retrieving data can be found at
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.sqlite.org/c_interface.html">http://www.sqlite.org/c_interface.html</a></span>.  DBD::SQLite switched from
&gt; &gt; using
&gt; &gt; sqlite_exec, to using the replacement functions of sqlite_compile,
&gt; &gt; sqlite_step and sqlite_finalize.  Your problem was actually one
&gt; &gt; statement locking the database and not releasing the lock in time.
&gt; &gt; The
</div>&gt; 
&gt; Ok, this is the main problem, that the database/table is locked when I 
&gt; declare the STH. Note that in my example I have 2 sth,  the 1st is for 
&gt; insertion and the 2nd just make a select to get the name of the 
&gt; columns. So, the process is &#40;all over the same table&#41;:
&gt; 
&gt; 1 STH1 -&gt; declared &#40;INSERT INTO...&#41;
&gt; 2 STH2 -&gt; declared &#40;SELECT * FROM...&#41;
&gt; 3 STH2 -&gt; executed
&gt; 4 STH2 -&gt; is hloded in a cache table just in case to need to be used in 
&gt; the future.
&gt; 5 STH1 -&gt; executed &#40;GOT ERROR!&#41;
&gt; 
&gt; Note that if I don&#39;t cache STH2 &#40;step 4&#41; I won&#39;t get the error for STH1.
&gt; 
&gt; So, STH2 is locking the table?! First, STH2 is not a insertion comand, 
&gt; is just a select and don&#39;t need lock. Second, after execute the command 
&gt; the table should be freed! The main idea to hold a STH, actually to 
&gt; exists STH in DBI, is to avoid the compilation of the SQL command each 
&gt; time that we need to make the same interaction. So, we really need to 
&gt; keep cache of STH working for SQLite or we will lose desempenho 
&gt; &#40;without talk aboute resources&#41;.
&gt; 
<div class="message-stanza open">&gt; &gt; second problem was that the error message that is returned is
&gt; &gt; incorrect.
&gt; &gt;  The attached patch contains a quick patch that, when applied, will
&gt; &gt; produce the following output from your sample program:
</div>&gt; 
&gt; Thanks for the patch, but this is just fixing the alert message, and 
&gt; not the locking error that is not compatible with the DBI architecture.
&gt; 
<div class="message-stanza open">&gt; &gt; ______________________________________
&gt; &gt; LOOP 1
&gt; &gt; ______________________________________
&gt; &gt; LOOP 2
&gt; &gt; DBD::SQLite::st execute failed: database table is locked [for
&gt; &gt; Statement
&gt; &gt; &#34;INSERT INTO words VALUES &#40;?,?,?&#41;&#34;] at ./SQLITE-ERROR.pl line 27.
&gt; &gt; ______________________________________
&gt; &gt; LOOP 3
&gt; &gt; DBD::SQLite::st execute failed: database table is locked [for
&gt; &gt; Statement
&gt; &gt; &#34;INSERT INTO words VALUES &#40;?,?,?&#41;&#34;] at ./SQLITE-ERROR.pl line 27.
&gt; &gt; 
&gt; &gt; I hope this is helpful.
&gt; &gt; Uru
&gt; &gt; -Dave
&gt; &gt; 
</div>&gt; 
&gt; Regards,
&gt; Graciliano M. P.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;06&nbsp;14:32:42&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;07&nbsp;19:06:04&nbsp;2006</span>
    <span class="description">msergeant [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
