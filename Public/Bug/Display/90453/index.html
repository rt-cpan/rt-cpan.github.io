<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #90453 for IO-Socket-SSL: SSL fails after plain text + STARTTLS</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #90453 for IO-Socket-SSL: SSL fails after plain text + STARTTLS</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=IO-Socket-SSL">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=IO-Socket-SSL">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=IO-Socket-SSL">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=IO-Socket-SSL">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IO-Socket-SSL">IO-Socket-SSL CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">90453</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=IO-Socket-SSL">IO-Socket-SSL</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
klara.mall [...] kit.edu

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-17228-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-17229-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=90453">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1289142" href="/Public/Bug/Display.html?id=90453#txn-1289142">#</a>      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;17&nbsp;11:35:41&nbsp;2013</span>
    <span class="description">klara.mall [...] kit.edu -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SSL fails after plain text + STARTTLS</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 17 Nov 2013 17:35:22 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-IO-Socket-SSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Klara Mall &lt;klara.mall [...] kit.edu&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1289142/683072/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/683072">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 7.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I use the Perl software radiator &#40;RADIUS server&#41; where I
authenticate users with LDAP. With some LDAP servers I use an SSL
connection and with some plain text and STARTTLS. With this
configuration radiator told me from time to time that it could not
open the LDAP connection. I analyzed this and noticed that the first
SSL connection after using plaintext + STARTTLS fails. Rather the
verification of the certificate fails providing that you use two
different servers in the plain text / STARTTLS and the SSL
connection. 

I could reproduce this with a litte Perl program:

-----------------------------------------------------------------
#!/usr/bin/perl -w

use IO::Socket::SSL qw&#40;debug3&#41;;

my $tls_host = &#34;kit-dc-04.kit.edu&#34;;
my $ssl_host = &#34;kit-ad.scc.kit.edu&#34;;

require Net::LDAP;
my $ldap_tls = Net::LDAP-&gt;new&#40;
                            $tls_host,
                            port =&gt; 389,
                            timeout =&gt; 3&#41;;
$ldap_tls-&gt; start_tls&#40;
                            verify =&gt; &#39;require&#39;,
                            cafile =&gt; &#39;ca.pem&#39;&#41;;

require Net::LDAPS;
my $ldap_ssl = Net::LDAPS-&gt;new&#40;
                            $ssl_host,
                            port =&gt; 636,
                            timeout =&gt; 3,
                            verify =&gt; &#39;require&#39;,
                            cafile =&gt; &#39;ca.pem&#39;&#41;;

-----------------------------------------------------------------

Result:

-----------------------------------------------------------------
DEBUG: .../IO/Socket/SSL.pm:1653: new ctx 22392624
DEBUG: .../IO/Socket/SSL.pm:1061: start handshake
DEBUG: .../IO/Socket/SSL.pm:383: ssl handshake not started
DEBUG: .../IO/Socket/SSL.pm:433: set socket to non-blocking to enforce timeout=3
DEBUG: .../IO/Socket/SSL.pm:446: Net::SSLeay::connect -&gt; -1
DEBUG: .../IO/Socket/SSL.pm:456: ssl handshake in progress
DEBUG: .../IO/Socket/SSL.pm:466: waiting for fd to become ready: SSL wants a read first
DEBUG: .../IO/Socket/SSL.pm:486: socket ready, retrying connect
DEBUG: .../IO/Socket/SSL.pm:446: Net::SSLeay::connect -&gt; -1
DEBUG: .../IO/Socket/SSL.pm:456: ssl handshake in progress
DEBUG: .../IO/Socket/SSL.pm:466: waiting for fd to become ready: SSL wants a read first
DEBUG: .../IO/Socket/SSL.pm:486: socket ready, retrying connect
DEBUG: .../IO/Socket/SSL.pm:1641: ok=1 cert=22397184
DEBUG: .../IO/Socket/SSL.pm:1641: ok=1 cert=22521520
DEBUG: .../IO/Socket/SSL.pm:1641: ok=1 cert=22513408
DEBUG: .../IO/Socket/SSL.pm:1641: ok=1 cert=22421632
DEBUG: .../IO/Socket/SSL.pm:1201: scheme=ldap cert=22421632
DEBUG: .../IO/Socket/SSL.pm:1210: identity=kit-dc-04.kit.edu cn=kit-dc-04.kit.edu alt=2 kit-dc-04.kit.edu 2 kit-dc.kit.edu
DEBUG: .../IO/Socket/SSL.pm:446: Net::SSLeay::connect -&gt; -1
DEBUG: .../IO/Socket/SSL.pm:456: ssl handshake in progress
DEBUG: .../IO/Socket/SSL.pm:466: waiting for fd to become ready: SSL wants a read first
DEBUG: .../IO/Socket/SSL.pm:486: socket ready, retrying connect
DEBUG: .../IO/Socket/SSL.pm:446: Net::SSLeay::connect -&gt; 1
DEBUG: .../IO/Socket/SSL.pm:501: ssl handshake done
DEBUG: .../IO/Socket/SSL.pm:1653: new ctx 22444320
DEBUG: .../IO/Socket/SSL.pm:363: socket not yet connected
DEBUG: .../IO/Socket/SSL.pm:365: socket connected
DEBUG: .../IO/Socket/SSL.pm:383: ssl handshake not started
DEBUG: .../IO/Socket/SSL.pm:433: set socket to non-blocking to enforce timeout=3
DEBUG: .../IO/Socket/SSL.pm:446: Net::SSLeay::connect -&gt; -1
DEBUG: .../IO/Socket/SSL.pm:456: ssl handshake in progress
DEBUG: .../IO/Socket/SSL.pm:466: waiting for fd to become ready: SSL wants a read first
DEBUG: .../IO/Socket/SSL.pm:486: socket ready, retrying connect
DEBUG: .../IO/Socket/SSL.pm:1641: ok=1 cert=22556704
DEBUG: .../IO/Socket/SSL.pm:1641: ok=1 cert=22677424
DEBUG: .../IO/Socket/SSL.pm:1641: ok=1 cert=22669216
DEBUG: .../IO/Socket/SSL.pm:1641: ok=1 cert=22570864
DEBUG: .../IO/Socket/SSL.pm:1201: scheme=ldap cert=22570864
DEBUG: .../IO/Socket/SSL.pm:1210: identity=kit-dc-04.kit.edu cn=kit-ad.scc.kit.edu alt=1 f5@scc.kit.edu
DEBUG: .../IO/Socket/SSL.pm:446: Net::SSLeay::connect -&gt; -1
DEBUG: .../IO/Socket/SSL.pm:1328: SSL connect attempt failed with unknown error error:14090086:SSL routines:SSL3_GET_SERVER_CERTIFICATE:certificate verify failed

DEBUG: .../IO/Socket/SSL.pm:452: fatal SSL error: SSL connect attempt failed with unknown error error:14090086:SSL routines:SSL3_GET_SERVER_CERTIFICATE:certificate verify failed
DEBUG: .../IO/Socket/SSL.pm:1328: IO::Socket::IP configuration failed error:00000000:lib&#40;0&#41;:func&#40;0&#41;:reason&#40;0&#41;

DEBUG: .../IO/Socket/SSL.pm:1690: free ctx 22444320 open=22444320 22392624
DEBUG: .../IO/Socket/SSL.pm:1695: free ctx 22444320 callback
DEBUG: .../IO/Socket/SSL.pm:1698: OK free ctx 22444320
DEBUG: .../IO/Socket/SSL.pm:1690: free ctx 22392624 open=22392624
DEBUG: .../IO/Socket/SSL.pm:1695: free ctx 22392624 callback
DEBUG: .../IO/Socket/SSL.pm:1698: OK free ctx 22392624
-----------------------------------------------------------------

To understand the problem I had a look at SSL.pm from
IO::Socket:SSL. As far as I understand SSL variables which are not
set are overriden with global variables. So I moved this code block
somewhat down which fixes it. &#40;Although I&#39;m wondering if the
identity should be overriden with a global variable at all.&#41;

I&#39;m using IO::Socket:SSL 1.74 from Debian wheezy, but I also
installed the recent version 1.959. It&#39;s the same problem although
the code is a bit different.


Fix for version 1.74 &#40;Debian wheezy&#41;:

-----------------------------------------------------------
--- SSL.pm.orig 2013-11-13 02:11:46.752935483 +0100
+++ SSL.pm      2013-11-13 02:12:44.413920483 +0100
@@ -291,9 +291,6 @@
                }
        }
 
-       #Replace nonexistent entries with defaults
-       %$arg_hash = &#40; %default_args, %$GLOBAL_CONTEXT_ARGS, %$arg_hash &#41;;
-
        #Avoid passing undef arguments to Net::SSLeay
        defined&#40;$arg_hash-&gt;{$_}&#41; or delete&#40;$arg_hash-&gt;{$_}&#41; foreach &#40;keys %$arg_hash&#41;;
 
@@ -327,6 +324,9 @@
                        return $rv;
                };
        }
+       
+       #Replace nonexistent entries with defaults
+       %$arg_hash = &#40; %default_args, %$GLOBAL_CONTEXT_ARGS, %$arg_hash &#41;;
 
        ${*$self}{&#39;_SSL_arguments&#39;} = $arg_hash;
        ${*$self}{&#39;_SSL_ctx&#39;} = IO::Socket::SSL::SSL_Context-&gt;new&#40;$arg_hash&#41; || return;
-----------------------------------------------------------

Fix for recent version 1.959:

-----------------------------------------------------------
--- SSL.pm.orig 2013-11-13 02:05:17.658251025 +0100
+++ SSL.pm      2013-11-13 02:04:55.129862855 +0100
@@ -300,13 +300,6 @@
        $is_server = $arg_hash-&gt;{SSL_server} = $arg_hash-&gt;{Listen} || 0;
     }
 
-    # add user defined defaults
-    %$arg_hash = &#40;
-       %$GLOBAL_SSL_ARGS,
-       $is_server ? %$GLOBAL_SSL_SERVER_ARGS : %$GLOBAL_SSL_CLIENT_ARGS,
-       %$arg_hash
-    &#41;;
-
     my $ctx = $arg_hash-&gt;{&#39;SSL_reuse_ctx&#39;};
     if &#40;$ctx&#41; {
        if &#40;$ctx-&gt;isa&#40;&#39;IO::Socket::SSL::SSL_Context&#39;&#41; and
@@ -320,6 +313,13 @@
     # create context
     # this will fill in defaults in $arg_hash
     $ctx ||= IO::Socket::SSL::SSL_Context-&gt;new&#40;$arg_hash&#41;;
+    
+    # add user defined defaults
+    %$arg_hash = &#40;
+       %$GLOBAL_SSL_ARGS,
+       $is_server ? %$GLOBAL_SSL_SERVER_ARGS : %$GLOBAL_SSL_CLIENT_ARGS,
+       %$arg_hash
+    &#41;;
 
     ${*$self}{&#39;_SSL_arguments&#39;} = $arg_hash;
     ${*$self}{&#39;_SSL_ctx&#39;} = $ctx;
-----------------------------------------------------------

Don&#39;t know if these fixes are ok, but I think they show where the
problem resides.

BTW: For testing I installed libnet-ldap-perl from Debian squeeze
and it works. As it seems the reason is that the part of the
IO::Socket::SSL code with the identity is not used &#40;no DEBUG output
for this&#41;.

Is this a bug in IO::Socket::SSL? It would be nice if you check
what&#39;s the problem here.

Thanks in advance
Klara

-- 
Karlsruher Institut für Technologie &#40;KIT&#41;
Steinbuch Centre for Computing &#40;SCC&#41;

Klara Mall
Netze und Telekommunikation &#40;NET&#41;
Hermann-von-Helmholtz-Platz 1
76344 Eggenstein-Leopoldshafen
Telefon: +49 721 608-28630
Telefon: +49 721 608-48946
E-Mail: klara.mall@kit.edu
Web: <span class="clickylink"><a target="new" rel="nofollow" href="http://www.scc.kit.edu">http://www.scc.kit.edu</a></span>

KIT - Universität des Landes Baden-Württemberg und
nationales Forschungszentrum in der Helmholtz-Gemeinschaft
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1289151" href="/Public/Bug/Display.html?id=90453#txn-1289151">#</a>      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;17&nbsp;13:29:48&nbsp;2013</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SSL fails after plain text + STARTTLS &#40;certificate does not match
 hostname&#41;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1289151/683076/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/683076">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; my $tls_host = &#34;kit-dc-04.kit.edu&#34;;
&gt; my $ssl_host = &#34;kit-ad.scc.kit.edu&#34;;
&gt; ...
&gt; DEBUG: .../IO/Socket/SSL.pm:1210: identity=kit-dc-04.kit.edu cn=kit-
&gt; ad.scc.kit.edu alt=1 f5@scc.kit.edu
&gt; DEBUG: .../IO/Socket/SSL.pm:446: Net::SSLeay::connect -&gt; -1
&gt; DEBUG: .../IO/Socket/SSL.pm:1328: SSL connect attempt failed with
&gt; unknown error error:14090086:SSL
&gt; routines:SSL3_GET_SERVER_CERTIFICATE:certificate verify failed
</div>
Hi,

you can see in the debug output:
...identity=kit-dc-04.kit.edu cn=kit-ad.scc.kit.edu alt=1 f5@scc.kit.edu

This means, that you access the server as &#34;kit-dc-04.kit.edu&#34;, but the certificate in the server has a commonName of &#34;kit-ad.scc.kit.edu&#34;, which is different from the name you use to access the server. Furthermore an alternative name is provided in the certificate, but this is not a DNS name but an email &#39;f5@scc.kit.edu&#39; &#40;general name type 1: GEN_EMAIL&#41;. 
But, the verification scheme for ldap  requires the hostname to match either the commonName or the subjectAltName. If none of these match the verification fails.

So the problem is not with IO::Socket::SSL, it&#39;s with either the hostname you use or the certificate provided by the hostname.
You get the same kind of problem in your webbrowser: for example accessing <span class="clickylink"><a target="new" rel="nofollow" href="https://comdirect.de">https://comdirect.de</a></span> currently gives you an error, because it returns a certificate, which matches only &#34;www.comdirect.de&#34;, but not &#34;comdirect.de&#34;.

Regards,
Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1289152" href="/Public/Bug/Display.html?id=90453#txn-1289152">#</a>      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;17&nbsp;13:29:48&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1289155" href="/Public/Bug/Display.html?id=90453#txn-1289155">#</a>      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;17&nbsp;13:29:49&nbsp;2013</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1289167" href="/Public/Bug/Display.html?id=90453#txn-1289167">#</a>      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;17&nbsp;13:58:12&nbsp;2013</span>
    <span class="description">klara.mall [...] kit.edu -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &#34;behroozi [...] www.pls.uni.edu&#34; &lt;behroozi [...] www.pls.uni.edu&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #90453] SSL fails after plain text + STARTTLS &#40;certificate does not match  hostname&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 17 Nov 2013 19:57:56 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Steffen Ullrich via RT &lt;bug-IO-Socket-SSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Klara Mall &lt;klara.mall [...] kit.edu&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1289167/683085/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/683085">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Steffen,

On Sun, Nov 17, 2013 at 07:29:48PM +0100, Steffen Ullrich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=90453">https://rt.cpan.org/Ticket/Display.html?id=90453</a></span> &gt;
&gt; 
&gt; 
&gt; 
<div class="message-stanza open">&gt; &gt; my $tls_host = &#34;kit-dc-04.kit.edu&#34;;
&gt; &gt; my $ssl_host = &#34;kit-ad.scc.kit.edu&#34;;
&gt; &gt; ...
&gt; &gt; DEBUG: .../IO/Socket/SSL.pm:1210: identity=kit-dc-04.kit.edu cn=kit-
&gt; &gt; ad.scc.kit.edu alt=1 f5@scc.kit.edu
&gt; &gt; DEBUG: .../IO/Socket/SSL.pm:446: Net::SSLeay::connect -&gt; -1
&gt; &gt; DEBUG: .../IO/Socket/SSL.pm:1328: SSL connect attempt failed with
&gt; &gt; unknown error error:14090086:SSL
&gt; &gt; routines:SSL3_GET_SERVER_CERTIFICATE:certificate verify failed
</div>&gt; 
&gt; Hi,
&gt; 
&gt; you can see in the debug output:
&gt; ...identity=kit-dc-04.kit.edu cn=kit-ad.scc.kit.edu alt=1 f5@scc.kit.edu
&gt; 
&gt; This means, that you access the server as &#34;kit-dc-04.kit.edu&#34;, but the certificate in the server has a commonName of &#34;kit-ad.scc.kit.edu&#34;, which is different from the name you use to access the server. Furthermore an alternative name is provided in the certificate, but this is not a DNS name but an email &#39;f5@scc.kit.edu&#39; &#40;general name type 1: GEN_EMAIL&#41;. 
</div>
No, that&#39;s not the problem. Please reread my code. I connect to
kit-ad.scc.kit.edu. That are two different servers:
kit-dc-04.kit.edu has &#34;kit-dc-04.kit.edu&#34; as common name and
kit-ad.scc.kit.edu has &#34;kit-ad.scc.kit.edu&#34; as common name in its
certificate.

First I connect to kit-dc-04.kit.edu with plain text / STARTTLS
&#40;success&#41; and then to kit-ad.scc.kit.edu with SSL &#40;failure&#41; because
identity is set to kit-dc-04.kit.edu &#40;if I connect to
kit-dc-05.kit.edu first, then identity is set to kit-dc-05.kit.edu&#41;.

If I only connect with SSL to kit-ad.scc.kit.edu &#40;without
connecting to a different server before with plain text + STARTTLS -
in this case kit-dc-04.kit.edu&#41; there is no problem.

Please try to reproduce this. It is reproducible for me with
arbitrary servers.

Kind Regards
Klara
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1289183" href="/Public/Bug/Display.html?id=90453#txn-1289183">#</a>      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;17&nbsp;14:56:23&nbsp;2013</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1289183/683096/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/683096">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; No, that&#39;s not the problem. Please reread my code. I connect to
&gt; kit-ad.scc.kit.edu. That are two different servers:
&gt; kit-dc-04.kit.edu has &#34;kit-dc-04.kit.edu&#34; as common name and
&gt; kit-ad.scc.kit.edu has &#34;kit-ad.scc.kit.edu&#34; as common name in its
&gt; certificate.
</div>
Now I understand your problem.
From my understanding it is a bug in Net::LDAP. In Net::LDAP::start_tls it applies the ssl specific settings, including SSL_verifycn_name, not only to the socket, but globally:

1053 sub start_tls {
...
1085   IO::Socket::SSL::context_init&#40; { _SSL_context_init_args&#40;$arg&#41; } &#41;;
1086   my $sock_class = ref&#40;$sock&#41;;
1087 
1088   return $mesg
1089     if IO::Socket::SSL-&gt;start_SSL&#40;$sock, {_SSL_context_init_args&#40;$arg&#41;}&#41;;

The line 1085 is what causes the problem.
Additionally SSL_verifycn_name is only set if _SSL_context_init_args is called from within start_tls, not from connect_ldaps &#40;e.g. Net::LDAPS-&gt;new&#41;. So the latter call to Net::LDAPS-&gt;new will reuse the hostname for verification from the earlier start_tls call.


Because in line 1089 the SSL upgrade of the socket is done with all SSL specific settings &#40;which only apply to the socket&#41; there should be no need for the global settings at all, so line 1085 should simply be removed.

The code in IO::Socket::SSL is at least in this regard correct: because the default and global ssl settings need to be applied when creating the socket &#40;e.g. ciphers...&#41; they must be mixed into the user supplied args before creating the socket. 

So please try to remove line 1085 from Net::LDAP and see if it fixes the problem.
Then file the bug against Net::LDAP :&#41;

Regards,
Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1289214" href="/Public/Bug/Display.html?id=90453#txn-1289214">#</a>      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;17&nbsp;16:01:37&nbsp;2013</span>
    <span class="description">klara.mall [...] kit.edu -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &#34;behroozi [...] www.pls.uni.edu&#34; &lt;behroozi [...] www.pls.uni.edu&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #90453] SSL fails after plain text + STARTTLS</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 17 Nov 2013 22:01:20 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Steffen Ullrich via RT &lt;bug-IO-Socket-SSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Klara Mall &lt;klara.mall [...] kit.edu&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1289214/683111/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/683111">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Steffen,

On Sun, Nov 17, 2013 at 08:56:24PM +0100, Steffen Ullrich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=90453">https://rt.cpan.org/Ticket/Display.html?id=90453</a></span> &gt;
&gt; 
&gt; 
<div class="message-stanza open">&gt; &gt; No, that&#39;s not the problem. Please reread my code. I connect to
&gt; &gt; kit-ad.scc.kit.edu. That are two different servers:
&gt; &gt; kit-dc-04.kit.edu has &#34;kit-dc-04.kit.edu&#34; as common name and
&gt; &gt; kit-ad.scc.kit.edu has &#34;kit-ad.scc.kit.edu&#34; as common name in its
&gt; &gt; certificate.
</div>&gt; 
&gt; Now I understand your problem.
&gt; From my understanding it is a bug in Net::LDAP. In Net::LDAP::start_tls it applies the ssl specific settings, including SSL_verifycn_name, not only to the socket, but globally:
&gt; 
&gt; 1053 sub start_tls {
&gt; ...
&gt; 1085   IO::Socket::SSL::context_init&#40; { _SSL_context_init_args&#40;$arg&#41; } &#41;;
&gt; 1086   my $sock_class = ref&#40;$sock&#41;;
&gt; 1087 
&gt; 1088   return $mesg
&gt; 1089     if IO::Socket::SSL-&gt;start_SSL&#40;$sock, {_SSL_context_init_args&#40;$arg&#41;}&#41;;
&gt; 
&gt; The line 1085 is what causes the problem.
&gt; Additionally SSL_verifycn_name is only set if _SSL_context_init_args is called from within start_tls, not from connect_ldaps &#40;e.g. Net::LDAPS-&gt;new&#41;. So the latter call to Net::LDAPS-&gt;new will reuse the hostname for verification from the earlier start_tls call.
&gt; 
&gt; 
&gt; Because in line 1089 the SSL upgrade of the socket is done with all SSL specific settings &#40;which only apply to the socket&#41; there should be no need for the global settings at all, so line 1085 should simply be removed.
&gt; 
&gt; The code in IO::Socket::SSL is at least in this regard correct: because the default and global ssl settings need to be applied when creating the socket &#40;e.g. ciphers...&#41; they must be mixed into the user supplied args before creating the socket. 
&gt; 
&gt; So please try to remove line 1085 from Net::LDAP and see if it fixes the problem.
&gt; Then file the bug against Net::LDAP :&#41;
</div>
Thank you very much for the detailed explanation. Removing that
line fixes it. :&#41;

Filed the bug against Net::LDAP:
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=90459">https://rt.cpan.org/Ticket/Display.html?id=90459</a></span>

Regards
Klara
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.399783</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
