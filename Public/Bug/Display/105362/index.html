<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #105362 for Devel-Confess: Original references + stack trace when non-object references are thrown</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #105362 for Devel-Confess: Original references + stack trace when non-object references are thrown</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Devel-Confess/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Devel-Confess/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Devel-Confess/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Devel-Confess/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Devel-Confess">Devel-Confess CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">105362</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Devel-Confess/Active/">Devel-Confess</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
PERLANCAR [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-251956-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-251957-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;18&nbsp;23:47:07&nbsp;2015</span>
    <span class="description">PERLANCAR [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Original references + stack trace when non-object references are
 thrown</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">For non-references:

    # trapping
    % perl -d:Confess -MData::Dump -E&#39;sub f { die &#34;Not found&#34; }; eval { f }; dd $@&#39;
    &#34;Not found at -e line 1.\n\tmain::f&#40;&#41; called at -e line 1\n\teval {...} called at -e line 1\n&#34;

    # rethrowing
    % perl -d:Confess -MData::Dump -E&#39;sub f { die &#34;Not found&#34; }; eval { f }; die&#39;
    Not found at -e line 1.
            main::f&#40;&#41; called at -e line 1
            eval {...} called at -e line 1
            ...propagated at -e line 1.

For non-object references:

    # trapping &#40;the original reference is returned, but no stack trace information&#41;
    % perl -d:Confess -MData::Dump -E&#39;sub f { die [404,&#34;Not found&#34;] }; eval { f }; dd $@&#39;
    [404, &#34;Not found&#34;]

    % perl -d:Confess -MData::Dump -E&#39;sub f { die [404,&#34;Not found&#34;] }; eval { f }; die&#39;
    ARRAY&#40;0xb6f160&#41; at -e line 1.

Is there a way to get both the stack trace and the original reference, so I can rethrow and still retain the original stack trace? Perhaps by wrapping the exception using on object &#40;I see from the source code that Devel::Confess already does this kind of trick, albeit only for objects?&#41;. Imagined interface:

    # trapping &#40;the original reference is returned, but no stack trace information&#41;
    % perl -d:Confess=wrap_ref -MData::Dump -E&#39;sub f { die [404,&#34;Not found&#34;] }; eval { f }; dd $@&#39;
    bless&#40;{message&gt;[400, &#34;Not found&#34;], stack_trace=&gt;...}, &#34;Devel::Confess::Wrapper&#34;&#41;

    # rethrow
    % perl -d:Confess=wrap_ref -MData::Dump -E&#39;sub f { die [404,&#34;Not found&#34;] }; eval { f }; die&#39;
    ARRAY&#40;0xb6f160&#41; at -e line 1.
            main::f&#40;&#41; called at -e line 1
            eval {...} called at -e line 1
            ...propagated at -e line 1.

    # rethrow after formatting the message
    % perl -d:Confess=wrap_ref -MData::Dump -E&#39;sub f { die [404,&#34;Not found&#34;] }; eval { f }; $err = $@; $err-&gt;message = &#34;&lt;color&gt;ERROR &#34;.$err-&gt;message-&gt;[0].&#34;: &#34;.$err-&gt;message-&gt;[1].&#34;&lt;/color&gt;&#34;; die $err&#39;
    &#34;&lt;color&gt;ERROR 404: Not found&lt;/color&gt;&#34; at -e line 1.
            main::f&#40;&#41; called at -e line 1
            eval {...} called at -e line 1
            ...propagated at -e line 1.

Or do you think this use-case is too specific? Admittedly, I&#39;ve very seldom encountered other people&#39;s code where it uses non-object refs as exception. I use this technique myself in my CLI framework &#40;Perinci::CmdLine::Lite&#41;.

Regards,
perlancar
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;18&nbsp;23:53:57&nbsp;2015</span>
    <span class="description">PERLANCAR [...] cpan.org -  Severity Wishlist added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;00:25:15&nbsp;2015</span>
    <span class="description">PERLANCAR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Upon reading your blog post <span class="clickylink"><a target="new" rel="nofollow" href="http://blogs.perl.org/users/graham_knop/2013/09/carp-always-evenobjects.html">http://blogs.perl.org/users/graham_knop/2013/09/carp-always-evenobjects.html</a></span> and further look into the source code, it looks like this case is already handled. I can get the original exception from $Devel::Confess::EXCEPTIONS{ refaddr&#40;$ref&#41; } and the stack trace in $Devel::Confess::MESSAGES{ refaddr&#40;$ref&#41; }. Neat.

Sorry for the noise.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;00:25:16&nbsp;2015</span>
    <span class="description">PERLANCAR [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;00:25:17&nbsp;2015</span>
    <span class="description">PERLANCAR [...] cpan.org -  Fixed in 0.003000 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;00:25:40&nbsp;2015</span>
    <span class="description">PERLANCAR [...] cpan.org -  Status changed from &#39;resolved&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;01:59:33&nbsp;2015</span>
    <span class="description">haarg [...] haarg.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">There is a bit of a bug here.  The code was intended to pick up the initial stack trace if a non-object reference was rethrown at the top level.  I&#39;ll fix that.

Turning non-object references into objects is too much of a change to the exception for me to do.  So the only real option is to track the information externally.  And that limits my options for retrieving the information.  The only reliable option I can do for the general case is to check if we are not in an eval, in which case we can modify the output freely.

I wouldn&#39;t recommend using the %MESSAGES hash.  It isn&#39;t part of the API and could easily be changed in future releases.  I would have kept it as a lexical, but I needed the longer lifetime that a package variable gives you.  If you still need access to that information after I fix the initial issue, I&#39;ll have to think further about a proper way to provide it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;02:45:20&nbsp;2015</span>
    <span class="description">PERLANCAR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ok noted. BTW, here&#39;s how I&#39;m retrieving the stack trace:

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/perlancar/perl-Perinci-CmdLine-Lite/commit/07d8c4616bfa042ed73e710ac5e85d12b88d0dcd">https://github.com/perlancar/perl-Perinci-CmdLine-Lite/commit/07d8c4616bfa042ed73e710ac5e85d12b88d0dcd</a></span>

Basically, it just appends the stack trace &#40;from $MESSAGES{$id}&#41; to the error message &#40;$err-&gt;[1]&#41;.

Example of how this plays out:

* without -d:Confess:

$ perl -MPerinci::CmdLine::Lite -E&#39;Perinci::CmdLine::Lite-&gt;new&#40;url=&gt;&#34;/Perinci/Examples/gen_array&#34;, subcommands=&gt;sub{&#34;blah&#34;}&#41;-&gt;run&#39;
ERROR 500: BUG: Subcommands code didn&#39;t return a hashref

$ perl -MPerinci::CmdLine::Lite -E&#39;Perinci::CmdLine::Lite-&gt;new&#40;url=&gt;&#34;/Perinci/Examples/gen_array&#34;, subcommands=&gt;sub{&#34;blah&#34;}&#41;-&gt;run&#39; -- --json
[
   500,
   &#34;BUG: Subcommands code didn&#39;t return a hashref&#34;,
   null,
   {}
]

s$ perl -d:Confess -MPerinci::CmdLine::Lite -E&#39;Perinci::CmdLine::Lite-&gt;new&#40;url=&gt;&#34;/Perinci/Examples/gen_array&#34;, subcommands=&gt;sub{&#34;blah&#34;}&#41;-&gt;run&#39;
ERROR 500: BUG: Subcommands code didn&#39;t return a hashref
 at /home/s1/perl5/perlbrew/perls/perl-5.22.0/lib/site_perl/5.22.0/Perinci/CmdLine/Base.pm line 406.
        Perinci::CmdLine::Base::list_subcommands&#40;Perinci::CmdLine::Lite=HASH&#40;0x1da0580&#41;&#41; called at /home/s1/perl5/perlbrew/perls/perl-5.22.0/lib/site_perl/5.22.0/Perinci/CmdLine/Lite.pm line 511
        Perinci::CmdLine::Lite::action_help&#40;Perinci::CmdLine::Lite=HASH&#40;0x1da0580&#41;, HASH&#40;0x1fc2248&#41;&#41; called at /home/s1/perl5/perlbrew/perls/perl-5.22.0/lib/site_perl/5.22.0/Perinci/CmdLine/Base.pm line 1185
        eval {...} called at /home/s1/perl5/perlbrew/perls/perl-5.22.0/lib/site_perl/5.22.0/Perinci/CmdLine/Base.pm line 1143
        Perinci::CmdLine::Base::run&#40;Perinci::CmdLine::Lite=HASH&#40;0x1da0580&#41;&#41; called at -e line 1

$ perl -d:Confess -MPerinci::CmdLine::Lite -E&#39;Perinci::CmdLine::Lite-&gt;new&#40;url=&gt;&#34;/Perinci/Examples/gen_array&#34;, subcommands=&gt;sub{&#34;blah&#34;}&#41;-&gt;run&#39; -- --json
[
   500,
   &#34;BUG: Subcommands code didn&#39;t return a hashref\n at /home/s1/perl5/perlbrew/perls/perl-5.22.0/lib/site_perl/5.22.0/Perinci/CmdLine/Base.pm line 406.\n\tPerinci::CmdLine::Base::list_subcommands&#40;Perinci::CmdLine::Lite=HASH&#40;0x1e78580&#41;&#41; called at /home/s1/perl5/perlbrew/perls/perl-5.22.0/lib/site_perl/5.22.0/Perinci/CmdLine/Lite.pm line 511\n\tPerinci::CmdLine::Lite::action_help&#40;Perinci::CmdLine::Lite=HASH&#40;0x1e78580&#41;, HASH&#40;0x21d4cd0&#41;&#41; called at /home/s1/perl5/perlbrew/perls/perl-5.22.0/lib/site_perl/5.22.0/Perinci/CmdLine/Base.pm line 1185\n\teval {...} called at /home/s1/perl5/perlbrew/perls/perl-5.22.0/lib/site_perl/5.22.0/Perinci/CmdLine/Base.pm line 1143\n\tPerinci::CmdLine::Base::run&#40;Perinci::CmdLine::Lite=HASH&#40;0x1e78580&#41;&#41; called at -e line 1&#34;,
   null,
   {}
]

Regards,
perlancar
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;26&nbsp;02:58:43&nbsp;2015</span>
    <span class="description">haarg [...] haarg.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve released 0.008000, which will include a stack trace with a ref that has been rethrown if the output is going to the screen.

It will also dumper refs and objects without stringify overloads if the dump option is enabled and the output is going to the screen.

I&#39;m still hesitant to include an API for getting a stack trace for a given exception, as this module wasn&#39;t designed to really have an API at all.  I&#39;ll still consider it for the future though.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;26&nbsp;02:58:44&nbsp;2015</span>
    <span class="description">haarg [...] haarg.org -  Status changed from &#39;rejected&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;26&nbsp;02:58:45&nbsp;2015</span>
    <span class="description">haarg [...] haarg.org -  Fixed in 0.003000 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
