<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #66437 for Test-TCP: Tests are blocking in Windows 7</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #66437 for Test-TCP: Tests are blocking in Windows 7</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Test-TCP">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Test-TCP">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Test-TCP">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Test-TCP">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/tokuhirom/Test-TCP/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Test-TCP">Test-TCP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">66437</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Test-TCP">Test-TCP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bo.johansson [...] lsn.se

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-223460-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.12    </td>
  </tr>
  <tr id="CF-223461-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=66437">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-907549" href="/Public/Bug/Display.html?id=66437#txn-907549">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;07&nbsp;03:16:15&nbsp;2011</span>
    <span class="description">bo.johansson [...] lsn.se -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Tests are blocking in Windows 7</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/907549/470790/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/470790">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am using:
* Strawberry-perl-5.12.2.0
* Perl 5, version 12, subversion 2 &#40;v5.12.2&#41; built for
MSWin32-x86-multi-thread
* Windows 7 Home Premium with Service Pack 1

I have used version 1.11 and 1.12 of Test::TCP

Problem:
The test in Test::TCP is blocking. Get the system in state, that it
must be restarted.
It is sometimes not possible to kill the blocked processes.
I even get errors like “Can&#39;t spawn &#34;cmd.exe&#34;” when using the system
call. It indicates a degeneration of the perl interpreter.

Tries and errors:

I have tried a lot of changes and also tried to find out what the real
problem is. But i have not succeeded.
Probably there is a problem in the emulation of fork in Windows.

I have found by adding &#34;sleep 1;&#34; in some places there is an
improvement. I think that it is not the delay, but that it cause a
&#34;context change&#34; in the fork emulation that is important.

I have also tried to add a &#34;sleep 1;&#34; in the destructor. It gives some
improvements but is not enough.
sub DESTROY {
    my $self = shift;
    local $@;
    sleep 1; #added gives some improvement
    $self-&gt;stop&#40;&#41;;
}

In several tests it is necessary to add an explicit shutdown of the server

         t::Server-&gt;new&#40;$port&#41;-&gt;run&#40;sub {
             note &#34;new request&#34;;
             my &#40;$remote, $line, $sock&#41; = @_;
+            if &#40;$line eq &#34;quit\n&#34;&#41;{
+                exit 0;
+            };
             print {$remote} $line;
         }&#41;;
     },



An alternative is to make test_tcp to return the $server.

sub test_tcp {

    .....

    $args{client}-&gt;&#40;$server-&gt;port, $server-&gt;pid&#41;;
    #undef $server; # make sure REMOVED
    return $server; # ADDED
}

This makes it possible to do the shout down in the tests in this way

my $object = test_tcp ....

$object-&gt;stop;

Using the object oriented way of calling this technique can be used

In t/10_oo.t I have done the changes:

-print {$sock} &#34;quit\n&#34;;
+$server-&gt;stop;


Patch with proposed changes:

diff -u -r t.orig/01_simple.t t/01_simple.t
--- t.orig/01_simple.t  2010-08-15 16:21:39.000000000 +0200
+++ t/01_simple.t       2011-03-06 20:04:45.875400000 +0100
@@ -27,6 +27,7 @@
 
         note &#34;finalize&#34;;
         print {$sock} &#34;quit\n&#34;;
+        sleep 1;
     },
     server =&gt; sub {
         my $port = shift;
@@ -34,8 +35,13 @@
         t::Server-&gt;new&#40;$port&#41;-&gt;run&#40;sub {
             note &#34;new request&#34;;
             my &#40;$remote, $line, $sock&#41; = @_;
+            if &#40;$line eq &#34;quit\n&#34;&#41;{
+                exit 0;
+            };
             print {$remote} $line;
         }&#41;;
     },
 &#41;;
 
+warn $$;
+
diff -u -r t.orig/08_exit.t t/08_exit.t
--- t.orig/08_exit.t    2010-08-24 07:08:16.000000000 +0200
+++ t/08_exit.t 2011-03-06 20:06:41.907000000 +0100
@@ -37,6 +37,7 @@
         client =&gt; sub {
             my $port = shift;
             note &#34;CLIENT: $$&#34;;
+            sleep 1;
             exit 1;
         },
         server =&gt; sub {
@@ -53,3 +54,4 @@
     &#41;;
 }
 
+
diff -u -r t.orig/09_fork.t t/09_fork.t
--- t.orig/09_fork.t    2011-03-03 09:13:54.000000000 +0100
+++ t/09_fork.t 2011-03-06 22:31:39.035000000 +0100
@@ -39,12 +39,20 @@
         print {$sock} &#34;Hello server\n&#34;;
         my $res = &lt;$sock&gt;;
         is $res, &#34;Hello server\n&#34;, &#34;got expected reply&#34;;
+
+        note &#34;finalize&#34;;
+        print {$sock} &#34;quit\n&#34;;
+        sleep 1;
+        warn &#34;Client exit after sleep $$&#34;;
     },
     server =&gt; sub {
         my $port = shift;
         t::Server-&gt;new&#40;$port&#41;-&gt;run&#40;sub {
             note &#34;new request&#34;;
             my &#40;$remote, $line, $sock&#41; = @_;
+            if &#40;$line eq &#34;quit\n&#34;&#41;{
+                exit 0;
+            };
             print {$remote} $line;
         }&#41;;
     }
@@ -56,3 +64,5 @@
     diag &#34;test_tcp&#40;&#41; leaks \$?. Maybe it&#39;s Perl bug?: $?&#34;;
     $? = 0;
 }
+
+
diff -u -r t.orig/10_oo.t t/10_oo.t
--- t.orig/10_oo.t      2011-03-03 09:13:56.000000000 +0100
+++ t/10_oo.t   2011-03-07 07:37:18.063200000 +0100
@@ -35,7 +35,7 @@
 is $res2, &#34;bar\n&#34;;
 
 note &#34;finalize&#34;;
-print {$sock} &#34;quit\n&#34;;
+$server-&gt;stop;
 
 if &#40;$?&#41; {
     # It&#39;s maybe ActivePerl&#39;s bug.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-908533" href="/Public/Bug/Display.html?id=66437#txn-908533">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;09&nbsp;13:43:06&nbsp;2011</span>
    <span class="description">cameronbaustian [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/908533/471312/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/471312">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 112b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Same here. Tests hang in Windows 7 using Strawberry Perl.

I am willing to provide additional info upon request.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-908536" href="/Public/Bug/Display.html?id=66437#txn-908536">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;09&nbsp;13:43:07&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-908894" href="/Public/Bug/Display.html?id=66437#txn-908894">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;10&nbsp;14:54:38&nbsp;2011</span>
    <span class="description">JDB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/908894/471487/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/471487">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 559b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I can not reproduce the problem.

Using:

Windows 7 Professional with SP1 &#40;running under VMware&#41;
StrawberryPerl-5.12.1 with bundled dmake/MinGW
ActivePerl-5.12.1.1201 with nmake/vc6

On ActivePerl I get the wrong exit code for some tests &#40;bug #66016&#41;, but
if I add the sleep&#40;1&#41; call at the end of the stop&#40;&#41; function, then all
tests pass under both Perl distributions.

I&#39;ve been running `dmake test` 5 times, all &#34;PASS&#34;.  Anything else that
has to be done to make it crash/hang?

BTW, I&#39;m running manually from the commandline, not using
cpan/cpanplus/cpanm.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-908922" href="/Public/Bug/Display.html?id=66437#txn-908922">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;10&nbsp;17:40:07&nbsp;2011</span>
    <span class="description">bo.johansson [...] lsn.se -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bo.johansson [...] lsn.se</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/908922/471499/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/471499">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Vid Thu, 10 Mar 2011 kl. 14.54.38, skrev JDB:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I can not reproduce the problem.
</div>
The test are still blocking for me.

The proposed modification makes a significant improvment for the
08_exit.t test.
It is blocking, but first after about a 10 to 150 times. &#40;Using a batch
file like this below, which is only
calling perl -Ilib t/08_exit.t.&#41;

When using the batchfile below, I got the following result in 10 tries:
c 8 t01; c 6 t08; c 2 t01; c 6 t10; c 6 t10; c 7 t01;
c 6 t10; c 30 t01; c 12 t10; c 3 t10

The figure after c means blocking in loop number and txx indicates the
test which is blocking.

Used batch file:
@echo off
set count=0
:loop
set /a count=%count%+1
echo Count %count%
@echo on
perl -Ilib t/01_simple.t
perl -Ilib t/08_exit.t
perl -Ilib t/09_fork.t
perl -Ilib t/10_oo.t
@echo off
goto loop

I am using:
* Test::TCP $VERSION = &#39;1.12&#39;; with the added line see below.
* Strawberry-perl-5.12.2.0
* Perl 5, version 12, subversion 2 &#40;v5.12.2&#41; built for
MSWin32-x86-multi-thread
* Windows 7 Home Premium with Service Pack 1

sub stop {
    my $self = shift;

    ....
    
    undef $self-&gt;{pid};
    sleep&#40;1&#41; if $^O eq &#34;MSWin32&#34;; #added line
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-911256" href="/Public/Bug/Display.html?id=66437#txn-911256">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;17&nbsp;05:16:00&nbsp;2011</span>
    <span class="description">bo.johansson [...] lsn.se -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Proposal for making modules using fork more portable</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bo.johansson [...] lsn.se</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/911256/472720/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/472720">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Proposal for making modules using fork more portable

PROPOSAL

To add an advice to explicitly shut down child processes by the
implementation of modules intended to be portable.  The purpose with
this is to avoid the related problem in the emulation of fork in Windows. 

In the documentation of fork there could be a warning about the problem
and an reference to perlfork  <span class="clickylink"><a target="new" rel="nofollow" href="http://perldoc.perl.org/perlfork.html">http://perldoc.perl.org/perlfork.html</a></span>. In
perlfork there should be an advice to explicitly shut down child
processes and how to avoid using kill&#40;9, $child&#41;.

BACKGROUND

Using kill&#40;9, $child&#41; in Windows, where fork is emulated in the perl
interpreter, there is a probability to get a blocked process.

Work is going on to improve the perlfork implementation in Windows &#40;see:
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.gossamer-threads.com/lists/perl/porters/261805&#41;">http://www.gossamer-threads.com/lists/perl/porters/261805&#41;</a></span>, but it will
take a long time until the new versions of Perl are used in all places.
To update a module is often done faster.


Example of problem:

The test in Test::TCP is blocking. Get the system in state, that it
must be restarted.
It is sometimes not possible to kill the blocked processes.
I even get errors like “Can&#39;t spawn &#34;cmd.exe&#34;” when using the system
call. It indicates a degeneration of the perl interpreter. 

I am using:
* Strawberry-perl-5.12.2.0
* Perl 5, version 12, subversion 2 &#40;v5.12.2&#41; built for
MSWin32-x86-multi-thread
* Windows 7 Home Premium with Service Pack 1

From <span class="clickylink"><a target="new" rel="nofollow" href="http://perldoc.perl.org/perlfork.html">http://perldoc.perl.org/perlfork.html</a></span>:

On some platforms such as Windows where the fork&#40;&#41; system call is not
available, Perl can be built to emulate fork&#40;&#41; at the interpreter level.
While the emulation is designed to be as compatible as possible with the
real fork&#40;&#41; at the level of the Perl program, there are certain
important differences that stem from the fact that all the pseudo child
&#34;processes&#34; created this way live in the same real process as far as the
operating system is concerned. 


Jan Dubois wrote in
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=66016#txn-910239">https://rt.cpan.org/Public/Bug/Display.html?id=66016#txn-910239</a></span>

Note though that kill&#40;9, $child&#41; is inherently
unsafe for pseudo-processes. 

...

Here is the list of warnings about some of the things that can go
wrong if you call TerminateThread&#40;&#41; when you don&#39;t know the current
state of the thread &#40;from the Microsoft docs&#41;:

* If the target thread owns a critical section, the critical section
will not be released.

* If the target thread is allocating memory from the heap, the heap lock
will not be released.

* If the target thread is executing certain kernel32 calls when it is
terminated, the kernel32 state for the thread&#39;s process could be
inconsistent.

* If the target thread is manipulating the global state of a shared
DLL, the state of the DLL could be destroyed, affecting other users
of the DLL.

As the terminated thread runs inside the same process as the controlling
thread, it is always possible that the controlling thread will get
damaged by this action.

…

Anyway, I don&#39;t think TerminateThread&#40;&#41; can ever be completely safe
if you call it when the child thread may not be in a wait state, so
I hope the alternate implementation will solve the issue instead &#40;for
5.14 and later only, for 5.12 and earlier we will have to add the
sleep&#40;&#41; calls and live with the occasional breakage, I think&#41;. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1196005" href="/Public/Bug/Display.html?id=66437#txn-1196005">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;29&nbsp;03:00:03&nbsp;2013</span>
    <span class="description">tokuhirom+cpan [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1196005/631203/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/631203">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 48b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I hope the issue was resolved by latest release.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1196007" href="/Public/Bug/Display.html?id=66437#txn-1196007">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;29&nbsp;03:00:04&nbsp;2013</span>
    <span class="description">tokuhirom+cpan [...] gmail.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.40213</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
