<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #97055 for File-KeePass: Does not accept XML key file</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #97055 for File-KeePass: Does not accept XML key file</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/File-KeePass/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/File-KeePass/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/File-KeePass/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/File-KeePass/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/File-KeePass">File-KeePass CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">97055</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/File-KeePass/Active/">File-KeePass</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
joe.burpee [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-233724-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.03    </td>
  </tr>
  <tr id="CF-233725-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;08&nbsp;10:17:35&nbsp;2014</span>
    <span class="description">https://www.google.com/accounts/o8/id?id=AItOawlzZbAjF6knBhcrdzGFWvZvcGA5zsmb74o -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Does not accept XML key file</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">KeyPass.pm cannot handle XML key files created by KeePass 2.26. The attached patch is intended mainly to fix that.

THe patch also modifies bits of logic to recognize database format version 3. WFM but I have no idea whether there are recent format changes that might not be handled correctly. &#40;Presumably one of the three maintainers would know something about that.&#41;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> xml-keyfile.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- KeePass.pm	2014-07-07 10:28:36.660608544 -0400
+++ KeePass.pm	2014-07-08 07:22:07.610192471 -0400
@@ -17,7 +17,7 @@
 use constant DB_SIG_2_v1      =&gt; 0xB54BFB65;
 use constant DB_SIG_2_v2      =&gt; 0xB54BFB67;
 use constant DB_VER_DW_V1     =&gt; 0x00030002;
-use constant DB_VER_DW_V2     =&gt; 0x00030000; # recent KeePass is 0x0030001
+use constant DB_VER_DW_V2     =&gt; 0x00030000; # recent KeePass is 0x00030001
 use constant DB_FLAG_RIJNDAEL =&gt; 2;
 use constant DB_FLAG_TWOFISH  =&gt; 8;
 
@@ -149,7 +149,7 @@
     my &#40;$self, $buffer&#41; = @_;
     my %h = &#40;version =&gt; 2, enc_type =&gt; &#39;rijndael&#39;&#41;;
     @h{qw&#40;sig1 sig2 ver&#41;} = unpack &#39;L3&#39;, $buffer;
-    die &#34;Unsupported file version2 &#40;$h{&#39;ver&#39;}&#41;.\n&#34; if &#40;$h{&#39;ver&#39;} &#38; 0xFFFF0000&#41; &gt; &#40;0x00020000 &#38; 0xFFFF0000&#41;;
+    die &#34;Unsupported file version2 &#40;$h{&#39;ver&#39;}&#41;.\n&#34; if &#40;$h{&#39;ver&#39;} &#38; 0xFFFF0000&#41; &gt; &#40;DB_VER_DW_V2 &#38; 0xFFFF0000&#41;;
     my $pos = 12;
 
     while &#40;1&#41; {
@@ -603,16 +603,17 @@
         if &#40;length&#40;$file&#41; == 64&#41; {
             $file = join &#39;&#39;, map {chr hex} &#40;$file =~ /\G&#40;[a-f0-9A-F]{2}&#41;/g&#41;;
         } elsif &#40;length&#40;$file&#41; != 32&#41; {
-            $file = sha256&#40;$file&#41;;
+            $file = eval{ $self-&gt;decode_base64&#40; $self-&gt;parse_xml&#40;$file&#41;-&gt;{Key}{Data} &#41; }
+                 // sha256&#40;$file&#41;;
         }
     }
     my $key = &#40;!$pass &#38;&#38; !$file&#41; ? die &#34;One or both of password or key file must be passed\n&#34;
-            : &#40;$head-&gt;{&#39;version&#39;} &#38;&#38; $head-&gt;{&#39;version&#39;} eq &#39;2&#39;&#41; ? sha256&#40;grep {$_} $pass, $file&#41;
+            : &#40;$head-&gt;{&#39;version&#39;} &#38;&#38; $head-&gt;{&#39;version&#39;} &gt; 1&#41; ? sha256&#40;grep {$_} $pass, $file&#41;
             : &#40;$pass &#38;&#38; $file&#41; ? sha256&#40;$pass, $file&#41; : $pass ? $pass : $file;
     $head-&gt;{&#39;enc_iv&#39;}     ||= join &#39;&#39;, map {chr rand 256} 1..16;
-    $head-&gt;{&#39;seed_rand&#39;}  ||= join &#39;&#39;, map {chr rand 256} 1..&#40;$head-&gt;{&#39;version&#39;} &#38;&#38; $head-&gt;{&#39;version&#39;} eq &#39;2&#39; ? 32 : 16&#41;;
+    $head-&gt;{&#39;seed_rand&#39;}  ||= join &#39;&#39;, map {chr rand 256} 1..&#40;$head-&gt;{&#39;version&#39;} &#38;&#38; $head-&gt;{&#39;version&#39;} &gt; 1 ? 32 : 16&#41;;
     $head-&gt;{&#39;seed_key&#39;}   ||= sha256&#40;time.rand&#40;2**32-1&#41;.$$&#41;;
-    $head-&gt;{&#39;rounds&#39;} ||= $self-&gt;{&#39;rounds&#39;} || &#40;$head-&gt;{&#39;version&#39;} &#38;&#38; $head-&gt;{&#39;version&#39;} eq &#39;2&#39; ? 6_000 : 50_000&#41;;
+    $head-&gt;{&#39;rounds&#39;} ||= $self-&gt;{&#39;rounds&#39;} || &#40;$head-&gt;{&#39;version&#39;} &#38;&#38; $head-&gt;{&#39;version&#39;} &gt; 1 ? 6_000 : 50_000&#41;;
 
     my $cipher = Crypt::Rijndael-&gt;new&#40;$head-&gt;{&#39;seed_key&#39;}, Crypt::Rijndael::MODE_ECB&#40;&#41;&#41;;
     $key = $cipher-&gt;encrypt&#40;$key&#41; for 1 .. $head-&gt;{&#39;rounds&#39;};
@@ -644,7 +645,7 @@
     die &#34;Please unlock before calling gen_db\n&#34; if $self-&gt;is_locked&#40;$groups&#41;;
 
     srand&#40;rand&#40;time&#40;&#41; ^ $$&#41;&#41; if ! $self-&gt;{&#39;no_srand&#39;};
-    if &#40;$v eq &#39;2&#39;&#41; {
+    if &#40;$v &gt; 1&#41; {
         return $self-&gt;_gen_v2_db&#40;$pass, $head, $groups&#41;;
     } else {
         return $self-&gt;_gen_v1_db&#40;$pass, $head, $groups&#41;;
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
