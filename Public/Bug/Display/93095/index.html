<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #93095 for Time-Piece: strptime/strftime issues with %z and %Z</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #93095 for Time-Piece: strptime/strftime issues with %z and %Z</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Time-Piece/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Time-Piece/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Time-Piece/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Time-Piece/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Time-Piece">Time-Piece CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">93095</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Time-Piece/Active/">Time-Piece</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ESAYM [...] cpan.org

<br />
gelbman [...] gmail.com

<br />
tsibley [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-33486-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
1.26</li>
<li>
1.27</li>
</ul>
    </td>
  </tr>
  <tr id="CF-33487-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;17&nbsp;15:38:47&nbsp;2014</span>
    <span class="description">gelbman [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> strptime issues with %z and %Z</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">When I use strptime to parse a date with a timezone offset like -0600 the resulting time is offset +6 hours from the local timezone when it should be offset from GMT.

For example:

#!/usr/bin/perl
use Time::Piece;

# prints 1984-01-01 05:00 UTC +0000
# as it should
$ENV{TZ} = &#34;UTC&#34;;
my $t = Time::Piece-&gt;strptime&#40;&#34;1984-01-01 00:00 -0500&#34;, &#34;%Y-%m-%d %H:%M %z&#34;&#41;;
print $t-&gt;strftime&#40;&#34;%Y-%m-%d %H:%M %Z %z\n&#34;&#41;;

# prints 1984-01-01 05:00 CST -0600
# but should be 1983-12-31 23:00 CST -0600
$ENV{TZ} = &#34;CST6CDT&#34;;
my $t = Time::Piece-&gt;strptime&#40;&#34;1984-01-01 00:00 -0500&#34;, &#34;%Y-%m-%d %H:%M %z&#34;&#41;;
print $t-&gt;strftime&#40;&#34;%Y-%m-%d %H:%M %Z %z\n&#34;&#41;;

Also %Z seems completely broken:

# Error parsing time at /Library/Perl/5.16/darwin-thread-multi-2level/Time/Piece.pm line 469.
$ENV{TZ} = &#34;CST6CDT&#34;;
my $t = Time::Piece-&gt;strptime&#40;&#34;1984-01-01 00:00 EST&#34;, &#34;%Y-%m-%d %H:%M %Z&#34;&#41;;
print $t-&gt;strftime&#40;&#34;%Y-%m-%d %H:%M %Z %z\n&#34;&#41;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;29&nbsp;15:59:14&nbsp;2014</span>
    <span class="description">tsibley [...] cpan.org -  Requestor TSIBLEY added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;29&nbsp;16:07:21&nbsp;2014</span>
    <span class="description">tsibley [...] cpan.org -  Subject changed from &#39;strptime issues with %z and %Z&#39; to &#39;strptime/strftime issues with %z and %Z&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other Forward Transaction even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;29&nbsp;16:21:33&nbsp;2014</span>
    <span class="description">tsibley [...] cpan.org -  Forwarded Transaction #1327654 to tsibley@cpan.org</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;29&nbsp;18:54:18&nbsp;2014</span>
    <span class="description">tsibley [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #93095] strptime issues with %z and %Z</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 29 Jul 2014 18:53:48 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Time-Piece [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Thomas Sibley &lt;tsibley [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This behaviour bit me recently, and when I went digging I learned more
than I really wanted to know &#40;as is always the case with date times&#41;.  I
summarize below...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; When I use strptime to parse a date with a timezone offset like -0600
&gt; the resulting time is offset +6 hours from the local timezone when it
&gt; should be offset from GMT.
&gt; 
&gt; [...]
&gt; 
&gt; # prints 1984-01-01 05:00 CST -0600
&gt; # but should be 1983-12-31 23:00 CST -0600
&gt; $ENV{TZ} = &#34;CST6CDT&#34;;
&gt; my $t = Time::Piece-&gt;strptime&#40;&#34;1984-01-01 00:00 -0500&#34;, &#34;%Y-%m-%d %H:%M %z&#34;&#41;;
&gt; print $t-&gt;strftime&#40;&#34;%Y-%m-%d %H:%M %Z %z\n&#34;&#41;;
</div>
I believe the problem you&#39;re seeing is in formatting, not parsing.  Your
examples touch both strptime and strftime, which I think leads to some
confusion over where the fault lies.  It&#39;d be good to break the examples
into tests that only exercise one function at a time and show the
failures more clearly.

The formatting bug is that Time::Piece doesn&#39;t actually pass any time
zone offset information to the underlying strftime XS/C function it
calls, so these parts of the C struct tm are initialized to the
machine&#39;s localtime &#40;usually via init_tm provided by Perl&#39;s util.c&#41; [1].
Hence the time values are in GMT but the local zone &#40;%z or %Z&#41; is
returned without any conversion being done.

When the format contains %z or %Z, strftime needs to either a&#41; convert
to local time first &#40;from GMT or whatever offset is in the object&#41; or b&#41;
set the appropriate offsets and name in the C struct so a zone other
than the local time is reported.

All that said, note that the strptime provided by Time::Piece ignores
the got_GMT flag it gets from the parser [2].  The effect of this is
that Time::Piece always treats strings without %z as GMT, not the local
zone.  This may be unintuitive and certainly should be documented.
Strings *with* %z are converted to GMT while parsing, so if you&#39;re
explicit, such as in your examples, you&#39;re OK.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Also %Z seems completely broken:
</div>
Real strptime support for %Z is pretty hard to find, including in glibc.
Time::Piece&#39;s strptime is no different, and it only recogizes &#34;GMT&#34; [3].
It is worth noting that GNU date&#40;1&#41; can handle lots of timezone
specifications &#40;refer to the parse_datetime function in GNU coreutils&#41;,
though it does recommend against ambiguous names like &#34;EST&#34; [4].

[1] <span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/blob/HEAD:/util.c#l3599">http://perl5.git.perl.org/perl.git/blob/HEAD:/util.c#l3599</a></span>
[2] <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/RJBS/Time-Piece-1.27/Piece.xs#L1107">https://metacpan.org/source/RJBS/Time-Piece-1.27/Piece.xs#L1107</a></span>
[3] <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/RJBS/Time-Piece-1.27/Piece.xs#L894">https://metacpan.org/source/RJBS/Time-Piece-1.27/Piece.xs#L894</a></span>
[4] <span class="clickylink"><a target="new" rel="nofollow" href="https://www.gnu.org/software/coreutils/manual/html_node/Time-zone-items.html#Time-zone-items">https://www.gnu.org/software/coreutils/manual/html_node/Time-zone-items.html#Time-zone-items</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;04&nbsp;16:07:31&nbsp;2015</span>
    <span class="description">ESAYM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Feb 17 15:38:47 2014, iamjake wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; When I use strptime to parse a date with a timezone offset like -0600
&gt; the resulting time is offset +6 hours from the local timezone when it
&gt; should be offset from GMT.
&gt; 
&gt; For example:
&gt; 
&gt; #!/usr/bin/perl
&gt; use Time::Piece;
&gt; 
&gt; # prints 1984-01-01 05:00 UTC +0000
&gt; # as it should
&gt; $ENV{TZ} = &#34;UTC&#34;;
&gt; my $t = Time::Piece-&gt;strptime&#40;&#34;1984-01-01 00:00 -0500&#34;, &#34;%Y-%m-%d
&gt; %H:%M %z&#34;&#41;;
&gt; print $t-&gt;strftime&#40;&#34;%Y-%m-%d %H:%M %Z %z\n&#34;&#41;;
&gt; 
&gt; # prints 1984-01-01 05:00 CST -0600
&gt; # but should be 1983-12-31 23:00 CST -0600
&gt; $ENV{TZ} = &#34;CST6CDT&#34;;
&gt; my $t = Time::Piece-&gt;strptime&#40;&#34;1984-01-01 00:00 -0500&#34;, &#34;%Y-%m-%d
&gt; %H:%M %z&#34;&#41;;
&gt; print $t-&gt;strftime&#40;&#34;%Y-%m-%d %H:%M %Z %z\n&#34;&#41;;
&gt; 
&gt; Also %Z seems completely broken:
&gt; 
&gt; # Error parsing time at /Library/Perl/5.16/darwin-thread-multi-
&gt; 2level/Time/Piece.pm line 469.
&gt; $ENV{TZ} = &#34;CST6CDT&#34;;
&gt; my $t = Time::Piece-&gt;strptime&#40;&#34;1984-01-01 00:00 EST&#34;, &#34;%Y-%m-%d %H:%M
&gt; %Z&#34;&#41;;
&gt; print $t-&gt;strftime&#40;&#34;%Y-%m-%d %H:%M %Z %z\n&#34;&#41;;
</div>


Strangely, using the native functions provided in libc shows the behavior is completely different. Converting timezones doesn&#39;t seem to really be supported. Still investigating, trying to get an example to work in pure C before I tackle the _strptime in xs. It might be converting to the epoch might be the best way forward but I&#39;ll see if there is another way.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;04&nbsp;16:07:32&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;04&nbsp;16:09:01&nbsp;2015</span>
    <span class="description">ESAYM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Apr 04 16:07:31 2015, ESAYM wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Feb 17 15:38:47 2014, iamjake wrote:
<div class="message-stanza open">&gt; &gt; When I use strptime to parse a date with a timezone offset like -0600
&gt; &gt; the resulting time is offset +6 hours from the local timezone when it
&gt; &gt; should be offset from GMT.
&gt; &gt;
&gt; &gt; For example:
&gt; &gt;
&gt; &gt; #!/usr/bin/perl
&gt; &gt; use Time::Piece;
&gt; &gt;
&gt; &gt; # prints 1984-01-01 05:00 UTC +0000
&gt; &gt; # as it should
&gt; &gt; $ENV{TZ} = &#34;UTC&#34;;
&gt; &gt; my $t = Time::Piece-&gt;strptime&#40;&#34;1984-01-01 00:00 -0500&#34;, &#34;%Y-%m-%d
&gt; &gt; %H:%M %z&#34;&#41;;
&gt; &gt; print $t-&gt;strftime&#40;&#34;%Y-%m-%d %H:%M %Z %z\n&#34;&#41;;
&gt; &gt;
&gt; &gt; # prints 1984-01-01 05:00 CST -0600
&gt; &gt; # but should be 1983-12-31 23:00 CST -0600
&gt; &gt; $ENV{TZ} = &#34;CST6CDT&#34;;
&gt; &gt; my $t = Time::Piece-&gt;strptime&#40;&#34;1984-01-01 00:00 -0500&#34;, &#34;%Y-%m-%d
&gt; &gt; %H:%M %z&#34;&#41;;
&gt; &gt; print $t-&gt;strftime&#40;&#34;%Y-%m-%d %H:%M %Z %z\n&#34;&#41;;
&gt; &gt;
&gt; &gt; Also %Z seems completely broken:
&gt; &gt;
&gt; &gt; # Error parsing time at /Library/Perl/5.16/darwin-thread-multi-
&gt; &gt; 2level/Time/Piece.pm line 469.
&gt; &gt; $ENV{TZ} = &#34;CST6CDT&#34;;
&gt; &gt; my $t = Time::Piece-&gt;strptime&#40;&#34;1984-01-01 00:00 EST&#34;, &#34;%Y-%m-%d %H:%M
&gt; &gt; %Z&#34;&#41;;
&gt; &gt; print $t-&gt;strftime&#40;&#34;%Y-%m-%d %H:%M %Z %z\n&#34;&#41;;
</div>&gt; 
&gt; 
&gt; 
&gt; Strangely, using the native functions provided in libc shows the
&gt; behavior is completely different. Converting timezones doesn&#39;t seem to
&gt; really be supported. Still investigating, trying to get an example to
&gt; work in pure C before I tackle the _strptime in xs. It might be
&gt; converting to the epoch might be the best way forward but I&#39;ll see if
&gt; there is another way.
</div>
I might add my above comment was only concerning how strptime builds the tm struct, strftime is a different beast...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;06&nbsp;22:07:03&nbsp;2015</span>
    <span class="description">rjbs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Something, possibly related to this, has broken String-Errf:

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/cae9ca10-dcad-11e4-b7a8-a446e14af301">http://www.cpantesters.org/cpan/report/cae9ca10-dcad-11e4-b7a8-a446e14af301</a></span>

-- 
rjbs
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;07&nbsp;14:59:18&nbsp;2015</span>
    <span class="description">ESAYM [...] cpan.org -  Requestor ESAYM added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;07&nbsp;17:26:45&nbsp;2015</span>
    <span class="description">ESAYM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Apr 06 22:07:03 2015, RJBS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Something, possibly related to this, has broken String-Errf:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/cae9ca10-dcad-11e4-b7a8-a446e14af301">http://www.cpantesters.org/cpan/report/cae9ca10-dcad-11e4-b7a8-a446e14af301</a></span>
</div>

Indeed, thank you for the update.
The issue stems from my call to native mktime. This is done to fix issues where dates in the past would be given the wrong dst timezone in the output of %z in strftime. I demonstrate this in the attached file, the timezone is wrong because it was initially set &#40;In Piece.xs&#41; by a call to the native libc localtime which populates the tmzone struct element with the current zone regardless if the broken down time is from a different dst.

Let me put some thought into this and commit a patch against 1.29_03.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> time_test.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#! /usr/bin/env perl
use strict;
use Time::Piece;
use POSIX qw&#40;strftime&#41;;

my $t = localtime&#40;951827696&#41;;
my $tt = gmtime&#40;951827696&#41;;

my @l = localtime&#40;951827696&#41;;
my @ll = gmtime&#40;951827696&#41;;


print $t-&gt;strftime&#40;&#34;%F %T %Z %z&#34;&#41; . &#34;\n&#34;;
print $tt-&gt;strftime&#40;&#34;%F %T %Z %z&#34;&#41; . &#34;\n&#34;;

print strftime&#40;&#34;%F %T %Z %z&#34;, @l&#41; . &#34;\n&#34;;
print strftime&#40;&#34;%F %T %Z %z&#34;, @ll&#41; . &#34;\n&#34;;

#output:
#2000-02-29 06:34:56 CDT -0500
#2000-02-29 12:34:56 CDT -0500
#2000-02-29 06:34:56 CST -0600
#2000-02-29 12:34:56 CST -0600

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;10&nbsp;13:06:20&nbsp;2015</span>
    <span class="description">ESAYM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Apr 06 22:07:03 2015, RJBS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Something, possibly related to this, has broken String-Errf:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/cae9ca10-dcad-11e4-b7a8-a446e14af301">http://www.cpantesters.org/cpan/report/cae9ca10-dcad-11e4-b7a8-a446e14af301</a></span>
</div>

This is fixed in 1.29_03, but I am now toying with the idea of just passing in the epoch to _strftime in the xs code. I think that would be simpler in the end and one wouldn&#39;t need to worry at all about platform differences with the tm struct.

Also added more test cases and I have a simple script that can pull and build all the reverse dependencies of Time::Piece so I shouldn&#39;t be breaking other modules again :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;19&nbsp;16:28:17&nbsp;2017</span>
    <span class="description">ESAYM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Feb 17 15:38:47 2014, iamjake wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; When I use strptime to parse a date with a timezone offset like -0600
&gt; the resulting time is offset +6 hours from the local timezone when it
&gt; should be offset from GMT.
&gt; 
&gt; For example:
&gt; 
&gt; #!/usr/bin/perl
&gt; use Time::Piece;
&gt; 
&gt; # prints 1984-01-01 05:00 UTC +0000
&gt; # as it should
&gt; $ENV{TZ} = &#34;UTC&#34;;
&gt; my $t = Time::Piece-&gt;strptime&#40;&#34;1984-01-01 00:00 -0500&#34;, &#34;%Y-%m-%d
&gt; %H:%M %z&#34;&#41;;
&gt; print $t-&gt;strftime&#40;&#34;%Y-%m-%d %H:%M %Z %z\n&#34;&#41;;
&gt; 
&gt; # prints 1984-01-01 05:00 CST -0600
&gt; # but should be 1983-12-31 23:00 CST -0600
&gt; $ENV{TZ} = &#34;CST6CDT&#34;;
&gt; my $t = Time::Piece-&gt;strptime&#40;&#34;1984-01-01 00:00 -0500&#34;, &#34;%Y-%m-%d
&gt; %H:%M %z&#34;&#41;;
&gt; print $t-&gt;strftime&#40;&#34;%Y-%m-%d %H:%M %Z %z\n&#34;&#41;;
&gt; 
&gt; Also %Z seems completely broken:
&gt; 
&gt; # Error parsing time at /Library/Perl/5.16/darwin-thread-multi-
&gt; 2level/Time/Piece.pm line 469.
&gt; $ENV{TZ} = &#34;CST6CDT&#34;;
&gt; my $t = Time::Piece-&gt;strptime&#40;&#34;1984-01-01 00:00 EST&#34;, &#34;%Y-%m-%d %H:%M
&gt; %Z&#34;&#41;;
&gt; print $t-&gt;strftime&#40;&#34;%Y-%m-%d %H:%M %Z %z\n&#34;&#41;;
</div>


There seems to have been some confusion on my part here &#40;and in other places&#41;

Calling like this: Time::Piece-&gt;strptime&#40;&#41; defaults to returning a TP instance of GMT
Getting a local TP instance via localtime&#40;&#41;, is different.

So of course doing something like:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;my $t = Time::Piece-&gt;strptime&#40;&#34;1984-01-01 00:00 EST&#34;, &#34;%Y-%m-%d %H:%M
&gt;print $t-&gt;strftime&#40;&#34;%Y-%m-%d %H:%M %Z %z\n&#34;&#41;;
</div>
will give you a GMT time &#40;as $t-&gt;[c_islocal] will be set to 1&#41;.

So this problem was made out to be a strftime issue, when it is really a strptime issue.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
