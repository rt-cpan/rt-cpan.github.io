<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #34921 for WWW-Myspace: Sending of comments and messages was broken; patch included</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #34921 for WWW-Myspace: Sending of comments and messages was broken; patch included</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/WWW-Myspace/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/WWW-Myspace/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/WWW-Myspace/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/WWW-Myspace/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/WWW-Myspace">WWW-Myspace CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">34921</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">10 min

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/WWW-Myspace/Active/">WWW-Myspace</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">GRANTG [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
steven [...] pyro.eu.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-38014-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-38015-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;12&nbsp;12:51:51&nbsp;2008</span>
    <span class="description">steven [...] pyro.eu.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Sending of comments and messages was broken; patch included</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 12 Apr 2008 17:51:14 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-www-myspace [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steven Chamberlain &lt;steven [...] pyro.eu.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

The test suite was showing multiple failed tests relating to comments 
and messages.  With my attached patch, things seem to be working again 
&#40;for now&#41;.

The post_comment and send_message functions weren&#39;t working at all due 
to changes in the forms.  Also, read_message wasn&#39;t retrieving the 
subject line, and the returned message body had some clutter at the end 
causing a test to fail.  This all seems to be fixed by my patch.

Also when posting a comment to someone not in your &#39;friends&#39; list, 
post_comment should return &#39;FF&#39; but I think it was returning something 
else like &#39;F&#39;.  I think the regex name was wrong, and it looks like it&#39;s 
fixed now.  A new test, which tries to post to someone definitely *not* 
added to friends, would be useful there.

If you decide to use my patch and make another release sometime then I 
hope SVN doesn&#39;t give you any trouble this time around!


I also noticed a slight problem in t/05-message which I haven&#39;t figured 
out how to fix yet.  A message is sent from one test account to the 
other; but if a CAPTCHA is shown then the send_message test still 
&#39;passes&#39; whereas I think it should be skipped with a warning instead.  I 
think it should also skip the following test too because that fails 
otherwise &#40;it logs into the recipient account to try and find the message&#41;.

As long as a CAPTCHA isn&#39;t experienced when sending the test message 
between accounts, &#39;make test&#39; now shows 100% passes.  Many tests are 
still being skipped though for functions that are currently &#39;disabled&#39;. 
  I might be able to fix some of those sometime but I can&#39;t guarantee if 
or when.

Thanks,
-- 
Steven Chamberlain
steven@pyro.eu.org
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: t/05-message.t
===================================================================
--- t/05-message.t	&#40;revision 570&#41;
+++ t/05-message.t	&#40;working copy&#41;
@@ -84,7 +84,7 @@
 		is&#40; $mr-&gt;{from}, $CONFIG-&gt;{acct1}-&gt;{friend_id}, &#34;read_message From&#34; &#41;;
 		is&#40; $mr-&gt;{subject}, &#39;Hi &#39;.$ident, &#34;read_message Subject&#34; &#41;;
 		#is&#40; $mr-&gt;{date}, &#39;Feb 28, 2006 1:20 AM&#39;, &#34;read_message Date&#34; &#41;;
-		is&#40; $mr-&gt;{body}, &#34;Just saying hi.\n\nHope all is well.\n&#34;, &#34;read_message Body&#34; &#41;;
+		is&#40; $mr-&gt;{body}, &#34;Just saying hi.\n\nHope all is well.&#34;, &#34;read_message Body&#34; &#41;;
 		
 		SKIP: {
 			skip &#34;delete_message tests disabled because Myspace&#39;s Delete button doesn&#39;t work&#34;, 2;
@@ -182,4 +182,4 @@
 	# Clean up
 	unlink &#39;msave.yml&#39;;
 
-}
\ No newline at end of file
+}
Index: lib/WWW/Myspace.pm
===================================================================
--- lib/WWW/Myspace.pm	&#40;revision 570&#41;
+++ lib/WWW/Myspace.pm	&#40;working copy&#41;
@@ -118,8 +118,8 @@
 
 # What should we look for to see if we are being asked for a CAPTCHA code?
 # We&#39;ll extract the URL to return from the area in parenthesis.
-our $CAPTCHA=&#39;&lt;img.*?src=&#34;&#40;http:\/\/security.myspace.com\/CAPTCHA\/&#39;.
-    &#39;CAPTCHA\.aspx\?SecurityToken=[^&#34;]+&#41;&#34;&#39;;
+our $CAPTCHA=&#39;&lt;img.*?src=&#34;&#40;http:\/\/security\.myspace\.com\/captcha\/&#39;.
+    &#39;captcha\.aspx\?SecurityToken=[^&#34;]+&#41;&#34;&#39;;
 our $CAPTCHAi = qr/$CAPTCHA/io;   # ok, we will store both ways
 our $CAPTCHAs = qr/$CAPTCHA/o;  
 #$CAPTCHA = $CAPTCHAi;             # use case insensitive for now
@@ -203,8 +203,8 @@
     comment_posted =&gt; qr/Your Comment has been posted/io,
     not_logged_in =&gt; qr/You Must Be Logged-In to do That\!/io,
     verify_message_sent =&gt; qr/Your Message Has Been Sent\!/o,
-    comment_p1 =&gt; qr/ctl00\$&#40;cp&#41;?Main\$postComment\$commentTextBox.*&lt;\/form|$NOT_FRIEND_ERROR|&#40;$CAPTCHA&#41;|&#40;$INVALID_ID&#41;/smio,
-    comment_p2 =&gt; qr/ctl00\$&#40;cp&#41;?Main\$postComment\$Button1.*&lt;\/form/smo,
+    comment_p1 =&gt; qr/ctl00\$&#40;cp&#41;?Main\$UserWriteCommentsControl\$commentTextBox.*&lt;\/form|&#40;$NOT_FRIEND_ERROR&#41;|&#40;$CAPTCHA&#41;|&#40;$INVALID_ID&#41;/smio,
+    comment_p2 =&gt; qr/ctl00\$&#40;cp&#41;?Main\$UserWriteCommentsControl\$ConfirmPostButton.*&lt;\/form/smo,
     comment_approval_msg =&gt; qr/This user requires all comments to be approved before being posted/o,
     not_friend =&gt; qr/$NOT_FRIEND_ERROR/smo,
     bulletin_url =&gt; qr/fuseaction=bulletin\.edit/io,
@@ -3445,7 +3445,7 @@
     
             # Submit the comment to $friend_id&#39;s page
             $link = $self-&gt;mech-&gt;find_link&#40;
-                                    text_regex =&gt; qr/^add\s+comment$/io &#41;;
+                                    text_regex =&gt; qr/^Add\s+Comment$/io &#41;;
             unless &#40; $link &#41; { $status=&#34;FL&#34;; last TESTBLOCK; }
     
             &#40; $DEBUG &#41; &#38;&#38; print &#34;Getting comment form..\n&#34;;
@@ -3455,8 +3455,9 @@
                          follow =&gt; 1,
                          form_name =&gt; &#39;aspnetForm&#39;,
                          fields_ref =&gt; {
-                            &#39;ctl00$cpMain$postComment$commentTextBox&#39; =&gt; &#34;$message&#34;,
-                            &#39;__EVENTTARGET&#39; =&gt; &#39;ctl00$cpMain$postComment$postcommentImageButton&#39;,
+                            &#39;ctl00$cpMain$UserWriteCommentsControl$commentTextBox&#39; =&gt; &#34;$message&#34;,
+                            &#39;ctl00$cpMain$UserWriteCommentsControl$postcommentImageButton&#39; =&gt; &#34;Post A Comment&#34;,
+    #                        &#39;__EVENTTARGET&#39; =&gt; &#39;ctl00$cpMain$UserWriteCommentsControl$postcommentImageButton&#39;,
     #                        &#39;__EVENTARGUMENT&#39; =&gt; &#39;&#39;,
                          },
                          re1 =&gt; &#39;comment_p1&#39;,
@@ -3484,7 +3485,7 @@
                 $submitted = $self-&gt;submit_form&#40; {
                     follow =&gt; 1,
                     form_name =&gt; &#39;aspnetForm&#39;,
-                    button =&gt; &#39;ctl00$cpMain$postComment$ConfirmPostButton&#39;,
+                    button =&gt; &#39;ctl00$cpMain$UserWriteCommentsControl$ConfirmPostButton&#39;,
                     @captcha
                 } &#41;;
             } else {
@@ -3503,7 +3504,7 @@
         $page =~ s/[ \t\n\r]+/ /g;
     
         # Set the status code to return.
-        if &#40; $self-&gt;_apply_regex&#40; source =&gt; $page, regex =&gt; &#39;not_friend_error&#39; &#41; &#41; {
+        if &#40; $self-&gt;_apply_regex&#40; source =&gt; $page, regex =&gt; &#39;not_friend&#39; &#41; &#41; {
             $status=&#34;FF&#34;;
         } elsif &#40; $self-&gt;_apply_regex&#40; source =&gt; $page, regex =&gt; &#39;is_invalid&#39; &#41; &#41; {
             $status=&#34;FI&#34;;
@@ -3977,7 +3978,7 @@
     $message{&#39;date&#39;} = $1;
     
     # Subject:
-    if &#40; $page =~ /&lt;th.*?&gt;\s*Subject:\s*&lt;.*?&lt;td&gt;\s*&#40;.*?&#41;\s*&lt;\/td&gt;/smo &#41; {
+    if &#40; $page =~ /&lt;p.*?&gt;\s*Subject:\s*&lt;.*?&lt;p.*?&gt;\s*&#40;.*?&#41;\s*&lt;\/p&gt;/smo &#41; {
         $message{&#39;subject&#39;} = $1;
     }
  
@@ -3995,18 +3996,18 @@
     # Clean up newlines
     $message{&#39;body&#39;} =~ s/[\n\r]/\n/go;
 
-    # Gotta clean white space before and after the body
-    $message{&#39;body&#39;} =~ s/^\s*//so;  # Before
-    $message{&#39;body&#39;} =~ s/\s*$//so;  # After
-
     # And they have these BR tags at the beginning of each line...
     # Not any more - 8/16/07
 #    $message{&#39;body&#39;} =~ s/^[ \t]*&lt;br \/&gt;[ \t]*//mog;
     
     # And sometimes they put them elsewhere, so we&#39;ll convert those to newlines.
     # &#40;Note: Maybe this shouldn&#39;t be done, since the messages *are* HTML after all&#41;
-    $message{&#39;body&#39;} =~ s/&lt;br \/&gt;/\n/mog;
-    
+    $message{&#39;body&#39;} =~ s/&lt;br &#40;style=\&#34;display:none\&#34;&#41;?\/&gt;/\n/mog;
+
+    # Gotta clean white space before and after the body
+    $message{&#39;body&#39;} =~ s/^\s*//so;  # Before
+    $message{&#39;body&#39;} =~ s/\s*$//so;  # After
+
     return \%message;
 }
 
@@ -4317,13 +4318,14 @@
             # New mail form...
             $submitted = $self-&gt;submit_form&#40; {
                 form_name =&gt; &#39;aspnetForm&#39;,
+		button =&gt; &#39;ctl00$ctl00$Main$messagingMain$SendMessage$btnSend&#39;,
                 fields_ref =&gt; {
-                    &#39;ctl00$ctl00$Main$Main$sendMessageControl$subjectTextBox&#39; =&gt;
+                    &#39;ctl00$ctl00$Main$messagingMain$SendMessage$subjectTextBox&#39; =&gt;
                         &#34;$options{&#39;subject&#39;}&#34;,
-                    &#39;ctl00$ctl00$Main$Main$sendMessageControl$bodyTextBox&#39; =&gt;
+                    &#39;ctl00$ctl00$Main$messagingMain$SendMessage$bodyTextBox&#39; =&gt;
                         &#34;$options{&#39;message&#39;}&#34;,
-                     &#39;__EVENTTARGET&#39; =&gt; &#39;ctl00$ctl00$Main$Main$sendMessageControl$btnSend&#39;,
-                     &#39;__EVENTARGUMENT&#39; =&gt; &#39;&#39;
+                    &#39;__EVENTTARGET&#39; =&gt; &#39;ctl00$ctl00$Main$messagingMain$SendMessage$btnSend&#39;,
+                    &#39;__EVENTARGUMENT&#39; =&gt; &#39;&#39;
     
                 },
                 no_click =&gt; 1,
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;14&nbsp;19:02:00&nbsp;2008</span>
    <span class="description">GRANTG [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">10 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Patch applied, released as version 0.78.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;14&nbsp;19:02:01&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;14&nbsp;19:02:02&nbsp;2008</span>
    <span class="description">GRANTG [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;14&nbsp;19:02:04&nbsp;2008</span>
    <span class="description">GRANTG [...] cpan.org -  Given to GRANTG</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
