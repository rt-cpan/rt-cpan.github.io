<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #19705 for IO-Socket-SSL: read&#40;&#41; problem</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #19705 for IO-Socket-SSL: read&#40;&#41; problem</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/IO-Socket-SSL/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/IO-Socket-SSL/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/IO-Socket-SSL/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/IO-Socket-SSL/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IO-Socket-SSL">IO-Socket-SSL CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">19705</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/IO-Socket-SSL/Active/">IO-Socket-SSL</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
s.zagrodzki [...] net.icm.edu.pl

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-17228-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.97    </td>
  </tr>
  <tr id="CF-17229-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;05&nbsp;08:04:53&nbsp;2006</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> read&#40;&#41; problem</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">IO::Socket::SSL::read&#40;&#41; uses ssl_read_all&#40;&#41; for reading data when 
$blocking is set. In previous versions it used read&#40;&#41;, which has 
different semantics: ssl_read_all&#40;&#41; reads data until EOF, while Net::
SSLeay:read&#40;&#41; returned after first EOL.

This causes problems for example with HTTP::Daemon:SSL, that uses 
sysread&#40;&#41; on a request. It can&#39;t do anything until read&#40;&#41; returns, and 
read&#40;&#41; returns only when client closes connection, and in this case 
processing the request makes no sense...

Using ssl_read_CRLF instead of ssl_read_all solves the problem. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;12&nbsp;19:06:58&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steffen_Ullrich [...] genua.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">if the socket is blocking sysread can block, if you don&#39;t want
this use nonblocking sockets &#40;whcih got better support with version
0.98&#41;. But it shouldn&#39;t block too much, e.g if yousaid sysread
that you need only 512 bytes it will not wait until EOF but only
until it got 512 bytes &#40;assuming that there are more then 512
bytes to read&#41;. 
So in my opinion the code is not broken.

But could you please send an example program  which shows the problem
so that I could have a closer look at it?


On Mo. 05. Jun. 2006, 08:04:53, guest wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; IO::Socket::SSL::read&#40;&#41; uses ssl_read_all&#40;&#41; for reading data when 
&gt; $blocking is set. In previous versions it used read&#40;&#41;, which has 
&gt; different semantics: ssl_read_all&#40;&#41; reads data until EOF, while Net::
&gt; SSLeay:read&#40;&#41; returned after first EOL.
&gt; 
&gt; This causes problems for example with HTTP::Daemon:SSL, that uses 
&gt; sysread&#40;&#41; on a request. It can&#39;t do anything until read&#40;&#41; returns, and 
&gt; read&#40;&#41; returns only when client closes connection, and in this case 
&gt; processing the request makes no sense...
&gt; 
&gt; Using ssl_read_CRLF instead of ssl_read_all solves the problem. 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;12&nbsp;19:06:59&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;20&nbsp;05:34:25&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Pon. 12 Cze. 2006, 19:06:58, guest wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; if the socket is blocking sysread can block, if you don&#39;t want
&gt; this use nonblocking sockets &#40;whcih got better support with version
&gt; 0.98&#41;. But it shouldn&#39;t block too much, e.g if yousaid sysread
&gt; that you need only 512 bytes it will not wait until EOF but only
&gt; until it got 512 bytes &#40;assuming that there are more then 512
&gt; bytes to read&#41;.
</div>What if I don&#39;t know how many bytes should I read before sending some 
response? Note that you shouldn&#39;t have to wait for EOF, because you may
want to read something, send some response, and then read again.
Currently, with blocking read that doesn&#39;t break at CR/LF &#40;like system 
read&#40;&#41; does&#41;, it&#39;s impossible to implement such behavior, you would have 
to use non-blocking operations and idle loops, or use read&#40;1&#41; to get 
first line of received text.
This will cause problems when implementing i.e. POP, IMAP or whatever 
text-oriented protocol over SSL using IO::Socket::SSL, where you have to 
read one line, and then send something in response, before you get any 
other input.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But could you please send an example program  which shows the problem
&gt; so that I could have a closer look at it?
</div>        $httpserver = HTTP::Daemon::SSL-&gt;new&#40;
                Reuse =&gt; 1,
                LocalAddr =&gt; $ip,
                LocalPort =&gt; $port,
                &#40;$SSLKey ? &#40;SSL_key_file =&gt; $SSLKey&#41; : &#40;&#41;&#41;,
                &#40;$SSLCert ? &#40;SSL_cert_file =&gt; $SSLCert&#41; : &#40;&#41;&#41;
        &#41;;
        my $c = $httpserver-&gt;accept;
        my $r = $c-&gt;get_request;
        print &#34;Method: &#34;.$r-&gt;method.&#34;\n&#34;;

In HTTP::Daemon::SSL get_request&#40;&#41; uses _need_more&#40;&#41;, which has the 
line:

        my $n = sysread&#40;$self, $_[0], 2048, length&#40;$_[0]&#41;&#41;;

sysread is from IO::Socket:SSL, and uses IO::Socket::SSL::read.
HTTP request is usually shorter than 2kB, so this read&#40;&#41; waits 
indefinitely.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;18&nbsp;02:31:29&nbsp;2006</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
I see your argument.
The problem is that IO::Socket::SSL::read and IO::Socket::SSL::sysread
are the same which they should not be, because the semantic of read is
to block until all bytes are read &#40;or EOF&#41; while the semantics of
sysread are to block only until something is read &#40;if socket is 
blocking&#41; and to return even if not all requested bytes are read.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In HTTP::Daemon::SSL get_request&#40;&#41; uses _need_more&#40;&#41;, which has the 
&gt; line:
&gt; 
&gt;         my $n = sysread&#40;$self, $_[0], 2048, length&#40;$_[0]&#41;&#41;;
&gt; 
&gt; sysread is from IO::Socket:SSL, and uses IO::Socket::SSL::read.
&gt; HTTP request is usually shorter than 2kB, so this read&#40;&#41; waits 
&gt; indefinitely.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;18&nbsp;04:25:14&nbsp;2006</span>
    <span class="description">s.zagrodzki [...] net.icm.edu.pl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> s.zagrodzki [...] net.icm.edu.pl, BEHROOZI [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #19705] read&#40;&#41; problem</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 18 Jul 2006 10:22:15 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Steffen Ullrich via RT &lt;bug-IO-Socket-SSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Sebastian Zagrodzki &lt;s.zagrodzki [...] net.icm.edu.pl&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Jul 18, 2006 at 02:31:30AM -0400, Steffen Ullrich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The problem is that IO::Socket::SSL::read and IO::Socket::SSL::sysread
&gt; are the same which they should not be, because the semantic of read is
&gt; to block until all bytes are read &#40;or EOF&#41; while the semantics of
&gt; sysread are to block only until something is read &#40;if socket is 
&gt; blocking&#41; and to return even if not all requested bytes are read.
</div>Ok, if I got it right, I assume this should or will be changed. Should
I prepare the patch myself, or will you do it? This should be easy, as
read&#40;&#41; is simply a call to generic_read. I suppose using:

sub sysread {
        my $self = shift;
        return $self-&gt;generic_read&#40;$self-&gt;blocking ?
                \&#38;Net::SSLeay::ssl_read_CRLF : \&#38;Net::SSLeay::read, @_&#41;;
}

instead of calling read&#40;&#41; will do it?

-- 
Sebastian Zagrodzki             Dział Sieciowy ICM, Uniwersytet Warszawski
s.zagrodzki@net.icm.edu.pl      &#40;+48-22&#41; 5520527, 8268009, fax. 8284195
                                <span class="clickylink"><a target="new" rel="nofollow" href="http://www.net.icm.edu.pl/">http://www.net.icm.edu.pl/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;18&nbsp;04:44:55&nbsp;2006</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have a patch already and it is fairly simple &#40;just call generic_read
with Net::SSLeay::read no matter if blocking or not&#41;. But nevertheless
it needs testing. So the next version will be uploaded in the next days.

But I don&#39;t know where you get the idea that sysread should read until
the next CRLF? This would be contrary to the usual behavior of sysread.
Usually sysread just tries to read and returns what it got, no matter
if this ends with CRLF or not.
Maybe you assumed CRLF because the HTTP header ends with CRLF, so
the final packet of the header will end in CRLF. But this is not a
property of sysread, it&#39;s a property of the data you read.

Steffen

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ok, if I got it right, I assume this should or will be changed. Should
&gt; I prepare the patch myself, or will you do it? This should be easy, as
&gt; read&#40;&#41; is simply a call to generic_read. I suppose using:
&gt; 
&gt; sub sysread {
&gt;       my $self = shift;
&gt;       return $self-&gt;generic_read&#40;$self-&gt;blocking ?
&gt;               \&#38;Net::SSLeay::ssl_read_CRLF : \&#38;Net::SSLeay::read, @_&#41;;
&gt; }
&gt; 
&gt; instead of calling read&#40;&#41; will do it?
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;18&nbsp;09:35:29&nbsp;2006</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">fixed in version 0.991 by using Net::SSLeay::read instead of ssl_read_all
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;18&nbsp;09:35:31&nbsp;2006</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
