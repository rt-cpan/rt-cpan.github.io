<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #128505 for Net-SSLeay: Memory leak from Net::SSLeay::connect</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #128505 for Net-SSLeay: Memory leak from Net::SSLeay::connect</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-SSLeay/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SSLeay">Net-SSLeay CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">128505</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-SSLeay/Active/">Net-SSLeay</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
leonerd-cpan [...] leonerd.org.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-44414-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.85    </td>
  </tr>
  <tr id="CF-44415-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.86_04    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;13&nbsp;16:43:01&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Memory leak from Net::SSLeay::connect</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have a long-running process which talks lots of SSL, by constantly starting and shutting down new connections talking to many hosts.

Previously I had found and fixed some memory leaks visible at the SV heap level, and now the process no longer leaks according to SV count, but yet the virtual memory size still increases very linearly over time.

Having run this for a while in valgrind, I get the following leak report:

==9498== 109,623 &#40;7,392 direct, 102,231 indirect&#41; bytes in 22 blocks are definitely lost in loss record 143 of 143
==9498==    at 0x4C2BBAF: malloc &#40;in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so&#41;
==9498==    by 0xE34442D: CRYPTO_zalloc &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==9498==    by 0xE27BA27: ??? &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==9498==    by 0xE27987E: ??? &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==9498==    by 0xE279F5C: ASN1_item_ex_d2i &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==9498==    by 0xE279FDA: ASN1_item_d2i &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==9498==    by 0xE3B156C: d2i_X509_AUX &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==9498==    by 0xE35763D: PEM_ASN1_read_bio &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==9498==    by 0xE3A152C: X509_load_cert_file &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==9498==    by 0xE3A0C6F: ??? &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==9498==    by 0xE3A516A: X509_STORE_CTX_get_by_subject &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==9498==    by 0xE3A588C: X509_STORE_CTX_get1_issuer &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==9498==    by 0xE3AA67E: ??? &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==9498==    by 0xE3AB47F: X509_verify_cert &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==9498==    by 0xDF915D7: ??? &#40;in /usr/lib/x86_64-linux-gnu/libssl.so.1.1&#41;
==9498==    by 0xDFA3DCA: ??? &#40;in /usr/lib/x86_64-linux-gnu/libssl.so.1.1&#41;
==9498==    by 0xDFA14FE: ??? &#40;in /usr/lib/x86_64-linux-gnu/libssl.so.1.1&#41;
==9498==    by 0xDF99F60: SSL_do_handshake &#40;in /usr/lib/x86_64-linux-gnu/libssl.so.1.1&#41;
==9498==    by 0xDD367B0: XS_Net__SSLeay_connect &#40;SSLeay.c:2454&#41;
==9498==    by 0x242F1D: Perl_pp_entersub &#40;pp_hot.c:3988&#41;
==9498== 
==9498== LEAK SUMMARY:
==9498==    definitely lost: 7,829 bytes in 49 blocks
==9498==    indirectly lost: 107,020 bytes in 1,745 blocks

I&#39;m still investigating this, so I hope to have more details and analysis later.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;15&nbsp;12:32:05&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Feb 13 16:43:01 2019, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m still investigating this, so I hope to have more details and
&gt; analysis later.
</div>
On further investigation I have a reproducible minimal test. The test appears to be specific to certain hosts. Attached is the script.

In particular, most servers don&#39;t leak; e.g.
   www.google.com
   www.github.com
   www.ctrlo.com
   lenio.ctrlo.com

A few do, such examples are:
   app4.infosaas.uk
   web3.infosaas.uk

Unsure yet if it&#39;s related to the SSL certs themselves, or the way these hosts communicate SSL, or some other factor.

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> make-many-http-hits.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use warnings;

use IO::Async::Loop;
use Net::Async::HTTP;

# Most servers don&#39;t leak; e.g.
#   www.google.com
#   www.github.com
#   www.ctrlo.com
#   lenio.ctrlo.com
#
# A few do, such examples are:
#   app4.infosaas.uk
#   web3.infosaas.uk

my $HOST = &#34;app4.infosaas.uk&#34;;

my $loop = IO::Async::Loop-&gt;new;

# Don&#39;t add a single UA because that will use connection keepalive. We&#39;ll
# burn memory faster by constantly making them and throwing them away again

sub do_a_request
{
   my &#40; $host &#41; = @_;

   print STDERR &#34;Requesting $host...\n&#34;;

   $loop-&gt;add&#40; my $ua = Net::Async::HTTP-&gt;new &#41;;

   $ua-&gt;GET&#40; &#34;https://$host&#34; &#41;-&gt;then&#40; sub {
      print STDERR &#34;Done $host\n&#34;;

      $loop-&gt;remove&#40; $ua &#41;;
      Future-&gt;done;
   }&#41;;
}

while&#40;1&#41; {
   $loop-&gt;delay_future&#40; after =&gt; 1 &#41;-&gt;get;
   do_a_request&#40; $HOST &#41;-&gt;get;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;15&nbsp;13:39:26&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Using script gives me a nicely repeatable:

==5996== 1,883,000 &#40;140,800 direct, 1,742,200 indirect&#41; bytes in 400 blocks are definitely lost in loss record 125 of 125
==5996==    at 0x483577F: malloc &#40;vg_replace_malloc.c:299&#41;
==5996==    by 0x7DD2D38: CRYPTO_zalloc &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==5996==    by 0x7CF9F48: ??? &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==5996==    by 0x7CF79AA: ??? &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==5996==    by 0x7CF858C: ASN1_item_ex_d2i &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==5996==    by 0x7CF860A: ASN1_item_d2i &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==5996==    by 0x7E52E14: d2i_X509_AUX &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==5996==    by 0x7DE682C: PEM_ASN1_read_bio &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==5996==    by 0x7E42A15: X509_load_cert_file &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==5996==    by 0x7E42122: ??? &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==5996==    by 0x7E4676A: X509_STORE_CTX_get_by_subject &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==5996==    by 0x7E46EAC: X509_STORE_CTX_get1_issuer &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==5996==    by 0x7E4BBBD: ??? &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==5996==    by 0x7E4CCB5: X509_verify_cert &#40;in /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1&#41;
==5996==    by 0x7BE1EC7: ??? &#40;in /usr/lib/x86_64-linux-gnu/libssl.so.1.1&#41;
==5996==    by 0x7C032D3: ??? &#40;in /usr/lib/x86_64-linux-gnu/libssl.so.1.1&#41;
==5996==    by 0x7C05834: ??? &#40;in /usr/lib/x86_64-linux-gnu/libssl.so.1.1&#41;
==5996==    by 0x7BFF392: ??? &#40;in /usr/lib/x86_64-linux-gnu/libssl.so.1.1&#41;
==5996==    by 0x7BEB1C3: SSL_do_handshake &#40;in /usr/lib/x86_64-linux-gnu/libssl.so.1.1&#41;
==5996==    by 0x7B3F64F: XS_Net__SSLeay_connect &#40;SSLeay.c:2451&#41;
==5996==    by 0x25CF44: Perl_pp_entersub &#40;pp_hot.c:5232&#41;
==5996==    by 0x215CA9: Perl_runops_debug &#40;dump.c:2539&#41;
==5996==    by 0x16DFD3: Perl_call_sv &#40;perl.c:3004&#41;
==5996==    by 0x4875C23: ??? &#40;in /usr/lib/x86_64-linux-gnu/perl5/5.28/auto/Linux/Epoll/Epoll.so&#41;
==5996==    by 0x25CF44: Perl_pp_entersub &#40;pp_hot.c:5232&#41;
==5996==    by 0x215CA9: Perl_runops_debug &#40;dump.c:2539&#41;
==5996==    by 0x179C7D: S_run_body &#40;perl.c:2694&#41;
==5996==    by 0x179C7D: perl_run &#40;perl.c:2617&#41;
==5996==    by 0x13E36D: main &#40;perlmain.c:122&#41;

The number &#34;400 blocks&#34; is nicely round probably because I let the script run 200 iterations of the loop.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;07&nbsp;11:45:42&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Now with full symbol names and source location information because I installed libssl1.1-dbgsym:

==1803== 1,759,200 &#40;140,800 direct, 1,618,400 indirect&#41; bytes in 400 blocks are definitely lost in loss record 85 of 85
==1803==    at 0x483577F: malloc &#40;vg_replace_malloc.c:299&#41;
==1803==    by 0x7DAFD38: CRYPTO_zalloc &#40;mem.c:230&#41;
==1803==    by 0x7CD6F48: asn1_item_embed_new &#40;tasn_new.c:122&#41;
==1803==    by 0x7CD49AA: asn1_item_embed_d2i &#40;tasn_dec.c:306&#41;
==1803==    by 0x7CD558C: ASN1_item_ex_d2i &#40;tasn_dec.c:124&#41;
==1803==    by 0x7CD560A: ASN1_item_d2i &#40;tasn_dec.c:114&#41;
==1803==    by 0x7E2FE14: d2i_X509_AUX &#40;x_x509.c:118&#41;
==1803==    by 0x7DC382C: PEM_ASN1_read_bio &#40;pem_oth.c:31&#41;
==1803==    by 0x7E1FA15: X509_load_cert_file &#40;by_file.c:90&#41;
==1803==    by 0x7E1F122: get_cert_by_subject &#40;by_dir.c:317&#41;
==1803==    by 0x7E2376A: X509_STORE_CTX_get_by_subject &#40;x509_lu.c:307&#41;
==1803==    by 0x7E23EAC: X509_STORE_CTX_get1_issuer &#40;x509_lu.c:669&#41;
==1803==    by 0x7E28BBD: get_issuer &#40;x509_vfy.c:2852&#41;
==1803==    by 0x7E28BBD: build_chain &#40;x509_vfy.c:2991&#41;
==1803==    by 0x7E28BBD: verify_chain &#40;x509_vfy.c:216&#41;
==1803==    by 0x7E29CB5: X509_verify_cert &#40;x509_vfy.c:295&#41;
==1803==    by 0x7BBEEC7: ssl_verify_cert_chain &#40;ssl_cert.c:430&#41;
==1803==    by 0x7BE02D3: tls_process_server_certificate &#40;statem_clnt.c:1907&#41;
==1803==    by 0x7BE2834: ossl_statem_client_process_message &#40;statem_clnt.c:1045&#41;
==1803==    by 0x7BDC392: read_state_machine &#40;statem.c:634&#41;
==1803==    by 0x7BDC392: state_machine.part.5 &#40;statem.c:432&#41;
==1803==    by 0x7BC81C3: SSL_do_handshake &#40;ssl_lib.c:3579&#41;
==1803==    by 0x7B2C64F: XS_Net__SSLeay_connect &#40;SSLeay.c:2451&#41;
...

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;07&nbsp;13:35:21&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">And now with a bit of annotation from the source code files themselves:

==1803== 1,759,200 &#40;140,800 direct, 1,618,400 indirect&#41; bytes in 400 blocks are definitely lost in loss record 85 of 85
==1803==    at 0x483577F: malloc &#40;vg_replace_malloc.c:299&#41;
==1803==    by 0x7DAFD38: CRYPTO_zalloc &#40;mem.c:230&#41;
==1803==    by 0x7CD6F48: asn1_item_embed_new &#40;tasn_new.c:122&#41;
        if &#40;embed&#41; {
            memset&#40;*pval, 0, it-&gt;size&#41;;
        } else {
            *pval = OPENSSL_zalloc&#40;it-&gt;size&#41;;
            if &#40;*pval == NULL&#41;
                goto memerr;
        }

==1803==    by 0x7CD49AA: asn1_item_embed_d2i &#40;tasn_dec.c:306&#41;
        if &#40;!*pval &#38;&#38; !ASN1_item_ex_new&#40;pval, it&#41;&#41; {
            ASN1err&#40;ASN1_F_ASN1_ITEM_EMBED_D2I, ERR_R_NESTED_ASN1_ERROR&#41;;
            goto err;
        }

==1803==    by 0x7CD558C: ASN1_item_ex_d2i &#40;tasn_dec.c:124&#41;
    rv = asn1_item_embed_d2i&#40;pval, in, len, it, tag, aclass, opt, ctx, 0&#41;;

==1803==    by 0x7CD560A: ASN1_item_d2i &#40;tasn_dec.c:114&#41;
    if &#40;ASN1_item_ex_d2i&#40;pval, in, len, it, -1, 0, 0, &#38;c&#41; &gt; 0&#41;
        return *pval;

==1803==    by 0x7E2FE14: d2i_X509_AUX &#40;x_x509.c:118&#41;
&#40;&#40;Via macro IMPLEMENT_ASN1_FUNCTIONS&#40;X509&#41; &#41;&#41;
    ret = d2i_X509&#40;a, &#38;q, length&#41;;

==1803==    by 0x7DC382C: PEM_ASN1_read_bio &#40;pem_oth.c:31&#41;
d2i_of_void *d2i;

    ret = d2i&#40;x, &#38;p, len&#41;;

==1803==    by 0x7E1FA15: X509_load_cert_file &#40;by_file.c:90&#41;
            x = PEM_read_bio_X509_AUX&#40;in, NULL, NULL, &#34;&#34;&#41;;

==1803==    by 0x7E1F122: get_cert_by_subject &#40;by_dir.c:317&#41;
            if &#40;type == X509_LU_X509&#41; {
                if &#40;&#40;X509_load_cert_file&#40;xl, b-&gt;data, ent-&gt;dir_type&#41;&#41; == 0&#41;
                    break;

==1803==    by 0x7E2376A: X509_STORE_CTX_get_by_subject &#40;x509_lu.c:307&#41;
            lu = sk_X509_LOOKUP_value&#40;ctx-&gt;get_cert_methods, i&#41;;
            j = X509_LOOKUP_by_subject&#40;lu, type, name, &#38;stmp&#41;;

==1803==    by 0x7E23EAC: X509_STORE_CTX_get1_issuer &#40;x509_lu.c:669&#41;
    xn = X509_get_issuer_name&#40;x&#41;;
    ok = X509_STORE_CTX_get_by_subject&#40;ctx, X509_LU_X509, xn, obj&#41;;


These bottom few frames are concerning themselves with reading issuer certs off the disk, in order to verify the one received on the new connection.

I have additionally made the observation that the two leaking certs were
generated by Lets Encrypt

        Issuer: C = US, O = Let&#39;s Encrypt, CN = Let&#39;s Encrypt Authority X3

and the two nonleaking ones by DigiCert:

        Issuer: C = US, O = DigiCert Inc, OU = www.digicert.com, CN = RapidSSL RSA CA 2018

There may be something in that; perhaps something related to loading the issuer CA cert off the disk, rather than relating to the cert served by the https server *itself*

As it happens, my personal server also uses LE, so I can also test against that one and see if similar things happen there.

Either way; this is feeling verymuch like a bug inside libssl itself, and not the fault of Net::SSLeay, but lacking anywhere else to write about it at present I shall continue here for now. Perhaps when I have something more concrete I&#39;ll send it upstream.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;07&nbsp;13:41:50&nbsp;2019</span>
    <span class="description">chrisn [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for investigating this, Paul. I was just trying to reproduce the problem locally using make-many-http-hits.pl, but wasn&#39;t able to &#40;with Perl 5.22.2, OpenSSL 1.1.1b, Net-SSLeay master branch&#41;. Could you share some more details about your setup?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;07&nbsp;13:41:51&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;07&nbsp;13:46:43&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Mar 07 13:41:50 2019, CHRISN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for investigating this, Paul. I was just trying to reproduce
&gt; the problem locally using make-many-http-hits.pl, but wasn&#39;t able to
&gt; &#40;with Perl 5.22.2, OpenSSL 1.1.1b, Net-SSLeay master branch&#41;. Could
&gt; you share some more details about your setup?
</div>
Oooh, that&#39;s interesting. Same host?

In case it&#39;s relevant then:

$ perl -v

This is perl 5, version 28, subversion 1 &#40;v5.28.1&#41; built for x86_64-linux-gnu-thread-multi

&#40;from debian package&#41;
ii  perl           5.28.1-4     amd64        Larry Wall&#39;s Practical Extraction a

$ perlmodversion Net::SSLeay
1.85

ii  libssl1.1:amd64 1.1.1a-1     amd64        Secure Sockets Layer toolkit - sha

I&#39;m only using libssl 1.1.1a-1. I can try updating to 1.1.1b from debian/unstable and see if that changes things.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;07&nbsp;21:46:23&nbsp;2019</span>
    <span class="description">chrisn [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Mar 07 18:46:43 2019, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Mar 07 13:41:50 2019, CHRISN wrote:
<div class="message-stanza open">&gt; &gt; Thanks for investigating this, Paul. I was just trying to reproduce
&gt; &gt; the problem locally using make-many-http-hits.pl, but wasn&#39;t able to
&gt; &gt; &#40;with Perl 5.22.2, OpenSSL 1.1.1b, Net-SSLeay master branch&#41;. Could
&gt; &gt; you share some more details about your setup?
</div>&gt; 
&gt; Oooh, that&#39;s interesting. Same host?
</div>
Yep, app4.infosaas.uk. The only change I made was to hardcode the while loop to 200 iterations, figuring that&#39;d be enough to reproduce the problem.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In case it&#39;s relevant then:
&gt; 
&gt; $ perl -v
&gt; 
&gt; This is perl 5, version 28, subversion 1 &#40;v5.28.1&#41; built for x86_64-
&gt; linux-gnu-thread-multi
&gt; 
&gt; &#40;from debian package&#41;
&gt; ii  perl           5.28.1-4     amd64        Larry Wall&#39;s Practical
&gt; Extraction a
&gt; 
&gt; $ perlmodversion Net::SSLeay
&gt; 1.85
&gt; 
&gt; ii  libssl1.1:amd64 1.1.1a-1     amd64        Secure Sockets Layer
&gt; toolkit - sha
&gt; 
&gt; I&#39;m only using libssl 1.1.1a-1. I can try updating to 1.1.1b from
&gt; debian/unstable and see if that changes things.
</div>
I&#39;ve just tried with a self-built copy of 1.1.1a but still couldn&#39;t reproduce it, so maybe there&#39;s more to it &#40;although I agree that it doesn&#39;t look like a leak in Net-SSLeay&#41;. I&#39;ll ask Heikki if he can reproduce it on his end...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;08&nbsp;06:03:38&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Mar 07 21:46:23 2019, CHRISN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Yep, app4.infosaas.uk. The only change I made was to hardcode the
&gt; while loop to 200 iterations, figuring that&#39;d be enough to reproduce
&gt; the problem.
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve just tried with a self-built copy of 1.1.1a but still couldn&#39;t
&gt; reproduce it, so maybe there&#39;s more to it &#40;although I agree that it
&gt; doesn&#39;t look like a leak in Net-SSLeay&#41;. I&#39;ll ask Heikki if he can
&gt; reproduce it on his end...
</div>
Indeed. I&#39;ve updated to 1.1.1b and that still leaks for this host.

$ ./pull-to-csv.pl -i 5
&#34;# timestamp&#34;,process_virtual_memory_bytes,process_resident_memory_bytes,perl_heap_svs
&#34;2019-03-08 10:54:21&#34;,46489600,37793792,83442
&#34;2019-03-08 10:54:26&#34;,46628864,37806080,82878
&#34;2019-03-08 10:54:31&#34;,46628864,37982208,82890
&#34;2019-03-08 10:54:36&#34;,46764032,37982208,83513
&#34;2019-03-08 10:54:41&#34;,46764032,37982208,82915
...
&#34;2019-03-08 10:55:46&#34;,47722496,39030784,83079
...
&#34;2019-03-08 10:56:36&#34;,48427008,39571456,84240
&#34;2019-03-08 10:56:41&#34;,48574464,39841792,83225
&#34;2019-03-08 10:56:46&#34;,48574464,39841792,83239


What&#39;s interesting is that my own home server is also using LE, using the same authority:

app4.infosaas.uk.PEM.txt:            X509v3 Authority Key Identifier: 
app4.infosaas.uk.PEM.txt-                keyid:A8:4A:6A:63:04:7D:DD:BA:E6:D1:39:B7:A6:45:65:EF:F3:A8:EC:A1
--
home.leonerd.org.uk.PEM.txt:            X509v3 Authority Key Identifier: 
home.leonerd.org.uk.PEM.txt-                keyid:A8:4A:6A:63:04:7D:DD:BA:E6:D1:39:B7:A6:45:65:EF:F3:A8:EC:A1
--

But yet doesn&#39;t show this leaking behaviour.

$ ./pull-to-csv.pl -i 5
&#34;# timestamp&#34;,process_virtual_memory_bytes,process_resident_memory_bytes,perl_heap_svs
&#34;2019-03-08 10:45:50&#34;,43565056,34701312,60914
&#34;2019-03-08 10:45:55&#34;,43565056,34729984,60958
&#34;2019-03-08 10:46:00&#34;,43565056,34729984,60967
&#34;2019-03-08 10:46:05&#34;,43708416,34729984,60974
&#34;2019-03-08 10:46:10&#34;,43708416,34729984,61625
&#34;2019-03-08 10:46:15&#34;,43708416,34729984,60990
&#34;2019-03-08 10:46:20&#34;,43708416,34729984,60999
...
&#34;2019-03-08 10:47:25&#34;,43708416,34729984,61112
&#34;2019-03-08 10:47:30&#34;,43708416,34729984,61121
&#34;2019-03-08 10:47:35&#34;,43708416,34729984,61130


In case it still somehow related to the issuer cert, I notice mine is loading the cert *twice* for the leaking host, but only once for the nonleaky one:

$ strace -e file ...
...
Requesting app4.infosaas.uk &#40;5 of 200&#41;...
stat&#40;&#34;/usr/lib/ssl/certs&#34;, {st_mode=S_IFDIR|0755, st_size=20480, ...}&#41; = 0
openat&#40;AT_FDCWD, &#34;/usr/lib/ssl/certs&#34;, O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY&#41; = 8
stat&#40;&#34;/usr/lib/ssl/certs/4f06f81d.0&#34;, 0x7fff47d47a00&#41; = -1 ENOENT &#40;No such file or directory&#41;
stat&#40;&#34;/usr/lib/ssl/certs/2e5ac55d.0&#34;, {st_mode=S_IFREG|0644, st_size=1200, ...}&#41; = 0
openat&#40;AT_FDCWD, &#34;/usr/lib/ssl/certs/2e5ac55d.0&#34;, O_RDONLY&#41; = 8
stat&#40;&#34;/usr/lib/ssl/certs/2e5ac55d.1&#34;, 0x7fff47d47a00&#41; = -1 ENOENT &#40;No such file or directory&#41;
stat&#40;&#34;/etc/localtime&#34;, {st_mode=S_IFREG|0644, st_size=3687, ...}&#41; = 0
stat&#40;&#34;/etc/localtime&#34;, {st_mode=S_IFREG|0644, st_size=3687, ...}&#41; = 0
stat&#40;&#34;/usr/lib/ssl/certs&#34;, {st_mode=S_IFDIR|0755, st_size=20480, ...}&#41; = 0
openat&#40;AT_FDCWD, &#34;/usr/lib/ssl/certs&#34;, O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY&#41; = 10
stat&#40;&#34;/usr/lib/ssl/certs/4f06f81d.0&#34;, 0x7fff47d47a00&#41; = -1 ENOENT &#40;No such file or directory&#41;
stat&#40;&#34;/usr/lib/ssl/certs/2e5ac55d.0&#34;, {st_mode=S_IFREG|0644, st_size=1200, ...}&#41; = 0
openat&#40;AT_FDCWD, &#34;/usr/lib/ssl/certs/2e5ac55d.0&#34;, O_RDONLY&#41; = 10
stat&#40;&#34;/usr/lib/ssl/certs/2e5ac55d.1&#34;, 0x7fff47d47a00&#41; = -1 ENOENT &#40;No such file or directory&#41;
stat&#40;&#34;/etc/localtime&#34;, {st_mode=S_IFREG|0644, st_size=3687, ...}&#41; = 0
stat&#40;&#34;/etc/localtime&#34;, {st_mode=S_IFREG|0644, st_size=3687, ...}&#41; = 0
Done app4.infosaas.uk


$ strace -e file ...
...
Requesting home.leonerd.org.uk &#40;17 of 200&#41;...
stat&#40;&#34;/usr/lib/ssl/certs&#34;, {st_mode=S_IFDIR|0755, st_size=20480, ...}&#41; = 0
openat&#40;AT_FDCWD, &#34;/usr/lib/ssl/certs&#34;, O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY&#41; = 8
stat&#40;&#34;/usr/lib/ssl/certs/4f06f81d.0&#34;, 0x7ffcd8b037a0&#41; = -1 ENOENT &#40;No such file or directory&#41;
stat&#40;&#34;/usr/lib/ssl/certs/2e5ac55d.0&#34;, {st_mode=S_IFREG|0644, st_size=1200, ...}&#41; = 0
openat&#40;AT_FDCWD, &#34;/usr/lib/ssl/certs/2e5ac55d.0&#34;, O_RDONLY&#41; = 8
stat&#40;&#34;/usr/lib/ssl/certs/2e5ac55d.1&#34;, 0x7ffcd8b037a0&#41; = -1 ENOENT &#40;No such file or directory&#41;
Done home.leonerd.org.uk


If it&#39;s useful to compare if the file is identical to yours:

$ sha256sum /usr/lib/ssl/certs/2e5ac55d.0
139a5e4a4e0fa505378c72c5f700934ce8333f4e6b1b508886c4b0eb14f4be99  /usr/lib/ssl/certs/2e5ac55d.0


-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;14&nbsp;10:49:25&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Mar 08 06:03:38 2019, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In case it still somehow related to the issuer cert, I notice mine is
&gt; loading the cert *twice* for the leaking host, but only once for the
&gt; nonleaky one:
</div>
Further on this, I&#39;ve done some gdb&#39;ing

&#40;gdb&#41; break X509_load_cert_file
&#40;gdb&#41; break X509_verify_cert

Running in either leaky or non-leaky case it starts off the same:

Breakpoint 2, X509_verify_cert &#40;ctx=ctx@entry=0x555555a983b0&#41;
    at ../crypto/x509/x509_vfy.c:255
255         SSL_DANE *dane = ctx-&gt;dane;
&#40;gdb&#41; bt
#0  X509_verify_cert &#40;ctx=ctx@entry=0x555555a983b0&#41; at ../crypto/x509/x509_vfy.c:255
#1  0x00007ffff7425ea8 in ssl_verify_cert_chain &#40;s=s@entry=0x555556bc0210,
    sk=sk@entry=0x555556bc2340&#41; at ../ssl/ssl_cert.c:430
#2  0x00007ffff7447433 in tls_process_server_certificate &#40;s=0x555556bc0210,
    pkt=0x7fffffffd950&#41; at ../ssl/statem/statem_clnt.c:1907
#3  0x00007ffff7449a05 in ossl_statem_client_process_message &#40;s=0x555556bc0210,
    pkt=&lt;optimized out&gt;&#41; at ../ssl/statem/statem_clnt.c:1045
#4  0x00007ffff7443423 in read_state_machine &#40;s=0x555556bc0210&#41;
    at ../ssl/statem/statem.c:634
#5  state_machine &#40;s=0x555556bc0210, server=0&#41; at ../ssl/statem/statem.c:432
#6  0x00007ffff742f1d4 in SSL_do_handshake &#40;s=0x555556bc0210&#41; at ../ssl/ssl_lib.c:3579
#7  0x00007ffff7501650 in XS_Net__SSLeay_connect &#40;my_perl=&lt;optimized out&gt;,
    cv=&lt;optimized out&gt;&#41; at SSLeay.c:2451
...

Breakpoint 1, X509_load_cert_file &#40;ctx=ctx@entry=0x555556bb7ca0, 
    file=0x555556bd3810 &#34;/usr/lib/ssl/certs/2e5ac55d.0&#34;, type=1&#41;
    at ../crypto/x509/by_file.c:81
81          in = BIO_new&#40;BIO_s_file&#40;&#41;&#41;;
&#40;gdb&#41; bt
#0  X509_load_cert_file &#40;ctx=ctx@entry=0x555556bb7ca0, 
    file=0x555556bd3810 &#34;/usr/lib/ssl/certs/2e5ac55d.0&#34;, type=1&#41;
    at ../crypto/x509/by_file.c:81
#1  0x00007ffff730d2a3 in get_cert_by_subject &#40;xl=0x555556bb7ca0, type=X509_LU_X509, 
    name=&lt;optimized out&gt;, ret=0x7fffffffd690&#41; at ../crypto/x509/by_dir.c:317
#2  0x00007ffff73118fb in X509_STORE_CTX_get_by_subject &#40;vs=vs@entry=0x555555a983b0, 
    type=type@entry=X509_LU_X509, name=name@entry=0x555556bb5860, 
    ret=ret@entry=0x555556bd37a0&#41; at ../crypto/x509/x509_lu.c:307
#3  0x00007ffff731203d in X509_STORE_CTX_get1_issuer &#40;issuer=0x7fffffffd780, 
    ctx=0x555555a983b0, x=0x5555558b4690&#41; at ../crypto/x509/x509_lu.c:669
#4  0x00007ffff7316d5e in get_issuer &#40;cert=0x5555558b4690, ctx=0x555555a983b0, 
    issuer=0x7fffffffd780&#41; at ../crypto/x509/x509_vfy.c:2852
#5  build_chain &#40;ctx=&lt;optimized out&gt;&#41; at ../crypto/x509/x509_vfy.c:2991
#6  verify_chain &#40;ctx=0x555555a983b0&#41; at ../crypto/x509/x509_vfy.c:216
#7  0x00007ffff7317e56 in X509_verify_cert &#40;ctx=ctx@entry=0x555555a983b0&#41;
    at ../crypto/x509/x509_vfy.c:295
&#40;inside above&#41;
...

But at this point, a non-leaking host will stop after that - just one invocation of X509_verify_cert that invokes X509_load_cert_file just once. On a leaking host, there are a number more invocations:

Breakpoint 2, X509_verify_cert &#40;ctx=ctx@entry=0x5555559b2ba0&#41;
    at ../crypto/x509/x509_vfy.c:255
255         SSL_DANE *dane = ctx-&gt;dane;
&#40;gdb&#41; bt
#0  X509_verify_cert &#40;ctx=ctx@entry=0x5555559b2ba0&#41; at ../crypto/x509/x509_vfy.c:255
#1  0x00007ffff72ad540 in OCSP_basic_verify &#40;bs=bs@entry=0x555556be94c0, 
    certs=certs@entry=0x0, st=st@entry=0x5555569e61a0, flags=&lt;optimized out&gt;, 
    flags@entry=0&#41; at ../crypto/ocsp/ocsp_vfy.c:88
#2  0x00007ffff7515863 in XS_Net__SSLeay_OCSP_response_verify &#40;my_perl=&lt;optimized out&gt;, 
    cv=&lt;optimized out&gt;&#41; at SSLeay.xs:6688
#3  0x00005555556405d1 in Perl_pp_entersub &#40;my_perl=0x555555869260&#41; at pp_hot.c:5232
#4  0x00005555556368f6 in Perl_runops_standard &#40;my_perl=0x555555869260&#41; at run.c:42
#5  0x0000555555678909 in S_docatch &#40;my_perl=0x555555869260, 
    firstpp=firstpp@entry=0x555555686200 &lt;Perl_pp_entereval&gt;&#41; at pp_ctl.c:3241
#6  0x000055555568681c in Perl_pp_entereval &#40;my_perl=0x555555869260&#41; at pp_ctl.c:4379
#7  0x00005555556368f6 in Perl_runops_standard &#40;my_perl=0x555555869260&#41; at run.c:42
#8  0x00005555555a9d75 in Perl_call_sv &#40;my_perl=0x555555869260, 
    sv=sv@entry=0x555556b839e8, flags=flags@entry=2&#41; at perl.c:3004
#9  0x00007ffff75108ca in tlsext_status_cb_invoke &#40;ssl=&lt;optimized out&gt;, 
    arg=&lt;optimized out&gt;&#41; at SSLeay.xs:839
#10 0x00007ffff74497a9 in tls_process_initial_server_flight &#40;s=0x555556b9ebc0&#41;
    at ../ssl/statem/statem_clnt.c:2831
#11 tls_process_initial_server_flight &#40;s=0x555556b9ebc0&#41;
    at ../ssl/statem/statem_clnt.c:2813
#12 0x00007ffff7449880 in tls_process_server_done &#40;s=0x555556b9ebc0, pkt=&lt;optimized out&gt;&#41;
    at ../ssl/statem/statem_clnt.c:2877
#13 0x00007ffff7449a45 in ossl_statem_client_process_message &#40;s=0x555556b9ebc0, 
    pkt=&lt;optimized out&gt;&#41; at ../ssl/statem/statem_clnt.c:1060
#14 0x00007ffff7443423 in read_state_machine &#40;s=0x555556b9ebc0&#41;
    at ../ssl/statem/statem.c:634
#15 state_machine &#40;s=0x555556b9ebc0, server=0&#41; at ../ssl/statem/statem.c:432
#16 0x00007ffff742f1d4 in SSL_do_handshake &#40;s=0x555556b9ebc0&#41; at ../ssl/ssl_lib.c:3579
#17 0x00007ffff7501650 in XS_Net__SSLeay_connect &#40;my_perl=&lt;optimized out&gt;, 
    cv=&lt;optimized out&gt;&#41; at SSLeay.c:2451

Breakpoint 2, X509_verify_cert &#40;ctx=ctx@entry=0x5555559b2ba0&#41;
    at ../crypto/x509/x509_vfy.c:255
255         SSL_DANE *dane = ctx-&gt;dane;
&#40;gdb&#41; bt
#0  X509_verify_cert &#40;ctx=ctx@entry=0x5555559b2ba0&#41; at ../crypto/x509/x509_vfy.c:255
#1  0x00007ffff7425ea8 in ssl_verify_cert_chain &#40;s=s@entry=0x555556bf2440, 
    sk=sk@entry=0x5555569ffe30&#41; at ../ssl/ssl_cert.c:430
#2  0x00007ffff7447433 in tls_process_server_certificate &#40;s=0x555556bf2440, 
    pkt=0x7fffffffd980&#41; at ../ssl/statem/statem_clnt.c:1907
#3  0x00007ffff7449a05 in ossl_statem_client_process_message &#40;s=0x555556bf2440, 
    pkt=&lt;optimized out&gt;&#41; at ../ssl/statem/statem_clnt.c:1045
#4  0x00007ffff7443423 in read_state_machine &#40;s=0x555556bf2440&#41;
    at ../ssl/statem/statem.c:634
#5  state_machine &#40;s=0x555556bf2440, server=0&#41; at ../ssl/statem/statem.c:432
#6  0x00007ffff742f1d4 in SSL_do_handshake &#40;s=0x555556bf2440&#41; at ../ssl/ssl_lib.c:3579
#7  0x00007ffff7501650 in XS_Net__SSLeay_connect &#40;my_perl=&lt;optimized out&gt;, 
    cv=&lt;optimized out&gt;&#41; at SSLeay.c:2451

Breakpoint 1, X509_load_cert_file &#40;ctx=ctx@entry=0x555556bed5a0, 
    file=0x555556c05bf0 &#34;/usr/lib/ssl/certs/2e5ac55d.0&#34;, type=1&#41;
    at ../crypto/x509/by_file.c:81
81          in = BIO_new&#40;BIO_s_file&#40;&#41;&#41;;
&#40;gdb&#41; bt
#0  X509_load_cert_file &#40;ctx=ctx@entry=0x555556bed5a0, 
    file=0x555556c05bf0 &#34;/usr/lib/ssl/certs/2e5ac55d.0&#34;, type=1&#41;
    at ../crypto/x509/by_file.c:81
#1  0x00007ffff730d2a3 in get_cert_by_subject &#40;xl=0x555556bed5a0, type=X509_LU_X509, 
    name=&lt;optimized out&gt;, ret=0x7fffffffd6c0&#41; at ../crypto/x509/by_dir.c:317
#2  0x00007ffff73118fb in X509_STORE_CTX_get_by_subject &#40;vs=vs@entry=0x5555559b2ba0, 
    type=type@entry=X509_LU_X509, name=name@entry=0x555556beffd0, 
    ret=ret@entry=0x555556c05b80&#41; at ../crypto/x509/x509_lu.c:307
#3  0x00007ffff731203d in X509_STORE_CTX_get1_issuer &#40;issuer=0x7fffffffd7b0, 
    ctx=0x5555559b2ba0, x=0x555556b968a0&#41; at ../crypto/x509/x509_lu.c:669
#4  0x00007ffff7316d5e in get_issuer &#40;cert=0x555556b968a0, ctx=0x5555559b2ba0, 
    issuer=0x7fffffffd7b0&#41; at ../crypto/x509/x509_vfy.c:2852
#5  build_chain &#40;ctx=&lt;optimized out&gt;&#41; at ../crypto/x509/x509_vfy.c:2991
#6  verify_chain &#40;ctx=0x5555559b2ba0&#41; at ../crypto/x509/x509_vfy.c:216
#7  0x00007ffff7317e56 in X509_verify_cert &#40;ctx=ctx@entry=0x5555559b2ba0&#41;
    at ../crypto/x509/x509_vfy.c:295
#8  0x00007ffff7425ea8 in ssl_verify_cert_chain &#40;s=s@entry=0x555556bf2440, 
    sk=sk@entry=0x5555569ffe30&#41; at ../ssl/ssl_cert.c:430
#9  0x00007ffff7447433 in tls_process_server_certificate &#40;s=0x555556bf2440, 
    pkt=0x7fffffffd980&#41; at ../ssl/statem/statem_clnt.c:1907
#10 0x00007ffff7449a05 in ossl_statem_client_process_message &#40;s=0x555556bf2440, 
    pkt=&lt;optimized out&gt;&#41; at ../ssl/statem/statem_clnt.c:1045
#11 0x00007ffff7443423 in read_state_machine &#40;s=0x555556bf2440&#41;
    at ../ssl/statem/statem.c:634
#12 state_machine &#40;s=0x555556bf2440, server=0&#41; at ../ssl/statem/statem.c:432
#13 0x00007ffff742f1d4 in SSL_do_handshake &#40;s=0x555556bf2440&#41; at ../ssl/ssl_lib.c:3579
#14 0x00007ffff7501650 in XS_Net__SSLeay_connect &#40;my_perl=&lt;optimized out&gt;, 
    cv=&lt;optimized out&gt;&#41; at SSLeay.c:2451

Breakpoint 2, X509_verify_cert &#40;ctx=ctx@entry=0x5555559b2ba0&#41;
    at ../crypto/x509/x509_vfy.c:255
255         SSL_DANE *dane = ctx-&gt;dane;
&#40;gdb&#41; bt
#0  X509_verify_cert &#40;ctx=ctx@entry=0x5555559b2ba0&#41; at ../crypto/x509/x509_vfy.c:255
#1  0x00007ffff72ad540 in OCSP_basic_verify &#40;bs=bs@entry=0x555556c07630, 
    certs=certs@entry=0x0, st=st@entry=0x555556bb5250, flags=&lt;optimized out&gt;, 
    flags@entry=0&#41; at ../crypto/ocsp/ocsp_vfy.c:88
#2  0x00007ffff7515863 in XS_Net__SSLeay_OCSP_response_verify &#40;my_perl=&lt;optimized out&gt;, 
    cv=&lt;optimized out&gt;&#41; at SSLeay.xs:6688
#3  0x00005555556405d1 in Perl_pp_entersub &#40;my_perl=0x555555869260&#41; at pp_hot.c:5232
#4  0x00005555556368f6 in Perl_runops_standard &#40;my_perl=0x555555869260&#41; at run.c:42
#5  0x0000555555678909 in S_docatch &#40;my_perl=0x555555869260, 
    firstpp=0x5555556870c0 &lt;Perl_pp_entertry&gt;&#41; at pp_ctl.c:3241
#6  0x00005555556368f6 in Perl_runops_standard &#40;my_perl=0x555555869260&#41; at run.c:42
#7  0x00005555555a9d75 in Perl_call_sv &#40;my_perl=0x555555869260, 
    sv=sv@entry=0x555556b3c6c8, flags=flags@entry=2&#41; at perl.c:3004
#8  0x00007ffff75108ca in tlsext_status_cb_invoke &#40;ssl=&lt;optimized out&gt;, 
    arg=&lt;optimized out&gt;&#41; at SSLeay.xs:839
#9  0x00007ffff74497a9 in tls_process_initial_server_flight &#40;s=0x555556bf2440&#41;
    at ../ssl/statem/statem_clnt.c:2831
#10 tls_process_initial_server_flight &#40;s=0x555556bf2440&#41;
    at ../ssl/statem/statem_clnt.c:2813
#11 0x00007ffff7449880 in tls_process_server_done &#40;s=0x555556bf2440, pkt=&lt;optimized out&gt;&#41;
    at ../ssl/statem/statem_clnt.c:2877
#12 0x00007ffff7449a45 in ossl_statem_client_process_message &#40;s=0x555556bf2440, 
    pkt=&lt;optimized out&gt;&#41; at ../ssl/statem/statem_clnt.c:1060
#13 0x00007ffff7443423 in read_state_machine &#40;s=0x555556bf2440&#41;
    at ../ssl/statem/statem.c:634
#14 state_machine &#40;s=0x555556bf2440, server=0&#41; at ../ssl/statem/statem.c:432
#15 0x00007ffff742f1d4 in SSL_do_handshake &#40;s=0x555556bf2440&#41; at ../ssl/ssl_lib.c:3579
#16 0x00007ffff7501650 in XS_Net__SSLeay_connect &#40;my_perl=&lt;optimized out&gt;, 
    cv=&lt;optimized out&gt;&#41; at SSLeay.c:2451


These latter invocations appear to be coming from a nested perl call &#40;the perl_call_sv in the stack trace&#41;, related to the tls_status_cb. This doesn&#39;t seem to happen in the nonleaking host case.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;14&nbsp;11:18:33&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Stack traces summarised:

Nonleak just does one iteration of:

 X509_load_cert_file
 get_cert_by_subject
 X509_STORE_CTX_get_by_subject
 X509_STORE_CTX_get1_issuer
 get_issuer
 build_chain
 verify_chain
 X509_verify_cert
 ssl_verify_cert_chain
 tls_process_server_certificate
 ossl_statem_client_process_message
 read_state_machine
 state_machine
 SSL_do_handshake
 XS_Net__SSLeay_connect

Leaky case does that, followed by

 X509_verify_cert
 OCSP_basic_verify
 XS_Net__SSLeay_OCSP_response_verify
 Perl_pp_entersub
 Perl_runops_standard
 S_docatch
 Perl_pp_entereval
 Perl_runops_standard
 Perl_call_sv
 tlsext_status_cb_invoke
 tls_process_initial_server_flight
 tls_process_initial_server_flight
 tls_process_server_done
 ossl_statem_client_process_message
 read_state_machine
 state_machine
 SSL_do_handshake
 XS_Net__SSLeay_connect

then repeats the entire process a second time, this time curiously lacking the Perl_pp_entereval.

I haven&#39;t yet analysed where in relation to these stacktraces the actual leak happens. That&#39;s next...

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;14&nbsp;11:36:35&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Mar 14 11:18:33 2019, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Stack traces summarised:
&gt; 
&gt; Nonleak just does one iteration of:
&gt; 
</div>...
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; tls_process_server_certificate
&gt; ossl_statem_client_process_message
&gt; read_state_machine
&gt; state_machine
&gt; SSL_do_handshake
&gt; XS_Net__SSLeay_connect
</div>
This part of the stacktrace is in response of &#40;both&#41; servers sending a TLS_ST_CR_CERT message, which ssl/statem/statem_clnt.c processes.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Leaky case does that, followed by
&gt; 
</div>...
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; tls_process_server_done
&gt; ossl_statem_client_process_message
&gt; read_state_machine
&gt; state_machine
&gt; SSL_do_handshake
&gt; XS_Net__SSLeay_connect
</div>
This part is as a result of TLS_ST_CR_SRVR_DONE, which the nonleaking server seems not to issue.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;14&nbsp;12:04:47&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Much more prodding by using

 $ PERL_DESTRUCT_LEVEL=2 valgrind --vgdb=yes --vgdb-error=0 debugperl make-many-http-hits.pl 

meanwhile

 $ gdb debugperl
 &#40;gdb&#41; target remote | vgdb
 &#40;gdb&#41; break X509_load_cert_file

I trace what happens inside int X509_load_cert_file&#40;&#41; &#40;crypto/x509/by_file.c:74&#41;

I print the value of x after line 90 each time:

&#40;gdb&#41; p x
$8 = &#40;X509 *&#41; 0x4fd8490

...

&#40;gdb&#41; p x
$11 = &#40;X509 *&#41; 0x536d280

thus obtaining two addresses. Once it finishes one iteration I ask for a leak report and inspect some blocks:

&#40;gdb&#41; monitor leak_check full definiteleak
...
==19506== 7,603 &#40;+7,603&#41; &#40;704 &#40;+704&#41; direct, 6,899 &#40;+6,899&#41; indirect&#41; bytes in 2 &#40;+2&#41; blocks are definitely lost in loss record 7,659 of 8,055
==19506==    at 0x483577F: malloc &#40;vg_replace_malloc.c:299&#41;
==19506==    by 0x7DAFD38: CRYPTO_zalloc &#40;mem.c:230&#41;
==19506==    by 0x7CD6F18: asn1_item_embed_new &#40;tasn_new.c:122&#41;
==19506==    by 0x7CD498A: asn1_item_embed_d2i &#40;tasn_dec.c:306&#41;
==19506==    by 0x7CD556C: ASN1_item_ex_d2i &#40;tasn_dec.c:124&#41;
==19506==    by 0x7CD55EA: ASN1_item_d2i &#40;tasn_dec.c:114&#41;
==19506==    by 0x7E2FFE4: d2i_X509_AUX &#40;x_x509.c:118&#41;
==19506==    by 0x7DC388C: PEM_ASN1_read_bio &#40;pem_oth.c:31&#41;
==19506==    by 0x7E1FBA5: X509_load_cert_file &#40;by_file.c:90&#41;
==19506==    by 0x7E1F2A2: get_cert_by_subject &#40;by_dir.c:317&#41;
==19506==    by 0x7E238FA: X509_STORE_CTX_get_by_subject &#40;x509_lu.c:307&#41;
==19506==    by 0x7E2403C: X509_STORE_CTX_get1_issuer &#40;x509_lu.c:669&#41;

&#40;gdb&#41; monitor block_list 7659
==19506== 7,603 &#40;+7,603&#41; &#40;704 &#40;+704&#41; direct, 6,899 &#40;+6,899&#41; indirect&#41; bytes in 2 &#40;+2&#41; blocks are definitely lost in loss record 7,659 of 8,055
==19506==    at 0x483577F: malloc &#40;vg_replace_malloc.c:299&#41;
==19506==    by 0x7DAFD38: CRYPTO_zalloc &#40;mem.c:230&#41;
==19506==    by 0x7CD6F18: asn1_item_embed_new &#40;tasn_new.c:122&#41;
==19506==    by 0x7CD498A: asn1_item_embed_d2i &#40;tasn_dec.c:306&#41;
==19506==    by 0x7CD556C: ASN1_item_ex_d2i &#40;tasn_dec.c:124&#41;
==19506==    by 0x7CD55EA: ASN1_item_d2i &#40;tasn_dec.c:114&#41;
==19506==    by 0x7E2FFE4: d2i_X509_AUX &#40;x_x509.c:118&#41;
==19506==    by 0x7DC388C: PEM_ASN1_read_bio &#40;pem_oth.c:31&#41;
==19506==    by 0x7E1FBA5: X509_load_cert_file &#40;by_file.c:90&#41;
==19506==    by 0x7E1F2A2: get_cert_by_subject &#40;by_dir.c:317&#41;
==19506==    by 0x7E238FA: X509_STORE_CTX_get_by_subject &#40;x509_lu.c:307&#41;
==19506==    by 0x7E2403C: X509_STORE_CTX_get1_issuer &#40;x509_lu.c:669&#41;
==19506== 0x4FD8490[352]
==19506==   0x4E97940[16] indirect loss record 4359
            ...
==19506== 0x536D280[352]
==19506==   0x57C3A00[256] indirect loss record 6690
...

and sure enough, those same two memory addresses appear in the loss records.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;14&nbsp;12:31:17&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">By comparison, if I pick the nonleaky host, I don&#39;t get this leak and instead I can see where it was freed:

&#40;gdb&#41; p x
$2 = &#40;X509 *&#41; 0x5001110

...

&#40;gdb&#41; monitor check_memory addressable 0x5001110
Address 0x5001110 len 1 not addressable:
bad address 0x5001110
 Address 0x5001110 is 0 bytes inside a block of size 352 free&#39;d
==22165==    at 0x48369AB: free &#40;vg_replace_malloc.c:530&#41;
==22165==    by 0x7CD692B: asn1_item_embed_free &#40;tasn_fre.c:115&#41;
==22165==    by 0x7CD69A4: ASN1_item_free &#40;tasn_fre.c:20&#41;
==22165==    by 0x7E22FF8: X509_OBJECT_free &#40;x509_lu.c:463&#41;
==22165==    by 0x7E10E3F: OPENSSL_sk_pop_free &#40;stack.c:368&#41;
==22165==    by 0x7E2352C: sk_X509_OBJECT_pop_free &#40;x509_vfy.h:58&#41;
==22165==    by 0x7E2352C: X509_STORE_free &#40;x509_lu.c:225&#41;
==22165==    by 0x7BC77C8: SSL_CTX_free &#40;ssl_lib.c:3110&#41;
==22165==    by 0x7BC77C8: SSL_CTX_free &#40;ssl_lib.c:3080&#41;
==22165==    by 0x7B3E0D6: XS_Net__SSLeay_CTX_free &#40;SSLeay.xs:1847&#41;
==22165==    by 0x25D444: Perl_pp_entersub &#40;pp_hot.c:5232&#41;
==22165==    by 0x2160C9: Perl_runops_debug &#40;dump.c:2539&#41;
==22165==    by 0x16E39C: Perl_call_sv &#40;perl.c:3021&#41;
==22165==    by 0x2658E9: S_curse &#40;sv.c:6938&#41;
 Block was alloc&#39;d at
==22165==    at 0x483577F: malloc &#40;vg_replace_malloc.c:299&#41;
==22165==    by 0x7DAFD38: CRYPTO_zalloc &#40;mem.c:230&#41;
==22165==    by 0x7CD6F18: asn1_item_embed_new &#40;tasn_new.c:122&#41;
==22165==    by 0x7CD498A: asn1_item_embed_d2i &#40;tasn_dec.c:306&#41;
==22165==    by 0x7CD556C: ASN1_item_ex_d2i &#40;tasn_dec.c:124&#41;
==22165==    by 0x7CD55EA: ASN1_item_d2i &#40;tasn_dec.c:114&#41;
==22165==    by 0x7E2FFE4: d2i_X509_AUX &#40;x_x509.c:118&#41;
==22165==    by 0x7DC388C: PEM_ASN1_read_bio &#40;pem_oth.c:31&#41;
==22165==    by 0x7E1FBA5: X509_load_cert_file &#40;by_file.c:90&#41;
==22165==    by 0x7E1F2A2: get_cert_by_subject &#40;by_dir.c:317&#41;
==22165==    by 0x7E238FA: X509_STORE_CTX_get_by_subject &#40;x509_lu.c:307&#41;
==22165==    by 0x7E2403C: X509_STORE_CTX_get1_issuer &#40;x509_lu.c:669&#41;


-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;14&nbsp;13:05:45&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Applying a debug-print patch:

--- openssl-1.1.1a.orig/crypto/x509/by_file.c
+++ openssl-1.1.1a/crypto/x509/by_file.c
@@ -98,6 +98,8 @@ int X509_load_cert_file&#40;X509_LOOKUP *ctx
                     goto err;
                 }
             }
+            fprintf&#40;stderr, &#34;LEODEBUG: add x=%p to store=%p\n&#34;,
+                x, ctx-&gt;store_ctx&#41;;
             i = X509_STORE_add_cert&#40;ctx-&gt;store_ctx, x&#41;;
             if &#40;!i&#41;
                 goto err;
--- openssl-1.1.1a.orig/crypto/x509/x509_lu.c
+++ openssl-1.1.1a/crypto/x509/x509_lu.c
@@ -209,6 +209,10 @@ void X509_STORE_free&#40;X509_STORE *vfy&#41;
 
     if &#40;vfy == NULL&#41;
         return;
+
+    fprintf&#40;stderr, &#34;LEODEBUG: free store=%p\n&#34;,
+        vfy&#41;;
+
     CRYPTO_DOWN_REF&#40;&#38;vfy-&gt;references, &#38;i, vfy-&gt;lock&#41;;
     REF_PRINT_COUNT&#40;&#34;X509_STORE&#34;, vfy&#41;;
     if &#40;i &gt; 0&#41;

Yields in a leaky case:

Requesting app4.infosaas.uk &#40;1 of 200&#41;...
LEODEBUG: add x=0x55a94ac6e3f0 to store=0x55a94bf33600
LEODEBUG: add x=0x55a94ab6f100 to store=0x55a94bf6b020
Done app4.infosaas.uk
LEODEBUG: free store=0x55a94bf33600
LEODEBUG: free store=0x55a94bf6b020
Requesting app4.infosaas.uk &#40;2 of 200&#41;...
LEODEBUG: add x=0x55a94bf76a50 to store=0x55a94c1d97d0
LEODEBUG: add x=0x55a94acdbfb0 to store=0x55a94bf6a650
Done app4.infosaas.uk
LEODEBUG: free store=0x55a94c1d97d0
LEODEBUG: free store=0x55a94bf6a650
...

Whereas a non-leak is:

Requesting home.leonerd.org.uk &#40;1 of 200&#41;...
LEODEBUG: add x=0x5572c5cf04e0 to store=0x5572c6d8e930
Done home.leonerd.org.uk
LEODEBUG: free store=0x5572c6d8e930
Requesting home.leonerd.org.uk &#40;2 of 200&#41;...
LEODEBUG: add x=0x5572c70cf090 to store=0x5572c70ce4f0
Done home.leonerd.org.uk
LEODEBUG: free store=0x5572c70ce4f0
...

Looking at `monitor leak_check` in the leaky case reveals that it&#39;s usually both occasions of pointer that get leaked.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;14&nbsp;14:09:01&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">PROGRESS!

By adding more debug that prints the `references` count of the X509 objects at the time the store is thrown away, I get:

$ PERL_DESTRUCT_LEVEL=2 debugperl make-many-http-hits.pl
Requesting app4.infosaas.uk &#40;1 of 200&#41;...
LEODEBUG: add x=0x56498d56c3f0 to store=0x56498e910c20
LEODEBUG: free store=0x56498e910c20
LEODEBUG:  store contains 1 items
  [0] = x509=0x56498d56c3f0 &#40;references=2&#41;
LEODEBUG: add x=0x56498d6ba8d0 to store=0x56498e948de0
Done app4.infosaas.uk
LEODEBUG: free store=0x56498e948de0
LEODEBUG:  store contains 1 items
  [0] = x509=0x56498d6ba8d0 &#40;references=2&#41;
Requesting app4.infosaas.uk &#40;2 of 200&#41;...
LEODEBUG: add x=0x56498e949960 to store=0x56498e937a70
LEODEBUG: add x=0x56498d64cb00 to store=0x56498e9400b0
Done app4.infosaas.uk
LEODEBUG: free store=0x56498e937a70
LEODEBUG:  store contains 1 items
  [0] = x509=0x56498e949960 &#40;references=2&#41;
LEODEBUG: free store=0x56498e9400b0
LEODEBUG:  store contains 1 items
  [0] = x509=0x56498d64cb00 &#40;references=2&#41;

vs

$ PERL_DESTRUCT_LEVEL=2 debugperl make-many-http-hits.pl -h home.leonerd.org.uk
Requesting home.leonerd.org.uk &#40;1 of 200&#41;...
LEODEBUG: add x=0x55deeef3d570 to store=0x55def0203ac0
Done home.leonerd.org.uk
LEODEBUG: free store=0x55def0203ac0
LEODEBUG:  store contains 1 items
  [0] = x509=0x55deeef3d570 &#40;references=1&#41;
Requesting home.leonerd.org.uk &#40;2 of 200&#41;...
LEODEBUG: add x=0x55deeefab130 to store=0x55def0203b60
Done home.leonerd.org.uk
LEODEBUG: free store=0x55def0203b60
LEODEBUG:  store contains 1 items
  [0] = x509=0x55deeefab130 &#40;references=1&#41;

It seems the X509 objects have leaked a reference so when the store throws them away, the refcount doesn&#39;t hit zero yet but remains at 1. I wonder where that went...

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;15&nbsp;13:52:40&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;15&nbsp;14:36:40&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Mar 15 13:52:40 2019, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Applying some gdb `watch` magic to see where the refcount gets
&gt; tickled.
</div>
Analysing that long list of stack traces, I make the following summary:

 * X509 cert gets created &#40;references=1&#41;
 * gets added to store &#40;references=2&#41;
 * local variable gets dropped &#40;references=1&#41;

this seems fine so far.

 * some internal fiddling within
    ssl_verify_cert_chain ... as a result of tls_process_server_certificate
   references ends up being 2

Then the OCSP basic verify step comes in, invoked via tlsext_status_cb_invoke, through a separate perl interpreter level, working within OCSP_basic_verify. That fiddles with the cert but leaves reference count as 2 again by the end.

Then crucially are three modifications that appear unbalanced, all invoked from inside Net::SSLeay::OCSP_cert2ids:

up &#40;references=3&#41;
  X509_up_ref
  X509_STORE_CTX_get_by_subject
  X509_STORE_CTX_get1_issuer -&gt; find_issuer -&gt; Net::SSLeay::OCSP_cert2ids
  ...
  tlsext_status_cb_invoke
  tls_process_initial_server_flight -&gt; tls_process_initial_server_flight -&gt; tls_process_server_done
up &#40;references=4&#41;
  X509_up_ref
  X509_STORE_CTX_get1_issuer -&gt; find_issuer -&gt; Net::SSLeay::OCSP_cert2ids
  ...
  tlsext_status_cb_invoke
  tls_process_initial_server_flight -&gt; tls_process_initial_server_flight -&gt; tls_process_server_done
down &#40;references=3&#41;
  CRYPTO_DOWN_REF -&gt; asn1_do_lock -&gt; asn1_item_embed_free -&gt; ASN1_item_free
  X509_OBJECT_free
  X509_STORE_CTX_get1_issuer -&gt; find_issuer -&gt; Net::SSLeay::OCSP_cert2ids
  ...
  tlsext_status_cb_invoke
  tls_process_initial_server_flight -&gt; tls_process_initial_server_flight -&gt; tls_process_server_done

I believe it is this unbalancing step where the leak comes from, because at this point references=3, not restored to 2. Hereafter, the SSL library seems to clean itself up OK:

 * SSL_free cleans up one ref &#40;references=2&#41;
 * SSL_CTX_free cleans up one ref &#40;references=1&#41;

were it not for that unbalancing step at Net::SSLeay::OCSP_cert2ids, I believe now the reference count would be 0, and the memory reclaimed.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;15&nbsp;14:43:58&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Mar 15 14:36:40 2019, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I believe it is this unbalancing step where the leak comes from,
&gt; because at this point references=3, not restored to 2. Hereafter, the
&gt; SSL library seems to clean itself up OK:
</div>
Looking in SSLeay.xs at `find_issuer` function, I wonder if this explains it.

The function has two cases; maybe it&#39;ll find the issuer inside the &#34;chain&#34; argument - if so it returns a value taken directly from that STACK_OF&#40;X509&#41; objects:

  issuer = sk_X509_value&#40;chain,i&#41;;

that wouldn&#39;t increment a refcount. If it fails to find it there, it asks the X509_STORE for its issuer:

   int ok = X509_STORE_CTX_get1_issuer&#40;&#38;issuer,stx,cert&#41;;

Looking at the stack traces, it appears that this latter function does result in the X509&#39;s refcount being incremented. It appears that the other callers of `find_issuer` don&#39;t take account of this fact.

Speculating on this, I&#39;m going to add a refcount-increment step to the first half of that function, and then have all of find_issuer&#40;&#41;&#39;s callers remember to drop it again after they&#39;re done with the result.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;15&nbsp;14:53:33&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Mar 15 14:43:58 2019, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Speculating on this, I&#39;m going to add a refcount-increment step to the
&gt; first half of that function, and then have all of find_issuer&#40;&#41;&#39;s
&gt; callers remember to drop it again after they&#39;re done with the result.
</div>
I believe we&#39;re onto a winner :&#41;

The attached patch implements this strategy, and so far under my testing hasn&#39;t managed to leak any memory of any of the previously-problematic hostnames.

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt128505.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== modified file &#39;SSLeay.xs&#39;
--- SSLeay.xs	2019-02-15 18:23:30 +0000
+++ SSLeay.xs	2019-03-15 18:49:33 +0000
@@ -1651,6 +1651,7 @@
 	    if &#40; X509_check_issued&#40;sk_X509_value&#40;chain,i&#41;,cert&#41; == X509_V_OK &#41; {
 		TRACE&#40;2,&#34;found issuer in chain&#34;&#41;;
 		issuer = sk_X509_value&#40;chain,i&#41;;
+		X509_up_ref&#40;issuer&#41;;
 	    }
 	}
     }
@@ -6600,7 +6601,9 @@
 		croak&#40;&#34;no OCSP request for self-signed certificate&#34;&#41;;
 	    if &#40;!&#40;issuer = find_issuer&#40;cert,store,chain&#41;&#41;&#41;
 		croak&#40;&#34;cannot find issuer certificate&#34;&#41;;
-	    if &#40;!&#40;id = OCSP_cert_to_id&#40;EVP_sha1&#40;&#41;,cert,issuer&#41;&#41;&#41;
+	    id = OCSP_cert_to_id&#40;EVP_sha1&#40;&#41;,cert,issuer&#41;;
+	    X509_free&#40;issuer&#41;;
+	    if&#40;!id&#41;
 		croak&#40;&#34;out of memory for generating OCSP certid&#34;&#41;;
 
 	    pi = NULL;
@@ -6696,6 +6699,7 @@
 		ERR_clear_error&#40;&#41;; /* clear error from last OCSP_basic_verify */
 		if &#40;last &#38;&#38; &#40;issuer = find_issuer&#40;last,store,chain&#41;&#41;&#41; {
 		    OCSP_basic_add1_cert&#40;bsr, issuer&#41;;
+		    X509_free&#40;issuer&#41;;
 		    TRACE&#40;1,&#34;run OCSP_basic_verify with issuer for last chain element&#34;&#41;;
 		    RETVAL = OCSP_basic_verify&#40;bsr, NULL, store, flags&#41;;
 		}

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;15&nbsp;14:57:57&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Mar 15 14:43:58 2019, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The function has two cases; maybe it&#39;ll find the issuer inside the
&gt; &#34;chain&#34; argument - if so it returns a value taken directly from that
&gt; STACK_OF&#40;X509&#41; objects:
&gt; 
&gt; issuer = sk_X509_value&#40;chain,i&#41;;
&gt; 
&gt; that wouldn&#39;t increment a refcount. If it fails to find it there, it
&gt; asks the X509_STORE for its issuer:
&gt; 
&gt; int ok = X509_STORE_CTX_get1_issuer&#40;&#38;issuer,stx,cert&#41;;
&gt; 
&gt; Looking at the stack traces, it appears that this latter function does
&gt; result in the X509&#39;s refcount being incremented. It appears that the
&gt; other callers of `find_issuer` don&#39;t take account of this fact.
</div>
I suspect this might also explain why some hosts leak and some don&#39;t. The leak is all about whether the chain in the original server cert happened to contain the issuer in the right place, or not. Whether it did, makes the `find_issuer` function take one of two paths, resulting in mismatched refcounts depending on which path it took.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;16&nbsp;00:52:42&nbsp;2019</span>
    <span class="description">chrisn [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Mar 15 18:53:33 2019, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Mar 15 14:43:58 2019, PEVANS wrote:
<div class="message-stanza open">&gt; &gt; Speculating on this, I&#39;m going to add a refcount-increment step to
&gt; &gt; the
&gt; &gt; first half of that function, and then have all of find_issuer&#40;&#41;&#39;s
&gt; &gt; callers remember to drop it again after they&#39;re done with the result.
</div>&gt; 
&gt; I believe we&#39;re onto a winner :&#41;
&gt; 
&gt; The attached patch implements this strategy, and so far under my
&gt; testing hasn&#39;t managed to leak any memory of any of the previously-
&gt; problematic hostnames.
</div>
Thanks for the huge amount of investigative work you did on this, Paul, and I&#39;m glad you found the source of the problem in the end. Unfortunately, I realised what was going on as soon as you mentioned find_issuer&#40;&#41; --- Steffen Ullrich already spotted and fixed this specific leak with that function and its callers &#40;albeit in a different context&#41;, which explains why I wasn&#39;t able to reproduce the leak with the git master branch:

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/radiator-software/p5-net-ssleay/commit/0a648a564176b539e2022f61d4130fdbd9b7ef05">https://github.com/radiator-software/p5-net-ssleay/commit/0a648a564176b539e2022f61d4130fdbd9b7ef05</a></span>

Steffen&#39;s fix was quite similar to yours, the only difference being that he used X509_dup&#40;issuer&#41; in find_issuer&#40;&#41; where you instead used X509_up_ref&#40;issuer&#41;. Given the way the return value from find_issuer&#40;&#41; is used in SSLeay.xs, I think X509_dup&#40;&#41; is the best fit here.

Sorry for not connecting the dots sooner, it would&#39;ve saved you a lot of hassle. Thanks again for all the effort you put into tracking this down!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;16&nbsp;00:52:42&nbsp;2019</span>
    <span class="description">chrisn [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;16&nbsp;00:52:43&nbsp;2019</span>
    <span class="description">chrisn [...] cpan.org -  Fixed in 1.86_04 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
