<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #75687 for DBD-ODBC: Regression in 1.35 execute_for_fetch/execute_array  with freetds 0.82 &#40;current Debian stable&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #75687 for DBD-ODBC: Regression in 1.35 execute_for_fetch/execute_array  with freetds 0.82 &#40;current Debian stable&#41;</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DBD-ODBC">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DBD-ODBC">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DBD-ODBC">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DBD-ODBC">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-ODBC">DBD-ODBC CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">75687</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DBD-ODBC">DBD-ODBC</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ribasushi [...] leporine.io

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10188-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.35    </td>
  </tr>
  <tr id="CF-10189-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.36_2    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




ODBC_1.33_execute_array_PASS<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1048808/548250/ODBC_1.33_execute_array_PASS">
Sun Mar 11 06:04:43 2012 (148.2k) by ribasushi [...] leporine.io
</a>
</font></li>
</ul>


ODBC_1.33_execute_for_fetch_PASS<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1048808/548251/ODBC_1.33_execute_for_fetch_PASS">
Sun Mar 11 06:04:43 2012 (145.4k) by ribasushi [...] leporine.io
</a>
</font></li>
</ul>


ODBC_1.35_execute_array_FAIL<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1048808/548249/ODBC_1.35_execute_array_FAIL">
Sun Mar 11 06:04:43 2012 (105.6k) by ribasushi [...] leporine.io
</a>
</font></li>
</ul>


ODBC_1.35_execute_for_fetch_FAIL<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1048808/548248/ODBC_1.35_execute_for_fetch_FAIL">
Sun Mar 11 06:04:43 2012 (102.5k) by ribasushi [...] leporine.io
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=75687">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1048808" href="/Public/Bug/Display.html?id=75687#txn-1048808">#</a>      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;11&nbsp;06:04:43&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Regression in 1.35 execute_for_fetch/execute_array  with freetds
 0.82 &#40;current Debian stable&#41;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1048808/548247/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/548247">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Damn it, I should have tested this more :&#40;&#40;&#40;

Somewhat reduced test case:
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dbsrgits/dbix-class/blob/8c4e88c67d11ba11847e801e03a96d384ff616a5/t/746mssql.t">https://github.com/dbsrgits/dbix-class/blob/8c4e88c67d11ba11847e801e03a96d384ff616a5/t/746mssql.t</a></span>

Available in two incarnations - one is the original execute_array&#40;&#41;
based code &#40;8c4e88c67&#41; and the other the current master including the
new execute_for_fetch&#40;&#41; based code &#40;1d1906158&#41;.

I can try to reduce it more, let me know!

Attached is a run capture, and full level 5 traces of all 4 runs:


rabbit@Thesaurus:~/devel/dbic/dbgit$ perl Makefile.PL &#38;&gt;/dev/null ; git
rev-parse HEAD
8c4e88c67d11ba11847e801e03a96d384ff616a5
rabbit@Thesaurus:~/devel/dbic/dbgit$
DBI_TRACE=5=ODBC_1.33_execute_array_PASS prove -l t/746mssql.t 
t/746mssql.t .. ok   
Result: PASS

rabbit@Thesaurus:~/devel/dbic/dbgit$ perl Makefile.PL &#38;&gt;/dev/null ; git
rev-parse HEAD
1d190615808b90d101ee6c2bd6931458b861d344
rabbit@Thesaurus:~/devel/dbic/dbgit$
DBI_TRACE=5=ODBC_1.33_execute_for_fetch_PASS prove -l t/746mssql.t 
Result: PASS

rabbit@Thesaurus:~/devel/dbic/dbgit$ PERL_CPANM_OPT= cpanm DBD::ODBC
--&gt; Working on DBD::ODBC
...
Successfully installed DBD-ODBC-1.35 &#40;upgraded from 1.33&#41;

rabbit@Thesaurus:~/devel/dbic/dbgit$
DBI_TRACE=5=ODBC_1.35_execute_for_fetch_FAIL prove -l t/746mssql.t 
t/746mssql.t .. 3/? 
#   Failed test &#39;populate with PKs supplied ok&#39;
#   at t/746mssql.t line 101.
# died: DBIx::Class::Exception &#40;DBIx::Class::Schema::populate&#40;&#41;:
execute_for_fetch&#40;&#41; aborted with &#39;failed to retrieve diags&#39; at populate
slice:
# {
#   id =&gt; 2,
#   name =&gt; &#34;woggle&#34;
# } at t/746mssql.t line 83
# &#41;
t/746mssql.t .. 4/? 
#   Failed test &#39;populate with PKs supplied ok&#39;
#   at t/746mssql.t line 101.
# died: DBIx::Class::Exception &#40;DBIx::Class::Schema::populate&#40;&#41;:
execute_for_fetch&#40;&#41; aborted with &#39;failed to retrieve diags&#39; at populate
slice:
# {
#   id =&gt; 3,
#   name =&gt; &#34;boggle&#34;
# } at t/746mssql.t line 83
# &#41;
# Looks like you failed 2 tests of 5.
t/746mssql.t .. Dubious, test returned 2 &#40;wstat 512, 0x200&#41;
Failed 2/5 subtests 
        &#40;less 2 skipped subtests: 1 okay&#41;

Test Summary Report
-------------------
t/746mssql.t &#40;Wstat: 512 Tests: 5 Failed: 2&#41;
  Failed tests:  3-4
  Non-zero exit status: 2
Files=1, Tests=5,  9 wallclock secs &#40; 0.02 usr  0.00 sys +  0.30 cusr 
0.00 csys =  0.32 CPU&#41;
Result: FAIL


rabbit@Thesaurus:~/devel/dbic/dbgit$ perl Makefile.PL &#38;&gt;/dev/null ; git
rev-parse HEAD
8c4e88c67d11ba11847e801e03a96d384ff616a5
rabbit@Thesaurus:~/devel/dbic/dbgit$
DBI_TRACE=5=ODBC_1.35_execute_array_FAIL prove -l t/746mssql.t 
t/746mssql.t .. 3/? 
#   Failed test &#39;populate with PKs supplied ok&#39;
#   at t/746mssql.t line 100.
# died: DBIx::Class::Exception &#40;DBIx::Class::Schema::populate&#40;&#41;:
execute_array&#40;&#41; aborted with &#39;failed to retrieve diags&#39; at populate slice:
# {
#   id =&gt; 2,
#   name =&gt; &#34;woggle&#34;
# } at t/746mssql.t line 82
# &#41;
t/746mssql.t .. 4/? 
#   Failed test &#39;populate with PKs supplied ok&#39;
#   at t/746mssql.t line 100.
# died: DBIx::Class::Exception &#40;DBIx::Class::Schema::populate&#40;&#41;:
execute_array&#40;&#41; aborted with &#39;failed to retrieve diags&#39; at populate slice:
# {
#   id =&gt; 2,
#   name =&gt; &#34;woggle&#34;
# } at t/746mssql.t line 82
# &#41;
t/746mssql.t .. 5/? # Looks like you failed 2 tests of 5.
t/746mssql.t .. Dubious, test returned 2 &#40;wstat 512, 0x200&#41;
Failed 2/5 subtests 
        &#40;less 2 skipped subtests: 1 okay&#41;

Test Summary Report
-------------------
t/746mssql.t &#40;Wstat: 512 Tests: 5 Failed: 2&#41;
  Failed tests:  3-4
  Non-zero exit status: 2
Files=1, Tests=5, 10 wallclock secs &#40; 0.02 usr  0.00 sys +  0.30 cusr 
0.02 csys =  0.34 CPU&#41;
Result: FAIL
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ODBC_1.35_execute_for_fetch_FAIL</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1048808/548248/ODBC_1.35_execute_for_fetch_FAIL">Download ODBC_1.35_execute_for_fetch_FAIL</a><br />
<span class="downloadcontenttype">application/octet-stream 102.5k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ODBC_1.35_execute_array_FAIL</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1048808/548249/ODBC_1.35_execute_array_FAIL">Download ODBC_1.35_execute_array_FAIL</a><br />
<span class="downloadcontenttype">application/octet-stream 105.6k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ODBC_1.33_execute_array_PASS</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1048808/548250/ODBC_1.33_execute_array_PASS">Download ODBC_1.33_execute_array_PASS</a><br />
<span class="downloadcontenttype">application/octet-stream 148.2k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ODBC_1.33_execute_for_fetch_PASS</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1048808/548251/ODBC_1.33_execute_for_fetch_PASS">Download ODBC_1.33_execute_for_fetch_PASS</a><br />
<span class="downloadcontenttype">application/octet-stream 145.4k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1048825" href="/Public/Bug/Display.html?id=75687#txn-1048825">#</a>      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;11&nbsp;06:32:57&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1048825/548262/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/548262">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Mar 11 06:04:43 2012, RIBASUSHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Damn it, I should have tested this more :&#40;&#40;&#40;
</div>
Thanks Peter.

I know some ODBC drivers have bugs which prevent the native ODBC
execute_for_fetch working and I&#39;ve been trying to persuade people to fix
them. I&#39;ve not looked at your case yet as I&#39;m away this weekend so it
could just as easily be DBD::ODBC in this case. There is an attribute to
turn off the ODBC native execute_for_fetch &#40;which will work as a
workaround for now&#41;.

In the end, even though I knew some drivers would break I decided it was
better for the default to be on and it would hopefully force driver
writers to fix the issues, and have a switch to return to the old behaviour.

I&#39;ll look at this properly when I get home.

As always, I scoured the net/irc etc for people to test but as always, I
had little feedback. I cannot test all of the 100&#39;s &#40;and there are
easily over 100&#41; of ODBC drivers. Smokers don&#39;t help in this respect as
no one has DBI set up although book &#40;I think&#41; worte Test::Database to
help with this - perhaps you can speak to him at QA hackathon and see if
we can move it on a bit - it would be really worth while.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1048828" href="/Public/Bug/Display.html?id=75687#txn-1048828">#</a>      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;11&nbsp;06:32:59&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1048841" href="/Public/Bug/Display.html?id=75687#txn-1048841">#</a>      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;11&nbsp;06:39:24&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1048841/548271/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/548271">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Mar 11 06:32:57 2012, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun Mar 11 06:04:43 2012, RIBASUSHI wrote:
<div class="message-stanza open">&gt; &gt; Damn it, I should have tested this more :&#40;&#40;&#40;
</div>&gt; 
&gt; Thanks Peter.
&gt; 
&gt; I know some ODBC drivers have bugs which prevent the native ODBC
&gt; execute_for_fetch working and I&#39;ve been trying to persuade people to fix
&gt; them. I&#39;ve not looked at your case yet as I&#39;m away this weekend so it
&gt; could just as easily be DBD::ODBC in this case. There is an attribute to
&gt; turn off the ODBC native execute_for_fetch &#40;which will work as a
&gt; workaround for now&#41;.
&gt; 
&gt; In the end, even though I knew some drivers would break I decided it was
&gt; better for the default to be on and it would hopefully force driver
&gt; writers to fix the issues, and have a switch to return to the old
</div>behaviour.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I&#39;ll look at this properly when I get home.
&gt; 
&gt; As always, I scoured the net/irc etc for people to test but as always, I
&gt; had little feedback. I cannot test all of the 100&#39;s &#40;and there are
&gt; easily over 100&#41; of ODBC drivers. Smokers don&#39;t help in this respect as
&gt; no one has DBI set up although book &#40;I think&#41; worte Test::Database to
&gt; help with this - perhaps you can speak to him at QA hackathon and see if
&gt; we can move it on a bit - it would be really worth while.
&gt; 
&gt; Martin
</div>
&#34;failed to retrieve diags&#34; - same old same old issue with freeTDS. It
returns an error from an ODBC call and then does not provide any error
text - I guess. Should get a chance to look at it this evening or tomorrow.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1048844" href="/Public/Bug/Display.html?id=75687#txn-1048844">#</a>      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;11&nbsp;06:39:59&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75687] Regression in 1.35 execute_for_fetch/execute_array with freetds 0.82 &#40;current Debian stable&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 11 Mar 2012 11:39:46 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-ODBC [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;ribasushi [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1048844/548274/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/548274">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Martin J Evans via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75687">https://rt.cpan.org/Ticket/Display.html?id=75687</a></span> &gt;
&gt; 
&gt; On Sun Mar 11 06:04:43 2012, RIBASUSHI wrote:
<div class="message-stanza open">&gt;&gt; Damn it, I should have tested this more :&#40;&#40;&#40;
</div>&gt; 
&gt; Thanks Peter.
&gt; 
&gt; I know some ODBC drivers have bugs which prevent the native ODBC
&gt; execute_for_fetch working and I&#39;ve been trying to persuade people to fix
&gt; them. I&#39;ve not looked at your case yet as I&#39;m away this weekend so it
&gt; could just as easily be DBD::ODBC in this case. There is an attribute to
&gt; turn off the ODBC native execute_for_fetch &#40;which will work as a
&gt; workaround for now&#41;.
&gt; 
&gt; In the end, even though I knew some drivers would break I decided it was
&gt; better for the default to be on and it would hopefully force driver
&gt; writers to fix the issues, and have a switch to return to the old behaviour.
&gt; 
&gt; I&#39;ll look at this properly when I get home.
&gt; 
&gt; As always, I scoured the net/irc etc for people to test but as always, I
&gt; had little feedback. I cannot test all of the 100&#39;s &#40;and there are
&gt; easily over 100&#41; of ODBC drivers. Smokers don&#39;t help in this respect as
&gt; no one has DBI set up although book &#40;I think&#41; worte Test::Database to
&gt; help with this - perhaps you can speak to him at QA hackathon and see if
&gt; we can move it on a bit - it would be really worth while.
&gt; 
</div>
Yes, this is definitely on the roadmap. Also note that my sentence quoted
above laments *me* not testing more. I am in no way accusing you of not
having your due diligence ;&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1048846" href="/Public/Bug/Display.html?id=75687#txn-1048846">#</a>      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;11&nbsp;06:41:36&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75687] Regression in 1.35 execute_for_fetch/execute_array with freetds 0.82 &#40;current Debian stable&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 11 Mar 2012 11:41:26 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-ODBC [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;ribasushi [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1048846/548276/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/548276">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 477b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Martin J Evans via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; &#34;failed to retrieve diags&#34; - same old same old issue with freeTDS. It
&gt; returns an error from an ODBC call and then does not provide any error
&gt; text - I guess. Should get a chance to look at it this evening or tomorrow.
&gt; 
</div>
This is a little different - with 1.33 tests pass fully, and with 1.35
something that should insert just fine does mysteriously fail. So, while
yes, freetds is a \x{1F4A9}, I think we do have a genuine D::O bug here.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1049430" href="/Public/Bug/Display.html?id=75687#txn-1049430">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;12&nbsp;14:08:11&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1049430/548600/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/548600">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 816b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Mar 11 06:41:36 2012, RIBASUSHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Martin J Evans via RT wrote:
&gt; 
<div class="message-stanza open">&gt; &gt;
&gt; &gt; &#34;failed to retrieve diags&#34; - same old same old issue with freeTDS.
</div>&gt; It
<div class="message-stanza open">&gt; &gt; returns an error from an ODBC call and then does not provide any
</div>&gt; error
<div class="message-stanza open">&gt; &gt; text - I guess. Should get a chance to look at it this evening or
</div>&gt; tomorrow.
<div class="message-stanza open">&gt; &gt;
</div>&gt; 
&gt; This is a little different - with 1.33 tests pass fully, and with 1.35
&gt; something that should insert just fine does mysteriously fail. So,
&gt; while
&gt; yes, freetds is a \x{1F4A9}, I think we do have a genuine D::O bug
&gt; here.
</div>
The standard 70execute_array.t test fails with freeTDS 9 as it returns
rows affected as 1 instead of 5. Although this may not be the problem in
this case it is an error in the driver. Still to look at your exact example.

Martin 
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1049446" href="/Public/Bug/Display.html?id=75687#txn-1049446">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;12&nbsp;14:46:26&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1049446/548613/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/548613">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">My interpretation of the DBIC code example &#40;I&#39;ve not got all the
required stuff to run the example as is and I&#39;m DBIC illiterate&#41; is:

use DBI;
use strict;
use warnings;

my $h = DBI-&gt;connect&#40;&#39;dbi:ODBC:freetds8&#39;,&#39;sa&#39;,&#39;easysoft&#39;, {RaiseError =&gt;
1}&#41;;

eval {
    $h-&gt;do&#40;q/drop table owners/&#41;;
};

$h-&gt;do&#40;q/create table owners &#40;id int identity &#40;1,1&#41; not null, name
varchar&#40;100&#41;&#41;/&#41;;

my $s = $h-&gt;prepare_cached&#40;q/SET IDENTITY_INSERT owners ON insert into
owners &#40;id, name&#41; values&#40;?,?&#41;/&#41;;
my @data = &#40;[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],
         [&#39;wiggle&#39;,
          &#39;woggle&#39;,
          &#39;boggle&#39;,
          &#39;fRIOUX&#39;,
          &#39;fRUE&#39;,
          &#39;fREW&#39;,
          &#39;fROOH&#39;,
          &#39;fISMBoC&#39;,
          &#39;station&#39;,
          &#39;mirror&#39;,
          &#39;dimly&#39;,
          &#39;face_to_face&#39;,
          &#39;icarus&#39;,
          &#39;dream&#39;,
          &#39;dyrstyggyr&#39;]&#41;;
$s-&gt;execute_array&#40;undef, @data&#41;;

and it appears to work with freeTDS 0.91 and 0.8something although the
latter outputs:

Describe failed during DBI::st=HASH&#40;0x9cda9b8&#41;-&gt;FETCH&#40;NUM_OF_PARAMS,0&#41;
at /home/
martin/perl5/perlbrew/perls/perl-5.13.6/lib/site_perl/5.13.6/i686-linux/DBI.pm
l
ine 1896.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1051477" href="/Public/Bug/Display.html?id=75687#txn-1051477">#</a>      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;17&nbsp;14:04:40&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1051477/549800/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/549800">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">It appears Caelum has made my example fail by adding SELECT
SCOPE_IDENTITY&#40;&#41; to the end of the prepared statement. I&#39;m not sure
about this now. Also Caelum said something that suggested the select has
been taken out of dbic but only in his branch. I still don&#39;t like:

    row=0 p1 ind=-3 /1/
    row=0 p2 ind=-3 /wiggle/
    row=1 p1 ind=-3 /2/
    row=1 p2 ind=-3 /woggle/
    row=2 p1 ind=-3 /3/
    row=2 p2 ind=-3 /boggle/
    row=3 p1 ind=-3 /4/
    row=3 p2 ind=-3 /fRIOUX/
    row=4 p1 ind=-3 /5/
    row=4 p2 ind=-3 /fRUE/
    row=5 p1 ind=-3 /6/
    row=5 p2 ind=-3 /fREW/
    row=6 p1 ind=-3 /7/
    row=6 p2 ind=-3 /fROOH/
    row=7 p1 ind=-3 /8/
    row=7 p2 ind=-3 /fISMBoC/
    row=8 p1 ind=-3 /9/
    row=8 p2 ind=-3 /station/
    row=9 p1 ind=-3 /10/
    row=9 p2 ind=-3 /mirror/
    params processed = 1
    row 0, parameter status = 0
    row 1, parameter status = 2778
    +get_row_diag for row 2
    row 2, parameter status = 30062
    +get_row_diag for row 3
    row 3, parameter status = 8301
    +get_row_diag for row 4
    row 4, parameter status = 24944
    +get_row_diag for row 5
    row 5, parameter status = 24946
    +get_row_diag for row 6
    row 6, parameter status = 29549
    +get_row_diag for row 7
    row 7, parameter status = 61
    +get_row_diag for row 8
    row 8, parameter status = 10344
    +get_row_diag for row 9
    row 9, parameter status = 0

The only parameter status which looks right is the first - 0 =
SQL_PARAM_SUCCESS. The others are very suspicious suggesting either they
were never set of this freeTDS and DBD::ODBC are built with different
size SQLULEN.

Lastly, Caelum found my example above + the select works with MS native
client:

<span class="clickylink"><a target="new" rel="nofollow" href="https://gist.github.com/2063477">https://gist.github.com/2063477</a></span>

#!/usr/bin/env perl

use DBI;
use strict;
use warnings;

my $h = DBI-&gt;connect&#40;@ENV{map &#34;DBICTEST_MSSQL_ODBC_$_&#34;, qw/DSN USER PASS/},
    {RaiseError =&gt; 1, PrintError =&gt; 0}
&#41;;

eval { $h-&gt;do&#40;q/drop table owners/&#41;; };

$h-&gt;do&#40;q/create table owners &#40;id int identity &#40;1,1&#41; not null, name
varchar&#40;100&#41;&#41;/&#41;;

my $s = $h-&gt;prepare_cached&#40;&lt;&lt;&#34;EOF&#34;&#41;;
SET IDENTITY_INSERT owners ON
insert into owners &#40;id, name&#41; values &#40;?,?&#41;
SET IDENTITY_INSERT owners OFF
SELECT SCOPE_IDENTITY&#40;&#41;
EOF

my @data = &#40;[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],
         [&#39;wiggle&#39;,
          &#39;woggle&#39;,
          &#39;boggle&#39;,
          &#39;fRIOUX&#39;,
          &#39;fRUE&#39;,
          &#39;fREW&#39;,
          &#39;fROOH&#39;,
          &#39;fISMBoC&#39;,
          &#39;station&#39;,
          &#39;mirror&#39;,
          &#39;dimly&#39;,
          &#39;face_to_face&#39;,
          &#39;icarus&#39;,
          &#39;dream&#39;,
          &#39;dyrstyggyr&#39;]&#41;;

$s-&gt;execute_array&#40;undef, @data&#41;;

eval { $h-&gt;do&#40;q/drop table owners/&#41;; };

So, where to go now?

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1051506" href="/Public/Bug/Display.html?id=75687#txn-1051506">#</a>      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;17&nbsp;18:02:07&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1051506/549819/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/549819">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Mar 17 14:04:40 2012, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It appears Caelum has made my example fail by adding SELECT
&gt; SCOPE_IDENTITY&#40;&#41; to the end of the prepared statement. I&#39;m not sure
&gt; about this now. Also Caelum said something that suggested the select has
&gt; been taken out of dbic but only in his branch. I still don&#39;t like:
&gt; 
&gt;     row=0 p1 ind=-3 /1/
&gt;     row=0 p2 ind=-3 /wiggle/
&gt;     row=1 p1 ind=-3 /2/
&gt;     row=1 p2 ind=-3 /woggle/
&gt;     row=2 p1 ind=-3 /3/
&gt;     row=2 p2 ind=-3 /boggle/
&gt;     row=3 p1 ind=-3 /4/
&gt;     row=3 p2 ind=-3 /fRIOUX/
&gt;     row=4 p1 ind=-3 /5/
&gt;     row=4 p2 ind=-3 /fRUE/
&gt;     row=5 p1 ind=-3 /6/
&gt;     row=5 p2 ind=-3 /fREW/
&gt;     row=6 p1 ind=-3 /7/
&gt;     row=6 p2 ind=-3 /fROOH/
&gt;     row=7 p1 ind=-3 /8/
&gt;     row=7 p2 ind=-3 /fISMBoC/
&gt;     row=8 p1 ind=-3 /9/
&gt;     row=8 p2 ind=-3 /station/
&gt;     row=9 p1 ind=-3 /10/
&gt;     row=9 p2 ind=-3 /mirror/
&gt;     params processed = 1
&gt;     row 0, parameter status = 0
&gt;     row 1, parameter status = 2778
&gt;     +get_row_diag for row 2
&gt;     row 2, parameter status = 30062
&gt;     +get_row_diag for row 3
&gt;     row 3, parameter status = 8301
&gt;     +get_row_diag for row 4
&gt;     row 4, parameter status = 24944
&gt;     +get_row_diag for row 5
&gt;     row 5, parameter status = 24946
&gt;     +get_row_diag for row 6
&gt;     row 6, parameter status = 29549
&gt;     +get_row_diag for row 7
&gt;     row 7, parameter status = 61
&gt;     +get_row_diag for row 8
&gt;     row 8, parameter status = 10344
&gt;     +get_row_diag for row 9
&gt;     row 9, parameter status = 0
&gt; 
&gt; The only parameter status which looks right is the first - 0 =
&gt; SQL_PARAM_SUCCESS. The others are very suspicious suggesting either they
&gt; were never set of this freeTDS and DBD::ODBC are built with different
&gt; size SQLULEN.
</div>
Nonesense but possible.

Long answer:

The actual problem in this case is that freeTDS &#40;or MS SQL Server ODBC
driver&#41; actually only processes the first row of parameters &#40;i.e.,
params processed is 1&#41; but DBD::ODBC assumes all values in the parameter
status array will be set &#40;incorrectly, only params processed rows in
param status array are valid&#41;. That is why the parameter status array
after row 1 is nonesense. I&#39;ve fixed this &#40;not checked in yet&#41; although
it won&#39;t make any difference to the case in point as issuing a select in
the SQL with array bound parameters is a HELL-WHAT-TO-DO-WITH-THIS
situation. Think about it. If you bind a row of parameters to an insert
followed by a select at what point does the select get processed - the
ODBC driver is simply pumping rows of parameters after the SQL and there
is nothing in the spec to say how you break in to this to process the
select i.e., in ODBC terms, once the rows of parameters are bound all
that happens is SQLExecute is called and the driver is supposed to pass
all the arrays of parameters in perhaps in a single block - there is
nothing to interrupt this and handle the select.

Short answer:

Don&#39;t run what appears like multiple statements i.e, sql_do_this;
sql_now_something_else; because a&#41; the handling of it is driver
dependent &#40;note 1&#41; and b&#41; some drivers batch the sql up.

note 1: in particular, don&#39;t mix insert/update/delete and a select as
few ODBC drivers will handle this in a reasonable way and if you bind
arrays of parameters &#40;execute_for_fetch/execute_array&#41; there is no way
to interrupt the parameters and retrieve the result-set.
 
Succinctly, there is no way DBD::ODBC is going to support multiple
statements passed to prepare as the way it is handled in ODBC drivers is
too diverse, unpredicatable and not defined clearly enough in ODBC spec.

Consider this one:

a procedure which takes an input parameter and returns one output
parameter. In ODBC, the output parameter cannot be valid until the
procedure is finished since anything in the proc could change the output
parameter. Also, a proc can issue multiple
inserts/updates/deletes/selects. As a result, calling a procedure that
does insert this, select this, select that, insert this is only
meaningful when SQLMoreResults is called as the result-set changes
repeatedly during the procedure so you do:

prepare&#40;{call proc fred &#40;?,?&#41;}&#41;;
bind_param&#40;1, input_param&#41;
bind_param&#40;2, output_param&#41;
execute;
do {
    fetch rows from different result sets of possibly different columns
} while odbc_more_results;
output param is valid now

Now imagine what happens when you do this with execute_array - i.e., the
procedure is called multiple times with each row of params but it all
kicks off with one ODBC call SQLExecute - I daren&#39;t even think about how
the ODBC driver never mind DBD::ODBC would handle this. In fact when
this came up with the author of our SQL Server ODBC driver it was a walk
away and never come back mmoment.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1056991" href="/Public/Bug/Display.html?id=75687#txn-1056991">#</a>      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;31&nbsp;08:32:02&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1056991/552994/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/552994">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I fixed the only true ODBC issue in this rt in 1.36_1.

There is no way DBD::ODBC is going to support mixing
inserts/deletes/updates/selects in the same statement - reason above.

1.36_2 will revert default to no array operations although strictly
speaking all that defaulting it to on, in the case of this rt, is
highlight issues in freeTDS.

It is a shame I&#39;m having to do this. I knew there would be issues in
some ODBC drivers but I thought highlighting them would hopefully put
pressure on people to fix them. Instead it seems I&#39;ve just added to my
work by having to keep a list of broken drivers and disable array
operations for each of them to hide the bugs in them - sigh. I&#39;ve
attempted to find some sort of middle ground by pulling the common code
out of the 70execute_array.t test and splitting it in to 2 - one which
does the default DBI execute* and one which forces internal DBD::ODBC
array operations. In this way if you run the tests to a real driver it
still shows the bugs in the driver. However, as no one bothers to set up
a real scenario when installing DBD::ODBC the test suite is useless in
this respect.

BTW, Peter, above comment is not directed at you - just my moaning about
the sad state of some open source drivers.

Will write this off when 1.36_2 appears on rt unless you come back to me.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1065013" href="/Public/Bug/Display.html?id=75687#txn-1065013">#</a>      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;07&nbsp;11:38:49&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1065013/559923/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/559923">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 537b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Mar 31 08:32:02 2012, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I fixed the only true ODBC issue in this rt in 1.36_1.
&gt; 
&gt; There is no way DBD::ODBC is going to support mixing
&gt; inserts/deletes/updates/selects in the same statement - reason above.
&gt; 
&gt; 1.36_2 will revert default to no array operations although strictly
&gt; speaking all that defaulting it to on, in the case of this rt, is
&gt; highlight issues in freeTDS.
</div>
Above wraps this up a long with a 1.37 release which reverts default to
no array operations.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1065016" href="/Public/Bug/Display.html?id=75687#txn-1065016">#</a>      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;07&nbsp;11:39:21&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1065018" href="/Public/Bug/Display.html?id=75687#txn-1065018">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;07&nbsp;11:39:21&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Fixed in 1.36_2 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.767893</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
