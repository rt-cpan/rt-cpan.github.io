<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #22074 for Business-OnlinePayment: _child_submit/_pre_submit&#40;&#41; wackiness causes deep recursion in BOP::AuthorizeNet</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #22074 for Business-OnlinePayment: _child_submit/_pre_submit&#40;&#41; wackiness causes deep recursion in BOP::AuthorizeNet</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Business-OnlinePayment/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Business-OnlinePayment/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Business-OnlinePayment/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Business-OnlinePayment/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Business-OnlinePayment">Business-OnlinePayment CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">22074</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Business-OnlinePayment/Active/">Business-OnlinePayment</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mschwern [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-4618-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
3.00_04    </td>
  </tr>
  <tr id="CF-4619-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
3.00_05    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;13&nbsp;05:23:13&nbsp;2006</span>
    <span class="description">mschwern [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> _child_submit/_pre_submit&#40;&#41; wackiness causes deep recursion in
 BOP::AuthorizeNet</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The odd code to insert the new _pre_submit&#40;&#41; into a subclass&#39; submit&#40;&#41;
override causes BOP::AuthorizeNet&#39;s capture.t test to go into deep
recursion.

The first object created will have _child_submit set to its submit&#40;&#41;
method.  The subclass&#39; submit method will then be overriden by BOP. 
Everything works fine.  But the second object created will have
_child_submit set to the BOP override.  This is called inside the BOP
override and deep recursion happens.

Rather than that, the attached patch simply overrides the subclass&#39;
submit and records that we&#39;ve done it so we don&#39;t do it again.  The
submit override calls both pre_submit&#40;&#41; and then the original submit.

Overall this implementation of wedging fraud detection in seems fragile
and is setting off all sorts of design alarm bells.  The necessity of it
comes from subclasses not properly calling SUPER::submit&#40;&#41; in their
submit&#40;&#41; overrides &#40;rightly, because it would blow up&#41; leaving no way
for BOP to add more functionality to submit&#40;&#41;.

Rather than hack things up like this it might be better to just change
the API and require folks to call SUPER::method when the override BOP
methods.  In this case it does no harm to existing code except they
can&#39;t use fraud protection until they update.  Send a note out to the
BOP subclass authors about the change.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> bop_pre_submit.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== OnlinePayment.pm
==================================================================
--- OnlinePayment.pm	&#40;revision 19627&#41;
+++ OnlinePayment.pm	&#40;local&#41;
@@ -12,6 +12,8 @@
 
 my $Class = __PACKAGE__;
 
+my %Presubmit_Added;
+
 my %fields = &#40;
     authorization    =&gt; undef,
     error_message    =&gt; undef,
@@ -56,15 +58,16 @@
         $self-&gt;$key&#40;$value&#41;;
     }
 
-    unless &#40; $subclass-&gt;can&#40;&#39;submit&#39;&#41; eq $class-&gt;can&#40;&#39;submit&#39;&#41; &#41; {
+    unless &#40; $Presubmit_Added{$subclass}++ &#41; {
         no strict &#39;refs&#39;;
         no warnings &#39;redefine&#39;;
-        my $submit = qualify_to_ref&#40;&#39;submit&#39;, $subclass&#41;;
 
-        $self-&gt;{_child_submit} = \&#38;$submit;
+        my $real_submit = $subclass-&gt;can&#40;&#39;submit&#39;&#41;;
         *{&#34;${subclass}::submit&#34;} = sub {
             my $self = shift;
-            $self-&gt;_pre_submit&#40;&#41;;
+            return unless $self-&gt;_pre_submit&#40;@_&#41;;
+
+            return $real_submit-&gt;&#40;$self, @_&#41;;
         }
     }
 
@@ -80,7 +83,7 @@
     $risk_transaction-&gt;submit&#40;&#41;;
     if &#40;$risk_transaction-&gt;is_success&#40;&#41;&#41; {
 	if &#40; $risk_transaction-&gt;fraud_score &lt;= $self-&gt;maximum_fraud_score&#40;&#41;&#41; {
-	    $self-&gt;{_child_submit}-&gt;&#40;$self&#41;;
+            return 1;
 	} else {
 	    $self-&gt;is_success&#40;0&#41;;
 	    $self-&gt;error_message&#40;&#39;Excessive risk from risk management&#39;&#41;;
@@ -96,7 +99,7 @@
     my $fraud_detection = $self-&gt;fraud_detect&#40;&#41;;
 
     # early return if user does not want optional risk mgt
-    return $self-&gt;{_child_submit}-&gt;&#40;$self,@_&#41; unless $fraud_detection &#38;&#38; length $fraud_detection;
+    return unless $fraud_detection &#38;&#38; length $fraud_detection;
 
     # Search for an appropriate FD module
     foreach my $subclass &#40; q&#40;Business::OnlinePayment::&#41; . $fraud_detection,
=== t/pre_submit.t
==================================================================
--- t/pre_submit.t	&#40;revision 19627&#41;
+++ t/pre_submit.t	&#40;local&#41;
@@ -0,0 +1,33 @@
+#!/usr/bin/perl -w
+
+use Test::More tests =&gt; 4;
+
+my $pre_submit_called = 0;
+{    # fake test driver &#40;with submit method&#41;
+
+    package Business::OnlinePayment::MOCK;
+    use strict;
+    use warnings;
+    use base qw&#40;Business::OnlinePayment&#41;;
+    sub submit {
+        my $self = shift;
+        return 1;
+    }
+
+    sub _pre_submit {
+        my $self = shift;
+        $pre_submit_called++;
+
+        return 1;
+    }
+}
+
+$INC{&#34;Business/OnlinePayment/MOCK.pm&#34;} = &#34;testing&#34;;
+
+my $tx = Business::OnlinePayment-&gt;new&#40;&#34;MOCK&#34;&#41;;
+ok $tx-&gt;submit;
+is $pre_submit_called, 1;
+
+my $tx2 = Business::OnlinePayment-&gt;new&#40;&#34;MOCK&#34;&#41;;
+ok $tx2-&gt;submit;
+is $pre_submit_called, 2;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;18&nbsp;01:41:38&nbsp;2006</span>
    <span class="description">ivan-pause [...] 420.am -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;20&nbsp;00:46:22&nbsp;2006</span>
    <span class="description">ivan-pause [...] 420.am -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Oct 13 05:23:13 2006, MSCHWERN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The odd code to insert the new _pre_submit&#40;&#41; into a subclass&#39; 
</div>submit&#40;&#41;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; override causes BOP::AuthorizeNet&#39;s capture.t test to go into deep
&gt; recursion.
&gt; 
&gt; The first object created will have _child_submit set to its submit&#40;&#41;
&gt; method.  The subclass&#39; submit method will then be overriden by BOP. 
&gt; Everything works fine.  But the second object created will have
&gt; _child_submit set to the BOP override.  This is called inside the 
</div>BOP
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; override and deep recursion happens.
&gt; 
&gt; Rather than that, the attached patch simply overrides the subclass&#39;
&gt; submit and records that we&#39;ve done it so we don&#39;t do it again.  The
&gt; submit override calls both pre_submit&#40;&#41; and then the original 
</div>submit.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Overall this implementation of wedging fraud detection in seems 
</div>fragile
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; and is setting off all sorts of design alarm bells.  The necessity 
</div>of it
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; comes from subclasses not properly calling SUPER::submit&#40;&#41; in their
&gt; submit&#40;&#41; overrides &#40;rightly, because it would blow up&#41; leaving no 
</div>way
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; for BOP to add more functionality to submit&#40;&#41;.
&gt; 
&gt; Rather than hack things up like this it might be better to just 
</div>change
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; the API and require folks to call SUPER::method when the override 
</div>BOP
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; methods.  In this case it does no harm to existing code except they
&gt; can&#39;t use fraud protection until they update.  Send a note out to 
</div>the
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; BOP subclass authors about the change.
&gt; 
</div>
I think providing this as the &#34;new, better&#34; way is desirable, but 
given the time and logistics involved in getting every subclass 
updated, the kludge to wedge it in with existing subclasses seems 
desirable for now...  I&#39;ll apply this patch.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;24&nbsp;01:30:22&nbsp;2006</span>
    <span class="description">ivan-pause [...] 420.am -  Reference to ticket #23586 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;19&nbsp;02:13:06&nbsp;2006</span>
    <span class="description">ivan-pause [...] 420.am -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;19&nbsp;02:13:06&nbsp;2006</span>
    <span class="description">ivan-pause [...] 420.am -  Fixed in 3.00_05 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
