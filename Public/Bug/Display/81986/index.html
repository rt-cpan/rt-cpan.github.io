<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #81986 for Math-Big: The primes function is *very* slow and uses too much memory &#40;patch included&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #81986 for Math-Big: The primes function is *very* slow and uses too much memory &#40;patch included&#41;</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Math-Big">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Math-Big">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Math-Big">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Math-Big">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Math-Big">Math-Big CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">81986</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Math-Big">Math-Big</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
DANAJ [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-20496-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.12    </td>
  </tr>
  <tr id="CF-20497-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




Math-Big.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1155295/607598/Math-Big.patch">
Fri Dec 14 16:40:59 2012 (3.7k) by DANAJ [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=81986">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1155295" href="/Public/Bug/Display.html?id=81986#txn-1155295">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;14&nbsp;16:40:59&nbsp;2012</span>
    <span class="description">DANAJ [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> The primes function is *very* slow and uses too much memory
 &#40;patch included&#41;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1155295/607597/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/607597">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The primes function is far slower than it should be.  The attached patch
makes it run much faster and use much less memory, while also fixing
incorrect prime count returns for N &lt;= 2, and primes for N &lt;= 1.

I realize that this no longer really tests the functionality of
Math::BigInt, and hence may not be acceptable as submitted.  I have it
returning all results as BigInts at the end, so the result is the same
as it was before, even though there is really no reason for them to be
BigInts &#40;and the conversion takes more time than the sieving for most
inputs&#41;.  But for almost all cases, this is really not necessary.  The
case I can think of would be for a 32-bit machine with an argument
larger than 2**32.  The old code used more than 26GB of RAM getting to
800M, so I don&#39;t think anyone ever hit that limit.  The new code would
be able to get there, so maybe it deserves more thought.

For BigInts, a segmented sieve might also be worthwhile, though the
current interface &#40;a single integer with an implied lower limit of 2&#41;
doesn&#39;t really make it useful.

The patch uses a string sieve which is faster than array versions.  It
would be an easy change to instead use a more conventional vec&#40;&#41; version
that runs 2-4x slower than this patch but uses 1/8th the sieve memory. 
The memory savings when run in array context is dwarfed by the BigInt
return values, so not really a factor there.  Either one would run quite
a bit faster than the existing code.


time perl -MMath::Big=primes -E &#39;say scalar primes&#40;10_000_000&#41;;&#39;
664579
377.58s  1,510,336k used

time perl -Iblib/lib -Iblib/arch -MMath::Big=primes -E &#39;say scalar
primes&#40;10_000_000&#41;;&#39;
664579
0.81s  98,176k used

time perl -MMath::Big=primes -E &#39;my @p = primes&#40;700000&#41;; say $p[50000];&#39;
611957
26.21s  244,528k used

time perl -Iblib/lib -Iblib/arch -MMath::Big=primes -E &#39;my @p =
primes&#40;700000&#41;; say $p[50000];&#39;
0.58s  150,096k used

Memory use is from /usr/bin/time, so includes everything.  I verified
the prime count for small values using:

perl -Iblib/lib -Iblib/arch -MMath::Big=primes -MMath::Prime::FastSieve
-E &#39;my $sieve = Math::Prime::FastSieve::Sieve-&gt;new&#40; 1_000_000 &#41;; foreach
my $n &#40;1..100000&#41; { die &#34;$n&#34; unless $sieve-&gt;count_le&#40;$n&#41; == scalar
primes&#40;$n&#41;; say &#34;good through $n&#34; if $n % 5000 == 0; }&#39;

and the primes array using:

perl -Iblib/lib -Iblib/arch -MMath::Big=primes -MMath::Prime::FastSieve
-E &#39;my $sieve = Math::Prime::FastSieve::Sieve-&gt;new&#40; 1_000_000 &#41;; foreach
my $n &#40;1..10000&#41; { my @p1 = @{$sieve-&gt;primes&#40;$n&#41;}; my @p2 = primes&#40;$n&#41;;
die &#34;$n&#34; unless scalar @p1 == scalar @p2; foreach my $i &#40;0..$#p1&#41; { die
&#34;$n&#34; unless $p1[$i] == $p2[$i]; } say &#34;good through $n&#34; if $n % 500 == 0; }&#39;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Math-Big.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1155295/607598/Math-Big.patch">Download Math-Big.patch</a><br />
<span class="downloadcontenttype">text/x-diff 3.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- lib/site_perl/5.17.6/Math/Big.pm	2007-04-16 08:27:54.000000000 -0700
+++ lib/Math/Big.pm	2012-12-14 13:34:05.429974839 -0800
@@ -29,64 +29,41 @@
 my $five = Math::BigFloat-&gt;new&#40;5&#41;;		# for pi
 my $twothreenine = Math::BigFloat-&gt;new&#40;239&#41;;	# for pi
 
-sub primes
-  {
-  my $amount = shift; $amount = 1000 if !defined $amount;
-  $amount = Math::BigInt-&gt;new&#40;$amount&#41; unless ref $amount;
-
-  return &#40;Math::BigInt-&gt;new&#40;2&#41;&#41; if $amount &lt; $three;
-  
-  $amount++;  
-
-  # any not defined number is prime, 0,1 are not, but 2 is
-  my @primes = &#40;1,1,0&#41;; 
-  my $prime = $three-&gt;copy&#40;&#41;;			# start
-  my $r = 0; my $a = $amount-&gt;numify&#40;&#41;;
-  for &#40;my $i = 3; $i &lt; $a; $i++&#41;		# int version
-    {
-    $primes[$i] = $r; $r = 1-$r;
-    }
-  my &#40;$cur,$add&#41;;
-  # find primes
-  OUTER:
-  while &#40;$prime &lt;= $amount&#41;
-    {
-    # find first unmarked, it is the next prime
-    $cur = $prime;
-    while &#40;$primes[$cur]&#41;
-      {
-      $cur += $two; last OUTER if $cur &gt;= $amount;	# no more to do
-      }
-    # $cur is now new prime
-    # now strike out all multiples of $cur
-    $add = $cur * $two;
-    $prime = $cur + $two;			# next round start two higher
-    $cur += $add;
-    while &#40;$cur &lt;= $amount&#41;
-      {
-      $primes[$cur] = 1; $cur += $add;
-      }
-    }
-
-  if &#40;!wantarray&#41;
-    {
-    my $n = 0;
-    for my $p &#40;@primes&#41;
-      {
-      $n++ if $p == 0;
-      }
-    return Math::BigInt-&gt;new&#40;$n&#41;;
-    }
-
-  my @real_primes; my $i = 0;
-  while &#40;$i &lt; scalar @primes&#41;
-    {
-    push @real_primes, Math::BigInt-&gt;new&#40;$i&#41; if $primes[$i] == 0;
-    $i ++;
-    }
-
-  @real_primes;
+# In scalar context this returns the prime count &#40;# of primes &lt;= N&#41;.
+# In array context it returns a list of primes from 2 to N.
+sub primes {
+  my $end = shift;
+  return unless defined $end;
+  $end = $end-&gt;numify&#40;&#41; if ref&#40;$end&#41; =~ /^Math::Big/;
+  if &#40;$end &lt; 2&#41; { return !wantarray ? Math::BigInt-&gt;bzero&#40;&#41; : &#40;&#41;; }
+  if &#40;$end &lt; 3&#41; { return !wantarray ? $one-&gt;copy : &#40;$two-&gt;copy&#41;; }
+  if &#40;$end &lt; 5&#41; { return !wantarray ? $two-&gt;copy : &#40;$two-&gt;copy, $three-&gt;copy&#41;; }
+
+  $end-- unless &#40;$end &#38; 1&#41;;
+  my $s_end = $end &gt;&gt; 1;
+  my $whole = int&#40; &#40;$end&gt;&gt;1&#41; / 15&#41;;
+  # Be conservative.  This would result in terabytes of array output.
+  die &#34;Cannot return $end primes!&#34; if $whole &gt; 1_145_324_612;  # ~32 GB string
+  my $sieve = &#34;100010010010110&#34; . &#34;011010010010110&#34; x $whole;
+  substr&#40;$sieve, $s_end+1&#41; = &#39;&#39;; # Clip to the right number of entries
+  my &#40;$n, $limit&#41; = &#40; 7, int&#40;sqrt&#40;$end&#41;&#41; &#41;;
+  while &#40; $n &lt;= $limit &#41; {
+    for &#40;my $s = &#40;$n*$n&#41; &gt;&gt; 1; $s &lt;= $s_end; $s += $n&#41; {
+      substr&#40;$sieve, $s, 1&#41; = &#39;1&#39;;
+    }
+    do { $n += 2 } while substr&#40;$sieve, $n&gt;&gt;1, 1&#41;;
+  }
+
+  return Math::BigInt-&gt;new&#40;1 + $sieve =~ tr/0//&#41; if !wantarray;
+
+  my @primes = &#40;2, 3, 5&#41;;
+  $n = 7-2;
+  foreach my $s &#40;split&#40;&#34;0&#34;, substr&#40;$sieve, 3&#41;, -1&#41;&#41; {
+    $n += 2 + 2 * length&#40;$s&#41;;
+    push @primes, $n if $n &lt;= $end;
   }
+  return map { Math::BigInt-&gt;new&#40;$_&#41; } @primes;
+}
   
 sub fibonacci
   {
@@ -880,7 +857,7 @@
       cos sin tan euler bernoulli arctan arcsin pi/;
 
     @primes	= primes&#40;100&#41;;		# first 100 primes
-    $prime	= primes&#40;100&#41;;		# 100th prime
+    $count	= primes&#40;100&#41;;		# number of primes &lt;= 100
     @fib	= fibonacci &#40;100&#41;;	# first 100 fibonacci numbers
     $fib_1000	= fibonacci &#40;1000&#41;;	# 1000th fibonacci number
     $hailstone	= hailstone &#40;1000&#41;;	# length of sequence
@@ -930,11 +907,10 @@
 	$primes = primes&#40;$n&#41;;
 
 Calculates all the primes below N and returns them as array. In scalar context
-returns the number of primes below N.
+returns the prime count of N &#40;the number of primes less than or equal to N&#41;.
   
 This uses an optimized version of the B&lt;Sieve of Eratosthenes&gt;, which takes
-half of the time and half of the space, but is still O&#40;N&#41;. Or in other words,
-quite slow.
+half of the time and half of the space, but is still O&#40;N&#41;.
 
 =head2 B&lt;fibonacci&#40;&#41;&gt;
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1155308" href="/Public/Bug/Display.html?id=81986#txn-1155308">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;14&nbsp;16:56:11&nbsp;2012</span>
    <span class="description">DANAJ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1155308/607608/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/607608">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 471b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This also seems to fix floating point inputs:

perl -MMath::Big=primes -E &#39;say scalar primes&#40;14.99&#41;;&#39;
1

perl -Iblib/lib -Iblib/arch -MMath::Big=primes -E &#39;say scalar
primes&#40;14.99&#41;;&#39;
6


perl -MMath::Big=primes -E &#39;say join &#34;,&#34;, primes&#40;14.99&#41;;&#39;
2

perl -Iblib/lib -Iblib/arch -MMath::Big=primes -E &#39;say join &#34;,&#34;,
primes&#40;14.99&#41;;&#39;
2,3,5,7,11,13


Arguably, new test cases for N = 0,1,2 in scalar and array context, with
no input, and a floating point input should be added.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1155310" href="/Public/Bug/Display.html?id=81986#txn-1155310">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;14&nbsp;16:56:13&nbsp;2012</span>
    <span class="description">DANAJ [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1155467" href="/Public/Bug/Display.html?id=81986#txn-1155467">#</a>      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;15&nbsp;06:54:02&nbsp;2012</span>
    <span class="description">nospam-abuse [...] bloodgate.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #81986] The primes function is *very* slow and  uses too much memory  &#40;patch included&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 15 Dec 2012 06:53:52 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Math-Big [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Tels&#34; &lt;nospam-abuse [...] bloodgate.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1155467/607698/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/607698">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Dana,

On Fri, December 14, 2012 4:41 pm, Dana Jacobsen via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Fri Dec 14 16:40:59 2012: Request 81986 was acted upon.
&gt; Transaction: Ticket created by DANAJ
&gt;        Queue: Math-Big
&gt;      Subject: The primes function is *very* slow and uses too much memory
&gt;  &#40;patch included&#41;
&gt;    Broken in: 1.12
&gt;     Severity: Normal
&gt;        Owner: Nobody
&gt;   Requestors: DANAJ@cpan.org
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=81986">https://rt.cpan.org/Ticket/Display.html?id=81986</a></span> &gt;
&gt;
&gt;
&gt; The primes function is far slower than it should be.  The attached patch
&gt; makes it run much faster and use much less memory, while also fixing
&gt; incorrect prime count returns for N &lt;= 2, and primes for N &lt;= 1.
&gt;
&gt; I realize that this no longer really tests the functionality of
&gt; Math::BigInt, and hence may not be acceptable as submitted.  I have it
&gt; returning all results as BigInts at the end, so the result is the same
&gt; as it was before, even though there is really no reason for them to be
&gt; BigInts &#40;and the conversion takes more time than the sieving for most
&gt; inputs&#41;.  But for almost all cases, this is really not necessary.  The
&gt; case I can think of would be for a 32-bit machine with an argument
&gt; larger than 2**32.  The old code used more than 26GB of RAM getting to
&gt; 800M, so I don&#39;t think anyone ever hit that limit.  The new code would
&gt; be able to get there, so maybe it deserves more thought.
&gt;
&gt; For BigInts, a segmented sieve might also be worthwhile, though the
&gt; current interface &#40;a single integer with an implied lower limit of 2&#41;
&gt; doesn&#39;t really make it useful.
&gt;
&gt; The patch uses a string sieve which is faster than array versions.  It
&gt; would be an easy change to instead use a more conventional vec&#40;&#41; version
&gt; that runs 2-4x slower than this patch but uses 1/8th the sieve memory.
&gt; The memory savings when run in array context is dwarfed by the BigInt
&gt; return values, so not really a factor there.  Either one would run quite
&gt; a bit faster than the existing code.
</div>
The results look fine to me, and I&#39;d not object to replacing my code. The
original code was more a proof-of-concept and not really something usable
for large values - there exist much faster/better alternatives for it. But
it&#39;s something for &#34;Need it quickly and now and w/ lots of fuss like
installing modules.&#34;

all the best,

tels

-- 
<span class="clickylink"><a target="new" rel="nofollow" href="http://bloodgate.com/galleries/">http://bloodgate.com/galleries/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1155575" href="/Public/Bug/Display.html?id=81986#txn-1155575">#</a>      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;15&nbsp;18:50:12&nbsp;2012</span>
    <span class="description">DANAJ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1155575/607761/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/607761">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Dec 15 06:54:02 2012, nospam-abuse@bloodgate.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The results look fine to me, and I&#39;d not object to replacing my code. The
&gt; original code was more a proof-of-concept and not really something usable
&gt; for large values - there exist much faster/better alternatives for it. But
&gt; it&#39;s something for &#34;Need it quickly and now and w/ lots of fuss like
&gt; installing modules.&#34;
</div>
Tels, thanks for the reply.

As part of developing Math::Prime::Util, one of the things I&#39;ve been
doing is comparing it to other solutions, both to verify my correctness
and also performance.  I was sadly lax in reporting issues I found until
recently.  Math::Big was quite an outlier in both time and space, with a
slope that didn&#39;t resemble any of the other sieving methods I used.

There are faster alternatives, and ones with many more features, but
after this change, I think it runs at a reasonable speed.  Some timings
using Perl 5.17.6 on a pretty fast computer, prime count to 800M:

    0.025s Math::Prime::Util 0.12      XS, Lehmer&#39;s method
    0.36s  Math::Prime::Util 0.09      XS, segmented mod-30 sieve
    0.52s  Math::Prime::Util:PP 0.14   Perl, Lehmer&#39;s method
    2.90s  Math::Prime::FastSieve 0.18 XS, good SoE
   11.7s   Math::Prime::XS 0.29        XS
   15.0s   Bit::Vector 7.2             XS
   57.3s   Math::Prime::Util::PP 0.14  Perl, string sieve
    &#34;&#34;     Math::Big patched           &#34;&#34;
  169.5s   Python mpmath primepi 0.17  Python, 25 GB RAM.
  292.2s   Python sympy primepi 0.7.1  Python
20000+     Math::Big 1.12              Perl, &gt; 26GB RAM

This is probably the best case for this Perl code: doing a count using
Perl 5.16.0+.  But importantly we&#39;ve changed from being really slow with
too much memory, to now being quite fast -- only 4x slower than one of
the XS solutions.

[Aside to be fair: there are much faster solutions in Python than the
ones used in the standard modules -- RHW on StackOverflow provided some
fast sieves, and modifying those to do prime counts yields a pure Python
implementation that runs about 2x faster than this pure Perl code,
albeit with 2x the memory.  The version using numpy runs not much slower
than Math::Prime::FastSieve -- in other words, pretty darn fast.]

The Lehmer count method is ~100 lines of Perl including comments. 
Probably something better left for a module, though it&#39;s fine with me if
someone wants to include it.

Summing the first 1M primes &#34;$sum += $_ for primes&#40;1000000&#41;&#34; on a
slightly slower machine:
 38.1s  old Math::Big
  1.7s  new Math::Big
  0.2s  new Math::Big returning @primes instead of mapping to BigInts
 ~0.02s the various XS modules

Looks much more reasonable.  A lot of the time difference between the
non-BigInt and BigInt versions is the summation, which gets done as a
BigInt calculation.  At 10M, I get 402s for old Math::Big, 14s for new
Math::Big, 1.2s for new Math::Big returning non-BigInts, and 0.13-0.18s
for XS modules &#40;which all return non-BigInts for this range&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1159126" href="/Public/Bug/Display.html?id=81986#txn-1159126">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;25&nbsp;11:56:51&nbsp;2012</span>
    <span class="description">nospam-abuse [...] bloodgate.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #81986] The primes function is *very* slow and  uses too much memory &#40;patch included&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 25 Dec 2012 11:56:34 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Math-Big [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Tels&#34; &lt;nospam-abuse [...] bloodgate.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1159126/609446/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/609446">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On Sat, December 15, 2012 6:50 pm, Dana Jacobsen via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Math-Big
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=81986">https://rt.cpan.org/Ticket/Display.html?id=81986</a></span> &gt;
&gt;
&gt; On Sat Dec 15 06:54:02 2012, nospam-abuse@bloodgate.com wrote:
<div class="message-stanza open">&gt;&gt; The results look fine to me, and I&#39;d not object to replacing my code.
&gt;&gt; The
&gt;&gt; original code was more a proof-of-concept and not really something
&gt;&gt; usable
&gt;&gt; for large values - there exist much faster/better alternatives for it.
&gt;&gt; But
&gt;&gt; it&#39;s something for &#34;Need it quickly and now and w/ lots of fuss like
&gt;&gt; installing modules.&#34;
</div>&gt;
&gt; Tels, thanks for the reply.
&gt;
&gt; As part of developing Math::Prime::Util, one of the things I&#39;ve been
&gt; doing is comparing it to other solutions, both to verify my correctness
&gt; and also performance.  I was sadly lax in reporting issues I found until
&gt; recently.  Math::Big was quite an outlier in both time and space, with a
&gt; slope that didn&#39;t resemble any of the other sieving methods I used.
&gt;
&gt; There are faster alternatives, and ones with many more features, but
&gt; after this change, I think it runs at a reasonable speed.  Some timings
&gt; using Perl 5.17.6 on a pretty fast computer, prime count to 800M:
&gt;
&gt;     0.025s Math::Prime::Util 0.12      XS, Lehmer&#39;s method
&gt;     0.36s  Math::Prime::Util 0.09      XS, segmented mod-30 sieve
&gt;     0.52s  Math::Prime::Util:PP 0.14   Perl, Lehmer&#39;s method
&gt;     2.90s  Math::Prime::FastSieve 0.18 XS, good SoE
&gt;    11.7s   Math::Prime::XS 0.29        XS
&gt;    15.0s   Bit::Vector 7.2             XS
&gt;    57.3s   Math::Prime::Util::PP 0.14  Perl, string sieve
&gt;     &#34;&#34;     Math::Big patched           &#34;&#34;
&gt;   169.5s   Python mpmath primepi 0.17  Python, 25 GB RAM.
&gt;   292.2s   Python sympy primepi 0.7.1  Python
&gt; 20000+     Math::Big 1.12              Perl, &gt; 26GB RAM
&gt;
&gt; This is probably the best case for this Perl code: doing a count using
&gt; Perl 5.16.0+.  But importantly we&#39;ve changed from being really slow with
&gt; too much memory, to now being quite fast -- only 4x slower than one of
&gt; the XS solutions.
</div>
Hm, I think the actual times are missing?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [Aside to be fair: there are much faster solutions in Python than the
&gt; ones used in the standard modules -- RHW on StackOverflow provided some
&gt; fast sieves, and modifying those to do prime counts yields a pure Python
&gt; implementation that runs about 2x faster than this pure Perl code,
&gt; albeit with 2x the memory.  The version using numpy runs not much slower
&gt; than Math::Prime::FastSieve -- in other words, pretty darn fast.]
&gt;
&gt; The Lehmer count method is ~100 lines of Perl including comments.
&gt; Probably something better left for a module, though it&#39;s fine with me if
&gt; someone wants to include it.
&gt;
&gt; Summing the first 1M primes &#34;$sum += $_ for primes&#40;1000000&#41;&#34; on a
&gt; slightly slower machine:
&gt;  38.1s  old Math::Big
&gt;   1.7s  new Math::Big
&gt;   0.2s  new Math::Big returning @primes instead of mapping to BigInts
&gt;  ~0.02s the various XS modules
&gt;
&gt; Looks much more reasonable.  A lot of the time difference between the
&gt; non-BigInt and BigInt versions is the summation, which gets done as a
&gt; BigInt calculation.  At 10M, I get 402s for old Math::Big, 14s for new
&gt; Math::Big, 1.2s for new Math::Big returning non-BigInts, and 0.13-0.18s
&gt; for XS modules &#40;which all return non-BigInts for this range&#41;.
</div>
Yeah, the Math::Big* math is very slow, part idea  of this module was to
show &#34;it works&#34; and part &#34;it is still very slow, see if we can make it
faster&#34;.

Using a better algorithmn of course yields lot of improvements, but the
main point should be actually to make the Math::Big* math faster. So in
this light I think that it is justified to leave it at this point.

Thank you for your work, even tho I&#39;m no longer involved in the Perl core
development, I still use it quite heavily.

All the best,
tels


-- 
<span class="clickylink"><a target="new" rel="nofollow" href="http://bloodgate.com/galleries/">http://bloodgate.com/galleries/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1159132" href="/Public/Bug/Display.html?id=81986#txn-1159132">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;25&nbsp;12:57:23&nbsp;2012</span>
    <span class="description">DANAJ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1159132/609451/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/609451">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 25 11:56:51 2012, nospam-abuse@bloodgate.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; On Sat, December 15, 2012 6:50 pm, Dana Jacobsen via RT wrote:
<div class="message-stanza open">&gt; &gt; [...]
&gt; &gt;     0.025s Math::Prime::Util 0.12      XS, Lehmer&#39;s method
&gt; &gt;     0.36s  Math::Prime::Util 0.09      XS, segmented mod-30 sieve
&gt; &gt;     0.52s  Math::Prime::Util:PP 0.14   Perl, Lehmer&#39;s method
&gt; &gt;     2.90s  Math::Prime::FastSieve 0.18 XS, good SoE
&gt; &gt;    11.7s   Math::Prime::XS 0.29        XS
&gt; &gt;    15.0s   Bit::Vector 7.2             XS
&gt; &gt;    57.3s   Math::Prime::Util::PP 0.14  Perl, string sieve
&gt; &gt;     &#34;&#34;     Math::Big patched           &#34;&#34;
&gt; &gt;   169.5s   Python mpmath primepi 0.17  Python, 25 GB RAM.
&gt; &gt;   292.2s   Python sympy primepi 0.7.1  Python
&gt; &gt; 20000+     Math::Big 1.12              Perl, &gt; 26GB RAM
&gt; &gt;  [...]
</div>&gt; 
&gt; Hm, I think the actual times are missing?
</div>
Sorry, I meant that it&#39;s identical to the line above &#40;57.3s&#41;, since
they&#39;re using the same code in this case.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Summing the first 1M primes &#34;$sum += $_ for primes&#40;1000000&#41;&#34; on a
&gt; &gt; slightly slower machine:
&gt; &gt;  38.1s  old Math::Big
&gt; &gt;   1.7s  new Math::Big
&gt; &gt;   0.2s  new Math::Big returning @primes instead of mapping to BigInts
&gt; &gt;  ~0.02s the various XS modules
&gt; &gt;
&gt; &gt; Looks much more reasonable.  A lot of the time difference between the
&gt; &gt; non-BigInt and BigInt versions is the summation, which gets done as a
&gt; &gt; BigInt calculation.  At 10M, I get 402s for old Math::Big, 14s for new
&gt; &gt; Math::Big, 1.2s for new Math::Big returning non-BigInts, and 0.13-0.18s
&gt; &gt; for XS modules &#40;which all return non-BigInts for this range&#41;.
</div>&gt; 
&gt; Yeah, the Math::Big* math is very slow, part idea  of this module was to
&gt; show &#34;it works&#34; and part &#34;it is still very slow, see if we can make it
&gt; faster&#34;.
&gt; 
&gt; Using a better algorithmn of course yields lot of improvements, but the
&gt; main point should be actually to make the Math::Big* math faster. So in
&gt; this light I think that it is justified to leave it at this point.
&gt; 
&gt; Thank you for your work, even tho I&#39;m no longer involved in the Perl core
&gt; development, I still use it quite heavily.
</div>
I agree, for what it&#39;s worth.  Thanks again for the reply.

Dana
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1620981" href="/Public/Bug/Display.html?id=81986#txn-1620981">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;26&nbsp;08:19:22&nbsp;2016</span>
    <span class="description">peter.john.acklam [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1620981/868059/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/868059">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 24b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in Math-Big v1.13.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1620984" href="/Public/Bug/Display.html?id=81986#txn-1620984">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;26&nbsp;08:19:23&nbsp;2016</span>
    <span class="description">peter.john.acklam [...] gmail.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.505832</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
