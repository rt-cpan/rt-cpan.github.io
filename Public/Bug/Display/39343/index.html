<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #39343 for Tk: Skips lines when arrowing down in a window not exactly sized to a text line</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #39343 for Tk: Skips lines when arrowing down in a window not exactly sized to a text line</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Tk/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Tk/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Tk/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Tk/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Tk">Tk CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">39343</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Tk/Active/">Tk</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
thundergnat [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-33610-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
804.027</li>
<li>
804.027_500</li>
<li>
804.027_501</li>
<li>
804.027_502</li>
<li>
804.028</li>
</ul>
    </td>
  </tr>
  <tr id="CF-33611-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




textdiff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/509121/253353/textdiff">
Tue Sep 16 20:15:49 2008 (494b) by thundergnat [...] gmail.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;16&nbsp;20:15:49&nbsp;2008</span>
    <span class="description">thundergnat [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Skips lines when arrowing down in a window not exactly sized to a
 text line</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">If you resize a Text widget &#40;or a derivation&#41; so that the bottom of
the window is NOT exactly at the bottom of a line of text, and then
try to move the cursor down past the bottom of the text displayed in
the window using the arrow key, the cursor advances two lines instead
of one. It doesn&#39;t seem to matter whether the text widget is scrolled
or not and is independent of the font &#38; font size. 

OS independent.

In 804.028

Tk::Text version 4.026

sub UpDownLine.

Line 1205 reads:

&#40;$ly + $lh&#41; &gt; &#40; $w-&gt;height - 2*$w-&gt;cget&#40;-bd&#41; -
2*$w-&gt;cget&#40;-highlightthickness&#41; &#41; &#41;

#Check if last line y position plus line height is greater than visible
#window height &#40;window height - decorations and borders&#41;

But it really should be checking if it is greater than the visible
height minus any fraction of a line.

Modifying the line to read:

&#40;$ly + $lh&#41; &gt; &#40; $w-&gt;height - 2*$w-&gt;cget&#40;-bd&#41; -
2*$w-&gt;cget&#40;-highlightthickness&#41; - $lh + 1&#41; &#41;

fixes the problem without any repercussions that I can see. 

Patch file attached.


Here is a short script with a locally modified UpDownLine to
demonstrate. Run the script. Put the cursor at the bottom of the file,
then arrow down. The unmodified Text advances 2 lines at a time.

*************************************************************

#!/usr/bin/perl

{#######################################################################
package FixedText;

use base qw&#40;Tk::Text&#41;;

Construct Tk::Widget &#39;FixedText&#39;;

sub UpDownLine
{
 my &#40;$w,$n&#41; = @_;
 $w-&gt;see&#40;&#39;insert&#39;&#41;;
 my $i = $w-&gt;index&#40;&#39;insert&#39;&#41;;

 my &#40;$line,$char&#41; = split&#40;/\./,$i&#41;;

 my $testX; #used to check the &#34;new&#34; position
 my $testY; #used to check the &#34;new&#34; position

 &#40;my $bx, my $by, my $bw, my $bh&#41; = $w-&gt;bbox&#40;$i&#41;;
 &#40;my $lx, my $ly, my $lw, my $lh&#41; = $w-&gt;dlineinfo&#40;$i&#41;;

 if &#40; &#40;$n == -1&#41; and &#40;$by &lt;= $bh&#41; &#41;
  {
   #On first display line.. so scroll up and recalculate..
   $w-&gt;yview&#40;&#39;scroll&#39;, -1, &#39;units&#39;&#41;;
   unless &#40;&#40;$w-&gt;yview&#41;[0]&#41; {
     #first line of entire text - keep same position.
     return $i;
   }
   &#40;$bx, $by, $bw, $bh&#41; = $w-&gt;bbox&#40;$i&#41;;
   &#40;$lx, $ly, $lw, $lh&#41; = $w-&gt;dlineinfo&#40;$i&#41;;
  }
 elsif &#40; &#40;$n == 1&#41; and
         &#40;$ly + $lh&#41; &gt; &#40; $w-&gt;height - 2*$w-&gt;cget&#40;-bd&#41; -
2*$w-&gt;cget&#40;-highlightthickness&#41; - $lh + 1&#41; &#41;
  {
   #On last display line.. so scroll down and recalculate..
   $w-&gt;yview&#40;&#39;scroll&#39;, 1, &#39;units&#39;&#41;;
   &#40;$bx, $by, $bw, $bh&#41; = $w-&gt;bbox&#40;$i&#41;;
   &#40;$lx, $ly, $lw, $lh&#41; = $w-&gt;dlineinfo&#40;$i&#41;;
  }

 # Calculate the vertical position of the next display line
 my $Yoffset = 0;
 $Yoffset = $by - $ly + 1 if &#40;$n== -1&#41;;
 $Yoffset = $ly + $lh + 1 - $by if &#40;$n == 1&#41;;
 $Yoffset*=$n;
 $testY = $by + $Yoffset;

 # Save the original &#39;x&#39; position of the insert cursor if:
 # 1. This is the first time through -- or --
 # 2. The insert cursor position has changed from the previous
 #    time the up or down key was pressed -- or --
 # 3. The cursor has reached the beginning or end of the widget.

 {
  no warnings &#39;uninitialized&#39;;
  if &#40;not defined $w-&gt;{&#39;origx&#39;} or &#40;$w-&gt;{&#39;lastindex&#39;} != $i&#41; &#41;
   {
    $w-&gt;{&#39;origx&#39;} = $bx;
   }
 }

 # Try to keep the same column if possible
 $testX = $w-&gt;{&#39;origx&#39;};

 # Get the coordinates of the possible new position
 my $testindex = $w-&gt;index&#40;&#39;@&#39;.$testX.&#39;,&#39;.$testY &#41;;
 $w-&gt;see&#40;$testindex&#41;;
 my &#40;$nx,$ny,$nw,$nh&#41; = $w-&gt;bbox&#40;$testindex&#41;;

 # Which side of the character should we position the cursor -
 # mainly for a proportional font
 if &#40;$testX &gt; $nx+$nw/2&#41;
  {
   $testX = $nx+$nw+1;
  }

 my $newindex = $w-&gt;index&#40;&#39;@&#39;.$testX.&#39;,&#39;.$testY &#41;;

 if &#40; $w-&gt;compare&#40;$newindex,&#39;==&#39;,&#39;end - 1 char&#39;&#41; and &#40;$ny == $ly &#41; &#41;
  {
    # Then we are trying to the &#39;end&#39; of the text from
    # the same display line - don&#39;t do that
    return $i;
  }

 $w-&gt;{&#39;lastindex&#39;} = $newindex;
 $w-&gt;see&#40;$newindex&#41;;
 return $newindex;
}

1;

}###############################################################################

use strict;
use warnings;
use Tk;

my $w1 = MainWindow-&gt;new;
my $t1 = $w1-&gt;Text-&gt;pack&#40;
    -expand =&gt;1,
    -fill =&gt; &#39;both&#39;
&#41;;
$w1-&gt;title&#40;&#39;Original UpDownLine&#39;&#41;;
$t1-&gt;insert&#40;&#39;end&#39;,&#34;$_\n&#34;&#41; for &#40;1..100&#41;;

my $w2 = MainWindow-&gt;new;
my $t2 = $w2-&gt;FixedText-&gt;pack&#40;
    -expand =&gt;1,
    -fill =&gt; &#39;both&#39;
&#41;;
$w2-&gt;title&#40;&#39;Modified UpDownLine&#39;&#41;;
$t2-&gt;insert&#40;&#39;end&#39;,&#34;$_\n&#34;&#41; for &#40;1..100&#41;;

$w1-&gt;update;

my $geometry = $w1-&gt;geometry;
my &#40;$width,$height,$x,$y&#41; = split/[x+]/,$geometry;

$height += 8;
$width /= 2;
$geometry = $width.&#39;x&#39;.$height.&#34;+$x+$y&#34;;
$w1-&gt;geometry&#40;$geometry&#41;;
$x += $width+10;
$geometry = $width.&#39;x&#39;.$height.&#34;+$x+$y&#34;;
$w2-&gt;geometry&#40;$geometry&#41;;

MainLoop; 
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> textdiff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/509121/253353/textdiff">Download textdiff</a><br />
<span class="downloadcontenttype">application/octet-stream 494b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;18&nbsp;02:57:11&nbsp;2008</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks, applied to the svn repo at
<span class="clickylink"><a target="new" rel="nofollow" href="https://svn.perl.org/modules/Tk/trunk">https://svn.perl.org/modules/Tk/trunk</a></span>, change 11809.

Regards,
    Slaven
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;18&nbsp;02:57:13&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;18&nbsp;02:57:14&nbsp;2008</span>
    <span class="description">SREZIC [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
