<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #132844 for PDF-API2: PDF::API2 corrupts certain PNMs when embedding them</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #132844 for PDF-API2: PDF::API2 corrupts certain PNMs when embedding them</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/PDF-API2/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/PDF-API2">PDF-API2 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">132844</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/PDF-API2/Active/">PDF-API2</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jffry [...] posteo.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24958-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.037    </td>
  </tr>
  <tr id="CF-24959-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




corrupt_no_compression.pnm<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1902693/1019591/corrupt_no_compression.pnm">
Fri Jun 19 07:22:06 2020 (8491.1k) by jffry [...] posteo.net
</a>
</font></li>
</ul>


patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1902803/1019661/patch">
Sat Jun 20 06:11:37 2020 (1.7k) by jffry [...] posteo.net
</a>
</font></li>
</ul>


signature.asc<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1903589/1020072/signature.asc">
Sat Jun 27 05:38:08 2020 (833b) by jffry [...] posteo.net
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1902803/1019662/signature.asc">
Sat Jun 20 06:11:37 2020 (833b) by jffry [...] posteo.net
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1902714/1019605/signature.asc">
Fri Jun 19 13:53:52 2020 (833b) by jffry [...] posteo.net
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;07:22:06&nbsp;2020</span>
    <span class="description">jffry [...] posteo.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> PDF::API2 corrupts certain PNMs when embedding them</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w
use strict;
use PDF::API2;

my $pdf = PDF::API2-&gt; new&#40;-file =&gt; &#39;test.pdf&#39;&#41;;

my $page = $pdf-&gt; page;
$page-&gt;mediabox&#40;2480/300*72*5, 3506/300*72*5&#41;;

my $gfx = $page-&gt;gfx;
my $img = $pdf-&gt;image_pnm&#40;shift&#41;;
$gfx-&gt;image&#40;$img&#41;;

$pdf-&gt;save;
$pdf-&gt;end&#40;&#41;;

Run the above script with the pnm filename as an argument, the right hand side of the resulting PDF is shifted to the left.

Investigating this, the corruption depends upon the geometry of the
image - it is possible to crop the image to a size that is not corrupted
in the PDF.

e.g. the pnm after this cropping option is not corrupted:

convert corrupt_no_compression.pnm -crop 790x400+500+900
corrupt_no_compression_cropped.pnm

but cropping only the width, the corruption is still there, but less:

convert corrupt_no_compression.pnm -crop 790x3506+500+0
corrupt_no_compression_cropped.pnm

equally, cropping only the height, the corruption is also still there,
in a similar magnitude to the original:

convert corrupt_no_compression.pnm -crop 2480x400+0+900
corrupt_no_compression_cropped.pnm
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> corrupt_no_compression.pnm</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1902693/1019591/corrupt_no_compression.pnm">Download corrupt_no_compression.pnm</a><br />
<span class="downloadcontenttype">image/x-portable-anymap 8.2m</span>
</div>
<div class="messagebody">
<img alt="corrupt_no_compression.pnm" title="corrupt_no_compression.pnm" src="/Ticket/Attachment/1902693/1019591/" /></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction other SystemError even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;07:22:12&nbsp;2020</span>
    <span class="description">The RT System itself -  System error</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sending the previous mail has failed.  Please contact your admin, they can find more details in the logs.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;11:39:13&nbsp;2020</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I can see a problem with &#34;insufficient data&#34; for the image when the PDF tries to display it. This is both PDF::API2 and PDF::Builder. I am looking at it.

There are a couple odd things in your Perl script: 1&#41; you use &#34;shift&#34; for the name fed to image_pnm, even though @_ is empty at this point. I can avoid that error by replacing &#34;shift&#34; with &#34;$ARGV[0]&#34;. Can you explain what you are doing there? 2&#41; normally you give the lower left corner x,y in the image&#40;&#41; call. There&#39;s no telling for sure what it&#39;s using for x and y coordinates if you omit them. However, no improvement even if I add &#34;,0,0&#34; to the call. I also tried adding the dimensions &#34;,2480,3506&#34; but that didn&#39;t help.

The PNM file itself appears to be OK -- I can display it as 2480x3506 in GIMP &#40;grayscale 8 bit/pixel&#41;. Those are the dimensions stored in the PDF object describing the image, although the compressed stream &#40;Flate compress&#41; is 1047348 bytes rather than the original 8694880. Possibly something is going wrong with the compression itself -- I will have to try adding the image as UNcompressed data and see what happens. The page &#40;media box&#41; appears to be sufficiently large to hold the image.

Let me know if you make any headway with this, as I will be looking at it from this end.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;11:39:14&nbsp;2020</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;13:53:52&nbsp;2020</span>
    <span class="description">jffry [...] posteo.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #132844] PDF::API2 corrupts certain PNMs when embedding them</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 19 Jun 2020 19:45:53 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jeff &lt;jffry [...] posteo.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #132844] PDF::API2 corrupts certain PNMs when embedding them</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jeff &lt;jffry [...] posteo.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 19/06/2020 17:39, Phil M. Perry via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=132844">https://rt.cpan.org/Ticket/Display.html?id=132844</a></span> &gt;
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There are a couple odd things in your Perl script: 1&#41; you use &#34;shift&#34; for the name fed to image_pnm, even though @_ is empty at this point. I can avoid that error by replacing &#34;shift&#34; with &#34;$ARGV[0]&#34;. Can you explain what you are doing there? 2&#41; normally you give the lower left corner x,y in the image&#40;&#41; call. There&#39;s no telling for sure what it&#39;s using for x and y coordinates if you omit them. However, no improvement even if I add &#34;,0,0&#34; to the call. I also tried adding the dimensions &#34;,2480,3506&#34; but that didn&#39;t help.
</div>
&#34;shift&#34; used like that is the same as $ARGV[0], as it is a shortcut for
shift @ARGV.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The PNM file itself appears to be OK -- I can display it as 2480x3506 in GIMP &#40;grayscale 8 bit/pixel&#41;. Those are the dimensions stored in the PDF object describing the image, although the compressed stream &#40;Flate compress&#41; is 1047348 bytes rather than the original 8694880. Possibly something is going wrong with the compression itself -- I will have to try adding the image as UNcompressed data and see what happens. The page &#40;media box&#41; appears to be sufficiently large to hold the image.
&gt; 
&gt; Let me know if you make any headway with this, as I will be looking at it from this end.
</div>
I tried out various different filters with no success.

The header of the pnm says 2480x3506, which implies a filesize of
8694919, which is what the file is &#40;on my system&#41;.

I would expect the flate to compress it quite well, as there quite a bit
of white there. So 8x smaller is no surprise.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1902714/1019605/signature.asc">Download signature.asc</a><br />
<span class="downloadcontenttype">application/pgp-signature 833b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;22:38:00&nbsp;2020</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think I&#39;ve got it fixed &#40;in PDF::Builder, PhilterPaper/Perl-PDF-Builder&#41;. It&#39;s two lines to add in PNM.pm &#40;see GitHub entry for RT 132844 fix&#41;, and should be easy enough to add to PDF::API2. Let me know if the fix clears things up for you. This may be a code path that was never exercised for PNM before. The error I was getting was that there was insufficient data for the image... I&#39;m not sure what you were seeing.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;20&nbsp;06:11:37&nbsp;2020</span>
    <span class="description">jffry [...] posteo.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #132844] PDF::API2 corrupts certain PNMs when embedding them</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 20 Jun 2020 12:11:15 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jeff &lt;jffry [...] posteo.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #132844] PDF::API2 corrupts certain PNMs when embedding them</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jeff &lt;jffry [...] posteo.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 20/06/2020 04:38, Phil M. Perry via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=132844">https://rt.cpan.org/Ticket/Display.html?id=132844</a></span> &gt;
&gt; 
&gt; I think I&#39;ve got it fixed &#40;in PDF::Builder, PhilterPaper/Perl-PDF-Builder&#41;. It&#39;s two lines to add in PNM.pm &#40;see GitHub entry for RT 132844 fix&#41;, and should be easy enough to add to PDF::API2. Let me know if the fix clears things up for you. This may be a code path that was never exercised for PNM before. The error I was getting was that there was insufficient data for the image... I&#39;m not sure what you were seeing.
</div>
Thanks for the patch, Phil. I confirm that this fixes things for me too.

For reference, I&#39;ve attached the patch adapted for PDF::API2.
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1902803/1019662/signature.asc">Download signature.asc</a><br />
<span class="downloadcontenttype">application/pgp-signature 833b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;20&nbsp;09:29:51&nbsp;2020</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Great! The patch is in PDF::Builder; I don&#39;t know when Steve will put it into PDF::API2. Note that I have not looked at any other PNM types/subtypes, so something similar could happen with other PNM files, too.

BTW, the defaulting of x and y to 0,0 in image&#40;&#41; and form_image&#40;&#41; wasn&#39;t really part of the PNM fix, but it doesn&#39;t hurt to put it in. Being undefined in your example code, they apparently were being treated as 0,0, but I don&#39;t like relying on such behavior. If someone used, e.g., the -e flag on Perl, that might be flagged as an error.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;26&nbsp;11:54:20&nbsp;2020</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, the specification 

<span class="clickylink"><a target="new" rel="nofollow" href="http://netpbm.sourceforge.net/doc/pgm.html">http://netpbm.sourceforge.net/doc/pgm.html</a></span>

mentions &#40;see #8&#41; &#34;single whitespace character &#40;usually a newline&#41;&#34; between Maxval and 
raster data; that whitespace character was already consumed by &#34;readppmheader&#34;; the purpose of this line:

<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/SSIMMS/PDF-API2-2.037/lib/PDF/API2/Resource/XObject/Image/PNM.pm#L134">https://metacpan.org/source/SSIMMS/PDF-API2-2.037/lib/PDF/API2/Resource/XObject/Image/PNM.pm#L134</a></span>

eludes me completely; was reading a PGM ever successful with PDF::API2, and was it even tested? No similar line for PPM full-color images, as I see. 

Patch, as suggested, fixes the issue, but, in absence of what that line was supposed to do &#40;such as well-known and tolerated application which produced broken PGMs, perhaps? but then what about others?&#41;, I&#39;d simply remove it. Keep this remark documented, at least; the module has its share of issues, if whoever is going to untangle them, maybe this will alleviate the task :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;26&nbsp;16:33:49&nbsp;2020</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yeah, I&#39;m not sure just what it&#39;s supposed to be doing. What I did find was that this one read sucked in 857kB of data &#40;well into the raster data&#41;, leaving the next read way short. The patch I gave works for THIS particular PNM file &#40;the ONLY one I have to test with&#41;, but it shouldn&#39;t be surprising if it breaks on another file. That&#39;s not even considering other types/subtypes. Maybe it was expecting an empty or dummy line to simply eat, leaving the next read at the start of the raster data?

As PNM is apparently pretty rare &#40;I had never seen one before this ticket&#41;, I&#39;m not inclined to put a lot of effort into fixing it at this point. If you or someone else wants to go over it with a fine-toothed comb and fix up the code, I&#39;ll be happy to incorporate it into PDF::Builder. Otherwise, if it proves to be really buggy, I don&#39;t think it would be a tragedy to remove PNM support entirely.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;27&nbsp;05:38:08&nbsp;2020</span>
    <span class="description">jffry [...] posteo.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #132844] PDF::API2 corrupts certain PNMs when embedding them</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 27 Jun 2020 11:37:44 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jeff &lt;jffry [...] posteo.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #132844] PDF::API2 corrupts certain PNMs when embedding them</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jeff &lt;jffry [...] posteo.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It&#39;s a really simple format, no compression and shouldn&#39;t be hard to fix
properly:

<span class="clickylink"><a target="new" rel="nofollow" href="https://en.wikipedia.org/wiki/Netpbm">https://en.wikipedia.org/wiki/Netpbm</a></span>

You could cover the basics with six test images. I could create them for
you, if you like.

I first noticed that all was not good with PDF::API2&#39;s handling of PNM
ages ago. Here is another image I found in 2009:

<span class="clickylink"><a target="new" rel="nofollow" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=514380#5">https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=514380#5</a></span>
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1903589/1020072/signature.asc">Download signature.asc</a><br />
<span class="downloadcontenttype">application/pgp-signature 833b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;27&nbsp;15:58:26&nbsp;2020</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Well.... if it&#39;s a format that people are actually still using, and depend on, and the format is that simple, it might be worth fixing. After all, I did go and fix the BDF font support. It sounds like there are more than just six variations that would need to be handled, and tested, but if six would take care of the vast majority of users, we could at least start with that. 

How about all the related formats similar to .pnm? Are you looking at those too, or just PNM itself? I just don&#39;t want to go down a rabbit hole with &#34;please add this additional format/variation&#34;, or there are all sorts of informal variations, and it never ends. Also please pay attention to all the formats/variations that PDF::API2 currently claims to support -- would any of those be dropped?

If you&#39;re willing to contribute a list of vital formats/variations to support, and test cases for them, I can work with you on PDF::Builder&#39;s PNM support. I can&#39;t do anything about PDF::API2, although the code for Builder will *probably* work OK on API2 &#40;no guarantees&#41;.

If you have a GitHub account, please open a ticket on PDF::Builder &#40;PhilterPaper/Perl-PDF-Builder&#41;, or open an account on catskilltech.com/forum. I don&#39;t want to clog up PDF::API2 discussions with PDF::Builder support.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
