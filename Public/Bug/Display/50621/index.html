<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #50621 for DBI: Signal-handling sample code is buggy</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #50621 for DBI: Signal-handling sample code is buggy</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBI">DBI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">50621</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBI/Active/">DBI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
eponymousalias [...] yahoo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10328-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10329-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;18&nbsp;15:50:31&nbsp;2009</span>
    <span class="description">eponymousalias [...] yahoo.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Signal-handling sample code is buggy</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 18 Oct 2009 12:50:04 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> eponymous alias &lt;eponymousalias [...] yahoo.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The example code for signal handling:

  eval {
    local $SIG{ALRM} = sub { die &#34;TIMEOUT\n&#34; };
    alarm&#40;$seconds&#41;;
    ... code to execute with timeout here ...
    alarm&#40;0&#41;;  # cancel alarm &#40;if code ran fast&#41;
  };
  alarm&#40;0&#41;;    # cancel alarm &#40;if eval failed&#41;
  if &#40; $@ eq &#34;TIMEOUT\n&#34; &#41; { ... }

is buggy.  Suppose the eval dies for some reason unrelated to the
signal handling just before the alarm expires, and then the code
exits the eval, and then the alarm expires before the final alarm&#40;0&#41;
can be called.  Now either the code will completely die because
there is no $SIG{ALRM} handler in place to catch the signal, or
the wrong handler &#40;not the local handler&#41; will be called.

What you need instead is:

  eval {
    local $SIG{ALRM} = sub { die &#34;TIMEOUT\n&#34; };
    eval {
      alarm&#40;$seconds&#41;;
      ... code to execute with timeout here ...
      alarm&#40;0&#41;;  # cancel alarm &#40;if code ran fast&#41;
    };
    alarm&#40;0&#41;;    # cancel alarm &#40;if eval failed&#41;
    die $@ if $@;
  };
  if &#40; $@ eq &#34;TIMEOUT\n&#34; &#41; { ... }

so the desired signal handler is called in this situation.

The same problem affects the sample sigaction code just below
this timeout example.



      
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;19&nbsp;04:30:44&nbsp;2009</span>
    <span class="description">Tim.Bunce [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #50621] Signal-handling sample code is buggy</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 19 Oct 2009 09:30:20 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> eponymous alias via RT &lt;bug-DBI [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Bunce &lt;Tim.Bunce [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun, Oct 18, 2009 at 03:50:32PM -0400, eponymous alias via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The example code for signal handling: [...]
&gt; What you need instead is: [...]
&gt; 
&gt; The same problem affects the sample sigaction code just below
&gt; this timeout example.
</div>
Thanks!  Could you send me a patch to fix both?

Tim.

p.s. I think the &#34;alarm&#40;0&#41;;  # cancel alarm &#40;if code ran fast&#41;&#34;
isn&#39;t needed as the following alarm&#40;0&#41;, just after the inner eval,
will work just as well and it doesn&#39;t matter if a SIGALRM arrives
before it&#39;s executed.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;19&nbsp;04:30:45&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;17&nbsp;10:08:59&nbsp;2010</span>
    <span class="description">lab [...] lincolnbaxter.com.MAKE.ME.VALID -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> Tim.Bunce [...] pobox.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Oct 19 04:30:44 2009, Tim.Bunce@pobox.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun, Oct 18, 2009 at 03:50:32PM -0400, eponymous alias via RT wrote:
&gt; p.s. I think the &#34;alarm&#40;0&#41;;  # cancel alarm &#40;if code ran fast&#41;&#34;
&gt; isn&#39;t needed as the following alarm&#40;0&#41;, just after the inner eval,
&gt; will work just as well and it doesn&#39;t matter if a SIGALRM arrives
&gt; before it&#39;s executed.
</div>
Tim,

I just noticed this yesterday.  Not sure why I missed it when it was
first entered.  I see the suggested fix is wrapping the eval with an
eval.  I wonder if this bug was ever actually manifested in as system,
the submitter owns or manages, logically I think he is right, but given
the fact that we are essentially revert to &#34;unsafe&#34; signal handling
here, and we still don&#39;t have a proposed fix to the safe flags problem I
have identified in my tests, I wonder if it really matters.  The code is
somewhat ugly.  If I understand your remark correctly, I think you are
saying &#40;and I think I agree&#41; that that inner cancel is unnecessary.  I
just looked in the DBI pod to see if your example code was ever
patched... Did you ever get a patch, that you have not released yet?  

I&#39;m going to think about this for a day or too.  I don&#39;t think this
impacts the Sys::SigAction code itself, though it would require changes
to the tests.  I&#39;ll modify the tests, and if no negative impacts are
found &#40;i expect not&#41;, I&#39;ll probably update Sys::SigAction in the next
week, with the modified tests and POD updates. 

Has this been updated this in DBI?, or if not, would you like a patch
from me, that is consistent with what I finally do with Sys::SigAction?

Lincoln
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;19&nbsp;03:05:30&nbsp;2010</span>
    <span class="description">eponymousalias [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #50621] Signal-handling sample code is buggy</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 19 Jan 2010 00:05:03 -0800 &#40;PST&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> eponymous alias &lt;eponymousalias [...] yahoo.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- On Sun, 1/17/10, Lincoln A Baxter via RT &lt;bug-DBI@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I wonder if this bug was ever actually manifested in a
&gt; system, the submitter owns or manages,
</div>
No, I spotted the bug not by exercising it, but by long
experience in staring down uncommon conditions, as I was
reading the documentation.  But the bug could be simulated
easily enough, by a &#34;die&#34; right after alarm&#40;$seconds&#41; and
introducing an infinite loop &#40;just to demonstrate what
would otherwise be a rare condition&#41; right before the
second alarm&#40;0&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Logically I think he is right, but given the fact that
&gt; we are essentially revert to &#34;unsafe&#34; signal handling
&gt; here, and we still don&#39;t have a proposed fix to the safe
&gt; flags problem I have identified in my tests, I wonder if
&gt; it really matters.
</div>
I would suggest that you read page 417 of Programming Perl,
3/e for the basic idea.  However, the code presented there
is simply wrong, and suffers from the same condition of
having the local ALRM handler out of scope when the alarm
might finally occur just before the second &#34;alarm 0;&#34;.  My
copy of the book has a handwritten note &#34;code is wrong --
see errata&#34;, but the O&#39;Reilly site is &#40;ridiculously&#41; showing
no confirmed errata for this book.  I believe it used to, as
that would explain my note, but the errata page has not been
properly maintained.  Also, the explanation in the last two
sentences of the page is clearly bogus, though it does hint
at the actual problem.  The authors had the right intuition
but failed to capture reality in both their implementation
and their explanation.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The code is somewhat ugly.  Did you ever get a patch,
&gt; that you have not released yet?  
</div>
Sorry, I&#39;ve been too busy &#40;writing other code, and finding
bugs in other Perl-modules, some submitted and some still
queued up&#41; to submit a patch.



      
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;10&nbsp;08:37:32&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jan 19 03:05:30 2010, eponymousalias@yahoo.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; --- On Sun, 1/17/10, Lincoln A Baxter via RT &lt;bug-DBI@rt.cpan.org&gt; wrote:
<div class="message-stanza open">&gt; &gt; I wonder if this bug was ever actually manifested in a
&gt; &gt; system, the submitter owns or manages,
</div>&gt; 
&gt; No, I spotted the bug not by exercising it, but by long
&gt; experience in staring down uncommon conditions, as I was
&gt; reading the documentation.  But the bug could be simulated
&gt; easily enough, by a &#34;die&#34; right after alarm&#40;$seconds&#41; and
&gt; introducing an infinite loop &#40;just to demonstrate what
&gt; would otherwise be a rare condition&#41; right before the
&gt; second alarm&#40;0&#41;.
&gt; 
<div class="message-stanza open">&gt; &gt; Logically I think he is right, but given the fact that
&gt; &gt; we are essentially revert to &#34;unsafe&#34; signal handling
&gt; &gt; here, and we still don&#39;t have a proposed fix to the safe
&gt; &gt; flags problem I have identified in my tests, I wonder if
&gt; &gt; it really matters.
</div>&gt; 
&gt; I would suggest that you read page 417 of Programming Perl,
&gt; 3/e for the basic idea.  However, the code presented there
&gt; is simply wrong, and suffers from the same condition of
&gt; having the local ALRM handler out of scope when the alarm
&gt; might finally occur just before the second &#34;alarm 0;&#34;.  My
&gt; copy of the book has a handwritten note &#34;code is wrong --
&gt; see errata&#34;, but the O&#39;Reilly site is &#40;ridiculously&#41; showing
&gt; no confirmed errata for this book.  I believe it used to, as
&gt; that would explain my note, but the errata page has not been
&gt; properly maintained.  Also, the explanation in the last two
&gt; sentences of the page is clearly bogus, though it does hint
&gt; at the actual problem.  The authors had the right intuition
&gt; but failed to capture reality in both their implementation
&gt; and their explanation.
&gt; 
<div class="message-stanza open">&gt; &gt; The code is somewhat ugly.  Did you ever get a patch,
&gt; &gt; that you have not released yet?  
</div>&gt; 
&gt; Sorry, I&#39;ve been too busy &#40;writing other code, and finding
&gt; bugs in other Perl-modules, some submitted and some still
&gt; queued up&#41; to submit a patch.
&gt; 
</div>
The example from the documentation modified to demonstrate the problem
as the OP reported is:

use strict;
use warnings;

$SIG{ALRM} = sub {print &#34;outer alarm handler\n&#34;};

eval {
    local $SIG{ALRM} = sub { die &#34;TIMEOUT\n&#34; };
    alarm&#40;5&#41;;
    die &#34;fred&#34;; # long running code that dies before alarm

};
# infinite loop to demonstrate what happens if alarm&#40;0&#41; is not
# called in time
while &#40;1&#41; { 
    sleep 1;
}
alarm&#40;0&#41;;    # cancel alarm &#40;if eval failed&#41;
if &#40; $@ eq &#34;TIMEOUT\n&#34; &#41; {
    print &#34;timeout seen\n&#34;;
}
   
produces:

$ ~/svn/dbi/trunk$ perl ex/timeout.pl
outer alarm handler

The corrected example &#40;which I&#39;ll document&#41; and modified to demonstrate
the problem is:

use strict;
use warnings;

$SIG{ALRM} = sub {print &#34;outer alarm handler\n&#34;};

eval {
    local $SIG{ALRM} = sub { die &#34;TIMEOUT\n&#34; };
    eval {
        alarm&#40;5&#41;;
        die &#34;fred&#34;; # long running code that dies before alarm
    };
    alarm&#40;0&#41;;
    die &#34;$@\n&#34; if $@;
};
while &#40;1&#41; {
    sleep 1;
}
if &#40; $@ eq &#34;TIMEOUT\n&#34; &#41; {
    print &#34;timeout seen\n&#34;;
} elsif &#40;$@&#41; {
    print &#34;died with $@\n&#34;;
}

which produces no output &#40;correctly&#41;.

I&#39;ll update both examples in subversion.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;10&nbsp;12:43:15&nbsp;2010</span>
    <span class="description">Tim.Bunce [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #50621] Signal-handling sample code is buggy</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 10 Mar 2010 15:15:31 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Martin J Evans via RT &lt;bug-DBI [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Bunce &lt;Tim.Bunce [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Mar 10, 2010 at 08:37:33AM -0500, Martin J Evans via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; eval {
&gt;     local $SIG{ALRM} = sub { die &#34;TIMEOUT\n&#34; };
&gt;     eval {
&gt;         alarm&#40;5&#41;;
&gt;         die &#34;fred&#34;; # long running code that dies before alarm
&gt;     };
</div>
maybe add an explanatory comment:

      # outer eval catches alarm that might fire JUST before this alarm&#40;0&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     alarm&#40;0&#41;;
&gt;     die &#34;$@\n&#34; if $@;
</div>
just: die $@ if $@; to avoid adding an additional newline to $@
which would break the $@ eq &#34;TIMEOUT\n&#34; check below.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ll update both examples in subversion.
</div>
Thanks Martin!

Tim.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;30&nbsp;08:18:05&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Mar 10 12:43:15 2010, Tim.Bunce@pobox.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed, Mar 10, 2010 at 08:37:33AM -0500, Martin J Evans via RT wrote:
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; eval {
&gt; &gt;     local $SIG{ALRM} = sub { die &#34;TIMEOUT\n&#34; };
&gt; &gt;     eval {
&gt; &gt;         alarm&#40;5&#41;;
&gt; &gt;         die &#34;fred&#34;; # long running code that dies before alarm
&gt; &gt;     };
</div>&gt; 
&gt; maybe add an explanatory comment:
&gt; 
&gt;       # outer eval catches alarm that might fire JUST before this alarm&#40;0&#41;
&gt; 
<div class="message-stanza open">&gt; &gt;     alarm&#40;0&#41;;
&gt; &gt;     die &#34;$@\n&#34; if $@;
</div>&gt; 
&gt; just: die $@ if $@; to avoid adding an additional newline to $@
&gt; which would break the $@ eq &#34;TIMEOUT\n&#34; check below.
&gt; 
<div class="message-stanza open">&gt; &gt; I&#39;ll update both examples in subversion.
</div>&gt; 
&gt; Thanks Martin!
&gt; 
&gt; Tim.
</div>
For reason I missed Tim&#39;s last comment on this RT and have just checked
in the change. I think this rt can be written off now.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;30&nbsp;16:42:52&nbsp;2010</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Resolved by r13940
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;30&nbsp;16:42:53&nbsp;2010</span>
    <span class="description">TIMB [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
