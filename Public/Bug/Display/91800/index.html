<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #91800 for XML-LibXML: Threads still failing?</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #91800 for XML-LibXML: Threads still failing?</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/XML-LibXML/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-LibXML">XML-LibXML CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">91800</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/XML-LibXML/Active/">XML-LibXML</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
perrettdl [...] googlemail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-37350-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-37351-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;02&nbsp;14:09:57&nbsp;2014</span>
    <span class="description">perrettdl [...] googlemail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Threads still failing?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 2 Jan 2014 19:09:43 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-LibXML [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> D Perrett &lt;perrettdl [...] googlemail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span class="clickylink"><a target="new" rel="nofollow" href="https://gist.github.com/pdl/8222887">https://gist.github.com/pdl/8222887</a></span>

breaks with error

PmmFreeHashTable: not empty

On Strawberry Perl, the error is different, it lists the memory addresses.

I have observed this on 5.12 &#40;Strawberry 32-bit&#41;, 5.14 &#40;cygwin 32-bit,
Ubuntu 64-bit, Fedora 32-bit&#41;. I have confirmed this occurs even when
t/90threads.t is executed and passes and is not skipped.

I don&#39;t have access to later releases compiled with threads but I
can&#39;t see anything in
<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/release/SHLOMIF/XML-LibXML-2.0108/LibXML.pod#THREAD-SUPPORT">https://metacpan.org/pod/release/SHLOMIF/XML-LibXML-2.0108/LibXML.pod#THREAD-SUPPORT</a></span>
or in perldelta indicating later perls will yield different results.

Daniel
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;02&nbsp;14:16:14&nbsp;2014</span>
    <span class="description">perrettdl [...] googlemail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #91800] AutoReply: Threads still failing?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 2 Jan 2014 19:16:06 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-LibXML [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> D Perrett &lt;perrettdl [...] googlemail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">NB: the error without :threads_shared is

PmmREFCNT_dec: REFCNT decremented below 0 for b1fea0!.
PmmREFCNT_dec: REFCNT decremented below 0 for b3edc0!.
PmmREFCNT_dec: REFCNT decremented below 0 for b4a830!.
PmmREFCNT_dec: REFCNT decremented below 0 for b47f40!.
PmmREFCNT_dec: REFCNT decremented below 0 for b47a80!.
*** Error in `perl&#39;: corrupted double-linked list: 0x0000000000b47f10 ***

On Strawberry, this is always the error, except I don&#39;t get the last
line, I get a dialog box.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;03&nbsp;05:24:40&nbsp;2014</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

On Thu Jan 02 14:09:57 2014, perrettdl@googlemail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://gist.github.com/pdl/8222887">https://gist.github.com/pdl/8222887</a></span>
&gt; 
</div>
Please put the contents of that gist as an attachment here, so it won&#39;t get lost.

I&#39;ll try to take a look at this problem when I&#39;m in the mood. In the meanwhile - a patch with a regression testcase would be welcome.
 
Regards,

     -- Shlomi Fish
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;03&nbsp;05:24:40&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;20&nbsp;08:28:28&nbsp;2014</span>
    <span class="description">perrettdl [...] googlemail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #91800] Threads still failing?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 20 Jan 2014 13:28:15 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-LibXML [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> D Perrett &lt;perrettdl [...] googlemail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello

I&#39;ve taken the standalone file and turned it into a test file, and
then attached it. For me it fails with: &#34;Dubious, test returned 5
&#40;wstat 1280, 0x500&#41;&#34;

Daniel

On 3 January 2014 10:24, Shlomi Fish via RT &lt;bug-XML-LibXML@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=91800">https://rt.cpan.org/Ticket/Display.html?id=91800</a></span> &gt;
&gt;
&gt; Hi,
&gt;
&gt; On Thu Jan 02 14:09:57 2014, perrettdl@googlemail.com wrote:
<div class="message-stanza open">&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://gist.github.com/pdl/8222887">https://gist.github.com/pdl/8222887</a></span>
&gt;&gt;
</div>&gt;
&gt; Please put the contents of that gist as an attachment here, so it won&#39;t get lost.
&gt;
&gt; I&#39;ll try to take a look at this problem when I&#39;m in the mood. In the meanwhile - a patch with a regression testcase would be welcome.
&gt;
&gt; Regards,
&gt;
&gt;      -- Shlomi Fish
&gt;
</div></div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;13&nbsp;10:52:47&nbsp;2014</span>
    <span class="description">yoreek [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jan 20 15:28:28 2014, perrettdl@googlemail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello
&gt; 
&gt; I&#39;ve taken the standalone file and turned it into a test file, and
&gt; then attached it. For me it fails with: &#34;Dubious, test returned 5
&gt; &#40;wstat 1280, 0x500&#41;&#34;
&gt; 
&gt; Daniel
&gt; 
&gt; On 3 January 2014 10:24, Shlomi Fish via RT &lt;bug-XML-
&gt; LibXML@rt.cpan.org&gt; wrote:
<div class="message-stanza open">&gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=91800">https://rt.cpan.org/Ticket/Display.html?id=91800</a></span> &gt;
&gt; &gt;
&gt; &gt; Hi,
&gt; &gt;
&gt; &gt; On Thu Jan 02 14:09:57 2014, perrettdl@googlemail.com wrote:
<div class="message-stanza open">&gt; &gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://gist.github.com/pdl/8222887">https://gist.github.com/pdl/8222887</a></span>
&gt; &gt;&gt;
</div>&gt; &gt;
&gt; &gt; Please put the contents of that gist as an attachment here, so it
&gt; &gt; won&#39;t get lost.
&gt; &gt;
&gt; &gt; I&#39;ll try to take a look at this problem when I&#39;m in the mood. In the
&gt; &gt; meanwhile - a patch with a regression testcase would be welcome.
&gt; &gt;
&gt; &gt; Regards,
&gt; &gt;
&gt; &gt; -- Shlomi Fish
&gt; &gt;
</div></div>
Hi

I investigated this bug and I think the bug occurs during pass object to thread &#34;$q-&gt;enqueue&#40;$doc&#41;&#34;.
In which case uses function &#34;shared_clone&#34; and new variable looks as this:
SV = IV&#40;0x2610f20&#41; at 0x2610f28
  REFCNT = 1
  FLAGS = &#40;PADMY,ROK&#41;
  RV = 0x2235438
  SV = PVMG&#40;0x2317a20&#41; at 0x2235438
    REFCNT = 1
    FLAGS = &#40;PADMY,OBJECT,GMG,SMG,OVERLOAD,pIOK&#41;
    IV = 39825760
    NV = 0
    PV = 0
    MAGIC = 0x2629310
      MG_VIRTUAL = 0x7f2f3c2ec440
      MG_TYPE = PERL_MAGIC_shared_scalar&#40;n&#41;
      MG_FLAGS = 0x30
      MG_PTR = 0x223f758 &#34;&#34;
    STASH = 0x2444540   &#34;XML::LibXML::Document&#34;

Wherein REFCNT of the real object is not changed, but when this is destroyed, the counter is decreased, and this should not be.

Basically we can rewrite the source code so as not to pass object by $q-&gt;enqueue&#40;@docs&#41;, but I can offer patch that adds check if variable is shared and if so, not to decrease REFCNT.

Sorry for my english.

-- 
YOREEK
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt91800_shared_clone.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -Nuraw XML-LibXML-2.0110-orig/LibXML.xs XML-LibXML-2.0110/LibXML.xs
--- XML-LibXML-2.0110-orig/LibXML.xs	2014-01-31 14:49:14.000000000 +0700
+++ XML-LibXML-2.0110/LibXML.xs	2014-02-13 19:44:48.295305557 +0700
@@ -4100,8 +4100,33 @@
 void
 DESTROY&#40; node &#41;
         SV * node
+    PREINIT:
+        int count;
+        SV *is_shared;
     CODE:
 #ifdef XML_LIBXML_THREADS
+    if &#40; &#40;is_shared = get_sv&#40;&#34;XML::LibXML::__threads_shared&#34;, 0&#41;&#41; == NULL &#41; {
+        is_shared = &#38;PL_sv_undef;
+    }
+    if &#40; SvTRUE&#40;is_shared&#41; &#41; {
+        dSP;
+        ENTER;
+        SAVETMPS;
+        PUSHMARK&#40;SP&#41;;
+        XPUSHs&#40;node&#41;;
+        PUTBACK;
+        count = call_pv&#40;&#34;threads::shared::is_shared&#34;, G_SCALAR&#41;;
+        SPAGAIN;
+        if &#40;count != 1&#41;
+            croak&#40;&#34;Couldn&#39;t checks if the variable is shared or not\n&#34;&#41;;
+        is_shared = POPs;
+        PUTBACK;
+        FREETMPS;
+        LEAVE;
+        if &#40;is_shared != &#38;PL_sv_undef&#41; {
+            XSRETURN_UNDEF;
+        }
+    }
 	if&#40; PmmUSEREGISTRY &#41; {
 	  SvLOCK&#40;PROXY_NODE_REGISTRY_MUTEX&#41;;
 	  PmmRegistryREFCNT_dec&#40;SvPROXYNODE&#40;node&#41;&#41;;
diff -Nuraw XML-LibXML-2.0110-orig/t/90shared_clone_failed_rt_91800.t XML-LibXML-2.0110/t/90shared_clone_failed_rt_91800.t
--- XML-LibXML-2.0110-orig/t/90shared_clone_failed_rt_91800.t	1970-01-01 07:00:00.000000000 +0700
+++ XML-LibXML-2.0110/t/90shared_clone_failed_rt_91800.t	2014-02-13 22:36:24.458723624 +0700
@@ -0,0 +1,46 @@
+
+use strict;
+use warnings;
+
+use Test::More;
+use Config;
+BEGIN
+{
+    my $will_run = 0;
+    if &#40; $Config{useithreads} &#41;
+    {
+        if &#40;$ENV{THREAD_TEST}&#41;
+        {
+            require threads;
+            require threads::shared;
+            $will_run = 1;
+        }
+        else
+        {
+            plan skip_all =&gt; &#34;optional &#40;set THREAD_TEST=1 to run these tests&#41;&#34;;
+        }
+    }
+    else
+    {
+        plan skip_all =&gt; &#34;no ithreads in this Perl&#34;;
+    }
+
+    if &#40;$will_run&#41;
+    {
+        plan tests =&gt; 3;
+    }
+}
+
+use XML::LibXML qw&#40;:threads_shared&#41;;
+# TEST
+ok&#40;1, &#39;Loaded&#39;&#41;;
+
+my $p = XML::LibXML-&gt;new&#40;&#41;;
+# TEST
+ok&#40;$p, &#39;Parser initted.&#39;&#41;;
+
+{
+    my $doc = $p-&gt;parse_string&#40;qq{&lt;root&gt;&lt;foo id=&#34;1&#34;&gt;bar&lt;/foo&gt;&lt;/root&gt;}&#41;;
+    my $cloned = threads::shared::shared_clone&#40;$doc&#41;;
+    ok&#40;1,  &#34;Shared clone&#34;&#41;;
+}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;19&nbsp;06:50:17&nbsp;2014</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I applied YOREEK&#39;s patch &#40;after some modification&#41; in the 195d5d278828 commit. YOREEK, for your information:

1. Next time, the patch should also include a description in the &#34;Changes&#34; file.

2. You missed a &#34;# TEST&#34; directive in the test file.

3. The test script should include the URL to the bug report in the comments or POD.

Regards,

-- Shlomi Fish
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;06&nbsp;07:51:04&nbsp;2014</span>
    <span class="description">paul [...] city-fan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> paul [...] city-fan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Feb 19 06:50:17 2014, SHLOMIF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I applied YOREEK&#39;s patch &#40;after some modification&#41; in the 195d5d278828
&gt; commit. YOREEK, for your information:
&gt; 
&gt; 1. Next time, the patch should also include a description in the
&gt; &#34;Changes&#34; file.
&gt; 
&gt; 2. You missed a &#34;# TEST&#34; directive in the test file.
&gt; 
&gt; 3. The test script should include the URL to the bug report in the
&gt; comments or POD.
&gt; 
&gt; Regards,
&gt; 
&gt; -- Shlomi Fish
</div>
Also please note that threads::shared::shared_clone was introduced in threads::shared 1.21, so I needed to tweak the test a little to skip on older versions:

--- t/90shared_clone_failed_rt_91800.t
+++ t/90shared_clone_failed_rt_91800.t
@@ -13,7 +13,14 @@
         {
             require threads;
             require threads::shared;
-            $will_run = 1;
+            if &#40; $threads::shared::VERSION &lt; 1.21 &#41;
+            {
+                plan skip_all =&gt; &#34;threads::shared 1.21 required for shared_clone&#34;;
+            }
+            else
+            {
+                $will_run = 1;
+            }
         }
         else
         {

Also, is_shared was introduced in threads::shared 0.96, and I get warnings from the threads test on older versions:

t/90threads............................ &#40;in cleanup&#41; Undefined subroutine &#38;threads::shared::is_shared called at /builddir/build/BUILD/XML-LibXML-2.0111/blib/lib/XML/LibXML.pm line 1571.
        &#40;in cleanup&#41; Undefined subroutine &#38;threads::shared::is_shared called at /builddir/build/BUILD/XML-LibXML-2.0111/blib/lib/XML/LibXML.pm line 1571.
        &#40;in cleanup&#41; Undefined subroutine &#38;threads::shared::is_shared called at /builddir/build/BUILD/XML-LibXML-2.0111/blib/lib/XML/LibXML.pm line 1571.
        &#40;in cleanup&#41; Undefined subroutine &#38;threads::shared::is_shared called at /builddir/build/BUILD/XML-LibXML-2.0111/blib/lib/XML/LibXML.pm line 1571.
        &#40;in cleanup&#41; Undefined subroutine &#38;threads::shared::is_shared called at /builddir/build/BUILD/XML-LibXML-2.0111/blib/lib/XML/LibXML.pm line 1571.
&#40;repeat lots&#41;
        &#40;in cleanup&#41; Undefined subroutine &#38;threads::shared::is_shared called during global destruction.
PmmFreeHashTable: not empty
        &#40;in cleanup&#41; Undefined subroutine &#38;threads::shared::is_shared called during global destruction.
PmmFreeHashTable: not empty
        &#40;in cleanup&#41; Undefined subroutine &#38;threads::shared::is_shared called during global destruction.
PmmFreeHashTable: not empty
        &#40;in cleanup&#41; Undefined subroutine &#38;threads::shared::is_shared called during global destruction.
PmmFreeHashTable: not empty
&#40;repeat lots&#41;

Perhaps _id could be used instead?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;07&nbsp;12:16:07&nbsp;2014</span>
    <span class="description">yoreek [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Mar 06 14:51:04 2014, paul@city-fan.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Feb 19 06:50:17 2014, SHLOMIF wrote:
<div class="message-stanza open">&gt; &gt; I applied YOREEK&#39;s patch &#40;after some modification&#41; in the
&gt; &gt; 195d5d278828
&gt; &gt; commit. YOREEK, for your information:
&gt; &gt;
&gt; &gt; 1. Next time, the patch should also include a description in the
&gt; &gt; &#34;Changes&#34; file.
&gt; &gt;
&gt; &gt; 2. You missed a &#34;# TEST&#34; directive in the test file.
&gt; &gt;
&gt; &gt; 3. The test script should include the URL to the bug report in the
&gt; &gt; comments or POD.
&gt; &gt;
&gt; &gt; Regards,
&gt; &gt;
&gt; &gt; -- Shlomi Fish
</div>&gt; 
&gt; Also please note that threads::shared::shared_clone was introduced in
&gt; threads::shared 1.21, so I needed to tweak the test a little to skip
&gt; on older versions:
&gt; 
&gt; --- t/90shared_clone_failed_rt_91800.t
&gt; +++ t/90shared_clone_failed_rt_91800.t
&gt; @@ -13,7 +13,14 @@
&gt;          {
&gt;              require threads;
&gt;              require threads::shared;
&gt; -            $will_run = 1;
&gt; +            if &#40; $threads::shared::VERSION &lt; 1.21 &#41;
&gt; +            {
&gt; +                plan skip_all =&gt; &#34;threads::shared 1.21 required for
&gt; shared_clone&#34;;
&gt; +            }
&gt; +            else
&gt; +            {
&gt; +                $will_run = 1;
&gt; +            }
&gt;          }
&gt;          else
&gt;          {
&gt; 
&gt; Also, is_shared was introduced in threads::shared 0.96, and I get
&gt; warnings from the threads test on older versions:
&gt; 
&gt; t/90threads............................ &#40;in cleanup&#41; Undefined
&gt; subroutine &#38;threads::shared::is_shared called at
&gt; /builddir/build/BUILD/XML-LibXML-2.0111/blib/lib/XML/LibXML.pm line
&gt; 1571.
&gt;         &#40;in cleanup&#41; Undefined subroutine &#38;threads::shared::is_shared
&gt; called at /builddir/build/BUILD/XML-LibXML-
&gt; 2.0111/blib/lib/XML/LibXML.pm line 1571.
&gt;         &#40;in cleanup&#41; Undefined subroutine &#38;threads::shared::is_shared
&gt; called at /builddir/build/BUILD/XML-LibXML-
&gt; 2.0111/blib/lib/XML/LibXML.pm line 1571.
&gt;         &#40;in cleanup&#41; Undefined subroutine &#38;threads::shared::is_shared
&gt; called at /builddir/build/BUILD/XML-LibXML-
&gt; 2.0111/blib/lib/XML/LibXML.pm line 1571.
&gt;         &#40;in cleanup&#41; Undefined subroutine &#38;threads::shared::is_shared
&gt; called at /builddir/build/BUILD/XML-LibXML-
&gt; 2.0111/blib/lib/XML/LibXML.pm line 1571.
&gt; &#40;repeat lots&#41;
&gt;         &#40;in cleanup&#41; Undefined subroutine &#38;threads::shared::is_shared
&gt; called during global destruction.
&gt; PmmFreeHashTable: not empty
&gt;         &#40;in cleanup&#41; Undefined subroutine &#38;threads::shared::is_shared
&gt; called during global destruction.
&gt; PmmFreeHashTable: not empty
&gt;         &#40;in cleanup&#41; Undefined subroutine &#38;threads::shared::is_shared
&gt; called during global destruction.
&gt; PmmFreeHashTable: not empty
&gt;         &#40;in cleanup&#41; Undefined subroutine &#38;threads::shared::is_shared
&gt; called during global destruction.
&gt; PmmFreeHashTable: not empty
&gt; &#40;repeat lots&#41;
&gt; 
&gt; Perhaps _id could be used instead?
</div>
I agree with Paul that we can use &#34;_id&#34; instead of &#34;is_shared&#34;:

--- XML-LibXML-2.0111-orig/LibXML.xs    2014-03-05 17:13:09.000000000 +0200
+++ XML-LibXML-2.0111/LibXML.xs 2014-03-07 20:27:47.000000000 +0200
@@ -4127,7 +4127,7 @@
         PUSHMARK&#40;SP&#41;;
         XPUSHs&#40;node&#41;;
         PUTBACK;
-        count = call_pv&#40;&#34;threads::shared::is_shared&#34;, G_SCALAR&#41;;
+        count = call_pv&#40;&#34;threads::shared::_id&#34;, G_SCALAR&#41;;
         SPAGAIN;
         if &#40;count != 1&#41;
             croak&#40;&#34;Couldn&#39;t checks if the variable is shared or not\n&#34;&#41;;

-- 
YOREEK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;07&nbsp;14:29:18&nbsp;2014</span>
    <span class="description">NWELLNHOF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> yoreek [...] yahoo.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Feb 13 10:52:47 2014, yoreek wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Basically we can rewrite the source code so as not to pass object by
&gt; $q-&gt;enqueue&#40;@docs&#41;, but I can offer patch that adds check if variable
&gt; is shared and if so, not to decrease REFCNT.
</div>
Unfortunately, this can&#39;t be made to work safely. Consider the following sequence:

    my $doc = $parser-&gt;parse&#40;...&#41;;
    my $clone = shared_clone&#40;$doc&#41;;
    $doc = undef;
    print $clone-&gt;documentElement;

When $doc is set to undef, it will be freed and subsequent usage via the cloned SVs will fail &#40;segfault or whatever&#41;. The way I see it, it&#39;s simply impossible to make shared_clone work with XML::LibXML objects. So I&#39;d vote to revert your patch.

But it should work to simply pass a reference to an XML::LibXML object to $q-&gt;enqueue.

    $q-&gt;enqueue&#40;map { \$_ } @docs&#41;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;08&nbsp;04:25:28&nbsp;2014</span>
    <span class="description">yoreek [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Mar 07 21:29:18 2014, NWELLNHOF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Feb 13 10:52:47 2014, yoreek wrote:
<div class="message-stanza open">&gt; &gt; Basically we can rewrite the source code so as not to pass object by
&gt; &gt; $q-&gt;enqueue&#40;@docs&#41;, but I can offer patch that adds check if variable
&gt; &gt; is shared and if so, not to decrease REFCNT.
</div>&gt; 
&gt; Unfortunately, this can&#39;t be made to work safely. Consider the
&gt; following sequence:
&gt; 
&gt; my $doc = $parser-&gt;parse&#40;...&#41;;
&gt; my $clone = shared_clone&#40;$doc&#41;;
&gt; $doc = undef;
&gt; print $clone-&gt;documentElement;
&gt; 
&gt; When $doc is set to undef, it will be freed and subsequent usage via
&gt; the cloned SVs will fail &#40;segfault or whatever&#41;. The way I see it,
&gt; it&#39;s simply impossible to make shared_clone work with XML::LibXML
&gt; objects. So I&#39;d vote to revert your patch.
&gt; 
&gt; But it should work to simply pass a reference to an XML::LibXML object
&gt; to $q-&gt;enqueue.
&gt; 
&gt; $q-&gt;enqueue&#40;map { \$_ } @docs&#41;;
</div>

Thanks Nick for the comment.

I have tried to understand how works shared_clone and I think that shared_clone not work correctly with objects is a C structure:

$make_shared = sub {
    my &#40;$item, $cloned&#41; = @_;
    ...
    # Copy a scalar ref
    elsif &#40;$ref_type eq &#39;SCALAR&#39;&#41; {
        $copy = \do{ my $scalar = $$item; };
    ...
    bless&#40;$copy, $class&#41;;
    ...
    return $copy;
};

In fact a reference to object is copied as number and blessed, the result is a new reference to same object, but not an increase REFCNT.

If so, then we need fix shared_clone or modify code as suggested by Nick. Patch can be reverted because it only partially solves problem.

-- 
YOREEK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;08&nbsp;06:09:27&nbsp;2014</span>
    <span class="description">NWELLNHOF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Mar 08 04:25:28 2014, yoreek wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In fact a reference to object is copied as number and blessed, the
&gt; result is a new reference to same object, but not an increase REFCNT.
</div>
The Perl ref count is increased, but XML::LibXML has its own little objects &#40;proxy nodes&#41; which have another, separate ref count. The Perl objects contain a pointer to these proxy nodes. shared_clone copies this pointer without increasing the internal ref count. That&#39;s why you get the double free error.

&#40;The reason for the second reference count is that for every XML::LibXML::Node object, XML::LibXML has to keep a reference to the owner of that node, typically a document. Otherwise, the document could be destroyed prematurely.&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If so, then we need fix shared_clone or modify code as suggested by
&gt; Nick. Patch can be reverted because it only partially solves problem.
</div>
I don&#39;t think shared_clone can be made to work with the kind of memory management that XML::LibXML uses.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;16&nbsp;12:21:51&nbsp;2016</span>
    <span class="description">jkahrman [...] mathworks.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jkahrman [...] mathworks.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">See also <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=117423#txn-1669591">https://rt.cpan.org/Public/Bug/Display.html?id=117423#txn-1669591</a></span>
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
