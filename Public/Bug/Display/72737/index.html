<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #72737 for Perl-Critic: Parsing bug for return statement</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #72737 for Perl-Critic: Parsing bug for return statement</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Perl-Critic/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Perl-Critic/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Perl-Critic/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Perl-Critic/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/Perl-Critic/Perl-Critic/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Perl-Critic">Perl-Critic CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">72737</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Perl-Critic/Active/">Perl-Critic</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
john.deighan [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-25198-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.116    </td>
  </tr>
  <tr id="CF-25199-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;26&nbsp;09:24:22&nbsp;2011</span>
    <span class="description">john.deighan [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Parsing bug for return statement</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The attached file compiles just fine, but Perl::Critic gives incorrect
warnings, apparently because the return statement doesn&#39;t have
whitespace between the word &#39;return&#39; and the following string literal.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"># test.pl

use strict;
use warnings;
no warnings qw&#40;uninitialized numeric&#41;;

# ------------------------------------

MAIN: {
my $str = f&#40;&#41;;
print&#40;&#34;str = &#39;$str&#39;\n&#34;&#41;;
} # MAIN&#40;&#41;

# ------------------------------------

sub f {

return&#39;ProposedOverdue.png&#39;;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;26&nbsp;16:41:47&nbsp;2011</span>
    <span class="description">wyant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Nov 26 09:24:22 2011, jdeighan wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The attached file compiles just fine, but Perl::Critic gives incorrect
&gt; warnings, apparently because the return statement doesn&#39;t have
&gt; whitespace between the word &#39;return&#39; and the following string literal.
</div>
You don&#39;t say what warnings you object to, but running your example I
presume it is

Subroutine &#34;f&#34; does not end with &#34;return&#34; at line 16, column 1.  See
page 197 of PBP.  &#40;Severity: 4&#41;

The line in question is

return&#39;ProposedOverdue.png&#39;;

Perl::Critic relies on PPI to do its parsing for it, and the PPI parse
does not find a &#39;return&#39; in subroutine f&#40;&#41;. PPI produces the following
parse for the file starting at the declaration of subroutine f&#40;&#41;:

                      PPI::Statement::Sub
[   16,   1,   1 ]     PPI::Token::Word         &#39;sub&#39;
[   16,   5,   5 ]     PPI::Token::Word         &#39;f&#39;
                        PPI::Structure::Block   { ... ???
                          PPI::Statement
[   18,   1,   1 ]         PPI::Token::Word     &#39;return&#39;ProposedOverdue&#39;
[   18,  23,  23 ]         PPI::Token::Operator         &#39;.&#39;
[   18,  24,  24 ]         PPI::Token::Word     &#39;png&#39;
[   18,  27,  27 ]         PPI::Token::Quote::Single    &#39;&#39;;\n}\n&#39;

In other words, without the space after the &#39;return&#39;, PPI thinks that it
has a Perl 4 package reference &#40;i.e. the equivalent of
return::ProposedOverdue&#41;, and the rest of the parse is basically
garbage. PPI does not fail, because when run against what it thinks is
invalid Perl, its design goal appears to be not to die horribly.

You can try filing a ticket against PPI, referring to this one. But this
is a case where I would really advise that you just put a space after
the &#39;return&#39;, since I&#39;m inclined to regard Perl&#39;s &#39;correct&#39; parse of
this as a bug in Perl.

Tom
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;26&nbsp;16:41:48&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;26&nbsp;16:41:49&nbsp;2011</span>
    <span class="description">wyant [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;28&nbsp;14:20:53&nbsp;2011</span>
    <span class="description">john.deighan [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #72737] Parsing bug for return statement</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 28 Nov 2011 14:20:43 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Perl-Critic [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Deighan &lt;john.deighan [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Actually, I got both of these warnings:

Subroutine &#34;f&#34; does not end with &#34;return&#34; at line 19, column 1. See
page 197 of PBP.
Literal line breaks in a string at line 21, column 27. See pages 60,61 of PBP.

More importantly, though, when I run the script, the function returns
the correct value. So, clearly, the PPI parser is NOT doing what the
actual Perl parser does, so in my opinion, PPI is wrong simply because
Perl is &#34;right&#34; by definition. I will, of course, always put a space
after the word &#39;return&#39; &#40;this came up simply because I made a global
editing change that ended up creating the problematic construct&#41;, and
I will submit a bug report for PPI, though I suspect that they will
take your point of view, not mine ;-&#41; Thanks.

On Sat, Nov 26, 2011 at 4:41 PM, Tom Wyant via RT
&lt;bug-Perl-Critic@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=72737">https://rt.cpan.org/Ticket/Display.html?id=72737</a></span> &gt;
&gt;
&gt; On Sat Nov 26 09:24:22 2011, jdeighan wrote:
<div class="message-stanza open">&gt;&gt; The attached file compiles just fine, but Perl::Critic gives incorrect
&gt;&gt; warnings, apparently because the return statement doesn&#39;t have
&gt;&gt; whitespace between the word &#39;return&#39; and the following string literal.
</div>&gt;
&gt; You don&#39;t say what warnings you object to, but running your example I
&gt; presume it is
&gt;
&gt; Subroutine &#34;f&#34; does not end with &#34;return&#34; at line 16, column 1.  See
&gt; page 197 of PBP.  &#40;Severity: 4&#41;
&gt;
&gt; The line in question is
&gt;
&gt; return&#39;ProposedOverdue.png&#39;;
&gt;
&gt; Perl::Critic relies on PPI to do its parsing for it, and the PPI parse
&gt; does not find a &#39;return&#39; in subroutine f&#40;&#41;. PPI produces the following
&gt; parse for the file starting at the declaration of subroutine f&#40;&#41;:
&gt;
&gt;                      PPI::Statement::Sub
&gt; [   16,   1,   1 ]     PPI::Token::Word         &#39;sub&#39;
&gt; [   16,   5,   5 ]     PPI::Token::Word         &#39;f&#39;
&gt;                        PPI::Structure::Block   { ... ???
&gt;                          PPI::Statement
&gt; [   18,   1,   1 ]         PPI::Token::Word     &#39;return&#39;ProposedOverdue&#39;
&gt; [   18,  23,  23 ]         PPI::Token::Operator         &#39;.&#39;
&gt; [   18,  24,  24 ]         PPI::Token::Word     &#39;png&#39;
&gt; [   18,  27,  27 ]         PPI::Token::Quote::Single    &#39;&#39;;\n}\n&#39;
&gt;
&gt; In other words, without the space after the &#39;return&#39;, PPI thinks that it
&gt; has a Perl 4 package reference &#40;i.e. the equivalent of
&gt; return::ProposedOverdue&#41;, and the rest of the parse is basically
&gt; garbage. PPI does not fail, because when run against what it thinks is
&gt; invalid Perl, its design goal appears to be not to die horribly.
&gt;
&gt; You can try filing a ticket against PPI, referring to this one. But this
&gt; is a case where I would really advise that you just put a space after
&gt; the &#39;return&#39;, since I&#39;m inclined to regard Perl&#39;s &#39;correct&#39; parse of
&gt; this as a bug in Perl.
&gt;
&gt; Tom
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;28&nbsp;14:20:54&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;29&nbsp;20:50:23&nbsp;2011</span>
    <span class="description">wyant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Nov 28 14:20:53 2011, jdeighan wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Actually, I got both of these warnings:
&gt; 
&gt; Subroutine &#34;f&#34; does not end with &#34;return&#34; at line 19, column 1. See
&gt; page 197 of PBP.
&gt; Literal line breaks in a string at line 21, column 27. See pages 60,61
&gt; of PBP.
&gt; 
</div>
Thanks. Here is where I think the second one came from.

One of PPI&#39;s explicit goals it to be round-trip safe. That is, if you
feed it some Perl, you should be able to get the same Perl back out of it.

So when PPI decided to parse &#34;return&#39;ProposedOverdue.png&#39;;&#34; as Perl 4
package name &#34;return&#39;ProposedOverdue&#34;, it had to do something with the
unclosed quoted string that this decision created. So it just returned
it as is. Perl::Critic looked at this parse, and generated the spurious
&#34;Literal line breaks&#34; error.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; More importantly, though, when I run the script, the function returns
&gt; the correct value. So, clearly, the PPI parser is NOT doing what the
&gt; actual Perl parser does, so in my opinion, PPI is wrong simply because
&gt; Perl is &#34;right&#34; by definition.
</div>
This argument has been made before. The counter-example I had in mind
was &#39;for $x qw{Larry Moe Curly} {...}&#39;, with no parentheses around the
list. Perl never complained about this, until 5.14 when it became
deprecated.

The true situation is that Perl is only right until the Perl maintainers
decide it is wrong.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I will, of course, always put a space
&gt; after the word &#39;return&#39; &#40;this came up simply because I made a global
&gt; editing change that ended up creating the problematic construct&#41;,
</div>
Thank you. And thank you for submitting your report. You found something
interesting, and let us know, which is the right thing to do.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; and
&gt; I will submit a bug report for PPI, though I suspect that they will
&gt; take your point of view, not mine ;-&#41; Thanks.
</div>
Well, I confess my opinion that fixing this may take an amount of time
disproportionate to the benefit gained. And it may be impossible to fix
it completely.

It is known that you can not statically parse Perl. That is, you can not
be guaranteed to construct a correct parse of a Perl program simply from
looking at the program.

But this is what PPI tries to do. Usually it does it pretty well. But if
duplicating Perl&#39;s parse in this case depends on knowing that the first
element of the offending construct is a subroutine name and what its
prototype &#40;if any&#41; is, than I suspect that duplicating Perl&#39;s parse in
all cases may be out of PPI&#39;s reach.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
