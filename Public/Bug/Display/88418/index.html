<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #88418 for Cache-Cache: intermittent size-aware test failure</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #88418 for Cache-Cache: intermittent size-aware test failure</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Cache-Cache">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Cache-Cache">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Cache-Cache">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Cache-Cache">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Cache-Cache">Cache-Cache CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">88418</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Cache-Cache">Cache-Cache</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
zefram [...] fysh.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
gregoa [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-4846-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-4847-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




0001-Make-tests-aware-of-running-time.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1398020/742223/0001-Make-tests-aware-of-running-time.patch">
Wed Aug 13 06:09:17 2014 (4.2k) by ppisar [...] redhat.com
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1397983/742193/0001-Make-tests-aware-of-running-time.patch">
Wed Aug 13 03:45:36 2014 (3.9k) by ppisar [...] redhat.com
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1379798/732621/0001-Make-tests-aware-of-running-time.patch">
Thu Jun 26 08:48:21 2014 (3.4k) by ppisar [...] redhat.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=88418">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1258232" href="/Public/Bug/Display.html?id=88418#txn-1258232">#</a>      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;04&nbsp;11:40:19&nbsp;2013</span>
    <span class="description">zefram [...] fysh.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> intermittent size-aware test failure</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 4 Sep 2013 16:40:01 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Cache-Cache [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1258232/666154/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/666154">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m intermittently seeing Cache-Cache fail its tests thus:

t/5_test_size_aware_file_cache.t .... ok
Couldn&#39;t limit size to 28 at /opt/perl-5.18.1/cpan/build/Cache-Cache-1.06-CTXYVU
/blib/lib/Cache/CacheSizer.pm line 92.
Couldn&#39;t limit size to 28 at /opt/perl-5.18.1/cpan/build/Cache-Cache-1.06-CTXYVU
/blib/lib/Cache/CacheSizer.pm line 92.
Use of uninitialized value $first_value in string eq at /opt/perl-5.18.1/cpan/bu
ild/Cache-Cache-1.06-CTXYVU/blib/lib/Cache/SizeAwareCacheTester.pm line 149.
t/6_test_size_aware_memory_cache.t .. 
Failed 1/48 subtests 

The test involves a series of cache entries that are
ascribed sizes of 28 or 29.  These sizes are being judged by
Cache::MemoryCache::Backend::get_size&#40;&#41;, which is looking at the length
of the stringified form of an object, for which it gets strings such as
&#34;Cache::Object=HASH&#40;0x17dfde8&#41;&#34;; the number of hexadecimal digits in the
memory address accounts for the variability of the sizes.  I conclude
that the size estimation is entirely bogus.

The test failure could be accounted for by a race condition in
Cache::SizeAwareCacheTester::_test_two&#40;&#41;.  After setting a value for
$first_key with expiry in 20 s, it sets values for five more keys,
separated by sleep&#40;1&#41; calls, with expiry in 10 s.  The test relies
on $first_key having a later expiry time than any of the other five,
so that the $cache-&gt;limit_size&#40;$size_limit&#41; call evicts all keys other
than $first_key.  If there is an uncommanded pause amounting to 5 s
during the process of setting the five keys, the last of them could have
expiry time equal to or later than that of $first_key.  If it&#39;s later
then the test definitely fails; if it&#39;s tied then the result depends on
hash order and relative perceived size of the cache entries.  Adding a
sleep&#40;5&#41; before the cache setting loop is enough to induce these failures.

I haven&#39;t determined whether the above is how the intermittent failures
that I&#39;ve seen have occurred.  There may be another failure mode.

For my purposes, I&#39;m disabling the size-aware cache tests, because &#40;as
noted above&#41; the size awareness is bogus and we don&#39;t rely on it anyway.

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1379798" href="/Public/Bug/Display.html?id=88418#txn-1379798">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;26&nbsp;08:48:21&nbsp;2014</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1379798/732620/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/732620">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne St 04.zář.2013 11:40:19, zefram@fysh.org napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m intermittently seeing Cache-Cache fail its tests thus:
&gt; 
&gt; t/5_test_size_aware_file_cache.t .... ok
&gt; Couldn&#39;t limit size to 28 at /opt/perl-5.18.1/cpan/build/Cache-Cache-
&gt; 1.06-CTXYVU
&gt; /blib/lib/Cache/CacheSizer.pm line 92.
&gt; Couldn&#39;t limit size to 28 at /opt/perl-5.18.1/cpan/build/Cache-Cache-
&gt; 1.06-CTXYVU
&gt; /blib/lib/Cache/CacheSizer.pm line 92.
&gt; Use of uninitialized value $first_value in string eq at /opt/perl-
&gt; 5.18.1/cpan/bu
&gt; ild/Cache-Cache-1.06-CTXYVU/blib/lib/Cache/SizeAwareCacheTester.pm
&gt; line 149.
&gt;  t/6_test_size_aware_memory_cache.t ..
&gt;  Failed 1/48 subtests
&gt;
</div>[...] 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; The test failure could be accounted for by a race condition in
&gt; Cache::SizeAwareCacheTester::_test_two&#40;&#41;.  After setting a value for
&gt; $first_key with expiry in 20 s, it sets values for five more keys,
&gt; separated by sleep&#40;1&#41; calls, with expiry in 10 s.  The test relies
&gt; on $first_key having a later expiry time than any of the other five,
&gt; so that the $cache-&gt;limit_size&#40;$size_limit&#41; call evicts all keys other
&gt; than $first_key.  If there is an uncommanded pause amounting to 5 s
&gt; during the process of setting the five keys, the last of them could
&gt; have
&gt; expiry time equal to or later than that of $first_key.  If it&#39;s later
&gt; then the test definitely fails; if it&#39;s tied then the result depends
&gt; on
&gt; hash order and relative perceived size of the cache entries.  Adding a
&gt; sleep&#40;5&#41; before the cache setting loop is enough to induce these
&gt; failures.
</div>
Attached patch should fix the time races in the tests.

-- Petr
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Make-tests-aware-of-running-time.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1379798/732621/0001-Make-tests-aware-of-running-time.patch">Download 0001-Make-tests-aware-of-running-time.patch</a><br />
<span class="downloadcontenttype">text/x-diff 3.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 79b3decdb39c6a12261bb9a5f5bbada5ceec39eb Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Thu, 26 Jun 2014 13:43:09 +0200
Subject: [PATCH] Make tests aware of running time
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Some tests could fail if they run slower then the tested time limits
because then caches entries expired on different place expected. This
patch skips such tests if the running time is not shorter than
expected.

CPAN RT#88418

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 lib/Cache/CacheTester.pm          | 30 ++++++++++++++++++++++++------
 lib/Cache/SizeAwareCacheTester.pm | 10 ++++++++--
 2 files changed, 32 insertions&#40;+&#41;, 8 deletions&#40;-&#41;

diff --git a/lib/Cache/CacheTester.pm b/lib/Cache/CacheTester.pm
index 8f64577..1cd6f82 100644
--- a/lib/Cache/CacheTester.pm
+++ b/lib/Cache/CacheTester.pm
@@ -168,12 +168,18 @@ sub _test_four
 
   my $value = &#39;Test Value&#39;;
 
+  my $start = time;
   $cache-&gt;set&#40; $key, $value, $expires_in &#41;;
 
   my $fetched_value = $cache-&gt;get&#40; $key &#41;;
 
-  &#40; $fetched_value eq $value &#41; ?
-    $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$fetched_value eq $value&#39; &#41;;
+  if &#40;time - $start &lt; $expires_in&#41; {
+    &#40; $fetched_value eq $value &#41; ?
+      $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$fetched_value eq $value&#39; &#41;;
+  } else {
+      $self-&gt;skip&#40; &#39;$fetched_value eq $value &#40;not finished in &#39; .
+        $expires_in . &#39; s&#41;&#39; &#41;;
+  }
 
   sleep&#40; $EXPIRES_DELAY + 1 &#41;;
 
@@ -460,12 +466,18 @@ sub _test_thirteen
 
   my $value = &#39;Test Value&#39;;
 
+  my $start = time;
   $cache-&gt;set&#40; $key, $value, $expires_in &#41;;
 
   my $fetched_value = $cache-&gt;get&#40; $key &#41;;
 
-  &#40; $fetched_value eq $value &#41; ?
-    $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$fetched_value eq $value&#39; &#41;;
+  if &#40;time - $start &lt; $expires_in&#41; {
+    &#40; $fetched_value eq $value &#41; ?
+      $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$fetched_value eq $value&#39; &#41;;
+  } else {
+    $self-&gt;skip&#40; &#39;$fetched_value eq $value &#40;not finished in &#39; .
+      $expires_in . &#39; s&#41;&#39; &#41;;
+  }
 
   sleep&#40; $EXPIRES_DELAY + 1 &#41;;
 
@@ -525,12 +537,18 @@ sub _test_fifteen
 
   my $value = &#39;Test Value&#39;;
 
+  my $start = time;
   $cache-&gt;set&#40; $key, $value, $expires_in &#41;;
 
   my $fetched_value = $cache-&gt;get&#40; $key &#41;;
 
-  &#40; $fetched_value eq $value &#41; ?
-    $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$fetched_value eq $value&#39; &#41;;
+  if &#40;time - $start &lt; $expires_in&#41; {
+    &#40; $fetched_value eq $value &#41; ?
+      $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$fetched_value eq $value&#39; &#41;;
+  } else {
+      $self-&gt;skip&#40; &#39;$fetched_value eq $value &#40;not finished in &#39; .
+        $expires_in . &#39; s&#41;&#39; &#41;;
+  }
 
   sleep&#40; $EXPIRES_DELAY + 1 &#41;;
 
diff --git a/lib/Cache/SizeAwareCacheTester.pm b/lib/Cache/SizeAwareCacheTester.pm
index 1a660f7..1a36c48 100644
--- a/lib/Cache/SizeAwareCacheTester.pm
+++ b/lib/Cache/SizeAwareCacheTester.pm
@@ -110,6 +110,7 @@ sub _test_two
 
   my $first_expires_in = 20;
 
+  my $start = time;
   $cache-&gt;set&#40; $first_key, $value, $first_expires_in &#41;;
 
   my $first_size = $cache-&gt;size&#40; &#41;;
@@ -146,8 +147,13 @@ sub _test_two
 
   my $first_value = $cache-&gt;get&#40; $first_key &#41;;
 
-  &#40; $first_value eq $value &#41; ?
-    $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$first_value eq $value&#39; &#41;;
+  if &#40;time - $start &lt; $first_expires_in &#41; {
+    &#40; $first_value eq $value &#41; ?
+      $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$first_value eq $value&#39; &#41;;
+  } else {
+    $self-&gt;skip&#40; &#39;$first_value eq $value &#40;not finished in &#39; .
+      $first_expires_in . &#39; s&#41;&#39;&#41;;
+  }
 
 }
 
-- 
1.9.3

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1379799" href="/Public/Bug/Display.html?id=88418#txn-1379799">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;26&nbsp;08:48:21&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1397983" href="/Public/Bug/Display.html?id=88418#txn-1397983">#</a>      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;13&nbsp;03:45:36&nbsp;2014</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1397983/742192/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/742192">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Čt 26.čen.2014 08:48:21, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne St 04.zář.2013 11:40:19, zefram@fysh.org napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; I&#39;m intermittently seeing Cache-Cache fail its tests thus:
&gt; &gt; 
&gt; &gt; t/5_test_size_aware_file_cache.t .... ok
&gt; &gt; Couldn&#39;t limit size to 28 at /opt/perl-5.18.1/cpan/build/Cache-Cache-
&gt; &gt; 1.06-CTXYVU
&gt; &gt; /blib/lib/Cache/CacheSizer.pm line 92.
&gt; &gt; Couldn&#39;t limit size to 28 at /opt/perl-5.18.1/cpan/build/Cache-Cache-
&gt; &gt; 1.06-CTXYVU
&gt; &gt; /blib/lib/Cache/CacheSizer.pm line 92.
&gt; &gt; Use of uninitialized value $first_value in string eq at /opt/perl-
&gt; &gt; 5.18.1/cpan/bu
&gt; &gt; ild/Cache-Cache-1.06-CTXYVU/blib/lib/Cache/SizeAwareCacheTester.pm
&gt; &gt; line 149.
&gt; &gt;  t/6_test_size_aware_memory_cache.t ..
&gt; &gt;  Failed 1/48 subtests
&gt; &gt;
</div>&gt; [...] 
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; The test failure could be accounted for by a race condition in
&gt; &gt; Cache::SizeAwareCacheTester::_test_two&#40;&#41;.  After setting a value for
&gt; &gt; $first_key with expiry in 20 s, it sets values for five more keys,
&gt; &gt; separated by sleep&#40;1&#41; calls, with expiry in 10 s.  The test relies
&gt; &gt; on $first_key having a later expiry time than any of the other five,
&gt; &gt; so that the $cache-&gt;limit_size&#40;$size_limit&#41; call evicts all keys other
&gt; &gt; than $first_key.  If there is an uncommanded pause amounting to 5 s
&gt; &gt; during the process of setting the five keys, the last of them could
&gt; &gt; have
&gt; &gt; expiry time equal to or later than that of $first_key.  If it&#39;s later
&gt; &gt; then the test definitely fails; if it&#39;s tied then the result depends
&gt; &gt; on
&gt; &gt; hash order and relative perceived size of the cache entries.  Adding a
&gt; &gt; sleep&#40;5&#41; before the cache setting loop is enough to induce these
&gt; &gt; failures.
</div>&gt; 
&gt; Attached patch should fix the time races in the tests.
&gt; 
</div>There was another race. Attached patch fixes it and replaces the previous patch.

-- Petr
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Make-tests-aware-of-running-time.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1397983/742193/0001-Make-tests-aware-of-running-time.patch">Download 0001-Make-tests-aware-of-running-time.patch</a><br />
<span class="downloadcontenttype">text/x-diff 3.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 53b0e5405595a8a9b87b53dea1464584237f4dc7 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Thu, 26 Jun 2014 13:43:09 +0200
Subject: [PATCH] Make tests aware of running time
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Some tests could fail if they run slower then the tested time limits
because then caches entries expired on different place than expected. This
patch skips such tests if the running time is not shorter than
expected.

CPAN RT#88418

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 lib/Cache/CacheTester.pm          | 30 ++++++++++++++++++++++++------
 lib/Cache/SizeAwareCacheTester.pm | 19 +++++++++++++++----
 2 files changed, 39 insertions&#40;+&#41;, 10 deletions&#40;-&#41;

diff --git a/lib/Cache/CacheTester.pm b/lib/Cache/CacheTester.pm
index 8f64577..1cd6f82 100644
--- a/lib/Cache/CacheTester.pm
+++ b/lib/Cache/CacheTester.pm
@@ -168,12 +168,18 @@ sub _test_four
 
   my $value = &#39;Test Value&#39;;
 
+  my $start = time;
   $cache-&gt;set&#40; $key, $value, $expires_in &#41;;
 
   my $fetched_value = $cache-&gt;get&#40; $key &#41;;
 
-  &#40; $fetched_value eq $value &#41; ?
-    $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$fetched_value eq $value&#39; &#41;;
+  if &#40;time - $start &lt; $expires_in&#41; {
+    &#40; $fetched_value eq $value &#41; ?
+      $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$fetched_value eq $value&#39; &#41;;
+  } else {
+      $self-&gt;skip&#40; &#39;$fetched_value eq $value &#40;not finished in &#39; .
+        $expires_in . &#39; s&#41;&#39; &#41;;
+  }
 
   sleep&#40; $EXPIRES_DELAY + 1 &#41;;
 
@@ -460,12 +466,18 @@ sub _test_thirteen
 
   my $value = &#39;Test Value&#39;;
 
+  my $start = time;
   $cache-&gt;set&#40; $key, $value, $expires_in &#41;;
 
   my $fetched_value = $cache-&gt;get&#40; $key &#41;;
 
-  &#40; $fetched_value eq $value &#41; ?
-    $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$fetched_value eq $value&#39; &#41;;
+  if &#40;time - $start &lt; $expires_in&#41; {
+    &#40; $fetched_value eq $value &#41; ?
+      $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$fetched_value eq $value&#39; &#41;;
+  } else {
+    $self-&gt;skip&#40; &#39;$fetched_value eq $value &#40;not finished in &#39; .
+      $expires_in . &#39; s&#41;&#39; &#41;;
+  }
 
   sleep&#40; $EXPIRES_DELAY + 1 &#41;;
 
@@ -525,12 +537,18 @@ sub _test_fifteen
 
   my $value = &#39;Test Value&#39;;
 
+  my $start = time;
   $cache-&gt;set&#40; $key, $value, $expires_in &#41;;
 
   my $fetched_value = $cache-&gt;get&#40; $key &#41;;
 
-  &#40; $fetched_value eq $value &#41; ?
-    $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$fetched_value eq $value&#39; &#41;;
+  if &#40;time - $start &lt; $expires_in&#41; {
+    &#40; $fetched_value eq $value &#41; ?
+      $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$fetched_value eq $value&#39; &#41;;
+  } else {
+      $self-&gt;skip&#40; &#39;$fetched_value eq $value &#40;not finished in &#39; .
+        $expires_in . &#39; s&#41;&#39; &#41;;
+  }
 
   sleep&#40; $EXPIRES_DELAY + 1 &#41;;
 
diff --git a/lib/Cache/SizeAwareCacheTester.pm b/lib/Cache/SizeAwareCacheTester.pm
index 1a660f7..1cf744f 100644
--- a/lib/Cache/SizeAwareCacheTester.pm
+++ b/lib/Cache/SizeAwareCacheTester.pm
@@ -110,6 +110,7 @@ sub _test_two
 
   my $first_expires_in = 20;
 
+  my $start = time;
   $cache-&gt;set&#40; $first_key, $value, $first_expires_in &#41;;
 
   my $first_size = $cache-&gt;size&#40; &#41;;
@@ -132,8 +133,13 @@ sub _test_two
 
   my $second_size = $cache-&gt;size&#40; &#41;;
 
-  &#40; $second_size &gt; $first_size &#41; ?
-    $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$second_size &gt; $first_size&#39; &#41;;
+  if &#40;time - $start &lt; $first_expires_in &#41; {
+    &#40; $second_size &gt; $first_size &#41; ?
+      $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$second_size &gt; $first_size&#39; &#41;;
+  } else {
+      $self-&gt;skip&#40; &#39;$second_size &gt; $first_size &#40;not finished in &#39; .
+      $first_expires_in . &#39; s&#41;&#39;&#41;;
+  }
 
   my $size_limit = $first_size;
 
@@ -146,8 +152,13 @@ sub _test_two
 
   my $first_value = $cache-&gt;get&#40; $first_key &#41;;
 
-  &#40; $first_value eq $value &#41; ?
-    $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$first_value eq $value&#39; &#41;;
+  if &#40;time - $start &lt; $first_expires_in &#41; {
+    &#40; $first_value eq $value &#41; ?
+      $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$first_value eq $value&#39; &#41;;
+  } else {
+    $self-&gt;skip&#40; &#39;$first_value eq $value &#40;not finished in &#39; .
+      $first_expires_in . &#39; s&#41;&#39;&#41;;
+  }
 
 }
 
-- 
1.9.3

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1398020" href="/Public/Bug/Display.html?id=88418#txn-1398020">#</a>      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;13&nbsp;06:09:17&nbsp;2014</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1398020/742222/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/742222">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne St 13.srp.2014 03:45:36, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne Čt 26.čen.2014 08:48:21, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; Dne St 04.zář.2013 11:40:19, zefram@fysh.org napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; &gt; I&#39;m intermittently seeing Cache-Cache fail its tests thus:
&gt; &gt; &gt;
&gt; &gt; &gt; t/5_test_size_aware_file_cache.t .... ok
&gt; &gt; &gt; Couldn&#39;t limit size to 28 at /opt/perl-5.18.1/cpan/build/Cache-
&gt; &gt; &gt; Cache-
&gt; &gt; &gt; 1.06-CTXYVU
&gt; &gt; &gt; /blib/lib/Cache/CacheSizer.pm line 92.
&gt; &gt; &gt; Couldn&#39;t limit size to 28 at /opt/perl-5.18.1/cpan/build/Cache-
&gt; &gt; &gt; Cache-
&gt; &gt; &gt; 1.06-CTXYVU
&gt; &gt; &gt; /blib/lib/Cache/CacheSizer.pm line 92.
&gt; &gt; &gt; Use of uninitialized value $first_value in string eq at /opt/perl-
&gt; &gt; &gt; 5.18.1/cpan/bu
&gt; &gt; &gt; ild/Cache-Cache-1.06-CTXYVU/blib/lib/Cache/SizeAwareCacheTester.pm
&gt; &gt; &gt; line 149.
&gt; &gt; &gt;  t/6_test_size_aware_memory_cache.t ..
&gt; &gt; &gt;  Failed 1/48 subtests
&gt; &gt; &gt;
</div>&gt; &gt; [...]
<div class="message-stanza open">&gt; &gt; &gt;
&gt; &gt; &gt; The test failure could be accounted for by a race condition in
&gt; &gt; &gt; Cache::SizeAwareCacheTester::_test_two&#40;&#41;.  After setting a value
&gt; &gt; &gt; for
&gt; &gt; &gt; $first_key with expiry in 20 s, it sets values for five more keys,
&gt; &gt; &gt; separated by sleep&#40;1&#41; calls, with expiry in 10 s.  The test relies
&gt; &gt; &gt; on $first_key having a later expiry time than any of the other
&gt; &gt; &gt; five,
&gt; &gt; &gt; so that the $cache-&gt;limit_size&#40;$size_limit&#41; call evicts all keys
&gt; &gt; &gt; other
&gt; &gt; &gt; than $first_key.  If there is an uncommanded pause amounting to 5 s
&gt; &gt; &gt; during the process of setting the five keys, the last of them could
&gt; &gt; &gt; have
&gt; &gt; &gt; expiry time equal to or later than that of $first_key.  If it&#39;s
&gt; &gt; &gt; later
&gt; &gt; &gt; then the test definitely fails; if it&#39;s tied then the result
&gt; &gt; &gt; depends
&gt; &gt; &gt; on
&gt; &gt; &gt; hash order and relative perceived size of the cache entries.
&gt; &gt; &gt; Adding a
&gt; &gt; &gt; sleep&#40;5&#41; before the cache setting loop is enough to induce these
&gt; &gt; &gt; failures.
</div>&gt; &gt;
&gt; &gt; Attached patch should fix the time races in the tests.
&gt; &gt;
</div>&gt; There was another race. Attached patch fixes it and replaces the
&gt; previous patch.
&gt; 
</div>And this patch replacing the previous one fixes hopefully the last race betweem adding two key sets.

Although there remains a small unexplained issue with limiting cache size warning described in &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://bugzilla.redhat.com/show_bug.cgi?id=1128792#c1&gt;">https://bugzilla.redhat.com/show_bug.cgi?id=1128792#c1&gt;</a></span>.

-- Petr
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Make-tests-aware-of-running-time.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1398020/742223/0001-Make-tests-aware-of-running-time.patch">Download 0001-Make-tests-aware-of-running-time.patch</a><br />
<span class="downloadcontenttype">text/x-diff 4.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 847184c72a9e76612cd76e97b676af85202be27c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Thu, 26 Jun 2014 13:43:09 +0200
Subject: [PATCH] Make tests aware of running time
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Some tests could fail if they run slower then the tested time limits
because then caches entries expired on different place than expected. This
patch skips such tests if the running time is not shorter than
expected.

CPAN RT#88418

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 lib/Cache/CacheTester.pm          | 30 ++++++++++++++++++++++++------
 lib/Cache/SizeAwareCacheTester.pm | 25 +++++++++++++++++++++----
 2 files changed, 45 insertions&#40;+&#41;, 10 deletions&#40;-&#41;

diff --git a/lib/Cache/CacheTester.pm b/lib/Cache/CacheTester.pm
index 8f64577..1cd6f82 100644
--- a/lib/Cache/CacheTester.pm
+++ b/lib/Cache/CacheTester.pm
@@ -168,12 +168,18 @@ sub _test_four
 
   my $value = &#39;Test Value&#39;;
 
+  my $start = time;
   $cache-&gt;set&#40; $key, $value, $expires_in &#41;;
 
   my $fetched_value = $cache-&gt;get&#40; $key &#41;;
 
-  &#40; $fetched_value eq $value &#41; ?
-    $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$fetched_value eq $value&#39; &#41;;
+  if &#40;time - $start &lt; $expires_in&#41; {
+    &#40; $fetched_value eq $value &#41; ?
+      $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$fetched_value eq $value&#39; &#41;;
+  } else {
+      $self-&gt;skip&#40; &#39;$fetched_value eq $value &#40;not finished in &#39; .
+        $expires_in . &#39; s&#41;&#39; &#41;;
+  }
 
   sleep&#40; $EXPIRES_DELAY + 1 &#41;;
 
@@ -460,12 +466,18 @@ sub _test_thirteen
 
   my $value = &#39;Test Value&#39;;
 
+  my $start = time;
   $cache-&gt;set&#40; $key, $value, $expires_in &#41;;
 
   my $fetched_value = $cache-&gt;get&#40; $key &#41;;
 
-  &#40; $fetched_value eq $value &#41; ?
-    $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$fetched_value eq $value&#39; &#41;;
+  if &#40;time - $start &lt; $expires_in&#41; {
+    &#40; $fetched_value eq $value &#41; ?
+      $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$fetched_value eq $value&#39; &#41;;
+  } else {
+    $self-&gt;skip&#40; &#39;$fetched_value eq $value &#40;not finished in &#39; .
+      $expires_in . &#39; s&#41;&#39; &#41;;
+  }
 
   sleep&#40; $EXPIRES_DELAY + 1 &#41;;
 
@@ -525,12 +537,18 @@ sub _test_fifteen
 
   my $value = &#39;Test Value&#39;;
 
+  my $start = time;
   $cache-&gt;set&#40; $key, $value, $expires_in &#41;;
 
   my $fetched_value = $cache-&gt;get&#40; $key &#41;;
 
-  &#40; $fetched_value eq $value &#41; ?
-    $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$fetched_value eq $value&#39; &#41;;
+  if &#40;time - $start &lt; $expires_in&#41; {
+    &#40; $fetched_value eq $value &#41; ?
+      $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$fetched_value eq $value&#39; &#41;;
+  } else {
+      $self-&gt;skip&#40; &#39;$fetched_value eq $value &#40;not finished in &#39; .
+        $expires_in . &#39; s&#41;&#39; &#41;;
+  }
 
   sleep&#40; $EXPIRES_DELAY + 1 &#41;;
 
diff --git a/lib/Cache/SizeAwareCacheTester.pm b/lib/Cache/SizeAwareCacheTester.pm
index 1a660f7..b2bcb79 100644
--- a/lib/Cache/SizeAwareCacheTester.pm
+++ b/lib/Cache/SizeAwareCacheTester.pm
@@ -110,6 +110,7 @@ sub _test_two
 
   my $first_expires_in = 20;
 
+  my $start = time;
   $cache-&gt;set&#40; $first_key, $value, $first_expires_in &#41;;
 
   my $first_size = $cache-&gt;size&#40; &#41;;
@@ -129,11 +130,17 @@ sub _test_two
 
     $cache-&gt;set&#40; $key, $value, $second_expires_in &#41;;
   }
+  my $second_inserted = time;
 
   my $second_size = $cache-&gt;size&#40; &#41;;
 
-  &#40; $second_size &gt; $first_size &#41; ?
-    $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$second_size &gt; $first_size&#39; &#41;;
+  if &#40;time - $start &lt; $first_expires_in &#41; {
+    &#40; $second_size &gt; $first_size &#41; ?
+      $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$second_size &gt; $first_size&#39; &#41;;
+  } else {
+      $self-&gt;skip&#40; &#39;$second_size &gt; $first_size &#40;not finished in &#39; .
+      $first_expires_in . &#39; s&#41;&#39;&#41;;
+  }
 
   my $size_limit = $first_size;
 
@@ -146,8 +153,18 @@ sub _test_two
 
   my $first_value = $cache-&gt;get&#40; $first_key &#41;;
 
-  &#40; $first_value eq $value &#41; ?
-    $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$first_value eq $value&#39; &#41;;
+  if &#40;time - $start &gt;= $first_expires_in&#41; {
+    $self-&gt;skip&#40; &#39;$first_value eq $value &#40;not finished in &#39; .
+      $first_expires_in . &#39; s&#41;&#39;&#41;;
+  } elsif &#40;$second_inserted + $second_expires_in &gt;=
+      $start + $first_expires_in&#41; {
+    $self-&gt;skip&#40; &#39;$first_value eq $value &#40;second key insterted to late, &#39; .
+     &#39;so first key had expiration time before the second one, &#39; .
+     &#39;thus the first key was removed when limit cache size&#39;&#41;;
+  } else {
+    &#40; $first_value eq $value &#41; ?
+      $self-&gt;ok&#40; &#41; : $self-&gt;not_ok&#40; &#39;$first_value eq $value&#39; &#41;;
+  }
 
 }
 
-- 
1.9.3

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1430146" href="/Public/Bug/Display.html?id=88418#txn-1430146">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;06&nbsp;10:36:21&nbsp;2014</span>
    <span class="description">gregoa [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1430146/760076/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/760076">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 236b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Looks like Petr&#39;s patch is not enough, unfortunately.
Cf. <span class="clickylink"><a target="new" rel="nofollow" href="https://bugs.debian.org/766102">https://bugs.debian.org/766102</a></span> and &#40;linked from there&#41; <span class="clickylink"><a target="new" rel="nofollow" href="http://ci.debian.net/data/packages/unstable/amd64/libc/libcache-cache-perl/20141101_214223.autopkgtest.log">http://ci.debian.net/data/packages/unstable/amd64/libc/libcache-cache-perl/20141101_214223.autopkgtest.log</a></span>

Cheers,
gregor
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1430150" href="/Public/Bug/Display.html?id=88418#txn-1430150">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;06&nbsp;10:37:53&nbsp;2014</span>
    <span class="description">gregoa [...] cpan.org -  Cc GREGOA added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1455822" href="/Public/Bug/Display.html?id=88418#txn-1455822">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;22&nbsp;10:57:03&nbsp;2015</span>
    <span class="description">rjbs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1455822/774487/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/774487">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 73b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have applied this patches, though they may not be sufficient.

-- 
rjbs
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.583198</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
