<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #59594 for Cache-Memcached: Useless error message if you use a bad hostname in server list.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #59594 for Cache-Memcached: Useless error message if you use a bad hostname in server list.</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Cache-Memcached">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Cache-Memcached">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Cache-Memcached">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Cache-Memcached">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Cache-Memcached">Cache-Memcached CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">59594</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Cache-Memcached">Cache-Memcached</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bobtfish [...] bobtfish.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-4860-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-4861-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




Cache-Memcached-badhostname-nodie.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/807165/418501/Cache-Memcached-badhostname-nodie.patch">
Wed Jul 21 05:43:07 2010 (1.7k) by bobtfish [...] bobtfish.net
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=59594">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-807165" href="/Public/Bug/Display.html?id=59594#txn-807165">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;21&nbsp;05:43:07&nbsp;2010</span>
    <span class="description">bobtfish [...] bobtfish.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Useless error message if you use a bad hostname in server list.</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/807165/418500/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/418500">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 471b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">omni ~ $ perl -MCache::Memcached -e&#39;Cache::Memcached-&gt;new&#40;{servers =&gt;
[&#34;does.not.exist:11211&#34;]}&#41;-&gt;set&#40;&#34;foo&#34;, &#34;bar&#34;&#41;&#39;
Bad arg length for Socket::pack_sockaddr_in, length is 0, should be 4 at
/usr/lib/perl/5.10/Socket.pm line 214.

This is pretty spectacularly unhelpful.

As per the rest of the memcache client, it would be better if the bad
server was just ignored / not connected to &#40;and the connect fail
callback if defined was called&#41;.

Patch attached which does this.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Cache-Memcached-badhostname-nodie.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/807165/418501/Cache-Memcached-badhostname-nodie.patch">Download Cache-Memcached-badhostname-nodie.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/lib/Cache/Memcached.pm b/lib/Cache/Memcached.pm
index c1bf67b..fbb462c 100644
--- a/lib/Cache/Memcached.pm
+++ b/lib/Cache/Memcached.pm
@@ -261,10 +261,12 @@ sub sock_to_host { # &#40;host&#41;  #why is this public? I wouldn&#39;t have to worry about
             } else {
                 socket&#40;$sock, PF_INET, SOCK_STREAM, $proto&#41;;
                 $sock_map{$sock} = $host;
-                $sin = Socket::sockaddr_in&#40;$port, Socket::inet_aton&#40;$prefip&#41;&#41;;
+                my $aton_ip = Socket::inet_aton&#40;$prefip&#41;;
+                $sin = Socket::sockaddr_in&#40;$port, $aton_ip&#41;
+                    if $aton_ip;
             }
 
-            if &#40;_connect_sock&#40;$sock,$sin,$self-&gt;{connect_timeout}&#41;&#41; {
+            if &#40;$sin &#38;&#38; _connect_sock&#40;$sock,$sin,$self-&gt;{connect_timeout}&#41;&#41; {
                 $connected = 1;
             } else {
                 if &#40;my $cb = $self-&gt;{cb_connect_fail}&#41; {
@@ -285,11 +287,13 @@ sub sock_to_host { # &#40;host&#41;  #why is this public? I wouldn&#39;t have to worry about
             } else {
                 socket&#40;$sock, PF_INET, SOCK_STREAM, $proto&#41;;
                 $sock_map{$sock} = $host;
-                $sin = Socket::sockaddr_in&#40;$port, Socket::inet_aton&#40;$ip&#41;&#41;;
+                my $aton_ip = Socket::inet_aton&#40;$ip&#41;;
+                $sin = Socket::sockaddr_in&#40;$port, $aton_ip&#41;
+                    if $aton_ip;
             }
 
             my $timeout = $self ? $self-&gt;{connect_timeout} : 0.25;
-            unless &#40;_connect_sock&#40;$sock, $sin, $timeout&#41;&#41; {
+            unless &#40;$sin &#38;&#38; _connect_sock&#40;$sock, $sin, $timeout&#41;&#41; {
                 my $cb = $self ? $self-&gt;{cb_connect_fail} : undef;
                 $cb-&gt;&#40;$ip&#41; if $cb;
                 return _dead_sock&#40;$self, $sock, undef, 20 + int&#40;rand&#40;10&#41;&#41;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-982336" href="/Public/Bug/Display.html?id=59594#txn-982336">#</a>      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;27&nbsp;21:49:01&nbsp;2011</span>
    <span class="description">JEB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/982336/511491/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/511491">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 553b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I was about to report the same error, so +1 on this.

The error message is very obscure as it stands: &#34;Bad arg length for
Socket::pack_sockaddr_in, length is 0, should be 4 at
/usr/lib64/perl5/Socket.pm line 386.&#34; &#40;version 1.28&#41;. If this patch is
not accepted &#40;along with soem doco to indicate how one could craft a
callback to give more useful information&#41;, then perhaps catch this error
and report to STDERR as &#34;Invalid memcache host name %s&#34;? At least it
gives users a chance to spot which socket connection could be the
suspect one causing an issue.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-982339" href="/Public/Bug/Display.html?id=59594#txn-982339">#</a>      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;27&nbsp;21:49:02&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1835868" href="/Public/Bug/Display.html?id=59594#txn-1835868">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;01&nbsp;18:01:50&nbsp;2019</span>
    <span class="description">matthias.nott [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> matthias.nott [...] gmail.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1835868/987039/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/987039">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hmm. 8.5 Years and this is still open.

At least the patch also still works.

This became relevant over here when I needed to have an option to run memcached in either a virtual machine, together with its client, or within a separate Docker image. Hence the connection would work like this:

    my $memd = new Cache::Memcached {
        &#39;servers&#39;            =&gt; [&#39;127.0.0.1:11211&#39;, &#39;memcached:11211&#39;],
        &#39;compress_threshold&#39; =&gt; 10_000,
    };

The second part, &#39;memcached:11211&#39;, was attached and resolves if, and only if, the image is run as a Docker image. If running as a VM, the address will not resolve.

When running as a docker image, the connection to localhost will just fail, as there is no memcached running on the local port. It will then gracefully take the oter option, memcached:11211.

When running within a VM, where memcached is deployed alongside the application doing the code above, it should contend with the local memcached, but as it sees the other entry, it will fail with the error reported within this bug.

As we optionally provide our application as a virtual machine &#40;through Vagrant&#41; and as a docker image, this is annoying, and hence thanks for having worked out that patch.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.278062</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
