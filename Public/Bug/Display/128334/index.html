<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #128334 for File-BOM: t/01..bom.t test fails with Encode 2.99</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #128334 for File-BOM: t/01..bom.t test fails with Encode 2.99</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/File-BOM/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/File-BOM/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/File-BOM/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/File-BOM/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/File-BOM">File-BOM CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">128334</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/File-BOM/Active/">File-BOM</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">matt.lawrence [...] virgin.net
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ppisar [...] redhat.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-12678-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.15    </td>
  </tr>
  <tr id="CF-12679-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.16    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;23&nbsp;11:03:10&nbsp;2019</span>
    <span class="description">ppisar [...] redhat.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> t/01..bom.t test fails with Encode 2.99</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Encode-2.99 is better at recognizing invalid characters and t/01..bom.t test fails like this:

$ perl -Ilib t/01..bom.t
1..115
ok 1 - use File::BOM;
ok 2 - utf-16be.txt: open_bom returned encoding
ok 3 - utf-16be.txt: test content returned OK
ok 4 - utf-16be.txt: defuse returns correct encoding &#40;UTF-16BE&#41;
ok 5 - utf-16be.txt: defused version content OK
ok 6 - utf-16be.txt: get_encoding_from_filehandle returned correct encoding
ok 7 - utf-16be.txt: get_encoding_from_bom also worked
ok 8 - utf-16be.txt: .. and offset worked with substr&#40;&#41;
UTF-16BE:Partial character at lib/File/BOM.pm line 364, &lt;FH&gt; line 1.
# Looks like your test exited with 25 just after 8.

It dies in decode_from_bom&#40;&#41; because FB_CROAK is requested and the to-be-decoded byte-string indeed ends with a partial character. The partial character is result of chomp&#40;&#41; on encoded new-line:

$ hexdump -C t/data/utf-16be.txt 
00000000  fe ff 00 db 00 f1 00 ed  00 e7 00 f4 01 11 00 e8  |................|
00000010  00 0a                                             |..|
00000012

The test reads content of the above quoted file, performs chomp&#40;&#41; so that last byte is removed and the string is left with a dangling \x00 byte. This malformed string stored in $first_line variable is then passes to decode_from_bom&#40;&#41; using:

    my $result = decode_from_bom&#40;$first_line, &#39;UTF-8&#39;, FB_CROAK&#41;;
    is&#40;$result, $expect, &#34;$file: decode_from_bom&#40;&#41; scalar context&#34;&#41;;

As a result the test script dies.

I can see the test script already installs __WARN__ handler to filter similar warnings. I believe a proper fix is to remove the whole &#34;\n&#34; representation in a given encoding.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;25&nbsp;09:19:02&nbsp;2019</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne St 23.led.2019 11:03:10, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Encode-2.99 is better at recognizing invalid characters and
&gt; t/01..bom.t test fails like this:
&gt; 
</div>Attached patch fixes it.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> File-BOM-0.15-Adapt-to-stricter-Encode-2.99.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From ee024445df54df26d1aff18f65a54df725ba452a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Fri, 25 Jan 2019 15:08:36 +0100
Subject: [PATCH] Adapt to stricter Encode-2.99
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Encode-2.99 is better at recognizing invalid characters and
t/01..bom.t test fails like this:

    ok 8 - utf-32be.txt: .. and offset worked with substr&#40;&#41;
    UTF-32BE:Partial character at lib/File/BOM.pm line 364, &lt;FH&gt; line 1.
    # Looks like your test exited with 25 just after 8.

There problem is how the test handles end-of-line separator. It reads
the utf-32be.txt as a byte-strin up to first &#34;\n&#34; byte &#40;not
a UTF-32BE-encoded &#34;\n&#34;&#41;. Then it performs a chomp&#40;&#41; on the first line
and again it removes &#34;\n&#34; byte instead of encoded representation.

As a result the first line is left with a garbage at the end a Encode
die when it encounter it.

This patch fixes both issues by setting $/ to the expected &#34;\n&#34;
representation.

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 t/01..bom.t             |  8 ++++++--
 t/lib/Test/Framework.pm | 12 +++++++++++-
 2 files changed, 17 insertions&#40;+&#41;, 3 deletions&#40;-&#41;

diff --git a/t/01..bom.t b/t/01..bom.t
index c41b060..6ecf221 100644
--- a/t/01..bom.t
+++ b/t/01..bom.t
@@ -56,8 +56,12 @@ for my $file &#40;@test_files&#41; {
     }
 
     open FH, &#39;&lt;&#39;, $file2path{$file};
-    my $first_line = &lt;FH&gt;;
-    chomp $first_line;
+    my $first_line;
+    {
+	local $/ = $fileeol{$file};
+	$first_line = &lt;FH&gt;;
+	chomp $first_line;
+    }
 
     seek&#40;FH, 0, SEEK_SET&#41;;
 
diff --git a/t/lib/Test/Framework.pm b/t/lib/Test/Framework.pm
index b4b9f6b..800f9dd 100644
--- a/t/lib/Test/Framework.pm
+++ b/t/lib/Test/Framework.pm
@@ -4,6 +4,7 @@ package Test::Framework;
 # Common resources for tests
 #
 
+use Encode qw&#40; encode :fallback_all &#41;;
 use File::Spec::Functions qw&#40; catfile &#41;;
 use File::Temp qw&#40; tmpnam &#41;;
 use POSIX qw&#40; mkfifo &#41;;
@@ -13,7 +14,7 @@ use utf8;
 
 use base qw&#40; Exporter &#41;;
 
-our&#40;%file2path, %file2enc, %filecontent, @test_files, $fifo_supported&#41;;
+our&#40;%file2path, %file2enc, %filecontent, %fileeol, @test_files, $fifo_supported&#41;;
 
 @EXPORT = qw&#40;
 	make_test_data
@@ -21,6 +22,7 @@ our&#40;%file2path, %file2enc, %filecontent, @test_files, $fifo_supported&#41;;
 	%file2path
 	%file2enc
 	%filecontent
+	%fileeol
 	@test_files
 	write_fifo
 	$fifo_supported
@@ -45,6 +47,14 @@ our&#40;%file2path, %file2enc, %filecontent, @test_files, $fifo_supported&#41;;
     &#41;;
 @test_files = keys %file2enc;
 
+for &#40;@test_files&#41; {
+    my $enc = $file2enc{$_};
+    $enc = &#39;ASCII&#39; if $enc eq &#39;&#39;;
+    my $eol = &#34;\n&#34;;
+    $eol = encode&#40;$enc, $eol, FB_CROAK&#41;;
+    $fileeol{$_} = $eol;
+}
+
 $file2path{$_} = catfile&#40;qw&#40;t data&#41;, $_&#41; for @test_files;
 
 # write data into files
-- 
2.17.2

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;06&nbsp;05:02:17&nbsp;2019</span>
    <span class="description">matt.lawrence [...] virgin.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #128334] t/01..bom.t test fails with Encode 2.99</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 6 Feb 2019 10:00:47 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-File-BOM [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Matt Lawrence &lt;matt.lawrence [...] virgin.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 25/01/2019 14:19, Petr Pisar via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         Queue: File-BOM
&gt;   Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=128334">https://rt.cpan.org/Ticket/Display.html?id=128334</a></span> &gt;
&gt;
&gt; Dne St 23.led.2019 11:03:10, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt;&gt; Encode-2.99 is better at recognizing invalid characters and
&gt;&gt; t/01..bom.t test fails like this:
&gt;&gt;
</div>&gt; Attached patch fixes it.
&gt;
</div>Thanks!

I&#39;ll try to get that rolled out today.

Matt


---
This email has been checked for viruses by Avast antivirus software.
<span class="clickylink"><a target="new" rel="nofollow" href="https://www.avast.com/antivirus">https://www.avast.com/antivirus</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;06&nbsp;05:02:17&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;09&nbsp;03:46:25&nbsp;2019</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2019-02-06 05:02:17, MATTLAW wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 25/01/2019 14:19, Petr Pisar via RT wrote:
<div class="message-stanza open">&gt; &gt;         Queue: File-BOM
&gt; &gt;   Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=128334">https://rt.cpan.org/Ticket/Display.html?id=128334</a></span> &gt;
&gt; &gt;
&gt; &gt; Dne St 23.led.2019 11:03:10, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt;&gt; Encode-2.99 is better at recognizing invalid characters and
&gt; &gt;&gt; t/01..bom.t test fails like this:
&gt; &gt;&gt;
</div>&gt; &gt; Attached patch fixes it.
&gt; &gt;
</div>&gt; Thanks!
&gt; 
&gt; I&#39;ll try to get that rolled out today.
&gt; 
</div>
0.16 looks better --- probably this issue may be resolved?

Regards,
    Slaven
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;09&nbsp;14:41:57&nbsp;2019</span>
    <span class="description">matt.lawrence [...] virgin.net -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;09&nbsp;14:41:58&nbsp;2019</span>
    <span class="description">matt.lawrence [...] virgin.net -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;09&nbsp;14:41:58&nbsp;2019</span>
    <span class="description">matt.lawrence [...] virgin.net -  Fixed in 0.16 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
