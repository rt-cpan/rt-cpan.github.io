<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #123568 for Net-IMAP-Simple: SSL connections hang forever</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #123568 for Net-IMAP-Simple: SSL connections hang forever</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-IMAP-Simple/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-IMAP-Simple/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-IMAP-Simple/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-IMAP-Simple/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-IMAP-Simple">Net-IMAP-Simple CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">123568</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-IMAP-Simple/Active/">Net-IMAP-Simple</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cpanbugs2017 [...] wulf.eu.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22730-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22731-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;08&nbsp;12:43:38&nbsp;2017</span>
    <span class="description">cpanbugs2017 [...] wulf.eu.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SSL connections hang forever</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 8 Nov 2017 18:39:37 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-IMAP-Simple [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> JÃ¶rn Heissler &lt;cpanbugs2017 [...] wulf.eu.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

I&#39;m using OTRS and it tries to fetch mails from an IMAPS &#40;port 993&#41;
account. It uses Net:IMAP:Simple for this task.

Sometimes the process hangs forever. From what I can see, the TLS socket
is running in blocking mode and a read&#40;&#41; system call hangs, while imap
protocol messages are sent and received, i.e. the TLS connection itself
was established already.

I&#39;m not entirely sure which module is at fault here, Net:IMAP:Simple or
IO::Socket::SSL.

My assumption is that Net:IMAP:Simple should use non-blocking sockets
and handle timeouts itself.

I don&#39;t have a full test case, but I found I can reproduce this by
abusing iptables:

iptables -A INPUT -s &lt;imapserveraddress&gt; -p tcp --sport 993 -m length 100:200 -j DROP

Stack trace:
/opt/otrs/bin/otrs.Daemon.pl:138
/opt/otrs/bin/otrs.Daemon.pl:316
/opt/otrs/bin/otrs.Daemon.pl:316
/opt/otrs/Kernel/System/Daemon/DaemonModules/SchedulerTaskWorker.pm:253
/opt/otrs/Kernel/System/Daemon/DaemonModules/SchedulerTaskWorker/Cron.pm:129
/opt/otrs/Kernel/System/Daemon/DaemonModules/SchedulerTaskWorker/Cron.pm:150
/opt/otrs/Kernel/System/Console/BaseCommand.pm:454
/opt/otrs/Kernel/System/Console/BaseCommand.pm:460
/opt/otrs/Kernel/System/Console/Command/Maint/PostMaster/MailAccountFetch.pm:94
/opt/otrs/Kernel/System/MailAccount.pm:440
/opt/otrs/Kernel/System/MailAccount/IMAP.pm:86
/opt/otrs/Kernel/System/MailAccount/IMAP.pm:257
/opt/otrs/Kernel/cpan-lib/Net/IMAP/Simple.pm:1021   
/opt/otrs/Kernel/cpan-lib/Net/IMAP/Simple.pm:1210   while &#40; $res = $sock-&gt;getline &#41; {
/usr/share/perl5/IO/Socket/SSL.pm:2043              sub getline


OS: Ubuntu 16.04
Perl: 5.22.1
IO::Socket::SSL: 2.024
Net::IMAP::Simple: 1.2206


Best regards
Joern Heissler
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;16&nbsp;07:55:39&nbsp;2017</span>
    <span class="description">jettero [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">If you DROP packets, the expected behavior is a hang. Try this with almost any network program and you&#39;ll see the exact same thing. Try it with netcat, openssh, mutt, socat, openssl, wget, curl... you name it.

The alternative for the DROP case is a timeout where you set some arbitrary number &#40;eg a minute, or 20 seconds or something&#41; after which you _guess_ the connection is broken or something. Net::IMAP::SSL has such a timeout set, but IIRC it doesn&#39;t work somewhere in IO::Socket::SSL.

In the not-DROP case, where something goes wrong, but the application doesn&#39;t receive RST, FIN, ACK &#40;or whatever else&#41;; then the expected behavior is probably for the kernel itself to put the process in ready-wait &#40;see loadavg&#41; until something happens with the socket. TCP stacks can&#39;t just quit in the middle of a session, they have to do the RST or FIN thing. If they don&#39;t you end up with billions of TIME_WAIT sockets in netstat output.  TIME_WAIT sockets should stay open literally forever or until they receive their FIN, but modern kernels usually time them out around a few hours &#40;or some other arbitrary number&#41;.

My point is, settings this to non-blocking and polling the connection probably won&#39;t fix a bug. It feels like a layer 2 or layer 3 problem to me. Fix the bugs on the network and this won&#39;t be an issue.

You might be able to _work around_ the network bugs by making a non-blocking polling loop, but such a need is a matter of opinion. I say make a proxy for Net::IMAP::Simple or IO::Socket::SSL or whatever --- like you&#39;d have to do with curl or ssh.

-- 
If riding in an airplane is flying, then riding in a boat is swimming.
116 jumps, 48.6 minutes of freefall, 92.9 freefall miles.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;16&nbsp;07:55:40&nbsp;2017</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;16&nbsp;07:55:40&nbsp;2017</span>
    <span class="description">jettero [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;16&nbsp;09:22:54&nbsp;2017</span>
    <span class="description">cpanbugs2017 [...] wulf.eu.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #123568] SSL connections hang forever</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 16 Nov 2017 15:22:38 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Paul Miller via RT &lt;bug-Net-IMAP-Simple [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> JÃ¶rn Heissler &lt;cpanbugs2017 [...] wulf.eu.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Most software implements timeouts, for good reason. Some send
keepalive mesages and abort if no response is received in a while. Some
set the SO_KEEPALIVE socket option and the kernel will abort the
connection. Others have an event loop with a timer and close the
connection. Some arm an alarm&#40;&#41; or start a timeout thread or whatever.
And some software doesn&#39;t implement any timeout at all, and then the
program will hang forever.

* Netcat has -w.
* Openssh sends keepalive messages on application level and uses SO_KEEPALIVE.
* Mutt is lacking a timeout which can be annoying, but reacts to ctrl-c too.
* socat has &#34;keepalive&#34; to enable SO_KEEPALIVE.
* wget has --timeout.
* curl has --max-time and at least in the lib some more sophisticated options.

So 1 out of your 6 doesn&#39;t implement timeouts.

It&#39;s normal behaviour of networks and the internet to occasionally drop
packets. Usually it doesn&#39;t matter, but sometimes one end closes the
connection and the other end considers the connection to be still open.
This CANNOT be fixed on the network, software has to cope with this and
implement some sort of timeout.
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;16&nbsp;10:45:53&nbsp;2017</span>
    <span class="description">jettero [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yes, I agree. I said that. There&#39;s a 90 second timeout in the package. You can tune it to your liking. I was just trying to cover a lot of bases in case I misunderstood the problem.

Non-blocking mode is not the answer either way though. That&#39;s for cases where you expect no answer, rather than cases where you might not get one if something goes wrong.

Also, if the timeout&#39;s not working, it&#39;s probably the layer above.

-- 
If riding in an airplane is flying, then riding in a boat is swimming.
116 jumps, 48.6 minutes of freefall, 92.9 freefall miles.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
