<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #64827 for Catalyst-Authentication-Credential-Twitter: Break the authentication process into two</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #64827 for Catalyst-Authentication-Credential-Twitter: Break the authentication process into two</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Catalyst-Authentication-Credential-Twitter">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Catalyst-Authentication-Credential-Twitter">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Catalyst-Authentication-Credential-Twitter">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Catalyst-Authentication-Credential-Twitter">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/yanick/Catalyst-Authentication-Credential-Twitter/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Catalyst-Authentication-Credential-Twitter">Catalyst-Authentication-Credential-Twitter CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">64827</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Catalyst-Authentication-Credential-Twitter">Catalyst-Authentication-Credential-Twitter</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
yanick+cpan [...] babyl.dyndns.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-230660-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-230661-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




0001-break-the-authentication-process-into-two.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/882325/457143/0001-break-the-authentication-process-into-two.patch">
Sun Jan 16 10:57:59 2011 (4k) by yanick+cpan [...] babyl.dyndns.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=64827">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-882325" href="/Public/Bug/Display.html?id=64827#txn-882325">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;16&nbsp;10:57:59&nbsp;2011</span>
    <span class="description">yanick+cpan [...] babyl.dyndns.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Break the authentication process into two</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/882325/457142/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/457142">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 384b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m including a patch that divides the authentication process into two
steps: authenticate against twitter, and then authenticate against the
internal application store.  This is mostly to facilitate the process of
creating users on the fly as they are authenticated against twitter.

The patch is also available at
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/yanick/Catalyst-Authentication-Credential-Twitter">https://github.com/yanick/Catalyst-Authentication-Credential-Twitter</a></span>
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-break-the-authentication-process-into-two.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/882325/457143/0001-break-the-authentication-process-into-two.patch">Download 0001-break-the-authentication-process-into-two.patch</a><br />
<span class="downloadcontenttype">text/x-diff 4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 096ba093b5e81f4714f4f15a13021780023d8be4 Mon Sep 17 00:00:00 2001
From: Yanick Champoux &lt;yanick@babyl.dyndns.org&gt;
Date: Sun, 16 Jan 2011 10:47:29 -0500
Subject: [PATCH] break the authentication process into two

... so that we can authenticate against twitter, and then
do whatever we want with the result.
---
 lib/Catalyst/Authentication/Credential/Twitter.pm |   62 +++++++++++++++++----
 1 files changed, 51 insertions&#40;+&#41;, 11 deletions&#40;-&#41;

diff --git a/lib/Catalyst/Authentication/Credential/Twitter.pm b/lib/Catalyst/Authentication/Credential/Twitter.pm
index fce5b11..5bc9850 100644
--- a/lib/Catalyst/Authentication/Credential/Twitter.pm
+++ b/lib/Catalyst/Authentication/Credential/Twitter.pm
@@ -6,7 +6,9 @@ use base qw&#40; Class::Accessor::Fast &#41;;
 use Data::Dumper;
 
 BEGIN {
-    __PACKAGE__-&gt;mk_accessors&#40;qw/_twitter callback_url consumer_key consumer_secret/&#41;;
+    __PACKAGE__-&gt;mk_accessors&#40;qw/
+        _twitter twitter_user callback_url consumer_key consumer_secret
+    /&#41;;
 }
 
 our $VERSION = &#34;0.01001&#34;;
@@ -49,8 +51,8 @@ sub new {
     return $self;
 }
 
-sub authenticate {
-    my &#40; $self, $c, $realm, $authinfo &#41; = @_;
+sub authenticate_twitter {
+    my &#40; $self, $c &#41; = @_;
 
 	if &#40;!$c-&gt;user_session-&gt;{&#39;request_token&#39;} || !$c-&gt;user_session-&gt;{&#39;request_token_secret&#39;} || !$c-&gt;req-&gt;params-&gt;{&#39;oauth_verifier&#39;}&#41; {
 		die &#39;no request token present, or no verifier&#39;;
@@ -83,9 +85,8 @@ sub authenticate {
 	$self-&gt;_twitter-&gt;access_token&#40;$access_token&#41;;
     $self-&gt;_twitter-&gt;access_token_secret&#40;$access_token_secret&#41;;
 
-	my $twitter_user_hash;
-	eval {
-		$twitter_user_hash = $self-&gt;_twitter-&gt;verify_credentials&#40;&#41;;
+	my $twitter_user_hash = eval {
+		$self-&gt;_twitter-&gt;verify_credentials;
 	};
 
 	if &#40;$@ || !$twitter_user_hash&#41; {
@@ -96,9 +97,19 @@ sub authenticate {
 	$twitter_user_hash-&gt;{&#39;access_token&#39;} = $access_token;
 	$twitter_user_hash-&gt;{&#39;access_token_secret&#39;} = $access_token_secret;
 
-	if &#40;!$authinfo&#41; {
+    $self-&gt;twitter_user&#40; $twitter_user_hash &#41;;
+
+    return $twitter_user_hash;
+}
+
+sub authenticate {
+    my &#40; $self, $c, $realm, $authinfo &#41; = @_;
+
+	unless &#40;$authinfo&#41; {
+        $self-&gt;authenticate_twitter&#40; $c &#41; unless $self-&gt;twitter_user;
+
 		$authinfo = {
-			&#39;twitter_user_id&#39;	=&gt; $twitter_user_hash-&gt;{&#39;id&#39;},
+			&#39;twitter_user_id&#39;	=&gt; $self-&gt;twitter_user-&gt;{&#39;id&#39;},
 		};
 	}
 
@@ -106,10 +117,11 @@ sub authenticate {
 
 	if &#40;ref $user_obj&#41; {
 		if &#40;$user_obj-&gt;result_source-&gt;has_column&#40;&#39;twitter_user&#39;&#41; &#38;&#38; $user_obj-&gt;result_source-&gt;has_column&#40;&#39;twitter_access_token&#39;&#41; &#38;&#38; $user_obj-&gt;result_source-&gt;has_column&#40;&#39;twitter_access_token_secret&#39;&#41;&#41; {
+            my $twitter_user = $self-&gt;twitter_user;
 			$user_obj-&gt;update&#40;{
-				&#39;twitter_user&#39;					=&gt; $twitter_user_hash-&gt;{&#39;screen_name&#39;},
-				&#39;twitter_access_token&#39;			=&gt; $access_token,
-				&#39;twitter_access_token_secret&#39;	=&gt; $access_token_secret,
+				&#39;twitter_user&#39;					=&gt; $twitter_user-&gt;{&#39;screen_name&#39;},
+				&#39;twitter_access_token&#39;			=&gt; $twitter_user-&gt;{access_token},
+				&#39;twitter_access_token_secret&#39;	=&gt; $twitter_user-&gt;{access_token_secret},
 			}&#41;;
 		}
 		return $user_obj;
@@ -246,6 +258,34 @@ in your main user table. If the other keys are present they will be
 updated on login with Twitter&#39;s most up-to-date information for that
 user.
 
+=head2 authenticate_twitter&#40; &#41;
+
+Only performs the twitter authentication. Returns a hashref containing
+the user&#39;s information given by Twitter &#40;see C&lt;authenticate&#40;&#41;&gt; above for
+the lists of keys returned&#41;.
+
+=head2 twitter_user&#40;&#41;
+
+Contains the user&#39;s twitter information after a successful twitter
+authentication via C&lt;authenticate_twitter&#40;&#41;&gt; or
+C&lt;authenticate&#40;&#41;&gt;. Useful if, for example, you want to create users
+on-the-fly:
+
+    sub twitter_callback :Path&#40; &#39;twitter/callback&#39; &#41; {
+        my &#40;$self, $c&#41; = @_;
+
+        my $twitter = $c-&gt;get_auth_realm&#40;&#39;twitter&#39;&#41;-&gt;credential;
+        my $user =  $twitter-&gt;authenticate&#40; $c &#41;;
+
+        # properly authenticated against twitter,
+        # user just doesn&#39;t exist yet
+        if &#40; !$user and  $twitter-&gt;twitter_user &#41; {
+            $user = $self-&gt;model-&gt;create_user&#40; $twitter-&gt;twitter_user &#41;;
+        }
+
+        # etc
+    }
+
 =head1 AUTHOR
 
 Jesse Stay
-- 
1.7.3.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-998983" href="/Public/Bug/Display.html?id=64827#txn-998983">#</a>      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;12&nbsp;12:23:03&nbsp;2011</span>
    <span class="description">yanick+cpan [...] babyl.dyndns.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/998983/520309/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/520309">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 22b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Took care of that. :-&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-998985" href="/Public/Bug/Display.html?id=64827#txn-998985">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;12&nbsp;12:23:04&nbsp;2011</span>
    <span class="description">yanick+cpan [...] babyl.dyndns.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.285706</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
