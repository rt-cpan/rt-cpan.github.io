<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #44834 for Net-Appliance-Session: pathologic behaviour with &#34;show ip bgp&#34;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #44834 for Net-Appliance-Session: pathologic behaviour with &#34;show ip bgp&#34;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-Appliance-Session/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-Appliance-Session/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-Appliance-Session/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-Appliance-Session/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-Appliance-Session">Net-Appliance-Session CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">44834</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-Appliance-Session/Active/">Net-Appliance-Session</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">OLIVER [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
d.thomas [...] its.uq.edu.au

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-41116-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-41117-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;06&nbsp;18:32:31&nbsp;2009</span>
    <span class="description">d.thomas [...] its.uq.edu.au -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> pathologic behaviour with &#34;show ip bgp&#34;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I should have reported this a few weeks ago when I installed the current version along with 
module dependencies under perl 5.10 on FreeBSD 7.1

I wrote a script to parse the output of &#34;show ip bgp&#34; from a cisco router which produced 
sligthtly over 10K lines, but the script took 260 seconds to run at 100% CPU. By way of 
contrast, the script could also fetch the table using Net::SSH2 which took 4 seconds with 
little CPU. I reduced the runtime by limiting max_buffer_size &#40;resulting in truncated input&#41;.

# and DProf produced
# Total Elapsed Time = 4.215710 Seconds
#   User+System Time = 3.846182 Seconds
# Exclusive Times
# %Time ExclSec CumulS #Calls sec/call Csec/c  Name
#  75.7   2.912  4.055    102   0.0285 0.0398  Net::Telnet::waitfor
#  8.89   0.342  0.716     99   0.0035 0.0072  Devel::StackTrace::_record_caller_
#                                              data
#  4.47   0.172  0.172  19744   0.0000 0.0000  UNIVERSAL::isa
#  3.51   0.135  0.271     99   0.0014 0.0027  Carp::short_error_loc
#  3.04   0.117  0.157  19998   0.0000 0.0000  overload::AddrRef
#  2.47   0.095  0.136  34254   0.0000 0.0000  Carp::trusts
#  1.20   0.046  0.046  39897   0.0000 0.0000  Scalar::Util::blessed

Execution with the full table dropped to a few seconds after changing prompt to &#39;/[\/a-zA-
Z0-9._-]+#$/&#39;

I&#39;m not saying the default prompt should be changed unless that is sensible, but maybe this 
behaviour should get some mention in the docs ?

thanks
Danny
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;08&nbsp;04:07:48&nbsp;2009</span>
    <span class="description">OLIVER [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;08&nbsp;04:07:52&nbsp;2009</span>
    <span class="description">OLIVER [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;08&nbsp;04:21:35&nbsp;2009</span>
    <span class="description">OLIVER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Danny,

On Mon Apr 06 18:32:31 2009, d.thomas@its.uq.edu.au wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I should have reported this a few weeks ago when I installed the
&gt; current version
</div>
All feedback most definitely appreciated, whenever it&#39;s reported! :-&#41;

So I have some points to clarify below, hopefully quick for you to
answer, then I&#39;ll try to find the time to look at this.

We don&#39;t carry a full bgp table but I&#39;ve run other commands in the past
with large output, such as show tech-support. Either I wasn&#39;t paying
attention, or something is different about openssh on Debian, because I
don&#39;t recall such issues. However, I do remember having to increase the
output buffer in Net::Telnet to something large like a megabyte to be
able to slurp the command output in one go. Anyway...

First, can you let me know whether you were using SSH or Telnet &#40;or even
Serial&#41; to connect to the device, and which external helper app &#40;e.g.
openssh&#41;?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I wrote a script to parse the output of &#34;show ip bgp&#34; from a cisco
&gt; router which produced
&gt; sligthtly over 10K lines, but the script took 260 seconds to run at
&gt; 100% CPU.
</div>
Can you clarify which CPU was pegged, the router&#39;s or the ssh client&#39;s?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; By way of
&gt; contrast, the script could also fetch the table using Net::SSH2 which
&gt; took 4 seconds with
&gt; little CPU. I reduced the runtime by limiting max_buffer_size
&gt; &#40;resulting in truncated input&#41;.
</div>
My pea-brain is a bit confused here - in which toolkit is the
max_buffer_size option? I don&#39;t recall it as a Net::Telnet option, nor
openssh.

Also could you expand on what you mean by &#39;truncated input&#39;?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Execution with the full table dropped to a few seconds after changing
&gt; prompt to &#39;/[\/a-zA-
&gt; Z0-9._-]+#$/&#39;
</div>
Ah, very interesting - so you suspect the prompt regexp might be the
cause? You know I did have some ideas for improving the prompts - using
a bunch of more fine grained ones in each device mode rather than one
all-purpose regex. This is something I&#39;ll definitely test out now you&#39;ve
raised the issue.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; maybe this behaviour should get some mention in the docs ?
</div>
I agree performing this way sucks, and certainly unless we find a bug to
fix which causes this behaviour then it needs a mention. I&#39;ll pop it on
my TODO list.

For info, I am working on version 2.x of the module. It&#39;s more of a
refactor - adding support for plugins and so on, rather than intending
to fix such performance issues, but I&#39;ll see what else can be folded in.

regards,
oliver.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;08&nbsp;21:41:10&nbsp;2009</span>
    <span class="description">d.thomas [...] its.uq.edu.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> d.thomas [...] its.uq.edu.au</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;got truncation cause I didn&#39;t attach file&gt;
openssh
client CPU maxxed out

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; I reduced the runtime by limiting max_buffer_size
</div><div class="message-stanza open">&gt; &gt; &#40;resulting in truncated input&#41;.
</div>&gt; 
&gt; My pea-brain is a bit confused here - in which toolkit is the
&gt; max_buffer_size option? I don&#39;t recall it as a Net::Telnet option, nor
&gt; openssh.
</div>when I first ran the script it gave an error message saying
input was larger than max_buffer_size. I think it&#39;s in Net:::Telnet

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Also could you expand on what you mean by &#39;truncated input&#39;?
</div>I wanted input to only take a few seconds and be comparable
to show running config so I set max_buffer_size to 100K.
Of course I got the same error message so the part of the script
that processed the bgp table never ran. I also wanted a short run-time
profiling.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Execution with the full table dropped to a few seconds after changing
&gt; &gt; prompt to &#39;/[\/a-zA-
&gt; &gt; Z0-9._-]+#$/&#39;
</div>&gt; 
&gt; Ah, very interesting - so you suspect the prompt regexp might be the
&gt; cause? 
</div>yes, but related to the format of the bgp table.
Is it possible to bypass the prompt processing altogether.
My script is pretty strict on the bgp format, so any prompt
appearing in it would cause the script to barf.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;30&nbsp;16:15:48&nbsp;2010</span>
    <span class="description">OLIVER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello again Danny,

On Mon Apr 06 18:32:31 2009, d.thomas@its.uq.edu.au wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I wrote a script to parse the output of &#34;show ip bgp&#34; from a cisco
&gt; router which produced
&gt; sligthtly over 10K lines, but the script took 260 seconds to run at
&gt; 100% CPU. By way of
&gt; contrast, the script could also fetch the table using Net::SSH2 which
&gt; took 4 seconds with
&gt; little CPU. I reduced the runtime by limiting max_buffer_size
&gt; &#40;resulting in truncated input&#41;.
</div>
I think this is, sadly, not going to be fixable in the current design of Net::Telnet based 
Net::Appliance::Session. However I&#39;m still working on an alternative replacement and will be 
sure to test this case against a public route server.

The general cause is the way that Net::Telnet handles prompt matching, I think: it matches on 
every line received and the whole output received, so as you get more output, it gets slower 
and slower. This doesn&#39;t seem to interact well with my use of openssh, either - again, another 
thing to test.

Sorry for the lack of progress on this.

regards,
oliver.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;30&nbsp;16:15:49&nbsp;2010</span>
    <span class="description">OLIVER [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
