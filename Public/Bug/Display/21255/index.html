<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #21255 for Time-Piece: NOTDATE - DATE should stringify DATE and let Perl handle things.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #21255 for Time-Piece: NOTDATE - DATE should stringify DATE and let Perl handle things.</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Time-Piece/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Time-Piece/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Time-Piece/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Time-Piece/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Time-Piece">Time-Piece CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">21255</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Time-Piece/Active/">Time-Piece</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
derek [...] ximbiot.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-33486-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.08    </td>
  </tr>
  <tr id="CF-33487-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;31&nbsp;10:23:58&nbsp;2006</span>
    <span class="description">derek [...] ximbiot.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> NOTDATE - DATE should stringify DATE and let Perl handle things.</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is broken in 1.08, but that version is still missing from the list.

The subtract function currently dies when SWAP is set.  SWAP is set when
perl encounters an expression like NOTDATE - DATE, where Perl doesn&#39;t
have a subtraction function overloaded for NOTDATE and DATE is a
Time::Piece object.

This seems to go against the Perl philosophy.  If the `-&#39; operator had
not been overloaded in Time::Piece, Perl would have automatically
stringified the DATE, then numified that string, and then attempted to
subtract that from NOTDATE.

This is important in the context of any subclass of Time::Piece which
attempts to change the stringify function to something that makes more
sense as a number.  If Time::Piece allowed Perl to handle the
subtraction with the stringified object, then the subclass would not
need to override Time::Piece&#39;s subtraction function to enable
subtraction, assuming there were not other attributes of the subclass
that needed to be preserved across subtraction.

For an example of preserving Perl&#39;s standard stringify behavior in the
event that SWAP is set in the subtraction function, please see the
Time::Piece::Adaptive module on CPAN.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;08&nbsp;13:45:19&nbsp;2006</span>
    <span class="description">derek [...] ximbiot.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here&#39;s the patch.  It was basically a one-liner, but I included a big
comment, a line in the Changes file, and a test for t/06subclass.t.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: Changes
===================================================================
RCS file: /cvsroot/Time-Piece/Changes,v
retrieving revision 1.1.1.1
diff -u -p -r1.1.1.1 Changes
--- Changes	8 Sep 2006 17:14:13 -0000	1.1.1.1
+++ Changes	8 Sep 2006 17:42:57 -0000
@@ -1,6 +1,10 @@
 
 Time::Piece Changes
 
+1.12
+    - Subtract now stringifies times subtracted from unrecognized objects
+      &#40;bug #21255&#41;.
+
 1.11
     - Skip %V test on Win32
 
Index: Piece.pm
===================================================================
RCS file: /cvsroot/Time-Piece/Piece.pm,v
retrieving revision 1.1.1.1
diff -u -p -r1.1.1.1 Piece.pm
--- Piece.pm	8 Sep 2006 17:14:13 -0000	1.1.1.1
+++ Piece.pm	8 Sep 2006 17:42:57 -0000
@@ -540,7 +540,17 @@ sub subtract {
     if &#40;UNIVERSAL::isa&#40;$rhs, &#39;Time::Seconds&#39;&#41;&#41; {
         $rhs = $rhs-&gt;seconds;
     }
-    die &#34;Can&#39;t subtract a date from something!&#34; if shift;
+
+    if &#40;shift&#41;
+    {
+	# SWAPED is set &#40;so someone tried an expression like NOTDATE - DATE&#41;.
+	# Imitate Perl&#39;s standard behavior and return the result as if the
+	# string $time resolves to was subtracted from NOTDATE.  This way,
+	# classes which override this one and which have a stringify function
+	# that resolves to something that looks more like a number don&#39;t need
+	# to override this function.
+	return $rhs - &#34;$time&#34;;
+    }
     
     if &#40;UNIVERSAL::isa&#40;$rhs, &#39;Time::Piece&#39;&#41;&#41; {
         return Time::Seconds-&gt;new&#40;$time-&gt;epoch - $rhs-&gt;epoch&#41;;
Index: t/06subclass.t
===================================================================
RCS file: /cvsroot/Time-Piece/t/06subclass.t,v
retrieving revision 1.1.1.1
diff -u -p -r1.1.1.1 06subclass.t
--- t/06subclass.t	8 Sep 2006 17:14:13 -0000	1.1.1.1
+++ t/06subclass.t	8 Sep 2006 17:42:57 -0000
@@ -45,3 +45,22 @@ for my $method &#40;qw&#40;new localtime gmtime&#41;
   use base qw&#40;Time::Piece&#41;;
   # this package is identical, but will be -&gt;isa&#40;&#39;Time::Piece::Twin&#39;&#41;;
 }
+
+{
+  my $class = &#34;Time::Piece::NumString&#34;;
+  my $piece = $class-&gt;strptime &#40;&#34;2006&#34;, &#34;%Y&#34;&#41;;
+  is &#40;2007 - $piece, 1,
+      &#34;subtract attempts stringify for unrecognized objects.&#34;&#41;;
+}
+
+## Below is a package which only changes the stringify function.
+{
+  package Time::Piece::NumString;
+  use base qw&#40;Time::Piece&#41;;
+  use overload &#39;&#34;&#34;&#39; =&gt; \&#38;_stringify;
+  sub _stringify
+  {
+    my $self = shift;
+    return $self-&gt;strftime &#40;&#34;%Y&#34;&#41;;
+  }
+}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;08&nbsp;13:45:22&nbsp;2006</span>
    <span class="description">derek [...] ximbiot.com -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;29&nbsp;07:10:22&nbsp;2006</span>
    <span class="description">RGARCIA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> RGARCIA [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve applied this patch to the version of Time::Piece bundled with
bleadperl as change #29417.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;11&nbsp;15:48:38&nbsp;2010</span>
    <span class="description">msergeant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Marking resolved.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;11&nbsp;15:48:39&nbsp;2010</span>
    <span class="description">msergeant [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
