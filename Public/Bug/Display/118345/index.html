<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #118345 for Crypt-OpenSSL-PKCS10: Fails to build with OpenSSL 1.1.0</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #118345 for Crypt-OpenSSL-PKCS10: Fails to build with OpenSSL 1.1.0</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Crypt-OpenSSL-PKCS10/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Crypt-OpenSSL-PKCS10/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Crypt-OpenSSL-PKCS10/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Crypt-OpenSSL-PKCS10/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Crypt-OpenSSL-PKCS10">Crypt-OpenSSL-PKCS10 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">118345</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Crypt-OpenSSL-PKCS10/Active/">Crypt-OpenSSL-PKCS10</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ppisar [...] redhat.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-38154-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.15    </td>
  </tr>
  <tr id="CF-38155-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;12&nbsp;05:27:04&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Fails to build with OpenSSL 1.1.0</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">After upgrading OpenSSL to 1.1.0 build fails like this:

gcc -c   -D_REENTRANT -D_GNU_SOURCE -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m32 -march=i686 -mtune=atom -fasynchronous-unwind-tables -fwrapv -fno-strict-aliasing -I/usr/local/include -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 -g   -DVERSION=\&#34;0.15\&#34; -DXS_VERSION=\&#34;0.15\&#34; -fPIC &#34;-I/usr/lib/perl5/CORE&#34;  -DPERL5 -Wall PKCS10.c
[...]
PKCS10.xs:439:10: error: dereferencing pointer to incomplete type &#39;EVP_PKEY {aka struct evp_pkey_st}&#39;
  if &#40;pkey-&gt;type == EVP_PKEY_RSA&#41; {
          ^~
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;14&nbsp;08:54:34&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne St 12.říj.2016 05:27:04, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; After upgrading OpenSSL to 1.1.0 build fails like this:
&gt; 
</div>Attached patch fixes it.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Adapt-to-OpenSSL-1.1.0.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From ec363dab8b45ae05d5e06bb5a7cbb6caad6a96e3 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Fri, 14 Oct 2016 14:48:48 +0200
Subject: [PATCH] Adapt to OpenSSL 1.1.0
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

OpenSSL 1.1.0 hid structure internals and provides methods for
accessing them. This patch adapts the code so that it can be built
against new and old OpenSSL.

This patch does not address warnings about deprecated symbols in
OpenSSL 1.1.0.

CPAN RT#118345

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 PKCS10.xs | 35 ++++++++++++++++++++++++-----------
 1 file changed, 24 insertions&#40;+&#41;, 11 deletions&#40;-&#41;

diff --git a/PKCS10.xs b/PKCS10.xs
index d00b6ca..af6e2a6 100755
--- a/PKCS10.xs
+++ b/PKCS10.xs
@@ -5,12 +5,21 @@
 #include &lt;stdio.h&gt;
 #include &lt;stdlib.h&gt;
 
+#include &lt;openssl/asn1.h&gt;
 #include &lt;openssl/pem.h&gt;
 #include &lt;openssl/x509v3.h&gt;
 #include &lt;openssl/err.h&gt;
 
 #include &#34;ppport.h&#34;
 
+#if OPENSSL_VERSION_NUMBER &lt; 0x10100000L
+#define EVP_PKEY_get0_RSA&#40;pkey&#41; &#40;&#40;pkey&#41;-&gt;pkey.rsa&#41;
+#define EVP_PKEY_get0_DSA&#40;pkey&#41; &#40;&#40;pkey&#41;-&gt;pkey.dsa&#41;
+#ifndef OPENSSL_NO_EC
+#define EVP_PKEY_get0_EC_KEY&#40;pkey&#41; &#40;&#40;pkey&#41;-&gt;pkey.ec&#41;
+#endif
+#endif
+
 typedef struct
 {
     X509_REQ* req;
@@ -190,7 +199,7 @@ int add_ext_raw&#40;STACK_OF&#40;X509_REQUEST&#41; *sk, int nid, unsigned char *value, int l
 	X509_EXTENSION *ex;
 	ASN1_STRING *asn;
 
-	asn = M_ASN1_OCTET_STRING_new&#40;&#41;;
+	asn = ASN1_STRING_type_new&#40;V_ASN1_OCTET_STRING&#41;;
 	ASN1_OCTET_STRING_set&#40;asn, value, length&#41;;
 
 	ex = X509_EXTENSION_create_by_NID&#40;NULL, nid, 0, asn&#41;;
@@ -423,6 +432,7 @@ get_pem_pubkey&#40;pkcs10&#41;
 	PREINIT:
 	EVP_PKEY *pkey;
 	BIO *bio;
+	int type;
 
 	CODE:
 
@@ -436,17 +446,18 @@ get_pem_pubkey&#40;pkcs10&#41;
 		croak&#40;&#34;Public Key is unavailable\n&#34;&#41;;
 	}
 
-	if &#40;pkey-&gt;type == EVP_PKEY_RSA&#41; {
+	type = EVP_PKEY_base_id&#40;pkey&#41;;
+	if &#40;type == EVP_PKEY_RSA&#41; {
 
-#		PEM_write_bio_RSAPublicKey&#40;bio, pkey-&gt;pkey.rsa&#41;;
-		PEM_write_bio_RSA_PUBKEY&#40;bio, pkey-&gt;pkey.rsa&#41;;
+#		PEM_write_bio_RSAPublicKey&#40;bio, EVP_PKEY_get0_RSA&#40;pkey&#41;&#41;;
+		PEM_write_bio_RSA_PUBKEY&#40;bio, EVP_PKEY_get0_RSA&#40;pkey&#41;&#41;;
 
-	} else if &#40;pkey-&gt;type == EVP_PKEY_DSA&#41; {
+	} else if &#40;type == EVP_PKEY_DSA&#41; {
 
-		PEM_write_bio_DSA_PUBKEY&#40;bio, pkey-&gt;pkey.dsa&#41;;
+		PEM_write_bio_DSA_PUBKEY&#40;bio, EVP_PKEY_get0_DSA&#40;pkey&#41;&#41;;
 #ifndef OPENSSL_NO_EC
-	} else if &#40; pkey-&gt;type == EVP_PKEY_EC &#41; {
-		PEM_write_bio_EC_PUBKEY&#40;bio, pkey-&gt;pkey.ec&#41;;
+	} else if &#40; type == EVP_PKEY_EC &#41; {
+		PEM_write_bio_EC_PUBKEY&#40;bio, EVP_PKEY_get0_EC_KEY&#40;pkey&#41;&#41;;
 #endif
 	} else {
 
@@ -467,6 +478,7 @@ pubkey_type&#40;pkcs10&#41;
 
     PREINIT:
         EVP_PKEY *pkey;
+	int type;
 
     CODE:
         RETVAL=NULL;
@@ -475,13 +487,14 @@ pubkey_type&#40;pkcs10&#41;
         if&#40;!pkey&#41;
             XSRETURN_UNDEF;
 
-        if &#40;pkey-&gt;type == EVP_PKEY_DSA&#41; {
+        type = EVP_PKEY_base_id&#40;pkey&#41;;
+        if &#40;type == EVP_PKEY_DSA&#41; {
             RETVAL=&#34;dsa&#34;;
 
-        } else if &#40;pkey-&gt;type == EVP_PKEY_RSA&#41; {
+        } else if &#40;type == EVP_PKEY_RSA&#41; {
             RETVAL=&#34;rsa&#34;;
 #ifndef OPENSSL_NO_EC
-        } else if &#40; pkey-&gt;type == EVP_PKEY_EC &#41; {
+        } else if &#40; type == EVP_PKEY_EC &#41; {
             RETVAL=&#34;ec&#34;;
 #endif
         }
-- 
2.7.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;14&nbsp;12:21:00&nbsp;2016</span>
    <span class="description">jonozzz [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the patch! I&#39;ll merge it today, hopefully. Is this backwards compatible with older Openssl versions?

On Fri Oct 14 08:54:34 2016, ppisar wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne St 12.říj.2016 05:27:04, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; After upgrading OpenSSL to 1.1.0 build fails like this:
&gt; &gt; 
</div>&gt; Attached patch fixes it.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;14&nbsp;12:21:01&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;17&nbsp;03:49:36&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #118345] Fails to build with OpenSSL 1.1.0</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 17 Oct 2016 09:49:20 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Ionut Turturica via RT &lt;bug-Crypt-OpenSSL-PKCS10 [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Petr Pisar &lt;ppisar [...] redhat.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Oct 14, 2016 at 12:21:01PM -0400, Ionut Turturica via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Is this backwards compatible with older Openssl versions?
&gt; 
</div>I tested it with OpenSSL 1.0.2j and 1.1.0b.

-- Petr
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
