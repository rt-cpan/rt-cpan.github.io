<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #127928 for IO-Async: open3 in IO::Async::Process results in immediately dead child process</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #127928 for IO-Async: open3 in IO::Async::Process results in immediately dead child process</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=IO-Async">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=IO-Async">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=IO-Async">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=IO-Async">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IO-Async">IO-Async CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">127928</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=IO-Async">IO-Async</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
DBOOK [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-42614-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-42615-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




ma8sj9.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1824498/981513/ma8sj9.txt">
Wed Dec 12 17:15:16 2018 (1.4k) by DBOOK [...] cpan.org
</a>
</font></li>
</ul>


perl.strace<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1823579/981008/perl.strace">
Thu Dec 06 12:31:23 2018 (209.5k) by leonerd-cpan [...] leonerd.org.uk
</a>
</font></li>
</ul>


rt127928.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1823579/981009/rt127928.pl">
Thu Dec 06 12:31:23 2018 (1.1k) by leonerd-cpan [...] leonerd.org.uk
</a>
</font></li>
</ul>


vgg1wx.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1823358/980898/vgg1wx.txt">
Wed Dec 05 13:55:06 2018 (1k) by DBOOK [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=127928">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1823358" href="/Public/Bug/Display.html?id=127928#txn-1823358">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;05&nbsp;13:55:06&nbsp;2018</span>
    <span class="description">DBOOK [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> open3 in IO::Async::Process results in immediately dead child process</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1823358/980897/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/980897">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 390b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Reproducing script attached. I&#39;m really not sure what&#39;s going on here but it seems after using IPC::Open3 to start a second child process inside an IO::Async::Process child, the second child is immediately dead and thus trying to read from its output handles just hangs. IPC::Open3 is supposed to throw an exception if it fails to start so I&#39;m not sure how this is possible or how to debug.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> vgg1wx.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1823358/980898/vgg1wx.txt">Download vgg1wx.txt</a><br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl
use strict;
use warnings;
use IO::Async::Loop;
use Future;
use IPC::Open3;
use Symbol &#39;gensym&#39;;

my $cmd = &#39;echo &#34;stdout&#34;&#39;;
#my $cmd = &#39;echo &#34;stdout&#34; &#38;&#38; &gt;&#38;2 echo &#34;stderr&#34;&#39;;
my $out = &#39;&#39;;
my $code = sub {
  # works with regular pipe open
  #my $pid = open my $stdout, &#39;-|&#39;, $cmd or die &#34;open failed: $!&#34;;
  # hangs with open3
  my $pid = open3&#40;my $stdin, my $stdout, my $stderr = gensym, $cmd&#41;;
  print $_ while &lt;$stdout&gt;;
  waitpid $pid, 0;
  return $?;
};

open my $fake_out, &#39;&gt;&#39;, \$out or die &#34;open failed: $!&#34;;
select $fake_out;
my $exit = $code-&gt;&#40;&#41;;
select STDOUT;
print &#34;STDOUT:\n$out\nExit: $exit\n&#34;;

$out = &#39;&#39;;
my $loop = IO::Async::Loop-&gt;new;
my $f = $loop-&gt;new_future;
my $p = $loop-&gt;open_process&#40;
  code =&gt; $code,
  stdout =&gt; { into =&gt; \$out },
  stderr =&gt; { into =&gt; \my $err },
  on_finish =&gt; sub { $f-&gt;done&#40;$_[1]&#41; },
&#41;;
print &#34;pid: &#34; . $p-&gt;pid . &#34;\n&#34;;

$exit = Future-&gt;wait_any&#40;$f, $loop-&gt;timeout_future&#40;after =&gt; 10&#41;&#41;-&gt;get;
print &#34;STDOUT:\n$out\nExit: $exit\n&#34;;</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1823361" href="/Public/Bug/Display.html?id=127928#txn-1823361">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;05&nbsp;14:02:16&nbsp;2018</span>
    <span class="description">DBOOK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1823361/980901/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/980901">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 574b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 05 13:55:06 2018, DBOOK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Reproducing script attached. I&#39;m really not sure what&#39;s going on here
&gt; but it seems after using IPC::Open3 to start a second child process
&gt; inside an IO::Async::Process child, the second child is immediately
&gt; dead and thus trying to read from its output handles just hangs.
&gt; IPC::Open3 is supposed to throw an exception if it fails to start so
&gt; I&#39;m not sure how this is possible or how to debug.
</div>

Warning that running this script results in an IO::Async::Process waiting on a dead process that you have to manually clean up.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1823579" href="/Public/Bug/Display.html?id=127928#txn-1823579">#</a>      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;06&nbsp;12:31:23&nbsp;2018</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1823579/981007/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/981007">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 05 13:55:06 2018, DBOOK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Reproducing script attached. I&#39;m really not sure what&#39;s going on here
&gt; but it seems after using IPC::Open3 to start a second child process
&gt; inside an IO::Async::Process child, the second child is immediately
&gt; dead and thus trying to read from its output handles just hangs.
&gt; IPC::Open3 is supposed to throw an exception if it fails to start so
&gt; I&#39;m not sure how this is possible or how to debug.
</div>
Some curious behaviour here. I tried strace

  $ IO_ASYNC_DEBUG=2 strace -f -o perl.strace perl rt127928.pl 

on a slightly modified version of the script &#40;basically just added more `print STDERR ...` debugging in places&#41;, and got the following highlights:

Main process&#40;5763&#41; all proceeds as expected, until the fork call to set up the IaProcess:

5763  clone&#40;child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0x7faaec33d450&#41; = 5764

Perl-script child process&#40;5764&#41; then runs as far as the open3&#40;&#41; call:

5764  write&#40;2, &#34;D1\n&#34;, 3&#41;               = 3
5764  pipe2&#40;[3, 4], O_CLOEXEC&#41;          = 0
...
5764  pipe2&#40;[5, 6], O_CLOEXEC&#41;          = 0
...
5764  pipe2&#40; &lt;unfinished ...&gt;
5764  &lt;... pipe2 resumed&gt; [7, 8], O_CLOEXEC&#41; = 0
...
5764  pipe2&#40; &lt;unfinished ...&gt;
5764  &lt;... pipe2 resumed&gt; [10, 11], O_CLOEXEC&#41; = 0

So now it has some file descriptors. Quite why it does four pairs I don&#39;t yet know...

5764  clone&#40; &lt;unfinished ...&gt;
5764  &lt;... clone resumed&gt; child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0x7faaec33d450&#41; = 5765

open3&#40;&#41; has now cloned its own child&#40;5765&#41; to run the binary in. It dup2&#40;&#41;s the file descriptors to the right places

5765  dup2&#40;3, 0&#41;                        = 0
...
5765  dup2&#40;6, 1&#41;                        = 1
...
5765  dup2&#40;8, 2&#41;                        = 2

The originals were set to O_CLOEXEC. It then execve&#40;&#41;s the echo binary:

5765  execve&#40;&#34;/bin/sh&#34;, [&#34;sh&#34;, &#34;-c&#34;, &#34;echo \&#34;stdout\&#34;&#34;], 0x5566ed215990 /* 48 vars */ &lt;unfinished ...&gt;

that binary runs and eventually prints its output and exits:

5765  write&#40;1, &#34;stdout\n&#34;, 7 &lt;unfinished ...&gt;
5765  &lt;... write resumed&gt; &#41;             = 7
5765  exit_group&#40;0 &lt;unfinished ...&gt;
5765  &lt;... exit_group resumed&gt;&#41;         = ?

Meantime, the process running the `code` inside the IaProcess has been trying to read:

5764  read&#40;5,  &lt;unfinished ...&gt;

this eventually wakes up so it reports that back to its parent &#40;the &#34;print $_&#34; part&#41;:

5764  &lt;... read resumed&gt; &#34;stdout\n&#34;, 8192&#41; = 7
5764  write&#40;1, &#34;stdout\n&#34;, 7 &lt;unfinished ...&gt;
5764  &lt;... write resumed&gt; &#41;             = 7

By now, 5765 has exited, so 5764 receives its SIGCHLD, and ignores it

5764  --- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_EXITED, si_pid=5765, si_uid=1000, si_status=0, si_utime=0, si_stime=0} ---

But here&#39;s now where I get confused. The &#34;... while &lt;$stdout&gt;&#34; part is a loop, so naturally it&#39;s going to try reading again:

5764  read&#40;5,  &lt;unfinished ...&gt;

... and hereon blocks forever. This is the last system call that 5764 makes before the entire process group receives SIGINT because I hit Ctrl-C to stop the strace.

What I think *ought* to have happened is that read&#40;&#41; immediately returns zero, because it is trying to read fd5, which was a pipe whose other end was only open in the now-exited child. Surely?

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> perl.strace</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1823579/981008/perl.strace">Download perl.strace</a><br />
<span class="downloadcontenttype">application/octet-stream 209.5k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt127928.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1823579/981009/rt127928.pl">Download rt127928.pl</a><br />
<span class="downloadcontenttype">text/x-perl 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl
use strict;
use warnings;
use IO::Async::Loop;
use Future;
use IPC::Open3;
use Symbol &#39;gensym&#39;;

my $cmd = &#39;echo &#34;stdout&#34;&#39;;
#my $cmd = &#39;echo &#34;stdout&#34; &#38;&#38; &gt;&#38;2 echo &#34;stderr&#34;&#39;;
my $code = sub {
  # works with regular pipe open
  #my $pid = open my $stdout, &#39;-|&#39;, $cmd or die &#34;open failed: $!&#34;;
  # hangs with open3
  print STDERR &#34;D1\n&#34;;
  my $pid = open3&#40;my $stdin, my $stdout, my $stderr = gensym, $cmd&#41;;

  print STDERR &#34;D2\n&#34;;
  print $_ while &lt;$stdout&gt;;

  print STDERR &#34;D3\n&#34;;
  waitpid $pid, 0;

  print STDERR &#34;D4\n&#34;;
  return $?;
};

my $out = &#39;&#39;;
my $exit;

if&#40;0&#41; {
   open my $fake_out, &#39;&gt;&#39;, \$out or die &#34;open failed: $!&#34;;
   select $fake_out;
   $exit = $code-&gt;&#40;&#41;;
   select STDOUT;
   print &#34;STDOUT:\n$out\nExit: $exit\n&#34;;
}

$out = &#39;&#39;;
my $loop = IO::Async::Loop-&gt;new;
my $f = $loop-&gt;new_future;
my $p = $loop-&gt;open_process&#40;
  code =&gt; $code,
  stdout =&gt; { into =&gt; \$out },
  stderr =&gt; { into =&gt; \my $err },
  on_finish =&gt; sub { $f-&gt;done&#40;$_[1]&#41; },
&#41;;
print &#34;pid: &#34; . $p-&gt;pid . &#34;\n&#34;;

$exit = Future-&gt;wait_any&#40;$f, $loop-&gt;timeout_future&#40;after =&gt; 10&#41;&#41;-&gt;get;
print &#34;STDOUT:\n$out\nExit: $exit\n&#34;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1823580" href="/Public/Bug/Display.html?id=127928#txn-1823580">#</a>      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;06&nbsp;12:31:24&nbsp;2018</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1823582" href="/Public/Bug/Display.html?id=127928#txn-1823582">#</a>      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;06&nbsp;12:45:18&nbsp;2018</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1823582/981011/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/981011">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Dec 06 12:31:23 2018, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What I think *ought* to have happened is that read&#40;&#41; immediately
&gt; returns zero, because it is trying to read fd5, which was a pipe whose
&gt; other end was only open in the now-exited child. Surely?
</div>
Oh. Turns out, no. Here&#39;s a complete log of what 5764 did from the fork&#40;&#41; until the read&#40;&#41;:

5764  &lt;... clone resumed&gt; child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0x7faaec33d450&#41;    = 5765
5764  rt_sigprocmask&#40;SIG_SETMASK, [], NULL, 8&#41; = 0
5764  close&#40;11&#41;                 = 0
5764  read&#40;10, &#34;&#34;, 8192&#41;        = 0
5764  close&#40;10&#41;                 = 0
5764  close&#40;8&#41;                  = 0
5764  write&#40;2, &#34;D2\n&#34;, 3&#41;       = 3
5764  read&#40;5, &#34;stdout\n&#34;, 8192&#41; = 7
5764  write&#40;1, &#34;stdout\n&#34;, 7&#41;   = 7
5764  --- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_EXITED, si_pid=5765, si_uid=1000, si_status=0, si_utime=0, si_stime=0} ---
5764  read&#40;5,  &lt;unfinished ...&gt;

While it close&#40;&#41;ed its internal comms pipe and one of the three it set up for us, it didn&#39;t close the other two.

Indeed, this can be seen in its source - here some lines from IPC/Open3.pm &#40;VERSION = &#39;1.20&#39; on my system&#41;:

 243     # If the write handle is a dup give it away entirely, close my copy
 244     # of it.
 245     xclose $handles[0]{parent}, $handles[0]{mode} if $handles[0]{dup};

It is specifically only closing the first handle. it doesn&#39;t bother with the other two, leaving them open.

I elect this is an IPC::Open3 bug.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1823676" href="/Public/Bug/Display.html?id=127928#txn-1823676">#</a>      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;06&nbsp;18:25:13&nbsp;2018</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1823676/981070/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/981070">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Dec 06 12:45:18 2018, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I elect this is an IPC::Open3 bug.
</div>
Aaaactually, this looks more complicated than that.

I added some printing of opened filehandles according to the kernel, either side of the open3&#40;&#41; call:

  print STDERR `lsof -p $$ +E`;
  my $pid = IPC::Open3::open3&#40;my $stdin, my $stdout, my $stderr = gensym, $cmd&#41;;
  print STDERR `lsof -p $$ +E`;

The output of which is:

Before:
perl    2954  leo    0u   CHR  136,3      0t0       6 /dev/pts/3
perl    2954  leo    1w  FIFO   0,12      0t0   43396 pipe 2953,perl,4r
perl    2954  leo    2w  FIFO   0,12      0t0   43397 pipe 2953,perl,6r
perl    2954  leo    3r  FIFO   0,12      0t0   40623 pipe 2955,lsof,1w
perl    2954  leo    9w  FIFO   0,12      0t0   43398 pipe 2953,perl,8r

As was expected; STDIN remained from the terminal, STDOUT and STDERR are pipes to the parent process, fd 3 is the qx&#40;&#41; pipe from lsof, and fd 9 is the status pipe for IO::Async::Process.

After:
perl    2954  leo    0u   CHR  136,3      0t0       6 /dev/pts/3
perl    2954  leo    1w  FIFO   0,12      0t0   43396 pipe 2953,perl,4r
perl    2954  leo    2w  FIFO   0,12      0t0   43397 pipe 2953,perl,6r
perl    2954  leo    3r  FIFO   0,12      0t0   40623 pipe
perl    2954  leo    4r  FIFO   0,12      0t0   43401 pipe 2954,perl,5w
perl    2954  leo    5w  FIFO   0,12      0t0   43401 pipe 2954,perl,4r
perl    2954  leo    6r  FIFO   0,12      0t0   43402 pipe 2954,perl,7w
perl    2954  leo    7w  FIFO   0,12      0t0   43402 pipe 2954,perl,6r
perl    2954  leo    8r  FIFO   0,12      0t0   43403 pipe
perl    2954  leo    9w  FIFO   0,12      0t0   43398 pipe 2953,perl,8r
perl    2954  leo   10r  FIFO   0,12      0t0   43405 pipe 2960,lsof,1w

We have gained fds 4+5 and 6+7 for which we&#39;re holding *both* sides. Hrm...

I further added logging inside IPC/Open3.pm to the xclose&#40;&#41; function, having it print the values of filehandles it is attempting to close. It really tried:

sub xclose {
    print STDERR &#34;ENTER xclose&#40;$_[0]/IO=${\fileno $_[0]}&#41;\n&#34;;
    ...

Output:
ENTER xclose&#40;GLOB&#40;0x557681ad8840&#41;/IO=4&#41;
ENTER xclose&#40;GLOB&#40;0x557681b156d0&#41;/IO=7&#41;
ENTER xclose&#40;GLOB&#40;0x557681b07df0&#41;/IO=10&#41;

It tried to close 4, 7 and 10, but yet those remain open.


I now compare to a working case where the child doesn&#39;t deadlock, by commenting out the part where the -&gt;open_process call replaces the child&#39;s stderr. Now I get:

Before:
perl    4534  leo    0u   CHR  136,3      0t0       6 /dev/pts/3
perl    4534  leo    1w  FIFO   0,12      0t0   62923 pipe 4533,perl,4r
perl    4534  leo    2u   CHR  136,3      0t0       6 /dev/pts/3
perl    4534  leo    3r  FIFO   0,12      0t0   64257 pipe 4535,lsof,1w
perl    4534  leo    7w  FIFO   0,12      0t0   62924 pipe 4533,perl,6r

Output:
ENTER xclose&#40;GLOB&#40;0x55ae34a8f2a8&#41;/IO=4&#41;
ENTER xclose&#40;GLOB&#40;0x55ae34a8ef48&#41;/IO=8&#41;
ENTER xclose&#40;GLOB&#40;0x55ae34a8ed98&#41;/IO=10&#41;

After:
perl    4534  leo    0u   CHR  136,3      0t0       6 /dev/pts/3
perl    4534  leo    1w  FIFO   0,12      0t0   62923 pipe 4533,perl,4r
perl    4534  leo    2u   CHR  136,3      0t0       6 /dev/pts/3
perl    4534  leo    3r  FIFO   0,12      0t0   64257 pipe
perl    4534  leo    4r  FIFO   0,12      0t0   62925 pipe 4534,perl,5w
perl    4534  leo    5w  FIFO   0,12      0t0   62925 pipe 4534,perl,4r
perl    4534  leo    6r  FIFO   0,12      0t0   62926 pipe
perl    4534  leo    7w  FIFO   0,12      0t0   62924 pipe 4533,perl,6r
perl    4534  leo    8r  FIFO   0,12      0t0   62929 pipe 4538,lsof,1w
perl    4534  leo    9r  FIFO   0,12      0t0   62927 pipe

It still manages to be holding both sides of the fd 4+5 pair, but its attempt to close 8 and 10 were successful &#40;8 has been reused for lsof, 10 is now closed&#41;

Something oddly strange is occurring, whereby perl code executes the close&#40;&#41; operator, but that doesn&#39;t always result in a close&#40;2&#41; system call. Whether or not it does, seems to depend on what happens to STDERR.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1824498" href="/Public/Bug/Display.html?id=127928#txn-1824498">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;12&nbsp;17:15:16&nbsp;2018</span>
    <span class="description">DBOOK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1824498/981512/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/981512">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 182b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached a new test script using IO::Async::Process &#40;with its own loop&#41; for the secondary subprocess, can&#39;t seem to get this to work either, but don&#39;t know if it&#39;s a related problem.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ma8sj9.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1824498/981513/ma8sj9.txt">Download ma8sj9.txt</a><br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl
use strict;
use warnings;
BEGIN { $ENV{IO_ASYNC_LOOP} = &#39;Poll&#39; }
use IO::Async::Loop;
use Future;
use IPC::Open3;
use Symbol &#39;gensym&#39;;

my $cmd = &#39;echo &#39; . &#40;&#39;stdout&#39; x 100&#41;;
#my $cmd = &#39;echo &#34;stdout&#34; &#38;&#38; &gt;&#38;2 echo &#34;stderr&#34;&#39;;
my $out = &#39;&#39;;
my $code = sub {
  # works with regular pipe open
  #my $pid = open my $stdout, &#39;-|&#39;, $cmd or die &#34;open failed: $!&#34;;
  # hangs with open3
  #my $pid = open3&#40;my $stdin, my $stdout, my $stderr = gensym, $cmd&#41;;
  my $loop = IO::Async::Loop-&gt;really_new;
  my $f = $loop-&gt;new_future;
  my $process = $loop-&gt;open_process&#40;
    command =&gt; $cmd,
    stdout =&gt; {
      on_read =&gt; sub {
        my &#40;$stream, $buffref&#41; = @_;
        print $1 if $$buffref =~ s/&#40;.*&#41;//s;
        return 0;
      },
    },
    #stderr =&gt; {
    #  on_read =&gt; sub {0},
    #},
    on_finish =&gt; sub { $f-&gt;done&#40;$_[1]&#41; },
  &#41;;
  return $f-&gt;get;
};

open my $fake_out, &#39;&gt;&#39;, \$out or die &#34;open failed: $!&#34;;
select $fake_out;
my $exit = $code-&gt;&#40;&#41;;
select STDOUT;
print &#34;STDOUT:\n$out\nExit: $exit\n&#34;;

$out = &#39;&#39;;
my $loop = IO::Async::Loop-&gt;new;
my $f = $loop-&gt;new_future;
my $p = $loop-&gt;open_process&#40;
  code =&gt; $code,
  stdout =&gt; { into =&gt; \$out },
  #stderr =&gt; { into =&gt; \my $err },
  on_finish =&gt; sub { $f-&gt;done&#40;$_[1]&#41; },
&#41;;
print &#34;pid: &#34; . $p-&gt;pid . &#34;\n&#34;;

$exit = Future-&gt;wait_any&#40;$f, $loop-&gt;timeout_future&#40;after =&gt; 10&#41;&#41;-&gt;get;
print &#34;STDOUT:\n$out\nExit: $exit\n&#34;;</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1841916" href="/Public/Bug/Display.html?id=127928#txn-1841916">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;08&nbsp;20:08:16&nbsp;2019</span>
    <span class="description">DBOOK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1841916/990035/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/990035">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 82b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">For posterity, I am unable to reproduce this problem using IPC::Run3 in the child.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.551059</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
