<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #122822 for Geo-Coder-Google: 400 Bad Request when using utf8 in location.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #122822 for Geo-Coder-Google: 400 Bad Request when using utf8 in location.</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Geo-Coder-Google/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Geo-Coder-Google/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Geo-Coder-Google/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Geo-Coder-Google/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Geo-Coder-Google">Geo-Coder-Google CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">122822</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Geo-Coder-Google/Active/">Geo-Coder-Google</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
beasley [...] web.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-39900-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.18    </td>
  </tr>
  <tr id="CF-39901-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.18_01    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;16&nbsp;13:17:04&nbsp;2017</span>
    <span class="description">pzim [...] posteo.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 400 Bad Request when using utf8 in location.</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am using Geo::Coder::Google 0.18, that&#39;s latest as of now on Perl 5.20.

The following program results in `Google Maps API returned error: 400 Bad Request at geo_bug.pl`

    use v5.20;
    use strict;
    use utf8;
    use Geo::Coder::Google;

    my $geocoder = Geo::Coder::Google-&gt;new&#40; apiver =&gt; 3, key =&gt; &#39;AIzaSyDhg_MRCJvwFBYP56k65uf_HVC2iFjjWmU&#39; &#41;;
    $geocoder-&gt;geocode&#40; location =&gt; &#39;Kielstra√üe 23, 70123, Germany&#39;  &#41;;


When using a `key` parameter string with the utf8 marker set the library creates requests with invalid characters in it as soon as
the location that is to be geocoded contains unicode chars.

Removing lines 77-79 in Google/V3.pm fixes the issue.

77    if &#40;Encode::is_utf8&#40;$location&#41;&#41; {
78        $location = Encode::encode_utf8&#40;$location&#41;;
79    }

I am not sure though which other use-cases these lines were written for.


What follows is an explanation of what I think goes wrong when the above lines are *not* removed.

Geo/Coder/Google/V3.pm lines 77-79 UTF8 encode the location parameter if it has the utf8 marker.
This causes that the query parameters passed to the URI object later on can be of mixed encoding status &#40;some encoded already, some not yet&#41;.
That in turn makes URI double encode the already encoded parameters.

If I interpret <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/URI#BUGS">https://metacpan.org/pod/URI#BUGS</a></span> correctly, URI depends on the UTF8 marker on strings to determine whether to encode the string as UTF8
prior to percent encoding or not.
The behavior I observe, is that when calling $uri-&gt;query_form&#40;%hash&#41; and *any* of the values in hash have the utf8 marker set, then *all* hash values are taken to
be utf8 encoded already. If *none* of them have the utf8 marker set, then *all* hash values are utf8 encoded prior to percent encoding.

The following program demonstrates that behavior. The erroneous param should be encoded as &#34;x%C3%9Fz&#34;, but is encoded as &#34;x%C3%83%C2%9Fz&#34;.

    use v5.20;
    use strict;
    use Encode;
    use URI;
    use Devel::Peek;

    my $uri = URI-&gt;new&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="https://maps.googleapis.com/maps/api/geocode/json">https://maps.googleapis.com/maps/api/geocode/json</a></span>&#34;&#41;;
    # URI gives the correct result when using the top pair or the bottom pair.
    # It breaks when mixing decoded with non decoded params as below.
    my %params = &#40;
        #erroneous =&gt; decode&#40;&#39;utf8&#39;, &#39;x√üz&#39;&#41;,
        dummy     =&gt; decode&#40;&#39;utf8&#39;, &#39;abc&#39;&#41;, # sets the utf8 marker

        erroneous =&gt; &#39;x√üz&#39;,
        #dummy     =&gt; &#39;abc&#39;,
    &#41;;
    $uri-&gt;query_form&#40;%params&#41;;

    Dump&#40; %params &#41;;
    say &#39;url: &#39; . $uri-&gt;as_string;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;17&nbsp;13:37:51&nbsp;2017</span>
    <span class="description">justin.d.hunter [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have shipped 0.18_01 to cpan, can you test this?

related commits on github: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/arcanez/geo-coder-google/commit/69093d129f0d1c0217f41157fd6cee2d55ccaed7">https://github.com/arcanez/geo-coder-google/commit/69093d129f0d1c0217f41157fd6cee2d55ccaed7</a></span>

POSTing upload for Geo-Coder-Google-0.18_01.tar.gz to <span class="clickylink"><a target="new" rel="nofollow" href="https://pause.perl.org/pause/authenquery">https://pause.perl.org/pause/authenquery</a></span>
PAUSE add message sent ok [200]

On Wed Aug 16 13:17:04 2017, pzim@posteo.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I am using Geo::Coder::Google 0.18, that&#39;s latest as of now on Perl
&gt; 5.20.
&gt; 
&gt; The following program results in `Google Maps API returned error: 400
&gt; Bad Request at geo_bug.pl`
&gt; 
&gt; use v5.20;
&gt; use strict;
&gt; use utf8;
&gt; use Geo::Coder::Google;
&gt; 
&gt; my $geocoder = Geo::Coder::Google-&gt;new&#40; apiver =&gt; 3, key =&gt;
&gt; &#39;AIzaSyDhg_MRCJvwFBYP56k65uf_HVC2iFjjWmU&#39; &#41;;
&gt; $geocoder-&gt;geocode&#40; location =&gt; &#39;Kielstra√üe 23, 70123, Germany&#39;  &#41;;
&gt; 
&gt; 
&gt; When using a `key` parameter string with the utf8 marker set the
&gt; library creates requests with invalid characters in it as soon as
&gt; the location that is to be geocoded contains unicode chars.
&gt; 
&gt; Removing lines 77-79 in Google/V3.pm fixes the issue.
&gt; 
&gt; 77    if &#40;Encode::is_utf8&#40;$location&#41;&#41; {
&gt; 78        $location = Encode::encode_utf8&#40;$location&#41;;
&gt; 79    }
&gt; 
&gt; I am not sure though which other use-cases these lines were written
&gt; for.
&gt; 
&gt; 
&gt; What follows is an explanation of what I think goes wrong when the
&gt; above lines are *not* removed.
&gt; 
&gt; Geo/Coder/Google/V3.pm lines 77-79 UTF8 encode the location parameter
&gt; if it has the utf8 marker.
&gt; This causes that the query parameters passed to the URI object later
&gt; on can be of mixed encoding status &#40;some encoded already, some not
&gt; yet&#41;.
&gt; That in turn makes URI double encode the already encoded parameters.
&gt; 
&gt; If I interpret <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/URI#BUGS">https://metacpan.org/pod/URI#BUGS</a></span> correctly, URI
&gt; depends on the UTF8 marker on strings to determine whether to encode
&gt; the string as UTF8
&gt; prior to percent encoding or not.
&gt; The behavior I observe, is that when calling $uri-&gt;query_form&#40;%hash&#41;
&gt; and *any* of the values in hash have the utf8 marker set, then *all*
&gt; hash values are taken to
&gt; be utf8 encoded already. If *none* of them have the utf8 marker set,
&gt; then *all* hash values are utf8 encoded prior to percent encoding.
&gt; 
&gt; The following program demonstrates that behavior. The erroneous param
&gt; should be encoded as &#34;x%C3%9Fz&#34;, but is encoded as &#34;x%C3%83%C2%9Fz&#34;.
&gt; 
&gt; use v5.20;
&gt; use strict;
&gt; use Encode;
&gt; use URI;
&gt; use Devel::Peek;
&gt; 
&gt; my $uri = URI-
<div class="message-stanza open">&gt; &gt;new&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="https://maps.googleapis.com/maps/api/geocode/json">https://maps.googleapis.com/maps/api/geocode/json</a></span>&#34;&#41;;
</div>&gt; # URI gives the correct result when using the top pair or the bottom
&gt; pair.
&gt; # It breaks when mixing decoded with non decoded params as below.
&gt; my %params = &#40;
&gt;     #erroneous =&gt; decode&#40;&#39;utf8&#39;, &#39;x√üz&#39;&#41;,
&gt;     dummy     =&gt; decode&#40;&#39;utf8&#39;, &#39;abc&#39;&#41;, # sets the utf8 marker
&gt; 
&gt; erroneous =&gt; &#39;x√üz&#39;,
&gt; #dummy     =&gt; &#39;abc&#39;,
&gt; &#41;;
&gt; $uri-&gt;query_form&#40;%params&#41;;
&gt; 
&gt; Dump&#40; %params &#41;;
&gt; say &#39;url: &#39; . $uri-&gt;as_string;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;17&nbsp;13:37:52&nbsp;2017</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;17&nbsp;13:38:05&nbsp;2017</span>
    <span class="description">justin.d.hunter [...] gmail.com -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;21&nbsp;04:27:50&nbsp;2017</span>
    <span class="description">pzim [...] posteo.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> beasley [...] web.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Tested.

Broken in 0.18, works in 0.18_01.

Thanks!

Am Do 17. Aug 2017, 13:37:51, arcanez schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have shipped 0.18_01 to cpan, can you test this?
&gt; 
&gt; related commits on github: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/arcanez/geo-coder-">https://github.com/arcanez/geo-coder-</a></span>
&gt; google/commit/69093d129f0d1c0217f41157fd6cee2d55ccaed7
&gt; 
&gt; POSTing upload for Geo-Coder-Google-0.18_01.tar.gz to
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://pause.perl.org/pause/authenquery">https://pause.perl.org/pause/authenquery</a></span>
&gt; PAUSE add message sent ok [200]
&gt; 
&gt; On Wed Aug 16 13:17:04 2017, pzim@posteo.de wrote:
<div class="message-stanza open">&gt; &gt; I am using Geo::Coder::Google 0.18, that&#39;s latest as of now on Perl
&gt; &gt; 5.20.
&gt; &gt;
&gt; &gt; The following program results in `Google Maps API returned error: 400
&gt; &gt; Bad Request at geo_bug.pl`
&gt; &gt;
&gt; &gt; use v5.20;
&gt; &gt; use strict;
&gt; &gt; use utf8;
&gt; &gt; use Geo::Coder::Google;
&gt; &gt;
&gt; &gt; my $geocoder = Geo::Coder::Google-&gt;new&#40; apiver =&gt; 3, key =&gt;
&gt; &gt; &#39;AIzaSyDhg_MRCJvwFBYP56k65uf_HVC2iFjjWmU&#39; &#41;;
&gt; &gt; $geocoder-&gt;geocode&#40; location =&gt; &#39;Kielstra√üe 23, 70123, Germany&#39;  &#41;;
&gt; &gt;
&gt; &gt;
&gt; &gt; When using a `key` parameter string with the utf8 marker set the
&gt; &gt; library creates requests with invalid characters in it as soon as
&gt; &gt; the location that is to be geocoded contains unicode chars.
&gt; &gt;
&gt; &gt; Removing lines 77-79 in Google/V3.pm fixes the issue.
&gt; &gt;
&gt; &gt; 77    if &#40;Encode::is_utf8&#40;$location&#41;&#41; {
&gt; &gt; 78        $location = Encode::encode_utf8&#40;$location&#41;;
&gt; &gt; 79    }
&gt; &gt;
&gt; &gt; I am not sure though which other use-cases these lines were written
&gt; &gt; for.
&gt; &gt;
&gt; &gt;
&gt; &gt; What follows is an explanation of what I think goes wrong when the
&gt; &gt; above lines are *not* removed.
&gt; &gt;
&gt; &gt; Geo/Coder/Google/V3.pm lines 77-79 UTF8 encode the location parameter
&gt; &gt; if it has the utf8 marker.
&gt; &gt; This causes that the query parameters passed to the URI object later
&gt; &gt; on can be of mixed encoding status &#40;some encoded already, some not
&gt; &gt; yet&#41;.
&gt; &gt; That in turn makes URI double encode the already encoded parameters.
&gt; &gt;
&gt; &gt; If I interpret <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/URI#BUGS">https://metacpan.org/pod/URI#BUGS</a></span> correctly, URI
&gt; &gt; depends on the UTF8 marker on strings to determine whether to encode
&gt; &gt; the string as UTF8
&gt; &gt; prior to percent encoding or not.
&gt; &gt; The behavior I observe, is that when calling $uri-&gt;query_form&#40;%hash&#41;
&gt; &gt; and *any* of the values in hash have the utf8 marker set, then *all*
&gt; &gt; hash values are taken to
&gt; &gt; be utf8 encoded already. If *none* of them have the utf8 marker set,
&gt; &gt; then *all* hash values are utf8 encoded prior to percent encoding.
&gt; &gt;
&gt; &gt; The following program demonstrates that behavior. The erroneous param
&gt; &gt; should be encoded as &#34;x%C3%9Fz&#34;, but is encoded as &#34;x%C3%83%C2%9Fz&#34;.
&gt; &gt;
&gt; &gt; use v5.20;
&gt; &gt; use strict;
&gt; &gt; use Encode;
&gt; &gt; use URI;
&gt; &gt; use Devel::Peek;
&gt; &gt;
&gt; &gt; my $uri = URI-
<div class="message-stanza open">&gt; &gt; &gt; new&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="https://maps.googleapis.com/maps/api/geocode/json">https://maps.googleapis.com/maps/api/geocode/json</a></span>&#34;&#41;;
</div>&gt; &gt; # URI gives the correct result when using the top pair or the bottom
&gt; &gt; pair.
&gt; &gt; # It breaks when mixing decoded with non decoded params as below.
&gt; &gt; my %params = &#40;
&gt; &gt;     #erroneous =&gt; decode&#40;&#39;utf8&#39;, &#39;x√üz&#39;&#41;,
&gt; &gt;     dummy     =&gt; decode&#40;&#39;utf8&#39;, &#39;abc&#39;&#41;, # sets the utf8 marker
&gt; &gt;
&gt; &gt; erroneous =&gt; &#39;x√üz&#39;,
&gt; &gt; #dummy     =&gt; &#39;abc&#39;,
&gt; &gt; &#41;;
&gt; &gt; $uri-&gt;query_form&#40;%params&#41;;
&gt; &gt;
&gt; &gt; Dump&#40; %params &#41;;
&gt; &gt; say &#39;url: &#39; . $uri-&gt;as_string;
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;06&nbsp;12:46:31&nbsp;2017</span>
    <span class="description">justin.d.hunter [...] gmail.com -  Fixed in 0.18_01 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;06&nbsp;12:46:40&nbsp;2017</span>
    <span class="description">justin.d.hunter [...] gmail.com -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
