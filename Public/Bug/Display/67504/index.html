<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #67504 for Net-DNS: Net::DNS::Packet-&gt;data doesn&#39;t parse answer/additional/authority</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #67504 for Net-DNS: Net::DNS::Packet-&gt;data doesn&#39;t parse answer/additional/authority</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-DNS/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-DNS">Net-DNS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">67504</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-DNS/Active/">Net-DNS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
leonerd-cpan [...] leonerd.org.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22454-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.66    </td>
  </tr>
  <tr id="CF-22455-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;15&nbsp;20:24:33&nbsp;2011</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net::DNS::Packet-&gt;data doesn&#39;t parse answer/additional/authority</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Directly printing a Packet works.

eval: Net::DNS::Resolver-&gt;new-&gt;query&#40;&#34;www.cpan.org&#34;&#41;-&gt;print;
...
;; ANSWER SECTION &#40;3 records&#41;
www.cpan.org.   86031   IN      CNAME   cpan-www.develooper.com.
cpan-www.develooper.com.        6831    IN      CNAME  
cpan-global.l.develooper.org.
cpan-global.l.develooper.org.   60      IN      A       212.117.177.118

;; AUTHORITY SECTION &#40;4 records&#41;
...

However, I&#39;m trying to serialise a response packet to send it over a
pipe between two processes. This doesn&#39;t:

eval: my $data = Net::DNS::Resolver-&gt;new-&gt;query&#40;&#34;www.cpan.org&#34;&#41;-&gt;data;
&#34;\xf6\x97\x81\x80\x00\x01\x00\x00\x00\x00\x00\x00\x03www\x04cpan\x03org\x00\x00\x01\x00\x01&#34;

eval: Net::DNS::Packet-&gt;new&#40;\$data&#41;-&gt;print
...
;; ANSWER SECTION &#40;0 records&#41;

;; AUTHORITY SECTION &#40;0 records&#41;


Having read sub Net::DNS::Packet::data, I believe this is because it
doesn&#39;t correctly parse the other fields, before trying to pack the data
again. However, the following workaround seems to work OK:

eval: my $q = Net::DNS::Resolver-&gt;new-&gt;query&#40;&#34;www.cpan.org&#34;&#41;;

eval: $q-&gt;answer
&#39;3&#39;

eval: $q-&gt;authority
&#39;4&#39;

eval: $q-&gt;additional
&#39;0&#39;

eval: my $data = $q-&gt;data;
&#34;\xa1\x84\x81\x80\x00\x01\x00\x03\x00\x04\x00\x00\x03www\x04cpan\x03org\x00\x00\x01\x00\x01\xc0\x0c\x00\x05\x00\x01\x00\x01Q\x80\x00\x19\x08cpan-www\ndevelooper\x03com\x00\xc0*\x00\x05\x00\x01\x00\x00\x1c
\x00\e\x0bcpan-global\x01l\ndevelooper\xc0\x15\xc0O\x00\x01\x00\x01\x00\x00\x00&lt;\x00\x04\xd4u\xb1v\xc0[\x00\x02\x00\x01\x00\x01Q\x80\x00\x14\x03ns2\x03p20\x06dynect\x03net\x00\xc0[\x00\x02\x00\x01\x00\x01Q\x80\x00\x06\x03ns1\xc0\x8a\xc0[\x00\x02\x00\x01\x00\x01Q\x80\x00\x06\x03ns4\xc0\x8a\xc0[\x00\x02\x00\x01\x00\x01Q\x80\x00\x06\x03ns3\xc0\x8a&#34;

eval: Net::DNS::Packet-&gt;new&#40;\$data&#41;-&gt;print
;; HEADER SECTION
;; id = 41348
;; qr = 1    opcode = QUERY    aa = 0    tc = 0    rd = 1
;; ra = 1    ad = 0    cd = 0    rcode  = NOERROR
;; qdcount = 1  ancount = 3  nscount = 4  arcount = 0

;; QUESTION SECTION &#40;1 record&#41;
;; www.cpan.org.        IN      A

;; ANSWER SECTION &#40;3 records&#41;
www.cpan.org.   86400   IN      CNAME   cpan-www.develooper.com.
cpan-www.develooper.com.        7200    IN      CNAME  
cpan-global.l.develooper.org.
cpan-global.l.develooper.org.   60      IN      A       212.117.177.118

;; AUTHORITY SECTION &#40;4 records&#41;


eval: Net::DNS::Packet-&gt;new&#40; \$q-&gt;data &#41;-&gt;print
;; HEADER SECTION
;; id = 13956
;; qr = 1    opcode = QUERY    aa = 0    tc = 0    rd = 1
;; ra = 1    ad = 0    cd = 0    rcode  = NOERROR
;; qdcount = 1  ancount = 3  nscount = 4  arcount = 0

;; QUESTION SECTION &#40;1 record&#41;
;; www.cpan.org.        IN      A

;; ANSWER SECTION &#40;3 records&#41;
www.cpan.org.   86283   IN      CNAME   cpan-www.develooper.com.
cpan-www.develooper.com.        7083    IN      CNAME  
cpan-global.l.develooper.org.
cpan-global.l.develooper.org.   60      IN      A       212.117.177.118

;; AUTHORITY SECTION &#40;4 records&#41;



-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;18&nbsp;23:16:41&nbsp;2011</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Net::DNS is a stub resolver library whose purpose is to send query
packets to a configured list of nameservers and receive the
corresponding response packet object from which the RR data can be
extracted using the object methods.

It is emphatically NOT intended to be a general-purpose DNS packet
manipulation library. Retransmission of packets is not a requirement for
a stub resolver.

Parsing of received packet buffers is deferred until the $packet-&gt;answer
method is called. Other sections are handled in a similar manner. Packet
sections which are not used by the application need not be parsed at
all. This is expected behaviour, not a bug.


On Fri Apr 15 20:24:33 2011, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Directly printing a Packet works.
&gt; 
</div>Because each component is parsed when it is extracted from the packet
&#40;using $packet-&gt;answer and similar methods&#41;.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; However, I&#39;m trying to serialise a response packet to send it over a
&gt; pipe between two processes. This doesn&#39;t:
&gt; 
&gt; eval: my $data = Net::DNS::Resolver-&gt;new-&gt;query&#40;&#34;www.cpan.org&#34;&#41;-&gt;data;
&gt;
</div>&#34;\xf6\x97\x81\x80\x00\x01\x00\x00\x00\x00\x00\x00\x03www\x04cpan\x03org\x00\x00\x01\x00\x01&#34;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
</div>The present implementation does not support this use case at all.

Even if it did, the contents of the packet would be converted into RR
objects and immediately reconverted back into binary packet format.
Decoding would then need to be done a second time in the destination
process.

A more efficient solution might be to capture the raw packet buffer and
pipe that to the destination process. The transferred packet buffer can
then be decoded &#40;once only&#41; using existing methods.

 my $buffer = ...
 my $packet = new Net::DNS::Packet&#40; \$buffer &#41;;
 if &#40; $packet &#41; {
     my @answer = $packet-&gt;answer;
     ...
 }



This is an application issue, not a Net::DNS bug.

--Dick
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;18&nbsp;23:16:43&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;19&nbsp;12:16:07&nbsp;2011</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Apr 18 23:16:41 2011, rwfranks@acm.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Parsing of received packet buffers is deferred until the $packet-
<div class="message-stanza open">&gt; &gt;answer
</div>&gt; method is called. Other sections are handled in a similar manner.
&gt; Packet
&gt; sections which are not used by the application need not be parsed at
&gt; all. This is expected behaviour, not a bug.
</div>
Then why does -&gt;answer fill in the answer/additional/authority sections -if- they have already been parsed, 
but not before?

  my $pkt = Net::DNS::Resolver-&gt;new-&gt;query&#40;....&#41;

  $data = $pkt-&gt;data;     # contains only the question

  $pkt-&gt;answer; $pkt-&gt;additional; $pkt-&gt;authority; # in void context, just for side effects
  $data = $pkt-&gt;data;     # now contains all the sections

Theabove workaround is what my code currently contains.

If the intention is not to do this, then why does sub Net::DNS::Packet::data contain:

        $header-&gt;ancount&#40; scalar @{$self-&gt;{answer}} &#41;;
        $header-&gt;nscount&#40; scalar @{$self-&gt;{authority}} &#41;;
        $header-&gt;arcount&#40; scalar @{$self-&gt;{additional}} &#41;;

followed by:

        foreach my $component &#40; $header,
                                @{$self-&gt;{question}},
                                @{$self-&gt;{answer}},
                                @{$self-&gt;{authority}},
                                @{$self-&gt;{additional}}  &#41; {

If it&#39;s only ever for the question, then don&#39;t bother filling in the answer/authority/additional fields &#34;if 
they&#39;ve been parsed but not if not&#34;. Either it always should, or it never should.

The fact that the behaviour of one pure accessing method &#40;-&gt;data&#41; changes depending on whether or not some 
other &#40;supposedly&#41; pure accessing methods &#40;-&gt;answer, -&gt;authority, -&gt;additional&#41; are called is surely a bug, 
regardless.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; However, I&#39;m trying to serialise a response packet to send it over a
&gt; &gt; pipe between two processes. This doesn&#39;t:
</div></div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The present implementation does not support this use case at all.
</div>
Again, I observe that if I put those three void-context calls it happens to work fine.

There&#39;s surely a really trivial &#34;parse the response sections in -&gt;data if they&#39;re present&#34; code fix here...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Even if it did, the contents of the packet would be converted into RR
&gt; objects and immediately reconverted back into binary packet format.
&gt; Decoding would then need to be done a second time in the destination
&gt; process.
</div>
I&#39;m aware of that; see side note below.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; A more efficient solution might be to capture the raw packet buffer
&gt; and
&gt; pipe that to the destination process. The transferred packet buffer
&gt; can
&gt; then be decoded &#40;once only&#41; using existing methods.
&gt; 
&gt;  my $buffer = ...
&gt;  my $packet = new Net::DNS::Packet&#40; \$buffer &#41;;
&gt;  if &#40; $packet &#41; {
&gt;      my @answer = $packet-&gt;answer;
&gt;      ...
&gt;  }
</div>
That&#39;s an interesting idea - how might I capture that buffer? I couldn&#39;t see a way using 
Net::DNS::Resolver.

-----

As a side note:

The reason I want to send the raw DNS packet bytes over the pipe between these two processes, is that most 
of the time Net::LibResolv will be installed, so usually the child process actually calls res_query&#40;3&#41;, 
which just returns that raw DNS packet in a bytestring efficiently from the C code. That goes over the pipe 
to be parsed using Net::DNS in the controlling parent process. Net::DNS::Resolver is only used in the child 
as a fallback if Net::LibResolv is missing; perhaps because of an inability to compile and install XS code.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;20&nbsp;02:55:20&nbsp;2011</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Paul,

On Tue Apr 19 12:16:07 2011, PEVANS wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Apr 18 23:16:41 2011, rwfranks@acm.org wrote:
<div class="message-stanza open">&gt; &gt; Parsing of received packet buffers is deferred until the $packet-
<div class="message-stanza open">&gt; &gt; &gt;answer
</div>&gt; &gt; method is called. Other sections are handled in a similar manner.
&gt; &gt; Packet
&gt; &gt; sections which are not used by the application need not be parsed at
&gt; &gt; all. This is expected behaviour, not a bug.
</div>&gt; 
&gt; Then why does -&gt;answer fill in the answer/additional/authority
&gt; sections -if- they have already been parsed,
&gt; but not before?
</div>
Data lives &#40;unparsed&#41; in the raw packet buffer until
answer/authority/additional is called. The corresponding RR section in
the Net::DNS::Packet instance is populated and answer etc. returns a
list of RR references.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The fact that the behaviour of one pure accessing method &#40;-&gt;data&#41;
&gt; changes depending on whether or not some
&gt; other &#40;supposedly&#41; pure accessing methods &#40;-&gt;answer, -&gt;authority,
&gt; -&gt;additional&#41; are called is surely a bug,
&gt; regardless.
</div>
$packet-&gt;data does not force parsing, because as I explained before,
this is not a use case that Net::DNS needs to support. As it is also
horribly inefficient, there is little motivation for mission-creep in
that direction.

$packet-&gt;data is provided for generating images of fully populated
packets objects to be sent to a nameserver.

Retransmission of inbound packets is out of scope for a stub resolver,
no requirement, so not implemented. This view should be reinforced by
raising a fatal program error exception.

What you are doing may be interesting but lies beyond the remit of Net::DNS.



<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
<div class="message-stanza open">&gt; &gt; A more efficient solution might be to capture the raw packet buffer
&gt; &gt; and
&gt; &gt; pipe that to the destination process. The transferred packet buffer
&gt; &gt; can
&gt; &gt; then be decoded &#40;once only&#41; using existing methods.
&gt; &gt;
&gt; &gt;  my $buffer = ...
&gt; &gt;  my $packet = new Net::DNS::Packet&#40; \$buffer &#41;;
&gt; &gt;  if &#40; $packet &#41; {
&gt; &gt;      my @answer = $packet-&gt;answer;
&gt; &gt;      ...
&gt; &gt;  }
</div>&gt; 
&gt; That&#39;s an interesting idea - how might I capture that buffer? I
&gt; couldn&#39;t see a way using Net::DNS::Resolver.
</div>
There is currently no legitimate way to do this.

However, you could abuse Net::DNS some more, and fish out the reference
to the raw data.

This breaks encapsulation and, as it is not part of the published
interface, it could change or disappear without notice. This may not be
a good idea for widely deployed code.

 my $packet = $resolver-&gt;query&#40; ... &#41;;
 my $buffer = $packet-&gt;{buffer};
 my $rawdata = $$buffer;

Providing a good long-term solution which does not also fill up memory
with a trail of unwanted raw packet buffers will require some careful
thought.


Regards
--Dick
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;21&nbsp;07:43:54&nbsp;2011</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Apr 20 02:55:20 2011, rwfranks@acm.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Paul,
&gt; 
&gt; On Tue Apr 19 12:16:07 2011, PEVANS wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; On Mon Apr 18 23:16:41 2011, rwfranks@acm.org wrote:
<div class="message-stanza open">&gt; &gt; &gt; Parsing of received packet buffers is deferred until the $packet-
<div class="message-stanza open">&gt; &gt; &gt; &gt;answer
</div>&gt; &gt; &gt; method is called. Other sections are handled in a similar manner.
&gt; &gt; &gt; Packet
&gt; &gt; &gt; sections which are not used by the application need not be parsed at
&gt; &gt; &gt; all. This is expected behaviour, not a bug.
</div>&gt; &gt; 
&gt; &gt; Then why does -&gt;answer fill in the answer/additional/authority
&gt; &gt; sections -if- they have already been parsed,
&gt; &gt; but not before?
</div>&gt; 
&gt; Data lives &#40;unparsed&#41; in the raw packet buffer until
&gt; answer/authority/additional is called. The corresponding RR section in
&gt; the Net::DNS::Packet instance is populated and answer etc. returns a
&gt; list of RR references.
</div>
Oops, this was misworded. I meant to ask why does -&gt;data fill these sections?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; The fact that the behaviour of one pure accessing method &#40;-&gt;data&#41;
&gt; &gt; changes depending on whether or not some
&gt; &gt; other &#40;supposedly&#41; pure accessing methods &#40;-&gt;answer, -&gt;authority,
&gt; &gt; -&gt;additional&#41; are called is surely a bug,
&gt; &gt; regardless.
</div>&gt; 
&gt; $packet-&gt;data does not force parsing, because as I explained before,
&gt; this is not a use case that Net::DNS needs to support. As it is also
&gt; horribly inefficient, there is little motivation for mission-creep in
&gt; that direction.
</div>
The question here is: Should the byte buffer returned by -&gt;data include the answer/authority/additional fields?

 If yes =&gt; currently it doesn&#39;t unless they&#39;ve been parsed first, so
           sub data {} should do that.

 If no  =&gt; currently it will do if they have been parsed first, so the
           parts of code responsible for this behavior in sub data {}
           should be removed.

The current &#34;sometimes-yes-sometimes-no&#34; inconsistency seems to me a bug, I can&#39;t see it any other 
way.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; That&#39;s an interesting idea - how might I capture that buffer? I
&gt; &gt; couldn&#39;t see a way using Net::DNS::Resolver.
</div>&gt; 
&gt; There is currently no legitimate way to do this.
&gt; 
&gt; However, you could abuse Net::DNS some more, and fish out the reference
&gt; to the raw data.
&gt; 
&gt; This breaks encapsulation and, as it is not part of the published
&gt; interface, it could change or disappear without notice. This may not be
&gt; a good idea for widely deployed code.
&gt; 
&gt;  my $packet = $resolver-&gt;query&#40; ... &#41;;
&gt;  my $buffer = $packet-&gt;{buffer};
&gt;  my $rawdata = $$buffer;
&gt; 
&gt; Providing a good long-term solution which does not also fill up memory
&gt; with a trail of unwanted raw packet buffers will require some careful
&gt; thought.
</div>
It appears to me as the code stands, I basically have four options:

 0. Don&#39;t change anything, and continue to rely on the side-effect that
    -&gt;answer etc.. will prefill the data buffers such that -&gt;data now
    returns all the bytes.

 1. Break the encapsulation of Net::DNS::Packet by using the code sample
    above.

 2. Add a new method to Net::DNS::Packet, which would need to be
    integrated upstream:

      sub bufferbytes { return ${ shift-&gt;{buffer} } }

 3. Abandon the use of Net::DNS::Resolver in the child process and use
    only Net::LibResolv.

For reference, the code under consideration here is currently:

  <span class="clickylink"><a target="new" rel="nofollow" href="http://cpansearch.perl.org/src/PEVANS/IO-Async-Resolver-DNS-0.01/lib/IO/Async/Resolver/DNS.pm">http://cpansearch.perl.org/src/PEVANS/IO-Async-Resolver-DNS-0.01/lib/IO/Async/Resolver/DNS.pm</a></span>


What would you suggest here? It seems that, ideally, option 2 would look best. Adds a small simple 
interface to Net::DNS::Packet that directly and efficiently yields the answer I&#39;m looking for. I don&#39;t 
like option 1. Option 0 means relying on the current side-effect to remain working &#40;though unit tests 
easily determine if it is doing so&#41;.

Failing any of these options, my only remaining choice would otherwise be to abandon using 
Net::DNS::Resolver at all. But I am hoping that is the last-resort choice.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;21&nbsp;11:45:14&nbsp;2011</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Apr 21 07:43:54 2011, PEVANS wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What would you suggest here? It seems that, ideally, option 2 would
&gt; look best. Adds a small simple
&gt; interface to Net::DNS::Packet that directly and efficiently yields the
&gt; answer I&#39;m looking for. I don&#39;t
&gt; like option 1. Option 0 means relying on the current side-effect to
&gt; remain working &#40;though unit tests
&gt; easily determine if it is doing so&#41;.
&gt; 
&gt; Failing any of these options, my only remaining choice would otherwise
&gt; be to abandon using
&gt; Net::DNS::Resolver at all. But I am hoping that is the last-resort
&gt; choice.
</div>
Option 0 just forces parsing to happen and will always remain working
because it uses the existing interface.

Option 1 was offered as an interim workaround which avoids the parsing.

Option 2 is a non-starter. Your original complaint was that the object
behaviour was wrong, and from your standpoint it is. This is well
demonstrated by your workaround.

Fixing this without changing the published interface is probably the
best way forward. I will revisit the code to see if there is an
efficient way of doing this.

--Dick

 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;08&nbsp;11:55:42&nbsp;2011</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
The following patch should solve the problem nicely, on the
understanding that you have not forced parsing either directly, or
indirectly by calling string, printing or turning on debug flag.


*** /home/rwf/src/Net-DNS-0.66/lib/Net/DNS/Packet.pm    2009-12-30
11:01:39.000000000 +0000
--- ./Packet.pm 2011-12-08 16:34:37.172417186 +0000
***************
*** 138,143 ****
--- 138,146 ----
  
  sub data {
        my $self = shift;
+ 
+       return ${$self-&gt;{buffer}} if $self-&gt;{buffer};           # retransmit raw packet
+ 
        my $data = &#39;&#39;;
        my $header = $self-&gt;{header};
  
 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;27&nbsp;13:22:58&nbsp;2012</span>
    <span class="description">NLNETLABS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Closing because fix is in the current release.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;27&nbsp;13:22:59&nbsp;2012</span>
    <span class="description">NLNETLABS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
