<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #79023 for Test-HTTP-Server-Simple: Patch to allow using Net::Server::Fork</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #79023 for Test-HTTP-Server-Simple: Patch to allow using Net::Server::Fork</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Test-HTTP-Server-Simple">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Test-HTTP-Server-Simple">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Test-HTTP-Server-Simple">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Test-HTTP-Server-Simple">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Test-HTTP-Server-Simple">Test-HTTP-Server-Simple CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">79023</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Test-HTTP-Server-Simple">Test-HTTP-Server-Simple</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dschrag [...] oneupweb.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-31450-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.11    </td>
  </tr>
  <tr id="CF-31451-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




handle_child_pids.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1109865/583571/handle_child_pids.patch">
Thu Aug 16 14:58:40 2012 (2.7k) by http://dmaestro12.myopenid.com/
</a>
</font></li>
</ul>


TestServer.pm<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1109865/583570/TestServer.pm">
Thu Aug 16 14:58:40 2012 (4.4k) by http://dmaestro12.myopenid.com/
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=79023">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1109865" href="/Public/Bug/Display.html?id=79023#txn-1109865">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;16&nbsp;14:58:40&nbsp;2012</span>
    <span class="description">http://dmaestro12.myopenid.com/ -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Patch to allow using Net::Server::Fork</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1109865/583569/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/583569">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is a great module! I was using it to test an application using
HTTP::Async and found I needed my test servers to respond asynchronously
as well to fully test the process. I needed to proxy the requests as
well, so I borrowed a page from the tests for HTTP::Async, as follows:

--- TestServer.pm

  package TestServer;
  use base qw/Test::HTTP::Server::Simple HTTP::Server::Simple::CGI/;

  sub handle_request {
  ... [verbatim]
  }

  sub act_as_proxy {
  ... [verbatim]
  }

  # local modifications follow
  { # lazy monkeypatch - should be done as a proper subclass
    package Net::Server::Fork;

    sub post_bind_hook {
      my &#40;$self&#41; = @_;
      kill &#39;USR1&#39;, $self-&gt;{server}-&gt;{_run_args}-&gt;[0];
    }
  }

  sub background {
    my &#40;$self&#41; = @_; # Test::HTTP::Server::Simple::started_ok&#40;&#41; does not
pass arguments
    $self-&gt;SUPER::background&#40;$self-&gt;{test_http_server_simple_parent_pid}&#41;;
  }

  sub net_server { # for asynchronous request handling - requires this class
    my &#40;$self&#41; = @_;
    &#39;Net::Server::Fork&#39; if $self-&gt;port &#38; 1 ; # odd numbered ports are
forking
  }

  1;

Then, with Test::Class, I used a startup test that opened a TestServer
instance as a local proxy, persistent through all tests. The
setup/teardown methods created and then destroyed additional test server
instances, one per regular test method.

The teardown method was like this:

  sub teardown_server : Test&#40;teardown&#41; {
    my &#40;$self&#41; = @_;
    if &#40;$self-&gt;{server} &#38;&#38; $self-&gt;{server}-&gt;pids&#41; {
      for my $pid &#40;$self-&gt;{server}-&gt;pids&#41; {
        next if $pid == $self-&gt;{proxy_pid};
        kill &#39;USR1&#39;, $pid; # signal to cleanly exit
        waitpid $pid, 0;
      }
    }
    $self-&gt;{server} = undef;
  }

Ultimately I found that killing off a server was likely to kill my proxy
instance as well, because the additional test servers inherited the
@CHILD_PIDS array from the parent process, thinking the parent&#39;s
children were its own when the END { } block ran.

I worked around that by using a different signal in the teardown until
it came time to use Net::Server::Fork. Then I saw I had to fix the
handling of @CHILD_PIDS. The patch converts this array to a hash keyed
on the parent PID &#40;$$&#41;.

Using:
Test-HTTP-Server-Simple-0.11
$ perl -v
This is perl 5, version 12, subversion 3 &#40;v5.12.3&#41; built for
i486-linux-thread-multi
$ uname -a
Linux giuseppe 2.6.37.6-smp #2 SMP Sat Apr 9 23:39:07 CDT 2011 i686
Pentium&#40;R&#41; Dual-Core  CPU      E6300  @ 2.80GHz GenuineIntel GNU/Linux
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> TestServer.pm</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1109865/583570/TestServer.pm">Download TestServer.pm</a><br />
<span class="downloadcontenttype">text/x-perl 4.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use warnings;

# Provide a simple server that can be used to test the various bits.
package TestServer;
use base qw/Test::HTTP::Server::Simple HTTP::Server::Simple::CGI/;

use Time::HiRes qw&#40;sleep time&#41;;
use Data::Dumper;
use LWP::UserAgent;

sub handle_request {
    my &#40; $self, $cgi &#41; = @_;
    my $params = $cgi-&gt;Vars;

    # If we are on port 8081 then we are a proxy - we should forward the
    # requests.
    return act_as_proxy&#40;@_&#41; if $self-&gt;port == 8081;

    # We should act as a final destination server and so expect an absolute URL.
    my $request_uri = $ENV{REQUEST_URI};
    if &#40; $request_uri !~ m!^/! &#41; {
        warn &#34;ERROR - not absolute request_uri &#39;$request_uri&#39;&#34;;
        return;
    }

    # Flush the output so that it goes straight away. Needed for the timeout
    # trickle tests.
    $self-&gt;stdout_handle-&gt;autoflush&#40;1&#41;;

     # warn &#34;START REQUEST - &#34; . time;
     # warn Dumper&#40;$params&#41;;

    # Do the right thing depending on what is asked of us.
    if &#40; exists $params-&gt;{redirect} &#41; {
        my $num = $params-&gt;{redirect} || 0;
        $num--;

        if &#40; $num &gt; 0 &#41; {
            print $cgi-&gt;redirect&#40; -uri =&gt; &#34;?redirect=$num&#34;, -nph =&gt; 1, &#41;;
            print &#34;You are being redirected...&#34;;
        }
        else {
            print $cgi-&gt;header&#40; -nph =&gt; 1 &#41;;
            print &#34;No longer redirecting&#34;;
        }
    }

    elsif &#40; exists $params-&gt;{delay} &#41; {
        sleep&#40; $params-&gt;{delay} &#41;;
        print $cgi-&gt;header&#40; -nph =&gt; 1 &#41;;
        print &#34;Delayed for &#39;$params-&gt;{delay}&#39;.\n&#34;;
    }

    elsif &#40; exists $params-&gt;{trickle} &#41; {

        print $cgi-&gt;header&#40; -nph =&gt; 1 &#41;;

        my $trickle_for = $params-&gt;{trickle};
        my $finish_at   = time + $trickle_for;

        local $| = 1;

        while &#40; time &lt;= $finish_at &#41; {
            print time . &#34; trickle $$\n&#34;;
            sleep 0.1;
        }

        print &#34;Trickled for &#39;$trickle_for&#39;.\n&#34;;
    }

    elsif &#40; exists $params-&gt;{bad_header} &#41; {
        my $headers = $cgi-&gt;header&#40; -nph =&gt; 1, &#41;;

        # trim trailing whitspace to single newline.
        $headers =~ s{ \s* \z }{\n}xms;

        # Add a bad header:
        $headers .= &#34;Bad header: BANG!\n&#34;;

        print $headers . &#34;\n\n&#34;;
        print &#34;Produced some bad headers.&#34;;
    }

    elsif &#40; my $when = $params-&gt;{break_connection} &#41; {

        for &#40;1&#41; {
            last if $when eq &#39;before_headers&#39;;
            print $cgi-&gt;header&#40; -nph =&gt; 1 &#41;;

            last if $when eq &#39;before_content&#39;;
            print &#34;content\n&#34;;
        }
    }

    elsif &#40; my $id = $params-&gt;{set_time} &#41; {
        my $now = time;
        print $cgi-&gt;header&#40; -nph =&gt; 1 &#41;;
        print &#34;$id\n$now\n&#34;;
    }

    elsif &#40; exists $params-&gt;{not_modified} &#41; {
        my $last_modified = HTTP::Date::time2str&#40; time - 60 * 60 * 24 &#41;;
        print $cgi-&gt;header&#40;
            -status         =&gt; &#39;304&#39;,
            -nph            =&gt; 1,
            &#39;Last-Modified&#39; =&gt; $last_modified,
        &#41;;
        print &#34;content\n&#34;;
    }

    else {
        warn &#34;DON&#39;T KNOW WHAT TO DO: &#34; . Dumper $params;
    }

    # warn &#34;STOP REQUEST  - &#34; . time;

}

sub act_as_proxy {
    my &#40; $self, $cgi &#41; = @_;

    my $request_uri = $ENV{REQUEST_URI};

    # According to the RFC the request_uri must be fully qualified if the
    # request is to a proxy and absolute if it is to a destination server. CHeck
    # that this is the case.
    #
    #   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html#sec5.1.2">http://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html#sec5.1.2</a></span>
    if &#40; $request_uri !~ m!^http://! &#41; {
        warn &#34;ERROR - not fully qualified request_uri &#39;$request_uri&#39;&#34;;
        return;
    }

    my $response = LWP::UserAgent-&gt;new&#40; max_redirect =&gt; 0 &#41;-&gt;get&#40;$request_uri&#41;;

    # Add a header so that we know that this was proxied.
    $response-&gt;header&#40; WasProxied =&gt; &#39;yes&#39; &#41;;

    print $response-&gt;as_string;
    return 1;
}

{
  package Net::Server::Fork;

  sub post_bind_hook {
    my &#40;$self&#41; = @_;
    kill &#39;USR1&#39;, $self-&gt;{server}-&gt;{_run_args}-&gt;[0];
  }
}

sub background {
  my &#40;$self&#41; = @_; # Test::HTTP::Server::Simple::started_ok&#40;&#41; does not pass arguments
  $self-&gt;SUPER::background&#40;$self-&gt;{test_http_server_simple_parent_pid}&#41;;
}

sub net_server { # for asynchronous request handling - requires this class
  my &#40;$self&#41; = @_;
  &#39;Net::Server::Fork&#39; if $self-&gt;port &#38; 1 ; # odd numbered ports are forking
}

1;

__END__

This module from the tests of HTTP::Async, which has the following licensing:

Copyright &#40;C&#41; 2006, Edmund von der Burg

This library is free software; you can redistribute it and/or modify
it under the same terms as Perl itself.

</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> handle_child_pids.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1109865/583571/handle_child_pids.patch">Download handle_child_pids.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Test/HTTP/Server/Simple.pm	2009-11-10 14:11:45.000000000 -0500
+++ Test/HTTP/Server/Simple.pm	2012-08-16 12:04:17.000000000 -0400
@@ -58,11 +58,18 @@
 Note that if the child process dies, or never gets around to listening for connections, this
 just hangs.  &#40;This may be fixed in a future version.&#41;
 
-Also, it probably won&#39;t work if you use a custom L&lt;Net::Server&gt; in your server.
+Also, it won&#39;t work if you use a backgrounding L&lt;Net::Server&gt; in your server - the server
+loses track of its child PIDs.
 
 =cut
 
-my @CHILD_PIDS;
+# This used to be a simple private array, but a second test server might think
+# the first server was one of its children &#40;and so on for additional servers&#41;.
+# Unless you terminate all the servers at once, they tend to kill each other
+# off unexpectedly.
+# So we now use a hash indexed by $PROCESS_ID, so only a parent process will
+# see that it has children to kill when it exits.
+my %CHILD_PIDS;
 
 # If an interrupt kills perl, END blocks are not run.  This
 # essentially converts interrupts &#40;like CTRL-C&#41; into a standard
@@ -78,29 +85,29 @@
     if &#40;WIN32&#41; {
         # INT won&#39;t do since the server is doing a blocking read
         # which isn&#39;t interrupted by anything but KILL on win32.
-        kill 9, $_ for @CHILD_PIDS;
+        kill 9, $_ for pids&#40;&#41;;
         sleep 1;
-        foreach &#40;@CHILD_PIDS&#41; {
+        foreach &#40;pids&#40;&#41;&#41; {
             sleep 1 while kill 0, $_;
         }
     }
     else {
-        @CHILD_PIDS = grep {kill 0, $_} @CHILD_PIDS;
-        if &#40;@CHILD_PIDS&#41; {
-            kill &#39;USR1&#39;, @CHILD_PIDS;
+        my @children = grep {kill 0, $_} pids&#40;&#41;;
+        if &#40;@children&#41; {
+            kill &#39;USR1&#39;, @children;
             local $SIG{ALRM} = sub {
                 use POSIX &#34;:sys_wait_h&#34;;
                 my @last_chance = grep { waitpid&#40;$_, WNOHANG&#41; == -1 }
-                    grep { kill 0, $_ } @CHILD_PIDS;
+                    grep { kill 0, $_ } @children;
                 die &#39;uncleaned Test::HTTP::Server::Simple processes: &#39;.join&#40;&#39;,&#39;,@last_chance&#41;
                     if @last_chance;
             };
             alarm&#40;5&#41;;
             eval {
                 my $pid;
-                @CHILD_PIDS = grep {$_ != $pid} @CHILD_PIDS
-                  while $pid = wait and $pid &gt; 0 and @CHILD_PIDS;
-                @CHILD_PIDS = &#40;&#41; if $pid == -1;
+                @children = grep {$_ != $pid} @children
+                  while $pid = wait and $pid &gt; 0 and @children;
+                @children = &#40;&#41; if $pid == -1;
             };
             die $@ if $@;
             alarm&#40;0&#41;;
@@ -158,7 +165,7 @@
         return;
     } 
 
-    push @CHILD_PIDS, $pid;
+    push @{ $CHILD_PIDS{$$} }, $pid;
 
     if &#40;WIN32&#41; {
         $Event-&gt;wait&#40;&#41;;
@@ -202,7 +209,7 @@
 =cut
 
 sub pids {
-    return @CHILD_PIDS;
+    return @{ $CHILD_PIDS{$$} || [] };
 }
 
 =head1 DEPENDENCIES
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.256798</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
