<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #14048 for Class-Std: Coercions fail if the object is created during BEGIN</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #14048 for Class-Std: Coercions fail if the object is created during BEGIN</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Class-Std/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Class-Std/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Class-Std/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Class-Std/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Class-Std">Class-Std CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">14048</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Class-Std/Active/">Class-Std</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
aparker42 [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-7300-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.0.4    </td>
  </tr>
  <tr id="CF-7301-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;08&nbsp;00:26:52&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Coercions fail if the object is created during BEGIN</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It appears that the patch to make the coercions polymorphic caused other problems:

Operation `&#34;&#34;&#39;: no method found, argument in overloaded package Problem at t/begin-coercion.t line 24.  

If an class does its own &#34;use overload&#34; as well as using the Class::Std coercion attributes and the only instance of the object is created during BEGIN time then the coercions won&#39;t work.  This appears to be result of the way the overload module works.  The coercions from Class::Std don&#39;t get properly registered in the %OVERLOAD hash &#40;I&#39;m guessing it is because the code to do the overloads is eval&#39;d in the CHECK phase&#41;.  A bless of the class  will cause the %OVERLOAD to be properly populated, but in this case since the only bless happened at BEGIN before the coercions were in place %OVERLOAD isn&#39;t updated.

I&#39;ve come up with one fix for this: after the coercions for a package have been put in place in the CHECK block in Class::Std simply do &#34;bless {}, $package;&#34;.  It works, but just seems wrong.  Maybe overload provides a better way of forcing the %OVERLOAD hash to be updated?   

Andrew Parker
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use Test::More &#39;no_plan&#39;;

package Problem;
use Class::Std;

# overload seems to interfere as well &#40;remove this and it works&#41;
use overload &#39;+&#39; =&gt; sub {};
sub as_string : STRINGIFY { return &#39;string&#39;; }

package main;

our $obj;
BEGIN { 
    $obj = Problem-&gt;new&#40;&#41;;
}

# use of stringification is what shows the problem
# if another Problem object is created later thowgh, this 
# stringification will work

# Uncomment next line and this will work
#Problem-&gt;new&#40;&#41;;

ok&#40;&#34;$obj&#34;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;09&nbsp;23:44:07&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> aparker42 [...] gmail.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Well, after looking into it some more I couldn&#39;t find any better way to
get it to work.  I changed from using a hashref to an arrayref just to
make it a little lighter weight &#40;I suppose it could also just use ref to
a scalar&#41;.

Attached is the patch including a test

Andrew Parker
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -uNr Class-Std-0.0.4/MANIFEST Class-Std-0.0.4-fix-begin/MANIFEST
--- Class-Std-0.0.4/MANIFEST	Sat Aug  6 21:13:29 2005
+++ Class-Std-0.0.4-fix-begin/MANIFEST	Tue Aug  9 20:35:30 2005
@@ -23,3 +23,4 @@
 t/simple.t
 t/dump.t
 t/access.t
+t/begin-coercion.t
diff -uNr Class-Std-0.0.4/lib/Class/Std.pm Class-Std-0.0.4-fix-begin/lib/Class/Std.pm
--- Class-Std-0.0.4/lib/Class/Std.pm	Sat Aug  6 21:19:22 2005
+++ Class-Std-0.0.4-fix-begin/lib/Class/Std.pm	Tue Aug  9 20:30:23 2005
@@ -354,6 +354,10 @@
             eval sprintf $OVERLOADER_FOR{$attr}, &#40;$package&#41;x2;
             die &#34;Internal error: $@&#34; if $@;
         }
+        # The overloads don&#39;t take effect until the next bless so we 
+        # need to bless here to make sure that if an object was blessed 
+        # before this CHECK runs that it will still be able to get the overloads
+        bless [], $package; 
         delete $overload{$package};
     }
 }
diff -uNr Class-Std-0.0.4/t/begin-coercion.t Class-Std-0.0.4-fix-begin/t/begin-coercion.t
--- Class-Std-0.0.4/t/begin-coercion.t	Wed Dec 31 16:00:00 1969
+++ Class-Std-0.0.4-fix-begin/t/begin-coercion.t	Tue Aug  9 20:40:52 2005
@@ -0,0 +1,20 @@
+# If a single object is created during begin then the coercions should work
+# later.
+
+use Test::More &#39;no_plan&#39;;
+
+package Problem;
+use Class::Std;
+
+# an overload here is also needed to make the problem show up
+use overload &#39;+&#39; =&gt; sub {};
+sub as_string : STRINGIFY { return &#39;string&#39;; }
+
+package main;
+
+my $obj;
+BEGIN { 
+    $obj = Problem-&gt;new&#40;&#41;;
+}
+
+ok&#40;&#34;$obj&#34;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;16&nbsp;22:31:54&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> aparker42 [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">That fix doesn&#39;t fully work.  I&#39;ve discovered that subclasses don&#39;t work
correctly with it.  It seems that the overload information is stored in
each class in the heirarchy and so the subclasses will need to be
blessed as well.

The only way I can think of that is to bless something into every
package available in the system.  That solution doesn&#39;t seem very good,
though.  I can&#39;t think of why it wouldn&#39;t work, but it just seems ugly.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
