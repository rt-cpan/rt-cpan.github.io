<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #38866 for Env-C: segmentation fault on solaris 10 and up</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #38866 for Env-C: segmentation fault on solaris 10 and up</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Env-C/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Env-C/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Env-C/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Env-C/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Env-C">Env-C CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">38866</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Env-C/Active/">Env-C</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">stas [...] stason.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
wez [...] messagesystems.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-12160-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.06    </td>
  </tr>
  <tr id="CF-12161-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;30&nbsp;09:17:41&nbsp;2008</span>
    <span class="description">http://netevil.org/ -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> segmentation fault on solaris 10 and up</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Env-C assumes that there are no native functions for manipulating the
environment on Solaris 10, and this results in a segmentation fault when
running the test script.

The attached patch detects solaris versions that have these functions in
libc by doing the same thing that the stdlib.h header does to reveal the
prototype.  Ideally the Makefile.PL would detect the functions using a
compiler check, but this seems like the simplest approach for the moment.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Env-C.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ur C.xs ../C.xs
--- C.xs	Mon May 23 14:00:29 2005
+++ C.xs	Sat Aug 30 05:58:14 2008
@@ -6,6 +6,27 @@
 #include &lt;stdlib.h&gt; /* setenv/getenv */
 #include &lt;stdio.h&gt;  /* sprintf */
 
+/* configure-less detection of unsetenv for solaris */
+#if defined&#40;sun&#41;
+# if defined&#40;__EXTENSIONS__&#41; ||\
+    &#40;!defined&#40;_STRICT_STDC&#41; &#38;&#38; !defined&#40;__XOPEN_OR_POSIX&#41;&#41; || \
+	    defined&#40;_XPG6&#41;
+#  define HAVE_UNSETENV 1
+#  define HAVE_SETENV 1
+# endif
+#endif
+
+#ifndef HAVE_UNSETENV
+# if !defined&#40;WIN32&#41; &#38;&#38; !defined&#40;sun&#41; &#38;&#38; !defined&#40;_AIX&#41;
+#  define HAVE_UNSETENV 1
+# endif
+#endif
+#ifndef HAVE_SETENV
+# if !defined&#40;WIN32&#41; &#38;&#38; !defined&#40;sun&#41;
+#  define HAVE_SETENV 1
+# endif
+#endif
+
 MODULE = Env::C        PACKAGE = Env::C  PREFIX = env_c_
 
 char *
@@ -27,7 +48,7 @@
     int override
 
     CODE:
-#if defined&#40;WIN32&#41; || defined&#40;sun&#41;
+#if !HAVE_SETENV
     if &#40;override || getenv&#40;key&#41; == NULL&#41; {
         char *old_env = getenv&#40; key &#41;; 
         char *buff = malloc&#40;strlen&#40;key&#41; + strlen&#40;val&#41; + 2&#41;;
@@ -80,7 +101,7 @@
     _putenv&#40;buff&#41;;
     free&#40;buff&#41;;
 #else
-#if !defined&#40; sun &#41; &#38;&#38; !defined&#40; _AIX &#41;
+#if HAVE_UNSETENV
     unsetenv&#40;key&#41;;
 #else
     key_len = strlen&#40;key&#41;;
@@ -120,10 +141,3 @@
     OUTPUT:
     RETVAL
 
-
-
-
-    
-
-
-    
diff -ur test.pl ../test.pl
--- test.pl	Tue Mar  1 20:15:44 2005
+++ test.pl	Sat Aug 30 05:58:43 2008
@@ -1,27 +1,25 @@
 use strict;
 #use warnings;
 
-use Test;
-
-BEGIN { plan tests =&gt; 6 };
+use Test::More tests =&gt; 5;
 use Env::C;
-ok 1 ;
 
 # getenv
 my $key = &#34;USER&#34;;
 my $val_orig = Env::C::getenv&#40;$key&#41; || &#39;&#39;;
-print &#34;# [$key] &#39;$val_orig&#39;\n&#34;;
-ok $val_orig eq $ENV{$key} ? 1 : 0;
+is $val_orig, $ENV{$key}, &#34;getenv matches perl ENV for $key&#34;;
 
 # unsetenv
+diag &#34;unsetting an env&#34;;
 Env::C::unsetenv&#40;$key&#41;;
-my $val = Env::C::getenv&#40;$key&#41; || &#39;&#39;;
-print &#34;# [$key] expecting &#39;&#39;, got &#39;$val&#39;\n&#34;;
-ok $val eq &#39;&#39; ? 1 : 0;
+diag &#34;getting it&#34;;
+my $val = Env::C::getenv&#40;$key&#41;;
+is $val, undef, &#34;$key is no longer set in C env&#34;;
 
 # setenv
 my $val_new = &#34;foobar&#34;;
 Env::C::setenv&#40;$key, $val_new&#41;;
+diag &#34;called setenv&#34;;
 $val = Env::C::getenv&#40;$key&#41; || &#39;&#39;;
 print &#34;# [$key] expecting &#39;$val_new&#39;, got &#39;$val&#39;\n&#34;;
 ok $val eq $val_new ? 1 : 0;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;31&nbsp;18:29:12&nbsp;2008</span>
    <span class="description">stas [...] stason.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">new version 0.07 including your patch has been released - thank you,
nameless contributor.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;31&nbsp;18:29:14&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;31&nbsp;18:29:14&nbsp;2008</span>
    <span class="description">stas [...] stason.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;31&nbsp;18:29:15&nbsp;2008</span>
    <span class="description">stas [...] stason.org -  Given to STAS</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
