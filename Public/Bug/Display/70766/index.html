<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #70766 for Test-Tester: Tested tests that call plan&#40;&#41; cause confusing problems</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #70766 for Test-Tester: Tested tests that call plan&#40;&#41; cause confusing problems</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Test-Tester">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Test-Tester">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Test-Tester">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Test-Tester">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Test-Tester">Test-Tester CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">70766</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Test-Tester">Test-Tester</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ether [...] cpan.org

<br />
RWSTAUNER [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-31640-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.107    </td>
  </tr>
  <tr id="CF-31641-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




tester-plan-output.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/974631/507211/tester-plan-output.txt">
Tue Sep 06 12:14:55 2011 (2.1k) by RWSTAUNER [...] cpan.org
</a>
</font></li>
</ul>


tester-plan-test.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/974631/507212/tester-plan-test.pl">
Tue Sep 06 12:14:55 2011 (935b) by RWSTAUNER [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=70766">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-974631" href="/Public/Bug/Display.html?id=70766#txn-974631">#</a>      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;06&nbsp;12:14:55&nbsp;2011</span>
    <span class="description">RWSTAUNER [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Tested tests that call plan&#40;&#41; cause confusing problems</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/974631/507210/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/507210">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">If any of the tests being tested call plan&#40;&#41; it causes lots of &#40;very
confusing&#41; problems.

Defining a dummy plan&#40;&#41; function on Test::Tester::Delegate or
Test::Tester::Capture made things work ok for me &#40;no pun intended&#41;.

I didn&#39;t notice any mention of plan&#40;&#41; in Test::Tester
so I didn&#39;t know if this was known-behavior or simply hadn&#39;t been addressed.

I don&#39;t know if the solution is to define that function &#40;and possibly do
something with the values&#41; or to merely document that it may be
necessary.  I am not sure how this would affect any subtests that get
run inside of run_tests&#40;&#41; and I am not sure if there would be a general
practice that would be useful for most situations.  Perhaps there is not
and it should simply be a warning in the documentation that says that
plans may need to be handled specially.

The example where I hit this issue:
I was specifically testing that Test::Spelling was operating on the
files I configured... calling pod_file_spelling_ok&#40;&#41; is a simple test
and works just fine.  However, all_pod_files_spelling_ok&#40;&#41; sets the plan
to the number of files it finds because it assumes it is the only test
being run in the file.

I have attached a test file that demonstrates the issue &#40;and its output&#41;.
Any thoughts?
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> tester-plan-output.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/974631/507211/tester-plan-output.txt">Download tester-plan-output.txt</a><br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">    ok 1 - Test &#39;check single&#39; completed
    ok 2 - Test &#39;check single&#39; no premature diagnostication
    ok 3 - Test &#39;check single&#39; result count
    ok 4 - subtest &#39;single&#39; of &#39;check single&#39; compare ok
    ok 5 - subtest &#39;single&#39; of &#39;check single&#39; compare name
    ok 6 - checking depth
    1..6
ok 1 - check_single
Use of uninitialized value $indent in concatenation &#40;.&#41; or string at /home/rando/perl5/perlbrew/perls/5.14.1-st/lib/5.14.1/Test/Builder.pm line 1754.
    not ok 1 - Test &#39;check all default plan&#40;&#41;&#39; completed
    #   Failed test &#39;Test &#39;check all default plan&#40;&#41;&#39; completed&#39;
    #   at t/plan.t line 33.
    # Can&#39;t use an undefined value as a symbol reference at /home/rando/perl5/perlbrew/perls/5.14.1-st/lib/5.14.1/Test/Builder.pm line 1759.
    ok 2 - Test &#39;check all default plan&#40;&#41;&#39; no premature diagnostication
    not ok 3 - Test &#39;check all default plan&#40;&#41;&#39; result count
    #   Failed test &#39;Test &#39;check all default plan&#40;&#41;&#39; result count&#39;
    #   at t/plan.t line 33.
    #          got: 0
    #     expected: 1
    not ok 4 - subtest &#39;&#39; of &#39;check all default plan&#40;&#41;&#39; compare ok
    #   Failed test &#39;subtest &#39;&#39; of &#39;check all default plan&#40;&#41;&#39; compare ok&#39;
    #   at t/plan.t line 33.
    #          got: undef
    #     expected: &#39;1&#39;
    not ok 5 - subtest &#39;&#39; of &#39;check all default plan&#40;&#41;&#39; compare name
    #   Failed test &#39;subtest &#39;&#39; of &#39;check all default plan&#40;&#41;&#39; compare name&#39;
    #   at t/plan.t line 33.
    #          got: undef
    #     expected: &#39;single&#39;
    not ok 6 - checking depth
    #   Failed test &#39;checking depth&#39;
    #   at t/plan.t line 33.
    #          got: undef
    #     expected: &#39;2&#39;
    # You need to change $Test::Builder::Level
    1..6
    # Looks like you failed 5 tests of 6.
not ok 2 - check_all_default
#   Failed test &#39;check_all_default&#39;
#   at t/plan.t line 36.
    ok 1 - Test &#39;check all dummy plan&#40;&#41;&#39; completed
    ok 2 - Test &#39;check all dummy plan&#40;&#41;&#39; no premature diagnostication
    ok 3 - Test &#39;check all dummy plan&#40;&#41;&#39; result count
    ok 4 - subtest &#39;single&#39; of &#39;check all dummy plan&#40;&#41;&#39; compare ok
    ok 5 - subtest &#39;single&#39; of &#39;check all dummy plan&#40;&#41;&#39; compare name
    ok 6 - checking depth
    1..6
ok 3 - check_all_dummy
1..3
# Looks like you failed 1 test of 3.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> tester-plan-test.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/974631/507212/tester-plan-test.pl">Download tester-plan-test.pl</a><br />
<span class="downloadcontenttype">text/x-perl 935b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use warnings;
use Test::Tester;
use Test::More 0.88;

{
  package Test::Tester::TestThingThatCallsPlan;
  use Exporter;
  our @ISA = qw&#40;Exporter&#41;;
  our @EXPORT = qw&#40;single_ok all_ok&#41;;
  my $Test = Test::Builder-&gt;new;
  sub single_ok { $Test-&gt;ok&#40;1, &#39;single&#39;&#41; }
  sub all_ok { $Test-&gt;plan&#40;tests =&gt; 1&#41;; single_ok&#40;&#41;; }
}

Test::Tester::TestThingThatCallsPlan-&gt;import&#40;&#41;;

subtest check_single =&gt; sub {
  check_test&#40;
    sub {
      single_ok&#40;&#41;;
    },
    { ok =&gt; 1, name =&gt; &#39;single&#39;, depth =&gt; 1 },
    &#39;check single&#39;
  &#41;;
};

subtest check_all_default =&gt; sub {
  check_test&#40;
    sub {
      all_ok&#40;&#41;;
    },
    { ok =&gt; 1, name =&gt; &#39;single&#39;, depth =&gt; 2 },
    &#39;check all default plan&#40;&#41;&#39;
  &#41;;
};

subtest check_all_dummy =&gt; sub {
  check_test&#40;
    sub {
      local *Test::Tester::Delegate::plan = sub {};
      all_ok&#40;&#41;;
    },
    { ok =&gt; 1, name =&gt; &#39;single&#39;, depth =&gt; 2 },
    &#39;check all dummy plan&#40;&#41;&#39;
  &#41;;
};

done_testing;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-981051" href="/Public/Bug/Display.html?id=70766#txn-981051">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;24&nbsp;10:01:05&nbsp;2011</span>
    <span class="description">fergal [...] esatclear.ie -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #70766] Tested tests that call plan&#40;&#41; cause confusing problems</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 24 Sep 2011 15:00:55 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Test-Tester [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Fergal Daly &lt;fergal [...] esatclear.ie&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/981051/510827/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/510827">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 504b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

sorry for not getting back sooner, I don&#39;t really do any Perl stuff
any more. Why would your tests set the plan? I&#39;ve never seen that. I
guess if you had a test function that you expect to be the only thing
called in a given .t file it would work but that still sounds odd.

By the way, it looks like the new version of Test-Simple is going to
have testing that&#39;s very similar to Test-Tester, you might want to
raise this use case on the perl-qa list &#40;or wherever mschwern is
dealing with that&#41;,

F
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-981054" href="/Public/Bug/Display.html?id=70766#txn-981054">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;24&nbsp;10:01:06&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-981086" href="/Public/Bug/Display.html?id=70766#txn-981086">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;24&nbsp;13:52:39&nbsp;2011</span>
    <span class="description">RWSTAUNER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/981086/510847/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/510847">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; sorry for not getting back sooner, I don&#39;t really do any Perl stuff
&gt; any more. Why would your tests set the plan? I&#39;ve never seen that. I
&gt; guess if you had a test function that you expect to be the only thing
&gt; called in a given .t file it would work but that still sounds odd.
</div>
That is exactly what I was testing.  There are lots of modules out
there, mostly xt &#40;author or release&#41; tests that are designed to work
like that: you make a boilerplate test file and put that module&#39;s
&#34;all_tests_ok&#40;&#41;&#34; sort of function in the file.

The synopsis for Test::Spelling &#40;which is what I was testing&#41; is a
perfect example:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; use Test::More;
&gt; BEGIN {
&gt;     plan skip_all =&gt; &#34;Spelling tests only for authors&#34;
&gt;         unless -d &#39;inc/.author&#39;;
&gt; }
&gt; 
&gt; use Test::Spelling;
&gt; all_pod_files_spelling_ok&#40;&#41;;
</div>
I was actually testing changes to a Dist::Zilla plugin that generates a
file very much like that and I wanted to confirm that the tests were in
fact getting called &#40;specifically that all my desired files were getting
checked by that call&#41;.

I would not be surprised to hear that I&#39;m the first one who ever tried
to use Test::Tester to do that.  :-&#41;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; By the way, it looks like the new version of Test-Simple is going to
&gt; have testing that&#39;s very similar to Test-Tester, you might want to
&gt; raise this use case on the perl-qa list &#40;or wherever mschwern is
&gt; dealing with that&#41;,
&gt; 
&gt; F
</div>

Ok, I&#39;ll keep that in mind.  Thanks for the heads up!

- R
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-981088" href="/Public/Bug/Display.html?id=70766#txn-981088">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;24&nbsp;13:57:35&nbsp;2011</span>
    <span class="description">RWSTAUNER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/981088/510849/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/510849">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 537b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">You can see lots of examples of test modules that have a similar
synopsis in Dist::Zilla::PluginBundle::TestingMania &#40;which generates a
bunch of these little test files that use the other test modules&#41;.

<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/module/Dist::Zilla::PluginBundle::TestingMania">https://metacpan.org/module/Dist::Zilla::PluginBundle::TestingMania</a></span>

Here&#39;s an example of the generated files:

<span class="clickylink"><a target="new" rel="nofollow" href="http://api.metacpan.org/source/DOHERTY/Dist-Zilla-PluginBundle-TestingMania-0.14/xt/release/">http://api.metacpan.org/source/DOHERTY/Dist-Zilla-PluginBundle-TestingMania-0.14/xt/release/</a></span>

Typically each file is a very small boilerplate file that expects the
real test module to run all the tests &#40;and set the plan&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-981386" href="/Public/Bug/Display.html?id=70766#txn-981386">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;25&nbsp;06:02:20&nbsp;2011</span>
    <span class="description">fergal [...] esatclear.ie -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #70766] Tested tests that call plan&#40;&#41; cause confusing problems</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 25 Sep 2011 11:02:11 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Test-Tester [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Fergal Daly &lt;fergal [...] esatclear.ie&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/981386/511002/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/511002">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The purpose of the plan is to make sure the expected number of tests
are run. To make sure that the test file&#39;s _author_ does not have a
bug in his test file such that some tests get skipped. So in the
examples you give the plan should be for 1 test.

The reason people have done otherwise is because there&#39;s no good way
to do subplans &#40;e.g. this test has N parts&#41;.

In Test::Spelling for example, it could be refactored so that
all_pod_files_spelling_ok calls $TEST-&gt;ok just once, passing if all
files are OK. This would bring it into line with correct plan
practice, it would make it possible to call other tests in the same
file and it would eliminate the BEGIN block from the code example you
gave which would then be

use Test::More test =&gt; 1;
use Test::Spelling

SKIP: {
  skip &#34;Spelling tests only for authors&#34; unless -d &#39;inc/.author&#39;;
  all_pod_files_spelling_ok&#40;&#41;;
}

I think nothing is lost by doing it this way. If Test::Spelling dies
half way through one of the files the overall test still fails and the
plan is violated.

Anyway, since this seems to be a common practice, I don&#39;t mind
supporting testing planning but I have no time to do it. If you want
to send a patch, I will make release and upload it,

F
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-992462" href="/Public/Bug/Display.html?id=70766#txn-992462">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;26&nbsp;18:00:45&nbsp;2011</span>
    <span class="description">RWSTAUNER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/992462/516838/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/516838">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 710b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve put patching this into my &#34;queue&#34;,
but I haven&#39;t had the time yet,
and I haven&#39;t given any thought to the API yet.

However I did just run into another issue with it,
so I think I probably will do something,
just need to figure out what,
and find the time to implement.

Originally I had simply defined plan&#40;&#41; to an empty sub
so that it would essentially be ignored if called.

That worked fine for plans that declare the number of tests,
but again I got very confused at the mass of angry output when the plan
was for &#39;skip_all&#39;.

That&#39;s something else I need to keep in mind as I try to determine a
useful API.  Thanks for the help, and hopefully you&#39;ll hear from me
again sometime soon with a patch ;-&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1210854" href="/Public/Bug/Display.html?id=70766#txn-1210854">#</a>      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;11&nbsp;21:20:12&nbsp;2013</span>
    <span class="description">ether [...] cpan.org -  Requestor ETHER added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1210856" href="/Public/Bug/Display.html?id=70766#txn-1210856">#</a>      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;11&nbsp;21:33:06&nbsp;2013</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1210856/639428/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/639428">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve run into this too, when attempting to write tests for Test::Kwalitee before undertaking a big refactoring effort.

Test::Kwalitee also calls plan&#40;&#41; directly -- right in its import sub, even!!!

In light of this open ticket, I think the best recourse is to change Test::Kwalitee to not call plan&#40;&#41;, and instead, call done_testing in an END block &#40;which will occur after Test::Tester has done its thing&#41;.

I agree it&#39;s bad practice for Test modules to create their own plan -- unfortunately, many of them do it, and to alter this behaviour will break everyone who is using these tests &#40;less of a big deal with autogenerated tests, as we can fix the generator, but there&#39;s *lots* of manual users of these tests too&#41;.

These are the bad ones that I&#39;m using in just one dist that I checked:

Test::Spelling
Test::CPAN::Meta
Test::EOL
Test::MinimumVersion
Test::NoTabs
Test::Pod


The only option that I can see is to create a major version bump in the module, and keep the old behaviour if the explicit version is not specified, e.g.:

    use Test::Kwalitee;   # creates a plan for itself, and also warns the user they should upgrade

but

    use Test::Kwalitee 2; # no plan - you must call done_testing yourself
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.49388</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
