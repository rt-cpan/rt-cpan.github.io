<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #75606 for File-Tail-App: PATCH: fix poor handling of &#34;0 but true&#34;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #75606 for File-Tail-App: PATCH: fix poor handling of &#34;0 but true&#34;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/File-Tail-App/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/File-Tail-App/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/File-Tail-App/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/File-Tail-App/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/File-Tail-App">File-Tail-App CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">75606</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/File-Tail-App/Active/">File-Tail-App</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
kcason [...] yahoo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-13192-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.4</li>
<li>
v0.0.1</li>
<li>
v0.0.2</li>
<li>
v0.0.3</li>
</ul>
    </td>
  </tr>
  <tr id="CF-13193-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;07&nbsp;12:54:50&nbsp;2012</span>
    <span class="description">kcason [...] yahoo.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Discovered this bug in v0.0.3 but it is also in v0.4.

Environment:

Linux 2.6.9-89.0.9.ELsmp #1 SMP Wed Aug 19 08:07:15 EDT 2009 i686 i686 
i386 GNU/Linux
This is perl, v5.8.5 built for i386-linux-thread-multi

Situation:

The lastrun file values, if zero, sometimes get the value &#34;0 but true&#34;. 
This is a Perl feature that allows boolean comparisons but, in this 
case, causes the md5 check to process the first record in the input 
file over and over and over...

There is a discussion of &#34;0 but true&#34; here:
<span class="clickylink"><a target="new" rel="nofollow" href="http://stackoverflow.com/questions/5318011/why-does-perl-think-0-but-">http://stackoverflow.com/questions/5318011/why-does-perl-think-0-but-</a></span>
true-is-a-number

In this case, the lastrun file looks something like this:
   &#34;0 but true&#34;-1803087-145add8648ec9426016a019c3d0693aa-42
but was expected to look like this:
   0-1803087-145add8648ec9426016a019c3d0693aa-42

The reason is the lastrun file values are expected to be integers, 
but &#34;0 but true&#34; is not an integer. Therefore, the following scenario 
presents itself:

1&#41; A variable is set to zero, ex: fileStart=0;
2&#41; That variable is inadvertantly written to the lastrun file as 
boolean, which is valid as &#34;0 but true&#34;, but not an integer.
3&#41; The next iteration through the program the lastrun file is read, ex: 
lastFileStart=&#34;0 but true&#34;;
4&#41; A comparison of:
    if &#40;fileStart eq lastFileStart&#41;
  is expected to be 
    if &#40;0 eq 0&#41;  &lt;-- which is true
  is actually
    if &#40;0 eq &#34;0 but true&#34;&#41;  &lt;-- which is false

Proposal:

Use the int&#40;&#41; function to ensure lastrun values are integers instead of 
boolean. For instance, see line #4 below:

1 sub _set_lastrun_data {
2    my&#40;$new_posi, $file_ident, $md5_chk, $md5_len, $cur_file&#41; = @_;
3    $md5_chk ||= 0;
4    $new_posi = int&#40;&#34;$new_posi&#34;&#41;; # avoid &#34;0 but true&#34; situation
5
6    open my $curpos_fh, &#39;&gt;&#39;, $cur_file
7        or Carp::croak &#34;Could not write $cur_file: $!&#34;;
8    print {$curpos_fh} qq&#40;$new_posi-$file_ident-$md5_chk-$md5_len&#41;;
9    close $curpos_fh;
}

I&#39;ve tested this and it appears to fix the bug. There are several 
places in the code where I added the int&#40;&#41; function, and that code is 
include as an attachement with the assignment of v0.5.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> App.pm</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">package File::Tail::App;

use strict;
use warnings;

use File::Tail;
use Carp &#40;&#41;;

sub import {
    my $caller = caller&#40;&#41;;
    no strict &#39;refs&#39;;
    *{ $caller . &#39;::tail_app&#39; } = \&#38;tail_app;
}

$File::Tail::App::VERSION = &#39;0.5&#39;;

sub File::Tail::seek_to {
    my&#40;$tail, $seek_to&#41; = @_;
    # work around possible &#34;0 but true&#34; value for $seek_to
    if &#40;$seek_to&#41; { $seek_to = int&#40;&#34;$seek_to&#34;&#41;; }
    Carp::croak &#39;argument to seek_to&#40;&#41; must be all digits&#39; if $seek_to !~ m/^\d+$/;
    $tail-&gt;{&#39;curpos&#39;} = sysseek $tail-&gt;{&#39;handle&#39;}, $seek_to, 0;
}

sub File::Tail::app {
    my&#40;$tail, $args_ref&#41; = @_;

    $args_ref-&gt;{&#39;line_handler&#39;} = sub { print shift; }
        if !$args_ref-&gt;{&#39;line_handler&#39;};
    Carp::croak &#39;&#34;line_handler&#34; must be a code ref&#39;
        if ref $args_ref-&gt;{&#39;line_handler&#39;} ne &#39;CODE&#39;;

    $args_ref-&gt;{&#39;verbose&#39;} = 0 if !defined $args_ref-&gt;{&#39;verbose&#39;};

    my $lastrun_file = $args_ref-&gt;{&#39;lastrun_file&#39;};
    my $do_md5_check = $args_ref-&gt;{&#39;do_md5_check&#39;} || 0;

    my&#40;$previous_position, $file_ident, $md5_chk, $md5_len&#41; 
        = defined $lastrun_file ? _get_lastrun_data&#40;$tail-&gt;{&#39;input&#39;}, 
                                                    $lastrun_file,
                                                    $do_md5_check, 
                                                    $tail&#41;
                                : &#40;&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;&#41;;

    $args_ref-&gt;{&#39;seek_on_zero&#39;} = 1 if !exists $args_ref-&gt;{&#39;seek_on_zero&#39;};
    if&#40;exists $args_ref-&gt;{&#39;seek_to&#39;} &#38;&#38; defined $args_ref-&gt;{&#39;seek_to&#39;}&#41; {
        if&#40;$args_ref-&gt;{&#39;seek_to&#39;} eq &#39;0&#39; &#38;&#38; $args_ref-&gt;{&#39;seek_on_zero&#39;}&#41; {
            $tail-&gt;seek_to&#40;$args_ref-&gt;{&#39;seek_to&#39;}&#41;;
        }
        elsif&#40;$args_ref-&gt;{&#39;seek_to&#39;} =~ m/^\d+$/&#41; {
            $tail-&gt;seek_to&#40;$args_ref-&gt;{&#39;seek_to&#39;}&#41;;
        }
    }

    my $start_size   = -s $tail-&gt;{&#39;input&#39;};
    my $start_handle = $tail-&gt;{&#39;handle&#39;}; 

    $tail-&gt;seek_to&#40;$previous_position&#41; if $previous_position ne $start_size
                                          &#38;&#38; $previous_position ne &#39;&#39;;

    while&#40; defined&#40; my $line = $tail-&gt;read&#40;&#41; &#41; &#41; {
        my @stat = stat $tail-&gt;{&#39;input&#39;};
        my $replaced = 0;
        if&#40;-s $tail-&gt;{&#39;input&#39;} &lt; $start_size&#41; {
            Carp::carp &#34;$tail-&gt;{&#39;input&#39;} was truncated: &#34; . sysseek&#40;$tail-&gt;{&#39;handle&#39;},0,1&#41;
                if $args_ref-&gt;{&#39;verbose&#39;};
            $tail-&gt;seek_to&#40;length $line&#41;; 
            $replaced++;
        } 
        elsif&#40;$do_md5_check &#38;&#38; $md5_chk ne _get_md5_info&#40;$tail, 
                                                       $md5_len, 
                                                       $do_md5_check&#41;&#41; {
            Carp::carp &#34;MD5 Check changed: &#34; . sysseek&#40;$tail-&gt;{&#39;handle&#39;},0,1&#41;
                if $args_ref-&gt;{&#39;verbose&#39;};
            $replaced++;
        }

        if&#40;$replaced&#41; {
            $tail-&gt;seek_to&#40;length $line&#41;;
            $start_size = $stat[7];
            $md5_len = $stat[7] &lt; 42  ? $stat[7] : 42;
            $md5_chk = _get_md5_info&#40;$tail, $md5_len, $do_md5_check&#41;;
        }

        # do simple checks then tell them about it &#38; reset some vars if needed
        if&#40;$stat[1] ne $file_ident &#38;&#38; $file_ident&#41; {
            Carp::carp &#34;$tail-&gt;{&#39;input&#39;} was replaced: &#34; . sysseek&#40;$tail-&gt;{&#39;handle&#39;},0,1&#41; 
                if $args_ref-&gt;{&#39;verbose&#39;};
            $file_ident = $stat[1];
        }
 
        if&#40;$start_handle ne $tail-&gt;{&#39;handle&#39;}&#41; {
            # checking descriptor via fileno&#40;&#41; is same check but numerically
            Carp::carp &#34;descriptor/handle changed: &#34; . sysseek&#40;$tail-&gt;{&#39;handle&#39;},0,1&#41;
                if $args_ref-&gt;{&#39;verbose&#39;};
            $start_handle = $tail-&gt;{&#39;handle&#39;};
        }

        $args_ref-&gt;{&#39;line_handler&#39;}-&gt;&#40;$line&#41;;
        _set_lastrun_data&#40; 
                           sysseek&#40;$tail-&gt;{&#39;handle&#39;},0,1&#41;,
                           $file_ident,
                           $md5_chk, 
                           $md5_len, 
                           $lastrun_file
                         &#41; if defined $lastrun_file;
        Carp::carp &#34;$tail-&gt;{&#39;input&#39;} is at : &#34; . sysseek&#40;$tail-&gt;{&#39;handle&#39;},0,1&#41;
            if $args_ref-&gt;{&#39;verbose&#39;} &gt; 1;
    }   
}

sub tail_app {
    my &#40;$args_ref&#41; = @_;

    Carp::croak &#39;tail_app&#40;&#41; requires a hashref as its first argument&#39; 
        if ref $args_ref ne &#39;HASH&#39;;

    Carp::croak &#39;missing &#34;new&#34; key from tail_app arg&#39; if !exists $args_ref-&gt;{&#39;new&#39;};
    Carp::croak &#39;&#34;new&#34; must be an array ref&#39; if ref $args_ref-&gt;{&#39;new&#39;} ne &#39;ARRAY&#39;;

    my $tail = File::Tail-&gt;new&#40;@{ $args_ref-&gt;{&#39;new&#39;} }&#41; 
        or Carp::croak &#34;Could not create File::Tail object: $!&#34;;

    $tail-&gt;app&#40;{
        &#39;line_handler&#39; =&gt; $args_ref-&gt;{&#39;line_handler&#39;},
        &#39;verbose&#39;      =&gt; $args_ref-&gt;{&#39;verbose&#39;},
        &#39;seek_to&#39;      =&gt; $args_ref-&gt;{&#39;seek_to&#39;},
        &#39;seek_on_zero&#39; =&gt; $args_ref-&gt;{&#39;seek_on_zero&#39;},
        &#39;lastrun_file&#39; =&gt; $args_ref-&gt;{&#39;lastrun_file&#39;}, 
        &#39;do_md5_check&#39; =&gt; $args_ref-&gt;{&#39;do_md5_check&#39;},
    }&#41;;
}

sub _get_lastrun_data {
    my&#40;$tail_file, $cur_file, $do_md5_check, $tail&#41; = @_;

    my @stat              = stat $tail_file;
    my $previous_position = 0; # start at zero if 1st time ...
    my $cur_tail_ident    = $stat[1]; #:$stat[10]# or if file&#39;s changed
    my $_md5_len          = $stat[7] &lt; 42  ? $stat[7] : 42; 
    my $_md5_chk          = _get_md5_info&#40;$tail, $_md5_len, $do_md5_check&#41;;

    my&#40;$curpos, $logged_ident, $md5_chk, $md5_len&#41; = &#40;&#39;&#39;,&#39;&#39;,$_md5_chk,$_md5_len&#41;;
    if&#40;-e $cur_file&#41; {
        open my $curat_fh, &#39;&lt;&#39;, $cur_file 
            or Carp::croak &#34;Could not read $cur_file: $!&#34;;
        chomp&#40;my $first_line = &lt;$curat_fh&gt;&#41;;
        close $curat_fh;

        &#40;$curpos, $logged_ident, $md5_chk, $md5_len&#41; = split /-/, $first_line;
        $curpos = 0 if $logged_ident ne $cur_tail_ident;
        $previous_position = int&#40;$curpos&#41;;
       
        if&#40;$do_md5_check&#41; {
           $md5_len = $_md5_len if !defined $md5_len || !$md5_len; 
           $md5_chk = $_md5_chk if !defined $md5_chk || !$md5_chk;
        }
    }

    return &#40;$previous_position, $cur_tail_ident, $md5_chk, $md5_len&#41;;
}

sub _set_lastrun_data {
    my&#40;$new_posi, $file_ident, $md5_chk, $md5_len, $cur_file&#41; = @_;
    $md5_chk ||= 0;
    $new_posi = int&#40;&#34;$new_posi&#34;&#41;; # avoid &#34;0 but true&#34; situation

    open my $curpos_fh, &#39;&gt;&#39;, $cur_file 
        or Carp::croak &#34;Could not write $cur_file: $!&#34;;
    print {$curpos_fh} qq&#40;$new_posi-$file_ident-$md5_chk-$md5_len&#41;;
    close $curpos_fh;
}

sub _get_md5_info {
    my&#40;$tail, $md5_len, $do_md5_check&#41; = @_;

    return if !$do_md5_check;
    require Digest::MD5; # only do the module if needed

    my $data_to_md5 = &#39;&#39;; # to avoid uninitialized value warnings
    my $origpos = sysseek&#40;$tail-&gt;{&#39;handle&#39;},0,1&#41;;

    $tail-&gt;seek_to&#40;0&#41;;
    sysread $tail-&gt;{&#39;handle&#39;}, $data_to_md5, $md5_len;
    $tail-&gt;seek_to&#40;$origpos&#41;;

    return Digest::MD5::md5_hex&#40;$data_to_md5&#41;;
}

1;

__END__

=head1 NAME

File::Tail::App - Perl extension for making apps that tail files

=head1 SYNOPSIS

   use File::Tail::App;

   tail_app&#40;{
       &#39;new&#39;          =&gt; [&#39;logfile.log&#39;],
       &#39;line_handler&#39; =&gt; \&#38;_wag_tail,
   }&#41;;

   sub _wag_tail {
       my&#40;$line&#41; = @_;
       # do what you want with the $line
   }

=head1 DESCRIPTION

Adds two methods for a File::Tail object and one function.

=head2 tail_app&#40;&#41;

As in the SYNOPSIS, creates an app that processes a file&#39;s tail line by line.

Its only arg is a hashref with these keys:

=over 4

=item new

Required.
This is an array ref of the array you give to File::Tail&#39;s new method.

=item line_handler

This is a code ref that takes the current line in a string as its only argument. if you do not specify this the line is simply printed out.

=item seek_to

Before you start processing the file you can sysseek to this part of the file.

Like sysseek&#40;&#41;, its value is in bytes. 

=item seek_on_zero

If this is false and seek_to is 0, then don&#39;t $tail-&gt;seek_to&#40;&#41; it, 
Default is 1. 

=item lastrun_file

This is a file that is used to track the current position. It is recommended to use this so that if the program is terminated unexpectedly it can resume exactly where it left off so you will avoid duplicated or missing data.

If you&#39;d rather do this your self the you&#39;ll need to get the current position before the call to app and send it via the seek_to key and log the new length at the end of your line processing function. You&#39;ll also need to be able to tell if the file you&#39;re tailing changes drastically because say you are currently at 12345 and the script is killed and then the log file is truncated before it is restarted. You don&#39;t want to start at 12345 in that case, you want to start at 0. 

The lastrun_file parameter handles all of that and more for you. Feel free to take a look at how it works if you need to write your own for some reason, like you want to use SQL DB instead of a file, etc etc...

=item do_md5_check

If using lastrun_file also do a check on the MD5 sum of a small part of data in the beginning of the file to see if its been truncated and handle appropriately. &#40;Thanks to Ben Thomas for the MD5 idea!!&#41;

=back

=head2 $tail-&gt;app&#40;&#41;

Same args as tail_app except for the &#34;new&#34; key since you&#39;ve already create the File::Tail object.

=head2 $tail-&gt;seek_to&#40;&#41;

Given a digit, it will move to that position in the $tail object&#39;s handle. Useful for resuming where you left off.

Like sysseek&#40;&#41;, its argument is in bytes.

=head2 EXPORT

None by default.

tail_app can be exported.

=head1 EXAMPLE

This example will process x.log as its updated. To avoid double logging it only allows one instance of itself to be run &#40;See L&lt;Unix::PID&gt;&#41;. To avoid missing
 or double processing data if a problem arises it uses a lastrun file. So this is a pretty sturdy, reliable, and easy to code log processor:

    #!/usr/bin/perl

    use strict;
    use warnings;

    use Unix::PID &#39;/var/run/xlogr.pid&#39;;
    use File::Tail::App qw&#40;tail_app&#41;;

    tail_app&#40;{
        &#39;new&#39;          =&gt; [&#39;x.log&#39;],
        &#39;line_handler&#39; =&gt; \&#38;_wag_tail,
        &#39;lastrun_file&#39; =&gt; &#39;x.lastrun&#39;,
    }&#41;;

    sub _wag_tail {
        my&#40;$line&#41; = @_;
        # do what you want with the $line
    }

=head1 BUGS

This was stress tested pretty vigorously for various circumstances so it should be pretty solid. If you do come across a problem please contact me with the code and steps neccessary to reproduce the bug so I can release a fix ASAP.

=head1 SEE ALSO

L&lt;File::Tail&gt;

=head1 AUTHOR

Daniel Muey, L&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://drmuey.com/cpan_contact.pl">http://drmuey.com/cpan_contact.pl</a></span>&gt;

=head1 COPYRIGHT AND LICENSE

Copyright 2005 by Daniel Muey

This library is free software; you can redistribute it and/or modify
it under the same terms as Perl itself. 

=cut
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;23&nbsp;15:42:22&nbsp;2014</span>
    <span class="description">ether [...] cpan.org -  Subject changed from &#40;no value&#41; to &#39;PATH: fix poor handling of &#34;0 but true&#34;&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;23&nbsp;17:18:57&nbsp;2014</span>
    <span class="description">ether [...] cpan.org -  Subject changed from &#39;PATH: fix poor handling of &#34;0 but true&#34;&#39; to &#39;PATCH: fix poor handling of &#34;0 but true&#34;&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
