<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #66016 for Test-TCP: Tests fail on Windows &#40;even when they pass?&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #66016 for Test-TCP: Tests fail on Windows &#40;even when they pass?&#41;</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Test-TCP">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Test-TCP">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Test-TCP">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Test-TCP">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/tokuhirom/Test-TCP/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Test-TCP">Test-TCP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">66016</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Test-TCP">Test-TCP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mkanat [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
JDB [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-223460-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.11    </td>
  </tr>
  <tr id="CF-223461-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=66016">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-901180" href="/Public/Bug/Display.html?id=66016#txn-901180">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;21&nbsp;21:09:29&nbsp;2011</span>
    <span class="description">mkanat [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Tests fail on Windows &#40;even when they pass?&#41;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/901180/467361/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/467361">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 346b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">It looks like the tests for Test-TCP frequently end with &#34;Dubious, test 
returned 9 &#40;wstat 2304, 0x900&#41;&#34; even when they have passed, on Windows:

<span class="clickylink"><a target="new" rel="nofollow" href="http://ppm4.activestate.com/MSWin32-x86/5.12/1200/T/TO/TOKUHIROM/Test-">http://ppm4.activestate.com/MSWin32-x86/5.12/1200/T/TO/TOKUHIROM/Test-</a></span>
TCP-1.11.d/log-20101221T221845.txt

This looks to be the current blocker for getting Plack to be installable 
on Windows via PPM.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-905989" href="/Public/Bug/Display.html?id=66016#txn-905989">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;17:22:28&nbsp;2011</span>
    <span class="description">bo.johansson [...] lsn.se -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bo.johansson [...] lsn.se</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/905989/469984/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/469984">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 861b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Vid Mon, 21 Feb 2011 kl. 21.09.29, skrev MKANAT:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It looks like the tests for Test-TCP frequently end with &#34;Dubious, test 
&gt; returned 9 &#40;wstat 2304, 0x900&#41;&#34; even when they have passed, on Windows:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://ppm4.activestate.com/MSWin32-x86/5.12/1200/T/TO/TOKUHIROM/Test-">http://ppm4.activestate.com/MSWin32-x86/5.12/1200/T/TO/TOKUHIROM/Test-</a></span>
&gt; TCP-1.11.d/log-20101221T221845.txt
&gt; 
&gt; This looks to be the current blocker for getting Plack to be installable 
&gt; on Windows via PPM.
</div>
Had also problems with the test t/08_exit.t. It is blocking on Windows
7. Trying to find the problem using warn statements, I found it seemed
to work much better.

Added a sleep statement in t/08_exit.t &#40;marked below&#41; and the test run
much better. Is it a timing problem?

else { # child
    test_tcp&#40;
        client =&gt; sub {
            my $port = shift;
            note &#34;CLIENT: $$&#34;;
            sleep 1; &lt;========
            exit 1;
        },
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-905992" href="/Public/Bug/Display.html?id=66016#txn-905992">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;17:22:29&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-906158" href="/Public/Bug/Display.html?id=66016#txn-906158">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;22:38:33&nbsp;2011</span>
    <span class="description">tokuhirom [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66016] Tests fail on Windows &#40;even when they pass?&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 3 Mar 2011 12:38:23 +0900</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Test-TCP [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tokuhiro Matsuno &lt;tokuhirom [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/906158/470041/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/470041">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 970b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is a issue around leaking $?. But Test::TCP already added &#34;local
$?&#34; in process management. It&#39;s maybe ActivePerl&#39;s issue.

On Tue, Feb 22, 2011 at 11:09 AM, Max Kanat-Alexander via RT
&lt;bug-Test-TCP@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Mon Feb 21 21:09:29 2011: Request 66016 was acted upon.
&gt; Transaction: Ticket created by MKANAT
&gt; Â  Â  Â  Queue: Test-TCP
&gt; Â  Â  Subject: Tests fail on Windows &#40;even when they pass?&#41;
&gt; Â  Broken in: 1.11
&gt; Â  Â Severity: Critical
&gt; Â  Â  Â  Owner: Nobody
&gt; Â Requestors: mkanat@cpan.org
&gt; Â  Â  Â Status: new
&gt; Â Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66016">https://rt.cpan.org/Ticket/Display.html?id=66016</a></span> &gt;
&gt;
&gt;
&gt; It looks like the tests for Test-TCP frequently end with &#34;Dubious, test
&gt; returned 9 &#40;wstat 2304, 0x900&#41;&#34; even when they have passed, on Windows:
&gt;
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://ppm4.activestate.com/MSWin32-x86/5.12/1200/T/TO/TOKUHIROM/Test-">http://ppm4.activestate.com/MSWin32-x86/5.12/1200/T/TO/TOKUHIROM/Test-</a></span>
&gt; TCP-1.11.d/log-20101221T221845.txt
&gt;
&gt; This looks to be the current blocker for getting Plack to be installable
&gt; on Windows via PPM.
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-908193" href="/Public/Bug/Display.html?id=66016#txn-908193">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;08&nbsp;21:03:54&nbsp;2011</span>
    <span class="description">JDB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> tokuhirom [...] gmail.com, bo.johansson [...] lsn.se</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/908193/471152/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/471152">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Mar 02 22:38:33 2011, tokuhirom@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is a issue around leaking $?. But Test::TCP already added &#34;local
&gt; $?&#34; in process management. It&#39;s maybe ActivePerl&#39;s issue.
</div>
I can reproduce the problem with the latest bleadperl, compiled with
Microsoft VC6 on Windows 2000.

The problem is *not* a leaking $?.  I have verified that the return
value of the Perl main&#40;&#41; function is actually correct &#40;0&#41;.  However, the
waitpid&#40;&#41; function in the parent does indeed sometimes receive a
different value &#40;9&#41;.

This only happens when the code is running under Test::Harness.  I have
further simplified the setup to trigger the issue to this driver
program, using IPC::Open3 directly &#40;the same way TAP::Parser does&#41;:

#!perl
use strict;
use warnings;

use IPC::Open3;
use IO::Handle;

$ENV{PERL5LIB} = &#34;blib/lib&#34;;
my $out = IO::Handle-&gt;new;
my $pid = open3&#40;&#34;&lt;&#38;STDIN&#34;, $out, &#34;&gt;&#38;STDERR&#34;, @ARGV&#41;;

while &#40;&#41; {
    last unless defined&#40; my $line = &lt;$out&gt; &#41;;
    print &#34;# $line&#34;;
}

my $wpid = waitpid&#40; $pid, 0 &#41;;
print &lt;&lt;EOT;
pid=$pid
wpid=$wpid
\$?=$?
EOT
__END__

Run with `perl tst.pl perl -w t/04_die.t`

The problem goes away if instead of the $out filehandle I simply pass
&#34;&gt;&#38;STDOUT&#34; &#40;and remove the loop reading from $out&#41;.  I&#39;ve starred for a
long time at the win32_waitpid&#40;&#41; implementation, and can&#39;t find any
fault there.

I also did lots more experiments, calling ExitProcess&#40;&#41; directly to
bypass CRT cleanup etc, but the issue never went away.  So I have no
idea where the code lives, that seems to be changing the exit status
post-mortem.  It does feel like a bug in either Windows, or the MSVCRT
runtime library.

However, I did find a workaround to get all the tests to pass: adding a
simple sleep&#40;1&#41; call to the end of Test::TCP::stop&#40;&#41; makes all tests
pass; the $? fiddling done by the latest release is not necessary.

So I would recommend adding something like this:

    sleep&#40;1&#41; if $^O eq &#34;MSWin32&#34;;

and forget about it, even if we don&#39;t manage to fully understand it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-908197" href="/Public/Bug/Display.html?id=66016#txn-908197">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;08&nbsp;21:05:04&nbsp;2011</span>
    <span class="description">JDB [...] cpan.org -  Cc JDB added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-908544" href="/Public/Bug/Display.html?id=66016#txn-908544">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;09&nbsp;13:59:58&nbsp;2011</span>
    <span class="description">JDB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/908544/471318/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/471318">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 499b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Mar 08 21:03:54 2011, JDB wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So I would recommend adding something like this:
&gt; 
&gt;     sleep&#40;1&#41; if $^O eq &#34;MSWin32&#34;;
&gt; 
&gt; and forget about it, even if we don&#39;t manage to fully understand it.
</div>
I added this patch via the distroprefs mechanism to the ActiveState PPM
build machines, and all Windows builds succeeded now:

<span class="clickylink"><a target="new" rel="nofollow" href="http://code.activestate.com/ppm/Test-TCP/">http://code.activestate.com/ppm/Test-TCP/</a></span>

Sample build log:

<span class="clickylink"><a target="new" rel="nofollow" href="http://ppm4.activestate.com/MSWin32-x86/5.12/1200/T/TO/TOKUHIROM/Test-TCP-1.12.d/log-20110308T181913.txt">http://ppm4.activestate.com/MSWin32-x86/5.12/1200/T/TO/TOKUHIROM/Test-TCP-1.12.d/log-20110308T181913.txt</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-908686" href="/Public/Bug/Display.html?id=66016#txn-908686">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;10&nbsp;02:28:18&nbsp;2011</span>
    <span class="description">bo.johansson [...] lsn.se -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bo.johansson [...] lsn.se</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/908686/471384/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/471384">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Vid ons, 09 Mar 2011 kl. 13.59.58, skrev JDB:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Mar 08 21:03:54 2011, JDB wrote:
<div class="message-stanza open">&gt; &gt; So I would recommend adding something like this:
&gt; &gt;
&gt; &gt;     sleep&#40;1&#41; if $^O eq &#34;MSWin32&#34;;
&gt; &gt;
&gt; &gt; and forget about it, even if we don&#39;t manage to fully understand it.
</div>&gt; 
&gt; I added this patch via the distroprefs mechanism to the ActiveState
&gt; PPM
&gt; build machines, and all Windows builds succeeded now:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://code.activestate.com/ppm/Test-TCP/">http://code.activestate.com/ppm/Test-TCP/</a></span>
&gt; 
&gt; Sample build log:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://ppm4.activestate.com/MSWin32-x86/5.12/1200/T/TO/TOKUHIROM/Test-">http://ppm4.activestate.com/MSWin32-x86/5.12/1200/T/TO/TOKUHIROM/Test-</a></span>
&gt; TCP-1.12.d/log-20110308T181913.txt
</div>

I have used the proposed change and most of the tests are still
blocking. The test 08_exit.t is blocking about one of three times. The
tests 01_simple.t  t/09_fork.t t/10_oo.t are blocking with lower
frequency of about one of 60 times. 

I am using:
Strawberry-perl-5.12.2.0
Perl 5, version 12, subversion 2 &#40;v5.12.2&#41; built for
MSWin32-x86-multi-thread
Windows 7 Home Premium with Service Pack 1

See also <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=66437">https://rt.cpan.org/Public/Bug/Display.html?id=66437</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-908976" href="/Public/Bug/Display.html?id=66016#txn-908976">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;10&nbsp;18:54:38&nbsp;2011</span>
    <span class="description">JDB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> tokuhirom [...] gmail.com, bo.johansson [...] lsn.se</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/908976/471530/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/471530">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Alright, I think I&#39;ve figured it all out now...

Here are 2 minimal test cases for ActivePerl that reproduce the &#39;9&#39; exit
code:

Windows 2000:
system $^X,  &#34;-e&#34;, &#34;if &#40;\$pid=fork&#41;{sleep 1;kill&#40;9, \$pid&#41;} else {sleep 5}&#34;;
print $?&gt;&gt;8, &#34;\n&#34;;

Windows 7:
system $^X,  &#34;-e&#34;, &#34;if &#40;\$pid=fork&#41;{kill&#40;9, \$pid&#41;} else {sleep 5}&#34;;
print $?&gt;&gt;8, &#34;\n&#34;;

The only difference is the additional sleep&#40;&#41; before kill&#40;&#41; on Windows
2000.  The Windows 7 test case however prints &#39;0&#39; on Windows 2000, and
vice versa, the Windows 2000 test case prints &#39;0&#39; on Windows 7 too.

The problem does not manifest itself under Strawberry Perl 5.12.1 on
Windows 7 &#40;and Strawberry doesn&#39;t install on Windows 2000&#41;.

The problem can be fixed in both cases by adding a sleep&#40;1&#41; after the
kill&#40;&#41; call.

Further testing shows that it is actually enough to just give up the
remainder of the timeslice to resolve the issue:

    Win32::Sleep&#40;0&#41;;

Looking at the implementation of win32_kill&#40;&#41; again I see that we are
actually passing the signal number as the thread exit code:

            case 9:
                /* kill -9 style un-graceful exit */
                if &#40;TerminateThread&#40;hProcess, sig&#41;&#41; {
                    remove_dead_pseudo_process&#40;child&#41;;
                    return 0;
                }

So what this now looks like is that we are killing the other thread with
an exit code of 9, and if we manage to call ExitProcess&#40;0&#41; in the
remainder of our own timeslice, then the Windows scheduler will do the
final cleanup of the child thread after we have terminated the main
thread, replacing our exit code &#40;0&#41; with the exit code of the child
process &#40;9&#41;.

I haven&#39;t tested this further, but I assume that Strawberry Perl, due to
being compiled with a different compiler, will do something that always
yields to the scheduler before calling ExitProcess&#40;&#41;, thereby avoiding
this race condition.

I&#39;m going to fix this in core Perl by adding a Sleep&#40;0&#41; call after the
TerminateThread&#40;&#41; call for the Perl 5.14 release.

But for earlier releases of ActivePerl it would still be nice if
Test-TCP could add a call to sleep&#40;1&#41; to prevent these bogus test
failures &#40;both for itself, and the modules using it, like Plack&#41;.  If
you want to avoid the additional delay for each test, change the
sleep&#40;1&#41; to:

    Win32::Sleep&#40;0&#41; if $^O eq &#34;MSWin32&#34;;

Win32::Sleep&#40;&#41; is always defined on Windows; there is no need to
use/require the Win32 module first.  And don&#39;t try sleep&#40;0&#41;, it is
implemented differently and won&#39;t give up the remainder of the timeslice.

As a further note, since this problem affects the tests of other modules
too &#40;e.g. HTTP::Server::Simple&#41;, a good workaround for current
ActivePerl versions is to add this line:

    END { Win32::Sleep&#40;0&#41; }

to your Perl/site/lib/sitecustomize.pl file.  Both Test-TCP-1.12 and
HTTP-Server-Simple-0.43 build and test without problems for me with this
modification.  I&#39;ll add this workaround to the ActiveState PPM Windows
build machines.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-909253" href="/Public/Bug/Display.html?id=66016#txn-909253">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;11&nbsp;13:43:42&nbsp;2011</span>
    <span class="description">JDB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/909253/471680/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/471680">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 220b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Mar 10 18:54:38 2011, JDB wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m going to fix this in core Perl by adding a Sleep&#40;0&#41; call after the
&gt; TerminateThread&#40;&#41; call for the Perl 5.14 release.
</div>
<span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/commitdiff/82e24582">http://perl5.git.perl.org/perl.git/commitdiff/82e24582</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-909972" href="/Public/Bug/Display.html?id=66016#txn-909972">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;14&nbsp;04:35:36&nbsp;2011</span>
    <span class="description">bo.johansson [...] lsn.se -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bo.johansson [...] lsn.se</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/909972/472025/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/472025">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have done some test using Win32::Sleep&#40;0&#41;; and some inspired by &#34;if
&#40;\$pid=fork&#41;{sleep 1;kill&#40;9, \$pid&#41;} else {sleep 5}&#34;.

I have also tried to find a improved workaround using Win32::Sleep&#40;0&#41;;
in the tests of Test::TCP. See 3 below.
A workaround which only changes the stop method in TCP.pm seems not to
be enough. The in  <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=66437">https://rt.cpan.org/Public/Bug/Display.html?id=66437</a></span>
proposed changes to the tests is probably also necessary. 

Here are the results. Hope it can give some information in the search of
the problem causes.

1&#41; This is always blocking:
perl -e &#34;if &#40;$pid=fork&#41;{kill&#40;9, $pid&#41;;} else {sleep 1000}&#34;

&#40;Should the corresponding test be added to the tests of the core Perl&#41;

2&#41; This is sometimes blocking and sometimes giving the exit value 9:
perl -e &#34;if &#40;$pid=fork&#41;{Win32::Sleep&#40;0&#41;; kill&#40;9, $pid&#41;;} else {sleep 1000}&#34;

Using the batch file below I get the following result:

- Blocking after 725 loops. 
- Blocking after 1335 loops.
- Exiting with the value 9 after 568 loops.
- Exiting with the value 9 after 5 loops.*
- Exiting with the value 9 after 3 loops.*
- Exiting with the value 9 after 14 loops.*
- Exiting with the value 9 after 6 loops.*
- Blocking after 3878 loops.
- Blocking after 269 loops.
- Exiting with the value 9 after 678 loops.
- Blocking after 1472 loops.

* this was run in sequence in one cmd.exe window. Is there a problem
with some initialization of variables??!!

Batchflie:

@echo off
set count=0
:loop
set /a count=%count%+1
echo Count %count%
@echo on
perl -e &#34;if &#40;$pid=fork&#41;{Win32::Sleep&#40;0&#41;; kill&#40;9, $pid&#41;;} else {sleep 1000}&#34;
if errorlevel 1 goto exit
@echo off
goto loop
:exit
ECHO.%ERRORLEVEL%

3&#41; Running tests with modifications in TCP.pm

Got the following result running some test, using a batch file and with
modifications in TCP.pm:

Test 01_simple.t is blocking after 343 loops
Test 08_exit.t is blocking after 713 loops
Test 10_oo.t is blocking after 481 loops
Test 01_simple.t is blocking after 423 loops
Test 10_oo.t is blocking after 2067 loops
Test 08_exit.t is blocking after 1434 loops
Test 08_exit.t is blocking after 87 loops
Test 08_exit.t is blocking after 3258 loops

Used batch file:

@echo off
set count=0
:loop
set /a count=%count%+1
echo Count %count%
@echo on
perl -Ilib t/01_simple.t
perl -Ilib t/08_exit.t
perl -Ilib t/09_fork.t
perl -Ilib t/10_oo.t
@echo off
goto loop

With the two marked lines added in TCP.pm:

sub stop {
    my $self = shift;

    return unless defined $self-&gt;{pid};
    return unless $self-&gt;{_my_pid} == $$;
    Win32::Sleep&#40;0&#41; if $^O eq &#34;MSWin32&#34;; # added line
    kill $TERMSIG =&gt; $self-&gt;{pid};
    Win32::Sleep&#40;0&#41; if $^O eq &#34;MSWin32&#34;; # added line
    local $?; # waitpid modifies original $?.

I am using:
- Strawberry-perl-5.12.2.0
- Perl 5, version 12, subversion 2 &#40;v5.12.2&#41; built for
MSWin32-x86-multi-thread
- Windows 7 Home Premium with Service Pack 1

See also <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=66437">https://rt.cpan.org/Public/Bug/Display.html?id=66437</a></span> 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-910083" href="/Public/Bug/Display.html?id=66016#txn-910083">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;14&nbsp;13:14:22&nbsp;2011</span>
    <span class="description">jand [...] ActiveState.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &lt;JDB [...] cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #66016] Tests fail on Windows &#40;even when they pass?&#41; </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 14 Mar 2011 10:14:12 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-Test-TCP [...] rt.cpan.org&gt;, &lt;mkanat [...] cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jan Dubois&#34; &lt;jand [...] activestate.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/910083/472089/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/472089">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, 14 Mar 2011, Bo Johansson via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66016">https://rt.cpan.org/Ticket/Display.html?id=66016</a></span> &gt;
&gt; 
&gt; I have done some test using Win32::Sleep&#40;0&#41;; and some inspired by &#34;if
&gt; &#40;\$pid=fork&#41;{sleep 1;kill&#40;9, \$pid&#41;} else {sleep 5}&#34;.
&gt; 
&gt; I have also tried to find a improved workaround using Win32::Sleep&#40;0&#41;;
&gt; in the tests of Test::TCP. See 3 below.
&gt; A workaround which only changes the stop method in TCP.pm seems not to
&gt; be enough. The in  <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=66437">https://rt.cpan.org/Public/Bug/Display.html?id=66437</a></span>
&gt; proposed changes to the tests is probably also necessary.
&gt; 
&gt; Here are the results. Hope it can give some information in the search of
&gt; the problem causes.
&gt; 
&gt; 1&#41; This is always blocking:
&gt; perl -e &#34;if &#40;$pid=fork&#41;{kill&#40;9, $pid&#41;;} else {sleep 1000}&#34;
</div>
On Windows 7, but not on Windows 2000.  It is a race condition, and the
timing seems to depend on details of the scheduler.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#40;Should the corresponding test be added to the tests of the core Perl&#41;
</div>
I already did this &#40;together with adding a Sleep&#40;0&#41; after calling
TerminateThread&#40;&#41; whenever a pseudo-process is killed with kill&#40;9,...&#41;&#41;:

<span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/commitdiff/82e24582">http://perl5.git.perl.org/perl.git/commitdiff/82e24582</a></span>

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2&#41; This is sometimes blocking and sometimes giving the exit value 9:
&gt; perl -e &#34;if &#40;$pid=fork&#41;{Win32::Sleep&#40;0&#41;; kill&#40;9, $pid&#41;;} else {sleep 1000}&#34;
</div>
Yes, to prevent the exit value of 9 the Win32::Sleep&#40;0&#41; has to be
*after* the kill&#40;&#41;.

[...]
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 3&#41; Running tests with modifications in TCP.pm
&gt; 
&gt; Got the following result running some test, using a batch file and with
&gt; modifications in TCP.pm:
</div>
[...]

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; With the two marked lines added in TCP.pm:
&gt; 
&gt; sub stop {
&gt;     my $self = shift;
&gt; 
&gt;     return unless defined $self-&gt;{pid};
&gt;     return unless $self-&gt;{_my_pid} == $$;
&gt;     Win32::Sleep&#40;0&#41; if $^O eq &#34;MSWin32&#34;; # added line
</div>
That line should not be necessary &#40;at least not for the exit value
of &#39;9&#39; problem.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     kill $TERMSIG =&gt; $self-&gt;{pid};
&gt;     Win32::Sleep&#40;0&#41; if $^O eq &#34;MSWin32&#34;; # added line
&gt;     local $?; # waitpid modifies original $?.
&gt; 
&gt; I am using:
&gt; - Strawberry-perl-5.12.2.0
&gt; - Perl 5, version 12, subversion 2 &#40;v5.12.2&#41; built for
&gt; MSWin32-x86-multi-thread
&gt; - Windows 7 Home Premium with Service Pack 1
</div>
Thanks for providing the batch file.  I&#39;ll try to run it on
my VMs to see if I can reproduce the blocking.

Cheers,
-Jan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-910155" href="/Public/Bug/Display.html?id=66016#txn-910155">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;14&nbsp;17:24:14&nbsp;2011</span>
    <span class="description">bo.johansson [...] lsn.se -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bo.johansson [...] lsn.se</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/910155/472129/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/472129">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hej Jan!

Thank you for your patience! I have very little knowledge about the
internal of perl.

1&#41; You wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;Windows 7:
&gt;system $^X, &#34;-e&#34;, &#34;if &#40;\$pid=fork&#41;{kill&#40;9, \$pid&#41;} else {sleep 5}&#34;;
&gt;print $?&gt;&gt;8, &#34;\n&#34;;
</div>
Is it a problem if it is blocking and there is no print at all?


2&#41; Using the batch file:
@echo off
set count=0
:loop
set /a count=%count%+1
echo Count %count%
@echo on
perl -Ilib t/01_simple.t
perl -Ilib t/08_exit.t
perl -Ilib t/09_fork.t
perl -Ilib t/10_oo.t
@echo off
goto loop

and with &#34;added line removed&#34; in:

sub stop {
    my $self = shift;

    return unless defined $self-&gt;{pid};
    return unless $self-&gt;{_my_pid} == $$;
    #Win32::Sleep&#40;0&#41; if $^O eq &#34;MSWin32&#34;; # added line removed
    kill $TERMSIG =&gt; $self-&gt;{pid};
    Win32::Sleep&#40;0&#41; if $^O eq &#34;MSWin32&#34;; # added line
    local $?; # waitpid modifies original $?.

gave the results:

- Test 09_fork.t is blocking in loop 1.
- Test 09_fork.t is blocking in loop 4.
- Test 09_fork.t is blocking in loop 2.
- Test 09_fork.t is blocking in loop 2.
- Test 09_fork.t is blocking in loop 1.
- Test 09_fork.t is blocking in loop 1.
- Test 09_fork.t is blocking in loop 2.

Removed &#34;perl -Ilib t/09_fork.t&#34; in batch file.

- Test 08_exit.t is blocking in loop 8.
- Test 08_exit.t is blocking in loop 9.
- Test 08_exit.t is blocking in loop 13.
- Test 08_exit.t is blocking in loop 5.

Conclusion: This indicates that the first Win32::Sleep&#40;0&#41; if $^O eq
&#34;MSWin32&#34;; line is needed to prevent the blocking.

    
3&#41; Running this batch file:

@echo off
set count=0
:loop
set /a count=%count%+1
echo Count %count%
@echo on
perl -e &#34;if &#40;$pid=fork&#41;{Win32::Sleep&#40;0&#41;; kill&#40;9, $pid&#41;; Win32::Sleep&#40;0&#41;}
else {sleep 1000}&#34;
if errorlevel 1 goto exit
@echo off
goto loop
:exit
ECHO.%ERRORLEVEL%

&#40;second &#34;Win32::Sleep&#40;0&#41;&#34; is added&#41; gave the results:

- Blocking after 2170 loops.
- Blocking after 449 loops.
- Blocking after 38 loops.
- Blocking after 58 loops.
- Blocking after 2108 loops.
- Exiting with the value 9 after 3 loops.
- Exiting with the value 9 after 7 loops.
- Exiting with the value 9 after 7 loops.
- Exiting with the value 9 after 1 loops.
- Exiting with the value 9 after a few loops was repeated more than 20
times using the same command windows.
Is there some missing initialization???!!!
- Blocking after 2806 loops.
- Blocking after 353 loops.
- Blocking after 1737 loops.
- Run more than 7000 loops without problems.

Conclusion: There are still &#34;exiting with the value 9&#34;. 

Removing the first Win32::Sleep&#40;0&#41; resulted in immediate blocking.

Have a nice day!

Bosse
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-910239" href="/Public/Bug/Display.html?id=66016#txn-910239">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;14&nbsp;20:21:04&nbsp;2011</span>
    <span class="description">jand [...] ActiveState.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &lt;JDB [...] cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #66016] Tests fail on Windows &#40;even when they pass?&#41; </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 14 Mar 2011 17:20:56 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-Test-TCP [...] rt.cpan.org&gt;, &lt;mkanat [...] cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jan Dubois&#34; &lt;jand [...] activestate.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/910239/472171/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/472171">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, 14 Mar 2011, Bo Johansson via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 1&#41; You wrote:
&gt; 
<div class="message-stanza open">&gt; &gt;Windows 7:
&gt; &gt;system $^X, &#34;-e&#34;, &#34;if &#40;\$pid=fork&#41;{kill&#40;9, \$pid&#41;} else {sleep 5}&#34;;
&gt; &gt;print $?&gt;&gt;8, &#34;\n&#34;;
</div>&gt; 
&gt; Is it a problem if it is blocking and there is no print at all?
</div>
Yes, that is a problem.  Note though that kill&#40;9, $child&#41; is inherently
unsafe for pseudo-processes.  You should only ever do this if you
know that $child is in a known &#34;blocking&#34; state.  E.g.

  system $^X, &#34;-e&#34;, &#34;if &#40;\$pid=fork&#41;{sleep 1;kill&#40;9, \$pid&#41;} else {sleep 5}&#34;;

The sleep&#40;1&#41; before the kill&#40;&#41; should give the child process enough
time to reach the sleep&#40;5&#41; call before getting killed.

Here is the list of warnings about some of the things that can go
wrong if you call TerminateThread&#40;&#41; when you don&#39;t know the current
state of the thread &#40;from the Microsoft docs&#41;:

* If the target thread owns a critical section, the critical section
  will not be released.

* If the target thread is allocating memory from the heap, the heap lock
  will not be released.

* If the target thread is executing certain kernel32 calls when it is
  terminated, the kernel32 state for the thread&#39;s process could be
  inconsistent.

* If the target thread is manipulating the global state of a shared
  DLL, the state of the DLL could be destroyed, affecting other users
  of the DLL.

As the terminated thread runs inside the same process as the controlling
thread, it is always possible that the controlling thread will get
damaged by this action.

I&#39;ve suggested an alternative to perl5-porters, that would allow us
to SIGTERM the child and then simply exit from the parent and leave
the thread cleanup to the OS.  That should work much cleaner, because
it should never affect the parent process.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2&#41; Using the batch file:
&gt; @echo off
&gt; set count=0
&gt; :loop
&gt; set /a count=%count%+1
&gt; echo Count %count%
&gt; @echo on
&gt; perl -Ilib t/01_simple.t
&gt; perl -Ilib t/08_exit.t
&gt; perl -Ilib t/09_fork.t
&gt; perl -Ilib t/10_oo.t
&gt; @echo off
&gt; goto loop
</div>
I have not tested with the Test::TCP tests any further, but...
[...]
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 3&#41; Running this batch file:
&gt; 
&gt; @echo off
&gt; set count=0
&gt; :loop
&gt; set /a count=%count%+1
&gt; echo Count %count%
&gt; @echo on
&gt; perl -e &#34;if &#40;$pid=fork&#41;{Win32::Sleep&#40;0&#41;; kill&#40;9, $pid&#41;; Win32::Sleep&#40;0&#41;}
&gt; else {sleep 1000}&#34;
&gt; if errorlevel 1 goto exit
&gt; @echo off
&gt; goto loop
&gt; :exit
&gt; ECHO.%ERRORLEVEL%
&gt; 
&gt; &#40;second &#34;Win32::Sleep&#40;0&#41;&#34; is added&#41; gave the results:
&gt; 
&gt; - Blocking after 2170 loops.
&gt; - Blocking after 449 loops.
&gt; - Blocking after 38 loops.
&gt; - Blocking after 58 loops.
&gt; - Blocking after 2108 loops.
&gt; - Exiting with the value 9 after 3 loops.
&gt; - Exiting with the value 9 after 7 loops.
&gt; - Exiting with the value 9 after 7 loops.
&gt; - Exiting with the value 9 after 1 loops.
&gt; - Exiting with the value 9 after a few loops was repeated more than 20
&gt; times using the same command windows.
&gt; Is there some missing initialization???!!!
&gt; - Blocking after 2806 loops.
&gt; - Blocking after 353 loops.
&gt; - Blocking after 1737 loops.
&gt; - Run more than 7000 loops without problems.
&gt; 
&gt; Conclusion: There are still &#34;exiting with the value 9&#34;.
&gt; 
&gt; Removing the first Win32::Sleep&#40;0&#41; resulted in immediate blocking.
</div>
I&#39;ve been running this, and variations of it on my Windows 7 Pro SP1 VM,
and only had it exit with value &#34;9&#34; once after more than 24K interations.
So I see that it can still happen, but it is really hard to repro.

I was hoping to be able to see the blocking state, so I could use a debugger
to check the stack traces from all threads to determine the cause of the
deadlock, but have not been able to repo this at all.

Anyways, I don&#39;t think TerminateThread&#40;&#41; can ever be completely safe
if you call it when the child thread may not be in a wait state, so
I hope the alternate implementation will solve the issue instead &#40;for
5.14 and later only, for 5.12 and earlier we will have to add the
sleep&#40;&#41; calls and live with the occasional breakage, I think&#41;.

Cheers,
-Jan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-928128" href="/Public/Bug/Display.html?id=66016#txn-928128">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;26&nbsp;12:23:42&nbsp;2011</span>
    <span class="description">kmx [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/928128/481675/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/481675">with headers</a>
<br />
<span class="downloadcontenttype">text/html 629b</span>
</div>
<div class="messagebody">
<div class="message-stanza"><pre>
op/fork.t test if failing on my Windows 7/64bit box
- perl-5.14.0-RC1
- built with mingw-w64.sf.net gcc-4.4.3 toolchain
- the same failure for 32bit and 64bit perl

op/fork.t ......................................................... 23/? PROG:<br># Windows 7: <a><span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66016#txn-908976">https://rt.cpan.org/Ticket/Display.html?id=66016#txn-908976</a></span></a><br>system $^X,  &quot;-e&quot;, &quot;if (\$pid=fork){kill(9, \$pid)} else {sleep 5}&quot;;<br>print $?&gt;&gt;8, &quot;\n&quot;;<br>EXPECTED:<br>0<br>GOT:<br>9

--
kmx
</pre>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-928369" href="/Public/Bug/Display.html?id=66016#txn-928369">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;26&nbsp;22:13:04&nbsp;2011</span>
    <span class="description">tokuhirom [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66016] Tests fail on Windows &#40;even when they pass?&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 27 Apr 2011 11:12:54 +0900</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Test-TCP [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tokuhiro Matsuno &lt;tokuhirom [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/928369/481800/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/481800">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 734b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Can anyone send a pull-req on github?

repo is here: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/tokuhirom/test-tcp">https://github.com/tokuhirom/test-tcp</a></span>

On Wed, Apr 27, 2011 at 1:23 AM, kmx via RT &lt;bug-Test-TCP@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Â  Â  Â  Queue: Test-TCP
&gt; Â Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66016">https://rt.cpan.org/Ticket/Display.html?id=66016</a></span> &gt;
&gt;
&gt; op/fork.t test if failing on my Windows 7/64bit box
&gt; - perl-5.14.0-RC1
&gt; - built with mingw-w64.sf.net gcc-4.4.3 toolchain
&gt; - the same failure for 32bit and 64bit perl
&gt;
&gt;
&gt; op/fork.t ......................................................... 23/? PROG:
&gt; # Windows 7: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66016#txn-908976">https://rt.cpan.org/Ticket/Display.html?id=66016#txn-908976</a></span>
&gt; system $^X, Â &#34;-e&#34;, &#34;if &#40;\$pid=fork&#41;{kill&#40;9, \$pid&#41;} else {sleep 5}&#34;;
&gt; print $?&gt;&gt;8, &#34;\n&#34;;
&gt; EXPECTED:
&gt; 0
&gt; GOT:
&gt; 9
&gt; --
&gt; kmx
&gt;
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1189574" href="/Public/Bug/Display.html?id=66016#txn-1189574">#</a>      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;10&nbsp;16:37:25&nbsp;2013</span>
    <span class="description">bo.johansson [...] lsn.se -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bo.johansson [...] lsn.se</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1189574/627510/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/627510">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 471b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Vid Fre, 11 Mar 2011 kl. 13.43.42, skrev JDB:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Mar 10 18:54:38 2011, JDB wrote:
<div class="message-stanza open">&gt; &gt; I&#39;m going to fix this in core Perl by adding a Sleep&#40;0&#41; call after the
&gt; &gt; TerminateThread&#40;&#41; call for the Perl 5.14 release.
</div>&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/commitdiff/82e24582">http://perl5.git.perl.org/perl.git/commitdiff/82e24582</a></span>
</div>
I have got an improvement proposal to the patch see
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=1022657">http://www.perlmonks.org/?node_id=1022657</a></span>.
I have no possibilities to test the proposal. Could someone test it and
if it work create a patch?
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.754013</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
