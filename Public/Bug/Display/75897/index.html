<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #75897 for HTTP-Cookies: Duplication Of Cookies</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #75897 for HTTP-Cookies: Duplication Of Cookies</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/HTTP-Cookies/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/HTTP-Cookies/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/HTTP-Cookies/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/HTTP-Cookies/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/HTTP-Cookies">HTTP-Cookies CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">75897</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/HTTP-Cookies/Active/">HTTP-Cookies</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
vaibhavkhunger [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-237462-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
6.01    </td>
  </tr>
  <tr id="CF-237463-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
6.01    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;20&nbsp;02:24:48&nbsp;2012</span>
    <span class="description">vaibhavkhunger [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Duplication Of Cookies</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Bug in HTTP::Cookies version 6.01
Perl Version 5.10.1
Operating System: Ubuntu 10.04

BUG:
In package HTTP::Cookies, the function add_cookie_header&#40;&#41; has a bug 
that it copies prevoiusly existing cookies and concatenates them to the 
request header. This sometimes causes duplication of cookies.
The Bug causes error 400 Bad Request, due to the request header being 
too long when trying to log in to a server.This condition does not cause 
an error until and unless the cookies are too long.


Workaround:
Rather than appending the existing cookies to the new cookies we should 
check if the cookie already exists than skip appending it, otherwise 
append it to the new cookies.



My Scenario:
I was trying to log on to an AD-FS server using NTLM Authentication.
We recieve 4 NTLM Request Cookies which are base64 encoded. But during 
Authentication there are 3 redirections which are handled using 
request&#40;&#41; in LWP::UserAgent.
This make a indirect call to HTTP::Cookies each time.
Therefore, the same cookies are repeated 3 times.
As the cookies are too long we recieve an HTTP Bad Request, Error 400.



Place of Bug in Code:

    if &#40;@cval&#41; {
        if &#40;my $old = $request-&gt;header&#40;&#34;Cookie&#34;&#41;&#41; {
            unshift&#40;@cval, $old&#41;;
        }
        $request-&gt;header&#40;Cookie =&gt; join&#40;&#34;; &#34;, @cval&#41;&#41;;
    }

Fix:
This patch checks whether the cookie in @oldcookie has alredy been 
included in @cval, if yes than it skips appending it to @cval,

if &#40;@cval&#41; {
        if &#40;my $old = $request-&gt;header&#40;&#34;Cookie&#34;&#41;&#41; {
                my @oldcookie = split&#40;/;/, $old&#41;;
                my $cookieflag;
                my $ocookie;
                my $ncookie;
                foreach&#40;@oldcookie&#41;{
                        $ocookie = $_;
                        $ocookie=~ s/^\s*//;
                        $ocookie=~ s/\s*$//;
                        chomp&#40;$ocookie&#41;;
                        $cookieflag = 1;
                        foreach&#40;@cval&#41;{
                                $ncookie = $_;
                                $ncookie=~ s/^\s*//;
                                $ncookie=~ s/\s*$//;
                                chomp&#40;$ncookie&#41;;
                                if&#40;$ncookie eq $ocookie&#41;
                                {       
                                        $cookieflag=0;
                                }
                        }
                        if&#40;$cookieflag==1&#41;
                        {    
                        unshift&#40;@cval, $ocookie&#41;;
                        }
                }
        }
        $request-&gt;header&#40;Cookie =&gt; join&#40;&#34;; &#34;, @cval&#41;&#41;;
    }
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Error report</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;04&nbsp;15:45:04&nbsp;2016</span>
    <span class="description">olaf [...] wundersolutions.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Mar 20 02:24:48 2012, vaibhavkhunger wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Bug in HTTP::Cookies version 6.01
&gt; Perl Version 5.10.1
&gt; Operating System: Ubuntu 10.04
&gt; 
&gt; BUG:
&gt; In package HTTP::Cookies, the function add_cookie_header&#40;&#41; has a bug 
&gt; that it copies prevoiusly existing cookies and concatenates them to the 
&gt; request header. This sometimes causes duplication of cookies.
&gt; The Bug causes error 400 Bad Request, due to the request header being 
&gt; too long when trying to log in to a server.This condition does not cause 
&gt; an error until and unless the cookies are too long.
&gt; 
&gt; 
&gt; Workaround:
&gt; Rather than appending the existing cookies to the new cookies we should 
&gt; check if the cookie already exists than skip appending it, otherwise 
&gt; append it to the new cookies.
&gt; 
&gt; 
&gt; 
&gt; My Scenario:
&gt; I was trying to log on to an AD-FS server using NTLM Authentication.
&gt; We recieve 4 NTLM Request Cookies which are base64 encoded. But during 
&gt; Authentication there are 3 redirections which are handled using 
&gt; request&#40;&#41; in LWP::UserAgent.
&gt; This make a indirect call to HTTP::Cookies each time.
&gt; Therefore, the same cookies are repeated 3 times.
&gt; As the cookies are too long we recieve an HTTP Bad Request, Error 400.
&gt; 
&gt; 
&gt; 
&gt; Place of Bug in Code:
&gt; 
&gt;     if &#40;@cval&#41; {
&gt;         if &#40;my $old = $request-&gt;header&#40;&#34;Cookie&#34;&#41;&#41; {
&gt;             unshift&#40;@cval, $old&#41;;
&gt;         }
&gt;         $request-&gt;header&#40;Cookie =&gt; join&#40;&#34;; &#34;, @cval&#41;&#41;;
&gt;     }
&gt; 
&gt; Fix:
&gt; This patch checks whether the cookie in @oldcookie has alredy been 
&gt; included in @cval, if yes than it skips appending it to @cval,
&gt; 
&gt; if &#40;@cval&#41; {
&gt;       if &#40;my $old = $request-&gt;header&#40;&#34;Cookie&#34;&#41;&#41; {
&gt;               my @oldcookie = split&#40;/;/, $old&#41;;
&gt;               my $cookieflag;
&gt;               my $ocookie;
&gt;               my $ncookie;
&gt;               foreach&#40;@oldcookie&#41;{
&gt;                       $ocookie = $_;
&gt;                       $ocookie=~ s/^\s*//;
&gt;                       $ocookie=~ s/\s*$//;
&gt;                       chomp&#40;$ocookie&#41;;
&gt;                       $cookieflag = 1;
&gt;                       foreach&#40;@cval&#41;{
&gt;                               $ncookie = $_;
&gt;                               $ncookie=~ s/^\s*//;
&gt;                               $ncookie=~ s/\s*$//;
&gt;                               chomp&#40;$ncookie&#41;;
&gt;                               if&#40;$ncookie eq $ocookie&#41;
&gt;                               {       
&gt;                                       $cookieflag=0;
&gt;                               }
&gt;                       }
&gt;                       if&#40;$cookieflag==1&#41;
&gt;                       {    
&gt;                       unshift&#40;@cval, $ocookie&#41;;
&gt;                       }
&gt;               }
&gt;       }
&gt;       $request-&gt;header&#40;Cookie =&gt; join&#40;&#34;; &#34;, @cval&#41;&#41;;
&gt;     }
</div>
Looks like this is still an issue.  See <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/libwww-perl/WWW-Mechanize/issues/52">https://github.com/libwww-perl/WWW-Mechanize/issues/52</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;04&nbsp;15:45:04&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;30&nbsp;19:32:35&nbsp;2017</span>
    <span class="description">olaf [...] wundersolutions.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ticket migrated to github as <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/libwww-perl/http-cookies/issues/33">https://github.com/libwww-perl/http-cookies/issues/33</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;30&nbsp;19:32:41&nbsp;2017</span>
    <span class="description">olaf [...] wundersolutions.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
