<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #45408 for POE: wheels break when manipulated by other sessions</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #45408 for POE: wheels break when manipulated by other sessions</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/POE/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/POE/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/POE/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/POE/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE">POE CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">45408</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/POE/Active/">POE</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
sean.pieper [...] viable.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26342-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26343-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;24&nbsp;18:41:42&nbsp;2009</span>
    <span class="description">sean.pieper [...] viable.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> POE filehandle leak</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 24 Apr 2009 18:41:18 -0400 &#40;EDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> sean.pieper [...] viable.net</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza"><font face="arial" size="2">Dear POE maintainers,<br><br>&nbsp;&nbsp; I've discovered a filehandle leak in POE, intially with v 1.003 and confirmed still present in 1.005. This leak was first spotted in a production server where clients connect and are authorized and logged in a database before further interactions. The database access can take a while when we get a large number of clients connecting simultaneously, and if some clients drop off in the meantime, we quickly leak filehandles (not sockets though-- the network stuff gets shutdown properly). <br><br>Effectively, what happens for the leak is:<br><br>socketfactory creates a new socket<br>new socket gets wrapped as a wheel::readwrite<br>wheel::readwrite gets input and kicks off an event to the session handling DB communication<br>wheel::readwrite receives close<br>DB session completes, and wheel::readwrite is collected<br>filehandle is still kicking around.<br><br>I've written what I believe is a minimal demonstration (attached). This bug only appears if I post to a separate session-- if the slow (outstanding) event is in the same session that creates the wheels, there is no leak. If the outstanding event is resolved before the socket closes, the filehandle is also correctly cleaned.<br><br>Please let me know if I can do anything further to help resolve this issue. I'm trying to track down a high load deadlock in my server code, and I'd like to eliminate this bug as a potential culprit. <br><br>Thanks for a really useful framework.<br><br>-sean<br><br>Sean Pieper<br>Engineer<br>Viable, Inc.<br>VRS: ViableVRS.tv<br>www.viable.net<br>sean.pieper@viable.net<br>Office: 240-292-0222 x244<br>VSN: viablepieper<br><br><br>This e-mail, including any attachments may contain information that is protected by law as PRIVILEGED AND CONFIDENTIAL and is intended solely for the use of the recipient or the employee or agent responsible for delivering the message to the recipient. Please note that if you are not the intended recipient, you are hereby notified that any dissemination, copying, distribution, retention, re-transmission, printing or any other use of this e-mail or the information contained herein is strictly prohibited. If you have received this e-mail communication in error, please immediately send an e-mail reply to notify the sender and immediately and permanently delete this e-mail from your computer system. Thank you.</font>
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;30&nbsp;14:06:27&nbsp;2009</span>
    <span class="description">sean.pieper [...] viable.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #45408] AutoReply: POE filehandle leak </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 30 Apr 2009 14:06:02 -0400 &#40;EDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> sean.pieper [...] viable.net</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Update:

I&#39;ve traced down the problem to an issue with POE Kernel and Resource::FileHandles.

1&#41; the wheel is created in the Server session
2&#41; Resource::FileHandles registers that &#39;Server&#39; owns the wheel&#39;s handle.
3&#41; &#39;Slow&#39; gets a pointer to the wheel
4&#41; &#39;Server&#39; detects the close, and removes the wheel from its heap, but the wheel is still in scope because of &#39;Slow&#39;.
5&#41; &#39;Slow&#39; finishes its business with the wheel and wheel goes out of scope
6&#41; Wheel DESTROY calls Kernel select_read, which calls _internal_select with the active session &#40;&#39;Slow&#39;&#41;
7&#41; _internal_select calls Resource::FileHandles _data_handle_remove
8&#41; _data_handle_remove detects that &#39;Slow&#39; does not own the wheel&#39;s filehandle, and refuses to delete the filehandle.

I&#39;ve verified that if when &#39;Slow&#39; finishes with the wheel, it passes it back to &#39;Server&#39; so that the wheel goes out of scope in the owning session, everything cleans up properly.

I&#39;m not sure really how to clean this up-- is there a good reason not to search through all the sessions to find the owner if an object goes out of scope in a session that does not own it? or, for that matter, to have the owning session as part of the wheel, and pass that session to _data_handle_remove rather than the active session?


Sean Pieper
Engineer
Viable, Inc.
VRS: ViableVRS.tv
www.viable.net
sean.pieper@viable.net
Office: 240-292-0222 x244
VSN: viablepieper


This e-mail, including any attachments may contain information that is protected by law as PRIVILEGED AND CONFIDENTIAL and is intended solely for the use of the recipient or the employee or agent responsible for delivering the message to the recipient. Please note that if you are not the intended recipient, you are hereby notified that any dissemination, copying, distribution, retention, re-transmission, printing or any other use of this e-mail or the information contained herein is strictly prohibited. If you have received this e-mail communication in error, please immediately send an e-mail reply to notify the sender and immediately and permanently delete this e-mail from your computer system. Thank you.
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;30&nbsp;17:23:32&nbsp;2009</span>
    <span class="description">sean.pieper [...] viable.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #45408] : workaround</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 30 Apr 2009 17:22:37 -0400 &#40;EDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> sean.pieper [...] viable.net</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">in the wheel error handler, or any other place that the wheel might be removed from the heap of the session that owns it, can add explicit calls to shutdown_input and shutdown_output. Then, even if the object is actually reaped later, the filehandle will already have been released by poe&#39;s internals.

workaround looks like this:


sub on_client_error : State
{
        # Handle client error, including disconnect.
        my &#40;$op, $err, $wheel_id&#41; = @_[ARG0,ARG1,ARG3];
        warn&#40;&#34;SRV:main got $op $err $wheel_id\n&#34;&#41;;
        $_[HEAP]-&gt;{RW}-&gt;{$wheel_id}-&gt;shutdown_input&#40;&#41;;
        $_[HEAP]-&gt;{RW}-&gt;{$wheel_id}-&gt;shutdown_output&#40;&#41;;
        delete $_[HEAP]-&gt;{RW}-&gt;{$wheel_id};
}

I still think this is a bug though.


Sean Pieper
Engineer
Viable, Inc.
VRS: ViableVRS.tv
www.viable.net
sean.pieper@viable.net
Office: 240-292-0222 x244
VSN: viablepieper


This e-mail, including any attachments may contain information that is protected by law as PRIVILEGED AND CONFIDENTIAL and is intended solely for the use of the recipient or the employee or agent responsible for delivering the message to the recipient. Please note that if you are not the intended recipient, you are hereby notified that any dissemination, copying, distribution, retention, re-transmission, printing or any other use of this e-mail or the information contained herein is strictly prohibited. If you have received this e-mail communication in error, please immediately send an e-mail reply to notify the sender and immediately and permanently delete this e-mail from your computer system. Thank you.
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;30&nbsp;18:24:10&nbsp;2009</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Apr 30 14:06:27 2009, sean.pieper@viable.net wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Update:
&gt; 
&gt; I&#39;ve traced down the problem to an issue with POE Kernel and
&gt;    Resource::FileHandles.
&gt; 
&gt; 1&#41; the wheel is created in the Server session
&gt; 2&#41; Resource::FileHandles registers that &#39;Server&#39; owns the wheel&#39;s
&gt;    handle.
</div>
The wheel adds an anonymous input event handler to the Server session,
using POE::Kernel-&gt;state&#40;&#41;.

The wheel calls POE::Kernel-&gt;select_read&#40;&#41; to register an input
watcher.  This input watcher associates the socket with the Server
session and the newly created anonymous event handler.

Both state&#40;&#41; and select_read&#40;&#41; operate &#34;in the current session&#34;.
Their resources &#40;a CODE reference and a socket handle&#41; are implicitly
associated with the session that created the wheel.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 3&#41; &#39;Slow&#39; gets a pointer to the wheel
&gt; 4&#41; &#39;Server&#39; detects the close, and removes the wheel from its heap,
&gt;    but the wheel is still in scope because of &#39;Slow&#39;.
&gt; 5&#41; &#39;Slow&#39; finishes its business with the wheel and wheel goes out of
&gt;    scope
&gt; 6&#41; Wheel DESTROY calls Kernel select_read, which calls
&gt;    _internal_select with the active session &#40;&#39;Slow&#39;&#41;
&gt; 7&#41; _internal_select calls Resource::FileHandles _data_handle_remove
&gt; 8&#41; _data_handle_remove detects that &#39;Slow&#39; does not own the wheel&#39;s
&gt;    filehandle, and refuses to delete the filehandle.
</div>
Exactly so.  In your test case, Slow is trying to destroy a wheel and
filehandle watcher owned by Server.  This would break Server&#39;s
encapsulation, which POE normally prevents by design.

The general pattern to work around this is to give Server total
control over the connection.  Server would expose an API, and other
sessions would $kernel-&gt;post&#40;&#41; or $kernel-&gt;call&#40;&#41; it to do the actual
sending.

Given that you&#39;ve run across a design feature, I&#39;m not sure there&#39;s
anything I can fix.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;30&nbsp;18:24:11&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;01&nbsp;12:04:26&nbsp;2009</span>
    <span class="description">sean.pieper [...] viable.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #45408] POE filehandle leak </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 1 Jun 2009 12:04:06 -0400 &#40;EDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> sean.pieper [...] viable.net</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for getting back to me.

I feel like this should at least be red flagged in the wheel::readwrite documentation and a nasty warning raised if a session tries to shutdown someone else&#39;s wheel. I&#39;m also not too confident in the workaround you suggest. Unless I&#39;m missing something important,  I&#39;d still have to specify the wheel ID in my API calls and instead of passing an actual pointer to the wheel object between sessions, I&#39;d pass the ID. The server session would get the ID, look it up in its hash, and operate on the correct wheel. For this approach to be safe, I need to trust that when a wheel goes out of scope, its ID is never reused-- otherwise I can get an even nastier problem: 

1. wheel id is passed to task
2. task gets stalled
3. connection is closed, wheel is deleted from hash
4. new wheel gets created with duplicate ID
5. task completes and calls into API with ID 
6. ID found in hash but wheel is for a different client
7. data intended for party A goest to party B. 

Unfortunately, the documentation for wheel-&gt;ID states that no such guarantee is provided: &#34;Wheel IDs may be reused, although it has never been reported&#34;. Maybe it&#39;s paranoid, but this doesn&#39;t give me a warm feeling, particularly if POE is changed at some point to more agressively reuse IDs.

What I&#39;d prefer to see would be something along the lines of a session variable inside the wheel that the DESTROY method explicitly provides to _data_handle_remove. This would still prevent other sessions from explicitly shutting down a wheel&#39;s i/o, but keep garbage collection sane.

-sean

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: &#34;Rocco Caputo via RT&#34; &lt;bug-POE@rt.cpan.org&gt;
Sent: Saturday, May 30, 2009 6:24pm
To: sean.pieper@viable.net
Subject: [rt.cpan.org #45408] POE filehandle leak 

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=45408">https://rt.cpan.org/Ticket/Display.html?id=45408</a></span> &gt;

On Thu Apr 30 14:06:27 2009, sean.pieper@viable.net wrote:
<div class="message-stanza open">&gt; Update:
&gt; 
&gt; I&#39;ve traced down the problem to an issue with POE Kernel and
&gt;    Resource::FileHandles.
&gt; 
&gt; 1&#41; the wheel is created in the Server session
&gt; 2&#41; Resource::FileHandles registers that &#39;Server&#39; owns the wheel&#39;s
&gt;    handle.
</div>
The wheel adds an anonymous input event handler to the Server session,
using POE::Kernel-&gt;state&#40;&#41;.

The wheel calls POE::Kernel-&gt;select_read&#40;&#41; to register an input
watcher.  This input watcher associates the socket with the Server
session and the newly created anonymous event handler.

Both state&#40;&#41; and select_read&#40;&#41; operate &#34;in the current session&#34;.
Their resources &#40;a CODE reference and a socket handle&#41; are implicitly
associated with the session that created the wheel.

<div class="message-stanza open">&gt; 3&#41; &#39;Slow&#39; gets a pointer to the wheel
&gt; 4&#41; &#39;Server&#39; detects the close, and removes the wheel from its heap,
&gt;    but the wheel is still in scope because of &#39;Slow&#39;.
&gt; 5&#41; &#39;Slow&#39; finishes its business with the wheel and wheel goes out of
&gt;    scope
&gt; 6&#41; Wheel DESTROY calls Kernel select_read, which calls
&gt;    _internal_select with the active session &#40;&#39;Slow&#39;&#41;
&gt; 7&#41; _internal_select calls Resource::FileHandles _data_handle_remove
&gt; 8&#41; _data_handle_remove detects that &#39;Slow&#39; does not own the wheel&#39;s
&gt;    filehandle, and refuses to delete the filehandle.
</div>
Exactly so.  In your test case, Slow is trying to destroy a wheel and
filehandle watcher owned by Server.  This would break Server&#39;s
encapsulation, which POE normally prevents by design.

The general pattern to work around this is to give Server total
control over the connection.  Server would expose an API, and other
sessions would $kernel-&gt;post&#40;&#41; or $kernel-&gt;call&#40;&#41; it to do the actual
sending.

Given that you&#39;ve run across a design feature, I&#39;m not sure there&#39;s
anything I can fix.


Sean Pieper
Engineer
Viable, Inc.
VRS: ViableVRS.tv
www.viable.net
sean.pieper@viable.net
Office: 240-292-0222 x244
VSN: viablepieper


This e-mail, including any attachments may contain information that is protected by law as PRIVILEGED AND CONFIDENTIAL and is intended solely for the use of the recipient or the employee or agent responsible for delivering the message to the recipient. Please note that if you are not the intended recipient, you are hereby notified that any dissemination, copying, distribution, retention, re-transmission, printing or any other use of this e-mail or the information contained herein is strictly prohibited. If you have received this e-mail communication in error, please immediately send an e-mail reply to notify the sender and immediately and permanently delete this e-mail from your computer system. Thank you.
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;25&nbsp;23:47:38&nbsp;2009</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> wheels break when manipulated by other sessions</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Regarding red flags:

I&#39;m revising POE::Wheel&#39;s DESCRIPTION.  How does this sound:

Sessions must not expose their wheels to other sessions.  Doing so will
likely cause problems because wheels are tightly integrated with the
sessions that created them.  For example, calling put&#40;&#41; on a
POE::Wheel::ReadWrite instance may enable a write-okay watcher.  The
handler for this watcher is already defined in the wheel&#39;s owner. 
Calling put&#40;&#41; outside that session will enable the write-okay watcher in
the wrong session, and the event will never be handled.

Likewise, wheels must be destroyed from within their creator sessions. 
Otherwise breakage will occur when the wheels&#39; DESTROY methods try to
unregister event handlers and watchers from the wrong sessions.  To
simplify things, it&#39;s recommended to store POE::Wheel instances in heaps
of the sessions that created them.

---

Regarding wheel IDs:

Due to the Halting Problem, I can&#39;t guarantee that wheel IDs are never
reused.  I also don&#39;t want to guarantee a minimum time between reuse
because it&#39;ll complicate the code and limit future change.

Since a task in your application may involve many wheels, it seems
reasonable to decouple task ID from wheel ID.  Your task manager should
expose task IDs that persist for the lifespan of each task.  Internally,
it can map task IDs to wheel IDs with much shorter lifespans.

Internally, wheel IDs can change throughout a task&#39;s lifetime.  The task
manager will update the wheel ID associated with the task as connections
are re-established.

Externally, the rest of the application has a single, stable ID for each
task.

---

Regarding the session variable in the wheel:

By allowing one object to remove a watcher from another, we open up
semantics where any object can do as it pleases with another&#39;s
resources.  I&#39;d like to explore less permissive options, if they&#39;re
available.

POE has a lot of optional checks, one of which may already catch the
problem.  They are disabled by default because they incur significant
performance penalties.  You can try them by setting POE_ASSERT_DEFAULT=1
in your shell environment.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;25&nbsp;23:49:12&nbsp;2009</span>
    <span class="description">RCAPUTO [...] cpan.org -  Subject changed from &#39;POE filehandle leak&#39; to &#39;wheels break when manipulated by other sessions&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;26&nbsp;11:25:51&nbsp;2009</span>
    <span class="description">sean.pieper [...] viable.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #45408] wheels break when manipulated by other sessions </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 26 Aug 2009 11:25:31 -0400 &#40;EDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> sean.pieper [...] viable.net</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Rocco,

    that sounds very clear. I&#39;d been using the assert default option and it did not raise the warning-- I had to turn on a specific flag for warnings about other sessions acting on data that they did not own. It&#39;d be nice if this flag could be included in the defaults.

-sean

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: &#34;Rocco Caputo via RT&#34; &lt;bug-POE@rt.cpan.org&gt;
Sent: Tuesday, August 25, 2009 11:47pm
To: sean.pieper@viable.net
Subject: [rt.cpan.org #45408] wheels break when manipulated by other sessions 

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=45408">https://rt.cpan.org/Ticket/Display.html?id=45408</a></span> &gt;

Regarding red flags:

I&#39;m revising POE::Wheel&#39;s DESCRIPTION.  How does this sound:

Sessions must not expose their wheels to other sessions.  Doing so will
likely cause problems because wheels are tightly integrated with the
sessions that created them.  For example, calling put&#40;&#41; on a
POE::Wheel::ReadWrite instance may enable a write-okay watcher.  The
handler for this watcher is already defined in the wheel&#39;s owner. 
Calling put&#40;&#41; outside that session will enable the write-okay watcher in
the wrong session, and the event will never be handled.

Likewise, wheels must be destroyed from within their creator sessions. 
Otherwise breakage will occur when the wheels&#39; DESTROY methods try to
unregister event handlers and watchers from the wrong sessions.  To
simplify things, it&#39;s recommended to store POE::Wheel instances in heaps
of the sessions that created them.

---

Regarding wheel IDs:

Due to the Halting Problem, I can&#39;t guarantee that wheel IDs are never
reused.  I also don&#39;t want to guarantee a minimum time between reuse
because it&#39;ll complicate the code and limit future change.

Since a task in your application may involve many wheels, it seems
reasonable to decouple task ID from wheel ID.  Your task manager should
expose task IDs that persist for the lifespan of each task.  Internally,
it can map task IDs to wheel IDs with much shorter lifespans.

Internally, wheel IDs can change throughout a task&#39;s lifetime.  The task
manager will update the wheel ID associated with the task as connections
are re-established.

Externally, the rest of the application has a single, stable ID for each
task.

---

Regarding the session variable in the wheel:

By allowing one object to remove a watcher from another, we open up
semantics where any object can do as it pleases with another&#39;s
resources.  I&#39;d like to explore less permissive options, if they&#39;re
available.

POE has a lot of optional checks, one of which may already catch the
problem.  They are disabled by default because they incur significant
performance penalties.  You can try them by setting POE_ASSERT_DEFAULT=1
in your shell environment.


Sean Pieper
Engineer
Viable, Inc.
VRS: ViableVRS.tv
www.viable.net
sean.pieper@viable.net
Office: 240-292-0222 x244
VSN: viablepieper


This e-mail, including any attachments may contain information that is protected by law as PRIVILEGED AND CONFIDENTIAL and is intended solely for the use of the recipient or the employee or agent responsible for delivering the message to the recipient. Please note that if you are not the intended recipient, you are hereby notified that any dissemination, copying, distribution, retention, re-transmission, printing or any other use of this e-mail or the information contained herein is strictly prohibited. If you have received this e-mail communication in error, please immediately send an e-mail reply to notify the sender and immediately and permanently delete this e-mail from your computer system. Thank you.
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;03&nbsp;22:52:57&nbsp;2009</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m not sure if there&#39;s anything left to resolve.  Please reopen if you
feel that something&#39;s not satisfactory.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;03&nbsp;22:52:58&nbsp;2009</span>
    <span class="description">RCAPUTO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
