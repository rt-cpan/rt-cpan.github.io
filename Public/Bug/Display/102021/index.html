<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #102021 for Palm-ThinkDB: More fixes for ThinkDB.pm</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #102021 for Palm-ThinkDB: More fixes for ThinkDB.pm</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Palm-ThinkDB/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Palm-ThinkDB/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Palm-ThinkDB/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Palm-ThinkDB/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Palm-ThinkDB">Palm-ThinkDB CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">102021</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Palm-ThinkDB/Active/">Palm-ThinkDB</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Alan.Wehmann [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24488-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24489-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;09&nbsp;12:26:00&nbsp;2015</span>
    <span class="description">Alan.Wehmann [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> More fixes for ThinkDB.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 9 Feb 2015 11:25:44 -0600</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Palm-ThinkDB [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> alan.wehmann [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">What follows is my latest patch file for ThinkDB.pm.  It includes
previously reported fixes, plus fixes for more problems that I have
run across:

1&#41; In the type 87 database record I noticed in one of my
SmartList-To-Go databases that the usual pattern of two null
characters following field names was--at times--two null characters
with an extraneous character between them.  Unmodified ThinkDB.pm
couldn&#39;t handle this alteration in the usual pattern.

2&#41; In fields that are lists, or in the list of Categories, unmodified
ThinkDB.pm cannot deal properly with the case where deletions to the
field list or the Categories list have been made.

--- ./original/ThinkDB.pm       2001-06-12 15:11:10.000000000 -0500
+++ ./original/fixed/ThinkDB.pm 2015-02-09 11:01:28.000000000 -0600
@@ -58,7 +58,7 @@
     
     # Column names!  Yowch.
     if &#40;$record_type == 1&#41; {
-        my &#40;$numcols, @trash, $tcnum, $tctype, $tcname, $tidx&#41;;
+        my &#40;$numcols, @trash, $tcnum, $tctype, $tcname, $tidx, $bool&#41;;
         _debug_print&#40;&#34;Columns:\n&#34;&#41;;
         $data = substr $data, 1;
         &#40;$numcols, @trash&#41; = unpack&#40;&#34;C13&#34;, $data&#41;;
@@ -67,11 +67,20 @@
         for &#40;my $i = 1; $i &lt;= $numcols; $i++&#41; {
             &#40;@trash[0..1], $tcnum, $tctype, @trash[0..9]&#41; = unpack&#40;&#34;C13&#34;, $data&#41;;
             $tidx = index&#40;$data, &#34;\000&#34;, 14&#41;;
-            $tcname = substr&#40;$data, 14, $tidx - 14&#41;;
-            _debug_printf&#40;&#34; i: $i  colnum: %03d  coltype: %02d  colname: &#39;%s&#39;\n&#34;, $tcnum, $tctype, $tcname&#41;;
+           # deal with case where two null characters don&#39;t follow field name
+           #  in rare cases there is an extraneous character present, between the
+           #  two null characters
+           $bool = &#40;substr&#40;$data, $tidx + 1, 1&#41; ne &#34;\000&#34;&#41;;
+           if &#40;$bool&#41; {
+               die &#34; trouble with field names, stopping at&#34;
+                   if substr&#40;$data, $tidx + 2, 1&#41; ne &#34;\000&#34;;
+           }
+           $tcname = substr&#40;$data, 14, $tidx - 14&#41;;
+            _debug_printf&#40;&#34; i: $i  colnum: %03d  coltype: %02d  colname: &#39;%s&#39;\n&#34;, 
+                         $tcnum, $tctype, $tcname&#41;;
             $self-&gt;{cols}[$tcnum]{type} = $tctype;
             $self-&gt;{cols}[$tcnum]{name} = $tcname;
-
+           $tidx++ if $bool;
             $data = substr $data, $tidx;
         }
         _debug_print&#40;&#34;\n&#34;&#41;;
@@ -79,20 +88,25 @@
     # List items
     elsif &#40;$record_type &gt; 2 &#38;&#38;
            $record_type &lt; 82&#41; {
-        my &#40;@list, $colid, $num, @order&#41;;
+        my &#40;@list, @list2, $colid, $num, @order, $idx&#41;;
         $data = substr $data, 1;
         $colid = $record_type - 2;
         &#40;$num&#41; = unpack&#40;&#34;C&#34;, $data&#41;;
         if &#40;$num &gt; 0&#41; {
-            &#40;@order&#41; = unpack&#40;&#34;C$num&#34;, $data&#41;;
+            &#40;@order&#41; = unpack&#40;&#34;C$num&#34;, substr $data, 1&#41;;
             &#40;@list&#41;  = split&#40;&#34;\000&#34;, substr&#40;$data, $num + 1&#41;, $num + 1&#41;;
             # get rid of trailing garbage!
             pop @list;
             # Sort according to order?  Not needed -- only for aesthetics
             #&#40;@list&#41; = @list[sort { $order[$a] &lt;=&gt; $order[$b] } 0 .. $#list];
-
+           $idx = 0;
+           foreach &#40;@order&#41; {
+               @list2[$_] = @list[$idx];
+               $idx++;
+           }
             $self-&gt;{list}{$colid} = \@list;
-            
+           $self-&gt;{list2}{$colid} = \@list2;
+           $self-&gt;{order}{$colid} = \@order;
             _debug_print&#40;&#34;Record ID: &#34;, $record{id}, &#34;\n&#34;,
                          &#34; List Record for Column $colid\n&#34;,
                          &#34; Ordering: &#34;, join&#40;&#34;, &#34;, @order&#41;, &#34;\n&#34;,
@@ -107,11 +121,12 @@
 
         # Unpack a record
         my $foo;
-        my &#40;$type, $id&#41; = unpack &#34;CxN&#34;, $data;
+        my &#40;$type, $cat, $id&#41; = unpack &#34;CCN&#34;, $data;
         _debug_printf&#40;&#34; type: %d  id: %d\n&#34;, $type, $id&#41;;
         $data = substr $data, 6;
 
         $record{idnum} = $id;
+       $record{category} = $cat;
         if &#40;$id &gt; $self-&gt;{high_id}&#41; {
           $self-&gt;{high_id} = $id;
         }
@@ -145,7 +160,7 @@
             }
             # Float
             elsif &#40;$ctype == 4&#41; {
-                my &#40;@val&#41; = unpack&#40;&#34;s2&#34;, $data&#41;;
+                my &#40;@val&#41; = unpack&#40;&#34;f&gt;&#34;, $data&#41;;
                 _debug_printf&#40;&#34; col: %02d  data: %s\n&#34;, $cid, join&#40;&#39;,&#39;, @val&#41;&#41;;
                 $record{col}{$cid} = $val[0];
                 $record{raw}{$cid} = substr $data, 0, 4;
@@ -154,7 +169,7 @@
             # List!
             elsif &#40;$ctype == 5&#41; {
                 my &#40;$val&#41; = unpack&#40;&#34;C&#34;, $data&#41;;
-                $record{col}{$cid} = $self-&gt;{list}{$cid}[$val - 1];
+                $record{col}{$cid} = $self-&gt;{list2}{$cid}[$val];
                 _debug_printf&#40;&#34; col: %02d  idx: %d  val: &#39;%s&#39;\n&#34;,
                               $cid, $val, $record{col}{$cid}&#41;;
                 $data = substr $data, 1;
@@ -291,7 +306,7 @@
             $record-&gt;{idnum} = ++$self-&gt;{high_id};
         }
         
-        $retval = pack&#40;&#34;CxN&#34;, 87, $record-&gt;{idnum}&#41;;
+        $retval = pack&#40;&#34;CCN&#34;, 87, $record-&gt;{category}, $record-&gt;{idnum}&#41;;
         foreach my $field &#40;sort { $a &lt;=&gt; $b } keys %{$record-&gt;{col}}&#41; {
             $ctype = $self-&gt;{cols}[$field]{type};
 
@@ -311,9 +326,14 @@
             elsif &#40;$ctype == 3&#41; {
                 $retval .= pack&#40;&#34;N&#34;, $record-&gt;{col}{$field}&#41;;
             }
+           #Float
+           elsif &#40;$ctype == 4&#41; {
+               $retval .= pack&#40;&#34;f&gt;&#34;, $record-&gt;{col}{$field}&#41;;
+           }
+           
             # List
             elsif &#40;$ctype == 5&#41; {
-                $retval .= pack&#40;&#34;C&#34;, $self-&gt;list_lookup&#40;$field, $record-&gt;{col}{$field}&#41;&#41;;
+                $retval .= pack&#40;&#34;C&#34;, $self-&gt;list_lookup_2&#40;$field, $record-&gt;{col}{$field}&#41;&#41;;
             }
             # Checkbox
             elsif &#40;$ctype == 6&#41; {
@@ -419,6 +439,19 @@
         }
     }
     return 0;
+}
+
+sub list_lookup_2 {
+    my $self = shift;
+    my $cid  = shift;
+    my $txt  = shift;
+
+    for &#40;my $i = 0; $i &lt;= $#{$self-&gt;{list2}{$cid}}; $i++&#41; {
+        if &#40;$self-&gt;{list2}{$cid}[$i] eq $txt&#41; {
+            return $i;
+        }
+    }
+    return 0;
 }
 
 sub add_to_list {

-- 
Alan Wehmann
Alan.Wehmann@gmail.com
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
