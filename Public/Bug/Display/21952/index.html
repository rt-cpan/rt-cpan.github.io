<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #21952 for CGI-Session: CGI::Session alters custom data and yield to a wrong behavior&#40;CGI::Session bug report&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #21952 for CGI-Session: CGI::Session alters custom data and yield to a wrong behavior&#40;CGI::Session bug report&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/CGI-Session/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/CGI-Session/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/CGI-Session/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/CGI-Session/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/CGI-Session">CGI-Session CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">21952</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/CGI-Session/Active/">CGI-Session</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
fporcher [...] smartech.pf

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-5872-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-5873-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;08&nbsp;06:21:49&nbsp;2006</span>
    <span class="description">fporcher [...] smartech.pf -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Franck PORCHER &lt;fporcher [...] smartech.pf&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CGI::Session alters custom data and yield to a wrong behavior&#40;CGI::Session bug report&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 08 Oct 2006 00:10:36 -1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> markstos [...] cpan.org,  sherzodr [...] cpan.org,  bug-Cgi-Session [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Franck Porcher &lt;fporcher [...] smartech.pf&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Mark &#38; Sherzod


I just started yesterday to use CGI::Session &#40;as an embedded component 
of CGI::Forge &#41;, and would like to report a wrong behavior.

-----------------------------------------------------
My environment :

CGI::Session : Version 4.14
uname -a : Linux perl.smartech.pf 2.6.16.4 #1 PREEMPT Mon Apr 17 
15:12:40 TAHT 2006 i686 AMD Athlon&#40;TM&#41; XP 2800+ unknown GNU/Linux
perl -v : This is perl, v5.8.7 built for i386-linux

-----------------------------------------------------
My code  &#40;summarized&#41; :

1 my $opt_dsn = ...
2 my $cgiquery = ...
3 my $s = CGI::Session-&gt;load&#40;&#39;driver:file;serializer:default&#39;, 
$cgiquery, $opt_dsn&#41; or die;
4 $s = CGI::Session-&gt;new&#40;&#39;driver:file;serializer:default&#39;, $cgiquery, 
$opt_dsn&#41; if $s-&gt;is_empty&#40;&#41;;
5 &lt;END OF PROG&gt;

-----------------------------------------------------
The suspicious behavior...

- The statement line 3 leads to the creation of a new CGI::Session 
object, say A, and to the creation of a CGI::Session::Sriver::file 
driver object, say B.

- Statement 4 resets $s, so A &#38; B, no longer reachable are DESTROYed and 
garbage collected.The destruction of A is caught in CGI/Session.pm to 
automagically call CGI::Session::flush&#40;&#41; which does nothing in this 
case. A new CGI::Session object is created and assigned to $s, say C, which
shares the driver B &#40;see log below&#41;.

- When the end of program is reached &#40;line 5 above&#41;,  C is caught to be 
flushed by DESTROY. B having already disappeared out the scene, a
new driver is specially created at this time of death only to allow the 
flushing &#40;DESTROY &gt;&gt; flush&#40;&#41; &gt;&gt; CGI::Session::_driver&#41;.
This new driver ignores $opt_dsn &#40;for instance Directory =&gt; /my/temp&#41;, 
so the flushing creates or updates session files
at the wrong place...

And it appears that
C-&gt;{_DRIVER_ARGS} is also gone,

-----------------------------------------------------
My analysis of the problem

Statement line 3 leads CGI::Session::Driver::new&#40;&#41; to physically alter 
its argument &#40;here $opt_dsn&#41; by turning it into a driver object &#40;bless 
$opt_dsn, &lt;driver&gt;&#41;.
 
So $opt_dsn data is no longer a private custom data structure : it has 
turned into an object &#40;B&#41; elligible for a premature DESTROY
when it goes out of reach after statement 4 resets $s.

As such, and unfortunate as it is, the garbage collection of B is also 
that of $opt_dsn, and that of $s-&gt;{_DRIVER_ARGS},
which proves to be unavailable &#40;long gone&#41; when used by 
CGI::Session::_driver&#40;&#41; to create a driver for the late flushing 
&#40;&lt;driverClass&gt;-&gt;new&#40; $self-&gt;{_DRIVER_ARGS} &#41;.

-------------------
My suggestion

My idea is that the custom data, here $opt_dsn, *should not* be altered 
by the underlying CGI::Session logic.
My suggestion to restore a good behavior is to prevent 
CGI::Session::Driver to turn its argument into an object.
This is easily done by patching CGI::Forge::Driver::new&#40;&#41; as follows
&#40; *bold* shows the suggested patch, /*bold italic*/ shows my other 
&#34;perturbations&#34; &#41; :

sub new {
    /*my &#40;$class, $args&#41; = @_;
    croak &#34;Invalid argument type passed to driver: &#34; . Dumper&#40;$args&#41; if 
$args &#38;&#38; ! ref $args;
    $args ||= {};*/
 
    # my $self = bless &#40;$args, $class&#41;      # wrong : $args is a custom 
data that shouldn&#39;t be altered
    my $self = bless &#40;*{%$args}*, $class&#41;;  # Instead make it a 
shallow-clone, and only alter the clone !
    return $self if $self-&gt;init&#40;&#41;;
    return $self-&gt;set_error&#40; &#34;%s-&gt;init&#40;&#41; returned false&#34;, $class&#41;;
}

I&#39;ve applied it to my CGI::Session version and the suspicious behavior 
was removed.

Cheers, and good luck.

I hope that CGI::Session stays around up &#38; running : it&#39;s a fine suite 
of module. Thanks for contributing it.


Franck PORCHER

======================= LOGS==========================
/*Statement line 3 ...
*/Oct  7 16:32:21 perl logger: [CGISESSION::LOAD::1] SESSION: 
CGI::Session=HASH&#40;0x87808ac&#41;
Oct  7 16:32:21 perl logger: [CGISESSION::_driver] SESSION: 
CGI::Session=HASH&#40;0x87808ac&#41;  DRIVER:    *DRIVERARGS: _HASH&#40;0x87b3a20&#41;_*
Oct  7 16:32:21 perl logger: [DRIVER::INIT] DRIVER:* 
CGI::Session::Driver::file=_HASH&#40;0x87b3a20&#41;_*   DIRECTORY: .
Oct  7 16:32:21 perl logger: [CGISESSION::LOAD::2] SESSION: 
CGI::Session=HASH&#40;0x87808ac&#41; DRIVER: 
CGI::Session::Driver::file=HASH&#40;0x87b3a20&#41;

==&gt; The 3 lines above show how $opt_dsn &#40;*_HASH&#40;0x87b3a20&#41;_*&#41; is turned 
into an object &#40;_*CGI::Session::Driver::file=HASH&#40;0x87b3a20&#41;*_&#41;


/*Statement lien 4 &#40;rest of $s&#41; ...*/
Oct  7 16:32:21 perl logger: [*CGISESSION::DESTROY*] SESSION: 
CGI::Session=HASH&#40;0x87808ac&#41;  DRIVER:
Oct  7 16:32:21 perl logger: [*DRIVER::DESTROY*] DRIVER: 
_*CGI::Session::Driver::file=HASH&#40;0x87b3a20&#41;*_

==&gt; these 2 lines show that &#40;blessed&#41;$opt_dsn is DESTROYED prematurately..

-- 
Franck Porcher, Docteur ès Sciences &#40;Paris VI&#41;, Informatique théorique

----------------------------------------------------------------------
SMART Technologies                         Les solutions intelligentes
Service et Ingénierie Informatique
Solutions Open Source Linux
1995-2006 : Premier fournisseur en Polynésie française

Tél:    &#40;689&#41; 550 815
Vini:   &#40;689&#41; 711 911
Email:  fporcher@smartech.pf
Web:    www.smartech.pf
----------------------------------------------------------------------
&#34;You can analyze the past but you have to design the future.&#34;
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;24&nbsp;10:11:32&nbsp;2006</span>
    <span class="description">mark [...] summersault.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #21952] CGI::Session alters custom data and yield to a wrong behavior&#40;CGI::Session bug report&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 24 Oct 2006 10:08:41 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI-Session [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Stosberg &lt;mark [...] summersault.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Franck Porcher via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I just started yesterday to use CGI::Session &#40;as an embedded component 
&gt; of CGI::Forge &#41;, and would like to report a wrong behavior.
</div>
Frank,

Thanks for the thorough report. We appreciate the contribution.

It seems like you have a rather clear idea of what the issue is, and
what the solution is.

It would be ideal if you could express the issue in a Test::More style
test case we could add to the test suite. From the code you have below
it looks like you are almost there.

Then, if you fee confident about the fix, go ahead and submit a patch
for the code and docs as needed to completely resolve the issue.

Otherwise, someone else will get to this eventually.

Thanks!

   Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;24&nbsp;10:11:33&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;06&nbsp;13:42:33&nbsp;2006</span>
    <span class="description">fenlisesi [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> fenlisesi [...] gmail.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">How about the attached attempt at a fix for this?

--Ali Isik

On Tue Oct 24 10:11:32 2006, mark@summersault.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Franck Porcher via RT wrote:
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; I just started yesterday to use CGI::Session &#40;as an embedded component 
&gt; &gt; of CGI::Forge &#41;, and would like to report a wrong behavior.
</div>&gt; 
&gt; Frank,
&gt; 
&gt; Thanks for the thorough report. We appreciate the contribution.
&gt; 
&gt; It seems like you have a rather clear idea of what the issue is, and
&gt; what the solution is.
&gt; 
&gt; It would be ideal if you could express the issue in a Test::More style
&gt; test case we could add to the test suite. From the code you have below
&gt; it looks like you are almost there.
&gt; 
&gt; Then, if you fee confident about the fix, go ahead and submit a patch
&gt; for the code and docs as needed to completely resolve the issue.
&gt; 
&gt; Otherwise, someone else will get to this eventually.
&gt; 
&gt; Thanks!
&gt; 
&gt;    Mark
</div></div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Session-original.pm	2006-11-04 20:45:10.000000000 +0200
+++ Session-fixbug21952.pm	2006-11-06 20:41:36.000000000 +0200
@@ -668,7 +668,17 @@ sub load {
 
         # load&#40;$dsn, $query, \%dsn_args&#41;;
 
-        $self-&gt;{_DRIVER_ARGS} = $dsn_args if defined $dsn_args;
+        if &#40;defined $dsn_args&#41; {
+            if &#40;ref&#40; $dsn_args &#41; eq &#39;HASH&#39;&#41; {
+                my $data_href = $self-&gt;{_DRIVER_ARGS};
+                for my $k &#40;keys %$dsn_args&#41; {
+                    $data_href-&gt;{ $k } = $dsn_args-&gt;{ $k };
+                }
+            }
+            else {
+                ## carp about bad $dsn_args here
+            }
+        }
 
     }
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;06&nbsp;13:49:41&nbsp;2006</span>
    <span class="description">fenlisesi [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> fenlisesi [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">No, this seems to have broken some tests.  Please
ignore it while I check those out.

--Ali Isik

On Mon Nov 06 13:42:33 2006, fenlisesi@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; How about the attached attempt at a fix for this?
&gt; 
&gt; --Ali Isik
&gt; 
&gt; On Tue Oct 24 10:11:32 2006, mark@summersault.com wrote:
<div class="message-stanza open">&gt; &gt; Franck Porcher via RT wrote:
<div class="message-stanza open">&gt; &gt; &gt; 
&gt; &gt; &gt; I just started yesterday to use CGI::Session &#40;as an embedded
</div></div></div>component 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; of CGI::Forge &#41;, and would like to report a wrong behavior.
</div>&gt; &gt; 
&gt; &gt; Frank,
&gt; &gt; 
&gt; &gt; Thanks for the thorough report. We appreciate the contribution.
&gt; &gt; 
&gt; &gt; It seems like you have a rather clear idea of what the issue is, and
&gt; &gt; what the solution is.
&gt; &gt; 
&gt; &gt; It would be ideal if you could express the issue in a Test::More style
&gt; &gt; test case we could add to the test suite. From the code you have below
&gt; &gt; it looks like you are almost there.
&gt; &gt; 
&gt; &gt; Then, if you fee confident about the fix, go ahead and submit a patch
&gt; &gt; for the code and docs as needed to completely resolve the issue.
&gt; &gt; 
&gt; &gt; Otherwise, someone else will get to this eventually.
&gt; &gt; 
&gt; &gt; Thanks!
&gt; &gt; 
&gt; &gt;    Mark
</div>&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;06&nbsp;13:54:29&nbsp;2006</span>
    <span class="description">mark [...] summersault.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #21952] CGI::Session alters custom data and yield to a wrong behavior&#40;CGI::Session bug report&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 06 Nov 2006 13:51:35 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI-Session [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Stosberg &lt;mark [...] summersault.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ali ISIK via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: CGI-Session
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=21952">http://rt.cpan.org/Ticket/Display.html?id=21952</a></span> &gt;
&gt; 
&gt; No, this seems to have broken some tests.  Please
&gt; ignore it while I check those out.
</div>
Thanks. In any case, here&#39;s a simpler way to make a shallow copy:

%$dst = %$src;

If we need a deep copy, a cloning module should probably be used.

     Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;06&nbsp;14:19:08&nbsp;2006</span>
    <span class="description">fenlisesi [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> fenlisesi [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Deep copies are likely to be expensive, though.  If deeper
structure is allowed within \%dsn_args and this is a
rare, non-typical scenario, perhaps we should just put a
warning in the docs saying something like &#34;If your %dsn_args
has deeper structure in it and you want to use it with
multiple constructor calls, you must generate a deep copy
of it and use that&#34;?

--Ali Isik

On Mon Nov 06 13:54:29 2006, mark@summersault.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ali ISIK via RT wrote:
<div class="message-stanza open">&gt; &gt;        Queue: CGI-Session
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=21952">http://rt.cpan.org/Ticket/Display.html?id=21952</a></span> &gt;
&gt; &gt; 
&gt; &gt; No, this seems to have broken some tests.  Please
&gt; &gt; ignore it while I check those out.
</div>&gt; 
&gt; Thanks. In any case, here&#39;s a simpler way to make a shallow copy:
&gt; 
&gt; %$dst = %$src;
&gt; 
&gt; If we need a deep copy, a cloning module should probably be used.
&gt; 
&gt;      Mark
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;06&nbsp;20:23:27&nbsp;2006</span>
    <span class="description">mark [...] summersault.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #21952] CGI::Session alters custom data and yield to a wrong behavior&#40;CGI::Session bug report&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 06 Nov 2006 20:22:50 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI-Session [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Stosberg &lt;mark [...] summersault.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ali ISIK via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: CGI-Session
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=21952">http://rt.cpan.org/Ticket/Display.html?id=21952</a></span> &gt;
&gt; 
&gt; Deep copies are likely to be expensive, though.  If deeper
&gt; structure is allowed within \%dsn_args and this is a
&gt; rare, non-typical scenario, perhaps we should just put a
&gt; warning in the docs saying something like &#34;If your %dsn_args
&gt; has deeper structure in it and you want to use it with
&gt; multiple constructor calls, you must generate a deep copy
&gt; of it and use that&#34;?
</div>
I think it&#39;s reasonable to just stick with a shallow copy for now.
Perhaps somewhere in the notes for driver authors we could add a note
about this, but it does seem particular unusual to configure a session
module which a such a complex data structure.

   Mark

-- 
<span class="clickylink"><a target="new" rel="nofollow" href="http://mark.stosberg.com/">http://mark.stosberg.com/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;07&nbsp;03:40:11&nbsp;2006</span>
    <span class="description">fporcher [...] smartech.pf -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #21952] CGI::Session alters custom data and yield to a wrong behavior&#40;CGI::Session bug report&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 06 Nov 2006 22:32:55 -1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI-Session [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Franck Porcher &lt;fporcher [...] smartech.pf&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The shallow copy was the idea I first proposed as a patch along with the 
discovery of the problem:

# ORIGINAL
my $self = bless &#40;$args, $class&#41;      # $args is a custom data and 
altered as a CGI::Session:xxx object !

# PROPOSED PATCH &#40;that I called a shallow-clone, which is exactly the 
same thing proposed by Mark : a shallow copy&#41;
my $self = bless &#40;*{%$args}*, $class&#41;;  # Create a shallow copy of $args 
should be sufficient in most cases.

I&#39;ve applied this patch to my CGI::Session version and the suspicious 
behavior was removed. I&#39;ve been quite happy since 8-&#41;
As what you suggest Mark, regarding Test::More, I never used it yet, but 
could easily make it, along with some description, if we agree with
the idea of the proposed patch. Let me know.
Cheers,

        Franck Porcher

Ali ISIK via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=21952">http://rt.cpan.org/Ticket/Display.html?id=21952</a></span> &gt;
&gt;
&gt;Deep copies are likely to be expensive, though.  If deeper
&gt;structure is allowed within \%dsn_args and this is a
&gt;rare, non-typical scenario, perhaps we should just put a
&gt;warning in the docs saying something like &#34;If your %dsn_args
&gt;has deeper structure in it and you want to use it with
&gt;multiple constructor calls, you must generate a deep copy
&gt;of it and use that&#34;?
&gt;
&gt;--Ali Isik
&gt;
&gt;On Mon Nov 06 13:54:29 2006, mark@summersault.com wrote:
&gt;  
&gt;
<div class="message-stanza open">&gt;&gt;Ali ISIK via RT wrote:
&gt;&gt;    
&gt;&gt;
<div class="message-stanza open">&gt;&gt;&gt;       Queue: CGI-Session
&gt;&gt;&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=21952">http://rt.cpan.org/Ticket/Display.html?id=21952</a></span> &gt;
&gt;&gt;&gt;
&gt;&gt;&gt;No, this seems to have broken some tests.  Please
&gt;&gt;&gt;ignore it while I check those out.
&gt;&gt;&gt;      
&gt;&gt;&gt;
</div>&gt;&gt;Thanks. In any case, here&#39;s a simpler way to make a shallow copy:
&gt;&gt;
&gt;&gt;%$dst = %$src;
&gt;&gt;
&gt;&gt;If we need a deep copy, a cloning module should probably be used.
&gt;&gt;
&gt;&gt;     Mark
&gt;&gt;
&gt;&gt;    
&gt;&gt;
</div>&gt;
&gt;
&gt;
&gt;  
&gt;
</div>
-- 
Franck Porcher, Docteur ès Sciences &#40;Paris VI&#41;, Informatique théorique

----------------------------------------------------------------------
SMART Technologies                         Les solutions intelligentes
Service et Ingénierie Informatique
Solutions Open Source Linux
1995-2006 : Premier fournisseur en Polynésie française

Tél:    &#40;689&#41; 550 815
Vini:   &#40;689&#41; 711 911
Email:  fporcher@smartech.pf
Web:    www.smartech.pf
----------------------------------------------------------------------
&#34;You can analyze the past but you have to design the future.&#34;
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;23&nbsp;11:10:21&nbsp;2006</span>
    <span class="description">MARKSTOS [...] cpan.org -  Reference to ticket #17299 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;23&nbsp;11:10:22&nbsp;2006</span>
    <span class="description">MARKSTOS [...] cpan.org -  Reference to ticket #17299 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;23&nbsp;13:37:21&nbsp;2006</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CGI::Session alters custom data and yield to a wrong behavior &#40;fixed&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> sherzodr [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is fixed in SVN now, with a  regression test for it. I also tracked
own and fixed the SQLite driver bug that Sherzod exposed as part of his
work on this. 

This change will appear in the next release, perhaps Soon, with credit
to you. 

Thanks for the report. 

  Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;23&nbsp;13:37:28&nbsp;2006</span>
    <span class="description">MARKSTOS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
