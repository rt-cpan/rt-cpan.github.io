<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #28949 for POE-Component-Server-HTTP: PostHandler only once.  Better connection_close &#40;with tests&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #28949 for POE-Component-Server-HTTP: PostHandler only once.  Better connection_close &#40;with tests&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/POE-Component-Server-HTTP/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/POE-Component-Server-HTTP/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/POE-Component-Server-HTTP/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/POE-Component-Server-HTTP/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE-Component-Server-HTTP">POE-Component-Server-HTTP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">28949</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/POE-Component-Server-HTTP/Active/">POE-Component-Server-HTTP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
perl [...] pied.nu

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-26610-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.09    </td>
  </tr>
  <tr id="CF-26611-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;23&nbsp;00:02:29&nbsp;2007</span>
    <span class="description">perl [...] pied.nu -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> PostHandler only once.  Better connection_close &#40;with tests&#41;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This patch will bring 0.09 up to date with my internal version of
PoCo::Server::HTTP, including all the fixes that I&#39;ve had to implement
since 0.07.

The included patch makes sure that PostHandler is only called once per
request.  Previously, it could be called multiple times if an error
occurred.  With test case.

It also includes a work around where some versions of POE and perl don&#39;t
call DESTROY on a deleted wheel.

It also tweaks the POD &#40;20_stream.t not 30_stream.t&#41;

Also, some tweaks to the test cases.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Philip_Gwyn.Queue-cleanup.connection_close.01.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -rub POE-Component-Server-HTTP-0.09/lib/POE/Component/Server/HTTP.pm POE-Component-Server-HTTP-0.09-PG/lib/POE/Component/Server/HTTP.pm
--- POE-Component-Server-HTTP-0.09/lib/POE/Component/Server/HTTP.pm	2006-05-23 16:45:07.000000000 -0400
+++ POE-Component-Server-HTTP-0.09-PG/lib/POE/Component/Server/HTTP.pm	2007-08-22 23:44:20.000000000 -0400
@@ -98,6 +98,9 @@
                 my &#40;$kernel, $session, $heap&#41; = @_[KERNEL, SESSION, HEAP];
                 $kernel-&gt;call&#40;$tcp_alias, &#34;shutdown&#34;&#41;;
                 $kernel-&gt;alias_remove&#40;$alias&#41;;
+                foreach my $id &#40;keys %{$heap-&gt;{wheels}}&#41; {
+                    close_connection&#40;$heap, $id&#41;;
+                }
             },
         },
         heap =&gt; { self =&gt; $self }
@@ -134,17 +137,22 @@
 }
 
 sub error_queue {
-    return [qw&#40;
-        Map
-        ErrorHandler
-        PostHandler
-        Cleanup
-       &#41;];
+    my&#40;$self, $c, $pre&#41;=@_;
+
+    # If client closed connect, we don&#39;t want PostHandler called twice
+    if&#40; $c-&gt;{client_closed} and $c-&gt;{response_sent} and not $c-&gt;{post_done} &#41; {
+        warn &#34;Client closed, response_sent, but PostHandler not called?&#34;;
+    }
+    return [qw&#40;Map ErrorHandler Cleanup&#41;]
+                if $c-&gt;{client_closed} and $c-&gt;{post_done};
+    return [qw&#40; Map PreHandler ErrorHandler PostHandler Cleanup &#41;] if $pre;
+    return [qw&#40; Map ErrorHandler PostHandler Cleanup &#41;];
 }
 
 # Set up queue for handling this request
 sub rebuild_queue {
-    my&#40; $self, $handlers&#41; = @_;
+    my&#40; $self, $c&#41; = @_;
+    my $handlers = $c-&gt;{handlers};
     my $now = $handlers-&gt;{Queue}[0];      # what phase are we about to do?
 
     if &#40;not $now&#41; {                      # this means we are post Cleanup
@@ -154,11 +162,13 @@
         $handlers-&gt;{Queue} = [&#39;Map&#39;, &#39;ErrorHandler&#39;, &#39;Cleanup&#39;];
         # Note : sub error set up fake request/response objects, etc
     }
-    elsif &#40;$now eq &#39;TransHandler&#39; or $now eq &#39;Map&#39; or
-           $now eq &#39;PreHandler&#39; or $now eq &#39;ContentHandler&#39; or
+    elsif &#40;$now eq &#39;TransHandler&#39; or $now eq &#39;Map&#39; &#41; {
+        $handlers-&gt;{Queue}=$self-&gt;error_queue&#40;$c, 1&#41;;
+    }
+    elsif &#40;$now eq &#39;PreHandler&#39; or $now eq &#39;ContentHandler&#39; or
            $now eq &#39;Send&#39; or $now eq &#39;PostHandler&#39;&#41; {
 
-        $handlers-&gt;{Queue}=$self-&gt;error_queue;
+        $handlers-&gt;{Queue}=$self-&gt;error_queue&#40;$c&#41;;
     }
     elsif &#40;$now eq &#39;Cleanup&#39;&#41; {
         # we need Map to turn set up ErrorHandler
@@ -170,6 +180,23 @@
     $handlers-&gt;{PreHandler}  = [];
 }
 
+sub close_connection {
+    my&#40;$heap, $id&#41;=@_;
+
+    DEBUG and warn &#34;Close connection&#34;;
+    my $connection=$heap-&gt;{c}-&gt;{$id};
+
+    delete&#40;$connection-&gt;{handlers}&#41;;
+    delete&#40;$connection-&gt;{wheel}&#41;;
+    delete&#40;$heap-&gt;{c}-&gt;{$id}&#41;;
+
+    my $w=delete $heap-&gt;{wheels}-&gt;{$id};
+    # WORK AROUND: Some versions of Perl and POE don&#39;t DESTROY wheels properly
+    $w-&gt;DESTROY if $w;
+    return;
+}
+
+
 sub accept {
     my &#40;$socket,$remote_addr, $remote_port&#41; = @_[ARG0, ARG1, ARG2];
     my $self = $_[HEAP]-&gt;{self};
@@ -184,8 +211,10 @@
         ContentHandler =&gt; undef,
         PostHandler  =&gt; [],
         # IMHO, Queue should be set in &#39;input&#39; --PG
+        # 2006/01 -- no, because rebuild_queue needs to see it set --PG
         Queue =&gt; $self-&gt;handler_queue,
     };
+    $connection-&gt;{post_done} = 0;
 
     my $wheel = POE::Wheel::ReadWrite-&gt;new&#40;
         Handle =&gt; $socket,
@@ -271,8 +300,11 @@
         $c-&gt;{request}-&gt;is_error&#40;1&#41;;
         $c-&gt;{response}-&gt;is_error&#40;1&#41;;
 
+        # mark this connection as closed
+        $c-&gt;{client_closed}=1 if $op eq &#39;read&#39; and $errnum==0;
+
         # and rebuild the queue
-        $self-&gt;rebuild_queue&#40;$c-&gt;{handlers}&#41;;
+        $self-&gt;rebuild_queue&#40;$c&#41;;
         $poe_kernel-&gt;yield&#40;&#39;execute&#39;,$id&#41;;
     }
 }
@@ -306,12 +338,13 @@
 
         if &#40;$state eq &#39;Map&#39;&#41; {
             $self-&gt;state_Map&#40; $request-&gt;uri ? $request-&gt;uri-&gt;path : &#39;&#39;,
-                              $handlers, $request &#41;;
+                              $handlers, $request, $connection &#41;;
             shift @{$handlers-&gt;{Queue}};
             next;
         }
         elsif &#40;$state eq &#39;Send&#39;&#41; {
-            $self-&gt;state_Send&#40; $response,  $_[HEAP]-&gt;{wheels}-&gt;{$id} &#41;;
+            $self-&gt;state_Send&#40; $response,  $_[HEAP]-&gt;{wheels}-&gt;{$id},
+                               $connection &#41;;
             shift @{$handlers-&gt;{Queue}};
             last;
         }
@@ -365,10 +398,7 @@
             }
             else {
                 DEBUG and warn &#34;Close connection&#34;;
-                delete&#40;$connection-&gt;{handlers}&#41;;
-                delete&#40;$connection-&gt;{wheel}&#41;;
-                delete&#40;$_[HEAP]-&gt;{c}-&gt;{$id}&#41;;
-                delete&#40;$_[HEAP]-&gt;{wheels}-&gt;{$id}&#41;;
+                close_connection&#40;$_[HEAP], $id&#41;;
             }
             last HANDLERS;
         }
@@ -376,6 +406,9 @@
             $self-&gt;{StreamHandler}-&gt;&#40;$request, $response&#41;;
             last HANDLERS;
         }
+        elsif&#40; $state eq &#39;PostHandler&#39; &#41; {
+            $connection-&gt;{post_done} = 1;
+        }
 
       DISPATCH:     # this is used for {Trans,Pre,Post}Handler
         while &#40;1&#41; {
@@ -397,10 +430,7 @@
 }
 
 sub state_Map {
-    my $self = shift;
-    my $path = shift;
-    my $handlers = shift;
-    my $request = shift;
+    my&#40; $self, $path, $handlers, $request, $c &#41; = @_;
     my $filename;
     &#40;undef, $path,$filename&#41; = File::Spec-&gt;splitpath&#40;$path&#41;;
     my @dirs = File::Spec-&gt;splitdir&#40;$path&#41;;
@@ -420,11 +450,10 @@
     DEBUG and warn &#34;check=&#34;, join &#39;,&#39;, @check;
 
     my @todo;
-    unless &#40;$request-&gt;is_error&#41; {
-        @todo=qw&#40;PreHandler ContentHandler PostHandler&#41;;
-    }
-    else {
-        @todo=qw&#40;ErrorHandler PostHandler&#41;;
+    # We need to map all the Handler phases in the queue
+    foreach my $phase &#40; @{ $c-&gt;{handlers}{Queue} } &#41; {
+        next unless $phase =~ /Handler$/;
+        push @todo, $phase
     }
 
     foreach my $path &#40;@check&#41; {
@@ -443,9 +472,9 @@
 }
 
 sub state_Send {
-    my $self = shift;
-    my $response = shift;
-    my $wheel = shift;
+    my&#40;$self, $response, $wheel, $c&#41; = @_;
+
+    $c-&gt;{response_sent}=1;
 
     $response-&gt;header&#40;%{$self-&gt;{Headers}}&#41;;
     unless &#40;$response-&gt;header&#40;&#39;Date&#39;&#41;&#41; {
@@ -647,7 +676,7 @@
         }
     }
 
-Another example can be found in t/30_stream.t.  The parts dealing with
+Another example can be found in t/20_stream.t.  The parts dealing with
 multipart/mixed are well documented and at the end of the file.
 
 NOTE: Changes in streaming mode are only verified when StreamHandler exits.
Only in POE-Component-Server-HTTP-0.09-PG/lib/POE/Component/Server: HTTP.pm~
diff -rub POE-Component-Server-HTTP-0.09/t/30_error.t POE-Component-Server-HTTP-0.09-PG/t/30_error.t
--- POE-Component-Server-HTTP-0.09/t/30_error.t	2006-05-23 16:10:35.000000000 -0400
+++ POE-Component-Server-HTTP-0.09-PG/t/30_error.t	2007-08-22 23:41:55.000000000 -0400
@@ -27,7 +27,7 @@
 
 ####################################################################
 unless &#40;$pid&#41; {                      # we are child
-    Test::Builder-&gt;new-&gt;no_ending&#40;1&#41;;
+    Test::More-&gt;builder-&gt;no_ending&#40;1&#41;;
     # stop kernel from griping
     ${$poe_kernel-&gt;[POE::Kernel::KR_RUN]} |=
                                 POE::Kernel::KR_RUN_CALLED;
@@ -76,16 +76,20 @@
 ####################################################################
 # we are the parent
 
-plan tests=&gt;11;
+plan tests=&gt;16;
 
 my $Q=1;
 my $shutdown=0;
 my $top=0;
 my $bonk=0;
+my $connected=0;
 
 my $aliases = POE::Component::Server::HTTP-&gt;new&#40;
      Port =&gt; $PORT,
      Address=&gt;&#39;localhost&#39;,
+     PreHandler =&gt; {
+            &#39;/&#39; =&gt; \&#38;pre_top,
+     },
      ContentHandler =&gt; { &#39;/&#39; =&gt; \&#38;top,
                          &#39;/honk/shutdown.html&#39; =&gt; \&#38;shutdown,
                          &#39;/bonk/&#39; =&gt; \&#38;bonk
@@ -143,6 +147,13 @@
 }
 
 #######################################
+sub pre_top
+{
+    DEBUG and warn &#34;pre_top&#34;;
+    $connected++;
+}
+
+#######################################
 sub top
 {
     my &#40;$request, $response&#41; = @_;
@@ -170,8 +181,12 @@
 sub post_top
 {
     my&#40;$request, $response&#41;=@_;
+    DEBUG and warn &#34;post_top&#34;;
+
+    $connected--;
     ok&#40;&#40;$shutdown or &#40;not $bonk and $request-&gt;is_error&#41;&#41;,
             &#34;all but shutdown requests should be errors&#34;&#41;;
+    ok&#40;0==$connected, &#34;Pre was called &#40;$connected&#41;&#34;&#41;;
 }
 
 #######################################
@@ -179,15 +194,16 @@
 {
     my&#40;$request, $response&#41;=@_;
     ok&#40;$shutdown, &#34;we are after shutdown&#34;&#41;;
+    ok&#40;0==$connected, &#34;Pre/Post was called once &#40;$connected&#41;&#34;&#41;;
 }
 
 #######################################
 sub shutdown
 {
     my &#40;$request, $response&#41; = @_;
-    DEBUG and warn &#34;SHUTDOWN&#34;;
-    $poe_kernel-&gt;post&#40;$aliases-&gt;{httpd} =&gt; &#39;shutdown&#39;&#41;;
-    $poe_kernel-&gt;post&#40;$aliases-&gt;{tcp} =&gt; &#39;shutdown&#39;&#41;;
+
+    $poe_kernel-&gt;state&#40; do_shutdown =&gt; \&#38;do_shutdown &#41;;
+    $poe_kernel-&gt;delay&#40; &#39;do_shutdown&#39;, 1 &#41;;
 
     $shutdown=1;
 
@@ -197,6 +213,15 @@
     return RC_OK;
 }
 
+#######################################
+sub do_shutdown
+{
+    DEBUG and warn &#34;DOING SHUTDOWN&#34;;
+    $poe_kernel-&gt;post&#40;$aliases-&gt;{httpd} =&gt; &#39;shutdown&#39;&#41;;
+    $poe_kernel-&gt;post&#40;$aliases-&gt;{tcp} =&gt; &#39;shutdown&#39;&#41;;
+
+}
+
 sub __peek
 {
     my&#40;$verbose&#41;=@_;
Only in POE-Component-Server-HTTP-0.09-PG/t: 30_error.t~
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
