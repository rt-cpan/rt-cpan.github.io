<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #54580 for Config-General: Many single quoted strings and -InterPolateVars causes value corruption</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #54580 for Config-General: Many single quoted strings and -InterPolateVars causes value corruption</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Config-General/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Config-General/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Config-General/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Config-General/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Config-General">Config-General CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">54580</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Config-General/Active/">Config-General</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">tlinden [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
TSHINNIC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-7696-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.44    </td>
  </tr>
  <tr id="CF-7697-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;12&nbsp;22:33:11&nbsp;2010</span>
    <span class="description">TSHINNIC [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Many single quoted strings and -InterPolateVars causes value
 corruption</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">When there are many single-quoted strings in a config line, a problem
sometimes corrupts the text, with one or more single-quoted strings
replaced with text like &#34;QUOTE279QUOTE&#34;.

A config line like
  sheep_tale  &#39;Mary&#39; &#39;had&#39; &#39;a&#39; &#39;little&#39; &#39;lamb&#39;
can sometimes be seen by a program as
  &#34;&#39;Mary&#39; &#39;had&#39; &#39;a&#39; QUOTE999QUOTE &#39;lamb&#39;&#34;

Depending on the number of lines in a config file which have multiple
single-quoted strings, this may happen only infrequently.  &#40;If there is
only one single-quoted string per line the problem will not happen.&#41;

Routine Config::General::Interpolated::_interpolate&#40;&#41; uses a method of
temporarily replacing single-quoted strings in order to avoid &#39;seeing&#39;
these when looking for  ${var}  during interpolation.  At the end of the
routine the replaced text segments are restored from a hash.

However the method for generating the hash keys is able to accidentally
*repeat* a key more than once, and then loses track of one or more
single-quoted strings.  These then don&#39;t get replaced and the weird
placeholder texts remain in the value.

The fix is to use a simple counter within the routine to generate keys
as needed.

That patch file is attached, along with a test file that demonstrates
the problem before patching, and that the problem is fixed after patch
applied.

Please note that the patch also includes the rest of the suggested patch
in a previous bug report.  Old bug
   46184  When -InterPolateEnv is enabled, -StrictVars is ignored
suggested a patch that moved some code out of _interpolate&#40;&#41; into
_interpolate_hash&#40;&#41;.  Deleting the moved code from _interpolate&#40;&#41; was
missed.  That was noticed while researching the present bug.

This bug report is also related to the first problem mentioned in bug
51494, which had an alternate solution using split&#40;&#41;.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 90_RTxxxxx_interpolate_single_quotes.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
# This test relates to the first part of the following bug report
#   CPAN RT bug report #51494
#         <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=51494">https://rt.cpan.org/Public/Bug/Display.html?id=51494</a></span>
# which was separately discovered and noted


my  $debug_here = 0;

use Test::More tests =&gt; 2;
#use Test::More qw&#40;no_plan&#41;;

use Data::Dumper;


BEGIN { use_ok &#34;Config::General&#34;};


#------------------------------------------------------------------
# Test handling of values containing *many* single-quoted strings
#   when -InterPolateVars option is set

    #  -   -   -   -   -   -   -   -   -   -   -   -   -   -
    # Create a test string value containing many single-quoted strings

    my  $duplication_count = 2000;
   #    $duplication_count =  100;

    # This produces a lot of different quoted strings with explicit ordering.
    # By using this input it becomes even more obvious what goes wrong.

    my  $text_for_test;
    foreach my $counter &#40; reverse 1 .. $duplication_count &#41; {
        $text_for_test .= &#34; &#39;luck${counter}&#39;&#34;;
    }

    # remove the extra leading space from test value, as C::G will strip 
    #   leading/trailing spaces on read, causing later mismatch on test
    $text_for_test =~ s{\A }{}; 


    # Create the config source line: key plus value
    my  $config_source_text = &#39;test_single_many &#39; . $text_for_test;

    diag qq{config_source_text: &#39;$config_source_text&#39;}      if  $debug_here &gt; 1;


    #  -   -   -   -   -   -   -   -   -   -   -   -   -   -


    $cfgo = Config::General-&gt;new&#40;
                -String          =&gt; $config_source_text,
                -InterPolateVars =&gt; 1
            &#41;;

    %hash = $cfgo-&gt;getall;

    diag&#40; Data::Dumper-&gt;Dump&#40;[ \%hash ], [qw{ *hash }]&#41; &#41;   if  $debug_here &gt; 1;

    $text_from_test = $hash{test_single_many};

    is&#40; $text_from_test, $text_for_test,
        &#34;value with single-quote strings is as expected&#34; &#41;;

    if &#40; $debug_here &#41; {
        my  @oops = $text_from_test =~ m{QUOTE\d+QUOTE}g;
        diag &#34;Found @{[ scalar @oops ]} accidents&#34;;
    }

__END__

not ok 2 - value with single-quote strings is same
#   Failed test &#39;value with single-quote strings is same&#39;
#   at t\80_interpolate.t line 56.
#          got: &#39;&#39;luck&#39; &#39;luck&#39; &#39;luck&#39; QUOTE279QUOTE &#39;luck&#39;&#39;
#     expected: &#39;&#39;luck&#39; &#39;luck&#39; &#39;luck&#39; &#39;luck&#39; &#39;luck&#39;&#39;
# Found 1 accidents

#  vim:ft=perl:ts=4:sw=4:et:is:hls:ss=10:
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Interpolated.pm.RTxxxxx.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Interpolated.pm.original	2009-07-19 15:04:51.000000000 -0500
+++ Interpolated.pm	2010-02-12 20:57:26.343373600 -0600
@@ -65,6 +65,7 @@
   # called directly by Config::General::_parse_value&#40;&#41;
   #
   my &#40;$this, $config, $key, $value&#41; = @_;
+  my $quote_counter = 100;
 
   # some dirty trick to circumvent single quoted vars to be interpolated
   # we remove all quotes and replace them with unique random literals,
@@ -72,7 +73,7 @@
   # fixes bug rt#35766
   my %quotes;
   $value =~ s/&#40;\&#39;[^\&#39;]+?\&#39;&#41;/
-    my $key = &#34;QUOTE&#34; . int&#40;rand&#40;1000&#41;&#41; . &#34;QUOTE&#34;;
+    my $key = &#34;QUOTE&#34; . &#40;$quote_counter++&#41; . &#34;QUOTE&#34;;
     $quotes{ $key } = $1;
     $key;
   /gex;
@@ -85,23 +86,12 @@
     if &#40;exists $config-&gt;{__stack}-&gt;{$var_lc}&#41; {
       $con . $config-&gt;{__stack}-&gt;{$var_lc};
     }
-    elsif &#40;$this-&gt;{InterPolateEnv}&#41; {
-      # may lead to vulnerabilities, by default flag turned off
-      if &#40;defined&#40;$ENV{$var}&#41;&#41; {
-	$con . $ENV{$var};
-      }
-      else {
-	$con;
-      }
-    }
-    else {
-      if &#40;$this-&gt;{StrictVars}&#41; {
+    elsif &#40;$this-&gt;{StrictVars}&#41; {
 	croak &#34;Use of uninitialized variable &#40;\$$var&#41; while loading config entry: $key = $value\n&#34;;
       }
-      else {
-	# be cool
-	$con;
-      }
+    else {
+      # be cool
+      $con;
     }
   }egx;
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;31&nbsp;07:09:20&nbsp;2010</span>
    <span class="description">tlinden [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;31&nbsp;07:28:26&nbsp;2010</span>
    <span class="description">tlinden [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;02&nbsp;17:29:57&nbsp;2010</span>
    <span class="description">tlinden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">fixed in 2.45. Thanks for the patch!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;02&nbsp;17:29:58&nbsp;2010</span>
    <span class="description">tlinden [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
