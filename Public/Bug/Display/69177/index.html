<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #69177 for Schedule-Cron: Timeshift option</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #69177 for Schedule-Cron: Timeshift option</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Schedule-Cron/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Schedule-Cron/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Schedule-Cron/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Schedule-Cron/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Schedule-Cron">Schedule-Cron CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">69177</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Schedule-Cron/Active/">Schedule-Cron</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
rene [...] margar.fr

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-28310-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.01_3    </td>
  </tr>
  <tr id="CF-28311-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;29&nbsp;08:42:16&nbsp;2011</span>
    <span class="description">rene [...] margar.fr -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Timeshift option</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is not a bug but a enhancement I did for the Schedule::Cron module
to fit my needs :

I needed to add what I called a timeshift to the main cron clock to
shift all scheduled jobs in the future or in the past. I am using
several perl scripts running Schedule::Cron concurrently and using
similar crontabs &#40;each one with different accounts/permissions&#41;. That
can make many jobs launched exactly at the same time creating heavy CPU
load. By shifting by some seconds or minutes internal Schedule::Cron
clock I can avoid those massive launches without altering the crontabs.

I added a new option to the object creator :

  $cron = new Schedule::Cron&#40;$dispatcher, timeshift =&gt; $ts&#41;;

  Default is 0 if option is not provided.


I added a new public method to dynamically change the timeshift :

  $cron-&gt;set_timeshift&#40;$ts&#41;

Modify global time shift for all timetable. The timeshift is subbed from
localtime to calculate next execution time for all scheduled jobs.

ts parameter must be in seconds. Default value is 0. Negative values re
allowed to shift time in the past.

Returns actual timeshift in seconds.

Example:

   $cron-&gt;set_timeshift&#40;120&#41;;
   Will delay all jobs 2 minutes in the future.

Bug:
My implementation does not rebuild the job list after changing
dynamically the timeshift. So next job execution is still using the
previous timeshift value.

Roland, you can add it to your code if you want and if you feel that it
does not break the module.

I give you a patch against 1.01_3 to add the timeshift functionnality.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> cron-timeshift.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- D:/OSP/lib/Schedule/Cron_1.01_b3.pm	ven.  3 juin 2011, 10:09:04
+++ D:/OSP/lib/Schedule/Cron.pm	mer. 29 juin 2011, 10:22:39
@@ -363,9 +363,11 @@
     die &#34;Dispatcher not a ref to a subroutine&#34; unless ref&#40;$dispatcher&#41; eq &#34;CODE&#34;;
     my $cfg = ref&#40;$_[0]&#41; eq &#34;HASH&#34; ? $_[0] : {  @_ };
     $cfg-&gt;{processprefix} = &#34;Schedule::Cron&#34; unless $cfg-&gt;{processprefix};
+    my $timeshift = $cfg-&gt;{timeshift} || 0;
     my $self = { 
                 cfg =&gt; $cfg,
                 dispatcher =&gt; $dispatcher,
+                timeshift =&gt; $timeshift,
                 queue =&gt; [ ],
                 map =&gt; { }
              };
@@ -878,7 +880,7 @@
                 die &#34;No more jobs to run\n&#34;;
             }
             my &#40;$index,$time&#41; = @{shift @{$self-&gt;{queue}}};
-            my $now = time;
+            my $now = time + $self-&gt;{timeshift};
             my $sleep = 0;
             if &#40;$time &lt; $now&#41;
             {
@@ -917,7 +919,7 @@
                 } else {
                     sleep&#40;$sleep&#41;;
                 }
-                $sleep = $time - time;
+                $sleep = $time - &#40;time + $self-&gt;{timeshift}&#41;;
             }
 
             $self-&gt;_execute&#40;$index,$cfg&#41;;
@@ -1162,6 +1164,33 @@
   }
 }
 
+=item $cron-&gt;set_timeshift&#40;$ts&#41;
+
+Modify global time shift for all timetable. The timeshift is subbed from localtime
+to calculate next execution time for all scheduled jobs.
+
+ts parameter must be in seconds. Default value is 0. Negative values are allowed to
+shift time in the past.
+
+Returns actual timeshift in seconds.
+
+Example:
+
+   $cron-&gt;set_timeshift&#40;120&#41;;
+
+   Will delay all jobs 2 minutes in the future.
+
+=cut
+
+sub set_timeshift
+{
+    my $self = shift;
+    my $value = shift || 0;
+
+    $self-&gt;{timeshift} = $value;
+    return $self-&gt;{timeshift};
+}
+
 # ==================================================
 # PRIVATE METHODS:
 # ==================================================
@@ -1289,7 +1318,7 @@
     my $new_time = $self-&gt;get_next_execution_time&#40;$entry-&gt;{time}&#41;;
     # Check, whether next execution time is *smaller* than the current time.
     # This can happen during DST backflip:
-    my $now = time;
+    my $now = time + $self-&gt;{timeshift};
     if &#40;$new_time &lt;= $now&#41; {
         dbg &#34;Adjusting time calculation because of DST back flip &#40;new_time - now = &#34;,$new_time - $now,&#34;&#41;&#34; if $DEBUG;
         # We are adding hours as long as our target time is in the future
@@ -1313,7 +1342,7 @@
     my $now = shift;
     my $expanded = shift;
 
-    my $offset = &#40;$expanded-&gt;[5] ? 1 : 60&#41;;
+    my $offset = &#40;$expanded-&gt;[5] ? 1 : 60&#41; + $self-&gt;{timeshift};
     my &#40;$now_sec,$now_min,$now_hour,$now_mday,$now_mon,$now_wday,$now_year&#41; = 
       &#40;localtime&#40;$now+$offset&#41;&#41;[0,1,2,3,4,6,5];
     $now_mon++; 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;13&nbsp;08:28:20&nbsp;2013</span>
    <span class="description">roland [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza">Good idea. I added the path (+ a test) and this will be availbable with 1.02. &#39;hope the license for you contribution (artisstic)<br>

is ok for you.<br>

<br>

On Wed Jun 29 08:42:16 2011, rene@margar.fr wrote:<br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is not a bug but a enhancement I did for the Schedule::Cron module<br>

&gt; to fit my needs :<br>

&gt;<br>

&gt; I needed to add what I called a timeshift to the main cron clock to<br>

&gt; shift all scheduled jobs in the future or in the past. I am using<br>

&gt; several perl scripts running Schedule::Cron concurrently and using<br>

&gt; similar crontabs (each one with different accounts/permissions). That<br>

&gt; can make many jobs launched exactly at the same time creating heavy CPU<br>

&gt; load. By shifting by some seconds or minutes internal Schedule::Cron<br>

&gt; clock I can avoid those massive launches without altering the crontabs.<br>

&gt;<br>

&gt; I added a new option to the object creator :<br>

&gt;<br>

&gt; $cron = new Schedule::Cron($dispatcher, timeshift =&gt; $ts);<br>

&gt;<br>

&gt; Default is 0 if option is not provided.<br>

&gt;<br>

&gt;<br>

&gt; I added a new public method to dynamically change the timeshift :<br>

&gt;<br>

&gt; $cron-&gt;set_timeshift($ts)<br>

&gt;<br>

&gt; Modify global time shift for all timetable. The timeshift is subbed from<br>

&gt; localtime to calculate next execution time for all scheduled jobs.<br>

&gt;<br>

&gt; ts parameter must be in seconds. Default value is 0. Negative values re<br>

&gt; allowed to shift time in the past.<br>

&gt;<br>

&gt; Returns actual timeshift in seconds.<br>

&gt;<br>

&gt; Example:<br>

&gt;<br>

&gt; $cron-&gt;set_timeshift(120);<br>

&gt; Will delay all jobs 2 minutes in the future.<br>

&gt;<br>

&gt; Bug:<br>

&gt; My implementation does not rebuild the job list after changing<br>

&gt; dynamically the timeshift. So next job execution is still using the<br>

&gt; previous timeshift value.<br>

&gt;<br>

&gt; Roland, you can add it to your code if you want and if you feel that it<br>

&gt; does not break the module.<br>

&gt;<br>

&gt; I give you a patch against 1.01_3 to add the timeshift functionnality.<br>
</div><br>

<br>


</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;13&nbsp;08:28:20&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
