<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #41614 for Email-MIME: infinite recursion in remove_attachments</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #41614 for Email-MIME: infinite recursion in remove_attachments</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Email-MIME/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Email-MIME/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Email-MIME/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Email-MIME/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/rjbs/Email-MIME/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Email-MIME">Email-MIME CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">41614</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Email-MIME/Active/">Email-MIME</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ito.kazuo [...] oss.ntt.co.jp

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-11962-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-11963-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;10&nbsp;21:12:56&nbsp;2008</span>
    <span class="description">ito.kazuo [...] oss.ntt.co.jp -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> infinite recursion in remove_attachments</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Perl version: v5.8.8
OS vendor and version: Red Hat Enterprise Linux 5.2
 &#40;linux 2.6.18-92.el5&#41; x86_64

Problem:

The remove_attachments function in SYNOPSIS falls into infinite
recursion when content-type of a part is &#39;message&#39;.

How reproduceable: Always

Steps to reproduce the problem:

Place the attached files code1.pl and sample-mail.txt
in a same directory and run code1.pl.

Proposed fix:

The attached patch, patch.txt, adds an if clause for
content_type == message, when the function remove_attachments
recurses into $part-&gt;body.

Though it&#39;s a little bit complicated as a sample, it also
demonstrates the use of the body_set method in addition to parts_set.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> code1.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use Data::Dumper;
use Email::MIME;
use Email::MIME::Modifier;
#use Email::MIME::Attachment::Stripper;

my $msgfile = &#39;./sample-mail.txt&#39;;
open HANDLE, $msgfile or die &#34;cannot open : $!&#34;; while&#40;my $str = &lt;HANDLE&gt;&#41; {
    $mail .= $str;
}
close HANDLE;

my $email = Email::MIME-&gt;new&#40;$mail&#41;;

# print the mime structure &#40;for debug&#41;
#my $description = $email-&gt;debug_structure; #print $description;

remove_attachments&#40;$email&#41;;
@parts = $email-&gt;parts;
print $parts[0]-&gt;body;

sub remove_attachments {
    # borrowed this from the Email:MIME:Modifier example
    my $email = shift;
    my @keep;
    foreach my $part &#40; $email-&gt;parts &#41; {
        push @keep, $part
          unless $part-&gt;header&#40;&#39;Content-Disposition&#39;&#41; =~ /^attachment/;
        remove_attachments&#40;$part&#41;
          if $part-&gt;content_type =~ /^&#40;?:multipart|message&#41;/;
    }
    $email-&gt;parts_set&#40; \@keep &#41;;
}
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> sample-mail.txt</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From: user1@example.com
To: user2@example.com
Subject: =?ISO-2022-JP?B?GyRCIVo9RU1XIVslJiUkJWslOSVBJSclQyUvGyhC?=
 =?ISO-2022-JP?B?GyRCJE43azJMGyhC?=
Date: Tue, 07 Oct 2008 13:18:13 +0900
Message-ID: &lt;20081007131813.AB8FKC.025170.00000000.proscan@vcgw5w.ymc.
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary=&#34;----AB8FKC.025170.00000000&#34;
X-Mailer: ProScan Mail scanner
X-ProScan-Version: 6.0.3.8
X-Priority: 3 &#40;normal&#41;

This is a multi-part message in MIME format.

------AB8FKC.025170.00000000
Content-Type: text/plain;charset=&#34;ISO-2022-JP&#34;
Content-Transfer-Encoding: 7bit

--------------------------------------------------------------------
   !Z=EMW![%&#38;%$%k%9%A%&#39;%C%/$N7k2L &#40;!w#Y#M#C%&#38;%$%k%96n=|%5!&lt;%S%9&#41;
--------------------------------------------------------------------

0J2&lt;$N%a!&lt;%k$O#1$D0J&gt;e$N%&#38;%$%k%9$K46@w$K$7$F$$$^$9!#

%a!&lt;%k&gt;pJs
====================
BjL&gt;      : Fraud Transactions
Aw?.&lt;T    : user3@example.com
&lt;u?.&lt;T    : user2@example.com
Aw?.F|    : 2008/10/07 13:18:07
Message-ID: &lt;01c92801$687ef980$97778048@telsoft&gt;

%&#38;%$%k%9&gt;pJs
====================
Statement.zip&#40;application/zip&#41; infected HIDDENEXT/Crypted

%X%C%@&gt;pJs
====================
Received: from cpe-72-128-119-151.wi.res.rr.com &#40;72.128.119.151&#41;
  by vcgw5w.ymc.ne.jp with SMTP; 7 Oct 2008 13:18:10 +0900
Received: from [72.128.119.151] by ussmtp1.quark.com; Mon, 6 Oct 2008
22:18:07 -0600
From: &#34;Armando Hand&#34; &lt;user3@example.com&gt;
To: &lt;user4@example.com&gt;
Subject: Fraud Transactions
Date: Mon, 6 Oct 2008 22:18:07 -0600
Message-ID: &lt;01c92801$687ef980$97778048@telsoft&gt;
MIME-Version: 1.0
Content-Type: multipart/mixed;
  boundary=&#34;----=_NextPart_000_000E_01C92801.687EF980&#34;
X-Priority: 3 &#40;Normal&#41;
X-MSMail-Priority: Normal
X-Mailer: Microsoft Outlook, Build 10.0.2627
X-MimeOLE: Produced By Microsoft MimeOLE V5.50.4133.2400
Importance: Normal


--------------------------------------------------------------------

$3$N%a!&lt;%k$O!w#Y#M#C%&#38;%$%k%96n=|%5!&lt;%P!&lt;$+$i&lt;+F0Aw?.$7$F$*$j$^$9!#

%&#38;%$%k%9%A%&#39;%C%/$N7k2L!&#34;%a!&lt;%kAw?.&lt;T$N%3%s%T%e!&lt;%?$,%&#38;%$%k%9$K46@w$7
$F$$$k2DG=@-$,$&#34;$j$^$9!#

$J$*!&#34;:G6a$N%&#38;%$%k%9$NBgH&gt;$OAw?.&lt;T$N%&#34;%I%l%9$r56Au$7Aw?.$7$F$$$k$?$a!&#34;
Aw?.&lt;T$K$ODLCN$r9T$C$F$*$j$^$;$s!#
BjL&gt;!&#38;Aw?.&lt;T$J$I$+$i=EMW$J%a!&lt;%k$@$H9M$&#40;$i$l$k&gt;l9g$K$O!&#34;Aw?.&lt;T$K%a!&lt;
%k$NFbMF$r$43NG&#39;$$$?$@$-$^$9$h$&#38;!&#34;$*4j$$$$$?$7$^$9!#


------AB8FKC.025170.00000000
Content-Type: message/rfc822

Received: from cpe-72-128-119-151.wi.res.rr.com &#40;72.128.119.151&#41;
  by vcgw5w.ymc.ne.jp with SMTP; 7 Oct 2008 13:18:10 +0900
Received: from [72.128.119.151] by ussmtp1.quark.com; Mon, 6 Oct 2008
22:18:07 -0600
From: &#34;Armando Hand&#34; &lt;user3@example.com&gt;
To: &lt;user4@example.com&gt;
Subject: Fraud Transactions
Date: Mon, 6 Oct 2008 22:18:07 -0600
Message-ID: &lt;01c92801$687ef980$97778048@telsoft&gt;
MIME-Version: 1.0
Content-Type: multipart/mixed;
  boundary=&#34;----=_NextPart_000_000E_01C92801.687EF980&#34;
X-Priority: 3 &#40;Normal&#41;
X-MSMail-Priority: Normal
X-Mailer: Microsoft Outlook, Build 10.0.2627
X-MimeOLE: Produced By Microsoft MimeOLE V5.50.4133.2400
Importance: Normal

This is a multi-part message in MIME format.

------=_NextPart_000_000E_01C92801.687EF980
Content-Type: text/plain;
        charset=&#34;us-ascii&#34;
Content-Transfer-Encoding: 7bit

Greating and felications
Dear Credit Card Holder:

Please be aware that a credit card fraud involving your credit card
has been registered by our security department. For your information,
we are sending you the account statement that includes all
transactions
made with your credit card from 01.09.2008 through 03.09.2008.
Please take a note of the last three transactions on the list,
which have been recognized as fraudulent.

We highly recommend you to inform us of the transactions you have
made personally. Thus, you will help us and yourself to resolve this
issue
as soon as possible.

An MS Word document containing your account statement in is enclosed
in the archive attached to this message.

Good-bye until next time
Armando Hand
Manager of Credit Card Fraud Defense

------=_NextPart_000_000E_01C92801.687EF980--

------AB8FKC.025170.00000000--</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch.txt</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/README b/README
index 8342c6d..60434de 100644
--- a/README
+++ b/README
@@ -14,8 +14,13 @@ SYNOPSIS
           foreach my $part &#40; $email-&gt;parts &#41; {
               push @keep, $part
                 unless $part-&gt;header&#40;&#39;Content-Disposition&#39;&#41; =~ /^attachment/;
-              remove_attachments&#40;$part&#41;
-                if $part-&gt;content_type =~ /^&#40;?:multipart|message&#41;/;
+              if &#40; $part-&gt;content_type =~ /^multipart/ &#41; {
+                  remove_attachments&#40;$part&#41;
+              } elsif &#40; $part-&gt;content_type =~ /^message/ &#41; {
+                  my $encap = Email::MIME-&gt;new&#40;$part-&gt;body&#41;;
+                  remove_attachments&#40;$encap&#41;;
+                  $part-&gt;body_set&#40;$encap-&gt;body_raw&#41;;
+              }
           }
           $email-&gt;parts_set&#40; \@keep &#41;;
       }
diff --git a/lib/Email/MIME/Modifier.pm b/lib/Email/MIME/Modifier.pm
index 12adae2..39af488 100644
--- a/lib/Email/MIME/Modifier.pm
+++ b/lib/Email/MIME/Modifier.pm
@@ -37,8 +37,13 @@ version 1.442
       foreach my $part &#40; $email-&gt;parts &#41; {
           push @keep, $part
             unless $part-&gt;header&#40;&#39;Content-Disposition&#39;&#41; =~ /^attachment/;
-          remove_attachments&#40;$part&#41;
-            if $part-&gt;content_type =~ /^&#40;?:multipart|message&#41;/;
+          if &#40; $part-&gt;content_type =~ /^multipart/ &#41; {
+              remove_attachments&#40;$part&#41;
+          } elsif &#40; $part-&gt;content_type =~ /^message/ &#41; {
+              my $encap = Email::MIME-&gt;new&#40;$part-&gt;body&#41;;
+              remove_attachments&#40;$encap&#41;;
+              $part-&gt;body_set&#40;$encap-&gt;body_raw&#41;;
+          }
       }
       $email-&gt;parts_set&#40; \@keep &#41;;
   }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;14&nbsp;14:00:26&nbsp;2010</span>
    <span class="description">rjbs [...] cpan.org -  Queue changed from Email-MIME-Modifier to Email-MIME</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;08&nbsp;21:35:11&nbsp;2013</span>
    <span class="description">rjbs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks, I hope to apply this on my next run through Email-MIME bug application.

-- 
rjbs
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;08&nbsp;21:35:12&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;28&nbsp;23:03:01&nbsp;2014</span>
    <span class="description">rjbs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The remove_attachments example has been gone for a while.  This patch is no longer applicable.  Thank you anyway, and sorry for the absurdly long delay.

-- 
rjbs
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;28&nbsp;23:03:02&nbsp;2014</span>
    <span class="description">rjbs [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
