<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #17298 for Test-Simple: Test::Simple &#39;reset.t&#39; test case failures &#40;2-14&#41; on VMS, &#38; patch.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #17298 for Test-Simple: Test::Simple &#39;reset.t&#39; test case failures &#40;2-14&#41; on VMS, &#38; patch.</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Test-Simple/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Test-Simple/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Test-Simple/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Test-Simple/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="http://github.com/Test-More/test-more/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Test-Simple">Test-Simple CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">17298</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Test-Simple/Active/">Test-Simple</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cpan [...] pjedwards.co.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Unimportant    </td>
  </tr>
  <tr id="CF-31590-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.62    </td>
  </tr>
  <tr id="CF-31591-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;26&nbsp;12:38:11&nbsp;2006</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Test::Simple &#39;reset.t&#39; test case failures &#40;2-14&#41; on VMS, &#38; patch.</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Test::Simple 0.62

This is perl, v5.8.7 built for VMS_AXP

Failed Test Stat Wstat Total Fail  Failed  List of Failed
---------------------------------------------------------
t/reset.t     44  1024    14   26 185.71%  2-14
5 tests and 9 subtests skipped.
Failed 1/63 test scripts, 98.41% okay. 13/478 subtests failed, 97.28% 
okay.

t/reset...................
Can&#39;t open test output log foo.tmp: file currently locked by another 
user at &lt;removed&gt;/TEST-SIMPLE-0_62/blib/lib/Test/Builder.pm line 1268.
%SYSTEM-F-ABORT, abort
dubious
        Test returned status 44 &#40;wstat 1024, 0x400&#41;
                &#40;VMS status is 44&#41;
DIED. FAILED tests 2-14
        Failed 13/14 tests, 7.14% okay

Failures are due to VMS file system locking, when debugging these
failures, VMS file system versioning can also come into play.

Here are the lines I edited to fix these failures:

-----

line 25 of reset.t &#40;this is the cause of the failure&#41;

# These files were once one file, but due to OS&#39;s with file locking 
&#40;VMS&#41; I split them into 3 files.

my $tmpfile_output         = &#39;tmp_output.tmp&#39;;
my $tmpfile_failure_output = &#39;tmp_failure_output.tmp&#39;;
my $tmpfile_todo_output    = &#39;tmp_todo_output.tmp&#39;;

$tb-&gt;output&#40;$tmpfile_output&#41;;
$tb-&gt;failure_output&#40;$tmpfile_failure_output&#41;;
$tb-&gt;todo_output&#40;$tmpfile_todo_output&#41;;

END { 1 while unlink $tmpfile_output; 1 while unlink 
$tmpfile_failure_output; 1 while unlink $tmpfile_todo_output; }

-----

line 40 of output.t &#40;this change would help OS&#39;s with file versioning&#41;
change:
END { unlink&#40;$tmpfile&#41; }
to:
END { 1 while unlink $tmpfile } # Required for file systems with 
multiple versions, i.e. VMS

-----

line 22 of is_fh.t &#40;this change would help OS&#39;s with file versioning&#41;
change:
END { close FILE; unlink &#39;foo&#39; }
to:
END { close FILE; 1 while unlink &#39;foo&#39; } # Required for file systems 
with multiple versions, i.e. VMS

-----

Cheers,

Peter &#40;Stig&#41; Edwards
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;13&nbsp;22:39:12&nbsp;2007</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jan 26 12:38:11 2006, guest wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; t/reset...................
&gt; Can&#39;t open test output log foo.tmp: file currently locked by another 
&gt; user at &lt;removed&gt;/TEST-SIMPLE-0_62/blib/lib/Test/Builder.pm line 1268.
&gt; %SYSTEM-F-ABORT, abort
&gt; dubious
</div>
...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Failures are due to VMS file system locking, when debugging these
&gt; failures, VMS file system versioning can also come into play.
</div>
Who&#39;s the &#34;other user&#34; that&#39;s locking that file?

Not being able to send output to the same file is a problem.  Does it
fix the problem to just fix the tempfile cleanups so all versions get
deleted?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;13&nbsp;22:39:13&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;13&nbsp;22:40:15&nbsp;2007</span>
    <span class="description">mschwern [...] cpan.org -  Severity Unimportant added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;14&nbsp;05:13:54&nbsp;2007</span>
    <span class="description">cpan [...] pjedwards.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> cpan [...] pjedwards.co.uk</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; &gt; t/reset...................
&gt; &gt; &gt; Can&#39;t open test output log foo.tmp: file currently locked by another
&gt; &gt; &gt; user at &lt;removed&gt;/TEST-SIMPLE-0_62/blib/lib/Test/Builder.pm line 1268.
&gt; &gt; &gt; %SYSTEM-F-ABORT, abort
&gt; &gt; &gt; dubious
</div></div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &gt; Who&#39;s the &#34;other user&#34; that&#39;s locking that file?
</div>
Thanks for taking a look.

There is no third man.  It&#39;s a misleading message from Perl on VMS,
it is the same user as the user running the test, the message in this
case just means the OS can&#39;t create a file with the name foo.tmp in the
3rd call using this filename.

These are the 3 calls.

1.&#41; output&#40;foo.tmp&#41;
2.&#41; failure_output&#40;foo.tmp&#41;
3.&#41; todo_output&#40;foo.tmp&#41;

The first call creates version 1 of the file foo.tmp, it&#39;s opened for
write so on VMS this means a write lock is taken out by default until
the FH is closed.

From perlport - &#34;Don&#39;t open the same file more than once at a time for
writing, as some operating systems put mandatory locks on such files.&#34;

The second call creates version 2 &#40;because version 1 has a write lock&#41;
of the file foo.tmp, it&#39;s opened for write so on VMS this means a write
lock is taken out by default until the file handle is closed.

It&#39;s possible to set the default number of versions on a file and
directory on the default VMS filesystem, for the Perl roots on our
systems this is set to 2, this means that when a new file is created it
has a max number of 2 versions, so...

The third call attempts to create version 3 &#40;because version 1 and 2
have yet to be closed and still have write locks&#41; of the file foo.tmp,
however because this file has a version limit of 2, it&#39;s this call that
fails.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&gt; Not being able to send output to the same file is a problem. 
</div>
If, instead of passing the filename in, a shared file handle was used
then this would avoid the different versions of the file being created.

I&#39;ve tested the below, and it works:

    my $tmpfile = &#39;foo.tmp&#39;;
    my $tmpfh;
    open $tmpfh, &#39;&gt;&#39;,$tmpfile or croak&#40;&#34;Can&#39;t open test output log
$tmpfile: $!&#34;&#41;;

    $tb-&gt;output&#40;$tmpfh&#41;;
    $tb-&gt;failure_output&#40;$tmpfh&#41;;
    $tb-&gt;todo_output&#40;$tmpfh&#41;;

    END { 1 while unlink $tmpfile }

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&gt; Does it
&gt;&gt; fix the problem to just fix the tempfile cleanups so all versions get
&gt;&gt; deleted?
</div>
No.  Not cleaning up all the versions does not cause the problem, and
cleaning up all the versions does not fix it.

Cheers,

Peter &#40;Stig&#41; Edwards


In Italy under the Borgias they had 30 years of murder, bloodshed,
warfare and produced indigestible pasta, boring operas, and the Fiat.
In Switzerland, they had brotherly love, 500 years of democracy and
peace, and what did they produce? The Swiss bank account, the best
cheese in the world, and Heidi.  &#40;Pinky and the Brain - The Third Mouse&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;29&nbsp;19:41:57&nbsp;2007</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I don&#39;t remember, did we fix this?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;30&nbsp;04:14:44&nbsp;2007</span>
    <span class="description">cpan [...] pjedwards.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> cpan [...] pjedwards.co.uk</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It&#39;s not fixed in 0.74 &#40;just looked at the code and tested&#41;.

Here is the diff against 0.74 that I used to avoid the file lock.

==== t/reset.t#1 &#40;xtext&#41; - t/reset.t#2 &#40;xtext&#41; ==== content
27,29c27,32
&lt; $tb-&gt;output&#40;$tmpfile&#41;;
&lt; $tb-&gt;failure_output&#40;$tmpfile&#41;;
&lt; $tb-&gt;todo_output&#40;$tmpfile&#41;;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; my $tmpfh;
&gt; open $tmpfh, &#39;&gt;&#39;,$tmpfile or croak&#40;&#34;Can&#39;t open test output log
</div>$tmpfile: $!&#34;&#41;;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; $tb-&gt;output&#40;$tmpfh&#41;;
&gt; $tb-&gt;failure_output&#40;$tmpfh&#41;;
&gt; $tb-&gt;todo_output&#40;$tmpfh&#41;;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;30&nbsp;10:19:08&nbsp;2009</span>
    <span class="description">cpan [...] pjedwards.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Nov 30 04:14:44 2007, cpan@pjedwards.co.uk wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It&#39;s not fixed in 0.74 &#40;just looked at the code and tested&#41;.
&gt; 
&gt; Here is the diff against 0.74 that I used to avoid the file lock.
&gt; 
&gt; ==== t/reset.t#1 &#40;xtext&#41; - t/reset.t#2 &#40;xtext&#41; ==== content
&gt; 27,29c27,32
&gt; &lt; $tb-&gt;output&#40;$tmpfile&#41;;
&gt; &lt; $tb-&gt;failure_output&#40;$tmpfile&#41;;
&gt; &lt; $tb-&gt;todo_output&#40;$tmpfile&#41;;
&gt; ---
<div class="message-stanza open">&gt; &gt; my $tmpfh;
&gt; &gt; open $tmpfh, &#39;&gt;&#39;,$tmpfile or croak&#40;&#34;Can&#39;t open test output log
</div>&gt; $tmpfile: $!&#34;&#41;;
<div class="message-stanza open">&gt; &gt;
&gt; &gt; $tb-&gt;output&#40;$tmpfh&#41;;
&gt; &gt; $tb-&gt;failure_output&#40;$tmpfh&#41;;
&gt; &gt; $tb-&gt;todo_output&#40;$tmpfh&#41;;
</div></div>
I&#39;m just in the process of upgrading to 0.86, I made the same changes as 
above to avoid the file lock on VMS:

t/builder/reset.t

33,35c33,38
&lt; $tb-&gt;output&#40;$tmpfile&#41;;
&lt; $tb-&gt;failure_output&#40;$tmpfile&#41;;
&lt; $tb-&gt;todo_output&#40;$tmpfile&#41;;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; my $tmpfh;
&gt; open $tmpfh, &#39;&gt;&#39;,$tmpfile or croak&#40;&#34;Can&#39;t open test output log 
</div>$tmpfile: $!&#34;&#41;;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; $tb-&gt;output&#40;$tmpfh&#41;;
&gt; $tb-&gt;failure_output&#40;$tmpfh&#41;;
&gt; $tb-&gt;todo_output&#40;$tmpfh&#41;;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;02&nbsp;04:59:16&nbsp;2009</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ok, I&#39;ve fixed it to just not use a temp file at all.  You can give it a
shot here.  I expect no problems.
<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/schwern/test-more/tarball/master">http://github.com/schwern/test-more/tarball/master</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;02&nbsp;04:59:18&nbsp;2009</span>
    <span class="description">mschwern [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;02&nbsp;06:36:20&nbsp;2009</span>
    <span class="description">cpan [...] pjedwards.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;02&nbsp;06:36:21&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;02&nbsp;08:15:49&nbsp;2009</span>
    <span class="description">schwern [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17298] Test::Simple &#39;reset.t&#39; test case failures &#40;2-14&#41; on VMS, &#38; patch.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 02 Apr 2009 13:15:28 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Test-Simple [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michael G Schwern &lt;schwern [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Peter John Edwards via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; t/died..................................
&gt; 
&gt; #   Failed test at t/died.t line 0.
&gt; #          got: &#39;# Looks like your test exited with 512 before it could 
&gt; output anything.
&gt; # &#39;
&gt; #     expected: &#39;# Looks like your test exited with 250 before it could 
&gt; output anything.
&gt; # &#39;
&gt; #   Failed test &#39;exit code&#39;
&gt; #   at t/died.t line 0.
&gt; #          got: &#39;512&#39;
&gt; #     expected: &#39;250&#39;
&gt; %NONAME-E-NOMSG, Message number 00000002
&gt;  Dubious, test returned 2 &#40;wstat 512, 0x200&#41;
&gt; 
&gt;  Failed 2/3 subtests
</div>
Didn&#39;t touch that test at all, and it was introduced in 0.86.  It&#39;s likely
also broken in 0.86 and 0.87_01, could you check?



<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; t/exit..................................
&gt; 
&gt; #   Failed test &#39;death.plx exited with 4 &#40;expected 255&#41;&#39;
&gt; #   at t/exit.t line 89.
&gt; #          got: 4
&gt; #     expected: 255
&gt; %SYSTEM-F-ABORT, abort
&gt; 
&gt; #   Failed test &#39;too_few.plx exited with 4 &#40;expected 255&#41;&#39;
&gt; #   at t/exit.t line 89.
&gt; #          got: 4
&gt; #     expected: 255
&gt; %SYSTEM-F-ABORT, abort
</div>...

Oh, I think I got the exit mapping logic backwards.  Doesn&#39;t make any
different on Unix because it&#39;s an identify function.

Pull down the latest tarball please and see if that does it.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; t/pod-coverage..........................
&gt; Subroutine Test::Builder::share redefined at &lt;removed&gt;TEST-SIMP
&gt; LE-0_87_01/blib/lib/test/builder.pm line 66.
&gt; Subroutine Test::Builder::lock redefined at &lt;removed&gt;TEST-SIMPL
&gt; E-0_87_01/blib/lib/test/builder.pm line 67.
</div>
Well that&#39;s awful.  What&#39;s that all about?  Do you get that from all
Pod::Coverage tests on VMS?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;02&nbsp;12:32:13&nbsp;2009</span>
    <span class="description">cpan [...] pjedwards.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; # Failed test &#39;exit code&#39;
&gt;&gt; # at t/died.t line 0.
&gt;&gt; # got: &#39;512&#39;
&gt;&gt; # expected: &#39;250&#39;
</div></div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Didn&#39;t touch that test at all, and it was introduced in 0.86. It&#39;s 
</div>likely
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; also broken in 0.86 and 0.87_01, could you check?
</div>
I can confirm the same behaviour in 0.86.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Oh, I think I got the exit mapping logic backwards. Doesn&#39;t make any
&gt; different on Unix because it&#39;s an identify function.
</div>
After I posted I also noticed the exit mapping looked backwards,
I swapped it, and it fixed some tests, but not all.  I started to
dig into it but got pulled onto something else.
  I also changed:

&lt;&lt; for my $exit &#40;0..255&#41; {
&lt;&lt;    my $wait = system&#40;qq[$Perl -e &#34;exit $exit&#34;]&#41;;
&lt;&lt;    $Exit_Map{$exit} = exitstatus&#40;$wait&#41;;
&lt;&lt; }

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; for my $exit &#40;0,1,2,5,255&#41; {
&gt;&gt;   my $wait         = system&#40;qq[$Perl -e &#34;exit $exit&#34;]&#41;;
&gt;&gt;   my $os_exit      = exitstatus&#40;$wait&#41;;
&gt;&gt;   $Exit_Map{$exit} = $os_exit;
&gt;&gt;   print &#34;# $^O exit $exit returns $os_exit\n&#34;;
&gt;&gt; }
</div></div>
# Building up a map of exit codes.  May take a while.
# VMS exit 0 returns 0
# VMS exit 1 returns 4
# VMS exit 2 returns 2
# VMS exit 5 returns 0
# VMS exit 255 returns 0
# Done.

to speed things up and help debug.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Pull down the latest tarball please and see if that does it.
</div>
Just FYI, I have to pull the tarball down to linux and build the dist
to ensure it does not contain a dir that is invalid on VMS ODS-3
&#40;schwern-test-more-... exceeds 39 chars&#41;, so instead I&#39;m GETing:

<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/schwern/test-">http://github.com/schwern/test-</a></span>
more/raw/1c4bc8655fc5e4d20d55f9049414a3b6ed355df9/t/exit.t

I think the expected exit code also needs to change, in is_num:

&lt;&lt; &#34;&#40;expected $exit_code&#41;&#34;&#41;;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; &#34;&#40;expected &#34;.$Exit_Map{exit_code}.&#34;&#41;&#34;&#41;;
</div></div>
I also changed:

&lt;&lt;    my $wait_stat = system&#40;qq{$Perl -&#34;I../blib/lib&#34; -&#34;I../lib&#34; -
&#34;I../t/lib&#34; $file}&#41;;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt;    my $cmd = qq{$Perl -&#34;I../blib/lib&#34; -&#34;I../lib&#34; -&#34;I../t/lib&#34; $file};
&gt;&gt;    print &#34;# cmd = $cmd\n&#34;;
&gt;&gt;    my $wait_stat = system&#40;$cmd&#41;;
</div></div>
everything was exiting with a 4, I think it might boil down to how 
assigning
to $? behaves on VMS &#40;in the context of -Mvmsish&#41;, vs calling exit.

I&#39;ve run out of time.  Hopefully I&#39;ll find some more tonight.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Well that&#39;s awful.  What&#39;s that all about?  Do you get that from all
&gt; Pod::Coverage tests on VMS?
</div>
Sorry, you can ignore the Pod::Coverage warnings.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;02&nbsp;18:11:24&nbsp;2009</span>
    <span class="description">cpan [...] pjedwards.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think it might boil down to how assigning
&gt; to $? behaves on VMS, vs calling exit.
</div>
The short version is, it&#39;s the difference between
calling exit&#40;$n&#41; and Assigning to $? in an END block
&#40;on VMS&#41;.

These are the changes I made to get this to pass it&#39;s
tests in a &#39;safe&#39; and &#40;hopefully&#41; portable way.

&lt;&lt; for my $exit &#40;0..255&#41; {
&lt;&lt;     my $wait = system&#40;qq[$Perl -e &#34;exit $exit&#34;]&#41;;
&lt;&lt;     $Exit_Map{$exit} = exitstatus&#40;$wait&#41;;
&lt;&lt; }

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&gt; for my $exit &#40;0,1,2,5,255&#41; {
&gt;&gt;     my $q            = &#40;$^O eq &#39;VMS&#39;&#41; ? q{&#34;} : q{&#39;};
&gt;&gt;     my $cmd          = $Perl . q[ -e ] . $q . q[use 
</div>English;END{$CHILD_ERROR=] . $exit . q[}] .$q;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&gt;     my $wait         = system&#40;$cmd&#41;;
&gt;&gt;     my $os_exit      = exitstatus&#40;$wait&#41;;
&gt;&gt;     $Exit_Map{$exit} = $os_exit;
&gt;&gt;     print &#34;# $^O exit=$exit wait=$wait os_exit=$os_exit\n&#34;;
&gt;&gt; }
</div>
I tested on Linux and VMS.  I say &#39;safe&#39; because it&#39;s staying within
legacy POSIX emulation, just testing for successful completion, 
and not venturing into $?-on-VMS behaviour as outlined in:

  <span class="clickylink"><a target="new" rel="nofollow" href="http://perldoc.perl.org/perlvms.html#Perl-variables">http://perldoc.perl.org/perlvms.html#Perl-variables</a></span>

There is also this change:

&lt;&lt; $TB-&gt;is_num&#40; $actual_exit, $Exit_Map{$exit_code}, 
&lt;&lt;                       &#34;$test_name exited with $actual_exit &#34;.
&lt;&lt;                       &#34;&#40;expected $exit_code&#41;&#34;&#41;;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&gt; $TB-&gt;is_num&#40; $actual_exit, $Exit_Map{$exit_code}, 
&gt;&gt;                      &#34;$test_name exited with $actual_exit &#34;.
&gt;&gt;                      &#34;&#40;expected &#34;.$Exit_Map{$exit_code}.&#34;&#41;&#34;&#41;;
</div>
Cheers.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;02&nbsp;21:15:59&nbsp;2009</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Somehow wires got crossed.  This is all part of #42148.

Anyhow, can I get an executive summary of all that?

Also, the Pod::Coverage warnings do concern me.  I&#39;d rather not have a
huge stack of warnings being spewed out of my test.  Is that a general
Pod::Coverage problem on VMS?  Has it been reported?

Please reply on the 42148 ticket.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;28&nbsp;15:45:52&nbsp;2016</span>
    <span class="description">exodist7 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Apr 02 18:15:59 2009, MSCHWERN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Somehow wires got crossed.  This is all part of #42148.
&gt; 
&gt; Anyhow, can I get an executive summary of all that?
&gt; 
&gt; Also, the Pod::Coverage warnings do concern me.  I&#39;d rather not have a
&gt; huge stack of warnings being spewed out of my test.  Is that a general
&gt; Pod::Coverage problem on VMS?  Has it been reported?
&gt; 
&gt; Please reply on the 42148 ticket.
</div>
Closing this ticket, last I heard vms passes fine on the latest versions.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;28&nbsp;15:46:08&nbsp;2016</span>
    <span class="description">exodist7 [...] gmail.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
