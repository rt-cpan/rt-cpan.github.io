<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #19425 for Net-DNS: Unnecessary rd set in Recurse.pm</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #19425 for Net-DNS: Unnecessary rd set in Recurse.pm</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-DNS/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-DNS">Net-DNS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">19425</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-DNS/Active/">Net-DNS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jtk [...] ultradns.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-22454-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.57    </td>
  </tr>
  <tr id="CF-22455-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;22&nbsp;16:29:49&nbsp;2006</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Unnecessary rd set in Recurse.pm</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m moving a discussion that initially started with private email to
Oalf.  This and the following entry will consist of the initial email
exchange, the third will then be a new follow-up to Olaf&#39;s private reply.
--
From: John Kristoff &lt;jtk@ultradns.net&gt;
To: olaf@net-dns.org
Subject: Unnecessary rd enabled in Recurse.pm?
Date: Fri, 12 May 2006 13:41:11 -0500

Hi Olaf,

I am trying to use Net::DNS::Resolver::Recurse for a simple tool that
walks the tree, but I noticed that no matter what I did my first query
was able sent with the recursion desired flag set.  This is not what I
want.  Here is a sample piece of code based largely on the example in
the doc:

  #!/usr/bin/perl -wT
  use strict;
  $|=1;

  use Net::DNS::Resolver::Recurse;
  my @root_hints = &#40; &#34;192.5.5.241&#34; &#41;;

  my $res = Net::DNS::Resolver::Recurse-&gt;new;
  $res-&gt;hints&#40;@root_hints&#41;;

  $res-&gt;recursion_callback&#40;sub {
      my $packet = shift;
      $_-&gt;print for $packet-&gt;additional;
      printf&#40;&#34;;; Received %d bytes from %s\n\n&#34;,
          $packet-&gt;answersize,
          $packet-&gt;answerfrom
      &#41;;
  }&#41;;

  my $packet = $res-&gt;query_dorecursion&#40; &#34;depaul.edu.&#34;, &#34;NS&#34;&#41;;

In a packet capture I notice the first query towards the root server
I gave the hint to will have the recursion desired flag set.  Why is
this?  I noticed in Recurse.pm on line 28 that you set recursion for
the query that asks one of the hint servers who it thanks is auth for
the root.  While it won&#39;t generally hurt to have this I guess, I did
not want this behavior so I changed it.  Can you explain this or is
this a bug?

I also noticed that if I don&#39;t set the hints the TLD will get a query
with rd set as well.

John
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;22&nbsp;16:31:08&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jtk [...] ultradns.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Olaf&#39;s reply:

From: &#34;Olaf M. Kolkman&#34; &lt;olaf@dacht.net&gt;
To: John Kristoff &lt;jtk@ultradns.net&gt;
Subject: Re: Unnecessary rd enabled in Recurse.pm?
Date: Mon, 22 May 2006 21:02:55 +0200


Hi John,

Apologies for not getting back to you earlier.



On May 12, 2006, at 8:41 PM, John Kristoff wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Olaf,
&gt;
&gt; I am trying to use Net::DNS::Resolver::Recurse for a simple tool that
&gt; walks the tree, but I noticed that no matter what I did my first query
&gt; was able sent with the recursion desired flag set.  This is not what I
&gt; want.
</div>
&#40;...&#41;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; In a packet capture I notice the first query towards the root server
&gt; I gave the hint to will have the recursion desired flag set.  Why is
&gt; this?  I noticed in Recurse.pm on line 28 that you set recursion for
&gt; the query that asks one of the hint servers who it thanks is auth for
&gt; the root.  While it won&#39;t generally hurt to have this I guess, I did
&gt; not want this behavior so I changed it.  Can you explain this or is
&gt; this a bug?
</div>

This is not a bug but a feature. The Recursor module does a so called  
priming query. This is what the initial developer of the module  
thought was a good thing. I doubt if one should send a query to the  
root every time one starts resolution &#40;although the result is kept  
over multiple calls during the lifetime of the object&#41;.

Anyway you can hack around this by setting the hint attribute  
appropriately. Note that the attribute is an anonymous hash with the  
names of the servers as keys and anonymous arrays with their IP  
addresses as values.

Also note that there was a bug in earlier versions that did not  
handle the recursion at all in earlier versions &#40;e.g. version 0.48  
that commes with debian. I have not checked the revision logs when  
that was fixed&#41;.


As an alternative:

use Net::DNS::Resolver::Recurse;

my $res = Net::DNS::Resolver::Recurse-&gt;new;
$res-&gt;debug&#40;1&#41;;    #Debugging will show the priming.
$res-&gt;{&#39;hints&#39;}={
     &#34;k.root-server.net&#34; =&gt; [ qw&#40; 193.0.14.129 &#41; ],
     &#34;a.root-server.net&#34; =&gt; [ qw&#40; 192.5.5.241 &#41; ],


                 };


$res-&gt;recursion_callback&#40;sub {
     my $packet = shift;
     $_-&gt;print for $packet-&gt;additional;
       printf&#40;&#34;;; Received %d bytes from %s\n\n&#34;,
           $packet-&gt;answersize,
           $packet-&gt;answerfrom
              &#41;;
}&#41;;

my $packet = $res-&gt;query_dorecursion&#40; &#34;depaul.edu.&#34;, &#34;NS&#34;&#41;;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I also noticed that if I don&#39;t set the hints the TLD will get a query
&gt; with rd set as well.
</div>
This I do not understand. Can you give me an example?

Hope this helped.

--Olaf

PS please use the rt.cpan.org to report bugs and questions. It makes  
tracking much easier and mail will not be mistaken as spam.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;22&nbsp;16:31:09&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;22&nbsp;17:11:16&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jtk [...] ultradns.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Anyway you can hack around this by setting the hint attribute  
&gt; appropriately. Note that the attribute is an anonymous hash with the  
&gt; names of the servers as keys and anonymous arrays with their IP  
&gt; addresses as values.
</div>
Aha, I was looking at the &#34;hints&#34; documentation here:

  &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.net-dns.org/docs/Net/DNS/Resolver/Recurse.html">http://www.net-dns.org/docs/Net/DNS/Resolver/Recurse.html</a></span>&gt;

and passing the root hints as an array of IP addresses to res-&gt;hints&#40;&#41;,
but that is not the same thing.  Thanks for clarifying this.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I also noticed that if I don&#39;t set the hints the TLD will get a query
&gt; &gt; with rd set as well.
</div>&gt; 
&gt; This I do not understand. Can you give me an example?
</div>
So when I do something like this:

  $perl -e &#39;use Net::DNS::Resolver::Recurse; $res =
Net::DNS::Resolver::Recurse-&gt;new; $packet =
$res-&gt;query_dorecursion&#40;&#34;depaul.edu&#34;, &#39;NS&#39;&#41;;&#39;

The first query goes to a local server for the root NS RRSet, with RD
set.  This is as expected.  Then however, when the next query goes
towards a select root server and rd is still set, which is what I
thought should be avoided.  Thereafter rd is not set.  You should be
able to verify with a packet trace or by adding in some debug info.

John
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;22&nbsp;17:35:23&nbsp;2006</span>
    <span class="description">olaf [...] dacht.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #19425] Unnecessary rd set in Recurse.pm </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 22 May 2006 23:34:35 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Olaf M. Kolkman&#34; &lt;olaf [...] dacht.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; So when I do something like this:
&gt;
&gt;   $perl -e &#39;use Net::DNS::Resolver::Recurse; $res =
&gt; Net::DNS::Resolver::Recurse-&gt;new; $packet =
&gt; $res-&gt;query_dorecursion&#40;&#34;depaul.edu&#34;, &#39;NS&#39;&#41;;&#39;
&gt;
&gt; The first query goes to a local server for the root NS RRSet, with RD
&gt; set.  This is as expected.  Then however, when the next query goes
&gt; towards a select root server and rd is still set, which is what I
&gt; thought should be avoided.  Thereafter rd is not set.  You should be
&gt; able to verify with a packet trace or by adding in some debug info.
&gt;
</div>

The root servers do not recurse so the bit does not hurt... but still  
you have a valid point.

Attached is a fixed Recurse.pm

Fix also lives on the trunk
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">

--Olaf



------------------------------------------------------
Ik dacht net... heel even maar.
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;19&nbsp;05:57:09&nbsp;2006</span>
    <span class="description">OLAF [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
