<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #98737 for MIME-tools: Lift encoding restriction according to RFC 6533: can&#39;t have encoding quoted-printable for message type message/global-headers</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #98737 for MIME-tools: Lift encoding restriction according to RFC 6533: can&#39;t have encoding quoted-printable for message type message/global-headers</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/MIME-tools/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/MIME-tools/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/MIME-tools/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/MIME-tools/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/MIME-tools">MIME-tools CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">98737</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/MIME-tools/Active/">MIME-tools</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">dfs+pause [...] roaringpenguin.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Mark.Martinec [...] ijs.si

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-21368-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
5.505    </td>
  </tr>
  <tr id="CF-21369-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;09&nbsp;10:20:15&nbsp;2014</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Lift encoding restriction according to RFC 6533: can&#39;t have
 encoding quoted-printable for message type message/global-headers</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Trying to update my software to generate a DSN according to RFC 6533
&#40;Internationalized Delivery Status and Disposition Notifications&#41;,
I stumbled across the following diagnostic from MIME-Tools-5.505:

  can&#39;t have encoding quoted-printable for message type message/global-headers!

This is generated by the following code in MIME::Entity::build&#40;&#41; :

  ### Type-check sanity:
  if &#40;$type =~ m{^&#40;multipart|message&#41;/}&#41; {
    &#40;$encoding =~ /^&#40;|7bit|8bit|binary|-suggest&#41;$/i&#41;
      or croak &#34;can&#39;t have encoding $encoding for message type $type!&#34;;
  }

The restriction above needs to be relaxed,
the RFC 2045 requirements were relaxed by RFC 6532:


RFC 2045 section 6.4

  If an entity is of type &#34;multipart&#34; the Content-Transfer-Encoding
  is not permitted to have any value other than &#34;7bit&#34;, &#34;8bit&#34; or &#34;binary&#34;.
  [...]
  Certain Content-Transfer-Encoding values may only be used on certain
  media types.  In particular, it is EXPRESSLY FORBIDDEN to use any
  encodings other than &#34;7bit&#34;, &#34;8bit&#34;, or &#34;binary&#34; with any composite
  media type, i.e. one that recursively includes other Content-Type
  fields.  Currently the only composite media types are &#34;multipart&#34; and
  &#34;message&#34;.  All encodings that are desired for bodies of type
  multipart or message must be done at the innermost level, by encoding
  the actual body that needs to be encoded.


RFC 6532:

3.5.  Changes to MIME Message Type Encoding Restrictions

  This specification updates Section 6.4 of [RFC2045].  [RFC2045]
  prohibits applying a content-transfer-encoding to any subtypes of
  &#34;message/&#34;.  This specification relaxes that rule -- it allows newly
  defined MIME types to permit content-transfer-encoding, and it allows
  content-transfer-encoding for message/global &#40;see Section 3.7&#41;.

3.7.  The message/global Media Type
  [...]
  If an object of this type is sent to a 7-bit-only system, it MUST
  have an appropriate content-transfer-encoding applied.  &#40;Note that a
  system compliant with MIME that doesn&#39;t recognize message/global is
  supposed to treat it as &#34;application/octet-stream&#34; as described in
  Section 5.2.4 of [RFC2046].&#41;
  [...]
  Encoding considerations:  Any content-transfer-encoding is permitted.
  The 8-bit or binary content-transfer-encodings are recommended
  where permitted.
  [...]
  Restrictions on usage:  This is a structured media type that embeds
  other MIME media types.  An 8-bit or binary content-transfer-encoding
  SHOULD be used unless this media type is sent over a 7-bit-only transport.


RFC 6533:

  Note that [RFC6532] relaxed a restriction from MIME [RFC2046] regarding
  the use of Content-Transfer-Encoding in new &#34;message&#34; subtypes.  This
  specification explicitly allows the use of Content-Transfer-Encoding
  in message/global-headers and message/global-delivery-status.


RFC 6533:

4.5.  Additional Requirements on SMTP Servers

  If an SMTP server that advertises both SMTPUTF8 and DSN needs to
  return an undeliverable SMTPUTF8 message, then it has two choices for
  encapsulating the SMTPUTF8 message when generating the corresponding
  multipart/report:

    If the return-path SMTP server does not support SMTPUTF8, then the
    undeliverable body part and headers MUST be encoded using a 7-bit
    Content-Transfer-Encoding such as &#34;base64&#34; or &#34;quoted-printable&#34;
    [RFC2045], as detailed in Section 4.
    Otherwise, &#34;8bit&#34; Content-Transfer-Encoding can be used.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;10&nbsp;13:10:47&nbsp;2014</span>
    <span class="description">dfs+pause [...] roaringpenguin.com -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;10&nbsp;13:27:33&nbsp;2014</span>
    <span class="description">dfs [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #98737] Lift encoding restriction according to RFC 6533: can&#39;t have  encoding quoted-printable for message type message/global-headers</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 10 Sep 2014 13:27:07 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David F. Skoll&#34; &lt;dfs [...] roaringpenguin.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The restriction above needs to be relaxed,
&gt; the RFC 2045 requirements were relaxed by RFC 6532:
</div>
Thanks for the bug report.  I plan on applying the patch below for the next
release.  From my understanding, RFC 6532 only relaxes the restriction for
new subtypes of message/, so I keep it in place for old subtypes.  Your
review would be appreciated.

Regards,

David.

diff --git a/lib/MIME/Entity.pm b/lib/MIME/Entity.pm
index 37d0de4..9ea4ddd 100644
--- a/lib/MIME/Entity.pm
+++ b/lib/MIME/Entity.pm
@@ -570,7 +570,7 @@ sub build {
     $filename = undef if &#40;defined&#40;$filename&#41; and $filename eq &#39;&#39;&#41;;
 
     ### Type-check sanity:
-    if &#40;$type =~ m{^&#40;multipart|message&#41;/}&#41; {
+    if &#40;$type =~ m{^&#40;multipart/|message/&#40;rfc822|partial|external-body|delivery-status|disposition-notification|feedback-report&#41;&#41;}&#41; {
        &#40;$encoding =~ /^&#40;|7bit|8bit|binary|-suggest&#41;$/i&#41;
            or croak &#34;can&#39;t have encoding $encoding for message type $type!&#34;;
     }
diff --git a/t/Entity.t b/t/Entity.t
index 2ef11e2..440c931 100644
--- a/t/Entity.t
+++ b/t/Entity.t
@@ -1,7 +1,7 @@
 #!/usr/bin/perl -w
 use strict;
 use warnings;
-use Test::More tests =&gt; 34;
+use Test::More tests =&gt; 39;
 
 use MIME::Entity;
 use MIME::Parser;
@@ -101,6 +101,45 @@ my $LINE;
      my $got = $e-&gt;head-&gt;mime_attr&#40;&#39;content-type.charset&#39;&#41;;
      is&#40;$got, &#39;iso8859-1&#39;, &#39;Charset: explicit&#39;&#41;;
  }
+
+ {
+     #-----test------
+     my $croaked = 1;
+     eval {
+            my $e = MIME::Entity-&gt;build&#40;Type =&gt; &#39;message/rfc822&#39;,
+                                        Encoding =&gt; &#39;base64&#39;,
+                                        Data =&gt; &#34;Subject: phooey\n\nBlat\n&#34;&#41;;
+            $croaked = 0;
+     };
+     ok&#40;$croaked, &#39;MIME::Entity-&gt;build croaked on message/rfc822 with base64 encoding&#39;&#41;;
+     ok&#40;$@ =~ /can&#39;t have encoding base64 for message type message\/rfc822/,
+       &#39;and it croaked with expected error.&#39;&#41;;
+ }
+
+ {
+     #-----test------
+     my $croaked = 1;
+     eval {
+            my $e = MIME::Entity-&gt;build&#40;Type =&gt; &#39;message/global&#39;,
+                                        Encoding =&gt; &#39;base64&#39;,
+                                        Data =&gt; &#34;Subject: phooey\n\nBlat\n&#34;&#41;;
+            $croaked = 0;
+     };
+     ok&#40;!$croaked, &#39;MIME::Entity-&gt;build did not croak on message/global with base64 encoding&#39;&#41;;
+ }
+ {
+     #-----test------
+     my $croaked = 1;
+     eval {
+            my $e = MIME::Entity-&gt;build&#40;Type =&gt; &#39;multipart/alternative&#39;,
+                                        Encoding =&gt; &#39;base64&#39;,
+                                        Data =&gt; &#34;Subject: phooey\n\nBlat\n&#34;&#41;;
+            $croaked = 0;
+     };
+     ok&#40;$croaked, &#39;MIME::Entity-&gt;build croaked on multipart/alternative with base64 encoding&#39;&#41;;
+     ok&#40;$@ =~ /can&#39;t have encoding base64 for message type multipart\/alternative/,
+       &#39;and it croaked with expected error.&#39;&#41;;
+ }
 }
 
 #diag&#40;&#34;Create an entity&#34;&#41;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;10&nbsp;13:27:33&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;10&nbsp;19:33:06&nbsp;2014</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark.Martinec [...] ijs.si</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for a quick response.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I plan on applying the patch below for the next
&gt; release.  From my understanding, RFC 6532 only relaxes
&gt; the restriction for new subtypes of message/, so I keep
&gt; it in place for old subtypes.
</div>
Right, it doesn&#39;t relax it for old types.

On a careful reading, seems to me that it also does not
relax it automatically for any future subtype, but offers
new documents that introduce such new subtype a freedom
to explicitly permit encodings, should they choose so.

... which is not something that can possibly be coded
into present programs that will need to cope with
potential future subtypes defined after a program release,
so some compromise seems to be necessary.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; -    if &#40;$type =~ m{^&#40;multipart|message&#41;/}&#41; {
&gt; +    if &#40;$type =~ m{^&#40;multipart/|message/&#40;rfc822|partial|
</div>external-body|delivery-status|disposition-notification|feedback-report&#41;&#41;}&#41; {

Yes, something like that. Some boundary or delimiter or
a \z at the end of a regexp to stay on the safe side?
Is the $type guaranteed to be in lowercase?

Hope the RFC 5965 &#40;message/feedback-report&#41; doesn&#39;t change
its mind when it realizes that an Original-Rcpt-To field
may contain an UTF-8 string :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;11&nbsp;10:02:16&nbsp;2014</span>
    <span class="description">dfs [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #98737] Lift encoding restriction according to RFC 6533: can&#39;t have encoding quoted-printable for message type message/global-headers</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 11 Sep 2014 10:01:51 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David F. Skoll&#34; &lt;dfs [...] roaringpenguin.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, 10 Sep 2014 19:33:06 -0400
&#34;Mark.Martinec@ijs.si via RT&#34; &lt;bug-MIME-tools@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Yes, something like that. Some boundary or delimiter or
&gt; a \z at the end of a regexp to stay on the safe side?
</div>
Yes, good point.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Is the $type guaranteed to be in lowercase?
</div>
No, because it&#39;s passed in by the user.  So below is an updated patch.

Regards,

David.

diff --git a/lib/MIME/Entity.pm b/lib/MIME/Entity.pm
index 37d0de4..fd09008 100644
--- a/lib/MIME/Entity.pm
+++ b/lib/MIME/Entity.pm
@@ -570,7 +570,7 @@ sub build {
     $filename = undef if &#40;defined&#40;$filename&#41; and $filename eq &#39;&#39;&#41;;
 
     ### Type-check sanity:
-    if &#40;$type =~ m{^&#40;multipart|message&#41;/}&#41; {
+    if &#40;$type =~ m{^&#40;multipart/|message/&#40;rfc822|partial|external-body|delivery-status|disposition-notification|feedback-report$&#41;&#41;}i&#41; {
        &#40;$encoding =~ /^&#40;|7bit|8bit|binary|-suggest&#41;$/i&#41;
            or croak &#34;can&#39;t have encoding $encoding for message type $type!&#34;;
     }
diff --git a/t/Entity.t b/t/Entity.t
index 2ef11e2..421af5d 100644
--- a/t/Entity.t
+++ b/t/Entity.t
@@ -1,7 +1,7 @@
 #!/usr/bin/perl -w
 use strict;
 use warnings;
-use Test::More tests =&gt; 34;
+use Test::More tests =&gt; 39;
 
 use MIME::Entity;
 use MIME::Parser;
@@ -101,6 +101,45 @@ my $LINE;
      my $got = $e-&gt;head-&gt;mime_attr&#40;&#39;content-type.charset&#39;&#41;;
      is&#40;$got, &#39;iso8859-1&#39;, &#39;Charset: explicit&#39;&#41;;
  }
+
+ {
+     #-----test------
+     my $croaked = 1;
+     eval {
+            my $e = MIME::Entity-&gt;build&#40;Type =&gt; &#39;message/rfc822&#39;,
+                                        Encoding =&gt; &#39;base64&#39;,
+                                        Data =&gt; &#34;Subject: phooey\n\nBlat\n&#34;&#41;;
+            $croaked = 0;
+     };
+     ok&#40;$croaked, &#39;MIME::Entity-&gt;build croaked on message/rfc822 with base64 encoding&#39;&#41;;
+     ok&#40;$@ =~ /can&#39;t have encoding base64 for message type message\/rfc822/,
+       &#39;and it croaked with expected error.&#39;&#41;;
+ }
+
+ {
+     #-----test------
+     my $croaked = 1;
+     eval {
+            my $e = MIME::Entity-&gt;build&#40;Type =&gt; &#39;message/global&#39;,
+                                        Encoding =&gt; &#39;base64&#39;,
+                                        Data =&gt; &#34;Subject: phooey\n\nBlat\n&#34;&#41;;
+            $croaked = 0;
+     };
+     ok&#40;!$croaked, &#39;MIME::Entity-&gt;build did not croak on message/global with base64 encoding&#39;&#41;;
+ }
+ {
+     #-----test------
+     my $croaked = 1;
+     eval {
+            my $e = MIME::Entity-&gt;build&#40;Type =&gt; &#39;multipart/ALTERNATIVE&#39;,
+                                        Encoding =&gt; &#39;base64&#39;,
+                                        Data =&gt; &#34;Subject: phooey\n\nBlat\n&#34;&#41;;
+            $croaked = 0;
+     };
+     ok&#40;$croaked, &#39;MIME::Entity-&gt;build croaked on multipart/alternative with base64 encoding&#39;&#41;;
+     ok&#40;$@ =~ /can&#39;t have encoding base64 for message type multipart\/ALTERNATIVE/,
+       &#39;and it croaked with expected error.&#39;&#41;;
+ }
 }
 
 #diag&#40;&#34;Create an entity&#34;&#41;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;11&nbsp;10:05:01&nbsp;2014</span>
    <span class="description">dfs [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #98737] Lift encoding restriction according to RFC 6533: can&#39;t have encoding quoted-printable for message type message/global-headers</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 11 Sep 2014 10:04:48 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David F. Skoll&#34; &lt;dfs [...] roaringpenguin.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ugh!  Bad patch

The proper regex line should be:

    if &#40;$type =~ m{^&#40;multipart/|message/&#40;rfc822|partial|external-body|delivery-status|disposition-notification|feedback-report&#41;$&#41;}i&#41; {

I had the $ in the wrong place. :&#40;

Regards,

David.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;11&nbsp;10:33:17&nbsp;2014</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #98737] Lift encoding restriction according to RFC 6533: can&#39;t have encoding quoted-printable for message type message/global-headers</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 11 Sep 2014 16:32:54 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Martinec &lt;Mark.Martinec [...] ijs.si&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ugh!  Bad patch
&gt; I had the $ in the wrong place. :&#40;
</div>
Looks good now, thanks!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;22&nbsp;15:51:07&nbsp;2015</span>
    <span class="description">dfs+pause [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Although I forgot to mention it in the changelog, this
bug is fixed in the 5.506 release that I just uploaded.

Regards,

Dianne.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;22&nbsp;15:51:09&nbsp;2015</span>
    <span class="description">dfs+pause [...] roaringpenguin.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
