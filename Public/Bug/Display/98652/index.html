<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #64679 for DBIx-Class: find_or_create converts subselects to NULLs</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #64679 for DBIx-Class: find_or_create converts subselects to NULLs</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DBIx-Class">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DBIx-Class">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DBIx-Class">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DBIx-Class">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Class">DBIx-Class CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">64679</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DBIx-Class">DBIx-Class</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ether [...] cpan.org

<br />
TJC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-10410-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.08124</li>
<li>
0.08125</li>
<li>
0.08126</li>
</ul>
    </td>
  </tr>
  <tr id="CF-10411-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




0001-Add-test-for-sub-levels-in-find_or_create.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/880081/455873/0001-Add-test-for-sub-levels-in-find_or_create.patch">
Tue Jan 11 00:49:37 2011 (2.7k) by TJC [...] cpan.org
</a>
</font></li>
</ul>


update_or_create_single.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/880081/455872/update_or_create_single.t">
Tue Jan 11 00:49:37 2011 (4.2k) by TJC [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=64679">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-880081" href="/Public/Bug/Display.html?id=64679#txn-880081">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;11&nbsp;00:49:37&nbsp;2011</span>
    <span class="description">TJC [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> find_or_create converts subselects to NULLs</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/880081/455871/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/455871">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 899b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think I have found a bug in find_or_create&#40;&#41;, although maybe it&#39;s
more a case of &#34;it should throw an error if you try this&#34;, instead of
silenting doing the Wrong Thing.

Viz:

Assume you have these tables:
table1, with columns &#34;luser&#34; and &#34;role&#34;.
The primary key is on &#34;luser, role&#34;.
&#34;role&#34; is a foreign key into table2..

table2 has columns &#34;id&#34; and &#34;name&#34;.

my $rs = $schema-&gt;resultset&#40;&#39;table1&#39;&#41;;
$rs-&gt;find_or_create&#40;
 {
   luser =&gt; &#39;john&#39;,
   role =&gt; { name =&gt; &#39;Admin&#39; },
 }
&#41;;

In this case, the SELECT that dbix class does to try and find the user
will be WHERE luser=&#39;john&#39; AND role=NULL.

When it then creates the row, it will correctly fill it in with the ID
from the role table.
Eg. like:
INSERT INTO mytable &#40;luser,role&#41;
VALUES &#40;&#39;john&#39;, &#40;SELECT id FROM role WHERE name=&#39;Admin&#39;&#41;&#41;;


See attached for a failing test demonstrating the issue. &#40;Provided as 
both patch, and raw t file&#41;

-Toby
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> update_or_create_single.t</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/880081/455872/update_or_create_single.t">Download update_or_create_single.t</a><br />
<span class="downloadcontenttype">text/x-perl 4.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use warnings;

use Test::More;
use lib qw&#40;t/lib&#41;;
use DBICTest;

my $schema = DBICTest-&gt;init_schema&#40;&#41;;

plan tests =&gt; 20;

my $artist = $schema-&gt;resultset &#40;&#39;Artist&#39;&#41;-&gt;first;

my $genre = $schema-&gt;resultset &#40;&#39;Genre&#39;&#41;
            -&gt;create &#40;{ name =&gt; &#39;par excellence&#39; }&#41;;

is &#40;$genre-&gt;search_related&#40; &#39;model_cd&#39; &#41;-&gt;count, 0, &#39;No cds yet&#39;&#41;;

# expect a create
$genre-&gt;update_or_create_related &#40;&#39;model_cd&#39;, {
  artist =&gt; $artist,
  year =&gt; 2009,
  title =&gt; &#39;the best thing since sliced bread&#39;,
}&#41;;

# verify cd was inserted ok
is &#40;$genre-&gt;search_related&#40; &#39;model_cd&#39; &#41;-&gt;count, 1, &#39;One cd&#39;&#41;;
my $cd = $genre-&gt;find_related &#40;&#39;model_cd&#39;, {}&#41;;
is_deeply &#40;
  { map { $_, $cd-&gt;get_column &#40;$_&#41; } qw/artist year title/ },
  {
    artist =&gt; $artist-&gt;id,
    year =&gt; 2009,
    title =&gt; &#39;the best thing since sliced bread&#39;,
  },
  &#39;CD created correctly&#39;,
&#41;;

# expect a year update on the only related row
# &#40;non-qunique column + unique column as disambiguator&#41;
$genre-&gt;update_or_create_related &#40;&#39;model_cd&#39;, {
  year =&gt; 2010,
  title =&gt; &#39;the best thing since sliced bread&#39;,
}&#41;;

# re-fetch the cd, verify update
is &#40;$genre-&gt;search_related&#40; &#39;model_cd&#39; &#41;-&gt;count, 1, &#39;Still one cd&#39;&#41;;
$cd = $genre-&gt;find_related &#40;&#39;model_cd&#39;, {}&#41;;
is_deeply &#40;
  { map { $_, $cd-&gt;get_column &#40;$_&#41; } qw/artist year title/ },
  {
    artist =&gt; $artist-&gt;id,
    year =&gt; 2010,
    title =&gt; &#39;the best thing since sliced bread&#39;,
  },
  &#39;CD year column updated correctly&#39;,
&#41;;


# expect an update of the only related row
# &#40;update a unique column&#41;
$genre-&gt;update_or_create_related &#40;&#39;model_cd&#39;, {
  title =&gt; &#39;the best thing since vertical toasters&#39;,
}&#41;;

# re-fetch the cd, verify update
is &#40;$genre-&gt;search_related&#40; &#39;model_cd&#39; &#41;-&gt;count, 1, &#39;Still one cd&#39;&#41;;
$cd = $genre-&gt;find_related &#40;&#39;model_cd&#39;, {}&#41;;
is_deeply &#40;
  { map { $_, $cd-&gt;get_column &#40;$_&#41; } qw/artist year title/ },
  {
    artist =&gt; $artist-&gt;id,
    year =&gt; 2010,
    title =&gt; &#39;the best thing since vertical toasters&#39;,
  },
  &#39;CD title column updated correctly&#39;,
&#41;;


# expect a year update on the only related row
# &#40;non-unique column only&#41;
$genre-&gt;update_or_create_related &#40;&#39;model_cd&#39;, {
  year =&gt; 2011,
}&#41;;

# re-fetch the cd, verify update
is &#40;$genre-&gt;search_related&#40; &#39;model_cd&#39; &#41;-&gt;count, 1, &#39;Still one cd&#39;&#41;;
$cd = $genre-&gt;find_related &#40;&#39;model_cd&#39;, {}&#41;;
is_deeply &#40;
  { map { $_, $cd-&gt;get_column &#40;$_&#41; } qw/artist year title/ },
  {
    artist =&gt; $artist-&gt;id,
    year =&gt; 2011,
    title =&gt; &#39;the best thing since vertical toasters&#39;,
  },
  &#39;CD year column updated correctly without a disambiguator&#39;,
&#41;;


# Test multi-level find-or-create functionality.
# We should be able to find-or-create this twice, with the second time
# returning the same item and genre as the first..
# This first test has the sub-level query on a non-unique key, ie. it
# isn&#39;t checked as part of the &#34;find&#34; half of the method.

my $genre_name = &#39;Highlander&#39;;
my %cd_details = &#40;
    year =&gt; &#39;2010&#39;,
    title =&gt; &#39;Tasty Treats&#39;,
    genre =&gt; { name =&gt; $genre_name }
&#41;;
my $genre2 = $schema-&gt;resultset &#40;&#39;Genre&#39;&#41;
            -&gt;create &#40;{ name =&gt; $genre_name }&#41;;

my $found1 = $artist-&gt;find_or_create_related&#40;&#39;cds&#39;, { %cd_details }&#41;;
ok&#40;$found1-&gt;id, &#34;Found &#40;actually created&#41; album in first iteration&#34;&#41;;
is&#40;$found1-&gt;genre-&gt;name, $genre_name, &#34;.. with correct genre&#34;&#41;;

my $found2 = $artist-&gt;find_or_create_related&#40;&#39;cds&#39;, { %cd_details }&#41;;
ok&#40;$found2-&gt;id, &#34;Found album in second iteration&#34;&#41;;
is&#40;$found2-&gt;id, $found1-&gt;id, &#34;..and the IDs are the same.&#34;&#41;;
is&#40;$found2-&gt;genre-&gt;name, $genre_name, &#34;.. with correct genre&#34;&#41;;


# Now we repeat the tests, using a sub-level query on one of the critical
# keys that IS used in the &#34;find&#34; part.
# Unfortunately DBIC&#39;s generated SQL looks for &#34;artist=NULL&#34; here.
my $artist_name = &#39;Peanut and Cashew Mix&#39;;
my %new_cd = &#40;
    year =&gt; &#39;2011&#39;,
    title =&gt; &#39;Various Failures&#39;,
    artist =&gt; { name =&gt; $artist_name },
&#41;;
my $found3 = $genre2-&gt;find_or_create_related&#40;&#39;cds&#39;, { %new_cd }&#41;;
ok&#40;$found3-&gt;id, &#34;Found &#40;actually created&#41; album in first iteration&#34;&#41;;
is&#40;$found3-&gt;artist-&gt;name, $artist_name, &#34;..with correct artist name&#34;&#41;;

my $found4 = $genre2-&gt;find_or_create_related&#40;&#39;cds&#39;, { %new_cd }&#41;;
ok&#40;$found4-&gt;id, &#34;Found album in second iteration&#34;&#41;;
is&#40;$found4-&gt;id, $found3-&gt;id, &#34;..and the IDs are the same.&#34;&#41;;
is&#40;$found4-&gt;artist-&gt;name, $artist_name, &#34;.. with correct artist name&#34;&#41;;
is&#40;$found4-&gt;artist-&gt;id, $found3-&gt;artist-&gt;id, &#34;..matching artist ids&#34;&#41;;

</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Add-test-for-sub-levels-in-find_or_create.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/880081/455873/0001-Add-test-for-sub-levels-in-find_or_create.patch">Download 0001-Add-test-for-sub-levels-in-find_or_create.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 7649e2e7726fe4a39aec9b2eb1883451c8e9a9ec Mon Sep 17 00:00:00 2001
From: Toby Corkindale &lt;toby@dryft.net&gt;
Date: Mon, 20 Dec 2010 13:27:09 +1100
Subject: [PATCH] Add test for sub-levels in find_or_create.

Currently failing.
---
 t/relationship/update_or_create_single.t |   48 +++++++++++++++++++++++++++++-
 1 files changed, 47 insertions&#40;+&#41;, 1 deletions&#40;-&#41;

diff --git a/t/relationship/update_or_create_single.t b/t/relationship/update_or_create_single.t
index a0e31fb..416a130 100644
--- a/t/relationship/update_or_create_single.t
+++ b/t/relationship/update_or_create_single.t
@@ -7,7 +7,7 @@ use DBICTest;
 
 my $schema = DBICTest-&gt;init_schema&#40;&#41;;
 
-plan tests =&gt; 9;
+plan tests =&gt; 20;
 
 my $artist = $schema-&gt;resultset &#40;&#39;Artist&#39;&#41;-&gt;first;
 
@@ -95,3 +95,49 @@ is_deeply &#40;
   },
   &#39;CD year column updated correctly without a disambiguator&#39;,
 &#41;;
+
+
+# Test multi-level find-or-create functionality.
+# We should be able to find-or-create this twice, with the second time
+# returning the same item and genre as the first..
+# This first test has the sub-level query on a non-unique key, ie. it
+# isn&#39;t checked as part of the &#34;find&#34; half of the method.
+
+my $genre_name = &#39;Highlander&#39;;
+my %cd_details = &#40;
+    year =&gt; &#39;2010&#39;,
+    title =&gt; &#39;Tasty Treats&#39;,
+    genre =&gt; { name =&gt; $genre_name }
+&#41;;
+my $genre2 = $schema-&gt;resultset &#40;&#39;Genre&#39;&#41;
+            -&gt;create &#40;{ name =&gt; $genre_name }&#41;;
+
+my $found1 = $artist-&gt;find_or_create_related&#40;&#39;cds&#39;, { %cd_details }&#41;;
+ok&#40;$found1-&gt;id, &#34;Found &#40;actually created&#41; album in first iteration&#34;&#41;;
+is&#40;$found1-&gt;genre-&gt;name, $genre_name, &#34;.. with correct genre&#34;&#41;;
+
+my $found2 = $artist-&gt;find_or_create_related&#40;&#39;cds&#39;, { %cd_details }&#41;;
+ok&#40;$found2-&gt;id, &#34;Found album in second iteration&#34;&#41;;
+is&#40;$found2-&gt;id, $found1-&gt;id, &#34;..and the IDs are the same.&#34;&#41;;
+is&#40;$found2-&gt;genre-&gt;name, $genre_name, &#34;.. with correct genre&#34;&#41;;
+
+
+# Now we repeat the tests, using a sub-level query on one of the critical
+# keys that IS used in the &#34;find&#34; part.
+# Unfortunately DBIC&#39;s generated SQL looks for &#34;artist=NULL&#34; here.
+my $artist_name = &#39;Peanut and Cashew Mix&#39;;
+my %new_cd = &#40;
+    year =&gt; &#39;2011&#39;,
+    title =&gt; &#39;Various Failures&#39;,
+    artist =&gt; { name =&gt; $artist_name },
+&#41;;
+my $found3 = $genre2-&gt;find_or_create_related&#40;&#39;cds&#39;, { %new_cd }&#41;;
+ok&#40;$found3-&gt;id, &#34;Found &#40;actually created&#41; album in first iteration&#34;&#41;;
+is&#40;$found3-&gt;artist-&gt;name, $artist_name, &#34;..with correct artist name&#34;&#41;;
+
+my $found4 = $genre2-&gt;find_or_create_related&#40;&#39;cds&#39;, { %new_cd }&#41;;
+ok&#40;$found4-&gt;id, &#34;Found album in second iteration&#34;&#41;;
+is&#40;$found4-&gt;id, $found3-&gt;id, &#34;..and the IDs are the same.&#34;&#41;;
+is&#40;$found4-&gt;artist-&gt;name, $artist_name, &#34;.. with correct artist name&#34;&#41;;
+is&#40;$found4-&gt;artist-&gt;id, $found3-&gt;artist-&gt;id, &#34;..matching artist ids&#34;&#41;;
+
-- 
1.7.3.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-881074" href="/Public/Bug/Display.html?id=64679#txn-881074">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;13&nbsp;07:53:33&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/881074/456462/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/456462">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 962b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jan 11 00:49:37 2011, TJC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think I have found a bug in find_or_create&#40;&#41;, although maybe it&#39;s
&gt; more a case of &#34;it should throw an error if you try this&#34;, instead of
&gt; silenting doing the Wrong Thing.
</div>
Unfortunately the find_or_create interface is generally not thought out,
as it requires a user to pass incompatible args &#40;the find and the create
one&#41; in the same method call. The fix to make your tests pass is trivial
and you can see it here:

<span class="clickylink"><a target="new" rel="nofollow" href="http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=dbsrgits/DBIx-Class.git;a=commitdiff;h=dac9bfca09553f052ff6e37a680d9760646a8b66#patch1">http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=dbsrgits/DBIx-Class.git;a=commitdiff;h=dac9bfca09553f052ff6e37a680d9760646a8b66#patch1</a></span>

Whether this is the right thing to do - I am not entirely sure, The fact
that resolve_condition was there in the first place implies that someone
thought it would be a good idea at the time, completely disregarding
your particular use case.

Let me know what you think about the situation in general, maybe you can
come up with some solution that I am not seeing.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-881077" href="/Public/Bug/Display.html?id=64679#txn-881077">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;13&nbsp;07:53:34&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-881454" href="/Public/Bug/Display.html?id=64679#txn-881454">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;14&nbsp;00:21:36&nbsp;2011</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/881454/456672/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/456672">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jan 13 07:53:33 2011, RIBASUSHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The fix to make your tests pass is trivial
&gt; and you can see it here:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=dbsrgits/DBIx-">http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=dbsrgits/DBIx-</a></span>
&gt; Class.git;a=commitdiff;h=dac9bfca09553f052ff6e37a680d9760646a8b66#patch1
&gt; 
&gt; Whether this is the right thing to do - I am not entirely sure, The
&gt; fact
&gt; that resolve_condition was there in the first place implies that
&gt; someone
&gt; thought it would be a good idea at the time, completely disregarding
&gt; your particular use case.
</div>
Hmm, I can already see a case where the suggested fix wouldn&#39;t be valid, I&#39;m afraid.

Consider a table like this, which is linking three foreign keys:
CREATE TABLE foo &#40;
  user_id INTEGER NOT NULL REFERENCES users&#40;id&#41;,
  group_id INTEGER NOT NULL REFERENCES groups&#40;id&#41;,
  role_id INTEGER NOT NULL REFERENCES roles&#40;id&#41;,
  PRIMARY KEY &#40;user_id, group_id, role_id&#41;
&#41;;

Now say you tried to do:

$schema-&gt;resultset&#40;&#39;Foo&#39;&#41;-&gt;find_or_create&#40;
  {
    user_id =&gt; 1,
    group_id =&gt; { name =&gt; &#34;DBIC Developers&#34; },
    role_id =&gt; { name =&gt; &#34;Moderator&#34; }
  }
&#41;;

$schema-&gt;resultset&#40;&#39;Foo&#39;&#41;-&gt;find_or_create&#40;
  {
    user_id =&gt; 1,
    group_id =&gt; { name =&gt; &#34;DBIC Users&#34; },
    role_id =&gt; { name =&gt; &#34;Moderator&#34; }
  }
&#41;;

This would fail using the suggested fix, as the find.. portion would just look for the 
user_id component and ignore the other two.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Let me know what you think about the situation in general, maybe you
&gt; can come up with some solution that I am not seeing.
</div>
It sounds like we need the sub-queries to be resolved properly during the find&#40;&#41; 
portion, but I guess that&#39;s hard, if they are only supported during a create&#40;&#41;?


Otherwise, I&#39;d prefer to just have an error thrown, although that might surprise anyone 
relying upon the bug&#39;s existing behaviour, if any?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-882420" href="/Public/Bug/Display.html?id=64679#txn-882420">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;16&nbsp;18:09:15&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/882420/457206/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/457206">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jan 14 00:21:36 2011, TJC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Jan 13 07:53:33 2011, RIBASUSHI wrote:
<div class="message-stanza open">&gt; &gt; The fix to make your tests pass is trivial
&gt; &gt; and you can see it here:
&gt; &gt;
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=dbsrgits/DBIx-">http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=dbsrgits/DBIx-</a></span>
&gt; &gt;
</div>&gt; Class.git;a=commitdiff;h=dac9bfca09553f052ff6e37a680d9760646a8b66#patch1
<div class="message-stanza open">&gt; &gt;
&gt; &gt; Whether this is the right thing to do - I am not entirely sure, The
&gt; &gt; fact
&gt; &gt; that resolve_condition was there in the first place implies that
&gt; &gt; someone
&gt; &gt; thought it would be a good idea at the time, completely disregarding
&gt; &gt; your particular use case.
</div>&gt; 
&gt; Hmm, I can already see a case where the suggested fix wouldn&#39;t be
&gt; valid, I&#39;m afraid.
</div>
I mistook an irc &#39;tjc&#39; to be you and braindumped the following:

&lt;ribasushi&gt; tjc: on RT#64679 - I am generally not opposed to having
*something* done on this front, as long as someone else does it and does
it right &#40;i.e. with regard to backwards comp, doing the necessary
research why things are currently the way they are etc&#41;
&lt;ribasushi&gt; tjc: so don&#39;t take my skepticism expressed in the ticket as
&#34;this is to remain broken&#34;
&lt;ribasushi&gt; tjc: I just don&#39;t want to be the one to unfuck it, got
enough other things :&#41;
&lt;ribasushi&gt; tjc: fwiw the original code is old and have not changed much
&#40;and judging by the commit message wasn&#39;t without controversy either :&#41;
&lt;ribasushi&gt;
<span class="clickylink"><a target="new" rel="nofollow" href="http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=dbsrgits/DBIx-Class.git;a=blobdiff;f=lib/DBIx/Class/ResultSet.pm;h=64bcd4ea53230b3549f94e275605bc097f47cada;hp=6ab3ec08344aef2970cafd8c9a9cae1810a6af0f;hb=096f421241;hpb=03f24ee3c4fd551a0de43a1cc2821184f8864cb8">http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=dbsrgits/DBIx-Class.git;a=blobdiff;f=lib/DBIx/Class/ResultSet.pm;h=64bcd4ea53230b3549f94e275605bc097f47cada;hp=6ab3ec08344aef2970cafd8c9a9cae1810a6af0f;hb=096f421241;hpb=03f24ee3c4fd551a0de43a1cc2821184f8864cb8</a></span>

So if you can help me with this issue - awesome!

Cheers
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-891707" href="/Public/Bug/Display.html?id=64679#txn-891707">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;03&nbsp;08:25:42&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/891707/462219/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/462219">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 76b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Stalling ticket as &#34;needs sqla2&#34; unless better ideas pop up in the meantime.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-891710" href="/Public/Bug/Display.html?id=64679#txn-891710">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;03&nbsp;08:25:44&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Create even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1407699" href="/Public/Bug/Display.html?id=64679#txn-1407699">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;05&nbsp;16:01:03&nbsp;2014</span>
    <span class="description">ether [...] cpan.org - Ticket #98652:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> find_or_create on nested values does not work as expected</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1407699/747210/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/747210">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 6.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">here is a repro case:

    use strict;
    use warnings;

    use Test::More;
    use Test::Exception;
    use lib qw&#40;t/lib&#41;;
    use DBICTest;

    my $schema = DBICTest-&gt;init_schema&#40;&#41;;

    my $cd_rs = $schema-&gt;resultset&#40;&#39;CD&#39;&#41;;

    my $cd = $cd_rs-&gt;create&#40;{
      title=&gt;&#34;Music for Silly Walks&#34;,
      year=&gt;2000,
      artist =&gt; {
        name=&gt;&#34;Silly Musician&#34;,
      }
    }&#41;;

    my $artist = $cd-&gt;artist;

    is&#40;$cd-&gt;title, &#34;Music for Silly Walks&#34;, &#39;got cd row&#39;&#41;;
    is&#40;$artist-&gt;name, &#34;Silly Musician&#34;, &#39;got artist row&#39;&#41;;


    my $cd2 = $cd_rs-&gt;find_or_create&#40;{
      title=&gt;&#34;More Music for Silly Walks&#34;,
      year=&gt;2001,
      artist =&gt; {
        name=&gt;&#34;Silly Musician&#34;,
      }
    }&#41;;

    is&#40;$cd2-&gt;title, &#34;More Music for Silly Walks&#34;, &#39;got second cd row&#39;&#41;;

    my $artist2 = $cd2-&gt;artist;
    is&#40;$artist2-&gt;name, &#34;Silly Musician&#34;, &#39;got artist row&#39;&#41;;
    is&#40;$artist2-&gt;artistid, $artist-&gt;artistid, &#39;artist row is the same as the first&#39;&#41;;


    my $cd3 = $cd_rs-&gt;find_or_create&#40;{
      title=&gt;&#34;More Music for Silly Walks&#34;,  # same as cd2!
      year=&gt;2001,
      artist =&gt; {
        name=&gt;&#34;Silly Musician&#34;,
      }
    }&#41;;

    is&#40;$cd3-&gt;title, &#34;More Music for Silly Walks&#34;, &#39;got &#34;third&#34; cd row&#39;&#41;;
    is&#40;$cd3-&gt;cdid, $cd2-&gt;cdid, &#39;cd row is the same as the second&#39;&#41;;

    done_testing;
    __END__

    with DBIC_TRACE, gives:

    SELECT me.artistid, me.name, me.rank, me.charfield FROM artist me WHERE &#40; me.name = ? &#41;: &#39;Silly Musician&#39;
    INSERT INTO artist &#40; name&#41; VALUES &#40; ? &#41;: &#39;Silly Musician&#39;
    INSERT INTO cd &#40; artist, title, year&#41; VALUES &#40; ?, ?, ? &#41;: &#39;4&#39;, &#39;Music for Silly Walks&#39;, &#39;2000&#39;
    COMMIT
    SELECT me.artistid, me.name, me.rank, me.charfield FROM artist me WHERE &#40; me.artistid = ? &#41;: &#39;4&#39;
    ok 1 - got cd row
    ok 2 - got artist row
    SELECT me.cdid, me.artist, me.title, me.year, me.genreid, me.single_track FROM cd me WHERE &#40; &#40; me.artist IS NULL AND me.title = ? AND me.year = ? &#41; &#41;: &#39;More Music for Silly Walks&#39;, &#39;2001&#39;
    SELECT me.artistid, me.name, me.rank, me.charfield FROM artist me WHERE &#40; me.name = ? &#41;: &#39;Silly Musician&#39;
    INSERT INTO cd &#40; artist, title, year&#41; VALUES &#40; ?, ?, ? &#41;: &#39;4&#39;, &#39;More Music for Silly Walks&#39;, &#39;2001&#39;
    ok 3 - got second cd row
    SELECT me.artistid, me.name, me.rank, me.charfield FROM artist me WHERE &#40; me.artistid = ? &#41;: &#39;4&#39;
    ok 4 - got artist row
    ok 5 - artist row is the same as the first
    SELECT me.cdid, me.artist, me.title, me.year, me.genreid, me.single_track FROM cd me WHERE &#40; &#40; me.artist IS NULL AND me.title = ? AND me.year = ? &#41; &#41;: &#39;More Music for Silly Walks&#39;, &#39;2001&#39;
    SELECT me.artistid, me.name, me.rank, me.charfield FROM artist me WHERE &#40; me.name = ? &#41;: &#39;Silly Musician&#39;
    INSERT INTO cd &#40; artist, title, year&#41; VALUES &#40; ?, ?, ? &#41;: &#39;4&#39;, &#39;More Music for Silly Walks&#39;, &#39;2001&#39;
    DBI Exception: DBD::SQLite::st execute failed: UNIQUE constraint failed: cd.artist, cd.title [for Statement &#34;INSERT INTO cd &#40; artist, title, year&#41; VALUES &#40; ?, ?, ? &#41;&#34;] at lib/DBIx/Class/Schema.pm line 1081, &lt;&gt; line 1.
            DBIx::Class::Schema::throw_exception&#40;DBICTest::Schema=HASH&#40;0x7ff28af27cf8&#41;, &#34;DBI Exception: DBD::SQLite::st execute failed: UNIQUE constra&#34;...&#41; called at lib/DBIx/Class/Storage.pm line 113
            DBIx::Class::Storage::throw_exception&#40;DBIx::Class::Storage::DBI::SQLite=HASH&#40;0x7ff28af2d6f8&#41;, &#34;DBI Exception: DBD::SQLite::st execute failed: UNIQUE constra&#34;...&#41; called at lib/DBIx/Class/Storage/DBI.pm line 1473
            DBIx::Class::Storage::DBI::__ANON__&#40;&#34;DBD::SQLite::st execute failed: UNIQUE constraint failed: cd.&#34;..., DBI::st=HASH&#40;0x7ff28bdb2a60&#41;, undef&#41; called at lib/DBIx/Class/Storage/DBI.pm line 1840
            DBIx::Class::Storage::DBI::_dbh_execute&#40;DBIx::Class::Storage::DBI::SQLite=HASH&#40;0x7ff28af2d6f8&#41;, DBI::db=HASH&#40;0x7ff28bbae998&#41;, &#34;INSERT INTO cd &#40; artist, title, year&#41; VALUES &#40; ?, ?, ? &#41;&#34;, ARRAY&#40;0x7ff28bdb2b68&#41;, ARRAY&#40;0x7ff28bdbca90&#41;&#41; called at lib/DBIx/Class/Storage/DBI/SQLite.pm line 289
            DBIx::Class::Storage::DBI::SQLite::_dbh_execute&#40;DBIx::Class::Storage::DBI::SQLite=HASH&#40;0x7ff28af2d6f8&#41;, DBI::db=HASH&#40;0x7ff28bbae998&#41;, &#34;INSERT INTO cd &#40; artist, title, year&#41; VALUES &#40; ?, ?, ? &#41;&#34;, ARRAY&#40;0x7ff28bdb2b68&#41;, ARRAY&#40;0x7ff28bdbca90&#41;&#41; called at lib/DBIx/Class/Storage/DBI.pm line 855
            DBIx::Class::Storage::DBI::__ANON__&#40;&#41; called at lib/DBIx/Class/Storage/BlockRunner.pm line 136
            DBIx::Class::Storage::BlockRunner::try {...} &#40;&#41; called at /Users/ether/.perlbrew/libs/20.0@std/lib/perl5/Try/Tiny.pm line 77
            eval {...} called at /Users/ether/.perlbrew/libs/20.0@std/lib/perl5/Try/Tiny.pm line 72
            Try::Tiny::try&#40;CODE&#40;0x7ff28bdbd1f8&#41;, Try::Tiny::Catch=REF&#40;0x7ff28bdb2ac0&#41;&#41; called at lib/DBIx/Class/Storage/BlockRunner.pm line 140
            DBIx::Class::Storage::BlockRunner::__ANON__&#40;&#41; called at /Users/ether/.perlbrew/libs/20.0@std/lib/perl5/Context/Preserve.pm line 32
            Context::Preserve::preserve_context&#40;CODE&#40;0x7ff28bdbd588&#41;, &#34;replace&#34;, CODE&#40;0x7ff28bdbd6d8&#41;&#41; called at lib/DBIx/Class/Storage/BlockRunner.pm line 219
            DBIx::Class::Storage::BlockRunner::_run&#40;DBIx::Class::Storage::BlockRunner=HASH&#40;0x7ff28bdbd1e0&#41;, CODE&#40;0x7ff28ae4dae0&#41;&#41; called at lib/DBIx/Class/Storage/BlockRunner.pm line 111
            DBIx::Class::Storage::BlockRunner::run&#40;DBIx::Class::Storage::BlockRunner=HASH&#40;0x7ff28bdbd1e0&#41;, CODE&#40;0x7ff28ae4dae0&#41;&#41; called at lib/DBIx/Class/Storage/DBI.pm line 856
            DBIx::Class::Storage::DBI::dbh_do&#40;undef, undef, &#34;INSERT INTO cd &#40; artist, title, year&#41; VALUES &#40; ?, ?, ? &#41;&#34;, ARRAY&#40;0x7ff28bdb2b68&#41;, ARRAY&#40;0x7ff28bdbca90&#41;&#41; called at lib/DBIx/Class/Storage/DBI.pm line 1821
            DBIx::Class::Storage::DBI::_execute&#40;DBIx::Class::Storage::DBI::SQLite=HASH&#40;0x7ff28af2d6f8&#41;, &#34;insert&#34;, DBIx::Class::ResultSource::Table=HASH&#40;0x7ff28af3d328&#41;, HASH&#40;0x7ff28bcbf1c8&#41;, undef&#41; called at lib/DBIx/Class/Storage/DBI.pm line 1983
            DBIx::Class::Storage::DBI::insert&#40;DBIx::Class::Storage::DBI::SQLite=HASH&#40;0x7ff28af2d6f8&#41;, DBIx::Class::ResultSource::Table=HASH&#40;0x7ff28af3d328&#41;, HASH&#40;0x7ff28ba52a68&#41;&#41; called at lib/DBIx/Class/Row.pm line 405
            DBIx::Class::Row::insert&#40;DBICTest::CD=HASH&#40;0x7ff28bdbd498&#41;&#41; called at lib/DBIx/Class/ResultSet.pm line 2800
            DBIx::Class::ResultSet::create&#40;DBICTest::BaseResultSet=HASH&#40;0x7ff28bc349f8&#41;, HASH&#40;0x7ff28bdb2478&#41;&#41; called at lib/DBIx/Class/ResultSet.pm line 2882
            DBIx::Class::ResultSet::find_or_create&#40;DBICTest::BaseResultSet=HASH&#40;0x7ff28bc349f8&#41;, HASH&#40;0x7ff28bdb2478&#41;&#41; called at t/find_or_create_multi.t line 42
    # Auto checked 5 references for leaks - none detected
    # Tests were run but no plan was declared and done_testing&#40;&#41; was not seen.
    # Looks like your test exited with 255 just after 5.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1407711" href="/Public/Bug/Display.html?id=64679#txn-1407711">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;05&nbsp;16:22:22&nbsp;2014</span>
    <span class="description">ether [...] cpan.org - Ticket #98652:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1407711/747218/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/747218">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 621b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">When I add  { key =&gt; &#39;cd_artist_title&#39; } as the second argument to all $cd_rs-&gt;find_or_create calls, this warning message appears for all calls, and helps decipher the problem:

DBIx::Class::ResultSet::_build_unique_cond&#40;&#41;: NULL/undef values supplied for requested unique constraint &#39;cd_artist_title&#39; &#40;NULL values in column&#40;s&#41;: &#39;artist&#39;&#41;. This is almost certainly not what you wanted, though you can set DBIC_NULLABLE_KEY_NOWARN to disable this warning. at t/find_or_create_multi.t line 28

So, even though we provide enough information to find a unique artist, the artist PK is not being fed into the cd-&gt;find query.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1407854" href="/Public/Bug/Display.html?id=64679#txn-1407854">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;06&nbsp;06:41:30&nbsp;2014</span>
    <span class="description">ribasushi [...] leporine.io - Ticket #98652:  Merged into ticket #64679</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1407855" href="/Public/Bug/Display.html?id=64679#txn-1407855">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;06&nbsp;06:41:32&nbsp;2014</span>
    <span class="description">ribasushi [...] leporine.io -  Merged into ticket #64679</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1407864" href="/Public/Bug/Display.html?id=64679#txn-1407864">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;06&nbsp;06:54:05&nbsp;2014</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1407864/747288/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/747288">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Sep 05 22:22:22 2014, ETHER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ...
&gt; So, even though we provide enough information to find a unique artist,
&gt; the artist PK is not being fed into the cd-&gt;find query.
</div>
As you can tell from the merge-action on this ticket - this is a known issue &#40;originally RT#64679&#41;.

The work done so far by Toby is sitting in <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dbsrgits/dbix-class/commit/6572c1f4c2">https://github.com/dbsrgits/dbix-class/commit/6572c1f4c2</a></span> &#40;this is the same commit as the dac9bfca09 mentioned in <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=64679#txn-881074">https://rt.cpan.org/Ticket/Display.html?id=64679#txn-881074</a></span>, it simply drifted since, due to a rebase&#41;. It never went forward due to lack of clarity whether this is actually the right approach &#40;see resume in <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=64679#txn-882420">https://rt.cpan.org/Ticket/Display.html?id=64679#txn-882420</a></span>, and particularly the original commit introducing the inconsistency&#41;

Now almost 4 years later the landscape has changed a bit. In particular:
- there is a very good warning-emitting framework in place allowing for unobtrusive deprecations &#40;carp_unique&#41;
- the code of find&#40;&#41; has been refactored multiple times, and provides a clear delineation of where/how it does its stuff
- we have a very sophisticated relationship condition resolver, able to reliably pinpoint which cross-table columns are mapped together.

Putting all of the above together I am confident an interested party can produce a workable plan going forward. As I said earlier - the current situation sucks, and likely is worked around in many situations.

The sticking point is that while it is possible to break these workarounds, the *reason* for breaking them should be clear and unambiguous. Therefore - let&#39;s spec this up and see if we can poke any holes in it. If we can&#39;t - it will get implemented &#40;and likely be made available for immediate use with the proper $rs-level attr&#41;.

I am unstalling this ticket in the hope that we can go somewhere new :&#41; But just as 3 years ago - volunteers to do the *spec* legwork are sorely needed &#40;the code itself is likely to be trivial&#41;.

Cheers
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1407865" href="/Public/Bug/Display.html?id=64679#txn-1407865">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;06&nbsp;06:54:07&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1407868" href="/Public/Bug/Display.html?id=64679#txn-1407868">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;06&nbsp;07:14:07&nbsp;2014</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1407868/747291/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/747291">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jan 14 06:21:36 2011, TJC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; It sounds like we need the sub-queries to be resolved properly during
&gt; the find&#40;&#41;
&gt; portion, but I guess that&#39;s hard, if they are only supported during a
&gt; create&#40;&#41;?
</div>
An extra note on this particular point: there is now a working &#40;albeit a bit limited&#41; implementation of a &#34;related creation with ids retrieved via a subquery&#34; as part of <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dbsrgits/dbix-class/commit/d0cefd99a9">https://github.com/dbsrgits/dbix-class/commit/d0cefd99a9</a></span> &#40;read the commit message, especially paragraphs 4~6&#41;.

The actual implementation of this can be found here: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dbsrgits/dbix-class/blob/e089c417ce/lib/DBIx/Class/ResultSet.pm#L2450-L2486">https://github.com/dbsrgits/dbix-class/blob/e089c417ce/lib/DBIx/Class/ResultSet.pm#L2450-L2486</a></span> , and even more importantly the subset  <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dbsrgits/dbix-class/blob/e089c417ce/lib/DBIx/Class/ResultSet.pm#L2473-L2481">https://github.com/dbsrgits/dbix-class/blob/e089c417ce/lib/DBIx/Class/ResultSet.pm#L2473-L2481</a></span> , which basically can be translated as: &#34;Create a resultset which has each of our PKs defined via subqueries into the parent resultset, and then call create on that&#34;. Nothing prevents you from firing an actual find, it just has to be implemented with care, and a ton of extra tests.

For completeness - this is what a populate query looks like based on this code:

INSERT INTO fourkeys_to_twokeys &#40;
 autopilot,
 f_bar,
 f_foo,
 f_goodbye,
 f_hello,
 t_artist,
 t_cd
&#41; VALUES &#40;
 ?,
 ?,
 ?,
 ?,
 ?,
 &#40;
  SELECT me.artist FROM twokeys me WHERE artist = ? AND cd = ?
 &#41;,
 &#40;
  SELECT me.cd FROM twokeys me WHERE artist = ? AND cd = ?
 &#41;
&#41;

Hope this is helpful.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.574222</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
