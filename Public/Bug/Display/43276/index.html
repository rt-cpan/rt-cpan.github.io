<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #43276 for Proc-Simple: &lt;defunct&gt; processes can run rampant and system calls within child processes may not return valid status</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #43276 for Proc-Simple: &lt;defunct&gt; processes can run rampant and system calls within child processes may not return valid status</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Proc-Simple/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Proc-Simple/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Proc-Simple/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Proc-Simple/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Proc-Simple">Proc-Simple CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">43276</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Proc-Simple/Active/">Proc-Simple</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
aveckey [...] hotmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-27226-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.23    </td>
  </tr>
  <tr id="CF-27227-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;13&nbsp;19:27:58&nbsp;2009</span>
    <span class="description">aveckey [...] hotmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> &lt;defunct&gt; processes can run rampant and system calls within child
 processes may not return valid status</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Because the $SIG{CHLD} is not being reset in the child process within
the start&#40;&#41; function, sometimes &lt;defunct&gt; processes can pile up.

Another item is if the child process is performing system commands
itself, the exit statuses of those system commands are not always
reflected correctly.


The observation is that the $SIG{CHLD} is still set to \&#38;THE_REAPER and
Proc::Simple has no record of those grandchild processes, so they are
left &lt;defunct&gt;, waiting to be reaped.


The fix is to add as the first line in the start&#40;&#41; functions child
process a &#39;local $SIG{CHLD};&#39; in order to reset the CHLD signal handle
for the child.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;13&nbsp;19:32:42&nbsp;2009</span>
    <span class="description">aveckey [...] hotmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 13 19:27:58 2009, aveckey wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Because the $SIG{CHLD} is not being reset in the child process within
&gt; the start&#40;&#41; function, sometimes &lt;defunct&gt; processes can pile up.
&gt; 
&gt; Another item is if the child process is performing system commands
&gt; itself, the exit statuses of those system commands are not always
&gt; reflected correctly.
&gt; 
&gt; 
&gt; The observation is that the $SIG{CHLD} is still set to \&#38;THE_REAPER and
&gt; Proc::Simple has no record of those grandchild processes, so they are
&gt; left &lt;defunct&gt;, waiting to be reaped.
&gt; 
&gt; 
&gt; The fix is to add as the first line in the start&#40;&#41; functions child
&gt; process a &#39;local $SIG{CHLD};&#39; in order to reset the CHLD signal handle
&gt; for the child.
</div>

The below will reproduce the results I am seeing, note that within the
child process &#39;test&#40;&#41;&#39; function, the $SIG{CHLD} is still set.  The
&lt;defunct&gt; processes will accumulate under the child processes, so keep
monitoring the whole process tree, once the original child is reaped,
the &lt;defunct&gt; processes will be purged too &#40;but I have seen cases where
they remain&#41;.

I am running this on Perl 5.8.8
SunOS il93hsrv41 5.9 Generic_118558-39 sun4u sparc SUNW,Sun-Fire-V440
Solaris




use Proc::Simple;
use Cwd;

my %procs = &#40;&#41;;
foreach my $cnt &#40;1..4&#41;
{
    $procs{$cnt} = new Proc::Simple&#40;&#41;;
    $procs{$cnt}-&gt;start&#40;\&#38;test, $cnt, @ARGV&#41;;
}

print &#34;Current directory is &#34;, cwd&#40;&#41;, &#34;\n&#34;;
print &#34;Current directory is &#34;, cwd&#40;&#41;, &#34;\n&#34;;
print &#34;Current directory is &#34;, cwd&#40;&#41;, &#34;\n&#34;;


print &#34;Press &lt;enter&gt; to continue &#40;$$&#41;\n&#34;; &lt;STDIN&gt;;




sub test
{
    my $iteration = shift;

    print &#34;Passed was $iteration\n&#34;;
    foreach my $cnt &#40;0..20&#41;
    {
        printf &#34;%d Waiting %d more seconds ...\n&#34;,$$, 20 - $cnt;
        print &#34;Current directory is &#34;, cwd&#40;&#41;, &#34;\n&#34;;
        my $sys = system&#40;qq&#40;perl -e &#39;exit&#40;$cnt&#41;;&#39;&#41;&#41;;
        printf &#34;%d should be %d &#40;%d&#41;\n&#34;, $cnt, $sys, $sys / 256;
        print &#34;SIG = $SIG{CHLD}\n&#34;;
        sleep&#40;1&#41;;
    }
    print &#34;-------------------------$$ done.\n&#34;;
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;13&nbsp;19:32:44&nbsp;2009</span>
    <span class="description">aveckey [...] hotmail.com -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;16&nbsp;11:58:12&nbsp;2009</span>
    <span class="description">aveckey [...] hotmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The fix that I am suggesting is adding a &#39;local&#39; before redefining the
&#39;CHLD&#39; signal handler and also blanking &#39;CHLD&#39; within the child process:

&lt;PRE&gt;

sub start {
  my $self  = shift;
  my &#40;$func, @params&#41; = @_;

  # Reap Zombies automatically
  local $SIG{&#39;CHLD&#39;} = \&#38;THE_REAPER;

  # Fork a child process
  $self-&gt;{&#39;pid&#39;} = fork&#40;&#41;;
  return 0 unless defined $self-&gt;{&#39;pid&#39;};  #   return Error if fork failed

  if&#40;$self-&gt;{pid} == 0&#41; { # Child

      local $SIG{&#39;CHLD&#39;};  # Turn off &#39;CHLD&#39; signal handler

      if &#40;defined $self-&gt;{&#39;redirect_stderr&#39;}&#41; {
        $self-&gt;dprt&#40;&#34;STDERR -&gt; $self-&gt;{&#39;redirect_stderr&#39;}&#34;&#41;;
        open&#40;STDERR, &#34;&gt;$self-&gt;{&#39;redirect_stderr&#39;}&#34;&#41; ;
        autoflush STDERR 1 ;
      }

      if &#40;defined $self-&gt;{&#39;redirect_stdout&#39;}&#41; {
        $self-&gt;dprt&#40;&#34;STDOUT -&gt; $self-&gt;{&#39;redirect_stdout&#39;}&#34;&#41;;
        open&#40;STDOUT, &#34;&gt;$self-&gt;{&#39;redirect_stdout&#39;}&#34;&#41; ;
        autoflush STDOUT 1 ;
      }

      if&#40;ref&#40;$func&#41; eq &#34;CODE&#34;&#41; {
        $func-&gt;&#40;@params&#41;; exit 0;            # Start perl subroutine
      } else {
          exec $func, @params;       # Start shell process
          exit 0;                    # In case something goes wrong
      }
  } elsif&#40;$self-&gt;{&#39;pid&#39;} &gt; 0&#41; {      # Parent:
      $INTERVAL{$self-&gt;{&#39;pid&#39;}}{&#39;t0&#39;} = time&#40;&#41;;
      $self-&gt;dprt&#40;&#34;START&#40;$self-&gt;{&#39;pid&#39;}&#41;&#34;&#41;;
      # Register PID
      $EXIT_STATUS{$self-&gt;{&#39;pid&#39;}} = undef;
      $INTERVAL{$self-&gt;{&#39;pid&#39;}}{&#39;t1&#39;} = undef;
      return 1;                      #   return OK
  } else {      
      return 0;                      #   this shouldn&#39;t occur
  }
}


&lt;/PRE&gt;
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
