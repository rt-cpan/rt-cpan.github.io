<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #100458 for Devel-MAT: Test suite fails with perl 5.21.4 and newer</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #100458 for Devel-MAT: Test suite fails with perl 5.21.4 and newer</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Devel-MAT">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Devel-MAT">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Devel-MAT">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Devel-MAT">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Devel-MAT">Devel-MAT CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">100458</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Devel-MAT">Devel-MAT</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
SREZIC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-251196-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.18</li>
<li>
0.19</li>
</ul>
    </td>
  </tr>
  <tr id="CF-251197-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.21    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=100458">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1434919" href="/Public/Bug/Display.html?id=100458#txn-1434919">#</a>      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;19&nbsp;16:49:24&nbsp;2014</span>
    <span class="description">SREZIC [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Test suite fails with perl 5.21.4 and newer</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1434919/762761/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/762761">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 101b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Probably you&#39;re aware of it, but anyway ... see <span class="clickylink"><a target="new" rel="nofollow" href="http://matrix.cpantesters.org/?dist=Devel-MAT%200.19">http://matrix.cpantesters.org/?dist=Devel-MAT%200.19</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1434925" href="/Public/Bug/Display.html?id=100458#txn-1434925">#</a>      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;19&nbsp;17:01:57&nbsp;2014</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1434925/762766/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/762766">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 420b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Nov 19 16:49:24 2014, SREZIC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Probably you&#39;re aware of it, but anyway ... see
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://matrix.cpantesters.org/?dist=Devel-MAT%200.19">http://matrix.cpantesters.org/?dist=Devel-MAT%200.19</a></span>
</div>
Ooh, I wasn&#39;t previously aware of that, no

  Can&#39;t locate object method &#34;stashname&#34; via package &#34;Devel::MAT::SV::REF&#34; at /tmp/loop_over_bdir-31439-uGCLvY/Devel-MAT-0.19-PN4jCm/blib/lib/Devel/MAT/SV.pm line 1394.

Well that looks excitingly nontrivial :&#40;

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1434926" href="/Public/Bug/Display.html?id=100458#txn-1434926">#</a>      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;19&nbsp;17:01:58&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1435022" href="/Public/Bug/Display.html?id=100458#txn-1435022">#</a>      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;19&nbsp;21:04:08&nbsp;2014</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1435022/762826/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/762826">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 670b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Nov 19 17:01:57 2014, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Nov 19 16:49:24 2014, SREZIC wrote:
<div class="message-stanza open">&gt; &gt; Probably you&#39;re aware of it, but anyway ... see
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://matrix.cpantesters.org/?dist=Devel-MAT%200.19">http://matrix.cpantesters.org/?dist=Devel-MAT%200.19</a></span>
</div>&gt; 
&gt; Ooh, I wasn&#39;t previously aware of that, no
&gt; 
&gt; Can&#39;t locate object method &#34;stashname&#34; via package
&gt; &#34;Devel::MAT::SV::REF&#34; at /tmp/loop_over_bdir-31439-uGCLvY/Devel-MAT-
&gt; 0.19-PN4jCm/blib/lib/Devel/MAT/SV.pm line 1394.
&gt; 
&gt; Well that looks excitingly nontrivial :&#40;
</div>
Just guessing based on the class name, I suspect it was the change that made ‘sub foo{}’ store a sub ref in the stash that broke this.  So it’s probably actually unexcitingly trivial to fix. :-&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1436578" href="/Public/Bug/Display.html?id=100458#txn-1436578">#</a>      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;25&nbsp;14:48:30&nbsp;2014</span>
    <span class="description">ANDK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1436578/763694/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/763694">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 143b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">v5.21.3-654-ga65cc14 is the commit where bisect stops. The relevant bleadperl ticket was <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/rt3/Ticket/Display.html?id=122857">https://rt.perl.org/rt3/Ticket/Display.html?id=122857</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1438998" href="/Public/Bug/Display.html?id=100458#txn-1438998">#</a>      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;04&nbsp;11:38:11&nbsp;2014</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1438998/764973/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/764973">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 922b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Nov 25 14:48:30 2014, ANDK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; v5.21.3-654-ga65cc14 is the commit where bisect stops. The relevant
&gt; bleadperl ticket was
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/rt3/Ticket/Display.html?id=122857">https://rt.perl.org/rt3/Ticket/Display.html?id=122857</a></span>
</div>
commitdiff is:

<span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/commitdiff/a65cc14?hp=230b3caa7e7f84ecf3fa68999603884d4b196166">http://perl5.git.perl.org/perl.git/commitdiff/a65cc14?hp=230b3caa7e7f84ecf3fa68999603884d4b196166</a></span>

I can&#39;t immediately see from that what the issue should be and how to fix it. I suspect this commit isn&#39;t the actual change, but one related to it.

The code that this error in invoking is:

.... package Devel::MAT::SV::CODE;
1390 sub name
1391 {
1392    my $self = shift;
1393    return unless my $glob_at = $self-&gt;glob_at;
1394    return &#39;&#38;&#39; . $self-&gt;df-&gt;sv_at&#40; $glob_at &#41;-&gt;stashname;
1395 }

Failing to call -&gt;stashname on an SV::REF suggests that the SV it finds in the CvGV slot isn&#39;t, in fact, a GV after all, but an SV with SvROK.

Am currently in the process of &#39;perlbrew&#39;ing myself a 5.21.4

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1439008" href="/Public/Bug/Display.html?id=100458#txn-1439008">#</a>      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;04&nbsp;12:08:04&nbsp;2014</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1439008/764983/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/764983">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 460b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The code in the failing test starts off

 14 sub inner {
 15    Devel::MAT::Dumper::dump&#40; $DUMPFILE &#41;            # l0 + 1 
 16 }

Then later on tries to inspect this CV.

Inspecting this in the GTK explorer leads me to find that the CvGV slot of this CV seems to point directly at an SV with SvROK. The SvRV of that points directly back at this CV. I can&#39;t seem to find a GV itself that would hold the name of this sub.

What&#39;s going on there?

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1439013" href="/Public/Bug/Display.html?id=100458#txn-1439013">#</a>      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;04&nbsp;12:32:14&nbsp;2014</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1439013/764985/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/764985">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 373b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">It would appear the actual culprit is:

  <span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/commit/f9d9e965c">http://perl5.git.perl.org/perl.git/commit/f9d9e965c</a></span>

This patch claims that:

   • CvGV now reifies the GV if necessary.

but my observation here is that they aren&#39;t in the case of Devel::MAT. The relevant code in the Dumper is at

  <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/PEVANS/Devel-MAT-0.19/lib/Devel/MAT/Dumper.xs#L476">https://metacpan.org/source/PEVANS/Devel-MAT-0.19/lib/Devel/MAT/Dumper.xs#L476</a></span>

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1439267" href="/Public/Bug/Display.html?id=100458#txn-1439267">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;05&nbsp;09:28:54&nbsp;2014</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1439267/765090/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/765090">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Dec 04 12:32:14 2014, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It would appear the actual culprit is:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/commit/f9d9e965c">http://perl5.git.perl.org/perl.git/commit/f9d9e965c</a></span>
&gt; 
&gt; This patch claims that:
&gt; 
&gt; • CvGV now reifies the GV if necessary.
&gt; 
&gt; but my observation here is that they aren&#39;t in the case of Devel::MAT.
&gt; The relevant code in the Dumper is at
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/PEVANS/Devel-MAT-">https://metacpan.org/source/PEVANS/Devel-MAT-</a></span>
&gt; 0.19/lib/Devel/MAT/Dumper.xs#L476
</div>
On Thu Dec 04 12:08:04 2014, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Inspecting this in the GTK explorer leads me to find that the CvGV
&gt; slot of this CV seems to point directly at an SV with SvROK. The SvRV
&gt; of that points directly back at this CV. I can&#39;t seem to find a GV
&gt; itself that would hold the name of this sub.
&gt; 
&gt; What&#39;s going on there?
</div>
I think that by the time CvGV reifies the GV, you have already recorded the RV that you followed to get to it.  Since it is the RV itself that gets upgraded to a typeglob, referential identity results in a CvGV pointing to the RV.

So, either you can check, when you have a sub ref, whether CvGV&#40;SvRV&#40;ref&#41;&#41; modifies ref, before dumping it &#40;may be problematic if you have already processed a reference to that RV&#41;; or you could check !CvNAMED&#40;cv&#41; before processing CvGV, to avoid vivifying anything during the dump.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1549357" href="/Public/Bug/Display.html?id=100458#txn-1549357">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;29&nbsp;16:11:21&nbsp;2015</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1549357/827275/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/827275">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 05 09:28:54 2014, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think that by the time CvGV reifies the GV, you have already
&gt; recorded the RV that you followed to get to it.  Since it is the RV
&gt; itself that gets upgraded to a typeglob, referential identity results
&gt; in a CvGV pointing to the RV.
&gt; 
&gt; So, either you can check, when you have a sub ref, whether
&gt; CvGV&#40;SvRV&#40;ref&#41;&#41; modifies ref, before dumping it &#40;may be problematic if
&gt; you have already processed a reference to that RV&#41;; or you could check
&gt; !CvNAMED&#40;cv&#41; before processing CvGV, to avoid vivifying anything
&gt; during the dump.
</div>
So my code is now:

   if&#40;!CvNAMED&#40;cv&#41;&#41;
     write_svptr&#40;fh, &#40;SV*&#41;CvGV&#40;cv&#41;&#41;;
   else
     write_svptr&#40;fh, NULL&#41;;

And unfortunately I&#39;m still getting CV &#34;glob&#34; slots that claim to point directly to REFs. This is the only occurrence of CvGV in the code.

More specifically, throughout the entire memory dump, the only two CVs I can find with these odd glob slots are normal named functions defined in the main script; every single function that appears in the symbol table from other files has a proper GV.

This is even true of nontrivially-small programs - if I load half of IO::Async, for example, then again every single CV in the IO::Async:: and below namespace appears to have a real GV in its CvGV slot; not a single function is found without one.

In case it is of interest, the program that can create these odd CVs is

  <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/PEVANS/Devel-MAT-0.20/t/02contexts.t">https://metacpan.org/source/PEVANS/Devel-MAT-0.20/t/02contexts.t</a></span>

What is notable about those functions is that both of them are &#34;live&#34; on the callstack at the time the heap is dumped; though the same can also be said for the &#40;XS&#41; heap dumping function itself; and that retains a perfectly normal GV in this file.

I remain confused.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1552855" href="/Public/Bug/Display.html?id=100458#txn-1552855">#</a>      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;04&nbsp;11:39:21&nbsp;2015</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1552855/828973/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/828973">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 47b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think this one is fixed now.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1552857" href="/Public/Bug/Display.html?id=100458#txn-1552857">#</a>      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;04&nbsp;11:39:27&nbsp;2015</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1552859" href="/Public/Bug/Display.html?id=100458#txn-1552859">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;04&nbsp;11:39:33&nbsp;2015</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Fixed in 0.21 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.577607</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
