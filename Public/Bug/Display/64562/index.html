<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #64562 for Net-DNS: Problem about TSIG in Net::DNS</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #64562 for Net-DNS: Problem about TSIG in Net::DNS</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-DNS/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-DNS">Net-DNS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">64562</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-DNS/Active/">Net-DNS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
yingdi [...] cs.ucla.edu

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-22454-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.66    </td>
  </tr>
  <tr id="CF-22455-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




Kyingdi-brown.+157+53254.key<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/878327/454913/Kyingdi-brown.%2B157%2B53254.key">
Thu Jan 06 21:43:03 2011 (56b) by yingdi [...] cs.ucla.edu
</a>
</font></li>
</ul>


tsig.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/878327/454912/tsig.pl">
Thu Jan 06 21:43:03 2011 (888b) by yingdi [...] cs.ucla.edu
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;06&nbsp;21:43:02&nbsp;2011</span>
    <span class="description">yingdi [...] cs.ucla.edu -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Problem about TSIG in Net::DNS</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dear Sir or Madam,

I have a simple perl program that uses Net::DNS to create packets and sign them with a TSIG key.  When I send these packets to a DNS server that I have been using for several years, the server reports that the signatures are invalid.  However, when I use dig -k &lt;key&gt; they work fine.  
As you can see from the attached code, I am using an option code in the OPT record, and I don&#39;t 
know if this has something to do with the problem.  Can you please see if you have the same 
problem with this code, or see if there is a programming mistake I have made? My Perl version is 
5.8.9, and my OS is Mac OS X 10.6.4. Thanks a lot!

Regards!

Yingdi
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> tsig.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use Net::DNS;
use Net::IP;

#Set DNS server to query
$res = Net::DNS::Resolver-&gt;new&#40;&#41;;
$res-&gt;nameservers&#40;&#34;jupiter.cs.brown.edu&#34;&#41;;
$res-&gt;port&#40;7979&#41;;

#Set key for TSIG
$key_name = &#34;yingdi-brown&#34;;
$key = &#34;8bz86RaXjzxHioN3fKruQg==&#34;;

#Generate TSIG
$tsig = Net::DNS::RR-&gt;new&#40;&#34;$key_name TSIG $key&#34;&#41;;
$tsig-&gt;fudge&#40;300&#41;;

#Generate a Query
$query = Net::DNS::Packet-&gt;new&#40;&#34;www.sjtu.edu.cn&#34;&#41;;

#Generate OPT
@iplist = qw&#40;202 120 2 101&#41;;
my $opt = Net::DNS::RR-&gt;new&#40;
        name =&gt; &#34;&#34;,
        type =&gt; &#34;OPT&#34;,
	class =&gt; 1024,
        extendedrcode =&gt; 0x00,
        ednsflags =&gt; 0x0000,
        optioncode =&gt; 0x51,
        optiondata =&gt; pack&#40;&#34;C4&#34;, @iplist&#41; 
&#41;;

#Push OPT into Query
$query-&gt;push&#40;additional =&gt; $opt&#41;;

#Sign Query
$query-&gt;sign_tsig&#40;$tsig&#41;;

$query-&gt;print;

#Send Query
$response = $res-&gt;send&#40;$query&#41;;

if&#40;$response&#41;{
	foreach $_ &#40;$response-&gt;answer&#41;{
		print $_-&gt;rdatastr.&#34;\n&#34;;
	}
}
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Kyingdi-brown.+157+53254.key</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/878327/454913/Kyingdi-brown.%2B157%2B53254.key">Download Kyingdi-brown.+157+53254.key</a><br />
<span class="downloadcontenttype">application/x-iwork-keynote-sffkey 56b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;07&nbsp;08:43:27&nbsp;2011</span>
    <span class="description">willem [...] plutointernet.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dear Yingdi,

Although I couldn&#39;t connect to port 7979 of jupiter.cs.brown.edu from my
site, I managed to reproduce your problem with some nameservers of our own.

In RR/TSIG.pm on line 142:

    shift&#40;@{$newpacket-&gt;{&#34;additional&#34;}}&#41;;

ehe first addition to the additional section is removed, in the hope
that this will be the TSIG record. The TSIG record is in fact the last
added record to the additional section, so it should be removed with pop:

    pop&#40;@{$newpacket-&gt;{&#34;additional&#34;}}&#41;;

When line 142 in RR/TSIG.pm was changed in this manner everything worked
out fine.
The fix will be Incorporated in the next release.

Cheers, Willem

On Thu Jan 06 21:43:02 2011, yuyingdi wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dear Sir or Madam,
&gt; 
&gt; I have a simple perl program that uses Net::DNS to create packets and
&gt;    sign them with a TSIG key.  When I send these packets to a DNS
&gt;    server that I have been using for several years, the server reports
&gt;    that the signatures are invalid.  However, when I use dig -k &lt;key&gt;
&gt;    they work fine.
&gt; As you can see from the attached code, I am using an option code in
&gt;    the OPT record, and I don&#39;t
&gt; know if this has something to do with the problem.  Can you please see
&gt;    if you have the same
&gt; problem with this code, or see if there is a programming mistake I
&gt;    have made? My Perl version is
&gt; 5.8.9, and my OS is Mac OS X 10.6.4. Thanks a lot!
&gt; 
&gt; Regards!
&gt; 
&gt; Yingdi
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;07&nbsp;08:43:27&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;10&nbsp;07:55:59&nbsp;2011</span>
    <span class="description">willem [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Yiyingdi,

Even better would be to replace line 141 and 142 of RR/TSIG.pl from:

    @{$newpacket-&gt;{&#34;additional&#34;}} = @{$packet-&gt;{&#34;additional&#34;}};
    shift&#40;@{$newpacket-&gt;{&#34;additional&#34;}}&#41;;

into:

    @{$newpacket-&gt;{&#34;additional&#34;}} =
        grep { $_ != $self } @{$packet-&gt;{&#34;additional&#34;}};

This would reflect more clearly what the intention of the code is.
Remove TSIG key to replace it with the signature of the whole packet
&#40;but without the TSIG key, which is secret after all&#41;.

As a side effect it becomes possible to call sign_tsig even before
further packet modifications, as the packet data is only signed just
before it is send out.

Best regards, Willem
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;17&nbsp;08:08:30&nbsp;2011</span>
    <span class="description">willem [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
