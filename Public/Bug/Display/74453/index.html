<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #74453 for Variable-Magic: &#39;store&#39; callback for hashes called when reading values</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #74453 for Variable-Magic: &#39;store&#39; callback for hashes called when reading values</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Variable-Magic">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Variable-Magic">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Variable-Magic">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Variable-Magic">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Variable-Magic">Variable-Magic CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">74453</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Variable-Magic">Variable-Magic</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
pshangov [...] yahoo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-44686-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-44687-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




op_info_hslice.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1029657/537058/op_info_hslice.pl">
Sun Jan 29 10:13:38 2012 (640b) by vpit [...] cpan.org
</a>
</font></li>
</ul>


op_info_hslice.pl.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1030770/537660/op_info_hslice.pl.txt">
Tue Jan 31 10:55:50 2012 (1009b) by pshangov [...] yahoo.com
</a>
</font></li>
</ul>


test.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1028711/536707/test.pl">
Fri Jan 27 12:25:09 2012 (309b) by pshangov [...] yahoo.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=74453">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1028711" href="/Public/Bug/Display.html?id=74453#txn-1028711">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;27&nbsp;12:25:09&nbsp;2012</span>
    <span class="description">pshangov [...] yahoo.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> &#39;store&#39; callback for hashes called when reading values</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1028711/536706/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/536706">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 439b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">When trying to implement a read-only hash with Variable::Magic, I have 
noticed that the &#39;store&#39; callback gets invoked when using an array slice 
of the hash, or when iterating over an array reference contained within 
the hash &#40;see the attached test.pl&#41;. I presume this is due to some 
internal state of the variable changing, but it is possible to distinguish 
between such changes and actual attempts to change the value of a hash 
key?
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1028711/536707/test.pl">Download test.pl</a><br />
<span class="downloadcontenttype">text/x-perl 309b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use 5.010;
use strict;
use warnings;
use Variable::Magic qw&#40;wizard cast&#41;;

my $wizard = wizard&#40; store =&gt; sub { warn &#34;Kaboom! [$_[2]]&#34; } &#41;;
my %hash = &#40; foo =&gt; &#39;bar&#39;, baz =&gt; [qw&#40;qux quux&#41;] &#41;;
cast&#40; %hash, $wizard &#41;;

say $_ for @hash{qw&#40;foo baz&#41;}; # Kaboom!
say $_ for @{$hash{baz}};      # Kaboom!
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1029657" href="/Public/Bug/Display.html?id=74453#txn-1029657">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;29&nbsp;10:13:38&nbsp;2012</span>
    <span class="description">vpit [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1029657/537057/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/537057">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Le Ven 27 Jan 2012 12:25:09, pshangov a écrit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; When trying to implement a read-only hash with Variable::Magic, I have 
&gt; noticed that the &#39;store&#39; callback gets invoked when using an array slice 
&gt; of the hash, or when iterating over an array reference contained within 
&gt; the hash &#40;see the attached test.pl&#41;. I presume this is due to some 
&gt; internal state of the variable changing, but it is possible to
</div>distinguish 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; between such changes and actual attempts to change the value of a hash 
&gt; key?
</div>
The hash slice is causing a &#39;store&#39; magic call because &#34;for&#34; aliases $_
to the elements of the list, and $_ can possibly be assigned to in the
body of the loop. This is the same mechanism that causes &#34;1 for
$hash{nonexistent_key}&#34; to vivify : perl cannot know at compile time
whether the hash slot will actually be need, so in doubt it creates the
entry at the beginning of the loop. In that regard, it is &#34;correct&#34; for
Variable::Magic to call the magic callback for this construct &#40;in that
it is as correct as perl itself&#41;.

If you want to recognize those constructs, you can use the &#39;op_info&#39;
feature :

    use 5.010;
    use strict;
    use warnings;
    use Variable::Magic qw&lt;wizard cast VMG_OP_INFO_OBJECT&gt;;
    use Carp &#39;carp&#39;;

    my $wizard = wizard&#40;
     store   =&gt; sub {
      my $op    = $_[-1];
      my $name  = $op-&gt;name;
      my $flags = $op-&gt;flags;
      my $priv  = $op-&gt;private;
      if &#40;$name eq &#39;hslice&#39; and $flags &#38; 16 and $flags &#38; 128 and not
$priv&#41; {
       carp&#40;&#34;store &#39;$_[2]&#39;&#34;&#41;;
      }
     },
     op_info =&gt; VMG_OP_INFO_OBJECT,
    &#41;;
    my %hash = &#40;baz =&gt; [ qw&lt;qux quux&gt; ]&#41;;
    cast %hash, $wizard;

    @hash{qw&lt;foo&gt;} = &#39;bar&#39;; # store
    {
     my @wut = local @hash{qw&lt;foo bar&gt;}; # nothing
    }
    say for @hash{qw&lt;foo baz&gt;}; # nothing
    say for @{$hash{baz}};      # nothing


Vincent.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> op_info_hslice.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1029657/537058/op_info_hslice.pl">Download op_info_hslice.pl</a><br />
<span class="downloadcontenttype">text/x-perl 640b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use 5.010;
use strict;
use warnings;
use Variable::Magic qw&lt;wizard cast VMG_OP_INFO_OBJECT&gt;;
use Carp &#39;carp&#39;;

my $wizard = wizard&#40;
 store   =&gt; sub {
  my $op    = $_[-1];
  my $name  = $op-&gt;name;
  my $flags = $op-&gt;flags;
  my $priv  = $op-&gt;private;
  if &#40;$name eq &#39;hslice&#39; and $flags &#38; 16 and $flags &#38; 128 and not $priv&#41; {
   carp&#40;&#34;store &#39;$_[2]&#39;&#34;&#41;;
  }
 },
 op_info =&gt; VMG_OP_INFO_OBJECT,
&#41;;
my %hash = &#40;baz =&gt; [ qw&lt;qux quux&gt; ]&#41;;
cast %hash, $wizard;

@hash{qw&lt;foo&gt;} = &#39;bar&#39;; # store
{
 my @wut = local @hash{qw&lt;foo bar&gt;}; # nothing
}
say for @hash{qw&lt;foo baz&gt;}; # nothing
say for @{$hash{baz}};      # nothing
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1029659" href="/Public/Bug/Display.html?id=74453#txn-1029659">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;29&nbsp;10:13:38&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1030770" href="/Public/Bug/Display.html?id=74453#txn-1030770">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;31&nbsp;10:55:49&nbsp;2012</span>
    <span class="description">pshangov [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1030770/537659/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/537659">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 475b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the exhaustive reply. Unfortunately I will have to ask 
another question demonstrating my ignorance with regard to perl&#39;s 
internals, but I&#39;ve found the docs for B::OP discouraging.

Hash::Util::lock_hash&#40;&#41;, which I assume is built on the same type of 
magic, seems to be able to distinguish between:

    1 for @hash{qw&lt;foo baz&gt;}; # lives

and

    $_ = 1 for @hash{qw&lt;foo baz&gt;}; # dies

Is this possible to implement with Variable::Magic too?

Thanks,


--Peter
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> op_info_hslice.pl.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1030770/537660/op_info_hslice.pl.txt">Download op_info_hslice.pl.txt</a><br />
<span class="downloadcontenttype">text/plain 1009b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use 5.010;
use strict;
use warnings;
use Variable::Magic qw&lt;wizard cast VMG_OP_INFO_OBJECT&gt;;
use Hash::Util qw&#40;lock_hash&#41;;
use Carp &#39;croak&#39;;

my $wizard = wizard &#40;
    store =&gt; sub {
        my $op    = $_[-1];
        my $name  = $op-&gt;name;
        my $flags = $op-&gt;flags;
        my $priv  = $op-&gt;private;

        if &#40;$name eq &#39;hslice&#39; and $flags &#38; 16 and $flags &#38; 128 and not $priv&#41; {
            croak&#40;&#34;store &#39;$_[2]&#39;&#34;&#41;;
        }
    },
    op_info =&gt; VMG_OP_INFO_OBJECT,
&#41;;

my %magic_hash = my %locked_hash = &#40; foo =&gt; &#39;bar&#39;, baz =&gt; [ qw&lt;qux quux&gt; ] &#41;;
lock_hash %locked_hash;
cast %magic_hash, $wizard;

1 for @{$magic_hash{baz}};           # lives
$_ = 1 for @{$magic_hash{baz}};      # lives
1 for @magic_hash{qw&lt;foo baz&gt;};      # lives
$_ = 1 for @magic_hash{qw&lt;foo baz&gt;}; # lives

1 for @{$locked_hash{baz}};           # lives
$_ = 1 for @{$locked_hash{baz}};      # lives
1 for @locked_hash{qw&lt;foo baz&gt;};      # lives
$_ = 1 for @locked_hash{qw&lt;foo baz&gt;}; # DIES
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1030804" href="/Public/Bug/Display.html?id=74453#txn-1030804">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;31&nbsp;12:13:57&nbsp;2012</span>
    <span class="description">vpit [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #74453] &#39;store&#39; callback for hashes called when reading values</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 31 Jan 2012 18:13:43 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Variable-Magic [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Vincent Pit &lt;perl [...] profvince.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1030804/537680/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/537680">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 31/01/2012 16:55, Peter Shangov via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hash::Util::lock_hash&#40;&#41;, which I assume is built on the same type of
&gt; magic, seems to be able to distinguish between:
&gt;
&gt;      1 for @hash{qw&lt;foo baz&gt;}; # lives
&gt;
&gt; and
&gt;
&gt;      $_ = 1 for @hash{qw&lt;foo baz&gt;}; # dies
&gt;
&gt; Is this possible to implement with Variable::Magic too?
&gt;
&gt; Thanks,
</div>
Hash::Util::lock_hash&#40;&#41; does not work that way, and does not give 
special treatment to the aliasing behaviour of &#34;for&#34;. It just makes the 
hash and all its values read-only. As you would have seen if you had put 
the &#34;$_ = 1&#34; assignment on its own line,

     use Hash::Util &#39;lock_hash&#39;;
     my %hash = &#40;a =&gt; 1, b =&gt; 2&#41;;
     lock_hash&#40;%hash&#41;;
     for &#40;@hash{qw&lt;a b&gt;}&#41; {
      $_ = 3;
     }

dies on line 5, which is the line of the assignment, and this happens 
because $_ &#40;which aliases a value of the hash&#41; is read-only.

In the end, I am not sure what you want to achieve. If you want to 
distinguish between a &#34;true&#34; hash slice assignment and the lvalue 
context induced by iterating over the values of the slice, I have 
described a way to do this in my previous message, yet I strongly advise 
you against using it as I think it is a bad design decision. perl 
evaluates the list onto which a loop iterates in lvalue context for a 
good reason.


Vincent.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1030820" href="/Public/Bug/Display.html?id=74453#txn-1030820">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;31&nbsp;13:04:42&nbsp;2012</span>
    <span class="description">pshangov [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1030820/537694/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/537694">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 484b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the explanation. 

I needed this for MooseX::Params, a module that provides subroutine 
signatures via attributes, and then makes the arguments available in a 
magic read-only hash %_. I wanted to allow users to write this:

  sub doit :Args&#40;ArrayRef foo&#41; {
    say for @{$_{foo}};
  }

While still preventing 

  sub doit :Args&#40;ArrayRef foo&#41; {
    $_ = ... for @{$_{foo}};
  }

I think I will just update the docs explaining why neither is allowed.

Thanks again,

--Peter
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1030823" href="/Public/Bug/Display.html?id=74453#txn-1030823">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;31&nbsp;13:18:07&nbsp;2012</span>
    <span class="description">vpit [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #74453] &#39;store&#39; callback for hashes called when reading values</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 31 Jan 2012 19:17:55 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Variable-Magic [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Vincent Pit &lt;perl [...] profvince.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1030823/537696/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/537696">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 31/01/2012 19:04, Peter Shangov via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         Queue: Variable-Magic
&gt;   Ticket&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=74453">https://rt.cpan.org/Ticket/Display.html?id=74453</a></span>&gt;
&gt;
&gt; Thanks for the explanation.
&gt;
&gt; I needed this for MooseX::Params, a module that provides subroutine
&gt; signatures via attributes, and then makes the arguments available in a
&gt; magic read-only hash %_. I wanted to allow users to write this:
&gt;
&gt;    sub doit :Args&#40;ArrayRef foo&#41; {
&gt;      say for @{$_{foo}};
&gt;    }
&gt;
&gt; While still preventing
&gt;
&gt;    sub doit :Args&#40;ArrayRef foo&#41; {
&gt;      $_ = ... for @{$_{foo}};
&gt;    }
&gt;
&gt; I think I will just update the docs explaining why neither is allowed.
&gt;
&gt; Thanks again,
&gt;
&gt; --Peter
&gt;
</div>
If you want to prevent your users from modifying the values of your %_ 
hash, then this is a completely different matter : you just have to make 
it read-only. For example, you can put Readonly objects in %_, or 
recursively turn on the READONLY flag on its values &#40;with the 
Internals::SvREADONLY core function&#41;. The &#39;store&#39; magical callback is 
not suitable for this.


Vincent.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1035331" href="/Public/Bug/Display.html?id=74453#txn-1035331">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;10&nbsp;05:37:08&nbsp;2012</span>
    <span class="description">vpit [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1035332" href="/Public/Bug/Display.html?id=74453#txn-1035332">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;10&nbsp;05:37:08&nbsp;2012</span>
    <span class="description">vpit [...] cpan.org -  Severity Normal deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1035333" href="/Public/Bug/Display.html?id=74453#txn-1035333">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;10&nbsp;05:37:08&nbsp;2012</span>
    <span class="description">vpit [...] cpan.org -  Broken in 0.47 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.632151</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
