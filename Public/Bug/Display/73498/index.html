<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #73498 for IO-Async-Loop-Epoll: libio-async-loop-epoll-perl: FTBFS: Failed 1/8 test programs. 1/86 subtests failed.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #73498 for IO-Async-Loop-Epoll: libio-async-loop-epoll-perl: FTBFS: Failed 1/8 test programs. 1/86 subtests failed.</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/IO-Async-Loop-Epoll/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/IO-Async-Loop-Epoll/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/IO-Async-Loop-Epoll/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/IO-Async-Loop-Epoll/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IO-Async-Loop-Epoll">IO-Async-Loop-Epoll CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">73498</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/IO-Async-Loop-Epoll/Active/">IO-Async-Loop-Epoll</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
carnil [...] debian.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-225708-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-225709-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.12    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




0001-TODO-tests-to-detect-loop_once-returning-too-soon.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1057278/553155/0001-TODO-tests-to-detect-loop_once-returning-too-soon.patch">
Sun Apr 01 08:30:13 2012 (2.6k) by ntyni [...] iki.fi
</a>
</font></li>
</ul>


0002-Fix-loop_once-returning-too-soon.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1057278/553154/0002-Fix-loop_once-returning-too-soon.patch">
Sun Apr 01 08:30:13 2012 (1.8k) by ntyni [...] iki.fi
</a>
</font></li>
</ul>


libio-async-loop-epoll-perl_0.11-1-amd64-20111230-0731.gz<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1016491/529942/libio-async-loop-epoll-perl_0.11-1-amd64-20111230-0731.gz">
Fri Dec 30 02:45:09 2011 (4.5k) by CARNIL [...] cpan.org
</a>
</font></li>
</ul>


signature.asc<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1016491/529943/signature.asc">
Fri Dec 30 02:45:09 2011 (836b) by CARNIL [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;27&nbsp;09:26:23&nbsp;2011</span>
    <span class="description">CARNIL [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> CARNIL [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> libio-async-loop-epoll-perl: FTBFS: Failed 1/8 test programs.
 1/86 subtests failed.</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Paul

This bug has been forwarded from <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/646649">http://bugs.debian.org/646649</a></span>

I can reproduce the issue, but cannot find a hint why it is failing. I
see that are too one cpan tester failing with the same test failing [1],
but there additional one further test.

 [1] <span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/6f60c70c-2bd0-11e1-be17-7e2249abe0af">http://www.cpantesters.org/cpan/report/6f60c70c-2bd0-11e1-be17-7e2249abe0af</a></span>

Source: libio-async-loop-epoll-perl
Version: 0.11-1
Severity: serious
Tags: wheezy sid
User: debian-qa@lists.debian.org
Usertags: qa-ftbfs-20111022 qa-ftbfs
Justification: FTBFS on amd64

Hi,

During a rebuild of all packages in sid, your package failed to build on
amd64.

Relevant part:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  debian/rules build
&gt; dh build
&gt;    dh_testdir
&gt;    dh_auto_configure
&gt; Creating new &#39;MYMETA.yml&#39; with configuration results
&gt; Creating new &#39;Build&#39; script for &#39;IO-Async-Loop-Epoll&#39; version &#39;0.11&#39;
&gt;    dh_auto_build
&gt; Building IO-Async-Loop-Epoll
&gt;    dh_auto_test
&gt; t/00use.t ........... ok
&gt; t/01loop-io.t ....... ok
&gt; 
&gt; #   Failed test &#39;Other timers still fire after self-cancelling one&#39;
&gt; #   at /usr/share/perl5/IO/Async/LoopTests.pm line 458.
&gt; #          got: undef
&gt; #     expected: &#39;1&#39;
&gt; # Looks like you failed 1 test of 15.
&gt; t/02loop-timer.t .... 
&gt; Dubious, test returned 1 &#40;wstat 256, 0x100&#41;
&gt; Failed 1/15 subtests 
&gt; t/03loop-signal.t ... ok
&gt; t/04loop-idle.t ..... ok
&gt; t/05loop-child.t .... ok
&gt; t/06loop-control.t .. ok
&gt; t/99pod.t ........... ok
&gt; 
&gt; Test Summary Report
&gt; -------------------
&gt; t/02loop-timer.t  &#40;Wstat: 256 Tests: 15 Failed: 1&#41;
&gt;   Failed test:  14
&gt;   Non-zero exit status: 1
&gt; Files=8, Tests=86, 11 wallclock secs &#40; 0.04 usr  0.01 sys +  0.51 cusr  0.10 csys =  0.66 CPU&#41;
&gt; Result: FAIL
&gt; Failed 1/8 test programs. 1/86 subtests failed.
&gt; dh_auto_test: perl Build test returned exit code 255
&gt; make: *** [build] Error 255
</div>
The full build log is available from:
   <span class="clickylink"><a target="new" rel="nofollow" href="http://people.debian.org/~lucas/logs/2011/10/22/libio-async-loop-epoll-perl_0.11-1_lsid64.buildlog">http://people.debian.org/~lucas/logs/2011/10/22/libio-async-loop-epoll-perl_0.11-1_lsid64.buildlog</a></span>

A list of current common problems and possible solutions is available at 
<span class="clickylink"><a target="new" rel="nofollow" href="http://wiki.debian.org/qa.debian.org/FTBFS">http://wiki.debian.org/qa.debian.org/FTBFS</a></span> . You&#39;re welcome to contribute!

About the archive rebuild: The rebuild was done on about 50 AMD64 nodes
of the Grid&#39;5000 platform, using a clean chroot.  Internet was not
accessible from the build systems.




Thanks in advance,
Salvatore Bonaccorso, Debian Perl Group
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;29&nbsp;19:15:32&nbsp;2011</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hmm..

Is this a reliably repeatable failure, or only intermittent?

Are you testing against latest release of IO::Async &#40;0.45&#41;?

Perhaps would it be possible to get an strace output from the end of
this test?

  strace -o foo.strace perl -Mblib t/02loop-timer.t

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;29&nbsp;19:15:33&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;02:45:09&nbsp;2011</span>
    <span class="description">CARNIL [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73498] libio-async-loop-epoll-perl: FTBFS: Failed 1/8 test programs. 1/86 subtests failed.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 30 Dec 2011 08:44:56 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Paul Evans via RT &lt;bug-IO-Async-Loop-Epoll [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Salvatore Bonaccorso &lt;carnil [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hey Paul

many thanks for your reply on this issue:

On Thu, Dec 29, 2011 at 07:15:32PM -0500, Paul Evans via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73498">https://rt.cpan.org/Ticket/Display.html?id=73498</a></span> &gt;
&gt; 
&gt; Hmm..
&gt; 
&gt; Is this a reliably repeatable failure, or only intermittent?
</div>
I tried to build 20 times in a row now. Out of the 20, 4 where
successful, the other failed. I cannot 100% reproduce thus.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Are you testing against latest release of IO::Async &#40;0.45&#41;?
</div>
Yes, it is the latest 0.45 available in Debian unstable. For reference
attached the build log of my latest attempt.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Perhaps would it be possible to get an strace output from the end of
&gt; this test?
&gt; 
&gt;   strace -o foo.strace perl -Mblib t/02loop-timer.t
</div>
~/libio-async-loop-epoll-perl-0.11# strace -o foo.strace perl -Mblib t/02loop-timer.t
1..15
ok 1 - magic constructor yields $loop
ok 2 - $loop has refcount 1
ok 3 - $loop has refcount 1 after enqueue_timer
ok 4 - loop_once&#40;5&#41; while waiting for timer took at least 1.5 seconds
ok 5 - loop_once&#40;5&#41; while waiting for timer took no more than 2.5 seconds
ok 6 - cancelled timer does not fire
ok 7 - $done still 0 so far
ok 8 - requeued timer of delay 2 took at least 1.5 seconds
ok 9 - requeued timer of delay 2 took no more than 2.5 seconds
ok 10 - $done is 2 after requeued timer
ok 11 - loop_once while waiting for negative interval timer took at least 0 seconds
ok 12 - loop_once while waiting for negative interval timer took no more than 0.1 seconds
ok 13 - Self-cancelling timer still fires
ok 14 - Other timers still fire after self-cancelling one
ok 15 - $loop has refcount 1 finally
~/libio-async-loop-epoll-perl-0.11# perl -Mblib t/02loop-timer.t
1..15
ok 1 - magic constructor yields $loop
ok 2 - $loop has refcount 1
ok 3 - $loop has refcount 1 after enqueue_timer
ok 4 - loop_once&#40;5&#41; while waiting for timer took at least 1.5 seconds
ok 5 - loop_once&#40;5&#41; while waiting for timer took no more than 2.5 seconds
ok 6 - cancelled timer does not fire
ok 7 - $done still 0 so far
ok 8 - requeued timer of delay 2 took at least 1.5 seconds
ok 9 - requeued timer of delay 2 took no more than 2.5 seconds
ok 10 - $done is 2 after requeued timer
ok 11 - loop_once while waiting for negative interval timer took at least 0 seconds
ok 12 - loop_once while waiting for negative interval timer took no more than 0.1 seconds
ok 13 - Self-cancelling timer still fires
not ok 14 - Other timers still fire after self-cancelling one
#   Failed test &#39;Other timers still fire after self-cancelling one&#39;
#   at /usr/share/perl5/IO/Async/LoopTests.pm line 458.
#          got: undef
#     expected: &#39;1&#39;
ok 15 - $loop has refcount 1 finally
# Looks like you failed 1 test of 15.

so it does not fail when run under strace and cannot give this further
information.

Please let me know if I can provide some more information.

Regards
Salvatore
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016491/529942/libio-async-loop-epoll-perl_0.11-1-amd64-20111230-0731.gz">Download libio-async-loop-epoll-perl_0.11-1-amd64-20111230-0731.gz</a><br />
<span class="downloadcontenttype">application/octet-stream 4.5k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016491/529943/signature.asc">Download signature.asc</a><br />
<span class="downloadcontenttype">application/pgp-signature 836b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;01&nbsp;08:30:13&nbsp;2012</span>
    <span class="description">ntyni [...] iki.fi -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ntyni [...] iki.fi</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 27 09:26:23 2011, CARNIL wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &gt; #   Failed test &#39;Other timers still fire after self-cancelling one&#39;
&gt; &gt; #   at /usr/share/perl5/IO/Async/LoopTests.pm line 458.
&gt; &gt; #          got: undef
&gt; &gt; #     expected: &#39;1&#39;
&gt; &gt; # Looks like you failed 1 test of 15.
&gt; &gt; t/02loop-timer.t ....
&gt; &gt; Dubious, test returned 1 &#40;wstat 256, 0x100&#41;
&gt; &gt; Failed 1/15 subtests
</div>
I see there are a dozen similar similar failures now on the CPAN tester
reports so it&#39;s not just us.

I looked into this, and the bug seems to be in timeouts rounding down
to the nearest full millisecond. See the commit messages of the attached
proposed patches. Hope they make the problem clear enough, let me know
if you need more information.

As the failures are easily reproducible for me, I can also easily
provide straces if you like. Just let me know &#40;but note that I&#39;m
currently not in the CC field of this ticket; feel free to add me though.&#41;

Many thanks for your work,
-- 
Niko Tyni &#40;Debian Perl Group&#41;
ntyni@debian.org
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0002-Fix-loop_once-returning-too-soon.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From eab695afa987bde81db22f0dc7f689677cef6794 Mon Sep 17 00:00:00 2001
From: Niko Tyni &lt;ntyni@debian.org&gt;
Date: Sun, 1 Apr 2012 15:16:04 +0300
Subject: [PATCH 2/2] Fix loop_once&#40;&#41; returning too soon

epoll_pwait&#40;&#41; uses an integer millisecond value for its timeout parameter,
so round up any fractional values. This avoids early returns during the
very last millisecond before the next scheduled event.

As detailed in the previous commit message, this should fix the
intermittent t/02loop-timer.t failures seen in [rt.cpan.org #73498].
---
 lib/IO/Async/Loop/Epoll.pm |    4 ++--
 t/07loop-once.t            |    2 --
 2 files changed, 2 insertions&#40;+&#41;, 4 deletions&#40;-&#41;

diff --git a/lib/IO/Async/Loop/Epoll.pm b/lib/IO/Async/Loop/Epoll.pm
index 9f577c3..abb818d 100644
--- a/lib/IO/Async/Loop/Epoll.pm
+++ b/lib/IO/Async/Loop/Epoll.pm
@@ -22,7 +22,7 @@ use IO::Epoll qw&#40;
    EPOLLIN EPOLLOUT EPOLLHUP EPOLLERR
 &#41;;
 
-use POSIX qw&#40; EINTR EPERM SIG_BLOCK SIG_UNBLOCK sigprocmask sigaction &#41;;
+use POSIX qw&#40; EINTR EPERM SIG_BLOCK SIG_UNBLOCK sigprocmask sigaction ceil &#41;;
 
 =head1 NAME
 
@@ -143,7 +143,7 @@ sub loop_once
 
    $self-&gt;_adjust_timeout&#40; \$timeout &#41;;
 
-   my $msec = defined $timeout ? $timeout * 1000 : -1;
+   my $msec = defined $timeout ? ceil&#40;$timeout * 1000&#41; : -1;
 
    my $ret = epoll_pwait&#40; $self-&gt;{epoll}, $self-&gt;{maxevents}, $msec, $self-&gt;{sigmask} &#41;;
 
diff --git a/t/07loop-once.t b/t/07loop-once.t
index 2cad2e3..5b46109 100644
--- a/t/07loop-once.t
+++ b/t/07loop-once.t
@@ -19,9 +19,7 @@ for my $delay &#40;@delays&#41; {
     $i++ while
         !$loop-&gt;loop_once&#40; 1 &#41;         # callback not triggered yet
         &#38;&#38; &#40;time&#40;&#41; - $starttime &lt; 1&#41;;  # guard against infinite loops
-    TODO: { local $::TODO = &#34;[rt.cpan.org #73498]&#34;;
     is &#40;$i, 1, &#34;Just one loop run is enough to wait $delay seconds&#34;&#41;;
-    }
     is &#40;$done, 1, &#34;Timer actually got triggered within one second&#34;&#41;;
 }
  
-- 
1.7.9.1

</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-TODO-tests-to-detect-loop_once-returning-too-soon.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 9a6a6e60897777a4c220890ba709eb5ea3572418 Mon Sep 17 00:00:00 2001
From: Niko Tyni &lt;ntyni@debian.org&gt;
Date: Sun, 1 Apr 2012 14:10:00 +0300
Subject: [PATCH 1/2] TODO tests to detect loop_once&#40;&#41; returning too soon

The intermittent t/02loop-timer.t failures seen in [rt.cpan.org #73498]
happen because epoll_pwait&#40;&#41; uses an integer millisecond value for its
timeout parameter, so fractional values will get rounded down. The
loop_once&#40;&#41; method of IO::Async::Loop::Epoll doesn&#39;t take this into
account, so the next scheduled callback may therefore well not get
triggered on just one loop_once&#40;&#41; call.

If control comes back to the calling code before the remaining millisecond
is spent, the next loop_once&#40;&#41; call will end up calling epoll_pwait&#40;&#41;
with a timeout of zero, which makes it return immediately. This may result
in a busy loop of several loop_once&#40;&#41; calls until the millisecond tick
actually happens.

Add &#40;hopefully&#41; more deterministic TODO tests to detect such
situations. As IO::Async::Loop will never sleep more than one second
&#40;$MAX_SIGWAIT_TIME&#41;, we test with a range of timeouts between one and
700 milliseconds that loop_once&#40;&#41; will only return when a callback has
actually been called.

The busy loop seems to be longer on the small timeouts - perhaps
epoll_pwait&#40;2&#41; uses a finer resolution for shorter timeouts than the
longer ones?
---
 MANIFEST        |    1 +
 t/07loop-once.t |   27 +++++++++++++++++++++++++++
 2 files changed, 28 insertions&#40;+&#41;, 0 deletions&#40;-&#41;
 create mode 100644 t/07loop-once.t

diff --git a/MANIFEST b/MANIFEST
index 0010c9e..fc55176 100644
--- a/MANIFEST
+++ b/MANIFEST
@@ -14,4 +14,5 @@ t/03loop-signal.t
 t/04loop-idle.t
 t/05loop-child.t
 t/06loop-control.t
+t/07loop-once.t
 t/99pod.t
diff --git a/t/07loop-once.t b/t/07loop-once.t
new file mode 100644
index 0000000..2cad2e3
--- /dev/null
+++ b/t/07loop-once.t
@@ -0,0 +1,27 @@
+#!/usr/bin/perl -w
+my @delays;
+
+BEGIN { @delays = &#40;.001, .005, .007, .01, .05, .07, .1, .5, .7&#41; }
+
+use strict;
+use Test::More tests =&gt; 2 * @delays;
+use Time::HiRes q/time/;
+
+use IO::Async::Loop::Epoll;
+my $loop = IO::Async::Loop::Epoll-&gt;new;
+
+for my $delay &#40;@delays&#41; {
+    my $done;
+    my $i = 1;
+    my $starttime = time&#40;&#41;;
+
+    $loop-&gt;enqueue_timer&#40; delay =&gt; $delay, code =&gt; sub { $done++ } &#41;;
+    $i++ while
+        !$loop-&gt;loop_once&#40; 1 &#41;         # callback not triggered yet
+        &#38;&#38; &#40;time&#40;&#41; - $starttime &lt; 1&#41;;  # guard against infinite loops
+    TODO: { local $::TODO = &#34;[rt.cpan.org #73498]&#34;;
+    is &#40;$i, 1, &#34;Just one loop run is enough to wait $delay seconds&#34;&#41;;
+    }
+    is &#40;$done, 1, &#34;Timer actually got triggered within one second&#34;&#41;;
+}
+ 
-- 
1.7.9.1

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;01&nbsp;09:02:39&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> ntyni [...] iki.fi</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Apr 01 08:30:13 2012, ntyni@iki.fi wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I looked into this, and the bug seems to be in timeouts rounding down
&gt; to the nearest full millisecond. See the commit messages of the attached
&gt; proposed patches. Hope they make the problem clear enough, let me know
&gt; if you need more information.
&gt; 
&gt; As the failures are easily reproducible for me, I can also easily
&gt; provide straces if you like. Just let me know &#40;but note that I&#39;m
&gt; currently not in the CC field of this ticket; feel free to add me
&gt; though.&#41;
</div>
Ahh yes, that sounds quite plausible. Hrm.. I&#39;ll have a go at popping
that in, with those expanded tests as well.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;04&nbsp;13:19:12&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Fixed in 0.12 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;04&nbsp;13:19:32&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Released as 0.12.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;04&nbsp;13:19:33&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
