<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #66768 for MP3-Tag: Broken temp file generation in MP3::Tag::ID3v2</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #66768 for MP3-Tag: Broken temp file generation in MP3::Tag::ID3v2</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/MP3-Tag/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/MP3-Tag/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/MP3-Tag/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/MP3-Tag/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/MP3-Tag">MP3-Tag CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">66768</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/MP3-Tag/Active/">MP3-Tag</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jagerman [...] jagerman.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21896-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21897-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;22&nbsp;01:16:23&nbsp;2011</span>
    <span class="description">jagerman [...] jagerman.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 22 Mar 2011 01:16:12 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MP3-Tag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Rhinelander &lt;jagerman [...] jagerman.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">MP3::Tag::ID3v2 uses an unsafe tempfile generation, which has the 
potential to corrupt files if multiple processes using MP3::Tag::ID3v2 
are operating on files in the same directory at the same time.  I ran 
into this, with a parallel-processing script, and it clobbered some of 
my MP3 files.

This is just a basic race condition: the file might exist between the 
time -e is called and the subsequent open&#40;&#41;.  Rather than trying to fix 
the tempfile name generation, it would be easier to simply use 
File::Temp, which is designed to do exactly this sort of thing safely.

The attached patch to ID3v2.pm fixes the problem by doing exactly that: 
it removes the current tempfile generation code, instead using 
File::Temp&#39;s tempfile&#40;&#41; to create the file, which should solve the problem.
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;22&nbsp;01:48:24&nbsp;2011</span>
    <span class="description">jagerman [...] jagerman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 22 Mar 2011 01:48:14 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MP3-Tag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Rhinelander &lt;jagerman [...] jagerman.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I just noticed my first patch was broken: it wasn&#39;t actually importing 
tempfile&#40;&#41; from File::Temp.  This one contains the import, and I&#39;ve 
tested that it actually works.

On 22-Mar-11 1:16 AM, Bugs in MP3-Tag via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; Greetings,
&gt;
&gt; This message has been automatically generated in response to the
&gt; creation of a trouble ticket regarding:
&gt;       &#34;Broken temp file generation in MP3::Tag::ID3v2&#34;,
&gt; a summary of which appears below.
&gt;
&gt; There is no need to reply to this message right now.  Your ticket has been
&gt; assigned an ID of [rt.cpan.org #66768].  Your ticket is accessible
&gt; on the web at:
&gt;
&gt;      <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66768">https://rt.cpan.org/Ticket/Display.html?id=66768</a></span>
&gt;
&gt; Please include the string:
&gt;
&gt;           [rt.cpan.org #66768]
&gt;
&gt; in the subject line of all future correspondence about this issue. To do so,
&gt; you may reply to this message.
&gt;
&gt;                          Thank you,
&gt;                          bug-MP3-Tag@rt.cpan.org
&gt;
&gt; -------------------------------------------------------------------------
&gt; MP3::Tag::ID3v2 uses an unsafe tempfile generation, which has the
&gt; potential to corrupt files if multiple processes using MP3::Tag::ID3v2
&gt; are operating on files in the same directory at the same time.  I ran
&gt; into this, with a parallel-processing script, and it clobbered some of
&gt; my MP3 files.
&gt;
&gt; This is just a basic race condition: the file might exist between the
&gt; time -e is called and the subsequent open&#40;&#41;.  Rather than trying to fix
&gt; the tempfile name generation, it would be easier to simply use
&gt; File::Temp, which is designed to do exactly this sort of thing safely.
&gt;
&gt; The attached patch to ID3v2.pm fixes the problem by doing exactly that:
&gt; it removes the current tempfile generation code, instead using
&gt; File::Temp&#39;s tempfile&#40;&#41; to create the file, which should solve the problem.
&gt;
</div></div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;22&nbsp;07:20:09&nbsp;2011</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 22 Mar 2011 04:19:56 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jason Rhinelander via RT &lt;bug-MP3-Tag [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Mar 22, 2011 at 01:48:25AM -0400, Jason Rhinelander via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: MP3-Tag
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66768">https://rt.cpan.org/Ticket/Display.html?id=66768</a></span> &gt;
&gt; 
&gt; I just noticed my first patch was broken: it wasn&#39;t actually importing 
&gt; tempfile&#40;&#41; from File::Temp.  This one contains the import, and I&#39;ve 
&gt; tested that it actually works.
</div>
I won&#39;t like to introduce an extra dependency to fix a rare race
condition.  &#40;Especially taking into account that `use File::Temp&#39;
pulls in 29 modules, including overload.pm!&#41;  If you are interested,
consider some more lightweight solution...

  Checking...  Well, it looks like File::Temp is included even in 5.6.1,
  so it won&#39;t be a problem if it were not so heavy-weight...

Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;22&nbsp;07:20:10&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;22&nbsp;11:22:38&nbsp;2011</span>
    <span class="description">jagerman [...] jagerman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 22 Mar 2011 11:22:22 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MP3-Tag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Rhinelander &lt;jagerman [...] jagerman.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It does have a few dependencies, but as you pointed out, it is a core 
module and so doesn&#39;t introduce any to MP3::Tag.

As an alternative, how would you feel about only loading File::Temp at 
run-time when a tempfile is needed?  That would, at least, mitigate the 
heaviness most of the time, when the tag can be updated in-place.  I&#39;ve 
attached a new patch &#40;ID3v2-runtime-file-temp.patch&#41; that works this way.

If you don&#39;t want to use File::Temp at all, you can reduce the 
likelihood of the problem occurring by basing the tempfile filename on 
the filename of the mp3, instead of just its dirname.  i.e. for 
/some/dir/foo.mp3 the tempfile could be named something like 
/some/dir/foo.mp3.TMP-0.tmp instead of /some/dir/TMPxx0.tmp.  That still 
has a potential race condition, but at least it would only apply when 
working on the same file, as opposed to just working on two different 
files in the same directory.  Even better still would be to use a random 
set of characters &#40;e.g. /some/dir/foo.mp3.xB5z.tmp&#41; instead of just an 
incremented number.  I&#39;ve attached a second patch 
&#40;ID3v2-no-file-temp.patch&#41; that does this instead of using File::Temp. 
It&#39;s not as safe as using File::Temp, but it should be much, much harder 
to trigger the race condition this way, and doesn&#39;t use any extra modules.

Jason

On 22-Mar-11 7:20 AM, Ilya Zakharevich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66768">https://rt.cpan.org/Ticket/Display.html?id=66768</a></span>&gt;
&gt;
&gt; On Tue, Mar 22, 2011 at 01:48:25AM -0400, Jason Rhinelander via RT wrote:
<div class="message-stanza open">&gt;&gt;         Queue: MP3-Tag
&gt;&gt;   Ticket&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66768">https://rt.cpan.org/Ticket/Display.html?id=66768</a></span>&gt;
&gt;&gt;
&gt;&gt; I just noticed my first patch was broken: it wasn&#39;t actually importing
&gt;&gt; tempfile&#40;&#41; from File::Temp.  This one contains the import, and I&#39;ve
&gt;&gt; tested that it actually works.
</div>&gt;
&gt; I won&#39;t like to introduce an extra dependency to fix a rare race
&gt; condition.  &#40;Especially taking into account that `use File::Temp&#39;
&gt; pulls in 29 modules, including overload.pm!&#41;  If you are interested,
&gt; consider some more lightweight solution...
&gt;
&gt;    Checking...  Well, it looks like File::Temp is included even in 5.6.1,
&gt;    so it won&#39;t be a problem if it were not so heavy-weight...
&gt;
&gt; Ilya
&gt;
</div></div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;22&nbsp;16:06:57&nbsp;2011</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 22 Mar 2011 13:06:47 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jason Rhinelander via RT &lt;bug-MP3-Tag [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Mar 22, 2011 at 11:22:39AM -0400, Jason Rhinelander via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If you don&#39;t want to use File::Temp at all, you can reduce the 
&gt; likelihood of the problem occurring by basing the tempfile filename on 
&gt; the filename of the mp3, instead of just its dirname.  i.e. for 
&gt; /some/dir/foo.mp3 the tempfile could be named something like 
&gt; /some/dir/foo.mp3.TMP-0.tmp instead of /some/dir/TMPxx0.tmp.
</div>
Won&#39;t work on some filesystems...  I&#39;m well aware of these race
conditions; just do not have tuits to find a proper solution...  &#40;The
best thing is to ask OS to open-only-if-not-exists.&#41;

Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;22&nbsp;22:11:50&nbsp;2011</span>
    <span class="description">jagerman [...] jagerman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 22 Mar 2011 22:11:41 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MP3-Tag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Rhinelander &lt;jagerman [...] jagerman.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 22-Mar-11 4:06 PM, Ilya Zakharevich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Won&#39;t work on some filesystems...  I&#39;m well aware of these race
&gt; conditions; just do not have tuits to find a proper solution...  &#40;The
&gt; best thing is to ask OS to open-only-if-not-exists.&#41;
</div>
That, of course, is exactly what File::Temp does, but it takes a fair 
chunk of code to get this right in a portable manner.  The proper 
solution here is to use File::Temp--trying to duplicate everything it 
does, especially in dealing with odd systems, hardly seems worth the 
effort and the added maintenance cost just to avoid depending on a 
*core* Perl module that, honestly, doesn&#39;t have all that many 
dependencies.  The -runtime patch I attached earlier won&#39;t even load 
File::Temp most of the time, avoiding any resource hit in the majority 
of cases &#40;it only gets loaded if MP3::Tag::ID3v2 needs to rewrite the 
entire file&#41;.  We&#39;re still talking a relatively small amount of system 
resources to load File::Temp and its dependencies, and it seems like 
reducing the loading to when we actually need it is worthwhile as it 
fixes a serious &#40;i.e. data loss&#41; problem in a known, correct, portable, 
tested way.

I really want to ask that you reconsider the -runtime patch I sent in my 
last e-mail.  Using File::Temp is the standard, accepted, core Perl way 
of avoiding exactly this problem, and if it&#39;s only loaded when rewriting 
an entire file &#40;on the order of a few MB in typical use cases&#41;, the 
overhead of File::Temp seems worthwhile to avoid data loss.

Jason
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;22&nbsp;22:51:44&nbsp;2011</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 22 Mar 2011 19:51:31 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jason Rhinelander via RT &lt;bug-MP3-Tag [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Mar 22, 2011 at 10:11:51PM -0400, Jason Rhinelander via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That, of course, is exactly what File::Temp does, but it takes a fair 
&gt; chunk of code to get this right in a portable manner.
</div>
I doubt it very much.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  The proper 
&gt; solution here is to use File::Temp--trying to duplicate everything it 
&gt; does, especially in dealing with odd systems, hardly seems worth the 
&gt; effort and the added maintenance cost just to avoid depending on a 
&gt; *core* Perl module that, honestly, doesn&#39;t have all that many 
&gt; dependencies.  The -runtime patch I attached earlier won&#39;t even load 
&gt; File::Temp most of the time, avoiding any resource hit in the majority 
&gt; of cases &#40;it only gets loaded if MP3::Tag::ID3v2 needs to rewrite the 
&gt; entire file&#41;.  We&#39;re still talking a relatively small amount of system 
&gt; resources to load File::Temp and its dependencies, and it seems like 
&gt; reducing the loading to when we actually need it is worthwhile as it 
&gt; fixes a serious &#40;i.e. data loss&#41; problem in a known, correct, portable, 
&gt; tested way.
</div>
Using a module which loads overload.pm to open a temporary file cannot
be &#34;the proper solution&#34;.

Yours,
Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;23&nbsp;00:19:17&nbsp;2011</span>
    <span class="description">jagerman [...] jagerman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 23 Mar 2011 00:19:09 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MP3-Tag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Rhinelander &lt;jagerman [...] jagerman.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 22-Mar-11 10:51 PM, Ilya Zakharevich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66768">https://rt.cpan.org/Ticket/Display.html?id=66768</a></span>&gt;
&gt;
&gt; On Tue, Mar 22, 2011 at 10:11:51PM -0400, Jason Rhinelander via RT wrote:
<div class="message-stanza open">&gt;&gt; That, of course, is exactly what File::Temp does, but it takes a fair
&gt;&gt; chunk of code to get this right in a portable manner.
</div>&gt;
&gt; I doubt it very much.
</div>
Look for yourself.  vim `perldoc -l File::Temp`

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt;   The proper
&gt;&gt; solution here is to use File::Temp--trying to duplicate everything it
&gt;&gt; does, especially in dealing with odd systems, hardly seems worth the
&gt;&gt; effort and the added maintenance cost just to avoid depending on a
&gt;&gt; *core* Perl module that, honestly, doesn&#39;t have all that many
&gt;&gt; dependencies.  The -runtime patch I attached earlier won&#39;t even load
&gt;&gt; File::Temp most of the time, avoiding any resource hit in the majority
&gt;&gt; of cases &#40;it only gets loaded if MP3::Tag::ID3v2 needs to rewrite the
&gt;&gt; entire file&#41;.  We&#39;re still talking a relatively small amount of system
&gt;&gt; resources to load File::Temp and its dependencies, and it seems like
&gt;&gt; reducing the loading to when we actually need it is worthwhile as it
&gt;&gt; fixes a serious &#40;i.e. data loss&#41; problem in a known, correct, portable,
&gt;&gt; tested way.
</div>&gt;
&gt; Using a module which loads overload.pm to open a temporary file cannot
&gt; be &#34;the proper solution&#34;.
</div>
Why not?

Jason
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;23&nbsp;00:34:51&nbsp;2011</span>
    <span class="description">jagerman [...] jagerman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 23 Mar 2011 00:34:42 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MP3-Tag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Rhinelander &lt;jagerman [...] jagerman.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 22-Mar-11 10:51 PM, Ilya Zakharevich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Using a module which loads overload.pm to open a temporary file cannot
&gt; be &#34;the proper solution&#34;.
</div>
I should also point out that the patch I provided doesn&#39;t use the 
object-oriented interface to File::Temp at all, and thus no use of 
overloading takes place.  But the above comment leads me to suspect that 
your objections at this point are religious rather than logical.  You 
have my patches, which you are free to ignore; I just hope that you 
include *some* sort of fix for this problem, even if the fix is 
duplicating half of File::Temp just to avoid allowing overload.pm to be 
loaded.

Yours,

Jason Rhinelander
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;23&nbsp;05:38:55&nbsp;2011</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 23 Mar 2011 02:38:46 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jason Rhinelander via RT &lt;bug-MP3-Tag [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Mar 23, 2011 at 12:34:51AM -0400, Jason Rhinelander via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: MP3-Tag
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66768">https://rt.cpan.org/Ticket/Display.html?id=66768</a></span> &gt;
&gt; 
&gt; On 22-Mar-11 10:51 PM, Ilya Zakharevich via RT wrote:
<div class="message-stanza open">&gt; &gt; Using a module which loads overload.pm to open a temporary file cannot
&gt; &gt; be &#34;the proper solution&#34;.
</div>&gt; 
&gt; I should also point out that the patch I provided doesn&#39;t use the 
&gt; object-oriented interface to File::Temp at all, and thus no use of 
&gt; overloading takes place.
</div>
Irrelevant.  Loading overload.pm already does the damage...

Yours,
Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;24&nbsp;15:21:17&nbsp;2011</span>
    <span class="description">jagerman [...] jagerman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 24 Mar 2011 15:21:06 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MP3-Tag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Rhinelander &lt;jagerman [...] jagerman.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 23-Mar-11 5:38 AM, Ilya Zakharevich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Irrelevant.  Loading overload.pm already does the damage...
</div>
I&#39;d like to believe you on this one, but I can&#39;t seem to find any 
documentation or evidence of overload imposing any significant overhead 
on non-overloaded variables, aside from a broken RedHat patch to Perl 
about 3 years ago.  Moreover my own simple test:

time perl -le &#39;package Foo; use overload &#34;&gt;&#34; =&gt; sub {}; package main; 
for &#40;my $i = 0; $i &lt; 100_000_000; $i++&#41; { print $i if $i % 10_000_000 == 
0 }&#39;

versus

time perl -le &#39;package Foo; package main; for &#40;my $i = 0; $i &lt; 
100_000_000; $i++&#41; { print $i if $i % 10_000_000 == 0 }&#39;

doesn&#39;t appear to indicate any speed penalty on the code at all. 
perldoc overload also seems to imply that there is no measurable 
performance penalty for overload being loaded in another module.

So what, exactly, is the damage done by indirectly loading overload?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;24&nbsp;17:05:19&nbsp;2011</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 24 Mar 2011 14:05:08 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jason Rhinelander via RT &lt;bug-MP3-Tag [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Mar 24, 2011 at 03:21:18PM -0400, Jason Rhinelander via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 23-Mar-11 5:38 AM, Ilya Zakharevich via RT wrote:
<div class="message-stanza open">&gt; &gt; Irrelevant.  Loading overload.pm already does the damage...
</div>&gt; 
&gt; I&#39;d like to believe you on this one, but I can&#39;t seem to find any 
&gt; documentation or evidence of overload imposing any significant overhead 
&gt; on non-overloaded variables, aside from a broken RedHat patch to Perl 
&gt; about 3 years ago.
</div>
When I implemented overloading for Perl, I, obviously, did a lot of
benchmarking.  That time superpipelining and cache-coloring-type
optimizations in the processors were not widespread, so one could
do &#34;pretty predictable&#34; benchmarking.

IIRC, the slowdown due to my patch was about +- 1% when overloading
was not used &#40;probably due to offset of addresses, so better or worse
alignment of cache lines&#41;, and &#34;about several percent&#34; &#40;do not
remember more precise&#41; when overload was used.

On processors of nowadays, benchmarks vary too much to be meaningful
without major statistical samples.

Yours,
Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;24&nbsp;17:11:29&nbsp;2011</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 24 Mar 2011 14:11:19 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jason Rhinelander via RT &lt;bug-MP3-Tag [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Mar 23, 2011 at 12:19:17AM -0400, Jason Rhinelander via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; That, of course, is exactly what File::Temp does, but it takes a fair
&gt; &gt;&gt; chunk of code to get this right in a portable manner.
</div>&gt; &gt;
&gt; &gt; I doubt it very much.
</div>&gt; 
&gt; Look for yourself.  vim `perldoc -l File::Temp`
</div>
Did you?  Can you find anything else done except

   sysopen&#40;$fh, $path, $flags, 0600&#41;;

with $flags being essentially O_CREAT | O_EXCL | O_RDW, and checking
for $!{EEXIST} ?

Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;24&nbsp;17:27:27&nbsp;2011</span>
    <span class="description">jagerman [...] jagerman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 24 Mar 2011 17:27:18 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MP3-Tag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Rhinelander &lt;jagerman [...] jagerman.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">While I&#39;m still not convinced that a performance deficit that requires 
&#34;major statistical samples&#34; to detect, which is only loaded for a small 
fraction of MP3::Tag&#39;s use case, I&#39;m willing to concede the point in 
order to get this fixed in *some* way.

So let me ask this: are you willing to apply some patch on this, and if 
so, what code is acceptable here?  The code from perldoc -q temporary 
&#40;modified as appropriate, of course--actually, at a quick glance that 
code appears wrong in that it tests *FH, but actually opens a lexical 
filehandle $fh&#41;?  File::Temp appears to have additional safeness code 
for systems where the simple sysopen with O_WRONLY|O_EXCL|O_CREAT is 
insufficient to guarantee safeness, but that code plus a randomly 
generated sequence &#40;instead of the current counter-from-0 approach&#41; 
ought to eliminate on POSIX-like systems on non-networked filesystems, 
and significantly reduce the occurrence otherwise.

So in short, I suggest, and will write it and submit a patch, if you concur:

- using dirname&#40;$filename&#41; . &#34;/TMP&#34; . &#40;random sequence of 5 alphanumeric 
characters&#41; . &#34;.tmp&#34; for the filename
- using sysopen&#40;&#41; with O_WRONLY|O_EXCL|O_CREAT instead of open&#40;&#41;

Does that work?

Jason

On 24-Mar-11 5:05 PM, Ilya Zakharevich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66768">https://rt.cpan.org/Ticket/Display.html?id=66768</a></span>&gt;
&gt;
&gt; On Thu, Mar 24, 2011 at 03:21:18PM -0400, Jason Rhinelander via RT wrote:
<div class="message-stanza open">&gt;&gt; On 23-Mar-11 5:38 AM, Ilya Zakharevich via RT wrote:
<div class="message-stanza open">&gt;&gt;&gt; Irrelevant.  Loading overload.pm already does the damage...
</div>&gt;&gt;
&gt;&gt; I&#39;d like to believe you on this one, but I can&#39;t seem to find any
&gt;&gt; documentation or evidence of overload imposing any significant overhead
&gt;&gt; on non-overloaded variables, aside from a broken RedHat patch to Perl
&gt;&gt; about 3 years ago.
</div>&gt;
&gt; When I implemented overloading for Perl, I, obviously, did a lot of
&gt; benchmarking.  That time superpipelining and cache-coloring-type
&gt; optimizations in the processors were not widespread, so one could
&gt; do &#34;pretty predictable&#34; benchmarking.
&gt;
&gt; IIRC, the slowdown due to my patch was about +- 1% when overloading
&gt; was not used &#40;probably due to offset of addresses, so better or worse
&gt; alignment of cache lines&#41;, and &#34;about several percent&#34; &#40;do not
&gt; remember more precise&#41; when overload was used.
&gt;
&gt; On processors of nowadays, benchmarks vary too much to be meaningful
&gt; without major statistical samples.
&gt;
&gt; Yours,
&gt; Ilya
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;24&nbsp;17:47:02&nbsp;2011</span>
    <span class="description">jagerman [...] jagerman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 24 Mar 2011 17:46:52 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MP3-Tag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Rhinelander &lt;jagerman [...] jagerman.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 24-Mar-11 5:11 PM, Ilya Zakharevich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66768">https://rt.cpan.org/Ticket/Display.html?id=66768</a></span>&gt;
&gt;
&gt; On Wed, Mar 23, 2011 at 12:19:17AM -0400, Jason Rhinelander via RT wrote:
<div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt;&gt;&gt;&gt; That, of course, is exactly what File::Temp does, but it takes a fair
&gt;&gt;&gt;&gt; chunk of code to get this right in a portable manner.
</div>&gt;&gt;&gt;
&gt;&gt;&gt; I doubt it very much.
</div>&gt;&gt;
&gt;&gt; Look for yourself.  vim `perldoc -l File::Temp`
</div>&gt;
&gt; Did you?  Can you find anything else done except
&gt;
&gt;     sysopen&#40;$fh, $path, $flags, 0600&#41;;
&gt;
&gt; with $flags being essentially O_CREAT | O_EXCL | O_RDW, and checking
&gt; for $!{EEXIST} ?
</div>
Each of O_NOFOLLOW, O_BINARY, O_LARGEFILE, O_NOINHERIT, and O_EXLOCK is 
also set, if they exist.

Even still, we don&#39;t necessarily get safeness on a network mount, hence 
my suggestions for a random filename as well instead of a incremental 
integer value.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ilya
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;24&nbsp;17:49:11&nbsp;2011</span>
    <span class="description">jason [...] imaginary.ca -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 24 Mar 2011 17:49:02 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MP3-Tag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Rhinelander &lt;jason [...] imaginary.ca&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">

On 24-Mar-11 5:46 PM, Jason Rhinelander wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 24-Mar-11 5:11 PM, Ilya Zakharevich via RT wrote:
<div class="message-stanza open">&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66768">https://rt.cpan.org/Ticket/Display.html?id=66768</a></span>&gt;
&gt;&gt;
&gt;&gt; On Wed, Mar 23, 2011 at 12:19:17AM -0400, Jason Rhinelander via RT wrote:
<div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt;&gt;&gt;&gt;&gt; That, of course, is exactly what File::Temp does, but it takes a fair
&gt;&gt;&gt;&gt;&gt; chunk of code to get this right in a portable manner.
</div>&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I doubt it very much.
</div>&gt;&gt;&gt;
&gt;&gt;&gt; Look for yourself. vim `perldoc -l File::Temp`
</div>&gt;&gt;
&gt;&gt; Did you? Can you find anything else done except
&gt;&gt;
&gt;&gt; sysopen&#40;$fh, $path, $flags, 0600&#41;;
&gt;&gt;
&gt;&gt; with $flags being essentially O_CREAT | O_EXCL | O_RDW, and checking
&gt;&gt; for $!{EEXIST} ?
</div>&gt;
&gt; Each of O_NOFOLLOW, O_BINARY, O_LARGEFILE, O_NOINHERIT, and O_EXLOCK is
&gt; also set, if they exist.
</div>
... plus a bunch of extra tests if someone increases File::Temp&#39;s 
safe_level.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;24&nbsp;22:42:41&nbsp;2011</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 24 Mar 2011 19:41:31 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jason Rhinelander via RT &lt;bug-MP3-Tag [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Mar 24, 2011 at 05:49:11PM -0400, Jason Rhinelander via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; Did you? Can you find anything else done except
&gt; &gt;&gt;
&gt; &gt;&gt; sysopen&#40;$fh, $path, $flags, 0600&#41;;
&gt; &gt;&gt;
&gt; &gt;&gt; with $flags being essentially O_CREAT | O_EXCL | O_RDW, and checking
&gt; &gt;&gt; for $!{EEXIST} ?
</div>&gt; &gt;
&gt; &gt; Each of O_NOFOLLOW, O_BINARY, O_LARGEFILE, O_NOINHERIT, and O_EXLOCK is
&gt; &gt; also set, if they exist.
</div></div>
This is what &#34;essentially&#34; meant.  Do we need any of these flags?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ... plus a bunch of extra tests if someone increases File::Temp&#39;s 
&gt; safe_level.
</div>
Did you increase it in your patch?

Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;25&nbsp;03:08:13&nbsp;2011</span>
    <span class="description">jagerman [...] jagerman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 25 Mar 2011 03:08:02 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MP3-Tag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Rhinelander &lt;jagerman [...] jagerman.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 24-Mar-11 10:42 PM, Ilya Zakharevich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66768">https://rt.cpan.org/Ticket/Display.html?id=66768</a></span>&gt;
&gt;
&gt; On Thu, Mar 24, 2011 at 05:49:11PM -0400, Jason Rhinelander via RT wrote:
<div class="message-stanza open"><div class="message-stanza open">&gt;&gt;&gt;&gt; Did you? Can you find anything else done except
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; sysopen&#40;$fh, $path, $flags, 0600&#41;;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; with $flags being essentially O_CREAT | O_EXCL | O_RDW, and checking
&gt;&gt;&gt;&gt; for $!{EEXIST} ?
</div>&gt;&gt;&gt;
&gt;&gt;&gt; Each of O_NOFOLLOW, O_BINARY, O_LARGEFILE, O_NOINHERIT, and O_EXLOCK is
&gt;&gt;&gt; also set, if they exist.
</div>&gt;
&gt; This is what &#34;essentially&#34; meant.  Do we need any of these flags?
</div>
I do not know.  I would guess &#34;probably&#34; for O_BINARY and O_EXLOCK, and 
&#34;maybe&#34; for the others.  I do, however, assume that the author&#40;s&#41; of 
File::Temp knows better than I, and so assume that they have some 
importance on some system somewhere.

I&#39;ve written another patch, addressing the various concerns you have 
raised in this report thus far.  This time using sysopen, as previously 
discussed, with all the various flags that File::Temp sets.  If you know 
any of these to be obviously unnecessary for the file replacement being 
done in MP3::Tag::ID3v2, please remove them.

Additionally, this patch uses TMPxxxx.tmp for the filename, where xxxxx 
is replaced with 5 random \w characters &#40;this ought to help when the 
filesystem is on some mountpoint &#40;e.g. a network mount&#41; where sysopen 
cannot guarantee safeness of the open&#41;.  Finally, the patch also 
attempts to preserve the file permissions of the original file &#40;though 
forcing 0600 at a minimum&#41;.

I tested the patch on a few MP3s, completely removing and re-adding the 
ID3v2 tags to force the file rewriting, and everything appears to be 
working properly.  I specifically, for testing, changed the ID3v2.pm 
code to use much less random filename generation with several calls in 
parallel, and verified that the sysopen call, in fact, failing correctly 
when the file already exists.

Hopefully you find this new patch acceptable, and can include it in the 
next release of MP3::Tag.

Thanks,

Jason
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;25&nbsp;03:09:24&nbsp;2011</span>
    <span class="description">jagerman [...] jagerman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 25 Mar 2011 03:09:09 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MP3-Tag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Rhinelander &lt;jagerman [...] jagerman.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Oops: attaching the patch would help, I suppose.

Jason
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;25&nbsp;05:41:14&nbsp;2011</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 25 Mar 2011 02:41:04 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jason Rhinelander via RT &lt;bug-MP3-Tag [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Mar 25, 2011 at 03:08:14AM -0400, Jason Rhinelander via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt;&gt;&gt; Each of O_NOFOLLOW, O_BINARY, O_LARGEFILE, O_NOINHERIT, and O_EXLOCK is
&gt; &gt;&gt;&gt; also set, if they exist.
</div></div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; This is what &#34;essentially&#34; meant.  Do we need any of these flags?
</div></div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I do not know.  I would guess &#34;probably&#34; for O_BINARY and O_EXLOCK, and 
</div>
&#34;Definitely NO&#34; for O_BINARY and O_EXLOCK.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#34;maybe&#34; for the others.
</div>
The only one which may have some vague relation to real needs is
O_LARGEFILE.  Unfortunately, I have no clue what it means....

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I do, however, assume that the author&#40;s&#41; of 
&gt; File::Temp knows better than I, and so assume that they have some 
&gt; importance on some system somewhere.
</div>
As I said, I do not give ANY trust to authors of File::Temp, judging
by how it is designed...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve written another patch, addressing the various concerns you have 
&gt; raised in this report thus far.  This time using sysopen, as previously 
&gt; discussed, with all the various flags that File::Temp sets.
</div>
Thanks!  I was planning to do this for ages, just did not know how to
do it exactly...  Your prodding worked well in this regard...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Additionally, this patch uses TMPxxxx.tmp for the filename, where xxxxx 
&gt; is replaced with 5 random \w characters &#40;this ought to help when the 
&gt; filesystem is on some mountpoint &#40;e.g. a network mount&#41; where sysopen 
&gt; cannot guarantee safeness of the open&#41;.  Finally, the patch also 
&gt; attempts to preserve the file permissions of the original file &#40;though 
&gt; forcing 0600 at a minimum&#41;.
</div>
I thought about this, and I&#39;m not absolutely sure that it is what a
user would want.  Maybe one can make it configurable, as other
hard-to-decide matters...

Yours,
Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;25&nbsp;05:47:30&nbsp;2011</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 25 Mar 2011 02:47:18 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jason Rhinelander via RT &lt;bug-MP3-Tag [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Mar 25, 2011 at 03:09:24AM -0400, Jason Rhinelander via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: MP3-Tag
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66768">https://rt.cpan.org/Ticket/Display.html?id=66768</a></span> &gt;
&gt; 
&gt; Oops: attaching the patch would help, I suppose.
</div>
Just checking for an obvious bug, and it is there...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; +     for &#40;1 .. 1000&#41; {
&gt; +             my $tempfile = $base . join&#40;&#39;&#39;, @tempfile_chars[map rand&#40;@tempfile_chars&#41;, 1..5]&#41; . &#39;.tmp&#39;;
&gt; +
</div>
Bits of rand&#40;&#41; are intended to be independent.  However, there is no
guarantie that bits of SEVERAL calls to rand&#40;&#41; are independent.  One
should base things on a result of one call to rand&#40;&#41;...

Yours,
Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;25&nbsp;10:55:24&nbsp;2011</span>
    <span class="description">jagerman [...] jagerman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 25 Mar 2011 10:55:12 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MP3-Tag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Rhinelander &lt;jagerman [...] jagerman.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 25-Mar-11 5:47 AM, Ilya Zakharevich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Just checking for an obvious bug, and it is there...
&gt;
<div class="message-stanza open">&gt;&gt; +    for &#40;1 .. 1000&#41; {
&gt;&gt; +            my $tempfile = $base . join&#40;&#39;&#39;, @tempfile_chars[map rand&#40;@tempfile_chars&#41;, 1..5]&#41; . &#39;.tmp&#39;;
&gt;&gt; +
</div>&gt;
&gt; Bits of rand&#40;&#41; are intended to be independent.  However, there is no
&gt; guarantie that bits of SEVERAL calls to rand&#40;&#41; are independent.  One
&gt; should base things on a result of one call to rand&#40;&#41;...
</div>
Since guaranteed independence is not required here, that is not a bug, 
and you know it.

Your hostility, however, tells me that I am wasting my time in 
attempting to propose a solution to this bug.  You have my patches; use 
bits of them or do something else as you like.

Jason
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;25&nbsp;11:05:20&nbsp;2011</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 25 Mar 2011 08:05:06 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jason Rhinelander via RT &lt;bug-MP3-Tag [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Mar 25, 2011 at 10:55:24AM -0400, Jason Rhinelander via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: MP3-Tag
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66768">https://rt.cpan.org/Ticket/Display.html?id=66768</a></span> &gt;
&gt; 
&gt; On 25-Mar-11 5:47 AM, Ilya Zakharevich via RT wrote:
<div class="message-stanza open">&gt; &gt; Just checking for an obvious bug, and it is there...
&gt; &gt;
<div class="message-stanza open">&gt; &gt;&gt; +  for &#40;1 .. 1000&#41; {
&gt; &gt;&gt; +          my $tempfile = $base . join&#40;&#39;&#39;, @tempfile_chars[map rand&#40;@tempfile_chars&#41;, 1..5]&#41; . &#39;.tmp&#39;;
&gt; &gt;&gt; +
</div>&gt; &gt;
&gt; &gt; Bits of rand&#40;&#41; are intended to be independent.  However, there is no
&gt; &gt; guarantie that bits of SEVERAL calls to rand&#40;&#41; are independent.  One
&gt; &gt; should base things on a result of one call to rand&#40;&#41;...
</div>&gt; 
&gt; Since guaranteed independence is not required here, that is not a bug, 
&gt; and you know it.
</div>
Either you need randomness, and then you try to get some, or you do
not - then do not call rand&#40;&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Your hostility, however, tells me that I am wasting my time in 
&gt; attempting to propose a solution to this bug.  You have my patches; use 
&gt; bits of them or do something else as you like.
</div>
Your hostility makes this conversation moot.

A pity,
Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;25&nbsp;15:22:24&nbsp;2011</span>
    <span class="description">jagerman [...] jagerman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 25 Mar 2011 15:45:25 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MP3-Tag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Rhinelander &lt;jagerman [...] jagerman.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 25/03/11 11:05 AM, Ilya Zakharevich via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt; Your hostility makes this conversation moot.
</div>
I apologize for the tenor of my previous e-mail.  I am interested in 
getting this fixed, as I find the module very useful, and do appreciate 
the desire to get it fixed correctly.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt;&gt;&gt; Bits of rand&#40;&#41; are intended to be independent.  However, there is no
&gt;&gt;&gt; guarantie that bits of SEVERAL calls to rand&#40;&#41; are independent.  One
&gt;&gt;&gt; should base things on a result of one call to rand&#40;&#41;...
</div>&gt;&gt;
&gt;&gt; Since guaranteed independence is not required here, that is not a bug,
&gt;&gt; and you know it.
</div>&gt;
&gt; Either you need randomness, and then you try to get some, or you do
&gt; not - then do not call rand&#40;&#41;.
</div>
The bigger problem here is that even scooping the bits out of a single 
rand&#40;&#41; call doesn&#39;t actually give enough randomness: in particular, if I 
fork &#40;presuming rand&#40;&#41; has been called at least once before the fork&#40;&#41;, 
i.e. so that rand has been seeded&#41;, then attempt to operate on two files 
in the same directory at the same time, the same rand&#40;&#41; value &#40;and, for 
that matter, sequence of rand&#40;&#41; values&#41; will be generated--whether or 
not I use the bits from one rand&#40;&#41; call or a sequence of rand&#40;&#41; calls.

Since this race condition seems most likely to come up in a script that 
forks and uses MP3::Tag in parallel &#40;I may be biased--but that was how I 
ran into it&#41;, I tend to agree that any use of rand&#40;&#41; here--whether 5 
rand&#40;&#41; calls, or one rand&#40;&#41; call divided into 5 sets of bits--isn&#39;t 
actually any more random than the existing 0..999 sequence, and thus 
isn&#39;t solving anything when sysopen can&#39;t guarantee non-overwriting 
properly.

I&#39;m not entirely sure what a feasible solution is here.  You mentioned 
earlier that there were portability problems basing the filename on the 
MP3 filename as I did in one of the earlier patches--could we amend that 
filename generation in some way to mitigate the problem here?

On a separate note, while looking at the code I noticed another 
potential data loss problem: print values aren&#39;t checked, so if writing 
to the temp MP3 file fails &#40;e.g. because of a full disk&#41;, we still 
clobber the original with a truncated version.  If you&#39;d like, I&#39;d be 
happy to submit a separate patch that checks those, unlinking the 
tempfile and returning an error value if a print fails.  I didn&#39;t want 
to throw it into the previous patch as it really is a separate 
issue--but the two patches touch some of the same code and would thus be 
dependent.

Jason
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;25&nbsp;20:15:30&nbsp;2011</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 25 Mar 2011 17:15:21 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jason Rhinelander via RT &lt;bug-MP3-Tag [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Mar 25, 2011 at 03:22:24PM -0400, Jason Rhinelander via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: MP3-Tag
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66768">https://rt.cpan.org/Ticket/Display.html?id=66768</a></span> &gt;
&gt; 
&gt; On 25/03/11 11:05 AM, Ilya Zakharevich via RT wrote:
&gt; 
<div class="message-stanza open">&gt;  &gt; Your hostility makes this conversation moot.
</div>&gt; 
&gt; I apologize for the tenor of my previous e-mail.  I am interested in 
&gt; getting this fixed, as I find the module very useful, and do appreciate 
&gt; the desire to get it fixed correctly.
</div>
I might have been hostile indeed, but I believe not to you, but to
people who busted so important a module...  What you did is great, and
I hope to work on it ASAP &#40;which, unfortunately, may be some wait...&#41;.

Thanks again,
Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;28&nbsp;07:16:49&nbsp;2011</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 28 Mar 2011 04:16:39 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jason Rhinelander via RT &lt;bug-MP3-Tag [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Mar 25, 2011 at 03:22:24PM -0400, Jason Rhinelander via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The bigger problem here is that even scooping the bits out of a single 
&gt; rand&#40;&#41; call doesn&#39;t actually give enough randomness: in particular, if I 
&gt; fork &#40;presuming rand&#40;&#41; has been called at least once before the fork&#40;&#41;, 
&gt; i.e. so that rand has been seeded&#41;, then attempt to operate on two files 
&gt; in the same directory at the same time, the same rand&#40;&#41; value &#40;and, for 
&gt; that matter, sequence of rand&#40;&#41; values&#41; will be generated--whether or 
&gt; not I use the bits from one rand&#40;&#41; call or a sequence of rand&#40;&#41; calls.
</div>
Untested:

my $r = @arr ** 5;              # limit
# processes may have the same seed if rand&#40;&#41; is called before fork&#40;&#41;
$r = &#40;$$ + int&#40;rand $r&#41;&#41; % $r;  # read randomness from ONE call to rand&#40;&#41;
my $X = join &#39;&#39;, map { my $o = $r % @arr; $r = int&#40;$r/@arr&#41;; chr $o } 1..5;

Yours,
Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;28&nbsp;07:19:14&nbsp;2011</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 28 Mar 2011 04:19:03 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Ilya Zakharevich via RT &lt;bug-MP3-Tag [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, Mar 28, 2011 at 07:16:49AM -0400, Ilya Zakharevich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; my $r = @arr ** 5;              # limit
&gt; # processes may have the same seed if rand&#40;&#41; is called before fork&#40;&#41;
&gt; $r = &#40;$$ + int&#40;rand $r&#41;&#41; % $r;  # read randomness from ONE call to rand&#40;&#41;
&gt; my $X = join &#39;&#39;, map { my $o = $r % @arr; $r = int&#40;$r/@arr&#41;; chr $o } 1..5;
</div>
Silly me, forgot to use @arr:

my $r = @arr ** 5;              # limit
# processes may have the same seed if rand&#40;&#41; is called before fork&#40;&#41;
$r = &#40;$$ + int&#40;rand $r&#41;&#41; % $r;  # read randomness from ONE call to rand&#40;&#41;
my $X = join &#39;&#39;, map { my $o = $r % @arr; $r = int&#40;$r/@arr&#41;; $arr[$o] } 1..5;

Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;28&nbsp;08:45:51&nbsp;2011</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 28 Mar 2011 05:45:40 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jason Rhinelander via RT &lt;bug-MP3-Tag [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Mar 25, 2011 at 03:22:24PM -0400, Jason Rhinelander via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On a separate note, while looking at the code I noticed another 
&gt; potential data loss problem: print values aren&#39;t checked, so if writing 
&gt; to the temp MP3 file fails &#40;e.g. because of a full disk&#41;, we still 
&gt; clobber the original with a truncated version.
</div>
Checking result of print&#40;&#41; is not needed.  But one MUST check the
result of close&#40;&#41; indeed!  The only excuse I have is that &#34;it is not
my code&#34;, and I just have not have tuits to handle it...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  If you&#39;d like, I&#39;d be 
&gt; happy to submit a separate patch that checks those, unlinking the 
&gt; tempfile and returning an error value if a print fails.
</div>
Thanks a lot!  However, note that I do not see how returning an error
value would be a solution.  I suspect one should better die&#40;&#41;
instead...

Thanks,
Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;28&nbsp;09:18:57&nbsp;2011</span>
    <span class="description">jagerman [...] jagerman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 28 Mar 2011 09:18:46 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MP3-Tag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Rhinelander &lt;jagerman [...] jagerman.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 28-Mar-11 8:45 AM, Ilya Zakharevich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=66768">http://rt.cpan.org/Ticket/Display.html?id=66768</a></span>&gt;
&gt;
&gt; On Fri, Mar 25, 2011 at 03:22:24PM -0400, Jason Rhinelander via RT wrote:
<div class="message-stanza open">&gt;&gt; On a separate note, while looking at the code I noticed another
&gt;&gt; potential data loss problem: print values aren&#39;t checked, so if writing
&gt;&gt; to the temp MP3 file fails &#40;e.g. because of a full disk&#41;, we still
&gt;&gt; clobber the original with a truncated version.
</div>&gt;
&gt; Checking result of print&#40;&#41; is not needed.  But one MUST check the
&gt; result of close&#40;&#41; indeed!  The only excuse I have is that &#34;it is not
&gt; my code&#34;, and I just have not have tuits to handle it...
&gt;
<div class="message-stanza open">&gt;&gt;   If you&#39;d like, I&#39;d be
&gt;&gt; happy to submit a separate patch that checks those, unlinking the
&gt;&gt; tempfile and returning an error value if a print fails.
</div>&gt;
&gt; Thanks a lot!  However, note that I do not see how returning an error
&gt; value would be a solution.  I suspect one should better die&#40;&#41;
&gt; instead...
</div>
Well, yes, that would be better.  I assume, then, that we should also 
change the other failures &#40;unable to open the temp file, unable to 
rename it, ...&#41; to die as well?

Jason
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;28&nbsp;13:27:00&nbsp;2011</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 28 Mar 2011 10:26:49 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jason Rhinelander via RT &lt;bug-MP3-Tag [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, Mar 28, 2011 at 09:18:57AM -0400, Jason Rhinelander via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Well, yes, that would be better.  I assume, then, that we should also 
&gt; change the other failures &#40;unable to open the temp file, unable to 
&gt; rename it, ...&#41; to die as well?
</div>
&#34;Unable to rename it&#34; is tricky: the user who reads error messages has
a chance to correct it later.  I would make it user-configurable with
the default being &#34;be fatal&#34;.

Hmm, &#34;unable to do something&#34; is ALWAYS correctable later - unless we
do something really stupid &#40;like the current practice of overwriting
files ;-&#41;.  So the criterion should better be &#34;is the error expected
to persist if we do many files in a loop&#34;.

&#34;Unable to rename&#34; looks like some file locking issue which MAY be
specific to a particular file.  The other two errors look like some
filesystem problems, and would usually &#34;persist&#34; for other files as
well...  Just thinking aloud...

So maybe &#34;unable to rename it&#34; reserves a special treatment indeed...

Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;25&nbsp;16:15:19&nbsp;2011</span>
    <span class="description">jagerman [...] jagerman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 25 May 2011 16:15:07 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MP3-Tag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Rhinelander &lt;jagerman [...] jagerman.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve been unable to look at this again until now; please find attached 
my updated patch.  Changes from the last version:

- Only tries to set O_NOFOLLOW and O_LARGEFILE &#40;if available&#41;, no longer 
trying the various other O_ flags from the previous patch.

- Uses a single rand call &#40;incorporating $$&#41; for the temporary filename, 
as discussed earlier in this thread.

- Checks the return of close on the tempfile to make sure writing the 
file succeeded before we try to clobber the original.

The patch still die&#40;&#41;s on errors writing/closing/renaming the tempfile. 
  The code, as currently written, doesn&#39;t have an obvious &#40;to me&#41; 
mechanism for returning an error &#40;especially since the involved methods 
are typically only indirectly called, e.g. when more space is needed&#41;. 
Having a configurable means of not having these treated as die&#40;&#41;s is a 
good idea, but needs a bit more thought, and would probably be better to 
be MP3::Tag-wide instead of merely specific to MP3::Tag::ID3v2.

Jason

On 28-Mar-11 1:27 PM, Ilya Zakharevich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=66768">https://rt.cpan.org/Ticket/Display.html?id=66768</a></span>&gt;
&gt;
&gt; On Mon, Mar 28, 2011 at 09:18:57AM -0400, Jason Rhinelander via RT wrote:
<div class="message-stanza open">&gt;&gt; Well, yes, that would be better.  I assume, then, that we should also
&gt;&gt; change the other failures &#40;unable to open the temp file, unable to
&gt;&gt; rename it, ...&#41; to die as well?
</div>&gt;
&gt; &#34;Unable to rename it&#34; is tricky: the user who reads error messages has
&gt; a chance to correct it later.  I would make it user-configurable with
&gt; the default being &#34;be fatal&#34;.
&gt;
&gt; Hmm, &#34;unable to do something&#34; is ALWAYS correctable later - unless we
&gt; do something really stupid &#40;like the current practice of overwriting
&gt; files ;-&#41;.  So the criterion should better be &#34;is the error expected
&gt; to persist if we do many files in a loop&#34;.
&gt;
&gt; &#34;Unable to rename&#34; looks like some file locking issue which MAY be
&gt; specific to a particular file.  The other two errors look like some
&gt; filesystem problems, and would usually &#34;persist&#34; for other files as
&gt; well...  Just thinking aloud...
&gt;
&gt; So maybe &#34;unable to rename it&#34; reserves a special treatment indeed...
&gt;
&gt; Ilya
&gt;
</div></div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;25&nbsp;16:19:32&nbsp;2011</span>
    <span class="description">jagerman [...] jagerman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 25 May 2011 16:19:22 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MP3-Tag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Rhinelander &lt;jagerman [...] jagerman.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I should also add that I&#39;m driven a little mad by the conflicting tab 
settings: the file has apparently been edited by people using a mixture 
of 4-space tabs, 8-space tabs, and pure space indentation, for which no 
tabstop setting seems to work across the whole file.  I tried to keep 
the tabbing in each area the same so as to avoid unnecessary diff bloat, 
but reindenting the file in some universal style would be worthwhile.

Jason
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;26&nbsp;17:16:25&nbsp;2011</span>
    <span class="description">jagerman [...] jagerman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66768] AutoReply: Broken temp file generation in MP3::Tag::ID3v2</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 26 May 2011 17:16:14 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MP3-Tag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Rhinelander &lt;jagerman [...] jagerman.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">One more update--the previous patch had a &#40;stupid&#41; bug in the mode 
preservation that was actually mode-clobbering.


Jason
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
