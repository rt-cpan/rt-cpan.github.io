<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #62892 for Parse-RecDescent: failed subrules eat text</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #62892 for Parse-RecDescent: failed subrules eat text</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Parse-RecDescent/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Parse-RecDescent/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Parse-RecDescent/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Parse-RecDescent/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Parse-RecDescent">Parse-RecDescent CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">62892</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Parse-RecDescent/Active/">Parse-RecDescent</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mhhollomon [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-24792-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.965001    </td>
  </tr>
  <tr id="CF-24793-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;10&nbsp;07:06:49&nbsp;2010</span>
    <span class="description">mhhollomon [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> failed subrules eat text</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">perl version 5.10.1 built for i686-cygwin-thread-multi-64int
Parse::RecDescent version 1.965001

I would expect attached test to print &#34;NO MATCH&#34;, but in fact, it matches.

The problem seems to be this line in generated code:

unless &#40; $_matched || defined&#40;$score&#41; &#41;
{
...
$_[1] = $text;  # NOT SURE THIS IS NEEDED  &lt;====
...
}

$text is modified by the successful match of &#39;one&#39;. Assigning back to
the argument propagates this modification up the chain.

Applying the attached patch fixes this bug, but I don&#39;t know what it
might break. I can&#39;t think of a reason that you would ever want to
propagate a $text change upwards on failure, but I may not have a good
enough imagination.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> failed_subrules_eat_text.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w

use strict;
use warnings;
use Parse::RecDescent;

my $text = &#34;one ;&#34;;

my $parser = Parse::RecDescent-&gt;new&#40;&lt;&lt;&#39;EOGRAMMAR&#39;&#41;;
TOP:
    &lt;leftop: element /,/ element&gt;&#40;s?&#41; &#39;;&#39;
element:
    &#39;one&#39; &#39;two&#39;
EOGRAMMAR

local $::RD_TRACE = 1;
if &#40;defined $parser-&gt;TOP&#40;$text&#41;&#41; {
    print &#34;===== MATCHED ====\n&#34;;
} else {
    print &#34;===== NO MATCH ===\n&#34;;
}
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> failed_subrules_eat_text.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">*** RecDescent.pm.orig	2010-11-10 07:02:39.607127500 -0500
--- RecDescent.pm	2010-11-10 07:02:06.013162500 -0500
*************** sub &#39; . $namespace . &#39;::&#39; . $self-&gt;{&#34;nam
*** 441,447 ****
                &#39;
              : &#39;&#39;&#41; . &#39;
  
!         $_[1] = $text;  # NOT SURE THIS IS NEEDED
          Parse::RecDescent::_trace&#40;q{&lt;&lt;Didn\&#39;t match rule&gt;&gt;},
                       Parse::RecDescent::_tracefirst&#40;$_[1]&#41;,
                       q{&#39; . $self-&gt;{&#34;name&#34;} .&#39;},
--- 441,447 ----
                &#39;
              : &#39;&#39;&#41; . &#39;
  
!         #$_[1] = $text;  # NOT SURE THIS IS NEEDED
          Parse::RecDescent::_trace&#40;q{&lt;&lt;Didn\&#39;t match rule&gt;&gt;},
                       Parse::RecDescent::_tracefirst&#40;$_[1]&#41;,
                       q{&#39; . $self-&gt;{&#34;name&#34;} .&#39;},
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;29&nbsp;01:15:49&nbsp;2012</span>
    <span class="description">jtbraun [...] CPAN.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for the bug report!

I&#39;m preparing a set of changes for Parse::RecDescent that allow for the
use of external lexers.  A side effect of these changes are that all of
the state saving/restoring code has been touched, and the provided test
case appears to have the expected behavior against this new branch.

It will be some time yet before this branch is production ready, so I
will leave this ticket open until the lexer changes have been integrated.

Jeremy
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;29&nbsp;01:15:50&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;28&nbsp;10:11:07&nbsp;2012</span>
    <span class="description">spam-bitcard [...] yary.ack.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> spam-bitcard [...] yary.ack.org</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I&#39;ve run into this same problem and had a devil of a time tracking it
down, thanks for the patch! I wrote up a test program as well &#40;before I
saw this report&#41; and am attaching it here, in case it is helpful for the
test suite.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> gramtest.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl

use strict;
use Parse::RecDescent;

my $parser = new Parse::RecDescent &#40;&lt;&lt;&#39;GRAMMA&#39;&#41;;

word:	/\w+/ &lt;reject: $item[1] eq &#39;nother&#39;&gt; {$item[1]}

GRAMMA

sub parse_word {
  if &#40;defined &#40;my $result=$parser-&gt;word&#40;$_[0]&#41;&#41;&#41; {
    print &#34;parsed word &#39;$result&#39;\n&#34;;
  }
  else {
    print &#34;Could not parse here\n&#34;
  }
  print &#34;Left with &#39;${$_[0]}&#39;\n&#34;;
}


my $text=&#34;an other&#34;;


# This is good
parse_word&#40;\$text&#41;;
parse_word&#40;\$text&#41;;

# How come &#34;nother&#34; gets swallowed up?
$text=&#34;a nother&#34;;
parse_word&#40;\$text&#41;;
parse_word&#40;\$text&#41;;
print &#34;The previous line should have left with &#39; nother&#39;, if it \nsays &#39;&#39; then Parse::RecDescent ate unparsed text.\n&#34;;


</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
