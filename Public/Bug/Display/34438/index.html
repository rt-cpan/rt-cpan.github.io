<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #34438 for Module-Build: [PATCH] Multiple XS files with c_source causes relink</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #34438 for Module-Build: [PATCH] Multiple XS files with c_source causes relink</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Module-Build/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Module-Build/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Module-Build/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Module-Build/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Module-Build">Module-Build CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">34438</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">stalled</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Module-Build/Active/">Module-Build</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mschwern [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Unimportant    </td>
  </tr>
  <tr id="CF-21558-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.2808</li>
<li>
0.2808_01</li>
</ul>
    </td>
  </tr>
  <tr id="CF-21559-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




MB-Test.tgz<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/440007/215541/MB-Test.tgz">
Wed Mar 26 05:28:10 2008 (621b) by mschwern [...] cpan.org
</a>
</font></li>
</ul>


xs.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/440007/215544/xs.patch">
Wed Mar 26 05:28:10 2008 (1k) by mschwern [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;26&nbsp;05:28:10&nbsp;2008</span>
    <span class="description">mschwern [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Multiple XS files with c_source causes relink</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">When there are multiple XS files and a c_source set, Module::Build will
sometimes try to relink the first object file causing the compilation to
fail.  To see this happen, unpack the tarball, run Build.PL and then
continuously clean, build and rebuild until it fails.  Should take just
a few iterations.

$ perl -wle &#39;system&#40;q[./Build clean &#38;&#38; ./Build &#38;&#38; echo &#34;Build&#34; &#38;&#38; echo
&#34;Rebuild&#34; &#38;&#38; ./Build]&#41; while $? == 0&#39;

Eventually it should fail something like this &#40;YMMV for your OS&#41;

Rebuild
env MACOSX_DEPLOYMENT_TARGET=10.3 cc -L/sw/lib -bundle -undefined
dynamic_lookup -L/usr/local/lib -L/opt/local/lib -o
blib/arch/auto/MB/Foo/Other/Other.bundle lib/MB/Foo/Other.o ./test.o
./lib/MB/Test.o ./lib/MB/Foo/Other.o
/usr/libexec/gcc/i686-apple-darwin8/4.0.1/ld: multiple definitions of
symbol _XS_MB__Other_other
lib/MB/Foo/Other.o definition of _XS_MB__Other_other in section
&#40;__TEXT,__text&#41;
./lib/MB/Foo/Other.o definition of _XS_MB__Other_other in section
&#40;__TEXT,__text&#41;
/usr/libexec/gcc/i686-apple-darwin8/4.0.1/ld: multiple definitions of
symbol _boot_MB__Other
lib/MB/Foo/Other.o definition of _boot_MB__Other in section &#40;__TEXT,__text&#41;
./lib/MB/Foo/Other.o definition of _boot_MB__Other in section
&#40;__TEXT,__text&#41;
collect2: ld returned 1 exit status
error building blib/arch/auto/MB/Foo/Other/Other.bundle from
lib/MB/Foo/Other.o ./test.o ./lib/MB/Test.o ./lib/MB/Foo/Other.o at
/usr/local/lib/site_perl/ExtUtils/CBuilder/Base.pm line 213.

This is because link_c&#40;&#41; is linking each library against all the object
files.  process_support_files&#40;&#41; just puts all the object files into one
big list.  Because it builds last, this means lib/MB/Test.o is sometimes
newer than lib/MB/Foo/Other.o and thus MB thinks recompilation is necessary.

I believe each library should link only against its own object file.  I
may be wrong but it does work.  The attached patch does so.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> MB-Test.tgz</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/440007/215541/MB-Test.tgz">Download MB-Test.tgz</a><br />
<span class="downloadcontenttype">application/x-gzip 621b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> xs.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- lib/Module/Build/Base.pm	&#40;revision 55266&#41;
+++ lib/Module/Build/Base.pm	&#40;local&#41;
@@ -2270,7 +2270,7 @@
   
   my $files = $self-&gt;rscan_dir&#40;$p-&gt;{c_source}, file_qr&#40;&#39;\.c&#40;pp&#41;?$&#39;&#41;&#41;;
   foreach my $file &#40;@$files&#41; {
-    push @{$p-&gt;{objects}}, $self-&gt;compile_c&#40;$file&#41;;
+    $p-&gt;{objects}{$file} = $self-&gt;compile_c&#40;$file&#41;;
   }
 }
 
@@ -3972,18 +3972,19 @@
 
   $self-&gt;add_to_cleanup&#40;$spec-&gt;{lib_file}&#41;;
 
-  my $objects = $p-&gt;{objects} || [];
+  my @objects = $spec-&gt;{obj_file};
+  push @objects, $p-&gt;{objects}{$spec-&gt;{lib_file}}
+    if $p-&gt;{objects}{$spec-&gt;{lib_file}};
 
   return $spec-&gt;{lib_file}
-    if $self-&gt;up_to_date&#40;[$spec-&gt;{obj_file}, @$objects],
-			 $spec-&gt;{lib_file}&#41;;
+    if $self-&gt;up_to_date&#40;\@objects =&gt; $spec-&gt;{lib_file}&#41;;
 
   my $module_name = $self-&gt;module_name;
   $module_name  ||= $spec-&gt;{module_name};
 
   $self-&gt;cbuilder-&gt;link&#40;
     module_name =&gt; $module_name,
-    objects     =&gt; [$spec-&gt;{obj_file}, @$objects],
+    objects     =&gt; \@objects,
     lib_file    =&gt; $spec-&gt;{lib_file},
     extra_linker_flags =&gt; $p-&gt;{extra_linker_flags} &#41;;
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;26&nbsp;19:27:42&nbsp;2008</span>
    <span class="description">kwilliams [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kwilliams [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Mar 26 05:28:10 2008, MSCHWERN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is because link_c&#40;&#41; is linking each library against all the object
&gt; files.  process_support_files&#40;&#41; just puts all the object files into one
&gt; big list.
</div>
Yeah, it&#39;s definitely the wrong thing to do.  It&#39;s been like that since the beginning of time, the 
idea was to support builds with an XS file and a few .c files, all going into one loadable XS 
module.  Obviously that one use case shouldn&#39;t have driven the entire design.  

What I think needs to happen is to let the author explicitly say which ingredients should get 
mixed into which XS build.

 -Ken
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;26&nbsp;19:27:43&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;26&nbsp;20:22:35&nbsp;2008</span>
    <span class="description">schwern [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> mschwern [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #34438] Multiple XS files with c_source causes relink</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 26 Mar 2008 17:21:23 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Module-Build [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michael G Schwern &lt;schwern [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ken Williams via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=34438">http://rt.cpan.org/Ticket/Display.html?id=34438</a></span> &gt;
&gt; 
&gt; On Wed Mar 26 05:28:10 2008, MSCHWERN wrote:
<div class="message-stanza open">&gt;&gt; This is because link_c&#40;&#41; is linking each library against all the object
&gt;&gt; files.  process_support_files&#40;&#41; just puts all the object files into one
&gt;&gt; big list.
</div>&gt; 
&gt; Yeah, it&#39;s definitely the wrong thing to do.  It&#39;s been like that since the beginning of time, the 
&gt; idea was to support builds with an XS file and a few .c files, all going into one loadable XS 
&gt; module.  Obviously that one use case shouldn&#39;t have driven the entire design.  
&gt; 
&gt; What I think needs to happen is to let the author explicitly say which ingredients should get 
&gt; mixed into which XS build.
</div>
Is that necessary?  Don&#39;t they all get linked together in the end?


-- 
87. If the thought of something makes me giggle for longer than 15
     seconds, I am to assume that I am not allowed to do it.
     -- The 213 Things Skippy Is No Longer Allowed To Do In The U.S. Army
            <span class="clickylink"><a target="new" rel="nofollow" href="http://skippyslist.com/list/">http://skippyslist.com/list/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;12&nbsp;21:39:32&nbsp;2009</span>
    <span class="description">EWILHELM [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;12&nbsp;21:39:32&nbsp;2009</span>
    <span class="description">EWILHELM [...] cpan.org -  Severity Important changed to Unimportant</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;23&nbsp;15:24:29&nbsp;2009</span>
    <span class="description">dagolden [...] cpan.org -  Subject changed from &#39;Multiple XS files with c_source causes relink&#39; to &#39;[PATCH] Multiple XS files with c_source causes relink&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
