<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #16595 for Tk: Bug in encGlue.c:CallEncode causes TCL_Panic</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #16595 for Tk: Bug in encGlue.c:CallEncode causes TCL_Panic</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Tk/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Tk/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Tk/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Tk/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Tk">Tk CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">16595</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Tk/Active/">Tk</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">NI-S [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
coyote.frank [...] gmx.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-33610-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
804.027    </td>
  </tr>
  <tr id="CF-33611-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;19&nbsp;04:14:16&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Bug in encGlue.c:CallEncode causes TCL_Panic</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">System: Tk800_027, perl5.8.7, Debian Sarge, KDE

While tracking back a TCL_Panic when deleting a large selection
in a TK::Text &#40;see
<span class="clickylink"><a target="new" rel="nofollow" href="http://groups.google.com/group/comp.lang.perl.tk/browse_thread/thread/af1150eec445ccdf&#41;">http://groups.google.com/group/comp.lang.perl.tk/browse_thread/thread/af1150eec445ccdf&#41;</a></span>
I stumbled over the following code in encGlue.c.

    677   quiet = get_sv&#40;&#34;Tk::encodeFallback&#34;,0&#41;;
    ...
    723    PUSHMARK&#40;sp&#41;;
    724    XPUSHs&#40;PerlEncObj&#40;encoding&#41;&#41;;
    725    XPUSHs&#40;stmp&#41;;
    726    XPUSHs&#40;quiet&#41;;
    727    PUTBACK;
    728    perl_call_method&#40;method,G_SCALAR|G_EVAL&#41;;
    ...
    745    if &#40;SvCUR&#40;stmp&#41;&#41;
    746     {
    747      /* This could also be TCL_CONVERT_MULTIBYTE - how do we tell ? */
    748      code = TCL_CONVERT_UNKNOWN;
    749      break;
    750     }

If I understand this right this would call

    $encoding-&gt;encode&#40; $string, 0 &#41;

unless Tk:encodeFallback is set and expect it to delete the encodes chars
from string or fail with TCL_CONVERT_UNKNOWN &#40;check in line 745&#41; which
will cause the TCL_Panic later in my case.
$encoding is a Encode::Encoding object &#40;Encode::utf8 in my case&#41; and
reading the Encode::Encoding manpage it says

 | -&gt;encode&#40;$string [,$check]&#41;
 |    MUST return the octet sequence representing $string.
 |
 |    * If $check is true, it SHOULD modify $string in place to remove
 |      the converted part &#40;i.e.  the whole string unless there is an
 |      error&#41;.  If perlio_ok&#40;&#41; is true, SHOULD becomes MUST.
 |
 |    * If an error occurs, it SHOULD return the octet sequence for the                         
 |      fragment of string that has been converted and modify $string in-
 |      place to remove the converted part leaving it starting with the
 |      problem fragment.  If perlio_ok&#40;&#41; is true, SHOULD becomes MUST.
 |
 |    * If $check is is false then &#34;encode&#34; MUST  make a &#34;best effort&#34; to
 |      convert the string - for example, by using a replacement charac-
 |      ter.            
    
So there is no description what should happen with $string in case $check
is 0 false and conversion was OK. In fact Encode::utf8-&gt;encode&#40; $string,0 &#41;
just returns the converting string and leaves $string unchanged. Thus
the test in line 745 will fail even if everything was correct.

If I set $Tk::encodeFallback to true everything is fine, no panic occurs.         
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;19&nbsp;15:31:11&nbsp;2005</span>
    <span class="description">NI-S [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;19&nbsp;15:47:26&nbsp;2005</span>
    <span class="description">NI-S [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> dankogai [...] dan.co.jp</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I closed 16596 and 16597 which seemed to be identical?

I think your analysis is correct.
Although I wrote the original Encode module &#40;for perl/Tk&#41;
it has since been taken over and generalized a bit and API 
has changed - the way check argument works in particular.
As I recall a number of people were upset that the source string 
was modified. 

Because Encode was in a state of flux when Tk was released 
the idea of the C code you quoted is that $Tk::encodeFallback
is passed as the check argument.
This is initialized as &#40;in my copy&#41;:

./Tk.pm:23: $Tk::encodeFallback    = Encode::FB_PERLQQ&#40;&#41;;

So the problem should be fixable by a patch to just the perl code
and a workround should be to set 

 $Tk::encodeFallback = ...;

in your code, to something that works with your perl/Encode.

So now we are left studying the various incarnations of Encode
and deciding which is the best value for Tk to use.
It does not help that various different encodings treated 
value of check rather differently. 

The perlio flag was added as encoding layers &#40;which were also mine
originally&#41; assume&#40;d&#41; encodings work like I originally intended 
them to rather than how they did work at the time.

So it may be that setting $Tk::encodeFallback to perlio mode 
will suffice.

I have Cc:ed the current Encode maintainer.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;19&nbsp;15:47:27&nbsp;2005</span>
    <span class="description">NI-S [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
