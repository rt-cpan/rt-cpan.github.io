<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #130722 for PDF-API2: Crash during -&gt;openpage</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #130722 for PDF-API2: Crash during -&gt;openpage</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/PDF-API2/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/PDF-API2">PDF-API2 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">130722</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/PDF-API2/Active/">PDF-API2</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
joe [...] printevolved.co.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24958-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24959-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;17&nbsp;07:02:32&nbsp;2019</span>
    <span class="description">joe [...] printevolved.co.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Crash during -&gt;openpage</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 17 Oct 2019 11:02:11 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> joe &lt;joe [...] printevolved.co.uk&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
See my pull request here: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/ssimms/pdfapi2/pull/21">https://github.com/ssimms/pdfapi2/pull/21</a></span>

But I experienced a crash due to find_prop trying to bubble up to it&#39;s 
parent when that was a PDF::API2::Basic::PDF::Objind:

perl -MPDF::API2 -E &#39;
my $p = PDF::API2-&gt;open&#40;&#34;anon_file_328374.pdf&#34;&#41;; $p-&gt;openpage&#40;2&#41;&#39;
Can&#39;t locate object method &#34;find_prop&#34; via package 
&#34;PDF::API2::Basic::PDF::Objind&#34; at 
/usr/local/share/perl/5.26.1/PDF/API2/Basic/PDF/Pages.pm line 271.

My pull request basically stops this from happening by checking that 
&#34;parent&#34; is capable of find_prop before proceeding with that.

I can&#39;t supply the original data unfortunately because it&#39;s not mine, 
but I can test any alternative fixes or what have you if that helps.

Cheers,
Joe
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;18&nbsp;13:53:59&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I looked at this in PDF::Builder, but without a failing PDF file to try, I&#39;m reluctant to put your fix in my code. It doesn&#39;t appear that the fix could cause any problem, BUT, without understanding WHY the property isn&#39;t found &#40;??&#41; in the first place, this may be just slapping a Band-Aid over a machete wound. If the basic problem is that the PDF is defective in calling for some &#34;property&#34; but failing to include that property &#40;??&#41;, it might be good to also issue a warning to the user, so they&#39;re aware that they&#39;re working with a defective PDF. I presume that this PDF loads OK in something like Acrobat Reader? Such readers often do a lot of fixup and will happily load a bad PDF file without saying anything. WHY it would fail to find the find_prop&#40;&#41; method &#40;rather than a missing property&#41; would require a defective PDF to trigger the error do it could be traced through. Is there any chance you could provide a public test case?

I ran the t-test on my existing PDF::Builder implementation &#40;without your patch&#41;, and got

1..2
not ok 1 - Did not explode
#   Failed test &#39;Did not explode&#39;
#   at desktop\rt130722.t line 17.
# Can&#39;t locate object method &#34;find_prop&#34; via package &#34;PDF::Builder::Basic::PDF::Objind&#34; at C:/Strawberry/perl/site/lib/PDF/Builder/Basic/PDF/Pages.pm line 340.
ok 2 - Did opt get anything back
# Looks like you failed 1 test of 2.

However, running the two-line Perl code you gave, with a known good 12 page PDF, did not result in any messages.

By the way, what PDF::API2 version, running under what Perl version?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;18&nbsp;13:54:00&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;18&nbsp;16:58:10&nbsp;2019</span>
    <span class="description">joe [...] printevolved.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #130722] Crash during -&gt;openpage</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 18 Oct 2019 21:58:03 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> joe &lt;joe [...] printevolved.co.uk&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Is there any chance you could provide a public test case?
</div>
I&#39;ll see what I can do. Sadly the PDF that causes the problem belongs to 
a customer. Also when I tried processing it it fixed the problem so it&#39;s 
tricky.

I&#39;ll have a fish and see if I can get the thing to fail with something I 
can give you.

I have no doubt it&#39;s the PDF at fault, I don&#39;t know about acrobat off 
hand but it loads in evince. I could have a look at loading it with 
PDFBOX in Java or something like that. It&#39;d be nice if it generated a 
helpful error message that would illuminate things.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; By the way, what PDF::API2 version, running under what Perl version?
</div>In production I am running Perl v5.20.2 + PDF::API2 2.033. However I 
also reproduced it with Perl 5.26.1 and the latest github HEAD PDF::API2 
from before my fork.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;18&nbsp;17:34:31&nbsp;2019</span>
    <span class="description">joe [...] printevolved.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #130722] Crash during -&gt;openpage</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 18 Oct 2019 22:34:15 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> joe &lt;joe [...] printevolved.co.uk&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
By carefully hand deleting objects  I&#39;ve managed to get the attached to 
a state where:

 1. It&#39;s not got anything much in it..
 2. But it still shows fine in a PDF viewer
 3. And still crashes in the same way when I run:

perl -MPDF::API2 -E &#39;PDF::API2-&gt;open&#40;&#34;afhacked.pdf&#34;&#41;-&gt;openpage&#40;2&#41;&#39;

I hope this helps?

Thanks,

Joe
</div></div>

<div class="messagebody">
</div>
</div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;18&nbsp;21:04:03&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hmm. If I take your afhacked.pdf and open it in Adobe Acrobat Reader, it does modify &#40;fix&#41; it, as it asks me to save it when closing the Reader. However, when I run your sample program &#40;the openpage&#41;, it gives me:

C:\Users\Phil\Desktop&gt;rt130722.pl
Can&#39;t call method &#34;realise&#34; on an undefined value at C:/Strawberry/perl/site/lib/PDF/Builder.pm line 475.

That appears to be a different error than you&#39;re reporting &#40;your patch is not installed&#41;. You confirm that this PDF still produces the find_prop error in unpatched PDF::API2? I would prefer to find what the problem is in the PDF, and report that back to the user, rather than just blindly suppressing the error &#40;either the find_prop or this &#34;realise&#34; error&#41;. Anyway, it&#39;s in open_scalar&#40;&#41;, and is trying to realise&#40;&#41; on the opened PDF&#39;s &#39;Root&#39; member, which is apparently undefined. If I can track it down, the fix might be different for Builder than API2, but might still provide help in fixing API2.

Looking at the PDF file in gVim, I see that it was produced with InDesign, possibly as a number of single pages that were then combined? There&#39;s a lot of binary data, which I might be able to uncompress with PDFtk, although if there is an error in the PDF, that could corrupt the uncompression of the streams.

As our code as apparently diverged somewhat, Steve might taking any Builder-specific discussion over to PDF::Builder &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/PhilterPaper/Perl-PDF-Builder/issues/108">https://github.com/PhilterPaper/Perl-PDF-Builder/issues/108</a></span> or <span class="clickylink"><a target="new" rel="nofollow" href="https://www.catskilltech.com/forum/open-bugs/rt-130722-crash-during-gtopenpage/msg702/&#41;">https://www.catskilltech.com/forum/open-bugs/rt-130722-crash-during-gtopenpage/msg702/&#41;</a></span>.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;19&nbsp;04:36:06&nbsp;2019</span>
    <span class="description">joe [...] printevolved.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #130722] Crash during -&gt;openpage</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 19 Oct 2019 09:34:59 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> joe &lt;joe [...] printevolved.co.uk&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry, I think I&#39;ve confused the issue. I now get a Malformed xref in 
PDF file from that file. I&#39;ll have to try again to make a safe-to-send 
version. I could swear I double checked this yesterday but the evidence 
is against me.

I&#39;ll see what I can do.

You might have given me a steer with your idea of uncompressing it, that 
might make picking out the sensitive parts easier.
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;19&nbsp;05:06:02&nbsp;2019</span>
    <span class="description">joe [...] printevolved.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #130722] Crash during -&gt;openpage</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 19 Oct 2019 10:05:53 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> joe &lt;joe [...] printevolved.co.uk&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">

Okay I think this actually achieves what I said I&#39;d done yesterday, no 
sensitive data and with the version of PDF::API2 included in my linux 
distro:

perl -MPDF::API2 -E &#39;PDF::API2-&gt;open&#40;&#34;afhacked2.pdf&#34;&#41;-&gt;openpage&#40;2&#41;&#39;
Can&#39;t locate object method &#34;find_prop&#34; via package 
&#34;PDF::API2::Basic::PDF::Objind&#34; at 
/usr/local/share/perl/5.26.1/PDF/API2/Basic/PDF/Pages.pm line 271.

&#40;that being perl v5.26.1 and PDF::API2 2.036&#41;

With my patched version &#40;although my hackery seems to have added an 
extra warning&#41;:

  perl -I ~/code/perl/pdfapi2/lib/ -MPDF::API2 -E 
&#39;PDF::API2-&gt;open&#40;&#34;afhacked2.pdf&#34;&#41;-&gt;openpage&#40;2&#41;&#39;
Use of uninitialized value $dat in string at 
/home/joe/code/perl/pdfapi2/lib/PDF/API2/Basic/PDF/Filter/FlateDecode.pm 
line 42.

This time I removed the objects that I think contained the customer data 
and used qpdf to make the pdf vaguely usable again. Whatever qpdf is 
doing doesn&#39;t destroy the actual problem, which in this case is good.

Sorry for all the dancing around.
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;19&nbsp;11:50:26&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">OK, I&#39;m back to the &#34;find_prop&#34; error with the new PDF. I&#39;ll try to poke around and see what I can find, but no promises of when I can get to it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;26&nbsp;23:18:59&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The Rotate property appears to be uncommon in PDF::API2, although it is possible to add it &#40;rotate method&#41;. Your PDF has it in the top level of the page &#40;type Page&#41;, which is a child of type Pages. Every openpage&#40;&#41; is going to look for the Rotate property, so this code must have been exercised many times before without error. There must be something unusual about the structure of this particular PDF, at least compared to what PDF::API2 is used to working with. I don&#39;t think it&#39;s the presence &#40;or absence&#41; of the Rotate property itself, as the call to find_prop&#40;&#41; is failing to find the method in the first place. It looks like some odd class hierarchy where somewhere up the chain of recursively looking &#40;in the Parent&#41; for a property, a parent class doesn&#39;t support find_prop. In this case, we are in the proper class the first time &#40;we DO get to run find_prop&#41;, but its immediate parent&#39;s class lacks that method. I&#39;m guessing that our starting class level is somewhere below Page &#40;which has the Rotate property&#41;.

While your patch DOES sidestep the problem &#40;by terminating the upward search early&#41;, I&#39;m still concerned about whether it&#39;s the right approach. It may be valid if the basic problem is that an unexpected class is the Parent &#40;one that doesn&#39;t support find_prop&#41;, but I&#39;d be more comfortable if Steve could give his thoughts on it. We can see that the Page includes the Rotate property &#40;value 0&#41;, so where are we starting to look, and failing before we get to this Page object &#40;if that&#39;s what&#39;s happening&#41;?

I&#39;m going to set this aside for now, until there&#39;s been some more discussion. If nothing happens for a long time, I&#39;ll go ahead and put it in PDF::Builder &#40;it&#39;s better than nothing, although I&#39;m not comfortable that I fully understand the root causes&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;28&nbsp;05:34:42&nbsp;2019</span>
    <span class="description">joe [...] printevolved.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #130722] Crash during -&gt;openpage</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 28 Oct 2019 09:34:23 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> joe &lt;joe [...] printevolved.co.uk&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks very much for spending time on this.

I suppose how valid this situation is is kind-of the nub as to whether 
dodging it &#40;like I did&#41; or perhaps throwing a more clear error is the 
better solution. Almost every PDF tool I tried on the original tolerated 
it on load, but of course almost every PDF tool also corrected &#40;except 
qpdf&#41; it on save .

I don&#39;t &#40;yet&#41; understand enough about this level of PDF structure to 
contribute much, but I might while you are waiting for clarity on this 
try and use this as an excuse to dig deeper.

Thanks again.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;28&nbsp;09:35:37&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The question is then whether this shows a flaw in the PDF &#40;in which case an error message should be given, and fixup done if possible&#41;, or is PDF::API2 mishandling a legitimate situation and needs to be fixed. You say that many readers fix up and save the PDF, so it sounds more like the former &#40;PDF flaw&#41;. In that case, what are we looking for &#40;to flag&#41; in the PDF? Is encountering a class with missing find_prop&#40;&#41; enough? What is the error message that should be output &#40;something that a user could take action on&#41;? Is there any fixup that can be done?

This is getting in a bit over my head, WRT to my PDF skills and knowledge.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;07&nbsp;05:19:49&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Please note, these PDF files are invalid. In &#34;afhacked2.pdf&#34;, &#34;Pages&#34; root is object 4; and &#34;Parent&#34; of 1st page refers, correctly, to object 4. But &#34;Parent&#34; of 2nd page refers to some rogue dictionary object 9. Which, though happens to have same content as object 4, doesn&#39;t belong to pages tree, and so it&#39;s not 2nd page&#39;s legitimate parent, but an impostor. Same picture, different object numbers, in &#34;afhacked.pdf&#34;.

I asked someone to export a 2-pages PDF file from InDesign for me, and of course it has no such issues. I strongly suspect there was some messing around with internals, copy-pasting or similar. Though maybe a bug of particular ID version.

Why no other PDF consumer complained or even noticed? Well, e.g. offending line, instead of:

    { return $self-&gt;{&#39;Parent&#39;}-&gt;find_prop&#40;$prop&#41;; }

could be:

    { return find_prop&#40;$self-&gt;{&#39;Parent&#39;}, $prop&#41;; }

i.e. valid procedural Perl, and search for a &#34;property&#34; would bubble as intended, as opposed to aborted search in case of proposed patch. All depends on internal world-view and hierarchy of other apps. I didn&#39;t investigate thoroughly, but, staying with Perl:

perl -MCAM::PDF -E &#34;CAM::PDF-&gt;new&#40;&#39;afhacked2.pdf&#39;&#41;-&gt;_buildNameTable&#40;2&#41;&#34;

is OK. At first glance, this method bubbles up looking for resources, same as &#34;find_prop&#34;. It just happens that Pages root or intermediate nodes don&#39;t have additional magick attached to them, as in PDF::API2. It&#39;s neither good nor bad, just design decision and simply a given, in my opinion. The lib serves its purpose. I can think of hundreds&#40;?&#41; of ways to break a &#34;valid&#34; PDF file, if tinkered with at low-level, so maybe even Adobe Reader would crash ungraciously. Perhaps it&#39;s too much &#34;defensive&#34; to anticipate everything which is tiny percent of cases, sometimes try/catch at library user side is OK. Maybe I&#39;m wrong. And, yes, I did my lot of in-house patching to deal with in-flow of broken PDF files from same &#34;dear&#34; customers. It&#39;s just these patches are not universal.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;07&nbsp;06:00:20&nbsp;2019</span>
    <span class="description">joe [...] printevolved.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #130722] Crash during -&gt;openpage</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 7 Nov 2019 11:00:06 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> joe &lt;joe [...] printevolved.co.uk&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; And, yes, I did my lot of in-house patching to deal with in-flow of broken PDF files from same &#34;dear&#34; customers. It&#39;s just these patches are not universal.
</div>
I can understand that point of view 100%. I&#39;ve always thought this was a 
faulty PDF. The only reason we tried to get this in, is A&#41; we have 
patched this on our side so we&#39;d ideally not like to stay on a divergent 
path, but also B&#41; because acrobat &#38; everything else we tried worked with 
this PDF and PDF::API2 did not.

I know that&#39;s fairly arbitrary!

In the long term I&#39;m not even sure we&#39;ll see another PDF broken this way.

Given all this I&#39;d not be put out at all if you close my bug and my pull 
request, I just thought it worth raising in case wiser minds than mine 
found any value here. I don&#39;t think that&#39;s the case, except for as I say 
the entropy of the universe can make a PDF which 90% of PDF parsers will 
read and fix and PDF::API2 crashes on.
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;07&nbsp;10:26:47&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; acrobat &#38; everything else we tried worked with this PDF and PDF::API2 did not.
</div>
The nub of this is: what is &#34;works with&#34;? If a Reader &#40;like Acrobat&#41; FIXES UP a broken PDF &#40;and usually, asks permission to save it&#41;, that indicates that the original PDF is indeed defective. I would not call that &#34;works with&#34; &#40;&#34;tolerates&#34;, perhaps&#41;. At best, everything but PDF::API2 &#40;and Builder&#41; successfully fix a broken PDF. I will be happy to add detection &#40;with message&#41; and fixup to PDF::Builder if I can find what the problem is &#40;just a bad parent? always blame parenting!&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; make a PDF which 90% of PDF parsers will read and fix and PDF::API2 crashes on.
</div>
Again, a broken PDF is a broken PDF. It should not be silently passed or fixed up, but the user should at least be notified that something fishy was found &#40;in case further problems arise from either the flaw or the fix&#41;. Vadim&#39;s parental fixup is OK, *if* at first the error can be found and reported &#40;perhaps check links to all Kids, and see if all report back to the same Parent?&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;08&nbsp;16:39:18&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Following Vadim&#39;s lead, I followed the child/parent leads through afhacked2.pdf. It&#39;s a mess. Object 4 &#40;Pages&#41; points to its children Page objects 5 and 6. Object 5 points back to 4 as its Parent, while 6 points back to 9! It should also be 4. I changed object 6&#39;s Parent from 9 to 4, and got rid of objects 9 and 13, which weren&#39;t used by anyone. When run with your openpage&#40;&#41; code, I got a complaint about an undefined $dat in FlateDecode.pm, so I got rid of /Contents 8 0 R in object 6, and object 8 &#40;a FlateDecode Filter of Length 0&#41;. Now it runs without error message.

So, what happened to this PDF? If this was just the result of someone manually editing a PDF file, or a home-brew modifier, I&#39;m reluctant to add any code to check for these link problems, as it&#39;s probably a one-off. On the other hand, if a commercial product produced the bad PDF &#40;and no hand editing was done&#41;, it might be worth adding checks and fixes for this problem, as it will likely be fairly widespread.

Anyway, could you look inside the original PDF with an editor &#40;such as gViM&#41; and follow the Kids and Parents links, and see where they went off the rails? Is this PDF untouched from the time some commercial product produced it, or has someone messed with it?
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
