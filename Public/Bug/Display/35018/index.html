<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #35018 for File-Fetch: Treat HTTP 404 Message as File with lynx</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #35018 for File-Fetch: Treat HTTP 404 Message as File with lynx</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/File-Fetch/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/File-Fetch/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/File-Fetch/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/File-Fetch/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/File-Fetch">File-Fetch CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">35018</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/File-Fetch/Active/">File-Fetch</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
imacat [...] mail.imacat.idv.tw

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-12772-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.14    </td>
  </tr>
  <tr id="CF-12773-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;14&nbsp;12:21:59&nbsp;2008</span>
    <span class="description">imacat [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Treat HTTP 404 Message as File with lynx</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dear Jos Boumans,

    Hi.  This is imacat from Taiwan.  I found that your File-Fetch-0.14
fetches the HTTP 404 error page as the file when lynx is used.  It seems
that, because lynx does not return bad code with HTTP 404, it cannot
distinguish between successful or failed download and always return as
success.  This causes ambiguous information to the caller application,
such as CPANPLUS.  CPANPLUS will always gets the fake file even if the
file does really not exist, and deal with it consequently.

    I think this is a bit serious.  I would suggest you that, in
_lynx_fetch&#40;&#41;, try a &#34;-head&#34; request first, and process further only on
200 OK, to avoid such a problem. 

    The terminal log is attached below.  Hope that this helps.  Please
tell me if you need any more information, or if I could be of any help.
 Thank you.

imacat@rinse /tmp/t % ls -a
.  ..
imacat@rinse /tmp/t % perl -v

This is perl, v5.8.8 built for x86_64-linux-thread-multi-ld

Copyright 1987-2006, Larry Wall

Perl may be copied only under the terms of either the Artistic License
or the
GNU General Public License, which may be found in the Perl 5 source kit.

Complete documentation for Perl, including FAQ lists, should be found on
this system using &#34;man perl&#34; or &#34;perldoc perl&#34;.  If you have access to the
Internet, point your browser at <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perl.org/">http://www.perl.org/</a></span>, the Perl Home Page.

imacat@rinse /tmp/t % perl -mFile::Fetch -e&#39;exit 1 unless
File::Fetch-&gt;new&#40;uri=&gt;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/nosuchfile">http://localhost/nosuchfile</a></span>&#34;&#41;-&gt;fetch;&#39;
Fetch failed! HTTP response: 404 Not Found [404 Not Found] at -e line 1
Command failed:  at -e line 1
imacat@rinse /tmp/t % echo $?
0
imacat@rinse /tmp/t % ls -a
.  ..  nosuchfile
imacat@rinse /tmp/t % cat nosuchfile
&lt;!DOCTYPE HTML PUBLIC &#34;-//IETF//DTD HTML 2.0//EN&#34;&gt;
&lt;html&gt;&lt;head&gt;
&lt;title&gt;404 Not Found&lt;/title&gt;
&lt;/head&gt;&lt;body&gt;
&lt;h1&gt;Not Found&lt;/h1&gt;
&lt;p&gt;The requested URL /nosuchfile was not found on this server.&lt;/p&gt;
&lt;hr&gt;
&lt;address&gt;Apache/2.2.6 &#40;Unix&#41; mod_ssl/2.2.6 OpenSSL/0.9.8g
mod_bwshare/0.2.0 mod_perl/2.0.3 Perl/v5.8.8 Server at localhost Port
80&lt;/address&gt;
&lt;/body&gt;&lt;/html&gt;
imacat@rinse /tmp/t %
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;16&nbsp;22:01:57&nbsp;2008</span>
    <span class="description">imacat [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dear Jos Boumans,

    Hi.  This is imacat from Taiwan.  I made a simple patch against
File-Fetch-0.14, to make it tries to make a HEAD request first and fails
if not receiving an 200 OK status.  Hope that this helps.  Please tell
me if you need any more information, or if I could be of any help. 
Thank you.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

diff -u -r File-Fetch-0.14.orig/lib/File/Fetch.pm File-Fetch-0.14/lib/File/Fetch.pm
- --- File-Fetch-0.14.orig/lib/File/Fetch.pm	2007-12-14 20:41:01.000000000 +0800
+++ File-Fetch-0.14/lib/File/Fetch.pm	2008-04-17 09:57:33.000000000 +0800
@@ -717,6 +717,37 @@
                 &#39;lynx&#39; &#41;&#41;;
         }            
 
+        ### check if the HTTP resource exists ###
+        if &#40;$self-&gt;uri =~ /^https?:\/\//i&#41; {
+            my $cmd = [
+                $lynx,
+                &#39;-head&#39;,
+                &#39;-source&#39;,
+                &#34;-auth=anonymous:$FROM_EMAIL&#34;,
+            ];
+
+            push @$cmd, &#34;-connect_timeout=$TIMEOUT&#34; if $TIMEOUT;
+
+            ### DO NOT quote things for IPC::Run, it breaks stuff.
+            push @$cmd, $IPC::Cmd::USE_IPC_RUN
+                            ? $self-&gt;uri
+                            : QUOTE. $self-&gt;uri .QUOTE;
+
+
+            ### shell out ###
+            my $head;
+            unless&#40;run&#40; command =&gt; $cmd,
+                        buffer  =&gt; \$head,
+                        verbose =&gt; $DEBUG &#41;
+            &#41; {
+                return $self-&gt;_error&#40;loc&#40;&#34;Command failed: %1&#34;, $head || &#39;&#39;&#41;&#41;;
+            }
+
+            unless&#40;$head =~ /^HTTP\/\d+\.\d+ 200\b/&#41; {
+                return $self-&gt;_error&#40;loc&#40;&#34;Command failed: %1&#34;, $head || &#39;&#39;&#41;&#41;;
+            }
+        }
+
         ### write to the output file ourselves, since lynx ass_u_mes to much
         my $local = FileHandle-&gt;new&#40;&#34;&gt;$to&#34;&#41;
                         or return $self-&gt;_error&#40;loc&#40;
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 &#40;GNU/Linux&#41;

iEYEARECAAYFAkgGrroACgkQi9gubzC5S1y4/wCgpfSE/olPl8KBe01VLrApk+NZ
hPUAoJpBPOcz9b08vCJmgk88rMqfoJXA
=unxT
-----END PGP SIGNATURE-----
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;16&nbsp;22:02:03&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;19&nbsp;09:03:03&nbsp;2008</span>
    <span class="description">kane [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Apr 16 22:01:57 2008, IMACAT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dear Jos Boumans,
&gt; 
&gt;     Hi.  This is imacat from Taiwan.  I made a simple patch against
&gt; File-Fetch-0.14, to make it tries to make a HEAD request first and fails
&gt; if not receiving an 200 OK status.  Hope that this helps.  Please tell
&gt; me if you need any more information, or if I could be of any help. 
&gt; Thank you.
</div>
Thanks, applied
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;19&nbsp;09:03:05&nbsp;2008</span>
    <span class="description">kane [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
