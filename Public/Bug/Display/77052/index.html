<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #77052 for libnet: Compensate for bad PASV response</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #77052 for libnet: Compensate for bad PASV response</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/libnet/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/libnet/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/libnet/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/libnet/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/libnet">libnet CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">77052</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/libnet/Active/">libnet</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
chris_carr [...] bitcard.ccarr.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-18284-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-18285-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;07&nbsp;18:21:09&nbsp;2012</span>
    <span class="description">chris_carr [...] bitcard.ccarr.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Compensate for bad PASV response</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Some mis-configured FTP servers, not realizing that they are behind a
firewall, will send a non-routable address in response to the PASV
command. E.g.:

Net::FTP=GLOB&#40;0x21582d8&#41;&gt;&gt;&gt; PASV
Net::FTP=GLOB&#40;0x21582d8&#41;&lt;&lt;&lt; 227 Entering Passive Mode &#40;10,0,0,253,126,206&#41;

I request that Net::FTP be extended so as to compensate for such
incorrect responses.

I have altered the _dataconn method of my local copy of Net/FTP.pm as
follows:

+   my $peerAddr = join&#40;&#34;.&#34;, @port[0 .. 3]&#41;;
+   if &#40;
+       $port[0] == 10 or                                           #
Class A unroutable
+       &#40;$port[0] == 172 and $port[1] &gt; 15 and $port[1] &lt; 32&#41; or    #
Class B unroutable
+       &#40;$port[0] == 192 and $port[1] == 168&#41; &#41; {                   #
Class C unroutable
+     carp &#34;Server sent us an unroutable address, $peerAddr, in the pasv
response. Use the server address instead.\n&#34;;
+     $peerAddr = ${*$ftp}{&#39;net_ftp_host&#39;};
+   }

    $data = $pkg-&gt;new&#40;
+     PeerAddr  =&gt; $peerAddr,
-     PeerAddr  =&gt; join&#40;&#34;.&#34;, @port[0 .. 3]&#41;,
      PeerPort  =&gt; $port[4] * 256 + $port[5],
      LocalAddr =&gt; ${*$ftp}{&#39;net_ftp_localaddr&#39;},
      Proto     =&gt; &#39;tcp&#39;
    &#41;;

I offer it to the community under the same license as libnet.

Note that it assumes that any private address is unroutable, which is
true in my case. To be generally useful, it should probably be
controlled by a parameter in the constructor.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;07&nbsp;18:25:53&nbsp;2012</span>
    <span class="description">gbarr [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #77052] Compensate for bad PASV response </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 7 May 2012 17:25:24 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-libnet [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Graham Barr &lt;gbarr [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Your suggested patch would break the use of Net::FTP for connecting to ftp servers that are on a local private network.

If the remote server is broken, or the firewall it is behind is not configured to rewrite this, then there is not much Net::FTP can do. The remote server or the firewall needs to be fixed

Graham.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;07&nbsp;18:25:54&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;07&nbsp;18:27:37&nbsp;2012</span>
    <span class="description">chris_carr [...] bitcard.ccarr.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> chris_carr [...] bitcard.ccarr.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon May 07 18:25:53 2012, gbarr@pobox.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Your suggested patch would break the use of Net::FTP for connecting to
&gt; ftp servers that are on a local private network.
&gt; 
&gt; If the remote server is broken, or the firewall it is behind is not
&gt; configured to rewrite this, then there is not much Net::FTP can do.
&gt; The remote server or the firewall needs to be fixed
&gt; 
&gt; Graham.
&gt; 
</div>

I agree. This is why I suggested adding a parameter to the constructor.

Chris
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;19&nbsp;04:40:16&nbsp;2013</span>
    <span class="description">juan.castillo [...] meteologica.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #77052]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 19 Nov 2013 10:40:01 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-libnet [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Juan Antonio Castillo Dayer &lt;juan.castillo [...] meteologica.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi all,

I&#39;ve used a similar solution to NcFTP Client program, in the same place
that the first message.
So the solution would be good for local private network too.

=============================================
   if &#40;defined ${*$ftp}{&#39;net_ftp_pasv&#39;}&#41; {
     my @port = map { 0 + $_ } split&#40;/,/, ${*$ftp}{&#39;net_ftp_pasv&#39;}&#41;;

+    my $peerAddr = join&#40;&#34;.&#34;, @port[0 .. 3]&#41;;
+
+    # To solve the control address to a control IP, for if it were a name.
+    my $controlAddr = inet_ntoa&#40;inet_aton&#40;${*$ftp}{&#39;net_ftp_host&#39;}&#41;&#41;;
+    # To Check the control address has been resolved and it has an IP
format.
+    if&#40;defined $controlAddr and $controlAddr =~
m/^&#40;\d&#41;{1,3}\.&#40;\d&#41;{1,3}\.&#40;\d&#41;{1,3}\.&#40;\d&#41;{1,3}$/&#41;{
+        # If the obtained from the PASV IP is different from the control IP,
I check if it belongs to a private IP range.
+        if&#40;$peerAddr ne $controlAddr&#41;{
+            # Private IPs ranges.
+            my @privateNetworks = qw&#40;192.168. 10. 172.16. 172.17. 172.18.
172.19. 172.20. 172.21. 172.22. 172.23. 172.24. 172.25. 172.26. 172.27.
172.28. 172.29. 172.30. 172.31. undef&#41;;
+            my $i;
+            for&#40;$i=0; defined $privateNetworks[$i]; $i++&#41;{
+                #  If the PASV IP matches with some pattern.
+                if&#40;substr&#40;$peerAddr, 0, length $privateNetworks[$i]&#41; eq
$privateNetworks[$i]&#41;{
+                        last;
+                    }
+                }
+
+            if&#40;defined $privateNetworks[$i] and substr&#40;$controlAddr, 0,
length $privateNetworks[$i]&#41; ne $privateNetworks[$i]&#41;{
+                # If the obtained by PASV IP is private, but the control
IP isn&#39;t private, I changed it.
+                carp &#34;Server sent us an unroutable address, $peerAddr, in
the PASV response. Use the server address instead &#40;$controlAddr&#41;&#34;;
+                $peerAddr = ${*$ftp}{&#39;net_ftp_host&#39;};
+            }
+        }
+    }
+
     $data = $pkg-&gt;new&#40;
-      PeerAddr  =&gt; join&#40;&#34;.&#34;, @port[0 .. 3]&#41;,
+      PeerAddr  =&gt; $peerAddr,
       PeerPort  =&gt; $port[4] * 256 + $port[5],
       LocalAddr =&gt; ${*$ftp}{&#39;net_ftp_localaddr&#39;},
       Proto     =&gt; &#39;tcp&#39;
     &#41;;
   }
=============================================

I believe that together we can improve this patch.

Regards,
Juan
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;29&nbsp;17:13:09&nbsp;2018</span>
    <span class="description">robby.desmond [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Would it not be prudent, to avoid a lot of checking back and forth whether it is a private address or not, to just check the IP returned from the initial connection &#40;an IP presumably exists as a result of logging into a server&#41; against the IP returned from PASV?

If they are different, assume a bad IP address from PASV and try the original connection IP.

Or am I missing something?
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
