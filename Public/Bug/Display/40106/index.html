<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #40106 for Test-Database: Temporary or cleaned databases should be the normal mode</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #40106 for Test-Database: Temporary or cleaned databases should be the normal mode</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Test-Database">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Test-Database">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Test-Database">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Test-Database">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Test-Database">Test-Database CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">40106</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Test-Database">Test-Database</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
MLAWREN [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-224118-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-224119-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=40106">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-520325" href="/Public/Bug/Display.html?id=40106#txn-520325">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;16&nbsp;14:08:27&nbsp;2008</span>
    <span class="description">MLAWREN [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Temporary or cleaned databases should be the normal mode</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/520325/259829/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/259829">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 866b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">My database tests typically require a fresh database, at a minimum for
the very first test, not necessarily for the rest. However
Test::Database by default always uses the same database which may be
&#39;dirty&#39; from the last run, or dirty from a previous Test::Database user
within another modules tests.

Test::Database &#40;or perhaps the individual Drivers&#41; should have a &#39;reset&#39;
or &#39;clean&#39; method to make sure that the database is empty. 

Alternatively, the _default_ case could always return a fresh database.
I think for SQLite this is easily done &#40;using File::Temp from my earlier
bug report&#41;. Or, the default case could return a database with a name
based on the distribution/module being tested.

For other database types I guess it is just a question of the right
permissions, but also how to clean up possibly many new databases.

Cheers,
Mark.
-- 
Mark Lawrence
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-520344" href="/Public/Bug/Display.html?id=40106#txn-520344">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;16&nbsp;14:32:53&nbsp;2008</span>
    <span class="description">MLAWREN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/520344/259835/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/259835">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just thinking this through a bit more, I think the documentation kind of
already specifies what I want, but doesn&#39;t actually do that in practice. 

How about the following suggestion for behaviour:

* For a single test that creates a fresh fresh database, which is
automatically cleaned up when the single test process exits &#40;perhaps via
an Test::Database::END block?&#41;:

    Test::Database-&gt;dbh&#40;&#39;SQLite&#39;&#41;

For SQLite the cleanup is easy. For things like MySQL it becomes
something like $dbh-&gt;do&#40;&#39;DROP TABLE * CASCADE&#39;&#41; or whatever the syntax is.


* For a multiple tests, using named databases, make the cleanup a manual
process:

    t/01-first-test.t
        Test::Database-&gt;reset&#40;&#39;SQLite&#39; =&gt; &#39;mydb&#39;&#41;
        Test::Database-&gt;dbh&#40;&#39;SQLite&#39; =&gt; &#39;mydb&#39;&#41;

    t/0?-middle-test.t
        Test::Database-&gt;dbh&#40;&#39;SQLite&#39; =&gt; &#39;mydb&#39;&#41;

    t/09-last-test.t
        Test::Database-&gt;dbh&#40;&#39;SQLite&#39; =&gt; &#39;mydb&#39;&#41;
        # the tests, and then
        END { 
            Test::Database-&gt;reset&#40;&#39;SQLite&#39; =&gt; &#39;mydb&#39;&#41;
        }

For SQLite the once again reset&#40;&#41; is easy. For things like MySQL it
becomes something like $dbh-&gt;do&#40;&#39;DROP DATABASE mydb&#39;&#41; or whatever the
syntax is.

Cheers,
Mark.
-- 
Mark Lawrence
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-520346" href="/Public/Bug/Display.html?id=40106#txn-520346">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;16&nbsp;14:32:55&nbsp;2008</span>
    <span class="description">MLAWREN [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-520682" href="/Public/Bug/Display.html?id=40106#txn-520682">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;17&nbsp;03:59:44&nbsp;2008</span>
    <span class="description">book [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/520682/260014/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/260014">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Oct 16 14:08:27 2008, MLAWREN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; My database tests typically require a fresh database, at a minimum for
&gt; the very first test, not necessarily for the rest. However
&gt; Test::Database by default always uses the same database which may be
&gt; &#39;dirty&#39; from the last run, or dirty from a previous Test::Database user
&gt; within another modules tests.
&gt; 
&gt; Test::Database &#40;or perhaps the individual Drivers&#41; should have a &#39;reset&#39;
&gt; or &#39;clean&#39; method to make sure that the database is empty. 
</div>
The method is called cleanup&#40;&#41;, and be called like this:

    Test::Database-&gt;cleanup&#40;&#41;;            # clean the whole directory
    Test::Database::Driver-&gt;cleanup;      # same as above
    Test::Database::Driver::Foo-&gt;cleanup; # clean only the driver&#39;s
directory


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Alternatively, the _default_ case could always return a fresh database.
&gt; I think for SQLite this is easily done &#40;using File::Temp from my earlier
&gt; bug report&#41;. Or, the default case could return a database with a name
&gt; based on the distribution/module being tested.
</div>
In a test suite, if one needs a clean database at the beginning, they&#39;ll
only need to ask for it in the first script, then all the others will
use the one that was setup first.
I think it&#39;s more practical that using the default in the first script,
and then explicitely request to *not* clean the database in the
following ones.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; For other database types I guess it is just a question of the right
&gt; permissions, but also how to clean up possibly many new databases.
&gt; 
&gt; Cheers,
&gt; Mark.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-520697" href="/Public/Bug/Display.html?id=40106#txn-520697">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;17&nbsp;04:34:12&nbsp;2008</span>
    <span class="description">book [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/520697/260027/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/260027">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Oct 16 14:32:53 2008, MLAWREN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Just thinking this through a bit more, I think the documentation kind of
&gt; already specifies what I want, but doesn&#39;t actually do that in practice. 
&gt; 
&gt; How about the following suggestion for behaviour:
&gt; 
&gt; * For a single test that creates a fresh fresh database, which is
&gt; automatically cleaned up when the single test process exits &#40;perhaps via
&gt; an Test::Database::END block?&#41;:
&gt; 
&gt;     Test::Database-&gt;dbh&#40;&#39;SQLite&#39;&#41;
&gt; 
&gt; For SQLite the cleanup is easy. For things like MySQL it becomes
&gt; something like $dbh-&gt;do&#40;&#39;DROP TABLE * CASCADE&#39;&#41; or whatever the syntax is.
&gt; 
</div>
In my opinion, the easiest way to cleanup the database that were fully 
created by Test::Database is to just drop the directory... Oh well,
you&#39;re right: with SQLite, I&#39;ll drop every database. So maybe we need
a way to drop a single database, by name.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; * For a multiple tests, using named databases, make the cleanup a manual
&gt; process:
&gt; 
&gt;     t/01-first-test.t
&gt;         Test::Database-&gt;reset&#40;&#39;SQLite&#39; =&gt; &#39;mydb&#39;&#41;
&gt;         Test::Database-&gt;dbh&#40;&#39;SQLite&#39; =&gt; &#39;mydb&#39;&#41;
&gt; 
&gt;     t/0?-middle-test.t
&gt;         Test::Database-&gt;dbh&#40;&#39;SQLite&#39; =&gt; &#39;mydb&#39;&#41;
&gt; 
&gt;     t/09-last-test.t
&gt;         Test::Database-&gt;dbh&#40;&#39;SQLite&#39; =&gt; &#39;mydb&#39;&#41;
&gt;         # the tests, and then
&gt;         END { 
&gt;             Test::Database-&gt;reset&#40;&#39;SQLite&#39; =&gt; &#39;mydb&#39;&#41;
&gt;         }
&gt; 
&gt; For SQLite the once again reset&#40;&#41; is easy. For things like MySQL it
&gt; becomes something like $dbh-&gt;do&#40;&#39;DROP DATABASE mydb&#39;&#41; or whatever the
&gt; syntax is.
</div>
Actually, I think I&#39;m going to discourage using named databases.

Here&#39;s the rationale:
- some databases are much harder to setup than SQLite or MySQL, and the
only way to reasonably provide one to modules for their test suite is by
having the machine owner &#40;CPAN tester?&#41; configure the available databases
- therefore I plan to add very soon the support for preconfigured
databases: either via an environment variable &#40;TEST_DSN, TEST_DSN\d+,
DBI_DSN, etc&#41;, or via explicit configuration &#40;Test::Database::Config,
probably&#41;

In this cases, one cannot know the name of the databases in advance,
and dropping them would not be very nice &#40;of course, dropping all the
tables is accepted&#41;.

It also makes the original goal of the module &#40;provide a standardized
way for test script to obtain a dbh to run their test suites in&#41; more
difficult to achieve.

&#40;But see my reply to #40104 for a more elaborate way to handle those cases.&#41;

Thank you very much for your input, I appreciate it a lot.

I&#39;ll write down the use cases, and we&#39;ll continue via email.

-- BooK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-520936" href="/Public/Bug/Display.html?id=40106#txn-520936">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;17&nbsp;17:58:01&nbsp;2008</span>
    <span class="description">nomad [...] null.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #40106] Temporary or cleaned databases should be the normal mode</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 17 Oct 2008 23:57:29 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Philippe &#39;BooK&#39; Bruhat via RT &lt;bug-Test-Database [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Lawrence &lt;nomad [...] null.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/520936/260173/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/260173">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 9.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Test::Database &#40;or perhaps the individual Drivers&#41; should have a &#39;reset&#39;
&gt; &gt; or &#39;clean&#39; method to make sure that the database is empty. 
</div>&gt; 
&gt; The method is called cleanup&#40;&#41;, and be called like this:
&gt; 
&gt;     Test::Database-&gt;cleanup&#40;&#41;;            # clean the whole directory
&gt;     Test::Database::Driver-&gt;cleanup;      # same as above
&gt;     Test::Database::Driver::Foo-&gt;cleanup; # clean only the driver&#39;s
&gt; directory
</div>
Woops. Sorry, not reading the entire documentation before posting. But
I think we both came to the same conclusion about it not making sense
to have a global -&gt;cleanup method.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In a test suite, if one needs a clean database at the beginning, they&#39;ll
&gt; only need to ask for it in the first script, then all the others will
&gt; use the one that was setup first.
&gt; I think it&#39;s more practical that using the default in the first script,
&gt; and then explicitely request to *not* clean the database in the
&gt; following ones.
</div>
You are right, I got this backwards.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; For SQLite the cleanup is easy. For things like MySQL it becomes
&gt; &gt; something like $dbh-&gt;do&#40;&#39;DROP TABLE * CASCADE&#39;&#41; or whatever the syntax is.
&gt; &gt; 
</div>&gt; 
&gt; In my opinion, the easiest way to cleanup the database that were fully 
&gt; created by Test::Database is to just drop the directory... Oh well,
&gt; you&#39;re right: with SQLite, I&#39;ll drop every database. So maybe we need
&gt; a way to drop a single database, by name.
&gt;
&gt; ...
&gt; 
&gt; Actually, I think I&#39;m going to discourage using named databases.
&gt; 
&gt; Here&#39;s the rationale:
&gt; - some databases are much harder to setup than SQLite or MySQL, and the
&gt; only way to reasonably provide one to modules for their test suite is by
&gt; having the machine owner &#40;CPAN tester?&#41; configure the available databases
</div>
I agree. But the same rationale says to me that start_server and
stop_server in Test::Database::Driver also shouldn&#39;t be part of this
distribution. The starting and stopping of database processes is very
operating system dependent, and not something that can easily be
defined in the &#40;to be determined Test::Database::Config&#41; configuration
file.

I know you&#39;ve said you&#39;ll write down the use cases and reply, but I&#39;m
in a different time zone so I&#39;ll raise the question now :-&#41; What should
the interface between the various components &#40;Author, Test::Database,
Tester&#41; be? I think it goes like this:


Portable SQL Test Writer
-------------------------

If the SQL is very simple and likely to be extrememly portable, and the
author wants to check against everything available then she doesn&#39;t
need to specify any specific drivers:

    # Case 1
    foreach my $driver &#40;Test::Database-&gt;drivers&#41; {
        # tests
    }

Non-Portable SQL Test Writer
----------------------------

Author knows &#40;or wants&#41; that their code will only work against a
specific subset of drivers, so they are specified:

    # Case 2
    foreach my $driver &#40;Test::Database-&gt;drivers&#40;&#39;SQLite&#39;, &#39;mysql&#39;&#41; {
        # tests
    }

Perhaps they want to include drivers specific to their local setup:

    # Case 3
    foreach my $driver &#40;Test::Database-&gt;drivers&#40;&#39;mysql&#39;, &#39;mysql4&#39;&#41; {
        # tests
    }

Perhaps they could specify negation instead:

    # Case 4
    foreach my $driver &#40;Test::Database-&gt;drivers&#40;&#39;!DBM&#39;&#41; {
        # tests
    }


Test::Database
--------------

At &#34;use Test::Database&#34; an internal drivers configuration is built
from:

    1. File-system based installed DBD::*

over-written with:

    2. Intersection of $HOME/.Test-Database and installed DBD::*



Default Case
------------

The result is something like this for the default tester case:

    %drivers = &#40;
        &#39;DBM&#39; =&gt; {
            driver =&gt; &#39;DBM&#39;,
            dsn  =&gt; &#39;dbi::DBM:t/Test-Database/DBM/DBM&#39;,
            user =&gt; &#39;&#39;,
            pass =&gt; &#39;&#39;,
        },
        &#39;SQLite&#39; =&gt; {
            driver =&gt; &#39;SQLite&#39;,
            dsn  =&gt; &#39;dbi::SQLite:t/Test-Database/SQLite/SQLite.db&#39;,
            user =&gt; &#39;&#39;,
            pass =&gt; &#39;&#39;,
        },
    &#41;;


Power Tester
------------
    
The result is something like this for tester who was good enough to
decide that they&#39;ll run MySQL as well.

    $ cat $HOME/.Test-Database
    name    = mysql
    dsn     = dbi::mysql:databse=test
    user    = myuser
    pass    = mypass


    %drivers = &#40;
        &#39;DBM&#39; =&gt; {
            driver =&gt; &#39;DBM&#39;,
            dsn  =&gt; &#39;dbi::DBM:t/Test-Database/DBM/DBM&#39;,
            user =&gt; &#39;&#39;,
            pass =&gt; &#39;&#39;,
        },
        &#39;SQLite&#39; =&gt; {
            driver =&gt; &#39;SQLite&#39;,
            dsn  =&gt; &#39;dbi::SQLite:t/Test-Database/SQLite/SQLite.db&#39;,
            user =&gt; &#39;&#39;,
            pass =&gt; &#39;&#39;,
        },
        &#39;mysql&#39; =&gt; {
            driver =&gt; &#39;mysql&#39;,
            dsn  =&gt; &#39;dbi::mysql:databse=test&#39;,
            user =&gt; &#39;myuser&#39;,
            pass =&gt; &#39;mypass&#39;,
        },
    &#41;;


Module Author
-------------
    
The result is something like this for module author who runs MySQL
version 4 on port 3307 in addition to the latest MySQL on the default
port:

    $ cat $HOME/.Test-Database
    name    = mysql
    dsn     = dbi::mysql:databse=test
    user    = myuser
    pass    = mypass

    name    = mysql4
    dsn     = dbi::mysql:databse=test;port=3307
    user    = myolduser
    pass    = myoldpass


    %drivers = &#40;
        &#39;DBM&#39; =&gt; {
            driver =&gt; &#39;DBM&#39;,
            dsn  =&gt; &#39;dbi::DBM:t/Test-Database/DBM/DBM&#39;,
            user =&gt; &#39;&#39;,
            pass =&gt; &#39;&#39;,
        },
        &#39;SQLite&#39; =&gt; {
            driver =&gt; &#39;SQLite&#39;,
            dsn  =&gt; &#39;dbi::SQLite:t/Test-Database/SQLite/SQLite.db&#39;,
            user =&gt; &#39;&#39;,
            pass =&gt; &#39;&#39;,
        },
        &#39;mysql&#39; =&gt; {
            driver =&gt; &#39;mysql&#39;,
            dsn  =&gt; &#39;dbi::mysql:databse=test&#39;,
            user =&gt; &#39;myuser&#39;,
            pass =&gt; &#39;mypass&#39;,
        },
        &#39;mysql4&#39; =&gt; {
            driver =&gt; &#39;mysql&#39;,
            dsn  =&gt; &#39;dbi::mysql:databse=test;port=3307&#39;,
            user =&gt; &#39;myolduser&#39;,
            pass =&gt; &#39;myoldpass&#39;,
        },
    &#41;;

    

Testing
-------

The result of Test::Database-&gt;drivers&#40;@list&#41; is clearly then the
intersection of &#34;@list&#34; with &#34;keys %drivers&#34; when @list is defined, and
&#34;keys %drivers&#34; otherwise.


Design Thoughts
---------------

There are two models: file-system based databases and non-file-system
based. If the interface between Test::Database and databases was
strictly limited to DBI/DBD functionality, and we ignore the whole
named database issue, then the entire Driver/* tree could be collapsed
into two, maybe even one, module.

    package Test::Database;

    # static list of predefined file-based DSNs
    %file_drivers = &#40;
        DBM =&gt; {
            file_based =&gt; 1,
            driver =&gt; &#39;DBM&#39;,
            dsn =&gt; &#39;dbi:DBM:f_dir=t/Test-Database/DBM&#39;,
            ...
        },
        SQLite =&gt; {
            file_based =&gt; 1,
            driver =&gt; &#39;SQLite&#39;,
            dsn =&gt; &#39;dbi:SQLite:t/Test-Database/DBM&#39;,
            ...
        }
    &#41;;

    # Dynamically generated at &#39;use&#39;
    %drivers = &#40;
        %file_drivers + $HOME/.Test-Database definitions,
    &#41;

    sub drivers {
        my @return     = &#40;&#41;;
        my @candidates = map {$drivers{$_}} @_;

        foreach my $c &#40;@candidates&#41; {
            if &#40;my $driver = Test::Database::Driver-&gt;new&#40;$c&#41;&#41; {
                push&#40;@return, $driver&#41;;
            }
        }

        return @return;
    }


And the above would work with:

    package Test::Database::Driver;

    sub new {
        my $proto = shift;
        my $class = ref&#40;$proto&#41; || $proto;
        my $self  = shift;

        # Doing this here saves Test::Database startup time? Maybe not.
        if &#40;!eval &#34;require DBD::$self-&gt;{driver}; 1;&#34;&#41; {
            return;
        }

        if &#40;$self-&gt;{file_based}&#41; {
            # mkdir t/Test-Database/$self-&gt;{driver}
        }

        # croak now if this fails?
        $self-&gt;{dbh} = DBI-&gt;connect&#40;
            $self-&gt;{dsn},
            $self-&gt;{username},
            $self-&gt;{password}
        &#41;;

        return bless&#40;$self,$class&#41;;
    }

    sub cleanup {
        my $self = shift;

        if &#40;$self-&gt;{file_based}&#41; {
            $self-&gt;{dbh}-&gt;disconnect&#40;&#41;;

            # rm -rf t/Test-Database/$self-&gt;{driver}
            # mkdir t/Test-Database/$self-&gt;{driver} exists

            $self-&gt;{dbh} = DBI-&gt;connect&#40;
                $self-&gt;{dsn},
                $self-&gt;{username},
                $self-&gt;{password}
            &#41;;
            
        }
        else {
            # DROP TABLE *
            # or maybe we do need Driver::&lt;driver&gt;. How do we find the
            # list of tables in the database? Does DBI provide such
            # functions? Otherwise $self-&gt;_cleanup&#40;&#41;;
        }
    }

    sub connection_info {
        my $self = shift;
        return &#40;$self-&gt;{dsn}, $self-&gt;{username}, $self-&gt;{password}&#41;;
    }

    sub dbh {
        my $self = shift;
        return $self-&gt;{dbh};
    }


Which then enables the following, which is more intuitive to me:

    foreach my $driver &#40;Test::Database-&gt;drivers&#40;&#39;SQLite&#39;, &#39;Pg&#39;&#41; {
        SQL::DB-&gt;connect&#40;$driver-&gt;connection_info&#41;;
        # or
        SQL::DB-&gt;set_dbh&#40;$driver-&gt;dbh&#41;;

        ok&#40;...., &#39;test name&#39;&#41;
    }


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thank you very much for your input, I appreciate it a lot.
</div>
I hope I haven&#39;t gone too far with this mail. However regardless of the
outcome, the effort is gladly given, because I will definately
appreciate Test::Database when it&#39;s finished!

Cheers,
Mark.
-- 
Mark Lawrence
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-520951" href="/Public/Bug/Display.html?id=40106#txn-520951">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;17&nbsp;18:29:10&nbsp;2008</span>
    <span class="description">nomad [...] null.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #40106] Temporary or cleaned databases should be the normal mode</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 18 Oct 2008 00:05:58 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Philippe &#39;BooK&#39; Bruhat via RT &lt;bug-Test-Database [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Lawrence &lt;nomad [...] null.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/520951/260179/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/260179">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 802b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Oct 17, 2008 at 11:57:29PM +0200, Mark Lawrence wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Which then enables the following, which is more intuitive to me:
&gt; 
&gt;     foreach my $driver &#40;Test::Database-&gt;drivers&#40;&#39;SQLite&#39;, &#39;Pg&#39;&#41; {
&gt;         SQL::DB-&gt;connect&#40;$driver-&gt;connection_info&#41;;
&gt;         # or
&gt;         SQL::DB-&gt;set_dbh&#40;$driver-&gt;dbh&#41;;
&gt; 
&gt;         ok&#40;...., &#39;test name&#39;&#41;
&gt;     }
</div>
I just thought of something else. The SYNOPSIS for Test::Database
should actually be something like this, in the interests of making a
good test plan:

    use Test::More;
    use Test::Database;

    my @drivers = Test::Database-&gt;drivers&#40;&#39;SQLite&#39;, &#39;Pg&#39;&#41;;
    plan tests =&gt; @drivers * 3;

    foreach my $driver &#40;@drivers&#41; {
        ok&#40;....&#41;; # test 1
        ok&#40;....&#41;; # test 2
        ok&#40;....&#41;; # test 3
    }


Cheers,
Mark.
-- 
Mark Lawrence
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-520957" href="/Public/Bug/Display.html?id=40106#txn-520957">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;17&nbsp;18:50:06&nbsp;2008</span>
    <span class="description">nomad [...] null.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #40106] Temporary or cleaned databases should be the normal mode</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 18 Oct 2008 00:49:53 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Philippe &#39;BooK&#39; Bruhat via RT &lt;bug-Test-Database [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Lawrence &lt;nomad [...] null.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/520957/260185/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/260185">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 720b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     use Test::More;
&gt;     use Test::Database;
&gt; 
&gt;     my @drivers = Test::Database-&gt;drivers&#40;&#39;SQLite&#39;, &#39;Pg&#39;&#41;;
&gt;     plan tests =&gt; @drivers * 3;
&gt; 
&gt;     foreach my $driver &#40;@drivers&#41; {
&gt;         ok&#40;....&#41;; # test 1
&gt;         ok&#40;....&#41;; # test 2
&gt;         ok&#40;....&#41;; # test 3
&gt;     }
&gt; 
</div>
Sorry, one better would be this, to allow for database independent
tests:

     use Test::More;
     use Test::Database;
 
     my @drivers = Test::Database-&gt;drivers&#40;&#39;SQLite&#39;, &#39;Pg&#39;&#41;;
     plan tests =&gt; 2 + &#40;@drivers * 3&#41;;

     ok&#40;...&#41;; # test a;
     ok&#40;...&#41;; # test b;
 
     foreach my $driver &#40;@drivers&#41; {
         ok&#40;....&#41;; # test 1
         ok&#40;....&#41;; # test 2
         ok&#40;....&#41;; # test 3
     }

Cheers,
Mark.
-- 
Mark Lawrence
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-520962" href="/Public/Bug/Display.html?id=40106#txn-520962">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;17&nbsp;19:03:58&nbsp;2008</span>
    <span class="description">book [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/520962/260188/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/260188">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 12.5k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-636725" href="/Public/Bug/Display.html?id=40106#txn-636725">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;22&nbsp;18:41:26&nbsp;2009</span>
    <span class="description">book [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.514313</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
