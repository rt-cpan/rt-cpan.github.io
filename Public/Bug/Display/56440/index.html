<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #56440 for MongoDB: &#39;safe&#39; operations returning 0 on fail</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #56440 for MongoDB: &#39;safe&#39; operations returning 0 on fail</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/MongoDB/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/MongoDB/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/MongoDB/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/MongoDB/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://jira.mongodb.org/browse/PERL">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/MongoDB">MongoDB CPAN distribution</a>.</p>


<h3>Maintainer&#40;s&#41;&#39; notes</h3>

<p>Please don't report bugs here.  Please use the <a href="https://jira.mongodb.org/browse/PERL">MongoDB Perl driver issue tracker</a> instead.</p>



<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">56440</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/MongoDB/Active/">MongoDB</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
EWILHELM [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-227304-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.29    </td>
  </tr>
  <tr id="CF-227305-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;09&nbsp;15:48:50&nbsp;2010</span>
    <span class="description">EWILHELM [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> &#39;safe&#39; operations returning 0 on fail</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The insert&#40;&#41; method in version 0.28 would throw an error with the 
{safe =&gt; 1} option, but newer versions silently return 0.  Throwing an 
error was a better design, because &#34; or die 
MongoDB::Database-&gt;last_error&#34; is tedious to write, easily missed, and 
prone to synchronization errors because the error is disconnected from 
the origin.  Using eval {} or try/catch gives more flexibility for 
catching errors at various depths of scope and thus cleaner code.

The new remove&#40;&#41;, update&#40;&#41;, and ensure_index&#40;&#41; &#39;safe&#39; options seem to 
have this same misfeature.

If there is some good reason why these operations cannot throw an 
error, the Changes file should have noted this incompatible API change 
because it will cause silent breakage of any code which was expecting 
the error semantics.

Thanks,
Eric
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;09&nbsp;15:58:13&nbsp;2010</span>
    <span class="description">KRISTINA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve put this here: <span class="clickylink"><a target="new" rel="nofollow" href="http://jira.mongodb.org/browse/PERL-75">http://jira.mongodb.org/browse/PERL-75</a></span>

I see your point, but the people on IRC I consulted before changing this 
unanimously thought that dies were annoying to deal with and it wasn&#39;t a 
serious enough error to warrant their use.  I&#39;d like to get some more 
opinions.


On Fri Apr 09 15:48:50 2010, EWILHELM wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The insert&#40;&#41; method in version 0.28 would throw an error with the 
&gt; {safe =&gt; 1} option, but newer versions silently return 0.  Throwing an 
&gt; error was a better design, because &#34; or die 
&gt; MongoDB::Database-&gt;last_error&#34; is tedious to write, easily missed, and 
&gt; prone to synchronization errors because the error is disconnected from 
&gt; the origin.  Using eval {} or try/catch gives more flexibility for 
&gt; catching errors at various depths of scope and thus cleaner code.
&gt; 
&gt; The new remove&#40;&#41;, update&#40;&#41;, and ensure_index&#40;&#41; &#39;safe&#39; options seem to 
&gt; have this same misfeature.
&gt; 
&gt; If there is some good reason why these operations cannot throw an 
&gt; error, the Changes file should have noted this incompatible API change 
&gt; because it will cause silent breakage of any code which was expecting 
&gt; the error semantics.
&gt; 
&gt; Thanks,
&gt; Eric
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;09&nbsp;15:58:15&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;09&nbsp;18:29:41&nbsp;2010</span>
    <span class="description">enobacon [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #56440] &#39;safe&#39; operations returning 0 on fail</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 9 Apr 2010 15:29:23 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MongoDB [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Wilhelm &lt;enobacon [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"># from Kristina Chodorow via RT
# on Friday 09 April 2010 12:58:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;I see your point, but the people on IRC I consulted before changing
&gt; this unanimously thought that dies were annoying to deal with and it
&gt; wasn&#39;t a serious enough error to warrant their use.
</div>
Hi Kristina,

I&#39;m not sure which channel gave you this kind of opinions, but that&#39;s 
counter to most modern APIs and more like C than Perl.  It&#39;s trivial to 
use eval {} to trap or ignore errors, so IMO any case where the code 
has failed to carry out its duty is severe enough to throw an error.

That is, the flip-side of &#34;dies are annoying&#34; is that silent failure 
causes silly bugs &#40;or: having to write &#34;or die&#34; after every call is 
annoying.&#41;  Throwing exceptions gives you a side-channel for handling 
errors, which means that you don&#39;t have to clutter-up the main logic 
with checking whether or not every method did its job &#40;i.e. produced 
the intended side-effect.&#41;

Imagine in the following code that we&#39;re working at one or two method 
calls deep in scope.  How do we get out without throwing an error?  
Each level has to check return values -- and if 0 or undef is a valid 
answer at any level we&#39;ll have to jump through hoops.

  unless&#40;$coll-&gt;insert&#40;...&#41;&#41; {
    # insert failed, now perform some contortions
  }

This just gets more complicated when some failures could throw an error 
and others could return zero.

vs. the typical &#34;let the errors propagate&#34; usage:

  $coll-&gt;insert&#40;...&#41;;

which occasionally involves the &#34;or try something else&#34; pattern:

  eval {$coll-&gt;insert&#40;...&#41;};
  if&#40;$@&#41; {
    # retry or whatever
  }

Using &#34;throw an error&#34; semantics, the logic of trapping the error can 
happen at whichever depth, which is far cleaner than &#34;silently return a 
failure indicator&#34; where you potentially end up with error handling 
logic at every level of a multi-level abstraction.  More logic means 
more potential bugs.

I can see some code in Collection.pm which is already growing extra 
logic because of not throwing errors.

Thanks,
Eric
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;09&nbsp;19:15:25&nbsp;2010</span>
    <span class="description">EWILHELM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">See attached patch.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> exceptions.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/lib/MongoDB/Connection.pm b/lib/MongoDB/Connection.pm
index 819d87c..6e11670 100644
--- a/lib/MongoDB/Connection.pm
+++ b/lib/MongoDB/Connection.pm
@@ -255,6 +255,12 @@ has _last_error =&gt; &#40;
     is =&gt; &#39;rw&#39;,
 &#41;;
 
+sub croak &#40;@&#41; {
+    # Mouse delegation is doing something weird here - and confess is overkill
+    local $Carp::CarpLevel = 4;
+    Carp::croak&#40;@_&#41;;
+}
+
 sub _get_hosts {
     my &#40;$self&#41; = @_;
     my @hosts;
@@ -352,8 +358,8 @@ sub query {
 
 sub insert {
     my &#40;$self, $ns, $object, $options&#41; = @_;
-    my @id = $self-&gt;batch_insert&#40;$ns, [$object], $options&#41;;
-    return exists $id[0] ? $id[0] : 0;
+    my &#40;$id&#41; = $self-&gt;batch_insert&#40;$ns, [$object], $options&#41;;
+    return $id;
 }
 
 sub _make_safe {
@@ -370,10 +376,8 @@ sub _make_safe {
 
     my $ok = $cursor-&gt;next&#40;&#41;;
     $self-&gt;_last_error&#40;$ok&#41;;
+    croak $ok-&gt;{err} if $ok-&gt;{err};
 
-    if &#40;$ok-&gt;{err}&#41; {
-        return 0;
-    }
     return 1;
 }
 
diff --git a/t/collection.t b/t/collection.t
index 8db91b5..1ea784e 100644
--- a/t/collection.t
+++ b/t/collection.t
@@ -350,8 +350,8 @@ is&#40;$obj-&gt;{data}, 3.3&#41;;
 {
     $coll-&gt;drop;
     $coll-&gt;insert&#40;{_id =&gt; 1}, {safe =&gt; 1}&#41;;
-    $ok = $coll-&gt;insert&#40;{_id =&gt; 1}, {safe =&gt; 1}&#41;;
-    is&#40;$ok, 0&#41;;
+    eval {$coll-&gt;insert&#40;{_id =&gt; 1}, {safe =&gt; 1}&#41;};
+    ok&#40;$@ and $@ =~ /^E11000/, &#39;duplicate key exception&#39;&#41;;
 
   SKIP: {
       skip &#34;the version of the db you&#39;re running doesn&#39;t give error codes, you may wish to consider upgrading&#34;, 1 if !exists $db-&gt;last_error-&gt;{code};
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;16&nbsp;15:01:11&nbsp;2010</span>
    <span class="description">KRISTINA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The majority says it should croak, so I&#39;ve applied your patch and it will 
show up in 0.32!  Thanks!

<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/mongodb/mongo-perl-">http://github.com/mongodb/mongo-perl-</a></span>
driver/commit/706620c4cbe9c28a29461bf213a8b8bb80723395
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;16&nbsp;15:01:12&nbsp;2010</span>
    <span class="description">KRISTINA [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
