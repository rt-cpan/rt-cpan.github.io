<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #130240 for Moose: Moose performance issue in delete method of Native Hash traits</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #130240 for Moose: Moose performance issue in delete method of Native Hash traits</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Moose/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Moose/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Moose/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Moose/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Moose">Moose CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">130240</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Moose/Active/">Moose</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
niels.de.carpenter [...] intl.att.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-38786-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-38787-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;01&nbsp;11:14:56&nbsp;2019</span>
    <span class="description">niels.de.carpenter [...] intl.att.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Moose performance issue in delete method of Native Hash traits</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 1 Aug 2019 14:39:58 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Moose [...] rt.cpan.org&#34; &lt;bug-Moose [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;De Carpenter, Niels&#34; &lt;niels.de.carpenter [...] intl.att.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

We encountered a serious performance degradation when we upgraded from Moose 2.12.13 to 2.2011.
The issue turned out to be cause by very bad performance of the delete method when using Native Hash traits.

The issue is in &#34;lib64/perl5/Moose/Meta/Method/Accessor/Native/Hash/delete.pm&#34;, specifically:

# There are no new members so we don&#39;t need to coerce new values &#40;none exist&#41;
# and we always want to check the new &#40;empty&#41; hash as a whole.
sub _inline_coerce_new_values { &#39;&#39; }

sub _check_new_members_only { 0 }

This causes all objects in the hash to be checked when deleting a single entry from it.
For very large hashes this has a serious performance impact.

The comment that the new hash will be empty is wrong of course.
Setting _check_new_members_only to 1 fixes the issue.

A small script to reproduce the issue:

#!/usr/bin/perl

package TEST::Entry;
use strict;
use warnings FATAL =&gt; &#39;all&#39;;

use Moose;
use namespace::autoclean;

has &#39;name&#39; =&gt; &#40;    # To help identify what the data is while debugging
    is       =&gt; &#39;ro&#39;,
    isa      =&gt; &#39;Str&#39;,
    required =&gt; &#39;1&#39;,
&#41;;
has &#39;value&#39; =&gt; &#40;
    is       =&gt; &#39;ro&#39;,
    isa      =&gt; &#39;Int&#39;,
    required =&gt; &#39;1&#39;,
&#41;;

__PACKAGE__-&gt;meta-&gt;make_immutable;

1;

package TEST::HashRef;
use strict;
use warnings FATAL =&gt; &#39;all&#39;;

use Moose;
use namespace::autoclean;

has &#39;_entries&#39; =&gt; &#40;
    traits  =&gt; [&#39;Hash&#39;],
    is      =&gt; &#39;ro&#39;,
    isa     =&gt; &#39;HashRef[TEST::Entry]&#39;,
    default =&gt; sub { {} },
    handles =&gt; {
        keys   =&gt; &#39;keys&#39;,
        add    =&gt; &#39;set&#39;,
        get    =&gt; &#39;get&#39;,
        exists =&gt; &#39;exists&#39;,
        del    =&gt; &#39;delete&#39;,
        count  =&gt; &#39;count&#39;,
    },
&#41;;

__PACKAGE__-&gt;meta-&gt;make_immutable;

package main;
use Time::HiRes qw&#40;gettimeofday tv_interval&#41;;
print &#34;OK\n&#34;;
my $hash = TEST::HashRef-&gt;new&#40;&#41;;
test&#40;100000&#41;;


sub test {
    my $count = shift;
    my $string = sprintf&#40;&#34;test-%s&#34;,$count&#41;;
    print &#34;Running $string\n&#34;;
    my $name;
    for &#40;my $i=1; $i &lt;= $count; $i++&#41; {
        $name = sprintf&#40;&#34;%s-%s&#34;,$string, $i&#41;;
        $hash-&gt;add&#40; $name, TEST::Entry-&gt;new&#40; { name =&gt; $name, value =&gt; &#39;1&#39; } &#41; &#41;;
    }
    my $t0 = [gettimeofday];
    $hash-&gt;del&#40;$name&#41;;
    my $e0 = tv_interval&#40; $t0, [gettimeofday] &#41;;
    my $cnt = $hash-&gt;count;
    printf&#40; &#34;$string delete of last entry took %s, there are now %d entries in hash\n&#34;, $e0,$cnt &#41;;
}

1;

Regards,

Niels de Carpentier
DevOps Engineer
Integrator Solutions - Systems and Tools Center of Excellence
AT&#38;T Global Business
</div></div>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;28&nbsp;04:35:47&nbsp;2019</span>
    <span class="description">DROLSKY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Setting _check_new_members_only&#40;&#41; to return true is not the right solution.

The problem here is that we have no way of knowing what the overall type check for the attribute is looking for. For example, you could have a type that checks that there are at least 2 k/v pairs in the hash. If we don&#39;t check the constraint after the delete then you could obviously end up with an invalid value.

I&#39;m really not sure if there&#39;s a good way to fix this. The type constraint system doesn&#39;t have a way for us to figure out what the constraint does and whether it needs to be run after a delete.

Off hand I also can&#39;t think of a great workaround for you either :&#40;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;28&nbsp;04:35:49&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;29&nbsp;09:06:31&nbsp;2019</span>
    <span class="description">niels.de.carpenter [...] intl.att.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #130240] Moose performance issue in delete method of Native Hash traits</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 29 Aug 2019 09:38:28 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Moose [...] rt.cpan.org&#34; &lt;bug-Moose [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;De Carpenter, Niels&#34; &lt;niels.de.carpenter [...] intl.att.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Dave,

I&#39;m not sure I understand as this is just for the native hash trait, if you have a type that has a requirement for at least 2 k/v pairs in the hash it is not a Native hash anymore?
If someone needs a special type with special constraints, _check_new_members_only&#40;&#41; so be set to false as part of the definition for that type. &#40;Or am I missing something??&#41;

Niels 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Dave Rolsky via RT &lt;bug-Moose@rt.cpan.org&gt; 
Sent: Wednesday, August 28, 2019 10:36 AM
To: De Carpenter, Niels &lt;niels.de.carpenter@intl.att.com&gt;
Subject: [rt.cpan.org #130240] Moose performance issue in delete method of Native Hash traits

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://urldefense.proofpoint.com/v2/url?u=https-3A__rt.cpan.org_Ticket_Display.html-3Fid-3D130240&#38;d=DwIDaQ&#38;c=LFYZ-o9_HUMeMTSQicvjIg&#38;r=y731_v1E_MM5qFny7mhv3La88NQMmhodZIZ5ZXzIxxI&#38;m=mIzMa6Xobm6maVRCmoAwNRcKuzM5GADI5YuJWfbGM9E&#38;s=owdqPLHdOr0E13vATPmbLqkVjrjA-7hodBFsenJaKUY&#38;e=">https://urldefense.proofpoint.com/v2/url?u=https-3A__rt.cpan.org_Ticket_Display.html-3Fid-3D130240&#38;d=DwIDaQ&#38;c=LFYZ-o9_HUMeMTSQicvjIg&#38;r=y731_v1E_MM5qFny7mhv3La88NQMmhodZIZ5ZXzIxxI&#38;m=mIzMa6Xobm6maVRCmoAwNRcKuzM5GADI5YuJWfbGM9E&#38;s=owdqPLHdOr0E13vATPmbLqkVjrjA-7hodBFsenJaKUY&#38;e=</a></span> &gt;

Setting _check_new_members_only&#40;&#41; to return true is not the right solution.

The problem here is that we have no way of knowing what the overall type check for the attribute is looking for. For example, you could have a type that checks that there are at least 2 k/v pairs in the hash. If we don&#39;t check the constraint after the delete then you could obviously end up with an invalid value.

I&#39;m really not sure if there&#39;s a good way to fix this. The type constraint system doesn&#39;t have a way for us to figure out what the constraint does and whether it needs to be run after a delete.

Off hand I also can&#39;t think of a great workaround for you either :&#40;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;29&nbsp;09:39:46&nbsp;2019</span>
    <span class="description">DROLSKY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2019-08-29 08:06:31, niels.de.carpenter@intl.att.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Dave,
&gt; 
&gt; I&#39;m not sure I understand as this is just for the native hash trait,
&gt; if you have a type that has a requirement for at least 2 k/v pairs in
&gt; the hash it is not a Native hash anymore?
&gt; If someone needs a special type with special constraints,
&gt; _check_new_members_only&#40;&#41; so be set to false as part of the definition
&gt; for that type. &#40;Or am I missing something??&#41;
</div>
There&#39;s nothing about native hashes that requires the type to be &#34;HashRef[`a`]&#34; as opposed to &#34;SubTypeOfHashRef[`a`]&#34;. And since we don&#39;t know what sort of checks that subtype might impose, we need to fire the entire check again when hash keys are deleted.

It is entirely possible to define a subtype that required at least two keys. See the file I attached for an example.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> native-with-subtype.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use v5.14;
use strict;
use warnings;

package Foo;

use Moose;
use Moose::Util::TypeConstraints;

has h =&gt; &#40;
    traits  =&gt; [&#39;Hash&#39;],
    is      =&gt; &#39;ro&#39;,
    isa     =&gt; &#40; subtype &#39;HashRef&#39;, where { keys %{$_} &gt;= 2 } &#41;,
    default =&gt; sub { { foo =&gt; 2, bar =&gt; 4 } },
    handles =&gt; { d =&gt; &#39;delete&#39; },
&#41;;

package main;

my $foo = Foo-&gt;new;
$foo-&gt;d&#40;&#39;foo&#39;&#41;;

# will not get here
say for sort keys %{ $foo-&gt;h };
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;29&nbsp;11:35:21&nbsp;2019</span>
    <span class="description">niels.de.carpenter [...] intl.att.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Global MNS Systems Management RM &lt;rm-mnsmanagement [...] intl.att.com&gt;, &#34;Bonte, Jari&#34; &lt;jari.bonte [...] intl.att.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #130240] Moose performance issue in delete method of Native Hash traits</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 29 Aug 2019 15:34:49 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Moose [...] rt.cpan.org&#34; &lt;bug-Moose [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;De Carpenter, Niels&#34; &lt;niels.de.carpenter [...] intl.att.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Dave,

The correct fix seems to be removing the definition of _check_new_members_only  from &#34;lib64/perl5/Moose/Meta/Method/Accessor/Native/Hash/delete.pm&#34;.
The default version will handle both cases correctly and will run your script correctly while also solving the performance issue we were seeing.

Niels

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Dave Rolsky via RT &lt;bug-Moose@rt.cpan.org&gt; 
Sent: Thursday, August 29, 2019 3:40 PM
To: De Carpenter, Niels &lt;niels.de.carpenter@intl.att.com&gt;
Subject: [rt.cpan.org #130240] Moose performance issue in delete method of Native Hash traits

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://urldefense.proofpoint.com/v2/url?u=https-3A__rt.cpan.org_Ticket_Display.html-3Fid-3D130240&#38;d=DwIDaQ&#38;c=LFYZ-o9_HUMeMTSQicvjIg&#38;r=y731_v1E_MM5qFny7mhv3La88NQMmhodZIZ5ZXzIxxI&#38;m=yLYlzcDPPOu1YQIdwoUaSgEbN3Ap4gij0QG3h0cDa2E&#38;s=qPiyPbI6MXyTzK4CVIagHLCgYC5BxQzjzUoKkrYrIxg&#38;e=">https://urldefense.proofpoint.com/v2/url?u=https-3A__rt.cpan.org_Ticket_Display.html-3Fid-3D130240&#38;d=DwIDaQ&#38;c=LFYZ-o9_HUMeMTSQicvjIg&#38;r=y731_v1E_MM5qFny7mhv3La88NQMmhodZIZ5ZXzIxxI&#38;m=yLYlzcDPPOu1YQIdwoUaSgEbN3Ap4gij0QG3h0cDa2E&#38;s=qPiyPbI6MXyTzK4CVIagHLCgYC5BxQzjzUoKkrYrIxg&#38;e=</a></span> &gt;

On 2019-08-29 08:06:31, niels.de.carpenter@intl.att.com wrote:
<div class="message-stanza open">&gt; Hi Dave,
&gt; 
&gt; I&#39;m not sure I understand as this is just for the native hash trait, 
&gt; if you have a type that has a requirement for at least 2 k/v pairs in 
&gt; the hash it is not a Native hash anymore?
&gt; If someone needs a special type with special constraints,
&gt; _check_new_members_only&#40;&#41; so be set to false as part of the definition 
&gt; for that type. &#40;Or am I missing something??&#41;
</div>
There&#39;s nothing about native hashes that requires the type to be &#34;HashRef[`a`]&#34; as opposed to &#34;SubTypeOfHashRef[`a`]&#34;. And since we don&#39;t know what sort of checks that subtype might impose, we need to fire the entire check again when hash keys are deleted.

It is entirely possible to define a subtype that required at least two keys. See the file I attached for an example.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;29&nbsp;11:41:22&nbsp;2019</span>
    <span class="description">DROLSKY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2019-08-29 10:35:21, niels.de.carpenter@intl.att.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Dave,
&gt; 
&gt; The correct fix seems to be removing the definition of
&gt; _check_new_members_only  from
&gt; &#34;lib64/perl5/Moose/Meta/Method/Accessor/Native/Hash/delete.pm&#34;.
&gt; The default version will handle both cases correctly and will run your
&gt; script correctly while also solving the performance issue we were
&gt; seeing.
</div>
Yes, I think that is correct.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
