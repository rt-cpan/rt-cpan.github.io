<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #39863 for perlindex: perlindex: deleted modules are not removed from indexes</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #39863 for perlindex: perlindex: deleted modules are not removed from indexes</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/perlindex/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/perlindex/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/perlindex/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/perlindex/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/perlindex">perlindex CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">39863</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">1.3 hours (80 min)

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/perlindex/Active/">perlindex</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
SREZIC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-25440-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.502    </td>
  </tr>
  <tr id="CF-25441-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;07&nbsp;09:47:29&nbsp;2008</span>
    <span class="description">SREZIC [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> perlindex: deleted modules are not removed from indexes</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Deleted modules are not removed from the perlindex indexes. Currently
the only &#34;workaround&#34; is to remove all index files and re-run perlindex
-index from scratch.

Having a &#34;delete&#34; function would probably also help in implementing an
&#34;update&#34; function, where the indexes are re-built for existing but
updated pods &#40;see the other ticket&#41;.

Regards,
    Slaven
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;19&nbsp;04:16:08&nbsp;2008</span>
    <span class="description">ULPFR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">20 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Slaven,

to remove a document from the index, you need either

a&#41;  remove the document number from all word lists or
b&#41;  assign a new document number to the document and keep the
    entries for the deleted document.

To &#40;a&#41; remove the document you either

i&#41;  know all words of the document or
ii&#41; scan the whole document list.

The first option &#40;i&#41; requires to keep a copy of the original
document around - either in the input format or as inverted
inverted index.

Possibly a combination of &#40;b&#41; and &#40;ii&#41; would be the best option.
Documents are deleted by marking them as deleted and in a garbage
collecting step all deleted documents are removed in one scan
through the document list.

This is beyond the small script I wrote for demonstration purpose &#40;to
convince Larry to include &#39;pack &#34;w&#34;&#39;&#41; though.

Are people using this script for collections big enough to make
re-indexing too expensive?

Ulrich
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;19&nbsp;04:16:11&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;19&nbsp;05:58:37&nbsp;2008</span>
    <span class="description">ULPFR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As I have implemented the &#34;update&#34; functionality &#40;#39862&#41;, delete
is possible also. What interface are you proposing?

We could remove all files disappeared in an extended garbage collect
phase.  That would imply a run for every indexing, not only when a file
was updated.  Alternatively a command line flag could be added.

Ulrich
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;19&nbsp;10:31:51&nbsp;2008</span>
    <span class="description">ULPFR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">60 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Resolved in perlindex-1.601: After indexing, all files are checked
for existence. File not existing any more are removed from the index.
This release also fixed the indexing of the default directories
broken in 1.600.  Note that the 1.6 version breaks index compatibility.

Ulrich
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">*** perlindex.ref2	Sun Oct 19 15:50:57 2008
--- perlindex.PL	Sun Oct 19 16:23:04 2008
***************
*** 4,12 ****
  #                              -*- Mode: Perl -*- 
  # Author          : Ulrich Pfeifer
  # Created On      : Mon Jan 22 13:00:41 1996
! # Last Modified On: Sun Oct 19 16:26:42 2008
  # Language        : Perl
! # Update Count    : 370
  # Status          : Unknown, Use with caution!
  # 
  # &#40;C&#41; Copyright 1996-2005, Ulrich Pfeifer, all rights reserved.
--- 4,12 ----
  #                              -*- Mode: Perl -*- 
  # Author          : Ulrich Pfeifer
  # Created On      : Mon Jan 22 13:00:41 1996
! # Last Modified On: Sun Oct 19 16:23:04 2008
  # Language        : Perl
! # Update Count    : 387
  # Status          : Unknown, Use with caution!
  # 
  # &#40;C&#41; Copyright 1996-2005, Ulrich Pfeifer, all rights reserved.
***************
*** 128,134 ****
      for $name &#40;@ARGV&#41; {
          my $fns = $name;
          $fns =~ s:\Q$prefix/::;
!         if &#40;$SEEN{$fns}&#41; {
            my &#40;$mtime, $did&#41; = unpack &#34;$p$p&#34;, $SEEN{$fns};
            if &#40;&#40;stat $name&#41;[9] &gt; $mtime&#41; {
              # mark document as deleted
--- 128,134 ----
      for $name &#40;@ARGV&#41; {
          my $fns = $name;
          $fns =~ s:\Q$prefix/::;
!         if &#40;exists $SEEN{$fns}&#41; {
            my &#40;$mtime, $did&#41; = unpack &#34;$p$p&#34;, $SEEN{$fns};
            if &#40;&#40;stat $name&#41;[9] &gt; $mtime&#41; {
              # mark document as deleted
***************
*** 149,155 ****
--- 149,170 ----
              }
          }
      }
+     # Check if all &#40;previuosly&#41; indexed files are still available
+     # This may take some time.
+     warn &#34;Validating index ...\n&#34;;
+     while &#40;my &#40;$fns, $value&#41; = each %SEEN&#41; {
+       my $path = $fns; $path = $prefix.&#39;/&#39;.$path unless $path =~ m:^/:;
+       unless &#40;-f $path&#41; {
+         my &#40;$mtime, $did&#41; = unpack &#34;$p$p&#34;, $value;
+         # mark document as deleted
+         warn &#34;Marking $did &#40;$fns&#41; as deleted\n&#34;;
+         delete $FN{$did};
+         delete $SEEN{$fns};
+         $gc_required++;
+       }
+     }
      if &#40;$gc_required&#41; {
+       warn &#34;Garbadge collecting ...\n&#34;;
        # garbadge collection, this is awfully slow
        while &#40;my &#40;$word,$list&#41; = each %IF&#41; {
          my %post = unpack&#40;$p.&#39;*&#39;,$list&#41;;
***************
*** 200,211 ****
          $prune = 1;
      }
      $fns =~ s:\Q$prefix/::;
!     return if $SEEN{$fns};
      return unless -f $_;
      if &#40;$name =~ /man|bin|\.&#40;pod|pm|txt&#41;$/&#41; {
          if &#40;!/&#40;~|,v&#41;$/&#41; {
              $did = $FN{&#39;last&#39;}++;
!             $SEEN{$fns} = &#38;index&#40;$name, $fns, $did&#41;; 
          }
      }
  }
--- 215,242 ----
          $prune = 1;
      }
      $fns =~ s:\Q$prefix/::;
! 
!     if &#40;exists $SEEN{$fns}&#41; {
!       my &#40;$mtime, $did&#41; = unpack &#34;$p$p&#34;, $SEEN{$fns};
!       if &#40;&#40;stat $name&#41;[9] &gt; $mtime&#41; {
!         # mark document as deleted
!         delete $FN{$did};
!         warn &#34;Marking $did,$mtime &#40;$name&#41; as deleted\n&#34;;
!         $gc_required++;
!       } else {
!         # index up to date
!         return;
!       }
!     }
! 
      return unless -f $_;
      if &#40;$name =~ /man|bin|\.&#40;pod|pm|txt&#41;$/&#41; {
          if &#40;!/&#40;~|,v&#41;$/&#41; {
              $did = $FN{&#39;last&#39;}++;
!             if &#40;&#38;index&#40;$name, $fns, $did&#41;&#41; {
!                 my &#40;$mtime&#41; = &#40;stat $name&#41;[9];
!                 $SEEN{$fns} = pack &#34;$p$p&#34;, &#40;stat $name&#41;[9], $did;
!             }
          }
      }
  }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;19&nbsp;10:31:56&nbsp;2008</span>
    <span class="description">ULPFR [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
