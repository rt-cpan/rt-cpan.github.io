<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #20001 for Net-DAV-Server: Character set interpretation broken</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #20001 for Net-DAV-Server: Character set interpretation broken</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-DAV-Server/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-DAV-Server/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-DAV-Server/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-DAV-Server/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-DAV-Server">Net-DAV-Server CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">20001</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-DAV-Server/Active/">Net-DAV-Server</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">BRONG [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
hachi [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22390-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.28    </td>
  </tr>
  <tr id="CF-22391-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;20&nbsp;05:30:04&nbsp;2006</span>
    <span class="description">hachi [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Character set interpretation broken</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The code in Net::DAV::Server performs a conversion to make all calls to
Filesys::Virtual::* manipulate filenames as octet strings and not UTF-8.

Since all the DAV clients I have tested &#40;Windows Explorer, OSX Finder,
DAVExplorer&#41; appear to want URI encoded UTF-8 data, and perl&#39;s internal
data format is UTF-8, I have found the encode_utf8 and decode_utf8 calls
in the code to be completely unwanted.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> nds.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== local/Net-DAV-Server/lib/Net/DAV/Server.pm
==================================================================
--- local/Net-DAV-Server/lib/Net/DAV/Server.pm	&#40;revision 3998&#41;
+++ local/Net-DAV-Server/lib/Net/DAV/Server.pm	&#40;local&#41;
@@ -2,7 +2,6 @@
 use strict;
 use warnings;
 use File::Slurp;
-use Encode;
 use File::Find::Rule::Filesys::Virtual;
 use HTTP::Date qw&#40;time2str time2isoz&#41;;
 use HTTP::Headers;
@@ -45,7 +44,7 @@
   my $fs = $self-&gt;filesys || die &#39;Boom&#39;;
 
   my $method = $request-&gt;method;
-  my $path   = decode_utf8 uri_unescape $request-&gt;uri-&gt;path;
+  my $path   = uri_unescape $request-&gt;uri-&gt;path;
 
   if &#40;!defined $response&#41; {
     $response = HTTP::Response-&gt;new;
@@ -80,7 +79,7 @@
 
 sub head {
   my &#40;$self, $request, $response&#41; = @_;
-  my $path = decode_utf8 uri_unescape $request-&gt;uri-&gt;path;
+  my $path = uri_unescape $request-&gt;uri-&gt;path;
   my $fs   = $self-&gt;filesys;
 
   if &#40;$fs-&gt;test&#40;&#34;f&#34;, $path&#41; &#38;&#38; $fs-&gt;test&#40;&#34;r&#34;, $path&#41;&#41; {
@@ -100,7 +99,7 @@
 
 sub get {
   my &#40;$self, $request, $response&#41; = @_;
-  my $path = decode_utf8 uri_unescape $request-&gt;uri-&gt;path;
+  my $path = uri_unescape $request-&gt;uri-&gt;path;
   my $fs   = $self-&gt;filesys;
 
   if &#40;$fs-&gt;test&#40;&#39;f&#39;, $path&#41; &#38;&#38; $fs-&gt;test&#40;&#39;r&#39;, $path&#41;&#41; {
@@ -133,7 +132,7 @@
 
 sub put {
   my &#40;$self, $request, $response&#41; = @_;
-  my $path = decode_utf8 uri_unescape $request-&gt;uri-&gt;path;
+  my $path = uri_unescape $request-&gt;uri-&gt;path;
   my $fs   = $self-&gt;filesys;
 
   $response = HTTP::Response-&gt;new&#40;201, &#34;CREATED&#34;, $response-&gt;headers&#41;;
@@ -156,7 +155,7 @@
 
 sub delete {
   my &#40;$self, $request, $response&#41; = @_;
-  my $path = decode_utf8 uri_unescape $request-&gt;uri-&gt;path;
+  my $path = uri_unescape $request-&gt;uri-&gt;path;
   my $fs   = $self-&gt;filesys;
 
   if &#40;$request-&gt;uri-&gt;fragment&#41; {
@@ -204,7 +203,7 @@
 
 sub copy {
   my &#40;$self, $request, $response&#41; = @_;
-  my $path = decode_utf8 uri_unescape $request-&gt;uri-&gt;path;
+  my $path = uri_unescape $request-&gt;uri-&gt;path;
   my $fs   = $self-&gt;filesys;
 
   my $destination = $request-&gt;header&#40;&#39;Destination&#39;&#41;;
@@ -266,7 +265,7 @@
 
 sub copy_file {
   my &#40;$self, $request, $response&#41; = @_;
-  my $path = decode_utf8 uri_unescape $request-&gt;uri-&gt;path;
+  my $path = uri_unescape $request-&gt;uri-&gt;path;
   my $fs   = $self-&gt;filesys;
 
   my $destination = $request-&gt;header&#40;&#39;Destination&#39;&#41;;
@@ -325,7 +324,7 @@
 
 sub lock {
   my &#40;$self, $request, $response&#41; = @_;
-  my $path = decode_utf8 uri_unescape $request-&gt;uri-&gt;path;
+  my $path = uri_unescape $request-&gt;uri-&gt;path;
   my $fs   = $self-&gt;filesys;
 
   $fs-&gt;lock&#40;$path&#41;;
@@ -335,7 +334,7 @@
 
 sub unlock {
   my &#40;$self, $request, $response&#41; = @_;
-  my $path = decode_utf8 uri_unescape $request-&gt;uri-&gt;path;
+  my $path = uri_unescape $request-&gt;uri-&gt;path;
   my $fs   = $self-&gt;filesys;
 
   $fs-&gt;unlock&#40;$path&#41;;
@@ -345,7 +344,7 @@
 
 sub mkcol {
   my &#40;$self, $request, $response&#41; = @_;
-  my $path = decode_utf8 uri_unescape $request-&gt;uri-&gt;path;
+  my $path = uri_unescape $request-&gt;uri-&gt;path;
   my $fs   = $self-&gt;filesys;
 
   if &#40;$request-&gt;content&#41; {
@@ -367,7 +366,7 @@
 
 sub propfind {
   my &#40;$self, $request, $response&#41; = @_;
-  my $path  = decode_utf8 uri_unescape $request-&gt;uri-&gt;path;
+  my $path  = uri_unescape $request-&gt;uri-&gt;path;
   my $fs    = $self-&gt;filesys;
   my $depth = $request-&gt;header&#40;&#39;Depth&#39;&#41;;
 
@@ -444,7 +443,7 @@
     my $href = $doc-&gt;createElement&#40;&#39;D:href&#39;&#41;;
     $href-&gt;appendText&#40;
       File::Spec-&gt;catdir&#40;
-        map { uri_escape encode_utf8 $_} File::Spec-&gt;splitdir&#40;$path&#41;
+        map { uri_escape $_} File::Spec-&gt;splitdir&#40;$path&#41;
       &#41;
     &#41;;
     $resp-&gt;addChild&#40;$href&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;21&nbsp;02:42:11&nbsp;2006</span>
    <span class="description">BRONG [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jun 20 05:30:04 2006, HACHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The code in Net::DAV::Server performs a conversion to make all calls 
</div>to
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Filesys::Virtual::* manipulate filenames as octet strings and not 
</div>UTF-8.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Since all the DAV clients I have tested &#40;Windows Explorer, OSX 
</div>Finder,
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; DAVExplorer&#41; appear to want URI encoded UTF-8 data, and perl&#39;s 
</div>internal
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; data format is UTF-8, I have found the encode_utf8 and decode_utf8 
</div>calls
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; in the code to be completely unwanted.
</div>
Thanks for this, and your other patch as well.  I&#39;ve been meaning for 
a while to spend some time on Net::DAV::Server, and your patches will 
certainly be considered and either merged as is or re-written to match 
the changes I want to make.

I&#39;m afraid I branched rather a long way from Net::DAV::Server for my 
implementation of Apache mod_perl compatibility, so I&#39;ll need to 
integrate that back too!

Thanks again,

Bron.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;21&nbsp;02:42:12&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;18&nbsp;20:13:03&nbsp;2006</span>
    <span class="description">BRONG [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;18&nbsp;21:17:46&nbsp;2006</span>
    <span class="description">BRONG [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jun 20 05:30:04 2006, HACHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The code in Net::DAV::Server performs a conversion to make all calls 
</div>to
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Filesys::Virtual::* manipulate filenames as octet strings and not 
</div>UTF-8.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Since all the DAV clients I have tested &#40;Windows Explorer, OSX 
</div>Finder,
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; DAVExplorer&#41; appear to want URI encoded UTF-8 data, and perl&#39;s 
</div>internal
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; data format is UTF-8, I have found the encode_utf8 and decode_utf8 
</div>calls
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; in the code to be completely unwanted.
</div>
Sorry - on further examination I really don&#39;t see what problem you&#39;re 
trying to solve here.

The decode_utf8 and encode_utf8 calls do server a purpose, and I 
suspect you&#39;re reading them backwards.  The &#39;decode_utf8&#39; on incoming 
connections converts octet strings into &#34;characters&#34; within Perl, and 
the the &#39;encode_utf8&#39; on the way back converts them back into octet 
strings for URI encoding and returning to the client.

While there is no standard &#40;very unfortunately&#41; about this behaviour, 
it seems to be what most of the sane clients have chosen to do.  There 
is some small performance hit for doing things this way with Encode, 
but the advantage is that you are working with proper Perl Unicode 
strings inside the Perl code.


I suspect the bug you&#39;re trying to solve is actually that some clients 
_DON&#39;T_ work this way - they just send raw octets in their own native 
charset.  If you work in octets all the way through in Perl then 
it &#34;just works&#34;[tm], but only because it&#39;s returning the same broken 
values without testing them for UTF8 correctness.

So I won&#39;t include this patch in 1.29, but I&#39;d be very interested in 
talking with you about the underlying problems you experienced and 
coming up with another solution to them.

Regards,

Bron.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
