<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #30825 for Email-Send: Email-Send Net-SMTP-TLS problem.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #30825 for Email-Send: Email-Send Net-SMTP-TLS problem.</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Email-Send">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Email-Send">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Email-Send">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Email-Send">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/rjbs/Email-Send/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Email-Send">Email-Send CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">30825</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Email-Send">Email-Send</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mnichols [...] mojosoft.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-11990-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-11991-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




0001-Fudge-the-send-command-so-that-it-ll-play-ball-with-.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/684332/352459/0001-Fudge-the-send-command-so-that-it-ll-play-ball-with-.patch">
Fri Oct 30 15:26:38 2009 (2.3k) by yanick+cpan [...] babyl.dyndns.org
</a>
</font></li>
</ul>


SMTP.pm<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/384998/176649/SMTP.pm">
Sun Nov 18 14:04:22 2007 (5.2k) by mnichols [...] mojosoft.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=30825">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-384998" href="/Public/Bug/Display.html?id=30825#txn-384998">#</a>      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;18&nbsp;14:04:22&nbsp;2007</span>
    <span class="description">mnichols [...] mojosoft.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> bug-Net-SMTP-TLS [...] rt.cpan.org.,  bug-Email-Send [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Email-Send Net-SMTP-TLS problem.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 18 Nov 2007 14:03:57 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> awestholm [...] verizon.net,  rjbs [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mojo Nichols &lt;mnichols [...] mojosoft.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/384998/176648/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/176648">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 774b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi all,

I can not get Email Send to work out of the box.   I have managed to 
make it work, however I modified Email Send and I think the proper fix 
is to change Net::SMTP::TLS.


I think the problem is that Net::SMTP::TLS doesn&#39;t return anything from 
$SMTP-&gt;mail&#40;$from&#41; and
$SMTP-&gt;data&#40;$message&#41; doesn&#39;t work however $SMTP-&gt;data&#40;&#41;; 
$SMTP-&gt;datasend&#40;&#41;; $SMTP-&gt;dataend&#40;&#41;; does.

I&#39;m looking at making Net::SMTP::TLS behave as Email::Send expects and 
will post if I figure it out.

Also I note that the arguments are different User instead of username, 
Password instead of password.  It seems like the only change that should 
be necessary to go from ssl, to tls is the the arguement tls.  If I get 
anywhere with this I will post as well.





Thanks,


Mojo Nichols
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/384998/176649/SMTP.pm">Download SMTP.pm</a><br />
<span class="downloadcontenttype">text/x-perl 5.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">package Email::Send::SMTP;
use strict;

use vars qw[$SMTP $VERSION];
use Email::Address;
use Return::Value;

$VERSION   = &#39;2.182&#39;;

sub is_available {
    my &#40;$class, %args&#41; = @_;
    my $success = 1;
    $success = eval { require Net::SMTP };
    $success = eval { require Net::SMTP::SSL } if $args{ssl};
    $success = eval { require Net::SMTP::TLS } if $args{tls};
    return   $success
           ? success
           : failure $@;
}

sub get_env_sender {
  my &#40;$class, $message&#41; = @_;

  my $from = &#40;Email::Address-&gt;parse&#40;$message-&gt;header&#40;&#39;From&#39;&#41;&#41;&#41;[0]-&gt;address;
}

sub get_env_recipients {
  my &#40;$class, $message&#41; = @_;

  my %to = map { $_-&gt;address =&gt; 1 }
           map { Email::Address-&gt;parse&#40;$message-&gt;header&#40;$_&#41;&#41; }
           qw&#40;To Cc Bcc&#41;;

  return keys %to;
}

sub send {
    my &#40;$class, $message, @args&#41; = @_;
    require Net::SMTP;
    if &#40; @_ &gt; 1 &#41; {
        my %args;
        if &#40; @args % 2 &#41; {
            my $host = shift @args;
            %args = @args;
            $args{Host} = $host;
        } else {
            %args = @args;
        }

        my $host = delete&#40;$args{Host}&#41; || &#39;localhost&#39;;

        my $smtp_class = $args{ssl} ? &#39;Net::SMTP::SSL&#39;
                       : $args{tls} ? &#39;Net::SMTP::TLS&#39;
                       :              &#39;Net::SMTP&#39;;

        $SMTP-&gt;quit if $SMTP;
        $SMTP = $smtp_class-&gt;new&#40;$host, %args&#41;;
        return failure &#34;Couldn&#39;t connect to $host&#34; unless $SMTP;
        
        my &#40;$user, $pass&#41;
          = @args{qw[username password]};
        if &#40; $user &#41; {
            $SMTP-&gt;auth&#40;$user, $pass&#41;
              or return failure &#34;Couldn&#39;t authenticate &#39;$user:...&#39;&#34;;
        }
    }
    
    my @bad;
    eval {
        my $from = $class-&gt;get_env_sender&#40;$message&#41;;
        # ::TLS has no useful return value, but will croak on failure.
        #eval { $SMTP-&gt;mail&#40;$from&#41; } or return failure &#34;FROM: &lt;$from&gt; denied&#34;;
	if &#40;eval { $SMTP-&gt;isa&#40;&#39;Net::SMTP::TLS&#39;&#41; }&#41; {
	  $SMTP-&gt;mail&#40;$from&#41;;
	} else {
	  eval { $SMTP-&gt;mail&#40;$from&#41; } or return failure &#34;FROM: &lt;$from&gt; denied&#34;;
	}

        my @to = $class-&gt;get_env_recipients&#40;$message&#41;;


        if &#40;eval { $SMTP-&gt;isa&#40;&#39;Net::SMTP::TLS&#39;&#41; }&#41; {
          $SMTP-&gt;to&#40;@to&#41;;
        } else {
          my @ok = $SMTP-&gt;to&#40;@to, { SkipBad =&gt; 1 }&#41;;

          if &#40; @to != @ok &#41; {
              my %to; @to{@to} = &#40;1&#41; x @to;
              delete @to{@ok};
              @bad = keys %to;
          }
        }
 
        return failure &#34;No valid recipients&#34; if @bad == @to;
    };

    return failure $@ if $@;

    if&#40;eval { $SMTP-&gt;isa&#40;&#39;Net::SMTP::TLS&#39;&#41; }&#41; {

      $SMTP-&gt;data&#40;&#41;;
      $SMTP-&gt;datasend&#40; $message-&gt;as_string &#41;;
      $SMTP-&gt;dataend;

    } else {
      return failure &#34;Can&#39;t send data&#34; unless $SMTP-&gt;data&#40; $message-&gt;as_string &#41;;
    }
    return success &#34;Message sent&#34;, prop =&gt; { bad =&gt; [ @bad ], };
}

sub DESTROY {
    $SMTP-&gt;quit if $SMTP;
}

1;

__END__

=head1 NAME

Email::Send::SMTP - Send Messages using SMTP

=head1 SYNOPSIS

  use Email::Send;

  my $mailer = Email::Send-&gt;new&#40;{mailer =&gt; &#39;SMTP&#39;}&#41;;
  
  $mailer-&gt;mailer_args&#40;[Host =&gt; &#39;smtp.example.com:465&#39;, ssl =&gt; 1]&#41;
    if $USE_SSL;
  
  $mailer-&gt;send&#40;$message&#41;;

=head1 DESCRIPTION

This mailer for C&lt;Email::Send&gt; uses C&lt;Net::SMTP&gt; to send a message with
an SMTP server. The first invocation of C&lt;send&gt; requires an SMTP server
arguments. Subsequent calls will remember the the first setting until
it is reset.

Any arguments passed to C&lt;send&gt; will be passed to C&lt;&lt; Net::SMTP-&gt;new&#40;&#41; &gt;&gt;,
with some exceptions. C&lt;username&gt; and C&lt;password&gt;, if passed, are
used to invoke C&lt;&lt; Net::SMTP-&gt;auth&#40;&#41; &gt;&gt; for SASL authentication support.
C&lt;ssl&gt;, if set to true, turns on SSL support by using C&lt;Net::SMTP::SSL&gt;.

SMTP can fail for a number of reasons. All return values from this
package are true or false. If false, sending has failed. If true,
send succeeded. The return values are C&lt;Return::Value&gt; objects, however,
and contain more information on just what went wrong.

Here is an example of dealing with failure.

  my $return = send SMTP =&gt; $message, &#39;localhost&#39;;
  
  die &#34;$return&#34; if ! $return;

The stringified version of the return value will have the text of the
error. In a conditional, a failure will evaluate to false.

Here&#39;s an example of dealing with success. It is the case that some
email addresses may not succeed but others will. In this case, the
return value&#39;s C&lt;bad&gt; property is set to a list of bad addresses.

  my $return = send SMTP =&gt; $message, &#39;localhost&#39;;

  if &#40; $return &#41; {
      my @bad = @{ $return-&gt;prop&#40;&#39;bad&#39;&#41; };
      warn &#34;Failed to send to: &#34; . join &#39;, &#39;, @bad
        if @bad;
  }

For more information on these return values, see L&lt;Return::Value&gt;.

=head2 ENVELOPE GENERATION

The envelope sender and recipients are, by default, generated by looking at the
From, To, Cc, and Bcc headers.  This behavior can be modified by replacing the
C&lt;get_env_sender&gt; and C&lt;get_env_recipients&gt; methods, both of which receive the
Email::Simple object and their only parameter, and return email addresses.

=head1 SEE ALSO

L&lt;Email::Send&gt;,
L&lt;Net::SMTP&gt;,
L&lt;Net::SMTP::SSL&gt;,
L&lt;Email::Address&gt;,
L&lt;Return::Value&gt;,
L&lt;perl&gt;.

=head1 AUTHOR

Current maintainer: Ricardo SIGNES, &lt;F&lt;rjbs@cpan.org&gt;&gt;.

Original author: Casey West, &lt;F&lt;casey@geeknest.com&gt;&gt;.

=head1 COPYRIGHT

  Copyright &#40;c&#41; 2004 Casey West.  All rights reserved.
  This module is free software; you can redistribute it and/or modify it
  under the same terms as Perl itself.

=cut
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-684332" href="/Public/Bug/Display.html?id=30825#txn-684332">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;30&nbsp;15:26:38&nbsp;2009</span>
    <span class="description">yanick+cpan [...] babyl.dyndns.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/684332/352456/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/352456">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 258b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">As mentioned previously, the real fix should be done in ::TLS, but in
the meantime, I&#39;ve attached the patch that makes Email::Send::SMTP play
nice with ::TLS.  

A git version of it can also be found at
<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/yanick/email-send/tree/net-smtp-tls">http://github.com/yanick/email-send/tree/net-smtp-tls</a></span>
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/684332/352459/0001-Fudge-the-send-command-so-that-it-ll-play-ball-with-.patch">Download 0001-Fudge-the-send-command-so-that-it-ll-play-ball-with-.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">From b2d522b7a1b52a2dcf9a995ce2f5ef1a3f78cda8 Mon Sep 17 00:00:00 2001
From: Yanick Champoux &lt;yanick@babyl.dyndns.org&gt;
Date: Fri, 30 Oct 2009 15:17:30 -0400
Subject: [PATCH] Fudge the send&#40;&#41; command so that it&#39;ll play ball with Net::SMTP::TLS

The differences with the plain SMTP stuff are:

* ::TLS doesn&#39;t use username/password, but rather User/Password.

* The auth is done in the new&#40;&#41;, not in a distinct function

* mail&#40;&#41; doesn&#39;t return anything, so fail on the eval{ }

* data is not sent with a simple data&#40;&#41;, but requires a more compex invocation
---
 lib/Email/Send/SMTP.pm |   21 ++++++++++++++++++---
 1 files changed, 18 insertions&#40;+&#41;, 3 deletions&#40;-&#41;

diff --git a/lib/Email/Send/SMTP.pm b/lib/Email/Send/SMTP.pm
index fccaed9..9aa5b74 100644
--- a/lib/Email/Send/SMTP.pm
+++ b/lib/Email/Send/SMTP.pm
@@ -56,12 +56,20 @@ sub send {
                    :              &#39;Net::SMTP&#39;;
 
     eval &#34;require $smtp_class; 1&#34; or die;
+
+    if &#40; $smtp_class eq &#39;Net::SMTP::TLS&#39; &#41; {
+        # ::TLS has different User/Password than the rest
+        $args{User}     ||= $args{username};
+        $args{Password} ||= $args{password};
+    }
+
     my $SMTP = $smtp_class-&gt;new&#40;$host, %args&#41;;
     return failure &#34;Couldn&#39;t connect to $host&#34; unless $SMTP;
     
     my &#40;$user, $pass&#41; = @args{qw[username password]};
 
-    if &#40; $user &#41; {
+    # for ::TLS, the auth is done by the new&#40;&#41;
+    if &#40; $user and not $smtp_class eq &#39;Net::SMTP::TLS&#39;  &#41; {
         $SMTP-&gt;auth&#40;$user, $pass&#41;
           or return failure &#34;Couldn&#39;t authenticate &#39;$user:...&#39;&#34;;
     }
@@ -71,7 +79,7 @@ sub send {
         my $from = $class-&gt;get_env_sender&#40;$message&#41;;
 
         # ::TLS has no useful return value, but will croak on failure.
-        eval { $SMTP-&gt;mail&#40;$from&#41; } or return failure &#34;FROM: &lt;$from&gt; denied&#34;;
+        eval { $SMTP-&gt;mail&#40;$from&#41;; 1 } or return failure &#34;FROM: &lt;$from&gt; denied&#34;;
 
         my @to = $class-&gt;get_env_recipients&#40;$message&#41;;
 
@@ -92,7 +100,14 @@ sub send {
 
     return failure $@ if $@;
 
-    return failure &#34;Can&#39;t send data&#34; unless $SMTP-&gt;data&#40; $message-&gt;as_string &#41;;
+    if &#40; $smtp_class eq &#39;Net::SMTP::TLS&#39; &#41; {
+        $SMTP-&gt;data;
+        $SMTP-&gt;datasend&#40; $message-&gt;as_string &#41;;
+        $SMTP-&gt;dataend;
+    }
+    else {
+        return failure &#34;Can&#39;t send data&#34; unless $SMTP-&gt;data&#40; $message-&gt;as_string &#41;;
+    }
 
     $SMTP-&gt;quit;
     return success &#34;Message sent&#34;, prop =&gt; { bad =&gt; [ @bad ], };
-- 
1.6.4.1

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-684333" href="/Public/Bug/Display.html?id=30825#txn-684333">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;30&nbsp;15:26:40&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1250702" href="/Public/Bug/Display.html?id=30825#txn-1250702">#</a>      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;18&nbsp;19:41:25&nbsp;2013</span>
    <span class="description">rjbs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1250702/661764/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/661764">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 33b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">applied in git

thanks!

-- 
rjbs
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1250705" href="/Public/Bug/Display.html?id=30825#txn-1250705">#</a>      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;18&nbsp;19:41:26&nbsp;2013</span>
    <span class="description">rjbs [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.391032</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
