<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #103984 for Win32: Unicode tests fail on Cygwin</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #103984 for Win32: Unicode tests fail on Cygwin</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Win32">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Win32">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Win32">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Win32">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Win32">Win32 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">103984</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Win32">Win32</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Stromeko [...] NexGo.DE

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-42710-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.47</li>
<li>
0.48</li>
<li>
0.49</li>
<li>
0.50</li>
<li>
0.51</li>
</ul>
    </td>
  </tr>
  <tr id="CF-42711-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=103984">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1490360" href="/Public/Bug/Display.html?id=103984#txn-1490360">#</a>      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;26&nbsp;12:28:12&nbsp;2015</span>
    <span class="description">https://me.yahoo.com/howdidwegetherereally#f714d -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Unicode tests fail on Cygwin</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1490360/793683/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/793683">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The Unicode tests fail on Cygwin at least since 0.47.  The created files have the correct file names, but the requests for the checks seem to be doubly encoded.  The following patch makes the tests pass, however it is merely meant as a demonstration of what is needed to pass the tests.  I have no idea if only the tests are failing or if there&#39;s an encoding problem in the API wrapper.

--- origsrc/Win32-0.51/t/Unicode.t      2013-11-08 21:42:25.000000000 +0100
+++ src/Win32-0.51/t/Unicode.t  2015-03-08 19:46:49.706174300 +0100
@@ -1,8 +1,9 @@
 use strict;
-use Test;
+use utf8;
+use Test::More;
 use Config qw&#40;%Config&#41;;
 use Cwd qw&#40;cwd&#41;;
-use Encode qw&#40;&#41;;
+use Encode qw&#40;encode decode&#41;;
 use Win32;
 
 BEGIN {
@@ -20,10 +21,13 @@ BEGIN {
     }
 }
 
-my $home = Win32::GetCwd&#40;&#41;;
-my $cwd  = cwd&#40;&#41;; # may be a Cygwin path
-my $dir  = &#34;Foo \x{394}\x{419} Bar \x{5E7}\x{645} Baz&#34;;
-my $file = &#34;$dir\\xyzzy \x{394}\x{419} plugh \x{5E7}\x{645}&#34;;
+my $home  = Win32::GetCwd&#40;&#41;;
+my $cwd   = cwd&#40;&#41;; # may be a Cygwin path
+my $dir8  = &#34;Foo ΔЙ Bar קم Baz&#34;; #Foo \x{394}\x{419} Bar \x{5E7}\x{645} Baz&#34;;
+my $file8 = &#34;$dir8\\xyzzy ΔЙ plugh קم&#34;; #xyzzy \x{394}\x{419} plugh \x{5E7}\x{645}&#34;;
+my $dir   = encode&#40;&#34;UTF-8&#34;, $dir8&#41;;
+my $file  = encode&#40;&#34;UTF-8&#34;, $file8&#41;;
+
 
 sub cleanup {
     chdir&#40;$home&#41;;
@@ -36,32 +40,29 @@ sub cleanup {
 cleanup&#40;&#41;;
 END { cleanup&#40;&#41; }
 
-plan test =&gt; 12;
+plan tests =&gt; 12;
 
 # Create Unicode directory
-Win32::CreateDirectory&#40;$dir&#41;;
+Win32::CreateDirectory&#40;$dir8&#41;;
 ok&#40;-d Win32::GetANSIPathName&#40;$dir&#41;&#41;;
 
 # Create Unicode file
-Win32::CreateFile&#40;$file&#41;;
+Win32::CreateFile&#40;$file8&#41;;
 ok&#40;-f Win32::GetANSIPathName&#40;$file&#41;&#41;;
 
 # readdir&#40;&#41; returns ANSI form of Unicode filename
 ok&#40;opendir&#40;my $dh, Win32::GetANSIPathName&#40;$dir&#41;&#41;&#41;;
 while &#40;$_ = readdir&#40;$dh&#41;&#41; {
     next if /^\./;
-    # On Cygwin 1.7 readdir&#40;&#41; returns the utf8 representation of the
-    # filename but doesn&#39;t turn on the SvUTF8 bit
-    Encode::_utf8_on&#40;$_&#41; if $^O eq &#34;cygwin&#34; &#38;&#38; $Config{osvers} !~ /^1.5/;
     ok&#40;$file, Win32::GetLongPathName&#40;&#34;$dir\\$_&#34;&#41;&#41;;
 }
 closedir&#40;$dh&#41;;
 
 # Win32::GetLongPathName&#40;&#41; of the absolute path restores the Unicode dir name
-my $full = Win32::GetFullPathName&#40;$dir&#41;;
+my $full = Win32::GetFullPathName&#40;$dir8&#41;;
 my $long = Win32::GetLongPathName&#40;$full&#41;;
 
-ok&#40;$long, Win32::GetLongPathName&#40;$home&#41;.&#34;\\$dir&#34;&#41;;
+ok&#40;$long, Win32::GetLongPathName&#40;$home&#41;.&#34;\\&#34;.$dir&#41;;
 
 # We can Win32::SetCwd&#40;&#41; into the Unicode directory
 ok&#40;Win32::SetCwd&#40;$dir&#41;&#41;;
@@ -80,7 +81,7 @@ ok&#40;Win32::GetLongPathName&#40;$w32dir&#41;, $lon
 # cwd&#40;&#41; on Cygwin returns a mapped path that we need to translate
 # back to a Windows path. Invoking `cygpath` on $subdir doesn&#39;t work.
 if &#40;$^O eq &#34;cygwin&#34;&#41; {
-    $subdir = Cygwin::posix_to_win_path&#40;$subdir, 1&#41;;
+    $subdir = decode &#34;UTF-8&#34;, Cygwin::posix_to_win_path&#40;$subdir, 1&#41;;
 }
 $subdir =~ s,/,\\,g;
 ok&#40;Win32::GetLongPathName&#40;$subdir&#41;, $long&#41;;
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.196933</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
