<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #120345 for Phash-FFI: ph_hamming_distance returns truncated result</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #120345 for Phash-FFI: ph_hamming_distance returns truncated result</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Phash-FFI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Phash-FFI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Phash-FFI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Phash-FFI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Phash-FFI">Phash-FFI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">120345</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Phash-FFI/Active/">Phash-FFI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
LBE [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
PLICEASE [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-258690-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-258691-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;23&nbsp;21:18:48&nbsp;2017</span>
    <span class="description">LBE [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ph_hamming_distance returns truncated result</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The result returned from the pHas ph_hamming_distance function is 64 bits in size.  It appears, that what is being returned only a 32 bit result which are the two low order bytes on my Mac &#40;little endian&#41;.  I have written a test script in perl as well as modified one of the pHash example programs to provide the same output.  I have tested this both on Debian Jessie and on my Mac.

&lt;code&gt;
Test
&lt;/code&gt;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;23&nbsp;21:38:20&nbsp;2017</span>
    <span class="description">LBE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The following is the output of the perl test script:

Distance = 4 &lt;- from pHash
Distance = 20 &lt;- from PP
[      ][      ][      ][      ][      ][      ][      ][      ]  Hash in Hex      Filename
0110011001111110011010101100001000000110001100101001111010111100  667e6ac206329ebc 24299403.jpg
1001001101000111000110101000101100010110011101101001111000111100  93471a8b16769e3c 26468566.jpg
^^^^ ^ ^  ^^^  ^ ^^^     ^  ^  ^   ^     ^   ^          ^

The following is the output of the C++ test program
Distance = 20 &lt;- from pHash
[      ][      ][      ][      ][      ][      ][      ][      ]  Hash in Hex      File Name
0110011001111110011010101100001000000110001100101001111010111100  667e6ac206329ebc 24299403.jpg
1001001101000111000110101000101100010110011101101001111000111100  93471a8b16769e3c 26468566.jpg
^^^^ ^ ^  ^^^  ^ ^^^     ^  ^  ^   ^     ^   ^          ^

Please note that the hamming distance using Phash::FFI::ph_hamming_distance is 4 when it should be 20.  The actual hashes returned from Phash::FFI::dct_imagehash match exactly that from the C++ program.  The perl program also has a perl perl subroutine to calculate the hamming distance &#40;Thanks to Ken - <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=1048973&#41;">http://www.perlmonks.org/?node_id=1048973&#41;</a></span>

I also modified the return type to uint64 on the attach call in Phase::FFI.pm to attempt to coerce a different treatmet by perl; however, I received exactly the same results.

I really wonder if the problem is actually in FFI::Platypus upon which Phash::FFI depends.  I will open a ticket there and link to this ticket.

Thanks

lbe
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> phash-ffi-hd-test.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl 

use strict;
use warnings;
use utf8;

use File::Basename;
use Phash::FFI;

main: {
    my &#40; $fn1, $fn2 &#41; = @ARGV;

    $&#34; = &#34;\n&#34;;

    my $hash1 = calc_hash&#40;$fn1&#41;;
    my $hash2 = calc_hash&#40;$fn2&#41;;
    my $hd    = hd&#40; $hash1, $hash2 &#41;;
    printf &#34;Distance = %d &lt;- from pHash\n&#34;, $hd;
    printf &#34;Distance = %d &lt;- from PP\n&#34;, hdpp&#40; $hash1, $hash2, 64 &#41;;

    my $s;
    for &#40; 1 .. 8 &#41; {
        $s .= &#34;[      ]&#34;;
    }
    printf &#34;%s  %-16s %s\n&#34;, $s, &#34;Hash in Hex&#34;, &#34;Filename&#34;;

    my $a = sprintf &#34;%064b&#34;, $hash1;
    my $b = sprintf &#34;%064b&#34;, $hash2;

    printf &#34;%s  %x %s\n&#34;, $a, $hash1, basename&#40;$fn1&#41;;
    printf &#34;%s  %x %s\n&#34;, $b, $hash2, basename&#40;$fn2&#41;;

    my $d = 0;
    $s = undef;
    for &#40; 0 .. 63 &#41; {
        my $na = substr&#40; $a, $_, 1 &#41;;
        my $nb = substr&#40; $b, $_, 1 &#41;;
        my $diff = $na eq $nb ? 0 : 1;
        $d += $diff;
        $s .= $diff ? &#34;^&#34; : &#39; &#39;;
    }
    print &#34;$s\n&#34;;
} ## ---------- end main:

sub calc_hash {
    my &#40;$fn&#41; = @_;

    my $hash = Phash::FFI::dct_imagehash&#40;$fn&#41;;

    return &#40;$hash&#41;;
} ## ---------- end sub calc_hash

sub hd {
    my &#40; $hash1, $hash2 &#41; = @_;

    my $hd = Phash::FFI::ph_hamming_distance&#40; $hash1, $hash2 &#41;;

    return &#40;$hd&#41;;
} ## ---------- end sub hd

sub hdpp {
    my &#40; $diff, $bits, $count, $mask &#41; = &#40; $_[0] ^ $_[1], $_[2] || 8, 0 &#41;;

    $mask = 1 &lt;&lt; $_, $diff &#38; $mask &#38;&#38; ++$count for 0 .. $bits - 1;

    $count;
} ## ---------- end sub hdpp

</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> phash-hd-test.cpp</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;25&nbsp;00:08:35&nbsp;2017</span>
    <span class="description">PLICEASE [...] cpan.org -  Cc PLICEASE added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;25&nbsp;00:15:56&nbsp;2017</span>
    <span class="description">PLICEASE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Additional notes:

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/plicease/FFI-Platypus/issues/71">https://github.com/plicease/FFI-Platypus/issues/71</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/gugod/Phash-FFI/pull/4">https://github.com/gugod/Phash-FFI/pull/4</a></span>

Hope it helps.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;25&nbsp;00:15:57&nbsp;2017</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;26&nbsp;13:19:09&nbsp;2017</span>
    <span class="description">LBE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Feb 25 00:15:56 2017, PLICEASE wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Additional notes:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/plicease/FFI-Platypus/issues/71">https://github.com/plicease/FFI-Platypus/issues/71</a></span>
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/gugod/Phash-FFI/pull/4">https://github.com/gugod/Phash-FFI/pull/4</a></span>
&gt; 
&gt; Hope it helps.
</div>
Following the advice of PLICEASE, the following modification fixes the problem:

diff FFI.pm FFI.pm.orig
13c13
&lt; $ffi-&gt;attach&#40;[ ph_hamming_distance =&gt; &#39;ph_hamming_distance&#39; ] =&gt; [ &#39;uint64&#39;, &#39;uint64&#39; ] =&gt; &#39;int&#39;&#41;;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $ffi-&gt;attach&#40;[ ph_hamming_distance =&gt; &#39;ph_hamming_distance&#39; ] =&gt; [ &#39;int&#39;, &#39;int&#39; ] =&gt; &#39;int&#39;&#41;;
</div>
This was tested successfully on 64-bit Debian Jessie
- pHash was built from source &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://phash.org/downloads">http://phash.org/downloads</a></span> - version 0.9.6&#41;
- cimg-dev 1.5.9+dfsg-1 installed via apt

This failed on MacOS Sierra where
- pHash was built from source &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://phash.org/downloads">http://phash.org/downloads</a></span> - version 0.9.6&#41;
- cimg 1.6.9 was installed using Homebrew
The error message received there was: [CImg] *** CImgIOException *** [instance&#40;0,0,0,0,0x0,non-shared&#41;] CImg&lt;unsigned char&gt;::load&#40;&#41;: Failed to open file &#39;test1.jpg&#39;.

I will conduct further tests on MacOS.  I believe the error is due the way the Cimg package is built in Homebrew.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;26&nbsp;13:36:25&nbsp;2017</span>
    <span class="description">LBE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Feb 26 13:19:09 2017, LBE wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sat Feb 25 00:15:56 2017, PLICEASE wrote:
<div class="message-stanza open">&gt; &gt; Additional notes:
&gt; &gt;
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/plicease/FFI-Platypus/issues/71">https://github.com/plicease/FFI-Platypus/issues/71</a></span>
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/gugod/Phash-FFI/pull/4">https://github.com/gugod/Phash-FFI/pull/4</a></span>
&gt; &gt;
&gt; &gt; Hope it helps.
</div>&gt; 
&gt; Following the advice of PLICEASE, the following modification fixes the
&gt; problem:
&gt; 
&gt; diff FFI.pm FFI.pm.orig
&gt; 13c13
&gt; &lt; $ffi-&gt;attach&#40;[ ph_hamming_distance =&gt; &#39;ph_hamming_distance&#39; ] =&gt; [
&gt; &#39;uint64&#39;, &#39;uint64&#39; ] =&gt; &#39;int&#39;&#41;;
&gt; ---
<div class="message-stanza open">&gt; &gt; $ffi-&gt;attach&#40;[ ph_hamming_distance =&gt; &#39;ph_hamming_distance&#39; ] =&gt; [
&gt; &gt; &#39;int&#39;, &#39;int&#39; ] =&gt; &#39;int&#39;&#41;;
</div>&gt; 
&gt; This was tested successfully on 64-bit Debian Jessie
&gt; - pHash was built from source &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://phash.org/downloads">http://phash.org/downloads</a></span> - version
&gt; 0.9.6&#41;
&gt; - cimg-dev 1.5.9+dfsg-1 installed via apt
&gt; 
&gt; This failed on MacOS Sierra where
&gt; - pHash was built from source &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://phash.org/downloads">http://phash.org/downloads</a></span> - version
&gt; 0.9.6&#41;
&gt; - cimg 1.6.9 was installed using Homebrew
&gt; The error message received there was: [CImg] *** CImgIOException ***
&gt; [instance&#40;0,0,0,0,0x0,non-shared&#41;] CImg&lt;unsigned char&gt;::load&#40;&#41;: Failed
&gt; to open file &#39;test1.jpg&#39;.
&gt; 
&gt; I will conduct further tests on MacOS.  I believe the error is due the
&gt; way the Cimg package is built in Homebrew.
</div>
This is actually working on MacOS now.  My previous test failure was user error.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
