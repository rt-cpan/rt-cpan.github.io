<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #37299 for Class-Trigger: inherit</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #37299 for Class-Trigger: inherit</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Class-Trigger/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Class-Trigger/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Class-Trigger/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Class-Trigger/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Class-Trigger">Class-Trigger CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">37299</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Class-Trigger/Active/">Class-Trigger</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ryu1ro [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-7348-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-7349-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;01&nbsp;11:44:31&nbsp;2008</span>
    <span class="description">ryu1ro [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> inherit</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 02 Jul 2008 00:43:32 +0900</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Class-Trigger [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Hiroyuki Kobayashi &lt;ryu1ro [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">package Foo;
use Class::Trigger qw&#40;init&#41;;

sub init {
my $class = shift;
my $self = bless {},$class;
$self-&gt;call_trigger&#40;&#39;init&#39;&#41;;
return $self;
}

__PACKAGE__-&gt;add_trigger&#40;init =&gt; sub { warn &#34;foo&#34;;} &#41;;

package Bar;
use base &#39;Foo&#39;;

__PACKAGE__-&gt;add_trigger&#40;init =&gt; sub { warn &#34;bar&#34;;} &#41;;

package Baz;
use base &#39;Bar&#39;;

__PACKAGE__-&gt;add_trigger&#40;init =&gt; sub { warn &#34;baz&#34;;} &#41;;

package main;
my $foo = Foo-&gt;init;
my $bar = Bar-&gt;init;
my $baz = Baz-&gt;init;

0.12 results
foo at test.pl line 11.
foo at test.pl line 11.
bar at test.pl line 16.
foo at test.pl line 11.
bar at test.pl line 16.
baz at test.pl line 21.

0.13 results
foo at test.pl line 11.
foo at test.pl line 11.
bar at test.pl line 16.
bar at test.pl line 16.
baz at test.pl line 21.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;07&nbsp;13:11:21&nbsp;2009</span>
    <span class="description">MSCHOUT [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> inherited triggers / cache is broken</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This bit me also.

The problem is caused by the addition of the class triggers cache in
0.13.  __fetch_all_triggers&#40;&#41; added this section: 

+    return __cached_triggers&#40;$obj, $when&#41;
+        if $Fetch_All_Triggers_Cache{$class}{$when_key};

But the problem is that __fetch_all_triggers calls itself recursively
farther down, ignoring the return value:

            __fetch_all_triggers&#40;$c, $when, $list, $order, 1&#41;
                unless $c eq $class;

Instead, it depends on __fetch_all_triggers updating $list and $order,
which simply does not happen if the cache is hit.

I fixed this by added a $nocache arg to __fetch_all_triggers.  Patch,
including test case, is attached.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 54da8028048dc8d731003e36fd315a9b50fb7d04 Mon Sep 17 00:00:00 2001
From: Michael Schout &lt;mschout@gkg.net&gt;
Date: Wed, 7 Oct 2009 12:06:16 -0500
Subject: [PATCH] properly handle lookup of inherited triggers in __fetch_all_triggers&#40;&#41;.
 The addition of the cache caused this to break lookups of inherited
 triggers.

---
 lib/Class/Trigger.pm |   11 +++++++----
 t/09_inherit.t       |   40 ++++++++++++++++++++++++++++++++++++++++
 2 files changed, 47 insertions&#40;+&#41;, 4 deletions&#40;-&#41;
 create mode 100644 t/09_inherit.t

diff --git a/lib/Class/Trigger.pm b/lib/Class/Trigger.pm
index 5d1db0f..44f1685 100644
--- a/lib/Class/Trigger.pm
+++ b/lib/Class/Trigger.pm
@@ -87,13 +87,16 @@ sub call_trigger {
 }
 
 sub __fetch_all_triggers {
-    my &#40;$obj, $when, $list, $order&#41; = @_;
+    my &#40;$obj, $when, $list, $order, $nocache&#41; = @_;
+    $nocache = 0 unless defined $nocache;
     my $class = ref $obj || $obj;
     my $return;
     my $when_key = defined $when ? $when : &#39;&#39;;
     
-    return __cached_triggers&#40;$obj, $when&#41;
-        if $Fetch_All_Triggers_Cache{$class}{$when_key};
+    unless &#40;$nocache&#41; {
+        return __cached_triggers&#40;$obj, $when&#41;
+            if $Fetch_All_Triggers_Cache{$class}{$when_key};
+    }
     
     unless &#40;$list&#41; {
         # Absence of the $list parameter conditions the creation of
@@ -112,7 +115,7 @@ sub __fetch_all_triggers {
         next if $list-&gt;{$c};
         if &#40;UNIVERSAL::can&#40;$c, &#39;call_trigger&#39;&#41;&#41; {
             $list-&gt;{$c} = [];
-            __fetch_all_triggers&#40;$c, $when, $list, $order&#41;
+            __fetch_all_triggers&#40;$c, $when, $list, $order, 1&#41;
                 unless $c eq $class;
             if &#40;defined $when &#38;&#38; $Triggers{$c}{$when}&#41; {
                 push @$order, $c;
diff --git a/t/09_inherit.t b/t/09_inherit.t
new file mode 100644
index 0000000..5df3779
--- /dev/null
+++ b/t/09_inherit.t
@@ -0,0 +1,40 @@
+use strict;
+use Test::More tests =&gt; 3;
+
+my @data;
+
+package Foo;
+use Class::Trigger qw&#40;init&#41;;
+
+sub init {
+    my $class = shift;
+    my $self = bless {},$class;
+    $self-&gt;call_trigger&#40;&#39;init&#39;&#41;;
+    return $self;
+}
+
+__PACKAGE__-&gt;add_trigger&#40;init =&gt; sub { push @data, &#39;foo&#39; }&#41;;
+
+package Bar;
+use base &#39;Foo&#39;;
+
+__PACKAGE__-&gt;add_trigger&#40;init =&gt; sub { push @data, &#39;bar&#39; }&#41;;
+
+package Baz;
+use base &#39;Bar&#39;;
+
+__PACKAGE__-&gt;add_trigger&#40;init =&gt; sub { push @data, &#39;baz&#39; }&#41;;
+
+package main;
+
+Foo-&gt;init;
+is join&#40;&#39;:&#39;, @data&#41;, &#39;foo&#39;;
+@data = &#40;&#41;;
+
+Bar-&gt;init;
+is join&#40;&#39;:&#39;, @data&#41;, &#39;foo:bar&#39;;
+@data = &#40;&#41;;
+
+Baz-&gt;init;
+is join&#40;&#39;:&#39;, @data&#41;, &#39;foo:bar:baz&#39;;
+@data = &#40;&#41;;
-- 
1.6.0.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;07&nbsp;13:11:28&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;07&nbsp;13:14:23&nbsp;2009</span>
    <span class="description">MSCHOUT [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">and just to clarify, my patch does not disable the cache.  it only
disables the cache on the recursive __fetch_all_triggers&#40;&#41; calls.  So
triggers are still cached after they are computed the first time.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;08&nbsp;00:55:02&nbsp;2009</span>
    <span class="description">miyagawa [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #37299] inherited triggers / cache is broken</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 7 Oct 2009 21:54:42 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Class-Trigger [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tatsuhiko Miyagawa &lt;miyagawa [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Applied and shipped 0.13_01 to CPAN. Thanks!

On Wed, Oct 7, 2009 at 10:11 AM, MSCHOUT via RT
&lt;bug-Class-Trigger@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       Queue: Class-Trigger
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=37299">https://rt.cpan.org/Ticket/Display.html?id=37299</a></span> &gt;
&gt;
&gt; This bit me also.
&gt;
&gt; The problem is caused by the addition of the class triggers cache in
&gt; 0.13.  __fetch_all_triggers&#40;&#41; added this section:
&gt;
&gt; +    return __cached_triggers&#40;$obj, $when&#41;
&gt; +        if $Fetch_All_Triggers_Cache{$class}{$when_key};
&gt;
&gt; But the problem is that __fetch_all_triggers calls itself recursively
&gt; farther down, ignoring the return value:
&gt;
&gt;            __fetch_all_triggers&#40;$c, $when, $list, $order, 1&#41;
&gt;                unless $c eq $class;
&gt;
&gt; Instead, it depends on __fetch_all_triggers updating $list and $order,
&gt; which simply does not happen if the cache is hit.
&gt;
&gt; I fixed this by added a $nocache arg to __fetch_all_triggers.  Patch,
&gt; including test case, is attached.
&gt;
</div>


-- 
Tatsuhiko Miyagawa
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
