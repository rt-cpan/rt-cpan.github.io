<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #30317 for CGI-Application-PhotoGallery: IfModified  parse problem</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #30317 for CGI-Application-PhotoGallery: IfModified  parse problem</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/CGI-Application-PhotoGallery/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/CGI-Application-PhotoGallery/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/CGI-Application-PhotoGallery/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/CGI-Application-PhotoGallery/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/CGI-Application-PhotoGallery">CGI-Application-PhotoGallery CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">30317</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/CGI-Application-PhotoGallery/Active/">CGI-Application-PhotoGallery</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
tlhackque [...] yahoo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-5444-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.07    </td>
  </tr>
  <tr id="CF-5445-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.08    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;28&nbsp;11:41:58&nbsp;2007</span>
    <span class="description">tlhackque [...] yahoo.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> IfModified  parse problem</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Logs errors trying to check thumbnail cache modification date.  Seems 
to hit all files; extracted just one below for brevity

apache error log:
[Sun Oct 28 10:50:54 2007] [error] [client 192.168.148.108] 
Argument &#34;Thu, 01 Jan 1970 00:00:00 GMT; length=2051&#34; isn&#39;t numeric in 
numeric eq &#40;==&#41; 
at /usr/lib/perl5/site_perl/5.8.8/CGI/Application/PhotoGallery.pm line 
372., referer: <span class="clickylink"><a target="new" rel="nofollow" href="https://gallery.foo.baz/gallery.cgi">https://gallery.foo.baz/gallery.cgi</a></span>

Apache access log
192.168.148.108 - AuthorizedUser [28/Oct/2007:10:50:52 -
0400] &#34;GET /gallery.cgi?mode=thumb&#38;photo=%2FPICT0006.JPG HTTP/1.1&#34; 200 
2051

This is perl, v5.8.8 built for i386-linux-thread-multi

uname -a
Linux xx.foo.baz 2.6.22.2-42.fc6 #1 SMP Wed Aug 15 12:34:26 EDT 2007 
i686 i686 i386 GNU/Linux
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;07&nbsp;08:18:48&nbsp;2007</span>
    <span class="description">bricas [...] cpan.org -  Fixed in 0.08 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;07&nbsp;08:19:47&nbsp;2007</span>
    <span class="description">bricas [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;31&nbsp;13:44:49&nbsp;2008</span>
    <span class="description">tlhackque [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FW: [rt.cpan.org #30317] IfModified parse problem - and some other bug fixes</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 31 Jan 2008 10:43:47 -0800 &#40;PST&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI-Application-PhotoGallery [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> tlhackque &lt;tlhackque [...] yahoo.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Should have copied the attached to the list. 

Hope the attached patches are useful to others.


---------------------------------------------------------
This communication may not represent my employer&#39;s
views,
if any, on the matters discussed. 


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: tlhackque 
Sent: Saturday, January 05, 2008 18:20
To: Brian Cassidy
Subject: RE: [rt.cpan.org #30317] IfModified parse
problem - and some other
bug fixes

I apologize for the VERY late response; I was swamped
for a while &#38; then the
afflicted system was unavailable &#38; the user went
away... 

Yes, this fixes the problem.  Many thanks.

In testing this, I also noticed another couple of
divots.  

        1&#41; When there are any directories containing no
images in the
photo_dir tree, things get very confused.  You assume
that the gallery stack
has an entry for the top level, but fail to push it if
it&#39;s empty.  Things
go badly down hill as you pop something else.  
        2&#41; You return files &#40;and galleries&#41; in the filesystem
order.  People
expect some predictable order.  Best to sort.

Patches for these are below, applied in the attached
.tar file.  Also, my
previous patch, which allows one to set a maximum size
for a displayed
image.

Hope these are useful.

Apologies again for being soo slow.

T
diff
CGI-Application-PhotoGallery-0.08/lib/CGI/Application/PhotoGallery.pm
PhotoGallery.pm
159c159
&lt; our $VERSION = &#39;0.08&#39;;
---
<div class="message-stanza open">&gt; our $VERSION = &#39;0.08t&#39;;
</div>306c306,310
&lt;     my @dirs =
File::Find::Rule-&gt;directory-&gt;maxdepth&#40; 1 &#41;-&gt;in&#40;
$directory
&#41;;
---
<div class="message-stanza open">&gt;     die&#40; &#34;$directory is not a directory&#34; &#41; unless -d
</div>$directory;
<div class="message-stanza open">&gt;
&gt;     my @dirs = File::Find::Rule-&gt;directory -&gt;
</div>mindepth&#40; 1 &#41;
<div class="message-stanza open">&gt;                                          -&gt;
</div>maxdepth&#40; 1 &#41;-&gt;in&#40; $directory
&#41;;
<div class="message-stanza open">&gt;     @dirs = sort @dirs;
</div>309c313
&lt;     for my $dir &#40; @dirs &#41; {
---
<div class="message-stanza open">&gt;     for my $dir &#40; $directory, @dirs &#41; {
</div>311c315
&lt;             $self-&gt;get_photos&#40; $dir &#41;;
---
<div class="message-stanza open">&gt;           $self-&gt;get_photos&#40; $dir &#41;;
</div>313c317,318
&lt;         if &#40; $dir ne $dirs[ 0 ] &#41; {
---
<div class="message-stanza open">&gt;       @files = sort { $$a{filename} cmp
</div>$$b{filename} } @files;
<div class="message-stanza open">&gt;         if &#40; $dir ne $directory &#41; {
</div>319c324
&lt;             {
---
<div class="message-stanza open">&gt;       {
</div>324c329
&lt;             if @files;
---
<div class="message-stanza open">&gt;       if @files || &#40;$dir eq $directory&#41;;
</div>473a479,488
<div class="message-stanza open">&gt;     if&#40; defined $self-&gt;param&#40; &#39;max_width&#39; &#41; &#41; {
&gt;       my $max_width = $self-&gt;param&#40; &#39;max_width&#39; &#41;;
&gt;
&gt;       if&#40; $width &gt; $max_width &#41; {
&gt;           my $scale = $max_width / $width;
&gt;           $width = int&#40;$width * $scale&#41;;
&gt;           $height = int&#40;$height * $scale&#41;;
&gt;       }
&gt;     }
&gt;
</div>
---------------------------------------------------------
This communication may not represent my employer&#39;s
views, if any, on the
matters discussed. 


<div class="message-stanza open">-----Original Message-----
From: Brian Cassidy [mailto:brian.cassidy@gmail.com]
Sent: Monday, October 29, 2007 22:11
To: tlhackque@yahoo.com
Subject: Re: [rt.cpan.org #30317] IfModified parse
problem

On 10/28/07, via RT
&lt;bug-CGI-Application-PhotoGallery@rt.cpan.org&gt; wrote:
<div class="message-stanza open">&gt; Logs errors trying to check thumbnail cache
</div>modification date.  Seems 
<div class="message-stanza open">&gt; to hit all files; extracted just one below for
</div>brevity
<div class="message-stanza open">&gt;
&gt; apache error log:
&gt; [Sun Oct 28 10:50:54 2007] [error] [client
</div>192.168.148.108] Argument 
<div class="message-stanza open">&gt; &#34;Thu, 01 Jan 1970 00:00:00 GMT; length=2051&#34; isn&#39;t
</div>numeric in numeric 
<div class="message-stanza open">&gt; eq &#40;==&#41; at 
&gt;
</div>/usr/lib/perl5/site_perl/5.8.8/CGI/Application/PhotoGallery.pm
line 
<div class="message-stanza open">&gt; 372., referer: <span class="clickylink"><a target="new" rel="nofollow" href="https://gallery.foo.baz/gallery.cgi">https://gallery.foo.baz/gallery.cgi</a></span>
</div>
Ah, it must be my non-parsing of HTTP dates coming
back to bite me.
Attached is a potential fix that uses HTTP::Date. Can
you test it out for
me?

-Brian



<div class="message-stanza open">      ____________________________________________________________________________________
Be a better friend, newshound, and 
know-it-all with Yahoo! Mobile.  Try it now.  <span class="clickylink"><a target="new" rel="nofollow" href="http://mobile.yahoo.com/;_ylt=Ahu06i62sR8HDtDypao8Wcj9tAcJ">http://mobile.yahoo.com/;_ylt=Ahu06i62sR8HDtDypao8Wcj9tAcJ</a></span> 
</div></div></div></div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;31&nbsp;13:45:56&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;05&nbsp;10:58:07&nbsp;2008</span>
    <span class="description">bricas [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Done. Version 0.09 should hit CPAN shortly.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;05&nbsp;10:58:20&nbsp;2008</span>
    <span class="description">bricas [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
