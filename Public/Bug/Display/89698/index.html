<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #89698 for MailTools: Miss-handling null &#34;&lt;&gt;&#34; email addresses</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #89698 for MailTools: Miss-handling null &#34;&lt;&gt;&#34; email addresses</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=MailTools">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=MailTools">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=MailTools">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=MailTools">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/MailTools">MailTools CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">89698</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=MailTools">MailTools</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
thorben.jaendling [...] switch.ch

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-20244-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-20245-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=89698">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1277846" href="/Public/Bug/Display.html?id=89698#txn-1277846">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;22&nbsp;11:34:58&nbsp;2013</span>
    <span class="description">thorben.jaendling [...] switch.ch -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Miss-handling null &#34;&lt;&gt;&#34; email addresses</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 22 Oct 2013 17:34:27 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MailTools [...] rt.cpan.org, bug-AnyEvent-SMTP [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Thorben JÃ¤ndling &lt;thorben.jaendling [...] switch.ch&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1277846/676978/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/676978">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Good day,

While trying to debug a SMTP conversation similar to the one that
follows, I beleive that I have found a bug in Mail::Address &#40;or in
AnyEvent::SMTP&#39;s use of Mail::Address&#39; parse&#40;&#41; method&#41;:

$ telnet my-mta 25
Trying x.x.x.x...
Connected to my-mta.
Escape character is &#39;^]&#39;.
220 my-mta AnyEvent::SMTP Ready.
ehlo me
250 Go on.
mail from:&lt;&gt;
501 Usage: MAIL FROM:&lt;mail addr&gt;
quit
221 Bye.
Connection to my-mta closed by foreign host.
$

It is quite common, in the real world, to have no sender address. In
such cases the null address &#34;&lt;&gt;&#34; is given. &#40;Note &#34;Mail from: \n&#34; ie no
&lt;&gt; is invalid and should error&#41;.

In AnyEvent::SMTP::Server the &#39;mail from&#39; handler has the following two
lines:

my @addrs = map { $_-&gt;address } Mail::Address-&gt;parse&#40;$from&#41;;
@addrs == 1 or return $con-&gt;reply&#40;&#39;501 Usage: MAIL FROM:&lt;mail addr&gt;&#39;&#41;;

However in the case of &lt;&gt; Mail::Address-&gt;parse returns an empty array;
causing the SMTP conversation to incorrectly fail.

Maybe AnyEvent::SMTP::Server should not be using this parse&#40;&#41; method, or
handle the &lt;&gt; case on its own. However my feeling is that parse should
return a one element array, and the element should represent the null
address &#40;e.g. either &#34;&#34; or undef&#41;

Looking at Mail::Addess::parse&#40;&#41;: It tokenises the string, but does not
consider the case where there is no other token between &lt; and &gt;, ie:

for&#40;my $idx = 0; $idx &lt; $len; $idx++&#41;
{
        $_ = $tokens-&gt;[$idx];
        if&#40;substr&#40;$_,0,1&#41; eq &#39;&#40;&#39;&#41; { push @comment, $_ } 
        elsif&#40;$_ eq &#39;&lt;&#39;&#41;    { $depth++ }
        elsif&#40;$_ eq &#39;&gt;&#39;&#41;    { $depth-- if $depth }
        elsif&#40;$_ eq &#39;,&#39; || $_ eq &#39;;&#39;&#41;
        {   ...
        }
        elsif&#40;$depth&#41;       { push @address, $_ }
        ...
}

The &#34;elsif&#40;$depth&#41;&#34; will never be reached, thus the address array
remains empty.

I would suggest fixing the if/elsif logic or having _tokonise&#40;&#41; add an
element in the token array between &lt; and &gt;, maybe undef or &#34;&#34;; if there
is no other token between them.

Regards,

Thorben

-- 
Thorben JÃ¤ndling - Security Engineer: +41 44 268 1576
SWITCH Security: cert@switch.ch  +41 44 268 1540
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.switch.ch/all/cert/contact">http://www.switch.ch/all/cert/contact</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1277948" href="/Public/Bug/Display.html?id=89698#txn-1277948">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;22&nbsp;15:09:03&nbsp;2013</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #89698] Miss-handling null &#34;&lt;&gt;&#34; email addresses</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 22 Oct 2013 21:08:34 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Thorben JÃ¤ndling via RT &lt;bug-MailTools [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1277948/677060/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/677060">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Thorben JÃ¤ndling via RT &#40;bug-MailTools@rt.cpan.org&#41; [131022 15:35]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Tue Oct 22 11:34:58 2013: Request 89698 was acted upon.
&gt; Transaction: Ticket created by thorben.jaendling@switch.ch
&gt;        Queue: MailTools
&gt;      Subject: Miss-handling null &#34;&lt;&gt;&#34; email addresses
&gt; 
&gt; It is quite common, in the real world, to have no sender address. In
&gt; such cases the null address &#34;&lt;&gt;&#34; is given. &#40;Note &#34;Mail from: \n&#34; ie no
&gt; &lt;&gt; is invalid and should error&#41;.
</div>
Are you sure that it is common?  I never receive emails without
sender, and most spamfilters will block it.

My full email collection &#40;since 1993, &gt;75k non-spam emails&#41; does not
contain any From or Sender with &lt;&gt;...   It does contain a very small
number of &#34;Return-Path: &lt;&gt;&#34;, which is reasonable.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In AnyEvent::SMTP::Server the &#39;mail from&#39; handler has the following two
&gt; lines:
&gt; 
&gt; my @addrs = map { $_-&gt;address } Mail::Address-&gt;parse&#40;$from&#41;;
&gt; @addrs == 1 or return $con-&gt;reply&#40;&#39;501 Usage: MAIL FROM:&lt;mail addr&gt;&#39;&#41;;
&gt; 
&gt; However in the case of &lt;&gt; Mail::Address-&gt;parse returns an empty array;
&gt; causing the SMTP conversation to incorrectly fail.
</div>
When I see the code, I think the author wants to be sure that there
is an sender address.  &lt;&gt; is not an address, so the error seems justified.

When I read rfc2822, I see
   angle-addr      =       [CFWS] &#34;&lt;&#34; addr-spec &#34;&gt;&#34; [CFWS]
   addr-spec       =       local-part &#34;@&#34; domain

which makes an address &lt;&gt; illegal.
-- 
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1277949" href="/Public/Bug/Display.html?id=89698#txn-1277949">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;22&nbsp;15:09:03&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1278167" href="/Public/Bug/Display.html?id=89698#txn-1278167">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;23&nbsp;10:16:55&nbsp;2013</span>
    <span class="description">thorben.jaendling [...] switch.ch -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #89698] Miss-handling null &#34;&lt;&gt;&#34; email addresses</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 23 Oct 2013 16:16:24 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MailTools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Thorben JÃ¤ndling &lt;thorben.jaendling [...] switch.ch&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1278167/677181/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/677181">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Mark,

Thank you for your reply.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; It is quite common, in the real world, to have no sender address. In
&gt;&gt; such cases the null address &#34;&lt;&gt;&#34; is given. &#40;Note &#34;Mail from: \n&#34; ie no
&gt;&gt; &lt;&gt; is invalid and should error&#41;.
</div>&gt; 
&gt; Are you sure that it is common?  I never receive emails without
&gt; sender, and most spamfilters will block it.
&gt; 
&gt; My full email collection &#40;since 1993, &gt;75k non-spam emails&#41; does not
&gt; contain any From or Sender with &lt;&gt;...   It does contain a very small
&gt; number of &#34;Return-Path: &lt;&gt;&#34;, which is reasonable.
</div>
We have a lot. Since we&#39;re also intentionally not filtering out spam
before reaching the Perl application. About Return-Path and Sender,
please see my comments below.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; In AnyEvent::SMTP::Server the &#39;mail from&#39; handler has the following two
&gt;&gt; lines:
&gt;&gt;
&gt;&gt; my @addrs = map { $_-&gt;address } Mail::Address-&gt;parse&#40;$from&#41;;
&gt;&gt; @addrs == 1 or return $con-&gt;reply&#40;&#39;501 Usage: MAIL FROM:&lt;mail addr&gt;&#39;&#41;;
&gt;&gt;
&gt;&gt; However in the case of &lt;&gt; Mail::Address-&gt;parse returns an empty array;
&gt;&gt; causing the SMTP conversation to incorrectly fail.
</div>&gt; 
&gt; When I see the code, I think the author wants to be sure that there
&gt; is an sender address.  &lt;&gt; is not an address, so the error seems justified.
</div>
Not according to RFC 5321, which deals with SMTP:

End of Section 3.6.3:

&#34;
One way to prevent loops in error reporting is to specify a null
reverse-path in the MAIL command of a notification message.  When such a
message is transmitted, the reverse-path MUST be set to null &#40;see
Section 4.5.5 for additional discussion&#41;.  A MAIL command with a null
reverse-path appears as follows:

MAIL FROM:&lt;&gt;
&#34;

In 4.1.1.2:

&#34;
The reverse-path consists of the sender mailbox.
....
, the reverse-path may be null....
&#34;

Section 4.1.2. defined the SMTP syntax, you&#39;ll see a Reverse-Path email
address &#40;and so MAIL FROM:&#41; maybe &lt;&gt;

Finally section 4.5.5. is all about such null reverse path email messages.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; When I read rfc2822, I see
&gt;    angle-addr      =       [CFWS] &#34;&lt;&#34; addr-spec &#34;&gt;&#34; [CFWS]
&gt;    addr-spec       =       local-part &#34;@&#34; domain
&gt; 
&gt; which makes an address &lt;&gt; illegal.
&gt; 
</div>
Well then 2822 and 5321 disagree with each other. In which case I&#39;d opt
for something that works for the &#34;in the real world&#34; case; where we both
see &lt;&gt; addresses.


I can accept the opinion that this all needs to be handled in the SMTP
module and not your Mail::Address module. However it is still my feeling
that Mail::Address should be able to acknowledge the existence of &lt;&gt;
email addresses, so that it&#39;s user &#40;e.g. the SMTP module&#41; can act on it.
I would suggest again that it returns &#34;&#34; &#40;empty string&#41; for &lt;&gt;.

Otherwise a wrapping/using module would itself have to parse the entire
address string to determine if any &lt;&gt; is in the address part and not in
a comment or real-name part. i.e. could not just grep for /&lt;&gt;/ in an
address string.


Regards,

Thorben



-- 
Thorben JÃ¤ndling - Security Engineer: +41 44 268 1576
SWITCH Security: cert@switch.ch  +41 44 268 1540
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.switch.ch/all/cert/contact">http://www.switch.ch/all/cert/contact</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1278318" href="/Public/Bug/Display.html?id=89698#txn-1278318">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;23&nbsp;16:24:54&nbsp;2013</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #89698] Miss-handling null &#34;&lt;&gt;&#34; email addresses</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 23 Oct 2013 22:24:35 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Thorben JÃ¤ndling via RT &lt;bug-MailTools [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1278318/677281/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/677281">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Thorben JÃ¤ndling via RT &#40;bug-MailTools@rt.cpan.org&#41; [131023 14:17]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: MailTools
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=89698">https://rt.cpan.org/Ticket/Display.html?id=89698</a></span> &gt;
&gt; 
&gt; Well then 2822 and 5321 disagree with each other. In which case I&#39;d opt
&gt; for something that works for the &#34;in the real world&#34; case; where we both
&gt; see &lt;&gt; addresses.
</div>
2822 got followed-up by 5322.  Also that only speaks about an
empty return path.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I can accept the opinion that this all needs to be handled in the SMTP
&gt; module and not your Mail::Address module. However it is still my feeling
&gt; that Mail::Address should be able to acknowledge the existence of &lt;&gt;
&gt; email addresses, so that it&#39;s user &#40;e.g. the SMTP module&#41; can act on it.
&gt; I would suggest again that it returns &#34;&#34; &#40;empty string&#41; for &lt;&gt;.
</div>
Apparently something has changed.  Discussion is whether the STMP
trick in the spec should be shown in the email address, because it is
not an email address.   The SMTP server can easily check for the
path to be &#34;&lt;&gt;&#34; before parsing.

I may go for changing Mail::Address, but will need to sleep another
night on this subject.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1280272" href="/Public/Bug/Display.html?id=89698#txn-1280272">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;28&nbsp;08:16:52&nbsp;2013</span>
    <span class="description">thorben.jaendling [...] switch.ch -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #89698] Miss-handling null &#34;&lt;&gt;&#34; email addresses</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 28 Oct 2013 13:16:28 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MailTools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Thorben JÃ¤ndling &lt;thorben.jaendling [...] switch.ch&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1280272/678436/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/678436">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Mark,

Just to let you know, my problem/bug has been fixed in the SMTP module,
that uses Mail::Address, with the following changes:

if &#40;$from !~ /^\s*&lt;&gt;\s*$/&#41; {
        @addrs = map { $_-&gt;address }    Mail::Address-&gt;parse&#40;$from&#41;;
        @addrs == 1 or return $con-&gt;reply&#40;&#39;501 Usage: MAIL FROM:&lt;mail addr&gt;&#39;&#41;;
} else {
        @addrs = &#40;&#39;&#39;&#41;;
}

and later &#40;e.g. in RCPT handler&#41;:

defined $con-&gt;{m}{from} or return $con-&gt;reply&#40;&#34;503 Error: need MAIL
command&#34;&#41;;

I am now able to receive and process such emails. At least with this
SMTP module, that I&#39;m using, I don&#39;t know about the others.

You can close this ticket if you want, but I would be interested to know
what you finally decide to do, if anything.

Thank you and regards,

Thorben


On 23.10.13 22:24, Mark Overmeer via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=89698">https://rt.cpan.org/Ticket/Display.html?id=89698</a></span> &gt;
&gt; 
&gt; * Thorben JÃ¤ndling via RT &#40;bug-MailTools@rt.cpan.org&#41; [131023 14:17]:
<div class="message-stanza open">&gt;&gt;        Queue: MailTools
&gt;&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=89698">https://rt.cpan.org/Ticket/Display.html?id=89698</a></span> &gt;
&gt;&gt;
&gt;&gt; Well then 2822 and 5321 disagree with each other. In which case I&#39;d opt
&gt;&gt; for something that works for the &#34;in the real world&#34; case; where we both
&gt;&gt; see &lt;&gt; addresses.
</div>&gt; 
&gt; 2822 got followed-up by 5322.  Also that only speaks about an
&gt; empty return path.
&gt; 
<div class="message-stanza open">&gt;&gt; I can accept the opinion that this all needs to be handled in the SMTP
&gt;&gt; module and not your Mail::Address module. However it is still my feeling
&gt;&gt; that Mail::Address should be able to acknowledge the existence of &lt;&gt;
&gt;&gt; email addresses, so that it&#39;s user &#40;e.g. the SMTP module&#41; can act on it.
&gt;&gt; I would suggest again that it returns &#34;&#34; &#40;empty string&#41; for &lt;&gt;.
</div>&gt; 
&gt; Apparently something has changed.  Discussion is whether the STMP
&gt; trick in the spec should be shown in the email address, because it is
&gt; not an email address.   The SMTP server can easily check for the
&gt; path to be &#34;&lt;&gt;&#34; before parsing.
&gt; 
&gt; I may go for changing Mail::Address, but will need to sleep another
&gt; night on this subject.
&gt; 
</div>

-- 
Thorben JÃ¤ndling - Security Engineer: +41 44 268 1576
SWITCH Security: cert@switch.ch  +41 44 268 1540
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.switch.ch/all/cert/contact">http://www.switch.ch/all/cert/contact</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1280279" href="/Public/Bug/Display.html?id=89698#txn-1280279">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;28&nbsp;10:48:08&nbsp;2013</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #89698] Miss-handling null &#34;&lt;&gt;&#34; email addresses</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 28 Oct 2013 15:47:41 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Thorben JÃ¤ndling via RT &lt;bug-MailTools [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1280279/678441/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/678441">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Thorben JÃ¤ndling via RT &#40;bug-MailTools@rt.cpan.org&#41; [131028 12:17]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: MailTools
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=89698">https://rt.cpan.org/Ticket/Display.html?id=89698</a></span> &gt;
&gt; 
&gt; if &#40;$from !~ /^\s*&lt;&gt;\s*$/&#41; {
&gt;       @addrs = map { $_-&gt;address }    Mail::Address-&gt;parse&#40;$from&#41;;
&gt;       @addrs == 1 or return $con-&gt;reply&#40;&#39;501 Usage: MAIL FROM:&lt;mail addr&gt;&#39;&#41;;
&gt; } else {
&gt;       @addrs = &#40;&#39;&#39;&#41;;
&gt; }
</div>
May I suggest:

  my @addrs;
  if &#40;$from =~ /^\s*&lt;&gt;\s*$/&#41; {
  {  @addrs = &#40;&#39;&#39;&#41;;
  else
  {  @addrs = map $_-&gt;address, Mail::Address-&gt;parse&#40;$from&#41;;
     @addrs == 1 or return $con-&gt;reply&#40;&#39;501 Usage: MAIL FROM:&lt;mail addr&gt;&#39;&#41;;
  }

or &#40;only 1 path through the code reduces bugs&#41;

  my @addrs = $from =~ /^\s*&lt;&gt;\s*$/ ? &#39;&#39;
     : &#40;map $_-&gt;address, Mail::Address-&gt;parse&#40;$from&#41;&#41;;

  @addrs == 1
      or return $con-&gt;reply&#40;&#39;501 Usage: MAIL FROM:&lt;mail addr&gt;&#39;&#41;;
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1419660" href="/Public/Bug/Display.html?id=89698#txn-1419660">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;10&nbsp;14:18:58&nbsp;2014</span>
    <span class="description">MARKOV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1419660/753780/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/753780">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 22b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">not added to MailTools
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1419662" href="/Public/Bug/Display.html?id=89698#txn-1419662">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;10&nbsp;14:18:59&nbsp;2014</span>
    <span class="description">MARKOV [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.404679</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
