<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #56391 for Catalyst-View-Email: Catalyst::View::Email::Template: Body of MIME-Parts not encoded properly</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #56391 for Catalyst-View-Email: Catalyst::View::Email::Template: Body of MIME-Parts not encoded properly</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Catalyst-View-Email/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Catalyst-View-Email/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Catalyst-View-Email/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Catalyst-View-Email/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/dhoss/catalyst-view-email/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Catalyst-View-Email">Catalyst-View-Email CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">56391</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Catalyst-View-Email/Active/">Catalyst-View-Email</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">devin.austin [...] gmail.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
gernotk [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-43746-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-43747-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;08&nbsp;10:08:40&nbsp;2010</span>
    <span class="description">gernotk [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Catalyst::View::Email::Template: Body of MIME-Parts not encoded properly</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 08 Apr 2010 16:08:23 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Catalyst-View-Email [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Gernot Kieseritzky &lt;gernotk [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">In &#39;C::V::Email::Template::generate_part&#39; the result of &#39;$output =
$view-&gt;render&#39; is passed to &#39;Email::MIME-&gt;create&#39; without character set
encoding although &#39;$output&#39; is a Perl string and therefore not encoded.
I suggest the following patch:

@@ -227,5 +227,5 @@
     return Email::MIME-&gt;create&#40;
         attributes =&gt; $e_m_attrs,
-        body       =&gt; $output,
+        body_str   =&gt; $output
     &#41;;
 }

&#39;body_str&#39; will trigger the &#39;body_str&#39;-setter in Email::MIME and encode
the message body according to the specified character set.

There is also a related issue. As of version 0.27 C::V::Email neither
supports specifying a transfer encoding type nor recognizes a default
transfer encoding: It always assumes 7-bit ASCII. However, if &#39;body&#39;
contains characters &gt; 128 they must be encoded using &#39;quoted_printable&#39;,
&#39;base64&#39; or &#39;8bit&#39; as is actually supported by Email::MIME. 

I suggest therefore the following patch:

@@ -274,4 +274,5 @@
     $mime{attributes}-&gt;{content_type} = $email-&gt;{content_type}
       if $email-&gt;{content_type};
+
     if &#40;    $mime{attributes}
         and not $mime{attributes}-&gt;{charset}
@@ -281,4 +282,7 @@
     }

+    $mime{attributes}-&gt;{encoding} = $email-&gt;{encoding}
+      if $email-&gt;{encoding};
+
     my $message = $self-&gt;generate_message&#40; $c, \%mime &#41;;

@@ -309,4 +313,5 @@
     my $default_content_type = $self-&gt;default-&gt;{content_type};
     my $default_charset      = $self-&gt;default-&gt;{charset};
+    my $default_encoding     = $self-&gt;default-&gt;{encoding};

     my $e_m_attrs = {};
@@ -339,4 +344,22 @@
     }

+    if &#40;   exists $attrs-&gt;{encoding}
+        &#38;&#38; defined $attrs-&gt;{encoding}
+        &#38;&#38; $attrs-&gt;{encoding} ne &#39;&#39; &#41;
+    {
+        $c-&gt;log-&gt;debug&#40;
+                      &#39;C::V::Email uses specified encoding &#39;
+                     . $attrs-&gt;{encoding}
+                     . &#39;.&#39; &#41;
+          if $c-&gt;debug;
+        $e_m_attrs-&gt;{encoding} = $attrs-&gt;{encoding};
+    }
+    elsif &#40; defined $default_encoding &#38;&#38; $default_encoding ne &#39;&#39; &#41; {
+        $c-&gt;log-&gt;debug&#40;
+            &#34;C::V::Email uses default encoding $default_encoding.&#34;&#41;
+          if $c-&gt;debug;
+        $e_m_attrs-&gt;{encoding} = $default_encoding;
+    }
+
     return $e_m_attrs;
 }

Thanks,
Gernot Kieseritzky
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;11&nbsp;14:36:41&nbsp;2010</span>
    <span class="description">devin.austin [...] gmail.com -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;11&nbsp;14:37:43&nbsp;2010</span>
    <span class="description">devin.austin [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Apr 08 10:08:40 2010, gernotk@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In &#39;C::V::Email::Template::generate_part&#39; the result of &#39;$output =
&gt; $view-&gt;render&#39; is passed to &#39;Email::MIME-&gt;create&#39; without character set
&gt; encoding although &#39;$output&#39; is a Perl string and therefore not encoded.
&gt; I suggest the following patch:
&gt; 
&gt; @@ -227,5 +227,5 @@
&gt;      return Email::MIME-&gt;create&#40;
&gt;          attributes =&gt; $e_m_attrs,
&gt; -        body       =&gt; $output,
&gt; +        body_str   =&gt; $output
&gt;      &#41;;
&gt;  }
&gt; 
&gt; &#39;body_str&#39; will trigger the &#39;body_str&#39;-setter in Email::MIME and encode
&gt; the message body according to the specified character set.
&gt; 
&gt; There is also a related issue. As of version 0.27 C::V::Email neither
&gt; supports specifying a transfer encoding type nor recognizes a default
&gt; transfer encoding: It always assumes 7-bit ASCII. However, if &#39;body&#39;
&gt; contains characters &gt; 128 they must be encoded using &#39;quoted_printable&#39;,
&gt; &#39;base64&#39; or &#39;8bit&#39; as is actually supported by Email::MIME. 
&gt; 
&gt; I suggest therefore the following patch:
&gt; 
&gt; @@ -274,4 +274,5 @@
&gt;      $mime{attributes}-&gt;{content_type} = $email-&gt;{content_type}
&gt;        if $email-&gt;{content_type};
&gt; +
&gt;      if &#40;    $mime{attributes}
&gt;          and not $mime{attributes}-&gt;{charset}
&gt; @@ -281,4 +282,7 @@
&gt;      }
&gt; 
&gt; +    $mime{attributes}-&gt;{encoding} = $email-&gt;{encoding}
&gt; +      if $email-&gt;{encoding};
&gt; +
&gt;      my $message = $self-&gt;generate_message&#40; $c, \%mime &#41;;
&gt; 
&gt; @@ -309,4 +313,5 @@
&gt;      my $default_content_type = $self-&gt;default-&gt;{content_type};
&gt;      my $default_charset      = $self-&gt;default-&gt;{charset};
&gt; +    my $default_encoding     = $self-&gt;default-&gt;{encoding};
&gt; 
&gt;      my $e_m_attrs = {};
&gt; @@ -339,4 +344,22 @@
&gt;      }
&gt; 
&gt; +    if &#40;   exists $attrs-&gt;{encoding}
&gt; +        &#38;&#38; defined $attrs-&gt;{encoding}
&gt; +        &#38;&#38; $attrs-&gt;{encoding} ne &#39;&#39; &#41;
&gt; +    {
&gt; +        $c-&gt;log-&gt;debug&#40;
&gt; +                      &#39;C::V::Email uses specified encoding &#39;
&gt; +                     . $attrs-&gt;{encoding}
&gt; +                     . &#39;.&#39; &#41;
&gt; +          if $c-&gt;debug;
&gt; +        $e_m_attrs-&gt;{encoding} = $attrs-&gt;{encoding};
&gt; +    }
&gt; +    elsif &#40; defined $default_encoding &#38;&#38; $default_encoding ne &#39;&#39; &#41; {
&gt; +        $c-&gt;log-&gt;debug&#40;
&gt; +            &#34;C::V::Email uses default encoding $default_encoding.&#34;&#41;
&gt; +          if $c-&gt;debug;
&gt; +        $e_m_attrs-&gt;{encoding} = $default_encoding;
&gt; +    }
&gt; +
&gt;      return $e_m_attrs;
&gt;  }
&gt; 
&gt; Thanks,
&gt; Gernot Kieseritzky
&gt; 
</div>
Hi,

Thanks for the patches, can I get test cases for these so I can patch and put together another 
dist?

Thanks,

-Devin
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;11&nbsp;14:37:44&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;20&nbsp;08:36:29&nbsp;2010</span>
    <span class="description">jegade [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Test and patch for handling encoding and charset, if set. To avoid wide 
chars print. Tested for backward compatiblity.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> encoding.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: t/08encoding.t
===================================================================
--- t/08encoding.t	&#40;Revision 0&#41;
+++ t/08encoding.t	&#40;Revision 0&#41;
@@ -0,0 +1,27 @@
+use strict;
+use warnings;
+
+BEGIN { $ENV{EMAIL_SENDER_TRANSPORT} = &#39;Print&#39; }
+use Test::More;
+use Test::Warn;
+
+use Test::Requires {
+    &#39;Catalyst::View::TT&#39; =&gt; &#39;0.31&#39;,
+};
+use Email::Sender::Simple;
+use FindBin;
+use lib &#34;$FindBin::Bin/lib&#34;;
+
+use_ok&#40;&#39;Catalyst::Test&#39;, &#39;TestApp&#39;&#41;;
+
+my $response;
+my $time = time;
+
+# Testk without wide chars 
+warning_is { $response = request&#40;&#34;/template_email?time=$time&#34;&#41; } [],&#34;Without wide chars?&#34; ;
+
+# Test with unicode chars 
+warning_is { $response = request&#40;&#34;/template_email_utf8?time=$time&#34;&#41; } [],&#34;With wide chars&#34; ;
+
+
+done_testing&#40;&#41;;
Index: t/root/text_html/test_utf8.tt
===================================================================
--- t/root/text_html/test_utf8.tt	&#40;Revision 0&#41;
+++ t/root/text_html/test_utf8.tt	&#40;Revision 0&#41;
@@ -0,0 +1,7 @@
+&lt;html&gt;
+ &lt;body&gt;
+  &lt;h1&gt;Look at my style&lt;/h1&gt;
+  &lt;p&gt;I was sent to &lt;em&gt;[% $stash_key.to %]&lt;/em&gt; on [% time %] with some unicode characters â â â  inline and some in the stash [% chars %]&lt;/p&gt;
+ &lt;/body&gt;
+&lt;/html&gt;
+
Index: t/lib/TestApp/Controller/Root.pm
===================================================================
--- t/lib/TestApp/Controller/Root.pm	&#40;Revision 13873&#41;
+++ t/lib/TestApp/Controller/Root.pm	&#40;Arbeitskopie&#41;
@@ -3,6 +3,8 @@
 
 use base qw&#40;Catalyst::Controller&#41;;
 
+use Encode;
+
 sub default : Private {
     my &#40; $self, $c &#41; = @_;
 
@@ -86,6 +88,47 @@
     }
 }
 
+sub template_email_utf8 : Global&#40;&#39;template_email_utf8&#39;&#41; {
+    my &#40;$self, $c, @args&#41; = @_;
+
+    $c-&gt;stash-&gt;{time} = $c-&gt;req-&gt;params-&gt;{time} || time;
+
+    $c-&gt;stash-&gt;{chars} = decode&#40;&#39;utf-8&#39;, &#34;â â â&#34;&#41;;
+
+    $c-&gt;stash-&gt;{email} = {
+        to           =&gt; &#39;test-email@example.com&#39;,
+        from         =&gt; &#39;no-reply@example.com&#39;,
+        subject      =&gt; &#39;Just a test&#39;,
+        content_type =&gt; &#39;multipart/alternative&#39;,
+       templates =&gt; [
+            {
+                template        =&gt; &#39;text_plain/test.tt&#39;,
+                content_type    =&gt; &#39;text/plain&#39;,
+                charset      =&gt; &#39;utf-8&#39;,
+                encoding     =&gt; &#39;quoted-printable&#39;,
+            },
+            {
+                view            =&gt; &#39;TT&#39;,
+                template        =&gt; &#39;text_html/test_utf8.tt&#39;,
+                content_type    =&gt; &#39;text/html&#39;,
+                charset      =&gt; &#39;utf-8&#39;,
+                encoding     =&gt; &#39;quoted-printable&#39;,
+             },
+        ],
+    };
+
+    $c-&gt;forward&#40;&#39;TestApp::View::Email::Template&#39;&#41;;    
+
+    if &#40; scalar&#40; @{ $c-&gt;error } &#41; &#41; {
+        $c-&gt;res-&gt;status&#40;500&#41;;
+        $c-&gt;res-&gt;body&#40;&#39;Template Email Failed&#39;&#41;;
+    } else {
+        $c-&gt;res-&gt;body&#40;&#39;Template Email Ok&#39;&#41;;
+    }
+}
+
+
+
 sub template_email_app_config : Global&#40;&#39;template_email_app_config&#39;&#41; {
     my &#40;$self, $c, @args&#41; = @_;
 
Index: lib/Catalyst/View/Email.pm
===================================================================
--- lib/Catalyst/View/Email.pm	&#40;Revision 13873&#41;
+++ lib/Catalyst/View/Email.pm	&#40;Arbeitskopie&#41;
@@ -280,6 +280,9 @@
         $mime{attributes}-&gt;{charset} = $self-&gt;{default}-&gt;{charset};
     }
 
+    $mime{attributes}-&gt;{encoding} = $email-&gt;{encoding} 
+        if $email-&gt;{encoding};
+
     my $message = $self-&gt;generate_message&#40; $c, \%mime &#41;;
 
     if &#40;$message&#41; {
@@ -307,7 +310,8 @@
     my &#40; $self, $c, $attrs &#41; = @_;
 
     my $default_content_type = $self-&gt;default-&gt;{content_type};
-    my $default_charset      = $self-&gt;default-&gt;{charset};
+    my $default_charset      = $self-&gt;default-&gt;{charset}; 
+    my $default_encoding     = $self-&gt;default-&gt;{encoding};
 
     my $e_m_attrs = {};
 
@@ -338,6 +342,24 @@
         $e_m_attrs-&gt;{charset} = $default_charset;
     }
 
+    if &#40; exists $attrs-&gt;{encoding}
+         &#38;&#38; defined $attrs-&gt;{encoding}
+         &#38;&#38; $attrs-&gt;{encoding} ne &#39;&#39; &#41;
+    {
+        $c-&gt;log-&gt;debug&#40;
+        &#39;C::V::Email uses specified encoding &#39;
+        . $attrs-&gt;{encoding}
+        . &#39;.&#39; &#41;
+         if $c-&gt;debug;
+         $e_m_attrs-&gt;{encoding} = $attrs-&gt;{encoding};
+    }
+     elsif &#40; defined $default_encoding &#38;&#38; $default_encoding ne &#39;&#39; &#41; {
+         $c-&gt;log-&gt;debug&#40;
+         &#34;C::V::Email uses default encoding $default_encoding.&#34;&#41;
+         if $c-&gt;debug;
+         $e_m_attrs-&gt;{encoding} = $default_encoding;
+     }
+
     return $e_m_attrs;
 }
 
Index: lib/Catalyst/View/Email/Template.pm
===================================================================
--- lib/Catalyst/View/Email/Template.pm	&#40;Revision 13873&#41;
+++ lib/Catalyst/View/Email/Template.pm	&#40;Arbeitskopie&#41;
@@ -167,7 +167,7 @@
     my $template_prefix      = $self-&gt;template_prefix;
     my $default_view         = $self-&gt;default-&gt;{view};
     my $default_content_type = $self-&gt;default-&gt;{content_type};
-    my $default_charset      = $self-&gt;default-&gt;{charset};
+    my $default_charset      = $self-&gt;default-&gt;{charset}; 
 
     my $view;
 
@@ -224,10 +224,23 @@
         croak $output-&gt;can&#40;&#39;as_string&#39;&#41; ? $output-&gt;as_string : $output;
     }
 
-    return Email::MIME-&gt;create&#40;
-        attributes =&gt; $e_m_attrs,
-        body       =&gt; $output,
-    &#41;;
+    if &#40; exists $e_m_attrs-&gt;{encoding} 
+        &#38;&#38; defined $e_m_attrs-&gt;{encoding} 
+        &#38;&#38; exists $e_m_attrs-&gt;{charset} 
+        &#38;&#38; defined $e_m_attrs-&gt;{charset} &#41; {
+
+        return Email::MIME-&gt;create&#40;
+            attributes =&gt; $e_m_attrs,
+            body_str   =&gt; $output,
+        &#41;;
+
+    } else {
+
+        return Email::MIME-&gt;create&#40;
+            attributes =&gt; $e_m_attrs,
+            body       =&gt; $output,
+        &#41;;
+    }
 }
 
 =item process
@@ -268,7 +281,8 @@
                     template     =&gt; $part-&gt;{template},
                     content_type =&gt; $part-&gt;{content_type},
                     charset      =&gt; $part-&gt;{charset},
-                }
+                    encoding     =&gt; $part-&gt;{encoding},
+                 }
               &#41;;
         }
     }
Index: META.yml
===================================================================
--- META.yml	&#40;Revision 13873&#41;
+++ META.yml	&#40;Arbeitskopie&#41;
@@ -6,10 +6,11 @@
 build_requires:
   ExtUtils::MakeMaker: 6.42
   Test::More: 0
+  Test::Requires: 0
 configure_requires:
   ExtUtils::MakeMaker: 6.42
 distribution_type: module
-generated_by: &#39;Module::Install version 0.97&#39;
+generated_by: &#39;Module::Install version 1.00&#39;
 license: perl
 meta-spec:
   url: <span class="clickylink"><a target="new" rel="nofollow" href="http://module-build.sourceforge.net/META-spec-v1.4.html">http://module-build.sourceforge.net/META-spec-v1.4.html</a></span>
@@ -22,31 +23,29 @@
 provides:
   Catalyst::Helper::View::Email:
     file: lib/Catalyst/Helper/View/Email.pm
-    version: 0.28
+    version: 0.30
   Catalyst::Helper::View::Email::Template:
     file: lib/Catalyst/Helper/View/Email/Template.pm
-    version: 0.28
+    version: 0.30
   Catalyst::View::Email:
     file: lib/Catalyst/View/Email.pm
-    version: 0.28
+    version: 0.30
   Catalyst::View::Email::Template:
     file: lib/Catalyst/View/Email/Template.pm
-    version: 0.28
+    version: 0.30
 requires:
   Authen::SASL: 2.13
   Catalyst: 5.7
-  Catalyst::View::Mason: 0.18
-  Catalyst::View::TT: 0.31
   Email::MIME: 1.859
   Email::MIME::Creator: 1.455
   Email::Sender::Simple: 0.100110
   MIME::Base64: 3.08
   Moose: 0.93
-  Test::More: 0
+  Test::More: 0.88
   parent: 0.223
 resources:
   IRC: irc://irc.perl.org/#catalyst
   MailingList: <span class="clickylink"><a target="new" rel="nofollow" href="http://lists.scsys.co.uk/cgi-bin/mailman/listinfo/catalyst">http://lists.scsys.co.uk/cgi-bin/mailman/listinfo/catalyst</a></span>
   license: <span class="clickylink"><a target="new" rel="nofollow" href="http://dev.perl.org/licenses/">http://dev.perl.org/licenses/</a></span>
   repository: <span class="clickylink"><a target="new" rel="nofollow" href="http://dev.catalyst.perl.org/repos/Catalyst/Catalyst-View-Email/">http://dev.catalyst.perl.org/repos/Catalyst/Catalyst-View-Email/</a></span>
-version: 0.28
+version: 0.30
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;15&nbsp;17:09:28&nbsp;2013</span>
    <span class="description">devin.austin [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Dec 20 08:36:29 2010, JEGADE wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Test and patch for handling encoding and charset, if set. To avoid wide 
&gt; chars print. Tested for backward compatiblity.
&gt; 
</div>
This has been applied.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;15&nbsp;17:09:29&nbsp;2013</span>
    <span class="description">devin.austin [...] gmail.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
