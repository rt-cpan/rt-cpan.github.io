<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #40104 for Test-Database: Use of File::Temp for temporary files and directories</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #40104 for Test-Database: Use of File::Temp for temporary files and directories</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Test-Database/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Test-Database/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Test-Database/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Test-Database/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Test-Database">Test-Database CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">40104</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Test-Database/Active/">Test-Database</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
MLAWREN [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-224118-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.01</li>
<li>
0.02</li>
</ul>
    </td>
  </tr>
  <tr id="CF-224119-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;16&nbsp;13:34:01&nbsp;2008</span>
    <span class="description">MLAWREN [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Use of File::Temp for temporary files and directories</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

One of my packages once received a bug referring to the use of temporary
files with predictable names.

    <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Bug/Display.html?id=30019">http://rt.cpan.org/Public/Bug/Display.html?id=30019</a></span>

which can apparently be bad news, particularly if tests are run as root.

The suggestion was made to use File::Temp for

    a&#41; creating non-predictable file names; and
    b&#41; removing tempory files/directories on cleanup

Could the same concerns and solution apply here?

A secondary issue is this: what happens when a user runs multiple
Test::Database tests on the same system. Is there a chance for
over-writing and race conditions for /tmp/Test-Database/user/?

I would also find it somewhat cleaner if a temporary files were created
underneath the t/ directory, but I have no logic for that other than
personal preference.

Regards,
Mark.
-- 
Mark Lawrence
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;17&nbsp;04:30:59&nbsp;2008</span>
    <span class="description">book [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> book [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Oct 16 13:34:01 2008, MLAWREN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; One of my packages once received a bug referring to the use of temporary
&gt; files with predictable names.
&gt; 
&gt;     <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Bug/Display.html?id=30019">http://rt.cpan.org/Public/Bug/Display.html?id=30019</a></span>
&gt; 
&gt; which can apparently be bad news, particularly if tests are run as root.
&gt; 
&gt; The suggestion was made to use File::Temp for
&gt; 
&gt;     a&#41; creating non-predictable file names; and
&gt;     b&#41; removing tempory files/directories on cleanup
&gt; 
&gt; Could the same concerns and solution apply here?
</div>
The same concerns definitely apply here.

Non predictable file names will prevent Test::Database to find back the 
database information that is created, and meant to be passed between
tests scripts. So using File::Temp is definitely not an option. We
could make the directory name less predictable by adding some random
information taken on the local system. But I still have to make sure
that Test::Database-&gt;base_dir&#40;&#41; will always return the same value on a
given system.

However, removing the temporary files can be done with a 
Test::Database-&gt;cleanup&#40;&#41; in the last test script.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; A secondary issue is this: what happens when a user runs multiple
&gt; Test::Database tests on the same system. Is there a chance for
&gt; over-writing and race conditions for /tmp/Test-Database/user/?
</div>
Yes, there is. Again, if we want to take advantage of databases nicely 
provided by the host owner, I don&#39;t see many ways to avoid this. Adding a
locking scheme will not help much, if a script that expects the database
to be left in a certain state by the previous test script is started
some other script that just happened to be run at that time.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I would also find it somewhat cleaner if a temporary files were created
&gt; underneath the t/ directory, but I have no logic for that other than
&gt; personal preference.
</div>
Yes, I understand. 

I would say we have several distinct use cases:
1&#41; using databases provided by the host system
   &#40;by way of env vars, configuration&#41;
2&#41; fully setting up the database in a local directory

In case 1&#41;, we can&#39;t avoid race conditions and test scripts stepping on 
each other&#39;s toes. The gain is that we get many more available databases 
systems &#40;e.g., I doubt I&#39;ll ever write a Test::Database::Oracle, but a
CPAN test could provide the connection information to one&#41;.

In case 2&#41;, we can do whatever we want, including having base_dir&#40;&#41;
point inside of t/ and do its stuff there.

I also see a case 1 1/2, where the database information we are given 
comes with full administrative rights on the database, which allows us
to create and drop databases. In that case, we can effectively ensure
we have our own private database, and that any new database that will
be created will have a different name.

What do you think?

-- BooK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;17&nbsp;04:31:01&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;17&nbsp;18:40:32&nbsp;2008</span>
    <span class="description">nomad [...] null.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #40104] Use of File::Temp for temporary files and directories</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 18 Oct 2008 00:40:09 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Philippe &#39;BooK&#39; Bruhat via RT &lt;bug-Test-Database [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Lawrence &lt;nomad [...] null.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I would say we have several distinct use cases:
&gt; 1&#41; using databases provided by the host system
&gt;    &#40;by way of env vars, configuration&#41;
&gt; 2&#41; fully setting up the database in a local directory
&gt; 
&gt; In case 1&#41;, we can&#39;t avoid race conditions and test scripts stepping on 
&gt; each other&#39;s toes. The gain is that we get many more available databases 
&gt; systems &#40;e.g., I doubt I&#39;ll ever write a Test::Database::Oracle, but a
&gt; CPAN test could provide the connection information to one&#41;.
</div>
That is something I think we could live with if it is documented.
However, what is there to stop Test::Database from specifying an
advisory lock in say /var/lock || /var/run || /tmp/test-database.lck?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In case 2&#41;, we can do whatever we want, including having base_dir&#40;&#41;
&gt; point inside of t/ and do its stuff there.
</div>
Agreed.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I also see a case 1 1/2, where the database information we are given 
&gt; comes with full administrative rights on the database, which allows us
&gt; to create and drop databases. In that case, we can effectively ensure
&gt; we have our own private database, and that any new database that will
&gt; be created will have a different name.
&gt; 
&gt; What do you think?
</div>
I think case 1.5 is probably more trouble than it is worth. If the
database is persistent between cleanup&#40;&#41; calls, what is the use case
for named databases? A module that needs to run tests against multiple
databases &#40;of the same type&#41; simultaneously?

Perhaps a method for dynamically defining test databases would work for
file-based:

    use Test::Database;

    Test::Database-&gt;define&#40;
        name   =&gt; &#39;SQLite2&#39;,
        driver =&gt; &#39;SQLite&#39;,
    &#41;;

    my $d1 = Test::Database-&gt;drivers&#40;&#39;SQLite&#39;&#41;;
    my $d2 = Test::Database-&gt;drivers&#40;&#39;SQLite2&#39;&#41;;

Or here is another approach. The first call to drivers&#40;&#39;SQLite&#39;&#41; uses
t/Test-Database/SQLite0/. The second uses t/Test-Database/SQLite1/ and
so on...

However I think it would get messy for the other types. Creating could
require all kinds of external scripts and calling conventions.  And
then there is the cleanup factor to think about. When the tester
removes the source directory his system is clean of file-based.
However for modules where the author has gone and created all kinds of
junk in someones database daemon, and not called cleanup&#40;&#41;/dropdb&#40;&#41; in
the last test &#40;maybe the tests die before they finish...&#41; then that
stuff will hang around forever.

To be honest, I would not attempt to deal with multiple/named databases
until someone steps forward who actually needs such functionality.

Cheers,
Mark.
-- 
Mark Lawrence
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;13&nbsp;07:19:00&nbsp;2009</span>
    <span class="description">book [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
