<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #78395 for ExtUtils-MakeMaker: Win32: Do not  use dlltool to create DLLs</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #78395 for ExtUtils-MakeMaker: Win32: Do not  use dlltool to create DLLs</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=ExtUtils-MakeMaker">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=ExtUtils-MakeMaker">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=ExtUtils-MakeMaker">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=ExtUtils-MakeMaker">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/ExtUtils-MakeMaker">ExtUtils-MakeMaker CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">78395</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=ExtUtils-MakeMaker">ExtUtils-MakeMaker</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">ETJ [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-12494-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-12495-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




0001-Win32-Do-not-use-dlltool-to-create-DLLs.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1099746/578233/0001-Win32-Do-not-use-dlltool-to-create-DLLs.patch">
Mon Jul 16 07:07:24 2012 (2k) by Martin.Schlemmer [...] nwu.ac.za
</a>
</font></li>
</ul>


gcc bad reloc.PNG<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1458443/776018/gcc%20bad%20reloc.PNG">
Thu Jan 29 19:38:42 2015 (62.6k) by BULKDD [...] cpan.org
</a>
</font></li>
</ul>


GCC-BADDLL-0.01.zip<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1458443/776017/GCC-BADDLL-0.01.zip">
Thu Jan 29 19:38:42 2015 (5.8k) by BULKDD [...] cpan.org
</a>
</font></li>
</ul>


objdump -p dump.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1458443/776019/objdump%20-p%20dump.txt">
Thu Jan 29 19:38:42 2015 (23.8k) by BULKDD [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=78395">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1099746" href="/Public/Bug/Display.html?id=78395#txn-1099746">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;16&nbsp;07:07:24&nbsp;2012</span>
    <span class="description">Martin.Schlemmer [...] nwu.ac.za -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Win32: Do not  use dlltool to create DLLs</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1099746/578232/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/578232">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 586b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Using dlltool instead of gcc/ld cause the following problem in some cases:

-----
Error: Can&#39;t load &#39;&lt;Module&gt;.dll&#39; for module &lt;Module&gt;: load_file:Invalid
access to memory location at &lt;Path&gt;/lib/DynaLoader.pm line xxx
-----

This is due to dlltool being depreciated &#40;[1] and [2]&#41;, and instead
ld/gcc should
be used with --enable-auto-image-base. Even with recent binutils &#40;2.22&#41;
this is
still an issue in rare cases, especially when stripping the DLL.

[1] <span class="clickylink"><a target="new" rel="nofollow" href="http://sourceforge.net/mailarchive/message.php?msg_id=29151503">http://sourceforge.net/mailarchive/message.php?msg_id=29151503</a></span>
[2] <span class="clickylink"><a target="new" rel="nofollow" href="http://sourceforge.net/mailarchive/message.php?msg_id=19025935">http://sourceforge.net/mailarchive/message.php?msg_id=19025935</a></span>
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Win32-Do-not-use-dlltool-to-create-DLLs.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1099746/578233/0001-Win32-Do-not-use-dlltool-to-create-DLLs.patch">Download 0001-Win32-Do-not-use-dlltool-to-create-DLLs.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">From ddca82edd6d37255aaa8b7d654df4e38000e3284 Mon Sep 17 00:00:00 2001
From: Martin Schlemmer &lt;Martin.Schlemmer@nwu.ac.za&gt;
Date: Mon, 16 Jul 2012 13:06:10 +0200
Subject: [PATCH] Win32: Do not  use dlltool to create DLLs

Using dlltool instead of gcc/ld cause the following problem in some cases:

-----
Error: Can&#39;t load &#39;&lt;Module&gt;.dll&#39; for module &lt;Module&gt;: load_file:Invalid access to memory location at &lt;Path&gt;/lib/DynaLoader.pm line xxx
-----

This is due to dlltool being depreciated &#40;[1] and [2]&#41;, and instead ld/gcc should
be used with --enable-auto-image-base. Even with recent binutils &#40;2.22&#41; this is
still an issue in rare cases, especially when stripping the DLL.

[1] <span class="clickylink"><a target="new" rel="nofollow" href="http://sourceforge.net/mailarchive/message.php?msg_id=29151503">http://sourceforge.net/mailarchive/message.php?msg_id=29151503</a></span>
[2] <span class="clickylink"><a target="new" rel="nofollow" href="http://sourceforge.net/mailarchive/message.php?msg_id=19025935">http://sourceforge.net/mailarchive/message.php?msg_id=19025935</a></span>
---
 lib/ExtUtils/MM_Win32.pm | 9 ++++-----
 1 file changed, 4 insertions&#40;+&#41;, 5 deletions&#40;-&#41;

diff --git a/lib/ExtUtils/MM_Win32.pm b/lib/ExtUtils/MM_Win32.pm
index 43ae9a4..42b0cf6 100644
--- a/lib/ExtUtils/MM_Win32.pm
+++ b/lib/ExtUtils/MM_Win32.pm
@@ -350,10 +350,9 @@ $&#40;INST_DYNAMIC&#41;: $&#40;OBJECT&#41; $&#40;MYEXTLIB&#41; $&#40;BOOTSTRAP&#41; $&#40;INST_ARCHAUTODIR&#41;$&#40;DFSEP&#41;.
 &#39;&#41;;
     if &#40;$GCC&#41; {
       push&#40;@m,  
-       q{	}.$DLLTOOL.q{ --def $&#40;EXPORT_LIST&#41; --output-exp dll.exp
-	$&#40;LD&#41; -o $@ -Wl,--base-file -Wl,dll.base $&#40;LDDLFLAGS&#41; }.$ldfrom.q{ $&#40;OTHERLDFLAGS&#41; $&#40;MYEXTLIB&#41; $&#40;PERL_ARCHIVE&#41; $&#40;LDLOADLIBS&#41; dll.exp
-	}.$DLLTOOL.q{ --def $&#40;EXPORT_LIST&#41; --base-file dll.base --output-exp dll.exp
-	$&#40;LD&#41; -o $@ $&#40;LDDLFLAGS&#41; }.$ldfrom.q{ $&#40;OTHERLDFLAGS&#41; $&#40;MYEXTLIB&#41; $&#40;PERL_ARCHIVE&#41; $&#40;LDLOADLIBS&#41; dll.exp }&#41;;
+       q{	$&#40;LD&#41; $&#40;EXPORT_LIST&#41; -o $@ $&#40;LDDLFLAGS&#41; }.$ldfrom.q{ }
+       .q{$&#40;OTHERLDFLAGS&#41; $&#40;MYEXTLIB&#41; $&#40;PERL_ARCHIVE&#41; $&#40;LDLOADLIBS&#41; }
+       .q{-Wl,--enable-auto-image-base }&#41;;
     } elsif &#40;$BORLAND&#41; {
       push&#40;@m,
        q{	$&#40;LD&#41; $&#40;LDDLFLAGS&#41; $&#40;OTHERLDFLAGS&#41; }.$ldfrom.q{,$@,,}
@@ -390,7 +389,7 @@ gcc.  Otherwise, take out all *.pdb files.
 sub extra_clean_files {
     my $self = shift;
 
-    return $GCC ? &#40;qw&#40;dll.base dll.exp&#41;&#41; : &#40;&#39;*.pdb&#39;&#41;;
+    return $GCC ? &#40;q{}&#41; : &#40;&#39;*.pdb&#39;&#41;;
 }
 
 =item init_linker
-- 
1.7.11.msysgit.1

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1099968" href="/Public/Bug/Display.html?id=78395#txn-1099968">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;16&nbsp;16:50:29&nbsp;2012</span>
    <span class="description">schwern [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #78395] Win32: Do not  use dlltool to create DLLs</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 16 Jul 2012 13:50:06 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-ExtUtils-MakeMaker [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michael G Schwern &lt;schwern [...] pobox.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1099968/578366/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/578366">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 543b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m not very familiar with Windows build tools, but I cannot find anything
like an official reference that dlltool is deprecated.  Here&#39;s the official
docs from the latest stable of binutils on dlltool.  There&#39;s no mention of it
being deprecated.
<span class="clickylink"><a target="new" rel="nofollow" href="http://sourceware.org/binutils/docs-2.22/binutils/dlltool.html#dlltool">http://sourceware.org/binutils/docs-2.22/binutils/dlltool.html#dlltool</a></span>

That said, whether dlltool is deprecated is irrelevant if there&#39;s a better way
to do it.  MakeMaker&#39;s code for compiling on Windows can use some love.

So, how does one reproduce your problem and any ideas on how to fix it?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1099971" href="/Public/Bug/Display.html?id=78395#txn-1099971">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;16&nbsp;16:50:31&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1100291" href="/Public/Bug/Display.html?id=78395#txn-1100291">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;17&nbsp;13:23:40&nbsp;2012</span>
    <span class="description">Martin.Schlemmer [...] nwu.ac.za -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Martin.Schlemmer [...] nwu.ac.za</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1100291/578520/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/578520">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 819b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jul 16 16:50:29 2012, schwern@pobox.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That said, whether dlltool is deprecated is irrelevant if there&#39;s a
&gt; better way
&gt; to do it.  MakeMaker&#39;s code for compiling on Windows can use some
&gt; love.
&gt; 
&gt; So, how does one reproduce your problem and any ideas on how to fix
&gt; it?
</div>
Currently I can only reproduce it with Cairo-GObject, so not sure if I
can produce a test case. Also I mostly use ActiveState Perl, as its
easier for our setup that I only maintain the Gtk2 stack, and some other
bits not on AS PPM repository, but I can try to get a better test case
with Strawberry if needed?

Anyhow, the fix is the attached patch - do not jump through all the
dlltool/$LD/dlltool/$LD to determine the export list and load address,
but just call $LD with the .def and --enable-auto-image-base as arguments.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1100377" href="/Public/Bug/Display.html?id=78395#txn-1100377">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;17&nbsp;17:42:33&nbsp;2012</span>
    <span class="description">schwern [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #78395] Win32: Do not  use dlltool to create DLLs</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 17 Jul 2012 14:42:19 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-ExtUtils-MakeMaker [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michael G Schwern &lt;schwern [...] pobox.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1100377/578567/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/578567">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 863b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2012.7.17 10:23 AM, Martin Schlemmer via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Currently I can only reproduce it with Cairo-GObject, so not sure if I
&gt; can produce a test case. Also I mostly use ActiveState Perl, as its
&gt; easier for our setup that I only maintain the Gtk2 stack, and some other
&gt; bits not on AS PPM repository, but I can try to get a better test case
&gt; with Strawberry if needed?
</div>
AFAIK Strawberry uses a different compilation chain.  ActiveState depends on
the Microsoft build tools and Strawberry uses MinGW.  Both need attention and
both are pretty opaque to me.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Anyhow, the fix is the attached patch - do not jump through all the
&gt; dlltool/$LD/dlltool/$LD to determine the export list and load address,
&gt; but just call $LD with the .def and --enable-auto-image-base as arguments.
</div>
Any potential down sides?  Does this require relatively up to date build tools?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1100670" href="/Public/Bug/Display.html?id=78395#txn-1100670">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;18&nbsp;13:37:37&nbsp;2012</span>
    <span class="description">Martin.Schlemmer [...] nwu.ac.za -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Martin.Schlemmer [...] nwu.ac.za</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1100670/578733/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/578733">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jul 17 17:42:33 2012, schwern@pobox.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; AFAIK Strawberry uses a different compilation chain.  ActiveState
&gt; depends on the Microsoft build tools
&gt;
</div>
Right, but it works well with MinGW if you create a LD compatible import
libraries for Perl and other modules needed and build with
-mms-bitfields in OPTIMIZE.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; and Strawberry uses MinGW.
&gt;
</div>
I thought it might be a problem with my setup using AS Perl, so I did
some testing with Strawberry &#40;5.14.2&#41;. Initially I could not reproduce
the problem, as Strawberry build with C/LD-FLAGS += &#34; -s &#34;.

If I however do:

-----
perl Makefile.PL
sed -i -e &#34;s: -s : :g&#34; Makefile
dmake
dmake test
strip blib/arch/auto/Cairo/GObject/GObject.dll
dmake test
-----

The last test fails again with the message in initial post.

Applying the fix, above works again, and also the rest of the Gtk2 stack
builds and works fine.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Both need attention and both are pretty opaque to me.
&gt; 
</div>
TBH, for MSFT stuff I cannot really contribute, as I am a Perl/Linux dev
that had to switch to Windows in 2007 due to work.

However, the bits the patch touch is MinGW &#40;Cygwin?&#41; only, so will not
break things for people building with Visual Studio or the Windows SDK.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Anyhow, the fix is the attached patch - do not jump through all the
&gt; &gt; dlltool/$LD/dlltool/$LD to determine the export list and load
</div>&gt; address,
<div class="message-stanza open">&gt; &gt; but just call $LD with the .def and --enable-auto-image-base as
</div>&gt; arguments.
&gt; 
&gt; Any potential down sides?  Does this require relatively up to date
&gt; build tools?
&gt;
</div>
When I started building Gtk2/Gtk2-Perl in 2007 on Windows, I looked at
Tor&#39;s stuff, which already used only LD with --enable-auto-image-base
&#40;older libtool&#39;s did not handle DLLs correctly, so you had to force it&#41;.

I did a search just now, and there is references of
--enable-auto-image-base back to 2002/2003/2005 from the first few
pages, and most of those are gcc/libtool/other libraries, and not binutils.

According to above, I would say no to potential down sides and up to
date build tools.

Lastly, MinGW GCC versions have for LINK_SPEC &#40;added back in 2002-12-05&#41;:

  %{shared|mdll: -e _DllMainCRTStartup@12 --enable-auto-image-base}

so I think this dlltool usage is really only due to supporting GCC
versions before 3.2.3/3.3.1 &#40;if I read the ChangeLog&#39;s correctly&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1352872" href="/Public/Bug/Display.html?id=78395#txn-1352872">#</a>      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;20&nbsp;19:38:25&nbsp;2014</span>
    <span class="description">VADZ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1352872/717902/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/717902">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jul 16 16:50:29 2012, schwern@pobox.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So, how does one reproduce your problem and any ideas on how to fix
&gt; it?
</div>
Just another data point: I&#39;m trying to install Wx in a fresh ActivePerl
5.16.3 &#40;build 1604&#41; installation. ActivePerl automatically installs ancient
MinGW 3.4.5 compiler and so this is what is used for building non-pure Perl
modules. And I am running into another problem with dlltool: the build of
Wx fails with this error:

        c:\Perl\site\lib\auto\MinGW\bin\dlltool.exe --def RichText.def --base-file dll.base --output-exp dll.exp
        c:\Perl\site\lib\auto\MinGW\bin\dlltool.exe: Unable to open base-file: dll.base
        dmake.exe:  Error code 129, while making &#39;..\..\blib\arch\auto\Wx\RichText\RichText.dll&#39;

I have no idea what is supposed to happen here as the file dll.base doesn&#39;t
exist and doesn&#39;t seem to be generated by anything. However, not really
surprisingly, but rather helpfully, applying the patch above dropping the
use of dlltool completely fixes the problem.

Once again, I&#39;m doing this in a completely fresh installation of Windows 7
with just ActivePerl installed, so this should be 100% reproducible if you
are still looking for a way to reproduce the problem.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1445104" href="/Public/Bug/Display.html?id=78395#txn-1445104">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;21&nbsp;18:49:34&nbsp;2014</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1445104/768317/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/768317">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 652b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This bug is not a bug in dlltool. Its a bug in the relocations that ld produces for the dll. It only happens on AS&#39;s 3.4.5 Vista special r3 compiler.

here is a test case written by mithaldu a long time ago showing the crash without using dlltool.

Any instance of &#34;load_file:Invalid access to memory location at&#34; from dynaloader means a SEGV occured in DllMain in LoadLibrary, but it was trapped &#40;using SEH&#41; and turned an error code and the DLL was unloaded from memory. 99% of XS modules do not define their own DllMain, sine that is a Win32 only feature, so the DllMain code and a SEGV in it is strictly the responsibility of the C compiler authors.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1445107" href="/Public/Bug/Display.html?id=78395#txn-1445107">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;21&nbsp;18:50:20&nbsp;2014</span>
    <span class="description">Martin.Schlemmer [...] nwu.ac.za -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #78395] Win32: Do not  use dlltool to create DLLs</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 22 Dec 2014 01:49:56 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-ExtUtils-MakeMaker [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Martin Schlemmer&#34; &lt;Martin.Schlemmer [...] nwu.ac.za&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1445107/768320/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/768320">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Martin Schlemmer recently passed away. Please contact one of the following persons for any enquiries.

Martin Puttkammer    018 299 1512     martin.puttkammer@nwu.ac.za
Roald Eiselen            018 299 1512     roald.eiselen@nwu.ac.za
Charlene Schoeman  018 299 1509    charlene.schoeman@nwu.ac.za

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&gt;&gt; &#34;Daniel Dragan via RT&#34; &lt;bug-ExtUtils-MakeMaker@rt.cpan.org&gt; 12/22/14 01:49 &gt;&gt;&gt;
</div>
&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=78395">https://rt.cpan.org/Ticket/Display.html?id=78395</a></span> &gt;

This bug is not a bug in dlltool. Its a bug in the relocations that ld produces for the dll. It only happens on AS&#39;s 3.4.5 Vista special r3 compiler.

here is a test case written by mithaldu a long time ago showing the crash without using dlltool.

Any instance of &#34;load_file:Invalid access to memory location at&#34; from dynaloader means a SEGV occured in DllMain in LoadLibrary, but it was trapped &#40;using SEH&#41; and turned an error code and the DLL was unloaded from memory. 99% of XS modules do not define their own DllMain, sine that is a Win32 only feature, so the DllMain code and a SEGV in it is strictly the responsibility of the C compiler authors.

Vrywaringsklousule / Disclaimer:  <span class="clickylink"><a target="new" rel="nofollow" href="http://www.nwu.ac.za/it/gov-man/disclaimer.html">http://www.nwu.ac.za/it/gov-man/disclaimer.html</a></span> 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people DelWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1445116" href="/Public/Bug/Display.html?id=78395#txn-1445116">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;21&nbsp;20:36:59&nbsp;2014</span>
    <span class="description">ether [...] cpan.org -  Requestor azarah deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1445120" href="/Public/Bug/Display.html?id=78395#txn-1445120">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;21&nbsp;20:39:12&nbsp;2014</span>
    <span class="description">ETJ [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1458443" href="/Public/Bug/Display.html?id=78395#txn-1458443">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;29&nbsp;19:38:42&nbsp;2015</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1458443/776016/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/776016">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jul 16 07:07:24 2012, azarah wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Using dlltool instead of gcc/ld cause the following problem in some cases:
&gt; 
&gt; -----
&gt; Error: Can&#39;t load &#39;&lt;Module&gt;.dll&#39; for module &lt;Module&gt;: load_file:Invalid
&gt; access to memory location at &lt;Path&gt;/lib/DynaLoader.pm line xxx
&gt; -----
&gt; 
&gt; This is due to dlltool being depreciated &#40;[1] and [2]&#41;, and instead
&gt; ld/gcc should
&gt; be used with --enable-auto-image-base. Even with recent binutils &#40;2.22&#41;
&gt; this is
&gt; still an issue in rare cases, especially when stripping the DLL.
&gt; 
&gt; [1] <span class="clickylink"><a target="new" rel="nofollow" href="http://sourceforge.net/mailarchive/message.php?msg_id=29151503">http://sourceforge.net/mailarchive/message.php?msg_id=29151503</a></span>
&gt; [2] <span class="clickylink"><a target="new" rel="nofollow" href="http://sourceforge.net/mailarchive/message.php?msg_id=19025935">http://sourceforge.net/mailarchive/message.php?msg_id=19025935</a></span>
</div>
The OP is gone, but under no circumstances is &#34;--enable-auto-image-base&#34; a replacement for having reloc info on DLLs. Hashes collide. The amount of slots in a 32 bit process is very small, 0+0x0FFC0000/0x00010000 = 4092 slots <span class="clickylink"><a target="new" rel="nofollow" href="http://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;a=blob;f=ld/emultempl/pe.em;h=60882cef9095c174a17224d0af8355ab51637701;hb=HEAD#l143">http://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;a=blob;f=ld/emultempl/pe.em;h=60882cef9095c174a17224d0af8355ab51637701;hb=HEAD#l143</a></span> <span class="clickylink"><a target="new" rel="nofollow" href="http://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;a=blob;f=ld/emultempl/pe.em;h=60882cef9095c174a17224d0af8355ab51637701;hb=HEAD#l945">http://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;a=blob;f=ld/emultempl/pe.em;h=60882cef9095c174a17224d0af8355ab51637701;hb=HEAD#l945</a></span>  . Each DLL will be mapped starting at a multiple of 64KB, per rules of Win32/64 Memory Manager. Now some DLLs are really fat, like OpenSSL. libeay32.dll is 1172KB mapped + 44KB &#40;padding to next boundary&#41; = 1216KB, ssleay32.dll is 284KB+36KB=320KB.

From a real strawberry 5.18 process

&#34;63300000&#34;      &#34;Image&#34; &#34;1,520&#34; &#34;1,520&#34; &#34;44&#34;    &#34;1,168&#34; &#34;28&#34;    &#34;1,140&#34; &#34;&#34;      &#34;&#34;      &#34;10&#34;    &#34;Execute/Read/Write&#34;    &#34;C:\sperl\perl\bin\perl518.dll&#34;
&#34;6347C000&#34;      &#34;Unusable&#34;      &#34;16&#34;    &#34;16&#34;    &#34;&#34;      &#34;&#34;      &#34;&#34;      &#34;&#34;      &#34;&#34;      &#34;&#34;      &#34;&#34;      &#34;&#34;      &#34;&#34;


&#34;6CEC0000&#34;      &#34;Image&#34; &#34;120&#34;   &#34;120&#34;   &#34;20&#34;    &#34;48&#34;    &#34;12&#34;    &#34;36&#34;    &#34;&#34;      &#34;&#34;      &#34;9&#34;     &#34;Execute/Read&#34;  &#34;C:\sperl\perl\bin\libgcc_s_sjlj-1.dll&#34;
&#34;6CEDE000&#34;      &#34;Unusable&#34;      &#34;8&#34;     &#34;8&#34;     &#34;&#34;      &#34;&#34;      &#34;&#34;      &#34;&#34;      &#34;&#34;      &#34;&#34;      &#34;&#34;      &#34;&#34;      &#34;&#34;

&#34;6FC40000&#34;      &#34;Image&#34; &#34;832&#34;   &#34;832&#34;   &#34;44&#34;    &#34;108&#34;   &#34;24&#34;    &#34;84&#34;    &#34;&#34;      &#34;&#34;      &#34;11&#34;    &#34;Execute/Read&#34;  &#34;C:\sperl\perl\bin\libstdc++-6.dll&#34;

&#34;70840000&#34;      &#34;Image&#34; &#34;76&#34;    &#34;76&#34;    &#34;24&#34;    &#34;48&#34;    &#34;12&#34;    &#34;36&#34;    &#34;&#34;      &#34;&#34;      &#34;9&#34;     &#34;Execute/Read&#34;  &#34;C:\sperl\perl\lib\auto\Win32\Win32.dll&#34;
&#34;70853000&#34;      &#34;Unusable&#34;      &#34;52&#34;    &#34;52&#34;    &#34;&#34;      &#34;&#34;      &#34;&#34;      &#34;&#34;      &#34;&#34;      &#34;&#34;      &#34;&#34;      &#34;&#34;      &#34;&#34;

so summing all of that up means 2624 KB are gone automatically in a typical GCC Win32 Perl from the window in which GCC lays down hashed base addresses, so the odds of a hash collision are

&#40;0x0FFC0000 - &#40;2624 * 0x10000&#41;&#41; / 0x00010000 = 0x5BC = 1468 64 KB slots

1:1468 for a tiny, &lt;= 64 KB DLL, means a pretty good chance of a collision, and it is nearly guaranteed for a fat XS DLL

so there is no way to say &#34;we dont need reloc info on DLLs with GCC Win32 Perl&#34; unless you like playing 1:1468 odds

So, here is sample module, that will build on EUMM, but the XS DLL can never be loaded into a process, because of the 2 runs of dlltool, and 2 runs of g++ as LD, create a junk binary when combined with declspec&#40;dllexport&#41;.

Unlike my last post where I blamed Mingw GCC&#39;s 3.4.5&#39;s linker, this DLL won&#39;t execute with strawberry 5.18/gcc 4.6.3. The specific reason is, that the reloc info appears twice in the final DLL. I&#39;ve attached a screenshot of the actual SEGV inside DLL main and the fault address.

The DLL was originally at, 0x00400000, but there was a conflict, so it was relocated to &#40;picked by OS&#41; 0x00970000. The fault address is 0x00EE5014. Now look at this equation,

        
0x00970000 - 0x00400000 = 0x570000
new addr - orig addr = adjustment offset by OS
        
orig addr + adjustment offset +adjustment offset &#40;why on earth twice?&#41;
0x00400000 + 0x570000 + 0x570000 = 0xEE0000

0xEE5014 is the SEGV address

So it means there were 2 relocation entries for after relocation machine code address 0x00971429, notice 0x00971427 is not the place to do the relocation, 0xC7 0x05 is the x86 opcode, the next 4 bytes &#34;14 50 EE 00&#34; are the destination operand, so 0x00971429 is the correct place for the relocation, not 0x00971427.

Now to verify the hypothesis with &#34;objdump -p blib\arch/auto/GCC/BADDLL/BADDLL.dll&#34; which i&#39;ve attached a full dump of
---------------------------------------
****************cut********************
PE File Base Relocations &#40;interpreted .reloc section contents&#41;

Virtual Address: 00001000 Chunk size 324 &#40;0x144&#41; Number of fixups 158
        reloc    0 offset   1d [101d] HIGHLOW
****************cut********************
        reloc   29 offset  2c1 [12c1] HIGHLOW
        reloc   30 offset  429 [1429] HIGHLOW
        reloc   31 offset  467 [1467] HIGHLOW
****************cut********************
Virtual Address: 00001000 Chunk size 320 &#40;0x140&#41; Number of fixups 156
        reloc    0 offset   1d [101d] HIGHLOW
****************cut********************
        reloc   29 offset  2c1 [12c1] HIGHLOW
        reloc   30 offset  429 [1429] HIGHLOW
        reloc   31 offset  467 [1467] HIGHLOW
****************cut********************
---------------------------------------

yep, 2 relocation entries for offset into the DLL 0x1429
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> GCC-BADDLL-0.01.zip</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1458443/776017/GCC-BADDLL-0.01.zip">Download GCC-BADDLL-0.01.zip</a><br />
<span class="downloadcontenttype">application/x-zip-compressed 5.8k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> gcc bad reloc.PNG</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1458443/776018/gcc%20bad%20reloc.PNG">Download gcc bad reloc.PNG</a><br />
<span class="downloadcontenttype">image/png 62.6k</span>
</div>
<div class="messagebody">
<img alt="gcc bad reloc.PNG" title="gcc bad reloc.PNG" src="/Ticket/Attachment/1458443/776018/" /></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> objdump -p dump.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1458443/776019/objdump%20-p%20dump.txt">Download objdump -p dump.txt</a><br />
<span class="downloadcontenttype">text/plain 23.8k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1458445" href="/Public/Bug/Display.html?id=78395#txn-1458445">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;29&nbsp;20:01:32&nbsp;2015</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1458445/776021/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/776021">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Now to explain the Mingw GCC EUMM build process a little bit &#40;as much as I know, and I dont know very much except from trial and error today&#41;, this is the latter half of &#34;dmake -n test&#34;, with Straberry 5.18&#39;s gcc 4.6.3


C:\sperl\perl\bin\perl.exe C:\sperl\perl\lib\ExtUtils\xsubpp  -typemap C:\sperl\perl\lib\ExtUtils\typemap  BADDLL.xs &gt; BADDLL.xsc &#38;&#38; C:\sperl\perl\bin\perl.exe -MExtUtils::Command -e mv -- BADDLL.xsc BADDLL.c


make the .xs into a .c, ok

gcc -c  -I.  -s -O2 -DWIN32 -DPERL_TEXTMODE_SCRIPTS -DPERL_IMPLICIT_CONTEXT -DPERL_IMPLICIT_SYS -DUSE_PERLIO -fno-strict-aliasing -mms-bitfields -s -O2    -DVERSION=\&#34;0.01\&#34;  -DXS_VERSION=\&#34;0.01\&#34;  &#34;-IC:\sperl\perl\lib\CORE&#34;   BADDLL.c

turn .c into .o, ok

C:\sperl\perl\bin\perl.exe -l -e &#34;print qq{@ARGV}&#34; -- &#34;Running Mkbootstrap for GCC::BADDLL &#40;&#41;&#34;
C:\sperl\perl\bin\perl.exe &#34;-MExtUtils::Mkbootstrap&#34;   -e &#34;Mkbootstrap&#40;&#39;BADDLL&#39;,&#39;&#39;&#41;;&#34;
C:\sperl\perl\bin\perl.exe -MExtUtils::Command -e touch -- BADDLL.bs
C:\sperl\perl\bin\perl.exe -MExtUtils::Command -e chmod -- 644 BADDLL.bs

make .bs file, ok

C:\sperl\perl\bin\perl.exe -MExtUtils::Mksymlists      -e &#34;Mksymlists&#40;&#39;NAME&#39;=&gt;\&#34;GCC::BADDLL\&#34;, &#39;DLBASE&#39; =&gt; &#39;BADDLL&#39;, &#39;DL_FUNCS&#39; =&gt; {  }, &#39;FUNCLIST&#39; =&gt; [q[boot_GCC__BADDLL]], &#39;IMPORTS&#39; =&gt; {  }, &#39;DL_VARS&#39; =&gt; []&#41;;&#34;

make .def file

dlltool --def BADDLL.def --output-exp dll.exp

take in ASCII .def, make binary COFF dll.exp file

g++ -o blib\arch\auto\GCC\BADDLL\BADDLL.dll -Wl,--base-file -Wl,dll.base -mdll -s -L&#34;C:\sperl\perl\lib\CORE&#34; -L&#34;C:\sperl\c\lib&#34; BADDLL.o -Wl,--image-base=0x00400000  C:\sperl\perl\lib\CORE\libperl518.a -lmoldname -lkernel32 -luser32 -lgdi32 -lwinspool -lcomdlg32 -ladvapi32 -lshell32 -lole32 -loleaut32 -lnetapi32 -luuid -lws2_32 -lmpr -lwinmm -lversion -lodbc32 -lodbccp32 -lcomctl32 dll.exp

this is where the build process differs, based on whether function &#34;getfive&#34; had declspec&#40;dllexport&#41; or not, 2 things are made here

-dll.base fil, the dll.base is binary, and is not a COFF file
- DLL blib\arch\auto\GCC\BADDLL\BADDLL.dll

if the baddll.c/baddll.xs DOES NOT have declspec&#40;dllexport&#41;, then dll blib\arch\auto\GCC\BADDLL\BADDLL.dll DOES NOT have a relocation table, it will only be loadedable into a process if no base address conflict

if the baddll.c/baddll.xs DOES have declspec&#40;dllexport&#41;, then dll blib\arch\auto\GCC\BADDLL\BADDLL.dll DOES have a relocation table, with NO duplicate reloc entries, ready to run


dlltool --def BADDLL.def --base-file dll.base --output-exp dll.exp

take in baddll.def and dll.base, output dll.exp

g++ -o blib\arch\auto\GCC\BADDLL\BADDLL.dll -mdll -s -L&#34;C:\sperl\perl\lib\CORE&#34; -L&#34;C:\sperl\c\lib&#34; BADDLL.o -Wl,--image-base=0x00400000  C:\sperl\perl\lib\CORE\libperl518.a -lmoldname -lkernel32 -luser32 -lgdi32 -lwinspool -lcomdlg32 -ladvapi32 -lshell32 -lole32 -loleaut32 -lnetapi32 -luuid -lws2_32 -lmpr -lwinmm -lversion -lodbc32 -lodbccp32 -lcomctl32 dll.exp 

create blib\arch\auto\GCC\BADDLL\BADDLL.dll again, this time not producing dll.base, and taking in a new, 2nd version of dll.exp

this is again where the build process differs

if the baddll.c/baddll.xs DOES NOT have declspec&#40;dllexport&#41;, then dll blib\arch\auto\GCC\BADDLL\BADDLL.dll gets a relocation table, now its ready to run

if the baddll.c/baddll.xs DOES have declspec&#40;dllexport&#41;, then dll blib\arch\auto\GCC\BADDLL\BADDLL.dll gets 2 copies of a relocation table, with duplicate reloc entries, and this is a junk dll/binary, this dll IS NOT ready to run and is permanently broken


C:\sperl\perl\bin\perl.exe -MExtUtils::Command -e chmod -- 755 blib\arch\auto\GCC\BADDLL\BADDLL.dll
C:\sperl\perl\bin\perl.exe -MExtUtils::Command -e rm_rf -- blib\arch\auto\GCC\BADDLL\BADDLL.bs
C:\sperl\perl\bin\perl.exe -MExtUtils::Command -e cp -- BADDLL.bs blib\arch\auto\GCC\BADDLL\BADDLL.bs
C:\sperl\perl\bin\perl.exe -MExtUtils::Command -e chmod -- 644 blib\arch\auto\GCC\BADDLL\BADDLL.bs
rem
rem
rem
C:\sperl\perl\bin\perl.exe &#34;-MExtUtils::Command::MM&#34; &#34;-e&#34; &#34;test_harness&#40;0, &#39;blib\lib&#39;, &#39;blib\arch&#39;&#41;&#34; t/*.t
rem

boilerplate, uninteresting
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.684144</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
