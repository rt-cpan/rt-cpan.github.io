<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #81268 for Digest-SHA: Digest::SHA uses SvPV instead of SvPVbyte</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #81268 for Digest-SHA: Digest::SHA uses SvPV instead of SvPVbyte</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Digest-SHA">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Digest-SHA">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Digest-SHA">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Digest-SHA">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Digest-SHA">Digest-SHA CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">81268</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time estimated">
    <td class="label">Estimated:</td>
    <td class="value">1 hour (60 min)

</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">1 hour (60 min)

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Digest-SHA">Digest-SHA</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">mshelor [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
IKEGAMI [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-11544-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
5.73    </td>
  </tr>
  <tr id="CF-11545-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
5.74    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




0001-Handle-UTF8-1-strings-properly.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1144112/601707/0001-Handle-UTF8-1-strings-properly.patch">
Sun Nov 18 20:55:32 2012 (4.9k) by IKEGAMI [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=81268">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1144112" href="/Public/Bug/Display.html?id=81268#txn-1144112">#</a>      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;18&nbsp;20:55:32&nbsp;2012</span>
    <span class="description">IKEGAMI [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Digest::SHA uses SvPV instead of SvPVbyte</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1144112/601706/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/601706">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 321b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Digest::SHA silently corrupts its output when the input happens to be
upgraded, i.e. the same two perl strings cause different output.

This is caused by Digest::SHA accessing the strings using SvPV without
checking the choice of storage format. It should use SvPVbyte instead.

Patch &#40;including tests&#41; attached.

- Eric
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Handle-UTF8-1-strings-properly.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1144112/601707/0001-Handle-UTF8-1-strings-properly.patch">Download 0001-Handle-UTF8-1-strings-properly.patch</a><br />
<span class="downloadcontenttype">text/x-diff 4.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 92ee28af35ff2740252f67812d02fb6530935e92 Mon Sep 17 00:00:00 2001
From: Eric Brine &lt;ikegami@adaelis.com&gt;
Date: Sun, 18 Nov 2012 20:43:46 -0500
Subject: [PATCH] Handle UTF8=1 strings properly

---
 MANIFEST          |    1 +
 SHA.xs            |   12 +++++--
 lib/Digest/SHA.pm |    5 +++
 t/wide_strs.t     |   83 +++++++++++++++++++++++++++++++++++++++++++++++++++++
 4 files changed, 97 insertions&#40;+&#41;, 4 deletions&#40;-&#41;
 create mode 100644 t/wide_strs.t

diff --git a/MANIFEST b/MANIFEST
index 9f22adc..02735a8 100644
--- a/MANIFEST
+++ b/MANIFEST
@@ -36,5 +36,6 @@ t/sha224.t
 t/sha256.t
 t/sha384.t
 t/sha512.t
+t/wide_strs.t
 t/woodbury.t
 typemap
diff --git a/SHA.xs b/SHA.xs
index 8124a5d..264ef6d 100644
--- a/SHA.xs
+++ b/SHA.xs
@@ -2,6 +2,10 @@
 #include &#34;perl.h&#34;
 #include &#34;XSUB.h&#34;
 
+#ifndef SvPVbyte
+#define SvPVbyte&#40;sv, len&#41; SvPV&#40;sv, len&#41;
+#endif
+
 #include &#34;src/sha.c&#34;
 #include &#34;src/hmac.c&#34;
 
@@ -87,7 +91,7 @@ PPCODE:
 	if &#40;&#40;state = shaopen&#40;ix2alg[ix]&#41;&#41; == NULL&#41;
 		XSRETURN_UNDEF;
 	for &#40;i = 0; i &lt; items; i++&#41; {
-		data = &#40;unsigned char *&#41; &#40;SvPV&#40;ST&#40;i&#41;, len&#41;&#41;;
+		data = &#40;unsigned char *&#41; &#40;SvPVbyte&#40;ST&#40;i&#41;, len&#41;&#41;;
 		while &#40;len &gt; MAX_WRITE_SIZE&#41; {
 			shawrite&#40;data, MAX_WRITE_SIZE &lt;&lt; 3, state&#41;;
 			data += MAX_WRITE_SIZE;
@@ -141,11 +145,11 @@ PREINIT:
 	HMAC *state;
 	char *result;
 PPCODE:
-	key = &#40;unsigned char *&#41; &#40;SvPV&#40;ST&#40;items-1&#41;, len&#41;&#41;;
+	key = &#40;unsigned char *&#41; &#40;SvPVbyte&#40;ST&#40;items-1&#41;, len&#41;&#41;;
 	if &#40;&#40;state = hmacopen&#40;ix2alg[ix], key, len&#41;&#41; == NULL&#41;
 		XSRETURN_UNDEF;
 	for &#40;i = 0; i &lt; items - 1; i++&#41; {
-		data = &#40;unsigned char *&#41; &#40;SvPV&#40;ST&#40;i&#41;, len&#41;&#41;;
+		data = &#40;unsigned char *&#41; &#40;SvPVbyte&#40;ST&#40;i&#41;, len&#41;&#41;;
 		while &#40;len &gt; MAX_WRITE_SIZE&#41; {
 			hmacwrite&#40;data, MAX_WRITE_SIZE &lt;&lt; 3, state&#41;;
 			data += MAX_WRITE_SIZE;
@@ -193,7 +197,7 @@ PREINIT:
 PPCODE:
 	state = INT2PTR&#40;SHA *, SvIV&#40;SvRV&#40;SvRV&#40;self&#41;&#41;&#41;&#41;;
 	for &#40;i = 1; i &lt; items; i++&#41; {
-		data = &#40;unsigned char *&#41; &#40;SvPV&#40;ST&#40;i&#41;, len&#41;&#41;;
+		data = &#40;unsigned char *&#41; &#40;SvPVbyte&#40;ST&#40;i&#41;, len&#41;&#41;;
 		while &#40;len &gt; MAX_WRITE_SIZE&#41; {
 			shawrite&#40;data, MAX_WRITE_SIZE &lt;&lt; 3, state&#41;;
 			data += MAX_WRITE_SIZE;
diff --git a/lib/Digest/SHA.pm b/lib/Digest/SHA.pm
index a341991..ecfd039 100644
--- a/lib/Digest/SHA.pm
+++ b/lib/Digest/SHA.pm
@@ -208,6 +208,11 @@ In programs:
 	$digest = sha384_hex&#40;$data&#41;;
 	$digest = sha512_base64&#40;$data&#41;;
 
+	# Unicode code points must first be
+	# serialised into bytes by encoding.
+	use Encode qw&#40; encode_utf8 &#41;;
+	$digest = sha256&#40;encode_utf8&#40;$text&#41;&#41;;
+
 		# Object-oriented
 
 	use Digest::SHA;
diff --git a/t/wide_strs.t b/t/wide_strs.t
new file mode 100644
index 0000000..6aff6d3
--- /dev/null
+++ b/t/wide_strs.t
@@ -0,0 +1,83 @@
+use strict;
+
+if &#40;$] &lt; 5.008&#41; {
+	# This version of Perl does not support wide strings,
+	# so there&#39;s no need to make sure they&#39;re handled properly.
+	print &#34;1..1\n&#34;;
+	print &#34;ok 1 # skip: No wide strings in Perl $]\n&#34;;
+	exit&#40;0&#41;;
+}
+
+my $MODULE;
+my @hmac_sha_sub_names;
+my @sha_sub_names;
+
+BEGIN {
+	$MODULE = &#40;-d &#34;src&#34;&#41; ? &#34;Digest::SHA&#34; : &#34;Digest::SHA::PurePerl&#34;;
+	eval &#34;require $MODULE&#34; || die $@;
+
+	@hmac_sha_sub_names = qw&#40;
+		hmac_sha1	hmac_sha1_base64	hmac_sha1_hex
+		hmac_sha224	hmac_sha224_base64	hmac_sha224_hex
+		hmac_sha256	hmac_sha256_base64	hmac_sha256_hex
+		hmac_sha384	hmac_sha384_base64	hmac_sha384_hex
+		hmac_sha512	hmac_sha512_base64	hmac_sha512_hex&#41;;
+	@sha_sub_names = qw&#40;
+		sha1		sha1_base64		sha1_hex
+		sha224		sha224_base64		sha224_hex
+		sha256		sha256_base64		sha256_hex
+		sha384		sha384_base64		sha384_hex
+		sha512		sha512_base64		sha512_hex&#41;;
+	$MODULE-&gt;import&#40;@hmac_sha_sub_names, @sha_sub_names&#41;;
+}
+
+BEGIN {
+	if &#40;$ENV{PERL_CORE}&#41; {
+		chdir &#39;t&#39; if -d &#39;t&#39;;
+		@INC = &#39;../lib&#39;;
+	}
+}
+
+my $test_num = 1;
+sub ok {
+	my &#40;$ok&#41; = @_;
+	print &#34;not &#34; unless $ok;
+	print &#34;ok &#34;, $test_num++, &#34;\n&#34;;
+	return 1;
+}
+
+print &#34;1..&#34;.&#40;@hmac_sha_sub_names*3 + @sha_sub_names*2 + 1&#41;.&#34;\n&#34;;
+
+my $non_byte_data = chr&#40;0x2660&#41;;
+my $non_byte_key  = chr&#40;0x2660&#41; . &#40;&#34;\x00&#34; x 31&#41;;
+
+my $data = &#34;\x80\x81\x82\x83&#34;;
+utf8::downgrade&#40; my $data_d = $data &#41;;
+utf8::upgrade&#40;   my $data_u = $data &#41;;
+
+my $key = &#34;\x80\x81\x82\x83&#34; x 8;
+utf8::downgrade&#40; my $key_d = $key &#41;;
+utf8::upgrade&#40;   my $key_u = $key &#41;;
+
+for my $sub_name &#40;@hmac_sha_sub_names&#41; {
+	my $sub_ref = \&#38;$sub_name;
+	ok&#40; !eval { $sub_ref-&gt;&#40;$non_byte_data, $key_d&#41;; 1 } &#38;&#38; $@ =~ /Wide character/ &#41;;
+	ok&#40; !eval { $sub_ref-&gt;&#40;$data_d, $non_byte_key&#41;; 1 } &#38;&#38; $@ =~ /Wide character/ &#41;;
+
+	my $digest_d = eval { $sub_ref-&gt;&#40;$data_d, $key_d&#41; };
+	my $digest_u = eval { $sub_ref-&gt;&#40;$data_u, $key_u&#41; };
+	ok&#40; defined&#40;$digest_d&#41; &#38;&#38; defined&#40;$digest_u&#41; &#38;&#38; $digest_d eq $digest_u &#41;;
+}
+
+for my $sub_name &#40;@sha_sub_names&#41; {
+	my $sub_ref = \&#38;$sub_name;
+	ok&#40; !eval { $sub_ref-&gt;&#40;$non_byte_data&#41;; 1 } &#38;&#38; $@ =~ /Wide character/ &#41;;
+
+	my $digest_d = eval { $sub_ref-&gt;&#40;$data_d&#41; };
+	my $digest_u = eval { $sub_ref-&gt;&#40;$data_u&#41; };
+	ok&#40; defined&#40;$digest_d&#41; &#38;&#38; defined&#40;$digest_u&#41; &#38;&#38; $digest_d eq $digest_u &#41;;
+}
+
+ok&#40; !eval { Digest::SHA-&gt;new&#40;256&#41;-&gt;add&#40;$non_byte_data&#41;; 1 } &#38;&#38; $@ =~ /Wide character/ &#41;;
+
+1;
-- 
1.7.9

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1145777" href="/Public/Bug/Display.html?id=81268#txn-1145777">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;22&nbsp;14:16:43&nbsp;2012</span>
    <span class="description">mshelor [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> gisle [...] ActiveState.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1145777/602535/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/602535">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 919b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Nov 18 20:55:32 2012, ikegami wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Digest::SHA silently corrupts its output when the input happens to be
&gt; upgraded, i.e. the same two perl strings cause different output.
&gt; 
&gt; This is caused by Digest::SHA accessing the strings using SvPV without
&gt; checking the choice of storage format. It should use SvPVbyte instead.
&gt; 
&gt; Patch &#40;including tests&#41; attached.
&gt; 
&gt; - Eric
</div>

Thanks, Eric, for your interest and your clean well-constructed patch. 
The test script has portability problems with Perl 5.3, but that&#39;s
nothing major.

Your method seems a bit at odds with Digest::MD5, which imposes an
&#34;sv_utf8_downgrade&#40;&#41;&#34; for Perl &lt; 5.8.  Before proceeding further, some
sort of harmonized consistent approach to dealing with this issue should
be set up for all Digest modules designed to operate on octet streams.

It seems appropriate to mark this ticket as &#34;stalled&#34; until such an
approach is developed.

Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1145780" href="/Public/Bug/Display.html?id=81268#txn-1145780">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;22&nbsp;14:16:44&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1145781" href="/Public/Bug/Display.html?id=81268#txn-1145781">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;22&nbsp;14:16:45&nbsp;2012</span>
    <span class="description">mshelor [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1145857" href="/Public/Bug/Display.html?id=81268#txn-1145857">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;22&nbsp;17:46:45&nbsp;2012</span>
    <span class="description">ikegami [...] adaelis.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> IKEGAMI [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #81268] Digest::SHA uses SvPV instead of SvPVbyte</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 22 Nov 2012 17:46:31 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Digest-SHA [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Brine &lt;ikegami [...] adaelis.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1145857/602590/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/602590">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Nov 22, 2012 at 2:16 PM, Mark Shelor via RT &lt;
bug-Digest-SHA@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Your method seems a bit at odds with Digest::MD5, which imposes an
&gt; &#34;sv_utf8_downgrade&#40;&#41;&#34; for Perl &lt; 5.8.  Before proceeding further, some
&gt; sort of harmonized consistent approach to dealing with this issue should
&gt; be set up for all Digest modules designed to operate on octet streams.
&gt;
</div>
I didn&#39;t look at MD5&#39;s source, but a SvPVbyte is a downgrade + SvPV.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-------------------- BEGIN CODE --------------------
use strict;
use warnings;

use Devel::Peek qw&#40; Dump &#41;;

use Inline C =&gt; &lt;&lt;&#39;__EOI__&#39;;

void x&#40;SV* sv&#41; {
   STRLEN len;
   SvPVbyte&#40;sv, len&#41;;
}

__EOI__

$_ = &#34;abc&#34;;
utf8::upgrade&#40;$_&#41;;
Dump&#40;$_&#41;;
x&#40;$_&#41;;
Dump&#40;$_&#41;;

<div class="message-stanza open">-------------------- END CODE --------------------

<div class="message-stanza open">-------------------- BEGIN OUTPUT --------------------
SV = PV&#40;0x759a5c&#41; at 0x32a6dc
  REFCNT = 1
  FLAGS = &#40;POK,pPOK,UTF8&#41;
  PV = 0x257e4b4 &#34;abc&#34;\0 [UTF8 &#34;abc&#34;]
  CUR = 3
  LEN = 12
SV = PV&#40;0x759a5c&#41; at 0x32a6dc
  REFCNT = 1
  FLAGS = &#40;POK,pPOK&#41;
  PV = 0x257e4b4 &#34;abc&#34;\0
  CUR = 3
  LEN = 12
-------------------- END OUTPUT --------------------
</div></div></div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1145857/602591/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/602591">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1.5k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1145860" href="/Public/Bug/Display.html?id=81268#txn-1145860">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;22&nbsp;17:46:46&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1145936" href="/Public/Bug/Display.html?id=81268#txn-1145936">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;22&nbsp;20:37:51&nbsp;2012</span>
    <span class="description">ikegami [...] adaelis.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> IKEGAMI [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #81268] Digest::SHA uses SvPV instead of SvPVbyte</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 22 Nov 2012 20:37:06 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Digest-SHA [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Brine &lt;ikegami [...] adaelis.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1145936/602633/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/602633">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 969b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Nov 22, 2012 at 5:46 PM, ikegami@adaelis.com via RT &lt;
bug-Digest-SHA@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=81268">https://rt.cpan.org/Ticket/Display.html?id=81268</a></span> &gt;
&gt;
&gt; On Thu, Nov 22, 2012 at 2:16 PM, Mark Shelor via RT &lt;
&gt; bug-Digest-SHA@rt.cpan.org&gt; wrote:
&gt;
<div class="message-stanza open">&gt; &gt; Your method seems a bit at odds with Digest::MD5, which imposes an
&gt; &gt; &#34;sv_utf8_downgrade&#40;&#41;&#34; for Perl &lt; 5.8.  Before proceeding further, some
&gt; &gt; sort of harmonized consistent approach to dealing with this issue should
&gt; &gt; be set up for all Digest modules designed to operate on octet streams.
&gt; &gt;
</div>&gt;
&gt; I didn&#39;t look at MD5&#39;s source, but a SvPVbyte is a downgrade + SvPV.
</div>
Ok, I just looked at MD5, and it uses

#if PERL_VERSION &lt; 8
# undef SvPVbyte
# define SvPVbyte&#40;sv, lp&#41; &#40;sv_utf8_downgrade&#40;&#40;sv&#41;, 0&#41;, SvPV&#40;&#40;sv&#41;, &#40;lp&#41;&#41;&#41;
#endif

Perhaps it makes a difference on 5.6? If you&#39;d prefer to use that, I have
no objections. Just make sure sv_utf8_downgrade exists in the versions you
support. &#40;You mentioned 5.3?!&#41;
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1145936/602634/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/602634">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1.3k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1145943" href="/Public/Bug/Display.html?id=81268#txn-1145943">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;22&nbsp;22:35:24&nbsp;2012</span>
    <span class="description">mshelor [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1145944" href="/Public/Bug/Display.html?id=81268#txn-1145944">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;22&nbsp;22:36:04&nbsp;2012</span>
    <span class="description">mshelor [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1146695" href="/Public/Bug/Display.html?id=81268#txn-1146695">#</a>      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;24&nbsp;11:12:16&nbsp;2012</span>
    <span class="description">mshelor [...] cpan.org -  TimeEstimated changed from &#40;no value&#41; to &#39;60&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1146696" href="/Public/Bug/Display.html?id=81268#txn-1146696">#</a>      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;24&nbsp;11:12:16&nbsp;2012</span>
    <span class="description">mshelor [...] cpan.org -  TimeWorked changed from &#40;no value&#41; to &#39;60&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1146697" href="/Public/Bug/Display.html?id=81268#txn-1146697">#</a>      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;24&nbsp;11:12:17&nbsp;2012</span>
    <span class="description">mshelor [...] cpan.org -  Status changed from &#39;stalled&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1146699" href="/Public/Bug/Display.html?id=81268#txn-1146699">#</a>      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;24&nbsp;11:12:17&nbsp;2012</span>
    <span class="description">mshelor [...] cpan.org -  Fixed in 5.74 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1146700" href="/Public/Bug/Display.html?id=81268#txn-1146700">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;24&nbsp;11:12:17&nbsp;2012</span>
    <span class="description">mshelor [...] cpan.org -  Broken in 5.73 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.617346</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
