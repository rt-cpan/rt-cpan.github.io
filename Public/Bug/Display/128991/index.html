<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #128991 for WebService-HIBP: Passwords containing multibyte characters explode</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #128991 for WebService-HIBP: Passwords containing multibyte characters explode</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=WebService-HIBP">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=WebService-HIBP">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=WebService-HIBP">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=WebService-HIBP">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/WebService-HIBP">WebService-HIBP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">128991</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=WebService-HIBP">WebService-HIBP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
PCRONIN [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-271016-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-271017-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.12    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




hibp_utf8.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1840717/989510/hibp_utf8.patch">
Tue Apr 02 06:02:34 2019 (3.1k) by DDICK [...] cpan.org
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1840715/989506/hibp_utf8.patch">
Tue Apr 02 06:00:43 2019 (2.7k) by DDICK [...] cpan.org
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1840711/989502/hibp_utf8.patch">
Tue Apr 02 04:32:19 2019 (2.1k) by DDICK [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=128991">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1840459" href="/Public/Bug/Display.html?id=128991#txn-1840459">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;01&nbsp;10:03:29&nbsp;2019</span>
    <span class="description">PCRONIN [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Passwords containing multibyte characters explode</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1840459/989359/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/989359">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi David,

We&#39;ve found that when passwords contain characters that, in Perl&#39;s internal representation, require more than 8 bits to represent, the SHA1 calculation explodes. This is going to get complicated for a second, but the solution is simple enough. Here we go.

1. The PwnedPasswords endpoint requests the prefix of the SHA1 has of the UTF-8 encoded password. Source: <span class="clickylink"><a target="new" rel="nofollow" href="https://haveibeenpwned.com/API/v2#PwnedPasswords">https://haveibeenpwned.com/API/v2#PwnedPasswords</a></span>.
2. Perl &#40;5&#41;&#39;s internal format stores _characters_, each of which is 32 bits. Source: <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/Encode#TERMINOLOGY">https://metacpan.org/pod/Encode#TERMINOLOGY</a></span>. When working with data in Perl, it&#39;s recommended to convert incoming data to Perl&#39;s internal representation, work with it, and then convert outgoing data to whatever encoding is desired. &#40;Source: <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/perlunitut#I/O-flow-&#40;the-actual-5-minute-tutorial&#41;&#41;">https://metacpan.org/pod/perlunitut#I/O-flow-&#40;the-actual-5-minute-tutorial&#41;&#41;</a></span> We follow that guidance, so the data we work with in Perl is generally in Perl&#39;s internal representation.
3. In order to ensure we&#39;re sending UTF-8 encoded passwords to PwnedPasswords endpoint &#40;note -- that&#39;s different than &#34;utf8&#34; or &#34;UTF8&#34;, see <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/Encode#UTF-8-vs.-utf8-vs.-UTF8&#41;">https://metacpan.org/pod/Encode#UTF-8-vs.-utf8-vs.-UTF8&#41;</a></span>, we needed to encode the password from Perl&#39;s internal representation to UTF-8 using $octets = Encode::encode&#40;&#39;UTF-8&#39;, $password&#41;, and provide $octets &#40;instead of $password&#41; to the `password` method of your module. For strings composed of ASCII characters, $password and $octets is indistinguishable, but for strings containing characters requiring more than 8 bits to represent, $password and $octets differ.
4. As a test case, consider using WebService::HIBP to retrieve the prevalence of a password like &#34;Ç¯&#34;.

So, two proposals for your module &#40;one or the other, but not both&#41;:
1. Document that the `password` method requires the UTF-8 encoded version of the password, or
2. The password method receives the `$password` in Perl&#39;s internal format, computes the UTF-8 encoding of it using something like `$octets = Encode::encode&#40;&#39;UTF-8&#39;, $password&#41;`, and then passes $octets to the hashing function &#40;instead of $password&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1840708" href="/Public/Bug/Display.html?id=128991#txn-1840708">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;02&nbsp;03:51:30&nbsp;2019</span>
    <span class="description">DDICK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1840708/989498/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/989498">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Apr 02 01:03:29 2019, PCRONIN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi David,
&gt; 
&gt; We&#39;ve found that when passwords contain characters that, in Perl&#39;s
&gt; internal representation, require more than 8 bits to represent, the
&gt; SHA1 calculation explodes. This is going to get complicated for a
&gt; second, but the solution is simple enough. Here we go.
&gt; 
&gt; 1. The PwnedPasswords endpoint requests the prefix of the SHA1 has of
&gt; the UTF-8 encoded password. Source:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://haveibeenpwned.com/API/v2#PwnedPasswords">https://haveibeenpwned.com/API/v2#PwnedPasswords</a></span>.
&gt; 2. Perl &#40;5&#41;&#39;s internal format stores _characters_, each of which is 32
&gt; bits. Source: <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/Encode#TERMINOLOGY">https://metacpan.org/pod/Encode#TERMINOLOGY</a></span>. When
&gt; working with data in Perl, it&#39;s recommended to convert incoming data
&gt; to Perl&#39;s internal representation, work with it, and then convert
&gt; outgoing data to whatever encoding is desired. &#40;Source:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/perlunitut#I/O-flow-&#40;the-actual-5-minute-">https://metacpan.org/pod/perlunitut#I/O-flow-&#40;the-actual-5-minute-</a></span>
&gt; tutorial&#41;&#41; We follow that guidance, so the data we work with in Perl
&gt; is generally in Perl&#39;s internal representation.
&gt; 3. In order to ensure we&#39;re sending UTF-8 encoded passwords to
&gt; PwnedPasswords endpoint &#40;note -- that&#39;s different than &#34;utf8&#34; or
&gt; &#34;UTF8&#34;, see <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/Encode#UTF-8-vs.-utf8-vs.-UTF8&#41;">https://metacpan.org/pod/Encode#UTF-8-vs.-utf8-vs.-UTF8&#41;</a></span>,
&gt; we needed to encode the password from Perl&#39;s internal representation
&gt; to UTF-8 using $octets = Encode::encode&#40;&#39;UTF-8&#39;, $password&#41;, and
&gt; provide $octets &#40;instead of $password&#41; to the `password` method of
&gt; your module. For strings composed of ASCII characters, $password and
&gt; $octets is indistinguishable, but for strings containing characters
&gt; requiring more than 8 bits to represent, $password and $octets differ.
&gt; 4. As a test case, consider using WebService::HIBP to retrieve the
&gt; prevalence of a password like &#34;Ç¯&#34;.
&gt; 
&gt; So, two proposals for your module &#40;one or the other, but not both&#41;:
&gt; 1. Document that the `password` method requires the UTF-8 encoded
&gt; version of the password, or
&gt; 2. The password method receives the `$password` in Perl&#39;s internal
&gt; format, computes the UTF-8 encoding of it using something like
&gt; `$octets = Encode::encode&#40;&#39;UTF-8&#39;, $password&#41;`, and then passes
&gt; $octets to the hashing function &#40;instead of $password&#41;.
</div>
That&#39;s embarrassing.  Any preferences on normalising the password before sending it?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1840709" href="/Public/Bug/Display.html?id=128991#txn-1840709">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;02&nbsp;03:51:31&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1840711" href="/Public/Bug/Display.html?id=128991#txn-1840711">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;02&nbsp;04:32:19&nbsp;2019</span>
    <span class="description">DDICK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1840711/989501/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/989501">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 134b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Assuming you don&#39;t need/want normalisation &#40;can&#39;t see any reference to it in the API docs&#41;, does the following patch meet your needs?
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> hibp_utf8.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1840711/989502/hibp_utf8.patch">Download hibp_utf8.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -Naur old/lib/WebService/HIBP.pm new/lib/WebService/HIBP.pm
--- old/lib/WebService/HIBP.pm	2019-03-22 18:56:58.000000000 +1100
+++ new/lib/WebService/HIBP.pm	2019-04-02 19:26:27.765007139 +1100
@@ -6,10 +6,11 @@
 use URI::Escape&#40;&#41;;
 use LWP::UserAgent&#40;&#41;;
 use Digest::SHA&#40;&#41;;
+use Encode&#40;&#41;;
 use WebService::HIBP::Breach&#40;&#41;;
 use WebService::HIBP::Paste&#40;&#41;;
 
-our $VERSION = &#39;0.11&#39;;
+our $VERSION = &#39;0.12&#39;;
 
 sub _LENGTH_OF_PASSWORD_PREFIX { return 5; }
 
@@ -155,7 +156,7 @@
 
 sub password {
     my &#40; $self, $password &#41; = @_;
-    my $sha1 = uc Digest::SHA::sha1_hex&#40;$password&#41;;
+    my $sha1 = uc Digest::SHA::sha1_hex&#40;Encode::encode&#40;&#39;UTF-8&#39;, $password, 1&#41;&#41;;
     my $url = $self-&gt;{password_url} . substr $sha1, 0,
       _LENGTH_OF_PASSWORD_PREFIX&#40;&#41;;
     my $response = $self-&gt;_get&#40;$url&#41;;
diff -Naur old/Makefile.PL new/Makefile.PL
--- old/Makefile.PL	2019-03-22 18:49:35.000000000 +1100
+++ new/Makefile.PL	2019-04-02 19:22:18.094137336 +1100
@@ -21,6 +21,7 @@
         &#39;strict&#39;                =&gt; 0,
         &#39;warnings&#39;              =&gt; 0,
         &#39;Digest::SHA&#39;           =&gt; 0,
+        &#39;Encode&#39;                =&gt; 0,
         &#39;URI::Escape&#39;           =&gt; 3.30,
         &#39;URI&#39;                   =&gt; 1.53,
         &#39;JSON&#39;                  =&gt; 0,
diff -Naur old/t/01-hibp.t new/t/01-hibp.t
--- old/t/01-hibp.t	2019-03-21 05:54:20.000000000 +1100
+++ new/t/01-hibp.t	2019-04-02 19:21:32.419612596 +1100
@@ -366,6 +366,12 @@
     $count = $hibp-&gt;password&#40;$good_password&#41;;
     ok&#40; $count == 0,
         &#34;Good password &#39;$good_password&#39; returns a count of $count&#34; &#41;;
+    my $utf8_password = &#40;chr 8364&#41; . &#39; is a UTF-8 test &#39; . &#40;chr 29399&#41; . $good_password;
+    $count = $hibp-&gt;password&#40;$utf8_password&#41;;
+	my $encoded_password = Encode::encode&#40;&#39;UTF-8&#39;, $utf8_password, 1&#41;;
+    ok&#40; $count == 0,
+        &#34;UTF-8 password &#39;$encoded_password&#39; returns a count of $count&#34; &#41;;
+	ok &#40;$hibp-&gt;last_request&#40;&#41;-&gt;uri&#40;&#41; eq &#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://api.pwnedpasswords.com/range/40BCD&#39;">https://api.pwnedpasswords.com/range/40BCD&#39;</a></span>, &#34;Correctly encoded the uri for a password check for &#39;$encoded_password&#39; into &#34; . $hibp-&gt;last_request&#40;&#41;-&gt;uri&#40;&#41;&#41;;
 	$ENV{HTTPS_PROXY} = &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://incorrect.example.com">http://incorrect.example.com</a></span>&#39;;
 	$hibp = WebService::HIBP-&gt;new&#40;&#41;;
 	eval {
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1840715" href="/Public/Bug/Display.html?id=128991#txn-1840715">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;02&nbsp;06:00:43&nbsp;2019</span>
    <span class="description">DDICK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1840715/989505/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/989505">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 330b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Apr 02 19:32:19 2019, DDICK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Assuming you don&#39;t need/want normalisation &#40;can&#39;t see any reference to
&gt; it in the API docs&#41;, does the following patch meet your needs?
</div>
Disregard my last.  I checked with the HIBP implementation.  Unicode::Normalize::NFD appears to be the correct encoding.

Does this patch look okay?
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> hibp_utf8.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1840715/989506/hibp_utf8.patch">Download hibp_utf8.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -Naur old/lib/WebService/HIBP.pm new/lib/WebService/HIBP.pm
--- old/lib/WebService/HIBP.pm	2019-04-02 19:29:56.807410095 +1100
+++ new/lib/WebService/HIBP.pm	2019-04-02 20:56:40.969894661 +1100
@@ -6,7 +6,9 @@
 use URI::Escape&#40;&#41;;
 use LWP::UserAgent&#40;&#41;;
 use Digest::SHA&#40;&#41;;
+use Unicode::Normalize&#40;&#41;;
 use Encode&#40;&#41;;
+use Unicode::Normalize&#40;&#41;;
 use WebService::HIBP::Breach&#40;&#41;;
 use WebService::HIBP::Paste&#40;&#41;;
 
@@ -156,7 +158,8 @@
 
 sub password {
     my &#40; $self, $password &#41; = @_;
-    my $sha1 = uc Digest::SHA::sha1_hex&#40;Encode::encode&#40;&#39;UTF-8&#39;, $password, 1&#41;&#41;;
+    my $normalised = Unicode::Normalize::NFD&#40;$password&#41;;
+    my $sha1 = uc Digest::SHA::sha1_hex&#40;Encode::encode&#40;&#39;UTF-8&#39;, $normalised, 1&#41;&#41;;
     my $url = $self-&gt;{password_url} . substr $sha1, 0,
       _LENGTH_OF_PASSWORD_PREFIX&#40;&#41;;
     my $response = $self-&gt;_get&#40;$url&#41;;
diff -Naur old/Makefile.PL new/Makefile.PL
--- old/Makefile.PL	2019-04-02 19:29:56.808410107 +1100
+++ new/Makefile.PL	2019-04-02 20:57:02.010127468 +1100
@@ -22,6 +22,7 @@
         &#39;warnings&#39;              =&gt; 0,
         &#39;Digest::SHA&#39;           =&gt; 0,
         &#39;Encode&#39;                =&gt; 0,
+        &#39;Unicode::Normalize&#39;    =&gt; 0, 
         &#39;URI::Escape&#39;           =&gt; 3.30,
         &#39;URI&#39;                   =&gt; 1.53,
         &#39;JSON&#39;                  =&gt; 0,
diff -Naur old/t/01-hibp.t new/t/01-hibp.t
--- old/t/01-hibp.t	2019-04-02 19:29:56.808410107 +1100
+++ new/t/01-hibp.t	2019-04-02 20:54:53.392704353 +1100
@@ -372,6 +372,18 @@
     ok&#40; $count == 0,
         &#34;UTF-8 password &#39;$encoded_password&#39; returns a count of $count&#34; &#41;;
 	ok &#40;$hibp-&gt;last_request&#40;&#41;-&gt;uri&#40;&#41; eq &#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://api.pwnedpasswords.com/range/40BCD&#39;">https://api.pwnedpasswords.com/range/40BCD&#39;</a></span>, &#34;Correctly encoded the uri for a password check for &#39;$encoded_password&#39; into &#34; . $hibp-&gt;last_request&#40;&#41;-&gt;uri&#40;&#41;&#41;;
+	my $denormalised_password = chr&#40;0x0041&#41; . chr&#40;0x0300&#41;;
+    $count = $hibp-&gt;password&#40;$denormalised_password&#41;;
+	$encoded_password = Encode::encode&#40;&#39;UTF-8&#39;, $denormalised_password, 1&#41;;
+    ok&#40; $count == 0,
+        &#34;UTF-8 password &#39;$encoded_password&#39; returns a count of $count&#34; &#41;;
+	ok &#40;$hibp-&gt;last_request&#40;&#41;-&gt;uri&#40;&#41; eq &#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://api.pwnedpasswords.com/range/0273B&#39;">https://api.pwnedpasswords.com/range/0273B&#39;</a></span>, &#34;Correctly encoded the uri for a password check for &#39;$encoded_password&#39; into &#34; . $hibp-&gt;last_request&#40;&#41;-&gt;uri&#40;&#41;&#41;;
+	my $normalised_password = chr&#40;0x00C0&#41;;
+    $count = $hibp-&gt;password&#40;$normalised_password&#41;;
+	$encoded_password = Encode::encode&#40;&#39;UTF-8&#39;, $normalised_password, 1&#41;;
+    ok&#40; $count == 0,
+        &#34;UTF-8 password &#39;$encoded_password&#39; returns a count of $count&#34; &#41;;
+	ok &#40;$hibp-&gt;last_request&#40;&#41;-&gt;uri&#40;&#41; eq &#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://api.pwnedpasswords.com/range/0273B&#39;">https://api.pwnedpasswords.com/range/0273B&#39;</a></span>, &#34;Correctly encoded the uri for a password check for &#39;$encoded_password&#39; into &#34; . $hibp-&gt;last_request&#40;&#41;-&gt;uri&#40;&#41;&#41;;
 	$ENV{HTTPS_PROXY} = &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://incorrect.example.com">http://incorrect.example.com</a></span>&#39;;
 	$hibp = WebService::HIBP-&gt;new&#40;&#41;;
 	eval {
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1840717" href="/Public/Bug/Display.html?id=128991#txn-1840717">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;02&nbsp;06:02:34&nbsp;2019</span>
    <span class="description">DDICK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1840717/989509/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/989509">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 399b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Apr 02 21:00:43 2019, DDICK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Apr 02 19:32:19 2019, DDICK wrote:
<div class="message-stanza open">&gt; &gt; Assuming you don&#39;t need/want normalisation &#40;can&#39;t see any reference
&gt; &gt; to
&gt; &gt; it in the API docs&#41;, does the following patch meet your needs?
</div>&gt; 
&gt; Disregard my last.  I checked with the HIBP implementation.
&gt; Unicode::Normalize::NFD appears to be the correct encoding.
&gt; 
&gt; Does this patch look okay?
</div>
*sigh*
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> hibp_utf8.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1840717/989510/hibp_utf8.patch">Download hibp_utf8.patch</a><br />
<span class="downloadcontenttype">text/x-diff 3.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -Naur old/lib/WebService/HIBP.pm new/lib/WebService/HIBP.pm
--- old/lib/WebService/HIBP.pm	2019-03-22 18:56:58.000000000 +1100
+++ new/lib/WebService/HIBP.pm	2019-04-02 20:56:40.969894661 +1100
@@ -6,10 +6,13 @@
 use URI::Escape&#40;&#41;;
 use LWP::UserAgent&#40;&#41;;
 use Digest::SHA&#40;&#41;;
+use Unicode::Normalize&#40;&#41;;
+use Encode&#40;&#41;;
+use Unicode::Normalize&#40;&#41;;
 use WebService::HIBP::Breach&#40;&#41;;
 use WebService::HIBP::Paste&#40;&#41;;
 
-our $VERSION = &#39;0.11&#39;;
+our $VERSION = &#39;0.12&#39;;
 
 sub _LENGTH_OF_PASSWORD_PREFIX { return 5; }
 
@@ -155,7 +158,8 @@
 
 sub password {
     my &#40; $self, $password &#41; = @_;
-    my $sha1 = uc Digest::SHA::sha1_hex&#40;$password&#41;;
+    my $normalised = Unicode::Normalize::NFD&#40;$password&#41;;
+    my $sha1 = uc Digest::SHA::sha1_hex&#40;Encode::encode&#40;&#39;UTF-8&#39;, $normalised, 1&#41;&#41;;
     my $url = $self-&gt;{password_url} . substr $sha1, 0,
       _LENGTH_OF_PASSWORD_PREFIX&#40;&#41;;
     my $response = $self-&gt;_get&#40;$url&#41;;
diff -Naur old/Makefile.PL new/Makefile.PL
--- old/Makefile.PL	2019-03-22 18:49:35.000000000 +1100
+++ new/Makefile.PL	2019-04-02 20:57:02.010127468 +1100
@@ -21,6 +21,8 @@
         &#39;strict&#39;                =&gt; 0,
         &#39;warnings&#39;              =&gt; 0,
         &#39;Digest::SHA&#39;           =&gt; 0,
+        &#39;Encode&#39;                =&gt; 0,
+        &#39;Unicode::Normalize&#39;    =&gt; 0, 
         &#39;URI::Escape&#39;           =&gt; 3.30,
         &#39;URI&#39;                   =&gt; 1.53,
         &#39;JSON&#39;                  =&gt; 0,
diff -Naur old/t/01-hibp.t new/t/01-hibp.t
--- old/t/01-hibp.t	2019-03-21 05:54:20.000000000 +1100
+++ new/t/01-hibp.t	2019-04-02 20:54:53.392704353 +1100
@@ -366,6 +366,24 @@
     $count = $hibp-&gt;password&#40;$good_password&#41;;
     ok&#40; $count == 0,
         &#34;Good password &#39;$good_password&#39; returns a count of $count&#34; &#41;;
+    my $utf8_password = &#40;chr 8364&#41; . &#39; is a UTF-8 test &#39; . &#40;chr 29399&#41; . $good_password;
+    $count = $hibp-&gt;password&#40;$utf8_password&#41;;
+	my $encoded_password = Encode::encode&#40;&#39;UTF-8&#39;, $utf8_password, 1&#41;;
+    ok&#40; $count == 0,
+        &#34;UTF-8 password &#39;$encoded_password&#39; returns a count of $count&#34; &#41;;
+	ok &#40;$hibp-&gt;last_request&#40;&#41;-&gt;uri&#40;&#41; eq &#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://api.pwnedpasswords.com/range/40BCD&#39;">https://api.pwnedpasswords.com/range/40BCD&#39;</a></span>, &#34;Correctly encoded the uri for a password check for &#39;$encoded_password&#39; into &#34; . $hibp-&gt;last_request&#40;&#41;-&gt;uri&#40;&#41;&#41;;
+	my $denormalised_password = chr&#40;0x0041&#41; . chr&#40;0x0300&#41;;
+    $count = $hibp-&gt;password&#40;$denormalised_password&#41;;
+	$encoded_password = Encode::encode&#40;&#39;UTF-8&#39;, $denormalised_password, 1&#41;;
+    ok&#40; $count == 0,
+        &#34;UTF-8 password &#39;$encoded_password&#39; returns a count of $count&#34; &#41;;
+	ok &#40;$hibp-&gt;last_request&#40;&#41;-&gt;uri&#40;&#41; eq &#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://api.pwnedpasswords.com/range/0273B&#39;">https://api.pwnedpasswords.com/range/0273B&#39;</a></span>, &#34;Correctly encoded the uri for a password check for &#39;$encoded_password&#39; into &#34; . $hibp-&gt;last_request&#40;&#41;-&gt;uri&#40;&#41;&#41;;
+	my $normalised_password = chr&#40;0x00C0&#41;;
+    $count = $hibp-&gt;password&#40;$normalised_password&#41;;
+	$encoded_password = Encode::encode&#40;&#39;UTF-8&#39;, $normalised_password, 1&#41;;
+    ok&#40; $count == 0,
+        &#34;UTF-8 password &#39;$encoded_password&#39; returns a count of $count&#34; &#41;;
+	ok &#40;$hibp-&gt;last_request&#40;&#41;-&gt;uri&#40;&#41; eq &#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://api.pwnedpasswords.com/range/0273B&#39;">https://api.pwnedpasswords.com/range/0273B&#39;</a></span>, &#34;Correctly encoded the uri for a password check for &#39;$encoded_password&#39; into &#34; . $hibp-&gt;last_request&#40;&#41;-&gt;uri&#40;&#41;&#41;;
 	$ENV{HTTPS_PROXY} = &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://incorrect.example.com">http://incorrect.example.com</a></span>&#39;;
 	$hibp = WebService::HIBP-&gt;new&#40;&#41;;
 	eval {
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1840765" href="/Public/Bug/Display.html?id=128991#txn-1840765">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;02&nbsp;09:21:43&nbsp;2019</span>
    <span class="description">PCRONIN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1840765/989536/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/989536">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 664b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Apr 02 06:02:34 2019, DDICK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Apr 02 21:00:43 2019, DDICK wrote:
<div class="message-stanza open">&gt; &gt; On Tue Apr 02 19:32:19 2019, DDICK wrote:
<div class="message-stanza open">&gt; &gt; &gt; Assuming you don&#39;t need/want normalisation &#40;can&#39;t see any reference
&gt; &gt; &gt; to
&gt; &gt; &gt; it in the API docs&#41;, does the following patch meet your needs?
</div>&gt; &gt; 
&gt; &gt; Disregard my last.  I checked with the HIBP implementation.
&gt; &gt; Unicode::Normalize::NFD appears to be the correct encoding.
&gt; &gt; 
&gt; &gt; Does this patch look okay?
</div>&gt; 
&gt; *sigh*
</div>
I wasn&#39;t able to find HIBP&#39;s implementation to confirm that NFD is their selected normalized form. That aside, the patch looks good if the second `use Unicode::Normalize&#40;&#41;;` is removed.

Thank you!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1840824" href="/Public/Bug/Display.html?id=128991#txn-1840824">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;03&nbsp;06:12:12&nbsp;2019</span>
    <span class="description">DDICK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1840824/989560/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/989560">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 226b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I used a character combination that produced a failure to sha to the digest used by the hibp frontend for three of the four possibilities.  The only one that worked is now included in the test suite.

Thanks for the bug report
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1840826" href="/Public/Bug/Display.html?id=128991#txn-1840826">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;03&nbsp;06:12:14&nbsp;2019</span>
    <span class="description">DDICK [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1840828" href="/Public/Bug/Display.html?id=128991#txn-1840828">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;03&nbsp;06:12:14&nbsp;2019</span>
    <span class="description">DDICK [...] cpan.org -  Fixed in 0.12 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.513162</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
