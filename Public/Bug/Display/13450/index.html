<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #13450 for Net-Server: 0.88 crashes amavisd-new  when using perl 5.8.0</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #13450 for Net-Server: 0.88 crashes amavisd-new  when using perl 5.8.0</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-Server/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-Server/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-Server/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-Server/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-Server">Net-Server CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">13450</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-Server/Active/">Net-Server</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
lists [...] johnmecham.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-23138-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.88    </td>
  </tr>
  <tr id="CF-23139-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;28&nbsp;11:31:25&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0.88 crashes amavisd-new  when using perl 5.8.0</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Net::Server 0.88. On Red Hat 9.0 and RHEL3, with perl 5.8.0 installed, when attempting to start amavisd-new, Net::Server produces an error, then closes:

Output from &#39;amavisd debug&#39;:

Net::Server: 2005/06/28-09:24:58 Amavis &#40;type Net::Server::PreForkSimple&#41; starting! pid&#40;2780&#41;
Net::Server: Binding to UNIX socket file /var/amavis/amavisd.sock using SOCK_STREAM
Net::Server: Binding to TCP port 10024 on host 127.0.0.1
Net::Server: Setting gid to &#34;999 999&#34;
Net::Server: 2005/06/28-09:24:58 Couldn&#39;t become gid &#34;999&#34;: \n\n  at line 486 in file /usr/lib/perl5/site_perl/5.8.0/Net/Server.pm
Net::Server: 2005/06/28-09:24:58 Server closing!

This behavior appears to be new with version 0.88.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;30&nbsp;12:09:14&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> JussiT</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Tue Jun 28 11:31:25 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Net::Server 0.88. On Red Hat 9.0 and RHEL3, with perl 5.8.0 installed,
&gt;    when attempting to start amavisd-new, Net::Server produces an
&gt;    error, then closes:
</div>
Found the same with Red Hat Enterprise Linux 3 ES and perl-5.8.0. But
the same amavisd-new 2.3.2 works pretty well with Fedora Core 4 running
perl-5.8.6-15. It may be a perl-5.8.0 vs. Net::Server 0.88 compatibility
problem.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;14&nbsp;13:51:11&nbsp;2005</span>
    <span class="description">paul [...] seamons.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m thinking it may be in how the groups are returned on RedHat.  The 
code to blame is: 
 
sub set_gid { 
  my $gids = get_gid&#40; @_ &#41;; 
  my $gid  = &#40;split /\s+/, $gids&#41;[0]; 
  eval { $&#41; = $gids }; # store all the gids - this is really sort of 
optional 
 
  POSIX::setgid&#40;$gid&#41;; 
  my $_gid = &#40;split /\s+/, $&#40;&#41;[0]; 
  if &#40;$_gid != $gid&#41; { 
    die &#34;Couldn&#39;t become gid \&#34;$gid\&#34;: $!\n&#34;; 
  } 
 
  return 1; 
} 
 
I&#39;d be interested in looking at what $&#40; returns before and after the 
call to POSIX::setgid &#40;if you could debug that it would be very 
helpful&#41;.  I am imagining that maybe the group you set is being 
returned successfully but not in the first position &#40;the $&#40; string 
will be a space separated list of groups&#41;.  If this is the case, then 
we should be able to change the line to: 
 
if &#40;! grep {$gid == $_} split /\s+/, $&#40;&#41; { 
 
Can you try modifying a local copy and seeing if this takes care of 
the issue? 
 
Paul Seamons 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;15&nbsp;12:18:36&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> lists [...] johnmecham.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Red Hat 9.0 Perl 5.8.0, Daemonize.pm

[root@sf1 root]# grep amavis /etc/passwd
amavis:x:999:999:amavisd-new daemon:/var/amavis:/sbin/nologin
[root@sf1 root]# grep amavis /etc/group
amavis:x:999:clamav

******************
print $&#40;;
print &#34;\n&#34;;
  POSIX::setgid&#40;$gid&#41;;
print $&#40;;
print &#34;\n&#34;;

results in:

Jul 14 12:38:07 sf1.example.com amavisd[1825]: Net::Server: Setting gid 
to &#34;999 999&#34;
0 999 999
0 999 999
Jul 14 12:38:07 sf1.example.com amavisd[1825]: Net::Server: 2005/07/14-
12:38:07 Couldn&#39;t become gid &#34;999&#34;: \n\n  at line
486 in file /usr/lib/perl5/site_perl/5.8.0/Net/Server.pm

******************
I&#39;m hoping I replaced the correct line here ...

  my $_gid = &#40;split /\s+/, $&#40;&#41;[0];
#  if &#40;$_gid != $gid&#41; {                       # original line
   if &#40;! grep {$gid == $_} split /\s+/, $&#40;&#41; {
    die &#34;Couldn&#39;t become gid \&#34;$gid\&#34;: $!\n&#34;;
  }

now instead of gid, couldn&#39;t become uid:

Jul 14 12:37:02 sf1.example.com amavisd[1824]: Net::Server: Setting gid 
to &#34;999 999&#34;
Jul 14 12:37:02 sf1.example.com amavisd[1824]: Net::Server: Setting uid 
to &#34;999&#34;
Jul 14 12:37:03 sf1.example.com amavisd[1824]: Net::Server: 2005/07/14-
12:37:02 Couldn&#39;t become uid &#34;999&#34;: \n\n  at line
486 in file /usr/lib/perl5/site_perl/5.8.0/Net/Server.pm

*************************************

Just for comparison:
On my Debian Sarge machine &#40;Perl 5.8.6&#41; &#40;where there is no problem&#41;:
sfm:~# grep amavis /etc/passwd
amavis:x:103:104:AMaViS system user,,,:/var/lib/amavis:/bin/sh
sfm:~# grep amavis /etc/group
amavis:x:104:clamav

*****************

print &#34;$&#40;&#34;;
print &#34;\n&#34;;
  POSIX::setgid&#40;$gid&#41;;
print &#34;$&#40;&#34;;
print &#34;\n&#34;;

results in:

Jul 14 13:00:23 sfm amavisd-new[2250]: Net::Server: Setting gid to &#34;104 
104&#34;
0 104 104
104 104 104
Jul 14 13:00:23 sfm amavisd-new[2250]: Net::Server: Setting uid to &#34;103&#34;

******************


A FreeBSD system running Perl 5.8.7 shows:

0 110 110
110 110 110
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;20&nbsp;18:27:04&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> lists [...] johnmecham.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[RHANDOM - Thu Jul 14 13:51:11 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m thinking it may be in how the groups are returned on RedHat.  The
&gt; code to blame is:
&gt; 
&gt; sub set_gid {
&gt;   my $gids = get_gid&#40; @_ &#41;;
&gt;   my $gid  = &#40;split /\s+/, $gids&#41;[0];
&gt;   eval { $&#41; = $gids }; # store all the gids - this is really sort of
&gt; optional
&gt; 
&gt;   POSIX::setgid&#40;$gid&#41;;
&gt;   my $_gid = &#40;split /\s+/, $&#40;&#41;[0];
&gt;   if &#40;$_gid != $gid&#41; {
&gt;     die &#34;Couldn&#39;t become gid \&#34;$gid\&#34;: $!\n&#34;;
&gt;   }
&gt; 
&gt;   return 1;
&gt; }
&gt; 
&gt; I&#39;d be interested in looking at what $&#40; returns before and after the
&gt; call to POSIX::setgid &#40;if you could debug that it would be very
&gt; helpful&#41;.  I am imagining that maybe the group you set is being
&gt; returned successfully but not in the first position &#40;the $&#40; string
&gt; will be a space separated list of groups&#41;.  If this is the case, then
&gt; we should be able to change the line to:
&gt; 
&gt; if &#40;! grep {$gid == $_} split /\s+/, $&#40;&#41; {
&gt; 
&gt; Can you try modifying a local copy and seeing if this takes care of
&gt; the issue?
&gt; 
&gt; Paul Seamons
</div>

From what you have provided here, and what I grabbed from a patch by 
Mark Martinec, I created a patch that appears to work. I am not a 
programmer, so you be the judge:

--- Daemonize.pm        2005-06-20 13:41:15.000000000 -0600
+++ Daemonize.pm-patched        2005-07-20 16:12:10.000000000 -0600
@@ -199,11 +199,8 @@
 ### change the process to run as this uid
 sub set_uid {
   my $uid = get_uid&#40; shift&#40;&#41; &#41;;
-
-  POSIX::setuid&#40;$uid&#41;;
-  if &#40;$&lt; != $uid&#41; {
-    die &#34;Couldn&#39;t become uid \&#34;$uid\&#34;: $!\n&#34;;
-  }
+  POSIX::setuid&#40; $uid &#41; or die &#34;Couldn&#39;t POSIX::setuid to \&#34;$uid\&#34; [$!]
\n&#34;;
+  $&gt; = $uid; $&lt; = $uid;  # just in case

   return 1;
 }
@@ -217,7 +214,7 @@

   POSIX::setgid&#40;$gid&#41;;
   my $_gid = &#40;split /\s+/, $&#40;&#41;[0];
-  if &#40;$_gid != $gid&#41; {
+  if &#40;! grep {$gid == $_} split /\s+/, $&#40;&#41; {
     die &#34;Couldn&#39;t become gid \&#34;$gid\&#34;: $!\n&#34;;
   }
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Daemonize.pm        2005-06-20 13:41:15.000000000 -0600
+++ Daemonize.pm-patched        2005-07-20 16:12:10.000000000 -0600
@@ -199,11 +199,8 @@
 ### change the process to run as this uid
 sub set_uid {
   my $uid = get_uid&#40; shift&#40;&#41; &#41;;
-
-  POSIX::setuid&#40;$uid&#41;;
-  if &#40;$&lt; != $uid&#41; {
-    die &#34;Couldn&#39;t become uid \&#34;$uid\&#34;: $!\n&#34;;
-  }
+  POSIX::setuid&#40; $uid &#41; or die &#34;Couldn&#39;t POSIX::setuid to \&#34;$uid\&#34; [$!]\n&#34;;
+  $&gt; = $uid; $&lt; = $uid;  # just in case

   return 1;
 }
@@ -217,7 +214,7 @@

   POSIX::setgid&#40;$gid&#41;;
   my $_gid = &#40;split /\s+/, $&#40;&#41;[0];
-  if &#40;$_gid != $gid&#41; {
+  if &#40;! grep {$gid == $_} split /\s+/, $&#40;&#41; {
     die &#34;Couldn&#39;t become gid \&#34;$gid\&#34;: $!\n&#34;;
   }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;20&nbsp;18:33:08&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> lists [...] johnmecham.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">That may have wrapped, so here is a URL to the this patch if you would 
like:
<span class="clickylink"><a target="new" rel="nofollow" href="http://www200.pair.com/mecham/spam/p7.txt">http://www200.pair.com/mecham/spam/p7.txt</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;21&nbsp;10:43:56&nbsp;2005</span>
    <span class="description">paul [...] seamons.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Unfortunately that will break on BSD.  The POSIX::setuid call returns 
different things on different platforms &#40;and has possibly changed 
between version&#41;.  The old version &#40;&lt;=.87&#41; did the checks the way you 
patch provides and breaks on most BSD systems.  Also - it appears that 
the order that $&lt; and $&gt; should be set varies from platform to 
platform. 
 
Most people that I have heard back from have said that the set_uid 
portion of the 0.88 version is working for them.  So the question is - 
why wouldn&#39;t the check for $&lt; == $uid work on your system.  If it is 
not working then it seems that something dangerous is going on and the 
server won&#39;t be running as the user you think it will.  Could you 
debug a little more and figure out if we are getting the right value 
for $uid via the get_uid&#40;$username or $uid&#41; call and then debug the 
value of $&lt; and $&gt; after a POSIX::setuid&#40;$uid&#41; call &#40;from root&#41;. 
 
perl -e &#39;use POSIX; print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;; POSIX::setuid&#40;500&#41;; print 
&#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;&#39; 
&#40;0&#41;&#40;0&#41; 
&#40;500&#41;&#40;500&#41; 
 
On the other side, I&#39;m glad that at least the set_gid portion is 
working. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;21&nbsp;11:06:17&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> lists [...] johnmecham.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[RHANDOM - Thu Jul 21 10:43:56 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Unfortunately that will break on BSD. 
&gt; On the other side, I&#39;m glad that at least the set_gid portion is
&gt; working.
</div>
Red Hat 9.0 Perl 5.8.0

# perl -e &#39;use POSIX; print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;; POSIX::setuid&#40;500&#41;; 
print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;&#39;
&#40;0&#41;&#40;0&#41;
&#40;0&#41;&#40;0&#41;

  POSIX::setuid&#40;$uid&#41;;
+ print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;;

- if &#40;$_gid != $gid&#41; {
+ if &#40;! grep {$gid == $_} split /\s+/, $&#40;&#41; {

Jul 21 09:01:31 sf1.example.com amavisd[3375]: Net::Server: Setting gid 
to &#34;999 999&#34;
Jul 21 09:01:31 sf1.example.com amavisd[3375]: Net::Server: Setting uid 
to &#34;999&#34;
&#40;0&#41;&#40;0&#41;
Jul 21 09:01:31 sf1.example.com amavisd[3375]: Net::Server: 2005/07/21-
09:01:31 Couldn&#39;t become uid &#34;999&#34;: \n\n  at line 486 in 
file /usr/lib/perl5/site_perl/5.8.0/Net/Server.pm
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;21&nbsp;11:12:29&nbsp;2005</span>
    <span class="description">paul [...] seamons.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"> 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Red Hat 9.0 Perl 5.8.0 
&gt;  
&gt; # perl -e &#39;use POSIX; print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;; POSIX::setuid&#40;500&#41;; 
&gt; print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;&#39; 
&gt; &#40;0&#41;&#40;0&#41; 
&gt; &#40;0&#41;&#40;0&#41; 
</div> 
 
Sorry - to be more specific... 
The uid 500 exists on my system.  Please use one of the userids from 
your /etc/passwd file &#40;if 500 doesn&#39;t exist - then pick one that 
does&#41;. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;21&nbsp;11:48:44&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please use one of the userids from
&gt; your /etc/passwd file &#40;if 500 doesn&#39;t exist - then pick one that
&gt; does&#41;.
</div>
Red Hat 9.0 Perl 5.8.0:

grep &#39;999&#39; /etc/passwd
amavis:x:999:999:amavisd-new daemon:/var/amavis:/sbin/nologin

perl -e &#39;use POSIX; print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;; POSIX::setuid&#40;999&#41;; \
print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;&#39;
&#40;0&#41;&#40;0&#41;
&#40;0&#41;&#40;0&#41;

So on this 5.8.0 system, it does not matter whether the user
exists or not, it always returns &#40;0&#41;&#40;0&#41;.

On my Debian Sarge Perl 5.8.6 machine, it does not matter
whether the user exists or not either, it will return whatever
you set POSIX::setuid&#40;&#41; to:

grep 999 /etc/passwd
&#40;nothing returned&#41;

perl -e &#39;use POSIX; print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;; POSIX::setuid&#40;999&#41;; \
print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;&#39;
&#40;0&#41;&#40;0&#41;
&#40;999&#41;&#40;999&#41;

grep 103 /etc/passwd
amavis:x:103:104:AMaViS system user,,,:/var/lib/amavis:/bin/sh

perl -e &#39;use POSIX; print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;; POSIX::setuid&#40;999&#41;; \
print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;&#39;
&#40;0&#41;&#40;0&#41;
&#40;103&#41;&#40;103&#41;

My FreeBSD systems acts identically to my Debian system.

I am not a Perl programmer, so yes, specific is a good thing.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;21&nbsp;13:26:03&nbsp;2005</span>
    <span class="description">paul [...] seamons.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">OK here is some more to try - it asks the system what it thinks it is 
after trying to set $&lt; and $&gt; two different ways - change 500 to 999 
for your case. 
 
perl -MPOSIX -e&#39;$u=500;if&#40;!fork&#41;{POSIX::setuid&#40;$u&#41;;print&#34;1
&#40;$&lt;-$&gt;&#41;\n&#34;}elsif&#40;!fork&#41;{$&lt;=$&gt;=$u;print&#34;2&#40;$&lt;-$&gt;&#41;\n&#34;}else{sleep 1; print 
`ps --ppid=$$ -o euid,ruid`}sleep 2&#39; 
 
1&#40;500-500&#41; 
2&#40;500-500&#41; 
 EUID  RUID 
  500   500 
  500   500 
    0     0 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;21&nbsp;14:26:37&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> lists [...] johnmecham.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On the Red Hat machine:

1 &#40;0-0&#41;
2&#40;999-999&#41;
ps: error: Unknown gnu long option.
usage: ps -[Unix98 options]
       ps [BSD-style options]
       ps --[GNU-style long options]
       ps --help for a command summary

&#40;and with a user that does not exist:&#41;
1 &#40;0-0&#41;
2&#40;110-110&#41;
ps: error: Unknown gnu long option.
usage: ps -[Unix98 options]
       ps [BSD-style options]
       ps --[GNU-style long options]
       ps --help for a command summary

Sorry Paul, the argument given to ps is not supported.



On my Debian Machine:
1 &#40;103-103&#41;
2&#40;103-103&#41;
 EUID  RUID
  103   103
  103   103
    0     0

&#40;similar result when the user does not exist&#41;
1 &#40;999-999&#41;
2&#40;999-999&#41;
 EUID  RUID
  999   999
  999   999
    0     0

On my FreeBSD machine:

fork: Event not found.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;26&nbsp;18:09:25&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> lists [...] johnmecham.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">FYI: Looks like more of a Perl 5.8.0 bug than a RedHat bug. Whether it 
only affects Linux boxes is not known to me. Here is a post from 
someone who is running SuSE 8.1:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve been running amavisd successfully for a couple of years on an 
&gt; ageing SuSE 8.1 server with no problems until now.
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Here is the output when I start amavisd &#40;as root&#41; with the debug flag.
&gt; 
</div>=======================================================================
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Jul  8 14:38:30 aeryn.home ./amavisd[5308]: starting.  ./amavisd at 
</div>aeryn.home \
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; amavisd-new-2.3.2 &#40;20050629&#41;, Unicode aware, LANG= en_GB
&gt; Jul  8 14:38:30 aeryn.home ./amavisd[5308]: user=, EUID: 0 &#40;0&#41;;  
</div>group=, EGID: 0 0 \
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;                 &#40;0 0&#41;
&gt; Jul  8 14:38:30 aeryn.home ./amavisd[5308]: Perl 
</div>version               5.008

This user downgraded to 0.87 to work around the problem.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;02&nbsp;04:44:39&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> JussiT</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Thu Jul 21 11:48:44 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Red Hat 9.0 Perl 5.8.0:
&gt; 
&gt; grep &#39;999&#39; /etc/passwd
&gt; amavis:x:999:999:amavisd-new daemon:/var/amavis:/sbin/nologin
&gt; 
&gt; perl -e &#39;use POSIX; print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;; POSIX::setuid&#40;999&#41;; \
&gt; print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;&#39;
&gt; &#40;0&#41;&#40;0&#41;
&gt; &#40;0&#41;&#40;0&#41;
</div>
Test #1: RHEL &#40;Red Hat Enterprise Linux&#41; 3 ES and perl-5.8.0-89.10.
Logged in as root &#40;uid&#41;0&#41;

# grep amavis /etc/passwd
amavis:x:503:503:amavisd-new:/var/amavis:/bin/bash

# perl -e &#39;use POSIX; print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;; POSIX::setuid&#40;503&#41;; \
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;&#39;
</div>&#40;0&#41;&#40;0&#41;
&#40;0&#41;&#40;0&#41;

Logged in as amavis &#40;uid=503&#41;:

$ grep amavis /etc/passwd
amavis:x:503:503:amavisd-new:/var/amavis:/bin/bash

$ perl -e &#39;use POSIX; print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;; POSIX::setuid&#40;503&#41;; \
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;&#39;
</div>&#40;503&#41;&#40;503&#41;
&#40;503&#41;&#40;503&#41;

That amavisd-new-2.3.2 system hates Net::Server-0.88, but works fine
with Net::Server-0.87.


Test #2: Fedora Core 4 and perl-5.8.6-15. Logged in as root &#40;uid=0&#41;:

# grep amavis /etc/passwd
amavis:x:506:506:AMaViS email virus scanner user:/home/amavis:/bin/sh

# perl -e &#39;use POSIX; print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;; POSIX::setuid&#40;506&#41;; \
print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;&#39;
&#40;0&#41;&#40;0&#41;
&#40;506&#41;&#40;506&#41;

Logged in as amavis &#40;uid=506&#41;:

$ perl -e &#39;use POSIX; print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;; POSIX::setuid&#40;506&#41;; \
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; print &#34;&#40;$&lt;&#41;&#40;$&gt;&#41;\n&#34;&#39;
</div>&#40;506&#41;&#40;506&#41;
&#40;506&#41;&#40;506&#41;

This one has amavisd-new-2.3.2 and Net::Server-0.88 and they work fine.


So, it looks like that problematic RHEL3ES + perl-5.8.0 returns wrong
uid and gid values, when querying as a root. This is problem, when
running amavisd-new-2.3.2 with Net::Server-0.88.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;17&nbsp;10:18:04&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> JussiT</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">So, RHEL 3 has broken perl-5.8.0. See RH Bugzilla ticket

<span class="clickylink"><a target="new" rel="nofollow" href="https://bugzilla.redhat.com/bugzilla/show_bug.cgi?id=165078">https://bugzilla.redhat.com/bugzilla/show_bug.cgi?id=165078</a></span>

If someone is interested, bugfixed perl-5.8.0-90.2 is available at

<span class="clickylink"><a target="new" rel="nofollow" href="http://people.redhat.com/~jvdias/perl/RHEL-3/">http://people.redhat.com/~jvdias/perl/RHEL-3/</a></span>

It will be included in next OS update package &#40;RHEL 3 Update 7&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;23&nbsp;03:42:46&nbsp;2005</span>
    <span class="description">paul [...] seamons.com -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
