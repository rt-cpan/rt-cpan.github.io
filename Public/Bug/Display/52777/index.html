<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #52777 for DBIx-Class: might_have&#40;&#41; relationships return bad data</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #52777 for DBIx-Class: might_have&#40;&#41; relationships return bad data</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBIx-Class/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Class">DBIx-Class CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">52777</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBIx-Class/Active/">DBIx-Class</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ovid [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10410-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.08115    </td>
  </tr>
  <tr id="CF-10411-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;15&nbsp;05:37:50&nbsp;2009</span>
    <span class="description">ovid [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> might_have&#40;&#41; relationships return bad data</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Bug:  might_have relationships which depend on an attribute with 
&#34;is_nullable&#34; being true can return incorrect data if that attribute is 
NULL.

Peter Rabbitson mentions this bug in a mailing list response, but it 
appears that people think the bug was eliminated.  It&#39;s now causing 
incorrect responses at my work.

<span class="clickylink"><a target="new" rel="nofollow" href="http://lists.scsys.co.uk/pipermail/dbix-class/2009-December/008680.html">http://lists.scsys.co.uk/pipermail/dbix-class/2009-December/008680.html</a></span>

I&#39;ve attached sample program to reproduce this error on DBIx::Class 
version 0.08115.  Note that even though we create a customer with *no* 
account information &#40;as is allowed by the code&#41;, the code still reports 
the customer as having a &#34;Premium&#34; account.

Cheers,
Ovid
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> might_have.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl

use strict;
use warnings;

my $db  = &#39;premium.db&#39;;
my $sql = &lt;&lt;&#39;END&#39;;
create table customer &#40;
    id    int primary key, 
    account_id int null,
    foreign key&#40;account_id&#41; references account&#40;id&#41;
&#41;;
create table account  &#40;
    id int primary key,
    type varchar&#40;10&#41;
&#41;;
insert into account values &#40; 1, &#39;Premium&#39; &#41;;
END

unlink $db if -f $db;
open my $fh, &#34;| sqlite3 $db&#34; or die &#34;Cannot pipe to sqlite3: $!&#34;;
print $fh $sql or die $!;
close $fh or die $!;

{
    package The::Schema;
    use parent qw/DBIx::Class::Schema/;
}
{
    package The::Schema::Account;
    use parent &#39;DBIx::Class&#39;;
    __PACKAGE__-&gt;load_components&#40;&#34;Core&#34;&#41;;
    __PACKAGE__-&gt;table&#40;&#34;account&#34;&#41;;
    __PACKAGE__-&gt;add_columns&#40;
        id   =&gt; { data_type =&gt; &#34;int&#34; },
        type =&gt; { data_type =&gt; &#34;varchar&#34; },
    &#41;;
    __PACKAGE__-&gt;set_primary_key&#40;&#34;id&#34;&#41;;
    The::Schema-&gt;register_class&#40; &#39;Account&#39;, __PACKAGE__ &#41;;
}
{
    package The::Schema::Customer;
    use parent &#39;DBIx::Class&#39;;
    __PACKAGE__-&gt;load_components&#40;&#34;Core&#34;&#41;;
    __PACKAGE__-&gt;table&#40;&#34;customer&#34;&#41;;
    __PACKAGE__-&gt;add_columns&#40;
        id         =&gt; { data_type =&gt; &#34;int&#34; },
        account_id =&gt; { data_type =&gt; &#34;int&#34;, is_nullable =&gt; 1 },
    &#41;;
    __PACKAGE__-&gt;set_primary_key&#40;&#34;id&#34;&#41;;
    __PACKAGE__-&gt;might_have&#40; &#34;account&#34;, &#34;The::Schema::Account&#34; &#41;;
    The::Schema-&gt;register_class&#40; &#39;Customer&#39;, __PACKAGE__ &#41;;
}
my $schema = The::Schema-&gt;connect&#40;&#34;dbi:SQLite:dbname=$db&#34;&#41;;
my $cust = $schema-&gt;resultset&#40;&#39;Customer&#39;&#41;-&gt;create&#40; {} &#41;;
print $cust-&gt;account-&gt;type;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;15&nbsp;06:26:27&nbsp;2009</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 15 05:37:50 2009, OVID wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Bug:  might_have relationships which depend on an attribute with 
&gt; &#34;is_nullable&#34; being true can return incorrect data if that attribute is 
&gt; NULL.
&gt; 
&gt; Peter Rabbitson mentions this bug in a mailing list response, but it 
&gt; appears that people think the bug was eliminated.  It&#39;s now causing 
&gt; incorrect responses at my work.
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://lists.scsys.co.uk/pipermail/dbix-class/2009-December/008680.html">http://lists.scsys.co.uk/pipermail/dbix-class/2009-December/008680.html</a></span>
&gt; 
&gt; I&#39;ve attached sample program to reproduce this error on DBIx::Class 
&gt; version 0.08115.  Note that even though we create a customer with *no* 
&gt; account information &#40;as is allowed by the code&#41;, the code still reports 
&gt; the customer as having a &#34;Premium&#34; account.
&gt; 
&gt; Cheers,
&gt; Ovid
</div>
The example is completely flawed. You have Customer which may or may not
be related to an Account. However you keep the primary key of the
Account in a foreign key column in Customer &#40;which is odd in itself&#41;.
The only relationship helper for this is belong_to. Think of
relationships as two-way:
on one side you ALWAYS have belongs_to
on the other you have has_one/might_have/has_many

belongs_to signals: &#34;This class holds the foreign PK in an FK column&#34;
anything else says: Someone holds *our* PK in a column in the foreign class

The reason you see what you see is weirdness in the might_have/has_one
automatic column inference. Long story short the actual relationship
becomes JOIN ... ON &#39;account&#39;.&#39;id&#39; = &#39;customer&#39;.&#39;id&#39;, which is why you
get the account returned &#40;1 == 1&#41;.

In general in order to avoid such pitfalls always supply the 3rd
argument to the relationship helper. The automatic inference is an imho
unfortunate cargo-cult from CDBI, and is causing much more grief than
the value it supposedly brings.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;15&nbsp;06:26:27&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;15&nbsp;06:43:47&nbsp;2009</span>
    <span class="description">ovid [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 15 06:26:27 2009, RIBASUSHI wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The example is completely flawed. You have Customer which may or 
</div>may not
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; be related to an Account. However you keep the primary key of the
&gt; Account in a foreign key column in Customer &#40;which is odd in itself&#41;.
&gt; The only relationship helper for this is belong_to. Think of
&gt; relationships as two-way:
&gt; on one side you ALWAYS have belongs_to
&gt; on the other you have has_one/might_have/has_many
&gt; 
&gt; belongs_to signals: &#34;This class holds the foreign PK in an FK column&#34;
&gt; anything else says: Someone holds *our* PK in a column in the 
</div>foreign class
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; The reason you see what you see is weirdness in the 
</div>might_have/has_one
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; automatic column inference. Long story short the actual relationship
&gt; becomes JOIN ... ON &#39;account&#39;.&#39;id&#39; = &#39;customer&#39;.&#39;id&#39;, which is why you
&gt; get the account returned &#40;1 == 1&#41;.
&gt; 
&gt; In general in order to avoid such pitfalls always supply the 3rd
&gt; argument to the relationship helper. The automatic inference is an 
</div>imho
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; unfortunate cargo-cult from CDBI, and is causing much more grief 
</div>than
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; the value it supposedly brings.
&gt; 
</div>
Hi Peter,

Thanks for the quick response.  While I agree that the example is 
problematic, the response is even more so.  It&#39;s a silent failure mode.  
The larger an application, the harder something like this would be to 
find.   Could the inference be deprecated?  Is there another way this 
could be handled?

Cheers,
Ovid
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;16&nbsp;07:08:15&nbsp;2009</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Not a bug. Confusion was due to improper documentation, improvements
pending.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;16&nbsp;07:08:17&nbsp;2009</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
