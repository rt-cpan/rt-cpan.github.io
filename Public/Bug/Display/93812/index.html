<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #93812 for GnuPG-Interface: Please add a method to GnuPG::Handles objects to process multiple handles at once.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #93812 for GnuPG-Interface: Please add a method to GnuPG::Handles objects to process multiple handles at once.</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/GnuPG-Interface/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/GnuPG-Interface/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/GnuPG-Interface/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/GnuPG-Interface/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/GnuPG-Interface">GnuPG-Interface CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">93812</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/GnuPG-Interface/Active/">GnuPG-Interface</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
guilhem [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-14866-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-14867-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;12&nbsp;20:15:57&nbsp;2014</span>
    <span class="description">guilhem [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Please add a method to GnuPG::Handles objects to process multiple
 handles at once.</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi there,

A common use of GnuPG in scripts is to parse the output and process it
as it comes.  Therefore the following pattern is very common &#40;at least
in my code&#41; when working with GnuPG::Interface.

    my $pid = $gpg-&gt;list_public_keys&#40;handles =&gt; $handles, command_args =&gt; ...&#41;;
    while &#40;$handles-&gt;{stdout}-&gt;getlines&#40;&#41;&#41; {
        # process line
    }
    waitpid $pid, 0;
    $handles-&gt;{stdout}-&gt;close&#40;&#41;;

This is fine as it doesn&#39;t involve anything complicated; however it&#39;s
far more tricky when two IO::Handle objects have to be processed
simultaneously, since IO::Select has to enter into the picture.


Given that it&#39;s not so uncommon to have to process two handles at once
&#40;force instance the standard output and the status descriptor when
editing a key&#41;, I propose to add the following method &#39;communicate&#39;
&#40;heavily inspired from caff&#39;s &#39;readwrite_gpg&#39; function [1]&#41; to
GnuPG::Handles objects.

    $handles-&gt;communicate&#40; writefd =&gt; &#34;Some data to write in\n&#34;
                         , readfd =&gt; sub { push @data, $_ }
                         , OPTIONS &#41;;

 * writefd &#40;resp. readfd&#41; are input &#40;resp. output&#41; data members of
   GnuPG::Handles objects.  Possible values are qw/stdin passphrase
   command/ &#40;resp. qw/stdout stderr status logger/&#41;.

 * When input data members are given, their value must be a scalar which
   is written to the corresponding handle.

 * When output data members are given, their value must be a reference
   to either a subroutine &#40;used as a callback processing each line,
   bound as $_, which is read on the handle&#41; or a regular expression
   &#40;which is matched against each line read on the handle&#41;.  If the
   callback returns a non-zero value, or if the regular expression
   matches the current line, then the method exits.

 * In list context, this method returns a hash where keys are the given
   output data members, and values are string representing the data
   read.

 * The only option is keep_handles_open &#40;default: undefined&#41; which, if
   set, don&#39;t autoclose the handles after writing/reading or when the
   callback aborts.


Examples:

 # Dump output and status FDs:
 my %output = $handles-&gt;communicate&#40;&#41;;
 print &#34;Stdout is:\n$output{stdout}\nStatus is:\n$output{status}\n&#34;;

 # Get the first public key found in a listing
 $handles-&gt;communicate&#40; stdout =&gt; sub {
    if &#40;/^pub:.:&#40;?:[^:]*:&#41;{2,2}&#40;[^:]+&#41;:/&#41; {
        $key = $1;
        return 1;
    }
    return;
 }&#41;;

 # Store all public key found in a listing:
 $handles-&gt;communicate&#40; stdout =&gt; sub {
    push @key, $1 if /^pub:.:&#40;?:[^:]*:&#41;{2,2}&#40;[^:]+&#41;:/;
    return;
 }&#41;;

 # Select the first UID when editing a key, and keep the handles open:
 $handles-&gt;communicate&#40; command =&gt; &#34;uid 1\n&#34;, status =&gt; qr/^\[GNUPG:\] GET_LINE keyedit\.prompt$/, keep_handles_open =&gt; 1&#41;;

 # Store all UIDs as well as attributes
 $handles-&gt;communicate&#40; stdout =&gt; sub {
    push @uids, $1 if /^&#40;?:uid|uat&#41;:.:.*:[0-9A-F]{40}::&#40;[^:]+&#41;:$/
    return;
 }, status =&gt; sub {
    push @photos, {key =&gt; $1, size =&gt; $2, revoked =&gt; $3 &#38; 0x02}
        if /^\[GNUPG:\] ATTRIBUTE [0-9A-F]{24}&#40;[0-9A-F]{16}&#41; &#40;\d+&#41; 1 1 1 \d+ \d+ &#40;\d+&#41;$/
    return;
 }&#41;;

 # Delete a sig in the keyedit prompt, but remember which:
 $handles-&gt;communicate&#40; command =&gt; &#34;yes\n&#34;, keep_handles_open =&gt; 1, status =&gt; qr/^\[GNUPG:\] GET_BOOL keyedit\.delsig\.&#40;?:unknown|invalid|valid&#41;$/, stdout =&gt; sub {
    push @sigs, $1 if /^sig:.::\d+:&#40;[0-9A-F]{16}&#41;:\d+:.*:&#40;1[0-3]|30&#41;[lx]$/
    return;
 }&#41;;


I attach a proof of concept &#40;again, heavily inspired from caff&#39;s
&#39;readwrite_gpg&#39; function [1]&#41;.  Feedback welcome.

Thanks,
cheers,
--
Guilhem.

[1] <span class="clickylink"><a target="new" rel="nofollow" href="http://pgp-tools.alioth.debian.org/">http://pgp-tools.alioth.debian.org/</a></span>
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> communicate.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">sub communicate&#40;$%&#41; {
	my $self = shift;
	my %args = @_;

	my @wfds = qw/stdin passphrase command/;	# known input handles
	my @rfds = qw/stdout stderr status logger/;	# known output handles

	# ignore naked globs and unkown handles; ignore inputs we are not writing to
	@wfds = grep {defined $self-&gt;{$_} and ref $self-&gt;{$_} eq &#39;IO::Handle&#39; and defined $args{$_}} @wfds;
	@rfds = grep {defined $self-&gt;{$_} and ref $self-&gt;{$_} eq &#39;IO::Handle&#39;} @rfds;
	$self-&gt;{$_}-&gt;blocking&#40;0&#41; foreach &#40;@wfds, @rfds&#41;;

	my $ws = IO::Select-&gt;new&#40; @$self{@wfds} &#41;;
	my $rs = IO::Select-&gt;new&#40; @$self{@rfds} &#41;;
	my %names = map { $self-&gt;{$_} =&gt; $_ } &#40;@rfds,@wfds&#41;;

	my %left = map {$_ =&gt; length $args{$_}} @wfds; # #bytes left to write
	my %output = map {$_ =&gt; &#39;&#39;} @rfds;

	my $done = 0;
	while &#40;$rs-&gt;count&#40;&#41; or $ws-&gt;count&#40;&#41;&#41; {
		my @ready = IO::Select::select&#40;$rs, $ws, undef, $done ? 0 : 1&#41;;
		$_ //= [] foreach @ready[0,1];

		# if we exited due to an aborted callback, we keep processing
		# the other handles &#40;but select without timeout&#41; to give a
		# chance for the related data &#40;e.g. interleaving handles&#41; to
		# show up
		last if $done and !@{$ready[0]} and !@{$ready[1]};

		foreach my $fd &#40;@{$ready[0]}&#41; { # readers
			my $name = $names{$fd};

			if &#40;$fd-&gt;eof&#41; { # done reading from $fd
				$rs-&gt;remove&#40;$fd&#41;;
				$fd-&gt;close&#40;&#41; unless $args{keep_handles_open};
				next;
			}
			foreach my $line &#40;$fd-&gt;getlines&#40;&#41;&#41; {
				$output{$name} .= $line if wantarray;

				if &#40;defined $args{$name}&#41; { # callback
					local $_ = $line;
					my $r = ref $args{$name} eq &#39;CODE&#39; ? $args{$name}-&gt;&#40;&#41; :
							ref $args{$name} eq &#39;Regexp&#39; ? $line =~ /$args{$name}/ :
							die &#34;Unrecognized reference for $name: &#34;.&#40;ref $args{$name}&#41;;
					if &#40;$r&#41; {
						$done = 1;
						$rs-&gt;remove&#40;$fd&#41;; # stop processing that fd
						$fd-&gt;close&#40;&#41; unless $args{keep_handles_open};
						last; # exit the getlines
					}
				}
			}
		}

		foreach my $fd &#40;@{$ready[1]}&#41; { # writers
			my $name = $names{$fd};

			if &#40;$left{$name}&#41; {
				my $written = $fd-&gt;syswrite&#40;$args{$name}, $left{$name}, -$left{$name}&#41;;
				$left{$name} -= $written;
			};
			unless &#40;$left{$name}&#41; { # done writing in $fd
				$ws-&gt;remove&#40;$fd&#41;;
				$fd-&gt;close&#40;&#41; unless $args{keep_handles_open};
			}
		}
	}

	return %output if wantarray;
}
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
