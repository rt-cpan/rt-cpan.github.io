<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #30271 for SOAP-Lite: Don&#39;t give strings with utf8 flag set to MIME::Base64::encode_base64&#40;&#41;.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #30271 for SOAP-Lite: Don&#39;t give strings with utf8 flag set to MIME::Base64::encode_base64&#40;&#41;.</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/SOAP-Lite/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/SOAP-Lite/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/SOAP-Lite/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/SOAP-Lite/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/SOAP-Lite">SOAP-Lite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">30271</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/SOAP-Lite/Active/">SOAP-Lite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cmanley [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-29122-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.69</li>
<li>
0.70_01</li>
</ul>
    </td>
  </tr>
  <tr id="CF-29123-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;25&nbsp;15:26:59&nbsp;2007</span>
    <span class="description">cmanley [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Don&#39;t give strings with utf8 flag set to MIME::Base64::encode_base64&#40;&#41;.</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">In these 2 methods, there is no checking to see if the given string is 
utf8 flagged or not:
SOAP::XMLSchema1999::Serializer::as_base64
SOAP::XMLSchema2001::Serializer::as_base64Binary

I had a few cases where a utf8 flagged string containing a euro symbol 
was passed causing MIME::Base64::encode_base64 to die &#40;rightfully 
because it is meant to encode octets only&#41;.

The solution is to add this code just before 
MIME::Base64::encode_base64&#40;&#41; is called in order to turn the utf8 flag 
off:

require Encode;
if &#40;Encode::is_utf8&#40;$value&#41;&#41; {
  if &#40;Encode-&gt;can&#40;&#39;_utf8_off&#39;&#41;&#41; { # the quick way, but it may change in 
future Perl versions.
    Encode::_utf8_off&#40;$value&#41;;
  }
  else {
    $value = pack&#40;&#39;C*&#39;,unpack&#40;&#39;C*&#39;,$value&#41;&#41;; # the slow but safe way, 
but this fallback works always.
  }
} 


The &#40;dirty&#41; workaround for those of you who can&#39;t wait for this to be 
fixed is to place this code in your SOAP server just below the &#39;use&#39; 
clauses:

# First of all inject some patches into broken SOAP::Lite modules.
# This is dirty symbol table hack. It works for now, but remove this 
when SOAP::Lite has been fixed.
if &#40;$SOAP::Lite::VERSION &lt;= 0.70&#41; {
        if &#40;UNIVERSAL::can&#40;&#39;SOAP::XMLSchema2001::Serializer&#39;, 
&#39;as_base64Binary&#39;&#41;&#41; {
                my $origsub = 
\&#38;SOAP::XMLSchema2001::Serializer::as_base64Binary;
                *SOAP::XMLSchema2001::Serializer::as_base64Binary = sub 
{
                        my $self = shift;
                        my&#40;$value, $name, $type, $attr&#41; = @_;

                        # Base64 encoding only makes sense for octal 
characters, so to prevent
                        # MIME::Base64::encode_base64&#40;&#41; from rightfully 
croaking when given a utf8
                        # flagged string to encode, remove the utf8 
flag of the string so that it
                        # is treated as a string of bytes &#40;even though 
it&#39;s not&#41;.
                        require Encode;
                        if &#40;Encode::is_utf8&#40;$value&#41;&#41; {
                                if &#40;Encode-&gt;can&#40;&#39;_utf8_off&#39;&#41;&#41; { # the 
quick way, but it may change in future Perl versions.
                                        Encode::_utf8_off&#40;$value&#41;;
                                }
                                else {
                                        $value = 
pack&#40;&#39;C*&#39;,unpack&#40;&#39;C*&#39;,$value&#41;&#41;; # the slow but safe way, but this 
fallback works always.
                                }
                        }
                        return &#38;$origsub&#40;$self, $value, $name, $type, 
$attr&#41;;
                }
        }
        if &#40;UNIVERSAL::can&#40;&#39;SOAP::XMLSchema1999::Serializer&#39;, 
&#39;as_base64&#39;&#41;&#41; {
                my $origsub = 
\&#38;SOAP::XMLSchema1999::Serializer::as_base64;
                *SOAP::XMLSchema1999::Serializer::as_base64 = sub {
                        my $self = shift;
                        my&#40;$value, $name, $type, $attr&#41; = @_;

                        # Base64 encoding only makes sense for octal 
characters, so to prevent
                        # MIME::Base64::encode_base64&#40;&#41; from rightfully 
croaking when given a utf8
                        # flagged string to encode, remove the utf8 
flag of the string so that it
                        # is treated as a string of bytes &#40;even though 
it&#39;s not&#41;.
                        require Encode;
                        if &#40;Encode::is_utf8&#40;$value&#41;&#41; {
                                if &#40;Encode-&gt;can&#40;&#39;_utf8_off&#39;&#41;&#41; { # the 
quick way, but it may change in future Perl versions.
                                        Encode::_utf8_off&#40;$value&#41;;
                                }
                                else {
                                        $value = 
pack&#40;&#39;C*&#39;,unpack&#40;&#39;C*&#39;,$value&#41;&#41;; # the slow but safe way, but this 
fallback works always.
                                }
                        }
                        return &#38;$origsub&#40;$self, $value, $name, $type, 
$attr&#41;;
                }
        }
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;28&nbsp;18:42:06&nbsp;2007</span>
    <span class="description">kutterma [...] users.sourceforge.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Applied the following in CVS:

    # Fixes #30271 for 5.8 and above.
    # Won&#39;t fix for 5.6 and below - perl can&#39;t handle unicode before 
    # 5.8, and applying pack&#40;&#41; to everything is just a slowdown.
    if &#40;eval &#34;require Encode; 1&#34;&#41; {
        if &#40;Encode::is_utf8&#40;$value&#41;&#41; {
            if &#40;Encode-&gt;can&#40;&#39;_utf8_off&#39;&#41;&#41; { # the quick way, but it may 
change in future Perl versions.
                Encode::_utf8_off&#40;$value&#41;;
            }
            else {
                $value = pack&#40;&#39;C*&#39;,unpack&#40;&#39;C*&#39;,$value&#41;&#41;; # the slow but 
safe way, 
                # but this fallback works always.
            }
        }
    }


This should fix the issue for perl5.8 and above, while leaving 5.6 and 
below alone. There&#39;s no use in porting unicode support to 5.6, as perl 
itself does not support it in &lt;5.8

Thanks,

Martin
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;28&nbsp;18:42:08&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;28&nbsp;18:42:08&nbsp;2007</span>
    <span class="description">kutterma [...] users.sourceforge.net -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;14&nbsp;19:22:50&nbsp;2013</span>
    <span class="description">victor [...] vsespb.ru -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;14&nbsp;19:29:42&nbsp;2013</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> victor [...] vsespb.ru</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think such code introduce small inconsistency:

Latin1 downgraded strings auto-converted by perl to Unicode when output to external world.

So two strings that are equal can be encoded different way by this method. &#40;example below&#41;.

The correct solution would be ask user to specify encoding or specify &#34;BINARY&#34; encoding when calling this method.

use utf8;
use Encode;
use Devel::Peek;

my $s1 = &#34;\xB5&#34;;
my $s2 = decode&#40;&#34;UTF-8&#34;, &#34;\xC2\xB5&#34;&#41;;

print &#34;MATCH!\n&#34; if $s1 eq $s2;

Dump $s1;
Dump $s2;
__END__

MATCH!
SV = PV&#40;0x16d1b78&#41; at 0x16fcb28
  REFCNT = 1
  FLAGS = &#40;PADMY,POK,pPOK&#41;
  PV = 0x16efd90 &#34;\265&#34;\0
  CUR = 1
  LEN = 8
SV = PV&#40;0x16d2038&#41; at 0x16fcbe8
  REFCNT = 1
  FLAGS = &#40;PADMY,POK,pPOK,UTF8&#41;
  PV = 0x17bdb40 &#34;\302\265&#34;\0 [UTF8 &#34;\x{b5}&#34;]
  CUR = 2
  LEN = 8



On Mon Oct 29 01:42:06 2007, MKUTTER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Applied the following in CVS:
&gt; 
&gt;     # Fixes #30271 for 5.8 and above.
&gt;     # Won&#39;t fix for 5.6 and below - perl can&#39;t handle unicode before 
&gt;     # 5.8, and applying pack&#40;&#41; to everything is just a slowdown.
&gt;     if &#40;eval &#34;require Encode; 1&#34;&#41; {
&gt;         if &#40;Encode::is_utf8&#40;$value&#41;&#41; {
&gt;             if &#40;Encode-&gt;can&#40;&#39;_utf8_off&#39;&#41;&#41; { # the quick way, but it may 
&gt; change in future Perl versions.
&gt;                 Encode::_utf8_off&#40;$value&#41;;
&gt;             }
&gt;             else {
&gt;                 $value = pack&#40;&#39;C*&#39;,unpack&#40;&#39;C*&#39;,$value&#41;&#41;; # the slow but 
&gt; safe way, 
&gt;                 # but this fallback works always.
&gt;             }
&gt;         }
&gt;     }
&gt; 
&gt; 
&gt; This should fix the issue for perl5.8 and above, while leaving 5.6 and 
&gt; below alone. There&#39;s no use in porting unicode support to 5.6, as perl 
&gt; itself does not support it in &lt;5.8
&gt; 
&gt; Thanks,
&gt; 
&gt; Martin
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;15&nbsp;05:54:54&nbsp;2013</span>
    <span class="description">kutterma [...] users.sourceforge.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Victor,

the issue you responded to has been closed for almost 6 years now.

Do you have a real-world problem with SOAP::Lite&#39;s behavior &#40;in the latest version&#41;?

In this case, please attach some sample code demonstrating the error when using SOAP::Lite.

I&#39;ll close the ticket again - it&#39;ll be reopened automatically in case you reply to this mail.

Best regards,

Martin

Am Mi 14. Aug 2013, 19:29:42, vsespb schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think such code introduce small inconsistency:
&gt; 
&gt; Latin1 downgraded strings auto-converted by perl to Unicode when
&gt; output to external world.
&gt; 
&gt; So two strings that are equal can be encoded different way by this
&gt; method. &#40;example below&#41;.
&gt; 
&gt; The correct solution would be ask user to specify encoding or specify
&gt; &#34;BINARY&#34; encoding when calling this method.
&gt; 
&gt; use utf8;
&gt; use Encode;
&gt; use Devel::Peek;
&gt; 
&gt; my $s1 = &#34;\xB5&#34;;
&gt; my $s2 = decode&#40;&#34;UTF-8&#34;, &#34;\xC2\xB5&#34;&#41;;
&gt; 
&gt; print &#34;MATCH!\n&#34; if $s1 eq $s2;
&gt; 
&gt; Dump $s1;
&gt; Dump $s2;
&gt; __END__
&gt; 
&gt; MATCH!
&gt; SV = PV&#40;0x16d1b78&#41; at 0x16fcb28
&gt;   REFCNT = 1
&gt;   FLAGS = &#40;PADMY,POK,pPOK&#41;
&gt;   PV = 0x16efd90 &#34;\265&#34;\0
&gt;   CUR = 1
&gt;   LEN = 8
&gt; SV = PV&#40;0x16d2038&#41; at 0x16fcbe8
&gt;   REFCNT = 1
&gt;   FLAGS = &#40;PADMY,POK,pPOK,UTF8&#41;
&gt;   PV = 0x17bdb40 &#34;\302\265&#34;\0 [UTF8 &#34;\x{b5}&#34;]
&gt;   CUR = 2
&gt;   LEN = 8
&gt; 
&gt; 
&gt; 
&gt; On Mon Oct 29 01:42:06 2007, MKUTTER wrote:
<div class="message-stanza open">&gt; &gt; Applied the following in CVS:
&gt; &gt;
&gt; &gt; # Fixes #30271 for 5.8 and above.
&gt; &gt;  # Won&#39;t fix for 5.6 and below - perl can&#39;t handle unicode before
&gt; &gt; # 5.8, and applying pack&#40;&#41; to everything is just a slowdown.
&gt; &gt; if &#40;eval &#34;require Encode; 1&#34;&#41; {
&gt; &gt;     if &#40;Encode::is_utf8&#40;$value&#41;&#41; {
&gt; &gt;          if &#40;Encode-&gt;can&#40;&#39;_utf8_off&#39;&#41;&#41; { # the quick way, but it may
&gt; &gt; change in future Perl versions.
&gt; &gt;             Encode::_utf8_off&#40;$value&#41;;
&gt; &gt;         }
&gt; &gt;         else {
&gt; &gt;              $value = pack&#40;&#39;C*&#39;,unpack&#40;&#39;C*&#39;,$value&#41;&#41;; # the slow but
&gt; &gt; safe way,
&gt; &gt;             # but this fallback works always.
&gt; &gt;         }
&gt; &gt;     }
&gt; &gt; }
&gt; &gt;
&gt; &gt;
&gt; &gt; This should fix the issue for perl5.8 and above, while leaving 5.6
&gt; &gt; and
&gt; &gt; below alone. There&#39;s no use in porting unicode support to 5.6, as
&gt; &gt; perl
&gt; &gt; itself does not support it in &lt;5.8
&gt; &gt;
&gt; &gt; Thanks,
&gt; &gt;
&gt; &gt; Martin
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;15&nbsp;05:54:55&nbsp;2013</span>
    <span class="description">kutterma [...] users.sourceforge.net -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;16&nbsp;07:47:46&nbsp;2013</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> victor [...] vsespb.ru</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use SOAP::Lite &#39;trace&#39;, &#39;debug&#39;;
use Encode;
use strict;
use warnings;
use Digest::SHA qw/sha1_hex/;
use utf8;
my $soap = SOAP::Lite-&gt;new&#40; proxy =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://176.58.110.134/soap-wsdl-test/helloworld.pl&#39;&#41;">https://176.58.110.134/soap-wsdl-test/helloworld.pl&#39;&#41;</a></span>;
$soap-&gt;default_ns&#40;&#39;urn:HelloWorld&#39;&#41;;

my $s = decode&#40;&#34;UTF-8&#34;, &#34;\xC2\xB5&#34;&#41;;
my $digest = sha1_hex&#40;$s&#41;; # TRY COMMENT THIS OUT

my $som = $soap-&gt;call&#40;&#39;sayHello&#39;, &#39;Kutter&#39;, $s&#41;;
die $som-&gt;faultstring if &#40;$som-&gt;fault&#41;;
print $som-&gt;result, &#34;\n&#34;;
__END__


if sends different data to remote server - either

&lt;c-gensym5 xsi:type=&#34;xsd:base64Binary&#34;&gt;tQ==&lt;/c-gensym5&gt;

or

&lt;c-gensym5 xsi:type=&#34;xsd:base64Binary&#34;&gt;wrU=&lt;/c-gensym5&gt;

depending on whenever sha1_hex&#40;&#41; call commented out or no.

so sha1_hex&#40;&#41; call has a side effect on what is actually send to remote server, while it should not.

Note 1: that Digest::SHA document this behaviour:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Be aware that the digest routines silently convert UTF-8 input into its
&gt; equivalent byte sequence in the native encoding &#40;cf. utf8::downgrade&#41;. This &gt; side effect influences only the way Perl stores the data internally, but
&gt; otherwise leaves the actual value of the data intact.
</div>
Similar behaviour is observed in JSON module:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It will also try to downgrade any strings to octet-form if possible: perl 
&gt; stores strings internally either in an encoding called UTF-X or in 
&gt; octet-form. The latter cannot store everything but uses less space in
&gt; general &#40;and some buggy Perl or C code might even rely on that internal 
&gt; representation being used&#41;.
</div>
note the words &#34;some buggy Perl or C&#34;

Note 2: According to perl unicode specifications, any 3rd party code can downgrade strings, without advertising it in documentation.

Note 3: Those are example of character string silently downgraded, but same way
binary string can be silently upgraded to string with UTF-8 bit set &#40;and remain binary string after that&#41;

Note 4: if you print $s to output file, _with_ or _without_ specifying encoding, it will be always same, independent of sha1_hex call.

Note 5: This problem does not affect me directly, so if you prefer fix code, only if some real user have real problems with module, it&#39;s not the case yet.
This just is a proof-of-concept of possible problems.

On Thu Aug 15 13:54:54 2013, MKUTTER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello Victor,
&gt; 
&gt; the issue you responded to has been closed for almost 6 years now.
&gt; 
&gt; Do you have a real-world problem with SOAP::Lite&#39;s behavior &#40;in the
&gt; latest version&#41;?
&gt; 
&gt; In this case, please attach some sample code demonstrating the error
&gt; when using SOAP::Lite.
&gt; 
&gt; I&#39;ll close the ticket again - it&#39;ll be reopened automatically in case
&gt; you reply to this mail.
&gt; 
&gt; Best regards,
&gt; 
&gt; Martin
&gt; 
&gt; Am Mi 14. Aug 2013, 19:29:42, vsespb schrieb:
<div class="message-stanza open">&gt; &gt; I think such code introduce small inconsistency:
&gt; &gt;
&gt; &gt; Latin1 downgraded strings auto-converted by perl to Unicode when
&gt; &gt; output to external world.
&gt; &gt;
&gt; &gt; So two strings that are equal can be encoded different way by this
&gt; &gt; method. &#40;example below&#41;.
&gt; &gt;
&gt; &gt; The correct solution would be ask user to specify encoding or specify
&gt; &gt; &#34;BINARY&#34; encoding when calling this method.
&gt; &gt;
&gt; &gt; use utf8;
&gt; &gt; use Encode;
&gt; &gt; use Devel::Peek;
&gt; &gt;
&gt; &gt; my $s1 = &#34;\xB5&#34;;
&gt; &gt; my $s2 = decode&#40;&#34;UTF-8&#34;, &#34;\xC2\xB5&#34;&#41;;
&gt; &gt;
&gt; &gt; print &#34;MATCH!\n&#34; if $s1 eq $s2;
&gt; &gt;
&gt; &gt; Dump $s1;
&gt; &gt; Dump $s2;
&gt; &gt; __END__
&gt; &gt;
&gt; &gt; MATCH!
&gt; &gt; SV = PV&#40;0x16d1b78&#41; at 0x16fcb28
&gt; &gt;   REFCNT = 1
&gt; &gt;   FLAGS = &#40;PADMY,POK,pPOK&#41;
&gt; &gt;   PV = 0x16efd90 &#34;\265&#34;\0
&gt; &gt;   CUR = 1
&gt; &gt;   LEN = 8
&gt; &gt; SV = PV&#40;0x16d2038&#41; at 0x16fcbe8
&gt; &gt;   REFCNT = 1
&gt; &gt;   FLAGS = &#40;PADMY,POK,pPOK,UTF8&#41;
&gt; &gt;   PV = 0x17bdb40 &#34;\302\265&#34;\0 [UTF8 &#34;\x{b5}&#34;]
&gt; &gt;   CUR = 2
&gt; &gt;   LEN = 8
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; On Mon Oct 29 01:42:06 2007, MKUTTER wrote:
<div class="message-stanza open">&gt; &gt; &gt; Applied the following in CVS:
&gt; &gt; &gt;
&gt; &gt; &gt; # Fixes #30271 for 5.8 and above.
&gt; &gt; &gt;  # Won&#39;t fix for 5.6 and below - perl can&#39;t handle unicode before
&gt; &gt; &gt; # 5.8, and applying pack&#40;&#41; to everything is just a slowdown.
&gt; &gt; &gt; if &#40;eval &#34;require Encode; 1&#34;&#41; {
&gt; &gt; &gt;     if &#40;Encode::is_utf8&#40;$value&#41;&#41; {
&gt; &gt; &gt;          if &#40;Encode-&gt;can&#40;&#39;_utf8_off&#39;&#41;&#41; { # the quick way, but it
&gt; &gt; &gt; may
&gt; &gt; &gt; change in future Perl versions.
&gt; &gt; &gt;             Encode::_utf8_off&#40;$value&#41;;
&gt; &gt; &gt;         }
&gt; &gt; &gt;         else {
&gt; &gt; &gt;              $value = pack&#40;&#39;C*&#39;,unpack&#40;&#39;C*&#39;,$value&#41;&#41;; # the slow
&gt; &gt; &gt; but
&gt; &gt; &gt; safe way,
&gt; &gt; &gt;             # but this fallback works always.
&gt; &gt; &gt;         }
&gt; &gt; &gt;     }
&gt; &gt; &gt; }
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; This should fix the issue for perl5.8 and above, while leaving 5.6
&gt; &gt; &gt; and
&gt; &gt; &gt; below alone. There&#39;s no use in porting unicode support to 5.6, as
&gt; &gt; &gt; perl
&gt; &gt; &gt; itself does not support it in &lt;5.8
&gt; &gt; &gt;
&gt; &gt; &gt; Thanks,
&gt; &gt; &gt;
&gt; &gt; &gt; Martin
</div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;16&nbsp;07:48:14&nbsp;2013</span>
    <span class="description">victor [...] vsespb.ru -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;08&nbsp;09:21:21&nbsp;2015</span>
    <span class="description">christian [...] solvare.se -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #30271]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 08 Mar 2015 14:20:33 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-SOAP-Lite [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Christian Huldt &lt;christian [...] solvare.se&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Maybe just add

$content = SOAP::Data-&gt;type&#40;string =&gt; $content&#41;;

if $content is utf8?
That way it won&#39;t be fed to MIME::Base64....
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
