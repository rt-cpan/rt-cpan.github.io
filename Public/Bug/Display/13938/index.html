<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #13938 for Archive-Zip: Archive::Zip::MemberRead + XML::Parser</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #13938 for Archive-Zip: Archive::Zip::MemberRead + XML::Parser</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Archive-Zip">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Archive-Zip">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Archive-Zip">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Archive-Zip">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Archive-Zip">Archive-Zip CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">13938</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Archive-Zip">Archive-Zip</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dma_k [...] mail.ru

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-2540-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.15    </td>
  </tr>
  <tr id="CF-2541-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




log.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1069803/562696/log.txt">
Thu Apr 19 17:17:25 2012 (7.4k) by dma_k [...] mail.ru
</a>
</font></li>
</ul>


strace.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/138330/38215/strace.txt">
Sun Jul 31 10:53:17 2005 (2.5k) by 
</a>
</font></li>
</ul>


test.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/138332/38240/test.pl">
Mon Aug 01 08:47:53 2005 (517b) by 
</a>
</font></li>
</ul>


test_1.zip<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/138333/38243/test_1.zip">
Mon Aug 01 08:48:53 2005 (2.1k) by 
</a>
</font></li>
</ul>


test_2.zip<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/138334/38246/test_2.zip">
Mon Aug 01 08:49:22 2005 (11.2k) by 
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=13938">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-138330" href="/Public/Bug/Display.html?id=13938#txn-138330">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;31&nbsp;10:53:17&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Archive::Zip::MemberRead + XML::Parser</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/138330/38214/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/38214">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 944b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have the following problem: I&#39;ve got ZIP archives with huge XML files I need to parse chunk by chunk. I am trying to use Archive::Zip::MemberRead togather with XML::Parser. Unfortunately the stream is always unparseable:

=== code ===
use XML::Twig;       # Runs on the top of XML::Parser
use Archive::Zip;
use Archive::Zip::MemberRead;

my $catalog_parser = XML::Twig-&gt;new&#40;...&#41;;
my $zip = Archive::Zip-&gt;new&#40;...&#41;;
die &#34;Failed to open ZIP file: $!&#34; unless $zip;

foreach &#40;$zip-&gt;members&#40;&#41;&#41;
{
   $catalog_parser-&gt;parse&#40;$_-&gt;readFileHandle&#40;&#41;&#41;;
}
=== end of code ===

=== output ===
not well-formed &#40;invalid token&#41; at line 1, column 24, byte 24 at /usr/lib/perl5/vendor_perl/i386-linux/XML/Parser.pm line 187
=== end of output ===

The solution was suggested by Sreeji K Das: before calling XML::Parser-&gt;parse&#40;&#41; do:

@Archive::Zip::MemberRead::ISA = qw&#40; IO::Handle &#41;;

After that the perl script started to SEGFAULT. I have attached the strace log.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/138330/38215/strace.txt">Download strace.txt</a><br />
<span class="downloadcontenttype">text/plain 2.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">open&#40;&#34;./mirrors/its/hoteldetails/its_hoteldetails.zip&#34;, O_RDONLY|O_LARGEFILE&#41; = 4
ioctl&#40;4, SNDCTL_TMR_TIMEBASE or TCGETS, 0xbfffeb38&#41; = -1 ENOTTY &#40;Inappropriate ioctl for device&#41;
_llseek&#40;4, 0, [0], SEEK_CUR&#41;            = 0
fstat64&#40;4, {st_mode=S_IFREG|0644, st_size=459208, ...}&#41; = 0
fcntl64&#40;4, F_SETFD, FD_CLOEXEC&#41;         = 0
_llseek&#40;4, 0, [0], SEEK_SET&#41;            = 0
_llseek&#40;4, 0, [0], SEEK_CUR&#41;            = 0
read&#40;4, &#34;PK\3\4\24\0\2\0\10\0U}\3562V!\36\210F\1\7\0\205\370\350&#34;..., 4096&#41; = 4096
_llseek&#40;4, 30, [30], SEEK_SET&#41;          = 0
_llseek&#40;4, 0, [30], SEEK_CUR&#41;           = 0
_llseek&#40;4, 16, [46], SEEK_CUR&#41;          = 0
_llseek&#40;4, 0, [46], SEEK_CUR&#41;           = 0
_llseek&#40;4, 46, [46], SEEK_SET&#41;          = 0
_llseek&#40;4, 0, [46], SEEK_CUR&#41;           = 0
brk&#40;0&#41;                                  = 0x8d82000
brk&#40;0x8da4000&#41;                          = 0x8da4000
read&#40;4, &#34;\354\235Yo\343F\266\307\337\363&#41;j\362\320\230\301\264%&#34;..., 4096&#41; = 4096
read&#40;4, &#34;\20HE\267\244\342\375\242\330\t\230\v\5.NG\5\243\330I\230&#34;..., 4096&#41; = 4096
read&#40;4, &#34;\373\260\322n|\21P\312\230@\372\255\205\252\244;\7\32x&#34;..., 4096&#41; = 4096
read&#40;4, &#34;:\372\342\320oN8#\234Q\17g\234[\266\250/\26\277\233\372&#34;..., 4096&#41; = 4096
read&#40;4, &#34;\352u-\267O\265\257}\25\326 \251M\254\37Mm4\345?\313\332&#34;..., 4096&#41; = 4096
read&#40;4, &#34;\226\350\250H , , , , , , , , \254\27\10\213_\36\2521\300&#34;..., 4096&#41; = 4096
read&#40;4, &#34;\&#39;\351\2\2728\305\342\276M\375\30V;\205J{\232\322 \314&#34;..., 4096&#41; = 4096
read&#40;4, &#34;\202P\27\345\251\213\27M\324h\220\34\274\216\304\367,\351&#34;..., 4096&#41; = 4096
brk&#40;0&#41;                                  = 0x8da4000
brk&#40;0x8dda000&#41;                          = 0x8dda000
brk&#40;0&#41;                                  = 0x8dda000
brk&#40;0&#41;                                  = 0x8dda000
brk&#40;0x8dcb000&#41;                          = 0x8dcb000
brk&#40;0&#41;                                  = 0x8dcb000
mmap2&#40;NULL, 524288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0&#41; = 0x407e6000
brk&#40;0&#41;                                  = 0x8dcb000
brk&#40;0&#41;                                  = 0x8dcb000
brk&#40;0x8dac000&#41;                          = 0x8dac000
brk&#40;0&#41;                                  = 0x8dac000
mremap&#40;0x407e6000, 524288, 1048576, MREMAP_MAYMOVE&#41; = 0x407e6000
mremap&#40;0x407e6000, 1048576, 2097152, MREMAP_MAYMOVE&#41; = 0x407e6000
mmap2&#40;NULL, 1257472, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0&#41; = 0x409e6000
munmap&#40;0x407e6000, 2097152&#41;             = 0
mmap2&#40;NULL, 1257472, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0&#41; = 0x407e6000
munmap&#40;0x409e6000, 1257472&#41;             = 0
--- SIGSEGV &#40;Segmentation fault&#41; @ 0 &#40;0&#41; ---
+++ killed by SIGSEGV +++

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-138331" href="/Public/Bug/Display.html?id=13938#txn-138331">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;01&nbsp;02:19:37&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Sreeji [sreeji at gmail.com]</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/138331/38230/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/38230">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 537b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Sun Jul 31 10:53:17 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have the following problem: I&#39;ve got ZIP archives with huge XML
&gt;    files I need to parse chunk by chunk. I am trying to use
&gt;    Archive::Zip::MemberRead togather with XML::Parser. Unfortunately
&gt;    the stream is always unparseable:
</div>&lt;snip&gt;
I can&#39;t reproduce the issue using XML::Parser. Can you try to reproduce
this issue using XML::Parser &#40;no XML::Twig - it has too many pre-reqs.
and I can&#39;t download them all right now&#41;, and upload the code and
relevant &#40;small&#41; zip files you have used ?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-138332" href="/Public/Bug/Display.html?id=13938#txn-138332">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;01&nbsp;08:47:53&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dma_k [...] mail.ru</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/138332/38239/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/38239">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 726b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here goes the sample script. It is very simple. The test ZIPs follow. Notes:
1&#41; The files in ZIPs are known to be parsed with
$catalog_parser-&gt;parsefile&#40;&#39;ltupl_hoteldetails&#39;&#41;;
&#40;no ZIP processing&#41; w/o any error.
2&#41; The ZIPs are known to be read and parsed with
$catalog_parser-&gt;parse&#40;$_-&gt;contents&#40;&#41;&#41;;
&#40;parsing the whole in-memory contents&#41; w/o any error

The 
$ ln -s test_1.zip test.zip
$ ./test.pl
Processing XML: ltupl_hoteldetails.
*** glibc detected *** free&#40;&#41;: invalid next size &#40;normal&#41;: 0x083b28a8 ***
Aborted
$ ln -sf test_2.zip test.zip
$ ./test.pl
Processing XML: ltupl_hoteldetails.
Segmentation fault

Additional info:
perl: v5.8.7 built for i386-linux-thread-multi
perl-XML-Parser-2.34
libexpat-1.95.8
glibc-2.3.5
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/138332/38240/test.pl">Download test.pl</a><br />
<span class="downloadcontenttype">text/x-perl 517b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use XML::Parser;
use Archive::Zip;
use Archive::Zip::MemberRead;

@Archive::Zip::MemberRead::ISA = qw&#40; IO::Handle &#41;;

my $catalog_parser = new XML::Parser&#40;&#41;;

#$catalog_parser-&gt;parsefile&#40;&#39;ltupl_hoteldetails&#39;&#41;; exit;

my $zip = Archive::Zip-&gt;new&#40;&#39;test.zip&#39;&#41;;
die &#34;Failed to open ZIP file &#39;test.zip&#39;: $!&#34; unless $zip;

foreach &#40;$zip-&gt;members&#40;&#41;&#41;
{
	print &#34;Processing XML: &#34; . $_-&gt;fileName&#40;&#41; . &#34;.\n&#34;;
	#$catalog_parser-&gt;parse&#40;$_-&gt;contents&#40;&#41;&#41;;
	$catalog_parser-&gt;parse&#40;$_-&gt;readFileHandle&#40;&#41;&#41;;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-138333" href="/Public/Bug/Display.html?id=13938#txn-138333">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;01&nbsp;08:48:53&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dma_k [...] mail.ru</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/138333/38242/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/38242">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 15b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">First test ZIP.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/138333/38243/test_1.zip">Download test_1.zip</a><br />
<span class="downloadcontenttype">application/zip 2.1k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-138334" href="/Public/Bug/Display.html?id=13938#txn-138334">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;01&nbsp;08:49:22&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dma_k [...] mail.ru</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/138334/38245/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/38245">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 19b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Second test ZIP.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/138334/38246/test_2.zip">Download test_2.zip</a><br />
<span class="downloadcontenttype">application/zip 11.2k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-138335" href="/Public/Bug/Display.html?id=13938#txn-138335">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;01&nbsp;09:31:01&nbsp;2005</span>
    <span class="description">SMPETERS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/138335/38258/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/38258">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Mon Aug  1 08:47:53 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Here goes the sample script. It is very simple. The test ZIPs follow.
&gt;    Notes:
&gt; 1&#41; The files in ZIPs are known to be parsed with
&gt; $catalog_parser-&gt;parsefile&#40;&#39;ltupl_hoteldetails&#39;&#41;;
&gt; &#40;no ZIP processing&#41; w/o any error.
&gt; 2&#41; The ZIPs are known to be read and parsed with
&gt; $catalog_parser-&gt;parse&#40;$_-&gt;contents&#40;&#41;&#41;;
&gt; &#40;parsing the whole in-memory contents&#41; w/o any error
&gt; 
&gt; The
&gt; $ ln -s test_1.zip test.zip
&gt; $ ./test.pl
&gt; Processing XML: ltupl_hoteldetails.
&gt; *** glibc detected *** free&#40;&#41;: invalid next size &#40;normal&#41;: 0x083b28a8
&gt;    ***
&gt; Aborted
</div>
Looking at the back trace, the problem appears to be in
XML::Parser::Expat somewhere, rather than in Perl or Archive::Zip.  The
problem where you needed to add an ISA= qw&#40;IO::Handle&#41;, I&#39;ll have to
look into a bit more.

#0  0xffffe410 in __kernel_vsyscall &#40;&#41;
&#40;gdb&#41; bt
#0  0xffffe410 in __kernel_vsyscall &#40;&#41;
#1  0xb7dc856d in raise &#40;&#41; from /lib/tls/i686/cmov/libc.so.6
#2  0xb7dc9cf3 in abort &#40;&#41; from /lib/tls/i686/cmov/libc.so.6
#3  0xb7dfb376 in __fsetlocking &#40;&#41; from /lib/tls/i686/cmov/libc.so.6
#4  0xb7e015f5 in malloc_trim &#40;&#41; from /lib/tls/i686/cmov/libc.so.6
#5  0xb7e01969 in free &#40;&#41; from /lib/tls/i686/cmov/libc.so.6
#6  0xb7bf40fc in myfree &#40;&#41;
   from /usr/local/lib/perl/5.8.7/auto/XML/Parser/Expat/Expat.so
#7  0xb7bd6a20 in XML_ParserFree &#40;&#41; from /usr/lib/libexpat.so.1
#8  0xb7bfca66 in XS_XML__Parser__Expat_ParserFree &#40;&#41;
   from /usr/local/lib/perl/5.8.7/auto/XML/Parser/Expat/Expat.so
#9  0x080c424d in Perl_pp_entersub &#40;&#41;
#10 0x080bd07b in Perl_runops_standard &#40;&#41;
#11 0x08060cfe in Perl_get_cv &#40;&#41;
#12 0x0806470e in Perl_call_sv &#40;&#41;
#13 0x080c6c3d in Perl_sv_clear &#40;&#41;
#14 0x080c7443 in Perl_sv_free &#40;&#41;
#15 0x080c5bc3 in Perl_sv_add_arena &#40;&#41;
#16 0x080c5c0f in Perl_sv_clean_objs &#40;&#41;
#17 0x080664a4 in perl_destruct &#40;&#41;
#18 0x0805fdba in main &#40;&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-138336" href="/Public/Bug/Display.html?id=13938#txn-138336">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;04&nbsp;06:35:56&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dma_k [...] mail.ru</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/138336/38419/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/38419">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 306b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Looking at the back trace, the problem appears to be in
&gt; XML::Parser::Expat somewhere, rather than in Perl or Archive::Zip.
</div>
Ok, then how can you explain, that:
$catalog_parser-&gt;parse&#40;$_-&gt;contents&#40;&#41;&#41;;
works ok, but:
$catalog_parser-&gt;parse&#40;$_-&gt;readFileHandle&#40;&#41;&#41;;
does not &#40;see Note[2] in my prev. post&#41;?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-138337" href="/Public/Bug/Display.html?id=13938#txn-138337">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;04&nbsp;08:44:36&nbsp;2005</span>
    <span class="description">SMPETERS [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-138338" href="/Public/Bug/Display.html?id=13938#txn-138338">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;04&nbsp;08:44:36&nbsp;2005</span>
    <span class="description">SMPETERS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/138338/38421/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/38421">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Thu Aug  4 06:35:56 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Looking at the back trace, the problem appears to be in
&gt; &gt; XML::Parser::Expat somewhere, rather than in Perl or Archive::Zip.
</div>&gt; 
&gt; Ok, then how can you explain, that:
&gt; $catalog_parser-&gt;parse&#40;$_-&gt;contents&#40;&#41;&#41;;
&gt; works ok, but:
&gt; $catalog_parser-&gt;parse&#40;$_-&gt;readFileHandle&#40;&#41;&#41;;
&gt; does not &#40;see Note[2] in my prev. post&#41;?
</div>
Looking at the backtrace, it would appear XML::Parser::Expat is not
handling the filehandle correctly at destruction.  My guess would be
that it is confused by the conversion of Archive::Zip::MemberRead to an
IO::Handle.  

Since Archive::Zip has nothing to do with C or XS code, it cannot be
ultimately responsible for causing a SEGV.  It does have the possibility
to cause one in another module or in the Perl core code itself.  Based
on the backtrace, however, the SEGV seems to be occuring in
XML::Parser::Expat.  Also, since this occurs following the manipulation
of the internals of Archive::Zip::MemberRead outside of its code, I can
assume that the manipulation is helping it.  

I will continue to look into the various issues you&#39;ve raised and see if
I can subclass Archive::Zip::MemberRead from IO::Handle.  I probably
will not be looking into the coredump directly since it appears to be
caused by manipulation of the module internals outside of the module.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-138339" href="/Public/Bug/Display.html?id=13938#txn-138339">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;29&nbsp;07:42:06&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dma_k [...] mail.ru</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/138339/39445/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/39445">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 213b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">SMPETERS, will you be so kind to contact XML::Parser::Expat author? I
tried to use the Email address from CPAN, but nobody replied.
And one more question: how to become a registered user in this
bugtracker system?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1069640" href="/Public/Bug/Display.html?id=13938#txn-1069640">#</a>      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;19&nbsp;11:16:46&nbsp;2012</span>
    <span class="description">BBYRD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1069640/562580/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/562580">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 108b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Trying to clean up some RT tickets here.  Is this still an issue?  Does
the latest revision fix the problem?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1069803" href="/Public/Bug/Display.html?id=13938#txn-1069803">#</a>      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;19&nbsp;17:17:25&nbsp;2012</span>
    <span class="description">dma_k [...] mail.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> SMPETERS [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #13938] Archive::Zip::MemberRead + XML::Parser</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 19 Apr 2012 23:17:25 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Archive-Zip [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dmitry Katsubo &lt;dma_k [...] mail.ru&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1069803/562695/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/562695">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 564b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 19.04.2012 17:16, Brendan Byrd via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Trying to clean up some RT tickets here.  Is this still an issue?  Does
&gt; the latest revision fix the problem?
</div>
You&#39;re a hero: 7 years passed since the ticket was opened.

Unfortunately, the problem is still there. If you have enough courage to
look deeper into the problem, you&#39;re welcome. Or perhaps you can contact
XML::Parser team: maybe they can provide some input.

My logfile is attached &#40;&#34;Out of memory&#34; for test_1.zip and &#34;Segfault&#34;
for test_2.zip&#41;. Any ideas are welcomed.

-- 
With best regards,
Dmitry
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1069803/562696/log.txt">Download log.txt</a><br />
<span class="downloadcontenttype">text/plain 7.4k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.630634</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
