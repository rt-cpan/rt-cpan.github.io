<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #14231 for Class-Std: patch to add serialization to Class::Std</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #14231 for Class-Std: patch to add serialization to Class::Std</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Class-Std">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Class-Std">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Class-Std">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Class-Std">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Class-Std">Class-Std CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">14231</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Class-Std">Class-Std</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
luke [...] daeron.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-7300-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-7301-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




Class-Std-patch.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/140044/39085/Class-Std-patch.txt">
Thu Aug 18 21:27:26 2005 (2.1k) by dspizz [...] dspizz.com
</a>
</font></li>
</ul>


Class-Std-Storable.pm<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/140046/39108/Class-Std-Storable.pm">
Fri Aug 19 14:17:38 2005 (5.3k) by dspizz [...] dspizz.com
</a>
</font></li>
</ul>


Class-Std-Storable.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/140046/39109/Class-Std-Storable.t">
Fri Aug 19 14:17:38 2005 (3.1k) by dspizz [...] dspizz.com
</a>
</font></li>
</ul>


Class-Std.pm<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/140044/39087/Class-Std.pm">
Thu Aug 18 21:27:26 2005 (68.9k) by dspizz [...] dspizz.com
</a>
</font></li>
</ul>


Class-Std.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/140044/39086/Class-Std.t">
Thu Aug 18 21:27:26 2005 (2.3k) by dspizz [...] dspizz.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=14231">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-140044" href="/Public/Bug/Display.html?id=14231#txn-140044">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;18&nbsp;21:27:26&nbsp;2005</span>
    <span class="description">luke [...] daeron.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 18 Aug 2005 21:26:54 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Luke Meyer &lt;luke [...] daeron.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Class-Std [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> damian [...] conway.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch to add serialization to Class::Std</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/140044/39084/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/39084">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached is a patch that adds methods to Class::Std for Storable to 
freeze and thaw an inside-out class, as well as a few test cases and the 
full class code.

Discussion:

This also provides a side door for users to create inside-out objects 
without going through your constructors and accessors, which is 
unfortunate for those who really value encapsulation.  However, it&#39;s 
still just about impossible to fool with an object once it&#39;s been 
created.  Nevertheless, it might be a better approach to do one of:
1&#41; Make serializability optional somehow.
2&#41; Make the methods check that caller is &#39;Storable&#39; &#40;slim security, though&#41;
3&#41; Move serializing to a separate class Class::Std::Storable -- and then 
anything you want to be Storable has to be of this type, including base 
classes.  Sucks because it must either be forked code or a &#34;subclass&#34; 
that can parse and keep a copy of the attributes for the serialization.

Also, the serialization of course maintains the same caveat as for any 
other object: if it&#39;s not an object attribute, it won&#39;t get stored with 
the object, and you can&#39;t serialize an attribute that&#39;s a closure or 
otherwise not serializable.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/140044/39085/Class-Std-patch.txt">Download Class-Std-patch.txt</a><br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- /Library/Perl/5.8.6/Class/Std.pm	2005-08-07 00:19:22.000000000 -0400
+++ Class/Std.pm	2005-08-18 20:11:41.000000000 -0400
@@ -1,6 +1,6 @@
 package Class::Std;
 
-use version; $VERSION = qv&#40;&#39;0.0.4&#39;&#41;;
+use version; $VERSION = qv&#40;&#39;0.0.5&#39;&#41;;
 use strict;
 use warnings;
 use Carp;
@@ -19,6 +19,8 @@
     MODIFY_CODE_ATTRIBUTES
     AUTOLOAD
     _DUMP
+    STORABLE_freeze
+    STORABLE_thaw
 &#41;;
 
 sub import {
@@ -130,6 +132,49 @@
     return $dump;
 }
 
+sub STORABLE_freeze {
+    my&#40;$self, $cloning&#41; = @_;
+    #we&#39;ll ignore $cloning; it&#39;s not going to make sense to
+    #serialize and deserialize without &#34;cloning&#34;.
+    my $id = ID&#40;$self&#41;;
+    require Storable;
+    my $serialized = Storable::freeze&#40; \&#40;my $anon_scalar&#41; &#41;;
+
+    my %freeze; #stolen from _DUMP above
+    for my $package &#40;keys %attribute&#41; { 
+        my $attr_list_ref = $attribute{$package};
+        for my $attr_ref &#40; @{$attr_list_ref} &#41; {
+            next if !exists $attr_ref-&gt;{ref}{$id};
+            $freeze{$package}{$attr_ref-&gt;{name}} = $attr_ref-&gt;{ref}{$id};
+        }
+    }
+
+    return &#40;$serialized, \%freeze&#41;;
+}
+
+sub STORABLE_thaw {
+    my&#40;$self, $cloning, $serialized, $frozen_attr_ref&#41; = @_;
+    #we&#39;ll ignore $cloning; it&#39;s not going to make sense to
+    #serialize and deserialize without &#34;cloning&#34;.
+    #we can ignore $serialized too, as we know it&#39;s an anon_scalar.
+    my $id = ID&#40;$self&#41;;
+    while&#40; my &#40;$package, $pkg_attr_ref&#41; = each %$frozen_attr_ref &#41; {
+        my $attr_list_ref = $attribute{$package};
+        for my $attr_ref &#40; @{$attr_list_ref} &#41; {
+            next if !exists $pkg_attr_ref-&gt;{ $attr_ref-&gt;{name} };
+            $attr_ref-&gt;{ref}{$id}
+                = delete $pkg_attr_ref-&gt;{ $attr_ref-&gt;{name} };
+        }
+        if&#40; my @extra_keys = keys %$pkg_attr_ref &#41; {
+            #this is probably serious enough to throw an exception.
+            #however, TODO: it would be nice if the class could somehow
+            #indicate to ignore this problem.
+            croak &#34;unknown attribute&#40;s&#41; seen during deserialization&#34;
+                .&#34; for package $package: &#34; . join&#40;q{, }, @extra_keys&#41;;
+        }
+    }
+}
+
 my $STD_OVERLOADER
     = q{ package %%s;
          use overload &#40;
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/140044/39086/Class-Std.t">Download Class-Std.t</a><br />
<span class="downloadcontenttype">text/x-perl 2.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;

package TestClass;
use Class::Std;
{
    my %name_of :ATTR&#40; :get&lt;name&gt; :set&lt;name&gt; &#41;;
    my %flavor_of :ATTR&#40; :get&lt;flavor&gt; :set&lt;flavor&gt; &#41;;
}

package LinkedList;
use Class::Std;
{
    my %info_of :ATTR&#40; :get&lt;info&gt; :set&lt;info&gt; &#41;;
    my %next_node_for :ATTR&#40; :get&lt;next_node&gt; :set&lt;next_node&gt; &#41;;
}

package TestMISubClass;
use Class::Std;
use base qw&#40; TestClass LinkedList &#41;;
{
    my %ref_copy_for :ATTR&#40; :get&lt;ref_copy&gt; &#41;;
    sub set_next_node {
        my $self = shift;
        my $id = ident $self;
        die &#34;no param provided&#34; unless @_;
        my $next_node = shift;
        $ref_copy_for{$id} = $next_node;
        $self-&gt;SUPER::set_next_node&#40;$next_node&#41;;
        return;
    }
}

package main;
use Test::More tests =&gt; 24;
use Class::Std;
use Storable;
use Carp;

##########################################################
# very basic testing of a single object
my $object = TestClass-&gt;new;
$object-&gt;set_name&#40;&#34;Vanilla Bean&#34;&#41;;
$object-&gt;set_flavor&#40;&#34;vanilla&#34;&#41;;

my $clone = Storable::dclone&#40;$object&#41;;
is&#40; $clone-&gt;get_name, &#34;Vanilla Bean&#34;, &#34;properties successfully cloned&#34;&#41;;
is&#40; $clone-&gt;get_flavor, &#34;vanilla&#34;, &#34;properties successfully cloned&#34;&#41;;

##########################################################
# testing a nested structure
my $first_node = LinkedList-&gt;new;
$first_node-&gt;set_info&#40;1&#41;;
for my $i &#40;2..10&#41; {
    my $next_node = LinkedList-&gt;new;
    $next_node-&gt;set_info&#40;$i&#41;;
    $next_node-&gt;set_next_node&#40;$first_node&#41;;
    $first_node = $next_node;
}

my $id = ident&#40;$first_node&#41;;
$first_node = Storable::dclone&#40;$first_node&#41;;

isnt&#40;$id, ident&#40;$first_node&#41;, &#34;should in fact be a different object&#34;&#41;;
for my $i &#40;reverse 1..10&#41; {
    is&#40;$first_node-&gt;get_info, $i, &#34;values in the nodes all match&#34;&#41;;
    $first_node = $first_node-&gt;get_next_node;
}


##########################################################
# testing MI and structural integrity

my @flavors = qw&#40; vanilla chocolate strawberry mango peach grape &#41;;
my $obj;
for my $flavor &#40; @flavors &#41; {
    my $next = TestMISubClass-&gt;new;
    $next-&gt;set_flavor&#40;$flavor&#41;;
    $next-&gt;set_info&#40;$flavor&#41;;
    $next-&gt;set_next_node&#40;$obj&#41;;
    $obj = $next;
}

$clone = Storable::dclone&#40;$obj&#41;;
for my $flavor &#40; reverse @flavors &#41; {
    is&#40;$flavor, $clone-&gt;get_flavor, &#34;flavor cloned the same&#34;&#41;;
    my $next = $clone-&gt;get_next_node;
    my $copy = $clone-&gt;get_ref_copy;
    last unless $next;
    is&#40;ident&#40;$next&#41;, ident&#40;$copy&#41;, &#34;clone of same object should be the same&#34;&#41;;
    $clone = $next;
}
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/140044/39087/Class-Std.pm">Download Class-Std.pm</a><br />
<span class="downloadcontenttype">text/x-perl 68.9k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-140045" href="/Public/Bug/Display.html?id=14231#txn-140045">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;19&nbsp;11:22:36&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/140045/39100/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/39100">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 898b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This also provides a side door for users to create inside-out objects
&gt; without going through your constructors and accessors, which is
&gt; unfortunate for those who really value encapsulation.  However, it&#39;s
&gt; still just about impossible to fool with an object once it&#39;s been
&gt; created.
</div>
Silly me; of course this also opens the other side door to get the
object attributes in a handy little hash as well, and combined with the
first side door, pretty much lets you do whatever you want with the
attributes directly, if you&#39;re so inclined.

I can&#39;t at the moment think of a good way to put the shotgun &#40;for
keeping intruders out&#41; back in the hands of the class, other than maybe
marking individual attributes as serializable or not.  Perhaps the
cap-gun of &#34;check caller&#40;&#41;&#34; would be enough for some people.  In order
to get serialization, you&#39;re going to have to let an external class pry
somehow.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-140046" href="/Public/Bug/Display.html?id=14231#txn-140046">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;19&nbsp;14:17:38&nbsp;2005</span>
    <span class="description">luke [...] daeron.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 19 Aug 2005 14:17:27 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Luke Meyer &lt;luke [...] daeron.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Class-Std [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #14231] AutoReply: patch to add serialization to Class::Std</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/140046/39107/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/39107">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 446b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">So I went ahead and created a sister class Class::Std::Storable that 
allows the class to be serialized.  It doesn&#39;t suck as much as I 
thought.  Still, thinking about it, it wouldn&#39;t be hard to put this in 
Class::Std as an import option instead.

Also, there doesn&#39;t seem to be any way to restrict the serialization 
interface to Storable.  The rest of the world can also poke around in 
the class.

Attached are the class and some test cases.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/140046/39108/Class-Std-Storable.pm">Download Class-Std-Storable.pm</a><br />
<span class="downloadcontenttype">text/x-perl 5.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">package Class::Std::Storable;

use version; $VERSION = qv&#40;&#39;0.0.1&#39;&#41;;
use strict;
use warnings;
use Class::Std; #get subs from parent to export
use Carp;
use Scalar::Util;

use overload;

*ID = \&#38;Scalar::Util::refaddr;

my &#40;%attribute&#41;;

my @exported_subs = qw&#40;
    new
    ident
    DESTROY
    MODIFY_HASH_ATTRIBUTES
    MODIFY_CODE_ATTRIBUTES
    AUTOLOAD
    _DUMP
    STORABLE_freeze
    STORABLE_thaw
&#41;;

sub import {
    no strict &#39;refs&#39;;
    for my $sub &#40; @exported_subs &#41; {
        *{ caller&#40;&#41; . &#39;::&#39; . $sub } = \&#38;{$sub};
    }
}


*_extract_default  = Class::Std::_extractor_for_pair_named&#40;&#39;default&#39;&#41;;
*_extract_init_arg = Class::Std::_extractor_for_pair_named&#40;&#39;init_arg&#39;&#41;;
*_extract_get      = Class::Std::_extractor_for_pair_named&#40;&#39;get&#39;&#41;;
*_extract_set      = Class::Std::_extractor_for_pair_named&#40;&#39;set&#39;&#41;;

#NOTE: this subroutine should override the one that&#39;s imported
#by the &#34;use Class::Std&#34; above.
{
    my $old_sub = \&#38;MODIFY_HASH_ATTRIBUTES;
    my %positional_arg_of;
    my $new_sub = sub {
        my &#40;$package, $referent, @attrs&#41; = @_;
        my @return_attrs = $old_sub-&gt;&#40;@_&#41;;

        for my $attr &#40;@attrs&#41; {
            next if $attr !~ m/\A ATTRS? \s* &#40;?:[&#40;] &#40;.*&#41; [&#41;] &#41;? \z/xms;
            my &#40;$init_arg, $getter, $setter&#41;;
            #we would prefer to know the argument as the class does.
            if &#40;my $config = $1&#41; {
                $init_arg = _extract_init_arg&#40;$config&#41;;
                $getter = _extract_get&#40;$config&#41;;
                $setter = _extract_set&#40;$config&#41;;
            }
            #but we have a backup if no name was given.
            $positional_arg_of{$package} ||= &#34;__Positional_0001&#34;;
            push @{$attribute{$package}}, {
                ref      =&gt; $referent,
                name     =&gt; $init_arg || $getter || $setter
                            || $positional_arg_of{$package}++,
            };
        }
        return @return_attrs;
    };

    no warnings; #or this complains about redefining sub
    *MODIFY_HASH_ATTRIBUTES = $new_sub;
};

sub STORABLE_freeze {
    #croak &#34;must be called from Storable&#34; unless caller eq &#39;Storable&#39;;
    #unfortunately, Storable never appears on the call stack.
    my&#40;$self, $cloning&#41; = @_;
    #we&#39;ll ignore $cloning; it&#39;s not going to make sense to
    #serialize and deserialize without &#34;cloning&#34;.
    my $id = ID&#40;$self&#41;;
    require Storable;
    my $serialized = Storable::freeze&#40; \&#40;my $anon_scalar&#41; &#41;;

    my %frozen_attr;
    my @package_list = ref $self;
    my %package_seen;
    PACKAGE:
    while&#40; my $package = shift @package_list&#41; {
        #make sure we add any base classes to the list of
        #packages to examine for attributes.
        { no strict &#39;refs&#39;;
            for my $base_class &#40; @{&#34;${package}::ISA&#34;} &#41; {
                push @package_list, $base_class
                    if !$package_seen{$base_class}++;
            }
        }
        #don&#39;t examine attributes from unrelated packages
        next PACKAGE unless my $attr_list_ref = $attribute{$package};

        #look for any attributes of this object for this package
        for my $attr_ref &#40; @{$attr_list_ref} &#41; {
            next if !exists $attr_ref-&gt;{ref}{$id};
            $frozen_attr{$package}{$attr_ref-&gt;{name}} = $attr_ref-&gt;{ref}{$id};
        }
    }

    return &#40;$serialized, \%frozen_attr &#41;;
}

sub STORABLE_thaw {
    #croak &#34;must be called from Storable&#34; unless caller eq &#39;Storable&#39;;
    #unfortunately, Storable never appears on the call stack.
    my&#40;$self, $cloning, $serialized, $frozen_attr_ref&#41; = @_;
    #we&#39;ll ignore $cloning; it&#39;s not going to make sense to
    #serialize and deserialize without &#34;cloning&#34;.
    #we can ignore $serialized too, as we know it&#39;s an anon_scalar.
    my $id = ID&#40;$self&#41;;
    while&#40; my &#40;$package, $pkg_attr_ref&#41; = each %$frozen_attr_ref &#41; {
        my $attr_list_ref = $attribute{$package};
        for my $attr_ref &#40; @{$attr_list_ref} &#41; {
            next if !exists $pkg_attr_ref-&gt;{ $attr_ref-&gt;{name} };
            $attr_ref-&gt;{ref}{$id}
                = delete $pkg_attr_ref-&gt;{ $attr_ref-&gt;{name} };
        }
        if&#40; my @extra_keys = keys %$pkg_attr_ref &#41; {
            #this is probably serious enough to throw an exception.
            #however, TODO: it would be nice if the class could somehow
            #indicate to ignore this problem.
            croak &#34;unknown attribute&#40;s&#41; seen during deserialization&#34;
                .&#34; for package $package: &#34; . join&#40;q{, }, @extra_keys&#41;;
        }
    }
}

1; # Magic true value required at end of module
__END__

=head1 NAME

Class::Std::Storable - Support for creating serializable &#34;inside-out&#34; classes


=head1 VERSION

This document describes Class::Std::Storable version 0.0.1

=head2 SYNOPSIS

Use this exactly as you would Class::Std.  The only difference is that all
declared attributes of this class and any Class::Std::Storable superclasses
will be serialized with this object when frozen and thawed with Storable.

However, in order to let Storable save attributes and construct the object,
it is necessary to expose the attributes of the class to the world.  Thus,
any code could use the same interface that Storable does to access your
class&#39;s attributes directly.  It&#39;s not quite as easy as $object-&gt;{attribute}
but it won&#39;t stop anyone determined to do this.

As true encapsulation was one of the major features of Class::Std, this
would be a good reason NOT to use this class.  But this sacrifice is
necessary to provide serialization with an inside-out class.

=cut
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/140046/39109/Class-Std-Storable.t">Download Class-Std-Storable.t</a><br />
<span class="downloadcontenttype">text/x-perl 3.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;

package TestClass;
use Class::Std::Storable;
{
    my %name_of :ATTR&#40; :get&lt;name&gt; :set&lt;name&gt; &#41;;
    my %flavor_of :ATTR&#40; :get&lt;flavor&gt; :set&lt;flavor&gt; &#41;;
}

package LinkedList;
use Class::Std::Storable;
{
    my %info_of :ATTR&#40; :get&lt;info&gt; :set&lt;info&gt; &#41;;
    my %next_node_for :ATTR&#40; :get&lt;next_node&gt; :set&lt;next_node&gt; &#41;;
}

package TestMISubClass;
use Class::Std::Storable;
use base qw&#40; TestClass LinkedList &#41;;
{
    my %ref_copy_for :ATTR&#40; :get&lt;ref_copy&gt; &#41;;
    my %unknown1 :ATTR; #for testing with no attr name given
    my %unknown2 :ATTR; #for testing with no attr name given
    sub set_next_node {
        my $self = shift;
        my $id = ident $self;
        die &#34;no param provided&#34; unless @_;
        my $next_node = shift;
        $ref_copy_for{$id} = $next_node;
        $self-&gt;SUPER::set_next_node&#40;$next_node&#41;;
        return;
    }
    sub set_unknown1 {
        my $id = ident shift;
        $unknown1{$id} = shift;
    }
    sub get_unknown1 {
        return $unknown1{ident shift};
    }
    sub set_unknown2 {
        my $id = ident shift;
        $unknown2{$id} = shift;
    }
    sub get_unknown2 {
        return $unknown2{ident shift};
    }
}

package main;
use Test::More tests =&gt; 36;
use Class::Std::Storable;
use Storable;
use Carp;
use Data::Dumper;

##########################################################
# very basic testing of a single object
my $object = TestClass-&gt;new;
$object-&gt;set_name&#40;&#34;Vanilla Bean&#34;&#41;;
$object-&gt;set_flavor&#40;&#34;vanilla&#34;&#41;;

my $clone = Storable::dclone&#40;$object&#41;;
is&#40; $clone-&gt;get_name, &#34;Vanilla Bean&#34;, &#34;properties successfully cloned&#34;&#41;;
is&#40; $clone-&gt;get_flavor, &#34;vanilla&#34;, &#34;properties successfully cloned&#34;&#41;;

##########################################################
# testing a nested structure
my $first_node = LinkedList-&gt;new;
$first_node-&gt;set_info&#40;1&#41;;
for my $i &#40;2..10&#41; {
    my $next_node = LinkedList-&gt;new;
    $next_node-&gt;set_info&#40;$i&#41;;
    $next_node-&gt;set_next_node&#40;$first_node&#41;;
    $first_node = $next_node;
}

my $id = ident&#40;$first_node&#41;;
$first_node = Storable::dclone&#40;$first_node&#41;;

isnt&#40;$id, ident&#40;$first_node&#41;, &#34;should in fact be a different object&#34;&#41;;
for my $i &#40;reverse 1..10&#41; {
    is&#40;$first_node-&gt;get_info, $i, &#34;values in the nodes all match&#34;&#41;;
    $first_node = $first_node-&gt;get_next_node;
}


##########################################################
# testing MI and structural integrity

my @flavors = qw&#40; vanilla chocolate strawberry mango peach grape &#41;;
my $obj;
for my $flavor &#40; @flavors &#41; {
    my $next = TestMISubClass-&gt;new;
    $next-&gt;set_flavor&#40;$flavor&#41;;
    $next-&gt;set_info&#40;$flavor&#41;;
    $next-&gt;set_unknown1&#40;&#34;1_$flavor&#34;&#41;;
    $next-&gt;set_unknown2&#40;&#34;2_$flavor&#34;&#41;;
    $next-&gt;set_next_node&#40;$obj&#41;;
    $obj = $next;
}

$clone = Storable::freeze&#40;$obj&#41;;
undef $obj; #should destroy the whole list
$clone = Storable::thaw&#40;$clone&#41;;
for my $flavor &#40; reverse @flavors &#41; {
    is&#40;$flavor, $clone-&gt;get_flavor, &#34;flavor cloned the same&#34;&#41;;
    is&#40;&#34;1_$flavor&#34;, $clone-&gt;get_unknown1, &#34;unknown1 cloned the same&#34;&#41;;
    is&#40;&#34;2_$flavor&#34;, $clone-&gt;get_unknown2, &#34;unknown2 cloned the same&#34;&#41;;
    my $next = $clone-&gt;get_next_node;
    my $copy = $clone-&gt;get_ref_copy;
    last unless $next;
    is&#40;ident&#40;$next&#41;, ident&#40;$copy&#41;, &#34;clone of same object should be the same&#34;&#41;;
    $clone = $next;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-140047" href="/Public/Bug/Display.html?id=14231#txn-140047">#</a>      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;24&nbsp;17:42:46&nbsp;2005</span>
    <span class="description">damian [...] conway.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Aug 2005 07:42:20 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Damian Conway &lt;damian [...] conway.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Class-Std [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #14231] patch to add serialization to Class::Std</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/140047/39291/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/39291">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 830b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Luke,

You wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So I went ahead and created a sister class Class::Std::Storable that 
&gt; allows the class to be serialized.  It doesn&#39;t suck as much as I 
&gt; thought.  Still, thinking about it, it wouldn&#39;t be hard to put this in 
&gt; Class::Std as an import option instead.
&gt; 
&gt; Also, there doesn&#39;t seem to be any way to restrict the serialization 
&gt; interface to Storable.  The rest of the world can also poke around in 
&gt; the class.
</div>
For that reason, I&#39;d much rather see Class::Std::Storable remain a separate 
class, with a separate set of documented caveats &#40;and a separate maintainer ;-&#41;.

I really appreciate the effort you&#39;ve put in on this, Luke. I know several 
people have been asking about just this kind of facility, and I think your 
module will be seen as a very welcome addition to CPAN.

Thanks again,

Damian
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-439759" href="/Public/Bug/Display.html?id=14231#txn-439759">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;25&nbsp;23:22:20&nbsp;2008</span>
    <span class="description">dmuey [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.464407</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
