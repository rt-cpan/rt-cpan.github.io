<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #53525 for DBD-DB2: Segfault from setErrorFromDiagRecInfo</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #53525 for DBD-DB2: Segfault from setErrorFromDiagRecInfo</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-DB2/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-DB2/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-DB2/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-DB2/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-DB2">DBD-DB2 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">53525</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-DB2/Active/">DBD-DB2</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">opendev [...] us.ibm.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dave [...] awk.cz

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-10084-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.76    </td>
  </tr>
  <tr id="CF-10085-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;08&nbsp;16:04:31&nbsp;2010</span>
    <span class="description">dave [...] awk.cz -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Segfault from setErrorFromDiagRecInfo</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

I found a new bug causing segfaults when the DB2 query returns no rows.
Using DBI trace, I can see I&#39;m also getting a &#34;silent&#34; DB2 error during
prepare&#40;&#41; of my SQL statement. May be this issue is triggered by a
combination of these two, I don&#39;t know.

This is the segfault itself:

Program received signal SIGSEGV, Segmentation fault.
strlen &#40;&#41; at ../sysdeps/i386/i486/strlen.S:69
69      ../sysdeps/i386/i486/strlen.S: No such file or directory.
        in ../sysdeps/i386/i486/strlen.S
Current language:  auto
The current source language is &#34;auto; currently asm&#34;.
&#40;gdb&#41; bt
#0  strlen &#40;&#41; at ../sysdeps/i386/i486/strlen.S:69
#1  0xb7cab776 in set_err_char &#40;h=0x8354918, imp_xxh=0x84397f8,
err_c=0xb7c76e47 &#34;&#34;, err_i=100, errstr=0x0, state=0xbfffec3e &#34;00000&#34;,
method=0x0&#41; at DBI.xs:604
#2  0xb7c6c4ea in setErrorFromDiagRecInfo &#40;perlHandle=&lt;value optimized
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">out&gt;, handleType=&lt;value optimized out&gt;, handle=65537, err=0xb7c76e47 &#34;&#34;&#41;
</div>at dbdimp.c:112
#3  0xb7c6c693 in diagnoseError &#40;perlHandle=0x8354918, handleType=9376,
handle=65537, rc=100, what=0xb7c76dd8 &#34;Fetch Failed&#34;&#41; at dbdimp.c:54
#4  0xb7c72ee7 in db2_st_fetch &#40;sth=0x8354918, imp_sth=0x84397f8&#41; at
dbdimp.c:2539
#5  0xb7c67cc7 in XS_DBD__DB2__st_fetchrow_arrayref &#40;my_perl=0x8188008,
cv=0x8291950&#41; at DB2.xs:399
#6  0xb7cb9299 in XS_DBI_dispatch &#40;my_perl=0x8188008, cv=0x8326040&#41; at
DBI.xs:3292
#7  0x080b12c0 in Perl_pp_entersub &#40;&#41;
#8  0x080af688 in Perl_runops_standard &#40;&#41;
#9  0x080adbb2 in perl_run &#40;&#41;
#10 0x08063ffd in main &#40;&#41;

And this is what is reported in DBI trace log:

    DBI::db=HASH&#40;0x8ad1960&#41; trace level set to 0x0/1 &#40;DBI @ 0x0/0&#41; in
DBI 1.609-ithread &#40;pid 5042&#41;
DB2: 2009-11-20-06.00.00 - 2009-11-21-06.00.00
    !! ERROR: &#39;-99999&#39; &#39;[IBM][CLI Driver] CLI0137E  Information type out
of range. SQLSTATE=HY096&#39; &#40;err#1&#41;
    &lt;- prepare_cached&#40;&#39; 
        SELECT
                count&#40;RPT.ACC_BODYHIST.KANR&#41; count
        FROM
                RPT.ACC_BODYHIST
        WHERE
                RPT.ACC_BODYHIST.STATUS0 = ?
                AND RPT.ACC_BODYHIST.MDATUMZEIT &gt;= TIMESTAMP&#40; CAST&#40;? AS TIMESTAMP&#41; &#41;
                AND RPT.ACC_BODYHIST.MDATUMZEIT &lt; TIMESTAMP&#40; CAST&#40;? AS TIMESTAMP&#41; &#41;
        GROUP BY
                RPT.ACC_BODYHIST.STATUS0;
&#39;&#41;= DBI::st=HASH&#40;0x8ad1c90&#41; at count line 145
    !! ERROR: &#39;-99999&#39; CLEARED by call to execute method
    &lt;- execute&#40;&#39;Z100&#39;, &#39;2009-11-20-06.00.00&#39;, ...&#41;= -1 at count line 159
Segmentation fault

The weird thing is that the prepare is actually OK and subsequent
SELECTs with actual result rows are OK. I only trigger the segfault when
there are no rows returned. I couldn&#39;t find much about CLI0137E and
whatever I do with my statement, it doesn&#39;t go away.

I have just installed a new DB2 administration client version, but I
haven&#39;t tried this perl app with previous version. This client is the
latest version available in the IBM Software Access Catalog and is much
newer than my previous one:

DB21085I  Instance &#34;dave&#34; uses &#34;32&#34; bits and DB2 code release &#34;SQL08010&#34;
with 
level identifier &#34;01010106&#34;.
Informational tokens are &#34;DB2 v8.1.0.0&#34;, &#34;s021023&#34;, &#34;&#34;, and FixPak &#34;0&#34;.
Product is installed at &#34;/opt/IBM/db2/V8.1&#34;.

DBI is 1.609-1 &#40;Ubuntu&#41;
DBD::DB2 is 1.76 &#40;CPAN&#41;

Anyway, I found the issue and fixed it. I&#39;m attaching a patch for
dbdimp.c. You can see that setErrorFromDiagRecInfo&#40;&#41; initializes var
&#34;message&#34; with NULL. In an obvious case, this value is not updated and
is passed to DBI&#39;s set_err_char&#40;&#41; as &#34;errstr&#34;, which is then duplicated
and strlen&#40;&#41;&#39;d without any checking.

I think DBI should sanitize its parameters, but DBD::DB2 also shouldn&#39;t
pass NULLs around unnecessarily. :&#41; After initializing message = &#34;&#34;, the
segfault disappears and my code is working again.

I&#39;d be very much interested in what &#34;CLI0137E  Information type out of
range. SQLSTATE=HY096&#34; means and why the statement works fine despite
it. Here&#39;s the same DBD::DB2 call sequence, but with the highest
DB2_TRACE. You won&#39;t get segfault this way, because when
DBIc_TRACE_LEVEL &gt;= 3, the switch statement in setErrorFromDiagRecInfo&#40;&#41;
updates &#34;message&#34; itself:

    DBI::db=HASH&#40;0x94f9600&#41; trace level set to 0x0/5 &#40;DBI @ 0x0/0&#41; in
DBI 1.609-ithread &#40;pid 10458&#41;
DB2: 2009-11-20-06.00.00 - 2009-11-21-06.00.00
    -&gt; prepare for DBD::DB2::db &#40;DBI::db=HASH&#40;0x94f9690&#41;~0x94f9600 &#39;    
        SELECT
                count&#40;RPT.ACC_BODYHIST.KANR&#41; count
        FROM
                RPT.ACC_BODYHIST
        WHERE
                RPT.ACC_BODYHIST.STATUS0 = ?
                AND RPT.ACC_BODYHIST.MDATUMZEIT &gt;= TIMESTAMP&#40; CAST&#40;? AS TIMESTAMP&#41; &#41;
                AND RPT.ACC_BODYHIST.MDATUMZEIT &lt; TIMESTAMP&#40; CAST&#40;? AS TIMESTAMP&#41; &#41;
        GROUP BY
                RPT.ACC_BODYHIST.STATUS0;
&#39;&#41; thr#932d008
    New &#39;DBI::st&#39; &#40;for DBD::DB2::st, parent=DBI::db=HASH&#40;0x94f9600&#41;,
id=undef&#41;
    dbih_setup_handle&#40;DBI::st=HASH&#40;0x94f9930&#41;=&gt;DBI::st=HASH&#40;0x94f98d0&#41;,
DBD::DB2::st, 9477790, Null!&#41;
    dbih_make_com&#40;DBI::db=HASH&#40;0x94f9600&#41;, 93542f8, DBD::DB2::st, 160,
0&#41; thr#932d008
    dbih_setup_attrib&#40;DBI::st=HASH&#40;0x94f98d0&#41;, Err,
DBI::db=HASH&#40;0x94f9600&#41;&#41; SCALAR&#40;0x94776b0&#41; &#40;already defined&#41;
    dbih_setup_attrib&#40;DBI::st=HASH&#40;0x94f98d0&#41;, State,
DBI::db=HASH&#40;0x94f9600&#41;&#41; SCALAR&#40;0x9477730&#41; &#40;already defined&#41;
    dbih_setup_attrib&#40;DBI::st=HASH&#40;0x94f98d0&#41;, Errstr,
DBI::db=HASH&#40;0x94f9600&#41;&#41; SCALAR&#40;0x94776f0&#41; &#40;already defined&#41;
    dbih_setup_attrib&#40;DBI::st=HASH&#40;0x94f98d0&#41;, TraceLevel,
DBI::db=HASH&#40;0x94f9600&#41;&#41; 5 &#40;already defined&#41;
    dbih_setup_attrib&#40;DBI::st=HASH&#40;0x94f98d0&#41;, FetchHashKeyName,
DBI::db=HASH&#40;0x94f9600&#41;&#41; &#39;NAME&#39; &#40;already defined&#41;
    dbih_setup_attrib&#40;DBI::st=HASH&#40;0x94f98d0&#41;, HandleSetErr,
DBI::db=HASH&#40;0x94f9600&#41;&#41; undef &#40;not defined&#41;
    dbih_setup_attrib&#40;DBI::st=HASH&#40;0x94f98d0&#41;, HandleError,
DBI::db=HASH&#40;0x94f9600&#41;&#41; undef &#40;not defined&#41;
    dbih_setup_attrib&#40;DBI::st=HASH&#40;0x94f98d0&#41;, ReadOnly,
DBI::db=HASH&#40;0x94f9600&#41;&#41; undef &#40;not defined&#41;
    dbih_setup_attrib&#40;DBI::st=HASH&#40;0x94f98d0&#41;, Profile,
DBI::db=HASH&#40;0x94f9600&#41;&#41; undef &#40;not defined&#41;
    dbd_st_prepare&#39;d sql f65537
                
        SELECT
                count&#40;RPT.ACC_BODYHIST.KANR&#41; count
        FROM
                RPT.ACC_BODYHIST
        WHERE
                RPT.ACC_BODYHIST.STATUS0 = ?
                AND RPT.ACC_BODYHIST.MDATUMZEIT &gt;= TIMESTAMP&#40; CAST&#40;? AS TIMESTAMP&#41; &#41;
                AND RPT.ACC_BODYHIST.MDATUMZEIT &lt; TIMESTAMP&#40; CAST&#40;? AS TIMESTAMP&#41; &#41;
        GROUP BY
                RPT.ACC_BODYHIST.STATUS0;

statement =     
        SELECT
                count&#40;RPT.ACC_BODYHIST.KANR&#41; count
        FROM
                RPT.ACC_BODYHIST
        WHERE
                RPT.ACC_BODYHIST.STATUS0 = ?
                AND RPT.ACC_BODYHIST.MDATUMZEIT &gt;= TIMESTAMP&#40; CAST&#40;? AS TIMESTAMP&#41; &#41;
                AND RPT.ACC_BODYHIST.MDATUMZEIT &lt; TIMESTAMP&#40; CAST&#40;? AS TIMESTAMP&#41; &#41;
        GROUP BY
                RPT.ACC_BODYHIST.STATUS0;

imp_sth-&gt;statement=     
        SELECT
                count&#40;RPT.ACC_BODYHIST.KANR&#41; count
        FROM
                RPT.ACC_BODYHIST
        WHERE
                RPT.ACC_BODYHIST.STATUS0 = :p1
                AND RPT.ACC_BODYHIST.MDATUMZEIT &gt;= TIMESTAMP&#40; CAST&#40;:p2 AS TIMESTAMP&#41; &#41;
                AND RPT.ACC_BODYHIST.MDATUMZEIT &lt; TIMESTAMP&#40; CAST&#40;:p3 AS TIMESTAMP&#41; &#41;
        GROUP BY
                RPT.ACC_BODYHIST.STATUS0;

scanned 3 distinct placeholders
fbh 0: &#39;COUNT&#39; , type 4,  11, dsize 10, p0 s154487488
   out: ftype 1, indp 0, bufl 45, rlen 45
    !! ERROR: &#39;-99999&#39; &#39;[IBM][CLI Driver] CLI0137E  Information type out
of range. SQLSTATE=HY096&#39; &#40;err#0&#41;
    &lt;- prepare= DBI::st=HASH&#40;0x94f9930&#41; at ./count line 147 via  at
./count line 36
    !! ERROR: &#39;-99999&#39; CLEARED by call to execute method
    -&gt; execute for DBD::DB2::st &#40;DBI::st=HASH&#40;0x94f9930&#41;~0x94f98d0
&#39;Z100&#39; &#39;2009-11-20-06.00.00&#39; &#39;2009-11-21-06.00.00&#39;&#41; thr#932d008
bind :p1 &lt;== &#39;Z100&#39; &#40;attribs: &lt;no attribs&gt;&#41;
  bind :p1: db2_param_type=1, db2_c_type=1, db2_type=1, PRECISION=0,
SCALE=0, Maxlen=0, Described
bind :p2 &lt;== &#39;2009-11-20-06.00.00&#39; &#40;attribs: &lt;no attribs&gt;&#41;
  bind :p2: db2_param_type=1, db2_c_type=1, db2_type=93, PRECISION=0,
SCALE=6, Maxlen=0, Described
bind :p3 &lt;== &#39;2009-11-21-06.00.00&#39; &#40;attribs: &lt;no attribs&gt;&#41;
  bind :p3: db2_param_type=1, db2_c_type=1, db2_type=93, PRECISION=0,
SCALE=6, Maxlen=0, Described
    &lt;- execute= -1 at ./count line 161 via  at ./count line 36
    -&gt; fetchrow_arrayref for DBD::DB2::st
&#40;DBI::st=HASH&#40;0x94f9930&#41;~0x94f98d0&#41; thr#932d008
    !! info: &#39;&#39; &#39;SQL_NO_DATA returned from Diagnostic Information. There
might be no diagnostic records for this handle. Please see Infocentre
for more details!!&#39; &#40;err#2&#41;
    &lt;- fetchrow_arrayref= undef row-1 at ./count line 163 via  at
./count line 36
    !! info: &#39;&#39; CLEARED by call to finish method
    -&gt; finish for DBD::DB2::st &#40;DBI::st=HASH&#40;0x94f9930&#41;~0x94f98d0&#41;
thr#932d008
    &lt;- finish= 1 at ./count line 165 via  at ./count line 36
    -&gt; DESTROY for DBD::DB2::st &#40;DBI::st=HASH&#40;0x94f98d0&#41;~INNER&#41; thr#932d008
    &lt;- DESTROY= undef at ./count line 36 via  at ./count line 36
    -&gt; trace for DBD::DB2::db &#40;DBI::db=HASH&#40;0x94f9690&#41;~0x94f9600 0&#41;
thr#932d008
    &lt;- trace= 5 at ./count line 37

I don&#39;t know what could have changed in DBI or IBM DB2, but such an
error would have been fixed long time ago. Empty result is a frequent
occurrence, this must be something new. Please, keep me up-to-date and
let me know if you need something or discover something.


David
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dbd-db2-1.76-segv.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ru DBD-DB2-1.76/dbdimp.c DBD-DB2-1.76-EAbIPE/dbdimp.c
--- DBD-DB2-1.76/dbdimp.c	2009-11-28 10:07:57.000000000 +0100
+++ DBD-DB2-1.76-EAbIPE/dbdimp.c	2010-01-08 21:42:34.594365191 +0100
@@ -93,6 +93,7 @@
 		message = msgBuffer;
 	} else {
 		err = &#34;&#34;;
+		message = &#34;&#34;;
 		sqlcode = returnCode;
 		strcpy&#40; &#40;char*&#41;sqlstate, &#34;00000&#34; &#41;;
 		if&#40;DBIc_TRACE_LEVEL&#40;imp_xxh&#41; &gt;= 3&#41;{
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;08&nbsp;16:08:03&nbsp;2010</span>
    <span class="description">dave [...] awk.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dave [...] awk.cz</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Debug outputs attached to preserve formatting.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dbd-segv.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Program received signal SIGSEGV, Segmentation fault.
strlen &#40;&#41; at ../sysdeps/i386/i486/strlen.S:69
69	../sysdeps/i386/i486/strlen.S: No such file or directory.
	in ../sysdeps/i386/i486/strlen.S
Current language:  auto
The current source language is &#34;auto; currently asm&#34;.
&#40;gdb&#41; bt
#0  strlen &#40;&#41; at ../sysdeps/i386/i486/strlen.S:69
#1  0xb7cab776 in set_err_char &#40;h=0x8354918, imp_xxh=0x84397f8, err_c=0xb7c76e47 &#34;&#34;, err_i=100, errstr=0x0, state=0xbfffec3e &#34;00000&#34;, method=0x0&#41; at DBI.xs:604
#2  0xb7c6c4ea in setErrorFromDiagRecInfo &#40;perlHandle=&lt;value optimized out&gt;, handleType=&lt;value optimized out&gt;, handle=65537, err=0xb7c76e47 &#34;&#34;&#41; at dbdimp.c:112
#3  0xb7c6c693 in diagnoseError &#40;perlHandle=0x8354918, handleType=9376, handle=65537, rc=100, what=0xb7c76dd8 &#34;Fetch Failed&#34;&#41; at dbdimp.c:54
#4  0xb7c72ee7 in db2_st_fetch &#40;sth=0x8354918, imp_sth=0x84397f8&#41; at dbdimp.c:2539
#5  0xb7c67cc7 in XS_DBD__DB2__st_fetchrow_arrayref &#40;my_perl=0x8188008, cv=0x8291950&#41; at DB2.xs:399
#6  0xb7cb9299 in XS_DBI_dispatch &#40;my_perl=0x8188008, cv=0x8326040&#41; at DBI.xs:3292
#7  0x080b12c0 in Perl_pp_entersub &#40;&#41;
#8  0x080af688 in Perl_runops_standard &#40;&#41;
#9  0x080adbb2 in perl_run &#40;&#41;
#10 0x08063ffd in main &#40;&#41;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dbd-trace.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">    DBI::db=HASH&#40;0x94f9600&#41; trace level set to 0x0/5 &#40;DBI @ 0x0/0&#41; in DBI 1.609-ithread &#40;pid 10458&#41;
DB2: 2009-11-20-06.00.00 - 2009-11-21-06.00.00
    -&gt; prepare for DBD::DB2::db &#40;DBI::db=HASH&#40;0x94f9690&#41;~0x94f9600 &#39;	
	SELECT
		count&#40;RPT.ACC_BODYHIST.KANR&#41; count
	FROM
		RPT.ACC_BODYHIST
	WHERE
		RPT.ACC_BODYHIST.STATUS0 = ?
		AND RPT.ACC_BODYHIST.MDATUMZEIT &gt;= TIMESTAMP&#40; CAST&#40;? AS TIMESTAMP&#41; &#41;
		AND RPT.ACC_BODYHIST.MDATUMZEIT &lt; TIMESTAMP&#40; CAST&#40;? AS TIMESTAMP&#41; &#41;
	GROUP BY
		RPT.ACC_BODYHIST.STATUS0;
&#39;&#41; thr#932d008
    New &#39;DBI::st&#39; &#40;for DBD::DB2::st, parent=DBI::db=HASH&#40;0x94f9600&#41;, id=undef&#41;
    dbih_setup_handle&#40;DBI::st=HASH&#40;0x94f9930&#41;=&gt;DBI::st=HASH&#40;0x94f98d0&#41;, DBD::DB2::st, 9477790, Null!&#41;
    dbih_make_com&#40;DBI::db=HASH&#40;0x94f9600&#41;, 93542f8, DBD::DB2::st, 160, 0&#41; thr#932d008
    dbih_setup_attrib&#40;DBI::st=HASH&#40;0x94f98d0&#41;, Err, DBI::db=HASH&#40;0x94f9600&#41;&#41; SCALAR&#40;0x94776b0&#41; &#40;already defined&#41;
    dbih_setup_attrib&#40;DBI::st=HASH&#40;0x94f98d0&#41;, State, DBI::db=HASH&#40;0x94f9600&#41;&#41; SCALAR&#40;0x9477730&#41; &#40;already defined&#41;
    dbih_setup_attrib&#40;DBI::st=HASH&#40;0x94f98d0&#41;, Errstr, DBI::db=HASH&#40;0x94f9600&#41;&#41; SCALAR&#40;0x94776f0&#41; &#40;already defined&#41;
    dbih_setup_attrib&#40;DBI::st=HASH&#40;0x94f98d0&#41;, TraceLevel, DBI::db=HASH&#40;0x94f9600&#41;&#41; 5 &#40;already defined&#41;
    dbih_setup_attrib&#40;DBI::st=HASH&#40;0x94f98d0&#41;, FetchHashKeyName, DBI::db=HASH&#40;0x94f9600&#41;&#41; &#39;NAME&#39; &#40;already defined&#41;
    dbih_setup_attrib&#40;DBI::st=HASH&#40;0x94f98d0&#41;, HandleSetErr, DBI::db=HASH&#40;0x94f9600&#41;&#41; undef &#40;not defined&#41;
    dbih_setup_attrib&#40;DBI::st=HASH&#40;0x94f98d0&#41;, HandleError, DBI::db=HASH&#40;0x94f9600&#41;&#41; undef &#40;not defined&#41;
    dbih_setup_attrib&#40;DBI::st=HASH&#40;0x94f98d0&#41;, ReadOnly, DBI::db=HASH&#40;0x94f9600&#41;&#41; undef &#40;not defined&#41;
    dbih_setup_attrib&#40;DBI::st=HASH&#40;0x94f98d0&#41;, Profile, DBI::db=HASH&#40;0x94f9600&#41;&#41; undef &#40;not defined&#41;
    dbd_st_prepare&#39;d sql f65537
		
	SELECT
		count&#40;RPT.ACC_BODYHIST.KANR&#41; count
	FROM
		RPT.ACC_BODYHIST
	WHERE
		RPT.ACC_BODYHIST.STATUS0 = ?
		AND RPT.ACC_BODYHIST.MDATUMZEIT &gt;= TIMESTAMP&#40; CAST&#40;? AS TIMESTAMP&#41; &#41;
		AND RPT.ACC_BODYHIST.MDATUMZEIT &lt; TIMESTAMP&#40; CAST&#40;? AS TIMESTAMP&#41; &#41;
	GROUP BY
		RPT.ACC_BODYHIST.STATUS0;

statement = 	
	SELECT
		count&#40;RPT.ACC_BODYHIST.KANR&#41; count
	FROM
		RPT.ACC_BODYHIST
	WHERE
		RPT.ACC_BODYHIST.STATUS0 = ?
		AND RPT.ACC_BODYHIST.MDATUMZEIT &gt;= TIMESTAMP&#40; CAST&#40;? AS TIMESTAMP&#41; &#41;
		AND RPT.ACC_BODYHIST.MDATUMZEIT &lt; TIMESTAMP&#40; CAST&#40;? AS TIMESTAMP&#41; &#41;
	GROUP BY
		RPT.ACC_BODYHIST.STATUS0;

imp_sth-&gt;statement=	
	SELECT
		count&#40;RPT.ACC_BODYHIST.KANR&#41; count
	FROM
		RPT.ACC_BODYHIST
	WHERE
		RPT.ACC_BODYHIST.STATUS0 = :p1
		AND RPT.ACC_BODYHIST.MDATUMZEIT &gt;= TIMESTAMP&#40; CAST&#40;:p2 AS TIMESTAMP&#41; &#41;
		AND RPT.ACC_BODYHIST.MDATUMZEIT &lt; TIMESTAMP&#40; CAST&#40;:p3 AS TIMESTAMP&#41; &#41;
	GROUP BY
		RPT.ACC_BODYHIST.STATUS0;

scanned 3 distinct placeholders
fbh 0: &#39;COUNT&#39; , type 4,  11, dsize 10, p0 s154487488
   out: ftype 1, indp 0, bufl 45, rlen 45
    !! ERROR: &#39;-99999&#39; &#39;[IBM][CLI Driver] CLI0137E  Information type out of range. SQLSTATE=HY096&#39; &#40;err#0&#41;
    &lt;- prepare= DBI::st=HASH&#40;0x94f9930&#41; at ./count line 147 via  at ./count line 36
    !! ERROR: &#39;-99999&#39; CLEARED by call to execute method
    -&gt; execute for DBD::DB2::st &#40;DBI::st=HASH&#40;0x94f9930&#41;~0x94f98d0 &#39;Z100&#39; &#39;2009-11-20-06.00.00&#39; &#39;2009-11-21-06.00.00&#39;&#41; thr#932d008
bind :p1 &lt;== &#39;Z100&#39; &#40;attribs: &lt;no attribs&gt;&#41;
  bind :p1: db2_param_type=1, db2_c_type=1, db2_type=1, PRECISION=0, SCALE=0, Maxlen=0, Described
bind :p2 &lt;== &#39;2009-11-20-06.00.00&#39; &#40;attribs: &lt;no attribs&gt;&#41;
  bind :p2: db2_param_type=1, db2_c_type=1, db2_type=93, PRECISION=0, SCALE=6, Maxlen=0, Described
bind :p3 &lt;== &#39;2009-11-21-06.00.00&#39; &#40;attribs: &lt;no attribs&gt;&#41;
  bind :p3: db2_param_type=1, db2_c_type=1, db2_type=93, PRECISION=0, SCALE=6, Maxlen=0, Described
    &lt;- execute= -1 at ./count line 161 via  at ./count line 36
    -&gt; fetchrow_arrayref for DBD::DB2::st &#40;DBI::st=HASH&#40;0x94f9930&#41;~0x94f98d0&#41; thr#932d008
    !! info: &#39;&#39; &#39;SQL_NO_DATA returned from Diagnostic Information. There might be no diagnostic records for this handle. Please see Infocentre for more details!!&#39; &#40;err#2&#41;
    &lt;- fetchrow_arrayref= undef row-1 at ./count line 163 via  at ./count line 36
    !! info: &#39;&#39; CLEARED by call to finish method
    -&gt; finish for DBD::DB2::st &#40;DBI::st=HASH&#40;0x94f9930&#41;~0x94f98d0&#41; thr#932d008
    &lt;- finish= 1 at ./count line 165 via  at ./count line 36
    -&gt; DESTROY for DBD::DB2::st &#40;DBI::st=HASH&#40;0x94f98d0&#41;~INNER&#41; thr#932d008
    &lt;- DESTROY= undef at ./count line 36 via  at ./count line 36
    -&gt; trace for DBD::DB2::db &#40;DBI::db=HASH&#40;0x94f9690&#41;~0x94f9600 0&#41; thr#932d008
    &lt;- trace= 5 at ./count line 37
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;12&nbsp;01:50:53&nbsp;2010</span>
    <span class="description">opendev [...] us.ibm.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi David,

 Thanks for reporting this error. Will fix this error of passing null to
DBI&#39;s SET_ERR_CHAR in the next release of the driver.

 Coming to error CLI0137E, if you could provide us with CLI trace when
the application is run we will be able to tell more on it. To Obtain the
CLI trace follow the link below
<span class="clickylink"><a target="new" rel="nofollow" href="http://publib.boulder.ibm.com/infocenter/db2luw/v9r5/topic/com.ibm.db2.luw.admin.trb.doc/doc/c0020795.html">http://publib.boulder.ibm.com/infocenter/db2luw/v9r5/topic/com.ibm.db2.luw.admin.trb.doc/doc/c0020795.html</a></span>


 One more thing, you will need to update your DB2 client to minimum DB2
V8fp16 or v91fp2, as these are the minimum supported versions of DB2
client for DBD-DB2 perl driver.

-- 
Thanks
Praveen
IBM OpenSource Application Development Team
India Software Labs, Bangalore &#40;India&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;12&nbsp;01:50:55&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;12&nbsp;01:51:36&nbsp;2010</span>
    <span class="description">opendev [...] us.ibm.com -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;12&nbsp;05:30:29&nbsp;2010</span>
    <span class="description">dave [...] awk.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dave [...] awk.cz</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ok, thank you for taking care of this. Here&#39;s a CLI trace too. :&#41;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 26246.txt</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;12&nbsp;05:45:26&nbsp;2010</span>
    <span class="description">dave [...] awk.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dave [...] awk.cz</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Adding a detailed table description if you&#39;ll need to compare the data
type params.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> table.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Column                         Type                                                                                        Column     Partitioning key    Code
name                           schema                          Type name                       Length    Scale    Nulls    number     sequence            page     Default
------------------------------ ------------------------------- ------------------------------- --------- -------- -------- ---------- ------------------- -------- ----------------------------------------
WERK                           SYSIBM                          C                     2        0 No                0                   0      819
SPJ                            SYSIBM                          C                     4        0 No                1                   0      819
KANR                           SYSIBM                          C                     7        0 No                2                   0      819
MDATUMZEIT                     SYSIBM                          T                    10        0 No                3                   0        0
WERK0                          SYSIBM                          C                     2        0 No                4                   0      819
STATUS0                        SYSIBM                          C                     4        0 No                5                   0      819
WERK1                          SYSIBM                          C                     2        0 Yes               6                   0      819
SPJ1                           SYSIBM                          C                     4        0 Yes               7                   0      819
KNR1                           SYSIBM                          C                     7        0 Yes               8                   0      819
MART                           SYSIBM                          C                     1        0 No                9                   0      819 &#39; &#39;
EINDATUMZEIT                   SYSIBM                          T                    10        0 No               10                   0        0 CURRENT TIMESTAMP
SCHKZ                          SYSIBM                          C                     1        0 No               11                   0      819 &#39; &#39;
LFDNR                          SYSIBM                          S                     2        0 No               12                   0        0 0
NRGES                          SYSIBM                          C                     6        0 No               13                   0      819 &#39; &#39;
UMSCHL                         SYSIBM                          C                     1        0 No               14                   0      819 &#39; &#39;
INFASV                         SYSIBM                          C                     2        0 No               15                   0      819 &#39; &#39;
WERK2                          SYSIBM                          C                     2        0 No               16                   0      819
FANLAGE2                       SYSIBM                          C                     6        0 No               17                   0      819
WERK3                          SYSIBM                          C                     2        0 No               18                   0      819
ANLBGR3                        SYSIBM                          C                     4        0 No               19                   0      819
GERAETENAME3                   SYSIBM                          C                     8        0 No               20                   0      819
GUELTIG                        SYSIBM                          C                     1        0 No               21                   0      819 &#39; &#39;
VERSCHROTTZ                    SYSIBM                          I                     4        0 No               22                   0        0 0
STATUSDURCHLAUF                SYSIBM                          I                     4        0 Yes              23                   0        0
STATUSDURCHLAUF_ENDTS          SYSIBM                          T                    10        0 Yes              24                   0        0
MDZ_CALC                       SYSIBM                          C                     1        0 No               25                   0      819 &#39;N&#39;
USER_ID                        SYSIBM                          C                    20        0 Yes              26                   0      819
SHIFT_ID_STATUS                SYSIBM                          I                     4        0 Yes              27                   0        0
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;12&nbsp;07:03:10&nbsp;2010</span>
    <span class="description">opendev [...] us.ibm.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi David,

Thanks for the traces. They were handy. As mentioned earlier, you will
need to upgrade to the minimum required DB2 client level. The error you
are seeing is due to a lower version of the DB2 client.

Could you upgrade to the minimum required level&#40;v8fp16 or v91fp2&#41; of DB2
client and let me know how it goes and also if possible provide me with
the cli trace for the run with the new upgraded client.

-- 
Thanks
Praveen
IBM OpenSource Application Development Team
India Software Labs, Bangalore &#40;India&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;27&nbsp;23:24:07&nbsp;2010</span>
    <span class="description">opendev [...] us.ibm.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi David,

The issue is been fixed and is available in the new release 1.78
<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/CPAN/authors/id/I/IB/IBMTORDB2/DBD-DB2-1.78.tar.gz">http://search.cpan.org/CPAN/authors/id/I/IB/IBMTORDB2/DBD-DB2-1.78.tar.gz</a></span>

-- 
Thanks
Praveen
IBM OpenSource Application Development Team
India Software Labs, Bangalore &#40;India&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;27&nbsp;23:24:07&nbsp;2010</span>
    <span class="description">opendev [...] us.ibm.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
