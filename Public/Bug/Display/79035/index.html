<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #79035 for DBD-Pg: segfault in pg_st_split_statement under OpenBSD - over reads statement</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #79035 for DBD-Pg: segfault in pg_st_split_statement under OpenBSD - over reads statement</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-Pg/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-Pg/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-Pg/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-Pg/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-Pg">DBD-Pg CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">79035</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-Pg/Active/">DBD-Pg</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">greg [...] turnstep.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
andrew [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10200-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
2.18.0</li>
<li>
2.19.2</li>
</ul>
    </td>
  </tr>
  <tr id="CF-10201-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.19.3    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




DBD-Pg-segfault-fix-chat-log.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1110638/583995/DBD-Pg-segfault-fix-chat-log.txt">
Sat Aug 18 02:11:32 2012 (9k) by andrew [...] cpan.org
</a>
</font></li>
</ul>


patch-dbdimp_c<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1110638/583993/patch-dbdimp_c">
Sat Aug 18 02:11:32 2012 (523b) by andrew [...] cpan.org
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1110079/583696/patch-dbdimp_c">
Fri Aug 17 00:54:30 2012 (1012b) by andrew [...] cpan.org
</a>
</font></li>
</ul>


patch-t_segfault_t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1110079/583697/patch-t_segfault_t">
Fri Aug 17 00:54:30 2012 (522b) by andrew [...] cpan.org
</a>
</font></li>
</ul>


segfault.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1110638/583994/segfault.t">
Sat Aug 18 02:11:32 2012 (363b) by andrew [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;17&nbsp;00:54:30&nbsp;2012</span>
    <span class="description">andrew [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> segfault in pg_st_split_statement under OpenBSD - over reads
 statement</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This test reproduces the problem, it segfaults in different places 
depending on how memory was allocated, generally right at 511, 1023 or 
2047 bytes of SQL statement.  

The patch covers it up, but is not a good fix.  I can provide ssh access 
to a machine for testing on if you need.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch-dbdimp_c</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1110079/583696/patch-dbdimp_c">Download patch-dbdimp_c</a><br />
<span class="downloadcontenttype">application/octet-stream 1012b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch-t_segfault_t</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1110079/583697/patch-t_segfault_t">Download patch-t_segfault_t</a><br />
<span class="downloadcontenttype">application/octet-stream 522b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;17&nbsp;00:55:28&nbsp;2012</span>
    <span class="description">andrew [...] cpan.org -  Broken in 2.18.1 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;17&nbsp;00:55:28&nbsp;2012</span>
    <span class="description">andrew [...] cpan.org -  Broken in 2.19.0 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;17&nbsp;00:55:29&nbsp;2012</span>
    <span class="description">andrew [...] cpan.org -  Broken in 2.19.1 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;17&nbsp;08:18:35&nbsp;2012</span>
    <span class="description">rlippan [...] remotelinux.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79035] segfault in pg_st_split_statement under OpenBSD - over reads  statement</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 17 Aug 2012 08:18:42 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Rudolf Lippan &lt;rlippan [...] remotelinux.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Friday, August 17, 2012 at 12:54:31 AM, Andrew Fresh via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Fri Aug 17 00:54:30 2012: Request 79035 was acted upon.
&gt; Transaction: Ticket created by ANDREW
&gt;        Queue: DBD-Pg
&gt;      Subject: segfault in pg_st_split_statement under OpenBSD - over reads
&gt;  statement
&gt;    Broken in: 2.18.0, 2.18.1, 2.19.0, 2.19.1, 2.19.2
&gt;     Severity: Important
&gt;        Owner: Nobody
&gt;   Requestors: andrew@cpan.org
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=79035">https://rt.cpan.org/Ticket/Display.html?id=79035</a></span> &gt;
&gt; 
&gt; 
&gt; This test reproduces the problem, it segfaults in different places 
&gt; depending on how memory was allocated, generally right at 511, 1023 or 
&gt; 2047 bytes of SQL statement.  
&gt; 
&gt; The patch covers it up, but is not a good fix.  I can provide ssh access 
&gt; to a machine for testing on if you need.
&gt;
</div>
Maybe I am missing something here, but I don&#39;t see how the patch would do
anything other than change the location of the segfault.  I would guess just 
about any code that you added there would stop it form segfaulting,

strlen&#40;statement&#41; is going to be looking for the &#39;\0&#39; and is just as likely
to walk off the the end of the string.  If there were a concern that the string
were not correctly null-terminated, then it would be best to extract the length
from the PV.

-r


 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;17&nbsp;08:18:37&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;17&nbsp;10:58:42&nbsp;2012</span>
    <span class="description">andrew [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Aug 17 08:18:35 2012, RUDY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Maybe I am missing something here, but I don&#39;t see how the patch would
&gt; do
&gt; anything other than change the location of the segfault.
</div>
As I said it&#39;s a crappy, crappy patch.  I&#39;m not a decent C programmer at 
all.  I just know this makes the test provided &#40;all the way up to 
$length = 16534 in the test&#41; pass.

I believe it is caused because &#39;\0&#39; == *statmement is looking past the 
end of the string and when that lines up with a end of the memory 
segment, OpenBSD segfaults.

I do want to point out that strlen&#40;statement&#41; does NOT segfault while 
the existing code does so although I don&#39;t understand enough of the code 
in that function to see how the statement pointer ends up pointing past 
the end of the char, I&#39;m fairly sure that is what is happening.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;17&nbsp;23:09:21&nbsp;2012</span>
    <span class="description">rlippan [...] remotelinux.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79035] segfault in pg_st_split_statement under OpenBSD - over reads statement</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 17 Aug 2012 23:09:38 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Rudolf Lippan &lt;rlippan [...] remotelinux.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Friday, August 17, 2012 at 10:58:43 AM, Andrew Fresh via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: DBD-Pg
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=79035">https://rt.cpan.org/Ticket/Display.html?id=79035</a></span> &gt;
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I believe it is caused because &#39;\0&#39; == *statmement is looking past the 
&gt; end of the string and when that lines up with a end of the memory 
&gt; segment, OpenBSD segfaults.
&gt; 
</div>
My point is that strlen&#40;&#41; is implemented by walking the string until the
first null.  In other words strlen&#40;&#41; is using the same method of detecting the
end of the string.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I do want to point out that strlen&#40;statement&#41; does NOT segfault while 
&gt; the existing code does so although I don&#39;t understand enough of the code 
&gt; in that function to see how the statement pointer ends up pointing past 
&gt; the end of the char, I&#39;m fairly sure that is what is happening.
</div>
The fact that it does not segfault does not mean that you fixed the bug, it
just means that you made it go deeper into hiding.

I will try to take a look at this over the weekend.  It has been a long time
since I last looked at the code &#40;and it has changed quite a bit since then&#41;
so no promises.

-r
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;18&nbsp;02:11:32&nbsp;2012</span>
    <span class="description">andrew [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I was hanging out in #perl on irc.perl.org and mentioned that I had 
&#34;fixed&#34; it.  There was a bit of discussion &#40;much of it involving my poor 
C skills&#41; and mauke came up with both a better solution and then 
explanation of why it happens.  I have attached both the patch, the test 
and the irc log with the explanation.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch-dbdimp_c</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1110638/583993/patch-dbdimp_c">Download patch-dbdimp_c</a><br />
<span class="downloadcontenttype">application/octet-stream 523b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> segfault.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use strict;
use warnings;

use Test::More tests =&gt; 16385;

use DBI;

use lib &#39;t&#39;,&#39;.&#39;;
require &#39;dbdpg_test_setup.pl&#39;;

my $dbh = connect_database&#40;&#41;;

for my $length &#40;0..16384&#41; {
    my $sql = sprintf &#39;SELECT %*d&#39;, $length + 3, $length;
    my $cur_len = $dbh-&gt;selectrow_array&#40;$sql&#41;;
    is $cur_len, $length, &#34;length $length =&gt; &#34; . length&#40;$sql&#41;;
}
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> DBD-Pg-segfault-fix-chat-log.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">20:59 &lt; mauke&gt; heh, this is funny
20:59 &lt; mauke&gt; the comment in line 1980 is obviously bogus
20:59 &lt; mauke&gt; if you wanted to find out why this code is here, tracing that comment through version control would be a good start
21:00 &lt; mauke&gt; the fix is to remove lines 1980 .. 1982
21:00 &lt; triddle&gt; haha really?
21:00 &lt; mauke&gt; yes
21:00 &lt; afresh1&gt; I saw in RT that they switched to git somewhere, but the repo doesn&#39;t appear to be public
21:00 &lt; mauke&gt; just remove the crashing code~
21:00 &lt; afresh1&gt; mauke: that was what I did first!
21:00 &lt; mauke&gt; and?
21:00 &lt; afresh1&gt; and it didn&#39;t crash 
21:00 &lt; mauke&gt; good
21:01 &lt; triddle&gt; gumbybrain: oh C you so crazy
21:01 &lt; GumbyBRAIN&gt; With all the crazy get on with all the shite from the faq got &#39;im.
21:01 &lt; afresh1&gt; I think I cranked the loop over 9000! &#40;even over 16k&#41;
21:01 &lt; mauke&gt; do you want to know why that fix is correct?
21:01 &lt; afresh1&gt; for sure!
21:01 &lt; purl&gt; like totally!
21:02 &lt; mauke&gt; ok, so.
21:02 &lt; afresh1&gt; whar purl said!
21:02 &lt; mauke&gt; the whole block here analyzes the statement by stepping through it char by char
21:02 &lt; afresh1&gt; got that! I must be an expert!
21:02 &lt;@apeiron&gt; which seems like it&#39;s reinventing Postgres&#39;s parser
21:02 &lt;@apeiron&gt; poorly, as we&#39;ve seen
21:03 &lt; mauke&gt; the first thing it does is save the current character in ch, and increment statement/curpos
21:03 &lt; afresh1&gt; apeiron: true, but it is so they can handle placeholders &#40;as far as I can tell&#41;
21:03 &lt; mauke&gt; &#40;yeah, it&#39;s a quick and dirty lexer&#41;
21:03 &lt; afresh1&gt; so we have current and next characters available
21:03 &lt;@apeiron&gt; But placeholders are sent separately
21:03 &lt;@apeiron&gt; I don&#39;t see why this code needs to exist
21:03 &lt;@apeiron&gt; Send the SQL, send the placeholders
21:03 &lt;@apeiron&gt; If it blows up, returns the error to the user
21:04 &lt; afresh1&gt; maybe DBI supports more placeholder types than postgres?
21:04 &lt; mauke&gt; the check in line 1664 bypasses the main logic for most of your statement
21:04 &lt; mauke&gt; it will immediately skip SELECT &#40;uppercase letters are &gt; 64&#41;
21:04 &lt; mauke&gt; and it will skip spaces &#40;32&#41;
21:05 &lt; afresh1&gt; yay
21:05 &lt; mauke&gt; and it turns out digits don&#39;t get special treatment either &#40;48 .. 57&#41;
21:05 &lt; mauke&gt; in fact, the only way we&#39;re getting into the bowels of that loop with your statement is the very end: &#39;\0&#39;
21:06 &lt; mauke&gt; keep in mind, at this point ch == &#39;\0&#39;, statement is one past the end of the buffer, and currpos is 1 + the length of the string
21:07 &lt; afresh1&gt; I see that
21:07 &lt; mauke&gt; ch == &#39;\0&#39; skips us past 1668, 1704, 1732
21:07 &lt; mauke&gt; 0 is specifically excluded from 1840 so we go deeper
21:08 &lt; mauke&gt; line 1846 sets sectionstop = currpos-1, i.e. at this point sectionstop = strlen&#40;statement_orig&#41;
21:08 &lt; afresh1&gt; all the while statement is already pointed one past the end of the string?
21:08 &lt; mauke&gt; yes
21:09 &lt; mauke&gt; line 1849 sets placeholder_type = 0
21:09 &lt; mauke&gt; since ch is still &#39;\0&#39;, we skip past 1852, 1863, and 1867
21:10 &lt; mauke&gt; we&#39;re now in line 1887. we skip that too because we haven&#39;t touched placeholder_type in the meantime
21:10 &lt; mauke&gt; and we skip 1895 because ch is still &#39;\0&#39; &#40;i.e. false&#41;
21:11 &lt; mauke&gt; the next block allocates a segment, whatever that is, and initializes it
21:11 &lt; mauke&gt; placeholder_type is still 0 so we skip down to line 1953
21:12 &lt; mauke&gt; sectionsize = sectionstop - sectionstart;
21:12 &lt; mauke&gt; well, we said sectionstop = strlen&#40;original statement&#41;, and sectionstart is still 0 &#40;initialized before the loop&#41;
21:12 &lt; mauke&gt; so our &#34;section&#34; covers the entire input string
21:12 &lt; mauke&gt; &#40;and it&#39;s &gt; 0&#41;
21:12 &lt; mauke&gt; we&#39;re now in line 1955
21:13 &lt; warewolf&gt; mauke isn&#39;t a person, he&#39;s a computer.
21:13 &lt; warewolf&gt; this explains why he knows so many languages.
21:13 &lt; mauke&gt; we allocate strlen+1 bytes to newseg-&gt;segment
21:13 &lt; mauke&gt; we copy strlen bytes into it
21:13 &lt; mauke&gt; &#40;and we set the final byte to &#39;\0&#39;&#41;
21:13 &lt; mauke&gt; that&#39;s fine so far; where are we copying from?
21:13 &lt; mauke&gt; answer: statement-&#40;currpos-sectionstart&#41;
21:14 &lt; mauke&gt; since sectionstart == 0, that&#39;s statement - currpos
21:14 &lt; mauke&gt; so far we&#39;ve incremented statement/currpos in lockstep, so this cancels out
21:14 &lt; mauke&gt; we&#39;re copying from the beginning of the original statement
21:15 &lt; mauke&gt; so it turns out this block is all OK
21:15 &lt; afresh1&gt; yay
21:16 &lt; mauke&gt; some linked list shenanigans in line 1967ff
21:16 &lt; afresh1&gt; and this is where I saw the TRACE6 that said it had read in the entire statement before crashing
21:16 &lt; mauke&gt; and then we finally reach line 1980
21:16 &lt; mauke&gt; and we try to dereference statement, which is still one past the end of the buffer
21:16 &lt; afresh1&gt; boo!
21:16 &lt; mauke&gt; so, that&#39;s the explanation of why it crashes, or what the bug is
21:17 &lt; mauke&gt; why is the fix to simply remove that line?
21:17 &lt; mauke&gt; first off, notice that the comment talks about setting ch, which doesn&#39;t match the code at all
21:18 &lt; afresh1&gt; I did notice that, but I also noticed the comment didn&#39;t match english
21:18 &lt; mauke&gt; strike the first comma
21:18 &lt; mauke&gt; hmm, now I have to check what &#34;segments&#34; are
21:19 &lt; triddle&gt; that bit with assigning a negative value to a char type is pretty winning at failing on obscure platforms
21:19 &lt; triddle&gt; not everything has signed character types
21:20 &lt;@hobbs&gt; you can always get a signed char by asking for it
21:20 &lt; mauke&gt; afresh1: sorry, I can&#39;t guarantee that this is actually the right fix for all inputs
21:21 &lt; triddle&gt; hobbs: can I get one signed by Penn jillette?
21:21 &lt; mauke&gt; afresh1: it&#39;s correct for your select because dereferencing statement when ch is &#39;\0&#39; is obviously wrong and the condition in line 1643 would end the loop anyway
21:21 &lt; afresh1&gt; aww!  how about if we move &#39;\0&#39; == *statement before we assign it to ch and increment it?
21:21 &lt; afresh1&gt; at the top of the loop
21:22 &lt; mauke&gt; no, that would change semantics
21:22 &lt; afresh1&gt; :-&#40;
21:24 &lt; mauke&gt; for a minimally invasive change you need something like: if &#40;&#39;\0&#39; != ch &#38;&#38; &#39;\0&#39; == *statement&#41; break;  /* ... or: ch = &#39;\0&#39;; */
21:24 &lt; mauke&gt; the last variant would actually match the comment
21:24 &lt; mauke&gt; but the point is to make sure we don&#39;t touch statement if ch is &#39;\0&#39;
21:25 &lt; afresh1&gt; so if &#40;&#39;\0&#39; == ch || &#39;\0&#39; == *statement&#41; break; ?
21:26 &lt; afresh1&gt; or I didn&#39;t follow the &#34;last variant&#34;
21:28 &lt; mauke&gt; I said !=, not ==
21:28 &lt; afresh1&gt; I was trying to understand what you mean by variant
21:28 &lt; mauke&gt; the version in the comment
21:28 &lt; mauke&gt; ch = &#39;\0&#39;; instead of break;
21:29 &lt; afresh1&gt; ahh, I see
21:29 &lt; mauke&gt; I think I understand why that condition is there, btw
21:29 &lt; mauke&gt; they&#39;re trying to avoid creating an empty segment if the statement happens to end with a placeholder
21:31 &lt; afresh1&gt; mauke: I will have to copy and re-read this log a few times, but it is much, much clearer to me.  Thank you so much!
21:31 &lt; afresh1&gt; mauke: Do you mind if I share the solution and log with the RT ticket?
21:31 &lt; mauke&gt; go ahead and paste it in if it helps :-&#41;
21:32 &lt; afresh1&gt; based on his last comment &#40;&#34;I haven&#39;t read the code in a while&#34;&#41; it might
21:33 &lt; mauke&gt; if &#40;currseg-&gt;placeholder &lt; powf&#40;&#40;float&#41;10,&#40;float&#41;x&#41;&#41;  /me pukes
21:33 &lt;@hobbs&gt; &#40;float&#41;10
21:34 &lt; mauke&gt; yeah, this is bullshit
21:35 &lt; mauke&gt; 1&#41; if you want a constant 10 of type float, that&#39;s 10f
21:35 &lt; mauke&gt; 2&#41; why the fuck are you using powf? that&#39;s not even C89/C90
21:35 &lt; mauke&gt; 3&#41; why the fucking fuck are you using single precision floating-point arithmetic for integers?
21:35 &lt; mauke&gt; and not just any integers, but integer size checks for buffer sizes?
21:36 &lt; mauke&gt; but wait, it gets better: for &#40;x=1; x&lt;7; x++&#41; { if &#40;currseg-&gt;placeholder &lt; powf&#40;&#40;float&#41;10,&#40;float&#41;x&#41;&#41; break; }
21:37 &lt;@hobbs&gt; ...
21:38 &lt; mauke&gt; i.e. you can simply rewrite that as: long power_of_ten = 10; for &#40;x=1; x&lt;7; x++, power_of_ten *= 10&#41; { if &#40;currseg-&gt;placeholder &lt; power_of_ten&#41; break; }
21:38 &lt;@hobbs&gt; is the value of x at least used afterwards?
21:38 &lt; mauke&gt; ta-da! no more floats
21:38 &lt; mauke&gt; yes: if &#40;x&gt;=7&#41; croak&#40;&#34;...&#34;&#41;;
21:38 &lt; mauke&gt; &#40;ok, there&#39;s more after that&#41;
21:39 &lt; mauke&gt; great variable name, that &#39;x&#39;
21:39 &lt; afresh1&gt; &#39;i&#39; was probably taken by something important
21:42 &lt; mauke&gt; oh man, this code could be simplified so hard
21:42 &lt; mauke&gt; that whole loop is there to check how many digits a given integer will take in decimal form
21:43 &lt; mauke&gt; and if it&#39;s more than 6 digits, the code croaks
21:44 &lt; mauke&gt; so why not simply assume every number will take 6 digits, allocate that much memory, and simplify the check to: if &#40;currseg-&gt;placeholder &gt; 999999&#41; croak&#40;&#34;...&#34;&#41;;
21:45 &lt; mauke&gt; because clearly it is important to save 5 bytes per placeholder
21:46 &lt; mauke&gt; temporarily, that is. the string is freed in the same function
21:46 &lt; mauke&gt; apeiron: those parsing shenanigans are there because the code rewrites every placeholder into $123 form
21:46 &lt; mauke&gt; &#34;SELECT ?, ?, ?&#34; ==&gt; &#34;SELECT $1, $2, $3&#34;
21:47 &lt;@apeiron&gt; fun
21:49 &lt;@hobbs&gt; I think the dollar signs are postgres-native and the question-marks are only supported because it&#39;s DBI convention
21:50 &lt;@apeiron&gt; sounds about right
21:52 &lt; mauke&gt; and clearly this text processing step should be done in C, not Perl
21:52 &lt; mauke&gt; because we all know C is great at strings and not crashing
21:52 &lt;@apeiron&gt; yes exactly
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;20&nbsp;15:03:52&nbsp;2012</span>
    <span class="description">greg [...] turnstep.com -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;21&nbsp;13:23:13&nbsp;2012</span>
    <span class="description">greg [...] turnstep.com -  Fixed in 0.52 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;21&nbsp;13:23:13&nbsp;2012</span>
    <span class="description">greg [...] turnstep.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">That was some amusing reading. Thanks to all for the cleanups: all have 
been applied and will be part of the upcoming 2.19.3 version.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;21&nbsp;13:23:14&nbsp;2012</span>
    <span class="description">greg [...] turnstep.com -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;21&nbsp;22:13:40&nbsp;2012</span>
    <span class="description">andrew [...] cpan.org -  Fixed in 2.19.3 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;21&nbsp;22:13:40&nbsp;2012</span>
    <span class="description">andrew [...] cpan.org -  Fixed in 0.52 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;21&nbsp;22:14:51&nbsp;2012</span>
    <span class="description">andrew [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> It passes the new regression tests for me</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for your quick fix, unfortunately missed OpenBSD 5.2 but hope 
to see it in snapshots soon!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;21&nbsp;22:14:52&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;21&nbsp;22:14:52&nbsp;2012</span>
    <span class="description">andrew [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
