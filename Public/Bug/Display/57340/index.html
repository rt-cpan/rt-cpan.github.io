<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #57340 for PDF-Create: Inserting images fails with LANG=UTF8</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #57340 for PDF-Create: Inserting images fails with LANG=UTF8</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=PDF-Create">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=PDF-Create">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=PDF-Create">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=PDF-Create">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/PDF-Create">PDF-Create CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">57340</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=PDF-Create">PDF-Create</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">MARKUSB [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
frankie [...] etsetb.upc.edu

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-24970-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.05    </td>
  </tr>
  <tr id="CF-24971-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.06    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




60-dbi.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/774939/401303/60-dbi.t">
Mon May 10 06:34:39 2010 (1.4k) by frankie [...] etsetb.upc.edu
</a>
</font></li>
</ul>


60_locale.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/775984/401870/60_locale.t">
Wed May 12 06:32:45 2010 (1.4k) by frankie [...] etsetb.upc.edu
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=57340">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-774936" href="/Public/Bug/Display.html?id=57340#txn-774936">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;10&nbsp;05:58:36&nbsp;2010</span>
    <span class="description">frankie [...] etsetb.upc.edu -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Inserting images fails with LANG=UTF8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> frankie [...] etsetb.upc.edu</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/774936/401298/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401298">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi. I spotted a serious problem. It only happens when some circumstances are met. Images are added wrong in the PDF  when LANG=UTF8 and a DBI networking connection is made.

I&#39;ve been digging the root of the problem. I will try to explain the best that I can.

The PDFs created are different in the line where the image size is defined in the PDF file.

When LANG=ca_ES@euro
 PDF: 510.236220472441 0 0 841.889763779528 0 0 cm

When LANG=ca_ES.UTF-8
 PDF: 510,236220472441 0 0 841,889763779528 0 0 cm


Notice when the PDF is wrong the decimal separator is &#34;,&#34; instead &#34;.&#34;. Something happens somewhere in the DBI networking process that triggers a change in that. Then it affects the image size definition inside the PDF.

I tried many different DBI releases and it always happen the same. I also tried connection to mysql and postgress servers. The connection doesn&#39;t need to complete right. A bogus hostname does the trick :
 eval {DBI-&gt;connect&#40;&#34;DBI:Pg:host=WHATEVER&#34;&#41; };


PDF::Create v1.05
DBI v1.609
perl v5.10.1

I can also send a minimal script that creates the wrong PDF if you need it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-774939" href="/Public/Bug/Display.html?id=57340#txn-774939">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;10&nbsp;06:34:39&nbsp;2010</span>
    <span class="description">frankie [...] etsetb.upc.edu -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/774939/401302/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401302">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 41b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I just added a test to help spot the bug.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 60-dbi.t</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/774939/401303/60-dbi.t">Download 60-dbi.t</a><br />
<span class="downloadcontenttype">text/x-perl 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w
#
# PDF::Create - Test Script
#

BEGIN { unshift @INC, &#34;lib&#34;, &#34;../lib&#34; }
use strict;
use PDF::Create;
use Test::More tests =&gt; 3;

# we want the resulting pdf file to have the same name as the test
my $pdfname = $0;
$pdfname =~ s/\.t/\.pdf/;

my $MM = 25.4 / 72;
my $PAGE_WIDTH = 210 / $MM;
my $PAGE_HEIGHT = 297 / $MM;

my &#40;$X,$Y&#41;= &#40;300,369&#41;;

$ENV{LANG}=&#39;es_ES.UTF-8&#39;;

###################################################################
#
# start testing
#
SKIP: {
	eval {
		require DBI;
		require DBD::mysql;
	};
	$@ =~ s/&#40;.*?\.pm&#41; in /$1/;
	skip $@,3 if $@;
	
	eval { DBI-&gt;connect&#40;&#34;DBI:mysql:host=WHATEVER&#34;,undef,undef
			,{PrintError=&gt;0}&#41; };
	
	
	my $pdf = new PDF::Create&#40; &#39;filename&#39; =&gt; &#34;$pdfname&#34;,
							   &#39;Version&#39;  =&gt; 1.2,
							   &#39;PageMode&#39; =&gt; &#39;UseOutlines&#39;,
							   &#39;Author&#39;   =&gt; &#39;Markus Baertschi&#39;,
							   &#39;Title&#39;    =&gt; &#39;Testing Basic Stuff&#39;,
							 &#41;;
	my $root = $pdf-&gt;new_page&#40; &#39;MediaBox&#39; =&gt; $pdf-&gt;get_page_size&#40;&#39;A4&#39;&#41; &#41;;
	ok&#40; defined $root, &#34;Create page root&#34; &#41;;
	
	my $image_file = &#34;t/pdf-logo.jpg&#34;;
	my $image = $pdf-&gt;image&#40;$image_file&#41; or die $!;
	my $page = $root-&gt;new_page&#40;&#41;;
	$page-&gt;image&#40; image =&gt; $image , xpos =&gt; 0,ypos =&gt; 0
				, xscale =&gt; $PAGE_WIDTH/$Y, yscale =&gt; $PAGE_HEIGHT/$Y&#41;;
	
	ok&#40; !$pdf-&gt;close&#40;&#41;, &#34;Close PDF&#34; &#41;;
	
	my $SIZE = &#34;483.963894757058 0 0 841.889763779528 0 0 cm&#34;;
	
	open PDF,&#34;&lt;$pdfname&#34; or die &#34;$! $pdfname&#34;;
	my $line;
	for &#40; 1..8&#41;{
		$line=&lt;PDF&gt;;
	}
	chomp $line;
	ok &#40; $line eq $SIZE&#41;;
	close PDF;
};
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-774942" href="/Public/Bug/Display.html?id=57340#txn-774942">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;10&nbsp;06:34:40&nbsp;2010</span>
    <span class="description">frankie [...] etsetb.upc.edu -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-774948" href="/Public/Bug/Display.html?id=57340#txn-774948">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;10&nbsp;07:03:19&nbsp;2010</span>
    <span class="description">MARKUSB [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-774950" href="/Public/Bug/Display.html?id=57340#txn-774950">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;10&nbsp;07:04:07&nbsp;2010</span>
    <span class="description">MARKUSB [...] cpan.org -  Broken in 1.05 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-774973" href="/Public/Bug/Display.html?id=57340#txn-774973">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;10&nbsp;07:28:16&nbsp;2010</span>
    <span class="description">MARKUSB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/774973/401320/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401320">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 194b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">It looks to me like this comes from the implicit float-&gt;string 
conversion in the image method of the page object &#40;page.pm, lines 526-
538&#41;.

Could you try to insert $ENV{LANG}=&#39;C&#39; on line 525 ?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-774985" href="/Public/Bug/Display.html?id=57340#txn-774985">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;10&nbsp;07:51:54&nbsp;2010</span>
    <span class="description">frankie [...] etsetb.upc.edu -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #57340] Inserting images fails with LANG=UTF8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 10 May 2010 13:51:10 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Markus Baertschi via RT &lt;bug-PDF-Create [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Francesc Guasch &lt;frankie [...] etsetb.upc.edu&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/774985/401330/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401330">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 944b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, May 10, 2010 at 07:28:17AM -0400, Markus Baertschi via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; It looks to me like this comes from the implicit float-&gt;string 
&gt; conversion in the image method of the page object &#40;page.pm, lines 526-
&gt; 538&#41;.
</div>
In my source for Page.pm from PDF::Create v1.05 I have init_widths sub:

        sub init_widths
        {
                {  &#39;Courier&#39; =&gt; [ 599, 599, 599, 599, 599, 599, 
                                

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Could you try to insert $ENV{LANG}=&#39;C&#39; on line 525 ?
</div>
I inserted it in the beginning of sub image like this:

        #######################################################################
        # Place an image on the current page
        #
        sub image
        {
                $ENV{LANG}=&#39;C&#39;;
                my $self   = shift;
                my %params = @_;
        

But I see no effect. Actually I tried doing several $ENV{LANG}=&#39;C&#39;
all through the test code: right before calling image, before calling
new_page and even before doing PDF::Create-&gt;new. It never worked.
It only works if I change the LANG before DBI-&gt;connect. Weird !
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-774995" href="/Public/Bug/Display.html?id=57340#txn-774995">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;10&nbsp;08:02:28&nbsp;2010</span>
    <span class="description">frankie [...] etsetb.upc.edu -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/774995/401338/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401338">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 385b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Well, it looks like I call image with &#34;,&#34; separators already.

I found in perldata:

  &#34;If use locale  is in effect, and POSIX::setlocale&#40;&#41; has been called,
the character used for the decimal separator is affected by the
LC_NUMERIC locale.&#34;

So ,the DBI code must be calling those functions, it should be cleared
before the output to the pdf file. I will look a little deeper tomorrow.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-774998" href="/Public/Bug/Display.html?id=57340#txn-774998">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;10&nbsp;08:16:42&nbsp;2010</span>
    <span class="description">MARKUSB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/774998/401341/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401341">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 310b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon May 10 08:02:28 2010, FRANKIE wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So ,the DBI code must be calling those functions, it should be cleared
&gt; before the output to the pdf file. I will look a little deeper 
</div>tomorrow.

You might need $loc = setlocale&#40; LC_NUMERIC, &#34;C&#34; &#41;; before calculating 
the image size/scaling in your code.

Markus
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-775017" href="/Public/Bug/Display.html?id=57340#txn-775017">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;10&nbsp;10:07:38&nbsp;2010</span>
    <span class="description">frankie [...] etsetb.upc.edu -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #57340] Inserting images fails with LANG=UTF8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 10 May 2010 16:06:52 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Markus Baertschi via RT &lt;bug-PDF-Create [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Francesc Guasch &lt;frankie [...] etsetb.upc.edu&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/775017/401353/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401353">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 361b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, May 10, 2010 at 08:16:43AM -0400, Markus Baertschi via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; You might need $loc = setlocale&#40; LC_NUMERIC, &#34;C&#34; &#41;; before calculating 
&gt; the image size/scaling in your code.
&gt; 
</div>Absolutely. I added this in the beginning of sub image in Page.pm,
then I did a setlocale&#40; LC_NUMERIC, $loc&#41;; in the end.
In addition, I had to do use POSIX in Page.pm
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-775027" href="/Public/Bug/Display.html?id=57340#txn-775027">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;10&nbsp;11:11:26&nbsp;2010</span>
    <span class="description">markus [...] markus.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #57340] Inserting images fails with LANG=UTF8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 10 May 2010 17:10:45 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-Create [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Markus Baertschi &lt;markus [...] markus.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/775027/401360/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401360">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 926b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I don&#39;t quite understand: You said before that your program is passing the
comma instead of
the dot to $page-&gt;image&#40;&#41;. Now it sounds like adding setlocale to
page.pmfixes things.
If it is the first &#40;you pass the comma&#41; then changing page.pm does not help.

If it is the second then I&#39;ll have to see what is the best/most elegant way
to make
sure I always generate floats with dots instead of commas.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; You might need $loc = setlocale&#40; LC_NUMERIC, &#34;C&#34; &#41;; before calculating
&gt; &gt; the image size/scaling in your code.
</div>&gt; Absolutely. I added this in the beginning of sub image in Page.pm,
&gt; then I did a setlocale&#40; LC_NUMERIC, $loc&#41;; in the end.
&gt; In addition, I had to do use POSIX in Page.pm
&gt;
&gt;
&gt;
</div>

-- 
 Markus Baertschi             Phone: ++41 &#40;21&#41; 807 1677
 Bas du Rossé 16             Fax  : ++41 &#40;21&#41; 807 1678
 CH-1163, Etoy                Email: markus@markus.org
 Switzerland                  Homepage: www.markus.org
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/775027/401361/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401361">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1.4k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-775316" href="/Public/Bug/Display.html?id=57340#txn-775316">#</a>      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;11&nbsp;03:28:27&nbsp;2010</span>
    <span class="description">frankie [...] etsetb.upc.edu -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #57340] Inserting images fails with LANG=UTF8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 11 May 2010 09:27:50 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Markus Baertschi via RT &lt;bug-PDF-Create [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Francesc Guasch &lt;frankie [...] etsetb.upc.edu&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/775316/401529/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401529">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, May 10, 2010 at 11:11:27AM -0400, Markus Baertschi via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=57340">https://rt.cpan.org/Ticket/Display.html?id=57340</a></span> &gt;
&gt; 
&gt; I don&#39;t quite understand: You said before that your program is passing the
&gt; comma instead of
</div>
Yes, my wrong. I added some warns to check the contents of
the xscale values. And when I printed in the screen it was
with a comma.

In my opinion, that is a float internally. When I ask to
show it on screen, the locale makes it print in my language
format. So it has a comma. But if I changed the locale
to &#39;C&#39; right before printing it it is shown with a dot.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; the dot to $page-&gt;image&#40;&#41;. Now it sounds like adding setlocale to
&gt; page.pmfixes things.
&gt; If it is the first &#40;you pass the comma&#41; then changing page.pm does not help.
&gt; 
&gt; If it is the second then I&#39;ll have to see what is the best/most elegant way
&gt; to make
&gt; sure I always generate floats with dots instead of commas.
</div>
In my opinion the PDF spec requires a dot as a decimal separator.
To make sure it is like this a change is required to Page.pm so
float values are created in &#39;C&#39; locale. After inserting the image
the locale should be restored to its initial value. So if I use a
a locale in my code it should be like this when it returns from
page-&gt;image.

This way you are sure the PDFs are created right, no matter what
locale is set in the main code.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-775333" href="/Public/Bug/Display.html?id=57340#txn-775333">#</a>      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;11&nbsp;04:40:10&nbsp;2010</span>
    <span class="description">markus [...] markus.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #57340] Inserting images fails with LANG=UTF8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 11 May 2010 10:39:33 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-Create [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Markus Baertschi &lt;markus [...] markus.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/775333/401545/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401545">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, May 11, 2010 at 9:28 AM, Francesc Guasch via RT &lt;
bug-PDF-Create@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; In my opinion the PDF spec requires a dot as a decimal separator.
&gt; To make sure it is like this a change is required to Page.pm so
&gt; float values are created in &#39;C&#39; locale. After inserting the image
&gt; the locale should be restored to its initial value. So if I use a
&gt; a locale in my code it should be like this when it returns from
&gt; page-&gt;image.
&gt;
&gt; This way you are sure the PDFs are created right, no matter what
&gt; locale is set in the main code.
&gt;
</div>
There is something I don&#39;t know about the locale thing. Isn&#39;t the
locale setting a global thing ?
That means if I change the locale to &#39;C&#39; in page.pm, then suddenly
this changes the locale for the calling program too.

This would introduce a unwanted side-effect and break things.

-- 
 Markus Baertschi             Phone: ++41 &#40;21&#41; 807 1677
 Bas du Rossé 16             Fax  : ++41 &#40;21&#41; 807 1678
 CH-1163, Etoy                Email: markus@markus.org
 Switzerland                  Homepage: www.markus.org
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/775333/401546/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401546">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1.5k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-775356" href="/Public/Bug/Display.html?id=57340#txn-775356">#</a>      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;11&nbsp;04:54:59&nbsp;2010</span>
    <span class="description">markus [...] markus.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #57340] Inserting images fails with LANG=UTF8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 11 May 2010 10:54:27 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-Create [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Markus Baertschi &lt;markus [...] markus.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/775356/401563/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401563">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 615b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I just did some rtfm, can you insert the &#39;no locale&#39; command at the
beginning of the image&#40;&#41; subroutine in page.pm ?
This pragma is tells perl to ignore the locale settings until the end of the
current block. This would be a good fix with no unintended collateral
damage.

no locale

Sorry for the work, but I&#39;m at my money-earning day-job and don&#39;t have a
test-environment here.

Markus

-- 
 Markus Baertschi             Phone: ++41 &#40;21&#41; 807 1677
 Bas du Rossé 16             Fax  : ++41 &#40;21&#41; 807 1678
 CH-1163, Etoy                Email: markus@markus.org
 Switzerland                  Homepage: www.markus.org
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/775356/401564/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401564">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1005b</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-775381" href="/Public/Bug/Display.html?id=57340#txn-775381">#</a>      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;11&nbsp;05:12:08&nbsp;2010</span>
    <span class="description">frankie [...] etsetb.upc.edu -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #57340] Inserting images fails with LANG=UTF8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 11 May 2010 11:11:22 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Markus Baertschi via RT &lt;bug-PDF-Create [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Francesc Guasch &lt;frankie [...] etsetb.upc.edu&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/775381/401582/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401582">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, May 11, 2010 at 04:40:13AM -0400, Markus Baertschi via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt;
&gt; &gt; In my opinion the PDF spec requires a dot as a decimal separator.
&gt; &gt; To make sure it is like this a change is required to Page.pm so
&gt; &gt; float values are created in &#39;C&#39; locale. After inserting the image
</div>&gt; 
&gt; There is something I don&#39;t know about the locale thing. Isn&#39;t the
&gt; locale setting a global thing ?
&gt; That means if I change the locale to &#39;C&#39; in page.pm, then suddenly
&gt; this changes the locale for the calling program too.
</div>
I&#39;m testing what happens when there is code that messes with locales.
When a call is made to DBI-&gt;connect the LC_NUMERIC is changed because
internally there must be some code that uses the locale. When it
returns from connect it is changed globally.

print setlocale&#40;LC_NUMERIC&#41;.&#34;\n&#34;;

        *C*


$dbh = DBI-&gt;connect&#40;&#34;dbi:mysql:host...

print setlocale&#40;LC_NUMERIC&#41;.&#34;\n&#34;;

        *es_ES.UTF-8*


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This would introduce a unwanted side-effect and break things.
</div>
Yes it does, but you can also consider it a desired behaviour. If I
retrieve some number from a database and I want to show it on screen
it should be shown in a format I will understand. In that case I
have configured my terminal as es_ES.UTF-8 and that is what I get.

But then if I create a PDF and its internal numbering spec requires
a dot instead a comma the locale should be changed locally and
returned to the previous format later.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-775396" href="/Public/Bug/Display.html?id=57340#txn-775396">#</a>      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;11&nbsp;05:16:34&nbsp;2010</span>
    <span class="description">frankie [...] etsetb.upc.edu -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #57340] Inserting images fails with LANG=UTF8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 11 May 2010 11:15:59 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Markus Baertschi via RT &lt;bug-PDF-Create [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Francesc Guasch &lt;frankie [...] etsetb.upc.edu&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/775396/401588/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401588">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 565b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, May 11, 2010 at 04:55:00AM -0400, Markus Baertschi via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I just did some rtfm, can you insert the &#39;no locale&#39; command at the
&gt; beginning of the image&#40;&#41; subroutine in page.pm ?
&gt; This pragma is tells perl to ignore the locale settings until the end of the
&gt; current block. This would be a good fix with no unintended collateral
&gt; damage.
</div>
It failed, doing the setlocale and restoring it at the end worked fine.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sorry for the work, but I&#39;m at my money-earning day-job and don&#39;t have a
&gt; test-environment here.
</div>
Don&#39;t worry, I&#39;m glad to help.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-775399" href="/Public/Bug/Display.html?id=57340#txn-775399">#</a>      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;11&nbsp;05:22:08&nbsp;2010</span>
    <span class="description">markus [...] markus.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #57340] Inserting images fails with LANG=UTF8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 11 May 2010 11:21:33 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-Create [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Markus Baertschi &lt;markus [...] markus.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/775399/401592/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401592">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, May 11, 2010 at 11:12 AM, Francesc Guasch via RT &lt;
bug-PDF-Create@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m testing what happens when there is code that messes with locales.
&gt; When a call is made to DBI-&gt;connect the LC_NUMERIC is changed because
&gt; internally there must be some code that uses the locale. When it
&gt; returns from connect it is changed globally.
&gt;
&gt; print setlocale&#40;LC_NUMERIC&#41;.&#34;\n&#34;;
&gt;
&gt;        *C*
&gt;
&gt;
&gt; $dbh = DBI-&gt;connect&#40;&#34;dbi:mysql:host...
&gt;
&gt; print setlocale&#40;LC_NUMERIC&#41;.&#34;\n&#34;;
&gt;
&gt;        *es_ES.UTF-8*
&gt;
&gt;
<div class="message-stanza open">&gt; &gt; This would introduce a unwanted side-effect and break things.
</div>&gt;
</div>
In my opinion this is a bug in DBI. If the application/database requires a
change in locale this should have to be done explicitly by the app. Changing
locales behind the scene breaks things, as we have seen.

Yes it does, but you can also consider it a desired behaviour. If I
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; retrieve some number from a database and I want to show it on screen
&gt; it should be shown in a format I will understand. In that case I
&gt; have configured my terminal as es_ES.UTF-8 and that is what I get.
&gt;
</div>
Yes, but you, as developer know about the locales you want to support and
can set it according to your needs.

But then if I create a PDF and its internal numbering spec requires
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; a dot instead a comma the locale should be changed locally and
&gt; returned to the previous format later.
&gt;
</div>
I accept this as a bug in PDF::Create. It should not depend on a specific
local/set of locales, but it should not change them globally for others
either. Imagine your app depends on the correct locale, but calls to
PDF::Create change it, so you have to reset if after each invocation.

Markus

-- 
 Markus Baertschi             Phone: ++41 &#40;21&#41; 807 1677
 Bas du Rossé 16             Fax  : ++41 &#40;21&#41; 807 1678
 CH-1163, Etoy                Email: markus@markus.org
 Switzerland                  Homepage: www.markus.org
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/775399/401593/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401593">with headers</a>
<br />
<span class="downloadcontenttype">text/html 2.6k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-775984" href="/Public/Bug/Display.html?id=57340#txn-775984">#</a>      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;12&nbsp;06:32:45&nbsp;2010</span>
    <span class="description">frankie [...] etsetb.upc.edu -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #57340] Inserting images fails with LANG=UTF8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 12 May 2010 12:32:04 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Markus Baertschi via RT &lt;bug-PDF-Create [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Francesc Guasch &lt;frankie [...] etsetb.upc.edu&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/775984/401869/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/401869">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, May 11, 2010 at 05:22:09AM -0400, Markus Baertschi via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; In my opinion this is a bug in DBI. If the application/database requires a
&gt; change in locale this should have to be done explicitly by the app. Changing
&gt; locales behind the scene breaks things, as we have seen.
</div>
you must be right, I&#39;ll file a bug to DBI so.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I accept this as a bug in PDF::Create. It should not depend on a specific
&gt; local/set of locales, but it should not change them globally for others
</div>
Right, so before returning from Page-&gt;image it should restore
the locale. That is what I said yesterday. This is a diff from
my Page.pm:

23a24
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; use POSIX;
</div>464a466,468
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       my $loc = setlocale&#40;LC_NUMERIC&#41;;
&gt;       setlocale&#40;LC_NUMERIC,&#39;C&#39;&#41;;
&gt; 
</div>515a520,521
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt;       setlocale&#40;LC_NUMERIC,$loc&#41;;
</div>
I think that makes Page-&gt;image locale transparent and won&#39;t create
undesirable consequences to the caller.

And I also attach a test file. It checks whether PDF with images
are correctly created when utf spanish locales are used. It skips
the test if the es_ES.utf-8 locale is not available.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/775984/401870/60_locale.t">Download 60_locale.t</a><br />
<span class="downloadcontenttype">text/x-perl 1.4k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-800598" href="/Public/Bug/Display.html?id=57340#txn-800598">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;06&nbsp;09:29:47&nbsp;2010</span>
    <span class="description">MARKUSB [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-800599" href="/Public/Bug/Display.html?id=57340#txn-800599">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;06&nbsp;09:30:08&nbsp;2010</span>
    <span class="description">MARKUSB [...] cpan.org -  Severity Normal added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-801244" href="/Public/Bug/Display.html?id=57340#txn-801244">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;07&nbsp;16:30:58&nbsp;2010</span>
    <span class="description">MARKUSB [...] cpan.org -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-801246" href="/Public/Bug/Display.html?id=57340#txn-801246">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;07&nbsp;16:30:59&nbsp;2010</span>
    <span class="description">MARKUSB [...] cpan.org -  Fixed in 1.06 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.850955</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
