<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #60490 for Alien-SVN: Check if there&#39;s already an SVN library installed and use that</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #60490 for Alien-SVN: Check if there&#39;s already an SVN library installed and use that</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Alien-SVN/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Alien-SVN/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Alien-SVN/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Alien-SVN/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/evalEmpire/Alien-SVN/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Alien-SVN">Alien-SVN CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">60490</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Alien-SVN/Active/">Alien-SVN</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mschwern [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-45296-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.6.12.0    </td>
  </tr>
  <tr id="CF-45297-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;18&nbsp;18:32:59&nbsp;2010</span>
    <span class="description">mschwern [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Check if there&#39;s already an SVN library installed and use that</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">People have requested that Alien::SVN use existing installed Subversion
libraries.  Makes sense, as Alien modules are less about installing the
alien library in question as making sure its installed and of a high
enough version.

But don&#39;t ask me how to do it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;29&nbsp;20:13:59&nbsp;2010</span>
    <span class="description">CREAMYG [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Aug 18 18:32:59 2010, MSCHWERN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; People have requested that Alien::SVN use existing installed Subversion
&gt; libraries.  Makes sense, as Alien modules are less about installing the
&gt; alien library in question as making sure its installed and of a high
&gt; enough version.
&gt; 
&gt; But don&#39;t ask me how to do it.
</div>
I&#39;m not sure that Alien::SVN has ever used anything other than existing
installed Subversion libraries.

From what I can tell, the Subversion SWIG bindings do not know how to find a
.so file in a non-standard location.  To get them to find .so files
within the
Perl module tree, I had to apply the attached patch.  

To verify that the existing system is not using the custom-compiled
Subversion, try hiding /usr/lib/libsvn_client-1.so.0 and then perform the
following command:

    strace perl -MSVN::Client -e1 2&gt;&#38;1 | grep open

That will show you all the places that the dynamic loader is looking for
libsvn_client-1.so.0, which will include a bunch of dirs where the
library was
built, but not the dir where the .so files were installed. 

It was a colleague of mine who had the original insight to perform an
strace.
I then hacked until we managed to get the proper dir in to the search
path.  I
doubt that the patch uses best practices for passing arguments from a
top-level Build.PL to a Makefile.PL in a subdirectory, but it should be
enough
to convey the idea.

Cheers,

Marvin Humphrey
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> alien_svn_fix.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ur Alien-SVN-1.6.12.0.old/inc/My/SVN/Builder.pm Alien-SVN-1.6.12.0/inc/My/SVN/Builder.pm
--- Alien-SVN-1.6.12.0.old/inc/My/SVN/Builder.pm	2010-08-17 23:08:53.000000000 -0700
+++ Alien-SVN-1.6.12.0/inc/My/SVN/Builder.pm	2010-11-29 16:38:26.000000000 -0800
@@ -77,6 +77,10 @@
 
         $mm_args{$build_to_makemaker{$key}} = $value;
     }
+
+    $mm_args{ALIEN_DIR} = File::Spec-&gt;catdir&#40;
+        $self-&gt;install_destination&#40;&#39;arch&#39;&#41;, &#39;Alien&#39;, &#39;SVN&#39;&#41;;
+
     
     return map { &#34;$_=$mm_args{$_}&#34; } keys %mm_args;
 }
diff -ur Alien-SVN-1.6.12.0.old/src/subversion/subversion/bindings/swig/perl/native/Makefile.PL.in Alien-SVN-1.6.12.0/src/subversion/subversion/bindings/swig/perl/native/Makefile.PL.in
--- Alien-SVN-1.6.12.0.old/src/subversion/subversion/bindings/swig/perl/native/Makefile.PL.in	2010-08-17 23:08:49.000000000 -0700
+++ Alien-SVN-1.6.12.0/src/subversion/subversion/bindings/swig/perl/native/Makefile.PL.in	2010-11-29 16:37:13.000000000 -0800
@@ -3,6 +3,13 @@
 use Config;
 use Cwd &#39;abs_path&#39;;
 
+my $alien_dir;
+for my $arg &#40;@ARGV&#41; {
+    next unless $arg =~ /ALIEN_DIR/;
+    &#40;undef, $alien_dir&#41; = split&#40;/=/, $arg&#41;;
+}
+die &#34;Missing required arg ALIEN_DIR&#34; unless $alien_dir;
+
 my $perl_path = $Config{perlpath};
 if &#40;$^O ne &#39;VMS&#39;&#41; {
   $perl_path .= $Config{_exe} unless $perl_path =~ m/$Config{_exe}$/i;
@@ -16,7 +23,8 @@
 my $swig_builddir = &#34;${svnlib_builddir}/bindings/swig&#34;;
 
 my @modules = qw/client delta fs ra repos wc/;
-my @ldpaths = &#40;&#34;$swig_builddir/perl/libsvn_swig_perl/.libs&#34;,
+my @ldpaths = &#40;$alien_dir, 
+               &#34;$swig_builddir/perl/libsvn_swig_perl/.libs&#34;,
                map {&#34;$svnlib_builddir/libsvn_$_/.libs&#34;} &#40;@modules, qw/diff subr
                                                                       ra_local
                                                                       ra_svn
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;29&nbsp;20:14:00&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;02&nbsp;08:00:47&nbsp;2010</span>
    <span class="description">schwern [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #60490] Check if there&#39;s already an SVN library installed and use that</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 02 Dec 2010 23:59:47 +1100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Alien-SVN [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michael G Schwern &lt;schwern [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2010.11.30 12:14 PM, Marvin Humphrey via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=60490">https://rt.cpan.org/Ticket/Display.html?id=60490</a></span> &gt;
&gt; 
&gt; On Wed Aug 18 18:32:59 2010, MSCHWERN wrote:
<div class="message-stanza open">&gt;&gt; People have requested that Alien::SVN use existing installed Subversion
&gt;&gt; libraries.  Makes sense, as Alien modules are less about installing the
&gt;&gt; alien library in question as making sure its installed and of a high
&gt;&gt; enough version.
&gt;&gt;
&gt;&gt; But don&#39;t ask me how to do it.
</div>&gt; 
&gt; I&#39;m not sure that Alien::SVN has ever used anything other than existing
&gt; installed Subversion libraries.
</div>
It would use the Alien::SVN installed libraries, but it was easily confused by
other installed ones.  This patch looks like it may have fixed that long
standing problem!


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt;From what I can tell, the Subversion SWIG bindings do not know how to find a
</div>&gt; .so file in a non-standard location.
</div>
Yeah, I&#39;d always assumed they did.


-- 
124. Two drink limit does not mean first and last.
    -- The 213 Things Skippy Is No Longer Allowed To Do In The U.S. Army
           <span class="clickylink"><a target="new" rel="nofollow" href="http://skippyslist.com/list/">http://skippyslist.com/list/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;03&nbsp;15:21:00&nbsp;2010</span>
    <span class="description">CREAMYG [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It would use the Alien::SVN installed libraries, but it was
&gt; easily confused by other installed ones.  
</div>
Our belief is that it would load the newly compiled shared
libraries during building and testing, and then it would continue
to load those same files once installed -- but from the build
directory, not the installation directory.

Once the build directory gets zapped, the load mechanism follows
the rest of the LD search path &#40;which was set at compile time&#41;.
This search path does not include the location underneath the
Perl arch dirs where the compiled .so files were installed, so we
don&#39;t believe those copies were ever accessed once installed &#40;at
least not on our system&#41;.  Instead, if you have copies of those
shared objects in a standard installation location like /usr/lib,
it finds those.  If it can&#39;t find them anywhere &#40;for instance
because you moved libsvn_client.1.0.so out of the way for testing
purposes&#41;, it gives up.

In our case, the version in /usr/lib was not compatible with the
version distributed with SVN, and caused a segfault on load.  The
first symptom was that root was able to use SVN::Client properly,
but any other user would get a segfault.  That&#39;s because root was
the one that built Alien::SVN and was still able to see the build
directory and load shared objects from there, but other users
didn&#39;t have permission to access that directory and would get the
incompatible version in /usr/lib and blow up.

Note that all this happens outside the Perl XS load mechanism.
When you use the Perl module SVN::Client, it tries to load the
SWIG XS shared object for SVN::_Core, _Core.so.  It finds that
successfully, but then the dl_load_file&#40;&#41; call dispatches to the
C dynamic loader to get libsvn_client-1.0.so -- and that loader
knows nothing about Perl&#39;s @INC.

The solution was to prepend the non-standard installation
directory to the LD search path which gets baked into _Core.so at
build time.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This patch looks like it may have fixed that long standing
&gt; problem!
</div>
Excellent.  :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; From what I can tell, the Subversion SWIG bindings do not
&gt; &gt; know how to find a .so file in a non-standard location.
</div>&gt; 
&gt; Yeah, I&#39;d always assumed they did.
</div>
I would have assumed the same thing.  It seems like a
non-standard install location would be a common usage pattern.
It took me a while to figure out that there were no provisions
made for that in that Makefile.PL.in!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;16&nbsp;01:50:42&nbsp;2012</span>
    <span class="description">BBYRD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yeah, this one is kind of annoying on the Win32 side.  It tries to
compile and install SVN, even though it&#39;s perfectly fine.  I thinking
&#34;Dude, just type in svn on the CLI.  It&#39;s right THERE!&#34;  I have
TortoiseSVN installed and the svn binary is right there.

I think all it would need to install in that case is the Perl modules. 
Do the Perl modules have their own standard Perl distro install within
this distro, or is it all built into the C compiler Makefile?  It would
be nice to just separate this out.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
