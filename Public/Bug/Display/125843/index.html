<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #125843 for Catalyst-Runtime: libcatalyst-perl: sysread&#40;&#41; is deprecated on :utf8 handles</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #125843 for Catalyst-Runtime: libcatalyst-perl: sysread&#40;&#41; is deprecated on :utf8 handles</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Catalyst-Runtime">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Catalyst-Runtime">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Catalyst-Runtime">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Catalyst-Runtime">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Catalyst-Runtime">Catalyst-Runtime CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">125843</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Catalyst-Runtime">Catalyst-Runtime</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
gregoa [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-40040-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
5.90119    </td>
  </tr>
  <tr id="CF-40041-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
5.90122    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




Catalyst-Runtime-rtc-125843-0001-Use-IO-Handle-read-instead-of-sysread-on-UTF8.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1815234/976713/Catalyst-Runtime-rtc-125843-0001-Use-IO-Handle-read-instead-of-sysread-on-UTF8.patch">
Mon Oct 15 09:54:01 2018 (3.7k) by jkeenan [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=125843">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1795907" href="/Public/Bug/Display.html?id=125843#txn-1795907">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;13&nbsp;17:31:17&nbsp;2018</span>
    <span class="description">gregoa [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> gregoa [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> libcatalyst-perl: sysread&#40;&#41; is deprecated on :utf8 handles</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1795907/965814/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/965814">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">We have the following bug reported to the Debian package of
Catalyst-Runtime &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://bugs.debian.org/903742&#41;">https://bugs.debian.org/903742&#41;</a></span>:

It doesn&#39;t seem to be a bug in the packaging, so you may want to take
a look. Thanks!

------8&lt;-----------8&lt;-----------8&lt;-----------8&lt;-----------8&lt;-----

Package: libcatalyst-perl
Version: 5.90118-1
User: debian-perl@lists.debian.org
Usertags: perl-5.28-transition

While test rebuilding the archive against Perl 5.28 &#40;currently in
experimental&#41;, we noticed this warning in the build log of this package:

  sysread&#40;&#41; is deprecated on :utf8 handles. This will be a fatal error in Perl 5.30 at /usr/lib/x86_64-linux-gnu/perl/5.28/IO/Handle.pm line 205.

A full build log can be found at

 <span class="clickylink"><a target="new" rel="nofollow" href="http://perl.debian.net/rebuild-logs/perl-5.28-throwaway/libcatalyst-perl_5.90118-1/libcatalyst-perl_5.90118-1_amd64-2018-06-05T11%3A36%3A32Z.build">http://perl.debian.net/rebuild-logs/perl-5.28-throwaway/libcatalyst-perl_5.90118-1/libcatalyst-perl_5.90118-1_amd64-2018-06-05T11%3A36%3A32Z.build</a></span>

-- 
Niko Tyni   ntyni@debian.org


------8&lt;-----------8&lt;-----------8&lt;-----------8&lt;-----------8&lt;-----

The next lines after this warning also don&#39;t look good:

sysread&#40;&#41; is deprecated on :utf8 handles. This will be a fatal error in Perl 5.30 at /usr/lib/x86_64-linux-gnu/perl/5.28/IO/Handle.pm line 205.
sysread&#40;&#41; is deprecated on :utf8 handles. This will be a fatal error in Perl 5.30 at /usr/lib/x86_64-linux-gnu/perl/5.28/IO/Handle.pm line 205.
sysread&#40;&#41; is deprecated on :utf8 handles. This will be a fatal error in Perl 5.30 at /usr/lib/x86_64-linux-gnu/perl/5.28/IO/Handle.pm line 205.
sysread&#40;&#41; is deprecated on :utf8 handles. This will be a fatal error in Perl 5.30 at /usr/lib/x86_64-linux-gnu/perl/5.28/IO/Handle.pm line 205.
[error] Caught exception in MyApp::Controller::Root-&gt;stream_write_error &#34;You may not change the encoding once the headers are finalized at t/utf_incoming.t line 211.&#34;
[warn] Useless setting a header value after finalize_headers and the response callback has been called. Since we don&#39;t support tail headers this will not work as you might expect.
[warn] Useless setting a header value after finalize_headers and the response callback has been called. Since we don&#39;t support tail headers this will not work as you might expect.
[error] Caught exception in engine &#34;UTF-8 &#34;\xE2&#34; does not map to Unicode at /build/libcatalyst-perl-5.90118/blib/lib/Catalyst.pm line 3668.&#34;
[error] Caught exception in engine &#34;UTF-8 &#34;\xE2&#34; does not map to Unicode at /build/libcatalyst-perl-5.90118/blib/lib/Catalyst.pm line 3668.&#34;
[error] Caught exception in engine &#34;UTF-8 &#34;\xE2&#34; does not map to Unicode at /build/libcatalyst-perl-5.90118/blib/lib/Catalyst.pm line 3668.&#34;
t/utf_incoming.t ......................................................



Thanks for considering,
  gregor herrmann,
  Debian Perl Group
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1815108" href="/Public/Bug/Display.html?id=125843#txn-1815108">#</a>      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;13&nbsp;21:51:40&nbsp;2018</span>
    <span class="description">ANDK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1815108/976649/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/976649">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 163b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Now a fatality.

Sample fail: <span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/ab00cb56-cca3-11e8-8a16-ae5ce528fe8b">http://www.cpantesters.org/cpan/report/ab00cb56-cca3-11e8-8a16-ae5ce528fe8b</a></span>

XRef: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/Ticket/Display.html?id=133585">https://rt.perl.org/Ticket/Display.html?id=133585</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1815109" href="/Public/Bug/Display.html?id=125843#txn-1815109">#</a>      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;13&nbsp;21:51:43&nbsp;2018</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1815121" href="/Public/Bug/Display.html?id=125843#txn-1815121">#</a>      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;13&nbsp;22:53:52&nbsp;2018</span>
    <span class="description">ANDK [...] cpan.org -  Broken in 5.90119 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1815234" href="/Public/Bug/Display.html?id=125843#txn-1815234">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;15&nbsp;09:54:01&nbsp;2018</span>
    <span class="description">jkeenan [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1815234/976712/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/976712">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 287b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Oct 13 21:51:40 2018, ANDK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Now a fatality.
&gt; 
&gt; Sample fail: <span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/ab00cb56-cca3-">http://www.cpantesters.org/cpan/report/ab00cb56-cca3-</a></span>
&gt; 11e8-8a16-ae5ce528fe8b
&gt; 
&gt; XRef: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/Ticket/Display.html?id=133585">https://rt.perl.org/Ticket/Display.html?id=133585</a></span>
</div>

Please evaluate the patch attached.

Thank you very much.
Jim Keenan
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Catalyst-Runtime-rtc-125843-0001-Use-IO-Handle-read-instead-of-sysread-on-UTF8.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1815234/976713/Catalyst-Runtime-rtc-125843-0001-Use-IO-Handle-read-instead-of-sysread-on-UTF8.patch">Download Catalyst-Runtime-rtc-125843-0001-Use-IO-Handle-read-instead-of-sysread-on-UTF8.patch</a><br />
<span class="downloadcontenttype">text/x-diff 3.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 42240595ec5b17a74da34cc6692be08f3383c098 Mon Sep 17 00:00:00 2001
From: James E Keenan &lt;jkeenan@cpan.org&gt;
Date: Mon, 15 Oct 2018 09:47:48 -0400
Subject: [PATCH] Use IO::Handle-&gt;read instead of -&gt;sysread on UTF8

Perl 5.30 compatibility: sysread and syswrite no longer handle UTF8
data.

References:

<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125843">https://rt.cpan.org/Ticket/Display.html?id=125843</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/Ticket/Display.html?id=133585">https://rt.perl.org/Ticket/Display.html?id=133585</a></span>
---
 lib/Catalyst/Request/Upload.pm | 35 ++++++++++++++++++++++++++--------
 t/utf_incoming.t               | 12 ++++++++----
 2 files changed, 35 insertions&#40;+&#41;, 12 deletions&#40;-&#41;

diff --git a/lib/Catalyst/Request/Upload.pm b/lib/Catalyst/Request/Upload.pm
index bf9318f6..cf25569d 100644
--- a/lib/Catalyst/Request/Upload.pm
+++ b/lib/Catalyst/Request/Upload.pm
@@ -216,12 +216,21 @@ sub slurp {
 
     binmode&#40; $handle, $layer &#41;;
 
-    $handle-&gt;seek&#40;0, IO::File::SEEK_SET&#41;;
-    while &#40; $handle-&gt;sysread&#40; my $buffer, 8192 &#41; &#41; {
-        $content .= $buffer;
+    if &#40;$self-&gt;is_utf8_encoded&#41; {
+        $handle-&gt;seek&#40;0, IO::File::SEEK_SET&#41;;
+        while &#40; $handle-&gt;read&#40; my $buffer, 8192 &#41; &#41; {
+            $content .= $buffer;
+        }
+        $handle-&gt;seek&#40;0, IO::File::SEEK_SET&#41;;
+    }
+    else {
+        $handle-&gt;seek&#40;0, IO::File::SEEK_SET&#41;;
+        while &#40; $handle-&gt;sysread&#40; my $buffer, 8192 &#41; &#41; {
+            $content .= $buffer;
+        }
+        $handle-&gt;seek&#40;0, IO::File::SEEK_SET&#41;;
     }
 
-    $handle-&gt;seek&#40;0, IO::File::SEEK_SET&#41;;
     return $content;
 }
 
@@ -238,12 +247,22 @@ sub decoded_slurp {
     my $handle = $self-&gt;decoded_fh&#40;$layer&#41;;
 
     my $content = undef;
-    $handle-&gt;seek&#40;0, IO::File::SEEK_SET&#41;;
-    while &#40; $handle-&gt;sysread&#40; my $buffer, 8192 &#41; &#41; {
-        $content .= $buffer;
+    if &#40;$self-&gt;is_utf8_encoded&#41; {
+        $handle-&gt;seek&#40;0, IO::File::SEEK_SET&#41;;
+        while &#40; $handle-&gt;read&#40; my $buffer, 8192 &#41; &#41; {
+            $content .= $buffer;
+        }
+
+        $handle-&gt;seek&#40;0, IO::File::SEEK_SET&#41;;
     }
+    else {
+        $handle-&gt;seek&#40;0, IO::File::SEEK_SET&#41;;
+        while &#40; $handle-&gt;sysread&#40; my $buffer, 8192 &#41; &#41; {
+            $content .= $buffer;
+        }
 
-    $handle-&gt;seek&#40;0, IO::File::SEEK_SET&#41;;
+        $handle-&gt;seek&#40;0, IO::File::SEEK_SET&#41;;
+    }
     return $content;
 }
 
diff --git a/t/utf_incoming.t b/t/utf_incoming.t
index 9b2b68ef..7bf85b21 100644
--- a/t/utf_incoming.t
+++ b/t/utf_incoming.t
@@ -128,10 +128,12 @@ use Scalar::Util &#40;&#41;;
     Test::More::is $upload-&gt;charset, &#39;UTF-8&#39;;
 
     my $text = $upload-&gt;slurp;
-    Test::More::is Encode::decode_utf8&#40;$text&#41;, &#34;&lt;p&gt;This is stream_body_fh action Ã¢Â™Â¥&lt;/p&gt;\n&#34;;
+    Test::More::is Encode::decode_utf8&#40;$text&#41;, &#34;&lt;p&gt;This is stream_body_fh action Ã¢Â™Â¥&lt;/p&gt;\n&#34;,
+        &#34;file_upload: slurp&#40;&#41;&#34;;
 
     my $decoded_text = $upload-&gt;decoded_slurp;
-    Test::More::is $decoded_text, &#34;&lt;p&gt;This is stream_body_fh action Ã¢Â™Â¥&lt;/p&gt;\n&#34;;
+    Test::More::is $decoded_text, &#34;&lt;p&gt;This is stream_body_fh action Ã¢Â™Â¥&lt;/p&gt;\n&#34;,
+        &#34;file_upload: decoded_slurp&#40;&#41;&#34;;
 
     Test::More::is $upload-&gt;filename, &#39;Ã¢Â™Â¥ttachment.txt&#39;;
     Test::More::is $upload-&gt;raw_basename, &#39;Ã¢Â™Â¥ttachment.txt&#39;;
@@ -148,10 +150,12 @@ use Scalar::Util &#40;&#41;;
     Test::More::is $upload-&gt;charset, &#39;UTF-8&#39;;
 
     my $text = $upload-&gt;slurp;
-    Test::More::is Encode::decode_utf8&#40;$text&#41;, &#34;&lt;p&gt;This is stream_body_fh action Ã¢Â™Â¥&lt;/p&gt;\n&#34;;
+    Test::More::is Encode::decode_utf8&#40;$text&#41;, &#34;&lt;p&gt;This is stream_body_fh action Ã¢Â™Â¥&lt;/p&gt;\n&#34;,
+        &#34;file_upload_utf8_param: slurp&#40;&#41;&#34;;
 
     my $decoded_text = $upload-&gt;decoded_slurp;
-    Test::More::is $decoded_text, &#34;&lt;p&gt;This is stream_body_fh action Ã¢Â™Â¥&lt;/p&gt;\n&#34;;
+    Test::More::is $decoded_text, &#34;&lt;p&gt;This is stream_body_fh action Ã¢Â™Â¥&lt;/p&gt;\n&#34;,
+        &#34;file_upload_utf8_param: decoded_slurp&#40;&#41;&#34;;
 
     Test::More::is $upload-&gt;filename, &#39;Ã¢Â™Â¥ttachment.txt&#39;;
     Test::More::is $upload-&gt;raw_basename, &#39;Ã¢Â™Â¥ttachment.txt&#39;;
-- 
2.17.1

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1815248" href="/Public/Bug/Display.html?id=125843#txn-1815248">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;15&nbsp;13:10:17&nbsp;2018</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1815248/976723/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/976723">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 166b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I believe ::Upload supports more encodings than just utf8 &#40;e.g. latin1, UTF-16..&#41; so we should test those encodings as well, as it&#39;s not a matter of just utf8-or-raw.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1815688" href="/Public/Bug/Display.html?id=125843#txn-1815688">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;18&nbsp;10:19:31&nbsp;2018</span>
    <span class="description">jkeenan [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1815688/976965/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/976965">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Oct 15 13:10:17 2018, ETHER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I believe ::Upload supports more encodings than just utf8 &#40;e.g.
&gt; latin1, UTF-16..&#41; so we should test those encodings as well, as it&#39;s
&gt; not a matter of just utf8-or-raw.
</div>
Extending Catalyst::Request::Upload&#39;s test coverage to other encodings is a worthy goal.  But we shouldn&#39;t wait for that to happen in order to address the specific problem discussed in this ticket:  the perl-5.30-compatibility of this module -- and, by extension, all of Catalyst&#39;s many reverse dependencies -- is impeded by the the use of the now fatalized &#39;sysread&#39; on utf8 data.

I wouldn&#39;t claim that my patch is the only way of addressing this problem, but it has some advantages:

&#40;i&#41; The patch does not change any function calls.  Hence, it does not require Catalyst users to revise their code.  Nor does it preclude the Catalyst team from implementing a better solution down the road.

&#40;ii&#41; The patch gets Catalyst-Runtime&#39;s test suite to PASS on blead perl, which means that the 5.30-compatibility of all of that distributions&#39;s reverse dependencies can be assessed.  I anticipate a lot of work in that area, particularly after this weekend&#39;s release of perl-5.29.4 -- the first monthly development release in this series with potential for a lot of CPAN &#34;breakage&#34;.

Thank you very much.
Jim Keenan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1815695" href="/Public/Bug/Display.html?id=125843#txn-1815695">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;18&nbsp;12:16:28&nbsp;2018</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1815695/976973/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/976973">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2018-10-18 07:19:31, JKEENAN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Oct 15 13:10:17 2018, ETHER wrote:
<div class="message-stanza open">&gt; &gt; I believe ::Upload supports more encodings than just utf8 &#40;e.g.
&gt; &gt; latin1, UTF-16..&#41; so we should test those encodings as well, as it&#39;s
&gt; &gt; not a matter of just utf8-or-raw.
</div>&gt; 
&gt; Extending Catalyst::Request::Upload&#39;s test coverage to other encodings
&gt; is a worthy goal.  But we shouldn&#39;t wait for that to happen in order
&gt; to address the specific problem discussed in this ticket:  the perl-
&gt; 5.30-compatibility of this module -- and, by extension, all of
&gt; Catalyst&#39;s many reverse dependencies -- is impeded by the the use of
&gt; the now fatalized &#39;sysread&#39; on utf8 data.
</div>
This is not just a question of tests. My reading of the patch was that handling of different encodings will be altered by the proposed patch. We cannot break this module for everyone on all perl versions just to get tests to pass on 5.29.

For now we can simply skip this test for 5.29, which will not fix the underlying breakage, but will give us more time to do so before 5.30.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1819300" href="/Public/Bug/Display.html?id=125843#txn-1819300">#</a>      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;13&nbsp;10:41:58&nbsp;2018</span>
    <span class="description">haarg [...] haarg.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1819300/978858/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/978858">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 24b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is fixed in 5.90122
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1819303" href="/Public/Bug/Display.html?id=125843#txn-1819303">#</a>      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;13&nbsp;10:42:01&nbsp;2018</span>
    <span class="description">haarg [...] haarg.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1819305" href="/Public/Bug/Display.html?id=125843#txn-1819305">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;13&nbsp;10:42:01&nbsp;2018</span>
    <span class="description">haarg [...] haarg.org -  Fixed in 5.90122 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.554059</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
