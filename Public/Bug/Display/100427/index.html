<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #100427 for Encode: use encoding &#34;foo&#34;, Filter=&gt;1; does not raise an exception if Filter::Util::Call cannot be used</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #100427 for Encode: use encoding &#34;foo&#34;, Filter=&gt;1; does not raise an exception if Filter::Util::Call cannot be used</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Encode/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Encode/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Encode/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Encode/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Encode">Encode CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">100427</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Encode/Active/">Encode</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ppisar [...] redhat.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
pali [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-12062-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.64    </td>
  </tr>
  <tr id="CF-12063-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;18&nbsp;10:18:10&nbsp;2014</span>
    <span class="description">ppisar [...] redhat.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> use encoding &#34;foo&#34;, Filter=&gt;1; does not raise an exception if
 Filter::Util::Call cannot be used</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Running Encode tests without Filter::Util::Call module available in the system makes t/jperl.t to fail:

$ perl -Iblib/{lib,arch} t/jperl.t
1..15
Unrecognized character \x{fffd}; marked by &lt;-- HERE after     our $&lt;-- HERE near column 10 at t/jperl.t line 90.
# Looks like your test exited with 2 before it could output anything.

The test does:

{
    use encoding &#34;euc-jp&#34;, Filter=&gt;1;
    ok&#40;1, &#34;Filter on&#34;&#41;;
    use utf8;
    no strict &#39;vars&#39;; # fools
    # doesn&#39;t work w/ &#34;my&#34; as of this writing.
    # because of  buggy strict.pm and utf8.pm
    our $人 = 2;
    #   ^^U+4eba, &#34;human&#34; in CJK ideograph
    $人++; # a child is born
    *people = \$人;
    is &#40;$people, 3, &#34;Filter:utf8 identifier&#34;&#41;;
    no encoding;
    ok&#40;1, &#34;Filter off&#34;&#41;;
}

Obviously the first ok&#40;&#41; is there to confirm the &#34;use encoding ..., Filter=&gt;1&#34; pragma succeeded. However the encoding.pm does:

    unless &#40; $arg{Filter} &#41; {
        ...
    }
    else {
        defined&#40; ${^ENCODING} &#41; and undef ${^ENCODING};

        # implicitly &#39;use utf8&#39;
        require utf8;      # to fetch $utf8::hint_bits;
        $^H |= $utf8::hint_bits;
        eval {
            require Filter::Util::Call;
            Filter::Util::Call-&gt;import;
            filter_add&#40;
                sub {
                    my $status = filter_read&#40;&#41;;
                    if &#40; $status &gt; 0 &#41; {
                        $_ = $enc-&gt;decode&#40; $_, 1 &#41;;
                        DEBUG and warn $_;
                    }
                    $status;
                }
            &#41;;
        };
        $@ eq &#39;&#39; and DEBUG and warn &#34;Filter installed&#34;;
    }

The code hides any exception by the eval, so the above-mentioned first test should succeed all the time.

I know the &#34;use encoding&#34; is deprecated, so I do not push for working on this issue or changing behavior. I&#39;m just curious why the encode.pm does pass the exception. &#40;This can be handy if the character set identifier is uknown or the source byte stream is not well-formed for the specified character set.&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;27&nbsp;03:14:00&nbsp;2014</span>
    <span class="description">DANKOGAI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The logic therein was written circa 2001.  Even I don&#39;t remember.  At any rate now that Unicode is de-facto standard for new scripts to be written, encoding.pm is no longer needed…

Dan

On Tue Nov 18 10:18:10 2014, ppisar wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Running Encode tests without Filter::Util::Call module available in
&gt; the system makes t/jperl.t to fail:
&gt; 
&gt; $ perl -Iblib/{lib,arch} t/jperl.t
&gt; 1..15
&gt; Unrecognized character \x{fffd}; marked by &lt;-- HERE after     our $&lt;--
&gt; HERE near column 10 at t/jperl.t line 90.
&gt; # Looks like your test exited with 2 before it could output anything.
&gt; 
&gt; The test does:
&gt; 
&gt; {
&gt;     use encoding &#34;euc-jp&#34;, Filter=&gt;1;
&gt;     ok&#40;1, &#34;Filter on&#34;&#41;;
&gt;     use utf8;
&gt;     no strict &#39;vars&#39;; # fools
&gt;     # doesn&#39;t work w/ &#34;my&#34; as of this writing.
&gt;     # because of  buggy strict.pm and utf8.pm
&gt;     our $人 = 2;
&gt;     #   ^^U+4eba, &#34;human&#34; in CJK ideograph
&gt;     $人++; # a child is born
&gt;     *people = \$人;
&gt;     is &#40;$people, 3, &#34;Filter:utf8 identifier&#34;&#41;;
&gt;     no encoding;
&gt;     ok&#40;1, &#34;Filter off&#34;&#41;;
&gt; }
&gt; 
&gt; Obviously the first ok&#40;&#41; is there to confirm the &#34;use encoding ...,
&gt; Filter=&gt;1&#34; pragma succeeded. However the encoding.pm does:
&gt; 
&gt; unless &#40; $arg{Filter} &#41; {
&gt;     ...
&gt; }
&gt; else {
&gt;     defined&#40; ${^ENCODING} &#41; and undef ${^ENCODING};
&gt; 
&gt; # implicitly &#39;use utf8&#39;
&gt; require utf8;      # to fetch $utf8::hint_bits;
&gt; $^H |= $utf8::hint_bits;
&gt; eval {
&gt;     require Filter::Util::Call;
&gt;     Filter::Util::Call-&gt;import;
&gt;     filter_add&#40;
&gt;         sub {
&gt;             my $status = filter_read&#40;&#41;;
&gt;             if &#40; $status &gt; 0 &#41; {
&gt;                 $_ = $enc-&gt;decode&#40; $_, 1 &#41;;
&gt;                 DEBUG and warn $_;
&gt;             }
&gt;             $status;
&gt;         }
&gt;     &#41;;
&gt; };
&gt; $@ eq &#39;&#39; and DEBUG and warn &#34;Filter installed&#34;;
&gt; }
&gt; 
&gt; The code hides any exception by the eval, so the above-mentioned first
&gt; test should succeed all the time.
&gt; 
&gt; I know the &#34;use encoding&#34; is deprecated, so I do not push for working
&gt; on this issue or changing behavior. I&#39;m just curious why the encode.pm
&gt; does pass the exception. &#40;This can be handy if the character set
&gt; identifier is uknown or the source byte stream is not well-formed for
&gt; the specified character set.&#41;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;27&nbsp;03:14:00&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;02&nbsp;04:40:33&nbsp;2017</span>
    <span class="description">pali [...] cpan.org -  Cc PALI added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;02&nbsp;04:45:06&nbsp;2017</span>
    <span class="description">pali [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">That code should not be executed in eval, but rather directly with throwing exceptions back to that caller. &#34;use encoding&#34; must ensure that used filter is installed and used. Otherwise it is fatal error as following code is written in different encoding...

Dan, will you fix it and remove eval wrapper? &#39;use encoding&#39; is removed in Perl 5.26, but not &#39;use encoding, Filter&#39; which is still working. See: <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/release/XSAWYERX/perl-5.26.0/pod/perldelta.pod#The-${^ENCODING}-facility-has-been-removed">https://metacpan.org/pod/release/XSAWYERX/perl-5.26.0/pod/perldelta.pod#The-${^ENCODING}-facility-has-been-removed</a></span>

Therefore Filter encoding should be fixed.

On Thu Nov 27 03:14:00 2014, DANKOGAI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The logic therein was written circa 2001.  Even I don&#39;t remember.  At
&gt; any rate now that Unicode is de-facto standard for new scripts to be
&gt; written, encoding.pm is no longer needed…
&gt; 
&gt; Dan
&gt; 
&gt; On Tue Nov 18 10:18:10 2014, ppisar wrote:
<div class="message-stanza open">&gt; &gt; Running Encode tests without Filter::Util::Call module available in
&gt; &gt; the system makes t/jperl.t to fail:
&gt; &gt;
&gt; &gt; $ perl -Iblib/{lib,arch} t/jperl.t
&gt; &gt; 1..15
&gt; &gt; Unrecognized character \x{fffd}; marked by &lt;-- HERE after     our
&gt; &gt; $&lt;--
&gt; &gt; HERE near column 10 at t/jperl.t line 90.
&gt; &gt; # Looks like your test exited with 2 before it could output anything.
&gt; &gt;
&gt; &gt; The test does:
&gt; &gt;
&gt; &gt; {
&gt; &gt;     use encoding &#34;euc-jp&#34;, Filter=&gt;1;
&gt; &gt;     ok&#40;1, &#34;Filter on&#34;&#41;;
&gt; &gt;     use utf8;
&gt; &gt;     no strict &#39;vars&#39;; # fools
&gt; &gt;     # doesn&#39;t work w/ &#34;my&#34; as of this writing.
&gt; &gt;     # because of  buggy strict.pm and utf8.pm
&gt; &gt;     our $人 = 2;
&gt; &gt;     #   ^^U+4eba, &#34;human&#34; in CJK ideograph
&gt; &gt;     $人++; # a child is born
&gt; &gt;     *people = \$人;
&gt; &gt;     is &#40;$people, 3, &#34;Filter:utf8 identifier&#34;&#41;;
&gt; &gt;     no encoding;
&gt; &gt;     ok&#40;1, &#34;Filter off&#34;&#41;;
&gt; &gt; }
&gt; &gt;
&gt; &gt; Obviously the first ok&#40;&#41; is there to confirm the &#34;use encoding ...,
&gt; &gt; Filter=&gt;1&#34; pragma succeeded. However the encoding.pm does:
&gt; &gt;
&gt; &gt; unless &#40; $arg{Filter} &#41; {
&gt; &gt;     ...
&gt; &gt; }
&gt; &gt; else {
&gt; &gt;     defined&#40; ${^ENCODING} &#41; and undef ${^ENCODING};
&gt; &gt;
&gt; &gt; # implicitly &#39;use utf8&#39;
&gt; &gt; require utf8;      # to fetch $utf8::hint_bits;
&gt; &gt; $^H |= $utf8::hint_bits;
&gt; &gt; eval {
&gt; &gt;     require Filter::Util::Call;
&gt; &gt;     Filter::Util::Call-&gt;import;
&gt; &gt;     filter_add&#40;
&gt; &gt;         sub {
&gt; &gt;             my $status = filter_read&#40;&#41;;
&gt; &gt;             if &#40; $status &gt; 0 &#41; {
&gt; &gt;                 $_ = $enc-&gt;decode&#40; $_, 1 &#41;;
&gt; &gt;                 DEBUG and warn $_;
&gt; &gt;             }
&gt; &gt;             $status;
&gt; &gt;         }
&gt; &gt;     &#41;;
&gt; &gt; };
&gt; &gt; $@ eq &#39;&#39; and DEBUG and warn &#34;Filter installed&#34;;
&gt; &gt; }
&gt; &gt;
&gt; &gt; The code hides any exception by the eval, so the above-mentioned
&gt; &gt; first
&gt; &gt; test should succeed all the time.
&gt; &gt;
&gt; &gt; I know the &#34;use encoding&#34; is deprecated, so I do not push for working
&gt; &gt; on this issue or changing behavior. I&#39;m just curious why the
&gt; &gt; encode.pm
&gt; &gt; does pass the exception. &#40;This can be handy if the character set
&gt; &gt; identifier is uknown or the source byte stream is not well-formed for
&gt; &gt; the specified character set.&#41;
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;29&nbsp;08:35:36&nbsp;2017</span>
    <span class="description">pali [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">In attachment is a patch with proposed fix. ppisar, can you test this patch if it fixes problem which you reported?

On Fri Jun 02 04:45:06 2017, PALI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That code should not be executed in eval, but rather directly with
&gt; throwing exceptions back to that caller. &#34;use encoding&#34; must ensure
&gt; that used filter is installed and used. Otherwise it is fatal error as
&gt; following code is written in different encoding...
&gt; 
&gt; Dan, will you fix it and remove eval wrapper? &#39;use encoding&#39; is
&gt; removed in Perl 5.26, but not &#39;use encoding, Filter&#39; which is still
&gt; working. See: <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/release/XSAWYERX/perl-">https://metacpan.org/pod/release/XSAWYERX/perl-</a></span>
&gt; 5.26.0/pod/perldelta.pod#The-${^ENCODING}-facility-has-been-removed
&gt; 
&gt; Therefore Filter encoding should be fixed.
&gt; 
&gt; On Thu Nov 27 03:14:00 2014, DANKOGAI wrote:
<div class="message-stanza open">&gt; &gt; The logic therein was written circa 2001.  Even I don&#39;t remember.  At
&gt; &gt; any rate now that Unicode is de-facto standard for new scripts to be
&gt; &gt; written, encoding.pm is no longer needed…
&gt; &gt;
&gt; &gt; Dan
&gt; &gt;
&gt; &gt; On Tue Nov 18 10:18:10 2014, ppisar wrote:
<div class="message-stanza open">&gt; &gt; &gt; Running Encode tests without Filter::Util::Call module available in
&gt; &gt; &gt; the system makes t/jperl.t to fail:
&gt; &gt; &gt;
&gt; &gt; &gt; $ perl -Iblib/{lib,arch} t/jperl.t
&gt; &gt; &gt; 1..15
&gt; &gt; &gt; Unrecognized character \x{fffd}; marked by &lt;-- HERE after     our
&gt; &gt; &gt; $&lt;--
&gt; &gt; &gt; HERE near column 10 at t/jperl.t line 90.
&gt; &gt; &gt; # Looks like your test exited with 2 before it could output
&gt; &gt; &gt; anything.
&gt; &gt; &gt;
&gt; &gt; &gt; The test does:
&gt; &gt; &gt;
&gt; &gt; &gt; {
&gt; &gt; &gt;     use encoding &#34;euc-jp&#34;, Filter=&gt;1;
&gt; &gt; &gt;     ok&#40;1, &#34;Filter on&#34;&#41;;
&gt; &gt; &gt;     use utf8;
&gt; &gt; &gt;     no strict &#39;vars&#39;; # fools
&gt; &gt; &gt;     # doesn&#39;t work w/ &#34;my&#34; as of this writing.
&gt; &gt; &gt;     # because of  buggy strict.pm and utf8.pm
&gt; &gt; &gt;     our $人 = 2;
&gt; &gt; &gt;     #   ^^U+4eba, &#34;human&#34; in CJK ideograph
&gt; &gt; &gt;     $人++; # a child is born
&gt; &gt; &gt;     *people = \$人;
&gt; &gt; &gt;     is &#40;$people, 3, &#34;Filter:utf8 identifier&#34;&#41;;
&gt; &gt; &gt;     no encoding;
&gt; &gt; &gt;     ok&#40;1, &#34;Filter off&#34;&#41;;
&gt; &gt; &gt; }
&gt; &gt; &gt;
&gt; &gt; &gt; Obviously the first ok&#40;&#41; is there to confirm the &#34;use encoding ...,
&gt; &gt; &gt; Filter=&gt;1&#34; pragma succeeded. However the encoding.pm does:
&gt; &gt; &gt;
&gt; &gt; &gt; unless &#40; $arg{Filter} &#41; {
&gt; &gt; &gt;     ...
&gt; &gt; &gt; }
&gt; &gt; &gt; else {
&gt; &gt; &gt;     defined&#40; ${^ENCODING} &#41; and undef ${^ENCODING};
&gt; &gt; &gt;
&gt; &gt; &gt; # implicitly &#39;use utf8&#39;
&gt; &gt; &gt; require utf8;      # to fetch $utf8::hint_bits;
&gt; &gt; &gt; $^H |= $utf8::hint_bits;
&gt; &gt; &gt; eval {
&gt; &gt; &gt;     require Filter::Util::Call;
&gt; &gt; &gt;     Filter::Util::Call-&gt;import;
&gt; &gt; &gt;     filter_add&#40;
&gt; &gt; &gt;         sub {
&gt; &gt; &gt;             my $status = filter_read&#40;&#41;;
&gt; &gt; &gt;             if &#40; $status &gt; 0 &#41; {
&gt; &gt; &gt;                 $_ = $enc-&gt;decode&#40; $_, 1 &#41;;
&gt; &gt; &gt;                 DEBUG and warn $_;
&gt; &gt; &gt;             }
&gt; &gt; &gt;             $status;
&gt; &gt; &gt;         }
&gt; &gt; &gt;     &#41;;
&gt; &gt; &gt; };
&gt; &gt; &gt; $@ eq &#39;&#39; and DEBUG and warn &#34;Filter installed&#34;;
&gt; &gt; &gt; }
&gt; &gt; &gt;
&gt; &gt; &gt; The code hides any exception by the eval, so the above-mentioned
&gt; &gt; &gt; first
&gt; &gt; &gt; test should succeed all the time.
&gt; &gt; &gt;
&gt; &gt; &gt; I know the &#34;use encoding&#34; is deprecated, so I do not push for
&gt; &gt; &gt; working
&gt; &gt; &gt; on this issue or changing behavior. I&#39;m just curious why the
&gt; &gt; &gt; encode.pm
&gt; &gt; &gt; does pass the exception. &#40;This can be handy if the character set
&gt; &gt; &gt; identifier is uknown or the source byte stream is not well-formed
&gt; &gt; &gt; for
&gt; &gt; &gt; the specified character set.&#41;
</div></div></div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Propagate-fatal-errors-from-the-encoding-pragma-back.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 020c0a8a6e9a3858d78c672e59e1f6babfd5627f Mon Sep 17 00:00:00 2001
From: Pali &lt;pali@cpan.org&gt;
Date: Fri, 29 Sep 2017 14:31:33 +0200
Subject: [PATCH] Propagate fatal errors from the encoding pragma back to the
 caller

In some cases &#40;e.g. when Filter::Util::Call module is not available&#41;,
encoding pragma would not work. So caller should get fatal error message
instead of continuous execution of the wrong code.
---
 encoding.pm | 12 ++----------
 1 file changed, 2 insertions&#40;+&#41;, 10 deletions&#40;-&#41;

diff --git a/encoding.pm b/encoding.pm
index 7cd9eb2..651a158 100644
--- a/encoding.pm
+++ b/encoding.pm
@@ -176,7 +176,7 @@ sub import {
         # implicitly &#39;use utf8&#39;
         require utf8;      # to fetch $utf8::hint_bits;
         $^H |= $utf8::hint_bits;
-        eval {
+
             require Filter::Util::Call;
             Filter::Util::Call-&gt;import;
             filter_add&#40;
@@ -189,8 +189,6 @@ sub import {
                     $status;
                 }
             &#41;;
-            1;
-        } and DEBUG and warn &#34;Filter installed&#34;;
     }
     defined ${^UNICODE} and ${^UNICODE} != 0 and return 1;
     for my $h &#40;qw&#40;STDIN STDOUT&#41;&#41; {
@@ -200,20 +198,14 @@ sub import {
                 Carp::croak&#40;
                     &#34;encoding: Unknown encoding for $h, &#39;$arg{$h}&#39;&#34;&#41;;
             }
-            eval { binmode&#40; $h, &#34;:raw :encoding&#40;$arg{$h}&#41;&#34; &#41; };
+            binmode&#40; $h, &#34;:raw :encoding&#40;$arg{$h}&#41;&#34; &#41;;
         }
         else {
             unless &#40; exists $arg{$h} &#41; {
-                eval {
                     no warnings &#39;uninitialized&#39;;
                     binmode&#40; $h, &#34;:raw :encoding&#40;$name&#41;&#34; &#41;;
-                };
             }
         }
-        if &#40;$@&#41; {
-            require Carp;
-            Carp::croak&#40;$@&#41;;
-        }
     }
     return 1;    # I doubt if we need it, though
 }
-- 
2.11.0

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;29&nbsp;09:16:00&nbsp;2017</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #100427] use encoding &#34;foo&#34;, Filter=&gt;1; does not raise an exception if Filter::Util::Call cannot be used</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 29 Sep 2017 15:15:58 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Pali via RT &lt;bug-Encode [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Petr Pisar &lt;ppisar [...] redhat.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Sep 29, 2017 at 08:35:37AM -0400, Pali via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In attachment is a patch with proposed fix. ppisar, can you test this patch
&gt; if it fixes problem which you reported?
&gt; 
</div>Latest Encode-2.92 skips the test on Perl 5.26. When I run the test on
different host with Perl 5.22.3, I can reproduce the bug and after applying
your patch, the test fails with expected error now:

$ perl -Iblib/{lib,arch} t/jperl.t                            1..15
Can&#39;t locate Filter/Util/Call.pm in @INC &#40;you may need to install the Filter::Util::Call module&#41; &#40;@INC contains: blib/lib blib/arch /usr/local/lib64/perl5 /usr/local/share/perl5 /usr/lib64/perl5/vendor_perl /usr/share/perl5/vendor_perl /usr/lib64/perl5 /usr/share/perl5 .&#41; at blib/lib/encoding.pm line 180.
BEGIN failed--compilation aborted at t/jperl.t line 88.
# Looks like your test exited with 2 before it could output anything.

So I think it fixes the problem.

Next step could be adding a dependency on Filter::Util::Call into META.

Thank you for looking into this issue.

-- Petr
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;29&nbsp;09:21:26&nbsp;2017</span>
    <span class="description">pali [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Sep 29 09:16:00 2017, ppisar wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri, Sep 29, 2017 at 08:35:37AM -0400, Pali via RT wrote:
<div class="message-stanza open">&gt; &gt; In attachment is a patch with proposed fix. ppisar, can you test this
&gt; &gt; patch
&gt; &gt; if it fixes problem which you reported?
&gt; &gt;
</div>&gt; Latest Encode-2.92 skips the test on Perl 5.26. When I run the test on
&gt; different host with Perl 5.22.3, I can reproduce the bug and after
&gt; applying
&gt; your patch, the test fails with expected error now:
&gt; 
&gt; $ perl -Iblib/{lib,arch} t/jperl.t                            1..15
&gt; Can&#39;t locate Filter/Util/Call.pm in @INC &#40;you may need to install the
&gt; Filter::Util::Call module&#41; &#40;@INC contains: blib/lib blib/arch
&gt; /usr/local/lib64/perl5 /usr/local/share/perl5
&gt; /usr/lib64/perl5/vendor_perl /usr/share/perl5/vendor_perl
&gt; /usr/lib64/perl5 /usr/share/perl5 .&#41; at blib/lib/encoding.pm line 180.
&gt; BEGIN failed--compilation aborted at t/jperl.t line 88.
&gt; # Looks like your test exited with 2 before it could output anything.
&gt; 
&gt; So I think it fixes the problem.
</div>
Ok.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Next step could be adding a dependency on Filter::Util::Call into
&gt; META.
</div>
Looking at corelist...

$ corelist Filter::Util::Call

Data for 2017-01-14
Filter::Util::Call was first released with perl v5.7.3

... it tells me that Filter::Util::Call is part of perl itself since v5.7.3. So this is looks like a problem with your installation of perl, you should have Filter::Util::Call available.

But adding perl 5.8 into META seems like a good idea. It should fix also problem with Filter::Util::Call.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;30&nbsp;08:28:31&nbsp;2017</span>
    <span class="description">pali [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Pia Sep 29 09:21:26 2017, PALI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Sep 29 09:16:00 2017, ppisar wrote:
<div class="message-stanza open">&gt; &gt; On Fri, Sep 29, 2017 at 08:35:37AM -0400, Pali via RT wrote:
<div class="message-stanza open">&gt; &gt; &gt; In attachment is a patch with proposed fix. ppisar, can you test
&gt; &gt; &gt; this
&gt; &gt; &gt; patch
&gt; &gt; &gt; if it fixes problem which you reported?
&gt; &gt; &gt;
</div>&gt; &gt; Latest Encode-2.92 skips the test on Perl 5.26. When I run the test
&gt; &gt; on
&gt; &gt; different host with Perl 5.22.3, I can reproduce the bug and after
&gt; &gt; applying
&gt; &gt; your patch, the test fails with expected error now:
&gt; &gt;
&gt; &gt; $ perl -Iblib/{lib,arch} t/jperl.t                            1..15
&gt; &gt; Can&#39;t locate Filter/Util/Call.pm in @INC &#40;you may need to install the
&gt; &gt; Filter::Util::Call module&#41; &#40;@INC contains: blib/lib blib/arch
&gt; &gt; /usr/local/lib64/perl5 /usr/local/share/perl5
&gt; &gt; /usr/lib64/perl5/vendor_perl /usr/share/perl5/vendor_perl
&gt; &gt; /usr/lib64/perl5 /usr/share/perl5 .&#41; at blib/lib/encoding.pm line
&gt; &gt; 180.
&gt; &gt; BEGIN failed--compilation aborted at t/jperl.t line 88.
&gt; &gt; # Looks like your test exited with 2 before it could output anything.
&gt; &gt;
&gt; &gt; So I think it fixes the problem.
</div>&gt; 
&gt; Ok.
</div>
I created pull request with this patch:
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dankogai/p5-encode/pull/123">https://github.com/dankogai/p5-encode/pull/123</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;30&nbsp;08:45:19&nbsp;2017</span>
    <span class="description">DANKOGAI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Pulled.

Dan the Maintainer Thereof

On Sat Sep 30 08:28:31 2017, PALI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Pia Sep 29 09:21:26 2017, PALI wrote:
<div class="message-stanza open">&gt; &gt; On Fri Sep 29 09:16:00 2017, ppisar wrote:
<div class="message-stanza open">&gt; &gt; &gt; On Fri, Sep 29, 2017 at 08:35:37AM -0400, Pali via RT wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; In attachment is a patch with proposed fix. ppisar, can you test
&gt; &gt; &gt; &gt; this
&gt; &gt; &gt; &gt; patch
&gt; &gt; &gt; &gt; if it fixes problem which you reported?
&gt; &gt; &gt; &gt;
</div>&gt; &gt; &gt; Latest Encode-2.92 skips the test on Perl 5.26. When I run the test
&gt; &gt; &gt; on
&gt; &gt; &gt; different host with Perl 5.22.3, I can reproduce the bug and after
&gt; &gt; &gt; applying
&gt; &gt; &gt; your patch, the test fails with expected error now:
&gt; &gt; &gt;
&gt; &gt; &gt; $ perl -Iblib/{lib,arch} t/jperl.t                            1..15
&gt; &gt; &gt; Can&#39;t locate Filter/Util/Call.pm in @INC &#40;you may need to install the
&gt; &gt; &gt; Filter::Util::Call module&#41; &#40;@INC contains: blib/lib blib/arch
&gt; &gt; &gt; /usr/local/lib64/perl5 /usr/local/share/perl5
&gt; &gt; &gt; /usr/lib64/perl5/vendor_perl /usr/share/perl5/vendor_perl
&gt; &gt; &gt; /usr/lib64/perl5 /usr/share/perl5 .&#41; at blib/lib/encoding.pm line
&gt; &gt; &gt; 180.
&gt; &gt; &gt; BEGIN failed--compilation aborted at t/jperl.t line 88.
&gt; &gt; &gt; # Looks like your test exited with 2 before it could output anything.
&gt; &gt; &gt;
&gt; &gt; &gt; So I think it fixes the problem.
</div>&gt; &gt; 
&gt; &gt; Ok.
</div>&gt; 
&gt; I created pull request with this patch:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dankogai/p5-encode/pull/123">https://github.com/dankogai/p5-encode/pull/123</a></span>
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;30&nbsp;08:45:20&nbsp;2017</span>
    <span class="description">DANKOGAI [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
