<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #78069 for AnyEvent-FreeSWITCH: Example event loop script.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #78069 for AnyEvent-FreeSWITCH: Example event loop script.</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=AnyEvent-FreeSWITCH">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=AnyEvent-FreeSWITCH">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=AnyEvent-FreeSWITCH">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=AnyEvent-FreeSWITCH">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/AnyEvent-FreeSWITCH">AnyEvent-FreeSWITCH CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">78069</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=AnyEvent-FreeSWITCH">AnyEvent-FreeSWITCH</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
LOTTC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-243316-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-243317-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




fsevent-example.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1093941/575042/fsevent-example.pl">
Wed Jun 27 09:48:25 2012 (3.7k) by LOTTC [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=78069">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1093941" href="/Public/Bug/Display.html?id=78069#txn-1093941">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;27&nbsp;09:48:25&nbsp;2012</span>
    <span class="description">LOTTC [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Example event loop script.</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1093941/575041/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/575041">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 458b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

I put together a small script using your module.  I really couldn&#39;t find 
any good examples of how exactly to use your module...and it would be 
nice to have something like this included with the source.

While most of it is pretty straight forward, I ordered the callbacks in 
such a way that they detect if the connection is lost and reconnect if 
needed.

Anyway, it could help others get up and going faster...feel free to use 
it.

-Lott Caskey
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> fsevent-example.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1093941/575042/fsevent-example.pl">Download fsevent-example.pl</a><br />
<span class="downloadcontenttype">text/x-perl 3.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

# fsevent-example.pl
#  - Lott Caskey &lt;lottcaskey@gmail.com&gt;

use strict;
use AnyEvent;
use AnyEvent::FreeSWITCH;
use JSON::XS;
use Data::Dumper;
use ESL;

$|++;

my $debug = 0;

my $fshost = &#39;127.0.0.1&#39;;
my $fsport = &#39;8021&#39;;
my $fspass = &#39;ClueCon&#39;;
my $fsevnt = &#39;all&#39;;

my $cv = AnyEvent-&gt;condvar;
my $fs = AnyEvent::FreeSWITCH-&gt;new&#40;host=&gt;$fshost, port=&gt;$fsport, password=&gt;$fspass, events=&gt;$fsevnt&#41;;


# When &#34;connect&#34; event is called, we call the connect method.
$fs-&gt;reg_cb&#40; connect =&gt; sub {
        my $self = shift;
        $self-&gt;connect&#40;&#41;;
    }
&#41;;

# If &#34;connect&#34; was successful, the &#34;connected&#34; event below is triggered and we
# send a message to STDERR with the good news. We then setup a timer to check
# the connection every 5 seconds.  If the connection fails, we alert STDERR
# and trigger the &#34;connect&#34; event.
$fs-&gt;reg_cb&#40; connected =&gt; sub {
        my $self = shift;
        print STDERR &#34;Connected!\n&#34;;
        $self-&gt;{connection_timer} = AnyEvent-&gt;timer&#40;
            after =&gt; 5, interval =&gt; 5, cb =&gt; sub {
                unless &#40;$self-&gt;is_connected&#40;&#41;&#41; {
                    $self-&gt;{connection_timer} = undef;
                    print STDERR &#34;Lost Connection, trying to reconnect.\n&#34;;
                    $self-&gt;event&#40;&#39;connect&#39;&#41;;
                }
            }
        &#41;;
    }
&#41;;

# If &#34;connect&#34; was not successful, send the given error to STDERR and then
# schedule a &#34;connect&#34; event to reattempt.
$fs-&gt;reg_cb&#40; connection_error =&gt; sub {
        my &#40;$self, $error&#41; = @_;
        print STDERR $error.&#34;\n&#34;;
        my $wait_one_sec = AnyEvent-&gt;timer&#40;
            after =&gt; 2, interva =&gt; 0, cb =&gt; sub {
                print STDERR &#34;Retrying...\n&#34;;
                $self-&gt;event&#40;&#39;connect&#39;&#41;;
            }
        &#41;
    }
&#41;;

# Captures each FreeSWITCH event, with &#34;event_name&#34; containing the event
# command and &#34;event_headers&#34; containing a hashref of the all the event details.
# Setting debug to 1 will output the recieved event names to STDERR and
# allow you to figure out which &#34;event_*&#34; callbacks you need to define.
# Setting debug to 2 will output the event headers to STDERR for all events.
$fs-&gt;reg_cb&#40; recv_event =&gt; sub {
        my &#40;$self, $event_name, $data, $blah&#41; = @_;
        my $event_headers = decode_json&#40;$data&#41;;
        print STDERR $self-&gt;event_name.&#39;: &#39;.$event_name.&#39;: &#39;.$event_headers-&gt;{&#39;Core-UUID&#39;}.&#34;\n&#34; if &#40;defined&#40;$self-&gt;{debug}&#41; and $self-&gt;{debug}&gt;0&#41;;
        print STDERR $self-&gt;event_name.&#39;: &#39;.Data::Dumper-&gt;new&#40;[$event_headers]&#41;-&gt;Indent&#40;1&#41;-&gt;Terse&#40;1&#41;-&gt;Sortkeys&#40;1&#41;-&gt;Dump&#40;&#41;.&#34;\n\n&#34; if &#40;defined&#40;$self-&gt;{debug}&#41; and $self-&gt;{debug}&gt;1&#41;;
    }
&#41;;

# Capture individual FreeSWITCH events by using the callback id &#34;event_&#34; and the event name. 
# The callback &#34;event_HEARTBEAT&#34; is capturing the FreeSWITCH &#34;heartbeat&#34; event and then
# displaying the details of the message.
$fs-&gt;reg_cb&#40; event_HEARTBEAT =&gt; sub {
        my &#40;$self, $data&#41; = @_;
        my $event_headers = decode_json&#40;$data&#41;;
        print STDERR $self-&gt;event_name.&#39;: &#39;.$event_headers-&gt;{&#39;Event-Name&#39;}.&#39;: &#39;.$event_headers-&gt;{&#39;Core-UUID&#39;}.&#34;\n&#34;.Data::Dumper-&gt;new&#40;[$event_headers]&#41;-&gt;Indent&#40;1&#41;-&gt;Terse&#40;1&#41;-&gt;Sortkeys&#40;1&#41;-&gt;Dump&#40;&#41;.&#34;\n\n&#34;;
    }
&#41;;
$fs-&gt;reg_cb&#40; event_API =&gt; sub {
        my &#40;$self, $data&#41; = @_;
        my $event_headers = decode_json&#40;$data&#41;;
        #print STDERR &#34;a&#34;;
    }
&#41;;
$fs-&gt;reg_cb&#40; event_PRESENCE_IN =&gt; sub {
        my &#40;$self, $data&#41; = @_;
        my $event_headers = decode_json&#40;$data&#41;;
        #print STDERR &#39;p&#39;;
    }
&#41;;

# Register an event to catch any changes to the debug level.
$fs-&gt;reg_cb&#40; set_debug =&gt; sub { my &#40;$self, $debug&#41; = @_; $self-&gt;{debug} = &#40;defined&#40;$debug&#41; and $debug=~/^[+-]?\d+$/&#41; ? &#40;$debug*1&#41; : 0; }&#41;;
$fs-&gt;event&#40;&#39;set_debug&#39;, $debug&#41;;

# Send the &#34;connect&#34; event to start our loop.
$fs-&gt;event&#40;&#39;connect&#39;&#41;;

print STDERR &#34;Starting Main Loop.\n&#34;;
$cv-&gt;recv;
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.226638</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
