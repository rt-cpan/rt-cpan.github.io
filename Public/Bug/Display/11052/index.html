<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #11052 for Plucene: QueryParser should pass correct field name when tokenizing</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #11052 for Plucene: QueryParser should pass correct field name when tokenizing</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Plucene">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Plucene">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Plucene">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Plucene">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Plucene">Plucene CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">11052</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Plucene">Plucene</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
spam2 [...] mcdanielhome.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-25988-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.20    </td>
  </tr>
  <tr id="CF-25989-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




QueryParser.pm<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/121462/30007/QueryParser.pm">
Tue Jan 18 11:51:09 2005 (8.8k) by 
</a>
</font></li>
</ul>


testbug.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/121464/30449/testbug.pl">
Sun Jan 23 17:01:17 2005 (2.7k) by 
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=11052">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-121462" href="/Public/Bug/Display.html?id=11052#txn-121462">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;18&nbsp;11:51:09&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> QueryParser should pass correct field name when tokenizing</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/121462/30006/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/30006">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Distribution: Plucene-1.20
Perl version: ActiveState 5.8.6 build 811
OS: Windows XP

The current version QueryParser.pm always passes the name of its default field to the analyzer &#40;via its call to the analyzer&#39;s tokenstream function&#41;. For queries of the form &#34;FieldName:BasicClause&#34;, QueryParser should instead pass &#34;FieldName&#34; to the analyzer. I have verified that Java Lucene behaves this way.

I have made the following simple changes to QueryParser.pm &#40;attached file&#41; on my system and they fix the problem. I have not regression tested them.

C:\Perl\site\lib\Plucene&gt;diff QueryParser.pm.bak QueryParser.pm
101c101
&lt;                       $item-&gt;{term}  = $self-&gt;_tokenize&#40;$extracted&#41;;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;                       $item-&gt;{term}  = $self-&gt;_tokenize&#40;$extracted, $item-&gt;{field}&#41;;
</div>104c104
&lt;                       $item-&gt;{term}  = $self-&gt;_tokenize&#40;$1&#41;;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;                       $item-&gt;{term}  = $self-&gt;_tokenize&#40;$1, $item-&gt;{field}&#41;;
</div>108c108
&lt;                       $item-&gt;{term}  = $self-&gt;_tokenize&#40;$1&#41;;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;                       $item-&gt;{term}  = $self-&gt;_tokenize&#40;$1, $item-&gt;{field}&#41;;
</div>125c125
&lt;       my &#40;$self, $image&#41; = @_;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       my &#40;$self, $image, $field&#41; = @_;
</div>127c127
&lt;                       field  =&gt; $self-&gt;{default},
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;                       field  =&gt; $field || $self-&gt;{default},
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/121462/30007/QueryParser.pm">Download QueryParser.pm</a><br />
<span class="downloadcontenttype">text/x-perl 8.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">package Plucene::QueryParser;

use strict;
use warnings;

use base &#39;Class::Accessor::Fast&#39;;

use Carp &#39;croak&#39;;
use IO::Scalar;
use Text::Balanced qw&#40;extract_delimited extract_bracketed&#41;;
our $DefaultOperator = &#34;OR&#34;;

__PACKAGE__-&gt;mk_accessors&#40;qw&#40;analyzer default&#41;&#41;;

=head1 NAME

Plucene::QueryParser - Turn query strings into Plucene::Search::Query objects

=head1 SYNOPSIS

	my $p = Plucene::QueryParser-&gt;new&#40;{
		analyzer =&gt; Plucene::Analysis::Analyzer $a,
		default  =&gt; &#34;text&#34;
	}&#41;;

	my Plucene::Search::Query $q = $p-&gt;parse&#40;&#34;foo bar:baz&#34;&#41;;

=head1 DESCRIPTION

This module is responsible for turning a query string into a
Plucene::Query object. It needs to have an Analyzer object to help it
tokenize incoming queries, and it also needs to know the default field
to be used if no field is given in the query string.

=head1 METHODS

=head2 new

	my $p = Plucene::QueryParser-&gt;new&#40;{
		analyzer =&gt; Plucene::Analysis::Analyzer $a,
		default  =&gt; &#34;text&#34;
	}&#41;;

Construct a new query parser

=cut

sub new {
	my $self = shift-&gt;SUPER::new&#40;@_&#41;;
	croak &#34;You need to pass an analyzer&#34;
		unless UNIVERSAL::isa&#40;$self-&gt;{analyzer}, &#34;Plucene::Analysis::Analyzer&#34;&#41;;
	croak &#34;No default field name supplied!&#34; unless $self-&gt;{default};
	return $self;
}

=head2 parse

	my Plucene::Search::Query $q = $p-&gt;parse&#40;&#34;foo bar:baz&#34;&#41;;

Turns the string into a query object.

=cut

sub parse {
	my $self = shift;
	local $_ = shift;
	my $ast = shift;
	my @rv;
	while &#40;$_&#41; {
		s/^\s+// and next;
		my $item;
		$item-&gt;{conj} = &#34;NONE&#34;;
		s/^&#40;AND|OR|\|\|&#41;\s+//i;
		if &#40;$1&#41; {
			$item-&gt;{conj} = uc $1;
			$item-&gt;{conj} = &#34;OR&#34;
				if $item-&gt;{conj} eq &#34;||&#34;;
		}
		if    &#40;s/^\+//&#41;            { $item-&gt;{mods} = &#34;REQ&#34;; }
		elsif &#40;s/^&#40;-|!|NOT&#41;\s*//i&#41; { $item-&gt;{mods} = &#34;NOT&#34;; }
		else { $item-&gt;{mods} = &#34;NONE&#34;; }

		if &#40;s/^&#40;[^\s&#40;&#34;:]+&#41;://&#41; { $item-&gt;{field} = $1 }

		# Subquery
		if &#40;/^\&#40;/&#41; {
			my &#40;$extracted, $remainer&#41; = extract_bracketed&#40;$_, &#34;&#40;&#34;&#41;;
			if &#40;!$extracted&#41; { croak &#34;Unbalanced subquery&#34; }
			$_ = $remainer;
			$extracted =~ s/^\&#40;//;
			$extracted =~ s/\&#41;$//;
			$item-&gt;{query} = &#34;SUBQUERY&#34;;
			$item-&gt;{subquery} = $self-&gt;parse&#40;$extracted, 1&#41;;
		} elsif &#40;/^&#34;/&#41; {
			my &#40;$extracted, $remainer&#41; = extract_delimited&#40;$_, &#39;&#34;&#39;&#41;;
			if &#40;!$extracted&#41; { croak &#34;Unbalanced phrase&#34; }
			$_ = $remainer;
			$extracted =~ s/^&#34;//;
			$extracted =~ s/&#34;$//;
			$item-&gt;{query} = &#34;PHRASE&#34;;
			$item-&gt;{term}  = $self-&gt;_tokenize&#40;$extracted, $item-&gt;{field}&#41;;
		} elsif &#40;s/^&#40;\S+&#41;\*//&#41; {
			$item-&gt;{query} = &#34;PREFIX&#34;;
			$item-&gt;{term}  = $self-&gt;_tokenize&#40;$1, $item-&gt;{field}&#41;;
		} else {
			s/&#40;[^\s\^]+&#41;// or croak &#34;Malformed query&#34;;
			$item-&gt;{query} = &#34;TERM&#34;;
			$item-&gt;{term}  = $self-&gt;_tokenize&#40;$1, $item-&gt;{field}&#41;;
			if &#40;$item-&gt;{term} =~ / /&#41; { $item-&gt;{query} = &#34;PHRASE&#34;; }
		}
		s/^~&#40;\d+&#41;// and $item-&gt;{slop} = $1;
		if &#40;s/^\^&#40;\d+&#40;?:.\d+&#41;?&#41;//&#41; { $item-&gt;{boost} = $1 }

		push @rv, bless $item,
			&#34;Plucene::QueryParser::&#34; . ucfirst lc $item-&gt;{query};
	}
	my $obj = bless \@rv, &#34;Plucene::QueryParser::TopLevel&#34;;

	# If we only want the AST, don&#39;t convert to a Search::Query.
	if &#40;$ast&#41; { return $obj }
	return $obj-&gt;to_plucene&#40;$self-&gt;{default}&#41;;
}

sub _tokenize {
	my &#40;$self, $image, $field&#41; = @_;
	my $stream = $self-&gt;{analyzer}-&gt;tokenstream&#40;{
			field  =&gt; $field || $self-&gt;{default},
			reader =&gt; IO::Scalar-&gt;new&#40;\$image&#41; }&#41;;
	my @words;
	while &#40;my $x = $stream-&gt;next&#41; { push @words, $x-&gt;text }
	join&#40;&#34; &#34;, @words&#41;;
}

package Plucene::QueryParser::TopLevel;

sub to_plucene {
	my &#40;$self, $field&#41; = @_;
	return $self-&gt;[0]-&gt;to_plucene&#40;$field&#41;
		if @$self == 1
		and $self-&gt;[0]-&gt;{mods} eq &#34;NONE&#34;;

	my @clauses;
	$self-&gt;add_clause&#40;\@clauses, $_, $field&#41; for @$self;
	require Plucene::Search::BooleanQuery;
	my $query = new Plucene::Search::BooleanQuery;
	$query-&gt;add_clause&#40;$_&#41; for @clauses;

	$query;
}

sub add_clause {
	my &#40;$self, $clauses, $term, $field&#41; = @_;
	my $q = $term-&gt;to_plucene&#40;$field&#41;;
	if &#40;$term-&gt;{conj} eq &#34;AND&#34; and @$clauses&#41; {

		# The previous term needs to become required
		$clauses-&gt;[-1]-&gt;required&#40;1&#41; unless $clauses-&gt;[-1]-&gt;prohibited;
	}

	if &#40;  $Plucene::QueryParser::DefaultOperator eq &#34;AND&#34;
		and $term-&gt;{conj} eq &#34;OR&#34;&#41; {
		$clauses-&gt;[-1]-&gt;required&#40;0&#41; unless $clauses-&gt;[-1]-&gt;prohibited;
	}

	return unless $q;    # Shouldn&#39;t happen yet
	my $prohibited;
	my $required;
	if &#40;$Plucene::QueryParser::DefaultOperator eq &#34;OR&#34;&#41; {

		# We set REQUIRED if we&#39;re introduced by AND or +; PROHIBITED if
		# introduced by NOT or -; make sure not to set both.
		$prohibited = &#40;$term-&gt;{mods} eq &#34;NOT&#34;&#41;;
		$required   = &#40;$term-&gt;{mods} eq &#34;REQ&#34;&#41;;

		$required = 1 if $term-&gt;{conj} eq &#34;AND&#34; and !$prohibited;
	} else {

		# We set PROHIBITED if we&#39;re introduced by NOT or -; We set
		# REQUIRED if not PROHIBITED and not introduced by OR
		$prohibited = &#40;$term-&gt;{mods} eq &#34;NOT&#34;&#41;;
		$required = &#40;!$prohibited and $term-&gt;{conj} ne &#34;OR&#34;&#41;;
	}
	require Plucene::Search::BooleanClause;
	push @$clauses,
		Plucene::Search::BooleanClause-&gt;new&#40;{
			prohibited =&gt; $prohibited,
			required   =&gt; $required,
			query      =&gt; $q
		}&#41;;
}

package Plucene::QueryParser::Term;

sub to_plucene {
	require Plucene::Search::TermQuery;
	require Plucene::Index::Term;
	my &#40;$self, $field&#41; = @_;
	$self-&gt;set_term&#40;$field&#41;;
	my $q = Plucene::Search::TermQuery-&gt;new&#40;{ term =&gt; $self-&gt;{pl_term} }&#41;;
	$self-&gt;set_boost&#40;$q&#41;;
	return $q;
}

sub set_term {
	my &#40;$self, $field&#41; = @_;
	$self-&gt;{pl_term} = Plucene::Index::Term-&gt;new&#40;{
			field =&gt; &#40;exists $self-&gt;{field} ? $self-&gt;{field} : $field&#41;,
			text =&gt; $self-&gt;{term} }&#41;;
}

sub set_boost {
	my &#40;$self, $q&#41; = @_;
	$q-&gt;boost&#40;$self-&gt;{boost}&#41; if exists $self-&gt;{boost};
}

package Plucene::QueryParser::Phrase;
our @ISA = qw&#40;Plucene::QueryParser::Term&#41;;

# This corresponds to the rules for &#34;PHRASE&#34; in the Plucene grammar

sub to_plucene {
	require Plucene::Search::PhraseQuery;
	require Plucene::Index::Term;
	my &#40;$self, $field&#41; = @_;
	my @words = split /\s+/, $self-&gt;{term};
	return $self-&gt;SUPER::to_plucene&#40;$field&#41; if @words == 1;

	my $phrase = Plucene::Search::PhraseQuery-&gt;new;
	for my $word &#40;@words&#41; {
		my $term = Plucene::Index::Term-&gt;new&#40;{
				field =&gt; &#40;exists $self-&gt;{field} ? $self-&gt;{field} : $field&#41;,
				text =&gt; $word
			}&#41;;
		$phrase-&gt;add&#40;$term&#41;;
	}
	if &#40;exists $self-&gt;{slop}&#41; {
		$phrase-&gt;slop&#40;$self-&gt;{slop}&#41;;
	}
	$self-&gt;set_boost&#40;$phrase&#41;;
	return $phrase;
}

package Plucene::QueryParser::Subquery;

sub to_plucene {
	my &#40;$self, $field&#41; = @_;
	$self-&gt;{subquery}
		-&gt;to_plucene&#40;exists $self-&gt;{field} ? $self-&gt;{field} : $field&#41;;
}

package Plucene::QueryParser::Prefix;
our @ISA = qw&#40;Plucene::QueryParser::Term&#41;;

sub to_plucene {
	require Plucene::Search::PrefixQuery;
	my &#40;$self, $field&#41; = @_;
	$self-&gt;set_term&#40;$field&#41;;
	my $q = Plucene::Search::PrefixQuery-&gt;new&#40;{ prefix =&gt; $self-&gt;{pl_term} }&#41;;
	$self-&gt;set_boost&#40;$q&#41;;
	return $q;
}

1;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-121463" href="/Public/Bug/Display.html?id=11052#txn-121463">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;23&nbsp;16:30:44&nbsp;2005</span>
    <span class="description">tony [...] kasei.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 23 Jan 2005 21:19:49 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tony Bowden &lt;tony [...] kasei.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Guest via RT &lt;bug-plucene [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #11052] QueryParser should pass correct field name when tokenizing</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/121463/30446/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/30446">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 700b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Jan 18, 2005 at 11:51:10AM -0500, Guest via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The current version QueryParser.pm always passes the name of its
&gt; default field to the analyzer &#40;via its call to the analyzer&#39;s tokenstream
&gt; function&#41;. For queries of the form &#34;FieldName:BasicClause&#34;, QueryParser
&gt; should instead pass &#34;FieldName&#34; to the analyzer. I have verified that
&gt; Java Lucene behaves this way.
</div>
Do you have a simple test that exposes this bug?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have made the following simple changes to QueryParser.pm &#40;attached
&gt; file&#41; on my system and they fix the problem. I have not regression
&gt; tested them.
</div>
Thanks.

This passes all the tests, but I&#39;d prefer not to integrate without a
regression test for this.

Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-121464" href="/Public/Bug/Display.html?id=11052#txn-121464">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;23&nbsp;17:01:17&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/121464/30448/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/30448">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 738b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Attached is a script which exposes the bug, adapted &#40;quickly&#41; from the
Plucene documentation example. It creates a simple Analyzer subclass,
which prints the name of the field being analyzed.

The result I get with Plucene 1.20 is:
Creating index...
In TestAnalyzer::tokenstream&#40;&#41;, $field = content
In TestAnalyzer::tokenstream&#40;&#41;, $field = author
Starting query...
In TestAnalyzer::tokenstream&#40;&#41;, $field = text
In TestAnalyzer::tokenstream&#40;&#41;, $field = text
Results:
...

The result I expect is:
Creating index...
In TestAnalyzer::tokenstream&#40;&#41;, $field = content
In TestAnalyzer::tokenstream&#40;&#41;, $field = author
Starting query...
In TestAnalyzer::tokenstream&#40;&#41;, $field = author
In TestAnalyzer::tokenstream&#40;&#41;, $field = text
Results:
...
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/121464/30449/testbug.pl">Download testbug.pl</a><br />
<span class="downloadcontenttype">text/x-perl 2.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!perl

package TestAnalyzer;
use base &#39;Plucene::Analysis::Analyzer&#39;;

use Plucene::Analysis::Analyzer;
use Plucene::Analysis::WhitespaceTokenizer;

use Data::Dumper;

sub tokenstream {
	my $class = shift;

  my $field = $_[0]-&gt;{field};
  my $tok;

  print &#34;In TestAnalyzer::tokenstream&#40;&#41;, \$field = $field\n&#34;;

  $tok = Plucene::Analysis::WhitespaceTokenizer-&gt;new&#40;@_&#41;;

  return $tok;

}

1;

package main;

        use Plucene::Document;
        use Plucene::Document::Field;

print &#34;Creating index...\n&#34;;

        my $doc = Plucene::Document-&gt;new;
        $doc-&gt;add&#40;Plucene::Document::Field-&gt;Text&#40;&#34;content&#34;, $content&#41;&#41;;
        $doc-&gt;add&#40;Plucene::Document::Field-&gt;Text&#40;&#34;author&#34;, &#34;Your Name&#34;&#41;&#41;;

#Next, choose your analyser, and make an index writer.

        use Plucene::Index::Writer;
        use Plucene::Analysis::SimpleAnalyzer;

        my $writer = Plucene::Index::Writer-&gt;new&#40;&#34;my_index&#34;,
                TestAnalyzer-&gt;new&#40;&#41;, 1&#41;;

#Now write your documents into the index.

        $writer-&gt;add_document&#40;$doc&#41;;
        undef $writer; # close

#When you come to search, parse the query and create a searcher:

print &#34;Starting query...\n&#34;;

        use Plucene::QueryParser;
        use Plucene::Analysis::SimpleAnalyzer;
        use Plucene::Search::IndexSearcher;

        my $parser = Plucene::QueryParser-&gt;new&#40;{
                analyzer =&gt; TestAnalyzer-&gt;new&#40;&#41;,
                default  =&gt; &#34;text&#34; # Default field for non-specified queries
        }&#41;;
        my $query = $parser-&gt;parse&#40;&#39;author:Your Name&#39;&#41;;

        my $searcher = Plucene::Search::IndexSearcher-&gt;new&#40;&#34;my_index&#34;&#41;;

#Decide what you&#39;re going to do with the results:

        use Plucene::Search::HitCollector;
        my @docs;
        my $hc = Plucene::Search::HitCollector-&gt;new&#40;collect =&gt; sub {
                my &#40;$self, $doc, $score&#41;= @_;
                push @docs, $searcher-&gt;doc&#40;$doc&#41;;
        }&#41;;

        $searcher-&gt;search_hc&#40;$query, $hc&#41;;

use Data::Dumper;
print &#34;Results:\n&#34;;
print Dumper @docs;


</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-121467" href="/Public/Bug/Display.html?id=11052#txn-121467">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;20&nbsp;06:30:00&nbsp;2005</span>
    <span class="description">TMTM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/121467/37727/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/37727">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 527b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Sun Jan 23 17:01:17 2005]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Attached is a script which exposes the bug, adapted &#40;quickly&#41; from the
&gt; Plucene documentation example. It creates a simple Analyzer subclass,
&gt; which prints the name of the field being analyzed.
</div>
Sorry it&#39;s taken me so long to get around this. I can replicate this
bug, and I can fix it, but I&#39;m curious as to how it manifests itself.
What problem does this bug actually cause? I&#39;d like to add a test that&#39;s
at a slightly higher level than the one you&#39;ve supplied as well.

Thanks,

Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-121468" href="/Public/Bug/Display.html?id=11052#txn-121468">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;20&nbsp;12:02:13&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/121468/37738/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/37738">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 748b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">No need to apologize. Unless you&#39;re getting paid to support this :-&#41;

I haven&#39;t looked at this in a while myself, but basically the way the
bug manifests is that any time a QueryParser object parses a query of
the form &#34;fieldname:pattern&#34;, the result is likely to be incorrect. The
only case which gives the correct result is when fieldname is the same
as the default field for that QueryParser object.

For example, if you&#39;ve added the following fieldnames &#38; data to a document:

name:Eric, age:39, hair:brown
name:Pamela, age:40, hair:blonde

And you try to run a query with the search string &#34;hair:blonde&#34;, you
will not get any matches, since what Plucene sees internally is
&#34;name:blonde&#34;.

I&#39;ll try to come up with a real code example later.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-121469" href="/Public/Bug/Display.html?id=11052#txn-121469">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;20&nbsp;12:17:29&nbsp;2005</span>
    <span class="description">tony [...] kasei.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 20 Jul 2005 17:17:16 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tony Bowden &lt;tony [...] kasei.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Guest via RT &lt;bug-plucene [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #11052] QueryParser should pass correct field name when tokenizing</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/121469/37741/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/37741">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 628b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Jul 20, 2005 at 12:02:13PM -0400, Guest via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; No need to apologize. Unless you&#39;re getting paid to support this :-&#41;
</div>
Unfortunately not :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; name:Eric, age:39, hair:brown
&gt; name:Pamela, age:40, hair:blonde
&gt; And you try to run a query with the search string &#34;hair:blonde&#34;, you
&gt; will not get any matches, since what Plucene sees internally is
&gt; &#34;name:blonde&#34;.
</div>
Eeek. That&#39;s a fairly serious bug. I was pretty sure there were tests
for this sort of thing though ...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ll try to come up with a real code example later.
</div>
Thanks.  I&#39;ll see if I can get some time this evening to play about with
it myself.

Tony
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.376485</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
