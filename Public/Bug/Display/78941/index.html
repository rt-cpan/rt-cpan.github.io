<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #78941 for DBIx-Class-Schema-Loader: D:C:S:L does not respect FK default relationships for MySQL</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #78941 for DBIx-Class-Schema-Loader: D:C:S:L does not respect FK default relationships for MySQL</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBIx-Class-Schema-Loader/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBIx-Class-Schema-Loader/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBIx-Class-Schema-Loader/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBIx-Class-Schema-Loader/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Class-Schema-Loader">DBIx-Class-Schema-Loader CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">78941</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBIx-Class-Schema-Loader/Active/">DBIx-Class-Schema-Loader</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ray.rechtin [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-38270-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.07020    </td>
  </tr>
  <tr id="CF-38271-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;13&nbsp;14:21:34&nbsp;2012</span>
    <span class="description">ray.rechtin [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> D:C:S:L does not respect FK default relationships for MySQL</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">When creating a schema from an existing MySQL database, 
DBIx::Class::Schema::Loader is generating relationships for foreign keys 
with attributes of &#39;ON DELETE CASCADE&#39; and &#39;ON UPDATE CASCADE&#39; even when 
the underlying database has attributes of &#39;ON DELETE RESTRICT&#39; or &#39;ON 
UPDATE RESTRICT&#39;.

The attached .sql loads a database with a single table and a simple 
self-
referential FK.  If you load this table and then use 
DBIx::Class::Schema::Loader to dump it to a directory, you will see that 
the FK &#39;self_fk_constraint&#39; in the created schema has both &#39;ON DELETE 
CASCADE&#39; and &#39;ON UPDATE CASCADE&#39; even though the original table is 
created with both set to &#39;RESTRICT&#39;.  I have also attached the relevant 
result module.

Preliminary testing seems to indicate that this does not in some manner 
circumvent the actual database definition; a script attempting to 
perform a delete dies due to the failure in the underlying database 
structure.  However, the schema does not reflect the actual database and 
I am unsure as to any possible unintended side effects.

mysql -u &lt;user&gt; -p &lt; database.sql

dbicdump -o dump_directory=./ Test::Schema dbi:mysql:database=test_dcsl 
&lt;user&gt; &lt;password&gt;
Dumping manual schema for Test::Schema to directory ./ ...
Schema dump completed.

I am using perl 5.12.4, DBIx::Class::Schema::Loader v0.07020:
This is perl 5, version 12, subversion 4 &#40;v5.12.4&#41; built for i686-linux-
gnu-thread-multi-64int
perl -e &#39;use DBIx::Class::Schema::Loader; print 
$DBIx::Class::Schema::Loader::VERSION;&#39;
0.07020
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> database.sql</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">DROP DATABASE IF EXISTS test_dcsl;
CREATE DATABASE test_dcsl;

USE test_dcsl;

CREATE TABLE `test_dcsl`.`test_table` &#40;
  `id` INT&#40;10&#41; UNSIGNED NOT NULL AUTO_INCREMENT,
  `id_ref` INT&#40;10&#41; UNSIGNED NOT NULL,
  PRIMARY KEY &#40;`id`&#41;,
  INDEX `ref_index`&#40;`id_ref`&#41;,
  CONSTRAINT `self_fk_constraint` FOREIGN KEY `self_fk_constraint` &#40;`id_ref`&#41;
    REFERENCES `test_table` &#40;`id`&#41;
    ON DELETE RESTRICT
    ON UPDATE RESTRICT
&#41;
ENGINE = InnoDB;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> TestTable.pm</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use utf8;
package Test::Schema::Result::TestTable;

# Created by DBIx::Class::Schema::Loader
# DO NOT MODIFY THE FIRST PART OF THIS FILE

=head1 NAME

Test::Schema::Result::TestTable

=cut

use strict;
use warnings;

use base &#39;DBIx::Class::Core&#39;;

=head1 TABLE: C&lt;test_table&gt;

=cut

__PACKAGE__-&gt;table&#40;&#34;test_table&#34;&#41;;

=head1 ACCESSORS

=head2 id

  data_type: &#39;integer&#39;
  extra: {unsigned =&gt; 1}
  is_auto_increment: 1
  is_nullable: 0

=head2 id_ref

  data_type: &#39;integer&#39;
  extra: {unsigned =&gt; 1}
  is_foreign_key: 1
  is_nullable: 0

=cut

__PACKAGE__-&gt;add_columns&#40;
  &#34;id&#34;,
  {
    data_type =&gt; &#34;integer&#34;,
    extra =&gt; { unsigned =&gt; 1 },
    is_auto_increment =&gt; 1,
    is_nullable =&gt; 0,
  },
  &#34;id_ref&#34;,
  {
    data_type =&gt; &#34;integer&#34;,
    extra =&gt; { unsigned =&gt; 1 },
    is_foreign_key =&gt; 1,
    is_nullable =&gt; 0,
  },
&#41;;

=head1 PRIMARY KEY

=over 4

=item * L&lt;/id&gt;

=back

=cut

__PACKAGE__-&gt;set_primary_key&#40;&#34;id&#34;&#41;;

=head1 RELATIONS

=head2 id_ref

Type: belongs_to

Related object: L&lt;Test::Schema::Result::TestTable&gt;

=cut

__PACKAGE__-&gt;belongs_to&#40;
  &#34;id_ref&#34;,
  &#34;Test::Schema::Result::TestTable&#34;,
  { id =&gt; &#34;id_ref&#34; },
  { is_deferrable =&gt; 1, on_delete =&gt; &#34;CASCADE&#34;, on_update =&gt; &#34;CASCADE&#34; },
&#41;;

=head2 test_tables

Type: has_many

Related object: L&lt;Test::Schema::Result::TestTable&gt;

=cut

__PACKAGE__-&gt;has_many&#40;
  &#34;test_tables&#34;,
  &#34;Test::Schema::Result::TestTable&#34;,
  { &#34;foreign.id_ref&#34; =&gt; &#34;self.id&#34; },
  { cascade_copy =&gt; 0, cascade_delete =&gt; 0 },
&#41;;


# Created by DBIx::Class::Schema::Loader v0.07020 @ 2012-08-13 14:13:44
# DO NOT MODIFY THIS OR ANYTHING ABOVE! md5sum:gfFnXT59GLX5HKfos7Bt7A


# You can replace this text with custom code or comments, and it will be preserved on regeneration
1;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;13&nbsp;15:27:04&nbsp;2012</span>
    <span class="description">rkitover [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #78941] D:C:S:L does not respect FK default relationships for MySQL</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 13 Aug 2012 12:26:56 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class-Schema-Loader [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Rafael Kitover &lt;rkitover [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I haven&#39;t added fk type introspection yet, so it just uses those as
defaults.

This has no effect when just using a generated schema, it does have an
effect when deploying said schema to a new database through SQL::Translator
&#40;$schema-&gt;deploy&#41;.

This feature is planned, however I cannot give you a timeframe. Support
would have to be added for a large number of database types.
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;13&nbsp;15:27:07&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;13&nbsp;15:34:56&nbsp;2012</span>
    <span class="description">ray.rechtin [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ray.rechtin [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It is good to know that it has no effect when utilizing a generated 
schema, as that will protect our production environment.

However, our test setup deploys into a temporary sqlite database, which 
means that our test environment does not accurately reflect production.

Do you have any suggestions for a workaround?  I looked at the 
possibility of manually defining relationship options prior to dumping, 
but it looked like the only options to do that would set all 
relationships of a given type that way, instead of being able to define 
specific relationships differently.

Even if it requires overriding the results of the dumped schema, we just 
want to ensure we don&#39;t hit a bug because our test environment does 
something it shouldn&#39;t.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;13&nbsp;15:49:51&nbsp;2012</span>
    <span class="description">rkitover [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #78941] D:C:S:L does not respect FK default relationships for MySQL</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 13 Aug 2012 12:49:42 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class-Schema-Loader [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Rafael Kitover &lt;rkitover [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ok, I&#39;ll add coderef support to relationship_attrs. Sometime today or
tomorrow and I&#39;ll let you know.
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;25&nbsp;22:20:03&nbsp;2012</span>
    <span class="description">rkitover [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have some good news for you. I added mysql FK ON clause introspection
in version 0.07026.

Please try it out and let me know if it meets your needs.

I actually wrote this on the plane, which had no wifi, and only got a
chance to release it now, here in the woods with horrible cell reception
so my sprint hotspot kept disconnecting, but then this guy in a cabin
nearby turned on his access point, yay! And I&#39;m updating this RT from it.

As for coderef support for relationship_attrs, I will add that too,
maybe tonight,
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;28&nbsp;08:27:39&nbsp;2012</span>
    <span class="description">ray.rechtin [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ray.rechtin [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ok, I&#39;ll test regenerating our schema as soon as I get some free time... 
could be today or tomorrow.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;06&nbsp;11:24:29&nbsp;2012</span>
    <span class="description">rkitover [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed for MySQL as of 0.07026, fixed for PostgreSQL, SQLite, MSSQL, DB2 and Oracle in later 
versions.

Five more databases need a fix, which will be done over the next couple of weeks.

Closing this ticket as it was specifically for MySQL.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;06&nbsp;11:24:32&nbsp;2012</span>
    <span class="description">rkitover [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
