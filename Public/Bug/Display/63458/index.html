<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #63458 for Class-XSAccessor: segfault in C:XSA, perl 5.12.2, linux/amd64</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #63458 for Class-XSAccessor: segfault in C:XSA, perl 5.12.2, linux/amd64</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Class-XSAccessor/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Class-XSAccessor/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Class-XSAccessor/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Class-XSAccessor/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Class-XSAccessor">Class-XSAccessor CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">63458</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Class-XSAccessor/Active/">Class-XSAccessor</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
TJC [...] cpan.org

<br />
toby.corkindale [...] strategicdata.com.au

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-221550-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.09    </td>
  </tr>
  <tr id="CF-221551-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;29&nbsp;21:19:58&nbsp;2010</span>
    <span class="description">TJC [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> segfault in C:XSA, perl 5.12.2, linux/amd64</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">While tracking down test failures in some modules that use DBIx::Class, I discovered the cause was segfaults 
from Class::XSAccessor.

For eg, HTML::FormHandler::Model::DBIC fails.

Manually running the test script &#40;ie. perl -Ilib t/book.t&#41; results in the following occuring, after code 
gets into the END {} block.

*** glibc detected *** perl: realloc&#40;&#41;: invalid pointer: 0x0000000001674838 ***
======= Backtrace: =========
/lib/libc.so.6&#40;+0x775b6&#41;[0x7f46229f65b6]
/lib/libc.so.6&#40;realloc+0x352&#41;[0x7f46229fd312]
/usr/local/strategic/perl/lib/site_perl/5.12.2/x86_64-linux-thread-
multi/auto/Class/XSAccessor/XSAccessor.so&#40;get_hashkey_index+0x2a7&#41;[0x7f46210dcb77]
/usr/local/strategic/perl/lib/site_perl/5.12.2/x86_64-linux-thread-
multi/auto/Class/XSAccessor/XSAccessor.so&#40;XS_Class__XSAccessor_newxs_accessor+0x1db&#41;[0x7f46210dd5cb]
perl&#40;Perl_pp_entersub+0x530&#41;[0x495c90]
perl&#40;Perl_runops_standard+0x16&#41;[0x4947d6]
perl&#40;Perl_call_sv+0x4b7&#41;[0x439a47]
perl&#40;Perl_call_list+0x2ad&#41;[0x439f1d]
perl&#40;perl_destruct+0x170c&#41;[0x43c3bc]
perl&#40;main+0xcb&#41;[0x421e7b]
/lib/libc.so.6&#40;__libc_start_main+0xfd&#41;[0x7f462299dc4d]
perl[0x421ce9]
======= Memory map: ========
00400000-0055c000 r-xp 00000000 fb:03 6828319                            /home/tobyc/git/modern-
perl/system/lucid-amd64.new/bin/perl
0075b000-0075c000 r--p 0015b000 fb:03 6828319                            /home/tobyc/git/modern-
perl/system/lucid-amd64.new/bin/perl
0075c000-00760000 rw-p 0015c000 fb:03 6828319                            /home/tobyc/git/modern-
perl/system/lucid-amd64.new/bin/perl
01674000-03e44000 rw-p 00000000 00:00 0                                  [heap]
7f461f7c8000-7f461f7de000 r-xp 00000000 fb:00 29039                      /lib/libgcc_s.so.1
7f461f7de000-7f461f9dd000 ---p 00016000 fb:00 29039                      /lib/libgcc_s.so.1
7f461f9dd000-7f461f9de000 r--p 00015000 fb:00 29039                      /lib/libgcc_s.so.1
7f461f9de000-7f461f9df000 rw-p 00016000 fb:00 29039                      /lib/libgcc_s.so.1
7f461f9df000-7f461f9e0000 ---p 00000000 00:00 0 
7f461f9e0000-7f46201e0000 rw-p 00000000 00:00 0 
7f46201e0000-7f462027c000 r-xp 00000000 fb:03 5914083                    /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/site_perl/5.12.2/x86_64-linux-thread-multi/auto/DBD/SQLite/SQLite.so
7f462027c000-7f462047c000 ---p 0009c000 fb:03 5914083                    /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/site_perl/5.12.2/x86_64-linux-thread-multi/auto/DBD/SQLite/SQLite.so
7f462047c000-7f462047e000 r--p 0009c000 fb:03 5914083                    /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/site_perl/5.12.2/x86_64-linux-thread-multi/auto/DBD/SQLite/SQLite.so
7f462047e000-7f4620480000 rw-p 0009e000 fb:03 5914083                    /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/site_perl/5.12.2/x86_64-linux-thread-multi/auto/DBD/SQLite/SQLite.so
7f4620480000-7f4620481000 rw-p 00000000 00:00 0 
7f4620481000-7f462048a000 r-xp 00000000 fb:03 26325                      /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/5.12.2/x86_64-linux-thread-multi/auto/Data/Dumper/Dumper.so
7f462048a000-7f4620689000 ---p 00009000 fb:03 26325                      /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/5.12.2/x86_64-linux-thread-multi/auto/Data/Dumper/Dumper.so
7f4620689000-7f462068a000 r--p 00008000 fb:03 26325                      /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/5.12.2/x86_64-linux-thread-multi/auto/Data/Dumper/Dumper.so
7f462068a000-7f462068b000 rw-p 00009000 fb:03 26325                      /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/5.12.2/x86_64-linux-thread-multi/auto/Data/Dumper/Dumper.so
7f462068b000-7f46206ac000 r-xp 00000000 fb:03 5915678                    /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/site_perl/5.12.2/x86_64-linux-thread-multi/auto/DBI/DBI.so
7f46206ac000-7f46208ab000 ---p 00021000 fb:03 5915678                    /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/site_perl/5.12.2/x86_64-linux-thread-multi/auto/DBI/DBI.so
7f46208ab000-7f46208ac000 r--p 00020000 fb:03 5915678                    /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/site_perl/5.12.2/x86_64-linux-thread-multi/auto/DBI/DBI.so
7f46208ac000-7f46208ad000 rw-p 00021000 fb:03 5915678                    /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/site_perl/5.12.2/x86_64-linux-thread-multi/auto/DBI/DBI.so
7f46208ad000-7f46208b0000 r-xp 00000000 fb:03 26231                      /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/5.12.2/x86_64-linux-thread-multi/auto/Cwd/Cwd.so
7f46208b0000-7f4620aaf000 ---p 00003000 fb:03 26231                      /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/5.12.2/x86_64-linux-thread-multi/auto/Cwd/Cwd.so
7f4620aaf000-7f4620ab0000 r--p 00002000 fb:03 26231                      /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/5.12.2/x86_64-linux-thread-multi/auto/Cwd/Cwd.so
7f4620ab0000-7f4620ab1000 rw-p 00003000 fb:03 26231                      /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/5.12.2/x86_64-linux-thread-multi/auto/Cwd/Cwd.so
7f4620ab1000-7f4620ac5000 r-xp 00000000 fb:03 26320                      /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/5.12.2/x86_64-linux-thread-multi/auto/Storable/Storable.so
7f4620ac5000-7f4620cc5000 ---p 00014000 fb:03 26320                      /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/5.12.2/x86_64-linux-thread-multi/auto/Storable/Storable.so
7f4620cc5000-7f4620cc6000 r--p 00014000 fb:03 26320                      /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/5.12.2/x86_64-linux-thread-multi/auto/Storable/Storable.so
7f4620cc6000-7f4620cc7000 rw-p 00015000 fb:03 26320                      /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/5.12.2/x86_64-linux-thread-multi/auto/Storable/Storable.so
7f4620cc7000-7f4620cca000 r-xp 00000000 fb:03 26294                      /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/5.12.2/x86_64-linux-thread-multi/auto/Fcntl/Fcntl.so
7f4620cca000-7f4620eca000 ---p 00003000 fb:03 26294                      /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/5.12.2/x86_64-linux-thread-multi/auto/Fcntl/Fcntl.so
7f4620eca000-7f4620ecb000 r--p 00003000 fb:03 26294                      /home/tobyc/git/modern-
perl/system/lucid-amd64.new/lib/5.12.2/x86_64-linux-thread-multi/auto/Fcntl/Fcntl.so
Aborted
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;29&nbsp;21:20:36&nbsp;2010</span>
    <span class="description">TJC [...] cpan.org -  Dependency by ticket #63455 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;29&nbsp;21:22:22&nbsp;2010</span>
    <span class="description">TJC [...] cpan.org -  Requestor toby.corkindale@strategicdata.com.au added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;29&nbsp;21:31:56&nbsp;2010</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I don&#39;t know if it helps to note that the segfault occurred while Perl 
was processing the END {} block - would some parts of memory have already 
been cleared down by then?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;29&nbsp;21:32:02&nbsp;2010</span>
    <span class="description">TJC [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;29&nbsp;21:41:10&nbsp;2010</span>
    <span class="description">TJC [...] cpan.org -  Dependency by ticket #63459 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;30&nbsp;07:22:16&nbsp;2010</span>
    <span class="description">smueller [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m currently installing the modules in question. Not sure if I&#39;ll have time to dig in later today.

Thanks for reporting this with a test case that I may actually be able to use for reproducing the 
bug. I hope that&#39;ll lead to a &#34;doh&#34; moment as soon as I get things running in gdb.

Cheers,
Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;30&nbsp;08:12:49&nbsp;2010</span>
    <span class="description">smueller [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Nov 29 21:19:58 2010, TJC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; For eg, HTML::FormHandler::Model::DBIC fails.
&gt; 
&gt; Manually running the test script &#40;ie. perl -Ilib t/book.t&#41; results in
&gt; the following occuring, after code
&gt; gets into the END {} block.
</div>
Curiously, those tests fail for me in the same way &#40;without segfaults&#41; regardless of whether 
Class::XSAccessor is available or not. I&#39;m on OSX, though.

I&#39;ll try to get access to a saner &#40;i.e. Linux&#41; system for testing.

In the meantime: What version of Class::XSAccessor were you using? Could you try with:

- The most recent release
- Version 1.06
- github master?

Best regards,
Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;30&nbsp;08:46:48&nbsp;2010</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Nov 30 08:12:49 2010, SMUELLER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Nov 29 21:19:58 2010, TJC wrote:
<div class="message-stanza open">&gt; &gt; For eg, HTML::FormHandler::Model::DBIC fails.
&gt; &gt;
&gt; &gt; Manually running the test script &#40;ie. perl -Ilib t/book.t&#41; results
</div>&gt; in
<div class="message-stanza open">&gt; &gt; the following occuring, after code
&gt; &gt; gets into the END {} block.
</div>&gt; 
&gt; Curiously, those tests fail for me in the same way &#40;without segfaults&#41;
&gt; regardless of whether
&gt; Class::XSAccessor is available or not. I&#39;m on OSX, though.
</div>
The tests are a bit delicate; they rely upon a pre-existing SQLite database, and the tests are 
supposed to leave in a consistent state, but don&#39;t always seem to.
You can recreate the DB by deleting t/db/book.db, then running
sqlite3 t/db/book.db &#34;.read t/db/bookdb.sql&#34;

Although I noticed that &#39;prove&#39; was hiding the segfaults for me, and just reporting &#39;0 tests 
failed&#39; but with &#39;non-zero exit code&#39; or something.
It wasn&#39;t until I ran &#34;perl -Ilib t/book.t&#34; that I saw the segfault output.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ll try to get access to a saner &#40;i.e. Linux&#41; system for testing.
</div>
If it helps, the system I&#39;m having trouble with is Debian Lenny, amd64 architecture, although  we 
have a later Perl &#40;5.12.2&#41; rather than the system perl &#40;5.10.1&#41;.

I can provide either the exact commands used to roll it, or a tarball containing the self-
contained Perl + modules that demonstrate the problem, if it would help. ie. That&#39;s suitable for 
running in a chroot/lxc/jail kind of environment.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In the meantime: What version of Class::XSAccessor were you using?
</div>
It was the latest version on CPAN as of about 12 hours ago, so 1.09 I think.
I&#39;ll confirm in the morning &#40;umm, about 9 hours from now&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Could you try with:
&gt; 
&gt; - The most recent release
&gt; - Version 1.06
&gt; - github master?
</div>
I need some sleep here, will try the older version, and trunk version, in the morning.

Thanks for looking into this,
Toby
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;30&nbsp;15:32:41&nbsp;2010</span>
    <span class="description">smueller [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #63458] segfault in C:XSA, perl 5.12.2, linux/amd64 </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 30 Nov 2010 21:32:34 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Class-XSAccessor [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steffen Mueller &lt;smueller [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On Nov 30, 2010, at 2:46 PM, Toby C via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The tests are a bit delicate; they rely upon a pre-existing SQLite database, and the tests are 
&gt; supposed to leave in a consistent state, but don&#39;t always seem to.
&gt; You can recreate the DB by deleting t/db/book.db, then running
&gt; sqlite3 t/db/book.db &#34;.read t/db/bookdb.sql&#34;
&gt; 
&gt; Although I noticed that &#39;prove&#39; was hiding the segfaults for me, and just reporting &#39;0 tests 
&gt; failed&#39; but with &#39;non-zero exit code&#39; or something.
&gt; It wasn&#39;t until I ran &#34;perl -Ilib t/book.t&#34; that I saw the segfault output.
</div>
I can reproduce it on OS X now.

#0  0x000000010075744c in get_hashkey_index &#40;&#41;
#1  0x0000000100758208 in XS_Class__XSAccessor_newxs_accessor &#40;&#41;
#2  0x000000010009f033 in Perl_pp_entersub &#40;&#41;
#3  0x0000000100096a2a in Perl_runops_standard &#40;&#41;
#4  0x000000010001cd4a in Perl_call_sv &#40;&#41;
#5  0x000000010001d273 in Perl_call_list &#40;&#41;
#6  0x000000010001ed1e in perl_destruct &#40;&#41;
#7  0x00000001000012b2 in main &#40;&#41;

If I do this:

--- a/XSAccessor.xs
+++ b/XSAccessor.xs
@@ -563,7 +563,7 @@ END&#40;&#41;
     PROTOTYPE:
     CODE:
         if &#40;CXSAccessor_reverse_hashkeys&#41; {
-            CXSA_HashTable_free&#40;CXSAccessor_reverse_hashkeys&#41;;
+            /*CXSA_HashTable_free&#40;CXSAccessor_reverse_hashkeys&#41;;*/
         }
 
 void


Then it doesn&#39;t segfault any more. This is essentially neglecting to free memory at the end of the process.
Now, let me guess why this would happen:

a&#41; There is a class with a DESTROY method that calls XS accessors.
b&#41; Instances of that class get destroyed after this particular END block runs.

I&#39;m not sure how we can tell perl that we really, really want to run really late. But then there would be contention at THAT time at some point. Or maybe get_hashkey_index needs to be made aware of the status that things have been freed already. Except what kind of behaviour would that introduce in Perl land? &#34;Sorry, can&#39;t properly DESTROY your object. We&#39;ve already shut down the code that does it!&#34;

I think our only option is to leak the memory.

Chocolateboy, what do you think?

Cheers,
Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;01&nbsp;14:28:06&nbsp;2010</span>
    <span class="description">smueller [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Nov 30 15:32:41 2010, SMUELLER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think our only option is to leak the memory.
</div>
... and I still haven&#39;t come up with a better solution. I will try to make a release that relies on the 
OS to free the memory &#40;that would otherwise be freed during END&#41; later today to fix the 
crashing bug. If we come up with something better, that&#39;s the next iteration.

The only case I can think of in which this really is an issue is long running applications that 
repeatedly create and destroy embedded perl interpreters. Since I have a hunch that that would 
a&#41; be rare and b&#41; leak memory anyway, I&#39;m not that worried.

Cheers,
Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;01&nbsp;14:59:31&nbsp;2010</span>
    <span class="description">smueller [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Class::XSAccessor 1.10 released to CPAN. It would be great if you could confirm that the 
problem went away.

I&#39;ll keep the ticket open until then.

--Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;01&nbsp;14:59:32&nbsp;2010</span>
    <span class="description">smueller [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;01&nbsp;20:39:17&nbsp;2010</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 01 14:59:31 2010, SMUELLER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Class::XSAccessor 1.10 released to CPAN. It would be great if you
&gt; could confirm that the
&gt; problem went away.
&gt; 
&gt; I&#39;ll keep the ticket open until then.
</div>
My specific instance seems to be fixed with 1.10 - thanks for your rapid 
work on this.

I&#39;m a little nervous at the mention of memory leaks; could we discuss 
that a little further?

I see two possible cases, and I&#39;m not sure which it is. Could you take a 
moment to explain which case it is?

1&#41; Memory will only be leaked when Perl is &#34;exiting&#34;. As I understand 
it, this is OK for shell script and long-running instances, but not good 
for things like mod_perl or postgres&#39; PL/Perl.

2&#41; Memory will only be leaked on object destruction - ie. when a blessed 
object goes out of scope. I ask because I see there was discussed of 
DESTROY methods.

Thanks,
Toby
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;01&nbsp;20:39:18&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;02&nbsp;02:28:30&nbsp;2010</span>
    <span class="description">smueller [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #63458] segfault in C:XSA, perl 5.12.2, linux/amd64 </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 2 Dec 2010 08:28:19 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Class-XSAccessor [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steffen Mueller &lt;smueller [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On Dec 2, 2010, at 2:39 AM, Toby C via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       Queue: Class-XSAccessor
&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=63458">https://rt.cpan.org/Ticket/Display.html?id=63458</a></span> &gt;
&gt; 
&gt; On Wed Dec 01 14:59:31 2010, SMUELLER wrote:
<div class="message-stanza open">&gt;&gt; Class::XSAccessor 1.10 released to CPAN. It would be great if you
&gt;&gt; could confirm that the
&gt;&gt; problem went away.
&gt;&gt; 
&gt;&gt; I&#39;ll keep the ticket open until then.
</div></div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I see two possible cases, and I&#39;m not sure which it is. Could you take a 
&gt; moment to explain which case it is?
&gt; 
&gt; 1&#41; Memory will only be leaked when Perl is &#34;exiting&#34;. As I understand 
&gt; it, this is OK for shell script and long-running instances, but not good 
&gt; for things like mod_perl or postgres&#39; PL/Perl.
</div>
This is the case.
But I highly doubt that this matters for mod_perl. mod_perl instances are forked, are they not? They&#39;re not many interpreters in the same process. For Postgres, I&#39;m not sure. But seriously. I am very certain that a lot of modules rely on global destruction for this cleanup to happen, so Postgres probably doesn&#39;t do this either. And this memory might &#40;and it&#39;s early in the morning, I&#39;m not sure&#41; even be reused by new instances that have the same hash key names.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2&#41; Memory will only be leaked on object destruction - ie. when a blessed 
&gt; object goes out of scope. I ask because I see there was discussed of 
&gt; DESTROY methods.
</div>
This is not the case.

--Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;02&nbsp;02:34:48&nbsp;2010</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Dec 02 02:28:30 2010, SMUELLER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Dec 2, 2010, at 2:39 AM, Toby C via RT wrote:
<div class="message-stanza open">&gt; &gt; I see two possible cases, and I&#39;m not sure which it is. Could you
&gt; &gt; take a moment to explain which case it is?
&gt; &gt;
&gt; &gt; 1&#41; Memory will only be leaked when Perl is &#34;exiting&#34;. As I
&gt; &gt;    understand it, this is OK for shell script and long-running
&gt; &gt;    instances, but not good for things like mod_perl or
&gt; &gt;    postgres&#39; PL/Perl.
</div>&gt; 
&gt; This is the case.
&gt; But I highly doubt that this matters for mod_perl. mod_perl instances
&gt;    are forked, are they not? They&#39;re not many interpreters in the same
&gt;    process. For Postgres, I&#39;m not sure. But seriously. I am very
&gt;    certain that a lot of modules rely on global destruction for this
&gt;    cleanup to happen, so Postgres probably doesn&#39;t do this either. And
&gt;    this memory might &#40;and it&#39;s early in the morning, I&#39;m not sure&#41;
&gt;    even be reused by new instances that have the same hash key names.
</div>
mod_perl is threaded if you run Apache with the &#34;mpm_worker&#34; engine &#40;ie. threaded Apache&#41;, 
and I think that&#39;s also the only option on win32. In those cases, you have a pool of Perl 
interpreter threads that handle many requests.

&#40;That&#39;s probably why the win32+mod_perl environment is a bit fragile; any memory access 
mistakes from one thread can effect either another thread, or a later request&#41;

That said - I don&#39;t think many people tend to use mod_perl in the threaded apache environment 
on Linux, since it does tend to be unstable due to exactly those sort of issues..


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; 2&#41; Memory will only be leaked on object destruction - ie. when a
</div>&gt;    blessed
<div class="message-stanza open">&gt; &gt; object goes out of scope. I ask because I see there was discussed of
&gt; &gt; DESTROY methods.
</div>&gt; 
&gt; This is not the case.
</div>
That&#39;s good - thanks for reassuring me.

cheers,
Toby
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;02&nbsp;13:12:41&nbsp;2010</span>
    <span class="description">smueller [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #63458] segfault in C:XSA, perl 5.12.2, linux/amd64 </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 2 Dec 2010 19:12:33 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Class-XSAccessor [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steffen Mueller &lt;smueller [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Dec 2, 2010, at 8:34 AM, Toby C via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; mod_perl is threaded if you run Apache with the &#34;mpm_worker&#34; engine &#40;ie. threaded Apache&#41;, 
&gt; and I think that&#39;s also the only option on win32. In those cases, you have a pool of Perl 
&gt; interpreter threads that handle many requests.
</div>
Not sure how mod_perl implements this, but having many ithreads and repeatedly creating/reaping them is okay as far as C::XSA goes. Just destroying the master thread means leaking the memory.

--Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;02&nbsp;13:27:30&nbsp;2010</span>
    <span class="description">smueller [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Resolved! Yay!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;02&nbsp;13:27:32&nbsp;2010</span>
    <span class="description">smueller [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
