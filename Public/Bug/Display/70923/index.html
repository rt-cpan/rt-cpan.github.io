<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #70923 for SQL-Translator: Incorrect quoting behaviour in PostgreSQL producer &#40;and others?&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #70923 for SQL-Translator: Incorrect quoting behaviour in PostgreSQL producer &#40;and others?&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/SQL-Translator/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/SQL-Translator/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/SQL-Translator/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/SQL-Translator/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/SQL-Translator">SQL-Translator CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">70923</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/SQL-Translator/Active/">SQL-Translator</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
antony.gelberg [...] gmail.com

<br />
philip.allison [...] smoothwall.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-29610-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-29611-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




pg-quote.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/977054/508596/pg-quote.patch">
Tue Sep 13 06:06:06 2011 (708b) by philip.allison [...] smoothwall.net
</a>
</font></li>
</ul>


Reask-Schema-0.006-0.007-PostgreSQL.sql<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/792409/410723/Reask-Schema-0.006-0.007-PostgreSQL.sql">
Thu Jun 17 08:42:41 2010 (211b) by antony.gelberg [...] wayforth.com
</a>
</font></li>
</ul>


signature.asc<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/977054/508597/signature.asc">
Tue Sep 13 06:06:06 2011 (198b) by philip.allison [...] smoothwall.net
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;17&nbsp;08:42:41&nbsp;2010</span>
    <span class="description">antony.gelberg [...] wayforth.com - Ticket #58482:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Outputs invalid SQL &#40;PostgreSQL&#41;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve attached the diff produced by create_ddl_dir when attempting to
upgrade my schema.  I can&#39;t attach the entire schema but here&#39;s the
relevant table in 0.006:

CREATE TABLE &#34;query&#34; &#40;
  &#34;id&#34; serial NOT NULL,
  &#34;user&#34; integer NOT NULL,
  &#34;query&#34; text NOT NULL,
  &#34;shared&#34; boolean NOT NULL,
  &#34;stamp&#34; timestamp NOT NULL,
  &#34;language_code&#34; varchar&#40;2&#41; NOT NULL,
  PRIMARY KEY &#40;&#34;id&#34;&#41;
&#41;;
CREATE INDEX &#34;query_idx_user&#34; on &#34;query&#34; &#40;&#34;user&#34;&#41;;

and in 0.007:

CREATE TABLE &#34;query&#34; &#40;
  &#34;id&#34; serial NOT NULL,
  &#34;user&#34; integer,
  &#34;query&#34; text NOT NULL,
  &#34;shared&#34; boolean NOT NULL,
  &#34;stamp&#34; timestamp NOT NULL,
  &#34;language_code&#34; varchar&#40;2&#41; NOT NULL,
  PRIMARY KEY &#40;&#34;id&#34;&#41;
&#41;;
CREATE INDEX &#34;query_idx_user&#34; on &#34;query&#34; &#40;&#34;user&#34;&#41;;

As you see the only difference is that &#34;user&#34; is now allowed to be null.
 The first line in the attached file barfs - the second is fine &#40;once I
put double quotes round &#34;user&#34;&#41;.

Sorry I don&#39;t have the bandwidth to write a test but hope this is useful
info.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Reask-Schema-0.006-0.007-PostgreSQL.sql</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">-- Convert schema &#39;sql/Reask-Schema-0.006-PostgreSQL.sql&#39; to &#39;sql/Reask-Schema-0.007-PostgreSQL.sql&#39;:;

BEGIN;

ALTER TABLE query DROP CONSTRAINT ;

ALTER TABLE query ALTER COLUMN user DROP NOT NULL;


COMMIT;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Create even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;13&nbsp;06:06:06&nbsp;2011</span>
    <span class="description">philip.allison [...] smoothwall.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Incorrect quoting behaviour in PostgreSQL producer &#40;and others?&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 13 Sep 2011 11:05:44 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-SQL-Translator [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Philip Allison &lt;philip.allison [...] smoothwall.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello all,
        I&#39;ve discovered some interesting issues in the PostgreSQL producer
module surrounding quoting of table and field names.  The &#34;produce&#34;
function calls others in the module with arguments &#34;quote_table_names&#34;
and &#34;quote_field names&#34; set to either the double quote character or
empty, depending on whether or not the options with the same name are
set in the Translator instance itself &#40;lines 206 &#38; 207 of
lib/SQL/Translator/Producer/PostgreSQL.pm&#41;.  This works perfectly well
when calling produce, but occasionally other parts of the framework -
such as SQL::Translator::Diff - call *other* methods in the producer
modules directly.
        When, for example, produce_diff_sql&#40;&#41; in Diff calls
alter_drop_constraint&#40;&#41; in Producer::PostgreSQL directly, it does *not*
set &#34;quote_table_names&#34; or &#34;quote_field_names&#34; in the arguments, so the
method does *not* encase table or field names in quotes, regardless of
whether or not those options are set on the Translator itself.  If one
of the table names happens to be a reserved word, such as &#34;group&#34;, then
the resulting SQL contains syntax errors.

This can be worked around by setting &#34;quote_table_names&#34; and
&#34;quote_field_names&#34; directly in producer_args, as follows:

                sql_translator_args =&gt; {
                        add_drop_table =&gt; 0,
                        quote_table_names =&gt; 1,
                        quote_field_names =&gt; 1,
                        producer_args =&gt; {
                                quote_table_names =&gt; &#39;&#34;&#39;,
                                quote_field_names =&gt; &#39;&#34;&#39;,
                        },
                },

However, the documentation for the PostgreSQL producer does not mention
these options, and I do not think I should have to set these explicitly
to prevent generation of invalid SQL.

I have attached a documentation patch which adds mention of these
arguments to the PostgreSQL producer, but I am concerned that there may
be wider issues with quoting behaviour, across this and potentially
other Producer implementations.  Firstly, table or field names
corresponding to reserved words should always be quoted, otherwise the
resulting SQL will not work - IMHO this is not something that should be
optional*.  Secondly, I am confused by the way in which the top-level
Translator instance takes arguments which affect producer behaviour
outside of &#34;producer_args&#34; &#40;the first two occurrences of
&#34;quote_table_names&#34; and &#34;quote_field_names&#34; above&#41;, yet the Translator
instance is only passed as an argument to the &#34;produce&#34; method, not all
the other Producer functions.  Surely all the arguments which affect
producer behaviour should be in producer_args, or the Translator
instance should be passed into all Producer functions &#40;not just
produce&#41;, because it strikes me that the current inconsistency creates
fertile ground for bugs such as this by defining two conflicting ways of
interfacing to producers.

* The module does define a set of reserved words in %reserved, but does
not appear to use it anywhere in the code.

Regards
-- 
Philip Allison
Senior Developer

philip.allison@smoothwall.net

Smoothwall Ltd
1 John Charles Way, Leeds, LS12 6QA United Kingdom 
Telephone:  USA: 1 800 959 3760  Europe: +44 &#40;0&#41; 8701 999500
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.smoothwall.net">http://www.smoothwall.net</a></span>

Smoothwall Limited is registered in England, Company Number: 4298247.
Any opinions stated in this message are solely those of the author.
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/977054/508597/signature.asc">Download signature.asc</a><br />
<span class="downloadcontenttype">application/pgp-signature 198b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;26&nbsp;04:15:34&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io - Ticket #58482:  Merged into ticket #70923</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;26&nbsp;04:15:34&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io -  Merged into ticket #70923</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
