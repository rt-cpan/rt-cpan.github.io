<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #111552 for Term-ANSIColor: Reduce memory footprint of Term::ANSIColor with perl522</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #111552 for Term-ANSIColor: Reduce memory footprint of Term::ANSIColor with perl522</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Term-ANSIColor/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Term-ANSIColor/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Term-ANSIColor/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Term-ANSIColor/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Term-ANSIColor">Term-ANSIColor CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">111552</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Term-ANSIColor/Active/">Term-ANSIColor</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">RRA [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
me [...] eboxr.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-239548-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-239549-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
4.05    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;29&nbsp;12:31:57&nbsp;2016</span>
    <span class="description">me [...] eboxr.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Reduce memory footprint of Term::ANSIColor with perl522</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Term::ANSIColor is using 70% more memory than it was in perl514 with perl522.

We can reduce this bloat to less than 10% by avoiding to import
Carp and simplifying some \w regexp as we do not need unicode here.

FYI, the bloat is coming from <span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/commitdiff/bcb875216f24899d543c036aebdba0835f8d22e6">http://perl5.git.perl.org/perl.git/commitdiff/bcb875216f24899d543c036aebdba0835f8d22e6</a></span>

View <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/Public/Bug/Display.html?id=127392">https://rt.perl.org/Public/Bug/Display.html?id=127392</a></span> for more details
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Reduce-memory-footprint-of-Term-ANSIColor-with-perl5.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 219ddda181886fa511b4f4a92ca31d7f4d98d25d Mon Sep 17 00:00:00 2001
From: Nicolas R &lt;cpan@eboxr.com&gt;
Date: Fri, 29 Jan 2016 11:25:18 -0600
Subject: [PATCH] Reduce memory footprint of Term::ANSIColor with perl522

Term::ANSIColor is using 70% more memory than it was in perl514.
We can reduce this bloat to less than 10% by avoiding to import
Carp and simplifying some \w regexp.
---
 lib/Term/ANSIColor.pm | 12 +++++++++---
 1 file changed, 9 insertions&#40;+&#41;, 3 deletions&#40;-&#41;

diff --git a/lib/Term/ANSIColor.pm b/lib/Term/ANSIColor.pm
index ace4d47..1f317fe 100644
--- a/lib/Term/ANSIColor.pm
+++ b/lib/Term/ANSIColor.pm
@@ -23,7 +23,6 @@ use 5.006;
 use strict;
 use warnings;
 
-use Carp qw&#40;croak&#41;;
 use Exporter &#40;&#41;;
 
 # use Exporter plus @ISA instead of use base for 5.6 compatibility.
@@ -202,6 +201,11 @@ if &#40;exists $ENV{ANSI_COLORS_ALIASES}&#41; {
     }
 }
 
+sub croak {
+    require Carp;
+    return Carp::croak&#40; @_ &#41;;
+}
+
 # Stores the current color stack maintained by PUSHCOLOR and POPCOLOR.  This
 # is global and therefore not threadsafe.
 our @COLORSTACK;
@@ -236,7 +240,9 @@ our @COLORSTACK;
 ## no critic &#40;ClassHierarchies::ProhibitAutoloading&#41;
 ## no critic &#40;Subroutines::RequireArgUnpacking&#41;
 sub AUTOLOAD {
-    my &#40;$sub, $attr&#41; = $AUTOLOAD =~ m{ \A &#40;[\w:]*::&#40;[[:upper:]\d_]+&#41;&#41; \z }xms;
+    my &#40; $sub &#41; = $AUTOLOAD =~ /^&#40;[a-zA-Z0-9:_]+&#41;$/; # untaint
+    my $attr = &#40; split&#40;&#39;::&#39;, $sub &#41; &#41;[-1];
+    undef $attr if &#40; $attr &#38;&#38; $attr !~ qr{^[A-Z0-9_]+$} &#41; || $sub !~ qr{::};
 
     # Check if we were called with something that doesn&#39;t look like an
     # attribute.
@@ -501,7 +507,7 @@ sub coloralias {
             return $ATTRIBUTES_R{ $ALIASES{$alias} };
         }
     }
-    if &#40;$alias !~ m{ \A [\w._-]+ \z }xms&#41; {
+    if &#40; $alias !~ m{ \A [a-zA-Z0-9._-]+ \z }xms &#41; {
         croak&#40;qq{Invalid alias name &#34;$alias&#34;}&#41;;
     } elsif &#40;$ATTRIBUTES{$alias}&#41; {
         croak&#40;qq{Cannot alias standard color &#34;$alias&#34;}&#41;;
-- 
2.7.0

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;29&nbsp;14:40:35&nbsp;2016</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2016-01-29 12:31:57, atoomic wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Term::ANSIColor is using 70% more memory than it was in perl514 with
&gt; perl522.
&gt; 
&gt; We can reduce this bloat to less than 10% by avoiding to import
&gt; Carp and simplifying some \w regexp as we do not need unicode here.
&gt; 
&gt; FYI, the bloat is coming from
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/commitdiff/bcb875216f24899d543c036aebdba0835f8d22e6">http://perl5.git.perl.org/perl.git/commitdiff/bcb875216f24899d543c036aebdba0835f8d22e6</a></span>
&gt; 
&gt; View <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/Public/Bug/Display.html?id=127392">https://rt.perl.org/Public/Bug/Display.html?id=127392</a></span> for more
&gt; details
</div>
The patch does not use the same code style as the original &#40;e.g. the original code does not have extra spaces after and before parentheses&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;29&nbsp;14:40:35&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;31&nbsp;03:19:51&nbsp;2016</span>
    <span class="description">RRA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #111552] Reduce memory footprint of Term::ANSIColor with perl522</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 31 Jan 2016 00:18:27 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;Atoomic via RT&#34; &lt;bug-Term-ANSIColor [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Russ Allbery &lt;rra [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&#34;Atoomic via RT&#34; &lt;bug-Term-ANSIColor@rt.cpan.org&gt; writes:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Fri Jan 29 12:31:57 2016: Request 111552 was acted upon.
&gt; Transaction: Ticket created by atoomic
&gt;        Queue: Term-ANSIColor
&gt;      Subject: Reduce memory footprint of Term::ANSIColor with perl522
&gt;    Broken in: &#40;no value&#41;
&gt;     Severity: &#40;no value&#41;
&gt;        Owner: Nobody
&gt;   Requestors: me@eboxr.com
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=111552">https://rt.cpan.org/Ticket/Display.html?id=111552</a></span> &gt;
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Term::ANSIColor is using 70% more memory than it was in perl514 with
&gt; perl522.
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; We can reduce this bloat to less than 10% by avoiding to import
&gt; Carp and simplifying some \w regexp as we do not need unicode here.
</div>
Thanks!  I&#39;ll take a look.

I&#39;m unenthused by having to work around Carp being bloated.  :&#40;  I feel
like this is putting the program burden in the wrong place, and it&#39;s weird
to have to add these strange workarounds to other modules.  It would be
nice if Carp were just more efficient; there are various approaches it
could take internally to not load code until it&#39;s actually called.  But,
well, I don&#39;t feel like trying to fix Carp at the moment, so I guess I
should work around it.  :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  sub AUTOLOAD {
&gt; -    my &#40;$sub, $attr&#41; = $AUTOLOAD =~ m{ \A &#40;[\w:]*::&#40;[[:upper:]\d_]+&#41;&#41; \z }xms;
&gt; +    my &#40; $sub &#41; = $AUTOLOAD =~ /^&#40;[a-zA-Z0-9:_]+&#41;$/; # untaint
&gt; +    my $attr = &#40; split&#40;&#39;::&#39;, $sub &#41; &#41;[-1];
&gt; +    undef $attr if &#40; $attr &#38;&#38; $attr !~ qr{^[A-Z0-9_]+$} &#41; || $sub !~ qr{::};
&gt;  
&gt;      # Check if we were called with something that doesn&#39;t look like an
&gt;      # attribute.
&gt; @@ -501,7 +507,7 @@ sub coloralias {
&gt;              return $ATTRIBUTES_R{ $ALIASES{$alias} };
&gt;          }
&gt;      }
&gt; -    if &#40;$alias !~ m{ \A [\w._-]+ \z }xms&#41; {
&gt; +    if &#40; $alias !~ m{ \A [a-zA-Z0-9._-]+ \z }xms &#41; {
&gt;          croak&#40;qq{Invalid alias name &#34;$alias&#34;}&#41;;
&gt;      } elsif &#40;$ATTRIBUTES{$alias}&#41; {
&gt;          croak&#40;qq{Cannot alias standard color &#34;$alias&#34;}&#41;;
</div>
The second change is fine.  The first change is really awkward and
strange, and makes the code much harder to read.  Is all the machinery
with split actually necessary, or can I just replace \w with a-zA-Z0-9_
and replace [:upper:] with A-Z and achieve the same end?  I&#39;d much prefer
that, and it seems like that would get out of the locale problem that you
said was causing the bloat.

-- 
#!/usr/bin/perl -- Russ Allbery, Just Another Perl Hacker
$^=q;@!&gt;~|{&gt;krw&gt;yn{u&lt;$$&lt;[~||&lt;Juukn{=,&lt;S~|}&lt;Jwx}qn{&lt;Yn{u&lt;Qjltn{ &gt; 0gFzD gD,
 00Fz, 0,,&#40; 0hF 0g&#41;F/=, 0&gt; &#34;L$/GEIFewe{,$/ 0C$~&gt; &#34;@=,m,|,&#40;e 0.&#41;, 01,pnn,y{
rw} &gt;;,$0=q,$,,&#40;$_=$^&#41;=~y,$/ C-~&gt;&lt;@=\n\r,-~$:-u/ #y,d,s,&#40;\$.&#41;,$1,gee,print
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;03&nbsp;14:13:43&nbsp;2016</span>
    <span class="description">me [...] eboxr.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This perfectly fine if you replace \w by A-Z0-9_ in the first AUTOLOAD regexp
with the suggesting original patch &#40;which increase difficulty to read &#38; maintain &#41;:
VmRSS:      2572 kB
with simply replacing \w =&gt; my &#40;$sub, $attr&#41; = $AUTOLOAD =~ m{ \A &#40;[A-Z0-9_:]*::&#40;[[:upper:]\d_]+&#41;&#41; \z }xms;
VmRSS:      2588 kB

So I think this second option is definitely the way to go, the few extra kB worth the maintainability.

Your analyze on Carp is correct, but would move the conversation to totally different one...
The Carp fix I&#39;m suggesting is simply a &#34;load it on demand&#34; &#40;if we need it, which in most of the cases we dont&#41;.

Thanks for considering these changes, in a future release.
Let me know if you want me to provide you an updated patch.

nicolas 

On Sun Jan 31 03:19:51 2016, RRA wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#34;Atoomic via RT&#34; &lt;bug-Term-ANSIColor@rt.cpan.org&gt; writes:
&gt; 
<div class="message-stanza open">&gt; &gt; Fri Jan 29 12:31:57 2016: Request 111552 was acted upon.
&gt; &gt; Transaction: Ticket created by atoomic
&gt; &gt;        Queue: Term-ANSIColor
&gt; &gt;      Subject: Reduce memory footprint of Term::ANSIColor with perl522
&gt; &gt;    Broken in: &#40;no value&#41;
&gt; &gt;     Severity: &#40;no value&#41;
&gt; &gt;        Owner: Nobody
&gt; &gt;   Requestors: me@eboxr.com
&gt; &gt;       Status: new
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=111552">https://rt.cpan.org/Ticket/Display.html?id=111552</a></span> &gt;
</div>&gt; 
<div class="message-stanza open">&gt; &gt; Term::ANSIColor is using 70% more memory than it was in perl514 with
&gt; &gt; perl522.
</div>&gt; 
<div class="message-stanza open">&gt; &gt; We can reduce this bloat to less than 10% by avoiding to import
&gt; &gt; Carp and simplifying some \w regexp as we do not need unicode here.
</div>&gt; 
&gt; Thanks!  I&#39;ll take a look.
&gt; 
&gt; I&#39;m unenthused by having to work around Carp being bloated.  :&#40;  I
&gt; feel
&gt; like this is putting the program burden in the wrong place, and it&#39;s
&gt; weird
&gt; to have to add these strange workarounds to other modules.  It would
&gt; be
&gt; nice if Carp were just more efficient; there are various approaches it
&gt; could take internally to not load code until it&#39;s actually called.
&gt; But,
&gt; well, I don&#39;t feel like trying to fix Carp at the moment, so I guess I
&gt; should work around it.  :&#41;
&gt; 
<div class="message-stanza open">&gt; &gt; sub AUTOLOAD {
&gt; &gt; -    my &#40;$sub, $attr&#41; = $AUTOLOAD =~ m{ \A
&gt; &gt; &#40;[\w:]*::&#40;[[:upper:]\d_]+&#41;&#41; \z }xms;
&gt; &gt; +    my &#40; $sub &#41; = $AUTOLOAD =~ /^&#40;[a-zA-Z0-9:_]+&#41;$/; # untaint
&gt; &gt; +    my $attr = &#40; split&#40;&#39;::&#39;, $sub &#41; &#41;[-1];
&gt; &gt; +    undef $attr if &#40; $attr &#38;&#38; $attr !~ qr{^[A-Z0-9_]+$} &#41; || $sub !~
&gt; &gt; qr{::};
&gt; &gt;
&gt; &gt; # Check if we were called with something that doesn&#39;t look like an
&gt; &gt; # attribute.
&gt; &gt; @@ -501,7 +507,7 @@ sub coloralias {
&gt; &gt;         return $ATTRIBUTES_R{ $ALIASES{$alias} };
&gt; &gt;     }
&gt; &gt; }
&gt; &gt; -    if &#40;$alias !~ m{ \A [\w._-]+ \z }xms&#41; {
&gt; &gt; +    if &#40; $alias !~ m{ \A [a-zA-Z0-9._-]+ \z }xms &#41; {
&gt; &gt;     croak&#40;qq{Invalid alias name &#34;$alias&#34;}&#41;;
&gt; &gt; } elsif &#40;$ATTRIBUTES{$alias}&#41; {
&gt; &gt;     croak&#40;qq{Cannot alias standard color &#34;$alias&#34;}&#41;;
</div>&gt; 
&gt; The second change is fine.  The first change is really awkward and
&gt; strange, and makes the code much harder to read.  Is all the machinery
&gt; with split actually necessary, or can I just replace \w with a-zA-Z0-
&gt; 9_
&gt; and replace [:upper:] with A-Z and achieve the same end?  I&#39;d much
&gt; prefer
&gt; that, and it seems like that would get out of the locale problem that
&gt; you
&gt; said was causing the bloat.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;27&nbsp;21:56:52&nbsp;2016</span>
    <span class="description">RRA [...] cpan.org -  Fixed in 4.05 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;27&nbsp;21:56:53&nbsp;2016</span>
    <span class="description">RRA [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;27&nbsp;21:56:54&nbsp;2016</span>
    <span class="description">RRA [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
