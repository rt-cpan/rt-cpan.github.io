<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #75924 for ZeroMQ: Segfault when receiving</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #75924 for ZeroMQ: Segfault when receiving</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=ZeroMQ">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=ZeroMQ">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=ZeroMQ">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=ZeroMQ">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/ZeroMQ">ZeroMQ CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">75924</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=ZeroMQ">ZeroMQ</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
rafl [...] debian.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-233900-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-233901-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=75924">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052704" href="/Public/Bug/Display.html?id=75924#txn-1052704">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;20&nbsp;15:42:37&nbsp;2012</span>
    <span class="description">rafl [...] debian.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Segfault when receiving</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 20 Mar 2012 20:42:26 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-ZeroMQ [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Florian Ragwitz &lt;rafl [...] debian.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052704/550490/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550490">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On a perl 5.14.4 compiled with -DDEBUGGING and -Duseithreads, running
t/006_anyevent.t of ZeroMQ 0.20 compiled against version 2.1.11 of zmq,
results in a segfault.

$ ZMQ_TRACE=1 gdb --args perl -Mblib t/006_anyevent.t
GNU gdb &#40;GDB&#41; 7.4-debian
Copyright &#40;C&#41; 2012 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://gnu.org/licenses/gpl.html">http://gnu.org/licenses/gpl.html</a></span>&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type &#34;show copying&#34;
and &#34;show warranty&#34; for details.
This GDB was configured as &#34;x86_64-linux-gnu&#34;.
For bug reporting instructions, please see:
Reading symbols from /home/rafl/.perl5141/bin/perl...done.
&#40;gdb&#41; r
Starting program: /home/rafl/.perl5141/bin/perl -Mblib t/006_anyevent.t
[Thread debugging using libthread_db enabled]
Using host libthread_db library &#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;.
ok 1 - use ZeroMQ::Raw;
ok 2 - use ZeroMQ::Constants;
# Using zmq_getsockopt + AE
#  + Extracting ZMQ_FD
#  + Creating AE::io for fd
# Waiting...
[New Thread 0x7ffff43cc700 &#40;LWP 24657&#41;]
[New Thread 0x7ffff3bcb700 &#40;LWP 24658&#41;]
# Sending data to server

Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7ffff3bcb700 &#40;LWP 24658&#41;]
0x0000000000531b36 in Perl_safesysfree &#40;where=0x11c50d8&#41; at util.c:256
256         DEBUG_m&#40; PerlIO_printf&#40;Perl_debug_log, &#34;0x%&#34;UVxf&#34;: &#40;%05ld&#41; free\n&#34;,PTR2UV&#40;where&#41;,&#40;long&#41;PL_an++&#41;&#41;;
&#40;gdb&#41; thread apply all bt

Thread 3 &#40;Thread 0x7ffff3bcb700 &#40;LWP 24658&#41;&#41;:
#0  0x0000000000531b36 in Perl_safesysfree &#40;where=0x11c50d8&#41; at util.c:256
#1  0x00007ffff57b7347 in PerlZMQ_free_string &#40;data=0x11c50d8, hint=0x0&#41; at xs/perl_zeromq.xs:190
#2  0x00007ffff55a2cb2 in zmq_msg_close &#40;msg_=0x11e4220&#41; at zmq.cpp:152
#3  zmq_msg_close &#40;msg_=0x11e4220&#41; at zmq.cpp:130
#4  0x00007ffff558ae75 in zmq::encoder_t::message_ready &#40;this=0x11e41d8&#41; at encoder.cpp:56
#5  0x00007ffff55a44d4 in get_data &#40;offset_=&lt;optimized out&gt;, size_=&lt;optimized out&gt;, data_=&lt;optimized out&gt;, this=&lt;optimized out&gt;&#41; at encoder.hpp:80
#6  zmq::zmq_engine_t::out_event &#40;this=0x11e4120&#41; at zmq_engine.cpp:165
#7  0x00007ffff558b5f2 in zmq::epoll_t::loop &#40;this=0xb6e210&#41; at epoll.cpp:157
#8  0x00007ffff559f206 in thread_routine &#40;arg_=0xb6e280&#41; at thread.cpp:75
#9  0x00007ffff70efb50 in start_thread &#40;arg=&lt;optimized out&gt;&#41; at pthread_create.c:304
#10 0x00007ffff6e3a90d in clone &#40;&#41; at ../sysdeps/unix/sysv/linux/x86_64/clone.S:112
#11 0x0000000000000000 in ?? &#40;&#41;

Thread 2 &#40;Thread 0x7ffff43cc700 &#40;LWP 24657&#41;&#41;:
#0  0x00007ffff6e3af63 in epoll_wait &#40;&#41; at ../sysdeps/unix/syscall-template.S:82
#1  0x00007ffff558b57f in zmq::epoll_t::loop &#40;this=0xab5580&#41; at epoll.cpp:142
#2  0x00007ffff559f206 in thread_routine &#40;arg_=0xab55f0&#41; at thread.cpp:75
#3  0x00007ffff70efb50 in start_thread &#40;arg=&lt;optimized out&gt;&#41; at pthread_create.c:304
#4  0x00007ffff6e3a90d in clone &#40;&#41; at ../sysdeps/unix/sysv/linux/x86_64/clone.S:112
#5  0x0000000000000000 in ?? &#40;&#41;

Thread 1 &#40;Thread 0x7ffff7fd2700 &#40;LWP 24651&#41;&#41;:
#0  0x00007ffff6e2fcc3 in *__GI___poll &#40;fds=&lt;optimized out&gt;, nfds=&lt;optimized out&gt;, timeout=-1&#41; at ../sysdeps/unix/sysv/linux/poll.c:87
#1  0x00007ffff5599f21 in zmq::signaler_t::wait &#40;this=&lt;optimized out&gt;, timeout_=&lt;optimized out&gt;&#41; at signaler.cpp:145
#2  0x00007ffff558dd62 in zmq::mailbox_t::recv &#40;this=0xb6e5e0, cmd_=0x7fffffffcf20, timeout_=&lt;optimized out&gt;&#41; at mailbox.cpp:74
#3  0x00007ffff559b2bd in zmq::socket_base_t::process_commands &#40;this=0xb6e500, timeout_=&lt;optimized out&gt;, throttle_=false&#41; at socket_base.cpp:713
#4  0x00007ffff559b526 in zmq::socket_base_t::recv &#40;this=0xb6e500, msg_=0x7fffffffd130, flags_=0&#41; at socket_base.cpp:618
#5  0x00007ffff57c88e3 in XS_ZeroMQ__Raw_zmq_recv &#40;my_perl=0xa83010, cv=0x11111c0&#41; at xs/perl_zeromq.xs:492
#6  0x00000000005a9a98 in Perl_pp_entersub &#40;my_perl=0xa83010&#41; at pp_hot.c:3046
#7  0x0000000000530bd8 in Perl_runops_debug &#40;my_perl=0xa83010&#41; at dump.c:2266
#8  0x00000000004537d4 in S_run_body &#40;my_perl=0xa83010, oldscope=1&#41; at perl.c:2350
#9  0x00000000004529ce in perl_run &#40;my_perl=0xa83010&#41; at perl.c:2268
#10 0x000000000041cd7d in main &#40;argc=3, argv=0x7fffffffd788, env=0x7fffffffd7a8&#41; at perlmain.c:120
&#40;gdb&#41; p PL_an
Cannot access memory at address 0x788
&#40;gdb&#41; p my_perl
$1 = &#40;PerlInterpreter *&#41; 0x0

In there you can see PerlZMQ_free_string attempting to free a chunk of
memory seemingly allocated for it by the perl interpreter in thread
1. However, I don&#39;t see how that could work without without that thread
#3 having a way to get to the interpreter used to allocate that memory
in the first place.

Depending on perl&#39;s configuration, that might either be a straight
lookup in an exported global, or getting user data attached to a thread
&#40;cthread_data or pthread_getspecific depending on your system&#39;s thread
library&#41;.

In my configuration, the dTHX done in Perl_safesysfree will boil down to
a pthread_getspecific.

However, the thread #3, as created by zmq, not by perl&#39;s cloning
mechanism, will not have a perl interpreter as its user data, causing
freeing memory allocated in one thread on one perl interpreter fail when
done from another thread not closing over the same interpreter.

Changing the allocator used in the ZeroMQ module from perl&#39;s allocator
to libc&#39;s malloc, this particular issue goes away.

&#40;not that the test would start passing, but now it doesn&#39;t shit itself
anymore when trying to free memory in different threads&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052736" href="/Public/Bug/Display.html?id=75924#txn-1052736">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;20&nbsp;17:57:36&nbsp;2012</span>
    <span class="description">dmaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052736/550509/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550509">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 47b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">thanks for the diagnosis! but yewwwwww... 
hmm.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052739" href="/Public/Bug/Display.html?id=75924#txn-1052739">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;20&nbsp;17:57:37&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.227284</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
