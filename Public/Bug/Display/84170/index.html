<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #84170 for DBD-Oracle: after a fetch_scroll&#40;&#41;, fetch&#40;&#41; never returns undef after the last row</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #84170 for DBD-Oracle: after a fetch_scroll&#40;&#41;, fetch&#40;&#41; never returns undef after the last row</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-Oracle/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-Oracle/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-Oracle/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-Oracle/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/pythian/DBD-Oracle/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-Oracle">DBD-Oracle CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">84170</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-Oracle/Active/">DBD-Oracle</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
DAMI [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10192-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.58    </td>
  </tr>
  <tr id="CF-10193-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;23&nbsp;19:40:23&nbsp;2013</span>
    <span class="description">DAMI [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> after a fetch_scroll&#40;&#41;, fetch&#40;&#41; never returns undef after the
 last row</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yet another problem with scrollable cursors, similar to #76695 and #76410 : if we use ora_fetch_scroll&#40;&#41; to go to some specific row, and then loop over the remaing rows with one of the fetch_* methods, then we get stuck on the last row &#40;fetch&#40;&#41; never returns undef&#41;.


Ex:
my $sql = &#34;SELECT table_name FROM all_tables ORDER BY table_name &#34;;
my $sth = $dbh-&gt;prepare&#40;$sql, {ora_exe_mode =&gt; OCI_STMT_SCROLLABLE_READONLY}&#41;;
$sth-&gt;execute;
$sth-&gt;ora_fetch_scroll&#40;OCI_FETCH_LAST, 0&#41;;
$sth-&gt;ora_fetch_scroll&#40;OCI_FETCH_RELATIVE, -2&#41;;
for &#40;1 .. 5&#41; {         # purposedly trying beyond the last row
  my $r = $sth-&gt;fetch; # should get undef at some point .. but no
  say @$r;
}

Yields:
WRI$_ADV_ASA_RECO_DATA
WRR$_REPLAY_CALL_FILTER
WRR$_REPLAY_CALL_FILTER
WRR$_REPLAY_CALL_FILTER
WRR$_REPLAY_CALL_FILTER
...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;25&nbsp;14:41:22&nbsp;2013</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Mar 23 19:40:23 2013, DAMI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Yet another problem with scrollable cursors, similar to #76695 and
&gt;    #76410 : if we use ora_fetch_scroll&#40;&#41; to go to some specific row,
&gt;    and then loop over the remaing rows with one of the fetch_*
&gt;    methods, then we get stuck on the last row &#40;fetch&#40;&#41; never returns
&gt;    undef&#41;.
&gt; 
&gt; 
&gt; Ex:
&gt; my $sql = &#34;SELECT table_name FROM all_tables ORDER BY table_name &#34;;
&gt; my $sth = $dbh-&gt;prepare&#40;$sql, {ora_exe_mode =&gt;
&gt;    OCI_STMT_SCROLLABLE_READONLY}&#41;;
&gt; $sth-&gt;execute;
&gt; $sth-&gt;ora_fetch_scroll&#40;OCI_FETCH_LAST, 0&#41;;
&gt; $sth-&gt;ora_fetch_scroll&#40;OCI_FETCH_RELATIVE, -2&#41;;
&gt; for &#40;1 .. 5&#41; {         # purposedly trying beyond the last row
&gt;   my $r = $sth-&gt;fetch; # should get undef at some point .. but no
&gt;   say @$r;
&gt; }
&gt; 
&gt; Yields:
&gt; WRI$_ADV_ASA_RECO_DATA
&gt; WRR$_REPLAY_CALL_FILTER
&gt; WRR$_REPLAY_CALL_FILTER
&gt; WRR$_REPLAY_CALL_FILTER
&gt; WRR$_REPLAY_CALL_FILTER
&gt; ...
</div>
Thank you for this report.

I&#39;ll try and find some tuits to look in to it soon but my focus is elsewhere right now and I did not write scrollable cursor support &#40;John Scoles did&#41;.

You could perhaps help yourself by enabling ora_verbose=6 in the connect method call and looking at the trace output. My recollection is that the code is not that complex and you&#39;ll find most of it in oci8.c.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;25&nbsp;14:41:23&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;25&nbsp;15:08:00&nbsp;2013</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Mar 25 14:41:22 2013, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sat Mar 23 19:40:23 2013, DAMI wrote:
<div class="message-stanza open">&gt; &gt; Yet another problem with scrollable cursors, similar to #76695 and
&gt; &gt;    #76410 : if we use ora_fetch_scroll&#40;&#41; to go to some specific row,
&gt; &gt;    and then loop over the remaing rows with one of the fetch_*
&gt; &gt;    methods, then we get stuck on the last row &#40;fetch&#40;&#41; never returns
&gt; &gt;    undef&#41;.
&gt; &gt;
&gt; &gt;
&gt; &gt; Ex:
&gt; &gt; my $sql = &#34;SELECT table_name FROM all_tables ORDER BY table_name &#34;;
&gt; &gt; my $sth = $dbh-&gt;prepare&#40;$sql, {ora_exe_mode =&gt;
&gt; &gt;    OCI_STMT_SCROLLABLE_READONLY}&#41;;
&gt; &gt; $sth-&gt;execute;
&gt; &gt; $sth-&gt;ora_fetch_scroll&#40;OCI_FETCH_LAST, 0&#41;;
&gt; &gt; $sth-&gt;ora_fetch_scroll&#40;OCI_FETCH_RELATIVE, -2&#41;;
&gt; &gt; for &#40;1 .. 5&#41; {         # purposedly trying beyond the last row
&gt; &gt;   my $r = $sth-&gt;fetch; # should get undef at some point .. but no
&gt; &gt;   say @$r;
&gt; &gt; }
&gt; &gt;
&gt; &gt; Yields:
&gt; &gt; WRI$_ADV_ASA_RECO_DATA
&gt; &gt; WRR$_REPLAY_CALL_FILTER
&gt; &gt; WRR$_REPLAY_CALL_FILTER
&gt; &gt; WRR$_REPLAY_CALL_FILTER
&gt; &gt; WRR$_REPLAY_CALL_FILTER
&gt; &gt; ...
</div>&gt; 
&gt; Thank you for this report.
&gt; 
&gt; I&#39;ll try and find some tuits to look in to it soon but my focus is
&gt; elsewhere right now and I did not write scrollable cursor support
&gt; &#40;John Scoles did&#41;.
&gt; 
&gt; You could perhaps help yourself by enabling ora_verbose=6 in the
&gt; connect method call and looking at the trace output. My recollection
&gt; is that the code is not that complex and you&#39;ll find most of it in
&gt; oci8.c.
&gt; 
&gt; Martin
</div>
ok, I saved someone &#40;perhaps me&#41; some time on this one:


use DBI;
use strict;
use warnings;
use DBD::Oracle qw&#40;:ora_fetch_orient :ora_exe_modes&#41;;

my $h = DBI-&gt;connect&#40;&#34;dbi:Oracle:host=xxx;sid=xxx&#34;,&#34;xxx&#34;,&#34;xxx&#34;,
                     {RaiseError =&gt; 1, ora_verbose =&gt; 6}&#41;;
eval {
    $h-&gt;do&#40;q/drop table mje/&#41;;
};

$h-&gt;do&#40;q/create table mje &#40;a int&#41;/&#41;;

foreach &#40;1..5&#41; {
    $h-&gt;do&#40;qq/insert into mje values&#40;$_&#41;/&#41;;
}
my $sql = &#34;SELECT * from mje&#34;;
my $sth = $h-&gt;prepare&#40;$sql, {ora_exe_mode =&gt; OCI_STMT_SCROLLABLE_READONLY}&#41;;
$sth-&gt;execute;
$sth-&gt;ora_fetch_scroll&#40;OCI_FETCH_LAST, 0&#41;;
$sth-&gt;ora_fetch_scroll&#40;OCI_FETCH_RELATIVE, -2&#41;;

for &#40;1 .. 5&#41; { # purposedly trying beyond the last row
    my $r = $sth-&gt;fetch; # should get undef at some point .. but no
    print @$r, &#34;\n&#34;;
}

produces trace output:

4
        dbd_st_fetch 1 fields...
        Scrolling Fetch, position before fetch=4, Orientation = OCI_FETCH_NEXT , Fetchoffset =1
        OCIStmtFetch&#40;8473a74,8467e34,1,2,1&#41;=SUCCESS &lt;--- NOTICE SUCCESS
        OCIAttrGet&#40;8473a74,OCI_HTYPE_STMT,848aaf0,0,OCI_ATTR_CURRENT_POSITION,8467e34&#41;=SUCCESS
        Scrolling Fetch, postion after fetch=5
        dbd_st_fetched 1 fields with status of 0&#40;SUCCESS&#41;
        field #1 with rc=0&#40;OK&#41;

                821b6c0 &#40;field=0&#41;: &#39;5&#39;
5
        dbd_st_fetch 1 fields...
        Scrolling Fetch, position before fetch=5, Orientation = OCI_FETCH_NEXT , Fetchoffset =1
        OCIStmtFetch&#40;8473a74,8467e34,1,2,1&#41;=NO_DATA &lt;--- NOTICE NO_DATA

Seems like the scrollable cursor code is not paying attention to NO_DATA.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;25&nbsp;15:12:24&nbsp;2013</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Mar 25 15:08:00 2013, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Mar 25 14:41:22 2013, MJEVANS wrote:
<div class="message-stanza open">&gt; &gt; On Sat Mar 23 19:40:23 2013, DAMI wrote:
<div class="message-stanza open">&gt; &gt; &gt; Yet another problem with scrollable cursors, similar to #76695 and
&gt; &gt; &gt;    #76410 : if we use ora_fetch_scroll&#40;&#41; to go to some specific
</div></div>&gt; row,
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt;    and then loop over the remaing rows with one of the fetch_*
&gt; &gt; &gt;    methods, then we get stuck on the last row &#40;fetch&#40;&#41; never
</div></div>&gt; returns
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt;    undef&#41;.
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; Ex:
&gt; &gt; &gt; my $sql = &#34;SELECT table_name FROM all_tables ORDER BY table_name
</div></div>&gt; &#34;;
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; my $sth = $dbh-&gt;prepare&#40;$sql, {ora_exe_mode =&gt;
&gt; &gt; &gt;    OCI_STMT_SCROLLABLE_READONLY}&#41;;
&gt; &gt; &gt; $sth-&gt;execute;
&gt; &gt; &gt; $sth-&gt;ora_fetch_scroll&#40;OCI_FETCH_LAST, 0&#41;;
&gt; &gt; &gt; $sth-&gt;ora_fetch_scroll&#40;OCI_FETCH_RELATIVE, -2&#41;;
&gt; &gt; &gt; for &#40;1 .. 5&#41; {         # purposedly trying beyond the last row
&gt; &gt; &gt;   my $r = $sth-&gt;fetch; # should get undef at some point .. but no
&gt; &gt; &gt;   say @$r;
&gt; &gt; &gt; }
&gt; &gt; &gt;
&gt; &gt; &gt; Yields:
&gt; &gt; &gt; WRI$_ADV_ASA_RECO_DATA
&gt; &gt; &gt; WRR$_REPLAY_CALL_FILTER
&gt; &gt; &gt; WRR$_REPLAY_CALL_FILTER
&gt; &gt; &gt; WRR$_REPLAY_CALL_FILTER
&gt; &gt; &gt; WRR$_REPLAY_CALL_FILTER
&gt; &gt; &gt; ...
</div>&gt; &gt;
&gt; &gt; Thank you for this report.
&gt; &gt;
&gt; &gt; I&#39;ll try and find some tuits to look in to it soon but my focus is
&gt; &gt; elsewhere right now and I did not write scrollable cursor support
&gt; &gt; &#40;John Scoles did&#41;.
&gt; &gt;
&gt; &gt; You could perhaps help yourself by enabling ora_verbose=6 in the
&gt; &gt; connect method call and looking at the trace output. My recollection
&gt; &gt; is that the code is not that complex and you&#39;ll find most of it in
&gt; &gt; oci8.c.
&gt; &gt;
&gt; &gt; Martin
</div>&gt; 
&gt; ok, I saved someone &#40;perhaps me&#41; some time on this one:
&gt; 
&gt; 
&gt; use DBI;
&gt; use strict;
&gt; use warnings;
&gt; use DBD::Oracle qw&#40;:ora_fetch_orient :ora_exe_modes&#41;;
&gt; 
&gt; my $h = DBI-&gt;connect&#40;&#34;dbi:Oracle:host=xxx;sid=xxx&#34;,&#34;xxx&#34;,&#34;xxx&#34;,
&gt;                      {RaiseError =&gt; 1, ora_verbose =&gt; 6}&#41;;
&gt; eval {
&gt;     $h-&gt;do&#40;q/drop table mje/&#41;;
&gt; };
&gt; 
&gt; $h-&gt;do&#40;q/create table mje &#40;a int&#41;/&#41;;
&gt; 
&gt; foreach &#40;1..5&#41; {
&gt;     $h-&gt;do&#40;qq/insert into mje values&#40;$_&#41;/&#41;;
&gt; }
&gt; my $sql = &#34;SELECT * from mje&#34;;
&gt; my $sth = $h-&gt;prepare&#40;$sql, {ora_exe_mode =&gt;
&gt; OCI_STMT_SCROLLABLE_READONLY}&#41;;
&gt; $sth-&gt;execute;
&gt; $sth-&gt;ora_fetch_scroll&#40;OCI_FETCH_LAST, 0&#41;;
&gt; $sth-&gt;ora_fetch_scroll&#40;OCI_FETCH_RELATIVE, -2&#41;;
&gt; 
&gt; for &#40;1 .. 5&#41; { # purposedly trying beyond the last row
&gt;     my $r = $sth-&gt;fetch; # should get undef at some point .. but no
&gt;     print @$r, &#34;\n&#34;;
&gt; }
&gt; 
&gt; produces trace output:
&gt; 
&gt; 4
&gt;         dbd_st_fetch 1 fields...
&gt;         Scrolling Fetch, position before fetch=4, Orientation =
&gt; OCI_FETCH_NEXT , Fetchoffset =1
&gt;         OCIStmtFetch&#40;8473a74,8467e34,1,2,1&#41;=SUCCESS &lt;--- NOTICE
&gt; SUCCESS
&gt;         OCIAttrGet&#40;8473a74,OCI_HTYPE_STMT,848aaf0,0,OCI_ATTR_CURRENT_POSITION,8467e34&#41;=SUCCESS
&gt;         Scrolling Fetch, postion after fetch=5
&gt;         dbd_st_fetched 1 fields with status of 0&#40;SUCCESS&#41;
&gt;         field #1 with rc=0&#40;OK&#41;
&gt; 
&gt;                 821b6c0 &#40;field=0&#41;: &#39;5&#39;
&gt; 5
&gt;         dbd_st_fetch 1 fields...
&gt;         Scrolling Fetch, position before fetch=5, Orientation =
&gt; OCI_FETCH_NEXT , Fetchoffset =1
&gt;         OCIStmtFetch&#40;8473a74,8467e34,1,2,1&#41;=NO_DATA &lt;--- NOTICE
&gt; NO_DATA
&gt; 
&gt; Seems like the scrollable cursor code is not paying attention to
&gt; NO_DATA.
&gt; 
&gt; Martin
</div>
This code in oci8.c pays no attention to the status returned from OCIFetch:

                        if &#40;DBIc_DBISTATE&#40;imp_sth&#41;-&gt;debug &gt;= 4 || dbd_verbose &gt;= 4 &#41;
                                PerlIO_printf&#40;
                    DBIc_LOGPIO&#40;imp_sth&#41;,
                    &#34;   Scrolling Fetch, position before fetch=%d, &#34;
                    &#34;Orientation = %s , Fetchoffset =%d\n&#34;,
                                        imp_sth-&gt;fetch_position, oci_fetch_options&#40;imp_sth-&gt;fetch_orient&#41;,
                    imp_sth-&gt;fetch_offset&#41;;

                        OCIStmtFetch_log_stat&#40;imp_sth, imp_sth-&gt;stmhp, imp_sth-&gt;errhp,1, imp_sth-&gt;fetch_orient,imp_sth-&gt;fetch_offset, status&#41;;
                                /*this will work without a round trip so might as well open it up for all statments handles*/
                                /* default and OCI_FETCH_NEXT are the same so this avoids miscaluation on the next value*/
                        OCIAttrGet_stmhp_stat&#40;imp_sth, &#38;imp_sth-&gt;fetch_position, 0, OCI_ATTR_CURRENT_POSITION, status&#41;;

NOTE: status is never examined!

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;25&nbsp;15:27:47&nbsp;2013</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Try applying this change:

$ svn diff
Index: oci8.c
===================================================================
--- oci8.c      &#40;revision 15588&#41;
+++ oci8.c      &#40;working copy&#41;
@@ -4002,6 +4002,10 @@
                        OCIStmtFetch_log_stat&#40;imp_sth, imp_sth-&gt;stmhp, imp_sth-&gt;errhp,1, imp_sth-&gt;fetch_orient,imp_sth-&gt;fetch_offset
, status&#41;;
                                /*this will work without a round trip so might as well open it up for all statments handles*/
                                /* default and OCI_FETCH_NEXT are the same so this avoids miscaluation on the next value*/
+                       if &#40;status==OCI_NO_DATA&#41;{
+                return Nullav;
+            }
+
                        OCIAttrGet_stmhp_stat&#40;imp_sth, &#38;imp_sth-&gt;fetch_position, 0, OCI_ATTR_CURRENT_POSITION, status&#41;;

                        if &#40;DBIc_DBISTATE&#40;imp_sth&#41;-&gt;debug &gt;= 4 || dbd_verbose &gt;= 4 &#41;

With my script above altered to:

use DBI;
use strict;
use warnings;
use DBD::Oracle qw&#40;:ora_fetch_orient :ora_exe_modes&#41;;

my $h = DBI-&gt;connect&#40;&#34;dbi:Oracle:host=alvis.easysoft.local;sid=devel&#34;,&#34;bet&#34;,&#34;b3t&#34;,
                     {RaiseError =&gt; 1, ora_verbose =&gt; 0}&#41;;
eval {
    $h-&gt;do&#40;q/drop table mje/&#41;;
};

$h-&gt;do&#40;q/create table mje &#40;a int&#41;/&#41;;

foreach &#40;1..5&#41; {
    $h-&gt;do&#40;qq/insert into mje values&#40;$_&#41;/&#41;;
}
my $sql = &#34;SELECT * from mje&#34;;
my $sth = $h-&gt;prepare&#40;$sql, {ora_exe_mode =&gt; OCI_STMT_SCROLLABLE_READONLY}&#41;;
$sth-&gt;execute;
$sth-&gt;ora_fetch_scroll&#40;OCI_FETCH_LAST, 0&#41;;
$sth-&gt;ora_fetch_scroll&#40;OCI_FETCH_RELATIVE, -2&#41;;

for &#40;1 .. 5&#41; { # purposedly trying beyond the last row
    my $r = $sth-&gt;fetch; # should get undef at some point .. but no
    last if !$r;
    print @$r, &#34;\n&#34;;
}

it produces:

$ perl -Iblib/lib -Iblib/arch  rt_84170.pl
4
5

Let me know how you get on.

If it works for you come back to the rt and maybe Yanick could apply the patch. Even better would be if you could add a test case to t/51scroll.t which you can find and enhance if you download the distribution - tests are not installed - mores the pity.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;26&nbsp;11:18:52&nbsp;2013</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve added a test case to 51scroll.t test in subversion trunk.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;27&nbsp;03:08:24&nbsp;2013</span>
    <span class="description">DAMI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Le Lun 25 Mar 2013 15:27:47, MJEVANS a écrit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Try applying this change:
</div>[...]
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Let me know how you get on.
&gt; 
</div>
Hi, thanks for the quick response.
Indeed this patch fixes the problem.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;28&nbsp;16:23:30&nbsp;2013</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Mar 27 03:08:24 2013, DAMI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Le Lun 25 Mar 2013 15:27:47, MJEVANS a écrit :
<div class="message-stanza open">&gt; &gt; Try applying this change:
</div>&gt; [...]
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; Let me know how you get on.
&gt; &gt; 
</div>&gt; 
&gt; Hi, thanks for the quick response.
&gt; Indeed this patch fixes the problem.
</div>
Patched in subversion trunk and will be in next release.

Thanks for the report.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;28&nbsp;16:23:31&nbsp;2013</span>
    <span class="description">bohica [...] ntlworld.com -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;13&nbsp;15:06:30&nbsp;2013</span>
    <span class="description">DAMI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Le Jeu 28 Mar 2013 16:23:30, MJEVANS a écrit :

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Patched in subversion trunk and will be in next release.
</div>
Hi, I noticed that the patch did not make it to v1.60 because of merge problems. So do you have any idea when v1.61 will be published ?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;13&nbsp;15:06:30&nbsp;2013</span>
    <span class="description">DAMI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Le Jeu 28 Mar 2013 16:23:30, MJEVANS a écrit :

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Patched in subversion trunk and will be in next release.
</div>
Hi, I noticed that the patch did not make it to v1.60 because of merge problems. So do you have any idea when v1.61 will be published ?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;14&nbsp;05:50:17&nbsp;2013</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Apr 13 15:06:30 2013, DAMI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Le Jeu 28 Mar 2013 16:23:30, MJEVANS a écrit :
&gt; 
<div class="message-stanza open">&gt; &gt; Patched in subversion trunk and will be in next release.
</div>&gt; 
&gt; Hi, I noticed that the patch did not make it to v1.60 because of merge
&gt; problems. So do you have any idea when v1.61 will be published ?
</div>
I don&#39;t do the releases, Yanick does. DBD::Oracle is moving to git permanently as the svn.perl.org is going away so may be he&#39;ll do a release after that. Generally Yanick does fairly regular releases so long as there is something worthwhile to release.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;15&nbsp;15:38:31&nbsp;2013</span>
    <span class="description">champoux [...] pythian.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #84170] after a fetch_scroll&#40;&#41;, fetch&#40;&#41; never returns undef after the last row</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 15 Apr 2013 15:38:11 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Oracle [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Yanick Champoux &lt;champoux [...] pythian.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 13-04-14 05:50 AM, Martin J Evans via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I don&#39;t do the releases, Yanick does. DBD::Oracle is moving to git permanently as the svn.perl.org is going away so may be he&#39;ll do a release after that. Generally Yanick does fairly regular releases so long as there is something worthwhile to release.
</div>
     And since I actually had a few minutes free this afternoon... 
v1.61_00 is now on its way to CPAN. As usual, if no issue is found, 
it&#39;ll be promoted to v1.62 in two weeks.

Joy,
`/anick

-- 


--
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;22&nbsp;15:09:53&nbsp;2013</span>
    <span class="description">champoux [...] pythian.com -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
