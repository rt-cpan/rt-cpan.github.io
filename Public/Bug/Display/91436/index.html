<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #91436 for IO-Socket-SSL: crash of parent in accept&#40;&#41; when a child reads/sysreads another client</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #91436 for IO-Socket-SSL: crash of parent in accept&#40;&#41; when a child reads/sysreads another client</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=IO-Socket-SSL">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=IO-Socket-SSL">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=IO-Socket-SSL">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=IO-Socket-SSL">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IO-Socket-SSL">IO-Socket-SSL CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">91436</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=IO-Socket-SSL">IO-Socket-SSL</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cpan2759139006 [...] bador.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-17228-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-17229-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




ssl-crash-minimal.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1302352/690042/ssl-crash-minimal.pl">
Sun Dec 15 21:06:51 2013 (3k) by cpan2759139006 [...] bador.net
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1302346/690034/ssl-crash-minimal.pl">
Sun Dec 15 21:03:17 2013 (3k) by cpan2759139006 [...] bador.net
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1302343/690029/ssl-crash-minimal.pl">
Sun Dec 15 21:02:19 2013 (3k) by cpan2759139006 [...] bador.net
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=91436">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1302323" href="/Public/Bug/Display.html?id=91436#txn-1302323">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;15&nbsp;20:30:39&nbsp;2013</span>
    <span class="description">cpan2759139006 [...] bador.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> crash of parent in accept&#40;&#41; when a child reads/sysreads another client</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 16 Dec 2013 01:30:06 +0000 &#40;GMT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-IO-Socket-SSL [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Florian Bador &lt;cpan2759139006 [...] bador.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1302323/690008/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/690008">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">NOTE: We had a thread w/ Steffen Ullrich on this but I put my phone number in signature by mistake so we had to remove the thread.
Let&#39;s summarize everything we said, here.

##### The original message was : #####

Hi,

I am working on an HTTPS server using IO::Socket::SSL 1.962.

My program doesn&#39;t have any problem with HTTP &#40;a different process using use IO::Socket&#41;
With SSL, the following problem occurs, frequently but randomly :

-&gt; The parent calls accept to wait for another client
-&gt; In the same time, a forked child is reading some data from a previously accepted client
-&gt; The parent dies without a single warning, STDERR message, or anything. &#40;I use strict and warnings&#41;
-&gt; The child keeps going without problem

The dying parent does not return a true value when dying because ./program.pl &#38;&#38; date never prints date.

Now, since there is absolutely no warning/error anywhere, here&#39;s the way I was able to find out where it occurs in the code :
-&gt; I wrote plenty of :
select&#40;undef, undef, undef, 0.005&#41;; warn&#40;&#34;$$ This is line&#34;.__LINE__.&#34; at &#34;.tv_interval&#40;undef,[gettimeofday]&#41; &#41;;
at almost every line...
-&gt; I called the script this way:
./program.pl &gt; log 2&gt;&#38;1 ; perl -e &#39;use Time::HiRes qw&#40;gettimeofday tv_interval&#41;; print&#40; tv_interval&#40;undef,[gettimeofday]&#41;.&#34;\n&#34;&#41;;&#39;
-&gt; I then looked at what happens just before the time of termination of the program and concluded that it always happens when a child is calling read/sysread &#40;successfully!&#41; and the parent dies while waiting with accept&#40;&#41;.

What I tried &#40;and that did not fix the problem&#41; :
-&gt; both sysread and read
-&gt; creating a IO::select on the client in order to first make sure we can_read and can_write before reading / sysreading
&#40;I&#39;m not surprised it doesn&#39;t help because when the problem occurs, read/sysread succeeds&#41;
-&gt; same thing for the socket : waiting with can_read before calling accept&#40;&#41;.

NOTES:
-&gt; yes, all &#34;use&#34; are made before forking, at beginning of parent.
-&gt; I would say that it happens about once every 150 connections, sometimes the very first one, sometimes the 500th one.

Now I think the first step would be to get some feedback from the crash. Is there any way to get some more debugging info in a such case?
Thanks a lot!

// Florian Bador
// <span class="clickylink"><a target="new" rel="nofollow" href="http://florianbador.com">http://florianbador.com</a></span>
////////////////////////////////////////////////////////////
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1302330" href="/Public/Bug/Display.html?id=91436#txn-1302330">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;15&nbsp;20:45:47&nbsp;2013</span>
    <span class="description">cpan2759139006 [...] bador.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #91436] crash of parent in accept&#40;&#41; when a child reads/ sysreads another client</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 16 Dec 2013 01:45:20 +0000 &#40;GMT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-IO-Socket-SSL [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Florian Bador &lt;cpan2759139006 [...] bador.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1302330/690015/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/690015">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 203b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I will now send fake SMTP messages of all our conversation, below...
&#40;let&#39;s see if it works...&#41;

// Florian Bador
// <span class="clickylink"><a target="new" rel="nofollow" href="http://florianbador.com">http://florianbador.com</a></span>
////////////////////////////////////////////////////////////
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1302333" href="/Public/Bug/Display.html?id=91436#txn-1302333">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;15&nbsp;20:49:56&nbsp;2013</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #91436] crash of parent in accept&#40;&#41; when a child reads/sysreads another client</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Date: Mon, 16 Dec 2013 01:45:30 +0000 &#40;GMT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-io-socket-ssl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steffen_Ullrich [...] genua.de</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1302333/690018/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/690018">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 553b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,
I need more information to understand your problem.
I need at least:
- which version of IO::Socket::SSL and Net::SSLeay are you using, e.g.
  perl -MIO::Socket::SSL -e &#39;warn $IO::Socket::SSL::VERSION&#39;
  perl -MNet::SSLeay -e &#39;warn $Net::SSLeay::VERSION&#39;
- which operating system do you use, e.g. on windows a fork does not create a real process, only a thread, which can have subtible interactions with the parent &#34;process&#34;:
  perl -e &#39;warn $^O&#39;
- the version of perl itself:
  perl -v
- a minimal program, which is sufficient reproduce the problem
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1302334" href="/Public/Bug/Display.html?id=91436#txn-1302334">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;15&nbsp;20:49:56&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1302337" href="/Public/Bug/Display.html?id=91436#txn-1302337">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;15&nbsp;20:57:01&nbsp;2013</span>
    <span class="description">cpan2759139006 [...] bador.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #91436] crash of parent in accept&#40;&#41; when a child reads/ sysreads another client</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 16 Dec 2013 01:56:30 +0000 &#40;GMT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-IO-Socket-SSL [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Florian Bador &lt;cpan2759139006 [...] bador.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1302337/690021/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/690021">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you Steffen.

Linux 3.2.22-grsec #1 i686 GNU/Linux
Perl : This is perl 5, version 16, subversion 0 &#40;v5.16.0&#41; built for i686-linux-64int
IO::Socket::SSL 1.962
Net::SSLeay 1.55

I wrote a very simplified version, and made thousands of HTTPS requests w/ new connections...
No crash after a few hours of testing, but by pushing hard on the requests, the parent sometimes ends up blocked in accept&#40;&#41; instead of crashing, even once all children/clients are done.
For that reason, I decided to handle it w/ a non-blocking socket, and there is no problem w/ accept&#40;&#41;.

So I am adding step by step code and modules I need until I get the crash bug again.
I suspect one of the modules to create some sort of weird conflict...
I will also try my final program w/ non-blocking socket.

That&#39;s good news because it means that at a particular point we&#39;ll get the bug again, but that will take me some time at each test to make sure it can handle hours of intense requests.
Will be back to keep you aware.

Thanks!

// Florian Bador
// <span class="clickylink"><a target="new" rel="nofollow" href="http://florianbador.com">http://florianbador.com</a></span>
////////////////////////////////////////////////////////////


########## FROM rt-cpan-org-return@perl.org SENT 6 min EARLIER: ##########
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; I need more information to understand your problem.
&gt; I need at least:
&gt; - which version of IO::Socket::SSL and Net::SSLeay are you using, e.g.
&gt; perl -MIO::Socket::SSL -e &#39;warn $IO::Socket::SSL::VERSION&#39;
&gt; perl -MNet::SSLeay -e &#39;warn $Net::SSLeay::VERSION&#39;
&gt; - which operating system do you use, e.g. on windows a fork does not create a real process, only a thread, which can have subtible interactions with the parent &#34;process&#34;:
&gt; perl -e &#39;warn $^O&#39;
&gt; - the version of perl itself:
&gt; perl -v
&gt; - a minimal program, which is sufficient reproduce the problem
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1302340" href="/Public/Bug/Display.html?id=91436#txn-1302340">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;15&nbsp;21:00:24&nbsp;2013</span>
    <span class="description">cpan2759139006 [...] bador.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #91436] crash of parent in accept&#40;&#41; when a child reads/ sysreads another client</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 16 Dec 2013 01:59:52 +0000 &#40;GMT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-IO-Socket-SSL [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Florian Bador &lt;cpan2759139006 [...] bador.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1302340/690024/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/690024">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">So,

Right now, with a minimal version we no longer have a mysterious death of the parent that handles the socket, but instead, a freeze of it, occurring also in accept&#40;&#41;.

And now that the socket itself is non-blocking, there is less probability to be in accept&#40;&#41; when a child is calling sysread.
Even when socket was blocking, it didn&#39;t occur systematically at all, so now it is even less often for that reason.
Now, I could put that parent in a fork, so its children become forks of this fork &#40;grandchildren&#41; and then kill the process when it is blocked or gone, and restart it immediately... But that is really dirty coding... And some clients may be rejected by the time we restart the socket.

Is there any alternative to accept&#40;&#41; that I could try?

NOTE:
-&gt; remember that I tried to use IO::Select and can_read / can_write. I also tried to care for $SSL_ERROR. But these did not change anything.
-&gt; since the probability of seeing this problem is now reduced, I make about 1 connection/s in my tests &#40;a loop using curl -k&#41;
-&gt; I looked at a frozen process, and it sometimes takes 20% of a good CPU, sometimes 0.

Surprise:
It seems that my 1 connection/s &#40;random timer occurring sometimes at the same moment&#41; using curl does not create the problem, and that it only comes when I add on the top of that, requests from Firefox! &#40;difficult to be 100% sure so far though&#41;
Would it be a SNI problem?

I apologize for the fact that it becomes pretty difficult to create the problem, it requires now some serious network flood. &#40;of course you can try w/ a blocking socket, which will make it happen more often&#41;
But, I never had any problem with plain HTTP via IO::Socket, so there is obviously something wrong in the SSL connection.

Attached is my minimal program.
I run it this way :

./ssl-crash-minimal.pl &gt; crash-log 2&gt;&#38;1 ; perl -e &#39;use Time::HiRes qw&#40;gettimeofday tv_interval&#41;; print&#40; tv_interval&#40;undef,[gettimeofday]&#41;.&#34;\n&#34;&#41;;&#39;
WARN: the output log will become pretty big.

That way, once it&#39;s frozen you can grep the parent&#39;s pid in crash-log and see the last line logged &#40;always &#34;Calling accept ...&#34;&#41;
You then grep the approximate time of this last line to look at the lines around and realize some sysread of child/children was called at the same moment.

Thanks again.

// Florian Bador
// <span class="clickylink"><a target="new" rel="nofollow" href="http://florianbador.com">http://florianbador.com</a></span>
////////////////////////////////////////////////////////////
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1302343" href="/Public/Bug/Display.html?id=91436#txn-1302343">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;15&nbsp;21:02:19&nbsp;2013</span>
    <span class="description">cpan2759139006 [...] bador.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #91436] crash of parent in accept&#40;&#41; when a child reads/ sysreads another client</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 16 Dec 2013 02:01:53 +0000 &#40;GMT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-IO-Socket-SSL [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Florian Bador &lt;cpan2759139006 [...] bador.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1302343/690028/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/690028">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 154b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">&#40;oops, a file was attached in the other thread&#41;

// Florian Bador
// <span class="clickylink"><a target="new" rel="nofollow" href="http://florianbador.com">http://florianbador.com</a></span>
////////////////////////////////////////////////////////////
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1302343/690029/ssl-crash-minimal.pl">Download ssl-crash-minimal.pl</a><br />
<span class="downloadcontenttype">text/x-perl 3k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1302346" href="/Public/Bug/Display.html?id=91436#txn-1302346">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;15&nbsp;21:03:17&nbsp;2013</span>
    <span class="description">cpan2759139006 [...] bador.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #91436] crash of parent in accept&#40;&#41; when a child reads/ sysreads another client</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 16 Dec 2013 02:02:51 +0000 &#40;GMT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-IO-Socket-SSL [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Florian Bador &lt;cpan2759139006 [...] bador.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1302346/690033/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/690033">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 911b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">PS:

I still have a blocked parent process running, if you want me to try things with it, let me know, I don&#39;t kill it yet.

I tried :
-&gt; to send SIGCONT &#40;kill 18&#41; : nothing
-&gt; to send SIGSTOP &#40;kill 19&#41; : that did make the stop in the shell and process is still alive
-&gt; to send SIGCONT after the STOP : that did not make it leave the accept&#40;&#41; where it is currently blocked.
-&gt; curl -vk shows that we can still connect but when client sends handshake, the answer never comes.

We can summarize the problem by saying that accept&#40;&#41; sometimes becomes blocking regardless of blocking&#40;0&#41; and ignores incoming new clients, so it waits forever, and that it is probably when we are in accept doing things, and that a child reads/sysreads, that things get messed up and we will never leave this accept&#40;&#41; function.

// Florian Bador
// <span class="clickylink"><a target="new" rel="nofollow" href="http://florianbador.com">http://florianbador.com</a></span>
////////////////////////////////////////////////////////////
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1302346/690034/ssl-crash-minimal.pl">Download ssl-crash-minimal.pl</a><br />
<span class="downloadcontenttype">text/x-perl 3k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1302349" href="/Public/Bug/Display.html?id=91436#txn-1302349">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;15&nbsp;21:05:22&nbsp;2013</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #91436] crash of parent in accept&#40;&#41; when a child reads/sysreads another client</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 16 Dec 2013 02:05:00 +0000 &#40;GMT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-io-socket-ssl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steffen_Ullrich [...] genua.de</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1302349/690037/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/690037">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Do 05. Dez 2013, 23:13:18, cpan2759139006@bador.net schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; PS:
&gt; 
&gt; I still have a blocked parent process running, if you want me to try
&gt; things with it, let me know, I don&#39;t kill it yet.
</div>
IO::Socket::SSL::accept consists of an accept on the inet socket, followed by an SSL handshake. While the accept on the inet socket is fully handled in the OS kernel, the SSL handshake requires reads and writes on the underlying TCP connection. While it should be possible to do a non-blocking SSL handshake with IO::Socket::SSL::accept, your sample code does not handle it correctly. It only sets the server socket as non-blocking, but the SSL handshake is done in the new socket returned from IO::Socket::accept, which is not set non-blocking.

Because you will fork anyway to handle the child I would rather recommend you to only do an IO::Socket::accept, then fork and then do the SSL handshake in the forked child, e.g:

  my $server = IO::Socket::INET-&gt;new&#40; Listen =&gt; .., LocalAddr =&gt; ..&#41;;
  while &#40;1&#41; {
    my $c = $server-&gt;accept or next; # TCP accept
    defined&#40; my $pid = fork &#41; or die $!; # fork child
    next if $pid; # parent will wait for next child
    
    # child here
    close&#40;$server&#41;; # not needed in child
    IO::Socket::SSL-&gt;start_SSL&#40;$c, SSL_server =&gt; 1, .. other SSL_args ... &#41;
      or die &#34;ssl handshake failed: $SSL_ERROR&#34;
    ... now we have an SSL socket in $c ...
 
  }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1302352" href="/Public/Bug/Display.html?id=91436#txn-1302352">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;15&nbsp;21:06:51&nbsp;2013</span>
    <span class="description">cpan2759139006 [...] bador.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #91436] crash of parent in accept&#40;&#41; when a child reads/ sysreads another client</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 16 Dec 2013 02:06:24 +0000 &#40;GMT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-IO-Socket-SSL [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Florian Bador &lt;cpan2759139006 [...] bador.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1302352/690041/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/690041">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Danke schoen Steffen!

It seems to be prefect! :&#41;
I don&#39;t regret to create my own HTTP/HTTPS server, I measure everything w/ Time::HiRes and beside the handshakes that take about 300ms, all pages respond in 0ms, not one, just zero! on a pretty loaded server &#40;I put everything in ramfs&#41;. I have about 100-200ms using apache+cgi... That&#39;s just amazing!

Thank you very much!

So in the end, we will probably never know exactly why that weird &#38; random problem happens but if anyone passing here is looking for a solution, that is it!

=============================
=== SUMMARY OF THE SOLUTION: ===
-&gt; Accept w/ IO::Socket::INET just like a plain HTTP server and the same options &#40;except the port of course: 443&#41;
-&gt; Socket can even be blocking without problem
-&gt; Once forked, close $sock in the child and upgrade $client to SSL
-&gt; $client is then ready to be treated like any IO::Socket::INET handle.

NOTE: some browsers &#40;such as chrome&#41; create 3 parallel connections when opening a page in order to be faster &#40;avoiding further handshakes&#41;, and these connections sometime request nothing, they are just created in case of future need. &#40;of course that is not very nice for the cpu usage... thank you google for giving everyone the illusion to create a faster browser.&#41;

// Florian Bador
// <span class="clickylink"><a target="new" rel="nofollow" href="http://florianbador.com">http://florianbador.com</a></span>
////////////////////////////////////////////////////////////
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1302352/690042/ssl-crash-minimal.pl">Download ssl-crash-minimal.pl</a><br />
<span class="downloadcontenttype">text/x-perl 3k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1302763" href="/Public/Bug/Display.html?id=91436#txn-1302763">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;17&nbsp;04:33:14&nbsp;2013</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1302763/690269/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/690269">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 54b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">issue closed, because not a problem of IO::Socket::SSL
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1302766" href="/Public/Bug/Display.html?id=91436#txn-1302766">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;17&nbsp;04:33:15&nbsp;2013</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.836357</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
