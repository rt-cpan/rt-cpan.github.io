<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #92501 for Scalar-List-Utils: pairmap segfaults</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #92501 for Scalar-List-Utils: pairmap segfaults</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Scalar-List-Utils">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Scalar-List-Utils">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Scalar-List-Utils">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Scalar-List-Utils">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Scalar-List-Utils">Scalar-List-Utils CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">92501</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Scalar-List-Utils">Scalar-List-Utils</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
YKAR [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-28278-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-28279-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




0001-pairmap-extend-stack-outside-MULTICALL-when-needed.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1347419/715083/0001-pairmap-extend-stack-outside-MULTICALL-when-needed.patch">
Sun Apr 06 13:24:03 2014 (1.2k) by YKAR [...] cpan.org
</a>
</font></li>
</ul>


pairmap-bug-terse.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1347095/714920/pairmap-bug-terse.t">
Sat Apr 05 11:24:28 2014 (201b) by YKAR [...] cpan.org
</a>
</font></li>
</ul>


pairmap-bug.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1318558/699233/pairmap-bug.pl">
Mon Jan 27 09:08:13 2014 (496b) by YKAR [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=92501">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1318558" href="/Public/Bug/Display.html?id=92501#txn-1318558">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;27&nbsp;09:08:13&nbsp;2014</span>
    <span class="description">YKAR [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> pairmap segfaults</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1318558/699232/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/699232">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 977b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello!

I had data strucutre on which Perl terminated abnormally when perofrming pairmap. I have narrowed down it to this test case &#40;I&#39;m sorry I didn&#39;t make it shorter, but it&#39;s the shortest version which breaks perl&#41;.

Backtrace:

/lib64/libc.so.6&#40;+0x7e9d6&#41;[0x7ff8056c69d6]
/lib64/libc.so.6&#40;+0x7f783&#41;[0x7ff8056c7783]
/usr/lib64/libperl.so.5.16&#40;Perl_av_extend+0x1db&#41;[0x7ff805aa1f5b]
/usr/lib64/libperl.so.5.16&#40;Perl_stack_grow+0x2f&#41;[0x7ff805ad140f]
/usr/lib64/libperl.so.5.16&#40;Perl_pp_mapwhile+0x37c&#41;[0x7ff805adb7ac]
/usr/lib64/libperl.so.5.16&#40;Perl_runops_standard+0x13&#41;[0x7ff805aa3c83]
/usr/lib64/perl5/vendor_perl/5.16.3/x86_64-linux/auto/List/Util/Util.so&#40;+0x4943&#41;[0x7ff8048a8943]
/usr/lib64/libperl.so.5.16&#40;Perl_pp_entersub+0x645&#41;[0x7ff805aab6e5]
/usr/lib64/libperl.so.5.16&#40;Perl_runops_standard+0x13&#41;[0x7ff805aa3c83]
/usr/lib64/libperl.so.5.16&#40;perl_run+0x3ca&#41;[0x7ff805a49bea]
/usr/bin/perl&#40;main+0x11b&#41;[0x400f2b]

I hope my test case would work for you.

Thank you in advance!
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> pairmap-bug.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1318558/699233/pairmap-bug.pl">Download pairmap-bug.pl</a><br />
<span class="downloadcontenttype">text/x-perl 496b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#! /usr/bin/perl

use strict;
use warnings;

use List::Util qw&#40;pairmap&#41;;

my @x = &#40;
  &#39;a&#39; =&gt; [
    &#39;1&#39;,
    [
      &#39;b&#39; =&gt; [ &#39;2&#39;, &#39;3&#39;, &#39;4&#39; ],
      &#39;c&#39; =&gt; [ &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;, &#39;10&#39;, &#39;11&#39;, &#39;12&#39; ],
      &#39;d&#39; =&gt; [ &#39;13&#39;, &#39;14&#39;, &#39;15&#39;, &#39;16&#39;, &#39;17&#39;, &#39;18&#39;,
               &#39;19&#39;, &#39;20&#39;, &#39;21&#39;, &#39;22&#39;, &#39;23&#39;,
               &#39;24&#39;, &#39;25&#39;, &#39;26&#39;, &#39;27&#39;, &#39;28&#39;, &#39;29&#39;,
               &#39;30&#39;, &#39;31&#39;, &#39;32&#39; ],
    ]
  ],
&#41;;

sub _extract {
  map { ref $_ ? pairmap&#40;\&#38;_extract, @$_&#41; : $_ } @$b;
}

pairmap&#40;\&#38;_extract, @x&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1318697" href="/Public/Bug/Display.html?id=92501#txn-1318697">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;27&nbsp;14:07:49&nbsp;2014</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1318697/699314/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/699314">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 441b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jan 27 09:08:13 2014, YKAR wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I had data strucutre on which Perl terminated abnormally when
&gt; perofrming pairmap. I have narrowed down it to this test case &#40;I&#39;m
&gt; sorry I didn&#39;t make it shorter, but it&#39;s the shortest version which
&gt; breaks perl&#41;.
</div>
Indeed.

Seems to be the combination of a nested pairmap inside pairmap, combined with the inner one needing to copy the arg stack out of the way due to count &gt; 2.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1318698" href="/Public/Bug/Display.html?id=92501#txn-1318698">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;27&nbsp;14:07:49&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1347095" href="/Public/Bug/Display.html?id=92501#txn-1347095">#</a>      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;05&nbsp;11:24:28&nbsp;2014</span>
    <span class="description">YKAR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1347095/714919/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/714919">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 588b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Seems to be the combination of a nested pairmap inside pairmap,
&gt; combined with the inner one needing to copy the arg stack out of the
&gt; way due to count &gt; 2.
</div>
I prepared terse version of test case, and spent some time with valgrind.

I found that there is a write to unallocated memory at line 658 &#40;when reti == 29&#41;:

stack[reti++] = newSVsv&#40;PL_stack_sp[i - count + 1]&#41;;

Maybe it&#39;s not safe to write to stack just by incrementing pointer,
sooner or later it may exceed bounds. Probably exists safer alternative
in Perl API which checks bounds before writing and grows stack if needed.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> pairmap-bug-terse.t</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1347095/714920/pairmap-bug-terse.t">Download pairmap-bug-terse.t</a><br />
<span class="downloadcontenttype">text/x-perl 201b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#! /usr/bin/perl

use strict;
use warnings;

use List::Util qw&#40;pairmap&#41;;

sub _extract {
  map { ref $_ ? pairmap&#40;\&#38;_extract, @$_&#41; : $_ } @$b;
}

pairmap&#40;\&#38;_extract, a =&gt; [ b =&gt; [ c =&gt; [ 1 .. 31 ]]]&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1347419" href="/Public/Bug/Display.html?id=92501#txn-1347419">#</a>      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;06&nbsp;13:24:03&nbsp;2014</span>
    <span class="description">YKAR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1347419/715082/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/715082">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 395b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I spent some time inserting debugging output and now I&#39;m sure that error
was caused due to insufficient capacity of outer stack.

I made a patch which reallocates original stack &#40;which was before PUSH_MULTICALL&#41;
when needed. But I&#39;m not in the slightest degree an expert in Perl guts, so
please consider this patch just as an illustration to have an idea what&#39;s broken
and how it could be fixed.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-pairmap-extend-stack-outside-MULTICALL-when-needed.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1347419/715083/0001-pairmap-extend-stack-outside-MULTICALL-when-needed.patch">Download 0001-pairmap-extend-stack-outside-MULTICALL-when-needed.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 914c56bcad5a0bacd3da36de2459e150e0ed25c2 Mon Sep 17 00:00:00 2001
From: YKAR &lt;ykar@cpan.org&gt;
Date: Sun, 6 Apr 2014 17:11:40 +0000
Subject: [PATCH] pairmap: extend stack outside MULTICALL when needed

---
 ListUtil.xs | 11 +++++++++++
 1 file changed, 11 insertions&#40;+&#41;

diff --git a/ListUtil.xs b/ListUtil.xs
index bba138a..0190bbf 100644
--- a/ListUtil.xs
+++ b/ListUtil.xs
@@ -618,6 +618,9 @@ PPCODE:
     if&#40;!CvISXSUB&#40;cv&#41;&#41; {
         /* Since MULTICALL is about to move it */
         SV **stack = PL_stack_base + ax;
+        AV* prev_stack = PL_curstack;
+        I32 prev_stack_used = stack - PL_stack_base;
+        I32 prev_stack_free = PL_stack_max - stack;
         I32 ret_gimme = GIMME_V;
         int i;
 
@@ -654,8 +657,16 @@ PPCODE:
                 items = n_args;
             }
 
+            if &#40;count &gt; prev_stack_free&#41; {
+              prev_stack_free = count + 128;
+              av_extend&#40;prev_stack, prev_stack_used + prev_stack_free&#41;;
+              stack = AvARRAY&#40;prev_stack&#41; + ax;
+            }
+
             for&#40;i = 0; i &lt; count; i++&#41;
                 stack[reti++] = newSVsv&#40;PL_stack_sp[i - count + 1]&#41;;
+            prev_stack_free -= count;
+            prev_stack_used += count;
         }
         POP_MULTICALL;
 
-- 
1.9.1

</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.406226</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
