<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #125523 for Archive-Tar: CVE-2018-12015 directory traversal vulnerability</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #125523 for Archive-Tar: CVE-2018-12015 directory traversal vulnerability</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Archive-Tar/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Archive-Tar/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Archive-Tar/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Archive-Tar/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Archive-Tar">Archive-Tar CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">125523</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Archive-Tar/Active/">Archive-Tar</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dom [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-2526-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.26    </td>
  </tr>
  <tr id="CF-2527-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




0001-Extract-files-with-O_EXCL.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1791297/963435/0001-Extract-files-with-O_EXCL.patch">
Fri Jun 15 18:57:54 2018 (962b) by andrew [...] cpan.org
</a>
</font></li>
</ul>


0001-Remove-existing-files-before-overwriting-them.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1789907/962651/0001-Remove-existing-files-before-overwriting-them.patch">
Fri Jun 08 04:02:52 2018 (1.6k) by ppisar [...] redhat.com
</a>
</font></li>
</ul>


signature.asc<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1789962/962686/signature.asc">
Fri Jun 08 11:31:22 2018 (181b) by chris [...] bingosnet.co.uk
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;07&nbsp;17:31:29&nbsp;2018</span>
    <span class="description">dom [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CVE-2018-12015 directory traversal vulnerability</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As reported to the Debian BTS[1] Archive-Tar has a symlink-related directory traversal vulnerability:

-----
By default, the Archive::Tar module doesn&#39;t allow extracting files
outside the current working directory. However, you can bypass this
secure extraction mode easily by putting a symlink and a regular file
with the same name into the tarball.

I&#39;ve attached proof of concept tarball, which makes Archive::Tar create
/tmp/moo, regardless of what the current working directory is:

   $ tar -tvvf traversal.tar.gz
   lrwxrwxrwx root/root         0 2018-06-05 18:55 moo -&gt; /tmp/moo
   -rw-r--r-- root/root         4 2018-06-05 18:55 moo

   $ pwd
   /home/jwilk

   $ ls /tmp/moo
   ls: cannot access &#39;/tmp/moo&#39;: No such file or directory

   $ perl -MArchive::Tar -e &#39;Archive::Tar-&gt;extract_archive&#40;&#34;traversal.tar.gz&#34;&#41;&#39;

   $ ls /tmp/moo
   /tmp/moo
-----

The attachment is here: <span class="clickylink"><a target="new" rel="nofollow" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?att=1;bug=900834;filename=traversal.tar.gz;msg=3">https://bugs.debian.org/cgi-bin/bugreport.cgi?att=1;bug=900834;filename=traversal.tar.gz;msg=3</a></span>


[1] &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=900834">https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=900834</a></span>&gt;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;08&nbsp;02:24:35&nbsp;2018</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Čt 07.čen.2018 17:31:29, DOM napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $ tar -tvvf traversal.tar.gz
&gt; lrwxrwxrwx root/root         0 2018-06-05 18:55 moo -&gt; /tmp/moo
&gt; -rw-r--r-- root/root         4 2018-06-05 18:55 moo
&gt; 
</div>Tar archive can contain multiple file entries with the same name. GNU tar info page reads:

[...] files are
extracted from an archive in the order in which they were archived.
Thus, when the archive is extracted, a file archived later in time will
replace a file of the same name which was archived earlier
[...]
When you extract the archive, the older version of the file
will be extracted first, and then replaced by the newer version when it is extracted.

It looks like first Archive::Tar creates the symlink &#40;first entry&#41; and then writes the regular file content into the symlink &#40;second entry&#41;.

GNU tar indeed replaces the symlink with a regular file.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;08&nbsp;02:24:36&nbsp;2018</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;08&nbsp;04:02:52&nbsp;2018</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Čt 07.čen.2018 17:31:29, DOM napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; As reported to the Debian BTS[1] Archive-Tar has a symlink-related
&gt; directory traversal vulnerability:
&gt;
</div>Attached patch simply removes every existing &#40;non-directory&#41; file that&#39;s going to be extracted. Even in non-secure mode.

Is it fine, or too strict, or even dangerous?
 
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Remove-existing-files-before-overwriting-them.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From d23726d0d3d30ce451c6eadda41a2df5446ead27 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Fri, 8 Jun 2018 09:53:16 +0200
Subject: [PATCH] Remove existing files before overwriting them
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Archive should extract only the latest same-named entry.
Extracted regular file should not be writtent into existing block
device &#40;or any other one&#41;.

<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125523">https://rt.cpan.org/Ticket/Display.html?id=125523</a></span>
Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 lib/Archive/Tar.pm | 14 ++++++++++++++
 1 file changed, 14 insertions&#40;+&#41;

diff --git a/lib/Archive/Tar.pm b/lib/Archive/Tar.pm
index 9ac2763..adfb433 100644
--- a/lib/Archive/Tar.pm
+++ b/lib/Archive/Tar.pm
@@ -845,6 +845,20 @@ sub _extract_file {
         return;
     }
 
+    ### If a file system already contains a block device with the same name as
+    ### the being extracted regular file, we would write the file&#39;s content
+    ### to the block device. So remove the existing file &#40;block device&#41; now.
+    ### If an archive contains multiple same-named entries, the last one
+    ### should replace the previous ones. So remove the old file now.
+    ### If the old entry is a symlink to a file outside of the CWD, the new
+    ### entry would create a file there. This is CVE-2018-12015
+    ### &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125523">https://rt.cpan.org/Ticket/Display.html?id=125523</a></span>&gt;.
+    if &#40;-l $full || -e _&#41; {
+	if &#40;!unlink $full&#41; {
+	    $self-&gt;_error&#40; qq[Could not remove old file &#39;$full&#39;: $!] &#41;;
+	    return;
+	}
+    }
     if&#40; length $entry-&gt;type &#38;&#38; $entry-&gt;is_file &#41; {
         my $fh = IO::File-&gt;new;
         $fh-&gt;open&#40; $full, &#39;&gt;&#39; &#41; or &#40;
-- 
2.14.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;08&nbsp;10:22:48&nbsp;2018</span>
    <span class="description">dom [...] earth.li -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125523] CVE-2018-12015 directory traversal vulnerability</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 8 Jun 2018 14:51:30 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Petr Pisar via RT &lt;bug-Archive-Tar [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dominic Hargreaves &lt;dom [...] earth.li&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Jun 08, 2018 at 04:02:58AM -0400, Petr Pisar via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125523">https://rt.cpan.org/Ticket/Display.html?id=125523</a></span> &gt;
&gt; 
&gt; Dne Čt 07.čen.2018 17:31:29, DOM napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; As reported to the Debian BTS[1] Archive-Tar has a symlink-related
&gt; &gt; directory traversal vulnerability:
&gt; &gt;
</div>&gt; Attached patch simply removes every existing &#40;non-directory&#41; file that&#39;s going to be extracted. Even in non-secure mode.
&gt; 
&gt; Is it fine, or too strict, or even dangerous?
</div>
This looks good to me, but I&#39;d like a second opinion from someone more
familiar with the code before applying to Debian.

Thanks!
Dominic.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;08&nbsp;11:31:22&nbsp;2018</span>
    <span class="description">chris [...] bingosnet.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125523] CVE-2018-12015 directory traversal vulnerability</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 8 Jun 2018 16:29:47 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;dom [...] earth.li via RT&#34; &lt;bug-Archive-Tar [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Chris &#39;BinGOs&#39; Williams &lt;chris [...] bingosnet.co.uk&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Jun 08, 2018 at 10:22:48AM -0400, dom@earth.li via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; This looks good to me, but I&#39;d like a second opinion from someone more
&gt; familiar with the code before applying to Debian.
&gt; 
&gt; Thanks!
&gt; Dominic.
</div>
I have applied it as <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/jib/archive-tar-new/commit/ae65651eab053fc6dc4590dbb863a268215c1fc5">https://github.com/jib/archive-tar-new/commit/ae65651eab053fc6dc4590dbb863a268215c1fc5</a></span>

and released 2.28 to CPAN: <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/release/BINGOS/Archive-Tar-2.28">https://metacpan.org/release/BINGOS/Archive-Tar-2.28</a></span>

Cheers,

-- 
Chris Williams
aka BinGOs
PGP ID 0x4658671F
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.gumbynet.org.uk">http://www.gumbynet.org.uk</a></span>
==========================
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1789962/962686/signature.asc">Download signature.asc</a><br />
<span class="downloadcontenttype">application/pgp-signature 181b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;09&nbsp;19:22:32&nbsp;2018</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2018-06-08 08:31:22, chris@bingosnet.co.uk wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri, Jun 08, 2018 at 10:22:48AM -0400, dom@earth.li via RT wrote:
<div class="message-stanza open">&gt; &gt;
&gt; &gt; This looks good to me, but I&#39;d like a second opinion from someone
&gt; &gt; more
&gt; &gt; familiar with the code before applying to Debian.
&gt; &gt;
&gt; &gt; Thanks!
&gt; &gt; Dominic.
</div>&gt; 
&gt; I have applied it as <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/jib/archive-tar-">https://github.com/jib/archive-tar-</a></span>
&gt; new/commit/ae65651eab053fc6dc4590dbb863a268215c1fc5
&gt; 
&gt; and released 2.28 to CPAN:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/release/BINGOS/Archive-Tar-2.28">https://metacpan.org/release/BINGOS/Archive-Tar-2.28</a></span>
&gt; 
&gt; Cheers,
</div>

Can this ticket be closed now?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;09&nbsp;19:29:52&nbsp;2018</span>
    <span class="description">dom [...] earth.li -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125523] CVE-2018-12015 directory traversal vulnerability</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 10 Jun 2018 00:29:43 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;chris [...] bingosnet.co.uk via RT&#34; &lt;bug-Archive-Tar [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dominic Hargreaves &lt;dom [...] earth.li&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Jun 08, 2018 at 11:31:23AM -0400, chris@bingosnet.co.uk via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125523">https://rt.cpan.org/Ticket/Display.html?id=125523</a></span> &gt;
&gt; 
&gt; On Fri, Jun 08, 2018 at 10:22:48AM -0400, dom@earth.li via RT wrote:
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; This looks good to me, but I&#39;d like a second opinion from someone more
&gt; &gt; familiar with the code before applying to Debian.
&gt; &gt; 
&gt; &gt; Thanks!
&gt; &gt; Dominic.
</div>&gt; 
&gt; I have applied it as <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/jib/archive-tar-new/commit/ae65651eab053fc6dc4590dbb863a268215c1fc5">https://github.com/jib/archive-tar-new/commit/ae65651eab053fc6dc4590dbb863a268215c1fc5</a></span>
&gt; 
&gt; and released 2.28 to CPAN: <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/release/BINGOS/Archive-Tar-2.28">https://metacpan.org/release/BINGOS/Archive-Tar-2.28</a></span>
</div>
Thanks! We&#39;re rolling this out in Debian now.

Best,
Dominic.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;13&nbsp;23:17:50&nbsp;2018</span>
    <span class="description">andrew [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jun 08 04:02:52 2018, ppisar wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne Čt 07.čen.2018 17:31:29, DOM napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; As reported to the Debian BTS[1] Archive-Tar has a symlink-related
&gt; &gt; directory traversal vulnerability:
&gt; &gt;
</div>&gt; Attached patch simply removes every existing &#40;non-directory&#41; file
&gt; that&#39;s going to be extracted. Even in non-secure mode.
&gt; 
&gt; Is it fine, or too strict, or even dangerous?
&gt; 
</div>

Doesn&#39;t this just shorten the race and yet still have the same problem?  

If the attacker does something like:
perl -e &#39;symlink &#34;attack_vector&#34; &#34;to.extract&#34; while 1&#39;

Then I would think there&#39;s a reasonable chance that the symlink will get created between the unlink and the open while Archive::Tar is busy checking the length, if it is a file, and instantiating an IO::File object.  

I don&#39;t think the unlink is a negative, in that it avoids a case where you might run out of space to extract two copies of the file, but shouldn&#39;t this use a tempfile with a reasonably random name to avoid the race and then atomically rename it to the correct name?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;14&nbsp;22:58:45&nbsp;2018</span>
    <span class="description">andrew [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jun 13 23:17:50 2018, ANDREW wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Jun 08 04:02:52 2018, ppisar wrote:
<div class="message-stanza open">&gt; &gt; Dne Čt 07.čen.2018 17:31:29, DOM napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; &gt; As reported to the Debian BTS[1] Archive-Tar has a symlink-related
&gt; &gt; &gt; directory traversal vulnerability:
&gt; &gt; &gt;
</div>&gt; &gt; Attached patch simply removes every existing &#40;non-directory&#41; file
&gt; &gt; that&#39;s going to be extracted. Even in non-secure mode.
&gt; &gt;
&gt; &gt; Is it fine, or too strict, or even dangerous?
&gt; &gt;
</div></div>
Talking to ewilhelm at pdx.pm, the solution is probably to use the O_EXCL flag for the open.  This is not guaranteed to work on NFS, so you would also need a lockfile for that.  No idea what guarantees you&#39;re looking for with this.

<span class="clickylink"><a target="new" rel="nofollow" href="https://man.openbsd.org/open#O_EXCL">https://man.openbsd.org/open#O_EXCL</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;15&nbsp;18:57:54&nbsp;2018</span>
    <span class="description">andrew [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> dom [...] earth.li, chris [...] bingosnet.co.uk</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jun 14 22:58:45 2018, ANDREW wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Jun 13 23:17:50 2018, ANDREW wrote:
<div class="message-stanza open">&gt; &gt; On Fri Jun 08 04:02:52 2018, ppisar wrote:
<div class="message-stanza open">&gt; &gt; &gt; Dne Čt 07.čen.2018 17:31:29, DOM napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; &gt; &gt; As reported to the Debian BTS[1] Archive-Tar has a symlink-
&gt; &gt; &gt; &gt; related
&gt; &gt; &gt; &gt; directory traversal vulnerability:
&gt; &gt; &gt; &gt;
</div>&gt; &gt; &gt; Attached patch simply removes every existing &#40;non-directory&#41; file
&gt; &gt; &gt; that&#39;s going to be extracted. Even in non-secure mode.
&gt; &gt; &gt;
&gt; &gt; &gt; Is it fine, or too strict, or even dangerous?
&gt; &gt; &gt;
</div></div>&gt; 
&gt; Talking to ewilhelm at pdx.pm, the solution is probably to use the
&gt; O_EXCL flag for the open.  This is not guaranteed to work on NFS, so
&gt; you would also need a lockfile for that.  No idea what guarantees
&gt; you&#39;re looking for with this.
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://man.openbsd.org/open#O_EXCL">https://man.openbsd.org/open#O_EXCL</a></span>
</div>
Here is a patch that adds the O_EXCL flag to the open call.  Removing the unlink patch with just this one shows that it works, as the test suite extracts over files.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Extract-files-with-O_EXCL.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 0766551dd0298b5216699abf3f805c59b92c7840 Mon Sep 17 00:00:00 2001
From: Andrew Hewus Fresh &lt;andrew@afresh1.com&gt;
Date: Fri, 15 Jun 2018 15:47:49 -0700
Subject: [PATCH] Extract files with O_EXCL

This will cause the open to die if the file exists, avoiding a race
condition and security risk.

Relates to commit ae65651eab053fc6dc4590dbb863a268215c1fc5
and <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125523">https://rt.cpan.org/Ticket/Display.html?id=125523</a></span>
---
 lib/Archive/Tar.pm | 2 +-
 1 file changed, 1 insertion&#40;+&#41;, 1 deletion&#40;-&#41;

diff --git a/lib/Archive/Tar.pm b/lib/Archive/Tar.pm
index 5950b3e..a3aa577 100644
--- a/lib/Archive/Tar.pm
+++ b/lib/Archive/Tar.pm
@@ -861,7 +861,7 @@ sub _extract_file {
     }
     if&#40; length $entry-&gt;type &#38;&#38; $entry-&gt;is_file &#41; {
         my $fh = IO::File-&gt;new;
-        $fh-&gt;open&#40; $full, &#39;&gt;&#39; &#41; or &#40;
+        $fh-&gt;open&#40; $full, O_WRONLY|O_CREAT|O_EXCL  &#41; or &#40;
             $self-&gt;_error&#40; qq[Could not open file &#39;$full&#39;: $!] &#41;,
             return
         &#41;;
-- 
2.16.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;15&nbsp;20:15:57&nbsp;2018</span>
    <span class="description">dom [...] earth.li -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125523] CVE-2018-12015 directory traversal vulnerability</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 16 Jun 2018 01:15:28 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Andrew Fresh via RT &lt;bug-Archive-Tar [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dominic Hargreaves &lt;dom [...] earth.li&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Jun 13, 2018 at 11:17:51PM -0400, Andrew Fresh via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125523">https://rt.cpan.org/Ticket/Display.html?id=125523</a></span> &gt;
&gt; 
&gt; On Fri Jun 08 04:02:52 2018, ppisar wrote:
<div class="message-stanza open">&gt; &gt; Dne Čt 07.čen.2018 17:31:29, DOM napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; &gt; As reported to the Debian BTS[1] Archive-Tar has a symlink-related
&gt; &gt; &gt; directory traversal vulnerability:
&gt; &gt; &gt;
</div>&gt; &gt; Attached patch simply removes every existing &#40;non-directory&#41; file
&gt; &gt; that&#39;s going to be extracted. Even in non-secure mode.
&gt; &gt; 
&gt; &gt; Is it fine, or too strict, or even dangerous?
&gt; &gt; 
</div>&gt; 
&gt; 
&gt; Doesn&#39;t this just shorten the race and yet still have the same problem?  
&gt; 
&gt; If the attacker does something like:
&gt; perl -e &#39;symlink &#34;attack_vector&#34; &#34;to.extract&#34; while 1&#39;
</div>
The attack referred to in this ticket is not to do with people
extracting into an attacker controlled directory, but people extracting
an attacker-controlled archive. So there is no change for the attacker
to run this code.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Then I would think there&#39;s a reasonable chance that the symlink will get created between the unlink and the open while Archive::Tar is busy checking the length, if it is a file, and instantiating an IO::File object.  
&gt; 
&gt; I don&#39;t think the unlink is a negative, in that it avoids a case where you might run out of space to extract two copies of the file, but shouldn&#39;t this use a tempfile with a reasonably random name to avoid the race and then atomically rename it to the correct name?
</div>
This isn&#39;t to say that the attack you describe isn&#39;t valid, but it would
be much, much harder to pull off, since it would require the victim to be
unpacking an archive - and this isn&#39;t a bug in Archive-Tar so much as a
user behaviour problem, right?

Or am I misunderstanding completely?

Dominic.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;15&nbsp;21:53:34&nbsp;2018</span>
    <span class="description">andrew [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> dom [...] earth.li</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jun 15 20:15:57 2018, dom@earth.li wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed, Jun 13, 2018 at 11:17:51PM -0400, Andrew Fresh via RT wrote:
&gt; This isn&#39;t to say that the attack you describe isn&#39;t valid, but it
&gt; would
&gt; be much, much harder to pull off, since it would require the victim to
&gt; be
&gt; unpacking an archive - and this isn&#39;t a bug in Archive-Tar so much as
&gt; a
&gt; user behaviour problem, right?
&gt; 
&gt; Or am I misunderstanding completely?
&gt; 
&gt; Dominic.
</div>

I think you are correct, I must have I misunderstood the problem when first reading the ticket.  The existing patch should solve the problem of a malicious tar file extracting outside of the current working directory with a symlink.  Thank you for explaining again.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
