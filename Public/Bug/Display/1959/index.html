<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #1959 for Mail-IMAPClient: bug: Mail::IMAPClient::BodyStructure::Parse chokes on some messages</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #1959 for Mail-IMAPClient: bug: Mail::IMAPClient::BodyStructure::Parse chokes on some messages</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Mail-IMAPClient/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Mail-IMAPClient/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Mail-IMAPClient/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Mail-IMAPClient/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-IMAPClient">Mail-IMAPClient CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">1959</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Mail-IMAPClient/Active/">Mail-IMAPClient</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">DJKERNEN__NO_SOLICITING__ [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
adrian [...] quantumcat.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-19960-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-19961-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;19&nbsp;11:36:29&nbsp;2003</span>
    <span class="description">adrian [...] quantumcat.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Adrian &lt;adrian [...] quantumcat.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-IMAPClient [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> bug: Mail::IMAPClient::BodyStructure::Parse chokes on some messages</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 19 Jan 2003 11:34:31 -0500</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello.

I&#39;ve found two bugs, actually:

1&#41; In some circumstances, not all server output in response to the command 
FETCH BODYSTRUCTURE reaches Mail::IMAPClient::BodyStructure::Parser &#40;see 
attached file bug1.txt&#41; -- some of it is truncated. I suspect it&#39;s because 
sometimes the server splits the output on multiple lines &#40;see raw_output.txt, 
which contains the server response to FETCH BODYSTRUCTURE in raw form&#41;, while 
IMAPClient expects all the relevant output in one line.

2&#41; With the help of a really crude hack, I managed to get IMAPClient to pass 
all the FETCH BODYSTRUCTURE output to the BodyStructure parser, but the 
parser seems to choke on it &#40;see attached bug2.txt&#41;. 

Environment details: 
Redhat Linux 8.0, kernel 2.4.19
Mail::IMAPClient 2.2.6 
Perl: 5.8.0 
UW imap 2001a

How to reproduce the bug: as far as I can tell, both bugs only show up when 
processing messages containing MIME parts nested at least 3 levels deep. I 
just picked a random message that had a few pictures attached from my inbox 
and used the &#34;Forward as attachment&#34; function of my MUA to forward it to a 
test account. Calling FETCH BODYSTRUCTURE on such a message triggers the 
bugs.

Files attached to this message:
test.pl - the script I used to test the bugs
bug1.txt - log of session that shows first bug in action
bug2.txt - log of session that shows second bug
raw_output.txt - raw output of FETCH BODYSTRUCTURE server response as returned 
by $imap-&gt;fetch&#40;1, &#34;BODYSTRUCTURE&#34;&#41; to show that it is split across multiple 
lines

For your convenience, I&#39;ve also enabled tracing for 
Mail::IMAPClient::BodyStructure::Parser.

Hope this helps.
Adrian.
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;21&nbsp;10:39:53&nbsp;2003</span>
    <span class="description">DJKERNEN__NO_SOLICITING__ [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;21&nbsp;12:59:15&nbsp;2003</span>
    <span class="description">DJKERNEN__NO_SOLICITING__ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is not really two bugs but one. The problem is caused by the body descpription field of the 
forwarded message subpart. This entire field is being passed as a literal string. The 
get_bodystructure method is parsing the output from the FETCH BODYSTRUCTURE IMAP client 
command in a naive manner, and is not expecting the output to be broken up the way it is. 

When the FETCH BODYSTRUCTURE output is obtained manually, the part that was delimited by a 
literal is placed inline without any indication that this chunk was once one discreet item. This is why 
the parse of the full bodystructure is failing.

It is possible for me to fix this by carefully reassembling the entire response within the 
get_bodystructure method, replacing the &#34;naive&#34; code with something that can handle 
this style of response more gracefully. I&#39;ll update this ticket when that&#39;s ready.

-- 
Dave K.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;22&nbsp;10:20:39&nbsp;2003</span>
    <span class="description">DJKERNEN__NO_SOLICITING__ [...] cpan.org -  Status changed from &#39;new&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;23&nbsp;16:16:18&nbsp;2003</span>
    <span class="description">DJKERNEN__NO_SOLICITING__ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Enclosed is a patch. A similar bug exists in get_envelope, and this patch will not fix that bug. 
However both will be fixed in 2.2.7.

Use the patch command to apply the patch. If you can&#39;t run patch &#40;as will probably be the case if 
you are on NT&#41; then let me know and I&#39;ll send a plain-text replacement for get_bodystructure.

-- 
Dave K.
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">*** IMAPClient_pm.old	Thu Jan 23 21:09:14 2003
--- IMAPClient.pm	Thu Jan 23 21:10:26 2003
***************
*** 2009,2032 ****
  	return undef;
  }
  	
  sub get_bodystructure {
  	my&#40;$self,$msg&#41; = @_;
  	unless &#40; eval {require Mail::IMAPClient::BodyStructure ; 1 } &#41; {
  		$self-&gt;LastError&#40;&#34;Unable to use get_bodystructure: $@\n&#34;&#41;;
  		return undef;
  	}
  	my $bs = &#34;&#34;;
! 	eval { $bs = Mail::IMAPClient::BodyStructure-&gt;new&#40;
! 		grep&#40;	/bodystructure \&#40;/i, 	# Wee! ;-&#41;
! 			$self-&gt;fetch&#40;$msg,&#34;BODYSTRUCTURE&#34;&#41;
! 		&#41;
! 	&#41;};  
  	$self-&gt;_debug&#40;&#34;get_bodystructure: msg $msg returns this ref: &#34;. 
  		&#40; $bs ? &#34; $bs&#34; : &#34; UNDEF&#34; &#41; 
  		.&#34;\n&#34;&#41;;
  	return $bs;
  }
- 
  sub get_envelope {
  	my&#40;$self,$msg&#41; = @_;
  	unless &#40; eval {require Mail::IMAPClient::BodyStructure ; 1 } &#41; {
--- 2009,2054 ----
  	return undef;
  }
  	
+ # Updated to handle embedded literal strings
  sub get_bodystructure {
  	my&#40;$self,$msg&#41; = @_;
  	unless &#40; eval {require Mail::IMAPClient::BodyStructure ; 1 } &#41; {
  		$self-&gt;LastError&#40;&#34;Unable to use get_bodystructure: $@\n&#34;&#41;;
  		return undef;
  	}
+ 	my @out = $self-&gt;fetch&#40;$msg,&#34;BODYSTRUCTURE&#34;&#41;;
  	my $bs = &#34;&#34;;
! 	my $output = grep&#40;	
! 		/BODYSTRUCTURE \&#40;/i,  @out	 # Wee! ;-&#41;
! 	&#41;; 
! 	if &#40; $output =~ /\r\n$/ &#41; {
! 		eval { $bs = Mail::IMAPClient::BodyStructure-&gt;new&#40; $output &#41;};  
! 	} else {
! 		$self-&gt;_debug&#40;&#34;get_bodystructure: reassembling original response\n&#34;&#41;;
! 		my $start = 0;
! 		foreach my $o &#40;@{$self-&gt;{&#34;History&#34;}{$self-&gt;Transaction}}&#41; {
! 			next unless $self-&gt;_is_output_or_literal&#40;$o&#41;;
! 			$self-&gt;_debug&#40;&#34;o-&gt;[DATA] is &#34;.$o-&gt;[DATA].&#34;\n&#34;&#41;;
! 			next unless $start or 
! 				$o-&gt;[DATA] =~ /BODYSTRUCTURE \&#40;/i and ++$start;	  # Hi, vi! ;-&#41;
! 			if &#40; length&#40;$output&#41; and $self-&gt;_is_literal&#40;$o&#41; &#41; {
! 				my $data = $o-&gt;[DATA];
! 				$data =~ s/&#34;/\\&#34;/g;
! 				$data =~ s/\&#40;/\\\&#40;/g;
! 				$data =~ s/\&#41;/\\\&#41;/g;
! 				$output .= &#39;&#34;&#39;.$data.&#39;&#34;&#39;;
! 			} else {
! 				$output .= $o-&gt;[DATA] ;
! 			}
! 			$self-&gt;_debug&#40;&#34;get_bodystructure: reassembled output=$output&lt;END&gt;\n&#34;&#41;;
! 		}
! 		eval { $bs = Mail::IMAPClient::BodyStructure-&gt;new&#40; $output &#41;};  
! 	}
  	$self-&gt;_debug&#40;&#34;get_bodystructure: msg $msg returns this ref: &#34;. 
  		&#40; $bs ? &#34; $bs&#34; : &#34; UNDEF&#34; &#41; 
  		.&#34;\n&#34;&#41;;
  	return $bs;
  }
  sub get_envelope {
  	my&#40;$self,$msg&#41; = @_;
  	unless &#40; eval {require Mail::IMAPClient::BodyStructure ; 1 } &#41; {
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;23&nbsp;16:16:19&nbsp;2003</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;23&nbsp;16:18:09&nbsp;2003</span>
    <span class="description">DJKERNEN__NO_SOLICITING__ [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
