<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #7363 for DNS-ZoneParse: Wrong parsing of defaulted names &#38; general comment</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #7363 for DNS-ZoneParse: Wrong parsing of defaulted names &#38; general comment</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DNS-ZoneParse">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DNS-ZoneParse">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DNS-ZoneParse">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DNS-ZoneParse">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DNS-ZoneParse">DNS-ZoneParse CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">7363</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DNS-ZoneParse">DNS-ZoneParse</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mv [...] pdv-systeme.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-11678-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.91    </td>
  </tr>
  <tr id="CF-11679-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




DNS-ZoneParse.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/109892/21769/DNS-ZoneParse.diff">
Tue Aug 17 08:37:46 2004 (9.4k) by 
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=7363">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-109891" href="/Public/Bug/Display.html?id=7363#txn-109891">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;16&nbsp;09:09:59&nbsp;2004</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Wrong parsing of defaulted names &#38; general comment</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/109891/21730/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/21730">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">1.

@ IN SOA ...
  86400 IN NS ns...

gets parsed wrong &#40;name=&gt;86400,ttl=&gt;&#39;&#39;&#41;.


2.

253 IN PTR x...
    IN PTR y...
    IN PTR z...

The second and all following RR get thrown away because no regexp
matches a PTR RR where the name is defaulted.


3.

If the header doesn&#39;t have the format DNS::ZoneParse expects, there&#39;s
no origin. RFC 1035 states in 5.1 that &#34;the actual domain name is the
concatenation of the relative part with an origin specified in a
$ORIGIN, $INCLUDE, or as an argument to the master file loading
routine.&#34;.

_load_file&#40;&#41; and _parse&#40;&#41; could be extended to accept an optional $origin parameter.


General comments:

I would modify the line 

    my @records = map {s/^\s+//g; $_} split &#40;m|$/|, $zone&#41;;

in _clean_records&#40;&#41; to not throw away the information that a RR starts with a &lt;blank&gt; &#40;i.e. the &#34;name&#34; field is defaulted&#41;, and modify the regular expressions in _parse&#40;&#41; and _massage&#40;&#41; to react accordingly to a &lt;blank&gt;. #1 above and the ambiguity in PTR RRs with respect to the TTL would thus be resolved.

Compressing all consecutive whitespace to one blank would simplify the
regexps.

The module should react to a RR line it can&#39;t parse, i.e. there should
be an &#34;else&#34; branch in _parse&#40;&#41; that contains at least a call to carp&#40;&#41;.

Thanks for listening.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-109892" href="/Public/Bug/Display.html?id=7363#txn-109892">#</a>      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;17&nbsp;08:37:44&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mv [...] pdv-systeme.de</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/109892/21768/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/21768">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 113b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Mon Aug 16 09:09:59 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ...
</div>
The attached patch resolves all these issues.

Best regards,
  Martin
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/109892/21769/DNS-ZoneParse.diff">Download DNS-ZoneParse.diff</a><br />
<span class="downloadcontenttype">text/x-diff 9.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -urdN DNS-ZoneParse-0.91-orig/lib/DNS/ZoneParse.pm DNS-ZoneParse-0.91/lib/DNS/ZoneParse.pm
--- DNS-ZoneParse-0.91-orig/lib/DNS/ZoneParse.pm	2003-08-03 16:28:24.000000000 +0200
+++ DNS-ZoneParse-0.91/lib/DNS/ZoneParse.pm	2004-08-17 14:24:26.000000000 +0200
@@ -152,7 +152,7 @@
 
 
 sub _load_file {
-    my &#40;$self, $zonefile&#41; = @_;
+    my &#40;$self, $zonefile, $origin&#41; = @_;
     my $zone_contents;
     if&#40;ref&#40;$zonefile&#41; eq &#34;SCALAR&#34;&#41; {
         $zone_contents = $$zonefile;
@@ -165,73 +165,75 @@
             croak qq[DNS::ZoneParse Could not open input file: &#34;$zonefile&#34;:$!]
         }
     }
-    if &#40;$self-&gt;_parse&#40; $zonefile, $zone_contents &#41;&#41; { return 1; }
+    if &#40;$self-&gt;_parse&#40; $zonefile, $zone_contents, $origin &#41;&#41; { return 1; }
 }
 
 
 sub _parse {
-    my &#40;$self, $zonefile, $contents&#41; = @_;
+    my &#40;$self, $zonefile, $contents, $origin&#41; = @_;
     $self-&gt;_initialize&#40;&#41;;
 
     my $chars = qr/[a-z\-\.0-9]+/i;
     $contents =~ /Database file &#40;$chars&#41;&#40; dns&#41;? for &#40;$chars&#41; zone/si;
-    $dns_id{$self} = _massage&#40;{ ZoneFile =&gt; $1 || $zonefile, Origin =&gt; $3 }&#41;;
+    $dns_id{$self} = _massage&#40;{ ZoneFile =&gt; $1 || $zonefile, Origin =&gt; $3 || $origin }&#41;;
 
     my $records    = $self-&gt;_clean_records&#40;$contents&#41;;
     my $valid_name = qr/[\@a-z_\-\.0-9\*]+/i;
     my $valid_ip6  = qr/[\@a-z_\-\.0-9\*:]+/i;
-    my $rr_class   = qr/\b&#40;?:in|hs|ch&#41;\b/i;
-    my $rr_types   = qr/\b&#40;?:ns|a|cname&#41;\b/i;
+    my $rr_class   = qr/\b&#40;?:IN|HS|CH&#41;\b/i;
+    my $rr_type    = qr/\b&#40;?:NS|A|CNAME&#41;\b/i;
     my $rr_ttl     = qr/&#40;?:\d+[wdhms]?&#41;+/i;
-    my $ttl_cls    = qr/&#40;?:&#40;$rr_ttl&#41;\s+&#41;?&#40;?:\b&#40;$rr_class&#41;\s+&#41;?\s*/; 
+    my $ttl_cls    = qr/&#40;?:&#40;$rr_ttl&#41;\s&#41;?&#40;?:&#40;$rr_class&#41;\s&#41;?/; 
 
     _massage&#40;&#41;;    # reset last_name
     foreach &#40;@$records&#41; {
-        if &#40;/^&#40;$valid_name&#41;? \s*          # host
-              &#40;?:&#40;$rr_ttl&#41;\s+&#41;?           # ttl
-              &#40;?:\b&#40;$rr_class&#41;\s+&#41;?\s*    # class
-              &#40;$rr_types&#41; \s+             # record type
+        if &#40;/^&#40;$valid_name|\s&#41;? \s*       # host
+	      $ttl_cls                    # ttl &#38; class
+              &#40;$rr_type&#41; \s               # record type
               &#40;$valid_name&#41;               # record data
              /ix&#41; {
              my &#40;$name, $ttl, $class, $type, $host&#41; = &#40;$1, $2, $3, $4, $5&#41;;
-             if &#40;!$class &#38;&#38; defined $name &#38;&#38; $name =~ /^$rr_class$/&#41; {
-                 $class = uc $name;
-                 undef $name;
-             }
              my $dns_thing = uc $type eq &#39;NS&#39; ? $dns_ns{$self}
                  : uc $type eq &#39;A&#39; ? $dns_a{$self} : $dns_cname{$self};
              push @$dns_thing,
                  _massage&#40;{name =&gt; $name, class=&gt; $class,
                            host =&gt; $host, ttl =&gt; $ttl}&#41;
         }
-        elsif &#40;/&#40;$valid_name&#41;? \s* $ttl_cls AAAA \s+ &#40;$valid_ip6&#41;/&#41;
-        {
+        elsif &#40;/^&#40;$valid_name|\s&#41;? \s*
+	         $ttl_cls
+	         AAAA \s
+	         &#40;$valid_ip6&#41;
+	       /x&#41; {
             my &#40;$name, $ttl, $class, $host&#41; = &#40;$1, $2, $3, $4&#41;;
-             if &#40;!$class &#38;&#38; defined $name &#38;&#38; $name =~ /^$rr_class$/&#41; {
-                 $class = uc $name;
-                 undef $name;
-             }
              push @{$dns_a4{$self}},
                  _massage&#40;{name =&gt; $name, class=&gt; $class,
                            host =&gt; $host, ttl =&gt; $ttl}&#41;
         }
-        elsif &#40;/&#40;$valid_name&#41;? \s* $ttl_cls MX \s+ &#40;\d+&#41; \s+ &#40;$valid_name&#41;/ix&#41;
-        {
+        elsif &#40;/^&#40;$valid_name|\s&#41;? \s*
+	         $ttl_cls
+	         MX \s
+	         &#40;\d+&#41; \s
+	         &#40;$valid_name&#41;
+	       /ix&#41; {
               # host ttl class mx pri dest
              my &#40;$name, $ttl, $class, $pri, $host&#41; = &#40;$1, $2, $3, $4, $5&#41;;
-             if &#40;!$class &#38;&#38; defined $name &#38;&#38; $name =~ /^$rr_class$/&#41; {
-                 $class = uc $name;
-                 undef $name;
-             }
              push @{$dns_mx{$self}},
                   _massage&#40;{ name =&gt; $name, priority =&gt; $pri,
                              host =&gt; $host, ttl =&gt; $ttl, class =&gt; $class}&#41;
         }
-        elsif &#40;/&#40;$valid_name&#41; \s+ $ttl_cls
-                SOA \s+ &#40;$valid_name&#41; \s+ &#40;$valid_name&#41; \s*
-                \&#40;?\s* &#40;$rr_ttl&#41; \s+ &#40;$rr_ttl&#41; \s+ &#40;$rr_ttl&#41; \s+
-                &#40;$rr_ttl&#41; \s+ &#40;$rr_ttl&#41; \s* \&#41;? /ix&#41;
-        {
+        elsif &#40;/^&#40;$valid_name&#41; \s
+	         $ttl_cls
+                 SOA \s
+	         &#40;$valid_name&#41; \s
+	         &#40;$valid_name&#41; \s*
+                 \&#40;? \s*
+	          &#40;$rr_ttl&#41; \s
+	          &#40;$rr_ttl&#41; \s
+	          &#40;$rr_ttl&#41; \s
+                  &#40;$rr_ttl&#41; \s
+	          &#40;$rr_ttl&#41; \s*
+	         \&#41;?
+	       /ix&#41; {
             # SOA record
             my $ttl = $dns_soa{$self}-&gt;{ttl} || $2 || &#39;&#39;;
             $dns_soa{$self} =
@@ -239,8 +241,11 @@
                            email =&gt;$5, serial =&gt; $6, refresh=&gt; $7,
                            retry=&gt; $8, expire=&gt; $9, minimumTTL =&gt; $10 }&#41;;
         }
-        elsif &#40;/&#40;\d$valid_name+&#41;\s+&#40;$rr_ttl&#41;?\s*?&#40;$rr_class&#41;?\s*?PTR\s+&#40;$valid_name&#41;/i&#41;
-        {
+        elsif &#40;/^&#40;$valid_name|\s&#41; \s*
+	         $ttl_cls
+	         PTR \s
+	         &#40;$valid_name&#41;
+	       /ix&#41; {
             # PTR
             push @{$dns_ptr{$self}},
                 _massage&#40;{ name =&gt; $1, class =&gt; $3, ttl =&gt; $2,  host =&gt; $4 }&#41;;
@@ -253,6 +258,9 @@
         elsif &#40;/\$TTL\s+&#40;$rr_ttl&#41;/i&#41; {
             $dns_soa{$self}-&gt;{ttl} = $1;
         }
+        else {
+            carp &#34;Unparseable line\n  $_\n&#34;;
+        }
     }
     return 1;
 }
@@ -261,21 +269,23 @@
     my $self = shift;
     my &#40;$zone&#41; = shift;
 
-    $zone =~ s&lt;\;.{0,}$&gt;&lt;&gt;mg;    # Remove comments
-    $zone =~ s&lt;^\s*?$&gt;&lt;&gt;mg;      # Remove empty lines
-    $zone =~ s!$/{2,}!$/!g;      # Remove double carriage returns
+    $zone =~ s&lt;\;.*$&gt; &lt;&gt;mg;	# Remove comments
+    $zone =~ s&lt;^\s*$&gt; &lt;&gt;mg;	# Remove empty lines
+    $zone =~ s&lt;$/+&gt;   &lt;$/&gt;g;	# Remove multiple carriage returns
+    $zone =~ s&lt;[ \t]+&gt;&lt; &gt;g;	# Collapse whitespace, turn TABs to spaces
 
     # Concatenate everything split over multiple lines i.e. elements surrounded
     # by parentheses can be split over multiple lines. See RFC 1035 section 5.1
     $zone =~ s{&#40;\&#40;[^\&#41;]*?\&#41;&#41;}{_concatenate&#40;$1&#41;}egs;
 
-    my @records = map {s/^\s+//g; $_} split &#40;m|$/|, $zone&#41;;
+    # Split into multiple records, and kick out empty lines
+    my @records = grep !/^$/, split &#40;m|$/|, $zone&#41;;
     return \@records;
 }
 
 sub _concatenate {
     my $text_in_parenth= shift;
-    $text_in_parenth=~ s{$/}{}g;
+    $text_in_parenth=~ s{\s*$/\s*}{ }g;
     return $text_in_parenth;
 }
 
@@ -288,7 +298,7 @@
         $record-&gt;{$_} = uc $record-&gt;{$_} if $_ eq &#39;class&#39;;
     }
     return $record unless defined $record-&gt;{name};
-    if &#40;length $record-&gt;{name}&#41; {
+    if &#40;length $record-&gt;{name} &#38;&#38; $record-&gt;{name} ne &#39; &#39;&#41; {
         $last_name = $record-&gt;{name};
     } else {
         $record-&gt;{name} = $last_name;
diff -urdN DNS-ZoneParse-0.91-orig/t/dns-zoneparse.t DNS-ZoneParse-0.91/t/dns-zoneparse.t
--- DNS-ZoneParse-0.91-orig/t/dns-zoneparse.t	2003-08-03 16:29:02.000000000 +0200
+++ DNS-ZoneParse-0.91/t/dns-zoneparse.t	2004-08-17 11:57:56.000000000 +0200
@@ -64,19 +64,22 @@
             &#39;ttl&#39; =&gt; &#39;&#39;, &#39;name&#39; =&gt; &#39;www&#39;, &#39;class&#39; =&gt; &#39;IN&#39;, &#39;host&#39; =&gt; &#39;10.0.0.2&#39;
            },
            {
-            &#39;ttl&#39; =&gt; &#39;&#39;, &#39;name&#39; =&gt; &#39;www&#39;, &#39;class&#39; =&gt; &#39;&#39;, &#39;host&#39; =&gt; &#39;10.0.0.4&#39;
+            &#39;ttl&#39; =&gt; &#39;43200&#39;, &#39;name&#39; =&gt; &#39;www&#39;, &#39;class&#39; =&gt; &#39;IN&#39;, &#39;host&#39; =&gt; &#39;10.0.0.3&#39;
            },
            {
-            &#39;ttl&#39; =&gt; &#39;&#39;, &#39;name&#39; =&gt; &#39;foo&#39;, &#39;class&#39; =&gt; &#39;IN&#39;, &#39;host&#39; =&gt; &#39;10.0.0.5&#39;
+            &#39;ttl&#39; =&gt; &#39;&#39;, &#39;name&#39; =&gt; &#39;www&#39;, &#39;class&#39; =&gt; &#39;&#39;, &#39;host&#39; =&gt; &#39;10.0.0.5&#39;
+           },
+           {
+            &#39;ttl&#39; =&gt; &#39;&#39;, &#39;name&#39; =&gt; &#39;foo&#39;, &#39;class&#39; =&gt; &#39;IN&#39;, &#39;host&#39; =&gt; &#39;10.0.0.6&#39;
            },
             {
-            &#39;ttl&#39; =&gt; &#39;&#39;, &#39;name&#39; =&gt; &#39;mini&#39;, &#39;class&#39; =&gt; &#39;&#39;, &#39;host&#39; =&gt; &#39;10.0.0.6&#39;
+            &#39;ttl&#39; =&gt; &#39;&#39;, &#39;name&#39; =&gt; &#39;mini&#39;, &#39;class&#39; =&gt; &#39;&#39;, &#39;host&#39; =&gt; &#39;10.0.0.7&#39;
            },
           ], &#39;A records parsed OK&#39;&#41;;
 
     is_deeply&#40;$zf-&gt;ns, [
           {
-            &#39;ttl&#39; =&gt; &#39;&#39;,
+            &#39;ttl&#39; =&gt; &#39;43200&#39;,
             &#39;name&#39; =&gt; &#39;@&#39;,
             &#39;class&#39; =&gt; &#39;IN&#39;,
             &#39;host&#39; =&gt; &#39;ns0.dns-zoneparse-test.net.&#39;
@@ -102,7 +105,7 @@
             &#39;ttl&#39; =&gt; &#39;&#39;,
             &#39;name&#39; =&gt; &#39;www&#39;,
             &#39;class&#39; =&gt; &#39;IN&#39;,
-            &#39;host&#39; =&gt; &#39;10.0.0.3&#39;
+            &#39;host&#39; =&gt; &#39;10.0.0.4&#39;
           },
         ], &#39;MX records parsed OK&#39;&#41;;
 
diff -urdN DNS-ZoneParse-0.91-orig/t/test-zone.db DNS-ZoneParse-0.91/t/test-zone.db
--- DNS-ZoneParse-0.91-orig/t/test-zone.db	2003-08-03 16:27:04.000000000 +0200
+++ DNS-ZoneParse-0.91/t/test-zone.db	2004-08-17 11:57:56.000000000 +0200
@@ -8,7 +8,7 @@
                         691200      ; expire
                         86400     &#41; ; minimum TTL
 
-@                       IN	NS	ns0.dns-zoneparse-test.net.
+         43200          IN	NS	ns0.dns-zoneparse-test.net.
 @                       IN	NS	ns1.dns-zoneparse-test.net.
 
 @                       IN	A	127.0.0.1
@@ -18,10 +18,11 @@
 mail                    IN	A	127.0.0.1
 www                     IN	A	127.0.0.1
                         in      a       10.0.0.2
-                        IN      MX      10      10.0.0.3
-                                A       10.0.0.4
-foo                     IN      A       10.0.0.5
-mini                            A       10.0.0.6
+         43200          IN      A       10.0.0.3
+                        IN      MX      10      10.0.0.4
+                                A       10.0.0.5
+foo                     IN      A       10.0.0.6
+mini                            A       10.0.0.7
 icarus                  IN      AAAA    fe80::0260:83ff:fe7c:3a2a
 soup                    IN      TXT     &#34;This is a text message&#34;
 txta                            TXT     &#34;This is another text message&#34;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-109893" href="/Public/Bug/Display.html?id=7363#txn-109893">#</a>      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;22&nbsp;09:18:20&nbsp;2004</span>
    <span class="description">SIMONFLK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/109893/21913/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/21913">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 80b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Patch applied. v0.92 that has just been uploaded to CPAN.

Thank you
Simon Flack
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-109894" href="/Public/Bug/Display.html?id=7363#txn-109894">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;22&nbsp;09:19:28&nbsp;2004</span>
    <span class="description">SIMONFLK [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.32455</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
