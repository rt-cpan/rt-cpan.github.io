<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #41353 for XML-LibXML: XML_LIBXML_KEEP_BLANKS option not documented</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #41353 for XML-LibXML: XML_LIBXML_KEEP_BLANKS option not documented</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/XML-LibXML/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-LibXML">XML-LibXML CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">41353</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/XML-LibXML/Active/">XML-LibXML</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
wellnhofer [...] aevum.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Unimportant    </td>
  </tr>
  <tr id="CF-37350-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-37351-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;01&nbsp;10:42:17&nbsp;2008</span>
    <span class="description">NWELLNHOF [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> XML_LIBXML_KEEP_BLANKS option not documented</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I just spent some hours trying to figure out why XML::LibXSLT wouldn&#39;t
indent my XSLT result documents, whereas xsltproc would. It turned out
to be caused by the undocumented option XML_LIBXML_KEEP_BLANKS of the
XML::LibXML constructor that defaults to 1. Setting it to 0 makes the
indenting work.

It would be nice if this option could be documented.

I also wonder if the default shouldn&#39;t be 0.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;23&nbsp;15:24:22&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne po 01.pro.2008 10:42:17, NWELLNHOF napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I just spent some hours trying to figure out why XML::LibXSLT 
</div>wouldn&#39;t
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; indent my XSLT result documents, whereas xsltproc would. It turned 
</div>out

Would you care to provide a sample where xsltproc behaves differently 
than XML::LibXSLT? Did you have to turn it off for parsing the 
stylesheet or the XML input?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; to be caused by the undocumented option XML_LIBXML_KEEP_BLANKS of the
&gt; XML::LibXML constructor that defaults to 1. Setting it to 0 makes the
&gt; indenting work.
</div>
The option and the default value *are* documented in 
XML::LibXML::Parser. 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It would be nice if this option could be documented.
&gt; 
&gt; I also wonder if the default shouldn&#39;t be 0.
</div>
I don&#39;t think so, libxml2&#39;s default is 1, XML standard says whitespace 
is significant. 

-- Petr
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;23&nbsp;15:24:23&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;23&nbsp;18:40:38&nbsp;2009</span>
    <span class="description">NWELLNHOF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I see, the option is documented. Sorry about that.

But I had a closer look into the indenting issue and the behavior is
definitely buggy. Just see the attached test case.

Test 1 is a simple transform using transform_file&#40;&#41;. Indenting works as
expected.

Test 2 is the same transform. But before that I parse a completely
unrelated XML file. Suddenly, the indenting doesn&#39;t work.

Test 3 is also the same transform. Before that I parse an unrelated XML
file, but this time with keep_blanks&#40;0&#41;. Now, the indenting works again.
There seems to be a strange side effect.

I think this only affects XHTML output.

Maybe I dig deeper into this over the weekend. I should be familiar
enough with the libxml/libxslt code base to fix this.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;24&nbsp;08:19:20&nbsp;2009</span>
    <span class="description">NWELLNHOF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It&#39;s a bug in libxml. See my post to the libxml mailing list.

Maybe one could work around this in XML::LibXML, but I don&#39;t think it&#39;s
very important.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;30&nbsp;10:00:30&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne so 24.led.2009 08:19:20, NWELLNHOF napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It&#39;s a bug in libxml. See my post to the libxml mailing list.
&gt; 
&gt; Maybe one could work around this in XML::LibXML, but I don&#39;t think it&#39;s
&gt; very important.
</div>
The current SVN does not call xmlKeepBlanksDefault&#40;&#41; at all, which fixes
this as well.

Thanks,

-- Petr
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;30&nbsp;10:00:33&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;01&nbsp;02:21:12&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Why do you change

REPORT_ERROR&#40;recover ? recover : 1&#41;;
to
REPORT_ERROR&#40;1&#41;; ?

recover can be also 2...

-- Petr

Dne st 30.zář.2009 10:00:30, PAJAS napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne so 24.led.2009 08:19:20, NWELLNHOF napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; It&#39;s a bug in libxml. See my post to the libxml mailing list.
&gt; &gt; 
&gt; &gt; Maybe one could work around this in XML::LibXML, but I don&#39;t think it&#39;s
&gt; &gt; very important.
</div>&gt; 
&gt; The current SVN does not call xmlKeepBlanksDefault&#40;&#41; at all, which fixes
&gt; this as well.
&gt; 
&gt; Thanks,
&gt; 
&gt; -- Petr
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;01&nbsp;02:21:14&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;01&nbsp;09:00:38&nbsp;2009</span>
    <span class="description">wellnhofer [...] aevum.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #41353] XML_LIBXML_KEEP_BLANKS option not documented</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 01 Oct 2009 15:00:11 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-LibXML [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Nick Wellnhofer &lt;wellnhofer [...] aevum.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Petr Pajas via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=41353">https://rt.cpan.org/Ticket/Display.html?id=41353</a></span> &gt;
&gt; 
&gt; Why do you change
&gt; 
&gt; REPORT_ERROR&#40;recover ? recover : 1&#41;;
&gt; to
&gt; REPORT_ERROR&#40;1&#41;; ?
&gt; 
&gt; recover can be also 2...
</div>
At this point recover is always 0 because LibXML_get_recover hasn&#39;t been
called yet. If the parser context can&#39;t be created it is an internal
error and the code dies anyway. So it doesn&#39;t make much sense to use the
recover value.

Nick
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;04&nbsp;16:29:01&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hallo Nick, 

thanks for the explanation &#40;for the record: parts of the conversation
went by private mail&#41;.

Revision 807 contains most of the cleanup patch you sent via mail. I&#39;m
attaching your original patch so that it is recorded here as well, but
it is not what I comitted. Most notably, I kept

#if LIBXML_VERSION &gt; 20600
            /* dictionaries not support yet */
            ctxt-&gt;dictNames = 0;
#endif

&#40;don&#39;t know why you removed this; since we only support libxml2-2.6.x, I
would understand removing the #if, though&#41;

and

  if &#40; recover || &#40; well_formed &#38;&#38;
       &#40; !xmlDoValidityCheckingDefaultValue
            || &#40; valid || &#40; real_doc-&gt;intSubset == NULL
                  &#38;&#38; real_doc-&gt;extSubset == NULL &#41;&#41;&#41;&#41;&#41;
   ...

where xmlDoValidityCheckingDefaultValue is now replaced by the value of
ctxt-&gt;validate. Note that there is no need to NULL real_doc in the else
clause &#40;but in case somebody modifies the subsequent code and forgets
about this I decided to NULL it anyway - committed in revision 808&#41;.  

I also dealt with the suppressed warnings in a different manner.

For now I&#39;m closing this ticket, but you are welcome to reopen it in
order to provide feedback.

Thanks for your help,

-- Petr
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: LibXML.xs
===================================================================
--- LibXML.xs	&#40;revision 803&#41;
+++ LibXML.xs	&#40;working copy&#41;
@@ -225,6 +225,9 @@
     const char * CLASS = &#34;XML::LibXML::LibError&#34;;
     SV* libErr;
 
+    /* TODO: warning should be emitted */
+    if &#40; error-&gt;level == XML_ERR_WARNING &#41; return;
+
     libErr = NEWSV&#40;0,0&#41;;
     sv_setref_pv&#40; libErr, CLASS, &#40;void*&#41;error &#41;;
     LibXML_struct_error_callback&#40; saved_error, libErr&#41;;
@@ -861,8 +864,6 @@
     /* calling xmlInitParser&#40;&#41; here is definitly wrong!  */
     /* xmlInitParser&#40;&#41;; */ 
 
-    xmlGetWarningsDefaultValue = 0;
-
     if &#40; self != NULL &#41; {
         /* first fetch the values from the hash */
         real_obj = &#40;HV *&#41;SvRV&#40;self&#41;;
@@ -882,11 +883,9 @@
         item =  hv_fetch&#40; real_obj, &#34;XML_LIBXML_LINENUMBERS&#34;, 22, 0 &#41;;
         if &#40; item != NULL &#38;&#38; SvTRUE&#40;*item&#41; &#41; {
             if &#40;ctxt&#41; ctxt-&gt;linenumbers = 1;
-            else xmlLineNumbersDefault&#40; 1 &#41;;
         }
         else {
             if &#40;ctxt&#41; ctxt-&gt;linenumbers = 0;
-            else xmlLineNumbersDefault&#40; 0 &#41;;
         }
 
         item = hv_fetch&#40;real_obj, &#34;ext_ent_handler&#34;, 15, 0&#41;;
@@ -908,14 +907,6 @@
 
 void
 LibXML_cleanup_parser&#40;&#41; {
-    xmlSubstituteEntitiesDefaultValue = 1;
-    xmlKeepBlanksDefaultValue = 1;
-    xmlGetWarningsDefaultValue = 0;
-    xmlLoadExtDtdDefaultValue = 5;
-    xmlPedanticParserDefaultValue = 0;
-    xmlLineNumbersDefault&#40; 0 &#41;;
-    xmlDoValidityCheckingDefaultValue = 0;
-
     if &#40;LibXML_old_ext_ent_loader != NULL &#41; {
         xmlSetExternalEntityLoader&#40; &#40;xmlExternalEntityLoader&#41;LibXML_old_ext_ent_loader &#41;;
     }
@@ -1404,17 +1395,6 @@
     LIBXML_TEST_VERSION
     xmlInitParser&#40;&#41;;
     PmmSAXInitialize&#40;aTHX&#41;;
-
-    xmlSetGenericErrorFunc&#40; NULL ,
-                           &#40;xmlGenericErrorFunc&#41;LibXML_error_handler_ctx&#41;;
-    xmlDoValidityCheckingDefaultValue = 0;
-    xmlSubstituteEntitiesDefaultValue = 1;
-    xmlGetWarningsDefaultValue = 0;
-    xmlKeepBlanksDefaultValue = 1;
-    xmlLoadExtDtdDefaultValue = 5;
-    xmlPedanticParserDefaultValue = 0;
-    xmlLineNumbersDefault&#40;0&#41;;
-    xmlSetGenericErrorFunc&#40;NULL, NULL&#41;;
 #ifdef LIBXML_CATALOG_ENABLED
     /* xmlCatalogSetDebug&#40;10&#41;; */
     xmlInitializeCatalog&#40;&#41;; /* use catalog data */
@@ -1555,8 +1535,6 @@
         STRLEN len;
         char * ptr;
         HV * real_obj;
-        int well_formed;
-        int valid;
         xmlDocPtr real_doc;
         int recover = 0;
 	PREINIT_SAVED_ERROR
@@ -1579,7 +1557,7 @@
             xmlParserCtxtPtr ctxt = xmlCreateMemoryParserCtxt&#40;&#40;const char*&#41;ptr, len&#41;;
             if &#40;ctxt == NULL&#41; {
 	        CLEANUP_ERROR_HANDLER;
-                REPORT_ERROR&#40;recover ? recover : 1&#41;;
+                REPORT_ERROR&#40;1&#41;;
                 croak&#40;&#34;Could not create memory parser context!\n&#34;&#41;;
             }
             xs_warn&#40; &#34;context created\n&#34;&#41;;
@@ -1603,15 +1581,10 @@
 
             xs_warn&#40; &#34;context initialized\n&#34; &#41;;
 
-            {
-                /* TODO: make this into a macro: */
-                xmlParseDocument&#40;ctxt&#41;;
-                xs_warn&#40; &#34;document parsed \n&#34;&#41;;
-            }
+            xmlParseDocument&#40;ctxt&#41;;
+            xs_warn&#40; &#34;document parsed \n&#34;&#41;;
 
             ctxt-&gt;directory = NULL;
-            well_formed = ctxt-&gt;wellFormed;
-            valid = ctxt-&gt;valid;
             real_doc = ctxt-&gt;myDoc;
             ctxt-&gt;myDoc = NULL;
             xmlFreeParserCtxt&#40;ctxt&#41;;
@@ -1628,15 +1601,8 @@
             } else {
                 real_doc-&gt;URL = xmlStrdup&#40;&#40;const xmlChar*&#41;directory&#41;;
             }
-            if &#40; ! LibXML_will_die_ctx&#40;saved_error, recover&#41; &#38;&#38;
-		 &#40;recover || &#40; well_formed &#38;&#38;
-                              &#40; !xmlDoValidityCheckingDefaultValue
-                                || &#40; valid || &#40; real_doc-&gt;intSubset == NULL
-                                                &#38;&#38; real_doc-&gt;extSubset == NULL &#41;&#41;&#41;&#41;&#41;&#41; {
-                RETVAL = LibXML_NodeToSv&#40; real_obj, INT2PTR&#40;xmlNodePtr,real_doc&#41; &#41;;
-            } else {
-                xmlFreeDoc&#40;real_doc&#41;;
-            }
+
+            RETVAL = LibXML_NodeToSv&#40; real_obj, INT2PTR&#40;xmlNodePtr,real_doc&#41; &#41;;
         }
 
         LibXML_cleanup_parser&#40;&#41;;
@@ -1702,8 +1668,6 @@
         STRLEN len;
         char * directory = NULL;
         HV * real_obj;
-        int well_formed;
-        int valid;
         xmlDocPtr real_doc;
         int recover = 0;
         PREINIT_SAVED_ERROR
@@ -1732,16 +1696,12 @@
             ctxt = xmlCreatePushParserCtxt&#40;NULL, NULL, buffer, read_length, NULL&#41;;
             if &#40;ctxt == NULL&#41; {
                 CLEANUP_ERROR_HANDLER;
-                REPORT_ERROR&#40;recover ? recover : 1&#41;;
+                REPORT_ERROR&#40;1&#41;;
                 croak&#40;&#34;Could not create xml push parser context!\n&#34;&#41;;
             }
             xs_warn&#40; &#34;context created\n&#34;&#41;;
             real_obj = LibXML_init_parser&#40;self, ctxt&#41;;
             recover = LibXML_get_recover&#40;real_obj&#41;;
-#if LIBXML_VERSION &gt; 20600
-	    /* dictionaries not support yet */
-	    ctxt-&gt;dictNames = 0;
-#endif
             if &#40; directory != NULL &#41; {
                 ctxt-&gt;directory = directory;
             }
@@ -1760,8 +1720,6 @@
             }
 
             ctxt-&gt;directory = NULL;
-            well_formed = ctxt-&gt;wellFormed;
-            valid = ctxt-&gt;valid;
             real_doc = ctxt-&gt;myDoc;
             ctxt-&gt;myDoc = NULL;
             xmlFreeParserCtxt&#40;ctxt&#41;;
@@ -1776,14 +1734,7 @@
                 real_doc-&gt;URL = xmlStrdup&#40;&#40;const xmlChar*&#41;directory&#41;;
             }
 
-            if &#40; recover || &#40; well_formed &#38;&#38;
-                              &#40; !xmlDoValidityCheckingDefaultValue
-                                || &#40; valid || &#40; real_doc-&gt;intSubset == NULL
-                                                &#38;&#38; real_doc-&gt;extSubset == NULL &#41;&#41;&#41;&#41;&#41; {
-                RETVAL = LibXML_NodeToSv&#40; real_obj, INT2PTR&#40;xmlNodePtr,real_doc&#41; &#41;;
-            } else {
-                xmlFreeDoc&#40;real_doc&#41;;
-            }
+            RETVAL = LibXML_NodeToSv&#40; real_obj, INT2PTR&#40;xmlNodePtr,real_doc&#41; &#41;;
         }
 
         LibXML_cleanup_parser&#40;&#41;;
@@ -1872,8 +1823,6 @@
         STRLEN len;
         char * filename;
         HV * real_obj;
-        int well_formed;
-        int valid;
         xmlDocPtr real_doc;
         int recover = 0;
         PREINIT_SAVED_ERROR
@@ -1891,7 +1840,7 @@
             xmlParserCtxtPtr ctxt = xmlCreateFileParserCtxt&#40;filename&#41;;
             if &#40;ctxt == NULL&#41; {
                 CLEANUP_ERROR_HANDLER;
-                REPORT_ERROR&#40;recover ? recover : 1&#41;;
+                REPORT_ERROR&#40;1&#41;;
                 croak&#40;&#34;Could not create file parser context for file \&#34;%s\&#34;: %s\n&#34;,
                       filename, strerror&#40;errno&#41;&#41;;
             }
@@ -1902,28 +1851,17 @@
             ctxt-&gt;_private = &#40;void*&#41;self;
 
             xs_warn&#40; &#34;context initialized\n&#34; &#41;;
-            {
-                xmlParseDocument&#40;ctxt&#41;;
-                xs_warn&#40; &#34;document parsed \n&#34;&#41;;
-            }
 
-            well_formed = ctxt-&gt;wellFormed;
-            valid = ctxt-&gt;valid;
+            xmlParseDocument&#40;ctxt&#41;;
+            xs_warn&#40; &#34;document parsed \n&#34;&#41;;
+
             real_doc = ctxt-&gt;myDoc;
             ctxt-&gt;myDoc = NULL;
             xmlFreeParserCtxt&#40;ctxt&#41;;
         }
 
         if &#40; real_doc != NULL &#41; {
-
-            if &#40; recover || &#40; well_formed &#38;&#38;
-                              &#40; !xmlDoValidityCheckingDefaultValue
-                                || &#40; valid || &#40; real_doc-&gt;intSubset == NULL
-                                                &#38;&#38; real_doc-&gt;extSubset == NULL &#41;&#41;&#41;&#41;&#41; {
-                RETVAL = LibXML_NodeToSv&#40; real_obj, INT2PTR&#40;xmlNodePtr,real_doc&#41; &#41;;
-            } else {
-                xmlFreeDoc&#40;real_doc&#41;;
-            }
+            RETVAL = LibXML_NodeToSv&#40; real_obj, INT2PTR&#40;xmlNodePtr,real_doc&#41; &#41;;
         }
 
         LibXML_cleanup_parser&#40;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;04&nbsp;16:29:04&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;05&nbsp;15:56:29&nbsp;2009</span>
    <span class="description">wellnhofer [...] aevum.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #41353] XML_LIBXML_KEEP_BLANKS option not documented</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 05 Oct 2009 21:53:52 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-LibXML [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Nick Wellnhofer &lt;wellnhofer [...] aevum.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Petr Pajas via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Revision 807 contains most of the cleanup patch you sent via mail. I&#39;m
&gt; attaching your original patch so that it is recorded here as well, but
&gt; it is not what I comitted. Most notably, I kept
&gt; 
&gt; #if LIBXML_VERSION &gt; 20600
&gt;           /* dictionaries not support yet */
&gt;           ctxt-&gt;dictNames = 0;
&gt; #endif
</div>
The parser options always include XML_PARSE_NODICT now, so this isn&#39;t
necessary.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#40;don&#39;t know why you removed this; since we only support libxml2-2.6.x, I
&gt; would understand removing the #if, though&#41;
&gt; 
&gt; and
&gt; 
&gt;   if &#40; recover || &#40; well_formed &#38;&#38;
&gt;        &#40; !xmlDoValidityCheckingDefaultValue
&gt;             || &#40; valid || &#40; real_doc-&gt;intSubset == NULL
&gt;                   &#38;&#38; real_doc-&gt;extSubset == NULL &#41;&#41;&#41;&#41;&#41;
&gt;    ...
&gt; 
&gt; where xmlDoValidityCheckingDefaultValue is now replaced by the value of
&gt; ctxt-&gt;validate.
</div>
I think the whole if/else is unnecessary because libxml does all that
checking. The condition should always be true if we get a non-null
real_doc. If recover is false we should always get a well formed
document. If validity checking is enabled the document should always be
valid. Otherwise real_doc returned from libxml is NULL. But I&#39;m not 100%
sure about this.

When I remove the check the test cases still work. But I don&#39;t know if
there are good test cases for not well formed and invalid documents.

Also note that there is an additional check for LibXML_will_die_ctx in
_parse_string which is missing from _parse_file and _parse_fh. At least,
these three functions should be consistent.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Note that there is no need to NULL real_doc in the else
&gt; clause
</div>
Yes, I was wrong about that. There&#39;s no need to null real_doc.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#40;but in case somebody modifies the subsequent code and forgets
&gt; about this I decided to NULL it anyway - committed in revision 808&#41;.  
&gt; 
&gt; I also dealt with the suppressed warnings in a different manner.
</div>
Looks good. Personally, I would set $XML::LibXML::Error::WARNINGS to 1
by default although this wouldn&#39;t match the old behavior.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; For now I&#39;m closing this ticket, but you are welcome to reopen it in
&gt; order to provide feedback.
</div>
The original bug is definitely resolved. There&#39;s also a related fix in
libxml 2.7.4.

Nick


-- 
aevum gmbh
rumfordstr. 4
80469 münchen
germany

tel: +49 89 3838 0653
<span class="clickylink"><a target="new" rel="nofollow" href="http://aevum.de/">http://aevum.de/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;05&nbsp;15:56:30&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;07&nbsp;08:37:03&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the explanations, Nick. You are probably right in all points
but since this may require adding more tests and checking againts all
the supported libxml2 versions I decided to keep the code there for the
1.70 release, but will probably remove it in some future version. As you
suggested, I made the error handling code consistent among all _parse_*
functions. 

-- Petr

Dne po 05.říj.2009 15:56:29, wellnhofer@aevum.de napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Petr Pajas via RT wrote:
<div class="message-stanza open">&gt; &gt; Revision 807 contains most of the cleanup patch you sent via mail. I&#39;m
&gt; &gt; attaching your original patch so that it is recorded here as well, but
&gt; &gt; it is not what I comitted. Most notably, I kept
&gt; &gt; 
&gt; &gt; #if LIBXML_VERSION &gt; 20600
&gt; &gt;         /* dictionaries not support yet */
&gt; &gt;         ctxt-&gt;dictNames = 0;
&gt; &gt; #endif
</div>&gt; 
&gt; The parser options always include XML_PARSE_NODICT now, so this isn&#39;t
&gt; necessary.
&gt; 
<div class="message-stanza open">&gt; &gt; &#40;don&#39;t know why you removed this; since we only support libxml2-2.6.x, I
&gt; &gt; would understand removing the #if, though&#41;
&gt; &gt; 
&gt; &gt; and
&gt; &gt; 
&gt; &gt;   if &#40; recover || &#40; well_formed &#38;&#38;
&gt; &gt;        &#40; !xmlDoValidityCheckingDefaultValue
&gt; &gt;             || &#40; valid || &#40; real_doc-&gt;intSubset == NULL
&gt; &gt;                   &#38;&#38; real_doc-&gt;extSubset == NULL &#41;&#41;&#41;&#41;&#41;
&gt; &gt;    ...
&gt; &gt; 
&gt; &gt; where xmlDoValidityCheckingDefaultValue is now replaced by the value of
&gt; &gt; ctxt-&gt;validate.
</div>&gt; 
&gt; I think the whole if/else is unnecessary because libxml does all that
&gt; checking. The condition should always be true if we get a non-null
&gt; real_doc. If recover is false we should always get a well formed
&gt; document. If validity checking is enabled the document should always be
&gt; valid. Otherwise real_doc returned from libxml is NULL. But I&#39;m not 100%
&gt; sure about this.
&gt; 
&gt; When I remove the check the test cases still work. But I don&#39;t know if
&gt; there are good test cases for not well formed and invalid documents.
&gt; 
&gt; Also note that there is an additional check for LibXML_will_die_ctx in
&gt; _parse_string which is missing from _parse_file and _parse_fh. At least,
&gt; these three functions should be consistent.
&gt; 
<div class="message-stanza open">&gt; &gt; Note that there is no need to NULL real_doc in the else
&gt; &gt; clause
</div>&gt; 
&gt; Yes, I was wrong about that. There&#39;s no need to null real_doc.
&gt; 
<div class="message-stanza open">&gt; &gt; &#40;but in case somebody modifies the subsequent code and forgets
&gt; &gt; about this I decided to NULL it anyway - committed in revision 808&#41;.  
&gt; &gt; 
&gt; &gt; I also dealt with the suppressed warnings in a different manner.
</div>&gt; 
&gt; Looks good. Personally, I would set $XML::LibXML::Error::WARNINGS to 1
&gt; by default although this wouldn&#39;t match the old behavior.
&gt; 
<div class="message-stanza open">&gt; &gt; For now I&#39;m closing this ticket, but you are welcome to reopen it in
&gt; &gt; order to provide feedback.
</div>&gt; 
&gt; The original bug is definitely resolved. There&#39;s also a related fix in
&gt; libxml 2.7.4.
&gt; 
&gt; Nick
&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;07&nbsp;08:37:05&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
