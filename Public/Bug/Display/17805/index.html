<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #17805 for Class-DBI: Object not stored in objct index when created if PK comes from a sequence.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #17805 for Class-DBI: Object not stored in objct index when created if PK comes from a sequence.</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Class-DBI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Class-DBI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Class-DBI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Class-DBI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Class-DBI">Class-DBI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">17805</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Class-DBI/Active/">Class-DBI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
evdb [...] ecclestoad.co.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-6690-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
v3.0.9    </td>
  </tr>
  <tr id="CF-6691-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;22&nbsp;10:36:30&nbsp;2006</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Object not stored in objct index when created if PK comes from a
 sequence.</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is from a mail I sent to the CDBI mailing list yesterday.

Hello,

a while back I posted a test script &#40;attached&#41; that showed up a bug in
the object index that means that a new row whose PK comes from a
sequence is not added to the index correctly, although this may only
affect users of postgres. In the thread that followed a solution came
to light that fixes this problem in 3.0.12:

      # Line 578 or so of Class/DBI.pm 3.0.14

      # now that we have a complete primary key, add this to the
      # object index
      if &#40; $Weaken_Is_Available &#41; {
        $self = $class-&gt;_init&#40; $self &#41;;
      }


Could this fix be added to the next release. Currently it very
difficult to work with CDBI and new objects, especially in tests where
you create one, change it and then find that it does not work.

The previous discussion is archived here:
<span class="clickylink"><a target="new" rel="nofollow" href="http://lists.digitalcraftsmen.net/pipermail/classdbi/2005-November/000514.html">http://lists.digitalcraftsmen.net/pipermail/classdbi/2005-November/000514.html</a></span>

Cheers,
 Edmund.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> class-dbi-sequence-object-index-bug.t</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"># This is a test to show unexpected behaviour with relation to &#39;only
# one object in memory&#39;. If a row is added to the database and the
# value of it&#39;s primary key comes from a sequence then it is not
# fetched properly from the object cache. The same behaviour is not
# shown if a value is explicitly given for the primary key. I think
# this is the problem anyway...

# The tests below assume that there is a postgres database &#39;cdbi_test&#39;
# - SQLite does not have sequences and so I don&#39;t think that these
# tests can be run against it.

# Please let me know if there is anything else that I can do to help
# you withthis bug &#40; at least I think it is a bug &#41;.

# Edmund von der Burg
# evdb@ecclestoad.co.uk
# <span class="clickylink"><a target="new" rel="nofollow" href="http://ecclestoad.co.uk">http://ecclestoad.co.uk</a></span>

# see:
# <span class="clickylink"><a target="new" rel="nofollow" href="http://lists.digitalcraftsmen.net/pipermail/classdbi/2005-November/000514.html">http://lists.digitalcraftsmen.net/pipermail/classdbi/2005-November/000514.html</a></span>
# for more details.

use strict;
use warnings;
use Data::Dumper;
use Test::More &#39;no_plan&#39;;

############################################################################

package CDBI;

use base &#39;Class::DBI&#39;;
CDBI-&gt;connection&#40;&#34;dbi:Pg:dbname=cdbi_test&#34;&#41;;
CDBI-&gt;sequence&#40;&#39;cdbi_id_seq&#39;&#41;;

############################################################################

package Parent;
use base &#39;CDBI&#39;;

use Data::Dumper;

Parent-&gt;table&#40;&#39;parents&#39;&#41;;

Parent-&gt;columns&#40; Primary =&gt; qw&#40;cdbi_id&#41; &#41;;
Parent-&gt;columns&#40; Others  =&gt; qw&#40;name&#41; &#41;;

Parent-&gt;has_many&#40; children =&gt; &#39;Child&#39; &#41;;

sub create_sql { &#39;&#39; }

############################################################################

package Child;
use base &#39;CDBI&#39;;

Child-&gt;table&#40;&#39;children&#39;&#41;;

Child-&gt;columns&#40; Primary =&gt; qw/cdbi_id/ &#41;;
Child-&gt;columns&#40; Others  =&gt; qw/parent/ &#41;;

Child-&gt;has_a&#40; parent =&gt; &#39;Parent&#39; &#41;;

sub create_sql { &#39;&#39; }

############################################################################

package main;

diag &#34;\$Class::DBI::VERSION: &#39;&#34; . $Class::DBI::VERSION . &#34;&#39;&#34;;

create_tables&#40;&#41;;

for my $cdbi_id &#40; 1_000_000, undef &#41; {

    diag &#34;&#34;;
    diag &#34;using cdbi_id: &#34;, defined $cdbi_id ? $cdbi_id : &#39;undef&#39;;
    diag &#34;&#34;;

    # create a test parent.
    my $parent =
      Parent-&gt;create&#40; { cdbi_id =&gt; $cdbi_id, name =&gt; &#39;test parent&#39; } &#41;;
    ok $parent, &#39;create test parent&#39;;

    # create a test child.
    my $child = Child-&gt;create&#40; { parent =&gt; $parent, } &#41;;
    ok $child, &#39;create test child&#39;;

    # do a test to see if an update to the parent is reflected in the
    # child&#39;s parent.
    is $parent-&gt;name, $child-&gt;parent-&gt;name, &#34;names the same&#34;;
    ok $parent-&gt;name&#40;&#39;new name&#39;&#41;, &#34;change name&#34;;
    is $parent-&gt;name, $child-&gt;parent-&gt;name, &#34;names the same&#34;;
    ok $parent-&gt;update,     &#34;update&#34;;
    is $parent-&gt;name,       $child-&gt;parent-&gt;name, &#34;names the same&#34;;
    ok $parent-&gt;dbi_commit, &#34;dbi_commit&#34;;

    is&#40; $parent-&gt;name, $child-&gt;parent-&gt;name, &#34;names the same&#34; &#41;
      || diag Dumper {
        &#39;$parent&#39;        =&gt; $parent,
        &#39;$child-&gt;parent&#39; =&gt; $child-&gt;parent
      };

    # Cleanup.
    $parent-&gt;delete;
    Parent-&gt;dbi_commit;
}

delete_tables&#40;&#41;;
CDBI-&gt;dbi_commit;

############################################################################

sub create_tables {
    my $dbh = CDBI-&gt;db_Main;

    $SIG{__WARN__} = sub { warn @_ unless $_[0] =~ m/^NOTICE/ };

    # diag &#34;Creating tables and sequence&#34;;

    $dbh-&gt;do&#40; &lt;&lt;&#34;&#34; &#41;;
create sequence cdbi_id_seq

    $dbh-&gt;do&#40; &lt;&lt;&#34;&#34; &#41;;
create table parents &#40;
  cdbi_id   int8 primary key,
  name      text not null
&#41;

    $dbh-&gt;do&#40; &lt;&lt;&#34;&#34; &#41;;
create table children &#40;
  cdbi_id   int8 primary key,
  parent    int8 not null references parents
&#41;

}

sub delete_tables {
    my $dbh = CDBI-&gt;db_Main;

    # diag &#34;Destroying tables and sequence&#34;;
    $dbh-&gt;do&#40;&#34;drop table $_&#34;&#41; for qw&#40; children parents &#41;;
    $dbh-&gt;do&#40;&#34;drop sequence cdbi_id_seq&#34;&#41;;

}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;22&nbsp;10:59:32&nbsp;2006</span>
    <span class="description">tony [...] tmtm.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17805] Object not stored in objct index when created if PK comes from a sequence.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 22 Feb 2006 15:58:39 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Guest via RT &lt;bug-Class-DBI [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tony Bowden &lt;tony [...] tmtm.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Feb 22, 2006 at 10:36:30AM -0500, Guest via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Could this fix be added to the next release. 
</div>
Do you have a failing test case?

If you do, I can put out a fix pretty quickly. If not you&#39;ll have to
wait until I get a chance to make one up.

Thanks,

Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;22&nbsp;10:59:33&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;22&nbsp;11:28:06&nbsp;2006</span>
    <span class="description">evdb [...] ecclestoad.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17805] Object not stored in objct index when created if PK comes from a sequence.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 22 Feb 2006 16:27:13 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Class-DBI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Edmund von der Burg&#34; &lt;edmund.vonderburg [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The test script that I sent along fails on my system when the PK comes
from the sequence. I am running 3.0.14 with Postgres 8.1.

I&#39;m not sure how best to create a test script that can be packaged and
released though as it requires a Postgres database to run. Perhaps the
test script I sent along should be tweaked to make it look for an
environment variable &#40;eg &#39;CDBI_TEST_POSTGRES_DSN&#39; &#41;and skip the tests
if it is not found.

As the test script &#40;should&#41; clean up after itself it could be run
against an existing database without prompting the user but that will
probably cause lots of pain.

Cheers,
  Edmund.


On 22/02/06, tony@tmtm.com via RT &lt;bug-Class-DBI@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Do you have a failing test case?
&gt;
&gt; If you do, I can put out a fix pretty quickly. If not you&#39;ll have to
&gt; wait until I get a chance to make one up.
</div>
--
In reality I&#39;m evdb@ecclestoad.co.uk - <span class="clickylink"><a target="new" rel="nofollow" href="http://ecclestoad.co.uk">http://ecclestoad.co.uk</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;22&nbsp;12:32:24&nbsp;2006</span>
    <span class="description">tony [...] tmtm.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17805] Object not stored in objct index when created if PK comes from a sequence.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 22 Feb 2006 17:31:30 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;evdb [...] ecclestoad.co.uk via RT&#34; &lt;bug-Class-DBI [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tony Bowden &lt;tony [...] tmtm.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Feb 22, 2006 at 11:28:07AM -0500, evdb@ecclestoad.co.uk via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m not sure how best to create a test script that can be packaged and
&gt; released though as it requires a Postgres database to run. Perhaps the
&gt; test script I sent along should be tweaked to make it look for an
&gt; environment variable &#40;eg &#39;CDBI_TEST_POSTGRES_DSN&#39; &#41;and skip the tests
&gt; if it is not found.
</div>

Sorry - I missed the attachment as RT.cpan doesn&#39;t forward those on.

There&#39;s already a Pg test in the CDBI distribution. Perhaps you could
add this into that?

Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;23&nbsp;04:16:55&nbsp;2006</span>
    <span class="description">evdb [...] ecclestoad.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17805] Object not stored in objct index when created if PK comes from a sequence.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 23 Feb 2006 09:16:05 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Class-DBI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Edmund von der Burg&#34; &lt;edmund.vonderburg [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I did not realize that there was a Pg test script. I&#39;ll take the tests
that I have and see if I can add them to that.

Cheers,
  Edmund.


On 22/02/06, tony@tmtm.com via RT &lt;bug-Class-DBI@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed, Feb 22, 2006 at 11:28:07AM -0500, evdb@ecclestoad.co.uk via RT wrote:
<div class="message-stanza open">&gt; &gt; I&#39;m not sure how best to create a test script that can be packaged and
&gt; &gt; released though as it requires a Postgres database to run. Perhaps the
&gt; &gt; test script I sent along should be tweaked to make it look for an
&gt; &gt; environment variable &#40;eg &#39;CDBI_TEST_POSTGRES_DSN&#39; &#41;and skip the tests
&gt; &gt; if it is not found.
</div>&gt;
&gt;
&gt; Sorry - I missed the attachment as RT.cpan doesn&#39;t forward those on.
&gt;
&gt; There&#39;s already a Pg test in the CDBI distribution. Perhaps you could
&gt; add this into that?
&gt;
&gt; Tony
&gt;
&gt;
&gt;
</div>

--
In reality I&#39;m evdb@ecclestoad.co.uk - <span class="clickylink"><a target="new" rel="nofollow" href="http://ecclestoad.co.uk">http://ecclestoad.co.uk</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;23&nbsp;11:56:42&nbsp;2006</span>
    <span class="description">evdb [...] ecclestoad.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17805] Object not stored in objct index when created if PK comes from a sequence.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 23 Feb 2006 16:55:44 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Class-DBI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Edmund von der Burg&#34; &lt;edmund.vonderburg [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &gt; There&#39;s already a Pg test in the CDBI distribution. Perhaps you could
&gt; &gt; add this into that?
</div>
I&#39;ve created a new test file &#39;27-pg_sequences.t&#39; but it is based on
the &#39;PgBase&#39; that you use in Binary.pm so it should behave : &#41;

Class::DBI fails the test, but passes after the code suggested in the
test is added.

Thanks for looking at this so quickly, anything else I can do give me a shout.

Cheers,
  Edmund.


--
In reality I&#39;m evdb@ecclestoad.co.uk - <span class="clickylink"><a target="new" rel="nofollow" href="http://ecclestoad.co.uk">http://ecclestoad.co.uk</a></span>
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;03&nbsp;03:49:20&nbsp;2006</span>
    <span class="description">tony [...] kasei.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17805] Object not stored in objct index when created if PK comes from a sequence.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 3 Mar 2006 08:49:07 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;evdb [...] ecclestoad.co.uk via RT&#34; &lt;bug-Class-DBI [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tony Bowden &lt;tony [...] kasei.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Feb 23, 2006 at 11:56:44AM -0500, evdb@ecclestoad.co.uk via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for looking at this so quickly, anything else I can do give me a shout.
</div>
Just as an update- I haven&#39;t forgotten about this. I&#39;m hoping to use the
opportunity to tidy up the entire object index code and move it out into
another class which can be switched out for an alternative / subclassed
etc.

This means it will take slightly longer, but I will try to ensure that
there is a fix in the new release, even if I just have to fall back on
yours for the time being.

Thanks,

Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;03&nbsp;04:21:55&nbsp;2006</span>
    <span class="description">evdb [...] ecclestoad.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17805] Object not stored in objct index when created if PK comes from a sequence.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 3 Mar 2006 09:21:36 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Class-DBI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Edmund von der Burg&#34; &lt;edmund.vonderburg [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">No problems - I have a hack in place on my local system. Refactoring
the object index sounds like a good idea. I was thinking a while back
that it might be interesting to put the index into something like MMap
so that it is accessible from several processes, although I decided
that that was probably a dangerous thing to consider : &#41;

Whilst you&#39;re hitting the code one thing that would be really useful
&#40;for me at least&#41; would be able to do something like this:

my $film = Film-&gt;insert&#40;{...}&#41;;

# Update film over web interface
...

# check that the film has been updated.
$film-&gt;refresh;
is $film-&gt;title, &#39;Jaws 19&#39;, &#39;...&#39;;


Quite often I change the values in the database using some other
process &#40;eg updating over web&#41; and then want to refresh the values in
my local object. At the moment I tend to use:

$film = $film-&gt;retrieve&#40; $film-&gt;id &#41;;

which is clunky. Something like $film-&gt;refresh would be very useful.


I really appreciate that you are maintaining CDBI.

Cheers,
  Edmund.


On 03/03/06, Tony Bowden via RT &lt;bug-Class-DBI@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu, Feb 23, 2006 at 11:56:44AM -0500, evdb@ecclestoad.co.uk via RT wrote:
<div class="message-stanza open">&gt; &gt; Thanks for looking at this so quickly, anything else I can do give me a shout.
</div>&gt;
&gt; Just as an update- I haven&#39;t forgotten about this. I&#39;m hoping to use the
&gt; opportunity to tidy up the entire object index code and move it out into
&gt; another class which can be switched out for an alternative / subclassed
&gt; etc.
&gt;
&gt; This means it will take slightly longer, but I will try to ensure that
&gt; there is a fix in the new release, even if I just have to fall back on
&gt; yours for the time being.
&gt;
&gt; Thanks,
&gt;
&gt; Tony
&gt;
&gt;
</div>

--
In reality I&#39;m evdb@ecclestoad.co.uk - <span class="clickylink"><a target="new" rel="nofollow" href="http://ecclestoad.co.uk">http://ecclestoad.co.uk</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;13&nbsp;17:50:14&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Ryan Gerry&#34; &lt;gerryster [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I also independently discovered this issue with the object index and
creation without a primary key.  I am using MySQL with a table that has
an auto incrementing column.  I was about to submit the bug when I found
that the issue had already been submitted!

I agree that separating out the object indexing code into another class
would be a good idea.  I also wanted to let you know that this object
indexing idea has been documented as a design pattern in Martin Fowler&#39;s
 book &#34;Patterns of Enterprise Application Architecture&#34;.  Fowler calls
this an &#34;Identity Map&#34;.  Here is a link to the synopsis of this pattern,
but the full text is available in the book:
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.martinfowler.com/eaaCatalog/identityMap.html">http://www.martinfowler.com/eaaCatalog/identityMap.html</a></span>
I hope this link can provide you with inspiration as you proceed with
the refactoring.  The challenges with this pattern include concurrency
issues.  However, if the identity map only concerns itself with the
uniqueness of object in memory of the current process or thread then
these issues should be mitigated.

From my experience, Ruby On Rail&#39;s ActiveRecord is missing this feature.


On Fri Mar 03 03:49:20 2006, tony@kasei.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu, Feb 23, 2006 at 11:56:44AM -0500, evdb@ecclestoad.co.uk via RT
&gt; wrote:
<div class="message-stanza open">&gt; &gt; Thanks for looking at this so quickly, anything else I can do give
</div>&gt; me a shout.
&gt; 
&gt; Just as an update- I haven&#39;t forgotten about this. I&#39;m hoping to use
&gt; the
&gt; opportunity to tidy up the entire object index code and move it out
&gt; into
&gt; another class which can be switched out for an alternative /
&gt; subclassed
&gt; etc.
&gt; 
&gt; This means it will take slightly longer, but I will try to ensure that
&gt; there is a fix in the new release, even if I just have to fall back on
&gt; yours for the time being.
&gt; 
&gt; Thanks,
&gt; 
&gt; Tony
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;14&nbsp;01:45:51&nbsp;2006</span>
    <span class="description">tony [...] kasei.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17805] Object not stored in objct index when created if PK comes from a sequence.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 14 Mar 2006 06:45:30 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Guest via RT &lt;bug-Class-DBI [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tony Bowden &lt;tony [...] kasei.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, Mar 13, 2006 at 05:50:16PM -0500, Guest via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I also independently discovered this issue with the object index and
&gt; creation without a primary key.  I am using MySQL with a table that has
&gt; an auto incrementing column.  I was about to submit the bug when I found
&gt; that the issue had already been submitted!
</div>
A test case for that would be useful if you could put one together.
However, this one surprises me as I believed the code coped with that.
Is this still present in the latest CPAN release?

Thanks,

Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;14&nbsp;11:48:00&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Object not stored in object index when created if PK comes from a
 sequence.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Ryan Gerry&#34; &lt;gerryster [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; A test case for that would be useful if you could put one together.
&gt; However, this one surprises me as I believed the code coped with that.
&gt; Is this still present in the latest CPAN release?
&gt;
</div>Attached is a test case which demonstrates the issue for MySQL.  MySQL
differs from Postgres in that it uses auto_increment columsn instead of
sequences, but the basic idea is that same.  The meat of the script is
in the line:
  is&#40;refaddr&#40;$obj1&#41;, refaddr&#40;$obj2&#41;, &#39;objects 1 and 2 are equivalent&#39;&#41;;

However, I provided an update case to exemplify the problem.  I tested
with Class-DBI-v3.0.14 &#40;latest CPAN release&#41;.


Here are my test results:

perl ./class-dbi-sequence-object-index-bug-mysql.t
1..18
ok 1 - correct name
ok 2 - correct value
ok 3 - objects 1 and 2 are equivilent
ok 4 - same field: id = 1
ok 5 - same field: name = foo
ok 6 - same field: value = bar
ok 7 - same field: id = 1
ok 8 - same field: name = foo
ok 9 - same field: value = baz
ok 10 - correct name
ok 11 - correct value
not ok 12 - objects 1 and 2 are equivilant
#   Failed test &#39;objects 1 and 2 are equivilant&#39;
#   in ./class-dbi-sequence-object-index-bug-mysql.t at line 68.
#          got: &#39;9292480&#39;
#     expected: &#39;9293092&#39;
ok 13 - same field: id = 2
ok 14 - same field: name = foo
ok 15 - same field: value = bar
ok 16 - same field: id = 2
ok 17 - same field: name = foo
not ok 18 - same field: value = bar
#   Failed test &#39;same field: value = bar&#39;
#   in ./class-dbi-sequence-object-index-bug-mysql.t at line 85.
#          got: &#39;baz&#39;
#     expected: &#39;bar&#39;
# Looks like you failed 2 tests of 18.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"># Test case for <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Bug/Display.html?id=17805">http://rt.cpan.org/Public/Bug/Display.html?id=17805</a></span> and MySQL.
# Tested with MySQL 4.1.14-max-log.  However, the MySQL version should not be
# very important since no advanced functionality is used.
#
# Connection information should be supplied using the DBI_DSN, DBI_USER, and
# DBI_PASS environment variables.
#
# The basic problem is that insert could add the object to the object cache
# when the object&#39;s table contains an auto incrementing primary key.  This is
# because this information is avialable when the row is inserted.

use warnings;
use strict;
use Test::More tests =&gt; 18;
use Class::DBI;
use Scalar::Util qw&#40;refaddr&#41;; # used to find the memory location of CDBI objects

my $TABLE = &#39;test_CDBI&#39;;

#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::.
package CDBI;

use base &#39;Class::DBI&#39;;

__PACKAGE__-&gt;table&#40;$TABLE&#41;;
__PACKAGE__-&gt;columns&#40;Primary =&gt; qw/id/&#41;;
__PACKAGE__-&gt;columns&#40;Essential =&gt; qw/name value/&#41;;
# use environment variables $DBI_DSN, $DBI_USER, and $DBI_PASS if avialable
__PACKAGE__-&gt;connection&#40;$ENV{DBI_DSN}  || &#39;DBI:mysql:database=test&#39;,
                        $ENV{DBI_USER} || &#39;root&#39;,
                        $ENV{DBI_PASS}&#41;;

package main;

#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::.
sub startup {
  # create a table for the test class
  my $dbh = CDBI-&gt;db_Main;
  $dbh-&gt;do&#40; &lt;&lt;&#34;&#34; &#41;;
CREATE TEMPORARY TABLE $TABLE &#40;
  id int&#40;11&#41; NOT NULL auto_increment PRIMARY KEY,
  name varchar&#40;50&#41;,
  value varchar&#40;50&#41;
&#41;

}

startup&#40;&#41;;

# NOTE: unless the unique key is passed to create &#40;id =&gt; 1 in this case&#41;,
# the identity map will not work and retrieving this object will result in
# this object being loaded into memory twice
#
# The first value of $attr represents the passing case, the second is the
# failing case.
foreach my $attr &#40;{ id =&gt; 1, name =&gt; &#39;foo&#39;, value =&gt; &#39;bar&#39;},
                            { name =&gt; &#39;foo&#39;, value =&gt; &#39;bar&#39;} &#41; {
  my $obj1 = CDBI-&gt;insert&#40;$attr&#41;;
  is&#40;$obj1-&gt;name, &#39;foo&#39;, &#39;correct name&#39;&#41;;
  is&#40;$obj1-&gt;value, &#39;bar&#39;, &#39;correct value&#39;&#41;;

  # retreive the object - expect a reference to $obj1 to be returned
  my $obj2 = CDBI-&gt;retrieve&#40; $obj1-&gt;id &#41;;

  # the two objects should be equivilant in memory
  # refaddr is helpful for getting the memory address since simply Class::DBI
  # overloads every operation.
  is&#40;refaddr&#40;$obj1&#41;, refaddr&#40;$obj2&#41;, &#39;objects 1 and 2 are equivalent&#39;&#41;;

  # test all of the common fields:
  check_fields&#40;$obj1, $obj2, qw/id name value/&#41;;

  # If the two objects are equal in memroy, updating one should update both.
  # This is not the case when the unique id is not passed to insert
  $obj2-&gt;value&#40;&#39;baz&#39;&#41;;
  $obj2-&gt;update;
  check_fields&#40;$obj1, $obj2, qw/id name value/&#41;;
}

#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::.
sub check_fields {
  my &#40;$obj1, $obj2, @fields&#41; = @_;

  foreach my $field &#40;@fields&#41; {
    is&#40;$obj2-&gt;$field, $obj1-&gt;$field, &#34;same field: $field = &#34; . $obj1-&gt;$field&#41;;
  }
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;20&nbsp;04:49:56&nbsp;2006</span>
    <span class="description">TMTM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This isn&#39;t as simple as it appeared. It causes spurious warnings with
t/11 and t/22. 22 seems to be related to attributes being set in before
create triggers. I&#39;m not sure what 11 is yet. 

I&#39;ll have another look later, but it means I couldn&#39;t put this in the
latest release.

Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;20&nbsp;06:41:47&nbsp;2006</span>
    <span class="description">evdb [...] ecclestoad.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17805] Object not stored in objct index when created if PK comes from a sequence.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 20 Aug 2006 11:41:34 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Class-DBI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Edmund von der Burg&#34; &lt;evdb [...] ecclestoad.co.uk&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry that it is causing trouble : &#41;

Once i made the changes that I suggested it worked for me - but I
probably didn&#39;t exercise the code as thoroughly as you are. If there
is anything that I can do to help please let me know.

Cheers,
  Edmund

On 20/08/06, via RT &lt;bug-Class-DBI@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=17805">http://rt.cpan.org/Ticket/Display.html?id=17805</a></span> &gt;
&gt;
&gt; This isn&#39;t as simple as it appeared. It causes spurious warnings with
&gt; t/11 and t/22. 22 seems to be related to attributes being set in before
&gt; create triggers. I&#39;m not sure what 11 is yet.
&gt;
&gt; I&#39;ll have another look later, but it means I couldn&#39;t put this in the
&gt; latest release.
&gt;
&gt; Tony
&gt;
&gt;
</div>

-- 
In reality I&#39;m evdb@ecclestoad.co.uk - <span class="clickylink"><a target="new" rel="nofollow" href="http://ecclestoad.co.uk">http://ecclestoad.co.uk</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;20&nbsp;07:14:15&nbsp;2006</span>
    <span class="description">tony [...] kasei.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17805] Object not stored in objct index when created if PK comes from a sequence.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 20 Aug 2006 12:12:36 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;evdb [...] ecclestoad.co.uk via RT&#34; &lt;bug-Class-DBI [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tony Bowden &lt;tony [...] kasei.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun, Aug 20, 2006 at 06:41:48AM -0400, evdb@ecclestoad.co.uk via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sorry that it is causing trouble : &#41;
</div>
Well, the original problem still needs fixed, so I wouldn&#39;t worry too
much! :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Once i made the changes that I suggested it worked for me - but I
&gt; probably didn&#39;t exercise the code as thoroughly as you are. If there
&gt; is anything that I can do to help please let me know.
</div>
Well, if you fancy trying some debugging, just apply the patch and run
the existing test suite and see if you can spot why those two tests are
now issuing warnings. Each are warning that an object is going out of
scope with unsaved changes, so there&#39;s something very fishy going on. I
suspect this is a sign of a deeper problem somewhere that would bite
people hard if we left it in. But I can&#39;t see at a glance what it is,
and I need to leave now.

Otherwise I&#39;ll try to have a deeper look tomorrow.

Thanks,

Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;20&nbsp;11:01:35&nbsp;2008</span>
    <span class="description">roman.daniel [...] gtsnovera.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> roman.daniel [...] gtsnovera.cz</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As far as I can tell, the bug is still present &#40;3.0.17&#41;. It occurs
whenever create is called without primary key set - i.e. primary key is
either autoincrement column or comes from sequence.

I attach simple test reproducing the bug on SQLite database.

I don&#39;t have a deep understanding of CDBI code structure but by looking at: 

sub _insert {
    my &#40;$proto, $data&#41; = @_;
    my $class = ref $proto || $proto;

    my $self = $class-&gt;_init&#40;$data&#41;;
    $self-&gt;call_trigger&#40;&#39;before_create&#39;&#41;;
    $self-&gt;call_trigger&#40;&#39;deflate_for_create&#39;&#41;;

    $self-&gt;_prepopulate_id if $self-&gt;_undefined_primary;
    ...
}

I think that after id is prepopulated, the Live_Objects cache is not
updated - only access to the cache is within _init call. 



On Sun Aug 20 07:14:15 2006, tony@kasei.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun, Aug 20, 2006 at 06:41:48AM -0400, evdb@ecclestoad.co.uk via RT
&gt; wrote:
<div class="message-stanza open">&gt; &gt; Sorry that it is causing trouble : &#41;
</div>&gt; 
&gt; Well, the original problem still needs fixed, so I wouldn&#39;t worry too
&gt; much! :&#41;
&gt; 
<div class="message-stanza open">&gt; &gt; Once i made the changes that I suggested it worked for me - but I
&gt; &gt; probably didn&#39;t exercise the code as thoroughly as you are. If there
&gt; &gt; is anything that I can do to help please let me know.
</div>&gt; 
&gt; Well, if you fancy trying some debugging, just apply the patch and run
&gt; the existing test suite and see if you can spot why those two tests
&gt; are
&gt; now issuing warnings. Each are warning that an object is going out of
&gt; scope with unsaved changes, so there&#39;s something very fishy going on.
&gt; I
&gt; suspect this is a sign of a deeper problem somewhere that would bite
&gt; people hard if we left it in. But I can&#39;t see at a glance what it is,
&gt; and I need to leave now.
&gt; 
&gt; Otherwise I&#39;ll try to have a deeper look tomorrow.
&gt; 
&gt; Thanks,
&gt; 
&gt; Tony
</div></div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use File::Temp;
use DBI;
use Scalar::Util qw&#40;refaddr&#41;;
use Test::More &#39;tests&#39; =&gt; 2;

my $db_fh  = File::Temp-&gt;new;
my $dbfile = $db_fh-&gt;filename;

my $dbh = DBI-&gt;connect&#40; &#34;dbi:SQLite:dbname=$dbfile&#34;, &#39;&#39;, &#39;&#39;,
    { &#39;RaiseError&#39; =&gt; 1 } &#41;;
$dbh-&gt;do&#40;&lt;&lt;&#34;END_CREATE_TABLE&#34;&#41;;
create table simplest &#40;
   id integer primary key autoincrement,
   other_column integer
&#41;;
END_CREATE_TABLE

{

    package Simplest;
    use base qw&#40;Class::DBI&#41;;

    __PACKAGE__-&gt;table&#40;&#39;simplest&#39;&#41;;
    __PACKAGE__-&gt;columns&#40; &#39;Primary&#39;   =&gt; qw&#40;id&#41; &#41;;
    __PACKAGE__-&gt;columns&#40; &#39;Essential&#39; =&gt; qw&#40;other_column&#41; &#41;;

    sub db_Main { return $dbh }
}

my $r_created    = Simplest-&gt;create&#40; { &#39;other_column&#39; =&gt; 208 } &#41;;
my $r_retrieved1 = Simplest-&gt;retrieve&#40; $r_created-&gt;id &#41;;
my $r_retrieved2 = Simplest-&gt;retrieve&#40; $r_created-&gt;id &#41;;

cmp_ok&#40; refaddr&#40;$r_created&#41;, &#39;==&#39;, refaddr&#40;$r_retrieved1&#41;,
    &#39;Retrieve returns created object&#39; &#41;;
cmp_ok&#40; refaddr&#40;$r_retrieved1&#41;, &#39;==&#39;, refaddr&#40;$r_retrieved2&#41;,
    &#39;Retrieved objects are same&#39; &#41;;

# vim: expandtab:shiftwidth=4:tabstop=4:softtabstop=0:textwidth=78:
~
~

</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
