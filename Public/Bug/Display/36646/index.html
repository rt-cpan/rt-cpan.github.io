<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #36646 for Net-MySQL: bug in Net::MySQL and in dbi:mysqlPP</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #36646 for Net-MySQL: bug in Net::MySQL and in dbi:mysqlPP</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-MySQL/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-MySQL/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-MySQL/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-MySQL/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-MySQL">Net-MySQL CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">36646</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-MySQL/Active/">Net-MySQL</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
baptiste.marcel [...] eservglobal.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22906-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22907-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;11&nbsp;09:53:45&nbsp;2008</span>
    <span class="description">baptiste.marcel [...] eservglobal.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> bug in Net::MySQL and in dbi:mysqlPP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 11 Jun 2008 15:53:08 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-mysqlPP [...] rt.cpan.org, bug-Net-MySQL [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Baptiste Marcel &lt;baptiste.marcel [...] eservglobal.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Greetings

I have to report a bug

When the table has an index, a search with a where clause on that column 
hangs.


I use:
Net-MySQL-0.09 &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/%7Eoyama/Net-MySQL-0.09/">http://search.cpan.org/%7Eoyama/Net-MySQL-0.09/</a></span>&gt;

This is perl, v5.10.0 built for sun4-solaris-thread-multi-64


Binary build 1002 [283697] provided by ActiveState 
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.ActiveState.com">http://www.ActiveState.com</a></span>
Built Jan  9 2008 23:49:05

uname -a
SunOS sebastopol 5.10 Generic_120011-14 sun4u sparc SUNW,Ultra-4


Here is a script that reproduces the bug:

#!/bin/perl
use strict ;
use warnings ;
use DBI;
use Net::MySQL;
use Config::INI;
use Config::INI::Reader ;

# this is to retrieve my PWD
my $pwdhash = 
Config::INI::Reader-&gt;read_file&#40;&#39;/export/home/chernaya/scripts/sevcat/.mysql_passwd&#39;&#41;;
my $strDbPasswd=$pwdhash-&gt;{&#39;sevdb2&#39;}-&gt;{passwd};


  my $dbh = DBI-&gt;connect&#40;&#34;dbi:mysqlPP:database=sevdb2;host=localhost&#34;,
                         &#34;chernaya&#34;, &#34;$strDbPasswd&#34;,
                         {&#39;RaiseError&#39; =&gt; 1}&#41;;
                        
  $dbh-&gt;do&#40;&#34;CREATE TABLE demo2 &#40; id INTEGER , value  VARCHAR&#40;20&#41; ,  KEY  
&#40;id&#41;  &#41;&#34;&#41;;
  $dbh-&gt;do&#40;&#34;INSERT INTO demo2 VALUES &#40;?, ?&#41;&#34;, undef, 1, &#34;a&#34;&#41;;      
  $dbh-&gt;do&#40;&#34;INSERT INTO demo2 VALUES &#40;?, ?&#41;&#34;, undef, 2, &#34;b&#34;&#41;;      
  my $sth = $dbh-&gt;prepare&#40;&#34;SELECT id, value FROM demo2 where id=1&#34;&#41;;
 
 
  print &#34;Ready for executed \n&#34;;
  $sth-&gt;execute&#40;&#41;;
    # hangs -&gt; never returns ...
   
  print &#34;executed \n&#34;;
                        
Note that the same without the where clause, or without the index is OK
Note that its buggy whatever the index, being primary or not.
Note that it also fails with DBI::mysqlPP

Best regards

-- 
Baptiste Marcel
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;26&nbsp;17:42:16&nbsp;2008</span>
    <span class="description">cameron.neilson [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> cameron.neilson [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am having the same problem, and have traced it to the bug you
describe. this has essentially rendered this module useless as we often
have reason to search on an index. 

has anyone found a solution?


On Wed Jun 11 09:53:45 2008, baptiste.marcel@eservglobal.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Greetings
&gt; 
&gt; I have to report a bug
&gt; 
&gt; When the table has an index, a search with a where clause on that
&gt; column
&gt; hangs.
&gt; 
&gt; 
&gt; I use:
&gt; Net-MySQL-0.09 &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/%7Eoyama/Net-MySQL-0.09/">http://search.cpan.org/%7Eoyama/Net-MySQL-0.09/</a></span>&gt;
&gt; 
&gt; This is perl, v5.10.0 built for sun4-solaris-thread-multi-64
&gt; 
&gt; 
&gt; Binary build 1002 [283697] provided by ActiveState
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.ActiveState.com">http://www.ActiveState.com</a></span>
&gt; Built Jan  9 2008 23:49:05
&gt; 
&gt; uname -a
&gt; SunOS sebastopol 5.10 Generic_120011-14 sun4u sparc SUNW,Ultra-4
&gt; 
&gt; 
&gt; Here is a script that reproduces the bug:
&gt; 
&gt; #!/bin/perl
&gt; use strict ;
&gt; use warnings ;
&gt; use DBI;
&gt; use Net::MySQL;
&gt; use Config::INI;
&gt; use Config::INI::Reader ;
&gt; 
&gt; # this is to retrieve my PWD
&gt; my $pwdhash =
&gt; Config::INI::Reader-
<div class="message-stanza open">&gt; &gt;read_file&#40;&#39;/export/home/chernaya/scripts/sevcat/.mysql_passwd&#39;&#41;;
</div>&gt; my $strDbPasswd=$pwdhash-&gt;{&#39;sevdb2&#39;}-&gt;{passwd};
&gt; 
&gt; 
&gt;   my $dbh = DBI-&gt;connect&#40;&#34;dbi:mysqlPP:database=sevdb2;host=localhost&#34;,
&gt;                          &#34;chernaya&#34;, &#34;$strDbPasswd&#34;,
&gt;                          {&#39;RaiseError&#39; =&gt; 1}&#41;;
&gt; 
&gt;   $dbh-&gt;do&#40;&#34;CREATE TABLE demo2 &#40; id INTEGER , value  VARCHAR&#40;20&#41; ,
&gt; KEY
&gt; &#40;id&#41;  &#41;&#34;&#41;;
&gt;   $dbh-&gt;do&#40;&#34;INSERT INTO demo2 VALUES &#40;?, ?&#41;&#34;, undef, 1, &#34;a&#34;&#41;;
&gt;   $dbh-&gt;do&#40;&#34;INSERT INTO demo2 VALUES &#40;?, ?&#41;&#34;, undef, 2, &#34;b&#34;&#41;;
&gt;   my $sth = $dbh-&gt;prepare&#40;&#34;SELECT id, value FROM demo2 where id=1&#34;&#41;;
&gt; 
&gt; 
&gt;   print &#34;Ready for executed \n&#34;;
&gt;   $sth-&gt;execute&#40;&#41;;
&gt;     # hangs -&gt; never returns ...
&gt; 
&gt;   print &#34;executed \n&#34;;
&gt; 
&gt; Note that the same without the where clause, or without the index is
&gt; OK
&gt; Note that its buggy whatever the index, being primary or not.
&gt; Note that it also fails with DBI::mysqlPP
&gt; 
&gt; Best regards
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;26&nbsp;17:42:17&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;12&nbsp;18:21:51&nbsp;2008</span>
    <span class="description">miranska [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> miranska [...] yahoo.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It seems that it boils down to processing special codes by NET::MySQL,
since the database actually returns data &#40;based on debug output&#41;.
A quick and dirty workaround is to enclose your query in another SELECT
statement. Something like

SELECT * FROM &#40;SELECT id, value FROM table WHERE id &lt; 10&#41; a;

It works on Windows and Linux.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;30&nbsp;15:21:16&nbsp;2008</span>
    <span class="description">rosenfield.albert [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rosenfield.albert [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I spent some time debugging in Net::MySQL and found the following.

After a query has been sent to the server, and a response has been 
received, the _has_next_packet sub is called to check for an EOF within 
the data stream from the server:

sub _has_next_packet {
        my $self = shift;
        #substr&#40;$_[0], -1&#41; ne &#34;\xfe&#34;;
        return substr&#40;$_[0], -5&#41; ne &#34;\xfe\0\0\x22\x00&#34;;
}

At some point the protocol probably changed, and the second code line 
was commented out and replaced by the third.  I don&#39;t know why the code 
counts from the end of the packet &#40;-5 parameter to substr&#40;&#41;&#41; rather 
than from the beginning.  If counting from the beginning, you wouldn&#39;t 
have to change the code when the protocol changes because new stuff is 
always added to the end.

Anyway, the protocol is structured as such &#40;last 5 bytes in PDU&#41;:
  0x00     Number of columns
  0x0000   Number of warnings
  0x0000   Status bytes

A special value 0xFE in the &#34;number of columns&#34; field means EOF.

But in addition to checking for 0xFE, the current _has_next_packet&#40;&#41; 
code also checks whether there was exactly 0 warnings &#40;0x0000&#41;, whether 
an index was used by the server &#40;0x0020 means false&#41; and whether multi-
query is enabled &#40;0x0002&#41;.

If that is not the situation &#40;rare with any new server&#41;, the driver 
will listen indefinitely for another data packet which is not coming.

The simplest fix is to change the code to this:

sub _has_next_packet {
        my $self = shift;
        return substr&#40;$_[0], -5, 1&#41; ne &#34;\xfe&#34;;
}

although I&#39;m still not sure why counting starts from the end of the PDU.

Hope it helps!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;26&nbsp;10:43:23&nbsp;2010</span>
    <span class="description">bitcard [...] dejasurf.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bitcard [...] dejasurf.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks: aliquantus&#39; fix worked or me.

Details: I had the same hang using WHERE-clause on &#34;indexed&#34; fields in
an innodb table. Insert would work fine, but SELECT would fail.

I was running mySQL 5.1.41 on Windows7 with Cygwin.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
