<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #55049 for devel-nytprof: Devel-NYTProf-3.01_94 under Windows XP</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #55049 for devel-nytprof: Devel-NYTProf-3.01_94 under Windows XP</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/devel-nytprof/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/devel-nytprof/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/devel-nytprof/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/devel-nytprof/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/timbunce/devel-nytprof/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/devel-nytprof">devel-nytprof CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">55049</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/devel-nytprof/Active/">devel-nytprof</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Tim.Bunce [...] pobox.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-221012-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-221013-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;27&nbsp;16:42:58&nbsp;2010</span>
    <span class="description">Tim.Bunce [...] pobox.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Devel-NYTProf-3.01_94 under Windows XP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Feb 2010 18:01:59 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;Tim.Bunce [...] pobox.com&#34; &lt;Tim.Bunce [...] pobox.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Eissfeldt, Heiko&#34; &lt;Tim.Bunce [...] pobox.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Tim,

I am just doing bug hunting for Devel-NYTProf-3.01_94&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~timb/Devel-NYTProf-3.01_94/">http://search.cpan.org/~timb/Devel-NYTProf-3.01_94/</a></span>&gt;
under Windows XP with ActiveState Perl 5.8.4 and want to tell you my finds.

Symptom:
&#39;make tests&#39; first dies at t/10-run.t and very often in later tests.

This is the call stack at that point:
  msvcr71.dll!_lock_file&#40;void * pf=0x77c5fce0&#41;  Line 236 C
  msvcr71.dll!fgets&#40;char * string=0x01ce8a24, int count=2048, _iobuf * str=0x77c5fce0&#41;  Line 69 + 0x6 C
  NYTProf.dll!NYTP_gets&#40;NYTP_file_t * ifile=0x01ce5b9c, char * * buffer_p=0x0140fd28, unsigned int * len_p=0x0140fc7c&#41;  Line 369 + 0xf C
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; NYTProf.dll!load_profile_data_from_stream&#40;sv * cb=0x01ce5b9c&#41;  Line 3635 + 0x13 C
</div>  NYTProf.dll!XS_Devel__NYTProf__Data_load_profile_data_from_file&#40;interpreter * my_perl=0x00236004, cv * cv=0x01bce6f8&#41;  Line 4584 C
  perl58.dll!28040f9f&#40;&#41;
The problem seems to be this:

load_profile_data_from_stream&#40;&#41; uses the &#39;in&#39; filepointer, which is somehow corrupted.

That is
&#39;in&#39; points to a structure NYTP_file_t containing the
  &#39;file&#39; pointer pointing to a structure _iobuf which has only NULL pointers



- in 0x01ce5b9c {file=0x77c5fce0  NYTP_file_t *
  - file 0x77c5fce0  _iobuf *
    + _ptr 0x00000000 &lt;bad Ptr&gt; char *
     _cnt 0 int
    + _base 0x00000000 &lt;bad Ptr&gt; char *
     _flag 1 int
     _file 3 int
     _charbuf 0 int
     _bufsiz 0 int
    + _tmpfname 0x00000000 &lt;bad Ptr&gt; char *
so when NYTP_gets&#40;&#41; is called, it crashes.

&#39;in&#39; is set from the return value of NYTP_open&#40;&#41;.
I have not the faintest idea why such a buggy structure is given back...


The file nytprof_10-run.out has this content:
NYTProf 3 0
# Perl profile database. Generated by Devel::NYTProf on Thu Feb 25 16:47:11 2010
:basetime=1267112831
:xs_version=3.02
:perl_version=5.8.4
:clock_id=-1
:ticks_per_sec=1000000
:nv_size=8
:PL_perldb=784
:application=-
P&#39;ð G÷ß¦áÒAp&#39;ð.Gá¦áÒA


Hope that helps,
Heiko
</div></div>

<div class="messagebody">
</div>
</div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;27&nbsp;17:10:45&nbsp;2010</span>
    <span class="description">Tim.Bunce [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &#34;Eissfeldt, Heiko&#34; &lt;heiko.eissfeldt [...] siemens.com&gt;, develnytprof-dev [...] googlegroups.com</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #55049] Devel-NYTProf-3.01_94 under Windows XP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 27 Feb 2010 17:09:43 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Tim Bunce via RT &lt;bug-devel-nytprof [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Bunce &lt;Tim.Bunce [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Heiko.

Just a hunch... try editing t/10-run.t like this:

--- t/10-run.t  &#40;revision 1085&#41;
+++ t/10-run.t  &#40;working copy&#41;
@@ -11,7 +11,7 @@
 use Devel::NYTProf::Run qw&#40;profile_this&#41;;
 
 run_test_group&#40; {
-    extra_options =&gt; { stmts =&gt; 0 }, # RT#50851
+    extra_options =&gt; { stmts =&gt; 0, compress =&gt; 0 }, # RT#50851
     extra_test_count =&gt; 1,
     extra_test_code  =&gt; sub {
         my &#40;$profile, $env&#41; = @_;

and let us know &#40;ASAP please as this is the last issue holding up a
release&#41;.

If that does _not_ fix it then please:

1. install the module
2. set the NYTPROF env vat to &#34;trace=99&#34;
3. send me the output of:

    nytprofhtml --file nytprof_10-run.out

Thanks.

Tim.

On Sat, Feb 27, 2010 at 04:42:59PM -0500, Tim Bunce via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sat Feb 27 16:42:58 2010: Request 55049 was acted upon.
&gt; Transaction: Ticket created by Tim.Bunce@pobox.com
&gt;        Queue: devel-nytprof
&gt;      Subject: Devel-NYTProf-3.01_94 under Windows XP
&gt;    Broken in: &#40;no value&#41;
&gt;     Severity: &#40;no value&#41;
&gt;        Owner: Nobody
&gt;   Requestors: Tim.Bunce@pobox.com
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=55049">https://rt.cpan.org/Ticket/Display.html?id=55049</a></span> &gt;
&gt; 
&gt; 
&gt; Hello Tim,
&gt; 
&gt; I am just doing bug hunting for Devel-NYTProf-3.01_94&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~timb/Devel-NYTProf-3.01_94/">http://search.cpan.org/~timb/Devel-NYTProf-3.01_94/</a></span>&gt;
&gt; under Windows XP with ActiveState Perl 5.8.4 and want to tell you my finds.
&gt; 
&gt; Symptom:
&gt; &#39;make tests&#39; first dies at t/10-run.t and very often in later tests.
&gt; 
&gt; This is the call stack at that point:
&gt;   msvcr71.dll!_lock_file&#40;void * pf=0x77c5fce0&#41;  Line 236 C
&gt;   msvcr71.dll!fgets&#40;char * string=0x01ce8a24, int count=2048, _iobuf * str=0x77c5fce0&#41;  Line 69 + 0x6 C
&gt;   NYTProf.dll!NYTP_gets&#40;NYTP_file_t * ifile=0x01ce5b9c, char * * buffer_p=0x0140fd28, unsigned int * len_p=0x0140fc7c&#41;  Line 369 + 0xf C
<div class="message-stanza open">&gt; &gt; NYTProf.dll!load_profile_data_from_stream&#40;sv * cb=0x01ce5b9c&#41;  Line 3635 + 0x13 C
</div>&gt;   NYTProf.dll!XS_Devel__NYTProf__Data_load_profile_data_from_file&#40;interpreter * my_perl=0x00236004, cv * cv=0x01bce6f8&#41;  Line 4584 C
&gt;   perl58.dll!28040f9f&#40;&#41;
&gt; The problem seems to be this:
&gt; 
&gt; load_profile_data_from_stream&#40;&#41; uses the &#39;in&#39; filepointer, which is somehow corrupted.
&gt; 
&gt; That is
&gt; &#39;in&#39; points to a structure NYTP_file_t containing the
&gt;   &#39;file&#39; pointer pointing to a structure _iobuf which has only NULL pointers
&gt; 
&gt; 
&gt; 
&gt; - in 0x01ce5b9c {file=0x77c5fce0  NYTP_file_t *
&gt;   - file 0x77c5fce0  _iobuf *
&gt;     + _ptr 0x00000000 &lt;bad Ptr&gt; char *
&gt;      _cnt 0 int
&gt;     + _base 0x00000000 &lt;bad Ptr&gt; char *
&gt;      _flag 1 int
&gt;      _file 3 int
&gt;      _charbuf 0 int
&gt;      _bufsiz 0 int
&gt;     + _tmpfname 0x00000000 &lt;bad Ptr&gt; char *
&gt; so when NYTP_gets&#40;&#41; is called, it crashes.
&gt; 
&gt; &#39;in&#39; is set from the return value of NYTP_open&#40;&#41;.
&gt; I have not the faintest idea why such a buggy structure is given back...
&gt; 
&gt; 
&gt; The file nytprof_10-run.out has this content:
&gt; NYTProf 3 0
&gt; # Perl profile database. Generated by Devel::NYTProf on Thu Feb 25 16:47:11 2010
&gt; :basetime=1267112831
&gt; :xs_version=3.02
&gt; :perl_version=5.8.4
&gt; :clock_id=-1
&gt; :ticks_per_sec=1000000
&gt; :nv_size=8
&gt; :PL_perldb=784
&gt; :application=-
&gt; P&#39;ð G÷ß¦áÒAp&#39;ð.Gá¦áÒA
&gt; 
&gt; 
&gt; Hope that helps,
&gt; Heiko
&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;01&nbsp;05:02:55&nbsp;2010</span>
    <span class="description">heiko.eissfeldt [...] siemens.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &#34;develnytprof-dev [...] googlegroups.com&#34; &lt;develnytprof-dev [...] googlegroups.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> AW: [rt.cpan.org #55049] Devel-NYTProf-3.01_94 under Windows XP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 1 Mar 2010 10:59:28 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Tim Bunce &lt;Tim.Bunce [...] pobox.com&gt;, Tim Bunce via RT &lt;bug-devel-nytprof [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Eissfeldt, Heiko&#34; &lt;heiko.eissfeldt [...] siemens.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Tim,
 
sorry, no changes so far.

I changed the test =&gt; the app crashed.

So I installed the module and ran it like proposed.
The app crashed, the debugger points to the same 
location for the crash as in my previous email.

Sorry, no output file is created since 
the reading fails before.

H:\.cpan\build\Devel-NYTProf-3.01_94&gt;nytprofhtml --file t/nytprof_10-run.out
# trace=99
Generating report...
Reading t/nytprof_10-run.out
reading profile data from file t/nytprof_10-run.out
&lt;CRASH&gt;

======
Please convince me, that the NYTP_open&#40;&#41; function is
implemented correctly &#40;that is portably&#41;.

During debugging I found the call to fopen&#40;&#41; in 
NYTP_open&#40;&#41; is made into perl58.dll instead of 
to the equally named function of the C library.

I am sure fopen&#40;&#41; returns the buggy structure 
that is used later in NYTP_gets&#40;&#41;.

Is PerlIO_open needed here instead?

Sorry for the bads news,
greetings Heiko

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Ursprüngliche Nachricht-----

Just a hunch... try editing t/10-run.t like this:

--- t/10-run.t  &#40;revision 1085&#41;
+++ t/10-run.t  &#40;working copy&#41;
@@ -11,7 +11,7 @@
 use Devel::NYTProf::Run qw&#40;profile_this&#41;;
 
 run_test_group&#40; {
-    extra_options =&gt; { stmts =&gt; 0 }, # RT#50851
+    extra_options =&gt; { stmts =&gt; 0, compress =&gt; 0 }, # RT#50851
     extra_test_count =&gt; 1,
     extra_test_code  =&gt; sub {
         my &#40;$profile, $env&#41; = @_;

and let us know &#40;ASAP please as this is the last issue holding up a
release&#41;.

If that does _not_ fix it then please:

1. install the module
2. set the NYTPROF env vat to &#34;trace=99&#34;
3. send me the output of:

    nytprofhtml --file nytprof_10-run.out

Thanks.

Tim.

On Sat, Feb 27, 2010 at 04:42:59PM -0500, Tim Bunce via RT wrote:
<div class="message-stanza open">&gt; I am just doing bug hunting for Devel-NYTProf-3.01_94&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~timb/Devel-NYTProf-3.01_94/">http://search.cpan.org/~timb/Devel-NYTProf-3.01_94/</a></span>&gt;
&gt; under Windows XP with ActiveState Perl 5.8.4 and want to tell you my finds.
&gt; 
&gt; Symptom:
&gt; &#39;make tests&#39; first dies at t/10-run.t and very often in later tests.
&gt; 
&gt; This is the call stack at that point:
&gt;   msvcr71.dll!_lock_file&#40;void * pf=0x77c5fce0&#41;  Line 236 C
&gt;   msvcr71.dll!fgets&#40;char * string=0x01ce8a24, int count=2048, _iobuf * str=0x77c5fce0&#41;  Line 69 + 0x6 C
&gt;   NYTProf.dll!NYTP_gets&#40;NYTP_file_t * ifile=0x01ce5b9c, char * * buffer_p=0x0140fd28, unsigned int * len_p=0x0140fc7c&#41;  Line 369 + 0xf C
<div class="message-stanza open">&gt; &gt; NYTProf.dll!load_profile_data_from_stream&#40;sv * cb=0x01ce5b9c&#41;  Line 3635 + 0x13 C
</div>&gt;   NYTProf.dll!XS_Devel__NYTProf__Data_load_profile_data_from_file&#40;interpreter * my_perl=0x00236004, cv * cv=0x01bce6f8&#41;  Line 4584 C
&gt;   perl58.dll!28040f9f&#40;&#41;
&gt; The problem seems to be this:
&gt; 
&gt; load_profile_data_from_stream&#40;&#41; uses the &#39;in&#39; filepointer, which is somehow corrupted.
&gt; 
&gt; That is
&gt; &#39;in&#39; points to a structure NYTP_file_t containing the
&gt;   &#39;file&#39; pointer pointing to a structure _iobuf which has only NULL pointers
&gt; 
&gt; 
&gt; 
&gt; - in 0x01ce5b9c {file=0x77c5fce0  NYTP_file_t *
&gt;   - file 0x77c5fce0  _iobuf *
&gt;     + _ptr 0x00000000 &lt;bad Ptr&gt; char *
&gt;      _cnt 0 int
&gt;     + _base 0x00000000 &lt;bad Ptr&gt; char *
&gt;      _flag 1 int
&gt;      _file 3 int
&gt;      _charbuf 0 int
&gt;      _bufsiz 0 int
&gt;     + _tmpfname 0x00000000 &lt;bad Ptr&gt; char *
&gt; so when NYTP_gets&#40;&#41; is called, it crashes.
&gt; 
&gt; &#39;in&#39; is set from the return value of NYTP_open&#40;&#41;.
&gt; I have not the faintest idea why such a buggy structure is given back...
&gt; 
&gt; 
&gt; The file nytprof_10-run.out has this content:
&gt; NYTProf 3 0
&gt; # Perl profile database. Generated by Devel::NYTProf on Thu Feb 25 16:47:11 2010
&gt; :basetime=1267112831
&gt; :xs_version=3.02
&gt; :perl_version=5.8.4
&gt; :clock_id=-1
&gt; :ticks_per_sec=1000000
&gt; :nv_size=8
&gt; :PL_perldb=784
&gt; :application=-
&gt; P&#39;ð G÷ß¦áÒAp&#39;ð.Gá¦áÒA
&gt; 
&gt; 
&gt; Hope that helps,
&gt; Heiko
&gt; 
&gt; 
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;01&nbsp;05:02:57&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;01&nbsp;10:13:45&nbsp;2010</span>
    <span class="description">heiko.eissfeldt [...] siemens.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> AW: [rt.cpan.org #55049] Devel-NYTProf-3.01_94 under Windows XP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 1 Mar 2010 16:06:03 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Tim Bunce &lt;Tim.Bunce [...] pobox.com&gt;, Tim Bunce via RT &lt;bug-devel-nytprof [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Eissfeldt, Heiko&#34; &lt;heiko.eissfeldt [...] siemens.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Tim,

More info:

The preprocessed output of file FileHandle.c &#40;FileHandle.i, see attachment&#41;
has this call to fopen&#40;&#41; in function NYTP_open&#40;&#41;:

    FILE *raw_file = &#40;*&#40;*Perl_IStdIO_ptr&#40;&#40;&#40;PerlInterpreter *&#41;Perl_get_context&#40;&#41;&#41;&#41;&#41;-&gt;pOpen&#41;&#40;&#40;*Perl_IStdIO_ptr&#40;&#40;&#40;PerlInterpreter *&#41;Perl_get_context&#40;&#41;&#41;&#41;&#41;, &#40;name&#41;,&#40;mode&#41;&#41;;

From this original line
    FILE *raw_file = fopen&#40;name, mode&#41;;


It does not seem compatible with libc&#39;s fopen&#40;&#41;...


Here is the complete expanded function NYTP_open&#40;&#41;:
NYTP_file
NYTP_open&#40;const char *name, const char *mode&#41; {
    FILE *raw_file = &#40;*&#40;*Perl_IStdIO_ptr&#40;&#40;&#40;PerlInterpreter *&#41;Perl_get_context&#40;&#41;&#41;&#41;&#41;-&gt;pOpen&#41;&#40;&#40;*Perl_IStdIO_ptr&#40;&#40;&#40;PerlInterpreter *&#41;Perl_get_context&#40;&#41;&#41;&#41;&#41;, &#40;name&#41;,&#40;mode&#41;&#41;;
    NYTP_file file;

    if &#40;!raw_file&#41;
        return 0;

    &#40;file = &#40;struct NYTP_file_t*&#41;Perl_safesysmalloc&#40;&#40;size_t&#41;&#40;&#40;1&#41;*sizeof&#40;struct NYTP_file_t&#41;&#41;&#41;&#41;;
    file-&gt;file = raw_file;










    return file;
}


Mit freundlichen Grüßen
Heiko Eißfeldt
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;10&nbsp;05:52:17&nbsp;2010</span>
    <span class="description">heiko [...] hexco.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> heiko [...] hexco.de</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Tim,

I saw, development is progressing fast, so I need to tell you fast 
about my work.

I could fix the crash for 3.01_94 under Windows XP
by rewriting FileHandle.xs with the portable Perl IO API
&#40;according to the book; see docs perlclib and perlapio&#41;. My Perl used 
PERLIO, btw. 

Tests are not succeeding yet, alas. But that is a secondary matter.

Please compare the attached code against 3.01_94 und consider/review 
the rewritten code.

Thanks Heiko
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> NYTProf.xs</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;10&nbsp;05:54:52&nbsp;2010</span>
    <span class="description">heiko [...] hexco.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Oops, wrong attachment</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> heiko [...] hexco.de</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Oops, the attachment was the wrong one. Here it comes...
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FileHandle.xs</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;10&nbsp;08:33:41&nbsp;2010</span>
    <span class="description">Tim.Bunce [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Tim.Bunce [...] pobox.com, develnytprof-dev [...] googlegroups.com</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #55049] Devel-NYTProf-3.01_94 under Windows XP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 10 Mar 2010 13:31:43 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Heiko via RT &lt;bug-devel-nytprof [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Bunce &lt;Tim.Bunce [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Mar 10, 2010 at 05:52:20AM -0500, Heiko via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I could fix the crash for 3.01_94 under Windows XP
&gt; by rewriting FileHandle.xs with the portable Perl IO API
&gt; &#40;according to the book; see docs perlclib and perlapio&#41;. My Perl used 
&gt; PERLIO, btw. 
&gt; 
&gt; Tests are not succeeding yet, alas. But that is a secondary matter.
&gt; 
&gt; Please compare the attached code against 3.01_94 und consider/review 
&gt; the rewritten code.
</div>
Thanks Heiko [I&#39;ve attached the diff for the record.]

The problem is that really we&#39;d like to reduce perl&#39;isms in the
FileHandle.xs I/O code rather than add more. The I/O is simple so
shouldn&#39;t be too hard to port to windows, in theory.

In the course of investigating this did you identify an actual cause?

Could it be related to <span class="clickylink"><a target="new" rel="nofollow" href="http://perl.markmail.org/thread/2ixdrw25huun2fx5">http://perl.markmail.org/thread/2ixdrw25huun2fx5</a></span> ?

Tim.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;11&nbsp;05:28:25&nbsp;2010</span>
    <span class="description">heiko [...] hexco.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> heiko [...] hexco.de</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In the course of investigating this did you identify an actual cause?
</div>
Not really. The mapped fopen&#40;&#41; function returns something not 
appropriate for further use of non PERLAPIO functions...
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Could it be related to 
</div><span class="clickylink"><a target="new" rel="nofollow" href="http://perl.markmail.org/thread/2ixdrw25huun2fx5">http://perl.markmail.org/thread/2ixdrw25huun2fx5</a></span> ?

In the widest sense, yes.

PERLIO adds another level of indirection for IO Layers as far I 
understand. This can only work, if used with new functions from
PERLAPIO.

Alternatively we could block the mappings and use the libc functions 
directly. That is what I did, and it compiled, and the module did not 
crash. But how portable that is, I don&#39;t know.

See attached diff &#40;against 3.0.1_94&#41; for FileHandle.xs
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FileHandle.xs.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- FileHandle.xs.org	2010-02-21 17:34:28.000000000 +0100
+++ FileHandle.xs	2010-03-11 11:15:54.826391900 +0100
@@ -18,6 +18,18 @@
 #define NEED_sv_2pvbyte
 #include &#34;ppport.h&#34;
 
+/*  deliberately throw IO mappings away */
+#undef fgets
+#undef fopen
+#undef fclose
+#undef fread
+#undef fwrite
+#undef ftell
+#undef fprintf
+#undef vfprintf
+#undef feof
+#undef fflush
+
 #ifdef HAS_ZLIB
 #  include &lt;zlib.h&gt;
 #endif
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;11&nbsp;07:21:25&nbsp;2010</span>
    <span class="description">heiko [...] hexco.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> heiko [...] hexco.de</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Looking better now. Here is the test output.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> testresults.out.gz</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;11&nbsp;10:11:16&nbsp;2010</span>
    <span class="description">heiko [...] hexco.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> heiko [...] hexco.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Do 11. Mär 2010, 07:21:25, heiko@hexco.de schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Looking better now. Here is the test output.
</div>

rechecked with my latest diff &#40;#undef ...&#41; against 3.10_51:

only one test out of 2598 tests failed, good work :-&#41;

Z:\.cpan\build\Devel-NYTProf-3.10_51&gt;nmake test

Microsoft &#40;R&#41; Program Maintenance Utility, Version 7.10.3077
Copyright &#40;C&#41; Microsoft Corporation. Alle Rechte vorbehalten.

        Z:\WINNT\Perl\bin\perl.exe -MExtUtils::Command -e &#34;cp&#34; -- 
blib\arch\auto\Devel\NYTProf\NYTProf.dll 
blib\lib/Devel/auto/Devel\NYTProf/NYTProf.dll
        Z:\WINNT\Perl\bin\perl.exe &#34;-MExtUtils::Command::MM&#34; &#34;-
e&#34; &#34;test_harness&#40;0, &#39;blib\lib&#39;, &#39;blib\arch&#39;&#41;&#34; t/50-errno.t
t/50-errno....ok 3/8
t/50-errno....NOK 4#   Failed test &#39;$! should not be altered by 
assigning fids to previously unprofiled modules &#40;No such file or 
directory&#41;&#39;
#   at t/50-errno.t line 31.
#          got: &#39;2&#39;
#     expected: &#39;3&#39;
t/50-errno....ok 8/8# Looks like you failed 1 test of 8.
t/50-errno....dubious
        Test returned status 1 &#40;wstat 256, 0x100&#41;
DIED. FAILED test 4
        Failed 1/8 tests, 87.50% okay
Failed Test  Stat Wstat Total Fail  Failed  List of Failed
------------------------------------------------------------------------
-------
t/50-errno.t    1   256     8    1  12.50%  4
Failed 1/1 test scripts, 0.00% okay. 1/8 subtests failed, 87.50% okay.
NMAKE : fatal error U1077: &#39;Z:\WINNT\Perl\bin\perl.exe&#39;: Rⁿckgabe-
Code &#39;0x2&#39;
Stop.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;11&nbsp;17:15:18&nbsp;2010</span>
    <span class="description">Tim.Bunce [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Tim.Bunce [...] pobox.com, develnytprof-dev [...] googlegroups.com, Jan Dubois &lt;jand [...] activestate.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #55049] Devel-NYTProf-3.01_94 under Windows XP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 11 Mar 2010 22:13:57 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Heiko via RT &lt;bug-devel-nytprof [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Bunce &lt;Tim.Bunce [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Mar 11, 2010 at 05:28:30AM -0500, Heiko via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=55049">https://rt.cpan.org/Ticket/Display.html?id=55049</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt; &gt; In the course of investigating this did you identify an actual cause?
</div>&gt; 
&gt; Not really. The mapped fopen&#40;&#41; function returns something not 
&gt; appropriate for further use of non PERLAPIO functions...
&gt;  
<div class="message-stanza open">&gt; &gt; Could it be related to 
</div>&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://perl.markmail.org/thread/2ixdrw25huun2fx5">http://perl.markmail.org/thread/2ixdrw25huun2fx5</a></span> ?
&gt; 
&gt; In the widest sense, yes.
&gt; 
&gt; PERLIO adds another level of indirection for IO Layers as far I 
&gt; understand. This can only work, if used with new functions from
&gt; PERLAPIO.
&gt; 
&gt; Alternatively we could block the mappings and use the libc functions 
&gt; directly. That is what I did, and it compiled, and the module did not 
&gt; crash. But how portable that is, I don&#39;t know.
&gt; 
&gt; See attached diff &#40;against 3.0.1_94&#41; for FileHandle.xs
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; rechecked with my latest diff &#40;#undef ...&#41; against 3.10_51:
&gt;
&gt; only one test out of 2598 tests failed, good work :-&#41;   
</div>
[t/50-errno.t - I&#39;ll reply in a seperate email about that one.]

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; --- FileHandle.xs.org 2010-02-21 17:34:28.000000000 +0100
&gt; +++ FileHandle.xs     2010-03-11 11:15:54.826391900 +0100
&gt; @@ -18,6 +18,18 @@
&gt;  #define NEED_sv_2pvbyte
&gt;  #include &#34;ppport.h&#34;
&gt;  
&gt; +/*  deliberately throw IO mappings away */
&gt; +#undef fgets
&gt; +#undef fopen
&gt; +#undef fclose
&gt; +#undef fread
&gt; +#undef fwrite
&gt; +#undef ftell
&gt; +#undef fprintf
&gt; +#undef vfprintf
&gt; +#undef feof
&gt; +#undef fflush
</div>
I&#39;m happy with the approach, but I&#39;d like to wrap it in an #ifdef
so it only applies to the affected platforms.

What puzzles me is why Jan didn&#39;t hit the same problem in
<span class="clickylink"><a target="new" rel="nofollow" href="http://groups.google.com/group/develnytprof-dev/browse_frm/thread/7ec4850ff164c95b/e241a51712be9efd#e241a51712be9efd">http://groups.google.com/group/develnytprof-dev/browse_frm/thread/7ec4850ff164c95b/e241a51712be9efd#e241a51712be9efd</a></span>

You said you&#39;re using &#34;Windows XP with ActiveState Perl 5.8.4&#34;
Could you post your perl -V output so we get the full details?

Jan, could you do the same so we can compare?

I want to find an appropriate #ifdef incantation to wrap it with.
Any suggestions?

Tim.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;11&nbsp;17:39:51&nbsp;2010</span>
    <span class="description">jand [...] ActiveState.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [develnytprof-dev: 1825] Re: [rt.cpan.org #55049] 	Devel-NYTProf-3.01_94 under Windows XP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 11 Mar 2010 14:38:52 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;develnytprof-dev [...] googlegroups.com&gt;, &#34;&#39;Heiko via RT&#39;&#34; &lt;bug-devel-nytprof [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jan Dubois&#34; &lt;jand [...] activestate.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, 11 Mar 2010, Tim Bunce wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You said you&#39;re using &#34;Windows XP with ActiveState Perl 5.8.4&#34;
&gt; Could you post your perl -V output so we get the full details?
&gt; 
&gt; Jan, could you do the same so we can compare?
</div>
I&#39;ve attached it at the bottom, but AFAIK there was only a single ActivePerl
release for 5.8.4 &#40;build 810&#41;, so the output should be identical.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I want to find an appropriate #ifdef incantation to wrap it with.
</div>
As everything worked for me, it seems unlikely that there is any #define
that would explain the difference.

Things that are still different in Heiko&#39;s setup are the compiler version
&#40;Visual Studio 2003 I think&#41; and OS &#40;Windows XP&#41;.  I&#39;ve been using VC6 and MingW for
the compilers and Win2000 for the test VM &#40;but probably not MinGW with 5.8.4
because build 810 doesn&#39;t support this without some tweaks&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Any suggestions?
</div>
If anything I would suspect that the compiler version might make a difference
&#40;and or the Platform SDK, if installed&#41;.  But I&#39;m not keen on spending too
much time on testing a 7 year old compiler with a 6 year old version of
ActivePerl unless the problem can also be reproduced with a current version
of Perl.

Ok, I have one more idea: When you compile a module with VS2003, then that module
links against MSVCR71.dll instead of MSVCRT.dll, so you end up with 2 CRT libraries
inside a single process.  This normally works fine as long as you don&#39;t mix things
like memory allocation &#40;call MSVCR71.free&#40;&#41; on a pointer returned by MSVCRT.malloc&#40;&#41;&#41;
and file I/O &#40;call MSVCR71.fputs&#40;&#41; on a FILE* returned by MSVCRT.fopen&#40;&#41;&#41; etc.
All the macro redefinitions in the Perl headers are supposed to protect you from
these mixups, but there may be a bug somewhere.

I don&#39;t have a VM with VS2003, and I don&#39;t know if I have a license anywhere anymore
anyways, so it is not easy for me to test.

Cheers,
-Jan

Summary of my perl5 &#40;revision 5 version 8 subversion 4&#41; configuration:
  Platform:
    osname=MSWin32, osvers=4.0, archname=MSWin32-x86-multi-thread
    uname=&#39;&#39;
    config_args=&#39;undef&#39;
    hint=recommended, useposix=true, d_sigaction=undef
    usethreads=undef use5005threads=undef useithreads=define usemultiplicity=define
    useperlio=define d_sfio=undef uselargefiles=define usesocks=undef
    use64bitint=undef use64bitall=undef uselongdouble=undef
    usemymalloc=n, bincompat5005=undef
  Compiler:
    cc=&#39;cl&#39;, ccflags =&#39;-nologo -Gf -W3 -MD -Zi -DNDEBUG -O1 -DWIN32 -D_CONSOLE -DNO_STRICT -DHAVE_DES_FCRYPT  -NO_HASH_SEED
-DPERL_IMPLICIT_CONTEXT -DPERL_IMPLICIT_SYS -DUSE_PERLIO -DPERL_MSVCRT_READFIX&#39;,
    optimize=&#39;-MD -Zi -DNDEBUG -O1&#39;,
    cppflags=&#39;-DWIN32&#39;
    ccversion=&#39;&#39;, gccversion=&#39;&#39;, gccosandvers=&#39;&#39;
    intsize=4, longsize=4, ptrsize=4, doublesize=8, byteorder=1234
    d_longlong=undef, longlongsize=8, d_longdbl=define, longdblsize=10
    ivtype=&#39;long&#39;, ivsize=4, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;__int64&#39;, lseeksize=8
    alignbytes=8, prototype=define
  Linker and Libraries:
    ld=&#39;link&#39;, ldflags =&#39;-nologo -nodefaultlib -debug -opt:ref,icf  -libpath:&#34;C:
\Perl810\lib\CORE&#34;  -machine:x86&#39;
    libpth=C:\PROGRA~1\MICROS~3\VC98\lib
    libs=  oldnames.lib kernel32.lib user32.lib gdi32.lib winspool.lib  comdlg32.lib advapi32.lib shell32.lib ole32.lib oleaut32.lib
netapi32.lib uuid.lib wsock32.lib mpr.lib winmm.lib  version.lib odbc32.lib odbccp32.lib msvcrt.lib
    perllibs=  oldnames.lib kernel32.lib user32.lib gdi32.lib winspool.lib  comdlg32.lib advapi32.lib shell32.lib ole32.lib
oleaut32.lib  netapi32.lib uuid.lib wsock32.lib mpr.lib winmm.lib  version.lib odbc32.lib odbccp32.lib msvcrt.lib
    libc=msvcrt.lib, so=dll, useshrplib=yes, libperl=perl58.lib
    gnulibc_version=&#39;undef&#39;
  Dynamic Linking:
    dlsrc=dl_win32.xs, dlext=dll, d_dlsymun=undef, ccdlflags=&#39; &#39;
    cccdlflags=&#39; &#39;, lddlflags=&#39;-dll -nologo -nodefaultlib -debug -opt:ref,icf  -libpath:&#34;C:\Perl810\lib\CORE&#34;  -machine:x86&#39;


Characteristics of this binary &#40;from libperl&#41;:
  Compile-time options: MULTIPLICITY USE_ITHREADS USE_LARGE_FILES PERL_IMPLICIT_
CONTEXT PERL_IMPLICIT_SYS
  Locally applied patches:
        ActivePerl Build 810
        22751 Update to Test.pm 1.25
        21540 Fix backward-compatibility issues in if.pm
  Built under MSWin32
  Compiled at Jun  1 2004 11:52:21
  @INC:
    c:/Perl810/lib
    c:/Perl810/site/lib
    .
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;11&nbsp;17:56:54&nbsp;2010</span>
    <span class="description">Tim.Bunce [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Tim.Bunce [...] pobox.com, develnytprof-dev [...] googlegroups.com</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #55049] Devel-NYTProf-3.01_94 under Windows XP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 11 Mar 2010 22:55:57 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Heiko via RT &lt;bug-devel-nytprof [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Bunce &lt;Tim.Bunce [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Mar 11, 2010 at 10:11:19AM -0500, Heiko via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; rechecked with my latest diff &#40;#undef ...&#41; against 3.10_51:
&gt; 
&gt; only one test out of 2598 tests failed, good work :-&#41;
&gt; 
&gt; t/50-errno....NOK 4#   Failed test &#39;$! should not be altered by 
&gt; assigning fids to previously unprofiled modules &#40;No such file or 
&gt; directory&#41;&#39;
&gt; #   at t/50-errno.t line 31.
&gt; #          got: &#39;2&#39;
&gt; #     expected: &#39;3&#39;
</div>
I can&#39;t reproduce this. The NYTProf.xs code has logic to save and
restore errno around the entry points to/from perl. I tried adding
code in FileHandle.xs to explicitly set errno in all the i/o functions
but still couldn&#39;t get test failures &#40;unless I also disabled the errno
save/restore logic&#41;. I tried with and without zlib. r1166.

Is it reliably repeatable for you?

To help me narrow down the cause please try the following changes:

- edit t/50-errno.t to delete everything after line 31.
- change the test count from 8 to 4
- rerun to check it fails the same way
- rerun with each of the following changes to $ENV{NYTPROF} &#40;line 6&#41;:
  &#34;start=init:file=$nytprof_out:blocks=0:stmts=0&#34;
&#34;start=init:file=$nytprof_out:blocks=0:subs=0&#34;
&#34;start=init:file=$nytprof_out:blocks=0:stmts=0:subs=0&#34;
- also send me &#40;off-list&#41; the log from running whichever is the last of
  those which fails, but with &#34;:trace=90&#34; appended to it.

Thanks!

Tim.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;11&nbsp;18:50:20&nbsp;2010</span>
    <span class="description">Tim.Bunce [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &#39;Heiko via RT&#39; &lt;bug-devel-nytprof [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [develnytprof-dev: 1826] Re: [rt.cpan.org #55049] Devel-NYTProf-3.01_94 under Windows XP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 11 Mar 2010 23:49:20 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> develnytprof-dev [...] googlegroups.com</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Bunce &lt;Tim.Bunce [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks Jan.

For Heiko&#39;s config, NYTProf is very broken without the #undefs
so I&#39;d like to get those in. Assuming your VS2003 hypothesis is correct,
is there a macro to detect that compiler? And would using that macro
to wrap the #undefs be a reasonable solution?

That leaves the t/50-errno.t failures. I&#39;d be happy enough to
skip the failing tests on that system. Is there some way in perl to
detect that perl was built with VS2003 and/or the dual libraries?
If not then I could just skip the tests on windows systems with old
versions of perl, say &lt;= 5.8.9.

Tim.

On Thu, Mar 11, 2010 at 02:38:52PM -0800, Jan Dubois wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu, 11 Mar 2010, Tim Bunce wrote:
<div class="message-stanza open">&gt; &gt; You said you&#39;re using &#34;Windows XP with ActiveState Perl 5.8.4&#34;
&gt; &gt; Could you post your perl -V output so we get the full details?
&gt; &gt; 
&gt; &gt; Jan, could you do the same so we can compare?
</div>&gt; 
&gt; I&#39;ve attached it at the bottom, but AFAIK there was only a single ActivePerl
&gt; release for 5.8.4 &#40;build 810&#41;, so the output should be identical.
&gt;  
<div class="message-stanza open">&gt; &gt; I want to find an appropriate #ifdef incantation to wrap it with.
</div>&gt; 
&gt; As everything worked for me, it seems unlikely that there is any #define
&gt; that would explain the difference.
&gt; 
&gt; Things that are still different in Heiko&#39;s setup are the compiler version
&gt; &#40;Visual Studio 2003 I think&#41; and OS &#40;Windows XP&#41;.  I&#39;ve been using VC6 and MingW for
&gt; the compilers and Win2000 for the test VM &#40;but probably not MinGW with 5.8.4
&gt; because build 810 doesn&#39;t support this without some tweaks&#41;.
&gt; 
<div class="message-stanza open">&gt; &gt; Any suggestions?
</div>&gt; 
&gt; If anything I would suspect that the compiler version might make a difference
&gt; &#40;and or the Platform SDK, if installed&#41;.  But I&#39;m not keen on spending too
&gt; much time on testing a 7 year old compiler with a 6 year old version of
&gt; ActivePerl unless the problem can also be reproduced with a current version
&gt; of Perl.
&gt; 
&gt; Ok, I have one more idea: When you compile a module with VS2003, then that module
&gt; links against MSVCR71.dll instead of MSVCRT.dll, so you end up with 2 CRT libraries
&gt; inside a single process.  This normally works fine as long as you don&#39;t mix things
&gt; like memory allocation &#40;call MSVCR71.free&#40;&#41; on a pointer returned by MSVCRT.malloc&#40;&#41;&#41;
&gt; and file I/O &#40;call MSVCR71.fputs&#40;&#41; on a FILE* returned by MSVCRT.fopen&#40;&#41;&#41; etc.
&gt; All the macro redefinitions in the Perl headers are supposed to protect you from
&gt; these mixups, but there may be a bug somewhere.
&gt; 
&gt; I don&#39;t have a VM with VS2003, and I don&#39;t know if I have a license anywhere anymore
&gt; anyways, so it is not easy for me to test.
&gt; 
&gt; Cheers,
&gt; -Jan
&gt; 
&gt; Summary of my perl5 &#40;revision 5 version 8 subversion 4&#41; configuration:
&gt;   Platform:
&gt;     osname=MSWin32, osvers=4.0, archname=MSWin32-x86-multi-thread
&gt;     uname=&#39;&#39;
&gt;     config_args=&#39;undef&#39;
&gt;     hint=recommended, useposix=true, d_sigaction=undef
&gt;     usethreads=undef use5005threads=undef useithreads=define usemultiplicity=define
&gt;     useperlio=define d_sfio=undef uselargefiles=define usesocks=undef
&gt;     use64bitint=undef use64bitall=undef uselongdouble=undef
&gt;     usemymalloc=n, bincompat5005=undef
&gt;   Compiler:
&gt;     cc=&#39;cl&#39;, ccflags =&#39;-nologo -Gf -W3 -MD -Zi -DNDEBUG -O1 -DWIN32 -D_CONSOLE -DNO_STRICT -DHAVE_DES_FCRYPT  -NO_HASH_SEED
&gt; -DPERL_IMPLICIT_CONTEXT -DPERL_IMPLICIT_SYS -DUSE_PERLIO -DPERL_MSVCRT_READFIX&#39;,
&gt;     optimize=&#39;-MD -Zi -DNDEBUG -O1&#39;,
&gt;     cppflags=&#39;-DWIN32&#39;
&gt;     ccversion=&#39;&#39;, gccversion=&#39;&#39;, gccosandvers=&#39;&#39;
&gt;     intsize=4, longsize=4, ptrsize=4, doublesize=8, byteorder=1234
&gt;     d_longlong=undef, longlongsize=8, d_longdbl=define, longdblsize=10
&gt;     ivtype=&#39;long&#39;, ivsize=4, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;__int64&#39;, lseeksize=8
&gt;     alignbytes=8, prototype=define
&gt;   Linker and Libraries:
&gt;     ld=&#39;link&#39;, ldflags =&#39;-nologo -nodefaultlib -debug -opt:ref,icf  -libpath:&#34;C:
&gt; \Perl810\lib\CORE&#34;  -machine:x86&#39;
&gt;     libpth=C:\PROGRA~1\MICROS~3\VC98\lib
&gt;     libs=  oldnames.lib kernel32.lib user32.lib gdi32.lib winspool.lib  comdlg32.lib advapi32.lib shell32.lib ole32.lib oleaut32.lib
&gt; netapi32.lib uuid.lib wsock32.lib mpr.lib winmm.lib  version.lib odbc32.lib odbccp32.lib msvcrt.lib
&gt;     perllibs=  oldnames.lib kernel32.lib user32.lib gdi32.lib winspool.lib  comdlg32.lib advapi32.lib shell32.lib ole32.lib
&gt; oleaut32.lib  netapi32.lib uuid.lib wsock32.lib mpr.lib winmm.lib  version.lib odbc32.lib odbccp32.lib msvcrt.lib
&gt;     libc=msvcrt.lib, so=dll, useshrplib=yes, libperl=perl58.lib
&gt;     gnulibc_version=&#39;undef&#39;
&gt;   Dynamic Linking:
&gt;     dlsrc=dl_win32.xs, dlext=dll, d_dlsymun=undef, ccdlflags=&#39; &#39;
&gt;     cccdlflags=&#39; &#39;, lddlflags=&#39;-dll -nologo -nodefaultlib -debug -opt:ref,icf  -libpath:&#34;C:\Perl810\lib\CORE&#34;  -machine:x86&#39;
&gt; 
&gt; 
&gt; Characteristics of this binary &#40;from libperl&#41;:
&gt;   Compile-time options: MULTIPLICITY USE_ITHREADS USE_LARGE_FILES PERL_IMPLICIT_
&gt; CONTEXT PERL_IMPLICIT_SYS
&gt;   Locally applied patches:
&gt;         ActivePerl Build 810
&gt;         22751 Update to Test.pm 1.25
&gt;         21540 Fix backward-compatibility issues in if.pm
&gt;   Built under MSWin32
&gt;   Compiled at Jun  1 2004 11:52:21
&gt;   @INC:
&gt;     c:/Perl810/lib
&gt;     c:/Perl810/site/lib
&gt;     .
&gt; 
&gt; 
&gt; -- 
&gt; You&#39;ve received this message because you are subscribed to
&gt; the Devel::NYTProf Development User group.
&gt; 
&gt; Group hosted at:  <span class="clickylink"><a target="new" rel="nofollow" href="http://groups.google.com/group/develnytprof-dev">http://groups.google.com/group/develnytprof-dev</a></span>
&gt; Project hosted at:  <span class="clickylink"><a target="new" rel="nofollow" href="http://perl-devel-nytprof.googlecode.com">http://perl-devel-nytprof.googlecode.com</a></span>
&gt; CPAN distribution:  <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/dist/Devel-NYTProf">http://search.cpan.org/dist/Devel-NYTProf</a></span>
&gt; 
&gt; To post, email:  develnytprof-dev@googlegroups.com
&gt; To unsubscribe, email:  develnytprof-dev-unsubscribe@googlegroups.com
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;11&nbsp;22:05:23&nbsp;2010</span>
    <span class="description">jand [...] ActiveState.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &#34;&#39;Heiko via RT&#39;&#34; &lt;bug-devel-nytprof [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [develnytprof-dev: 1830] Re: [rt.cpan.org #55049] 	Devel-NYTProf-3.01_94 under Windows XP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 11 Mar 2010 19:04:47 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;develnytprof-dev [...] googlegroups.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jan Dubois&#34; &lt;jand [...] activestate.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, 11 Mar 2010, Tim Bunce wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; For Heiko&#39;s config, NYTProf is very broken without the #undefs
&gt; so I&#39;d like to get those in. Assuming your VS2003 hypothesis is correct,
&gt; is there a macro to detect that compiler? And would using that macro
&gt; to wrap the #undefs be a reasonable solution?
</div>
I&#39;ve verified my &#34;conflicting CRT version&#34; hypothesis now &#40;with VS2008&#41;.
The issue is indeed a bug in XSUB.h.  I&#39;ve added a workaround for that
in r1168.

Note that the problem is not specifically about the VS2003 compiler;
it is about mixing several different C runtime libraries.  The reason
I recommend MinGW if you don&#39;t have access to VC6 is that it is also
using MSVCRT.dll as the runtime library.  &#40;MSVCRT.dll is part of
Windows itself and not linked to a particular compiler version, which
is one of the reasons why ActivePerl continues to be compiled with
VC6&#41;.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That leaves the t/50-errno.t failures. I&#39;d be happy enough to
&gt; skip the failing tests on that system. Is there some way in perl to
&gt; detect that perl was built with VS2003 and/or the dual libraries?
&gt; If not then I could just skip the tests on windows systems with old
&gt; versions of perl, say &lt;= 5.8.9.
</div>
This is again a problem of multiple runtime libraries.  The errno
you are setting in Devel-NYTProf is not the same that any of the
redirected FILE* operations are modifying, so the whole saving/restoring
errno doesn&#39;t work in this case.  errno is not covered at all by the
Perl macro redefinition system, so I can&#39;t see a way around this.

The problem is not related to older Perl versions; it will happen
even for 5.12 once it is released.  I&#39;m also not convinced that this
problem can only happen on Windows with PERL_IMPLICIT_SYS; it should
trigger on other platforms too if they have difference C compilers
with different runtime libraries.

The best I can think of is that you add a little _set_errno&#40;&#41; function
to set errno to a specific value, and then check if this value propagates
back to Perl in the test.  Something like:

BEGIN {
    $! = 1;
    Devel::NYTProf::_set_errno&#40;2&#41;;
    return if $! == 2;
    print &#34;1..0 # skipped: module linked against different CRT than Perl itself\n&#34;;
    exit 0;
}

I&#39;ll make a note for myself to look into wrapping errno in the Perl headers
once the 5.12 code freeze is over.

Cheers,
-Jan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;12&nbsp;03:45:17&nbsp;2010</span>
    <span class="description">heiko [...] hexco.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> heiko [...] hexco.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Do 11. Mär 2010, 17:15:18, Tim.Bunce@pobox.com schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Could you post your perl -V output so we get the full details?
</div>
Summary of my perl5 &#40;revision 5 version 8 subversion 4&#41; configuration:
  Platform:
    osname=MSWin32, osvers=4.0, archname=MSWin32-x86-multi-thread
    uname=&#39;&#39;
    config_args=&#39;undef&#39;
    hint=recommended, useposix=true, d_sigaction=undef
    usethreads=undef use5005threads=undef useithreads=define 
usemultiplicity=define
    useperlio=define d_sfio=undef uselargefiles=define usesocks=undef
    use64bitint=undef use64bitall=undef uselongdouble=undef
    usemymalloc=n, bincompat5005=undef
  Compiler:
    cc=&#39;cl&#39;, ccflags =&#39;-nologo -GF -W3 -MD -Zi -DNDEBUG -O1 -DWIN32 -
D_CONSOLE -DNO_STRICT -DHAVE_DES_FCRYPT  -DNO_HASH_SEED -DPERL_IMPLICIT
_CONTEXT -DPERL_IMPLICIT_SYS -DUSE_PERLIO -DPERL_MSVCRT_READFIX&#39;,
    optimize=&#39;-MD -Zi -DNDEBUG -O1&#39;,
    cppflags=&#39;-DWIN32&#39;
    ccversion=&#39;&#39;, gccversion=&#39;&#39;, gccosandvers=&#39;&#39;
    intsize=4, longsize=4, ptrsize=4, doublesize=8, byteorder=1234
    d_longlong=undef, longlongsize=8, d_longdbl=define, longdblsize=10
    ivtype=&#39;long&#39;, ivsize=4, nvtype=&#39;double&#39;, nvsize=8, 
Off_t=&#39;__int64&#39;, lseeksize=8
    alignbytes=8, prototype=define
  Linker and Libraries:
    ld=&#39;link&#39;, ldflags =&#39;-nologo -nodefaultlib -debug -opt:ref,icf  -
libpath:&#34;Z:\WINNT\Perl\lib\CORE&#34;  -machine:x86&#39;
    libpth=Z:\PROGRA~1\MICROS~3\VC98\lib
    libs=  oldnames.lib kernel32.lib user32.lib gdi32.lib winspool.lib  
comdlg32.lib advapi32.lib shell32.lib ole32.lib oleaut32.lib  netapi
32.lib uuid.lib wsock32.lib mpr.lib winmm.lib  version.lib odbc32.lib 
odbccp32.lib msvcrt.lib
    perllibs=  oldnames.lib kernel32.lib user32.lib gdi32.lib 
winspool.lib  comdlg32.lib advapi32.lib shell32.lib ole32.lib 
oleaut32.lib  ne
tapi32.lib uuid.lib wsock32.lib mpr.lib winmm.lib  version.lib 
odbc32.lib odbccp32.lib msvcrt.lib
    libc=msvcrt.lib, so=dll, useshrplib=yes, libperl=perl58.lib
    gnulibc_version=&#39;undef&#39;
  Dynamic Linking:
    dlsrc=dl_win32.xs, dlext=dll, d_dlsymun=undef, ccdlflags=&#39; &#39;
    cccdlflags=&#39; &#39;, lddlflags=&#39;-dll -nologo -nodefaultlib -debug -
opt:ref,icf  -libpath:&#34;Z:\WINNT\Perl\lib\CORE&#34;  -machine:x86&#39;


Characteristics of this binary &#40;from libperl&#41;:
  Compile-time options: MULTIPLICITY USE_ITHREADS USE_LARGE_FILES 
PERL_IMPLICIT_CONTEXT PERL_IMPLICIT_SYS
  Locally applied patches:
        ActivePerl Build 810
        22751 Update to Test.pm 1.25
        21540 Fix backward-compatibility issues in if.pm
  Built under MSWin32
  Compiled at Jun  1 2004 11:52:21
  @INC:
    z:/WINNT/Perl/lib
    z:/WINNT/Perl/site/lib
    .
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;12&nbsp;04:00:51&nbsp;2010</span>
    <span class="description">heiko [...] hexco.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> heiko [...] hexco.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Do 11. Mär 2010, 17:39:51, jand@ActiveState.com schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Things that are still different in Heiko&#39;s setup are the compiler
&gt; version
&gt; &#40;Visual Studio 2003 I think&#41; and OS &#40;Windows XP&#41;.
</div>
Confirmed. I have multiple SDK versions installed, but VS 2003 is 
active.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ok, I have one more idea: When you compile a module with VS2003, then
&gt; that module
&gt; links against MSVCR71.dll instead of MSVCRT.dll, so you end up with 2
&gt; CRT libraries
&gt; inside a single process.  This normally works fine as long as you
&gt; don&#39;t mix things
&gt; like memory allocation &#40;call MSVCR71.free&#40;&#41; on a pointer returned by
&gt; MSVCRT.malloc&#40;&#41;&#41;
&gt; and file I/O &#40;call MSVCR71.fputs&#40;&#41; on a FILE* returned by
&gt; MSVCRT.fopen&#40;&#41;&#41; etc.
</div>
What a mess :-&#40;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; All the macro redefinitions in the Perl headers are supposed to
&gt; protect you from
&gt; these mixups, but there may be a bug somewhere.
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I don&#39;t have a VM with VS2003, and I don&#39;t know if I have a license
&gt; anywhere anymore
&gt; anyways, so it is not easy for me to test.
</div>
@Jan: what do you suggest?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;12&nbsp;04:27:47&nbsp;2010</span>
    <span class="description">heiko [...] hexco.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> heiko [...] hexco.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Is it reliably repeatable for you?
</div>
Yes, always.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; To help me narrow down the cause please try the following changes:
&gt; 
&gt; - edit t/50-errno.t to delete everything after line 31.
&gt; - change the test count from 8 to 4
&gt; - rerun to check it fails the same way
</div>fails like before.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; - rerun with each of the following changes to $ENV{NYTPROF} &#40;line 6&#41;:
&gt;   &#34;start=init:file=$nytprof_out:blocks=0:stmts=0&#34;
</div>succeeds.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#34;start=init:file=$nytprof_out:blocks=0:subs=0&#34;
</div>fails.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#34;start=init:file=$nytprof_out:blocks=0:stmts=0:subs=0&#34;
</div>succeeds.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; - also send me &#40;off-list&#41; the log from running whichever is the last 
</div>of
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;   those which fails, but with &#34;:trace=90&#34; appended to it.
</div>Done.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;12&nbsp;11:38:10&nbsp;2010</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in r1168 by Jan.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;12&nbsp;11:38:22&nbsp;2010</span>
    <span class="description">TIMB [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
