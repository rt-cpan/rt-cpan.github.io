<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #25078 for DateTime-Format-Duration: Odd malfunction of normalize&#40;&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #25078 for DateTime-Format-Duration: Odd malfunction of normalize&#40;&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DateTime-Format-Duration/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DateTime-Format-Duration/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DateTime-Format-Duration/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DateTime-Format-Duration/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DateTime-Format-Duration">DateTime-Format-Duration CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">25078</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DateTime-Format-Duration/Active/">DateTime-Format-Duration</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
TWILDE [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-9866-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.02    </td>
  </tr>
  <tr id="CF-9867-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;21&nbsp;20:43:53&nbsp;2007</span>
    <span class="description">TWILDE [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Odd malfunction of normalize&#40;&#41;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The normalize subroutine is inexplicably breaking with a very particular
pair of dates.  My relevant code looks like:

sub timeconv {
  my&#40;$expiry, $block_time&#41;  = @_;
  my $duration = $expiry - $block_time;
  use Data::Dumper;
  print Dumper \$block_time, \$expiry, \$duration;
  my $formatter = DateTime::Format::Duration-&gt;new&#40;
    pattern =&gt; &#39;%Y years, %m months, %e days, %H hours, %M minutes, %S
seconds&#39;,
    normalize =&gt; 1,
    base =&gt; $block_time,
  &#41;;
  my %normalized = $formatter-&gt;normalize&#40;$duration&#41;;
  print Dumper \%normalized;
  my @periods = &#40;&#39;years&#39;,&#39;months&#39;,&#39;days&#39;,&#39;hours&#39;,&#39;minutes&#39;,&#39;seconds&#39;&#41;;
  my $output;
  if &#40;$normalized{&#39;minutes&#39;} || $normalized{&#39;seconds&#39;}&#41; {
    $output = sprintf&#40;&#39;until %s %s &#39;, $expiry-&gt;ymd, $expiry-&gt;hms&#41;;
  } else {
    foreach &#40;@periods&#41; {
      $output .= sprintf&#40;&#39;%s %s, &#39;, $normalized{$_}, $_&#41; if $normalized{$_};
      if &#40;$normalized{$_} == 1&#41; {
        my $singular = $_;  
        $singular =~ s/s$//;
        $output =~ s/$_/$singular/;
      }
    }
    $output =~ s/, $/ /;
  }  
  return $output;
}

$expiry and $block_time are DateTime objects, in UTC.  For most cases,
this is working fine.  In one particular case, though, it breaks down. 
The output of the first Data::Dumper call in this situation looks like:

$VAR1 = \bless&#40; {
                   &#39;local_rd_secs&#39; =&gt; 5297,
                   &#39;local_rd_days&#39; =&gt; 732729,
                   &#39;rd_nanosecs&#39; =&gt; 0,
                   &#39;locale&#39; =&gt; bless&#40; {
                                        &#39;default_time_format_length&#39; =&gt;
&#39;medium&#39;,
                                        &#39;native_territory&#39; =&gt; &#39;United
States&#39;,
                                        &#39;native_language&#39; =&gt; &#39;English&#39;,
                                        &#39;real_class&#39; =&gt; &#39;en&#39;,
                                        &#39;native_complete_name&#39; =&gt;
&#39;English United States&#39;,
                                        &#39;en_language&#39; =&gt; &#39;English&#39;,
                                        &#39;default_date_format_length&#39; =&gt;
&#39;medium&#39;,
                                        &#39;id&#39; =&gt; &#39;en_US&#39;,
                                        &#39;en_territory&#39; =&gt; &#39;United States&#39;,
                                        &#39;en_complete_name&#39; =&gt; &#39;English
United States&#39;
                                      }, &#39;DateTime::Locale::en&#39; &#41;,
                   &#39;local_c&#39; =&gt; {
                                  &#39;hour&#39; =&gt; 1,
                                  &#39;second&#39; =&gt; 17,
                                  &#39;month&#39; =&gt; 2,
                                  &#39;quarter&#39; =&gt; 1,
                                  &#39;day_of_year&#39; =&gt; 53,
                                  &#39;day_of_quarter&#39; =&gt; 53,
                                  &#39;minute&#39; =&gt; 28,
                                  &#39;day&#39; =&gt; 22,
                                  &#39;day_of_week&#39; =&gt; 4,
                                  &#39;year&#39; =&gt; 2007
                                },
                   &#39;utc_rd_secs&#39; =&gt; 5297,
                   &#39;formatter&#39; =&gt; undef,
                   &#39;tz&#39; =&gt; bless&#40; {
                                    &#39;name&#39; =&gt; &#39;UTC&#39;
                                  }, &#39;DateTime::TimeZone::UTC&#39; &#41;,
                   &#39;utc_year&#39; =&gt; 2008,
                   &#39;utc_rd_days&#39; =&gt; 732729,
                   &#39;offset_modifier&#39; =&gt; 0
                 }, &#39;DateTime&#39; &#41;;
$VAR2 = \bless&#40; {
                   &#39;local_rd_secs&#39; =&gt; 5297,
                   &#39;local_rd_days&#39; =&gt; 732771,
                   &#39;rd_nanosecs&#39; =&gt; 0,
                   &#39;locale&#39; =&gt; ${$VAR1}-&gt;{&#39;locale&#39;},
                   &#39;local_c&#39; =&gt; {
                                  &#39;hour&#39; =&gt; 1,
                                  &#39;second&#39; =&gt; 17,
                                  &#39;month&#39; =&gt; 4,
                                  &#39;quarter&#39; =&gt; 2,
                                  &#39;day_of_year&#39; =&gt; 95,
                                  &#39;day_of_quarter&#39; =&gt; 5,
                                  &#39;minute&#39; =&gt; 28,
                                  &#39;day&#39; =&gt; 5,
                                  &#39;day_of_week&#39; =&gt; 4,
                                  &#39;year&#39; =&gt; 2007
                                },
                   &#39;utc_rd_secs&#39; =&gt; 5297,
                   &#39;formatter&#39; =&gt; undef,
                   &#39;tz&#39; =&gt; bless&#40; {
                                    &#39;name&#39; =&gt; &#39;UTC&#39;
                                  }, &#39;DateTime::TimeZone::UTC&#39; &#41;,
                   &#39;utc_year&#39; =&gt; 2008,
                   &#39;utc_rd_days&#39; =&gt; 732771,
                   &#39;offset_modifier&#39; =&gt; 0
                 }, &#39;DateTime&#39; &#41;;
$VAR3 = \bless&#40; {
                   &#39;seconds&#39; =&gt; 0,
                   &#39;minutes&#39; =&gt; 0,
                   &#39;end_of_month&#39; =&gt; &#39;wrap&#39;,
                   &#39;nanoseconds&#39; =&gt; 0,
                   &#39;days&#39; =&gt; 11,
                   &#39;months&#39; =&gt; 1
                 }, &#39;DateTime::Duration&#39; &#41;;

While the second outputs:

$VAR1 = {
          &#39;seconds&#39; =&gt; 0,
          &#39;hours&#39; =&gt; 0,
          &#39;years&#39; =&gt; 0,
          &#39;minutes&#39; =&gt; 0,
          &#39;months&#39; =&gt; 1,
          &#39;days&#39; =&gt; 8,
          &#39;nanoseconds&#39; =&gt; 0
        };

And the subroutine itself, using %normalized, outputs &#34;1 month 8 days&#34;.
 Something is obviously going wrong, causing DateTime::Format::Duration
to normalize 1 month 11 days to 1 month 8 days, though I can&#39;t figure
out what.  Ideas?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;21&nbsp;20:57:38&nbsp;2007</span>
    <span class="description">TWILDE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Aha.  The problem here is the order in which the math is done.  Even
though I&#39;m passing a DateTime::Duration object to normalize&#40;&#41;, the
deltas in that object are being re-added to the DateTime object to come
up with the deltas actually used.  But, when re-adding deltas like this,
order can have an impact.  Because the 1 month in the duration object is
added first, and February is a 28 day month, boom, we lose 3 days. 
Output with $formatter-&gt;{&#39;diagnostic&#39;} = 1 shows this:

Pre Normalise: $VAR1 = {
          &#39;seconds&#39; =&gt; 0,
          &#39;minutes&#39; =&gt; 0,
          &#39;nanoseconds&#39; =&gt; 0,
          &#39;days&#39; =&gt; 11,
          &#39;months&#39; =&gt; 1
        };
Adding  years: 2007-02-22T01:28:17
Adding 1 months: 2007-03-22T01:28:17
Adding 11 days: 2007-04-02T01:28:17
Adding  hours: 2007-04-02T01:28:17
Adding 0 minutes: 2007-04-02T01:28:17
Adding 0 seconds: 2007-04-02T01:28:17
Adding 0 nanoseconds: 2007-04-02T01:28:17
Post DateTime::Duration: $VAR1 = {
          &#39;seconds&#39; =&gt; 0,
          &#39;minutes&#39; =&gt; 0,
          &#39;nanoseconds&#39; =&gt; 0,
          &#39;days&#39; =&gt; 8,
          &#39;months&#39; =&gt; 1
        };

Adding the days first, then the months, would do the trick in this case,
though I don&#39;t know if it would work in the general case.  Actually, the
best fix would probably be to entirely reverse the order in which
additions are done, starting from nanoseconds and working up to years.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;21&nbsp;20:57:40&nbsp;2007</span>
    <span class="description">TWILDE [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;21&nbsp;21:41:00&nbsp;2007</span>
    <span class="description">TWILDE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Per the documentation for DateTime, addition and subtraction is always
done in this order:

days, months, minutes, seconds, nanoseconds

It is unclear how this translates out to years and hours.  My suspicion
is that they are internally converted into months and minutes,
respectively.  I don&#39;t see any downside to simply reversing the order in
which delta items are passed to -&gt;add&#40;&#41; in the foreach loop:

        # Can&#39;t just add the hash as -&gt;add&#40;%delta&#41; because of mixed
positivity:
        foreach &#40;qw/years months days hours minutes seconds nanoseconds/&#41; { 
                $end-&gt;add&#40; $_ =&gt; $delta{$_}||0 &#41;;
                print &#34;Adding $delta{$_} $_: &#34; . $end-&gt;datetime . &#34;\n&#34;
if $self-&gt;{diagnostic}; 
        }

Becomes:

        # Can&#39;t just add the hash as -&gt;add&#40;%delta&#41; because of mixed
positivity:
        foreach &#40;qw/nanoseconds seconds minutes hours days months years/&#41; { 
                $end-&gt;add&#40; $_ =&gt; $delta{$_}||0 &#41;;
                print &#34;Adding $delta{$_} $_: &#34; . $end-&gt;datetime . &#34;\n&#34;
if $self-&gt;{diagnostic}; 
        }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;21&nbsp;21:57:12&nbsp;2007</span>
    <span class="description">TWILDE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Last time I&#39;ll reply - I&#39;ve tested this change with all of my major test
cases for my application, and it appears to do the right thing in all of
them, including the one that broke originally.  I&#39;ve attached a one-line
patch.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Duration.pm.orig	Wed Feb 21 21:42:04 2007
+++ Duration.pm	Wed Feb 21 21:42:35 2007
@@ -263,7 +263,7 @@
 	my $start = $self-&gt;base;
 	my $end   = $self-&gt;base-&gt;clone;
 	# Can&#39;t just add the hash as -&gt;add&#40;%delta&#41; because of mixed positivity:
-	foreach &#40;qw/years months days hours minutes seconds nanoseconds/&#41; { 
+	foreach &#40;qw/nanoseconds seconds minutes hours days months years/&#41; { 
 		$end-&gt;add&#40; $_ =&gt; $delta{$_}||0 &#41;;
 	 	print &#34;Adding $delta{$_} $_: &#34; . $end-&gt;datetime . &#34;\n&#34; if $self-&gt;{diagnostic}; 
 	}</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;21&nbsp;21:59:12&nbsp;2007</span>
    <span class="description">TWILDE [...] cpan.org -  Severity Normal added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;21&nbsp;21:59:13&nbsp;2007</span>
    <span class="description">TWILDE [...] cpan.org -  Broken in 1.02 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
