<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #77746 for DBM-Deep: Cannot delete DBM::Deep file after copying inner key &#40;ref count issue?&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #77746 for DBM-Deep: Cannot delete DBM::Deep file after copying inner key &#40;ref count issue?&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBM-Deep/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBM-Deep/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBM-Deep/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBM-Deep/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBM-Deep">DBM-Deep CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">77746</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBM-Deep/Active/">DBM-Deep</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
RFREIMUTH [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-10808-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.0015    </td>
  </tr>
  <tr id="CF-10809-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;10&nbsp;22:22:46&nbsp;2012</span>
    <span class="description">RFREIMUTH [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Cannot delete DBM::Deep file after copying inner key &#40;ref count
 issue?&#41;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Cross-posted from <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=974578">http://www.perlmonks.org/?node_id=974578</a></span>...

I stumbled across a bug in my code that I tracked down to something I am
doing with a DBM::Deep file. When I assign the inner key of a DBM
hash-of-hrefs to another variable and then try to delete the file, I get
an error when the inner key is a href but not when it is a non-ref scalar.

use strict;
use warnings;

use DBM::Deep;

my $db_file = &#39;href_nocopy&#39;;

{
    my $db = DBM::Deep-&gt;new&#40; $db_file &#41;;
    $db-&gt;{key} = {};
}

print &#34;\nDeleting $db_file\n&#34;;
unlink&#40; $db_file &#41; || warn $!;  # succeeds

$db_file = &#39;href_copy&#39;;

{
    my $db = DBM::Deep-&gt;new&#40; $db_file &#41;;
    $db-&gt;{key} = {};
    my $db2 = $db-&gt;{key};
}

print &#34;\nDeleting $db_file\n&#34;;
unlink&#40; $db_file &#41; || warn $!;  # fails &#40;permission denied&#41;

$db_file = &#39;nonref_copy&#39;;

{
    my $db = DBM::Deep-&gt;new&#40; $db_file &#41;;
    $db-&gt;{key} = 1;
    my $db2 = $db-&gt;{key};
}

print &#34;\nDeleting $db_file\n&#34;;
unlink&#40; $db_file &#41; || warn $!; # succeeds

Any ideas? I didn&#39;t find any documentation about this elsewhere. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;11&nbsp;01:56:25&nbsp;2012</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Jun 10 22:22:46 2012, RFREIMUTH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $db_file = &#39;href_copy&#39;;
&gt; 
&gt; {
&gt;     my $db = DBM::Deep-&gt;new&#40; $db_file &#41;;
&gt;     $db-&gt;{key} = {};
&gt;     my $db2 = $db-&gt;{key};
&gt; }
&gt; 
&gt; print &#34;\nDeleting $db_file\n&#34;;
&gt; unlink&#40; $db_file &#41; || warn $!;  # fails &#40;permission denied&#41;
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Any ideas? I didn&#39;t find any documentation about this elsewhere. 
</div>
That sounds like a circular reference.  Those are hard to track down, but I’ll try if I have time.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;11&nbsp;01:56:27&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;12&nbsp;12:36:47&nbsp;2012</span>
    <span class="description">rrfreimuth2 [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #77746] Cannot delete DBM::Deep file after copying inner key &#40;ref count issue?&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 12 Jun 2012 09:36:37 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBM-Deep [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Robert Freimuth &lt;rrfreimuth2 [...] yahoo.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I&#39;m not sure that it&#39;s circular, as  $db never points to $db2 &#40;but it wouldn&#39;t surprise me if ref-counting is somehow involved&#41;.  I&#39;m just using $db2 as a shortcut into a deeper level of the $db structure.

Thanks for taking the time to look into this.

Bob



--- On Mon, 6/11/12, Father Chrysostomos via RT &lt;bug-DBM-Deep@rt.cpan.org&gt; wrote:

From: Father Chrysostomos via RT &lt;bug-DBM-Deep@rt.cpan.org&gt;
Subject: [rt.cpan.org #77746] Cannot delete DBM::Deep file after copying inner key &#40;ref count issue?&#41;
To: RFREIMUTH@cpan.org
Date: Monday, June 11, 2012, 12:56 AM

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=77746">https://rt.cpan.org/Ticket/Display.html?id=77746</a></span> &gt;

On Sun Jun 10 22:22:46 2012, RFREIMUTH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $db_file = &#39;href_copy&#39;;
&gt; 
&gt; {
&gt;     my $db = DBM::Deep-&gt;new&#40; $db_file &#41;;
&gt;     $db-&gt;{key} = {};
&gt;     my $db2 = $db-&gt;{key};
&gt; }
&gt; 
&gt; print &#34;\nDeleting $db_file\n&#34;;
&gt; unlink&#40; $db_file &#41; || warn $!;  # fails &#40;permission denied&#41;
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Any ideas? I didn&#39;t find any documentation about this elsewhere. 
</div>
That sounds like a circular reference.  Those are hard to track down, but I’ll try if I have time.
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;15&nbsp;11:32:11&nbsp;2012</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jun 12 12:36:47 2012, rrfreimuth2@yahoo.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; I&#39;m not sure that it&#39;s circular, as  $db never points to $db2 &#40;but it
&gt; wouldn&#39;t surprise me if ref-counting is somehow involved&#41;.  I&#39;m just
&gt; using $db2 as a shortcut into a deeper level of the $db structure.
&gt; 
&gt; Thanks for taking the time to look into this.
</div>
Devel::FindRef to the rescue!

Here is a variation of your script, with the output below.  Notice that $db2 is still set even 
after weakening.

use strict;
use warnings;

use DBM::Deep;
use Scalar::Util &#39;weaken&#39;;

my $db_file = &#39;href_nocopy&#39;;

{
    my $db = DBM::Deep-&gt;new&#40; $db_file &#41;;
    $db-&gt;{key} = {};

    weaken $db;
    warn $db;
}

$db_file = &#39;href_copy&#39;;

{
    my $db = DBM::Deep-&gt;new&#40; $db_file &#41;;
    $db-&gt;{key} = {};
    my $db2 = $db-&gt;{key};

    weaken $db;
    weaken $db2;
    warn $db;
    warn $db2;

    if &#40;$db2&#41; {
        use Devel::FindRef;
        print Devel&#39;FindRef&#39;track $db2;
    }
}
__END__
Use of uninitialized value $db in warn at - line 14.
Warning: something&#39;s wrong at - line 14.
Use of uninitialized value $db in warn at - line 26.
Warning: something&#39;s wrong at - line 26.
DBM::Deep::Hash=HASH&#40;0x33d9f0&#41; at - line 27.
DBM::Deep::Hash=HASH&#40;0x33d9f0&#41; [refcount 3] is
+- referenced by REF&#40;0x8515f0&#41; [refcount 1], which is
|  a temporary on the stack.
+- referenced by REF&#40;0x8038d0&#41; [refcount 1], which is
   the member &#39;0&#39; of HASH&#40;0x881f80&#41; [refcount 1], which is
      referenced by REF&#40;0x8517c0&#41; [refcount 1], which is
         the member &#39;609&#39; of HASH&#40;0x88c160&#41; [refcount 1], which is
            referenced by REF&#40;0x88c150&#41; [refcount 1], which is
               the member &#39;cache&#39; of DBM::Deep::Engine::File=HASH&#40;0x87dec0&#41; [refcount 1], which 
is
                  referenced by REF&#40;0x88c1b0&#41; [refcount 1], which is
                     the member &#39;engine&#39; of DBM::Deep::Hash=HASH&#40;0x88c0f0&#41; [refcount 2], which is
                        referenced by REF&#40;0x88c1e0&#41; [refcount 1], which is
                           referenced &#40;in mg_obj&#41; by &#39;P&#39; type magic attached to 
DBM::Deep::Hash=HASH&#40;0x33d9f0&#41; [refcount 3], which is
                                 not referenced within the search depth.

I don’t have time to write tests for it right now, but I believe the attached patch will fix it.  
Does it work for you?  If so, I will put it in the next release, maybe in a couple of days.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; --- On Mon, 6/11/12, Father Chrysostomos via RT &lt;bug-DBM-
&gt; Deep@rt.cpan.org&gt; wrote:
&gt; 
&gt; From: Father Chrysostomos via RT &lt;bug-DBM-Deep@rt.cpan.org&gt;
&gt; Subject: [rt.cpan.org #77746] Cannot delete DBM::Deep file after
&gt; copying inner key &#40;ref count issue?&#41;
&gt; To: RFREIMUTH@cpan.org
&gt; Date: Monday, June 11, 2012, 12:56 AM
&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=77746">https://rt.cpan.org/Ticket/Display.html?id=77746</a></span> &gt;
&gt; 
&gt; On Sun Jun 10 22:22:46 2012, RFREIMUTH wrote:
<div class="message-stanza open">&gt; &gt; $db_file = &#39;href_copy&#39;;
&gt; &gt;
&gt; &gt; {
&gt; &gt;     my $db = DBM::Deep-&gt;new&#40; $db_file &#41;;
&gt; &gt;     $db-&gt;{key} = {};
&gt; &gt;     my $db2 = $db-&gt;{key};
&gt; &gt; }
&gt; &gt;
&gt; &gt; print &#34;\nDeleting $db_file\n&#34;;
&gt; &gt; unlink&#40; $db_file &#41; || warn $!;  # fails &#40;permission denied&#41;
</div>&gt; 
<div class="message-stanza open">&gt; &gt; Any ideas? I didn&#39;t find any documentation about this elsewhere.
</div>&gt; 
&gt; That sounds like a circular reference.  Those are hard to track down,
&gt; but I’ll try if I have time.
&gt; 
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> open_RSWprf3A.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/lib/DBM/Deep/Sector/File/Reference.pm b/lib/DBM/Deep/Sector/File/Reference.pm
index 9b8cd5d..1e50bab 100644
--- a/lib/DBM/Deep/Sector/File/Reference.pm
+++ b/lib/DBM/Deep/Sector/File/Reference.pm
@@ -423,9 +423,7 @@ sub data {
         }&#41;;
 
         $$cache_entry{ $trans_id } = $obj;
-        if&#40;$engine-&gt;{external_refs}&#41; {
-            Scalar::Util::weaken&#40;$$cache_entry{ $trans_id }&#41;;
-        }
+        Scalar::Util::weaken&#40;$$cache_entry{ $trans_id }&#41;;
     }
     else {
         $obj = $$cache_entry{ $trans_id };
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;15&nbsp;11:34:39&nbsp;2012</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jun 15 11:32:11 2012, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Jun 12 12:36:47 2012, rrfreimuth2@yahoo.com wrote:
<div class="message-stanza open">&gt; &gt; Hi,
&gt; &gt;
&gt; &gt; I&#39;m not sure that it&#39;s circular, as  $db never points to $db2 &#40;but
</div>&gt; it
<div class="message-stanza open">&gt; &gt; wouldn&#39;t surprise me if ref-counting is somehow involved&#41;.  I&#39;m just
&gt; &gt; using $db2 as a shortcut into a deeper level of the $db structure.
&gt; &gt;
&gt; &gt; Thanks for taking the time to look into this.
</div>&gt; 
&gt; Devel::FindRef to the rescue!
&gt; 
&gt; Here is a variation of your script, with the output below.  Notice
&gt; that $db2 is still set even
&gt; after weakening.
</div>
I forgot to mention: The circular reference is inside DBM::Deep itself.  Since $db{key} == 
$db{key} must return true for sanity’s sake, the Perl hash that is created when the database 
hash is read is cached, so the same Perl hash can be returned each time.  Since the hash is 
linked to the database, it references the database engine, in whose cache it resides.  So that’s 
where the circular reference is.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;17&nbsp;16:11:50&nbsp;2012</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I’ve just uploaded DBM::Deep 2.0008 with a fix for this.

See also: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/robkinyon/dbm-deep/commit/d669a3211">https://github.com/robkinyon/dbm-deep/commit/d669a3211</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;17&nbsp;16:12:00&nbsp;2012</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;30&nbsp;03:05:14&nbsp;2012</span>
    <span class="description">rrfreimuth2 [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #77746] Cannot delete DBM::Deep file after copying inner key &#40;ref count issue?&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 30 Nov 2012 00:05:03 -0800 &#40;PST&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBM-Deep [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Robert Freimuth &lt;rrfreimuth2 [...] yahoo.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">THANK YOU!!

--- On Sun, 6/17/12, Father Chrysostomos via RT &lt;bug-DBM-Deep@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; From: Father Chrysostomos via RT &lt;bug-DBM-Deep@rt.cpan.org&gt;
&gt; Subject: [rt.cpan.org #77746] Cannot delete DBM::Deep file after copying inner key &#40;ref count issue?&#41;
&gt; To: RFREIMUTH@cpan.org
&gt; Date: Sunday, June 17, 2012, 3:11 PM
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=77746">https://rt.cpan.org/Ticket/Display.html?id=77746</a></span> &gt;
&gt; 
&gt; I’ve just uploaded DBM::Deep 2.0008 with a fix for this.
&gt; 
&gt; See also: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/robkinyon/dbm-deep/commit/d669a3211">https://github.com/robkinyon/dbm-deep/commit/d669a3211</a></span>
&gt; 
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;30&nbsp;03:05:15&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;30&nbsp;11:58:14&nbsp;2012</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
