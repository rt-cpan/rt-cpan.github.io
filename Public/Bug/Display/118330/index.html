<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #118330 for Crypt-OpenSSL-ECDSA: Cannot build against OpenSSL 1.1.0b</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #118330 for Crypt-OpenSSL-ECDSA: Cannot build against OpenSSL 1.1.0b</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Crypt-OpenSSL-ECDSA/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Crypt-OpenSSL-ECDSA/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Crypt-OpenSSL-ECDSA/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Crypt-OpenSSL-ECDSA/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Crypt-OpenSSL-ECDSA">Crypt-OpenSSL-ECDSA CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">118330</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Crypt-OpenSSL-ECDSA/Active/">Crypt-OpenSSL-ECDSA</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ppisar [...] redhat.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-258378-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.08    </td>
  </tr>
  <tr id="CF-258379-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;11&nbsp;07:36:17&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Cannot build against OpenSSL 1.1.0b</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">After upgrading OpenSSL to 1.1.0b Crypt-OpenSSL-ECDSA cannot be built:

gcc -c  -I. -I/usr/include -D_REENTRANT -D_GNU_SOURCE -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fwrapv -fno-strict-aliasing -I/usr/local/include -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic   -DVERSION=\&#34;0.08\&#34; -DXS_VERSION=\&#34;0.08\&#34; -fPIC &#34;-I/usr/lib64/perl5/CORE&#34;  -DPERL5 -DOPENSSL_NO_KRB5 ECDSA.c
ECDSA.c: In function &#39;XS_Crypt__OpenSSL__ECDSA_ECDSA_OpenSSL&#39;:
ECDSA.c:399:8: error: unknown type name &#39;ECDSA_METHOD&#39;
  const ECDSA_METHOD * RETVAL;
        ^~~~~~~~~~~~

and plenty of other warnings. OpenSSL 1.1.0 changed API.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;11&nbsp;08:20:11&nbsp;2016</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #118330] Cannot build against OpenSSL 1.1.0b</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 11 Oct 2016 14:19:52 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Crypt-OpenSSL-ECDSA [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks

I won&#39;t be able to look at this until next week


Sent from my iPhone

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 11 Oct 2016, at 1:36 PM, Petr Pisar via RT &lt;bug-Crypt-OpenSSL-ECDSA@rt.cpan.org&gt; wrote:
&gt; 
&gt; Tue Oct 11 07:36:17 2016: Request 118330 was acted upon.
&gt; Transaction: Ticket created by ppisar
&gt;       Queue: Crypt-OpenSSL-ECDSA
&gt;     Subject: Cannot build against OpenSSL 1.1.0b
&gt;   Broken in: 0.08
&gt;    Severity: &#40;no value&#41;
&gt;       Owner: Nobody
&gt;  Requestors: ppisar@redhat.com
&gt;      Status: new
&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=118330">https://rt.cpan.org/Ticket/Display.html?id=118330</a></span> &gt;
&gt; 
&gt; 
&gt; After upgrading OpenSSL to 1.1.0b Crypt-OpenSSL-ECDSA cannot be built:
&gt; 
&gt; gcc -c  -I. -I/usr/include -D_REENTRANT -D_GNU_SOURCE -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fwrapv -fno-strict-aliasing -I/usr/local/include -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic   -DVERSION=\&#34;0.08\&#34; -DXS_VERSION=\&#34;0.08\&#34; -fPIC &#34;-I/usr/lib64/perl5/CORE&#34;  -DPERL5 -DOPENSSL_NO_KRB5 ECDSA.c
&gt; ECDSA.c: In function &#39;XS_Crypt__OpenSSL__ECDSA_ECDSA_OpenSSL&#39;:
&gt; ECDSA.c:399:8: error: unknown type name &#39;ECDSA_METHOD&#39;
&gt;  const ECDSA_METHOD * RETVAL;
&gt;        ^~~~~~~~~~~~
&gt; 
&gt; and plenty of other warnings. OpenSSL 1.1.0 changed API.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;11&nbsp;08:20:12&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;11&nbsp;12:10:13&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Út 11.říj.2016 07:36:17, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; After upgrading OpenSSL to 1.1.0b Crypt-OpenSSL-ECDSA cannot be built:
&gt; 
</div>So far, I have the attached patch that works with the old OpenSSL, but crashes with the new one. Probably because I have still Crypt::OpenSSL::EC linked to the old OpenSSL and the two could be ABI-incompatible or mix their implementations.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Port-to-OpenSSL-1.1.0.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 7a707a2bb0b0c6de1eb98cef74a5d1016f0e8c9a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Tue, 11 Oct 2016 16:15:43 +0200
Subject: [PATCH] Port to OpenSSL 1.1.0
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

OpenSSL 1.1.0 hid ECDSA structure internals and provided methods
instead.

This patch uses the methods and provides their copies in the case of
older OpenSSL. Because the new OpenSSL API, ECDSA_SIG_set0&#40;&#41;, cannot
set curve parameters individually and ECDSA_SIG_get0&#40;&#41; returns yet
another reference, it&#39;s necessary to duplicate the other unchanged
paramater when calling set_r&#40;&#41; or set_s&#40;&#41;.

This patch also stops exporting ECDSA_METHOD functions that were
removed from the new OpenSSL.

CPAN RT#118330

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 ECDSA.xs | 78 ++++++++++++++++++++++++++++++++++++++++++++++++++--------------
 1 file changed, 61 insertions&#40;+&#41;, 17 deletions&#40;-&#41;

diff --git a/ECDSA.xs b/ECDSA.xs
index 4016368..648303e 100644
--- a/ECDSA.xs
+++ b/ECDSA.xs
@@ -7,9 +7,34 @@
 
 #include &lt;openssl/ecdsa.h&gt;
 #include &lt;openssl/err.h&gt;
+#include &lt;openssl/bn.h&gt;
 
 #include &#34;const-c.inc&#34;
 
+
+#if OPENSSL_VERSION_NUMBER &gt;= 0x10100000L
+#include &lt;openssl/ec.h&gt;
+#else
+static void ECDSA_SIG_get0&#40;const ECDSA_SIG *sig, const BIGNUM **pr,
+    const BIGNUM **ps&#41; {
+    if &#40;pr != NULL&#41;
+        *pr = sig-&gt;r;
+    if &#40;ps != NULL&#41;
+        *ps = sig-&gt;s;
+}
+
+static int ECDSA_SIG_set0&#40;ECDSA_SIG *sig, BIGNUM *r, BIGNUM *s&#41;
+{
+    if &#40;r == NULL || s == NULL&#41;
+        return 0;
+    BN_clear_free&#40;sig-&gt;r&#41;;
+    BN_clear_free&#40;sig-&gt;s&#41;;
+    sig-&gt;r = r;
+    sig-&gt;s = s;
+    return 1;
+}
+#endif
+
 MODULE = Crypt::OpenSSL::ECDSA		PACKAGE = Crypt::OpenSSL::ECDSA
 
 PROTOTYPES: ENABLE
@@ -17,7 +42,9 @@ INCLUDE: const-xs.inc
 
 BOOT:
     ERR_load_crypto_strings&#40;&#41;;
+#if OPENSSL_VERSION_NUMBER &gt;= 0x10002000L &#38;&#38; OPENSSL_VERSION_NUMBER &lt; 0x10100000L
     ERR_load_ECDSA_strings&#40;&#41;;
+#endif
 
 #ECDSA_SIG *
 #ECDSA_SIG_new&#40;&#41;
@@ -61,10 +88,16 @@ ECDSA_do_verify&#40;const unsigned char *dgst, const ECDSA_SIG *sig, EC_KEY* eckey&#41;;
 	OUTPUT:
 		RETVAL
 
-# These ECDSA_METHOD functions only became available in 1.0.2
+# These ECDSA_METHOD functions only became available in 1.0.2,
+# but some of them removed again in 1.1.0.
 
 #if OPENSSL_VERSION_NUMBER &gt;= 0x10002000L
 
+int	  
+ECDSA_size&#40;const EC_KEY *eckey&#41;
+
+#if OPENSSL_VERSION_NUMBER &lt; 0x10100000L
+
 const ECDSA_METHOD *
 ECDSA_OpenSSL&#40;&#41;
 
@@ -77,9 +110,6 @@ ECDSA_get_default_method&#40;&#41;
 int 	  
 ECDSA_set_method&#40;EC_KEY *eckey, const ECDSA_METHOD *meth&#41;
 
-int	  
-ECDSA_size&#40;const EC_KEY *eckey&#41;
-
 ECDSA_METHOD *
 ECDSA_METHOD_new&#40;ECDSA_METHOD *ecdsa_method=0&#41;
 
@@ -95,7 +125,7 @@ ECDSA_METHOD_set_name&#40;ECDSA_METHOD *ecdsa_method, char *name&#41;
 void 
 ERR_load_ECDSA_strings&#40;&#41;
 
-
+#endif
 #endif
 
 
@@ -135,11 +165,13 @@ SV *
 get_r&#40;ecdsa_sig&#41;
         ECDSA_SIG *ecdsa_sig
     PREINIT:
+        const BIGNUM *r;
         unsigned char *to;
         STRLEN len;
     CODE:
         to = malloc&#40;sizeof&#40;char&#41; * 128&#41;;
-        len = BN_bn2bin&#40;ecdsa_sig-&gt;r, to&#41;;
+        ECDSA_SIG_get0&#40;ecdsa_sig, &#38;r, NULL&#41;;
+        len = BN_bn2bin&#40;r, to&#41;;
         RETVAL = newSVpvn&#40;&#40;const char*&#41;to, len&#41;;
         free&#40;to&#41;;
     OUTPUT:
@@ -149,11 +181,13 @@ SV *
 get_s&#40;ecdsa_sig&#41;
         ECDSA_SIG *ecdsa_sig
     PREINIT:
+        const BIGNUM *s;
         unsigned char *to;
         STRLEN len;
     CODE:
         to = malloc&#40;sizeof&#40;char&#41; * 128&#41;;
-        len = BN_bn2bin&#40;ecdsa_sig-&gt;s, to&#41;;
+        ECDSA_SIG_get0&#40;ecdsa_sig, NULL, &#38;s&#41;;
+        len = BN_bn2bin&#40;s, to&#41;;
         RETVAL = newSVpvn&#40;&#40;const char*&#41;to, len&#41;;
         free&#40;to&#41;;
     OUTPUT:
@@ -164,26 +198,36 @@ set_r&#40;ecdsa_sig, r_SV&#41;
         ECDSA_SIG *ecdsa_sig
         SV * r_SV
     PREINIT:
-	char *s;
+	    char *string;
         STRLEN len;
+        BIGNUM *r;
+        BIGNUM *s;
     CODE:
-        s = SvPV&#40;r_SV, len&#41;;
-        if &#40;ecdsa_sig-&gt;r&#41;
-            BN_free&#40;ecdsa_sig-&gt;r&#41;;
-        ecdsa_sig-&gt;r = BN_bin2bn&#40;&#40;const unsigned char *&#41;s, len, NULL&#41;;
+        string = SvPV&#40;r_SV, len&#41;;
+        r = BN_bin2bn&#40;&#40;const unsigned char *&#41;string, len, NULL&#41;;
+        ECDSA_SIG_get0&#40;ecdsa_sig, NULL, &#40;const BIGNUM**&#41;&#38;s&#41;;
+        s = BN_dup&#40;s&#41;;
+        if &#40;NULL == s&#41;
+            croak&#40;&#34;Could not duplicate unchanged ECDSA paramater&#34;&#41;;
+        ECDSA_SIG_set0&#40;ecdsa_sig, r, s&#41;;
 
 void
 set_s&#40;ecdsa_sig, s_SV&#41;
         ECDSA_SIG *ecdsa_sig
         SV * s_SV
     PREINIT:
-	char *s;
+	    char *string;
         STRLEN len;
+        BIGNUM *r;
+        BIGNUM *s;
     CODE:
-        s = SvPV&#40;s_SV, len&#41;;
-        if &#40;ecdsa_sig-&gt;s&#41;
-            BN_free&#40;ecdsa_sig-&gt;s&#41;;
-        ecdsa_sig-&gt;s = BN_bin2bn&#40;&#40;const unsigned char *&#41;s, len, NULL&#41;;
+        string = SvPV&#40;s_SV, len&#41;;
+        s = BN_bin2bn&#40;&#40;const unsigned char *&#41;string, len, NULL&#41;;
+        ECDSA_SIG_get0&#40;ecdsa_sig, &#40;const BIGNUM**&#41;&#38;r, NULL&#41;;
+        r = BN_dup&#40;r&#41;;
+        if &#40;NULL == r&#41;
+            croak&#40;&#34;Could not duplicate unchanged ECDSA paramater&#34;&#41;;
+        ECDSA_SIG_set0&#40;ecdsa_sig, r, s&#41;;
 
 
 
-- 
2.7.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;11&nbsp;12:27:14&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Út 11.říj.2016 12:10:13, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne Út 11.říj.2016 07:36:17, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; After upgrading OpenSSL to 1.1.0b Crypt-OpenSSL-ECDSA cannot be
&gt; &gt; built:
&gt; &gt;
</div>&gt; So far, I have the attached patch that works with the old OpenSSL, but
&gt; crashes with the new one. Probably because I have still
&gt; Crypt::OpenSSL::EC linked to the old OpenSSL and the two could be ABI-
&gt; incompatible or mix their implementations.
</div>
After rebuilding Crypt-OpenSSL-Bignum and Crypt-OpenSSL-EC the tests pass without a crash.

The only remaining issue are the ECDSA_METHOD tests that are skipped now. Detailed OpenSSL 1.1.0 changelog &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://www.openssl.org/news/cl110.txt">https://www.openssl.org/news/cl110.txt</a></span>&gt; reads:

  *&#41; New EC_KEY_METHOD, this replaces the older ECDSA_METHOD and ECDH_METHOD
     and integrates ECDSA and ECDH functionality into EC. Implementations can
     now redirect key generation and no longer need to convert to or from
     ECDSA_SIG format.

     Note: the ecdsa.h and ecdh.h headers are now no longer needed and just
     include the ec.h header file instead.
 
I think the Perl ECDSA_METHOD functions could me moved to Crypt-OpenSSL-EC.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;19&nbsp;21:38:48&nbsp;2016</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #118330] Cannot build against OpenSSL 1.1.0b</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 20 Oct 2016 11:38:35 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Crypt-OpenSSL-ECDSA [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the report.

Are you able to provide a patch for any fix you need?

Cheers.

On Tuesday, October 11, 2016 12:27:14 PM Petr Pisar via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Crypt-OpenSSL-ECDSA
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=118330">https://rt.cpan.org/Ticket/Display.html?id=118330</a></span> &gt;
&gt; 
&gt; Dne Út 11.říj.2016 12:10:13, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; Dne Út 11.říj.2016 07:36:17, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; &gt; After upgrading OpenSSL to 1.1.0b Crypt-OpenSSL-ECDSA cannot be
</div>&gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; built:
</div>&gt; &gt; So far, I have the attached patch that works with the old OpenSSL, but
&gt; &gt; crashes with the new one. Probably because I have still
&gt; &gt; Crypt::OpenSSL::EC linked to the old OpenSSL and the two could be ABI-
&gt; &gt; incompatible or mix their implementations.
</div>&gt; 
&gt; After rebuilding Crypt-OpenSSL-Bignum and Crypt-OpenSSL-EC the tests pass
&gt; without a crash.
&gt; 
&gt; The only remaining issue are the ECDSA_METHOD tests that are skipped now.
&gt; Detailed OpenSSL 1.1.0 changelog &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://www.openssl.org/news/cl110.txt">https://www.openssl.org/news/cl110.txt</a></span>&gt;
&gt; reads:
&gt; 
&gt;   *&#41; New EC_KEY_METHOD, this replaces the older ECDSA_METHOD and ECDH_METHOD
&gt; and integrates ECDSA and ECDH functionality into EC. Implementations can
&gt; now redirect key generation and no longer need to convert to or from
&gt; ECDSA_SIG format.
&gt; 
&gt;      Note: the ecdsa.h and ecdh.h headers are now no longer needed and just
&gt;      include the ec.h header file instead.
&gt; 
&gt; I think the Perl ECDSA_METHOD functions could me moved to Crypt-OpenSSL-EC.
</div>
-- 
Mike McCauley           VK4AMM                   mikem@airspayce.com
Airspayce Pty Ltd 9 Bulbul Place Currumbin Waters QLD 4223 Australia   
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.airspayce.com">http://www.airspayce.com</a></span>
Phone +61 7 5598-7474
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;20&nbsp;07:27:37&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #118330] Cannot build against OpenSSL 1.1.0b</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 20 Oct 2016 13:27:20 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Mike McCauley via RT &lt;bug-Crypt-OpenSSL-ECDSA [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Petr Pisar &lt;ppisar [...] redhat.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Oct 19, 2016 at 09:38:49PM -0400, Mike McCauley via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Are you able to provide a patch for any fix you need?
&gt; 
</div>Yes. The patch I sent was supposed to fix building against the new OpenSSL
including preserving the set_r&#40;&#41; and set_s&#40;&#41; Perl methods.

I received failed test results from Net-DNS-SEC today and that showed I had
a bug in the patch I&#39;d already sent. The problem was with calling set_r&#40;&#41; and
set_s&#40;&#41; on an empty object. I corrected it, added a test and a new patch is
attached.

Regarding the unsupported ECDSA_METHOD, I&#39;m not wery much interested in it.
And actually current code treat it as an optional feature that was not
available before OpenSSL 1.0.2. So it think it&#39;s not a big harm unsupporting
it with OpenSSL 1.1.0.

-- Petr
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
