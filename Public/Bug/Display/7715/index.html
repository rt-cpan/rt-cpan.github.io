<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #7715 for Class-DBI: Class::DBI does not correctly quote column names &#40;Pg, maybe others&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #7715 for Class-DBI: Class::DBI does not correctly quote column names &#40;Pg, maybe others&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Class-DBI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Class-DBI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Class-DBI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Class-DBI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Class-DBI">Class-DBI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">7715</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Class-DBI/Active/">Class-DBI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
apeiron [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-6690-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-6691-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




class1<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/111971/22700/class1">
Mon Sep 20 17:56:25 2004 (803b) by enrico.scholz [...] informatik.tu-chemnitz.de
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;20&nbsp;17:56:25&nbsp;2004</span>
    <span class="description">apeiron [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Class::DBI does not correctly quote column names &#40;Pg, maybe others&#41;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">When attempting to use a table which contains a reserved name as a 
column name, Class::DBI does not properly quote the column name when 
issuing SQL requests. The attached script provides this output when 
run against such a table: 
 
Can&#39;t insert new main: DBD::Pg::st execute failed: ERROR:  syntax 
error at or near &#34;user&#34; at character 168 [for Statement &#34;INSERT INTO 
users &#40;ulbandwidth, password, dlbandwidth, uid, user, gid, dir&#41; 
VALUES &#40;?, ?, ?, ?, ?, ?, ?&#41; 
&#34;] 
at /usr/home/apeiron/software/perl/lib/site_perl/5.9.1/DBIx/ContextualFetch.pm 
line 51. 
        Class::DBI::_croak&#40;&#39;main=HASH&#40;0x83f3e7c&#41;&#39;, &#39;Can\&#39;t insert new 
main: DBD::Pg::st execute failed: ERROR:  s...&#39;, &#39;err&#39;, &#39;DBD::Pg::st 
execute failed: ERROR:  syntax error at or near &#34;...&#39;, &#39;method&#39;, 
&#39;create&#39;&#41; called 
at /usr/home/apeiron/software/perl/lib/site_perl/5.9.1/Class/DBI.pm 
line 644 
        Class::DBI::_insert_row&#40;&#39;main=HASH&#40;0x83f3e7c&#41;&#39;, 
&#39;HASH&#40;0x83f3f78&#41;&#39;&#41; called 
at /usr/home/apeiron/software/perl/lib/site_perl/5.9.1/Class/DBI.pm 
line 590 
        Class::DBI::_create&#40;&#39;main&#39;, &#39;HASH&#40;0x83e8658&#41;&#39;&#41; called 
at /usr/home/apeiron/software/perl/lib/site_perl/5.9.1/Class/DBI.pm 
line 470 
        Class::DBI::create&#40;&#39;main&#39;, &#39;HASH&#40;0x83e8484&#41;&#39;&#41; called at class1 
line 13 
 
 
This works if I use straight DBI, Alzabo, or the psql command-line 
utility. It also works for my FTP server which uses this database to 
authenticate users. So, obviously, the problem lies somewhere in 
between Class::DBI and DBI. I&#39;ve tried every single quote permutation 
of which I can think to try to solve this issue; cf. 
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/index.pl?node_id=392477">http://www.perlmonks.org/index.pl?node_id=392477</a></span> for further 
discussion. 
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/111971/22700/class1">Download class1</a><br />
<span class="downloadcontenttype">application/x-perl 803b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;21&nbsp;04:13:43&nbsp;2004</span>
    <span class="description">tony [...] kasei.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 21 Sep 2004 08:54:51 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tony Bowden &lt;tony [...] kasei.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Christopher via RT &lt;bug-Class-DBI [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #7715] Class::DBI does not correctly quote column names &#40;Pg, maybe others&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, Sep 20, 2004 at 05:56:26PM -0400, Christopher via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This works if I use straight DBI
</div>
This makes me think it&#39;s not a CDBI problem, as CDBI doesn&#39;t do anything
more or less than DBI here.

Can you reduce this down to a small test script which passes on DBI and
fails on CDBI?

Thanks,

Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;21&nbsp;10:13:34&nbsp;2004</span>
    <span class="description">TMTM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[APEIRON - Tue Sep 21 10:00:31 2004]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; This makes me think it&#39;s not a CDBI problem, as CDBI doesn&#39;t do
&gt;&gt; anything more or less than DBI here.
</div>&gt; Okay, but I can quote things with DBI. I&#39;ve tried every quoting method
&gt; possible in Perl with CDBI, but none of them actually succeed with the
&gt; insert.
</div>
Ah, if you&#39;re explicitly quoting it with DBI that&#39;s a different matter.
You&#39;re not going to be able to do this with CDBI. It assumes that all
your column names are going to be sensible.

To get this working isn&#39;t trivial, as it will require factoring out all
the places that construct SQL from column names and calling a method on
them to quote them ... which I assume is a database specific thing, so
by default CDBI won&#39;t actually be able to do anything, and have to leave
it to database specific subclasses to handle.

It&#39;s should be too difficult to get most of them working fairly quickly
just for yourself if you want to play around with it. If you&#39;re waiting
for me it&#39;ll probably be about 6 months. You could also try the mailing
list and see if anyone there has any time to help...

The main places for the simple case &#40;i.e. if you&#39;re not handling SQL
expansions, remapped column names etc&#41; are probably just _insert_row and
_do_search, where you can replace the column variables with a
$self-&gt;_quoted_column_name&#40;$col&#41; which DTRT for you.

Tony

Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;21&nbsp;10:13:35&nbsp;2004</span>
    <span class="description">TMTM [...] cpan.org -  Status changed from &#39;new&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;04&nbsp;03:41:29&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> qef [...] ungwe.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I had a go at fixing this, and ended up with the patch below.  But I
don&#39;t know how much of the problem this solves.  It seems to work for
the few things I&#39;ve tried it with, but it would need some proper
testing.  Right now though I&#39;ll probably just rearrange my table and
column names.

   qef


--- lib/Class/DBI.pm.orig       2004-04-30 08:22:12.000000000 +0100
+++ lib/Class/DBI.pm    2005-05-04 08:28:20.734250373 +0100
@@ -169,10 +169,14 @@
        my &#40;$self, $sql, @args&#41; = @_;
 
        my %cmap;
+       my $dbh = $self-&gt;db_Main;
        my $expand_table = sub {
                my &#40;$class, $alias&#41; = split /=/, shift, 2;
                my $table = $class ? $class-&gt;table : $self-&gt;table;
                $cmap{ $alias || $table } = $class || ref $self || $self;
+               for &#40;$table, $alias&#41; {
+                       $_ = $dbh-&gt;quote_identifier&#40;$_&#41; if defined;
+               }
                &#40;$alias ||= &#34;&#34;&#41; &#38;&#38;= &#34; AS $alias&#34;;
                return $table . $alias;
        };
@@ -200,8 +204,9 @@
                        };
 
                        $self-&gt;_croak&#40;&#34;Don&#39;t know how to join $c1 to $c2&#34;&#41; unless $col;
-                       push @sql, sprintf &#34; %s.%s = %s.%s &#34;, $t1, $col, $t2,
-                               $c2-&gt;primary_column;
+                       push @sql, sprintf &#34; %s.%s = %s.%s &#34;,
+                               map { $dbh-&gt;quote_identifier }
+                               $t1, $col, $t2, $c2-&gt;primary_column;
                }
                return join &#34; AND &#34;, @sql;
        };
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;04&nbsp;03:41:30&nbsp;2005</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;04&nbsp;04:16:59&nbsp;2005</span>
    <span class="description">TMTM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I had a go at fixing this, and ended up with the patch below.  But I
&gt; don&#39;t know how much of the problem this solves.  It seems to work for
&gt; the few things I&#39;ve tried it with, but it would need some proper
&gt; testing.  Right now though I&#39;ll probably just rearrange my table and
&gt; column names.
</div>
Thanks. The &#39;proper&#39; place for this is probably Class::DBI::Column, and
having all the places that construct SQL call a method on that to get
the correctly quoted version, but I&#39;ll play around with this and see
where I get.

Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;18&nbsp;06:41:58&nbsp;2005</span>
    <span class="description">TMTM [...] cpan.org -  Severity Important added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
