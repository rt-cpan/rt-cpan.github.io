<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #84352 for Algorithm-Cron: Bug in Algorithm::Cron</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #84352 for Algorithm-Cron: Bug in Algorithm::Cron</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Algorithm-Cron">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Algorithm-Cron">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Algorithm-Cron">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Algorithm-Cron">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Algorithm-Cron">Algorithm-Cron CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">84352</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Algorithm-Cron">Algorithm-Cron</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
chris [...] netnix.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-245746-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-245747-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.07    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=84352">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1197249" href="/Public/Bug/Display.html?id=84352#txn-1197249">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;01&nbsp;16:04:24&nbsp;2013</span>
    <span class="description">chris [...] netnix.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Bug in Algorithm::Cron</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 1 Apr 2013 21:04:08 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Algorithm-Cron [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Chris Mason &lt;chris [...] netnix.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1197249/631906/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/631906">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I have been using the Algorithm::Cron module for some time and up to
now it has been brilliant!
However, I noticed an issue this week when it failed to fire an event
- when I checked the next fire time it was a lot further in the future
than I was expecting:

To demonstrate this bug, I have put together the following script:

my $t = time &#40;&#41;;
print &#34;Time: &#34; . $t . &#34;\n\n&#34;;

foreach my $base &#40;&#39;local&#39;, &#39;utc&#39;&#41; {
  my $c = new Algorithm::Cron &#40;base =&gt; $base, crontab =&gt; &#34;0 4 * * *&#34;&#41;;

  print &#34;Base: &#34; . $base . &#34;\n&#34;;
  print &#34;Crontab: 0 4 * * *\n&#34;;
  print &#34;Current time: &#34; . strftime &#40;&#39;%H:%M:%S on %d/%b/%Y&#39;, localtime
&#40;$t&#41;&#41; . &#34;\n&#34;;
  print &#34;Next run time: &#34; . strftime &#40;&#39;%H:%M:%S on %d/%b/%Y&#39;,
localtime &#40;$c-&gt;next_time &#40;$t&#41;&#41;&#41; . &#34;\n\n&#34;;
}

After some investigation, the issue only occurs when I use the &#34;local&#34;
base - and when I execute the above script I get the following output:

Time: 1364846197

Base: local
Crontab: 0 4 * * *
Current time: 20:56:37 on 01/Apr/2013
Next run time: 04:00:00 on 27/Oct/2013 &lt;--- Issue here with the date?!?!

Base: utc
Crontab: 0 4 * * *
Current time: 20:56:37 on 01/Apr/2013
Next run time: 05:00:00 on 02/Apr/2013

My version of Perl is as follows running on Solaris 10:

Summary of my perl5 &#40;revision 5 version 8 subversion 4&#41; configuration:
  Platform:
    osname=solaris, osvers=2.10, archname=sun4-solaris-64int
    uname=&#39;sunos localhost 5.10 sun4u sparc SUNW,Ultra-2&#39;
    config_args=&#39;&#39;
    hint=recommended, useposix=true, d_sigaction=define
    usethreads=undef use5005threads=undef useithreads=undef
usemultiplicity=undef
    useperlio=define d_sfio=undef uselargefiles=define usesocks=undef
    use64bitint=define use64bitall=undef uselongdouble=undef
    usemymalloc=n, bincompat5005=undef
  Compiler:
    cc=&#39;cc&#39;, ccflags =&#39;-D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
-xarch=v8 -D_TS_ERRNO&#39;,
    optimize=&#39;-xO3 -xspace -xildoff&#39;,
    cppflags=&#39;&#39;
    ccversion=&#39;Sun WorkShop&#39;, gccversion=&#39;&#39;, gccosandvers=&#39;&#39;
    intsize=4, longsize=4, ptrsize=4, doublesize=8, byteorder=87654321
    d_longlong=define, longlongsize=8, d_longdbl=define, longdblsize=16
    ivtype=&#39;long long&#39;, ivsize=8, nvtype=&#39;double&#39;, nvsize=8,
Off_t=&#39;off_t&#39;, lseeksize=8
    alignbytes=8, prototype=define
  Linker and Libraries:
    ld=&#39;cc&#39;, ldflags =&#39;&#39;
    libpth=/lib /usr/lib /usr/ccs/lib
    libs=-lsocket -lnsl -ldl -lm -lc
    perllibs=-lsocket -lnsl -ldl -lm -lc
    libc=/lib/libc.so, so=so, useshrplib=true, libperl=libperl.so
    gnulibc_version=&#39;&#39;
  Dynamic Linking:
    dlsrc=dl_dlopen.xs, dlext=so, d_dlsymun=undef, ccdlflags=&#39;-R
/usr/perl5/5.8.4/lib/sun4-solaris-64int/CORE&#39;
    cccdlflags=&#39;-KPIC&#39;, lddlflags=&#39;-G&#39;


Characteristics of this binary &#40;from libperl&#41;:
  Compile-time options: USE_64_BIT_INT USE_LARGE_FILES
  Locally applied patches:
        22667 The optree builder was looping when constructing the ops ...
        22715 Upgrade to FileCache 1.04
        22733 Missing copyright in the README.
        22746 fix a coredump caused by rv2gv not fully converting a PV ...
        22755 Fix 29149 - another UTF8 cache bug hit by substr.
        22774 [perl #28938] split could leave an array without ...
        22775 [perl #29127] scalar delete of empty slice returned garbage
        22776 [perl #28986] perl -e &#34;open m&#34; crashes Perl
        22777 add test for change #22776 &#40;&#34;open m&#34; crashes Perl&#41;
        22778 add test for change #22746 &#40;[perl #29102] Crash on assign ...
        22781 [perl #29340] Bizarre copy of ARRAY make sure a pad op&#39;s ...
        22796 [perl #29346] Double warning for int&#40;undef&#41; and abs&#40;undef&#41; ...
        22818 BOM-marked and &#40;BOMless&#41; UTF-16 scripts not working
        22823 [perl #29581] glob&#40;&#41; misses a lot of matches
        22827 Smoke [5.9.2] 22818 FAIL&#40;F&#41; MSWin32 WinXP/.Net SP1 &#40;x86/1 cpu&#41;
        22830 [perl #29637] Thread creation time is hypersensitive
        22831 improve hashing algorithm for ptr tables in perl_clone: ...
        22839 [perl #29790] Optimization busted: &#39;@a = &#34;b&#34;, sort @a&#39; ...
        22850 [PATCH] &#39;perl -v&#39; fails if local_patches contains code snippets
        22852 TEST needs to ignore SCM files
        22886 Pod::Find should ignore SCM files and dirs
        22888 Remove redundant %SIG assignments from FileCache
        23006 [perl #30509] use encoding and &#34;eq&#34; cause memory leak
        23074 Segfault using HTML::Entities
        23106 Numeric comparison operators mustn&#39;t compare addresses of ...
        23320 [perl #30066] Memory leak in nested shared data structures ...
        23321 [perl #31459] Bug in read&#40;&#41;
        27722 perlio.c breaks on Solaris/gcc when &gt; 256 FDs are available
        SPRINTF0 - fixes for sprintf formatting issues - CVE-2005-3962
        6663288 Upgrade to CGI.pm 3.33
        REGEXP0 - fix for UTF-8 recoding in regexps - CVE-2007-5116
        6758953 Perl Sys::Syslog can log messages with wrong severity
  Built under solaris
  Compiled at May 18 2009 02:52:06
  %ENV:
    PERL5LIB=&#34;/export/home/cmason/lib/perl&#34;
  @INC:
    /export/home/cmason/lib/perl
    /usr/perl5/5.8.4/lib/sun4-solaris-64int
    /usr/perl5/5.8.4/lib
    /usr/perl5/site_perl/5.8.4/sun4-solaris-64int
    /usr/perl5/site_perl/5.8.4
    /usr/perl5/site_perl
    /usr/perl5/vendor_perl/5.8.4/sun4-solaris-64int
    /usr/perl5/vendor_perl/5.8.4
    /usr/perl5/vendor_perl
    .
Thanks,
Chris
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1199272" href="/Public/Bug/Display.html?id=84352#txn-1199272">#</a>      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;06&nbsp;15:24:00&nbsp;2013</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1199272/633121/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/633121">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Apr 01 16:04:24 2013, chris@netnix.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Base: local
&gt; Crontab: 0 4 * * *
&gt; Current time: 20:56:37 on 01/Apr/2013
&gt; Next run time: 04:00:00 on 27/Oct/2013 &lt;--- Issue here with the
&gt; date?!?!
</div>
Hmm, this is awkward, I&#39;m afraid I can&#39;t reproduce it.

If I use the current time&#40;&#41; I get

$ perl -Mblib rt84352.pl 
Time: 1365276076

Base: local
Crontab: 0 4 * * *
Current time: 20:21:16 on 06/Apr/2013
Next run time: 04:00:00 on 07/Apr/2013

Base: utc
Crontab: 0 4 * * *
Current time: 20:21:16 on 06/Apr/2013
Next run time: 05:00:00 on 07/Apr/2013


and if instead I use the time you provided I get

$ perl -Mblib rt84352.pl 1364846197
Time: 1364846197

Base: local
Crontab: 0 4 * * *
Current time: 20:56:37 on 01/Apr/2013
Next run time: 04:00:00 on 02/Apr/2013

Base: utc
Crontab: 0 4 * * *
Current time: 20:56:37 on 01/Apr/2013
Next run time: 05:00:00 on 02/Apr/2013


Might be timezone and/or perl version related though? I&#39;m in Europe/London, so BST currently. Running 5.14.2 from debian/testing.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1199274" href="/Public/Bug/Display.html?id=84352#txn-1199274">#</a>      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;06&nbsp;15:24:01&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1199297" href="/Public/Bug/Display.html?id=84352#txn-1199297">#</a>      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;06&nbsp;16:02:19&nbsp;2013</span>
    <span class="description">chris [...] netnix.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #84352] Bug in Algorithm::Cron</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 6 Apr 2013 21:01:58 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Algorithm-Cron [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Chris Mason &lt;chris [...] netnix.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1199297/633138/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/633138">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Paul,

I am also in Europe/London and I assumed it was something to do with
daylight savings as it only started to happen a couple of days before
the clocks went forward. However, I have done some further
investigation and it appears to be a Solaris issue as I am unable to
reproduce it under Debian Linux either.

I was struggling a little to understand what your code was doing, but
I can run a small Perl script on Solaris to determine if localtime&#40;&#41;
or mktime&#40;&#41; isn&#39;t working as expected?

Thanks,
Chris

On 6 April 2013 20:24, Paul Evans via RT &lt;bug-Algorithm-Cron@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=84352">https://rt.cpan.org/Ticket/Display.html?id=84352</a></span> &gt;
&gt;
&gt; On Mon Apr 01 16:04:24 2013, chris@netnix.org wrote:
<div class="message-stanza open">&gt;&gt; Base: local
&gt;&gt; Crontab: 0 4 * * *
&gt;&gt; Current time: 20:56:37 on 01/Apr/2013
&gt;&gt; Next run time: 04:00:00 on 27/Oct/2013 &lt;--- Issue here with the
&gt;&gt; date?!?!
</div>&gt;
&gt; Hmm, this is awkward, I&#39;m afraid I can&#39;t reproduce it.
&gt;
&gt; If I use the current time&#40;&#41; I get
&gt;
&gt; $ perl -Mblib rt84352.pl
&gt; Time: 1365276076
&gt;
&gt; Base: local
&gt; Crontab: 0 4 * * *
&gt; Current time: 20:21:16 on 06/Apr/2013
&gt; Next run time: 04:00:00 on 07/Apr/2013
&gt;
&gt; Base: utc
&gt; Crontab: 0 4 * * *
&gt; Current time: 20:21:16 on 06/Apr/2013
&gt; Next run time: 05:00:00 on 07/Apr/2013
&gt;
&gt;
&gt; and if instead I use the time you provided I get
&gt;
&gt; $ perl -Mblib rt84352.pl 1364846197
&gt; Time: 1364846197
&gt;
&gt; Base: local
&gt; Crontab: 0 4 * * *
&gt; Current time: 20:56:37 on 01/Apr/2013
&gt; Next run time: 04:00:00 on 02/Apr/2013
&gt;
&gt; Base: utc
&gt; Crontab: 0 4 * * *
&gt; Current time: 20:56:37 on 01/Apr/2013
&gt; Next run time: 05:00:00 on 02/Apr/2013
&gt;
&gt;
&gt; Might be timezone and/or perl version related though? I&#39;m in Europe/London, so BST currently. Running 5.14.2 from debian/testing.
&gt;
&gt; --
&gt;
&gt; Paul Evans
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1201411" href="/Public/Bug/Display.html?id=84352#txn-1201411">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;12&nbsp;18:14:14&nbsp;2013</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1201411/634306/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/634306">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 768b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Apr 06 16:02:19 2013, chris@netnix.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I was struggling a little to understand what your code was doing, but
&gt; I can run a small Perl script on Solaris to determine if localtime&#40;&#41;
&gt; or mktime&#40;&#41; isn&#39;t working as expected?
</div>
Well, you could certainly do that. Please apply the analogous of this shell log, and we&#39;ll see what the result looks like:

  $ perlsh
  eval: use POSIX &#39;mktime&#39;;
  undef

  eval: [ localtime 1364846197 ]
  [ &#39;37&#39;, &#39;56&#39;, &#39;20&#39;, &#39;1&#39;, &#39;3&#39;, &#39;113&#39;, &#39;1&#39;, &#39;90&#39;, &#39;1&#39; ]

## At this point, I manually set sec=0 min=0 hour=4 and rolled over the mday to the next value, 2:

  eval: my $t = mktime 0,0,4, 2, 3, 113;
  &#39;1364871600&#39;

  eval: scalar localtime $t
  &#39;Tue Apr  2 04:00:00 2013&#39;

See what your machine makes of that.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1201474" href="/Public/Bug/Display.html?id=84352#txn-1201474">#</a>      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;13&nbsp;04:12:06&nbsp;2013</span>
    <span class="description">chris [...] netnix.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #84352] Bug in Algorithm::Cron</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 13 Apr 2013 09:11:52 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Algorithm-Cron [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Chris Mason &lt;chris [...] netnix.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1201474/634323/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/634323">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Paul,

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Well, you could certainly do that. Please apply the analogous of this shell log, and we&#39;ll see what the result looks like:
&gt;
&gt;   $ perlsh
&gt;   eval: use POSIX &#39;mktime&#39;;
&gt;   undef
&gt;
&gt;   eval: [ localtime 1364846197 ]
&gt;   [ &#39;37&#39;, &#39;56&#39;, &#39;20&#39;, &#39;1&#39;, &#39;3&#39;, &#39;113&#39;, &#39;1&#39;, &#39;90&#39;, &#39;1&#39; ]
&gt;
&gt; ## At this point, I manually set sec=0 min=0 hour=4 and rolled over the mday to the next value, 2:
&gt;
&gt;   eval: my $t = mktime 0,0,4, 2, 3, 113;
&gt;   &#39;1364871600&#39;
&gt;
&gt;   eval: scalar localtime $t
&gt;   &#39;Tue Apr  2 04:00:00 2013&#39;
</div>
The only difference I see is that it moves localtime forward by 1 hour:

$ perlsh
eval: use POSIX &#39;mktime&#39;;
undef

eval: [ localtime 1364846197 ]
[ &#39;37&#39;, &#39;56&#39;, &#39;20&#39;, &#39;1&#39;, &#39;3&#39;, &#39;113&#39;, &#39;1&#39;, &#39;90&#39;, &#39;1&#39; ]

## At this point, I manually set sec=0 min=0 hour=4 and rolled over
the mday to the next value, 2:

eval: my $t = mktime 0,0,4, 2, 3, 113;
&#39;1364875200&#39;

eval: scalar localtime $t
&#39;Tue Apr  2 05:00:00 2013&#39;

Just to verify I am still getting the issue, I re-run my test script
and got the following output with the same inputs:

Time: 1364846197

Base: local
Crontab: 0 4 * * *
Current time: 20:56:37 on 01/Apr/2013
Next run time: 04:00:00 on 27/Oct/2013

I also tried this on another Solaris 10 system and got an identical result.
So, I attempted to try it with the time set to a month earlier and got
the correct results:

Time: 1362196800

Base: local
Crontab: 0 4 * * *
Current time: 04:00:00 on 02/Mar/2013
Next run time: 04:00:00 on 03/Mar/2013

eval: scalar localtime 1362196800
&#39;Sat Mar  2 04:00:00 2013&#39;

Thanks,
Chris
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1201550" href="/Public/Bug/Display.html?id=84352#txn-1201550">#</a>      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;13&nbsp;08:08:00&nbsp;2013</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1201550/634371/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/634371">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Apr 13 04:12:06 2013, chris@netnix.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; eval: my $t = mktime 0,0,4, 2, 3, 113;
&gt; &#39;1364875200&#39;
&gt; 
&gt; eval: scalar localtime $t
&gt; &#39;Tue Apr  2 05:00:00 2013&#39;
</div>
Oh dear. :&#40;

This would be one of mktime or localtime being broken then, because they ought to be inverses of each other; a mktime-&gt;localtime roundtrip should yield the same time.

I imagine that&#39;s what is upsetting Algorithm::Cron. It tries to hit 4am on one day, but finds it&#39;s now gone past it to 5am, so it&#39;ll have to try 4am the next day. It keeps going, every day, until that point in October when the BST offset changes back and suddenly it can manage to hit 4am again.

Having read further around on the subject, it appears that on Solaris, mktime&#40;&#41; is rather too trusting of the tm_isdst field given in to it. You have to specify -1 to let it not trust that. So perhaps try again with:

  eval: my $t = mktime 0,0,4, 2, 3, 113, 0, 0, -1;
  &#39;1364871600&#39;

  eval: scalar localtime $t;
  &#39;Tue Apr  2 04:00:00 2013&#39;

Or failing that, maybe set -1 as all three of those last fields.

If that works then I guess that&#39;ll be the solution.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1201703" href="/Public/Bug/Display.html?id=84352#txn-1201703">#</a>      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;13&nbsp;16:39:39&nbsp;2013</span>
    <span class="description">chris [...] netnix.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #84352] Bug in Algorithm::Cron</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 13 Apr 2013 21:39:26 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Algorithm-Cron [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Chris Mason &lt;chris [...] netnix.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1201703/634450/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/634450">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I imagine that&#39;s what is upsetting Algorithm::Cron. It tries to hit 4am on one day, but finds it&#39;s now gone past it to 5am, so it&#39;ll have to try 4am the next day. It keeps going, every day, until that point in October when the BST offset changes back and suddenly it can manage to hit 4am again.
</div>
This does sound plausible, however I had another example using the
crontab of &#34;0 8 * * 1&#34; which resulted in the following:

Time: 1364846197
Base: local
Crontab: 0 8 * * 1
Current time: 20:56:37 on 01/Apr/2013
Next run time: 11:00:00 on 08/Apr/2013

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Having read further around on the subject, it appears that on Solaris, mktime&#40;&#41; is rather too trusting of the tm_isdst field given in to it. You have to specify -1 to let it not trust that. So perhaps try again with:
&gt;
&gt;   eval: my $t = mktime 0,0,4, 2, 3, 113, 0, 0, -1;
&gt;   &#39;1364871600&#39;
&gt;
&gt;   eval: scalar localtime $t;
&gt;   &#39;Tue Apr  2 04:00:00 2013&#39;
&gt;
&gt; Or failing that, maybe set -1 as all three of those last fields.
</div>
I ended up with the correct result after setting the last 3 fields to
-1 &#40;the time was still 05:00 with just a single or double -1&#41;:

eval: my $t = mktime 0,0,4, 2, 3, 113, 0, 0, -1, -1, -1;
&#39;1364871600&#39;

eval: scalar localtime $t;
&#39;Tue Apr  2 04:00:00 2013&#39;

As a result of this I modified Cron.pm and changed the following line:

   local =&gt; [ sub { localtime $_[0] }, \&#38;mktime, sub { localtime
mktime @_[0..5] } ],

to read:

   local =&gt; [ sub { localtime $_[0] }, \&#38;mktime, sub { localtime
mktime @_[0..5], -1, -1, -1 } ],

and it has resolved the problem for both of my use cases above.

This also seems to work fine under Debian Linux as well.
Thank you for your time, other people would have put this down as a
Solaris issue, but now I can stop using &#39;utc&#39; and keep having to
change it every time the clocks change :&#41;

Chris
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1201938" href="/Public/Bug/Display.html?id=84352#txn-1201938">#</a>      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;14&nbsp;09:17:58&nbsp;2013</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1201938/634586/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/634586">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 790b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Apr 13 16:39:39 2013, chris@netnix.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I ended up with the correct result after setting the last 3 fields to
&gt; -1 &#40;the time was still 05:00 with just a single or double -1&#41;:
&gt; 
&gt; eval: my $t = mktime 0,0,4, 2, 3, 113, 0, 0, -1, -1, -1;
&gt; &#39;1364871600&#39;
&gt; 
&gt; eval: scalar localtime $t;
&gt; &#39;Tue Apr  2 04:00:00 2013&#39;
&gt; 
&gt; As a result of this I modified Cron.pm and changed the following line:
&gt; 
&gt;    local =&gt; [ sub { localtime $_[0] }, \&#38;mktime, sub { localtime
&gt; mktime @_[0..5] } ],
&gt; 
&gt; to read:
&gt; 
&gt;    local =&gt; [ sub { localtime $_[0] }, \&#38;mktime, sub { localtime
&gt; mktime @_[0..5], -1, -1, -1 } ],
&gt; 
&gt; and it has resolved the problem for both of my use cases above.
</div>
Excellent. Glad to know that finally fixed it.

I&#39;ll pop that in the next version then.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1201940" href="/Public/Bug/Display.html?id=84352#txn-1201940">#</a>      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;14&nbsp;09:17:58&nbsp;2013</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1256613" href="/Public/Bug/Display.html?id=84352#txn-1256613">#</a>      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;31&nbsp;19:56:19&nbsp;2013</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1256613/665163/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/665163">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 37b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Was released in 0.07

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1256615" href="/Public/Bug/Display.html?id=84352#txn-1256615">#</a>      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;31&nbsp;19:56:20&nbsp;2013</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1256617" href="/Public/Bug/Display.html?id=84352#txn-1256617">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;31&nbsp;19:56:20&nbsp;2013</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Fixed in 0.07 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.570337</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
