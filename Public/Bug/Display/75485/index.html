<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #75485 for Weather-NOAA-Alert: Adding in addition XML elements including nested elements</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #75485 for Weather-NOAA-Alert: Adding in addition XML elements including nested elements</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Weather-NOAA-Alert/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Weather-NOAA-Alert/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Weather-NOAA-Alert/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Weather-NOAA-Alert/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Weather-NOAA-Alert">Weather-NOAA-Alert CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">75485</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Weather-NOAA-Alert/Active/">Weather-NOAA-Alert</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">STOVENOUR [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ryan [...] bebeau.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-238424-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-238425-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;02&nbsp;14:34:51&nbsp;2012</span>
    <span class="description">ryan [...] bebeau.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Adding in addition XML elements including nested elements</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 02 Mar 2012 14:34:36 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Weather-NOAA-Alert [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ryan Bebeau &lt;ryan [...] bebeau.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

First of all, wanted to thank you for writing this module.

Second, I&#39;ve included a patch to allow the nested elements of the CAP to 
be stored in the events hash.  I also have code that would allow someone 
to know if a latitude/longitude is contained within a polygon.
That should help to determine if a storm based warning surrounds a 
specific area smaller than a county.

Included is the patch I made, hopefully it can be helpful.

If you have further questions, please let me know.

Thanks,

Ryan Bebeau
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;06&nbsp;00:34:04&nbsp;2012</span>
    <span class="description">STOVENOUR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Mar 02 14:34:51 2012, ryan@bebeau.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello,
&gt; 
&gt; First of all, wanted to thank you for writing this module.
</div>I&#39;m glad that others can use this module.  I spent many hours reverse
engineering the poorly documented interface from NOAA.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Second, I&#39;ve included a patch to allow the nested elements of the CAP to 
&gt; be stored in the events hash.  I also have code that would allow someone 
&gt; to know if a latitude/longitude is contained within a polygon.
&gt; That should help to determine if a storm based warning surrounds a 
&gt; specific area smaller than a county.
</div>:&#41; I also added code to support point in polygon detection.  I took a
slightly different approach.  My approach was first to separate the
&#34;polled&#34; counties from &#34;detected&#34; counties.  I then added support for
detection points.  With this method the module user can &#34;arm&#34; counties
and specific points for alert detection.  The cap data structure then
indicates if a tracked alert is inDetectionZone.  The nice thing about
this approach is that the module user can add multiple detection points
and the module takes care of iterating over each point.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Included is the patch I made, hopefully it can be helpful.
</div>I would like to combine what you and I have done.  1st a couple of
questions.  I implemented my own point in polygon code.  Do you think
that Math::Polygon will be better?  Maybe mathematically there is an
advantage to the existing module?  I don&#39;t mind using it if there is a
good reason but otherwise I&#39;d like to limit the number of dependencies.
 2nd you&#39;ve added support for nested elements.  Is this only to get at
the polygon?  Or do you think there is a general need?  My updates
retrieve the polygon data.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If you have further questions, please let me know.
</div>I really appreciate the time you&#39;ve taken to use and modify the code.  I
am truly interested in combining the best of our ideas.  Let me know
what you think.  I&#39;ve attached my updated Alert.pm, example.pl, and
noaa_alert_win32.pl for you to take a look at.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks,
&gt; 
&gt; Ryan Bebeau
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> noaa_alert_win32-diff.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Weather-NOAA-Alert-0.90/examples/noaa_alert_win32.pl	2011-05-01 13:26:48.421875000 -0500
+++ Weather-NOAA-Alert/examples/noaa_alert_win32.pl	2011-05-02 01:57:31.687500000 -0500
@@ -1,6 +1,6 @@
 use strict;
 
-#use lib &#39;../Weather-NOAA-Alert/lib&#39;;
+
 use Weather::NOAA::Alert;
 
 use Win32::OLE;
@@ -9,15 +9,16 @@
 
 use Data::Dumper;
 
-our $VERSION = &#39;2.10&#39;;
+our $VERSION = &#39;2.20&#39;;
 
-#V2.00 - Major rewrite to accomodate CAP 1.1 format.  Moved CAP parsing to 
+#V2.00 - Major rewrite to accommodate CAP 1.1 format.  Moved CAP parsing to 
 # the Weather-NOAA-Alert module
 #V2.10 - Add tracking for the same CAP event in multiple Zones.  The same 
-# alert can show up in multiple zones when polling for ajacent zones.  For 
+# alert can show up in multiple zones when polling for adjacent zones.  For 
 # example, polling for both Dallas and Collin counties in Texas might produce
 # the same CAP tornado watch event.  Code will now only schedule actions for 
 # the first instance.
+#V2.20 - Add support for detectionPoints and detectionZones
 
 
 #XXX-Add an audio test mode where the first message is always generated 
@@ -47,7 +48,7 @@
 #between the urgency category and the alerts.  For example from simply
 #looking over the current data it appears that flood warnings are 
 #&#34;Expected&#34; while severe thunderstorm warnings are &#34;Immediate&#34;.  I might
-#write a data coorelator that pulls the data a couple times a day and
+#write a data correlator that pulls the data a couple times a day and
 #builds a table of values for each even type.
 
 #Why not just build as many queues as we have urgency information??
@@ -95,6 +96,10 @@
 
 #Create a NOAA Alert Object, configure it, and get a reference to the events hash
 our $alert = Weather::NOAA::Alert-&gt;new&#40;\@zones&#41;;
+$alert-&gt;detectionZones&#40;[&#39;TXC085&#39;, &#39;TXZ104&#39;]&#41;;
+$alert-&gt;detectionPoints&#40;[[33.090394, -96.753218]]&#41;;
+$alert-&gt;formatTime&#40;1&#41;;
+$alert-&gt;formatAsterisk&#40;1&#41;;
 $alert-&gt;printLog&#40;1&#41;;
 $alert-&gt;printActions&#40;1&#41;;
 $alert-&gt;errorLog&#40;1&#41;;
@@ -272,7 +277,7 @@
                 $playAlertWav = $eventActions{$event}[2];
             } else {
                 #some suitable defaults if a new product springs to life
-                #Speek the text but don&#39;t play an alert tone
+                #Speak the text but don&#39;t play an alert tone
                 $eventRepeat = $REPEAT_SECS;
                 $includeWOthers = 0;
                 $playAlertWav = 0;
@@ -312,7 +317,7 @@
             #                            -&gt;{&#39;playAlertWav&#39;}=0
             #                            -&gt;{&#39;text&#39;}=&#39;text to speak&#39;
             
-            #May need to add some colums to %eventActions so that different
+            #May need to add some columns to %eventActions so that different
             #  action rules can apply to TTS vs. xAPAlert
             #For now xAPAlert is not implemented
             
@@ -325,7 +330,12 @@
             
             #Don&#39;t queue the action if this CAP id has already been
             #processed in a different zone. &#40;e.g. same watch in two counties&#41;
-            if&#40; !exists&#40;$capIdSeen{$capId}&#41;&#41; {
+            if&#40; exists&#40;$capIdSeen{$capId}&#41;&#41; {
+                print &#34;Skip dup -&gt; $event\n&#34;;
+            } elsif&#40; not $events-&gt;{$zone}{$capId}{&#39;inDetectionZone&#39;}&#41; {
+                $capIdSeen{$capId} = 1;
+                print &#34;not inDetectionZone -&gt; $event\n&#34;;
+            } else {
                 $capIdSeen{$capId} = 1;
                 print &#34;Queuing  -&gt; $event\n&#34;;
                 push&#40; @{$actionQueues{$severity}},
@@ -337,8 +347,6 @@
                         }
                     &#41;;
                 $events-&gt;{$zone}{$capId}{&#39;actionTime&#39;} = time;
-            } else {
-                print &#34;Skip dup -&gt; $event\n&#34;;
             }
 
         } #foreach my $capId
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> example-diff.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Weather-NOAA-Alert-0.90/examples/example.pl	2011-05-01 13:26:48.421875000 -0500
+++ Weather-NOAA-Alert/examples/example.pl	2011-05-02 00:44:39.718070500 -0500
@@ -1,10 +1,14 @@
+use strict;
 use Weather::NOAA::Alert;
 use Data::Dumper;
+$Data::Dumper::Indent = 1;
 
 my $SLEEP_SECS = 60;   #Poll every 1 minute
 
 #my $alert = Weather::NOAA::Alert-&gt;new&#40;[&#39;US&#39;]&#41;;
 my $alert = Weather::NOAA::Alert-&gt;new&#40;[&#39;TXC085&#39;, &#39;TXZ097&#39;]&#41;;
+$alert-&gt;detectionZones&#40;[&#39;TXC085&#39;]&#41;;
+$alert-&gt;detectionPoints&#40;[[33.090394, -96.753218]]&#41;;
 $alert-&gt;printLog&#40;1&#41;;
 $alert-&gt;errorLog&#40;1&#41;;
 
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Alert-diff.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Weather-NOAA-Alert-0.90/lib/Weather/NOAA/Alert.pm	2011-05-01 13:26:48.437500000 -0500
+++ Weather-NOAA-Alert/lib/Weather/NOAA/Alert.pm	2011-05-02 02:20:59.934619600 -0500
@@ -19,11 +19,11 @@
 
 =head1 VERSION
 
-Version 0.90
+Version 0.91
 
 =cut
 
-our $VERSION = &#39;0.90&#39;;
+our $VERSION = &#39;0.91&#39;;
 
 =head1 SYNOPSIS
  
@@ -49,16 +49,38 @@
 =item * Zone Maps: L&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.weather.gov/mirs/public/prods/maps/pfzones_list.htm">http://www.weather.gov/mirs/public/prods/maps/pfzones_list.htm</a></span>&gt;
 
 =back
+
+=head 2 Affected Area
+
+The affected area for NOAA NWS watches, warnings, and advisories fall into
+one of three categories.  They are either in a forecast zone, forecast county, 
+or within a polygon defined in the alert.  An alert is considered to affect the 
+entire forecast zone or county if the alert is supplied in the respective zone 
+or county file and the C&lt;E&lt;lt&gt;areaE&lt;gt&gt;E&lt;lt&gt;polygonE&lt;gt&gt;&gt; enclosure is empty.  
+If an C&lt;E&lt;lt&gt;areaE&lt;gt&gt;E&lt;lt&gt;polygonE&lt;gt&gt;&gt; enclosure is supplied then the alert 
+only applies to the area enclosed by the C&lt;E&lt;lt&gt;areaE&lt;gt&gt;E&lt;lt&gt;polygonE&lt;gt&gt;&gt;.
+
+Weather::NOAA::Alert can be armed with zones and latitude/longitude points which 
+are compared to the alert area.  The C&lt;inDetectionZone&gt; flag will be set in 
+the C&lt;events&gt; hash if one or more of the zones and/or points are within the 
+alert area.  This permits monitoring other counties and reacting differently 
+for alerts within the detection are vs. alerts outside the detection area.  In 
+the simplest case set the same zones for polling as for detection and provide a 
+latitude/longitude point for polygon based alerts.
+
  
 =head1 EXAMPLE
  
     use Weather::NOAA::Alert;
     use Data::Dumper;
- 
+    $Data::Dumper::Indent = 1;
+
     my $SLEEP_SECS = 60;   #Poll every 1 minute
  
     #my $alert = Weather::NOAA::Alert-&gt;new&#40;[&#39;US&#39;]&#41;;
     my $alert = Weather::NOAA::Alert-&gt;new&#40;[&#39;TXC085&#39;, &#39;TXZ097&#39;]&#41;;
+    $alert-&gt;detectionZones&#40;[&#39;TXC085&#39;]&#41;;
+    $alert-&gt;detectionPoints&#40;[[33.090394, -96.753218]]&#41;;
     $alert-&gt;printLog&#40;1&#41;;
     $alert-&gt;errorLog&#40;1&#41;;
 
@@ -99,6 +121,8 @@
     my $class = shift;
     my $self = {};
     
+    $self-&gt;{detectionPoints} = [];
+    $self-&gt;{detectionZones} = [];
     $self-&gt;{events} = {};
     $self-&gt;{formatTime} = 0;
     $self-&gt;{formatAsterisk} = 0;
@@ -122,19 +146,53 @@
     return $self;
 }
 
-=head2 B&lt;zones&gt; - Set the monitored zone list
+=head2 B&lt;zones&gt; - Set the polled zone list
     
     $object-&gt;zones&#40;[zone1, zone2, ...]&#41;;
     @zones = $object-&gt;zones&#40;&#41;;
 
-Setting the zone list will overwrite the existing list with the 
-supplied list. If called with no arguments, returns a reference 
-to the current zone array.  To return data for all zones use &#34;US&#34;.
+List of zones whose ATOM files will be polled and monitored for 
+new alerts.  Setting the zone list will overwrite the existing list 
+with the supplied list. If called with no arguments, returns a 
+reference to the current zone array.  To return data for all zones 
+use &#34;US&#34;.
 
 =cut
 
 sub zones { $_[0]-&gt;{zones}=$_[1] if defined $_[1]; return $_[0]-&gt;{zones}; }
 
+=head2 B&lt;detectionZones&gt; - Set the detection zone list
+    
+    $object-&gt;detectionZones&#40;[zone1, zone2, ...]&#41;;
+    @zones = $object-&gt;detectionZones&#40;&#41;;
+
+Events for zones in the C&lt;detectionZone&gt; list will set the 
+C&lt;inDetectionZone&gt; flag for the event in the events hash unless the 
+event contains a non-empty C&lt;E&lt;lt&gt;areaE&lt;gt&gt;E&lt;lt&gt;polygonE&lt;gt&gt;&gt; 
+enclosure.  Setting the zone list will overwrite the existing list 
+with the supplied list.  If called with no arguments, returns a 
+reference to the current C&lt;detectionZone&gt; array.
+
+=cut
+
+sub detectionZones { $_[0]-&gt;{detectionZones}=$_[1] if defined $_[1]; return $_[0]-&gt;{detectionZones}; }
+
+=head2 B&lt;detectionPoints&gt; - Set the detection point list
+    
+    $object-&gt;detectionPoints&#40;[[lat1, lon1], [lat2, lon2], ...]&#41;;
+    @zones = $object-&gt;detectionPoints&#40;&#41;;
+
+Events that contain a non-empty C&lt;E&lt;lt&gt;areaE&lt;gt&gt;E&lt;lt&gt;polygonE&lt;gt&gt;&gt; 
+enclosure and where one or more detectionPoints are within the polygon 
+will set the C&lt;inDetectionZone&gt; flag for the event in the events hash. 
+Setting the C&lt;detectionPoints&gt; list will overwrite the existing 
+list with the supplied list.  If called with no arguments, returns 
+a reference to the current C&lt;detectionPoints&gt; array.
+
+=cut
+
+sub detectionPoints { $_[0]-&gt;{detectionPoints}=$_[1] if defined $_[1]; return $_[0]-&gt;{detectionPoints}; }
+
 =head2 B&lt;get_events&gt; - get a reference to the alert object events hash
 
     %events = $object-&gt;get_events&#40;&#41;;
@@ -158,6 +216,7 @@
  C&lt;                -E&lt;gt&gt;{&#39;effective&#39;}&gt;
  C&lt;                -E&lt;gt&gt;{&#39;headline&#39;}&gt;
  C&lt;                -E&lt;gt&gt;{&#39;expires&#39;}&gt;
+ C&lt;                -E&lt;gt&gt;{&#39;inDetectionZone&#39;}&gt;
 
 Note that the hash keys are dynamically created from the &lt;info&gt; section of the 
 event.  If NOAA adds, renames, or removes an XML parameter it will also
@@ -419,13 +478,13 @@
     my &#40;$self, $zone, $capId&#41; = @_;
     
     my $capTwig= new XML::Twig&#40;
-        TwigRoots =&gt; {&#39;info&#39; =&gt; 1},
-#        TwigHandlers =&gt; {&#39;info&#39; =&gt;  \&#38;capInfoHandler},
-        TwigHandlers =&gt; {&#39;info&#39; =&gt; sub { capInfoHandler&#40; $self-&gt;{formatTime}, $self-&gt;{formatAsterisk}, @_&#41; } },
+        TwigRoots =&gt; {&#39;/alert/info&#39; =&gt; 1},
+        TwigHandlers =&gt; {&#39;/alert/info&#39; =&gt; sub { capInfoHandler&#40; $self-&gt;{formatTime}, $self-&gt;{formatAsterisk}, @_&#41; } },
         pretty_print =&gt; &#39;indented&#39;,
     &#41;;
-    
+
     my $capContent;
+    my $polygon = &#39;&#39;;
     if &#40;$capContent = get&#40;$capId&#41;&#41; {
     
         if&#40; defined&#40; $self-&gt;{diagFile}&#41; and $self-&gt;{diagDump}&#41; {
@@ -438,11 +497,32 @@
             #Parse only the first &lt;info&gt; enclosure
             #Loop through it appending items to the event hash
             foreach my $child &#40;$capTwig-&gt;root-&gt;first_child-&gt;children&#41; {
-                #ignore nested items: eventCode, parameter, area; they&#39;re too hard :^&#41;
+                #ignore nested items: eventCode, parameter; they&#39;re too hard :^&#41;
                 if&#40;$child-&gt;tag ne &#39;eventCode&#39; and $child-&gt;tag ne &#39;parameter&#39; and $child-&gt;tag ne &#39;area&#39;&#41; {
                     $self-&gt;{events}-&gt;{$zone}{$capId}{$child-&gt;tag} = $child-&gt;text;
+                } elsif&#40; $child-&gt;tag eq &#39;area&#39;&#41; {
+                  foreach my $childArea &#40;$child-&gt;children&#41; {
+                      $polygon = $childArea-&gt;text if&#40;$childArea-&gt;tag eq &#39;polygon&#39;&#41;;
+                      }
+                  }
+            }
+            #check for inDetectionZone
+            #if there was a polygon check all the detectionPoints else
+            #search for the currently polled zone in detectionZones
+            if&#40;$polygon eq &#39;&#39;&#41; {
+                $self-&gt;{events}-&gt;{$zone}{$capId}{&#39;inDetectionZone&#39;} = 
+                    grep&#40;/\b$zone\b/,@{$self-&gt;{detectionZones}}&#41;;
+            } else {
+                $self-&gt;{events}-&gt;{$zone}{$capId}{&#39;polygon&#39;} = $polygon;
+                $self-&gt;{events}-&gt;{$zone}{$capId}{&#39;inDetectionZone&#39;} = 0;
+                foreach my $point &#40;@{$self-&gt;{detectionPoints}}&#41; {
+                    my @polyPoints = map { [split&#40;/,/&#41;] } split&#40;/ /, $polygon&#41;;
+                    if&#40;pointInPolygon&#40; \@polyPoints, $point&#41;&#41; {
+                        $self-&gt;{events}-&gt;{$zone}{$capId}{&#39;inDetectionZone&#39;} = 1;
+                    }
                 }
             }
+
             $self-&gt;{events}-&gt;{$zone}{$capId}{&#39;delete&#39;} = 0;
             
         } else {
@@ -495,6 +575,7 @@
     #except the description and instruction; they need other adjustments.
     my @children = $capInfo-&gt;children;
     foreach my $child &#40;@children&#41; {
+        next if&#40;$child-&gt;tag eq &#39;area&#39;&#41;;
         my $childText = $child-&gt;text;
         if &#40;$child-&gt;tag ne &#39;description&#39; and $child-&gt;tag ne &#39;instruction&#39;&#41; {
             #Adjust the formatting a little.  Why would a CAP file 
@@ -505,13 +586,13 @@
             $childText =~ s/\s+$//; #remove trailing spaces
         } else {
             if&#40; $formatTime&#41; {
-#            if&#40; 1 &#41; {
                 #Try to add colons to all the time fields.  This allows
                 #the MS SAPI engine to correctly pronounce the time
-                $childText =~ s/&#40;\d{1,2}?&#41;&#40;\d{2}&#41;\s{1}&#40;AM|PM&#41;\s{1}[A-Z]{3}/$1:$2 $3/g;
+                $childText =~ s/&#40;\d{1,2}?&#41;&#40;\d{2}&#41;\s{1}&#40;AM|PM&#41;\s{1}[A-Z]{1}[D|S]T/$1:$2 $3/g;
+                $childText =~ s/&#40;\d{1,2}?&#41;&#40;\d{2}&#41;\s{1}&#40;AM|PM&#41;\s*\n/$1:$2 $3\n/g;
+                $childText =~ s/&#40;\d{1,2}?&#41;&#40;\d{2}&#41;\s{1}&#40;AM|PM&#41;\s/$1:$2 $3 /g;
             }
             if&#40; $formatAsterisk&#41; {
-#            if&#40; 1 &#41; {
                 #Remove any &#34;*&#34; because it sounds real funny when SAPI 
                 #pronounces &#34;asterisk&#34; in the middle of the speech stream
                 $childText =~ s/\*/  /g;
@@ -521,6 +602,32 @@
     }
 }
 
+sub pointInPolygon {
+  my &#40;$polygon, $point&#41; = @_;
+  my $lat = $point-&gt;[0];
+  my $lon = $point-&gt;[1];
+  
+  my $i;
+  my $j = &#40;scalar @$polygon&#41; - 1;
+  my $inPoly = 0;
+
+  #look for an odd number of intesecting points with line through point and
+  #the boundary of the polygon
+  for &#40; $i = 0; $i &lt; scalar @$polygon; $i++&#41; {
+    if &#40;$polygon-&gt;[$i][1] &lt; $lon &#38;&#38; $polygon-&gt;[$j][1] &gt;= $lon 
+        || $polygon-&gt;[$j][1] &lt; $lon &#38;&#38; $polygon-&gt;[$i][1] &gt;= $lon&#41; {
+      if &#40;$polygon-&gt;[$i][0] + &#40; $lon - $polygon-&gt;[$i][1]&#41; / 
+          &#40;$polygon-&gt;[$j][1] - $polygon-&gt;[$i][1]&#41; * &#40;$polygon-&gt;[$j][0] 
+          - $polygon-&gt;[$i][0]&#41; &lt; $lat&#41; {
+        $inPoly = !$inPoly;
+      }
+    }
+    $j = $i;
+  }
+  return $inPoly; 
+}
+
+
 =head1 NOAA CAP CHALLENGES
 
 The following items represent fragile parts of the code caused by ambiguous
@@ -561,22 +668,6 @@
 
 =back
 
-=head1 TODO
-
-=over 4
-
-=item * B&lt;Implement point detection based on latitude / longitude&gt;
-
-Events contain a C&lt;E&lt;lt&gt;polygonE&lt;gt&gt;E&lt;lt&gt;/polygonE&lt;gt&gt;&gt; that could be 
-used to determine if a specific latitude / longitude is in the event 
-area.  This would greatly reduce the number of alerts for a specific 
-point in a county since the NWS has recently started issuing and 
-expiring events for specific areas that are not bound by county.  
-Tracking at the county level can trigger several events over a short 
-period as a storm progresses through the county.
-
-=back
-
 =head1 SEE ALSO
 
 =over 4
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;06&nbsp;00:34:05&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;06&nbsp;12:17:51&nbsp;2012</span>
    <span class="description">ryan [...] bebeau.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75485] Adding in addition XML elements including nested elements</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 06 Mar 2012 12:17:35 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Weather-NOAA-Alert [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ryan Bebeau &lt;ryan [...] bebeau.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 03/06/12 00:34, Michael Stovenour via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75485">https://rt.cpan.org/Ticket/Display.html?id=75485</a></span>&gt;
&gt;
&gt; On Fri Mar 02 14:34:51 2012, ryan@bebeau.org wrote:
<div class="message-stanza open">&gt;&gt; Hello,
&gt;&gt;
&gt;&gt; First of all, wanted to thank you for writing this module.
</div>&gt; I&#39;m glad that others can use this module.  I spent many hours reverse
&gt; engineering the poorly documented interface from NOAA.
&gt;
<div class="message-stanza open">&gt;&gt; Second, I&#39;ve included a patch to allow the nested elements of the CAP to
&gt;&gt; be stored in the events hash.  I also have code that would allow someone
&gt;&gt; to know if a latitude/longitude is contained within a polygon.
&gt;&gt; That should help to determine if a storm based warning surrounds a
&gt;&gt; specific area smaller than a county.
</div>&gt; :&#41; I also added code to support point in polygon detection.  I took a
&gt; slightly different approach.  My approach was first to separate the
&gt; &#34;polled&#34; counties from &#34;detected&#34; counties.  I then added support for
&gt; detection points.  With this method the module user can &#34;arm&#34; counties
&gt; and specific points for alert detection.  The cap data structure then
&gt; indicates if a tracked alert is inDetectionZone.  The nice thing about
&gt; this approach is that the module user can add multiple detection points
&gt; and the module takes care of iterating over each point.
&gt;
<div class="message-stanza open">&gt;&gt; Included is the patch I made, hopefully it can be helpful.
</div>&gt; I would like to combine what you and I have done.  1st a couple of
&gt; questions.  I implemented my own point in polygon code.  Do you think
&gt; that Math::Polygon will be better?  Maybe mathematically there is an
&gt; advantage to the existing module?  I don&#39;t mind using it if there is a
&gt; good reason but otherwise I&#39;d like to limit the number of dependencies.
&gt;   2nd you&#39;ve added support for nested elements.  Is this only to get at
&gt; the polygon?  Or do you think there is a general need?  My updates
&gt; retrieve the polygon data.
</div>
As far as detection of a point within the polygon, I just used 
Math::Polygon because I was lazy.  Since only the &#39;contains&#39; function is 
ever really called, it&#39;s probably a waste of resources to include 
Math::Polygon.

For the nested elements, I do use at least the VTEC parameter if it is 
defined.  The reason I do this is so that I can know if I&#39;ve already 
acted on this alert before, as well as only acting on specific types of 
&#39;actions&#39;, for example, only alert on &#39;NEW&#39; VTEC events, not CON &#40;event 
continued&#41; or EXT &#40;extended time&#41;/etc.

The table I referenced for VTEC explanation is here: 
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.nws.noaa.gov/os/vtec/pdfs/VTEC_explanation6.pdf">http://www.nws.noaa.gov/os/vtec/pdfs/VTEC_explanation6.pdf</a></span>

One other thing I noticed in your code is that if I have, let&#39;s say, 5 
detection points in one county and I want to only alert when any 
detection point is covered by a polygon, I will not know which of the 5 
is actually within the polygon when I check the events hash.

My end goal is to make it so, for example, 5 different buildings are 
monitored and if building 1 is affected, then send an alert to contact 
#1, if building 2 is affected, send to a different contact, and so on.

If you would include the matched detectionPoints in the events hash, 
that would eliminate that issue.

It might possibly be helpful to include links in the Perl documentation 
for the end user to look up their coordinates.  I&#39;ve been using these:

<span class="clickylink"><a target="new" rel="nofollow" href="http://geocoder.us/">http://geocoder.us/</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://itouchmap.com/latlong.html">http://itouchmap.com/latlong.html</a></span>

I&#39;ve never seen these things yet, but there is the &lt;circle&gt; tag defined 
in the CAP 1.1 document... pretty sure that is just for earthquake kinds 
of events, but I could possibly see it being used for a hurricane type 
of situation as well.


Anyway, thanks again for your time in writing this.  I wrote something 
similar to this a few years ago, but never ended up having the time to 
throw it up onto CPAN.  I was pleasantly surprised when I found your 
module there.

Thanks again.

Ryan Bebeau

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; If you have further questions, please let me know.
</div>&gt; I really appreciate the time you&#39;ve taken to use and modify the code.  I
&gt; am truly interested in combining the best of our ideas.  Let me know
&gt; what you think.  I&#39;ve attached my updated Alert.pm, example.pl, and
&gt; noaa_alert_win32.pl for you to take a look at.
&gt;
<div class="message-stanza open">&gt;&gt; Thanks,
&gt;&gt;
&gt;&gt; Ryan Bebeau
</div>&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;19&nbsp;11:57:26&nbsp;2012</span>
    <span class="description">STOVENOUR [...] cpan.org -  Given to STOVENOUR</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;28&nbsp;23:46:31&nbsp;2013</span>
    <span class="description">michael [...] thegrebs.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Any chances on a new release with these included?

I was just dumb and wasted a lot of time working on a patch to enable me doing the polygon stuff in my code.  It&#39;s my fault for not checking the bug tracker first, of course.

here are my two changes so I don&#39;t feel like I completely wasted my time, the approach is slightly different.

From 0066499a91cc317587d5de54e71f457ad7c05194 Mon Sep 17 00:00:00 2001
From: mikegrb &lt;mgreb@linode.com&gt;
Date: Sun, 28 Jul 2013 23:32:37 -0400
Subject: [PATCH 1/2] don&#39;t reformat the text of elements with child elements

---
 lib/Weather/NOAA/Alert.pm | 1 +
 1 file changed, 1 insertion&#40;+&#41;

diff --git a/lib/Weather/NOAA/Alert.pm b/lib/Weather/NOAA/Alert.pm
index 1ac0ed7..d376291 100755
--- a/lib/Weather/NOAA/Alert.pm
+++ b/lib/Weather/NOAA/Alert.pm
@@ -495,6 +495,7 @@ sub capFormatTags {
     #except the description and instruction; they need other adjustments.
     my @children = $capInfo-&gt;children;
     foreach my $child &#40;@children&#41; {
+        next if $child-&gt;children;
         my $childText = $child-&gt;text;
         if &#40;$child-&gt;tag ne &#39;description&#39; and $child-&gt;tag ne &#39;instruction&#39;&#41; {
             #Adjust the formatting a little.  Why would a CAP file 
-- 
1.8.1.6


From b515a234641d963e67b369175966c3246c203433 Mon Sep 17 00:00:00 2001
From: mikegrb &lt;mgreb@linode.com&gt;
Date: Sun, 28 Jul 2013 23:32:59 -0400
Subject: [PATCH 2/2] add the area polygon to the CAP event data structure

---
 lib/Weather/NOAA/Alert.pm | 2 ++
 1 file changed, 2 insertions&#40;+&#41;

diff --git a/lib/Weather/NOAA/Alert.pm b/lib/Weather/NOAA/Alert.pm
index d376291..fa38e94 100755
--- a/lib/Weather/NOAA/Alert.pm
+++ b/lib/Weather/NOAA/Alert.pm
@@ -443,6 +443,8 @@ sub retrieveCAP {
                     $self-&gt;{events}-&gt;{$zone}{$capId}{$child-&gt;tag} = $child-&gt;text;
                 }
             }
+            $self-&gt;{events}-&gt;{$zone}{$capId}{polygon}
+                = $capTwig-&gt;findvalue&#40;&#39;//info/area/polygon&#39;&#41;;
             $self-&gt;{events}-&gt;{$zone}{$capId}{&#39;delete&#39;} = 0;
             
         } else {
-- 
1.8.1.6
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
