<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #17941 for Test-MockObject: T::MO objects leak under certain circumstances</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #17941 for Test-MockObject: T::MO objects leak under certain circumstances</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Test-MockObject/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Test-MockObject/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Test-MockObject/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Test-MockObject/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Test-MockObject">Test-MockObject CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">17941</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">15 min

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Test-MockObject/Active/">Test-MockObject</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">chromatic [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dpisoni [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-31500-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.02    </td>
  </tr>
  <tr id="CF-31501-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.03    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;02&nbsp;13:19:11&nbsp;2006</span>
    <span class="description">dpisoni [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> T::MO objects leak under certain circumstances</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">There are two problems here
1&#41; T::MO uses an &#34;Inside Out&#34; technique to record certain instance data, but does not declare 
a destructor to free that data.
2&#41; Due to the nature of perl method invocation, the first argument to mock object method 
invocations is the mock object reference itself.  If the mock method has logging enabled, this 
reference is retained in the log.  Even if you solve the destructor problem above the 
destructor will never be invoked &#40;until global destruction&#41; because of the &#40;circular&#41; reference 
in the log.

Attached find mock_object_leak.pl, which reproduces the problem in Test::MockObject 1.02.
Expected behavior is that the weak references are cleared when we clear the normal 
references.  Actual behavior is that they persist until the &#34;clear&#40;&#41;&#34; method is called, cleaning 
the log.

Also attached is &#39;test-mockobject_leak_fix.diff&#39;, which is a patch against the T::MO 1.02 
distribution.  It includes a fix to the module and added tests in &#39;bugs.t&#39; to verify the fix.

I have tested this on MacOS X and Linux.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test-mockobject_leak_fix.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -uNr Test-MockObject-1.02.old/lib/Test/MockObject.pm Test-MockObject-1.02/lib/Test/MockObject.pm
--- Test-MockObject-1.02.old/lib/Test/MockObject.pm	2005-12-24 01:25:27.000000000 -0800
+++ Test-MockObject-1.02/lib/Test/MockObject.pm	2006-03-02 09:34:09.000000000 -0800
@@ -6,7 +6,7 @@
 use vars qw&#40; $VERSION $AUTOLOAD &#41;;
 $VERSION = &#39;1.02&#39;;
 
-use Scalar::Util qw&#40; blessed refaddr reftype &#41;;
+use Scalar::Util qw&#40; blessed refaddr reftype weaken &#41;;
 use UNIVERSAL::isa;
 use UNIVERSAL::can;
 
@@ -225,9 +225,15 @@
 sub log_call
 {
 	my &#40;$self, $sub&#41; = splice&#40; @_, 0, 2 &#41;;
-
 	return unless _logs&#40; $self, $sub &#41;;
-	push @{ _calls&#40; $self &#41; }, [ $sub, [ @_ ] ];
+	my $call_args = [ @_ ];
+	# prevent circular references with weaken
+	foreach my $pos &#40; 0..$#{ $call_args } &#41; {
+		weaken $call_args-&gt;[$pos] if &#40; ref&#40;$call_args-&gt;[$pos]&#41; and &#40;refaddr $call_args-&gt;[$pos] eq refaddr $self&#41; &#41;;
+#		# or consider this bold strategy, if you dare:
+# 		weaken $call_args-&gt;[$pos] if &#40; blessed&#40;$call_args-&gt;[$pos]&#41; and $call_args-&gt;[$pos]-&gt;isa&#40;ref $self&#41; &#41;;
+	}		
+	push @{ _calls&#40; $self &#41; }, [ $sub, $call_args ];
 }
 
 sub called_ok
@@ -293,6 +299,15 @@
 	$self-&gt;fake_module&#40; $class, new =&gt; sub { $self } &#41;;
 }
 
+sub DESTROY
+{
+	my $self = shift;
+	$self-&gt;_clear_calls&#40;&#41;;
+	$self-&gt;_clear_subs&#40;&#41;;
+	$self-&gt;_clear_logs&#40;&#41;;
+	$self-&gt;_clear_isas&#40;&#41;;
+}
+
 sub _get_key
 {
 	my $invocant = shift;
@@ -306,6 +321,11 @@
 	{
 		$calls{ _get_key&#40; shift &#41; } ||= [];
 	}
+
+	sub _clear_calls
+	{
+		delete $calls{ _get_key&#40; shift &#41; };
+	}
 }
 
 {
@@ -315,6 +335,11 @@
 	{
 		$subs{ _get_key&#40; shift &#41; } ||= {};
 	}
+
+	sub _clear_subs
+	{
+		delete $subs{ _get_key&#40; shift &#41; };
+	}
 }
 
 {
@@ -343,6 +368,11 @@
 		my &#40;$name&#41; = @_;
 		return exists $logs{$key}{$name};
 	}
+
+	sub _clear_logs
+	{
+		delete $logs{ _get_key&#40; shift &#41; };
+	}
 }
 
 {
@@ -352,6 +382,11 @@
 	{
 		$isas{ _get_key&#40; shift &#41; } ||= {};
 	}
+
+	sub _clear_isas
+	{
+		delete $isas{ _get_key&#40; shift &#41; };
+	}
 }
 
 1;
diff -uNr Test-MockObject-1.02.old/t/bugs.t Test-MockObject-1.02/t/bugs.t
--- Test-MockObject-1.02.old/t/bugs.t	2005-12-24 01:25:27.000000000 -0800
+++ Test-MockObject-1.02/t/bugs.t	2006-03-02 09:32:44.000000000 -0800
@@ -2,8 +2,9 @@
 
 use strict;
 use warnings;
+use Scalar::Util qw&#40;weaken&#41;;
 
-use Test::More tests =&gt; 14;
+use Test::More tests =&gt; 17;
 
 use Test::MockObject;
 my $mock = Test::MockObject-&gt;new&#40;&#41;;
@@ -114,3 +115,24 @@
 $id = &#39;my id&#39;;
 is&#40; &#34;$o&#34;, &#39;my id&#39;,    &#39;... and not be static&#39; &#41;;
 is&#40; $o-&gt;foo&#40;&#41;, &#39;foo&#39;, &#39;... but should not interfere with method finding&#39; &#41;;
+
+# no overload &#39;&#34;&#34;&#39;;
+
+# David Pisoni found memory leak condition
+{
+	# Setup MOs with 2 references
+	my&#40;$obj1, $obj2, $obj1prime, $obj2prime&#41;;
+	$obj1 = $obj1prime = Test::MockObject-&gt;new&#40;&#41;;
+	$obj2 = $obj2prime = Test::MockObject-&gt;new&#40;&#41;;
+	# Weaken one of the references each
+	weaken $obj1prime;
+	weaken $obj2prime;
+	# test for memory leak condition
+	$obj1-&gt;set_true&#40;&#39;this&#39;&#41;;
+	$obj1-&gt;this&#40;$obj2&#41;;
+	undef $obj2;
+	is&#40;ref&#40;$obj2prime&#41;, &#39;Test::MockObject&#39;, &#39;MO cached by another MO log should not be garbage collected&#39;&#41;;
+	undef $obj1;
+	ok&#40; !ref&#40;$obj2prime&#41;, &#39;... but should go away when caching MO is destructed&#39; &#41;;
+	ok&#40; !ref&#40;$obj1prime&#41;, &#39;... and the caching MO better be gone too or it will just leak everywhere!&#39; &#41;;
+}
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> mock_object_leak.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use Test::MockObject;
use Scalar::Util qw&#40;weaken&#41;;
use Data::Dumper;

# setup and report
my&#40;$obj1, $obj2, %container&#41;;
$obj1 = $container{obj1} = Test::MockObject-&gt;new&#40;&#41;;
$obj2 = $container{obj2} = Test::MockObject-&gt;new&#40;&#41;;
weaken $container{obj1};
weaken $container{obj2};
print &#34;Beginning state: &#34; . Dumper&#40;\%container&#41;;

# reproduce memory leak and report
$obj1-&gt;set_true&#40;&#39;this&#39;&#41;;
$obj1-&gt;this&#40;$obj2&#41;;
undef $obj2;
undef $obj1;
print &#34;After strong refs removed: &#34; . Dumper&#40;\%container&#41;;

# clear fixes this
$container{obj1}-&gt;clear&#40;&#41;;
print &#34;After clear&#40;&#41; method called: &#34; . Dumper&#40;\%container&#41;;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;04&nbsp;20:30:52&nbsp;2006</span>
    <span class="description">chromatic [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">15 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Good catch, thank you.  I applied the patch &#40;with a couple of tweaks&#41;
and everything passes as of 1.03.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;04&nbsp;20:30:54&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;04&nbsp;20:30:55&nbsp;2006</span>
    <span class="description">chromatic [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;04&nbsp;20:30:56&nbsp;2006</span>
    <span class="description">chromatic [...] cpan.org -  Given to CHROMATIC</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;06&nbsp;11:20:44&nbsp;2006</span>
    <span class="description">dpisoni [...] cpan.org -  Broken in 1.03 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;06&nbsp;11:20:44&nbsp;2006</span>
    <span class="description">dpisoni [...] cpan.org -  Broken in 1.02 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;06&nbsp;11:21:10&nbsp;2006</span>
    <span class="description">dpisoni [...] cpan.org -  Broken in 1.02 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;06&nbsp;11:21:10&nbsp;2006</span>
    <span class="description">dpisoni [...] cpan.org -  Broken in 1.03 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;06&nbsp;11:21:11&nbsp;2006</span>
    <span class="description">dpisoni [...] cpan.org -  Fixed in 1.03 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
