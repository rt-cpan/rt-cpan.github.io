<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #19773 for DBD-ODBC: Memory leak when using table variables in MSSQL via DBD-ODBC</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #19773 for DBD-ODBC: Memory leak when using table variables in MSSQL via DBD-ODBC</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-ODBC/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-ODBC/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-ODBC/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-ODBC/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-ODBC">DBD-ODBC CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">19773</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-ODBC/Active/">DBD-ODBC</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
david.brewer [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10188-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.13    </td>
  </tr>
  <tr id="CF-10189-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;07&nbsp;17:08:15&nbsp;2006</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Memory leak when using table variables in MSSQL via DBD-ODBC</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have identified what looks like a substantial memory leak that occurs
under a somewhat complicated set of circumstances.  I am guessing the
leak occurs in DBD::ODBC but don&#39;t know for sure.  I was unable to
reproduce it using DBD::ADO as an alternate driver.

I have attached a test script for reproducing the leak.  The details of
the leak and the usage of the script are documented in the script, but I
will also also describe the behavior in detail here.

Overview:

If you perform a particular type of query using MSSQL via DBI and
DBD::ODBC, a substantial amount of memory seems to get leaked on each
repetition of the query.  The amount of memory leaked varies with the
number of long text columns that you are selecting.

Details:

In order to reproduce the leak, you must meet four criteria:

1&#41; In your query, you must create a table variable.
2&#41; You must insert at least one row into the table variable.  After
that, you can completely ignore the table variable!
3&#41; You must select from a table that contains &#39;text&#39; columns.  The more
text columns you select, the larger the leak.  Note that you don&#39;t
actually have to select any rows to cause the leak.
4&#41; After executing the query, you must do something which triggers the
lookup of column information.  I&#39;ve found that either $sth-&gt;{NAME} or
$sth-&gt;fetchrow_hashref&#40;&#41; will cause the leak, for instance.

In addition, the &#39;LongReadLen&#39; property of the database handle is
somehow related because the higher this number, the greater the leak.

Modules involved: DBI 1.50, DBD::ODBC 1.13
Perl version: ActiveState ActivePerl 5.8.7
Database: MSSQL 2000 SP3.
OS: Windows XP SP2.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> mssql_leak.t</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">############################################################################
# mssql_leak.t
#
# Script for demonstrating substantial memory leak with DBI, DBD::ODBC, and
# a MSSQL 2000 database.
#
# To use this script you must have DBI 1.50, DBD::ODBC 1.13, and owner
# access to an MSSQL database.  A table called &#39;leak_test&#39; will be created
# and destroyed in the database.  See the CONFIGURATION section below to set
# up the desired connection.
#
# In order to reproduce the leak, you must meet four criteria:
#
# 1&#41; In your query, you must create a table variable.
# 2&#41; You must insert at least one row into the table variable.  After that,
#    you can completely ignore the table variable!
# 3&#41; You must select from a table that contains &#39;text&#39; columns.  The more
#    text columns you select, the larger the leak.  Note that you don&#39;t
#    actually have to select any rows to cause the leak!
# 4&#41; After executing the query, you must do something which triggers the
#    lookup of column information.  I&#39;ve found that either $sth-&gt;{NAME} or
#    $sth-&gt;fetchrow_hashref&#40;&#41; will cause the leak, for instance.
#
# In addition, the &#39;LongReadLen&#39; property of the database handle is somehow
# related because the higher this number, the greater the leak.
#
# Once you&#39;ve verified that the leak is occuring using the code below, you
# can try commenting out various lines to see how it affects things.
# The two clearest examples are commenting out the insertion into the
# table variable, and commenting out the $sth-&gt;{NAME} line.
#
# I wasn&#39;t able to figure out how to get at the memory usage of perl
# programmatically on Windows, so rather than writing tests to test the
# memory usage, I just made a loop that demonstrates the leak.  It pauses
# after the first iteration and then again at the end so you can observe the
# memory used by perl using the task manager or &#39;Process Explorer&#39; from
# sysinternals.com.
#
# Author:   David Brewer, Second Story Interactive
# Date:     June 7, 2006
############################################################################

use strict;
use warnings;

############################################################################
# CONFIGURATION
############################################################################

# Database connection
my $dsn  = &#34;DBI:ODBC:driver={SQL Server};server=localhost;database=test;&#34;;
my $user = &#34;test&#34;;
my $pass = &#34;test&#34;;

# number of times to perform the leaky query in the loop
my $leak_iterations = 1200;

# seconds to pause at beginning and end of loop to permit memory observation
my $pause = 7;

# LongReadLen value to use on the database handle; this is somehow related
# to the leak because the greater this value, the greater the leak.
my $LongReadLen = 20000;


############################################################################
# SETUP
############################################################################

use Test::More tests =&gt; 8;

# Verify we have the correct versions of the modules
BEGIN {
    use_ok&#40; &#39;DBI 1.50&#39; &#41;;
    use_ok&#40; &#39;DBD::ODBC 1.13&#39; &#41;;
}

# Prepare the database by creating the test table.  Drop it first if it
# already exists.

my $create_sql = q{
    IF OBJECT_ID&#40;&#39;leak_test&#39;,&#39;U&#39;&#41;IS NOT NULL DROP TABLE leak_test;
    CREATE TABLE [dbo].[leak_test] &#40;
        ID                int NOT NULL,
        LongText1         text,
        LongText2         text,
        LongText3         text,
        LongText4         text,
        LongText5         text,
        PRIMARY KEY &#40;ID&#41;
    &#41;
};

my $dbh = DBI-&gt;connect&#40;$dsn, $user, $pass&#41;;
isa_ok&#40;$dbh, &#39;DBI::db&#39;&#41;;
ok&#40;$dbh-&gt;do&#40;$create_sql&#41;, &#39;Created leak_test table&#39;&#41;;
ok&#40;$dbh-&gt;disconnect,      &#39;Disconnected from database&#39;&#41;;


############################################################################
# THE TEST
############################################################################

my $leaky_sql = q{
    DECLARE @table_variable TABLE &#40;
        TestInteger          int DEFAULT&#40;0&#41;
    &#41;;

    -- Commenting the line below prevents the leak!
    INSERT INTO @table_variable &#40;TestInteger&#41; VALUES &#40;1&#41;;

    SELECT TOP 0
        *
    FROM
        leak_test;
};

my $iterations = 1200;
print&#40;qq{
We will run the leaky query $leak_iterations times, pausing $pause seconds
after the first run so you can observe the memory usage.
}&#41;;

$dbh = DBI-&gt;connect&#40;$dsn, $user, $pass&#41;;
$dbh-&gt;{LongReadLen} = $LongReadLen;

for my $i &#40;1..$leak_iterations&#41; {
    # print a dot for each run through the query
    print &#34;\n&#34; if &#40;$i % 60 == 1&#41;;
    print &#34;.&#34;;

    # run our leaky query...
    my $sth = $dbh-&gt;prepare&#40;$leaky_sql&#41;;
    $sth-&gt;execute&#40;&#41;;

    # Getting column names triggers link; you can comment out to verify.
    my $names = $sth-&gt;{NAME};

    # clean up
    $sth-&gt;finish;
    undef $sth;

    # pause after the first run so you can observe the memory usage
    sleep&#40;$pause&#41; if &#40;$i == 1&#41;;
}

$dbh-&gt;disconnect&#40;&#41;;
undef $dbh;

print&#40;qq{
\nPausing $pause seconds so you can observe final memory usage.
}&#41;;
sleep&#40;$pause&#41;;


############################################################################
# CLEANUP
############################################################################

# Remove the leak_test table
my $cleanup_sql = q{
    IF OBJECT_ID&#40;&#39;leak_test&#39;,&#39;U&#39;&#41; IS NOT NULL DROP TABLE leak_test;
};

$dbh = DBI-&gt;connect&#40;$dsn, $user, $pass&#41;;
isa_ok&#40;$dbh, &#39;DBI::db&#39;&#41;;
ok&#40;$dbh-&gt;do&#40;$cleanup_sql&#41;, &#39;Removed leak_test table&#39;&#41;;
ok&#40;$dbh-&gt;disconnect,       &#39;Disconnected from database&#39;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;18&nbsp;09:19:05&nbsp;2008</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have not run this code until today as I did not maintain DBD::ODBC
when it was reported. With DBI 1.607 and DBD::ODBC 1.17_2 and the
Easysoft SQL Server ODBC Driver I cannot see any leak.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;18&nbsp;09:19:08&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;16&nbsp;14:56:56&nbsp;2009</span>
    <span class="description">bohica [...] ntlworld.com -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;14&nbsp;14:22:12&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Nov 18 09:19:05 2008, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have not run this code until today as I did not maintain DBD::ODBC
&gt; when it was reported. With DBI 1.607 and DBD::ODBC 1.17_2 and the
&gt; Easysoft SQL Server ODBC Driver I cannot see any leak.
&gt; 
&gt; Martin
</div>
As I&#39;ve heard nothing on this rt for over a year I am going to close it.
If you object to this let me know.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;14&nbsp;14:22:13&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;14&nbsp;14:22:24&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
