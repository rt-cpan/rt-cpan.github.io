<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #79733 for Thread-Queue: Idea: queue non-blocking option</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #79733 for Thread-Queue: Idea: queue non-blocking option</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Thread-Queue/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Thread-Queue/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Thread-Queue/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Thread-Queue/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Thread-Queue">Thread-Queue CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">79733</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Thread-Queue/Active/">Thread-Queue</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mschwern [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-220700-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.12    </td>
  </tr>
  <tr id="CF-220701-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
3.01    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;18&nbsp;16:57:48&nbsp;2012</span>
    <span class="description">mschwern [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Idea: queue non-blocking option</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have an idea for Thread::Queue: a method which switches the whole
queue to non-blocking.  This will make all calls to dequeue&#40;&#41;
non-blocking.  The purpose is to indicate that no more data is coming
and threads can safely shut down.

I hit upon this idea trying to take the SYNOPSIS into practice and hit a
snag...

    my $q = Thread::Queue-&gt;new&#40;&#41;;

    my $thr = threads-&gt;create&#40;sub {
        while &#40;my $item = $q-&gt;dequeue&#40;&#41;&#41; {
            # Do work on $item
        }
    }&#41;-&gt;detach&#40;&#41;;

    # Send work to the thread
    $q-&gt;enqueue&#40;$item1, ...&#41;;

The program will exit as soon as its done queuing and take the detached
threads with it.  I considered a few ways to fix this...

    while&#40; $q-&gt;pending &#41; {
        sleep 1;
    }

Polling sucks.  Worse, this could exit while workers are working on the
last items.

    $_-&gt;join for threads-&gt;list&#40;threads::running&#41;;

Seems simple enough, wait for all the threads to finish working.  Except
all the threads block on dequeue waiting for data that will never come.
 I can&#39;t use dequeue_nb&#40;&#41;, that risks the threads ending before I get a
chance to populate the queue.  If I prepopulate the queue, there&#39;s no
guarantee it won&#39;t be exhausted before I can add more.  There&#39;s various
ways to work around this, all seem overcomplicated.  This is where the
new feature comes in.

    $q-&gt;blocking&#40;0&#41;;
    $_-&gt;join for threads-&gt;list&#40;threads::running&#41;;

When the queue is exhausted, dequeue&#40;&#41; returns undef instead of blocking
and all the threads finish.  Simple.

There would be a corresponding is_blocking&#40;&#41; method.

I&#39;d originally thought about this as &#34;the queue is finished&#34;, because
that&#39;s my particular purpose, but that narrowed its utility too much. 
For example, if you&#39;re done adding items to a queue you probably
wouldn&#39;t allow more to be enqueued.

Happy to implement it.  Seems simple enough, dequeue&#40;&#41; just checks the
blocking&#40;&#41; flag and punts to dequeue_nb&#40;&#41; if its false.  blocking would
default to true and be an option to new&#40;&#41;.

What do you think?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;18&nbsp;19:54:59&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Good catch.  I agree with your assessment of the example code in the 
SYNOPSIS.  I&#39;m going to change it to the following:

    use strict;
    use warnings;

    use threads;
    use Thread::Queue;

    my $q = Thread::Queue-&gt;new&#40;&#41;;    # A new empty queue

    # Worker thread
    my $thr = threads-&gt;create&#40;
        sub {
            # Thread will loop until no more work
            while &#40;defined&#40;my $item = $q-&gt;dequeue&#40;&#41;&#41;&#41; {
                # Do work on $item
                ...
            }
        }
    &#41;;

    # Send work to the thread
    $q-&gt;enqueue&#40;$item1, ...&#41;;
    # Send &#39;undef&#39; to thread to signal no more work
    $q-&gt;enqueue&#40;undef&#41;;
    # Join up with the thread when it finishes
    $thr-&gt;join&#40;&#41;;

I believe this addresses your concerns regarding the literal usage of 
the sample code.  Of course, if &#39;undef&#39; is a valid work time for the 
thread, then something more elaborate would be needed - such as an 
explicit &#34;no more work&#34; flag - but that&#39;s an exercise to be left up to 
the user.

I don&#39;t deny that your suggestion may have potential merit, but I don&#39;t 
see that a blocking/non-blocking switch on the dequeue&#40;&#41; call adds any 
advantages over the &#34;solution&#34; above &#40;and it feels to me that it starts 
to diverge from the KISS principle&#41;.  I&#39;m, of course, open to more 
discussion if you have other insights on this.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;18&nbsp;19:55:00&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;18&nbsp;19:55:16&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Severity Wishlist added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;22&nbsp;15:44:26&nbsp;2012</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;d written up this whole thing about all the reasons having to put
together your own end-of-queue flag is inconvenient and bug prone and
harder to read and so on.

And then I notice something.

Your solution only works if there&#39;s one thread.  D&#39;oh!  The first thread
dequeues the magic value and the rest hang.

I couldn&#39;t figure out how to do it.  You, the author, made a mistake
doing it.  The original SYNOPSIS didn&#39;t think of it.  I think that&#39;s a
pretty solid argument for providing a built in, explicit, safe, no-edge
case way to solve this problem.

I&#39;ll code that patch up.

Here&#39;s my now moot magnum opus.

--------------------------------------------------------------------

I still think the block/non-block flag, or something like it, has merit.
 If for no other reason than that I didn&#39;t think of a solution and
neither did the original author of the SYNOPSIS.

And, as you pointed out, it avoids the issue of if undef is valid data
and having to make up your own &#34;end of queue&#34; value.  Proving your own
&#34;the queue is done&#34; value is hacky and has edge cases.  It means the
user of the queue has to be *careful* and that&#39;s something you don&#39;t
want, especially in threads.  The queue management code and the queue
worker code might be very far away from each other, and they must
coordinate their magic value use.  There could be multiple points of use
of the same queue, each having to be updated if the magic value changes.
 If an undef accidentally gets into the queue, all your workers will
stop.  If a queue forgets to check for the magic value, it will hang
waiting for more data.  And if TQ doesn&#39;t provide a way to do it,
everybody&#39;s going to write their own clever way which makes reading code
harder and introduces bugs.

That&#39;s off the top of my head.  Lots of subtle things can go wrong,
which means bugs.  Avoidable bugs.

As for which one is simpler, let&#39;s see it written out in a way which
provides all the safeguards but doesn&#39;t use any extra methods.

    use strict;
    use warnings;
    use threads;
    use Thread::Queue;

    my $q = Thread::Queue-&gt;new&#40;&#41;; # A new empty queue

    # Worker thread
    my $thr = threads-&gt;create&#40; sub {
        # Thread will loop until no more work is coming
        while &#40;1&#41; {
            my $item = $q-&gt;dequeue;
            last if eval { $item-&gt;isa&#40;&#34;Thread::Queue::Stop&#34;&#41; };

            # Do work on $item
            ...;
        }
    }&#41;;

    # Send work to the thread
    $q-&gt;enqueue&#40;$item1, ...&#41;;

    # Signal no more work is coming
    my $stop_flag = bless {}, &#34;Thread::Queue::Stop&#34;;
    $q-&gt;enqueue&#40;$stop_flag&#41;;

    # Join up with the thread when it finishes
    $thr-&gt;join&#40;&#41;;

Yuck.  You can probably do better, but TQ is a convenience module.  It&#39;s
not about if it&#39;s better than the *best* solution a user could come up
with.  It&#39;s about being better than the solution a user is *likely* to
come up with.

Just because there exists a solution doesn&#39;t mean one can&#39;t provide a
more obvious, more convenient and pre-packaged one.  For example, this
whole module is just a convenience wrapper around a shared array. 
done&#40;&#41; is a trivial amount of code, and the block/non-block switch comes
along for free.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;22&nbsp;18:38:38&nbsp;2012</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The attached patch implements done&#40;&#41; and should_block&#40;&#41; as discussed
earlier.  It also adds an example of its use.  I tried to follow the
existing style as much as possible.

In implementing I realized that its necessary for done&#40;&#41; to unblock any
threads blocking on dequeue&#40;&#41; should done&#40;&#41; be called after the queue is
already empty.  That issue alone necessitates done&#40;&#41; being part of
Thread::Queue.  I had done&#40;&#41; issue a cond_broadcast&#40;&#41;.  I&#39;ve never
gotten into the cond_blah stuff, so please triple check that work.

In order to allow the queue to have flags, it was necessary to turn it
into a hash ref object rather than a array ref.  Most of the change is that.

I merged the duplicated bits of dequeue&#40;&#41; and dequeue_nb&#40;&#41;.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> done.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/lib/Thread/Queue.pm b/lib/Thread/Queue.pm
index 8588ed5..7b43f82 100644
--- a/lib/Thread/Queue.pm
+++ b/lib/Thread/Queue.pm
@@ -20,72 +20,119 @@ sub new
 {
     my $class = shift;
     my @queue :shared = map { shared_clone&#40;$_&#41; } @_;
-    return bless&#40;\@queue, $class&#41;;
+    my %self :shared = &#40; queue =&gt; \@queue, should_block =&gt; 1 &#41;;
+    return bless&#40;\%self, $class&#41;;
 }
 
 # Add items to the tail of a queue
 sub enqueue
 {
-    my $queue = shift;
-    lock&#40;@$queue&#41;;
+    my $self = shift;
+    lock&#40;%$self&#41;;
+
+    my $queue = $self-&gt;{queue};
     push&#40;@$queue, map { shared_clone&#40;$_&#41; } @_&#41;
-        and cond_signal&#40;@$queue&#41;;
+        and cond_signal&#40;%$self&#41;;
 }
 
 # Return a count of the number of items on a queue
 sub pending
 {
-    my $queue = shift;
-    lock&#40;@$queue&#41;;
+    my $self = shift;
+    lock&#40;%$self&#41;;
+
+    my $queue = $self-&gt;{queue};
     return scalar&#40;@$queue&#41;;
 }
 
+# Indicate that no more data will enter the queue
+sub done
+{
+    my $self = shift;
+    lock $self;
+
+    # No more data is coming, don&#39;t block on an empty queue
+    $self-&gt;should_block&#40;0&#41;;
+
+    # Release all blocked queues
+    cond_broadcast&#40;%$self&#41;;
+
+    return;
+}
+
+# Should dequeue block?
+sub should_block
+{
+    my $self = shift;
+
+    if&#40; @_ &#41; {
+        $self-&gt;{should_block} = shift;
+        return;
+    }
+
+    return $self-&gt;{should_block};
+}
+
+
 # Return 1 or more items from the head of a queue, blocking if needed
 sub dequeue
 {
-    my $queue = shift;
-    lock&#40;@$queue&#41;;
+    my $self = shift;
+    lock&#40;%$self&#41;;
+
+    my $queue = $self-&gt;{queue};
 
     my $count = @_ ? $validate_count-&gt;&#40;shift&#41; : 1;
 
     # Wait for requisite number of items
-    cond_wait&#40;@$queue&#41; until &#40;@$queue &gt;= $count&#41;;
-    cond_signal&#40;@$queue&#41; if &#40;@$queue &gt; $count&#41;;
+    cond_wait&#40;%$self&#41; while &#40;$self-&gt;should_block &#38;&#38; @$queue &lt; $count&#41;;
+    cond_signal&#40;%$self&#41; if &#40;@$queue &gt; $count&#41;;
 
-    # Return single item
-    return shift&#40;@$queue&#41; if &#40;$count == 1&#41;;
-
-    # Return multiple items
-    my @items;
-    push&#40;@items, shift&#40;@$queue&#41;&#41; for &#40;1..$count&#41;;
-    return @items;
+    return $self-&gt;_dequeue_nb&#40;$count&#41;;
 }
 
 # Return items from the head of a queue with no blocking
 sub dequeue_nb
 {
-    my $queue = shift;
-    lock&#40;@$queue&#41;;
+    my $self = shift;
+    lock&#40;%$self&#41;;
+
+    my $queue = $self-&gt;{queue};
 
     my $count = @_ ? $validate_count-&gt;&#40;shift&#41; : 1;
 
+    # If there&#39;s not enough left in the queue, return what&#39;s left.
+    $count = @$queue if @$queue &lt; $count;
+
+    return $self-&gt;_dequeue_nb&#40;$count&#41;;
+}
+
+# Do the dequeuing.  Assume proper input and that the queue is locked.
+sub _dequeue_nb {
+    my $self = shift;
+    my $queue = $self-&gt;{queue};
+
+    my $count = shift;
+
+    return if &#40;$count == 0&#41;;
+
     # Return single item
     return shift&#40;@$queue&#41; if &#40;$count == 1&#41;;
 
     # Return multiple items
     my @items;
-    for &#40;1..$count&#41; {
-        last if &#40;! @$queue&#41;;
-        push&#40;@items, shift&#40;@$queue&#41;&#41;;
-    }
+    push&#40;@items, shift&#40;@$queue&#41;&#41; for &#40;1..$count&#41;;
     return @items;
 }
 
 # Return an item without removing it from a queue
 sub peek
 {
-    my $queue = shift;
-    lock&#40;@$queue&#41;;
+    my $self = shift;
+    lock&#40;%$self&#41;;
+
+    my $queue = $self-&gt;{queue};
+
     my $index = @_ ? $validate_index-&gt;&#40;shift&#41; : 0;
     return $$queue[$index];
 }
@@ -93,8 +140,10 @@ sub peek
 # Insert items anywhere into a queue
 sub insert
 {
-    my $queue = shift;
-    lock&#40;@$queue&#41;;
+    my $self = shift;
+    lock&#40;%$self&#41;;
+
+    my $queue = $self-&gt;{queue};
 
     my $index = $validate_index-&gt;&#40;shift&#41;;
 
@@ -121,14 +170,16 @@ sub insert
     push&#40;@$queue, @tmp&#41;;
 
     # Soup&#39;s up
-    cond_signal&#40;@$queue&#41;;
+    cond_signal&#40;%$self&#41;;
 }
 
 # Remove items from anywhere in a queue
 sub extract
 {
-    my $queue = shift;
-    lock&#40;@$queue&#41;;
+    my $self = shift;
+    lock&#40;%$self&#41;;
+
+    my $queue = $self-&gt;{queue};
 
     my $index = @_ ? $validate_index-&gt;&#40;shift&#41; : 0;
     my $count = @_ ? $validate_count-&gt;&#40;shift&#41; : 1;
@@ -139,7 +190,7 @@ sub extract
         if &#40;$index &lt; 0&#41; {
             $count += $index;
             return if &#40;$count &lt;= 0&#41;;            # Beyond the head of the queue
-            return $queue-&gt;dequeue_nb&#40;$count&#41;;  # Extract from the head
+            return $self-&gt;dequeue_nb&#40;$count&#41;;  # Extract from the head
         }
     }
 
@@ -224,14 +275,16 @@ This document describes Thread::Queue version 2.12
 
     # Worker thread
     my $thr = threads-&gt;create&#40;sub {
-                                while &#40;my $item = $q-&gt;dequeue&#40;&#41;&#41; {
-                                    # Do work on $item
-                                }
-                             }&#41;-&gt;detach&#40;&#41;;
+        while &#40;my $item = $q-&gt;dequeue&#40;&#41;&#41; {
+            # Do work on $item
+        }
+    }&#41;-&gt;detach&#40;&#41;;
 
     # Send work to the thread
     $q-&gt;enqueue&#40;$item1, ...&#41;;
 
+    # Done adding things to the queue, unblock any threads
+    $q-&gt;done;
 
     # Count of items in the queue
     my $left = $q-&gt;pending&#40;&#41;;
@@ -328,9 +381,13 @@ Adds a list of items onto the end of the queue.
 =item -&gt;dequeue&#40;COUNT&#41;
 
 Removes the requested number of items &#40;default is 1&#41; from the head of the
-queue, and returns them.  If the queue contains fewer than the requested
-number of items, then the thread will be blocked until the requisite number
-of items are available &#40;i.e., until other threads &lt;enqueue&gt; more items&#41;.
+queue, and returns them.
+
+If the queue contains fewer than the requested number of items, then
+the thread will be blocked until the requisite number of items are
+available &#40;i.e., until other threads &lt;enqueue&gt; more items&#41; unless C&lt;&lt;
+$queue-&gt;should_block &gt;&gt; is false as after C&lt;&lt; $queue-&gt;done &gt;&gt; is
+called.
 
 =item -&gt;dequeue_nb&#40;&#41;
 
@@ -346,6 +403,14 @@ returned.
 
 Returns the number of items still in the queue.
 
+=item -&gt;done&#40;&#41;
+
+Declares that no more items will be added to the queue.
+
+All queues blocked waiting for items will unblock.  All further
+dequeues and similar methods will no longer block waiting for more
+items.
+
 =back
 
 =head1 ADVANCED METHODS
@@ -442,8 +507,77 @@ greater than zero&#41;:
                                      # Queue now contains:  bar, baz
     my @rest = $q-&gt;extract&#40;-3, 4&#41;;   # Returns &#40;bar, baz&#41; - &#40;2+&#40;-3&#41;+4&#41; &gt; 0
 
+=item -&gt;should_block
+
+=item -&gt;should_block&#40;BOOLEAN&#41;
+
+Get/set whether dequeue&#40;&#41; and other blocking methods should block
+while waiting for more items.
+
+Defaults to true.
+
 =back
 
+=head1 EXAMPLE
+
+=head2 Incrementally feed a large amount of data to a queue
+
+Let&#39;s say you can&#39;t build the whole queue at once.  Maybe it&#39;s too
+much data to fit in memory.  Or maybe it just takes a long time to get
+it all.
+
+Here&#39;s an example with illustrating print statements how to slowly
+feed data to a queue while its being worked on using C&lt;enqueue&gt;,
+C&lt;dequeue&gt; and C&lt;done&gt;.
+
+    use strict;
+    use warnings;
+
+    use threads;
+    use Thread::Queue;
+
+    # This is our stand in for the slow data feed.  It will
+    # return a random number of items after a pause.
+    my @data = &#40;1..50&#41;;
+    sub get_data {
+        sleep 1;
+        return splice @data, 0, int&#40;rand&#40;10&#41;+1&#41;;
+    }
+
+    # A new empty queue
+    my $q = Thread::Queue-&gt;new&#40;&#41;;
+
+    # Make five worker threads.
+    # They will start and wait for work in the queue.
+    my @threads;
+    for my $thread &#40;1..5&#41; {
+        push @threads, threads-&gt;create&#40;sub {
+            my $tid = threads-&gt;tid;
+            print &#34;$tid: starting\n&#34;;
+            while &#40;my $item = $q-&gt;dequeue&#40;&#41;&#41; {
+                print &#34;$tid: got $item\n&#34;;
+            }
+            print &#34;$tid: done\n&#34;;
+        }&#41;;
+    }
+
+    # After the workers have started, slowly add work into the queue.
+    while&#40; my @data = get_data&#40;&#41; &#41; {
+        print &#34;Adding more data to the queue.\n&#34;;
+        $q-&gt;enqueue&#40;@data&#41;;
+    }
+
+    # No more data, declare the queue done.
+    $q-&gt;done;
+    print &#34;Done\n&#34;;
+
+    for my $thread &#40;@threads&#41; {
+        my $tid = $thread-&gt;tid;
+        print &#34;$tid: joining\n&#34;;
+        $thread-&gt;join;
+        print &#34;$tid: joined\b&#34;;
+    }
+
 =head1 NOTES
 
 Queues created by L&lt;Thread::Queue&gt; can be used in both threaded and
diff --git a/t/09_done_while_empty.t b/t/09_done_while_empty.t
new file mode 100644
index 0000000..b0316a6
--- /dev/null
+++ b/t/09_done_while_empty.t
@@ -0,0 +1,53 @@
+# Test that threads will unblock if done&#40;&#41; is called after the queue is
+# empty and threads are blocking.
+
+use strict;
+use warnings;
+
+use Config;
+
+BEGIN {
+    if &#40;! $Config{&#39;useithreads&#39;}&#41; {
+        print&#40;&#34;1..0 # SKIP Perl not compiled with &#39;useithreads&#39;\n&#34;&#41;;
+        exit&#40;0&#41;;
+    }
+}
+
+use threads;
+use Thread::Queue;
+
+use Test::More;
+
+my @items = 1..20;
+my $num_threads = 3;
+plan tests =&gt; @items + &#40;$num_threads * 2&#41;;
+
+my $q = Thread::Queue-&gt;new&#40;&#41;;
+
+my @threads;
+for my $i &#40;1..$num_threads&#41; {
+    push @threads, threads-&gt;create&#40; sub {
+        # Thread will loop until no more work is coming
+        while &#40;defined&#40; my $item = $q-&gt;dequeue &#41;&#41; {
+            pass&#40;&#34;&#39;$item&#39; read from queue&#34;&#41;;
+            select&#40;undef, undef, undef, rand&#40;1&#41;&#41;;
+        }
+        pass&#40;&#34;Thread $i exiting&#34;&#41;;
+    }&#41;;
+}
+
+$q-&gt;enqueue&#40;@items&#41;;
+
+# Make sure there&#39;s nothing in the queue and threads are blocking.
+sleep 1 while $q-&gt;pending;
+sleep 1;
+
+# Signal no more work is coming to the blocked threads, they
+# should unblock.
+$q-&gt;done;
+note &#34;Done sent&#34;;
+
+for my $thread &#40;@threads&#41; {
+    $thread-&gt;join;
+    pass&#40;$thread-&gt;tid.&#34; joined&#34;&#41;;
+}
diff --git a/t/10_done_not_empty.t b/t/10_done_not_empty.t
new file mode 100644
index 0000000..e585136
--- /dev/null
+++ b/t/10_done_not_empty.t
@@ -0,0 +1,48 @@
+# Test that threads will keep going after done&#40;&#41; is called if there&#39;s more
+# in the queue.
+
+use strict;
+use warnings;
+
+use Config;
+
+BEGIN {
+    if &#40;! $Config{&#39;useithreads&#39;}&#41; {
+        print&#40;&#34;1..0 # SKIP Perl not compiled with &#39;useithreads&#39;\n&#34;&#41;;
+        exit&#40;0&#41;;
+    }
+}
+
+use threads;
+use Thread::Queue;
+
+use Test::More;
+
+my @items = 1..30;
+my $num_threads = 3;
+plan tests =&gt; @items + &#40;$num_threads * 2&#41;;
+
+my $q = Thread::Queue-&gt;new&#40;&#41;;
+
+my @threads;
+for my $i &#40;1..$num_threads&#41; {
+    push @threads, threads-&gt;create&#40; sub {
+        # Thread will loop until no more work is coming
+        while &#40;defined&#40; my $item = $q-&gt;dequeue &#41;&#41; {
+            pass&#40;&#34;&#39;$item&#39; read from queue&#34;&#41;;
+            select&#40;undef, undef, undef, rand&#40;1&#41;&#41;;
+        }
+        pass&#40;&#34;Thread $i exiting&#34;&#41;;
+    }&#41;;
+}
+
+$q-&gt;enqueue&#40;@items&#41;;
+
+# Signal no more work is coming while there&#39;s still stuff in the queue.
+$q-&gt;done;
+note &#34;Done sent&#34;;
+
+for my $thread &#40;@threads&#41; {
+    $thread-&gt;join;
+    pass&#40;$thread-&gt;tid.&#34; joined&#34;&#41;;
+}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;23&nbsp;15:29:40&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79733] Idea: queue non-blocking option</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 23 Oct 2012 15:28:59 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Thread-Queue [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jerry D. Hedden&#34; &lt;jdhedden [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2012-10-22 15:44:26, MSCHWERN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Your solution only works if there&#39;s one thread.  D&#39;oh!
&gt; The first thread dequeues the magic value and the rest
&gt; hang.
&gt;
&gt; I couldn&#39;t figure out how to do it.  You, the author, made
&gt; a mistake doing it.  The original SYNOPSIS didn&#39;t think of
&gt; it.  I think that&#39;s a pretty solid argument for providing
&gt; a built in, explicit, safe, no-edge case way to solve this
&gt; problem.
</div>
No, I didn&#39;t make a mistake.  My example was simplistic with
only one thread.  If you have more, then you send more
&#39;undef&#39;s - one &#40;or more as appropriate&#41; per thread.  For
example:

    $_-&gt;enqueue&#40;undef&#41; foreach &#40;threads-&gt;list&#40;threads::running&#41;&#41;;

Since each thread will only dequeue one &#39;undef&#39; to stop
work, this is the solution.  I use a similar approach in
examples/pool_reuse.pl in the &#39;threads&#39; distribution.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;             my $item = $q-&gt;dequeue;
&gt;             last if eval { $item-&gt;isa&#40;&#34;Thread::Queue::Stop&#34;&#41; };
</div>...
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     # Signal no more work is coming
&gt;     my $stop_flag = bless {}, &#34;Thread::Queue::Stop&#34;;
&gt;     $q-&gt;enqueue&#40;$stop_flag&#41;;
</div>
I like this concept of constructing a specific termination
item.  Quite clever.  For more threads, you&#39;d just use:

    $_-&gt;enqueue&#40;$stop_flag&#41; foreach &#40;threads-&gt;list&#40;threads::running&#41;&#41;;

As to your patch, I&#39;m concerned about a few issues I noted.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I had done&#40;&#41; issue a cond_broadcast&#40;&#41;.  I&#39;ve never gotten
&gt; into the cond_blah stuff, so please triple check that
&gt; work.
</div>
This is inappropriate.  cond_broadcast&#40;&#41; wakes up all
threads which can then all attempt to dequeue items at the
same time and hence cause data integrity problems &#40;e.g.,
more than one thread getting the same queue item&#41;.  The fix
is to use cond_signal&#40;&#41; and to also put a test on
should_block on the cond_signal call in dequeue&#40;&#41;:

    cond_signal&#40;%$self&#41; if &#40;&#40;@$queue &gt; $count&#41; || ! $self-&gt;should_block&#41;;

In &#39;dequeue&#39; you have:

    cond_wait&#40;%$self&#41; while &#40;$self-&gt;should_block &#38;&#38; @$queue &lt; $count&#41;;

If the queue is set to &#39;done&#40;&#41;&#39; before the $count
requirement is met, then a blocked thread will not get the
correct number of items it is expecting.  This means the
programmer needs to check for this, and take corrective
action.  This is conceptually similar to the objections you
brought up in the first place.  &#40;I.e., if the programmer is
not *careful*, the program will go awry.&#41;  This is not a bad
thing per se, but it does illustrate that no matter what is
conceived of, the programmer will still be responsible for
programming things correctly.

Then in your merged _dequeue_nb&#40;&#41; you have:

    push&#40;@items, shift&#40;@$queue&#41;&#41; for &#40;1..$count&#41;;

If $count is greater than the size of the queue, then
&#39;undef&#39;s will be added to the queue which again may &#40;or may
not&#41; be problematic.  That is why the two dequeue methods
were separate.

I think I will eliminate the should_block&#40;&#41; call.  I cannot
conceive of a significant situation when a programmer would
need to sent a queue to non-blocking and then back again.

All told, thanks for the ideas and the code.  I will work it
into an update and send it to you under separate cover for
your further comment.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;23&nbsp;18:43:25&nbsp;2012</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Oct 23 15:29:40 2012, JDHEDDEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 2012-10-22 15:44:26, MSCHWERN wrote:
<div class="message-stanza open">&gt; &gt; Your solution only works if there&#39;s one thread.  D&#39;oh!
&gt; &gt; The first thread dequeues the magic value and the rest
&gt; &gt; hang.
&gt; &gt;
&gt; &gt; I couldn&#39;t figure out how to do it.  You, the author, made
&gt; &gt; a mistake doing it.  The original SYNOPSIS didn&#39;t think of
&gt; &gt; it.  I think that&#39;s a pretty solid argument for providing
&gt; &gt; a built in, explicit, safe, no-edge case way to solve this
&gt; &gt; problem.
</div>&gt; 
&gt; No, I didn&#39;t make a mistake.  My example was simplistic with
&gt; only one thread.  If you have more, then you send more
&gt; &#39;undef&#39;s - one &#40;or more as appropriate&#41; per thread.  For
&gt; example:
&gt; 
&gt;     $_-&gt;enqueue&#40;undef&#41; foreach &#40;threads-&gt;list&#40;threads::running&#41;&#41;;
&gt; 
&gt; Since each thread will only dequeue one &#39;undef&#39; to stop
&gt; work, this is the solution.  I use a similar approach in
&gt; examples/pool_reuse.pl in the &#39;threads&#39; distribution.
</div>...
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I like this concept of constructing a specific termination
&gt; item.  Quite clever.  For more threads, you&#39;d just use:
&gt; 
&gt;     $_-&gt;enqueue&#40;$stop_flag&#41; foreach &#40;threads-&gt;list&#40;threads::running&#41;&#41;;
</div>
I hope you&#39;ll agree, it&#39;s not a very safe solution.  You have to know A&#41;
how many threads are running and B&#41; what their behavior will be.

A has a race condition where if a thread starts in the middle of that
loop, you&#39;re hosed.  You have to patch it up with something like...

    $_-&gt;enqueue&#40;$stop_flag&#41; for threads-&gt;list&#40;threads::running&#41;
        while&#40;threads-&gt;list&#40;threads::running&#41;&#41;;

But I&#39;m not even sure that&#39;s always reliable.

B relies on the queuer having intimate knowledge of how each worker
behaves.  Each worker must always pull a fixed and known number of items
off the queue before exiting.  Consider the following...

    sub work {
        my $item1 = $q-&gt;dequeue;

        ...do some work on $item1...

        my $item2 = $q-&gt;dequeue;

        ...do some work on $item1 and $item2...
    }

Is the thread blocked on the first one or the second one?  How many do
you put on the queue?  Sure, you might say &#34;why would you do that when
you can my @items = $q-&gt;dequeue&#40;2&#41;; but somebody will do it.

Here&#39;s maybe a more practical example.  Two different sets of workers,
one dequeues 1 at a time, one dequeues 3 at a time.  threads::running
only tells you how many workers you have, not which type they are. 
Either you need to add bookkeeping or you need to feed threads::running
* 3 elements onto the queue.  And hope the race condition doesn&#39;t start
again.

What if there&#39;s two sets of workers, each talking to a different queue?
 Now you need lists of what workers are on what queue.  What if there&#39;s
a third set not talking to any queue at all?  What if there&#39;s a fourth
talking to two queues, one is exhausted and one which is not?  It might
eat your stop flags before other threads get to see them, causing some
threads to never unblock.

If the queue doesn&#39;t have total control of which threads are working on
their queue I don&#39;t think there&#39;s ANY reliable way to guarantee your
workers will unblock.  You wind up shovelling stop flags onto the queue
as fast as possible and hope you can outrun the potential race conditions.

More likely a user doesn&#39;t think about any of this.  &#34;Stop on a magic
flag off the queue&#34; requires too much careful coordination between the
workers and the queue manager.  It&#39;s too easy to get into a state where
workers exhaust the stop flag &#40;or forget to look for it&#41; and wind up
blocking.  Doing it right involves a lot of careful consideration and a
lot of code, which means a lot of people are going to get it subtly wrong.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; As to your patch, I&#39;m concerned about a few issues I noted.
&gt; 
<div class="message-stanza open">&gt; &gt; I had done&#40;&#41; issue a cond_broadcast&#40;&#41;.  I&#39;ve never gotten
&gt; &gt; into the cond_blah stuff, so please triple check that
&gt; &gt; work.
</div>&gt; 
&gt; This is inappropriate.  cond_broadcast&#40;&#41; wakes up all
&gt; threads which can then all attempt to dequeue items at the
&gt; same time and hence cause data integrity problems &#40;e.g.,
&gt; more than one thread getting the same queue item&#41;.
&gt;
&gt; The fix
&gt; is to use cond_signal&#40;&#41; and to also put a test on
&gt; should_block on the cond_signal call in dequeue&#40;&#41;:
&gt; 
&gt;     cond_signal&#40;%$self&#41; if &#40;&#40;@$queue &gt; $count&#41; || ! $self-&gt;should_block&#41;;
</div>
I&#39;m a bit nervous about this.  It seems to rely on done&#40;&#41; issuing
cond_signal, getting picked up by one thread which then wakes up and
issues a cond_signal to the next thread which then wakes up and issues a
cond_signal to the next thread... a chain which could be broken.  A
single &#34;wake everybody up&#34; call seems more reliable.

Shouldn&#39;t the lock on %$self in dequeue&#40;&#41; protect against multiple
threads trying to pull data from it at once?  If not, would a second
lock inside _dequeue_nb&#40;&#41; cover that?

I wrote up some test code to try and make a collision but couldn&#39;t get
one with either my patch or 3.01.
<span class="clickylink"><a target="new" rel="nofollow" href="https://gist.github.com/3942210">https://gist.github.com/3942210</a></span>


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In &#39;dequeue&#39; you have:
&gt; 
&gt;     cond_wait&#40;%$self&#41; while &#40;$self-&gt;should_block &#38;&#38; @$queue &lt; $count&#41;;
&gt; 
&gt; If the queue is set to &#39;done&#40;&#41;&#39; before the $count
&gt; requirement is met, then a blocked thread will not get the
&gt; correct number of items it is expecting.  This means the
&gt; programmer needs to check for this, and take corrective
&gt; action.  This is conceptually similar to the objections you
&gt; brought up in the first place.  &#40;I.e., if the programmer is
&gt; not *careful*, the program will go awry.&#41;  This is not a bad
&gt; thing per se, but it does illustrate that no matter what is
&gt; conceived of, the programmer will still be responsible for
&gt; programming things correctly.
</div>
You&#39;re right, and &#34;bad data&#34; is a more prosaic sort of failure already
present, anybody can put bad data onto the queue, and MUCH easier to
debug than concurrency bugs.  One way to mitigate it would be to change
dequeue&#40;&#41; so it throws an exception if not enough items are pulled off
the queue.  Then the developer can&#39;t miss the mistake.  Also it&#39;s
impossible to tell &#34;bad data in the queue&#34; from &#34;the queue is exhausted&#34;
otherwise.  Checking $q-&gt;pending after $q-&gt;dequeue invites a race
condition.  I like that idea.

dequeue&#40;&#41; on an exhausted queue is always going to return a single
scalar undef or fixed size list possibly containing some undefs
&#40;depending on how you asked for them&#41;.  While dequeue_nb&#40;&#41; is going to
return an empty list.  I think this consistent with how these methods
work normally, dequeue&#40;&#41; is always going to give you a fixed list while
dequeue_nb&#40;&#41; gives you whatever&#39;s left.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Then in your merged _dequeue_nb&#40;&#41; you have:
&gt; 
&gt;     push&#40;@items, shift&#40;@$queue&#41;&#41; for &#40;1..$count&#41;;
&gt; 
&gt; If $count is greater than the size of the queue, then
&gt; &#39;undef&#39;s will be added to the queue which again may &#40;or may
&gt; not&#41; be problematic.  That is why the two dequeue methods
&gt; were separate.
</div>
Assuming the queue is locked during the operation &#40;ie. your cond fixes
are applied&#41; this is accounted for.  dequeue&#40;&#41; will always return a
fixed size list.  dequeue_nb&#40;&#41; will knock the count down to what&#39;s left
in the queue...

    # If there&#39;s not enough left in the queue, return what&#39;s left.
    $count = @$queue if @$queue &lt; $count;

This is the same as their current behaviors which I just left alone.

If it makes you more comfortable to keep them separate but a bit
redundant that&#39;s fine.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think I will eliminate the should_block&#40;&#41; call.  I cannot
&gt; conceive of a significant situation when a programmer would
&gt; need to sent a queue to non-blocking and then back again.
</div>
I&#39;m cool with eliminating it from the public API.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; All told, thanks for the ideas and the code.  I will work it
&gt; into an update and send it to you under separate cover for
&gt; your further comment.
</div>
This reply is already too huge.  Let me do that in a separate reply.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;23&nbsp;19:16:59&nbsp;2012</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I put your 3.01 tarball into my local git repo so I can compare it a bit
easier.  Aside from the changes to how threads are unblocked discussed
earlier, the major issue I have is adding the restriction that no more
values can be added to a queue after it&#39;s been declared done.

I can see why you&#39;d want it either way, so I&#39;d suggest having two modes.
 Both unblock the queue, but one prevents adding anything more and the
other does not.  I like &#34;close&#34; rather than &#34;end&#34;, the queue is closed
to new input, but no biggie.  &#34;Unblock&#34; is the other mode, same as
&#34;done&#34;, it just unblocks the queue but its still open to input.  Being
closed implies being unblocked.

I also don&#39;t see why these states cannot be flipped.  There&#39;s no
internal reason why not, and it provides the user with more flexibility
to do things we might not imagine.  I can imagine some things I&#39;d do
with it.  Consider having a data input that comes in waves.  Sometimes
you have a ton of data, sometimes you have a trickle.  When a big chunk
comes you might want to spin up a lot of workers.  When it abates you
might want to set the queue to &#34;unblocked&#34; so workers can exit.  Later
when data floods in again you might want to set the queue to blocked
again so workers stick around.  This might be better done with a
separate worker manager monitoring the queue, but that adds a whole
additional subsystem and its nice to have MTOWTDI.

If you don&#39;t want to worry about that just yet, end/close could be added
alone with the semantics you&#39;ve provided and done/unblock added later.

Other than that, some minor bits...

* The note about the effect of end/done on dequeue was removed.  It
really needs to be mentioned there in the dequeue&#40;&#41; docs because it
changes the behavior of dequeue&#40;&#41;.  It&#39;s where the user is going to be
looking for information about dequeue&#40;&#41;, and not in a disjoint section
at the bottom of the documentation.

* Calling the flag ENDED&#40;&#41; is disjoint from everything similar in the
API like pending&#40;&#41;.  It should be ended&#40;&#41;.  Also the docs state ENDED is
a method, but there is no ENDED method.  It should *not* be a hash key
the user grabs at, there&#39;s no reason to expose the object internals.

* The EXAMPLE was removed.  I think it should go back.  Its a useful and
more realistic example than the SYNOPSIS.  It shows managing multiple
threads as well as using illustrating print statements so the user can
trace what&#39;s going on while running the code.  And because it doesn&#39;t
have to try and show every feature it is clearer.

* More thoughts on dequeue&#39;s behavior on an unblocked queue... I think
there&#39;s THREE outcomes of dequeue&#40;&#41; when unblocked, particularly
dequeue&#40;$n &gt; 1&#41;.  1&#41; Here is the data you requested.  2&#41; There is no
more data.  3&#41; You requested more data than is on the queue.  Currently
you cannot safely distinguish these states.

I&#39;m thinking 1&#41; a scalar or list like normal, 2&#41; empty list, 3&#41; an
exception.  That makes all these do the right thing.

    eval {
        while&#40;my @items = $q-&gt;dequeue&#40;$n&#41;&#41; { ... }
    }
    if&#40; $@ &#41; {
        ...handle there not being enough in the queue...
    }

    # Important that it works with both styles
    while&#40;my $item  = $q-&gt;dequeue&#41; { ... }
    while&#40;my&#40;$item&#41; = $q-&gt;dequeue&#41; { ... }

Normally they&#39;ll loop.  When the queue is exhausted they&#39;ll exit.  If
there&#39;s not enough in the queue &#40;only possible with the first one&#41; they
get an exception.  No special checks for undef or the number of items
returned necessary.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;23&nbsp;21:09:52&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79733] Idea: queue non-blocking option</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 23 Oct 2012 21:09:10 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Thread-Queue [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jerry D. Hedden&#34; &lt;jdhedden [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; * Calling the flag ENDED&#40;&#41; is disjoint from everything
&gt; similar in the API like pending&#40;&#41;.  It should be ended&#40;&#41;.
&gt; Also the docs state ENDED is a method, but there is no
&gt; ENDED method.  It should *not* be a hash key the user
&gt; grabs at, there&#39;s no reason to expose the object
&gt; internals.
</div>
Thanks for pointing this out.  I&#39;ve removed it, and changed
the -&gt;pending&#40;&#41; method as follows:

=item -&gt;pending&#40;&#41;

Returns the number of items still in the queue.  Returns
C&lt;undef&gt; if the queue has been ended &#40;see below&#41;, and there
are no more items in the queue.

&#40;Yes, I&#39;m sure you&#39;re cringing at this, but I think it makes
sense.&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; * The EXAMPLE was removed.  I think it should go back.
&gt; Its a useful and more realistic example than the SYNOPSIS.
&gt; It shows managing multiple threads as well as using
&gt; illustrating print statements so the user can trace what&#39;s
&gt; going on while running the code.  And because it doesn&#39;t
&gt; have to try and show every feature it is clearer.
</div>
There&#39;s an &#39;examples&#39; sub-dir in the CPAN distribution.  I&#39;m
updated examples/queue.pl to include the new -&gt;end&#40;&#41; method.
I don&#39;t feel that the POD is a good place for long stretches
of example code, and the SYNOPSIS is just that - a synopsis
- code fragments to give you a clue and refresh your memory
after you&#39;ve read to docs.

I appreciate your passion for wanting to improve the module.
However, the first step is to get this by all of the p5p
people.  Thread::Queue is a core module - I don&#39;t really own
it.  The fact that the structure of the queue object is
changing is huge &#40;IMO&#41;, and may be a deal breaker for
getting this through.  &#40;All the arguments about bad
practices aside.&#41;  &#40;Then again, it might be that no one
takes notice or cares.&#41;

And I am in no way trying to be flippant here - I do respect
your ideas - but you could also release your own module to
CPAN that replaces Thread::Queue or extends it.  For
example, I like your Thread::Queue::Stop idea.  It&#39;s a shame
it wasn&#39;t there from the start.  I&#39;d like to see
dequeue_nb&#40;&#41; changed to return it instead of undef, and
similarly have dequeue&#40;&#41; return it when the queue is ended.
That would allow undef to be used as data so-to-speak.  But
of course such a change could not be made to Thread::Queue
otherwise the entirety of the known universe would cease to
exist.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;24&nbsp;20:52:33&nbsp;2012</span>
    <span class="description">schwern [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79733] Idea: queue non-blocking option</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 24 Oct 2012 17:52:17 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Thread-Queue [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michael G Schwern &lt;schwern [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2012.10.23 6:09 PM, Jerry D. Hedden via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=79733">https://rt.cpan.org/Ticket/Display.html?id=79733</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt;&gt; * Calling the flag ENDED&#40;&#41; is disjoint from everything
&gt;&gt; similar in the API like pending&#40;&#41;.  It should be ended&#40;&#41;.
&gt;&gt; Also the docs state ENDED is a method, but there is no
&gt;&gt; ENDED method.  It should *not* be a hash key the user
&gt;&gt; grabs at, there&#39;s no reason to expose the object
&gt;&gt; internals.
</div>&gt; 
&gt; Thanks for pointing this out.  I&#39;ve removed it, and changed
&gt; the -&gt;pending&#40;&#41; method as follows:
&gt; 
&gt; =item -&gt;pending&#40;&#41;
&gt; 
&gt; Returns the number of items still in the queue.  Returns
&gt; C&lt;undef&gt; if the queue has been ended &#40;see below&#41;, and there
&gt; are no more items in the queue.
&gt; 
&gt; &#40;Yes, I&#39;m sure you&#39;re cringing at this,
</div>
Yep, actually said &#34;No! No! Oh god no!&#34; to myself in my kitchen when I read it. :&#41;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; but I think it makes sense.&#41;
</div>
Tell me why this make sense?


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; * The EXAMPLE was removed.  I think it should go back.
&gt;&gt; Its a useful and more realistic example than the SYNOPSIS.
&gt;&gt; It shows managing multiple threads as well as using
&gt;&gt; illustrating print statements so the user can trace what&#39;s
&gt;&gt; going on while running the code.  And because it doesn&#39;t
&gt;&gt; have to try and show every feature it is clearer.
</div>&gt; 
&gt; There&#39;s an &#39;examples&#39; sub-dir in the CPAN distribution.
</div>
Most users don&#39;t even know that exists because they do CPAN shell installs, I
never noticed it and I&#39;m patching the distribution!  They don&#39;t survive
install which gives them a user a fleeting moment to consult them.  Consider
moving them to the POD.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m
&gt; updated examples/queue.pl to include the new -&gt;end&#40;&#41; method.
&gt; I don&#39;t feel that the POD is a good place for long stretches
&gt; of example code
</div>
Examples in POD may not be perfect, much easier to test files on disk, but at
least it will be seen.  Perfect documentation which is never read might as
well not exist.

Perhaps mention the examples directory in the POD so when a user searches for
&#34;example&#34; they&#39;ll see that and know it exists.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I appreciate your passion for wanting to improve the module.
&gt; However, the first step is to get this by all of the p5p
&gt; people.  Thread::Queue is a core module - I don&#39;t really own
&gt; it.  The fact that the structure of the queue object is
&gt; changing is huge &#40;IMO&#41;, and may be a deal breaker for
&gt; getting this through.  &#40;All the arguments about bad
&gt; practices aside.&#41;  &#40;Then again, it might be that no one
&gt; takes notice or cares.&#41;
</div>
I checked the logs.  p5p hasn&#39;t touched TQ since it was split out of
threads::shared 10 years ago.  They&#39;ve just been picking up your releases
since then.  You own it.

Thread::Queue is an object and it has a very neat and well documented API.
There is no documented exposure of the underlying data structure, and the API
is very good so there&#39;s no need to grab at it, so there is no real risk in
changing the underlying structure.

If you bring this up on p5p people will whinge about what if there&#39;s code out
there which assumed the queue was an array and you&#39;ll have a big, unnecessary
argument.  Really this has all already been resolved: if it&#39;s not documented
it doesn&#39;t exist.  I have a wonderful quote from Tom Christiansen on this...

    You are wicked and wrong to have broken inside and peeked at the
    implementation and then relied upon it.
        -- tchrist in &lt;31832.969261130@chthon&gt;

p5p has as much power as you give them, mainly in how much you attract their
attention.  So long as you&#39;re not breaking compatibility, just make a CPAN
release and they&#39;ll update it like they have in the past.  Mention it in the
change log.

That&#39;s my advice.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; And I am in no way trying to be flippant here - I do respect
&gt; your ideas - but you could also release your own module to
&gt; CPAN that replaces Thread::Queue or extends it.
</div>
I don&#39;t think we&#39;re anywhere near the need to fork the module.  Please don&#39;t
take my vigorous discussions as real dissatisfaction.  It&#39;s enthusiasm and a
desire to get it right so the user doesn&#39;t have to be careful.  That
philosophy of module design may be the real difference here?

Also I know jack all about threads.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; For
&gt; example, I like your Thread::Queue::Stop idea.  It&#39;s a shame
&gt; it wasn&#39;t there from the start.  I&#39;d like to see
&gt; dequeue_nb&#40;&#41; changed to return it instead of undef, and
&gt; similarly have dequeue&#40;&#41; return it when the queue is ended.
&gt; That would allow undef to be used as data so-to-speak.  But
&gt; of course such a change could not be made to Thread::Queue
&gt; otherwise the entirety of the known universe would cease to
&gt; exist.
</div>
While I agree that allowing undef as data is important, I still think stop
flags are a bad idea.  Continuously returning one only solves one half of that
problem, the worker still needs a bunch of code to detect the stop flag which
the user is likely to forget.  List vs empty list covers the problem well.
The snag being that dequeue&#40;$n=1&#41; always returns a single scalar, there&#39;s no
way to use it in list return mode.


-- 
125. Two drink limit does not mean two kinds of drinks.
    -- The 213 Things Skippy Is No Longer Allowed To Do In The U.S. Army
           <span class="clickylink"><a target="new" rel="nofollow" href="http://skippyslist.com/list/">http://skippyslist.com/list/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;07&nbsp;12:18:17&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">3.01 on CPAN
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;07&nbsp;12:18:18&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;07&nbsp;12:18:27&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Fixed in 3.01 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
