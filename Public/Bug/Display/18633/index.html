<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #18633 for DBD-SQLite: t/07busy.t hangs</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #18633 for DBD-SQLite: t/07busy.t hangs</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-SQLite/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-SQLite">DBD-SQLite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">18633</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-SQLite/Active/">DBD-SQLite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jdhedden [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10248-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.12    </td>
  </tr>
  <tr id="CF-10249-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;10&nbsp;08:39:02&nbsp;2006</span>
    <span class="description">jdhedden [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> t/07busy.t hangs</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Using Perl 5.8.8 under Cygwin, DBD-SQLite 1.12 fails testing because
test file 07busy.t hangs and must be terminated with ^C.  Here is the
test output:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; perl -Mblib t/07busy.t 
</div>1..8
# Running under perl version 5.008008 for cygwin
# Current time local: Mon Apr 10 08:32:25 2006
# Current time GMT:   Mon Apr 10 12:32:25 2006
# Using Test.pm version 1.25
ok 1
ok 2
ok 3
ok 4
ok 5
# insert failed : DBD::SQLite::db do failed: database is locked&#40;5&#41; at
dbdimp.c line 398 at t/07busy.t line 29.
ok 6
DBD::SQLite::db do failed: database is locked&#40;5&#41; at dbdimp.c line 398 at
t/07busy.t line 71.
Issuing rollback&#40;&#41; for database handle being DESTROY&#39;d without explicit
disconnect&#40;&#41;.

### At this point I have to terminate the test with ^C.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;11&nbsp;03:17:06&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I get
1..8
# Running under perl version 5.008004 for MSWin32
# Win32::BuildNumber 810
# Current time local: Tue Apr 11 00:17:21 2006
# Current time GMT:   Tue Apr 11 07:17:21 2006
# Using Test.pm version 1.25
ok 1
ok 2
ok 3
ok 4
ok 5
# insert failed : DBD::SQLite::db do failed: database is locked&#40;5&#41; at
dbdimp.c line 398 at t\07busy.t line 29.
ok 6
DBD::SQLite::db do failed: handle 2 is owned by thread 22471c not
current thread 1a6a9a4 &#40;handles can&#39;t be shared between threads and your
driver may
need a CLONE method added&#41; at t\07busy.t line 71.
Attempt to free unreferenced scalar: SV 0x1b48f54.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;11&nbsp;03:17:07&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;11&nbsp;09:04:06&nbsp;2006</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jdhedden [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; DBD::SQLite::db do failed: handle 2 is owned by thread 22471c not
&gt; current thread 1a6a9a4 &#40;handles can&#39;t be shared between threads and your
&gt; driver may
&gt; need a CLONE method added&#41; at t\07busy.t line 71.
&gt; Attempt to free unreferenced scalar: SV 0x1b48f54.
</div>
To the implementer:
The test uses &#39;fork&#39;.  Under Win32, &#39;fork&#39; is implemented using threads
and DBI is not thread safe.  Therefore, you cannot use &#39;fork&#39; in your tests.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;11&nbsp;09:34:37&nbsp;2006</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; To the implementer:
&gt; The test uses &#39;fork&#39;.  Under Win32, &#39;fork&#39; is implemented using threads
&gt; and DBI is not thread safe.  Therefore, you cannot use &#39;fork&#39; in your
</div>tests.

Correction.  You just can&#39;t have open database handles when you do a
fork.  Attached is a version of t/07busy.t that should work under Win32.
 I does work on my system and solves the problem of the hang that I
observed.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!perl

use Test;
BEGIN { plan tests =&gt; 8 }
use DBI;

unlink&#40;&#39;foo&#39;, &#39;foo-journal&#39;&#41;;
my $db = DBI-&gt;connect&#40;&#39;dbi:SQLite:foo&#39;, &#39;&#39;, &#39;&#39;,
{
    RaiseError =&gt; 1,
    PrintError =&gt; 0,
    AutoCommit =&gt; 0,
}&#41;;

my $db2 = DBI-&gt;connect&#40;&#39;dbi:SQLite:foo&#39;, &#39;&#39;, &#39;&#39;,
{
    RaiseError =&gt; 1,
    PrintError =&gt; 0,
    AutoCommit =&gt; 0,
}&#41;;

ok&#40;$db2-&gt;func&#40;3000, &#39;busy_timeout&#39;&#41;&#41;;

ok&#40;$db-&gt;do&#40;&#34;CREATE TABLE Blah &#40; id INTEGER, val VARCHAR &#41;&#34;&#41;&#41;;
ok&#40;$db-&gt;commit&#41;;
ok&#40;$db-&gt;do&#40;&#34;INSERT INTO Blah VALUES &#40; 1, &#39;Test1&#39; &#41;&#34;&#41;&#41;;
my $start = time;
eval {
    $db2-&gt;do&#40;&#34;INSERT INTO Blah VALUES &#40; 2, &#39;Test2&#39; &#41;&#34;&#41;;
};
ok&#40;$@&#41;;
if &#40;$@&#41; {
    print &#34;# insert failed : $@&#34;;
    $db2-&gt;rollback;
}

$db-&gt;commit;
ok&#40;$db2-&gt;do&#40;&#34;INSERT INTO Blah VALUES &#40; 2, &#39;Test2&#39; &#41;&#34;&#41;&#41;;
$db2-&gt;commit;

$db2-&gt;disconnect;
undef&#40;$db2&#41;;

$db-&gt;disconnect;
undef&#40;$db&#41;;

# Now test that two processes can write at once, assuming we commit timely.

pipe&#40;READER, WRITER&#41;;
my $pid = fork;
if &#40;!defined&#40;$pid&#41;&#41; {
    # fork failed
    skip&#40;&#34;No fork here&#34;, 1&#41;;
    skip&#40;&#34;No fork here&#34;, 1&#41;;
    exit;
}

if &#40;$pid&#41; {
    # Parent
    my $db2 = DBI-&gt;connect&#40;&#39;dbi:SQLite:foo&#39;, &#39;&#39;, &#39;&#39;,
    {
        RaiseError =&gt; 1,
        PrintError =&gt; 0,
        AutoCommit =&gt; 0,
    }&#41;;
    my $line = &lt;READER&gt;;
    chomp&#40;$line&#41;;
    ok&#40;$line, &#34;Ready&#34;&#41;;
    $db2-&gt;func&#40;10000, &#39;busy_timeout&#39;&#41;;
    ok&#40;$db2-&gt;do&#40;&#34;INSERT INTO Blah VALUES &#40;4, &#39;Test4&#39; &#41;&#34;&#41;&#41;;
    $db2-&gt;commit;
    wait;

} else {
    # Child
    my $db = DBI-&gt;connect&#40;&#39;dbi:SQLite:foo&#39;, &#39;&#39;, &#39;&#39;,
    {
        RaiseError =&gt; 1,
        PrintError =&gt; 0,
        AutoCommit =&gt; 0,
    }&#41;;
    $db-&gt;do&#40;&#34;INSERT INTO Blah VALUES &#40; 3, &#39;Test3&#39; &#41;&#34;&#41;;
    print WRITER &#34;Ready\n&#34;;
    sleep&#40;5&#41;;
    $db-&gt;commit;
}

exit&#40;0&#41;;

# EOF
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;12&nbsp;12:47:40&nbsp;2006</span>
    <span class="description">nilsonsfj [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Apr 10 08:39:02 2006, JDHEDDEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Using Perl 5.8.8 under Cygwin, DBD-SQLite 1.12 fails testing because
&gt; test file 07busy.t hangs and must be terminated with ^C.  Here is the
&gt; test output:
&gt; 
<div class="message-stanza open">&gt; &gt; perl -Mblib t/07busy.t 
</div>&gt; 1..8
&gt; # Running under perl version 5.008008 for cygwin
&gt; # Current time local: Mon Apr 10 08:32:25 2006
&gt; # Current time GMT:   Mon Apr 10 12:32:25 2006
&gt; # Using Test.pm version 1.25
&gt; ok 1
&gt; ok 2
&gt; ok 3
&gt; ok 4
&gt; ok 5
&gt; # insert failed : DBD::SQLite::db do failed: database is locked&#40;5&#41; at
&gt; dbdimp.c line 398 at t/07busy.t line 29.
&gt; ok 6
&gt; DBD::SQLite::db do failed: database is locked&#40;5&#41; at dbdimp.c line 398 at
&gt; t/07busy.t line 71.
&gt; Issuing rollback&#40;&#41; for database handle being DESTROY&#39;d without explicit
&gt; disconnect&#40;&#41;.
&gt; 
&gt; ### At this point I have to terminate the test with ^C.
</div>
Same issue happens with AS Perl 5.8.8.

t/07busy................ok 5/8DBD::SQLite::db do failed: handle 2 is
owned by th
read 235004 not current thread 2a96f54 &#40;handles can&#39;t be shared between
threads
and your driver may need a CLONE method added&#41; at t/07busy.t line 71.

If I kill the respective perl process, the tests keep running and all
of them manage to succeed &#40;besides, obviously, the one that hanged&#41;.

-Nilson Santos F. Jr.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;12&nbsp;12:47:47&nbsp;2006</span>
    <span class="description">nilsonsfj [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Apr 10 08:39:02 2006, JDHEDDEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Using Perl 5.8.8 under Cygwin, DBD-SQLite 1.12 fails testing because
&gt; test file 07busy.t hangs and must be terminated with ^C.  Here is the
&gt; test output:
&gt; 
<div class="message-stanza open">&gt; &gt; perl -Mblib t/07busy.t 
</div>&gt; 1..8
&gt; # Running under perl version 5.008008 for cygwin
&gt; # Current time local: Mon Apr 10 08:32:25 2006
&gt; # Current time GMT:   Mon Apr 10 12:32:25 2006
&gt; # Using Test.pm version 1.25
&gt; ok 1
&gt; ok 2
&gt; ok 3
&gt; ok 4
&gt; ok 5
&gt; # insert failed : DBD::SQLite::db do failed: database is locked&#40;5&#41; at
&gt; dbdimp.c line 398 at t/07busy.t line 29.
&gt; ok 6
&gt; DBD::SQLite::db do failed: database is locked&#40;5&#41; at dbdimp.c line 398 at
&gt; t/07busy.t line 71.
&gt; Issuing rollback&#40;&#41; for database handle being DESTROY&#39;d without explicit
&gt; disconnect&#40;&#41;.
&gt; 
&gt; ### At this point I have to terminate the test with ^C.
</div>
Same issue happens with AS Perl 5.8.8.

t/07busy................ok 5/8DBD::SQLite::db do failed: handle 2 is
owned by th
read 235004 not current thread 2a96f54 &#40;handles can&#39;t be shared between
threads
and your driver may need a CLONE method added&#41; at t/07busy.t line 71.

If I kill the respective perl process, the tests keep running and all
of them manage to succeed &#40;besides, obviously, the one that hanged&#41;.

-Nilson Santos F. Jr.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;07&nbsp;16:20:29&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bart.lateur [...] pandora.be</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Apr 11 09:34:37 2006, JDHEDDEN wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You just can&#39;t have open database handles when you do a
&gt; fork.  Attached is a version of t/07busy.t that should work under Win32.
&gt;  I does work on my system and solves the problem of the hang that I
&gt; observed.
</div>
I&#39;ve been working on the same bug as you, and at first sight, your patch
would seem to work. &#40;I wonder why this is not applied yet?&#41; What is
really the problem is that parent and child got swapped. It is the
parent, the original process, which should keep the original handle
open, and the child which needs to open a secondary db handle.

In addition, there&#39;s a minor problem with buffering in the pipe, and the
other process gets the &#34;go&#34; signal too late. It should get it in the
sleep&#40;5&#41; period. My patch &#40;attached&#41; stays closer to the original test
file than your, so it&#39;s more obvious what I changed. And it is not much.

So, in summary: what happens is that the child thread attempts to use
the original db handle, which belongs to the parent, and it croaks. &#40;On
Unix, with real processes, this most likely is permissible, though I
recommend against it: if you may only use a db handle in one process,
it&#39;s best to let the original process, the parent, have it.&#41; 

The parent, waiting for the signal from the child through the pipe to
continue, never gets the signal, and waits forever. Ergo, it appears to
hang.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- t/07busy.t	Sun Aug  8 16:02:23 2004
+++ t/07busy.pl	Sun May  7 19:54:30 2006
@@ -51,8 +51,8 @@
     skip&#40;&#34;No fork here&#34;, 1&#41;;
     exit;
 }
-if &#40;$pid&#41; {
-    # parent
+unless &#40;$pid&#41; {
+    # child
     my $db2 = DBI-&gt;connect&#40;&#39;dbi:SQLite:foo&#39;, &#39;&#39;, &#39;&#39;,
     {
         RaiseError =&gt; 1,
@@ -68,7 +68,9 @@
     exit;
 }

+# parent
 $db-&gt;do&#40;&#34;INSERT INTO Blah VALUES &#40; 3, &#39;Test3&#39; &#41;&#34;&#41;;
+select WRITER; $| = 1; select STDOUT;
 print WRITER &#34;Ready\n&#34;;
 sleep&#40;5&#41;;
 $db-&gt;commit;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;07&nbsp;19:25:52&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bart.lateur [...] pandora.be</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun May 07 16:20:29 2006, guest wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What is
&gt; really the problem is that parent and child got swapped. It is the
&gt; parent, the original process, which should keep the original handle
&gt; open, and the child which needs to open a secondary db handle.
</div>
Oh wait, I see now why parent and child were set up the way they were.
The child still should be the one creating the new database handle, but
in the original script the parent was chosen instead because that is
then the process that outputs the test results.

So I&#39;ve moved things around a little. A new patch is attached. It&#39;s much
 closer now to one of JDHEDDEN.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- t/07busy.t	Sun Aug  8 16:02:23 2004
+++ t/07busy.pl	Sun May  7 23:16:00 2006
@@ -49,28 +49,26 @@
     # fork failed
     skip&#40;&#34;No fork here&#34;, 1&#41;;
     skip&#40;&#34;No fork here&#34;, 1&#41;;
-    exit;
-}
-if &#40;$pid&#41; {
-    # parent
+} elsif &#40;!$pid&#41; {
+    # child
     my $db2 = DBI-&gt;connect&#40;&#39;dbi:SQLite:foo&#39;, &#39;&#39;, &#39;&#39;, 
     {
         RaiseError =&gt; 1,
         PrintError =&gt; 0,
         AutoCommit =&gt; 0,
     }&#41;;
+    $db2-&gt;do&#40;&#34;INSERT INTO Blah VALUES &#40; 3, &#39;Test3&#39; &#41;&#34;&#41;;
+    select WRITER; $| = 1; select STDOUT;
+    print WRITER &#34;Ready\n&#34;;
+    sleep&#40;5&#41;;
+    $db2-&gt;commit;
+} else {
+    # parent
     my $line = &lt;READER&gt;;
     chomp&#40;$line&#41;;
     ok&#40;$line, &#34;Ready&#34;&#41;;
-    $db2-&gt;func&#40;10000, &#39;busy_timeout&#39;&#41;;
-    ok&#40;$db2-&gt;do&#40;&#34;INSERT INTO Blah VALUES &#40;4, &#39;Test4&#39; &#41;&#34;&#41;&#41;;
-    $db2-&gt;commit;
-    exit;
+    $db-&gt;func&#40;10000, &#39;busy_timeout&#39;&#41;;
+    ok&#40;$db-&gt;do&#40;&#34;INSERT INTO Blah VALUES &#40;4, &#39;Test4&#39; &#41;&#34;&#41;&#41;;
+    $db-&gt;commit;
+    wait;
 }
-
-$db-&gt;do&#40;&#34;INSERT INTO Blah VALUES &#40; 3, &#39;Test3&#39; &#41;&#34;&#41;;
-print WRITER &#34;Ready\n&#34;;
-sleep&#40;5&#41;;
-$db-&gt;commit;
- 
-
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;08&nbsp;05:37:56&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bart.lateur [...] pandora.be</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun May 07 19:25:52 2006, guest wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So I&#39;ve moved things around a little. A new patch is attached.
</div>
I forgot one thing: if the other process dies, the parent will still
wait forever. That can be remedied by closing the WRITER pipe on the
READER side. A patch on the patch is attached.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- t/07busy.pl Sun May 7 23:16:00 2006
+++ t/07busy2.pl    Mon May  8 09:33:26 2006
@@ -64,6 +64,7 @@
     $db2-&gt;commit;
 } else {
     # parent
+    close WRITER;
     my $line = &lt;READER&gt;;
     chomp&#40;$line&#41;;
     ok&#40;$line, &#34;Ready&#34;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;19&nbsp;07:34:16&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Alexandr Ciornii &lt;alexchorny [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&gt; So I&#39;ve moved things around a little. A new patch is attached.
</div>Test with patches &#40;including close_writer.patch&#41; works for me.
perl 5.8.7 &#40;from port&#41;, CYGWIN 1.5.19.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;07&nbsp;19:03:41&nbsp;2006</span>
    <span class="description">msergeant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Applying, thanks.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;07&nbsp;19:03:42&nbsp;2006</span>
    <span class="description">msergeant [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
