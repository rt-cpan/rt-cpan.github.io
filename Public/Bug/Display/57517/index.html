<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #57517 for Fuse: Addition of file handles on open files</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #57517 for Fuse: Addition of file handles on open files</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Fuse">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Fuse">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Fuse">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Fuse">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Fuse">Fuse CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">57517</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Fuse">Fuse</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">DPAVLIN [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
gerph [...] gerph.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-13886-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.09_3    </td>
  </tr>
  <tr id="CF-13887-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.09_4    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




Fuse-filehandles.zip<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/777445/402668/Fuse-filehandles.zip">
Sat May 15 16:36:47 2010 (13.8k) by gerph [...] gerph.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=57517">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-777445" href="/Public/Bug/Display.html?id=57517#txn-777445">#</a>      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;15&nbsp;16:36:47&nbsp;2010</span>
    <span class="description">gerph [...] gerph.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Addition of file handles on open files</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/777445/402667/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/402667">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hiya,

Whilst trying to write a filesystem using the Fuse module, I found it 
surprising that there were no &#39;file handles&#39; available when you opened 
a file. The only way you can know what file was referenced is by its 
name, which is not useful if your filesystem is intended to return 
different results for each file opened. It turned out in my case to not 
matter, but consider a FS which returned a different story every time 
you opened it. Or, more practically, a FS which returned the contents 
of the latest checked in file - and whilst you were operating on the 
file the latest checked in file changed. There are ways around this - 
files becoming invariant whilst it has any open instances of itself or 
similar - but these are not ideal.

The way that Fuse appears to do this is that the filesystem updates a 
property &#40;&#39;fh&#39;&#41; in the fuse_file_info structure on open, to contain the 
context for the opened file. I&#39;ve put together a change which allows 
you to return a second parameter from open containing this value, which 
is then passed to all the functions which operate on open files &#40;read, 
write, flush, release&#41;. Because we&#39;re retaining a reference to the SV 
that was returned &#40;and is otherwise unused in the perl&#41; we also 
increment the refcount on open, and decrement it on release - I think 
that&#39;s all that&#39;s necessary to prevent a leak, but I&#39;ve never done any 
XS work before this so I can&#39;t be certain.

I&#39;d expect that under normal circumstances you&#39;d open a file, set up a 
hashref containing properties for the file that you&#39;ve opened and use 
&#39;return &#40;0, $handle&#41;;&#39; to return it. If you don&#39;t return a handle, the 
old behaviour remains - undef will be passed to the implementation in 
place of the handle &#40;which the implementation wasn&#39;t expecting so won&#39;t 
care about&#41;.

In addition, I&#39;ve also added the ability to set the &#39;direct_io&#39;, 
&#39;keepcache&#39; and &#39;nonseekable&#39; properties by changing a hashref which is 
passed to the &#39;open&#39; call.

The archive I&#39;ve attached contains the Fuse.pm and Fuse.xs files in 
their entirity, together with the diffs from 0.09_3. There is also a 
rudimentary example FS, based on the example one in the Fuse 
distribution, which shows the file handle to be working. It seems to be 
working in my more complex MythTV filesystem that I&#39;m still trying to 
make useful.

I couldn&#39;t actually test the nonseekable property as the fuse I have 
seems to be 2.4, so I don&#39;t have that property available to me here - 
I&#39;ve just followed what the documentation says should be available.

I&#39;ve not added anything to the tests, because I&#39;m not sure how to do 
that really, but I hope that the change to add the file handles is 
useful.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Fuse-filehandles.zip</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/777445/402668/Fuse-filehandles.zip">Download Fuse-filehandles.zip</a><br />
<span class="downloadcontenttype">application/zip 13.8k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-777759" href="/Public/Bug/Display.html?id=57517#txn-777759">#</a>      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;16&nbsp;12:29:39&nbsp;2010</span>
    <span class="description">DPAVLIN [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-777760" href="/Public/Bug/Display.html?id=57517#txn-777760">#</a>      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;16&nbsp;12:31:12&nbsp;2010</span>
    <span class="description">DPAVLIN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/777760/402817/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/402817">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 113b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">committed to branch in development repository:

<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/dpavlin/perl-fuse/commits/rt-57517-file-handles">http://github.com/dpavlin/perl-fuse/commits/rt-57517-file-handles</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-777762" href="/Public/Bug/Display.html?id=57517#txn-777762">#</a>      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;16&nbsp;12:31:13&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-778034" href="/Public/Bug/Display.html?id=57517#txn-778034">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;17&nbsp;08:15:26&nbsp;2010</span>
    <span class="description">DPAVLIN [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-778035" href="/Public/Bug/Display.html?id=57517#txn-778035">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;17&nbsp;08:15:30&nbsp;2010</span>
    <span class="description">DPAVLIN [...] cpan.org -  Fixed in 0.09_4 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-778153" href="/Public/Bug/Display.html?id=57517#txn-778153">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;17&nbsp;12:46:25&nbsp;2010</span>
    <span class="description">DPAVLIN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/778153/403020/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/403020">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 47b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for patch, new version is pushed to CPAN
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-778155" href="/Public/Bug/Display.html?id=57517#txn-778155">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;17&nbsp;12:46:26&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-778156" href="/Public/Bug/Display.html?id=57517#txn-778156">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;17&nbsp;12:46:26&nbsp;2010</span>
    <span class="description">DPAVLIN [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-895470" href="/Public/Bug/Display.html?id=57517#txn-895470">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;10&nbsp;15:05:53&nbsp;2011</span>
    <span class="description">daniel.frett [...] ccci.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> daniel.frett [...] ccci.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/895470/464250/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/464250">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat May 15 16:36:47 2010, gerph wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hiya,
&gt; 
&gt; Whilst trying to write a filesystem using the Fuse module, I found it 
&gt; surprising that there were no &#39;file handles&#39; available when you opened 
&gt; a file. The only way you can know what file was referenced is by its 
&gt; name, which is not useful if your filesystem is intended to return 
&gt; different results for each file opened. It turned out in my case to not 
&gt; matter, but consider a FS which returned a different story every time 
&gt; you opened it. Or, more practically, a FS which returned the contents 
&gt; of the latest checked in file - and whilst you were operating on the 
&gt; file the latest checked in file changed. There are ways around this - 
&gt; files becoming invariant whilst it has any open instances of itself or 
&gt; similar - but these are not ideal.
&gt; 
&gt; The way that Fuse appears to do this is that the filesystem updates a 
&gt; property &#40;&#39;fh&#39;&#41; in the fuse_file_info structure on open, to contain the 
&gt; context for the opened file. I&#39;ve put together a change which allows 
&gt; you to return a second parameter from open containing this value, which 
&gt; is then passed to all the functions which operate on open files &#40;read, 
&gt; write, flush, release&#41;. Because we&#39;re retaining a reference to the SV 
&gt; that was returned &#40;and is otherwise unused in the perl&#41; we also 
&gt; increment the refcount on open, and decrement it on release - I think 
&gt; that&#39;s all that&#39;s necessary to prevent a leak, but I&#39;ve never done any 
&gt; XS work before this so I can&#39;t be certain.
&gt; 
&gt; I&#39;d expect that under normal circumstances you&#39;d open a file, set up a 
&gt; hashref containing properties for the file that you&#39;ve opened and use 
&gt; &#39;return &#40;0, $handle&#41;;&#39; to return it. If you don&#39;t return a handle, the 
&gt; old behaviour remains - undef will be passed to the implementation in 
&gt; place of the handle &#40;which the implementation wasn&#39;t expecting so won&#39;t 
&gt; care about&#41;.
&gt; 
&gt; In addition, I&#39;ve also added the ability to set the &#39;direct_io&#39;, 
&gt; &#39;keepcache&#39; and &#39;nonseekable&#39; properties by changing a hashref which is 
&gt; passed to the &#39;open&#39; call.
&gt; 
&gt; The archive I&#39;ve attached contains the Fuse.pm and Fuse.xs files in 
&gt; their entirity, together with the diffs from 0.09_3. There is also a 
&gt; rudimentary example FS, based on the example one in the Fuse 
&gt; distribution, which shows the file handle to be working. It seems to be 
&gt; working in my more complex MythTV filesystem that I&#39;m still trying to 
&gt; make useful.
&gt; 
&gt; I couldn&#39;t actually test the nonseekable property as the fuse I have 
&gt; seems to be 2.4, so I don&#39;t have that property available to me here - 
&gt; I&#39;ve just followed what the documentation says should be available.
&gt; 
&gt; I&#39;ve not added anything to the tests, because I&#39;m not sure how to do 
&gt; that really, but I hope that the change to add the file handles is 
&gt; useful.
</div>

using this feature in threaded mode I get the following seg fault when triggering a release 
callback:

panic: free from wrong pool at /usr/local/lib64/perl5/site_perl/5.10.0/x86_64-linux-
thread-multi/Fuse.pm line 115, &lt;Sock_172.21.1.234:6001&gt; line 7.
Segmentation fault
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-895473" href="/Public/Bug/Display.html?id=57517#txn-895473">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;10&nbsp;15:05:54&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-897360" href="/Public/Bug/Display.html?id=57517#txn-897360">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;15&nbsp;14:11:27&nbsp;2011</span>
    <span class="description">daniel.frett [...] ccci.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> daniel.frett [...] ccci.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/897360/465294/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/465294">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 501b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Feb 10 15:05:53 2011, dfrett wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; using this feature in threaded mode I get the following seg fault when
&gt; triggering a release
&gt; callback:
&gt; 
&gt; panic: free from wrong pool at
&gt; /usr/local/lib64/perl5/site_perl/5.10.0/x86_64-linux-
&gt; thread-multi/Fuse.pm line 115, &lt;Sock_172.21.1.234:6001&gt; line 7.
&gt; Segmentation fault
</div>

just pushed a patch in github that makes the handles shared across threads when running in 
threaded mode. the patch is here: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dpavlin/perl-fuse/pull/4">https://github.com/dpavlin/perl-fuse/pull/4</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-897440" href="/Public/Bug/Display.html?id=57517#txn-897440">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;15&nbsp;17:19:23&nbsp;2011</span>
    <span class="description">gerph [...] gerph.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> gerph [...] gerph.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/897440/465347/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/465347">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 782b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Feb 15 14:11:27 2011, dfrett wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Feb 10 15:05:53 2011, dfrett wrote:
<div class="message-stanza open">&gt; &gt; using this feature in threaded mode I get the following seg fault
</div>&gt; when
<div class="message-stanza open">&gt; &gt; triggering a release
&gt; &gt; callback:
&gt; &gt;
&gt; &gt; panic: free from wrong pool at
&gt; &gt; /usr/local/lib64/perl5/site_perl/5.10.0/x86_64-linux-
&gt; &gt; thread-multi/Fuse.pm line 115, &lt;Sock_172.21.1.234:6001&gt; line 7.
&gt; &gt; Segmentation fault
</div>&gt; 
&gt; 
&gt; just pushed a patch in github that makes the handles shared across
&gt; threads when running in
&gt; threaded mode. the patch is here: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dpavlin/perl-">https://github.com/dpavlin/perl-</a></span>
&gt; fuse/pull/4
</div>
Ah. I&#39;d not tried the threaded mode because of concerns over how it 
handled such things - and clearly I didn&#39;t consider this when I made my 
patch. I&#39;ll try to give your updated version a whirl shortly.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1071489" href="/Public/Bug/Display.html?id=57517#txn-1071489">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;25&nbsp;14:41:00&nbsp;2012</span>
    <span class="description">demon [...] now.ai -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1071489/563659/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/563659">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 405b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Feb 15 17:19:23 2011, gerph wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ah. I&#39;d not tried the threaded mode because of concerns over how it 
&gt; handled such things - and clearly I didn&#39;t consider this when I made my 
&gt; patch. I&#39;ll try to give your updated version a whirl shortly.
&gt; 
</div>
File handles are supported &#40;as of 0.12 and later&#41; in all functions, as 
well as directory handles for opendir/readdir/closedir/fsyncdir 
operations.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1256374" href="/Public/Bug/Display.html?id=57517#txn-1256374">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;30&nbsp;22:49:56&nbsp;2013</span>
    <span class="description">demon [...] now.ai -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1256374/665028/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/665028">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 144b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This issue should now be resolved. If you have further issues, please reopen this ticket and let us know. Thanks!

-- 
Derrik Pates
demon@now.ai
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1256377" href="/Public/Bug/Display.html?id=57517#txn-1256377">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;30&nbsp;22:49:57&nbsp;2013</span>
    <span class="description">demon [...] now.ai -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.654806</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
