<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #42987 for Mail-IMAPClient: message_string&#40;&#41; mismatched size handling too strict and verbose</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #42987 for Mail-IMAPClient: message_string&#40;&#41; mismatched size handling too strict and verbose</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Mail-IMAPClient">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Mail-IMAPClient">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Mail-IMAPClient">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Mail-IMAPClient">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-IMAPClient">Mail-IMAPClient CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">42987</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Mail-IMAPClient">Mail-IMAPClient</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
phil [...] perkpartners.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-19960-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-19961-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




IMAPClient.pm.message_string-append_string.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/562726/284165/IMAPClient.pm.message_string-append_string.patch">
Tue Feb 03 02:45:49 2009 (1.6k) by phil [...] perkpartners.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=42987">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-562723" href="/Public/Bug/Display.html?id=42987#txn-562723">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;03&nbsp;02:35:49&nbsp;2009</span>
    <span class="description">phil [...] perkpartners.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> message_string&#40;&#41; mismatched size handling too strict and verbose</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 03 Feb 2009 02:33:41 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-IMAPClient [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Phil Lobbes &lt;phil [...] perkpartners.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/562723/284160/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/284160">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Using Mail::IMAPClient v3.13 &#40;and earlier versions&#41; against an IMAP
server where RFC822.SIZE does not match the size of LITERAL size via
BODY.PEEK some problems can arise.

Here&#39;s data from a case I ran into:

  Sending: 19 UID FETCH 4 &#40;RFC822.SIZE&#41;
  Sent 30 bytes
  Read: * 4 FETCH &#40;UID 4 RFC822.SIZE 75078&#41;
  ...
  Sending: 20 UID FETCH 4 BODY.PEEK[]
  Sent 28 bytes
  LITERAL: received literal in line * 4 FETCH &#40;UID 4 BODY[] of length
  75076; attempting to retrieve from the 2863 bytes in...

This generates these &#40;duplicate&#41; ERROR&#39;s:
  ERROR: message_string&#40;&#41; expected 75078 bytes but received 75076
  ERROR: message_string&#40;&#41; expected 75078 bytes but received 75076

And these warnings:
  * Use of uninitialized value in substitution &#40;s///&#41; at
    .../lib/Mail/IMAPClient.pm line 2338.
  * Use of uninitialized value in length at
    .../lib/Mail/IMAPClient.pm line 2340.
  * Use of uninitialized value in concatenation &#40;.&#41; or string at
    .../lib/Mail/IMAPClient.pm line 2345.

- These are the lines in question from append_string&#40;&#41;:

  2337  my $count  = $self-&gt;Count&#40;$self-&gt;Count+1&#41;;
  2338  $text =~ s/\r?\n/\r\n/g;
  2339
  2340  my $command = &#34;$count APPEND $folder &#34; . &#40;$flags ? &#34;$flags &#34; : &#34;&#34;&#41; .
  2341      &#40;$date ? &#34;$date &#34; : &#34;&#34;&#41; .  &#34;{&#34; . length&#40;$text&#41; . &#34;}\r\n&#34;;
  2342
  2343  $self-&gt;_record&#40;$count,[$self-&gt;_next_index, &#34;INPUT&#34;, $command]&#41;;
  2344
  2345  my $bytes = $self-&gt;_send_line&#40;$command.$text.&#34;\r\n&#34;&#41;;
  2346  unless&#40;defined $bytes&#41;


Beyond the undefined warnings, I believe we need to decide what is the
correct behavior.  Currently we have this...

sub message_string
{   my &#40;$self, $msg&#41; = @_;
    my $expected_size = $self-&gt;size&#40;$msg&#41;;
[   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ Note: this is RFC822.SIZE! ]

    ...
    $self-&gt;fetch&#40;$msg, $cmd&#41;
        or return undef;

    my $string = $self-&gt;_transaction_literals;
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

    unless&#40;$self-&gt;Ignoresizeerrors&#41;
    {   # Should this return undef if length != expected?
        # now, attempts are made to salvage parts of the message.
        if&#40; length&#40;$string&#41; != $expected_size &#41;
        ....


I believe our current behavior of message_string is potentially overly
strict.  RFC2683 Section 3.4.5 &#34;RFC822.SIZE&#34; seems to address this
issue.  There&#39;s a bit to it, but I believe the most relevant statement
is:

  &#34; ... a client should use the size that&#39;s returned in the literal when
  you fetch the data.&#34;

Since our code uses _transaction_literals which should &#40;seems to&#41;
properly handle the literal size.  This extra check of RFC822.SIZE vs
the length of the literal string should not be necessary, is not
recommended per the RFC, and perhaps more importantly should not be the
default behavior.

To make matters potentially worse, if the RFC822.SIZE is smaller than
the actual message size then the code will truncate a message.  This
would probably cause valid data to be lost.

If desired, I&#39;ll submit a patch that makes Ignoresizeerrors default to
TRUE, but we the option could still be turned off to be more strict if
desired.

Here is a patch that:
- only records the size mismatch error once
- does NOT truncate LITERALS longer than RFC822.SIZE
- enforces strictness of RFC822.SIZE vs LITERAL length check, so any
  mismatch in size &#40;larger or smaller&#41; causes an error and returns undef
- eliminates undefined warnings in append_string on empty $text

Phil


--- IMAPClient.pm.OLD   2009-02-03 02:27:00.706750000 -0500
+++ IMAPClient.pm       2009-02-03 02:28:37.534875000 -0500
@@ -564,20 +564,13 @@
 
     my $string = $self-&gt;_transaction_literals;
 
+    # Size check may be overly strict, see RFC2683 3.4.5 &#34;RFC822.SIZE&#34;
     unless&#40;$self-&gt;Ignoresizeerrors&#41;
     {   # Should this return undef if length != expected?
-        # now, attempts are made to salvage parts of the message.
+        # do not truncate the message if more data than RFC822.SIZE returned
         if&#40; length&#40;$string&#41; != $expected_size &#41;
         {   $self-&gt;LastError&#40;&#34;message_string&#40;&#41; &#34;
                . &#34;expected $expected_size bytes but received &#34;.length&#40;$string&#41;&#41;;
-        }
-
-        $string = substr $string, 0, $expected_size
-            if length&#40;$string&#41; &gt; $expected_size;
-
-        if&#40; length&#40;$string&#41; &lt; $expected_size &#41;
-        {    $self-&gt;LastError&#40;&#34;message_string&#40;&#41; expected &#34;.
-                &#34;$expected_size bytes but received &#34;.length&#40;$string&#41;&#41;;
             return undef;
         }
     }
@@ -2318,6 +2311,9 @@
     my $folder = $self-&gt;Massage&#40;shift&#41;;
     my &#40;$text, $flags, $date&#41; = @_;
 
+    # an empty message will likely fail but we will try anyway
+    $text = &#34;&#34; unless&#40;defined $text&#41;;
+
     if&#40;defined $flags&#41;
     {   $flags =~ s/^\s+//g;
         $flags =~ s/\s+$//g;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-562726" href="/Public/Bug/Display.html?id=42987#txn-562726">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;03&nbsp;02:45:49&nbsp;2009</span>
    <span class="description">phil [...] perkpartners.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #42987] message_string&#40;&#41; mismatched size handling too strict and verbose </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 03 Feb 2009 02:44:39 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-IMAPClient [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Phil Lobbes &lt;phil [...] perkpartners.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/562726/284164/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/284164">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 113b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached is an updated version of the patch which eliminates a call to
size&#40;&#41; if Ignoresizeerrors is set!

Phil
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/562726/284165/IMAPClient.pm.message_string-append_string.patch">Download IMAPClient.pm.message_string-append_string.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1.6k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-562780" href="/Public/Bug/Display.html?id=42987#txn-562780">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;03&nbsp;06:08:41&nbsp;2009</span>
    <span class="description">webmaster [...] nlnet.nl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #42987] message_string&#40;&#41; mismatched size handling too strict and verbose</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 3 Feb 2009 12:08:19 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;phil [...] perkpartners.com via RT&#34; &lt;bug-Mail-IMAPClient [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> NLnet webmaster &lt;webmaster [...] nlnet.nl&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/562780/284197/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/284197">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* phil@perkpartners.com via RT &#40;bug-Mail-IMAPClient@rt.cpan.org&#41; [090203 07:45]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Mail-IMAPClient
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=42987">http://rt.cpan.org/Ticket/Display.html?id=42987</a></span> &gt;
&gt; 
&gt; Attached is an updated version of the patch which eliminates a call to
&gt; size&#40;&#41; if Ignoresizeerrors is set!
</div>
Very nicely documented patch!  And I do understand that servers may
be 2 off in their size calculation.

I think we need to provide a nice error message when size&#40;&#41; is not
working.  So:

    unless&#40;$self-&gt;Ignoresizeerrors&#41;
    {   # Check size with expected size
        my $expected_size = $self-&gt;size&#40;$msg&#41;;
        unless&#40;defined $expected_size&#41;
        {   $self-&gt;LastError&#40; &#34;message_string&#40;&#41; cannot get message size,&#34;
                            . &#34; use IgnoreSizeErrors option&#34;&#41;;
            return undef;
        }

        # RFC822.SIZE may be wrong
        # See RFC2683 3.4.5 &#34;RFC822.SIZE&#34;
        if&#40;length&#40;$string&#41; != $expected_size&#41;
        {   $self-&gt;LastError&#40;&#34;message_string&#40;&#41; &#34;
              . &#34;expected $expected_size bytes but received &#34;.length&#40;$string&#41;&#41;;
            return undef;
        }
    }

Other changes included as well.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-562781" href="/Public/Bug/Display.html?id=42987#txn-562781">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;03&nbsp;06:08:42&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-563059" href="/Public/Bug/Display.html?id=42987#txn-563059">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;03&nbsp;18:20:24&nbsp;2009</span>
    <span class="description">PLOBBES [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/563059/284365/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/284365">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 435b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I like the idea of referencing Ignoresizeerrors &#40;not IgnoreSizeErrors&#41;
unless you&#39;ve made some other patch/update to use FancyCaps :-&#41;.  If you
want to be a little more wordy, you could change...

this:
{ $self-&gt;LastError&#40; &#34;message_string&#40;&#41; cannot get message size,&#34;
. &#34; use IgnoreSizeErrors option&#34;&#41;;

to this:
{ $self-&gt;LastError&#40; &#34;message_string&#40;&#41; cannot get message size,&#34;
. &#34; consider using Ignoresizeerrors option&#34;&#41;;

Thanks!
Phil
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-563160" href="/Public/Bug/Display.html?id=42987#txn-563160">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;04&nbsp;02:52:56&nbsp;2009</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #42987] message_string&#40;&#41; mismatched size handling too strict and verbose</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 4 Feb 2009 08:52:38 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Phil Lobbes via RT &lt;bug-Mail-IMAPClient [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/563160/284421/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/284421">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Phil Lobbes via RT &#40;bug-Mail-IMAPClient@rt.cpan.org&#41; [090203 23:20]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Mail-IMAPClient
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=42987">https://rt.cpan.org/Ticket/Display.html?id=42987</a></span> &gt;
&gt; 
&gt; I like the idea of referencing Ignoresizeerrors &#40;not IgnoreSizeErrors&#41;
&gt; unless you&#39;ve made some other patch/update to use FancyCaps :-&#41;.
</div>
I dislike it, but the options are case-insensitive:  &#40;line 221&#41;
    while&#40;@_&#41;
    {   my $k = ucfirst lc shift;
        my $v = shift;
        $self-&gt;{$k} = $v if defined $v;
    }

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If you want to be a little more wordy, you could change...
&gt; 
&gt; this:
&gt; { $self-&gt;LastError&#40; &#34;message_string&#40;&#41; cannot get message size,&#34;
&gt; . &#34; use IgnoreSizeErrors option&#34;&#41;;
&gt; 
&gt; to this:
&gt; { $self-&gt;LastError&#40; &#34;message_string&#40;&#41; cannot get message size,&#34;
&gt; . &#34; consider using Ignoresizeerrors option&#34;&#41;;
</div>
What about:  &#34; you may need the Ignoresizeerrors option&#34;
I mean: without that option, it will continue to break for the
user... it is not really a choice, is it?
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-563249" href="/Public/Bug/Display.html?id=42987#txn-563249">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;04&nbsp;09:41:36&nbsp;2009</span>
    <span class="description">PLOBBES [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/563249/284491/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/284491">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Feb 04 02:52:56 2009, Mark@Overmeer.net wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I dislike it, but the options are case-insensitive:  &#40;line 221&#41;
</div>
Ugh, I dislike the case insensitive options as well, but I was thinking
method and not option when writing that last response.  It wouldn&#39;t mind
removing that &#34;feature&#34;.  In the code I&#39;m dealing with right now, I end
up using the Ignoresizeerrors method so case insensitivity doesn&#39;t
&#34;help&#34; anyway.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What about:  &#34; you may need the Ignoresizeerrors option&#34;
&gt; I mean: without that option, it will continue to break for the
&gt; user... it is not really a choice, is it?
</div>
Sounds good.  If we were to consider that people want the code to just
DWIM, then I would recommend reversing this option. *However* that
certainly would cause problems for things like imapsync because it uses
the RFC822.size as part of it&#39;s algorithm to uniquely identify messages
so leaving the default as-is makes the most sense and I&#39;ve separately
submitted a patch to imapsync 1.267 to add a &#39;--allowsizemismatch&#39;
option that would work well with imapsync&#39;s --skipsize option.

--allowsizemismatch
  allow RFC822.SIZE != fetched msg size
  consider --skipsize to avoid duplicate messages
  when running syncs more than one time per mailbox

That info should show up in the archives
&#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.linux-france.org/prj/imapsync_list/&#41;">http://www.linux-france.org/prj/imapsync_list/&#41;</a></span> soon probably.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-563383" href="/Public/Bug/Display.html?id=42987#txn-563383">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;04&nbsp;16:42:07&nbsp;2009</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #42987] message_string&#40;&#41; mismatched size handling too strict and verbose</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 4 Feb 2009 22:13:23 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Phil Lobbes via RT &lt;bug-Mail-IMAPClient [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/563383/284553/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/284553">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Phil Lobbes via RT &#40;bug-Mail-IMAPClient@rt.cpan.org&#41; [090204 14:41]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Mail-IMAPClient
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=42987">https://rt.cpan.org/Ticket/Display.html?id=42987</a></span> &gt;
&gt; 
&gt; On Wed Feb 04 02:52:56 2009, Mark@Overmeer.net wrote:
<div class="message-stanza open">&gt; &gt; I dislike it, but the options are case-insensitive:  &#40;line 221&#41;
</div>&gt; 
&gt; Ugh, I dislike the case insensitive options as well, but I was thinking
&gt; method and not option when writing that last response.  It wouldn&#39;t mind
&gt; removing that &#34;feature&#34;.
</div>
Cannot be done without breaking everyone&#39;s applications.  You can
never recover from such design mistakes.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; What about:  &#34; you may need the Ignoresizeerrors option&#34;
&gt; &gt; I mean: without that option, it will continue to break for the
&gt; &gt; user... it is not really a choice, is it?
</div>&gt; 
&gt; Sounds good.  If we were to consider that people want the code to just
&gt; DWIM, then I would recommend reversing this option.
</div>
DWIM is one side, but on the other hand: if people are unaware of problems
with the server, then that will never get fixed.  Helpful error messages
are close to DWIM.  Reversing defaults is also impossible in the general
case.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; submitted a patch to imapsync 1.267 to add a &#39;--allowsizemismatch&#39;
&gt; option that would work well with imapsync&#39;s --skipsize option.
</div>
Good thinking.

I think this ticket can be closed.  I&#39;ll release a new version tomorrow.
Feel invited to open new tickets.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-566963" href="/Public/Bug/Display.html?id=42987#txn-566963">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;16&nbsp;08:22:58&nbsp;2009</span>
    <span class="description">MARKOV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/566963/286221/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/286221">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 16b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">released in 3.14
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-566966" href="/Public/Bug/Display.html?id=42987#txn-566966">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;16&nbsp;08:23:00&nbsp;2009</span>
    <span class="description">MARKOV [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.508953</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
