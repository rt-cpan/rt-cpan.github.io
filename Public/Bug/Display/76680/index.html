<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #76680 for K: patch: return K char vectors as Perl string scalars</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #76680 for K: patch: return K char vectors as Perl string scalars</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/K/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/K/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/K/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/K/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/K">K CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">76680</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/K/Active/">K</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
calid1984 [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-243030-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-243031-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;22:12:10&nbsp;2012</span>
    <span class="description">calid1984 [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch: return K char vectors as Perl string scalars</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> k_char2str.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -u -r ./kparse.c /home/nbkp1nr/github/k-perl/kparse.c
--- ./kparse.c	2012-04-08 15:39:27.000000000 -0500
+++ /home/nbkp1nr/github/k-perl/kparse.c	2012-04-18 20:57:37.361327186 -0500
@@ -165,6 +165,10 @@
             break;
     }
 
+    if &#40; k-&gt;t == KC || k-&gt;t == KG &#41; {
+        return result;
+    }
+
     return newRV_noinc&#40;&#40;SV*&#41;result&#41;;
 }
 
@@ -382,21 +386,18 @@
 }
 
 SV* byte_vector_from_k&#40;K k&#41; {
-    AV *av = newAV&#40;&#41;;
-    char byte_str[1];
+    char byte_str[k-&gt;n];
     int i = 0;
 
     for &#40;i = 0; i &lt; k-&gt;n; i++&#41; {
         if &#40;kG&#40;k&#41;[i] == 0&#41; {
-            av_push&#40;av, &#38;PL_sv_undef&#41;;
             continue;
         }
 
-        byte_str[0] = kG&#40;k&#41;[i];
-        av_push&#40;av, newSVpvn&#40;byte_str, 1&#41;&#41;;
+        byte_str[i] = kG&#40;k&#41;[i];
     }
 
-    return &#40;SV*&#41;av;
+    return newSVpvn&#40;byte_str, k-&gt;n&#41;;
 }
 
 SV* short_vector_from_k&#40;K k&#41; {
diff -u -r ./t/k.t /home/nbkp1nr/github/k-perl/t/k.t
--- ./t/k.t	2012-04-08 16:46:39.000000000 -0500
+++ /home/nbkp1nr/github/k-perl/t/k.t	2012-04-18 20:45:13.190224758 -0500
@@ -12,7 +12,7 @@
 
     is $k-&gt;cmd&#40;&#39;4 + 4&#39;&#41;, 8, &#39;make an int&#39;;
 
-    is_deeply $k-&gt;cmd&#40;q/&#34;abc&#34;/&#41;, [qw/a b c/], &#39;make char vector&#39;;
+    is $k-&gt;cmd&#40;q/&#34;abc&#34;/&#41;, &#34;abc&#34;, &#39;make string&#39;;
 
     my $timestamp = $k-&gt;cmd&#40;q/2012.03.24D12:13:14.15161728/&#41;;
     is &#34;$timestamp&#34;, &#39;385906394151617280&#39;, &#39;timestamp&#39;;
diff -u -r ./t/raw.t /home/nbkp1nr/github/k-perl/t/raw.t
--- ./t/raw.t	2012-04-08 16:46:39.000000000 -0500
+++ /home/nbkp1nr/github/k-perl/t/raw.t	2012-04-18 21:06:51.104563448 -0500
@@ -122,13 +122,13 @@
     my &#40;$handle&#41; = @_;
 
     is_deeply k&#40; $handle, &#39;&#40;&#41;,0b&#39;  &#41;, [ undef ], &#39;null boolean vector&#39;;
-    is_deeply k&#40; $handle, &#39;&#40;&#41;,0x00&#39;&#41;, [ undef ], &#39;null byte vector&#39;;
+    is k&#40; $handle, &#39;&#40;&#41;,0x00&#39;&#41;, &#34;\000&#34;, &#39;null byte vector&#39;;
     is_deeply k&#40; $handle, &#39;&#40;&#41;,0Nh&#39; &#41;, [ undef ], &#39;null short vector&#39;;
     is_deeply k&#40; $handle, &#39;&#40;&#41;,0N&#39;  &#41;, [ undef ], &#39;null int vector&#39;;
     is_deeply k&#40; $handle, &#39;&#40;&#41;,0Nj&#39; &#41;, [ undef ], &#39;null long vector&#39;;
     is_deeply k&#40; $handle, &#39;&#40;&#41;,0Ne&#39; &#41;, [ undef ], &#39;null real vector&#39;;
     is_deeply k&#40; $handle, &#39;&#40;&#41;,0n&#39;  &#41;, [ undef ], &#39;null float vector&#39;;
-    is_deeply k&#40; $handle, &#39;&#40;&#41;,&#34; &#34;&#39; &#41;, [ &#39; &#39;   ], &#39;null char vector&#39;; # this ones weird
+    is_deeply k&#40; $handle, &#39;&#40;&#41;,&#34; &#34;&#39; &#41;, &#39; &#39;, &#39;null char vector&#39;; # this ones weird
     is_deeply k&#40; $handle, &#39;&#40;&#41;,`&#39;   &#41;, [ undef ], &#39;null sym vector&#39;;
     is_deeply k&#40; $handle, &#39;&#40;&#41;,0Nm&#39; &#41;, [ undef ], &#39;null month vector&#39;;
     is_deeply k&#40; $handle, &#39;&#40;&#41;,0Nd&#39; &#41;, [ undef ], &#39;null day vector&#39;;
@@ -165,7 +165,7 @@
     my &#40;$handle&#41; = @_;
 
     is_deeply k&#40;$handle, &#39;&#40;0b;1b;0b&#41;&#39;&#41;, [undef, 1, undef], &#39;parse bool vector&#39;;
-    is_deeply k&#40;$handle, &#39;&#34;abc&#34;&#39;&#41;,      [qw&#40;a b c&#41;],       &#39;parse char vector&#39;;
+    is_deeply k&#40;$handle, &#39;&#34;abc&#34;&#39;&#41;,     &#34;abc&#34;,       &#39;parse char vector&#39;;
     is_deeply k&#40;$handle, &#39;&#40;7h;8h;9h&#41;&#39;&#41;, [7, 8, 9],         &#39;parse short vector&#39;;
     is_deeply k&#40;$handle, &#39;&#40;7i;8i;9i&#41;&#39;&#41;, [7, 8, 9],         &#39;parse int vector&#39;;
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;21&nbsp;19:49:42&nbsp;2012</span>
    <span class="description">WHITNEY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I came across a problem with the approach taken by this patch.  Take the
following table definition:

    &#40;[] foo: &#40;`a`b`c&#41;; bar: &#40;1;2;3&#41;&#41;

In q it looks like this:

    foo bar
    -------
    a   1
    b   2
    c   3

In Perl it looks like this:

    {
        &#39;foo&#39; =&gt; [ &#39;a&#39;, &#39;b&#39;, &#39;c&#39; ],
        &#39;bar&#39; =&gt; [  1,   2,   3  ],
    }

All is good.

Now change the table defintion to this:

    &#40;[] foo: &#40;&#34;a&#34;;&#34;b&#34;;&#34;c&#34;&#41;; bar: &#40;1;2;3&#41;&#41;

In q it looks like this:

    foo bar
    -------
    a   1
    b   2
    c   3

With your patch applied, in Perl it looks like this:

    {
        &#39;foo&#39; =&gt; &#39;abc&#39;,
        &#39;bar&#39; =&gt; [ 1, 2, 3 ],
    }

Q gets away with the vector/string duality because the syntax 
consistency allows you to not care.  In perl though, getting the nth 
character in a string is completely different syntax from getting the 
nth element of a list.

So while it&#39;s a pain to deal with char vectors as arrays in Perl, I 
think it might be worse to silently devectorize them to strings where 
you want to be able to assume you have a an array.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;21&nbsp;19:49:43&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;21&nbsp;20:50:05&nbsp;2012</span>
    <span class="description">calid1984 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> calid1984 [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Apr 21 19:49:42 2012, WHITNEY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I came across a problem with the approach taken by this patch.  Take the
&gt; following table definition:
&gt; 
&gt;     &#40;[] foo: &#40;`a`b`c&#41;; bar: &#40;1;2;3&#41;&#41;
&gt; 
&gt; In q it looks like this:
&gt; 
&gt;     foo bar
&gt;     -------
&gt;     a   1
&gt;     b   2
&gt;     c   3
&gt; 
&gt; In Perl it looks like this:
&gt; 
&gt;     {
&gt;         &#39;foo&#39; =&gt; [ &#39;a&#39;, &#39;b&#39;, &#39;c&#39; ],
&gt;         &#39;bar&#39; =&gt; [  1,   2,   3  ],
&gt;     }
&gt; 
&gt; All is good.
&gt; 
&gt; Now change the table defintion to this:
&gt; 
&gt;     &#40;[] foo: &#40;&#34;a&#34;;&#34;b&#34;;&#34;c&#34;&#41;; bar: &#40;1;2;3&#41;&#41;
&gt; 
&gt; In q it looks like this:
&gt; 
&gt;     foo bar
&gt;     -------
&gt;     a   1
&gt;     b   2
&gt;     c   3
&gt; 
&gt; With your patch applied, in Perl it looks like this:
&gt; 
&gt;     {
&gt;         &#39;foo&#39; =&gt; &#39;abc&#39;,
&gt;         &#39;bar&#39; =&gt; [ 1, 2, 3 ],
&gt;     }
&gt; 
&gt; Q gets away with the vector/string duality because the syntax 
&gt; consistency allows you to not care.  In perl though, getting the nth 
&gt; character in a string is completely different syntax from getting the 
&gt; nth element of a list.
&gt; 
&gt; So while it&#39;s a pain to deal with char vectors as arrays in Perl, I 
&gt; think it might be worse to silently devectorize them to strings where 
&gt; you want to be able to assume you have a an array.
</div>

I think there is some confusion here.  In q, &#34;foo&#34; is the same as
&#40;&#34;f&#34;;&#34;o&#34;;&#34;o&#34;&#41;:

q&#41;&#34;foo&#34; ~ &#40;&#34;f&#34;;&#34;o&#34;;&#34;o&#34;&#41;
1b

So saying getting a string in Perl is okay for the first case, but not
for the second case, doesn&#39;t really make sense since they&#39;re the same
case &#40;flat char vector&#41;.

And indeed, q itself tries to be helpful by presenting the more &#39;usable&#39;
form:

q&#41;&#40;&#34;f&#34;;&#34;o&#34;;&#34;o&#34;&#41;
&#34;foo&#34;

In my opinion, it&#39;s best to optimize for the more common case.  The vast
majority of time, in Perl, we are going to want to deal with a flat char
vector as a string.  For the boundary case when &#40;if&#41; we *really* want a
list of chars, vectorizing is trivial &#40;e.g. split //, $str&#41;.

Since we consistently return a char vector as a string, blindly
&#39;vectorizing&#39; if necessary is not dangerous.  Also, we still get nested
char vectors represented accurately:

warn Dumper&#40; $k-&gt;cmd&#40;&#39;&#40;enlist &#34;f&#34;; enlist &#34;o&#34;; enlist &#34;o&#34;&#41;&#39;&#41;&#41;;
$VAR1 = [
          &#39;f&#39;,
          &#39;o&#39;,
          &#39;o&#39;
        ];

which of course then extends to making a list of strings much more
friendly to deal with programmatically in Perl:

warn Dumper&#40; $k-&gt;cmd&#40;&#39;&#40;&#34;the&#34;; &#34;quick&#34;; &#34;whittns&#34;&#41;&#39;&#41;&#41;;
$VAR1 = [
          &#39;the&#39;,
          &#39;quick&#39;,
          &#39;whittns&#39;
        ];
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;21&nbsp;21:28:22&nbsp;2012</span>
    <span class="description">WHITNEY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think there is some confusion here.  In q, &#34;foo&#34; is the same as
&gt; &#40;&#34;f&#34;;&#34;o&#34;;&#34;o&#34;&#41;:
&gt; 
</div>
I think there is some confusion about here about there being some confusion here :&#41;  I&#39;ve got 
a good handle on how strings work in q.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In my opinion, it&#39;s best to optimize for the more common case.  The vast
&gt; majority of time, in Perl, we are going to want to deal with a flat char
&gt; vector as a string.  For the boundary case when &#40;if&#41; we *really* want a
&gt; list of chars, vectorizing is trivial &#40;e.g. split //, $str&#41;.
&gt; 
</div>
I see what you&#39;re saying.  You&#39;re clearly right about the fact that in the common case you 
want your char vector as a string.  However, I&#39;d rather deal with the annoyance of having to 
stringify arrays of chars than encounter the case where I intentionally produce a vector of 
chars only to be returned a string.  I brought up the table example to illustrates a case 
where the auto stringification behavior is surprising and annoying.  You want to write code 
that can safely treat all tables as hashes of array refs.  But now all your table processing 
code has to have a special condition in it to deal with the fact that some columns may in 
fact be strings. Yuk.

Given that Q is a all about vector processing I expect this to come up in lots of places. 
Having to check all the time to see if your vector is really a vector isn&#39;t acceptable.  Not 
checking means you&#39;re sacrificing correctness.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;21&nbsp;22:47:18&nbsp;2012</span>
    <span class="description">calid1984 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> calid1984 [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I think there is some confusion about here about there being some
&gt; confusion here :&#41;  I&#39;ve got
&gt; a good handle on how strings work in q.
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I see what you&#39;re saying.  You&#39;re clearly right about the fact that in
&gt; the common case you
&gt; want your char vector as a string.  However, I&#39;d rather deal with the
&gt; annoyance of having to
&gt; stringify arrays of chars than encounter the case where I
&gt; intentionally produce a vector of
&gt; chars only to be returned a string.  I brought up the table example to
&gt; illustrates a case
&gt; where the auto stringification behavior is surprising and annoying.
&gt; You want to write code
&gt; that can safely treat all tables as hashes of array refs.  But now all
&gt; your table processing
&gt; code has to have a special condition in it to deal with the fact that
&gt; some columns may in
&gt; fact be strings. Yuk.
&gt; 
&gt; Given that Q is a all about vector processing I expect this to come up
&gt; in lots of places.
&gt; Having to check all the time to see if your vector is really a vector
&gt; isn&#39;t acceptable.  Not
&gt; checking means you&#39;re sacrificing correctness.
&gt; 
&gt; 
</div>
I&#39;ve thought about this further, and realized that returning an
&#39;arrayref of chars&#39; in Perl is not only unusable, it&#39;s also incorrect.

A string *is* a char vector.  Even in Perl, there is this implicit
understanding.  That&#39;s why list-like operators such as index, substr,
and chop work on strings as though they are a list of chars... because
they are.

So if we&#39;re talking about correctness, where correctness is mapping the
corresponding Q -&gt; Perl data structure, it is actualy *incorrect* to
return a char vector as an array ref of chars in Perl.  The
corresponding Perl data structure for a flat vector of chars *is* a string.

This is a win:win.  It is both the correct mapping, and eminently more
usable.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;22&nbsp;12:12:43&nbsp;2012</span>
    <span class="description">calid1984 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> calid1984 [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Well I&#39;ve had a change of heart, and I&#39;m now leaning towards returning
an array of chars, but before I explain why a few more nitpicks/devil&#39;s
advocate arguments :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; auto stringification behavior is surprising and annoying.
</div>
No.  If you document that&#39;s what your library does, then it is
consistent and predictable

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Having to check all the time to see if your vector is really a vector
</div>isn&#39;t acceptable. Not checking means you&#39;re sacrificing correctness.

You don&#39;t have to check all the time, since you&#39;ve documented that a
flat char vector is a string all the time every time.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But now all your table processing code has to have a special condition
</div>in it to deal with the fact that some columns may in fact be strings. Yuk.

Again, you don&#39;t need &#39;special condition&#39; code.  As the client when I
get a column of strings I simply have to iterate over the column
treating each value as a string... why do I need a &#39;special condition?&#39;

If you want to talk about special processing, this happens when you
return an array of chars.  Now, when I get a column of strings, for each
value I have to splice together the chars into a usable string form. 
Now *that&#39;s* YUK.


Ok, I prefaced this by saying as much as I think it&#39;s wrong, inelegant,
and annoying, I&#39;m starting to lean towards returning an array chars for
each string... why?

First, there is a valid argument that it&#39;s important to maintain the
same behavior as Kx&#39;s own language wrappers.  Their java wrapper, for
instance, returns a char vector given a string, and a string given a symbol.

The real problem with auto-stringification is distinguishing between
symbols and strings, and this to me is the most persuasive argument in
favor of returning a string for the former and an array of chars for the
latter... 

That said, if there was an easy way to distinguish between a
&#39;stringified&#39; array of chars and a symbol, then I would still prefer
stringifying char vectors, even at the expense of having different
behavior than Kx&#39;s wrappers
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;22&nbsp;14:39:03&nbsp;2012</span>
    <span class="description">WHITNEY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Cool.  This is a pick your poison type situation so I guess it&#39;s not surprising that there is disagreement or agreement for different 
reasons :&#41;

I still want weigh in on some of the points you brought up:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; auto stringification behavior is surprising and annoying.
</div>&gt; No.  If you document that&#39;s what your library does, then it is
&gt; consistent and predictable
</div>
Sure.  My point is that you want to write code like:

    map { first @{ $_ } } values %{ $table }

But you can&#39;t because you forgot to check whether $_ is really an array ref
 and then deal with the special case where it&#39;s actually a string.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Having to check all the time to see if your vector is really a vector
</div>&gt; isn&#39;t acceptable. Not checking means you&#39;re sacrificing correctness.
&gt; 
&gt; You don&#39;t have to check all the time, since you&#39;ve documented that a
&gt; flat char vector is a string all the time every time.
</div>
I should have written &#34;Having to check all the time to see if your vector is really an *array* isn&#39;t acceptable.&#34;  So sorry for muddying 
the waters there.  As you say, a string is an equally correct representation of a char vector.  My point is that by having two equally 
valid representations of a vector means I have to sprinkle my generic vector processing code with conditions to see which representation is 
being used so I can apply the right syntax. If I don&#39;t put those conditionals in place then I risk sacrificing correctness.  The above map 
command is an example of what I&#39;m talking about.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If you want to talk about special processing, this happens when you
&gt; return an array of chars.  Now, when I get a column of strings, for each
&gt; value I have to splice together the chars into a usable string form. 
&gt; Now *that&#39;s* YUK.
</div>
Yep.  That&#39;s the downside.  That&#39;s why this is a trade-off.  To me this is the less yukky of the two yuks.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ok, I prefaced this by saying as much as I think it&#39;s wrong, inelegant,
&gt; and annoying, I&#39;m starting to lean towards returning an array chars for
&gt; each string... why?
&gt; 
&gt; First, there is a valid argument that it&#39;s important to maintain the
&gt; same behavior as Kx&#39;s own language wrappers.  Their java wrapper, for
&gt; instance, returns a char vector given a string, and a string given a symbol.
</div>
Good to know.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The real problem with auto-stringification is distinguishing between
&gt; symbols and strings, and this to me is the most persuasive argument in
&gt; favor of returning a string for the former and an array of chars for the
&gt; latter... 
</div>
Hmm...interesting.  Sadly there will still be cases where you can&#39;t distingish:  $k-&gt;cmd&#40;q/`a/&#41; and $k-&gt;cmd&#40;q/&#34;a&#34;/&#41; both return the perl 
string &#34;a&#34;.  $k-&gt;cmd&#40;q/`a`b`c/&#41; and $k-&gt;cmd&#40;q/&#34;abc&#34;/&#41; both return [qw/a b c/].   But with no q symbol concept in Perl, maybe it doesn&#39;t 
matter that much?
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That said, if there was an easy way to distinguish between a
&gt; &#39;stringified&#39; array of chars and a symbol, then I would still prefer
&gt; stringifying char vectors, even at the expense of having different
&gt; behavior than Kx&#39;s wrappers
&gt; 
&gt; 
</div>
I&#39;ve been thinking about implementing a strict mode or some such thing where we only return object representations of q data.  That way we 
can preserve all information like the q type and attributes in situations where we care those things.  That would prevent any information 
loss when we go from q to perl and take care of any ambiguity problems.  Also, you could make char vector objects stringify sanely.  There 
might be significant performance implications though.  We&#39;ll have to see.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;21&nbsp;22:30:08&nbsp;2012</span>
    <span class="description">WHITNEY [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
