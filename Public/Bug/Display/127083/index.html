<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #127083 for XML-LibXML: Bug in  XML::LibXML , findvalue. returns precomposed uft-8 even when the XML document ist composed utf-8</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #127083 for XML-LibXML: Bug in  XML::LibXML , findvalue. returns precomposed uft-8 even when the XML document ist composed utf-8</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/XML-LibXML/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-LibXML">XML-LibXML CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">127083</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/XML-LibXML/Active/">XML-LibXML</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
r.porth [...] tu-berlin.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-37350-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-37351-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;10&nbsp;08:10:37&nbsp;2018</span>
    <span class="description">r.porth [...] tu-berlin.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Bug in  XML::LibXML , findvalue. returns precomposed uft-8 even when the XML document ist composed utf-8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 10 Sep 2018 12:05:25 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-XML-LibXML [...] rt.cpan.org&#34; &lt;bug-XML-LibXML [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Porth, Robert, Dr.&#34; &lt;r.porth [...] tu-berlin.de&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello to bug-XML-LibXML@rt.cpan.org&lt;mailto:bug-XML-LibXML@rt.cpan.org&gt;

$ uname -a
Linux ubsrvapp01 4.4.0-134-generic #160-Ubuntu SMP Wed Aug 15 14:58:00 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux

$ perl -v
This is perl 5, version 22, subversion 1 &#40;v5.22.1&#41; built for x86_64-linux-gnu-thread-multi

----------------------------------------
The shortest, clearest code you can manage to write which reproduces the bug described would be
$ cat uml_test1.pl
#!/usr/bin/perl -w
use strict;
use XML::LibXML;

open &#40;FH_in, &#39;str.in&#39; &#41; || die &#34;Error: Could not open file $! \n&#34;;
my $str = &lt;FH_in&gt;;
close FH_in;

printf&#40;&#34;XX 01 / %v02X\n&#34;, $str&#41;;

my $xml =
&#34;&lt;r&gt;
    &lt;s&gt;$str&lt;/s&gt;
&lt;/r&gt;
&#34;;

my $dom = XML::LibXML-&gt;load_xml&#40; string =&gt; $xml &#41;;
$dom-&gt;setEncoding&#40;&#39;UTF-8&#39;&#41;;
my $s  = $dom-&gt;findvalue&#40;&#39;/r/s&#39;&#41;;

printf&#40;&#34;XX 02 / %v02X\n&#34;, $s&#41;;

----------------------------------------
Input file is
$ cat str.in
Müller

The ü in Müller in composed uft-8 coding.

The output running the program is
$ perl uml_test1.pl
XX 01 / 4D.C3.BC.6C.6C.65.72.0A
XX 02 / 4D.FC.6C.6C.65.72.0A

The original string in the XML is &#34;Müller&#34; with ü coded as C3.BC &#40;composed uft-8&#41;
But findvalue gets &#34;Müller&#34; with ü coded as FC &#40;precomposed uft-8&#41;

Problem: Working with findvalue with an document in composed utf-8 will result in a document with a mixture of composed &#40;original in the document&#41; and precomposed character. &#40;I only tested that for german umlauts&#41;. This inconsistency causes a lot of trouble with the document. Thus, findvalue should get a string in XML without any changes in the coding.

As a note: The line in the code
$dom-&gt;setEncoding&#40;&#39;UTF-8&#39;&#41;;
actually does not change anything. I just let it there to show, that it does not help


All the best

Robert


--
Robert Porth
Abt. Bibliothekssysteme
Fachreferate Informatik, Geodäsie

Technische Universität Berlin
Universitätsbibliothek
Fasanenstraße 88, 10623 Berlin

+49 &#40;0&#41;30 314-76311
r.porth@tu-berlin.de

www.ub.tu-berlin.de
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;10&nbsp;15:51:00&nbsp;2018</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2018-09-10 08:10:37, r.porth@tu-berlin.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello to bug-XML-LibXML@rt.cpan.org&lt;mailto:bug-XML-LibXML@rt.cpan.org&gt;
&gt; 
&gt; $ uname -a
&gt; Linux ubsrvapp01 4.4.0-134-generic #160-Ubuntu SMP Wed Aug 15 14:58:00
&gt; UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
&gt; 
&gt; $ perl -v
&gt; This is perl 5, version 22, subversion 1 &#40;v5.22.1&#41; built for x86_64-
&gt; linux-gnu-thread-multi
&gt; 
&gt; ----------------------------------------
&gt; The shortest, clearest code you can manage to write which reproduces
&gt; the bug described would be
&gt; $ cat uml_test1.pl
&gt; #!/usr/bin/perl -w
&gt; use strict;
&gt; use XML::LibXML;
&gt; 
&gt; open &#40;FH_in, &#39;str.in&#39; &#41; || die &#34;Error: Could not open file $! \n&#34;;
&gt; my $str = &lt;FH_in&gt;;
&gt; close FH_in;
&gt; 
&gt; printf&#40;&#34;XX 01 / %v02X\n&#34;, $str&#41;;
&gt; 
&gt; my $xml =
&gt; &#34;&lt;r&gt;
&gt;     &lt;s&gt;$str&lt;/s&gt;
&gt; &lt;/r&gt;
&gt; &#34;;
&gt; 
&gt; my $dom = XML::LibXML-&gt;load_xml&#40; string =&gt; $xml &#41;;
&gt; $dom-&gt;setEncoding&#40;&#39;UTF-8&#39;&#41;;
&gt; my $s  = $dom-&gt;findvalue&#40;&#39;/r/s&#39;&#41;;
&gt; 
&gt; printf&#40;&#34;XX 02 / %v02X\n&#34;, $s&#41;;
&gt; 
&gt; ----------------------------------------
&gt; Input file is
&gt; $ cat str.in
&gt; Müller
&gt; 
&gt; The ü in Müller in composed uft-8 coding.
&gt; 
&gt; The output running the program is
&gt; $ perl uml_test1.pl
&gt; XX 01 / 4D.C3.BC.6C.6C.65.72.0A
&gt; XX 02 / 4D.FC.6C.6C.65.72.0A
&gt; 
&gt; The original string in the XML is &#34;Müller&#34; with ü coded as C3.BC
&gt; &#40;composed uft-8&#41;
&gt; But findvalue gets &#34;Müller&#34; with ü coded as FC &#40;precomposed uft-8&#41;
&gt; 
&gt; Problem: Working with findvalue with an document in composed utf-8
&gt; will result in a document with a mixture of composed &#40;original in the
&gt; document&#41; and precomposed character. &#40;I only tested that for german
&gt; umlauts&#41;. This inconsistency causes a lot of trouble with the
&gt; document. Thus, findvalue should get a string in XML without any
&gt; changes in the coding.
&gt; 
&gt; As a note: The line in the code
&gt; $dom-&gt;setEncoding&#40;&#39;UTF-8&#39;&#41;;
&gt; actually does not change anything. I just let it there to show, that
&gt; it does not help
</div>
First the short answer: I think that XML-LibXML&#39;s behavior here is right. The longer explanation will follow.

Before the long answer, a note about terminology: the usage is &#34;composed utf-8&#34; and &#34;precomposed utf-8&#34; is non-standard in the Perl world and even confusing &#40;there is a &#40;de&#41;composition concept in Unicode, but apparently you don&#39;t mean this&#41;.
It&#39;s better to talk about characters &#40;text strings&#41; vs. bytes &#40;octets, binary strings&#41;, like it&#39;s done in the Encode or perlunitut manpages.

Also, using &#39;printf &#34;%v&#34;&#39; isn&#39;t adequate to show how a perl string is to be interpreted. It&#39;s better to use Devel::Peek::Dump, which shows a mixture of the internal representation and the character semantics.

The task of the parsing component in XML-LibXML is to parse XML documents which are taken as binary data &#40;bytes, octets&#41;. The XML document itself has the information in which encoding this binary data should be interpreted, typically with the &#34;encoding&#34; attribute in the XML declaration, or a BOM, or if it is missing, the encoding defaults to utf-8.
After parsing, the data within the XML document should be presented to the user as character strings, so the user does not have to worry about doing the encoding himself.

If Devel::Peek::Dump&#40;&#41; calls are added to the test script, then we see this output for the initial script:

  PV = 0x236a7a0 &#34;M\303\274ller\n&#34;\0

So this is a utf8-encoded string, very probably to be interpreted as an byte &#40;octet&#41; string &#40;theoretically it&#39;s possible to interpret the two non-ASCII bytes as characters, but it does not make sense here&#41;.

The findvalue return value looks like this:

  PV = 0x2381aa0 &#34;M\303\274ller\n&#34;\0 [UTF8 &#34;M\x{fc}ller\n&#34;]

The internal representation looks the same, but now Perl knows that this has to be interpreted as utf-8, and shows an additional interpretation as a character string &#40;with the unicode codepoint U+00FC which is LATIN SMALL LETTER U WITH DIAERESIS, as expected&#41;.

So everything works as expected: input is binary, output is characters.

I am not sure what your use case exactly is --- maybe you do some &#34;editing&#34; of XML data only partially with the use of XML-LibXML, and partially with bare perl functionality. In this case you have to be careful and know if you currently deal with characters or octets. But this is just a guess --- maybe you can describe your use case?

Regards,
    Slaven &#40;a TU Berlin alumnus&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;10&nbsp;15:51:01&nbsp;2018</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;11&nbsp;05:49:40&nbsp;2018</span>
    <span class="description">r.porth [...] tu-berlin.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> AW: [rt.cpan.org #127083] Bug in  XML::LibXML , findvalue. returns precomposed uft-8 even when the XML document ist composed utf-8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 11 Sep 2018 09:44:37 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-XML-LibXML [...] rt.cpan.org&#34; &lt;bug-XML-LibXML [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Porth, Robert, Dr.&#34; &lt;r.porth [...] tu-berlin.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Slaven 

thanks for the fast and detailed answer &#40;and even from a TU Berlin alumnus :-&#41;

To give a better understanding about my case: I work at a library in the library system administration group. Since about 2 years we are live with a new library system &#40;Alma&#41; that has a API that allows to get und put different kind of data from / to the system. The data are objects &#40;users, invoices, bibliographic data ...&#41; in an XML schema. And thus I started using the perl XML libraries to work with these data. In various scenarios, like creating report, change data in the system or other things. It works fine, but I then did run into a problem with german umlauts. After some debugging I found the root cause the issue mentioned in this ticket. 

But I think you&#39;re right I was not 100% correct about some terms. So would suggest to use precomposed and decomposed &#40;and not composed&#41; as in the wikipedia page: 
<span class="clickylink"><a target="new" rel="nofollow" href="https://en.wikipedia.org/wiki/Precomposed_character">https://en.wikipedia.org/wiki/Precomposed_character</a></span>
 
Thus independently from the coding, in the basic idea of
precomposed: as one single character 
--&gt; example Åström &#40;U+00C5 U+0073 U+0074 U+0072 U+00F6 U+006D&#41;
decomposed:  as the combination of the base character plus the diacritics
--&gt; example Åström &#40;U+0041 U+030A U+0073 U+0074 U+0072 U+006F U+0308 U+006D&#41;

    
In my situation here, findvalue has changed the coding &#40;in and that unfortunately creates problems. Not in the perl code itself. But in other programs that deal with the objects / documents that are created with the code when they contain different types of coding of special characters like umlauts. Unfortunately that is a problem that I had in my work and what limits using LibXML for my day-to-day work now. 

So, wouldn&#39;t it not be on the safe side for all situations if findvalue would return the string in the given XML tag in exactly that coding &#40;as long its correct uft-8&#41; as it is there?  

All the best from the TU Berlin,

Robert

-- 
Robert Porth
Abt. Bibliothekssysteme
Fachreferate Informatik, Geodäsie

Technische Universität Berlin
Universitätsbibliothek
Fasanenstraße 88, 10623 Berlin

+49 &#40;0&#41;30 314-76311
r.porth@tu-berlin.de 

www.ub.tu-berlin.de


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Ursprüngliche Nachricht-----
Von: Slaven_Rezic via RT &lt;bug-XML-LibXML@rt.cpan.org&gt; 
Gesendet: Montag, 10. September 2018 21:51
An: Porth, Robert, Dr. &lt;r.porth@tu-berlin.de&gt;
Betreff: [rt.cpan.org #127083] Bug in XML::LibXML , findvalue. returns precomposed uft-8 even when the XML document ist composed utf-8

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=127083">https://rt.cpan.org/Ticket/Display.html?id=127083</a></span> &gt;

On 2018-09-10 08:10:37, r.porth@tu-berlin.de wrote:
<div class="message-stanza open">&gt; Hello to bug-XML-LibXML@rt.cpan.org&lt;mailto:bug-XML-LibXML@rt.cpan.org&gt;
&gt; 
&gt; $ uname -a
&gt; Linux ubsrvapp01 4.4.0-134-generic #160-Ubuntu SMP Wed Aug 15 14:58:00 
&gt; UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
&gt; 
&gt; $ perl -v
&gt; This is perl 5, version 22, subversion 1 &#40;v5.22.1&#41; built for x86_64- 
&gt; linux-gnu-thread-multi
&gt; 
&gt; ----------------------------------------
&gt; The shortest, clearest code you can manage to write which reproduces 
&gt; the bug described would be $ cat uml_test1.pl #!/usr/bin/perl -w use 
&gt; strict; use XML::LibXML;
&gt; 
&gt; open &#40;FH_in, &#39;str.in&#39; &#41; || die &#34;Error: Could not open file $! \n&#34;; my 
&gt; $str = &lt;FH_in&gt;; close FH_in;
&gt; 
&gt; printf&#40;&#34;XX 01 / %v02X\n&#34;, $str&#41;;
&gt; 
&gt; my $xml =
&gt; &#34;&lt;r&gt;
&gt;     &lt;s&gt;$str&lt;/s&gt;
&gt; &lt;/r&gt;
&gt; &#34;;
&gt; 
&gt; my $dom = XML::LibXML-&gt;load_xml&#40; string =&gt; $xml &#41;; 
&gt; $dom-&gt;setEncoding&#40;&#39;UTF-8&#39;&#41;; my $s  = $dom-&gt;findvalue&#40;&#39;/r/s&#39;&#41;;
&gt; 
&gt; printf&#40;&#34;XX 02 / %v02X\n&#34;, $s&#41;;
&gt; 
&gt; ----------------------------------------
&gt; Input file is
&gt; $ cat str.in
&gt; Müller
&gt; 
&gt; The ü in Müller in composed uft-8 coding.
&gt; 
&gt; The output running the program is
&gt; $ perl uml_test1.pl
&gt; XX 01 / 4D.C3.BC.6C.6C.65.72.0A
&gt; XX 02 / 4D.FC.6C.6C.65.72.0A
&gt; 
&gt; The original string in the XML is &#34;Müller&#34; with ü coded as C3.BC 
&gt; &#40;composed uft-8&#41; But findvalue gets &#34;Müller&#34; with ü coded as FC 
&gt; &#40;precomposed uft-8&#41;
&gt; 
&gt; Problem: Working with findvalue with an document in composed utf-8 
&gt; will result in a document with a mixture of composed &#40;original in the
&gt; document&#41; and precomposed character. &#40;I only tested that for german 
&gt; umlauts&#41;. This inconsistency causes a lot of trouble with the 
&gt; document. Thus, findvalue should get a string in XML without any 
&gt; changes in the coding.
&gt; 
&gt; As a note: The line in the code
&gt; $dom-&gt;setEncoding&#40;&#39;UTF-8&#39;&#41;;
&gt; actually does not change anything. I just let it there to show, that 
&gt; it does not help
</div>
First the short answer: I think that XML-LibXML&#39;s behavior here is right. The longer explanation will follow.

Before the long answer, a note about terminology: the usage is &#34;composed utf-8&#34; and &#34;precomposed utf-8&#34; is non-standard in the Perl world and even confusing &#40;there is a &#40;de&#41;composition concept in Unicode, but apparently you don&#39;t mean this&#41;.
It&#39;s better to talk about characters &#40;text strings&#41; vs. bytes &#40;octets, binary strings&#41;, like it&#39;s done in the Encode or perlunitut manpages.

Also, using &#39;printf &#34;%v&#34;&#39; isn&#39;t adequate to show how a perl string is to be interpreted. It&#39;s better to use Devel::Peek::Dump, which shows a mixture of the internal representation and the character semantics.

The task of the parsing component in XML-LibXML is to parse XML documents which are taken as binary data &#40;bytes, octets&#41;. The XML document itself has the information in which encoding this binary data should be interpreted, typically with the &#34;encoding&#34; attribute in the XML declaration, or a BOM, or if it is missing, the encoding defaults to utf-8.
After parsing, the data within the XML document should be presented to the user as character strings, so the user does not have to worry about doing the encoding himself.

If Devel::Peek::Dump&#40;&#41; calls are added to the test script, then we see this output for the initial script:

  PV = 0x236a7a0 &#34;M\303\274ller\n&#34;\0

So this is a utf8-encoded string, very probably to be interpreted as an byte &#40;octet&#41; string &#40;theoretically it&#39;s possible to interpret the two non-ASCII bytes as characters, but it does not make sense here&#41;.

The findvalue return value looks like this:

  PV = 0x2381aa0 &#34;M\303\274ller\n&#34;\0 [UTF8 &#34;M\x{fc}ller\n&#34;]

The internal representation looks the same, but now Perl knows that this has to be interpreted as utf-8, and shows an additional interpretation as a character string &#40;with the unicode codepoint U+00FC which is LATIN SMALL LETTER U WITH DIAERESIS, as expected&#41;.

So everything works as expected: input is binary, output is characters.

I am not sure what your use case exactly is --- maybe you do some &#34;editing&#34; of XML data only partially with the use of XML-LibXML, and partially with bare perl functionality. In this case you have to be careful and know if you currently deal with characters or octets. But this is just a guess --- maybe you can describe your use case?

Regards,
    Slaven &#40;a TU Berlin alumnus&#41;

</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;11&nbsp;06:15:43&nbsp;2018</span>
    <span class="description">r.porth [...] tu-berlin.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> AW: [rt.cpan.org #127083] Bug in  XML::LibXML , findvalue. returns precomposed uft-8 even when the XML document ist composed utf-8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 11 Sep 2018 10:14:57 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-XML-LibXML [...] rt.cpan.org&#34; &lt;bug-XML-LibXML [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Porth, Robert, Dr.&#34; &lt;r.porth [...] tu-berlin.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Slaven 

as an additional information.

I did add the line
chomp $str;
after reading the string from file to get rid of the \n  

and in the end 

if &#40; $str eq $s &#41; { print &#34;XX 03 / same: -&gt;$str&lt;-&gt;$s&lt;-\n&#34;; }
else              { print &#34;XX 03 / not the same: -&gt;$str&lt;-&gt;$s&lt;- \n&#34;; }

to compare the strings.

And the output is now
XX 01 / 4D.C3.BC.6C.6C.65.72
XX 02 / 4D.FC.6C.6C.65.72
XX 03 / not the same: -&gt;Müller&lt;-&gt;M▒ller&lt;-

Rendering the output string on my linux machine in XX 02 looks strange. And eq finds both strings to be different. Which shows the problems mentioned in this ticket.

All the best

Robert

-- 
Robert Porth
Abt. Bibliothekssysteme
Fachreferate Informatik, Geodäsie

Technische Universität Berlin
Universitätsbibliothek
Fasanenstraße 88, 10623 Berlin

+49 &#40;0&#41;30 314-76311
r.porth@tu-berlin.de 

www.ub.tu-berlin.de



<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Ursprüngliche Nachricht-----
Von: Slaven_Rezic via RT &lt;bug-XML-LibXML@rt.cpan.org&gt; 
Gesendet: Montag, 10. September 2018 21:51
An: Porth, Robert, Dr. &lt;r.porth@tu-berlin.de&gt;
Betreff: [rt.cpan.org #127083] Bug in XML::LibXML , findvalue. returns precomposed uft-8 even when the XML document ist composed utf-8

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=127083">https://rt.cpan.org/Ticket/Display.html?id=127083</a></span> &gt;

On 2018-09-10 08:10:37, r.porth@tu-berlin.de wrote:
<div class="message-stanza open">&gt; Hello to bug-XML-LibXML@rt.cpan.org&lt;mailto:bug-XML-LibXML@rt.cpan.org&gt;
&gt; 
&gt; $ uname -a
&gt; Linux ubsrvapp01 4.4.0-134-generic #160-Ubuntu SMP Wed Aug 15 14:58:00 
&gt; UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
&gt; 
&gt; $ perl -v
&gt; This is perl 5, version 22, subversion 1 &#40;v5.22.1&#41; built for x86_64- 
&gt; linux-gnu-thread-multi
&gt; 
&gt; ----------------------------------------
&gt; The shortest, clearest code you can manage to write which reproduces 
&gt; the bug described would be $ cat uml_test1.pl #!/usr/bin/perl -w use 
&gt; strict; use XML::LibXML;
&gt; 
&gt; open &#40;FH_in, &#39;str.in&#39; &#41; || die &#34;Error: Could not open file $! \n&#34;; my 
&gt; $str = &lt;FH_in&gt;; close FH_in;
&gt; 
&gt; printf&#40;&#34;XX 01 / %v02X\n&#34;, $str&#41;;
&gt; 
&gt; my $xml =
&gt; &#34;&lt;r&gt;
&gt;     &lt;s&gt;$str&lt;/s&gt;
&gt; &lt;/r&gt;
&gt; &#34;;
&gt; 
&gt; my $dom = XML::LibXML-&gt;load_xml&#40; string =&gt; $xml &#41;; 
&gt; $dom-&gt;setEncoding&#40;&#39;UTF-8&#39;&#41;; my $s  = $dom-&gt;findvalue&#40;&#39;/r/s&#39;&#41;;
&gt; 
&gt; printf&#40;&#34;XX 02 / %v02X\n&#34;, $s&#41;;
&gt; 
&gt; ----------------------------------------
&gt; Input file is
&gt; $ cat str.in
&gt; Müller
&gt; 
&gt; The ü in Müller in composed uft-8 coding.
&gt; 
&gt; The output running the program is
&gt; $ perl uml_test1.pl
&gt; XX 01 / 4D.C3.BC.6C.6C.65.72.0A
&gt; XX 02 / 4D.FC.6C.6C.65.72.0A
&gt; 
&gt; The original string in the XML is &#34;Müller&#34; with ü coded as C3.BC 
&gt; &#40;composed uft-8&#41; But findvalue gets &#34;Müller&#34; with ü coded as FC 
&gt; &#40;precomposed uft-8&#41;
&gt; 
&gt; Problem: Working with findvalue with an document in composed utf-8 
&gt; will result in a document with a mixture of composed &#40;original in the
&gt; document&#41; and precomposed character. &#40;I only tested that for german 
&gt; umlauts&#41;. This inconsistency causes a lot of trouble with the 
&gt; document. Thus, findvalue should get a string in XML without any 
&gt; changes in the coding.
&gt; 
&gt; As a note: The line in the code
&gt; $dom-&gt;setEncoding&#40;&#39;UTF-8&#39;&#41;;
&gt; actually does not change anything. I just let it there to show, that 
&gt; it does not help
</div>
First the short answer: I think that XML-LibXML&#39;s behavior here is right. The longer explanation will follow.

Before the long answer, a note about terminology: the usage is &#34;composed utf-8&#34; and &#34;precomposed utf-8&#34; is non-standard in the Perl world and even confusing &#40;there is a &#40;de&#41;composition concept in Unicode, but apparently you don&#39;t mean this&#41;.
It&#39;s better to talk about characters &#40;text strings&#41; vs. bytes &#40;octets, binary strings&#41;, like it&#39;s done in the Encode or perlunitut manpages.

Also, using &#39;printf &#34;%v&#34;&#39; isn&#39;t adequate to show how a perl string is to be interpreted. It&#39;s better to use Devel::Peek::Dump, which shows a mixture of the internal representation and the character semantics.

The task of the parsing component in XML-LibXML is to parse XML documents which are taken as binary data &#40;bytes, octets&#41;. The XML document itself has the information in which encoding this binary data should be interpreted, typically with the &#34;encoding&#34; attribute in the XML declaration, or a BOM, or if it is missing, the encoding defaults to utf-8.
After parsing, the data within the XML document should be presented to the user as character strings, so the user does not have to worry about doing the encoding himself.

If Devel::Peek::Dump&#40;&#41; calls are added to the test script, then we see this output for the initial script:

  PV = 0x236a7a0 &#34;M\303\274ller\n&#34;\0

So this is a utf8-encoded string, very probably to be interpreted as an byte &#40;octet&#41; string &#40;theoretically it&#39;s possible to interpret the two non-ASCII bytes as characters, but it does not make sense here&#41;.

The findvalue return value looks like this:

  PV = 0x2381aa0 &#34;M\303\274ller\n&#34;\0 [UTF8 &#34;M\x{fc}ller\n&#34;]

The internal representation looks the same, but now Perl knows that this has to be interpreted as utf-8, and shows an additional interpretation as a character string &#40;with the unicode codepoint U+00FC which is LATIN SMALL LETTER U WITH DIAERESIS, as expected&#41;.

So everything works as expected: input is binary, output is characters.

I am not sure what your use case exactly is --- maybe you do some &#34;editing&#34; of XML data only partially with the use of XML-LibXML, and partially with bare perl functionality. In this case you have to be careful and know if you currently deal with characters or octets. But this is just a guess --- maybe you can describe your use case?

Regards,
    Slaven &#40;a TU Berlin alumnus&#41;

</div></div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
