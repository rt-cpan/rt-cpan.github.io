<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #66600 for YAML: YAML::Dump&#40;&#41; and YAML::Load&#40;&#41; apparently cause memory leaks</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #66600 for YAML: YAML::Dump&#40;&#41; and YAML::Load&#40;&#41; apparently cause memory leaks</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/YAML/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/YAML/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/YAML/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/YAML/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/ingydotnet/yaml-pm/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/YAML">YAML CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">66600</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/YAML/Active/">YAML</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mg.pub [...] gmx.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-37890-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.72    </td>
  </tr>
  <tr id="CF-37891-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;14&nbsp;10:01:55&nbsp;2011</span>
    <span class="description">mg.pub [...] gmx.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> YAML::Dump&#40;&#41; and YAML::Load&#40;&#41; apparently cause memory leaks</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">While trying to hunt down memory leak problems in OTRS &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://otrs.org">http://otrs.org</a></span>&#41;, I stumbled over 
apparent memory leaks in the YAML module. 

Please find attached a small test script to reproduce this problem. On my system, this 
produces the following 
output:

###

Checking leaks in YAML::Dump&#40;&#41; by performing 10000 function calls
The following symbol table differences were found:
  ARRAY changed from 488 to 1924
  CODE changed from 217 to 1232
  GLOB changed from 468 to 1814
  HASH changed from 103 to 10201
  REF changed from 70 to 153
  REF-ARRAY changed from 49 to 103
  SCALAR changed from 3910 to 56606
Checking leaks in YAML::Load&#40;&#41; by performing 10000 function calls
The following symbol table differences were found:
  ARRAY changed from 1924 to 2030
  GLOB changed from 1814 to 1951
  HASH changed from 10202 to 20209
  SCALAR changed from 56623 to 78348

###

This test was performed on:
YAML 0.72
This is perl, v5.10.0 built for darwin-thread-multi-2level
&#40;with 2 registered patches, see perl -V for more detail&#41;
Darwin otrs-mg.fritz.box 10.6.0 Darwin Kernel Version 10.6.0: Wed Nov 10 18:13:17 PST 
2010; root:xnu-
1504.9.26~3/RELEASE_I386 i386

So the outcome would be that for _every_ Dump&#40;&#41; and Load&#40;&#41; call, YAML causes leaked 
memory &#40;additional symbol table entries&#41;. I tested this on MacOS. If I am right, this is 
problematic, because long-running processes using YAML will consume constantly more 
memory.

On another linux system, the result is less problematic, but still shows leaks:

###

Checking leaks in YAML::Dump&#40;&#41; by performing 10000 function calls
The following symbol table differences were found:
  ARRAY changed from 526 to 1995
  CODE changed from 227 to 1256
  GLOB changed from 435 to 1676
  HASH changed from 125 to 261
  REF changed from 79 to 166
  REF-ARRAY changed from 55 to 111
  REGEXP changed from 64 to 214
  SCALAR changed from 4152 to 16982
Checking leaks in YAML::Load&#40;&#41; by performing 10000 function calls
The following symbol table differences were found:
  ARRAY changed from 1995 to 2108
  GLOB changed from 1676 to 1751
  REGEXP changed from 214 to 284
  SCALAR changed from 17000 to 18727

###

This test was performed on:
YAML 0.72
This is perl 5, version 12, subversion 1 &#40;v5.12.1&#41; built for i586-linux-thread-multi
Linux ub-opensuse113 2.6.34.7-0.7-default #1 SMP 2010-12-13 11:13:53 +0100 i686 
i686 i386 GNU/Linux

The attached test script is quite straightforward. You need to install Devel::Gladiator. Note 
that tests during the installation of this module may fail, but it still works well on my test 
systems.

Please let me know if I can provide further information about this problem, don&#39;t hesitate to 
contact me at mg dot pub at gmx dot net.

I would be very happy to hear about this issue, if you can confirm and also possibly fix it.

With best regards, 
Martin Gruner
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> yaml_leaks.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w

use strict;
use warnings;

use Devel::Gladiator &#40;&#41;;
use YAML &#40;&#41;;

=head1 SYNOPSIS

Helper script to check for leaks in YAML.

It seems that the YAML module in its latest version &#40;0.72&#41; suffers from memory leaks.
This script intends to show that Dump&#40;&#41; increases the amount of variables
in the symbol table with every call. This would mean that long-running processes grow constantly.

How is this achieved? We use the module Devel::Gladiator &#40;on installation, some tests were failing
on my platform MacOS, but it seems to work well!&#41; for this purpose. It takes a &#39;snapsnot&#39; of the
symbol table before and after running the tests. Then these are compared and differences highlighted.

=cut

my $DumperCount = 10_000;
print &#34;Checking leaks in YAML::Dump&#40;&#41; by performing $DumperCount function calls\n&#34;;

# take snapshot of symbol table before tests
my $OldSymbolTable = Devel::Gladiator::arena_ref_counts&#40;&#41;;

for &#40;1 .. $DumperCount&#41; {
    YAML::Dump&#40;&#39;123&#39;&#41;;
}

print &#34;The following symbol table differences were found:\n&#34;;

# take snapshot of symbol table after tests
my $NewSymbolTable = Devel::Gladiator::arena_ref_counts&#40;&#41;;

for my $Key &#40;sort keys %{$NewSymbolTable}&#41; {
    if &#40;$NewSymbolTable-&gt;{$Key} &gt; &#40;&#40;$OldSymbolTable-&gt;{$Key} || 0&#41; + 50&#41; &#41; {
        warn &#34;  $Key changed from $OldSymbolTable-&gt;{$Key} to $NewSymbolTable-&gt;{$Key}\n&#34;;
    }
}

my $LoadCount = 10_000;
print &#34;Checking leaks in YAML::Load&#40;&#41; by performing $LoadCount function calls\n&#34;;

# take snapshot of symbol table before tests
$OldSymbolTable = Devel::Gladiator::arena_ref_counts&#40;&#41;;

for &#40;1 .. $DumperCount&#41; {
    YAML::Load&#40;&#34;--- 123\n&#34;&#41;;
}

print &#34;The following symbol table differences were found:\n&#34;;

# take snapshot of symbol table after tests
$NewSymbolTable = Devel::Gladiator::arena_ref_counts&#40;&#41;;

for my $Key &#40;sort keys %{$NewSymbolTable}&#41; {
    if &#40;$NewSymbolTable-&gt;{$Key} &gt; &#40;&#40;$OldSymbolTable-&gt;{$Key} || 0&#41; + 50&#41; &#41; {
        warn &#34;  $Key changed from $OldSymbolTable-&gt;{$Key} to $NewSymbolTable-&gt;{$Key}\n&#34;;
    }
}

# DEBUG: print out entire information
#warn Devel::Gladiator::arena_table&#40;&#41;; # prints counts keyed by class</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;14&nbsp;02:49:45&nbsp;2014</span>
    <span class="description">ingy [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This issue has been copied to: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/ingydotnet/yaml-pm/issues/110">https://github.com/ingydotnet/yaml-pm/issues/110</a></span> please take all future correspondence there.
This ticket will remain open but please do not reply here.
This ticket will be closed when the github issue is dealt with.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;14&nbsp;02:49:45&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;09&nbsp;19:02:43&nbsp;2018</span>
    <span class="description">TINITA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">If I add one call to `Load&#40;&#41;` and `Dump&#40;&#41;` before measuring, no differences are found, neither for the reported version 0.72 nor current master. I think this is because YAML loads some classes only when performing the first Dump or Load.
Closing.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;May&nbsp;09&nbsp;19:02:44&nbsp;2018</span>
    <span class="description">TINITA [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
