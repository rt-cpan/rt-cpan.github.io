<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #125344 for DBIx-Class: Document and unhide DBIx::Class::Storage::BlockRunner</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #125344 for DBIx-Class: Document and unhide DBIx::Class::Storage::BlockRunner</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBIx-Class/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Class">DBIx-Class CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">125344</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBIx-Class/Active/">DBIx-Class</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
BBYRD [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10410-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10411-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;17&nbsp;20:33:43&nbsp;2018</span>
    <span class="description">BBYRD [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Document and unhide DBIx::Class::Storage::BlockRunner</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This module is the cornerstone of retry support within DBIC.  It would be useful to expose this to the public, to use in cases where one would want to retry more than once, or change the retry_handler to use different conditions.

If I wrote a patch to document the module and unhide it from PAUSE, would you be receptive to merging it in?  What about creating and publicizing attributes within Storage and Storage::DBI to use the same BlockRunner objects created in dbh_do / txn_do ?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;17&nbsp;21:41:00&nbsp;2018</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125344] Document and unhide DBIx::Class::Storage::BlockRunner</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 18 May 2018 03:40:38 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;ribasushi [...] leporine.io&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 05/18/2018 02:33 AM, Brendan Byrd via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; This module is the cornerstone of retry support within DBIC.  It would be useful to expose this to the public, to use in cases where one would want to retry more than once, or change the retry_handler to use different conditions.
</div>
Ideally - yes you are correct that it should get publicized.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; If I wrote a patch to document the module and unhide it from PAUSE, would you be receptive to merging it in?
&gt;
</div>
Not at present. There are several grave errors in its design, mainly 
around the surface API interfacing with ::Storage and the handling of 
stack-independent txn frames &#40; txn_scope_guard &#41;. This is the reason it 
remains hidden &#40; as the very first line of the module says &#41;.

With that said - I am definitely going to open this module at some point 
in the future, so having ready-to-go documentation parked in a branch 
definitely wouldn&#39;t hurt. I just want to clear up-front that the merging 
part will happen &#34;when it is ready&#34;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  What about creating and publicizing attributes within Storage and Storage::DBI to use the same BlockRunner objects created in dbh_do / txn_do ?
</div>
Could you elaborate on this point? I am not entirely sure what you 
meant, just a hunch. Pseudocode would be best!

Thank you for filing the issue in any case - gives me more info on how 
to prioritize this.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;17&nbsp;21:41:01&nbsp;2018</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;18&nbsp;12:49:41&nbsp;2018</span>
    <span class="description">BBYRD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu May 17 21:41:00 2018, RIBASUSHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Not at present. There are several grave errors in its design, mainly
&gt; around the surface API interfacing with ::Storage and the handling of
&gt; stack-independent txn frames &#40; txn_scope_guard &#41;. This is the reason it
&gt; remains hidden &#40; as the very first line of the module says &#41;.
</div> 
Can you elaborate?  The handling of transactions seems pretty reasonable to me:

* If starting a transaction via wrap_txn, then handle rollbacks and never trust the connection on error.
* If already in a transaction or block, run far far away because BlockRunner can&#39;t possibly know what transactionalized statements are before it that might be missed on disconnection rollback.  &#40;Also, the outer-layer BlockRunner with wrap_txn=1 will handle the retry logic, anyway.&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; With that said - I am definitely going to open this module at some point
&gt; in the future, so having ready-to-go documentation parked in a branch
&gt; definitely wouldn&#39;t hurt. I just want to clear up-front that the merging
&gt; part will happen &#34;when it is ready&#34;.
</div>
Part of the reason for asking is because I&#39;m finishing up a DBIx::Connector::Retry module for the non-DBIC side &#40;pending review and paperwork&#41;, and already have a chunk of documentation that would fit here.

Another more selfish reason is that I&#39;m also adding retry protection into DBIx::BatchChunker and another new module, so it would be nice to reference a public interface for that, instead of secretly using BlockRunner for increased retries.  Yes, I take full responsibility for the risks of involved in abusing private interfaces, but it seemed better than trying to roll our own that looks exactly like BlockRunner.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; What about creating and publicizing attributes within Storage and
&gt; &gt; Storage::DBI to use the same BlockRunner objects created in dbh_do /
&gt; &gt; txn_do ?
</div>&gt; 
&gt; Could you elaborate on this point? I am not entirely sure what you
&gt; meant, just a hunch. Pseudocode would be best!
</div>
I was going to go the route of a &#39;block_runner&#39; attribute.  But, perhaps a more incremental approach would just be &#39;block_runner_args&#39;:

package DBIx::Class::Storage;

__PACKAGE__-&gt;mk_group_accessors&#40;&#39;simple&#39; =&gt; &#39;block_runner_args&#39;&#41;;  # or maybe some other accessor type...

__PACKAGE__-&gt;block_runner_args&#40;{
  retry_handler =&gt; sub {
    $_[0]-&gt;failed_attempt_count == 1
      and
    ! $_[0]-&gt;storage-&gt;connected
  },
}&#41;;

sub txn_do {
  my $self = shift;
 
  DBIx::Class::Storage::BlockRunner-&gt;new&#40;
    %{ $self-&gt;block_runner_args },
    storage =&gt; $self,
    wrap_txn =&gt; 1,
  &#41;-&gt;run&#40;@_&#41;;
}

Then anybody could specify something like this:

$storage-&gt;block_runner_args&#40;{
  retry_handler =&gt; sub { ...whatever you want... },
  max_attempts  =&gt; 10,
}&#41;;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thank you for filing the issue in any case - gives me more info on how
&gt; to prioritize this.
</div>
It&#39;s our itch to scratch, so I&#39;d be happy to help, but I just wanted to make sure we could hash out the implementation details.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;18&nbsp;13:41:04&nbsp;2018</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125344] Document and unhide DBIx::Class::Storage::BlockRunner</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 18 May 2018 19:40:39 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;ribasushi [...] leporine.io&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 05/18/2018 06:49 PM, Brendan Byrd via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         Queue: DBIx-Class
&gt;   Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125344">https://rt.cpan.org/Ticket/Display.html?id=125344</a></span> &gt;
&gt; 
&gt; On Thu May 17 21:41:00 2018, RIBASUSHI wrote:
<div class="message-stanza open">&gt;&gt; Not at present. There are several grave errors in its design, mainly
&gt;&gt; around the surface API interfacing with ::Storage and the handling of
&gt;&gt; stack-independent txn frames &#40; txn_scope_guard &#41;. This is the reason it
&gt;&gt; remains hidden &#40; as the very first line of the module says &#41;.
</div>&gt;   
&gt; Can you elaborate?  The handling of transactions seems pretty reasonable to me:
<div class="message-stanza open">&gt;  &gt; * If starting a transaction via wrap_txn, then handle rollbacks and 
</div></div>never trust the connection on error.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; * If already in a transaction or block, run far far away because BlockRunner can&#39;t possibly know what transactionalized statements are before it that might be missed on disconnection rollback.  &#40;Also, the outer-layer BlockRunner with wrap_txn=1 will handle the retry logic, anyway.&#41;
</div>
Regarding the second portion I was referring to multiple corner cases of 
multiple nested txn_do blocks interspersed with multiple txn_scope_guard 
instantiations, plus the general &#40; not yet fully addressed &#41; problem of 
&#34;trapped exception&#34; within a txn . Fixes for both of these will likely 
require changes to the internals of BR, and this space is already 
critical enough that trying to do things incrementally is just too risky.

In other words I am not amenable to publicize this sub-API until all 
currently known issues with the transaction handling have been 
addressed. Yes - in its current implementation it works flawlessly when 
things &#34;go well&#34;, but this isn&#39;t enough.

With that said - if you are willing to spend the considerable time 
necessary to &#34;get it perfect&#34; - I will try my best to find the time to 
gather whatever test cases I have across various notes, to give you a 
full starting point.

Note that I am not trying to put you off from tackling this, I am just 
being honest with what is required.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt;&gt; With that said - I am definitely going to open this module at some point
&gt;&gt; in the future, so having ready-to-go documentation parked in a branch
&gt;&gt; definitely wouldn&#39;t hurt. I just want to clear up-front that the merging
&gt;&gt; part will happen &#34;when it is ready&#34;.
</div>&gt; 
&gt; Part of the reason for asking is because I&#39;m finishing up a DBIx::Connector::Retry module for the non-DBIC side &#40;pending review and paperwork&#41;, and already have a chunk of documentation that would fit here.
&gt; 
&gt; Another more selfish reason is that I&#39;m also adding retry protection into DBIx::BatchChunker and another new module, so it would be nice to reference a public interface for that, instead of secretly using BlockRunner for increased retries.  Yes, I take full responsibility for the risks of involved in abusing private interfaces, but it seemed better than trying to roll our own that looks exactly like BlockRunner.
&gt;
</div>
Sure thing - though I must disagree with &#34;risk abusing private 
interfaces&#34; part. You could simply start using BR today: as long as you 
are willing to write a test on your end and ideally have it somewhere on 
CPAN, so that I can catch regressions when doing revdeps testing.

That is - if the sub-API works for you well *as-is*, then there is 
little risk for you using it, as any future changes will be carefully 
planned and announced.

Once I do open and document it - changes that are not strictly additions 
are simply no longer possible. Given how central this interface is: I am 
being extra cautions and conservative.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt;&gt;&gt; What about creating and publicizing attributes within Storage and
&gt;&gt;&gt; Storage::DBI to use the same BlockRunner objects created in dbh_do /
&gt;&gt;&gt; txn_do ?
</div>&gt;&gt;
&gt;&gt; Could you elaborate on this point? I am not entirely sure what you
&gt;&gt; meant, just a hunch. Pseudocode would be best!
</div>&gt; 
&gt; I was going to go the route of a &#39;block_runner&#39; attribute. 
&gt;
&gt; But, perhaps a more incremental approach would just be &#39;block_runner_args&#39;:
&gt; 
&gt; 
&gt; Then anybody could specify something like this:
&gt; 
&gt; $storage-&gt;block_runner_args&#40;{
&gt;    retry_handler =&gt; sub { ...whatever you want... },
&gt;    max_attempts  =&gt; 10,
&gt; }&#41;;
&gt; 
</div>
This is just a gut feeling at this point, but both of the above 
approaches seem problematic in terms of &#34;sharing state&#34; perspective. I 
can not put my finger on it just yet, and it has been a while since I&#39;ve 
been in this headspace. But I did try to do that when I designed BR 
originally and I had to back out of that design due to...&lt;???&gt; I would 
need to look through my reflogs to find out the exact details.

What is likely to be more &#34;correct&#34; instead is something like:

txn_do&#40; \%optional_params, sub { ... }, @optional_sub_args &#41;

However! This needs further design/planning from the other perspective 
of allowing for finalizers with proper composition &#40; &#34;do X if and only 
if we managed to commit, and do Y i and only if we rolled back&#34; &#41;.

Apologies for the handwavey response, this is all I have off the top of 
my head without digging into the codebase.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; Thank you for filing the issue in any case - gives me more info on how
&gt;&gt; to prioritize this.
</div>&gt; 
&gt; It&#39;s our itch to scratch, so I&#39;d be happy to help, but I just wanted to make sure we could hash out the implementation details.
&gt; 
</div>
Thank you for doing that - hashing this out is like 95% of the problem. 
One last thing to address is that if you are on a tight timeline - you 
should *probably* go with just using BR as is. I am realistically 
another month away from attaining a large enough chunk of time to sit 
down and fix the ZR-reported performance regressions with what is 
currently in master and another couple months of ironing out random 
most-convoluted-context regressions. Again - I am not trying to dissuade 
you from participating in fixing this - it needs to be done and it will 
be done. I am simply managing walltime expectations up-front.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;18&nbsp;19:01:45&nbsp;2018</span>
    <span class="description">BBYRD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri May 18 13:41:04 2018, RIBASUSHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Regarding the second portion I was referring to multiple corner cases of
&gt; multiple nested txn_do blocks interspersed with multiple txn_scope_guard
&gt; instantiations
</div>
BR is already doing quite a bit in terms of transaction_depth checks, so
I&#39;m surprised there&#39;s even edge cases where this wouldn&#39;t work.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; plus the general &#40; not yet fully addressed &#41; problem of
&gt; &#34;trapped exception&#34; within a txn.
</div>
I figured that would bubble up to the outer-most BR layer, since the 
internal txn loops would immediately short-circuit to running the $cref,
uneval&#39;d and outside of the _run recursion.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; With that said - if you are willing to spend the considerable time
&gt; necessary to &#34;get it perfect&#34; - I will try my best to find the time to
&gt; gather whatever test cases I have across various notes, to give you a
&gt; full starting point.
</div>
While I can&#39;t commit to that level of effort, as the tuits aren&#39;t my own,
I would be interesting in seeing these kind of test cases if you have them
on hand.  Maybe they aren&#39;t so bad to solve for.  And if they exist in BR,
they probably would exist in DBIx::Connector::Retry, since they share
design concepts.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sure thing - though I must disagree with &#34;risk abusing private
&gt; interfaces&#34; part. You could simply start using BR today: as long as you
&gt; are willing to write a test on your end and ideally have it somewhere on
&gt; CPAN, so that I can catch regressions when doing revdeps testing.
&gt; 
&gt; That is - if the sub-API works for you well *as-is*, then there is
&gt; little risk for you using it, as any future changes will be carefully
&gt; planned and announced.
</div>
Fair enough, and thanks for being amicable.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Once I do open and document it - changes that are not strictly additions
&gt; are simply no longer possible. Given how central this interface is: I am
&gt; being extra cautions and conservative.
</div>
Understood, though it seems like you&#39;re kind of in that state already.  Any
sort of major changes to the interface could be disruptive, despite whatever
flaws it may already come with.  Even if you go into the direction of
subtracting or changing things, it would probably come with compatibility
layers to support the old interface.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is just a gut feeling at this point, but both of the above
&gt; approaches seem problematic in terms of &#34;sharing state&#34; perspective. I
&gt; can not put my finger on it just yet, and it has been a while since I&#39;ve
&gt; been in this headspace. But I did try to do that when I designed BR
&gt; originally and I had to back out of that design due to...&lt;???&gt; I would
&gt; need to look through my reflogs to find out the exact details.
</div>
Possibly because of a permanent retry_handler coderef?  Or are we talking
about a full BR object in a block_runner attribute?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What is likely to be more &#34;correct&#34; instead is something like:
&gt; 
&gt; txn_do&#40; \%optional_params, sub { ... }, @optional_sub_args &#41;
</div>
That does leave the open the possibility of temporarily increasing retries
or changing handlers just for one method call.  Although, I would expect
the need for a more permanent bit of settings, too.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; However! This needs further design/planning from the other perspective
&gt; of allowing for finalizers with proper composition &#40; &#34;do X if and only
&gt; if we managed to commit, and do Y i and only if we rolled back&#34; &#41;.
</div>
Now that sounds like feature scope creep :&#41;  But, if %optional_params is
a hashref, then it&#39;s infinitely expandable to whatever extra params are
needed.

Although, if BR manages to commit, which is really the default goal,
they can just run the next operation post-txn_do.  If BR rolls back,
the connection is probably not reliable, but a finalizer still could be
called in the rollback eval.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; One last thing to address is that if you are on a tight timeline - you
&gt; should *probably* go with just using BR as is. I am realistically
&gt; another month away from attaining a large enough chunk of time to sit
&gt; down and fix the ZR-reported performance regressions with what is
&gt; currently in master and another couple months of ironing out random
&gt; most-convoluted-context regressions. Again - I am not trying to dissuade
&gt; you from participating in fixing this - it needs to be done and it will
&gt; be done. I am simply managing walltime expectations up-front.
</div>
Okay, I think I&#39;ll go that route for now, but I&#39;d still be open to
improving BR in the future.  I agree that the problem solving is probably
95% implementation discussion and 5% code.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
