<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #3227 for PAR: Errors while deleting temp directory</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #3227 for PAR: Errors while deleting temp directory</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/PAR/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/PAR/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/PAR/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/PAR/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/PAR">PAR CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">3227</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/PAR/Active/">PAR</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
astewart1 [...] cox.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24530-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24531-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;12&nbsp;23:48:34&nbsp;2003</span>
    <span class="description">astewart1 [...] cox.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Alan Stewart&#34; &lt;astewart1 [...] cox.net&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-par [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 12 Aug 2003 20:48:24 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Errors while deleting temp directory</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Using PAR-0.73 on NT 4.0/sp6.

I get occasional &#34;unhandled exception&#34; crashes when launching the compiled 
a.exe by different means. The VC debugger indicates the crash occurs in 
par_rmtmpdir in par.exe. It appears that both a.exe &#40;static.c&#41; and par.exe 
&#40;main.c&#41; invoke this subroutine near their end. I don&#39;t know why that would 
cause a crash, and only when invoked from some places, but it&#39;s redundant. 
When I eliminated the call in main.c, leaving the one in static.c, everything 
works fine.

The call in main.c can&#39;t delete everything anyway, since some of the files are 
DLLs that are still in use. This happens when compiling with &#34;pp -d&#34; where the 
only call to par_rmtmpdir would be in main.c. Why not use the same process for 
&#34;-d&#34; of having a.exe extract par.exe but not extract perlxx.dll, and clean up 
after par.exe at the end of a.exe?

main.c has a
  #ifndef PAR_MKTMPDIR
but I don&#39;t see a define elsewhere. Was there supposed to be a define in the 
makefile?

Alan Stewart
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;13&nbsp;00:03:41&nbsp;2003</span>
    <span class="description">autrijus [...] autrijus.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 13 Aug 2003 12:03:34 +0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Autrijus Tang &lt;autrijus [...] autrijus.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Alan Stewart via RT &lt;bug-PAR [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &#34;AdminCc of cpan Ticket #3227&#34;: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #3227] Errors while deleting temp directory</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Aug 12, 2003 at 11:48:35PM -0400, Alan Stewart via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The call in main.c can&#39;t delete everything anyway, since some of the files are 
&gt; DLLs that are still in use. This happens when compiling with &#34;pp -d&#34; where the 
&gt; only call to par_rmtmpdir would be in main.c. Why not use the same process for 
&gt; &#34;-d&#34; of having a.exe extract par.exe but not extract perlxx.dll, and clean up 
&gt; after par.exe at the end of a.exe?
</div>
Can you explain a bit better why this would be a gain over the current
way in &#34;pp -d&#34;?

I agree that main.c should not attempt to rmdir when it&#39;s spawned by
static.c.  Can you help adding a test to !getenv&#40;&#34;PAR_ARGC&#34;&#41; before
par_rmtmpdir&#40;&#41;, and see if it suffices?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; main.c has a
&gt;   #ifndef PAR_MKTMPDIR
&gt; but I don&#39;t see a define elsewhere. Was there supposed to be a define in the 
&gt; makefile?
</div>
It&#39;s there in main.c line 7.

Thanks,
/Autrijus/
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;13&nbsp;12:48:43&nbsp;2003</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[autrijus@autrijus.org - Wed Aug 13 00:03:41 2003]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Can you explain a bit better why this would be a gain over the current
&gt; way in &#34;pp -d&#34;?
&gt; 
</div>When main.c isn&#39;t spawned from static.c for &#34;-d&#34;, it can&#39;t delete the 
DLLs it uses, so the directory is also not deleted. This is the same 
problem with earlier versions. I thought that was why you created the 
static.c approach, so main.c can end and then the DLLs can be cleaned 
up. Can&#39;t the same thing be done whether you are extracting perlxx.dll 
or using the installed perl one?
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt; main.c has a
&gt; &gt;   #ifndef PAR_MKTMPDIR
&gt; &gt; but I don&#39;t see a define elsewhere. Was there supposed to be a
</div>&gt; define in the
<div class="message-stanza open">&gt; &gt; makefile?
</div>&gt; 
&gt; It&#39;s there in main.c line 7.
&gt; 
</div>True, but that&#39;s right there after the #ifndef at line 6 and nowhere 
else that I see, so it&#39;s really unconditional. I thought it might have 
been intended as a conditional at compile time for main.c rather than 
an %ENV check at run time as you suggest above.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;13&nbsp;13:19:57&nbsp;2003</span>
    <span class="description">autrijus [...] autrijus.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 14 Aug 2003 01:19:47 +0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Autrijus Tang &lt;autrijus [...] autrijus.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Guest via RT &lt;bug-PAR [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &#34;AdminCc of cpan Ticket #3227&#34;: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #3227] Errors while deleting temp directory</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Aug 13, 2003 at 12:48:44PM -0400, Guest via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Can you explain a bit better why this would be a gain over the current
&gt; &gt; way in &#34;pp -d&#34;?
</div>&gt; When main.c isn&#39;t spawned from static.c for &#34;-d&#34;, it can&#39;t delete the 
&gt; DLLs it uses, so the directory is also not deleted. This is the same 
&gt; problem with earlier versions. I thought that was why you created the 
&gt; static.c approach, so main.c can end and then the DLLs can be cleaned 
&gt; up. Can&#39;t the same thing be done whether you are extracting perlxx.dll 
&gt; or using the installed perl one?
</div>
Ahh, I see.  You are not talking about perl5x.dll, but other XS files.

I really wonder if there&#39;s a way to not add a process spawn overhead
and be able to delete the DLL files.  Is there ways to explicitly close
all opened DLL files on Win32?  Or PERL_DESTRUCT already does that?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; It&#39;s there in main.c line 7.
</div>&gt; True, but that&#39;s right there after the #ifndef at line 6 and nowhere 
&gt; else that I see, so it&#39;s really unconditional. I thought it might have 
&gt; been intended as a conditional at compile time for main.c rather than 
&gt; an %ENV check at run time as you suggest above.
</div>
Right.  I should remove the unconditional flag right away.

Thanks,
/Autirjus/
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;14&nbsp;22:15:04&nbsp;2003</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Alan Stewart</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[autrijus@autrijus.org - Wed Aug 13 13:19:57 2003]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I really wonder if there&#39;s a way to not add a process spawn overhead
&gt; and be able to delete the DLL files.  Is there ways to explicitly 
</div>close
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; all opened DLL files on Win32?  Or PERL_DESTRUCT already does that?
&gt; 
</div>
I see two API functions that might be useful:
GetModuleHandleEx  gets the handle to a DLL given the file name.
FreeLibrary  decrements the reference count to the DLL.

Using these on all the DLL files you know have been extracted might 
free the process so par_rmtmpdir can work. I have no idea if the Perl 
core tries to do anything like this already. I&#39;ll do some searching 
thru the source for these APIs.
But, I am not an C/Win32 API programmer. . . 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;16&nbsp;00:05:58&nbsp;2003</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Alan Stewart</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Thu Aug 14 22:15:04 2003]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [autrijus@autrijus.org - Wed Aug 13 13:19:57 2003]:
&gt; 
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; I really wonder if there&#39;s a way to not add a process spawn overhead
&gt; &gt; and be able to delete the DLL files.  Is there ways to explicitly 
</div>&gt; close
<div class="message-stanza open">&gt; &gt; all opened DLL files on Win32?  Or PERL_DESTRUCT already does that?
&gt; &gt; 
</div>&gt; 
</div>I have a working mktmpdir.c that uses GetModuleHandle and FreeLibrary 
to decrement the references from the loaded DLLs to the extracted files 
&#40;see attached&#41;. All files now unlink with &#34;pp -d&#34;, but I have not tried 
to eliminate the use of spawning with plain &#34;pp&#34;.

Perl core code does a LoadLibrary, but not a FreeLibrary anywhere. Each 
DLL is probably only loaded once, but the MSDN says multiple loads are 
possible, so I decrement until none. MSDN also says to prefer 
GetModuleHandleEx, but that is not supported in all Windows versions.

I tested with the latest snap. BTW, the snap makefile.PL requires 
ScanDeps version 0.26, but CPAN only has 0.25 !

Alan Stewart
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;16&nbsp;03:02:31&nbsp;2003</span>
    <span class="description">autrijus [...] autrijus.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 16 Aug 2003 15:01:54 +0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Autrijus Tang &lt;autrijus [...] autrijus.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Guest via RT &lt;bug-PAR [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &#34;AdminCc of cpan Ticket #3227&#34;: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #3227] Errors while deleting temp directory</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, Aug 16, 2003 at 12:05:59AM -0400, Guest via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have a working mktmpdir.c that uses GetModuleHandle and FreeLibrary 
&gt; to decrement the references from the loaded DLLs to the extracted files 
&gt; &#40;see attached&#41;. All files now unlink with &#34;pp -d&#34;,
</div>
Yay!  Your patch is applied; I&#39;ll roll a new release as soon as I get
around to test it a bit on Win32.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; but I have not tried to eliminate the use of spawning with plain &#34;pp&#34;.
</div>
That will be much appreciated.  I wonder how would it work, though --
is it as simple as a LoadLibrary&#40;&#41; call to the extracted perl5x.dll?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I tested with the latest snap. BTW, the snap makefile.PL requires 
&gt; ScanDeps version 0.26, but CPAN only has 0.25 !
</div>
0.27 is now uploaded. :-&#41;

Thanks,
/Autrijus/
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;16&nbsp;12:49:33&nbsp;2003</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[autrijus@autrijus.org - Sat Aug 16 03:02:31 2003]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That will be much appreciated.  I wonder how would it work, though --
&gt; is it as simple as a LoadLibrary&#40;&#41; call to the extracted perl5x.dll?
&gt; 
</div>
Looks like static.c should become just a copy of main.c, with the 
addition of the WRITE_load_me_0 code and a LoadLibrary&#40;my_file&#41;.

And whatever needs to change in the Makefile and pp.

Alan Stewart
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;20&nbsp;21:15:06&nbsp;2003</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Alan Stewart</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Sat Aug 16 12:49:33 2003]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [autrijus@autrijus.org - Sat Aug 16 03:02:31 2003]:
&gt; 
<div class="message-stanza open">&gt; &gt; That will be much appreciated.  I wonder how would it work, though
</div>&gt;    --
<div class="message-stanza open">&gt; &gt; is it as simple as a LoadLibrary&#40;&#41; call to the extracted perl5x.dll?
&gt; &gt;
</div>&gt; 
&gt; Looks like static.c should become just a copy of main.c, with the
&gt; addition of the WRITE_load_me_0 code and a LoadLibrary&#40;my_file&#41;.
&gt; 
&gt; And whatever needs to change in the Makefile and pp.
&gt; 
&gt; Alan Stewart
</div>
A little studying and it looks a little less simple, but not bad. I 
think it needs to do:

1. Not link static.c with perl5x.lib &#40;Makefile.PL hack?&#41; so the .exe 
doesn&#39;t try to load perl5x.dll on startup, before we have a chance to 
extract it.
2. WRITE_loadme_0 and LoadLibrary&#40;&#39;/path/perl5x.dll&#39;&#41;.
3. For each perl5x function needed, GetProcAddress&#40;&#39;Perl_func_name&#39;&#41; to 
get the function address into a variable with the same name as the Perl 
API function.
4. Let the compiler notice the difference between a real function call 
and an indirect call with the same syntax for the remainder of the code 
copied from main.c.

Looks like there are only 36 Perl API functions useed directly or 
indirectly from main.c out of the 1100+ possible ones in perl5x.dll.

VC++ 6.0 and later has a linker option /DELAYLOAD:perl56.dll that would 
simplify this greatly by modding the .exe link table and adding a 
helper function to do essentially what I said above, but that would 
restrict the compiler anyone could use.

I&#39;ll give this a shot this weekend....

On the Unix/Linux side of things, does the shared library get linked at 
load time or is there an on-demand option that gives you a chance to do 
the extraction before the first function call?

Alan Stewart
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;30&nbsp;12:53:34&nbsp;2004</span>
    <span class="description">autrijus [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
