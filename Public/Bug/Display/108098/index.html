<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #108098 for DBIx-Class: Issue with alias names in +as with group by - 0.082810</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #108098 for DBIx-Class: Issue with alias names in +as with group by - 0.082810</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBIx-Class/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Class">DBIx-Class CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">108098</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBIx-Class/Active/">DBIx-Class</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
tony.langdon [...] wcn.co.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10410-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10411-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;29&nbsp;14:06:02&nbsp;2015</span>
    <span class="description">tony.langdon [...] wcn.co.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Tony WCN &lt;tony.langdon [...] wcn.co.uk&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Issue with alias names in +as with group by - 0.082810</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 29 Oct 2015 18:05:32 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tony Langdon &lt;tony.langdon [...] wcn.co.uk&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have attached minimal code to reproduce the issue.

I think part of the problem is in DBIx::Class::Storage::DBI in _select_args line 2481

    $prefetch_needs_subquery = ! scalar grep { $_ ne $attrs-&gt;{alias} } keys %{ $grp_aliases-&gt;{grouping} || {} };

I think that the ! is wrong since the subquery would only be needed if there are grouping aliases that aren’t that of this table.

That’s what I was trying to reproduce with the attached code &#40;using Artist / CDs&#41; but I also discovered that the aggregate column is not available in the result row when including the aggregate column.

e.g.

This is OK &#40;with the_wall_cds being a custom relationship to cds&#41;
  my $spec = { &#39;+as&#39;      =&gt; [ &#39;name&#39;,    &#39;number&#39; ],
               &#39;+select&#39;  =&gt; [ &#39;me.name&#39;, &#39;count&#40;the_wall_cds.cdid&#41;&#39; ],
               &#39;columns&#39;  =&gt; [],
               &#39;join&#39;     =&gt; &#39;the_wall_cds&#39;,
               &#39;group_by&#39; =&gt; [&#39;me.name&#39;], };
  my $rs = $artist_rs-&gt;search_rs&#40; {}, $spec &#41;;

However this is not:
  my $spec = { &#39;+as&#39;      =&gt; [ &#39;name&#39;,    &#39;the_wall_cds.number&#39; ],
               &#39;+select&#39;  =&gt; [ &#39;me.name&#39;, &#39;count&#40;the_wall_cds.cdid&#41;&#39; ],
               &#39;columns&#39;  =&gt; [],
               &#39;join&#39;     =&gt; &#39;the_wall_cds&#39;,
               &#39;group_by&#39; =&gt; [&#39;me.name&#39;], };
  my $rs = $artist_rs-&gt;search_rs&#40; {}, $spec &#41;;

Attached code should be self contained illustration of the issue. 

We’re trying to update our application to a more recent version of DBIx::Class &#40;from 0.08196&#41; and this is changed behaviour,

Thanks.
</div></div>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza"><div>I have attached minimal code to reproduce the issue.</div>
<div><br></div>
<div>I think part of the problem is in DBIx::Class::Storage::DBI in _select_args line 2481</div>
<div><br></div>
<div><div>&nbsp; &nbsp; $prefetch_needs_subquery = ! scalar grep { $_ ne $attrs-&gt;{alias} } keys %{ $grp_aliases-&gt;{grouping} || {} };</div></div>
<div><br></div>
<div>I think that the ! is wrong since the subquery would only be needed if there are grouping aliases that aren’t that of this table.</div>
<div><br></div>
<div>That’s what I was trying to reproduce with the attached code (using Artist / CDs) but I also discovered that the aggregate column is not available in the result row when including the aggregate column.</div>
<div><br></div>
<div>e.g.</div>
<div><br></div>
<div>This is OK (with the_wall_cds being a custom relationship to cds)</div>

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><blockquote>
<div><div>&nbsp; my $spec = { '+as' &nbsp; &nbsp; &nbsp;=&gt; [ 'name', &nbsp; &nbsp;'number' ],</div></div>
<div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'+select' &nbsp;=&gt; [ 'me.name', 'count(the_wall_cds.cdid)' ],</div></div>
<div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'columns' &nbsp;=&gt; [],</div></div>
<div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'join' &nbsp; &nbsp; =&gt; 'the_wall_cds',</div></div>
<div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'group_by' =&gt; ['me.name'], };</div></div>
<div><div>&nbsp; my $rs = $artist_rs-&gt;search_rs( {}, $spec );</div></div>
</blockquote>
</div><div><br></div>
<div>However this is not:</div>

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><blockquote>
<div><div>&nbsp; my $spec = { '+as' &nbsp; &nbsp; &nbsp;=&gt; [ 'name', &nbsp; &nbsp;'the_wall_cds.number' ],</div></div>
<div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'+select' &nbsp;=&gt; [ 'me.name', 'count(the_wall_cds.cdid)' ],</div></div>
<div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'columns' &nbsp;=&gt; [],</div></div>
<div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'join' &nbsp; &nbsp; =&gt; 'the_wall_cds',</div></div>
<div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'group_by' =&gt; ['me.name'], };</div></div>
<div><div>&nbsp; my $rs = $artist_rs-&gt;search_rs( {}, $spec );</div></div>
</blockquote>
</div><div><br></div>
<div>Attached code should be self contained illustration of the issue.&nbsp;</div>
<div><br></div>
<div>We’re trying to update our application to a more recent version of DBIx::Class (from&nbsp;0.08196) and this is changed behaviour,</div>
<div><br></div>
<div>Thanks.</div>
<div><br></div>
<div><br></div>
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>

<div class="messagebody">
<div class="message-stanza"></div></div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;03&nbsp;06:42:57&nbsp;2015</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Oct 29 19:06:02 2015, tony.langdon@wcn.co.uk wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; That’s what I was trying to reproduce with the attached code &#40;using
&gt; Artist / CDs&#41; but I also discovered that the aggregate column is not
&gt; available in the result row when including the aggregate column.
&gt;
&gt;   my $spec = { &#39;+as&#39;      =&gt; [ &#39;name&#39;,    &#39;the_wall_cds.number&#39; ],
&gt;                &#39;+select&#39;  =&gt; [ &#39;me.name&#39;, &#39;count&#40;the_wall_cds.cdid&#41;&#39;
&gt; ],
&gt;                &#39;columns&#39;  =&gt; [],
&gt;                &#39;join&#39;     =&gt; &#39;the_wall_cds&#39;,
&gt;                &#39;group_by&#39; =&gt; [&#39;me.name&#39;], };
&gt;   my $rs = $artist_rs-&gt;search_rs&#40; {}, $spec &#41;;
&gt; 
</div>

You have several issues tangled here, I will first address the above one &#40;as it is a clear bug in a subsystem I am currently working on&#41;. Once a devrel is available addressing the above, we will revisit your actual failure case.

Sorry for the delay, last month was too conference-y.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;03&nbsp;06:42:59&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;09&nbsp;08:19:49&nbsp;2016</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Oct 29 19:06:02 2015, tony.langdon@wcn.co.uk wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; We’re trying to update our application to a more recent version of
&gt; DBIx::Class &#40;from 0.08196&#41; and this is changed behaviour,
</div>

Hi! This ticket got dropped on the floor, sorry about that :&#40;

Looking over it again it seems that what you described never worked on 0.08196 in the first place. Could you please check this self-contained example, and tell me how it differs from what you have in production?

I am definitely missing something...

Thanks!


rabbit@Ahasver:~$ cpanm --look DBIx::Class@0.08196
--&gt; Working on DBIx::Class
Fetching <span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpan.org/authors/id/A/AR/ARODLAND/DBIx-Class-0.08196.tar.gz">http://www.cpan.org/authors/id/A/AR/ARODLAND/DBIx-Class-0.08196.tar.gz</a></span> ... OK
Entering /home/rabbit/.cpanm/work/1455023884.3729/DBIx-Class-0.08196 with /bin/bash

rabbit@Ahasver:~/.cpanm/work/1455023884.3729/DBIx-Class-0.08196$ DBICTEST_NO_MAKEFILE_VERIFICATION=1 perl -I lib -I t/lib -MDBICTest -MDevel::Dwarn -e &#39;
   warn DBIx::Class-&gt;VERSION;
 
   Dwarn [ DBICTest-&gt;init_schema-&gt;resultset&#40;&#34;Artist&#34;&#41;-&gt;search&#40;{}, {
     join =&gt; &#34;cds&#34;,
     group_by =&gt; &#34;me.name&#34;,
     &#34;+columns&#34; =&gt; {
       &#34;cds.count&#34; =&gt; &#34;count&#40;cds.cdid&#41;&#34;
     }
   }&#41;-&gt;all ]
&#39;
0.08196 at -e line 2.
DBIx::Class::ResultSet::all&#40;&#41;: Manual prefetch &#40;via select/columns&#41; not supported with accessor &#39;multi&#39; at -e line 4
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;11&nbsp;10:04:54&nbsp;2016</span>
    <span class="description">tony.langdon [...] wcn.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #108098] Issue with alias names in +as with group by - 0.082810</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 11 Feb 2016 15:04:37 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tony Langdon &lt;tony.langdon [...] wcn.co.uk&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I agree that DBIx::Class doesn’t like the query with 0.08196 and reports a Manual prefetch error if we run the resultset as is.

However in our code we don’t do that. 
1. We use as_query to get the select statement and binds
2. We match the query against a regex m!^\&#40;SELECT &#40;.+?&#41; FROM &#40;.+&#41;\&#41;$! to get the column &#38; table list
3. We wrap the query in an ‘insert into temptable’ which we run through DBI::do for paging / handling complicated many column selects

On 0.08196 the SQL generated was valid &#40;even though DBIx wouldn’t run it&#41;, with 0.082810 the subquery it is generating breaks our regex because of the subquery it adds.

0.08196 for my second query &#40;with ‘.’ in the +as names&#41;
&#40;SELECT me.name, count&#40;the_wall_cds.cdid&#41; FROM artist me LEFT JOIN cd the_wall_cds ON &#40; the_wall_cds.artistid = me.artistid AND the_wall_cds.title = ? &#41; GROUP BY me.name&#41;
0.082810
&#40;SELECT me.name, count&#40;the_wall_cds.cdid&#41; FROM &#40;SELECT me.name, count&#40;the_wall_cds.cdid&#41;, me.artistid FROM artist me LEFT JOIN cd the_wall_cds ON &#40; the_wall_cds.artistid = me.artistid AND the_wall_cds.title = ? &#41; GROUP BY me.name&#41; me LEFT JOIN cd the_wall_cds ON &#40; the_wall_cds.artistid = me.artistid AND the_wall_cds.title = ? &#41;

I know that this is unsupported behaviour, the query was invalid before and is still invalid, but it does seem to display an issue in DBIx::Class. The sub query in 0.082810 is unnecessary, the logic in DBIx::Class::Storage::DBI _select_args &#40;~2479&#41; seems to have the opposite logic to the comment.

    # no aliases other than our own in group_by
    # if there are - do not allow subquery even if limit is present
# TL - Patch for subquery
#    $prefetch_needs_subquery = ! scalar grep { $_ ne $attrs-&gt;{alias} } keys %{ $grp_aliases-&gt;{grouping} || {} };
    $prefetch_needs_subquery = scalar grep { $_ ne $attrs-&gt;{alias} } keys %{ $grp_aliases-&gt;{grouping} || {} };



<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 9 Feb 2016, at 13:19, Peter Rabbitson via RT &lt;bug-DBIx-Class@rt.cpan.org&gt; wrote:
&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=108098">https://rt.cpan.org/Ticket/Display.html?id=108098</a></span> &gt;
&gt; 
&gt; On Thu Oct 29 19:06:02 2015, tony.langdon@wcn.co.uk wrote:
<div class="message-stanza open">&gt;&gt; We’re trying to update our application to a more recent version of
&gt;&gt; DBIx::Class &#40;from 0.08196&#41; and this is changed behaviour,
</div>&gt; 
&gt; 
&gt; Hi! This ticket got dropped on the floor, sorry about that :&#40;
&gt; 
&gt; Looking over it again it seems that what you described never worked on 0.08196 in the first place. Could you please check this self-contained example, and tell me how it differs from what you have in production?
&gt; 
&gt; I am definitely missing something...
&gt; 
&gt; Thanks!
&gt; 
&gt; 
&gt; rabbit@Ahasver:~$ cpanm --look DBIx::Class@0.08196
&gt; --&gt; Working on DBIx::Class
&gt; Fetching <span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpan.org/authors/id/A/AR/ARODLAND/DBIx-Class-0.08196.tar.gz">http://www.cpan.org/authors/id/A/AR/ARODLAND/DBIx-Class-0.08196.tar.gz</a></span> ... OK
&gt; Entering /home/rabbit/.cpanm/work/1455023884.3729/DBIx-Class-0.08196 with /bin/bash
&gt; 
&gt; rabbit@Ahasver:~/.cpanm/work/1455023884.3729/DBIx-Class-0.08196$ DBICTEST_NO_MAKEFILE_VERIFICATION=1 perl -I lib -I t/lib -MDBICTest -MDevel::Dwarn -e &#39;
&gt;   warn DBIx::Class-&gt;VERSION;
&gt; 
&gt;   Dwarn [ DBICTest-&gt;init_schema-&gt;resultset&#40;&#34;Artist&#34;&#41;-&gt;search&#40;{}, {
&gt;     join =&gt; &#34;cds&#34;,
&gt;     group_by =&gt; &#34;me.name&#34;,
&gt;     &#34;+columns&#34; =&gt; {
&gt;       &#34;cds.count&#34; =&gt; &#34;count&#40;cds.cdid&#41;&#34;
&gt;     }
&gt;   }&#41;-&gt;all ]
&gt; &#39;
&gt; 0.08196 at -e line 2.
&gt; DBIx::Class::ResultSet::all&#40;&#41;: Manual prefetch &#40;via select/columns&#41; not supported with accessor &#39;multi&#39; at -e line 4
&gt; 
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;11&nbsp;11:10:13&nbsp;2016</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Feb 11 16:04:54 2016, tony.langdon@wcn.co.uk wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I agree that DBIx::Class doesn’t like the query with 0.08196 and
&gt; reports a Manual prefetch error if we run the resultset as is.
&gt; 
&gt; However in our code we don’t do that.
&gt; 1. We use as_query to get the select statement and binds
</div>
Nothing wrong with that.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2. We match the query against a regex m!^\&#40;SELECT &#40;.+?&#41; FROM &#40;.+&#41;\&#41;$!
&gt; to get the column &#38; table list
&gt; 3. We wrap the query in an ‘insert into temptable’ which we run
&gt; through DBI::do for paging / handling complicated many column selects
</div>
Cringe, but I can see why you are doing it this way ;&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I know that this is unsupported behaviour
</div>
I wouldn&#39;t go that far. What you are failing to recognize is that you are asking DBIC to do something it could not do before 0.08250, precisely because it was producing the query that happened to work for you.

In order to do what you want all you need is to replace 

  &#34;+columns&#34; =&gt; { &#34;cds.count&#34; =&gt; &#34;count&#40;cds.cdid&#41;&#34; }

with

  &#34;+columns&#34; =&gt; { &#34;cds_count&#34; =&gt; &#34;count&#40;cds.cdid&#41;&#34; }

With the former invocation you are saying &#34;I will retrieve some column and hang it off the *1:M* related slot&#34;. So DBIC gets into a mode where it needs to isolate the group_by, so that the &#34;1:M&#34; does not get collapsed.

With the latter syntax you are saying &#34;everything that comes back - just shove it into the main object and don&#39;t bother doing any related object resolution&#34;. Which ends up producing what you want.

&#40;SELECT me.artistid, me.name, me.rank, me.charfield, count&#40;cds.cdid&#41; FROM artist me LEFT JOIN cd cds ON cds.artist = me.artistid GROUP BY me.name&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; DBIx::Class::Storage::DBI _select_args &#40;~2479&#41; seems to have the
&gt; opposite logic to the comment.
</div>
It isn&#39;t opposite. If you are curious: simply edit it &#40;by removing the !&#41; and run the test suite &#40;prove -lr&#41; to see what will blow up.

Let me know if this solves the problem for you.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;11&nbsp;11:27:07&nbsp;2016</span>
    <span class="description">tony.langdon [...] wcn.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #108098] Issue with alias names in +as with group by - 0.082810</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 11 Feb 2016 16:26:44 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tony Langdon &lt;tony.langdon [...] wcn.co.uk&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I’ll look at the column names suggestion as it’s better than our alternate patch which manipulates the internal structure to remove the +as with group_by:
      my $rs2 = $shema-&gt;resultset&#40;‘SomeClass’&#41;-&gt;search&#40;{…}&#41;
      if &#40;exists $rs2-&gt;{&#39;attrs&#39;}{&#39;group_by&#39;}&#41; {
        delete $rs2-&gt;{&#39;attrs&#39;}{&#39;+as&#39;};
      }
     $rs2-&gt;as_sql….

I’ve been running the tweaked DBIx::Class::Storage::DBI for a few months now and it seemed OK with our code. However if it breaks the DBIx::Class tests it must be breaking something that I haven’t noticed yet.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 11 Feb 2016, at 16:10, Peter Rabbitson via RT &lt;bug-DBIx-Class@rt.cpan.org&gt; wrote:
&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=108098">https://rt.cpan.org/Ticket/Display.html?id=108098</a></span> &gt;
&gt; 
&gt; On Thu Feb 11 16:04:54 2016, tony.langdon@wcn.co.uk wrote:
<div class="message-stanza open">&gt;&gt; I agree that DBIx::Class doesn’t like the query with 0.08196 and
&gt;&gt; reports a Manual prefetch error if we run the resultset as is.
&gt;&gt; 
&gt;&gt; However in our code we don’t do that.
&gt;&gt; 1. We use as_query to get the select statement and binds
</div>&gt; 
&gt; Nothing wrong with that.
&gt; 
<div class="message-stanza open">&gt;&gt; 2. We match the query against a regex m!^\&#40;SELECT &#40;.+?&#41; FROM &#40;.+&#41;\&#41;$!
&gt;&gt; to get the column &#38; table list
&gt;&gt; 3. We wrap the query in an ‘insert into temptable’ which we run
&gt;&gt; through DBI::do for paging / handling complicated many column selects
</div>&gt; 
&gt; Cringe, but I can see why you are doing it this way ;&#41;
&gt; 
<div class="message-stanza open">&gt;&gt; I know that this is unsupported behaviour
</div>&gt; 
&gt; I wouldn&#39;t go that far. What you are failing to recognize is that you are asking DBIC to do something it could not do before 0.08250, precisely because it was producing the query that happened to work for you.
&gt; 
&gt; In order to do what you want all you need is to replace
&gt; 
&gt;  &#34;+columns&#34; =&gt; { &#34;cds.count&#34; =&gt; &#34;count&#40;cds.cdid&#41;&#34; }
&gt; 
&gt; with
&gt; 
&gt;  &#34;+columns&#34; =&gt; { &#34;cds_count&#34; =&gt; &#34;count&#40;cds.cdid&#41;&#34; }
&gt; 
&gt; With the former invocation you are saying &#34;I will retrieve some column and hang it off the *1:M* related slot&#34;. So DBIC gets into a mode where it needs to isolate the group_by, so that the &#34;1:M&#34; does not get collapsed.
&gt; 
&gt; With the latter syntax you are saying &#34;everything that comes back - just shove it into the main object and don&#39;t bother doing any related object resolution&#34;. Which ends up producing what you want.
&gt; 
&gt; &#40;SELECT me.artistid, me.name, me.rank, me.charfield, count&#40;cds.cdid&#41; FROM artist me LEFT JOIN cd cds ON cds.artist = me.artistid GROUP BY me.name&#41;
&gt; 
<div class="message-stanza open">&gt;&gt; DBIx::Class::Storage::DBI _select_args &#40;~2479&#41; seems to have the
&gt;&gt; opposite logic to the comment.
</div>&gt; 
&gt; It isn&#39;t opposite. If you are curious: simply edit it &#40;by removing the !&#41; and run the test suite &#40;prove -lr&#41; to see what will blow up.
&gt; 
&gt; Let me know if this solves the problem for you.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;11&nbsp;13:33:14&nbsp;2016</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Feb 11 17:27:07 2016, tony.langdon@wcn.co.uk wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I’ve been running the tweaked DBIx::Class::Storage::DBI for a few
&gt; months now and it seemed OK with our code. However if it breaks the
&gt; DBIx::Class tests it must be breaking something that I haven’t noticed
&gt; yet.
</div>
To be honest it is kinda strange to me that you modified the library *without* executing its comprehensive test suite to see whether it will affect anything ;&#41;

In any case - please let me know when you had a chance to try, so I can scratch this off the todo.

Cheers!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;30&nbsp;14:33:12&nbsp;2016</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">No response - closing.

You are very much encouraged to reopen this if the problem is not fully resolved.

Cheers!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;30&nbsp;14:33:20&nbsp;2016</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
