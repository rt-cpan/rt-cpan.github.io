<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #30692 for Catalyst-Runtime: The working of $c-&gt;view&#40;&#41; with no defaults</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #30692 for Catalyst-Runtime: The working of $c-&gt;view&#40;&#41; with no defaults</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Catalyst-Runtime/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Catalyst-Runtime/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Catalyst-Runtime/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Catalyst-Runtime/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Catalyst-Runtime">Catalyst-Runtime CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">30692</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Catalyst-Runtime/Active/">Catalyst-Runtime</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
a.r.ferreira [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-40040-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-40041-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;13&nbsp;08:33:38&nbsp;2007</span>
    <span class="description">a.r.ferreira [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> The working of $c-&gt;view&#40;&#41; with no defaults</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">A few days ago, me and my colleagues at work have
been bitten by a bug in a Catalyst application
which used Catalyst::Action::RenderView.

This application used two views

     App::View::TT
     App::View::JSON

We used at a base controller

     sub end : ActionClass&#40;&#39;RenderView&#39;&#41; {}

and expected to work ok &#40;using App::View::TT&#41;.
And so it did... until we renamed the application.
Then it started to use the JSON view.

The solution was rather obvious to my
co-workers &#40;which are more used to Catalyst
development&#41;: include a &#34;default_view&#34; in
the config file.

I investigated further the case because it
bugged me having no help of Catalyst itself
to diagnose this.

The docs of Catalyst::Action::RenderView says:

&#34;This action implements a sensible default
 end action, which will forward to the first
 available view.&#34;

which is a little cunning for an unaware
developer.

I traced the code behavior to the implementation
of Catalyst::view&#40;&#41; when used without parameters.

The docs says:

  =head2 $c-&gt;view&#40;$name&#41;

  ...

  If the name is omitted, it will look for
   - a view object in $c-&gt;stash{current_view_instance}, then
   - a view name in $c-&gt;stash-&gt;{current_view}, then
   - a config setting &#39;default_view&#39;, or
   - check if there is only one view, and return it if that&#39;s the case.

and there was tests at t/unit_core_mvc.t

  is &#40;MyApp-&gt;view , &#39;MyApp::View::V&#39;, &#39;view&#40;&#41; with no defaults ok&#39;&#41;;

But contrary to the documentation, &#34;MyApp-&gt;view&#34; should not
return such answer at this case, because there is not only one
view in the application skeleton being tested.

The problem lives in the code of _comp_singular,
which is supposed to &#34;return a component if only one matches&#34;.

--- Catalyst-Runtime-5.7011/lib/Catalyst.pm     2007-10-18
15:06:26.000000000 -0300
+++ Catalyst-Runtime/lib/Catalyst.pm    2007-11-09 23:52:27.000000000 -0200
@@ -474,7 +474,7 @@

     my &#40; $comp, $rest &#41; =
       map { $c-&gt;_comp_search&#40;&#34;^${appclass}::${_}::&#34;&#41; } @prefixes;
-    return $comp unless $rest;
+    return $rest ? undef : $comp;
 }

The last line &#34;return $comp unless $rest&#34; works ok
if there is only one view. But if there is more than
one view, the return depends on the last statement
&#40;which is the result of the &#34;map&#34;&#41;. Thus, it always
returned a component that matched the criteria.

I don&#39;t think this undefined behavior which can
change if the implementation changes is desirable.
So the fix is a more explicit expression like

    return $rest ? undef : $comp;

And then $c-&gt;view&#40;&#41; with no defaults will return
undef if there is more than one view.

The &#34;bug&#34; affected &#34;$c-&gt;model&#40;&#41;&#34; as well and so
does the patch.

The attached patch tweaks this bit and the mentioned
test to make this coherent with this argument.

NOTE. Obviously, if many Catalyst developers
out there and Catalyst applications rely on this
behavior &#40;namely, &#34;$c-&gt;view&#40;&#41; with no defaults return
some view&#34;&#41;, this change may be not the right
thing to do.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> view-patch.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ru Catalyst-Runtime-5.7011/lib/Catalyst.pm Catalyst-Runtime/lib/Catalyst.pm
--- Catalyst-Runtime-5.7011/lib/Catalyst.pm	2007-10-18 15:06:26.000000000 -0300
+++ Catalyst-Runtime/lib/Catalyst.pm	2007-11-09 23:52:27.000000000 -0200
@@ -474,7 +474,7 @@
 
     my &#40; $comp, $rest &#41; =
       map { $c-&gt;_comp_search&#40;&#34;^${appclass}::${_}::&#34;&#41; } @prefixes;
-    return $comp unless $rest;
+    return $rest ? undef : $comp;
 }
 
 # Filter a component before returning by calling ACCEPT_CONTEXT if available
diff -ru Catalyst-Runtime-5.7011/t/unit_core_mvc.t Catalyst-Runtime/t/unit_core_mvc.t
--- Catalyst-Runtime-5.7011/t/unit_core_mvc.t	2007-09-20 06:29:36.000000000 -0300
+++ Catalyst-Runtime/t/unit_core_mvc.t	2007-11-09 23:50:42.000000000 -0200
@@ -1,17 +1,23 @@
-use Test::More tests =&gt; 27;
+use Test::More tests =&gt; 29;
 use strict;
 use warnings;
 
 use_ok&#40;&#39;Catalyst&#39;&#41;;
 
-my @complist =
-  map { &#34;MyApp::$_&#34;; }
-  qw/C::Controller M::Model V::View Controller::C Model::M View::V Controller::Model::Dummy::Model Model::Dummy::Model/;
-
-my $thingie={};
-bless $thingie,&#39;MyApp::Model::Test::Object&#39;;
-push @complist,$thingie;
 {
+    my @complist =
+      map { &#34;MyApp::$_&#34;; }
+      qw/ C::Controller 
+          M::Model 
+          V::View 
+          Controller::C 
+          Model::M 
+          View::V 
+          Controller::Model::Dummy::Model 
+          Model::Dummy::Model /;
+
+    my $thingie = bless {},&#39;MyApp::Model::Test::Object&#39;;
+    push @complist,$thingie;
 
     package MyApp;
 
@@ -51,7 +57,7 @@
            [ qw/Dummy::Model M Model Test::Object/ ],
            &#39;models ok&#39;&#41;;
 
-is &#40;MyApp-&gt;view , &#39;MyApp::V::View&#39;, &#39;view&#40;&#41; with no defaults ok&#39;&#41;;
+is &#40;MyApp-&gt;view , undef, &#39;view&#40;&#41; with no defaults returns undef &#40;two views&#41;&#39;&#41;;
 
 is &#40; bless &#40;{stash=&gt;{current_view=&gt;&#39;V&#39;}}, &#39;MyApp&#39;&#41;-&gt;view , &#39;MyApp::View::V&#39;, &#39;current_view ok&#39;&#41;;
 
@@ -61,7 +67,7 @@
 is &#40; bless &#40;{stash=&gt;{current_view_instance=&gt; $view, current_view=&gt;&#39;MyApp::V::View&#39; }}, &#39;MyApp&#39;&#41;-&gt;view , $view, 
   &#39;current_view_instance precedes current_view ok&#39;&#41;;
 
-is &#40;MyApp-&gt;model , &#39;MyApp::M::Model&#39;, &#39;model&#40;&#41; with no defaults ok&#39;&#41;;
+is &#40;MyApp-&gt;model , undef, &#39;model&#40;&#41; with no defaults returns undef &#40;multiple models&#41;&#39;&#41;;
 
 is &#40; bless &#40;{stash=&gt;{current_model=&gt;&#39;M&#39;}}, &#39;MyApp&#39;&#41;-&gt;model , &#39;MyApp::Model::M&#39;, &#39;current_model ok&#39;&#41;;
 
@@ -90,3 +96,19 @@
 is_deeply&#40;$args, [qw/foo bar/], &#39;$c-&gt;model args passed to ACCEPT_CONTEXT ok&#39;&#41;;
 MyApp-&gt;view&#40;&#39;V&#39;, qw/baz moo/&#41;;
 is_deeply&#40;$args, [qw/baz moo/], &#39;$c-&gt;view args passed to ACCEPT_CONTEXT ok&#39;&#41;;
+
+{
+    package MyApp2;
+
+    use base qw/Catalyst/;
+
+    my @complist = map { __PACKAGE__ . &#39;::&#39; . $_ }
+                   qw/ Model::M 
+                       View::V 
+                   /;
+    __PACKAGE__-&gt;components&#40; { map { &#40; ref&#40;$_&#41;||$_ , $_ &#41; } @complist } &#41;;
+}
+
+is &#40;MyApp2-&gt;view , &#39;MyApp2::View::V&#39;, &#39;view&#40;&#41; with no defaults ok&#39;&#41;;
+
+is &#40;MyApp2-&gt;model , &#39;MyApp2::Model::M&#39;, &#39;model&#40;&#41; with no defaults ok&#39;&#41;;
\ No newline at end of file
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;13&nbsp;15:30:17&nbsp;2007</span>
    <span class="description">dbix-class [...] trout.me.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #30692] The working of $c-&gt;view&#40;&#41; with no defaults</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 13 Nov 2007 20:29:24 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;a.r.ferreira [...] gmail.com via RT&#34; &lt;bug-Catalyst-Runtime [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Matt S Trout &lt;dbix-class [...] trout.me.uk&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Nov 13, 2007 at 08:33:41AM -0500, a.r.ferreira@gmail.com via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; -    return $comp unless $rest;
&gt; +    return $rest ? undef : $comp;
</div>
This could potentially break working code.

Instead, how about adding a patch to do a $c-&gt;log-&gt;warn if it finds two
possible candidates?

-- 
      Matt S Trout       Need help with your Catalyst or DBIx::Class project?
   Technical Director                    <span class="clickylink"><a target="new" rel="nofollow" href="http://www.shadowcat.co.uk/catalyst/">http://www.shadowcat.co.uk/catalyst/</a></span>
 Shadowcat Systems Ltd.  Want a managed development or deployment platform?
<span class="clickylink"><a target="new" rel="nofollow" href="http://chainsawblues.vox.com/">http://chainsawblues.vox.com/</a></span>            <span class="clickylink"><a target="new" rel="nofollow" href="http://www.shadowcat.co.uk/servers/">http://www.shadowcat.co.uk/servers/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;13&nbsp;15:30:21&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;26&nbsp;09:28:25&nbsp;2008</span>
    <span class="description">bricas [...] cpan.org -  Fixed in 5.7011 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;13&nbsp;09:19:44&nbsp;2008</span>
    <span class="description">bricas [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">We cannot use the requested behavior &#40;i.e. return undef on multiple
matches&#41; as it breaks an expected behavior. Instead we&#39;ve reworked
component resolution to include some fairly verbose warnings when things
like view&#40;&#41; are called with no arguments and multiple results are found.

The changes currently reside in the &#34;compres&#34; branch. Here is the svnweb
changelog:

<span class="clickylink"><a target="new" rel="nofollow" href="http://dev.catalystframework.org/svnweb/Catalyst/log/Catalyst-Runtime/5.70/branches/compres/">http://dev.catalystframework.org/svnweb/Catalyst/log/Catalyst-Runtime/5.70/branches/compres/</a></span>

This branch is due to be merge very soon.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;13&nbsp;09:19:46&nbsp;2008</span>
    <span class="description">bricas [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
