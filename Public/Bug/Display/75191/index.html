<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #75191 for Net-SNMP: Synchronize in SNMPv3</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #75191 for Net-SNMP: Synchronize in SNMPv3</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-SNMP/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-SNMP/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-SNMP/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-SNMP/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SNMP">Net-SNMP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">75191</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">5 min

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-SNMP/Active/">Net-SNMP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">dtown [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
manuel-cpan [...] mausz.at

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-23238-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
v6.0.1    </td>
  </tr>
  <tr id="CF-23239-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;21&nbsp;08:14:40&nbsp;2012</span>
    <span class="description">https://www.google.com/accounts/o8/id?id=AItOawk1HFsg_ZtNpUosijePsEL3G_I7ua-bL6w -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Synchronize in SNMPv3</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi there.

I&#39;m not quite sure if this is actually a bug in Net::SNMP or just a bug
in the HP ProCurve SNMPv3 engine but let&#39;s start at the beginning:

We&#39;re using MRTG to generate some basic network graphs of our traffic.
Recently we started to graph them on our internal network which is run
with HP ProCurve switches &#40;2510G&#41;. We&#39;re using SNMPv3 since a few years
now without any problems and the ProCurve SNMPv3 users are set up
properly. However after activating MRTG &#40;which uses Net::SNMP&#41; the
switches are generating the following error message on every run:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Feb 21 13:49:07 a.b.c.d snmp:  SNMP Security access violation from e.f.g.h
</div>
The error message doesn&#39;t stop MRTG &#40;or SNMPv3&#41; from working. It just
gets triggered and written to the error log on every SNMPv3
authentification.

So digged into this and noticed that snmpwalk and the other tools from
net-snmp are NOT triggering this error message. After digging deeper and
parsing the SNMPv3 bytestreams I noticed that Net::SNMP is not putting
the engineBoots- and engineTime-values received in the first paket &#40;the
one that&#39;s generating the usmStatsUnknownEngineIDs error&#41; into the
second,  authentification paket. However net-snmp is doing that. So I
decided to try to fix that and in fact the error message doesn&#39;t get
triggered any more.

Attached is a patch I&#39;ve quickly put together. I&#39;m not sure what RFC
says about this. Just wanted to fix that annoying error message. A side
effect of my patch is that usmStatsNotInTimeWindows won&#39;t get triggered
any more on authentification. Additional I&#39;m not sure about other side
effects. I&#39;ve tested my patch against all our SNMPv3 devices and
authentification is still working.

Regards,
/ manuel
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;21&nbsp;08:19:46&nbsp;2012</span>
    <span class="description">https://www.google.com/accounts/o8/id?id=AItOawk1HFsg_ZtNpUosijePsEL3G_I7ua-bL6w -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Manuel</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">hm. looks like the attachment got lost. trying again...
or just use:
<span class="clickylink"><a target="new" rel="nofollow" href="http://manuel.mausz.at/coding/patches/net-snmp-synchronize.patch">http://manuel.mausz.at/coding/patches/net-snmp-synchronize.patch</a></span>

/ manuel
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> net-snmp-synchronize.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -Naur a/lib/Net/SNMP.pm b/lib/Net/SNMP.pm
--- a/lib/Net/SNMP.pm	2011-12-24 00:41:27.000000000 +0100
+++ b/lib/Net/SNMP.pm	2012-02-21 13:17:04.000000000 +0100
@@ -2564,7 +2564,7 @@
 
    if &#40;$this-&gt;{_security}-&gt;discovered&#40;&#41;&#41; {
       DEBUG_INFO&#40;&#39;discovery complete&#39;&#41;;
-      return $this-&gt;_discovery_complete&#40;&#41;;
+      $this-&gt;_discovery_complete&#40;&#41;;
    }
 
    # &#34;If authenticated communication is required, then the discovery
@@ -2618,7 +2618,7 @@
    # assume that the synchronization has failed.
 
    if &#40;&#40;$this-&gt;{_security}-&gt;discovered&#40;&#41;&#41; &#38;&#38;
-       &#40;$this-&gt;{_error} =~ /usmStatsNotInTimeWindows/&#41;&#41;
+       &#40;&#40;!$this-&gt;{_error}&#41; || &#40;$this-&gt;{_error} =~ /usmStatsNotInTimeWindows/&#41;&#41;&#41;
    {
       $this-&gt;_error_clear&#40;&#41;;
       DEBUG_INFO&#40;&#39;discovery and synchronization complete&#39;&#41;;
diff -Naur a/lib/Net/SNMP/Security/USM.pm b/lib/Net/SNMP/Security/USM.pm
--- a/lib/Net/SNMP/Security/USM.pm	2011-12-24 00:41:27.000000000 +0100
+++ b/lib/Net/SNMP/Security/USM.pm	2012-02-21 13:20:47.000000000 +0100
@@ -471,6 +471,16 @@
       &#41;;
    }
 
+   # Synchronize the time
+   if &#40;!$this-&gt;_synchronize&#40;$msg_engine_boots, $msg_engine_time&#41;&#41; {
+      return $this-&gt;_error&#40;&#41;;
+   }
+
+   # Check for timeliness
+   if &#40;!defined $this-&gt;_timeliness&#40;$msg_engine_boots, $msg_engine_time&#41;&#41; {
+      return $this-&gt;_error&#40;&#41;;
+   }
+
    if &#40;$security_level &gt; SECURITY_LEVEL_NOAUTHNOPRIV&#41; {
 
       # Authenticate the message
@@ -478,16 +488,6 @@
          return $this-&gt;_error&#40;&#41;;
       }
 
-      # Synchronize the time
-      if &#40;!$this-&gt;_synchronize&#40;$msg_engine_boots, $msg_engine_time&#41;&#41; {
-         return $this-&gt;_error&#40;&#41;;
-      }
-
-      # Check for timeliness
-      if &#40;!defined $this-&gt;_timeliness&#40;$msg_engine_boots, $msg_engine_time&#41;&#41; {
-         return $this-&gt;_error&#40;&#41;;
-      }
-
       if &#40;$security_level &gt; SECURITY_LEVEL_AUTHNOPRIV&#41; {
 
          # Validate the msgPrivacyParameters length.
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;21&nbsp;08:19:47&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;15&nbsp;14:27:27&nbsp;2012</span>
    <span class="description">dtown [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">5 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The Net::SNMP module uses the discovery process described in Section 4
of RFC 3414 when first communicating with a SNMPv3 agent.  In this
section, it is recommended that two distinct and intentionally invalid
messages be sent for discovery, if authentication is being used.  My
guess is that the second message being sent by the module is triggering
the &#34;Access Violations&#34;.

I would like to keep the Net::SNMP module inline with RFC 3414, so it
sends both messages.  I would consider a ticket to add a flag to toggle
this functionality.

== From RFC 3414 Section 4 ==

The User-based Security Model requires that a discovery process obtains
sufficient information about other SNMP engines in order to communicate
with them. Discovery requires an non-authoritative SNMP engine to learn
the authoritative SNMP engine&#39;s snmpEngineID value before communication
may proceed. This may be accomplished by generating a Request message
with a securityLevel of noAuthNoPriv, a msgUserName of zero-length, a
msgAuthoritativeEngineID value of zero length, and the varBindList left
empty. The response to this message will be a Report message containing
the snmpEngineID of the authoritative SNMP engine as the value of the
msgAuthoritativeEngineID field within the msgSecurityParameters field.
It contains a Report PDU with the usmStatsUnknownEngineIDs counter in
the varBindList.

If authenticated communication is required, then the discovery process
should also establish time synchronization with the authoritative SNMP
engine. This may be accomplished by sending an authenticated Request
message with the value of msgAuthoritativeEngineID set to the newly
learned snmpEngineID and with the values of msgAuthoritativeEngineBoots
and msgAuthoritativeEngineTime set to zero. For an authenticated Request
message, a valid userName must be used in the msgUserName field. The
response to this authenticated message will be a Report message
containing the up to date values of the authoritative SNMP engine&#39;s
snmpEngineBoots and snmpEngineTime as the value of the
msgAuthoritativeEngineBoots and msgAuthoritativeEngineTime fields
respectively. It also contains the usmStatsNotInTimeWindows counter in
the varBindList of the Report PDU

== End ==
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;15&nbsp;14:27:28&nbsp;2012</span>
    <span class="description">dtown [...] cpan.org -  Given to DTOWN</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;28&nbsp;16:22:07&nbsp;2018</span>
    <span class="description">joy [...] entuzijast.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #75191] possible duplicate</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 28 Dec 2018 22:21:57 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SNMP [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Josip Rodin &lt;joy [...] entuzijast.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Possible duplicate: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=127094">https://rt.cpan.org/Public/Bug/Display.html?id=127094</a></span>

BTW I&#39;ve tried applying only the lib/Net/SNMP/Security/USM.pm portions of
the original patch posted here in 2012, but they don&#39;t make my use case
work. It sounds more like the breaking of the logic with !$this-&gt;{_error}
was the kicker.

-- 
     2. That which causes joy or happiness.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
