<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #72556 for DBIx-Class: group_by crashes the multi step join query</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #72556 for DBIx-Class: group_by crashes the multi step join query</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBIx-Class/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Class">DBIx-Class CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">72556</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBIx-Class/Active/">DBIx-Class</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
TCONST [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10410-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.08195    </td>
  </tr>
  <tr id="CF-10411-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;19&nbsp;15:37:04&nbsp;2011</span>
    <span class="description">TCONST [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> group_by crashes the multi step join query</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Output of uname -a:

Linux 185.72.34.89.in-addr.arpa 2.6.18-194.26.1.el5PAE #1 SMP Tue Nov 9 
13:34:42 EST 2010 i686 i686 i386 GNU/Linux

perl -v:
This is perl 5, version 14, subversion 2 &#40;v5.14.2&#41; built for i686-linux-
thread-multi

I have the dbic &#34;query&#34;:

 my $companies_rs = $self-&gt;app-&gt;model-&gt;resultset&#40;&#39;Food::Schema::Result::CompanyType&#39;&#41;
        -&gt;search_rs&#40;
         {

          &#39;type&#39; =&gt; &#39;orderer&#39;,
          &#39;orders.status&#39;     =&gt; { &#39;!=&#39; =&gt; &#39;paid&#39; },
          &#39;company_2.id&#39; =&gt; $self-&gt;app-&gt;sessions-&gt;{user}-&gt;company&#40;&#41;-&gt;id&#40;&#41;,
         },
         {
           join      =&gt; { &#39;company&#39; =&gt; { &#39;users&#39; =&gt; { &#39;orders&#39; =&gt; &#39;company&#39; } } },
           prefetch  =&gt; [ qw&#40; company &#41;],
           select    =&gt; [ { sum =&gt; &#39;orders.total&#39;, -as =&gt; &#39;company_total&#39; }, ], #SQL As
           columns   =&gt; [ qw&#40;  company.name orders.company_id&#41; ],
           as        =&gt; [qw/company_total/], #used for retrieving the above sql as
           #group_by  =&gt; &#39;orders.company_id&#39; ,
         } &#41;;

which works ok, it outputs the MySQL query:

SELECT company.name, orders.company_id, SUM&#40; orders.total &#41; AS company_total, company.id, company.name, 
company.website, company.phone, company.company_type_id
FROM company_types me
LEFT JOIN companies company ON company.company_type_id = me.id
LEFT JOIN users users ON users.company_id = company.id
LEFT JOIN orders orders ON orders.user_id = users.id
LEFT JOIN companies company_2 ON company_2.id = orders.company_id
WHERE &#40;

&#40;
company_2.id = ? 
AND orders.status != ? 
AND TYPE = ?
&#41;
&#41;
ORDER BY company.company_type_id

However, in order to get the sum for each company for each order, I have to add a GROUP BY company.id or GROUP BY 
orders.company_id. If I uncomment the group_by clause from the above dbic query, it generates this SQL 
monstruosity:

SELECT company.name, orders.company_id, me.company_total, company.id, company.name, company.website, 
company.phone, company.company_type_id
FROM &#40;


SELECT company.name, orders.company_id, SUM&#40; orders.total &#41; AS company_total
FROM company_types me
LEFT JOIN companies company ON company.company_type_id = me.id
LEFT JOIN users users ON users.company_id = company.id
LEFT JOIN orders orders ON orders.user_id = users.id
LEFT JOIN companies company_2 ON company_2.id = orders.company_id
WHERE &#40;
&#40;
company_2.id = ? 
AND orders.status != ? 
AND TYPE = ?
&#41;
&#41;
GROUP BY orders.company_id
&#41;me
LEFT JOIN companies company ON company.company_type_id = me.id
LEFT JOIN users users ON users.company_id = company.id
LEFT JOIN orders orders ON orders.user_id = users.id
LEFT JOIN companies company_2 ON company_2.id = orders.company_id
WHERE &#40;
&#40;
company_2.id = ? 
AND orders.status != ? 
AND TYPE = ?
&#41;
&#41;
ORDER BY company.company_type_id

together with this error stacktrace:

DBI Exception: DBD::mysql::st execute failed: Unknown column &#39;type&#39; in &#39;where clause&#39; [for Statement &#34;SELECT 
company.name, orders.company_id, me.company_total, company.id, company.name, company.website, company.phone, 
company.company_type_id FROM &#40;SELECT company.name, orders.company_id, SUM&#40; orders.total &#41; AS company_total FROM 
company_types me LEFT JOIN companies company ON company.company_type_id = me.id LEFT JOIN users users ON 
users.company_id = company.id LEFT JOIN orders orders ON orders.user_id = users.id LEFT JOIN companies company_2 
ON company_2.id = orders.company_id WHERE &#40; &#40; company_2.id = ? AND orders.status != ? AND type = ? &#41; &#41; GROUP BY 
orders.company_id&#41; me LEFT JOIN companies company ON company.company_type_id = me.id LEFT JOIN users users ON 
users.company_id = company.id LEFT JOIN orders orders ON orders.user_id = users.id LEFT JOIN companies company_2 
ON company_2.id = orders.company_id WHERE &#40; &#40; company_2.id = ? AND orders.status != ? AND type = ? &#41; &#41; ORDER BY 
company.company_type_id&#34; with ParamValues: 0=&#39;2&#39;, 1=&#39;paid&#39;, 2=&#39;orderer&#39;, 3=&#39;2&#39;, 4=&#39;paid&#39;, 5=&#39;orderer&#39;] at 
/usr/local/lib/perl5/site_perl/5.14.2/DBIx/Class/Schema.pm line 1078
        DBIx::Class::Schema::throw_exception&#40;&#39;Food::Schema=HASH&#40;0x9e2e5c0&#41;&#39;, &#39;DBI Exception: DBD::mysql::st 
execute failed: Unknown column ...&#39;&#41; called at /usr/local/lib/perl5/site_perl/5.14.2/DBIx/Class/Storage.pm line 
111
        DBIx::Class::Storage::throw_exception&#40;&#39;DBIx::Class::Storage::DBI::mysql=HASH&#40;0x9e33a40&#41;&#39;, &#39;DBI Exception: 
DBD::mysql::st execute failed: Unknown column ...&#39;&#41; called at 
/usr/local/lib/perl5/site_perl/5.14.2/DBIx/Class/Storage/DBI.pm line 1288
        DBIx::Class::Storage::DBI::__ANON__&#40;&#39;DBD::mysql::st execute failed: Unknown column \&#39;type\&#39; in \&#39;w...&#39;, 
&#39;DBI::st=HASH&#40;0xaed7368&#41;&#39;, undef&#41; called at /usr/local/lib/perl5/site_perl/5.14.2/DBIx/Class/Storage/DBI.pm line 
1586
        DBIx::Class::Storage::DBI::_dbh_execute&#40;&#39;DBIx::Class::Storage::DBI::mysql=HASH&#40;0x9e33a40&#41;&#39;, 
&#39;DBI::db=HASH&#40;0x9f6d338&#41;&#39;, &#39;SELECT company.name, orders.company_id, me.company_total, com...&#39;, 
&#39;ARRAY&#40;0xaede360&#41;&#39;, &#39;ARRAY&#40;0xaf074c8&#41;&#39;&#41; called at /usr/local/lib/perl5/site_perl/5.14.2/DBIx/Class/Storage/DBI.pm 
line 779
        DBIx::Class::Storage::DBI::dbh_do&#40;&#39;DBIx::Class::Storage::DBI::mysql=HASH&#40;0x9e33a40&#41;&#39;, &#39;_dbh_execute&#39;, 
&#39;SELECT company.name, orders.company_id, me.company_total, com...&#39;, &#39;ARRAY&#40;0xaede360&#41;&#39;, &#39;ARRAY&#40;0xaf074c8&#41;&#39;&#41; 
called at /usr/local/lib/perl5/site_perl/5.14.2/DBIx/Class/Storage/DBI.pm line 1551
        DBIx::Class::Storage::DBI::_execute&#40;&#39;DBIx::Class::Storage::DBI::mysql=HASH&#40;0x9e33a40&#41;&#39;, &#39;select&#39;, 
&#39;ARRAY&#40;0xaede270&#41;&#39;, &#39;ARRAY&#40;0xaeec028&#41;&#39;, &#39;HASH&#40;0xaf0d628&#41;&#39;, &#39;HASH&#40;0xa03e2c0&#41;&#39;&#41; called at 
/usr/local/lib/perl5/site_perl/5.14.2/DBIx/Class/Storage/DBI.pm line 2077
        DBIx::Class::Storage::DBI::_select&#40;&#39;DBIx::Class::Storage::DBI::mysql=HASH&#40;0x9e33a40&#41;&#39;, 
&#39;ARRAY&#40;0xaf0d3f8&#41;&#39;, &#39;ARRAY&#40;0xaf07928&#41;&#39;, &#39;HASH&#40;0xaf0d628&#41;&#39;, &#39;HASH&#40;0xaf07388&#41;&#39;&#41; called at 
/usr/local/lib/perl5/site_perl/5.14.2/DBIx/Class/Storage/DBI/Cursor.pm line 89
        DBIx::Class::Storage::DBI::Cursor::_dbh_next&#40;&#39;DBIx::Class::Storage::DBI::mysql=HASH&#40;0x9e33a40&#41;&#39;, 
&#39;DBI::db=HASH&#40;0x9f6d338&#41;&#39;, &#39;DBIx::Class::Storage::DBI::Cursor=HASH&#40;0xaef9a48&#41;&#39;&#41; called at 
/usr/local/lib/perl5/site_perl/5.14.2/DBIx/Class/Storage/DBI.pm line 788
        DBIx::Class::Storage::DBI::__ANON__&#40;&#41; called at /usr/local/lib/perl5/site_perl/5.14.2/Try/Tiny.pm line 71
        eval {...} called at /usr/local/lib/perl5/site_perl/5.14.2/Try/Tiny.pm line 67
        Try::Tiny::try&#40;&#39;CODE&#40;0xaef97d8&#41;&#39;, &#39;Try::Tiny::Catch=REF&#40;0xaf06e28&#41;&#39;&#41; called at 
/usr/local/lib/perl5/site_perl/5.14.2/DBIx/Class/Storage/DBI.pm line 799
        DBIx::Class::Storage::DBI::dbh_do&#40;undef, undef, &#39;DBIx::Class::Storage::DBI::Cursor=HASH&#40;0xaef9a48&#41;&#39;&#41; 
called at /usr/local/lib/perl5/site_perl/5.14.2/DBIx/Class/Storage/DBI/Cursor.pm line 108
        DBIx::Class::Storage::DBI::Cursor::next&#40;&#39;DBIx::Class::Storage::DBI::Cursor=HASH&#40;0xaef9a48&#41;&#39;&#41; called at 
/usr/local/lib/perl5/site_perl/5.14.2/DBIx/Class/ResultSet.pm line 1198
        DBIx::Class::ResultSet::next&#40;&#39;DBIx::Class::ResultSet=HASH&#40;0xaf07b18&#41;&#39;&#41; called at 
script/../lib/Food/Provider.pm line 129
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Order.pm</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">package Food::Schema::Result::Order;

# Created by DBIx::Class::Schema::Loader
# DO NOT MODIFY THE FIRST PART OF THIS FILE

use strict;
use warnings;

use base &#39;DBIx::Class::Core&#39;;


=head1 NAME

Food::Schema::Result::Order

=cut

__PACKAGE__-&gt;table&#40;&#34;orders&#34;&#41;;

=head1 ACCESSORS

=head2 id

  data_type: &#39;integer&#39;
  is_auto_increment: 1
  is_nullable: 0

=head2 company_id

  data_type: &#39;integer&#39;
  is_nullable: 1

=head2 user_id

  data_type: &#39;integer&#39;
  is_nullable: 1

=head2 total

  data_type: &#39;float&#39;
  is_nullable: 1

=head2 money_id

  data_type: &#39;integer&#39;
  is_nullable: 0

=head2 created_at

  data_type: &#39;datetime&#39;
  datetime_undef_if_invalid: 1
  is_nullable: 1

=head2 updated_at

  data_type: &#39;bigint&#39;
  is_nullable: 1

=head2 status

  data_type: &#39;varchar&#39;
  is_nullable: 1
  size: 10

=cut

__PACKAGE__-&gt;add_columns&#40;
  &#34;id&#34;,
  { data_type =&gt; &#34;integer&#34;, is_auto_increment =&gt; 1, is_nullable =&gt; 0 },
  &#34;company_id&#34;,
  { data_type =&gt; &#34;integer&#34;, is_nullable =&gt; 1 },
  &#34;user_id&#34;,
  { data_type =&gt; &#34;integer&#34;, is_nullable =&gt; 1 },
  &#34;total&#34;,
  { data_type =&gt; &#34;float&#34;, is_nullable =&gt; 1 },
  &#34;money_id&#34;,
  { data_type =&gt; &#34;integer&#34;, is_nullable =&gt; 0 },
  &#34;created_at&#34;,
  {
    data_type =&gt; &#34;datetime&#34;,
    datetime_undef_if_invalid =&gt; 1,
    is_nullable =&gt; 1,
  },
  &#34;updated_at&#34;,
  { data_type =&gt; &#34;bigint&#34;, is_nullable =&gt; 1 },
  &#34;status&#34;,
  { data_type =&gt; &#34;varchar&#34;, is_nullable =&gt; 1, size =&gt; 10 },
&#41;;
__PACKAGE__-&gt;set_primary_key&#40;&#34;id&#34;&#41;;


# Created by DBIx::Class::Schema::Loader v0.07010 @ 2011-11-17 16:54:50
# DO NOT MODIFY THIS OR ANYTHING ABOVE! md5sum:J295znQJlQmJGF1gSxb2Mg
use DateTime;
__PACKAGE__-&gt;remove_column&#40;&#39;created_at&#39;&#41;;
__PACKAGE__-&gt;add_columns&#40;
  &#34;created_at&#34;,
  {
    data_type =&gt; &#34;datetime&#34;,
    datetime_undef_if_invalid =&gt; 1,
    is_nullable =&gt; 0,
    accessor =&gt; &#39;_created_at&#39;,
  },
&#41;;

__PACKAGE__-&gt;belongs_to&#40;company =&gt; &#39;Food::Schema::Result::Company&#39;, &#39;company_id&#39;&#41;;
__PACKAGE__-&gt;belongs_to&#40;user =&gt; &#39;Food::Schema::Result::User&#39;, &#39;user_id&#39;&#41;;
__PACKAGE__-&gt;has_many&#40;order_lines =&gt; &#39;Food::Schema::Result::OrderLine&#39;, &#39;order_id&#39;&#41;;
__PACKAGE__-&gt;many_to_many&#40;foods =&gt; &#39;order_lines&#39;, &#39;food&#39;&#41;;
__PACKAGE__-&gt;many_to_many&#40;menus =&gt; &#39;order_lines&#39;, &#39;menu&#39;&#41;;

sub created_at{
 my &#40;$self, $value&#41; = @_;

 $self-&gt;_created_at&#40; $self-&gt;_created_at&#40;&#41; || DateTime::Format::MySQL-&gt;format_datetime&#40; DateTime-&gt;now&#40;&#41; &#41; &#41;; 

 return $self-&gt;_created_at&#40;&#41;;
};

sub new{
 my &#40;$self, $attrs&#41; = @_;

 $self-&gt;created_at&#40;&#41;;

 my $new = $self-&gt;next::method&#40;$attrs&#41;;
 return $new;
}

1;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Company.pm</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">package Food::Schema::Result::Company;

# Created by DBIx::Class::Schema::Loader
# DO NOT MODIFY THE FIRST PART OF THIS FILE

use strict;
use warnings;

use base &#39;DBIx::Class::Core&#39;;


=head1 NAME

Food::Schema::Result::Company

=cut

__PACKAGE__-&gt;table&#40;&#34;companies&#34;&#41;;

=head1 ACCESSORS

=head2 id

  data_type: &#39;integer&#39;
  is_auto_increment: 1
  is_nullable: 0

=head2 name

  data_type: &#39;varchar&#39;
  is_nullable: 1
  size: 50

=head2 website

  data_type: &#39;varchar&#39;
  is_nullable: 1
  size: 50

=head2 phone

  data_type: &#39;varchar&#39;
  is_nullable: 1
  size: 20

=head2 company_type_id

  data_type: &#39;integer&#39;
  is_nullable: 0

=cut

__PACKAGE__-&gt;add_columns&#40;
  &#34;id&#34;,
  { data_type =&gt; &#34;integer&#34;, is_auto_increment =&gt; 1, is_nullable =&gt; 0 },
  &#34;name&#34;,
  { data_type =&gt; &#34;varchar&#34;, is_nullable =&gt; 1, size =&gt; 50 },
  &#34;website&#34;,
  { data_type =&gt; &#34;varchar&#34;, is_nullable =&gt; 1, size =&gt; 50 },
  &#34;phone&#34;,
  { data_type =&gt; &#34;varchar&#34;, is_nullable =&gt; 1, size =&gt; 20 },
  &#34;company_type_id&#34;,
  { data_type =&gt; &#34;integer&#34;, is_nullable =&gt; 0 },
&#41;;
__PACKAGE__-&gt;set_primary_key&#40;&#34;id&#34;&#41;;
__PACKAGE__-&gt;add_unique_constraint&#40;&#34;website&#34;, [&#34;website&#34;]&#41;;
__PACKAGE__-&gt;add_unique_constraint&#40;&#34;name&#34;, [&#34;name&#34;]&#41;;


# Created by DBIx::Class::Schema::Loader v0.07010 @ 2011-11-10 09:13:33
# DO NOT MODIFY THIS OR ANYTHING ABOVE! md5sum:Mw3wLkcjppjZmK+ZagG6uA

__PACKAGE__-&gt;belongs_to&#40;company_type =&gt; &#39;Food::Schema::Result::CompanyType&#39;, &#39;company_type_id&#39;&#41;;

__PACKAGE__-&gt;has_many&#40;users =&gt; &#39;Food::Schema::Result::User&#39;, &#39;company_id&#39;&#41;; 
__PACKAGE__-&gt;has_many&#40;orders =&gt; &#39;Food::Schema::Result::Order&#39;, &#39;company_id&#39;&#41;;
__PACKAGE__-&gt;has_many&#40;menus =&gt; &#39;Food::Schema::Result::Menus&#39;, &#39;company_id&#39;&#41;;
__PACKAGE__-&gt;has_many&#40;foods =&gt; &#39;Food::Schema::Result::Food&#39;, &#39;company_id&#39;&#41;;



# You can replace this text with custom code or comments, and it will be preserved on regeneration
1;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> User.pm</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">package Food::Schema::Result::User;

# Created by DBIx::Class::Schema::Loader
# DO NOT MODIFY THE FIRST PART OF THIS FILE

use strict;
use warnings;
#use Try::Tiny;
use base &#39;DBIx::Class::Core&#39;;
use Food::Util::Exception;


=head1 NAME

Food::Schema::Result::User

=cut

__PACKAGE__-&gt;table&#40;&#34;users&#34;&#41;;

=head1 ACCESSORS

=head2 id

  data_type: &#39;integer&#39;
  is_auto_increment: 1
  is_nullable: 0

=head2 username

  data_type: &#39;varchar&#39;
  is_nullable: 0
  size: 20

=head2 password

  data_type: &#39;char&#39;
  is_nullable: 0
  size: 32

=head2 company_id

  data_type: &#39;integer&#39;
  is_nullable: 1

=head2 user_type_id

  data_type: &#39;integer&#39;
  is_nullable: 1

=head2 first_name

  data_type: &#39;varchar&#39;
  is_nullable: 1
  size: 20

=head2 last_name

  data_type: &#39;varchar&#39;
  is_nullable: 1
  size: 20

=head2 email

  data_type: &#39;varchar&#39;
  is_nullable: 0
  size: 50

=head2 phone_number

  data_type: &#39;varchar&#39;
  is_nullable: 1
  size: 20

=head2 amount

  data_type: &#39;float&#39;
  default_value: 0
  is_nullable: 0

=cut

__PACKAGE__-&gt;add_columns&#40;
  &#34;id&#34;,
  { data_type =&gt; &#34;integer&#34;, is_auto_increment =&gt; 1, is_nullable =&gt; 0 },
  &#34;username&#34;,
  { data_type =&gt; &#34;varchar&#34;, is_nullable =&gt; 0, size =&gt; 20 },
  &#34;password&#34;,
  { data_type =&gt; &#34;char&#34;, is_nullable =&gt; 0, size =&gt; 32 },
  &#34;company_id&#34;,
  { data_type =&gt; &#34;integer&#34;, is_nullable =&gt; 1 },
  &#34;user_type_id&#34;,
  { data_type =&gt; &#34;integer&#34;, is_nullable =&gt; 1 },
  &#34;first_name&#34;,
  { data_type =&gt; &#34;varchar&#34;, is_nullable =&gt; 1, size =&gt; 20 },
  &#34;last_name&#34;,
  { data_type =&gt; &#34;varchar&#34;, is_nullable =&gt; 1, size =&gt; 20 },
  &#34;email&#34;,
  { data_type =&gt; &#34;varchar&#34;, is_nullable =&gt; 0, size =&gt; 50 },
  &#34;phone_number&#34;,
  { data_type =&gt; &#34;varchar&#34;, is_nullable =&gt; 1, size =&gt; 20 },
  &#34;amount&#34;,
  { data_type =&gt; &#34;float&#34;, default_value =&gt; 0, is_nullable =&gt; 0 },
&#41;;
__PACKAGE__-&gt;set_primary_key&#40;&#34;id&#34;&#41;;
__PACKAGE__-&gt;add_unique_constraint&#40;&#34;email&#34;, [&#34;email&#34;]&#41;;
__PACKAGE__-&gt;add_unique_constraint&#40;&#34;username&#34;, [&#34;username&#34;]&#41;;


# Created by DBIx::Class::Schema::Loader v0.07010 @ 2011-11-17 17:39:47
# DO NOT MODIFY THIS OR ANYTHING ABOVE! md5sum:kbT7RsQ7vTus0GN4y95H/A

use DateTime;
use DateTime::Format::MySQL;
__PACKAGE__-&gt;belongs_to&#40;user_type =&gt; &#39;Food::Schema::Result::UserType&#39;, &#39;user_type_id&#39;&#41;;
__PACKAGE__-&gt;belongs_to&#40;company =&gt; &#39;Food::Schema::Result::Company&#39;, &#39;company_id&#39;&#41;;

__PACKAGE__-&gt;has_many&#40;my_operations =&gt; &#39;Food::Schema::Result::Money&#39;, &#39;operated_for_id&#39;&#41;;
__PACKAGE__-&gt;has_many&#40;cashier_operations =&gt; &#39;Food::Schema::Result::Money&#39;, &#39;operated_by_id&#39;&#41;;
__PACKAGE__-&gt;many_to_many&#40;cashier_for =&gt; &#39;cashier_operations&#39;, &#39;owner&#39;&#41;;

__PACKAGE__-&gt;has_many&#40;orders =&gt; &#39;Food::Schema::Result::Order&#39;, &#39;user_id&#39;&#41;;
__PACKAGE__-&gt;many_to_many&#40;order_lines =&gt; &#39;orders&#39;, &#39;order_lines&#39;&#41;;

sub modify_amount{
  my $self = shift;
  my $cashier = shift;
  my $new_amount = shift;
  my $options = shift || {};

  $self-&gt;throw_exception&#40;Food::Util::Exception-&gt;new&#40;&#39;Must get a number as amount&#39;&#41;, undef&#41; if &#40; $new_amount !~ /^[+-]?\d*\.?\d*$/gmix &#41;;
   my $money = { 
	     description =&gt; &#39;no description&#39;,
	     amount      =&gt; $new_amount,
	     operated_by_id     =&gt; $cashier-&gt;id&#40;&#41;,
#	     created_at  =&gt; DateTime::Format::MySQL-&gt;format_datetime&#40; DateTime-&gt;now&#40;&#41; &#41;,
#	     owner       =&gt; $self,
	     %{$options},
	    };
	    1;
 
 $self-&gt;result_source-&gt;schema-&gt;txn_do&#40;sub {
    $self-&gt;create_related&#40;&#39;my_operations&#39;, $money &#41;;
    $self-&gt;amount&#40;$self-&gt;amount&#40;&#41; + $new_amount&#41;;
    $self-&gt;throw_exception&#40;Food::Util::Exception-&gt;new&#40; &#39;Not enough money for operation&#39; &#41;&#41; if &#40; $self-&gt;amount&#40;&#41; &lt; 0 &#41;;
    $self-&gt;update&#40;&#41;;
 }&#41;;
 
 
};

1;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CompanyType.pm</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">package Food::Schema::Result::CompanyType;

# Created by DBIx::Class::Schema::Loader
# DO NOT MODIFY THE FIRST PART OF THIS FILE

use strict;
use warnings;

use base &#39;DBIx::Class::Core&#39;;


=head1 NAME

Food::Schema::Result::CompanyType

=cut

__PACKAGE__-&gt;table&#40;&#34;company_types&#34;&#41;;

=head1 ACCESSORS

=head2 id

  data_type: &#39;integer&#39;
  is_auto_increment: 1
  is_nullable: 0

=head2 type

  data_type: &#39;varchar&#39;
  is_nullable: 0
  size: 10

=cut

__PACKAGE__-&gt;add_columns&#40;
  &#34;id&#34;,
  { data_type =&gt; &#34;integer&#34;, is_auto_increment =&gt; 1, is_nullable =&gt; 0 },
  &#34;type&#34;,
  { data_type =&gt; &#34;varchar&#34;, is_nullable =&gt; 0, size =&gt; 10 },
&#41;;
__PACKAGE__-&gt;set_primary_key&#40;&#34;id&#34;&#41;;
__PACKAGE__-&gt;add_unique_constraint&#40;&#34;type&#34;, [&#34;type&#34;]&#41;;


# Created by DBIx::Class::Schema::Loader v0.07010 @ 2011-11-10 09:13:33
# DO NOT MODIFY THIS OR ANYTHING ABOVE! md5sum:Q9dsWbi5BRfviP6FvWqREQ
__PACKAGE__-&gt;has_many&#40;company =&gt; &#39;Food::Schema::Result::Company&#39;, &#39;company_type_id&#39;&#41;;


# You can replace this text with custom code or comments, and it will be preserved on regeneration
1;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;19&nbsp;18:38:34&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Nov 19 15:37:04 2011, TCONST wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Output of uname -a:
&gt; 
&gt; Linux 185.72.34.89.in-addr.arpa 2.6.18-194.26.1.el5PAE #1 SMP Tue Nov
&gt; 9
&gt; 13:34:42 EST 2010 i686 i686 i386 GNU/Linux
&gt; 
&gt; perl -v:
&gt; This is perl 5, version 14, subversion 2 &#40;v5.14.2&#41; built for i686-
&gt; linux-
&gt; thread-multi
&gt; 
&gt; I have the dbic &#34;query&#34;:
&gt; 
&gt;  my $companies_rs = $self-&gt;app-&gt;model-
<div class="message-stanza open">&gt; &gt;resultset&#40;&#39;Food::Schema::Result::CompanyType&#39;&#41;
</div>&gt;         -&gt;search_rs&#40;
&gt;          {
&gt; 
&gt;           &#39;type&#39; =&gt; &#39;orderer&#39;,
&gt;           &#39;orders.status&#39;     =&gt; { &#39;!=&#39; =&gt; &#39;paid&#39; },
&gt;           &#39;company_2.id&#39; =&gt; $self-&gt;app-&gt;sessions-&gt;{user}-&gt;company&#40;&#41;-
<div class="message-stanza open">&gt; &gt;id&#40;&#41;,
</div>&gt;          },
&gt;          {
&gt;            join      =&gt; { &#39;company&#39; =&gt; { &#39;users&#39; =&gt; { &#39;orders&#39; =&gt;
&gt; &#39;company&#39; } } },
&gt;            prefetch  =&gt; [ qw&#40; company &#41;],
&gt;            select    =&gt; [ { sum =&gt; &#39;orders.total&#39;, -as =&gt;
&gt; &#39;company_total&#39; }, ], #SQL As
&gt;            columns   =&gt; [ qw&#40;  company.name orders.company_id&#41; ],
&gt;            as        =&gt; [qw/company_total/], #used for retrieving the
&gt; above sql as
&gt;            #group_by  =&gt; &#39;orders.company_id&#39; ,
&gt;          } &#41;;
&gt; 
&gt; which works ok, it outputs the MySQL query:
&gt; 
&gt; SELECT company.name, orders.company_id, SUM&#40; orders.total &#41; AS
&gt; company_total, company.id, company.name,
&gt; company.website, company.phone, company.company_type_id
&gt; FROM company_types me
&gt; LEFT JOIN companies company ON company.company_type_id = me.id
&gt; LEFT JOIN users users ON users.company_id = company.id
&gt; LEFT JOIN orders orders ON orders.user_id = users.id
&gt; LEFT JOIN companies company_2 ON company_2.id = orders.company_id
&gt; WHERE &#40;
&gt; 
&gt; &#40;
&gt; company_2.id = ?
&gt; AND orders.status != ?
&gt; AND TYPE = ?
&gt; &#41;
&gt; &#41;
&gt; ORDER BY company.company_type_id
&gt; 
&gt; However, in order to get the sum for each company for each order, I
&gt; have to add a GROUP BY company.id or GROUP BY
&gt; orders.company_id. If I uncomment the group_by clause from the above
&gt; dbic query, it generates this SQL
&gt; monstruosity:
&gt; 
&gt; SELECT company.name, orders.company_id, me.company_total, company.id,
&gt; company.name, company.website,
&gt; company.phone, company.company_type_id
&gt; FROM &#40;
&gt; 
&gt; 
&gt; SELECT company.name, orders.company_id, SUM&#40; orders.total &#41; AS
&gt; company_total
&gt; FROM company_types me
&gt; LEFT JOIN companies company ON company.company_type_id = me.id
&gt; LEFT JOIN users users ON users.company_id = company.id
&gt; LEFT JOIN orders orders ON orders.user_id = users.id
&gt; LEFT JOIN companies company_2 ON company_2.id = orders.company_id
&gt; WHERE &#40;
&gt; &#40;
&gt; company_2.id = ?
&gt; AND orders.status != ?
&gt; AND TYPE = ?
&gt; &#41;
&gt; &#41;
&gt; GROUP BY orders.company_id
&gt; &#41;me
&gt; LEFT JOIN companies company ON company.company_type_id = me.id
&gt; LEFT JOIN users users ON users.company_id = company.id
&gt; LEFT JOIN orders orders ON orders.user_id = users.id
&gt; LEFT JOIN companies company_2 ON company_2.id = orders.company_id
&gt; WHERE &#40;
&gt; &#40;
&gt; company_2.id = ?
&gt; AND orders.status != ?
&gt; AND TYPE = ?
&gt; &#41;se
&gt; &#41;
&gt; ORDER BY company.company_type_id
&gt; 
&gt; together with this error stacktrace:
&gt; 
&gt; DBI Exception: DBD::mysql::st execute failed: Unknown column &#39;type&#39; in
&gt; &#39;where clause&#39;...
</div>
You did not supply the most important part - your DBIC version. In any
case I think I see the problem &#40;I see *a* problem, whether this is the
only problem you have or not is a matter of testing&#41;. In fact DBIC is
behaving entirely correctly here. Several points:

Your CompanyType has_many &#39;company&#39;. This makes no semantical sense -
you has_many &#39;companies&#39; &#40;note the S for *many*&#41;. I shall refer to this
relationship as companieS from now on, as it will be confusing otherwise.

You asked DBIC to bring you back comapnies, but at the same time you
asked it to aggregate the main resultset so that your SUM will work
properly. Since the aggregate will completely collapse/flatten the
prefetch you requested &#40;* see next paragraph&#41;, DBIC has to find a
different way. It constructs a subquery representing just your main
resultset, constricted/aggregated the way you asked. Then it takes this
pre-canned resultset, and executes a prefetch on it - tadaaa you get
exactly what you asked for.

Note that what you are asking for by the way is generally illegal - a
selection needs to match the group clause. Mysql tries hard to guess
what you meant, which makes it appear like things are working. If
however you think a bit about what does it mean to group by the
belongs_to of a has_many, and what happens to the intermediate
multi-results in the middle - you will start getting the picture that
mysql is being cock by even letting you do this. To get out of such
trouble in the future &#40;i.e. to get better error messaging&#41; it is
strongly recommended to use mysql strict mode as described here:
<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~abraxxa/DBIx-Class-0.08195/lib/DBIx/Class/Storage/DBI/mysql.pm#set_strict_mode">http://search.cpan.org/~abraxxa/DBIx-Class-0.08195/lib/DBIx/Class/Storage/DBI/mysql.pm#set_strict_mode</a></span>

So with this out of the way - why didn&#39;t this work? The problem is that
you did not qualify your &#39;type&#39; column in the condition. DBIC tried to
guess where did it come from - but it failed. So it did the only thing
it could - pushed it through unqualified, and without its native source
joined in either &#40;since it could not reliably determine which source
that was&#41;. Qualify the TYPE in your condition, and everything shoul
start working quite magically.

Let us know how did this work for you.

Cheers
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;19&nbsp;18:38:37&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;20&nbsp;14:07:05&nbsp;2011</span>
    <span class="description">TCONST [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi again,

First of all let me express a wow for your quick and detailed response.

You are right with the semantic nonsense of the relation from CompanyType to Company - thx for pointing 
that out. 
I modified that in the CompanyType schema file, and I got an error saying that &#34;No such relationship 
company on CompanyType&#34; when accessing $companies_rs-&gt;next&#40;&#41;. I checked the code, relationships with/from 
other schemas and I coouldn&#39;t find any references to CompanyType-&gt;company. 

However, if I understood correctly from your reply, that was just a semantic issue, so I let both 
relationships in the Schema:

__PACKAGE__-&gt;has_many&#40;companies =&gt; &#39;Food::Schema::Result::Company&#39;, &#39;company_type_id&#39;&#41;;
__PACKAGE__-&gt;has_many&#40;company =&gt; &#39;Food::Schema::Result::Company&#39;, &#39;company_type_id&#39;&#41;;

And modified the dbic query to:

 my $companies_rs = $self-&gt;app-&gt;model-&gt;resultset&#40;&#39;Food::Schema::Result::CompanyType&#39;&#41;
        -&gt;search_rs&#40;
         {

          &#39;type&#39; =&gt; &#39;orderer&#39;,
          &#39;orders.status&#39;     =&gt; { &#39;!=&#39; =&gt; &#39;paid&#39; },
          &#39;company.id&#39; =&gt; $self-&gt;app-&gt;sessions-&gt;{user}-&gt;company&#40;&#41;-&gt;id&#40;&#41;,
         },
         {
           join      =&gt; { &#39;companies&#39; =&gt; { &#39;users&#39; =&gt; { &#39;orders&#39; =&gt; &#39;company&#39; } } },
           prefetch  =&gt; [ qw&#40; company &#41;],
           select    =&gt; [ { sum =&gt; &#39;orders.total&#39;, -as =&gt; &#39;company_total&#39; }, ], #SQL As
           columns   =&gt; [ qw&#40;  companies.name orders.company_id&#41; ],
           as        =&gt; [qw/company_total/], #used for retrieving the above sql as
           #group_by  =&gt; &#39;orders.company_id&#39; ,
         } &#41;;

This worked as yesterday. 
Again, when I uncommented the group_by clause, yesterday&#39;s behavior reproduced.
Unfortunately, the same errors appeared when I qualified the type column:
&#34;Unknown column &#39;me.type&#39; in &#39;where clause&#39;&#34; and
&#34;Unknown column &#39;companies.type&#39; in &#39;where clause&#39;&#34;.

I remember that yesterday I also tried to qualify the type column, getting the same errors &#40;sorry for not 
mentioning that then&#41;.

The version of the dbic query that I sent you yesterday &#40;with the unqualified type column&#41; was so because 
I expected that an unqualified column to be default qualified to the main ResultSet table alias 
&#40;&#39;Food::Schema::Result::CompanyType&#39; in my case&#41; - this would be a nice to have feature.

Regarding the expected &#40;by me at least&#41; behavior for the group_by attribute in the dbic query - I 
expected that clause to simply be transformed in an &#34;GROUP BY orders.company_id&#34; string appended to the 
previously generated SQL query.

The version of DBIC I use is the latest one &#40;I installed DBIC a couple of weeks before from cpan&#41;.

Regarding the logic of the MySQL query, I want to get the SUM of the AMOUNT of each ORDER for each 
COMPANY that has the TYPE &#39;orderer&#39;. So, I took each company of type orderer, each order of that, group 
by company and computed the sum of the amount column.

However, yesterday I managed to find a workaround for achieving what I needed by working with 2 
resultsets:
- one for each company with type &#39;orderer&#39;:

 my $companies_rs =  $self-&gt;app-&gt;model-&gt;resultset&#40;&#39;Food::Schema::Result::Company&#39;&#41;
         -&gt;search_rs&#40;
                  {
                    &#39;company_type.type&#39; =&gt; &#39;orderer&#39;,
                  },
                  {
                  join      =&gt; [&#39;company_type&#39;],
                  }
         &#41;;
- and for each of the users of the above companies, get the SUM of the amount from orders:
    my $comp_orders = $self-&gt;app-&gt;model-&gt;resultset&#40;&#39;Food::Schema::Result::User&#39;&#41;
        -&gt;search_rs&#40;
        {
          &#39;me.company_id&#39;   =&gt; $company-&gt;{id},
          &#39;orders.status&#39;=&gt; { &#39;!=&#39; =&gt; &#39;paid&#39; },
          &#39;company.id&#39;   =&gt; $self-&gt;app-&gt;sessions-&gt;{user}-&gt;company&#40;&#41;-&gt;id&#40;&#41;,

        },
        {
           join      =&gt; { &#39;orders&#39; =&gt; &#39;company&#39; },
           prefetch  =&gt; [ qw&#40; orders company &#41; ],
           select    =&gt; [ { sum =&gt; &#39;orders.total&#39;, -as =&gt; &#39;company_total&#39; }, ], #SQL As
           columns   =&gt; [ qw&#40;  company.name orders.company_id&#41; ],
           as        =&gt; [qw/company_total/],
        }
        &#41;;

The reason of wanting to solve that in a single query is because of the wonderful feature that DBIC has 
by working with result sets instead of only individual rows - and I still think it is &#40;or should be&#41; 
possible to do that.

Regards,
Tudor

On Sat Nov 19 18:38:34 2011, RIBASUSHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sat Nov 19 15:37:04 2011, TCONST wrote:
<div class="message-stanza open">&gt; &gt; Output of uname -a:
&gt; &gt;
&gt; &gt; Linux 185.72.34.89.in-addr.arpa 2.6.18-194.26.1.el5PAE #1 SMP Tue
</div>&gt; Nov
<div class="message-stanza open">&gt; &gt; 9
&gt; &gt; 13:34:42 EST 2010 i686 i686 i386 GNU/Linux
&gt; &gt;
&gt; &gt; perl -v:
&gt; &gt; This is perl 5, version 14, subversion 2 &#40;v5.14.2&#41; built for i686-
&gt; &gt; linux-
&gt; &gt; thread-multi
&gt; &gt;
&gt; &gt; I have the dbic &#34;query&#34;:
&gt; &gt;
&gt; &gt;  my $companies_rs = $self-&gt;app-&gt;model-
<div class="message-stanza open">&gt; &gt; &gt;resultset&#40;&#39;Food::Schema::Result::CompanyType&#39;&#41;
</div>&gt; &gt;         -&gt;search_rs&#40;
&gt; &gt;          {
&gt; &gt;
&gt; &gt;           &#39;type&#39; =&gt; &#39;orderer&#39;,
&gt; &gt;           &#39;orders.status&#39;     =&gt; { &#39;!=&#39; =&gt; &#39;paid&#39; },
&gt; &gt;           &#39;company_2.id&#39; =&gt; $self-&gt;app-&gt;sessions-&gt;{user}-&gt;company&#40;&#41;-
<div class="message-stanza open">&gt; &gt; &gt;id&#40;&#41;,
</div>&gt; &gt;          },
&gt; &gt;          {
&gt; &gt;            join      =&gt; { &#39;company&#39; =&gt; { &#39;users&#39; =&gt; { &#39;orders&#39; =&gt;
&gt; &gt; &#39;company&#39; } } },
&gt; &gt;            prefetch  =&gt; [ qw&#40; company &#41;],
&gt; &gt;            select    =&gt; [ { sum =&gt; &#39;orders.total&#39;, -as =&gt;
&gt; &gt; &#39;company_total&#39; }, ], #SQL As
&gt; &gt;            columns   =&gt; [ qw&#40;  company.name orders.company_id&#41; ],
&gt; &gt;            as        =&gt; [qw/company_total/], #used for retrieving
</div>&gt; the
<div class="message-stanza open">&gt; &gt; above sql as
&gt; &gt;            #group_by  =&gt; &#39;orders.company_id&#39; ,
&gt; &gt;          } &#41;;
&gt; &gt;
&gt; &gt; which works ok, it outputs the MySQL query:
&gt; &gt;
&gt; &gt; SELECT company.name, orders.company_id, SUM&#40; orders.total &#41; AS
&gt; &gt; company_total, company.id, company.name,
&gt; &gt; company.website, company.phone, company.company_type_id
&gt; &gt; FROM company_types me
&gt; &gt; LEFT JOIN companies company ON company.company_type_id = me.id
&gt; &gt; LEFT JOIN users users ON users.company_id = company.id
&gt; &gt; LEFT JOIN orders orders ON orders.user_id = users.id
&gt; &gt; LEFT JOIN companies company_2 ON company_2.id = orders.company_id
&gt; &gt; WHERE &#40;
&gt; &gt;
&gt; &gt; &#40;
&gt; &gt; company_2.id = ?
&gt; &gt; AND orders.status != ?
&gt; &gt; AND TYPE = ?
&gt; &gt; &#41;
&gt; &gt; &#41;
&gt; &gt; ORDER BY company.company_type_id
&gt; &gt;
&gt; &gt; However, in order to get the sum for each company for each order, I
&gt; &gt; have to add a GROUP BY company.id or GROUP BY
&gt; &gt; orders.company_id. If I uncomment the group_by clause from the above
&gt; &gt; dbic query, it generates this SQL
&gt; &gt; monstruosity:
&gt; &gt;
&gt; &gt; SELECT company.name, orders.company_id, me.company_total,
</div>&gt; company.id,
<div class="message-stanza open">&gt; &gt; company.name, company.website,
&gt; &gt; company.phone, company.company_type_id
&gt; &gt; FROM &#40;
&gt; &gt;
&gt; &gt;
&gt; &gt; SELECT company.name, orders.company_id, SUM&#40; orders.total &#41; AS
&gt; &gt; company_total
&gt; &gt; FROM company_types me
&gt; &gt; LEFT JOIN companies company ON company.company_type_id = me.id
&gt; &gt; LEFT JOIN users users ON users.company_id = company.id
&gt; &gt; LEFT JOIN orders orders ON orders.user_id = users.id
&gt; &gt; LEFT JOIN companies company_2 ON company_2.id = orders.company_id
&gt; &gt; WHERE &#40;
&gt; &gt; &#40;
&gt; &gt; company_2.id = ?
&gt; &gt; AND orders.status != ?
&gt; &gt; AND TYPE = ?
&gt; &gt; &#41;
&gt; &gt; &#41;
&gt; &gt; GROUP BY orders.company_id
&gt; &gt; &#41;me
&gt; &gt; LEFT JOIN companies company ON company.company_type_id = me.id
&gt; &gt; LEFT JOIN users users ON users.company_id = company.id
&gt; &gt; LEFT JOIN orders orders ON orders.user_id = users.id
&gt; &gt; LEFT JOIN companies company_2 ON company_2.id = orders.company_id
&gt; &gt; WHERE &#40;
&gt; &gt; &#40;
&gt; &gt; company_2.id = ?
&gt; &gt; AND orders.status != ?
&gt; &gt; AND TYPE = ?
&gt; &gt; &#41;se
&gt; &gt; &#41;
&gt; &gt; ORDER BY company.company_type_id
&gt; &gt;
&gt; &gt; together with this error stacktrace:
&gt; &gt;
&gt; &gt; DBI Exception: DBD::mysql::st execute failed: Unknown column &#39;type&#39;
</div>&gt; in
<div class="message-stanza open">&gt; &gt; &#39;where clause&#39;...
</div>&gt; 
&gt; You did not supply the most important part - your DBIC version. In any
&gt; case I think I see the problem &#40;I see *a* problem, whether this is the
&gt; only problem you have or not is a matter of testing&#41;. In fact DBIC is
&gt; behaving entirely correctly here. Several points:
&gt; 
&gt; Your CompanyType has_many &#39;company&#39;. This makes no semantical sense -
&gt; you has_many &#39;companies&#39; &#40;note the S for *many*&#41;. I shall refer to
&gt; this
&gt; relationship as companieS from now on, as it will be confusing
&gt; otherwise.
&gt; 
&gt; You asked DBIC to bring you back comapnies, but at the same time you
&gt; asked it to aggregate the main resultset so that your SUM will work
&gt; properly. Since the aggregate will completely collapse/flatten the
&gt; prefetch you requested &#40;* see next paragraph&#41;, DBIC has to find a
&gt; different way. It constructs a subquery representing just your main
&gt; resultset, constricted/aggregated the way you asked. Then it takes
&gt; this
&gt; pre-canned resultset, and executes a prefetch on it - tadaaa you get
&gt; exactly what you asked for.
&gt; 
&gt; Note that what you are asking for by the way is generally illegal - a
&gt; selection needs to match the group clause. Mysql tries hard to guess
&gt; what you meant, which makes it appear like things are working. If
&gt; however you think a bit about what does it mean to group by the
&gt; belongs_to of a has_many, and what happens to the intermediate
&gt; multi-results in the middle - you will start getting the picture that
&gt; mysql is being cock by even letting you do this. To get out of such
&gt; trouble in the future &#40;i.e. to get better error messaging&#41; it is
&gt; strongly recommended to use mysql strict mode as described here:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~abraxxa/DBIx-Class-">http://search.cpan.org/~abraxxa/DBIx-Class-</a></span>
&gt; 0.08195/lib/DBIx/Class/Storage/DBI/mysql.pm#set_strict_mode
&gt; 
&gt; So with this out of the way - why didn&#39;t this work? The problem is
&gt; that
&gt; you did not qualify your &#39;type&#39; column in the condition. DBIC tried to
&gt; guess where did it come from - but it failed. So it did the only thing
&gt; it could - pushed it through unqualified, and without its native
&gt; source
&gt; joined in either &#40;since it could not reliably determine which source
&gt; that was&#41;. Qualify the TYPE in your condition, and everything shoul
&gt; start working quite magically.
&gt; 
&gt; Let us know how did this work for you.
&gt; 
&gt; Cheers
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;20&nbsp;15:21:35&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Nov 20 14:07:05 2011, TCONST wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi again,
&gt; 
&gt; First of all let me express a wow for your quick and detailed
&gt; response.
&gt; 
&gt; You are right with the semantic nonsense of the relation from
&gt; CompanyType to Company - thx for pointing
&gt; that out.
&gt; I modified that in the CompanyType schema file, and I got an error
&gt; saying that &#34;No such relationship
&gt; company on CompanyType&#34; when accessing $companies_rs-&gt;next&#40;&#41;. I
&gt; checked the code, relationships with/from
&gt; other schemas and I coouldn&#39;t find any references to CompanyType-
<div class="message-stanza open">&gt; &gt;company.
</div>&gt; 
&gt; However, if I understood correctly from your reply, that was just a
&gt; semantic issue, so I let both
&gt; relationships in the Schema:
&gt; 
&gt; __PACKAGE__-&gt;has_many&#40;companies =&gt; &#39;Food::Schema::Result::Company&#39;,
&gt; &#39;company_type_id&#39;&#41;;
&gt; __PACKAGE__-&gt;has_many&#40;company =&gt; &#39;Food::Schema::Result::Company&#39;,
&gt; &#39;company_type_id&#39;&#41;;
&gt; 
</div>
When you say

columns   =&gt; [ qw&#40;  companies.name...

You are also referring to a relationship. When grepping for the
relationship name - search for all occurances.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; And modified the dbic query to:
&gt; 
&gt;  my $companies_rs = $self-&gt;app-&gt;model-
<div class="message-stanza open">&gt; &gt;resultset&#40;&#39;Food::Schema::Result::CompanyType&#39;&#41;
</div>&gt;         -&gt;search_rs&#40;
&gt;          {
&gt; 
&gt;           &#39;type&#39; =&gt; &#39;orderer&#39;,
&gt;           &#39;orders.status&#39;     =&gt; { &#39;!=&#39; =&gt; &#39;paid&#39; },
&gt;           &#39;company.id&#39; =&gt; $self-&gt;app-&gt;sessions-&gt;{user}-&gt;company&#40;&#41;-
<div class="message-stanza open">&gt; &gt;id&#40;&#41;,
</div>&gt;          },
&gt;          {
&gt;            join      =&gt; { &#39;companies&#39; =&gt; { &#39;users&#39; =&gt; { &#39;orders&#39; =&gt;
&gt; &#39;company&#39; } } },
&gt;            prefetch  =&gt; [ qw&#40; company &#41;],
&gt;            select    =&gt; [ { sum =&gt; &#39;orders.total&#39;, -as =&gt;
&gt; &#39;company_total&#39; }, ], #SQL As
&gt;            columns   =&gt; [ qw&#40;  companies.name orders.company_id&#41; ],
&gt;            as        =&gt; [qw/company_total/], #used for retrieving the
&gt; above sql as
&gt;            #group_by  =&gt; &#39;orders.company_id&#39; ,
&gt;          } &#41;;
&gt; 
&gt; This worked as yesterday.
&gt; Again, when I uncommented the group_by clause, yesterday&#39;s behavior
&gt; reproduced.
&gt; Unfortunately, the same errors appeared when I qualified the type
&gt; column:
&gt; &#34;Unknown column &#39;me.type&#39; in &#39;where clause&#39;&#34; and
&gt; &#34;Unknown column &#39;companies.type&#39; in &#39;where clause&#39;&#34;.
</div>
I will need to look into this. But please keep reading:
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I remember that yesterday I also tried to qualify the type column,
&gt; getting the same errors &#40;sorry for not
&gt; mentioning that then&#41;.
&gt; 
&gt; The version of the dbic query that I sent you yesterday &#40;with the
&gt; unqualified type column&#41; was so because
&gt; I expected that an unqualified column to be default qualified to the
&gt; main ResultSet table alias
&gt; &#40;&#39;Food::Schema::Result::CompanyType&#39; in my case&#41; - this would be a
&gt; nice to have feature.
</div>
Unfortunately this will never happen ue to backcompat issues.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Regarding the expected &#40;by me at least&#41; behavior for the group_by
&gt; attribute in the dbic query - I
&gt; expected that clause to simply be transformed in an &#34;GROUP BY
&gt; orders.company_id&#34; string appended to the
&gt; previously generated SQL query.
</div>
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The version of DBIC I use is the latest one &#40;I installed DBIC a couple
&gt; of weeks before from cpan&#41;.
</div>
In the future please give the actual version number: you have no idea
how often people end up using a stale cpan mirror. I will assume you are
using 0.08195

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Regarding the logic of the MySQL query, I want to get the SUM of the
&gt; AMOUNT of each ORDER for each
&gt; COMPANY that has the TYPE &#39;orderer&#39;. So, I took each company of type
&gt; orderer, each order of that, group
&gt; by company and computed the sum of the amount column.
&gt;
&gt; However, yesterday I managed to find a workaround for achieving what I
&gt; needed by working with 2
&gt; resultsets:
&gt; - one for each company with type &#39;orderer&#39;:
&gt; 
&gt;  my $companies_rs =  $self-&gt;app-&gt;model-
<div class="message-stanza open">&gt; &gt;resultset&#40;&#39;Food::Schema::Result::Company&#39;&#41;
</div>&gt;          -&gt;search_rs&#40;
&gt;                   {
&gt;                     &#39;company_type.type&#39; =&gt; &#39;orderer&#39;,
&gt;                   },
&gt;                   {
&gt;                   join      =&gt; [&#39;company_type&#39;],
&gt;                   }
&gt;          &#41;;
&gt; - and for each of the users of the above companies, get the SUM of the
&gt; amount from orders:
&gt;     my $comp_orders = $self-&gt;app-&gt;model-
<div class="message-stanza open">&gt; &gt;resultset&#40;&#39;Food::Schema::Result::User&#39;&#41;
</div>&gt;         -&gt;search_rs&#40;
&gt;         {
&gt;           &#39;me.company_id&#39;   =&gt; $company-&gt;{id},
&gt;           &#39;orders.status&#39;=&gt; { &#39;!=&#39; =&gt; &#39;paid&#39; },
&gt;           &#39;company.id&#39;   =&gt; $self-&gt;app-&gt;sessions-&gt;{user}-&gt;company&#40;&#41;-
<div class="message-stanza open">&gt; &gt;id&#40;&#41;,
</div>&gt; 
&gt;         },
&gt;         {
&gt;            join      =&gt; { &#39;orders&#39; =&gt; &#39;company&#39; },
&gt;            prefetch  =&gt; [ qw&#40; orders company &#41; ],
&gt;            select    =&gt; [ { sum =&gt; &#39;orders.total&#39;, -as =&gt;
&gt; &#39;company_total&#39; }, ], #SQL As
&gt;            columns   =&gt; [ qw&#40;  company.name orders.company_id&#41; ],
&gt;            as        =&gt; [qw/company_total/],
&gt;         }
&gt;         &#41;;
&gt; 
&gt; The reason of wanting to solve that in a single query is because of
&gt; the wonderful feature that DBIC has
&gt; by working with result sets instead of only individual rows - and I
&gt; still think it is &#40;or should be&#41;
&gt; possible to do that.
</div>
Sigh. No it shouldn&#39;t - you are still not understanding what you are
asking of DBIC. Since on top of everything else you are also asking for
a *PREFETCH OF A HAS_MANY*, you in essence have:

&#39;artist&#39; has_many &#39;cds&#39; belongs_to &#39;genre&#39;, and you are trying to
prefetch cds. So you get something like:

SELECT *.artist, *.cds FROM artist LEFT JOIN cds ... LEFT JOIN genre

Once you GROUP BY something from genre. - what do you think happens to
the entire result, especially what happens to the individual cds with
identical genres? *everything* is collapsed down to some random
undefined state. No more prefetch.

If you take the prefetch out - everything will work &#34;as you expect&#34;. But
what you ask of DBIC currently does not match what you think you are. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;20&nbsp;17:12:51&nbsp;2011</span>
    <span class="description">TCONST [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">just read what prefetch is actually doing - and is not the same thing as to what I was 
expecting - I put it there because i thought it only puts all the columns in the SELECT 
clause - removing it, indeed does what I want. 

The transformation of the query from some simple joins to the complex select from subselect 
by simply adding a group by clause made me think that it&#39;s a bug.

Thank you very much for helping me clarifying this out and sorry for my hurry in reporting 
this as a bug.

Cheers,
Tudor


On Sun Nov 20 15:21:35 2011, RIBASUSHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun Nov 20 14:07:05 2011, TCONST wrote:
<div class="message-stanza open">&gt; &gt; Hi again,
&gt; &gt; 
&gt; &gt; First of all let me express a wow for your quick and detailed
&gt; &gt; response.
&gt; &gt; 
&gt; &gt; You are right with the semantic nonsense of the relation from
&gt; &gt; CompanyType to Company - thx for pointing
&gt; &gt; that out.
&gt; &gt; I modified that in the CompanyType schema file, and I got an error
&gt; &gt; saying that &#34;No such relationship
&gt; &gt; company on CompanyType&#34; when accessing $companies_rs-&gt;next&#40;&#41;. I
&gt; &gt; checked the code, relationships with/from
&gt; &gt; other schemas and I coouldn&#39;t find any references to CompanyType-
<div class="message-stanza open">&gt; &gt; &gt;company.
</div>&gt; &gt; 
&gt; &gt; However, if I understood correctly from your reply, that was just a
&gt; &gt; semantic issue, so I let both
&gt; &gt; relationships in the Schema:
&gt; &gt; 
&gt; &gt; __PACKAGE__-&gt;has_many&#40;companies =&gt; &#39;Food::Schema::Result::Company&#39;,
&gt; &gt; &#39;company_type_id&#39;&#41;;
&gt; &gt; __PACKAGE__-&gt;has_many&#40;company =&gt; &#39;Food::Schema::Result::Company&#39;,
&gt; &gt; &#39;company_type_id&#39;&#41;;
&gt; &gt; 
</div>&gt; 
&gt; When you say
&gt; 
&gt; columns   =&gt; [ qw&#40;  companies.name...
&gt; 
&gt; You are also referring to a relationship. When grepping for the
&gt; relationship name - search for all occurances.
&gt; 
<div class="message-stanza open">&gt; &gt; And modified the dbic query to:
&gt; &gt; 
&gt; &gt;  my $companies_rs = $self-&gt;app-&gt;model-
<div class="message-stanza open">&gt; &gt; &gt;resultset&#40;&#39;Food::Schema::Result::CompanyType&#39;&#41;
</div>&gt; &gt;         -&gt;search_rs&#40;
&gt; &gt;          {
&gt; &gt; 
&gt; &gt;           &#39;type&#39; =&gt; &#39;orderer&#39;,
&gt; &gt;           &#39;orders.status&#39;     =&gt; { &#39;!=&#39; =&gt; &#39;paid&#39; },
&gt; &gt;           &#39;company.id&#39; =&gt; $self-&gt;app-&gt;sessions-&gt;{user}-&gt;company&#40;&#41;-
<div class="message-stanza open">&gt; &gt; &gt;id&#40;&#41;,
</div>&gt; &gt;          },
&gt; &gt;          {
&gt; &gt;            join      =&gt; { &#39;companies&#39; =&gt; { &#39;users&#39; =&gt; { &#39;orders&#39; =&gt;
&gt; &gt; &#39;company&#39; } } },
&gt; &gt;            prefetch  =&gt; [ qw&#40; company &#41;],
&gt; &gt;            select    =&gt; [ { sum =&gt; &#39;orders.total&#39;, -as =&gt;
&gt; &gt; &#39;company_total&#39; }, ], #SQL As
&gt; &gt;            columns   =&gt; [ qw&#40;  companies.name orders.company_id&#41; ],
&gt; &gt;            as        =&gt; [qw/company_total/], #used for retrieving the
&gt; &gt; above sql as
&gt; &gt;            #group_by  =&gt; &#39;orders.company_id&#39; ,
&gt; &gt;          } &#41;;
&gt; &gt; 
&gt; &gt; This worked as yesterday.
&gt; &gt; Again, when I uncommented the group_by clause, yesterday&#39;s behavior
&gt; &gt; reproduced.
&gt; &gt; Unfortunately, the same errors appeared when I qualified the type
&gt; &gt; column:
&gt; &gt; &#34;Unknown column &#39;me.type&#39; in &#39;where clause&#39;&#34; and
&gt; &gt; &#34;Unknown column &#39;companies.type&#39; in &#39;where clause&#39;&#34;.
</div>&gt; 
&gt; I will need to look into this. But please keep reading:
&gt;  
<div class="message-stanza open">&gt; &gt; I remember that yesterday I also tried to qualify the type column,
&gt; &gt; getting the same errors &#40;sorry for not
&gt; &gt; mentioning that then&#41;.
&gt; &gt; 
&gt; &gt; The version of the dbic query that I sent you yesterday &#40;with the
&gt; &gt; unqualified type column&#41; was so because
&gt; &gt; I expected that an unqualified column to be default qualified to the
&gt; &gt; main ResultSet table alias
&gt; &gt; &#40;&#39;Food::Schema::Result::CompanyType&#39; in my case&#41; - this would be a
&gt; &gt; nice to have feature.
</div>&gt; 
&gt; Unfortunately this will never happen ue to backcompat issues.
&gt; 
<div class="message-stanza open">&gt; &gt; Regarding the expected &#40;by me at least&#41; behavior for the group_by
&gt; &gt; attribute in the dbic query - I
&gt; &gt; expected that clause to simply be transformed in an &#34;GROUP BY
&gt; &gt; orders.company_id&#34; string appended to the
&gt; &gt; previously generated SQL query.
</div>&gt; 
&gt;  
<div class="message-stanza open">&gt; &gt; The version of DBIC I use is the latest one &#40;I installed DBIC a couple
&gt; &gt; of weeks before from cpan&#41;.
</div>&gt; 
&gt; In the future please give the actual version number: you have no idea
&gt; how often people end up using a stale cpan mirror. I will assume you are
&gt; using 0.08195
&gt; 
<div class="message-stanza open">&gt; &gt; Regarding the logic of the MySQL query, I want to get the SUM of the
&gt; &gt; AMOUNT of each ORDER for each
&gt; &gt; COMPANY that has the TYPE &#39;orderer&#39;. So, I took each company of type
&gt; &gt; orderer, each order of that, group
&gt; &gt; by company and computed the sum of the amount column.
&gt; &gt;
&gt; &gt; However, yesterday I managed to find a workaround for achieving what I
&gt; &gt; needed by working with 2
&gt; &gt; resultsets:
&gt; &gt; - one for each company with type &#39;orderer&#39;:
&gt; &gt; 
&gt; &gt;  my $companies_rs =  $self-&gt;app-&gt;model-
<div class="message-stanza open">&gt; &gt; &gt;resultset&#40;&#39;Food::Schema::Result::Company&#39;&#41;
</div>&gt; &gt;          -&gt;search_rs&#40;
&gt; &gt;                   {
&gt; &gt;                     &#39;company_type.type&#39; =&gt; &#39;orderer&#39;,
&gt; &gt;                   },
&gt; &gt;                   {
&gt; &gt;                   join      =&gt; [&#39;company_type&#39;],
&gt; &gt;                   }
&gt; &gt;          &#41;;
&gt; &gt; - and for each of the users of the above companies, get the SUM of the
&gt; &gt; amount from orders:
&gt; &gt;     my $comp_orders = $self-&gt;app-&gt;model-
<div class="message-stanza open">&gt; &gt; &gt;resultset&#40;&#39;Food::Schema::Result::User&#39;&#41;
</div>&gt; &gt;         -&gt;search_rs&#40;
&gt; &gt;         {
&gt; &gt;           &#39;me.company_id&#39;   =&gt; $company-&gt;{id},
&gt; &gt;           &#39;orders.status&#39;=&gt; { &#39;!=&#39; =&gt; &#39;paid&#39; },
&gt; &gt;           &#39;company.id&#39;   =&gt; $self-&gt;app-&gt;sessions-&gt;{user}-&gt;company&#40;&#41;-
<div class="message-stanza open">&gt; &gt; &gt;id&#40;&#41;,
</div>&gt; &gt; 
&gt; &gt;         },
&gt; &gt;         {
&gt; &gt;            join      =&gt; { &#39;orders&#39; =&gt; &#39;company&#39; },
&gt; &gt;            prefetch  =&gt; [ qw&#40; orders company &#41; ],
&gt; &gt;            select    =&gt; [ { sum =&gt; &#39;orders.total&#39;, -as =&gt;
&gt; &gt; &#39;company_total&#39; }, ], #SQL As
&gt; &gt;            columns   =&gt; [ qw&#40;  company.name orders.company_id&#41; ],
&gt; &gt;            as        =&gt; [qw/company_total/],
&gt; &gt;         }
&gt; &gt;         &#41;;
&gt; &gt; 
&gt; &gt; The reason of wanting to solve that in a single query is because of
&gt; &gt; the wonderful feature that DBIC has
&gt; &gt; by working with result sets instead of only individual rows - and I
&gt; &gt; still think it is &#40;or should be&#41;
&gt; &gt; possible to do that.
</div>&gt; 
&gt; Sigh. No it shouldn&#39;t - you are still not understanding what you are
&gt; asking of DBIC. Since on top of everything else you are also asking for
&gt; a *PREFETCH OF A HAS_MANY*, you in essence have:
&gt; 
&gt; &#39;artist&#39; has_many &#39;cds&#39; belongs_to &#39;genre&#39;, and you are trying to
&gt; prefetch cds. So you get something like:
&gt; 
&gt; SELECT *.artist, *.cds FROM artist LEFT JOIN cds ... LEFT JOIN genre
&gt; 
&gt; Once you GROUP BY something from genre. - what do you think happens to
&gt; the entire result, especially what happens to the individual cds with
&gt; identical genres? *everything* is collapsed down to some random
&gt; undefined state. No more prefetch.
&gt; 
&gt; If you take the prefetch out - everything will work &#34;as you expect&#34;. But
&gt; what you ask of DBIC currently does not match what you think you are. 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;20&nbsp;17:15:10&nbsp;2011</span>
    <span class="description">TCONST [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">What is the procedure for closing this ticket? I think you can reject 
this, as it is not a bug

On Sun Nov 20 15:21:35 2011, RIBASUSHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun Nov 20 14:07:05 2011, TCONST wrote:
<div class="message-stanza open">&gt; &gt; Hi again,
&gt; &gt; 
&gt; &gt; First of all let me express a wow for your quick and detailed
&gt; &gt; response.
&gt; &gt; 
&gt; &gt; You are right with the semantic nonsense of the relation from
&gt; &gt; CompanyType to Company - thx for pointing
&gt; &gt; that out.
&gt; &gt; I modified that in the CompanyType schema file, and I got an error
&gt; &gt; saying that &#34;No such relationship
&gt; &gt; company on CompanyType&#34; when accessing $companies_rs-&gt;next&#40;&#41;. I
&gt; &gt; checked the code, relationships with/from
&gt; &gt; other schemas and I coouldn&#39;t find any references to CompanyType-
<div class="message-stanza open">&gt; &gt; &gt;company.
</div>&gt; &gt; 
&gt; &gt; However, if I understood correctly from your reply, that was just a
&gt; &gt; semantic issue, so I let both
&gt; &gt; relationships in the Schema:
&gt; &gt; 
&gt; &gt; __PACKAGE__-&gt;has_many&#40;companies =&gt; &#39;Food::Schema::Result::Company&#39;,
&gt; &gt; &#39;company_type_id&#39;&#41;;
&gt; &gt; __PACKAGE__-&gt;has_many&#40;company =&gt; &#39;Food::Schema::Result::Company&#39;,
&gt; &gt; &#39;company_type_id&#39;&#41;;
&gt; &gt; 
</div>&gt; 
&gt; When you say
&gt; 
&gt; columns   =&gt; [ qw&#40;  companies.name...
&gt; 
&gt; You are also referring to a relationship. When grepping for the
&gt; relationship name - search for all occurances.
&gt; 
<div class="message-stanza open">&gt; &gt; And modified the dbic query to:
&gt; &gt; 
&gt; &gt;  my $companies_rs = $self-&gt;app-&gt;model-
<div class="message-stanza open">&gt; &gt; &gt;resultset&#40;&#39;Food::Schema::Result::CompanyType&#39;&#41;
</div>&gt; &gt;         -&gt;search_rs&#40;
&gt; &gt;          {
&gt; &gt; 
&gt; &gt;           &#39;type&#39; =&gt; &#39;orderer&#39;,
&gt; &gt;           &#39;orders.status&#39;     =&gt; { &#39;!=&#39; =&gt; &#39;paid&#39; },
&gt; &gt;           &#39;company.id&#39; =&gt; $self-&gt;app-&gt;sessions-&gt;{user}-&gt;company&#40;&#41;-
<div class="message-stanza open">&gt; &gt; &gt;id&#40;&#41;,
</div>&gt; &gt;          },
&gt; &gt;          {
&gt; &gt;            join      =&gt; { &#39;companies&#39; =&gt; { &#39;users&#39; =&gt; { &#39;orders&#39; =&gt;
&gt; &gt; &#39;company&#39; } } },
&gt; &gt;            prefetch  =&gt; [ qw&#40; company &#41;],
&gt; &gt;            select    =&gt; [ { sum =&gt; &#39;orders.total&#39;, -as =&gt;
&gt; &gt; &#39;company_total&#39; }, ], #SQL As
&gt; &gt;            columns   =&gt; [ qw&#40;  companies.name orders.company_id&#41; ],
&gt; &gt;            as        =&gt; [qw/company_total/], #used for retrieving 
</div></div>the
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; above sql as
&gt; &gt;            #group_by  =&gt; &#39;orders.company_id&#39; ,
&gt; &gt;          } &#41;;
&gt; &gt; 
&gt; &gt; This worked as yesterday.
&gt; &gt; Again, when I uncommented the group_by clause, yesterday&#39;s behavior
&gt; &gt; reproduced.
&gt; &gt; Unfortunately, the same errors appeared when I qualified the type
&gt; &gt; column:
&gt; &gt; &#34;Unknown column &#39;me.type&#39; in &#39;where clause&#39;&#34; and
&gt; &gt; &#34;Unknown column &#39;companies.type&#39; in &#39;where clause&#39;&#34;.
</div>&gt; 
&gt; I will need to look into this. But please keep reading:
&gt;  
<div class="message-stanza open">&gt; &gt; I remember that yesterday I also tried to qualify the type column,
&gt; &gt; getting the same errors &#40;sorry for not
&gt; &gt; mentioning that then&#41;.
&gt; &gt; 
&gt; &gt; The version of the dbic query that I sent you yesterday &#40;with the
&gt; &gt; unqualified type column&#41; was so because
&gt; &gt; I expected that an unqualified column to be default qualified to the
&gt; &gt; main ResultSet table alias
&gt; &gt; &#40;&#39;Food::Schema::Result::CompanyType&#39; in my case&#41; - this would be a
&gt; &gt; nice to have feature.
</div>&gt; 
&gt; Unfortunately this will never happen ue to backcompat issues.
&gt; 
<div class="message-stanza open">&gt; &gt; Regarding the expected &#40;by me at least&#41; behavior for the group_by
&gt; &gt; attribute in the dbic query - I
&gt; &gt; expected that clause to simply be transformed in an &#34;GROUP BY
&gt; &gt; orders.company_id&#34; string appended to the
&gt; &gt; previously generated SQL query.
</div>&gt; 
&gt;  
<div class="message-stanza open">&gt; &gt; The version of DBIC I use is the latest one &#40;I installed DBIC a 
</div></div>couple
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; of weeks before from cpan&#41;.
</div>&gt; 
&gt; In the future please give the actual version number: you have no idea
&gt; how often people end up using a stale cpan mirror. I will assume you 
</div>are
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; using 0.08195
&gt; 
<div class="message-stanza open">&gt; &gt; Regarding the logic of the MySQL query, I want to get the SUM of the
&gt; &gt; AMOUNT of each ORDER for each
&gt; &gt; COMPANY that has the TYPE &#39;orderer&#39;. So, I took each company of type
&gt; &gt; orderer, each order of that, group
&gt; &gt; by company and computed the sum of the amount column.
&gt; &gt;
&gt; &gt; However, yesterday I managed to find a workaround for achieving what 
</div></div>I
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; needed by working with 2
&gt; &gt; resultsets:
&gt; &gt; - one for each company with type &#39;orderer&#39;:
&gt; &gt; 
&gt; &gt;  my $companies_rs =  $self-&gt;app-&gt;model-
<div class="message-stanza open">&gt; &gt; &gt;resultset&#40;&#39;Food::Schema::Result::Company&#39;&#41;
</div>&gt; &gt;          -&gt;search_rs&#40;
&gt; &gt;                   {
&gt; &gt;                     &#39;company_type.type&#39; =&gt; &#39;orderer&#39;,
&gt; &gt;                   },
&gt; &gt;                   {
&gt; &gt;                   join      =&gt; [&#39;company_type&#39;],
&gt; &gt;                   }
&gt; &gt;          &#41;;
&gt; &gt; - and for each of the users of the above companies, get the SUM of 
</div></div>the
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; amount from orders:
&gt; &gt;     my $comp_orders = $self-&gt;app-&gt;model-
<div class="message-stanza open">&gt; &gt; &gt;resultset&#40;&#39;Food::Schema::Result::User&#39;&#41;
</div>&gt; &gt;         -&gt;search_rs&#40;
&gt; &gt;         {
&gt; &gt;           &#39;me.company_id&#39;   =&gt; $company-&gt;{id},
&gt; &gt;           &#39;orders.status&#39;=&gt; { &#39;!=&#39; =&gt; &#39;paid&#39; },
&gt; &gt;           &#39;company.id&#39;   =&gt; $self-&gt;app-&gt;sessions-&gt;{user}-&gt;company&#40;&#41;-
<div class="message-stanza open">&gt; &gt; &gt;id&#40;&#41;,
</div>&gt; &gt; 
&gt; &gt;         },
&gt; &gt;         {
&gt; &gt;            join      =&gt; { &#39;orders&#39; =&gt; &#39;company&#39; },
&gt; &gt;            prefetch  =&gt; [ qw&#40; orders company &#41; ],
&gt; &gt;            select    =&gt; [ { sum =&gt; &#39;orders.total&#39;, -as =&gt;
&gt; &gt; &#39;company_total&#39; }, ], #SQL As
&gt; &gt;            columns   =&gt; [ qw&#40;  company.name orders.company_id&#41; ],
&gt; &gt;            as        =&gt; [qw/company_total/],
&gt; &gt;         }
&gt; &gt;         &#41;;
&gt; &gt; 
&gt; &gt; The reason of wanting to solve that in a single query is because of
&gt; &gt; the wonderful feature that DBIC has
&gt; &gt; by working with result sets instead of only individual rows - and I
&gt; &gt; still think it is &#40;or should be&#41;
&gt; &gt; possible to do that.
</div>&gt; 
&gt; Sigh. No it shouldn&#39;t - you are still not understanding what you are
&gt; asking of DBIC. Since on top of everything else you are also asking 
</div>for
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; a *PREFETCH OF A HAS_MANY*, you in essence have:
&gt; 
&gt; &#39;artist&#39; has_many &#39;cds&#39; belongs_to &#39;genre&#39;, and you are trying to
&gt; prefetch cds. So you get something like:
&gt; 
&gt; SELECT *.artist, *.cds FROM artist LEFT JOIN cds ... LEFT JOIN genre
&gt; 
&gt; Once you GROUP BY something from genre. - what do you think happens to
&gt; the entire result, especially what happens to the individual cds with
&gt; identical genres? *everything* is collapsed down to some random
&gt; undefined state. No more prefetch.
&gt; 
&gt; If you take the prefetch out - everything will work &#34;as you expect&#34;. 
</div>But
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; what you ask of DBIC currently does not match what you think you are. 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;20&nbsp;17:33:57&nbsp;2011</span>
    <span class="description">abraxxa [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;21&nbsp;02:49:50&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #72556] group_by crashes the multi step join query</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 21 Nov 2011 08:49:39 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;ribasushi [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Tudor Constantin via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: DBIx-Class
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=72556">https://rt.cpan.org/Ticket/Display.html?id=72556</a></span> &gt;
&gt; 
&gt; What is the procedure for closing this ticket? I think you can reject 
&gt; this, as it is not a bug
&gt; 
</div>
It is a bug, given that a fully qualified far-side group_by did
not work. I just didn&#39;t get a chance to look into it yet.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;21&nbsp;02:49:53&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;rejected&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;18&nbsp;18:22:05&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Looking more into this bug it is clear that the second search&#40;&#41;
invocantion was laso incorrect - there is still an unqualified type
column in there. Closing as ENOTABUG
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;18&nbsp;18:22:07&nbsp;2012</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
