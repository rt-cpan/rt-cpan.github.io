<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #57695 for DBD-Pg: DBD::Pg unconditionally rolling back destroyed statements on destroy &#40;in pg_st_deallocate_statement&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #57695 for DBD-Pg: DBD::Pg unconditionally rolling back destroyed statements on destroy &#40;in pg_st_deallocate_statement&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-Pg/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-Pg/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-Pg/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-Pg/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-Pg">DBD-Pg CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">57695</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-Pg/Active/">DBD-Pg</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
SAMV [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Unimportant    </td>
  </tr>
  <tr id="CF-10200-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.17.1    </td>
  </tr>
  <tr id="CF-10201-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;21&nbsp;01:19:32&nbsp;2010</span>
    <span class="description">SAMV [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> DBD::Pg unconditionally rolling back destroyed statements on
 destroy &#40;in pg_st_deallocate_statement&#41;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, I&#39;m not sure why you choose to rollback when a statement handle is 
destroyed.  This breaks the idea that the transaction should stay in the 
failed state until explicitly rolled back or committed.  If you were, 
say, to then explicitly roll back to a named savepoint, it would roll 
back to the previous savepoint of the same name.

The rollback on DBH disconnect behaviour is fine, that is fair enough, 
but given that statement handles may be created temporarily and then 
thrown away, this behaviour is a bad default IMHO.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;23&nbsp;19:59:11&nbsp;2010</span>
    <span class="description">SAMV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri May 21 01:19:32 2010, SAMV wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, I&#39;m not sure why you choose to rollback when a statement handle is 
&gt; destroyed.  This breaks the idea that the transaction should stay in
&gt; the  failed state until explicitly rolled back or committed.
</div>
I suggest the attached patch, unless someone can describe why this is
required at all.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> no-rollback-on-st-destroy.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- libdbd-pg-perl-2.8.7.orig/dbdimp.c	2008-07-24 07:46:49.000000000 +1200
+++ libdbd-pg-perl-2.8.7/dbdimp.c	2010-05-24 11:41:19.000000000 +1200
@@ -3414,42 +3414,6 @@
 	
 	tempsqlstate[0] = &#39;\0&#39;;
 
-	/* What is our status? */
-	tstatus = pg_db_txn_status&#40;aTHX_ imp_dbh&#41;;
-	if &#40;TRACE5&#41;
-		TRC&#40;DBILOGFP, &#34;%stxn_status is %d\n&#34;, THEADER, tstatus&#41;;
-
-	/* If we are in a failed transaction, rollback before deallocating */
-	if &#40;PQTRANS_INERROR == tstatus&#41; {
-		if &#40;TRACE4&#41;
-			TRC&#40;DBILOGFP, &#34;%sIssuing rollback before deallocate\n&#34;, THEADER&#41;;
-		{
-			/* If a savepoint has been set, rollback to the last savepoint instead of the entire transaction */
-			I32	alen = av_len&#40;imp_dbh-&gt;savepoints&#41;;
-			if &#40;alen &gt; -1&#41; {
-				char	*cmd;
-				SV * const sp = *av_fetch&#40;imp_dbh-&gt;savepoints, alen, 0&#41;;
-				New&#40;0, cmd, SvLEN&#40;sp&#41; + 13, char&#41;; /* Freed below */
-				if &#40;TRACE4&#41;
-					TRC&#40;DBILOGFP, &#34;%sRolling back to savepoint %s\n&#34;, THEADER, SvPV_nolen&#40;sp&#41;&#41;;
-				sprintf&#40;cmd, &#34;rollback to %s&#34;, SvPV_nolen&#40;sp&#41;&#41;;
-				strncpy&#40;tempsqlstate, imp_dbh-&gt;sqlstate, strlen&#40;imp_dbh-&gt;sqlstate&#41;+1&#41;;
-				status = _result&#40;aTHX_ imp_dbh, cmd&#41;;
-				Safefree&#40;cmd&#41;;
-			}
-			else {
-				status = _result&#40;aTHX_ imp_dbh, &#34;ROLLBACK&#34;&#41;;
-				imp_dbh-&gt;done_begin = DBDPG_FALSE;
-			}
-		}
-		if &#40;PGRES_COMMAND_OK != status&#41; {
-			/* This is not fatal, it just means we cannot deallocate */
-			if &#40;TRACEWARN&#41; TRC&#40;DBILOGFP, &#34;%sRollback failed, so no deallocate\n&#34;, THEADER&#41;;
-			if &#40;TEND&#41; TRC&#40;DBILOGFP, &#34;%sEnd pg_st_deallocate_statement &#40;cannot deallocate&#41;\n&#34;, THEADER&#41;;
-			return 1;
-		}
-	}
-
 	New&#40;0, stmt, strlen&#40;&#34;DEALLOCATE &#34;&#41; + strlen&#40;imp_sth-&gt;prepare_name&#41; + 1, char&#41;; /* freed below */
 
 	sprintf&#40;stmt, &#34;DEALLOCATE %s&#34;, imp_sth-&gt;prepare_name&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;23&nbsp;19:59:15&nbsp;2010</span>
    <span class="description">SAMV [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;24&nbsp;20:28:19&nbsp;2010</span>
    <span class="description">SAMV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun May 23 19:59:11 2010, SAMV wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri May 21 01:19:32 2010, SAMV wrote:
<div class="message-stanza open">&gt; &gt; Hi, I&#39;m not sure why you choose to rollback when a statement handle 
</div></div>is 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; destroyed.  This breaks the idea that the transaction should stay in
&gt; &gt; the  failed state until explicitly rolled back or committed.
</div>&gt; 
&gt; I suggest the attached patch, unless someone can describe why this is
&gt; required at all.
</div>
Right, I now see.  Postgres refuses to deal even with non-data related 
operations such as DEALLOCATE or PREPARE in this state.  Yuck.  Still, 
implicit rollback is very evil, a more correct solution would defer the 
work which will not be accepted until the transaction is in a valid state 
again.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;24&nbsp;20:46:50&nbsp;2010</span>
    <span class="description">SAMV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon May 24 20:28:19 2010, SAMV wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun May 23 19:59:11 2010, SAMV wrote:
<div class="message-stanza open">&gt; &gt; On Fri May 21 01:19:32 2010, SAMV wrote:
<div class="message-stanza open">&gt; &gt; &gt; Hi, I&#39;m not sure why you choose to rollback when a statement 
</div></div></div>handle 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; is 
<div class="message-stanza open">&gt; &gt; &gt; destroyed.  This breaks the idea that the transaction should stay 
</div></div>in
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; the  failed state until explicitly rolled back or committed.
</div>&gt; &gt; 
&gt; &gt; I suggest the attached patch, unless someone can describe why this 
</div></div>is
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; required at all.
</div>&gt; 
&gt; Right, I now see.  Postgres refuses to deal even with non-data related 
&gt; operations such as DEALLOCATE or PREPARE in this state.  Yuck.  Still, 
&gt; implicit rollback is very evil, a more correct solution would defer 
</div>the 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; work which will not be accepted until the transaction is in a valid 
</div>state 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; again.
</div>
OK, after a bit of investigation I&#39;m more convinced that the code is 
unnecessary.  In the event that an $sth goes out of scope during an 
aborted transaction, the DEALLOCATE statement will simply fail, a 
warning will be issued by the enclosing code, but nothing disastrous 
should result of this.  Even if you explicitly re-used a prepared 
statement name using pg_prepare_name, it would fail, and then pick a 
different name.  I&#39;ll see if I can prove this with a test case.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;25&nbsp;00:21:38&nbsp;2010</span>
    <span class="description">SAMV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon May 24 20:46:50 2010, SAMV wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; OK, after a bit of investigation I&#39;m more convinced that the code is 
&gt; unnecessary.  In the event that an $sth goes out of scope during an 
&gt; aborted transaction, the DEALLOCATE statement will simply fail, a 
&gt; warning will be issued by the enclosing code, but nothing disastrous 
&gt; should result of this.  Even if you explicitly re-used a prepared 
&gt; statement name using pg_prepare_name, it would fail, and then pick a 
&gt; different name.  I&#39;ll see if I can prove this with a test case.
</div>
Continuing my monologue, after producing a test case &#40;attached&#41; I can see 
that the exact drawback I describe is not correct, leaving me with just 
the general grumble that the driver is resetting my transaction state 
without telling me.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 20savepoints.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!perl

## Test savepoint functionality

use 5.006;
use strict;
use warnings;
use Test::More;
use DBI &#39;:sql_types&#39;;
use lib &#39;t&#39;,&#39;.&#39;;
require &#39;dbdpg_test_setup.pl&#39;;
select&#40;&#40;$|=1,select&#40;STDERR&#41;,$|=1&#41;[1]&#41;;

my $dbh = connect_database&#40;&#41;;

if &#40;!defined $dbh&#41; {
	plan skip_all =&gt; &#39;Connection to database failed, cannot continue testing&#39;;
}
plan &#34;no_plan&#34;;

isnt &#40;$dbh, undef, &#39;Connect to database for savepoint testing&#39;&#41;;

my $pgversion = $dbh-&gt;{pg_server_version};

my $t;
my $str = &#39;Savepoint Test&#39;;
my $ids = sub {
	my $ids = $dbh-&gt;selectcol_arrayref&#40;&#39;SELECT id FROM dbd_pg_test WHERE pname = ? order by id asc&#39;,undef,$str&#41;;
	return $ids;
};

SKIP: {
	skip &#40;&#39;Cannot test savepoints on pre-8.0 servers&#39;, 2&#41; if $pgversion &lt; 80000;

	my $sth = $dbh-&gt;prepare&#40;&#39;INSERT INTO dbd_pg_test &#40;id,pname&#41; VALUES &#40;?,?&#41;&#39;&#41;;

	## Create 500 without a savepoint
	$sth-&gt;execute&#40;500,$str&#41;;

	## Create 501 inside a savepoint and roll it back
	$dbh-&gt;pg_savepoint&#40;&#39;dbd_pg_test_savepoint&#39;&#41;;
	$sth-&gt;execute&#40;501,$str&#41;;
	$dbh-&gt;pg_rollback_to&#40;&#39;dbd_pg_test_savepoint&#39;&#41;;

	## savepoints can be re-used.  Make 505 and roll it back.
	$sth-&gt;execute&#40;502,$str&#41;;
	$dbh-&gt;pg_rollback_to&#40;&#39;dbd_pg_test_savepoint&#39;&#41;;

	## Create 502 after the rollback:
	$sth-&gt;execute&#40;503,$str&#41;;
	$dbh-&gt;commit;

	$t=&#39;pg_savepoint and pg_rollback_to - re-using a savepoint&#39;;
	is_deeply&#40;$ids-&gt;&#40;&#41;, [500, 503], $t&#41;;

	## however, re-using a savepoint name also stacks them.
	$dbh-&gt;pg_savepoint&#40;&#39;dbd_pg_test_savepoint&#39;&#41;;
	$sth-&gt;execute&#40;504,$str&#41;;
	$dbh-&gt;pg_savepoint&#40;&#39;dbd_pg_test_savepoint&#39;&#41;;
	$sth-&gt;execute&#40;505,$str&#41;;
	$dbh-&gt;pg_rollback_to&#40;&#39;dbd_pg_test_savepoint&#39;&#41;;
	$dbh-&gt;commit;

	$t=&#39;duplicate savepoint name behaviour&#39;;
	is_deeply&#40;$ids-&gt;&#40;&#41;, [500, 503, 504], $t&#41;;

	## we can also &#39;release&#39; savepoints
	$dbh-&gt;pg_savepoint&#40;&#39;dbd_pg_test_savepoint&#39;&#41;;
	$sth-&gt;execute&#40;506,$str&#41;;
	$dbh-&gt;pg_release&#40;&#39;dbd_pg_test_savepoint&#39;&#41;;

	# these ones should fail
	eval { $dbh-&gt;pg_rollback_to&#40;&#39;dbd_pg_test_savepoint&#39;&#41; };
	$t = &#34;exception by rollback to released savepoint&#34;;
	like&#40;$@, qr/no such savepoint/, $t&#41;;
	eval { $sth-&gt;execute&#40;507,$str&#41; };
	$t = &#34;exception from trying to execute stuff&#34;;
	like&#40;$@, qr/current.*aborted/, $t&#41;;

	## this will be a forced rollback.
	$dbh-&gt;commit;

	$t = &#39;pg_release to release savepoint&#39;;
	is_deeply&#40;$ids-&gt;&#40;&#41;, [500, 503, 504], $t&#41;;

	## test rollback with an actual exception
	$dbh-&gt;pg_savepoint&#40;&#39;dbd_pg_test_savepoint&#39;&#41;;
	$sth-&gt;execute&#40;508,$str&#41;;
	$dbh-&gt;pg_savepoint&#40;&#39;dbd_pg_test_savepoint&#39;&#41;;
	$sth-&gt;execute&#40;509,$str&#41;;
	# we do something bad,
	eval { $dbh-&gt;selectall_arrayref&#40;&#39;gibbons&#39;&#41; };
	# say we detect the error and roll back,
	$dbh-&gt;pg_rollback_to&#40;&#39;dbd_pg_test_savepoint&#39;&#41;;
	$sth-&gt;execute&#40;510,$str&#41;;
	$dbh-&gt;commit;
	$t = &#39;no implicit rollback on statement deallocate&#39;;
	is_deeply&#40;$ids-&gt;&#40;&#41;, [500, 503, 504, 508, 510], $t&#41;;

	# test what happens if you re-use savepoints and roll back twice
	$dbh-&gt;do&#40;&#39;SAVEPOINT dbd_pg_test_savepoint&#39;&#41;;
	$sth-&gt;execute&#40;511,$str&#41;;
	$dbh-&gt;do&#40;&#39;SAVEPOINT dbd_pg_test_savepoint&#39;&#41;;
	$sth-&gt;execute&#40;512,$str&#41;;
	# we do something bad,
	eval { $dbh-&gt;selectall_arrayref&#40;&#39;gibbons&#39;&#41; };
	# the statement handle rolls back for us,
	$dbh-&gt;do&#40;&#39;ROLLBACK TO dbd_pg_test_savepoint&#39;&#41;;
	# we detect the error and roll back as before,
	$dbh-&gt;do&#40;&#39;ROLLBACK TO dbd_pg_test_savepoint&#39;&#41;;
	$sth-&gt;execute&#40;513,$str&#41;;
	$dbh-&gt;commit;
	# ah, it&#39;s safe - because the first rollback didn&#39;t *release*
	# the savepoint.
	$t = &#39;rollback to savepoint - re-using rollbacks in the presence of stacking&#39;;
	is_deeply&#40;$ids-&gt;&#40;&#41;, [500, 503, 504, 508, 510, 511, 513], $t&#41;;
}

$dbh-&gt;do&#40;&#39;DELETE FROM dbd_pg_test&#39;&#41;;
$dbh-&gt;commit&#40;&#41;;

cleanup_database&#40;$dbh,&#39;test&#39;&#41;;
$dbh-&gt;disconnect&#40;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;01&nbsp;18:29:01&nbsp;2010</span>
    <span class="description">greg [...] turnstep.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; the general grumble that the driver is resetting my transaction state 
&gt; without telling me.
</div>
So do you want to close this bug? If not, I&#39;d suggest you start a 
discussion on the dbdpg mailing list.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;27&nbsp;11:53:38&nbsp;2011</span>
    <span class="description">greg [...] turnstep.com -  Severity Unimportant added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;27&nbsp;11:53:38&nbsp;2011</span>
    <span class="description">greg [...] turnstep.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Stalling ticket for now
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;27&nbsp;11:53:39&nbsp;2011</span>
    <span class="description">greg [...] turnstep.com -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;05&nbsp;09:55:29&nbsp;2019</span>
    <span class="description">greg [...] turnstep.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Closing this as &#34;rejected&#34;, but feel free to reopen. But the lack of anyone else complaining limits the chances we will address this without at least some discussion on the list.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;05&nbsp;09:55:30&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;May&nbsp;05&nbsp;09:55:30&nbsp;2019</span>
    <span class="description">greg [...] turnstep.com -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
