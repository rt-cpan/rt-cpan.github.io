<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #129225 for IO-Async: Add a $loop-&gt;run_process</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #129225 for IO-Async: Add a $loop-&gt;run_process</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/IO-Async/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/IO-Async/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/IO-Async/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/IO-Async/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IO-Async">IO-Async CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">129225</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/IO-Async/Active/">IO-Async</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
leonerd-cpan [...] leonerd.org.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-42614-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-42615-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.73    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;18&nbsp;09:41:19&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Add a $loop-&gt;run_process</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">We have the old-and-annoying -&gt;run_child which doesn&#39;t play nicely with Futures. It&#39;d be nice to have a Future-returning oneliner to replace many common uses of system&#40;&#41;, qx&#40;&#41;, IPC::Run, etc.

  my &#40;$exitcode, $stdout&#41; = $loop-&gt;run_process&#40;command =&gt; [&#34;ls&#34;, &#34;-l&#34;]&#41;-&gt;get;

feels like a nice start. Except, how would we distinguish the &#34;I want to capture STDOUT&#34; of a qx&#40;&#41;-alike from the &#34;leave STDOUT pointing at my terminal&#34; of a system&#40;&#41;-alike? And what if we wanted to capture STDERR as well?

In either case we can pass in some STDIN data as extra args so that&#39;s not too difficult to add.

Perhaps there&#39;d be some extra named arguments, possibly with some named method shortcuts for invoking them:

  $loop-&gt;run_process_stdout&#40; ... &#41;  ==  $loop-&gt;run_process&#40; capture_stdout =&gt; 1, ... &#41;;

and so on?

In either case: they&#39;d return a Future that directly represents the eventual result of running the process. If the caller wants to additionally do Weird Things perhaps grabbing the PID as it starts, or interact directly with the underlying IaProcess object, they can pass in maybe an `on_process` callback to see those. Or maybe they have to use -&gt;spawn_process + await a finish future themself.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;18&nbsp;09:41:30&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Severity Wishlist added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;10&nbsp;23:09:09&nbsp;2019</span>
    <span class="description">KSYSOEV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> leonerd-cpan [...] leonerd.org.uk</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, Paul!

I&#39;ve done a small patch to implement this shortcut. I hope it will be helpful.

Also, I didn&#39;t find information about what is the best way to contribute to the project? Is it fine to put patch files here? Is there a GitHub or any other public repository for this project?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;10&nbsp;23:09:09&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;10&nbsp;23:19:15&nbsp;2019</span>
    <span class="description">KSYSOEV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry, I forgot to attach files.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 39loop-runproccess.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use warnings;

use IO::Async::Test;

use Test::More;
use Test::Fatal;

use IO::Async::Loop;
use IO::Async::OS;

use Data::Dumper;
plan skip_all =&gt; &#34;POSIX fork&#40;&#41; is not available&#34; unless IO::Async::OS-&gt;HAVE_POSIX_FORK;

my $loop = IO::Async::Loop-&gt;new_builtin;
testing_loop&#40; $loop &#41;;

# Same testing as run_child to proof that nothing broken

my &#40; $exitcode, $stdout, $stderr &#41;;
my $defaul_capture = [qw&#40;exitcode stdout stderr&#41;];

&#40; $exitcode, $stdout, $stderr &#41;
   = $loop-&gt;run_process&#40;
      code    =&gt; sub { 0 },
      capture =&gt; $defaul_capture,
   &#41;-&gt;get;

ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;WIFEXITED&#40;$exitcode&#41; after sub { 0 }&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 0,     &#39;WEXITSTATUS&#40;$exitcode&#41; after sub { 0 }&#39; &#41;;
is&#40; $stdout, &#34;&#34;,             &#39;$stdout after sub { 0 }&#39; &#41;;
is&#40; $stderr, &#34;&#34;,             &#39;$stderr after sub { 0 }&#39; &#41;;


&#40; $exitcode, $stdout, $stderr &#41;
   = $loop-&gt;run_process&#40;
      code    =&gt; sub { 3 },
      capture =&gt; $defaul_capture,
   &#41;-&gt;get;

ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;WIFEXITED&#40;$exitcode&#41; after sub { 3 }&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 3,     &#39;WEXITSTATUS&#40;$exitcode&#41; after sub { 3 }&#39; &#41;;
is&#40; $stdout, &#34;&#34;,             &#39;$stdout after sub { 3 }&#39; &#41;;
is&#40; $stderr, &#34;&#34;,             &#39;$stderr after sub { 3 }&#39; &#41;;

&#40; $exitcode, $stdout, $stderr &#41;
   = $loop-&gt;run_process&#40;
      command =&gt; [ $^X, &#34;-e&#34;, &#39;1&#39; ],
      capture =&gt; $defaul_capture,
   &#41;-&gt;get;

ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;WIFEXITED&#40;$exitcode&#41; after perl -e 1&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 0,     &#39;WEXITSTATUS&#40;$exitcode&#41; after perl -e 1&#39; &#41;;
is&#40; $stdout, &#34;&#34;,             &#39;$stdout after perl -e 1&#39; &#41;;
is&#40; $stderr, &#34;&#34;,             &#39;$stderr after perl -e 1&#39; &#41;;

&#40; $exitcode, $stdout, $stderr &#41;
   = $loop-&gt;run_process&#40;
      command =&gt; [ $^X, &#34;-e&#34;, &#39;exit 5&#39; ],
      capture =&gt; $defaul_capture,
   &#41;-&gt;get;


ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;WIFEXITED&#40;$exitcode&#41; after perl -e exit 5&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 5,     &#39;WEXITSTATUS&#40;$exitcode&#41; after perl -e exit 5&#39; &#41;;
is&#40; $stdout, &#34;&#34;,             &#39;$stdout after perl -e exit 5&#39; &#41;;
is&#40; $stderr, &#34;&#34;,             &#39;$stderr after perl -e exit 5&#39; &#41;;

&#40; $exitcode, $stdout, $stderr &#41;
   = $loop-&gt;run_process&#40;
      code    =&gt; sub { print &#34;hello\n&#34;; 0 },
      capture =&gt; $defaul_capture,
   &#41;-&gt;get;

ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;WIFEXITED&#40;$exitcode&#41; after sub { print }&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 0,     &#39;WEXITSTATUS&#40;$exitcode&#41; after sub { print }&#39; &#41;;
is&#40; $stdout, &#34;hello\n&#34;,      &#39;$stdout after sub { print }&#39; &#41;;
is&#40; $stderr, &#34;&#34;,             &#39;$stderr after sub { print }&#39; &#41;;


&#40; $exitcode, $stdout, $stderr &#41;
   = $loop-&gt;run_process&#40;
      command =&gt; [ $^X, &#34;-e&#34;, &#39;print &#34;goodbye\n&#34;&#39; ],
      capture =&gt; $defaul_capture,
   &#41;-&gt;get;

ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;WIFEXITED&#40;$exitcode&#41; after perl STDOUT&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 0,     &#39;WEXITSTATUS&#40;$exitcode&#41; after perl STDOUT&#39; &#41;;
is&#40; $stdout, &#34;goodbye\n&#34;,    &#39;$stdout after perl STDOUT&#39; &#41;;
is&#40; $stderr, &#34;&#34;,             &#39;$stderr after perl STDOUT&#39; &#41;;

&#40; $exitcode, $stdout, $stderr &#41;
   = $loop-&gt;run_process&#40;
      command =&gt; [ $^X, &#34;-e&#34;, &#39;print STDOUT &#34;output\n&#34;; print STDERR &#34;error\n&#34;;&#39; ],
      capture =&gt; $defaul_capture,
   &#41;-&gt;get;

ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;WIFEXITED&#40;$exitcode&#41; after perl STDOUT/STDERR&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 0,     &#39;WEXITSTATUS&#40;$exitcode&#41; after perl STDOUT/STDERR&#39; &#41;;
is&#40; $stdout, &#34;output\n&#34;,     &#39;$stdout after perl STDOUT/STDERR&#39; &#41;;
is&#40; $stderr, &#34;error\n&#34;,      &#39;$stderr after perl STDOUT/STDERR&#39; &#41;;

# perl -pe 1 behaves like cat; copies STDIN to STDOUT

&#40; $exitcode, $stdout, $stderr &#41;
   = $loop-&gt;run_process&#40;
      command =&gt; [ $^X, &#34;-pe&#34;, &#39;1&#39; ],
      stdin   =&gt; &#34;some data\n&#34;,
      capture =&gt; $defaul_capture,
   &#41;-&gt;get;

ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;WIFEXITED&#40;$exitcode&#41; after perl STDIN-&gt;STDOUT&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 0,     &#39;WEXITSTATUS&#40;$exitcode&#41; after perl STDIN-&gt;STDOUT&#39; &#41;;
is&#40; $stdout, &#34;some data\n&#34;,  &#39;$stdout after perl STDIN-&gt;STDOUT&#39; &#41;;
is&#40; $stderr, &#34;&#34;,             &#39;$stderr after perl STDIN-&gt;STDOUT&#39; &#41;;

# Testing what the future will return by default
my &#40; $future, $proc_id, $pid &#41;;

$future = $loop-&gt;run_process&#40;
      command =&gt; [ $^X, &#34;-e&#34;, &#39;print STDOUT &#34;output&#34;; print STDERR &#34;error&#34;;&#39; ],
   &#41;;

&#40; $exitcode, $stdout &#41; = $future-&gt;get;

ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;Exit code is correct with default captures&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 0,     &#39;Exit code is correct with default captures&#39; &#41;;
is&#40; $stdout, &#34;output&#34;,       &#39;STDOUT is correct with default captures&#39; &#41;;


# Testing what the future will return with additional captures
&#40; $future, $proc_id &#41;
   = $loop-&gt;run_process&#40;
      command =&gt; [ $^X, &#34;-e&#34;, &#39;print STDOUT &#34;output&#34;; print STDERR &#34;error&#34;;&#39; ],
      capture =&gt; [qw&#40;pid exitcode stdout stderr&#41;],
   &#41;;


&#40; $pid, $exitcode, $stdout, $stderr &#41; = $future-&gt;get;

is&#40; $proc_id, $pid,          &#39;PID is correct with default captures&#39; &#41;;
ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;Exit code is correct with custom captures&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 0,     &#39;Exit code is correct with custom captures&#39; &#41;;
is&#40; $stdout, &#34;output&#34;,       &#39;STDOUT is correct with custom captures&#39; &#41;;
is&#40; $stderr, &#34;error&#34;,        &#39;STDERR is correct with custom captures&#39; &#41;;

ok&#40; exception { $loop-&gt;run_process&#40;
         command =&gt; [ $^X, &#34;-e&#34;, 1 ],
         some_key_you_fail =&gt; 1
      &#41; },
   &#39;unrecognised key fails&#39;
&#41;;


# Testing what the future will return with additional captures in reverse order
&#40; $future, $proc_id &#41;
   = $loop-&gt;run_process&#40;
      command =&gt; [ $^X, &#34;-e&#34;, &#39;print STDOUT &#34;output&#34;; print STDERR &#34;error&#34;;&#39; ],
      capture =&gt; [qw&#40;stderr stdout exitcode pid&#41;],
   &#41;;

&#40; $stderr, $stdout, $exitcode, $pid &#41; = $future-&gt;get;

is&#40; $proc_id, $pid,          &#39;PID is correct with reversed captures&#39; &#41;;
ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;Exit code is correct with reversed captures&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 0,     &#39;Exit code is correct with reversed captures&#39; &#41;;
is&#40; $stdout, &#34;output&#34;,       &#39;STDOUT is correct with reversed captures&#39; &#41;;
is&#40; $stderr, &#34;error&#34;,        &#39;STDERR is correct with reversed captures&#39; &#41;;

# Testing error handling
ok&#40; exception { $loop-&gt;run_process&#40;
         command =&gt; [ $^X, &#34;-e&#34;, 1 ],
         some_key_you_fail =&gt; 1
      &#41; },
   &#39;unrecognised key fails&#39;
&#41;;

ok&#40; exception { $loop-&gt;run_process&#40;
         command =&gt; [ $^X, &#34;-e&#34;, 1 ],
         capture =&gt; &#39;pid&#39;
      &#41; },
   &#39;Capture in invapid format&#39;
&#41;;

ok&#40; exception { $loop-&gt;run_process&#40;
         command =&gt; [ $^X, &#34;-e&#34;, 1 ],
         capture =&gt; [&#39;invalid_capture&#39;]
      &#41; },
   &#39;Invalid capture type&#39;
&#41;;

ok&#40; exception { $loop-&gt;run_process&#40;
         command =&gt; [ $^X, &#34;-e&#34;, 1 ],
         on_finish =&gt; sub{ 0 }
      &#41; },
   &#39;Failing when finish callback is passed&#39;
&#41;;

done_testing;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch_lib_IO_Async_Loop.pm</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">1283a1284,1349
&gt; 
&gt; =head2 run_process
&gt; 
&gt;    $future = $loop-&gt;run_process&#40; %params &#41;
&gt; 
&gt; This creates a new child process to run the given code block or command,
&gt; capturing its STDOUT and STDERR streams. The method returns in scalar context
&gt; future or in list context - future and pid of the child proccess. When the process
&gt; exits, the future will be resolved. The Future will return C&lt;exitcode&gt; and
&gt; captured C&lt;stdout&gt; by default.
&gt; 
&gt; The method is a wrapper around run_child. It can accept the same parameters as
&gt; run_child, except C&lt;on_finish&gt;.
&gt; 
&gt; =over 8
&gt; 
&gt; =item capture =&gt; ARRAY
&gt; Optional, the list of value&#39;s names which should be returned by resolving future.
&gt; Values will be returned in the same order as you put them in the array.
&gt; It can contain next values: C&lt;pid&gt;, C&lt;exitcode&gt;, C&lt;stdout&gt;, C&lt;stderr&gt;
&gt; 
&gt; =back
&gt; 
&gt; This method is just a shortcut for run_child method.
&gt; 
&gt; 
&gt; my &#40;$future, $pid&#41; = $loop-&gt;run_process&#40;command =&gt; &#34;command here&#34;&#41;;
&gt; 
&gt; my &#40;$exitcode, $stdout&#41; = $future-&gt;get;
&gt; 
&gt; Z&lt;&gt;
&gt; 
&gt; my &#40;$exitcode, $stdout&#41; = $loop-&gt;run_process&#40;command =&gt; &#34;command here&#34;&#41;-&gt;get&#40;&#41;;
&gt; 
&gt; =cut
&gt; 
&gt; my @process_captures = qw&#40;pid exitcode stdout stderr&#41;;
&gt; 
&gt; sub run_process
&gt; {
&gt;    my $self = shift;
&gt;    my %params = @_;
&gt; 
&gt;    $params{on_finish} and croak &#34;Unrecognised parameter on_finish&#34;;
&gt; 
&gt;    my $capture = delete $params{capture} // [qw&#40;exitcode stdout&#41;];
&gt;    ref $capture eq ref [] or croak &#34;Expected &#39;capture&#39; to be an array reference&#34;;
&gt; 
&gt;    for my $name &#40; @$capture &#41; {
&gt;       grep { $_ eq $name } @process_captures or croak &#34;Unexpected capture $name&#34;;
&gt;    }
&gt; 
&gt;    my $future = $self-&gt;new_future;
&gt;    my $pid = $self-&gt;run_child&#40;
&gt;       %params,
&gt;       on_finish =&gt; sub {
&gt;          my %results;
&gt;          @results{ @process_captures } = @_;
&gt; 
&gt;          $future-&gt;done&#40; @results{ @$capture } &#41;;
&gt;       },
&gt;    &#41;;
&gt; 
&gt;    return wantarray ? &#40; $future, $pid &#41; : $future;
&gt; }
&gt; 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;11&nbsp;10:16:45&nbsp;2019</span>
    <span class="description">KSYSOEV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I reworked a little bit the first version and I did interface much like open_process/child. Now run_process returns in list context future and process object.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 39loop-runproccess.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use warnings;

use IO::Async::Test;

use Test::More;
use Test::Fatal;

use IO::Async::Loop;
use IO::Async::OS;
use Data::Dumper;

plan skip_all =&gt; &#34;POSIX fork&#40;&#41; is not available&#34; unless IO::Async::OS-&gt;HAVE_POSIX_FORK;

my $loop = IO::Async::Loop-&gt;new_builtin;
testing_loop&#40; $loop &#41;;

# Same testing as run_child to proof that nothing broken

my &#40; $exitcode, $stdout, $stderr &#41;;
my $defaul_capture = [qw&#40;exitcode stdout stderr&#41;];

&#40; $exitcode, $stdout, $stderr &#41;
   = $loop-&gt;run_process&#40;
      code    =&gt; sub { 0 },
      capture =&gt; $defaul_capture,
   &#41;-&gt;get;

ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;WIFEXITED&#40;$exitcode&#41; after sub { 0 }&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 0,     &#39;WEXITSTATUS&#40;$exitcode&#41; after sub { 0 }&#39; &#41;;
is&#40; $stdout, &#34;&#34;,             &#39;$stdout after sub { 0 }&#39; &#41;;
is&#40; $stderr, &#34;&#34;,             &#39;$stderr after sub { 0 }&#39; &#41;;


&#40; $exitcode, $stdout, $stderr &#41;
   = $loop-&gt;run_process&#40;
      code    =&gt; sub { 3 },
      capture =&gt; $defaul_capture,
   &#41;-&gt;get;

ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;WIFEXITED&#40;$exitcode&#41; after sub { 3 }&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 3,     &#39;WEXITSTATUS&#40;$exitcode&#41; after sub { 3 }&#39; &#41;;
is&#40; $stdout, &#34;&#34;,             &#39;$stdout after sub { 3 }&#39; &#41;;
is&#40; $stderr, &#34;&#34;,             &#39;$stderr after sub { 3 }&#39; &#41;;

&#40; $exitcode, $stdout, $stderr &#41;
   = $loop-&gt;run_process&#40;
      command =&gt; [ $^X, &#34;-e&#34;, &#39;1&#39; ],
      capture =&gt; $defaul_capture,
   &#41;-&gt;get;

ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;WIFEXITED&#40;$exitcode&#41; after perl -e 1&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 0,     &#39;WEXITSTATUS&#40;$exitcode&#41; after perl -e 1&#39; &#41;;
is&#40; $stdout, &#34;&#34;,             &#39;$stdout after perl -e 1&#39; &#41;;
is&#40; $stderr, &#34;&#34;,             &#39;$stderr after perl -e 1&#39; &#41;;

&#40; $exitcode, $stdout, $stderr &#41;
   = $loop-&gt;run_process&#40;
      command =&gt; [ $^X, &#34;-e&#34;, &#39;exit 5&#39; ],
      capture =&gt; $defaul_capture,
   &#41;-&gt;get;


ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;WIFEXITED&#40;$exitcode&#41; after perl -e exit 5&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 5,     &#39;WEXITSTATUS&#40;$exitcode&#41; after perl -e exit 5&#39; &#41;;
is&#40; $stdout, &#34;&#34;,             &#39;$stdout after perl -e exit 5&#39; &#41;;
is&#40; $stderr, &#34;&#34;,             &#39;$stderr after perl -e exit 5&#39; &#41;;

&#40; $exitcode, $stdout, $stderr &#41;
   = $loop-&gt;run_process&#40;
      code    =&gt; sub { print &#34;hello\n&#34;; 0 },
      capture =&gt; $defaul_capture,
   &#41;-&gt;get;

ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;WIFEXITED&#40;$exitcode&#41; after sub { print }&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 0,     &#39;WEXITSTATUS&#40;$exitcode&#41; after sub { print }&#39; &#41;;
is&#40; $stdout, &#34;hello\n&#34;,      &#39;$stdout after sub { print }&#39; &#41;;
is&#40; $stderr, &#34;&#34;,             &#39;$stderr after sub { print }&#39; &#41;;


&#40; $exitcode, $stdout, $stderr &#41;
   = $loop-&gt;run_process&#40;
      command =&gt; [ $^X, &#34;-e&#34;, &#39;print &#34;goodbye\n&#34;&#39; ],
      capture =&gt; $defaul_capture,
   &#41;-&gt;get;

ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;WIFEXITED&#40;$exitcode&#41; after perl STDOUT&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 0,     &#39;WEXITSTATUS&#40;$exitcode&#41; after perl STDOUT&#39; &#41;;
is&#40; $stdout, &#34;goodbye\n&#34;,    &#39;$stdout after perl STDOUT&#39; &#41;;
is&#40; $stderr, &#34;&#34;,             &#39;$stderr after perl STDOUT&#39; &#41;;

&#40; $exitcode, $stdout, $stderr &#41;
   = $loop-&gt;run_process&#40;
      command =&gt; [ $^X, &#34;-e&#34;, &#39;print STDOUT &#34;output\n&#34;; print STDERR &#34;error\n&#34;;&#39; ],
      capture =&gt; $defaul_capture,
   &#41;-&gt;get;

ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;WIFEXITED&#40;$exitcode&#41; after perl STDOUT/STDERR&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 0,     &#39;WEXITSTATUS&#40;$exitcode&#41; after perl STDOUT/STDERR&#39; &#41;;
is&#40; $stdout, &#34;output\n&#34;,     &#39;$stdout after perl STDOUT/STDERR&#39; &#41;;
is&#40; $stderr, &#34;error\n&#34;,      &#39;$stderr after perl STDOUT/STDERR&#39; &#41;;

# perl -pe 1 behaves like cat; copies STDIN to STDOUT

&#40; $exitcode, $stdout, $stderr &#41;
   = $loop-&gt;run_process&#40;
      command =&gt; [ $^X, &#34;-pe&#34;, &#39;1&#39; ],
      stdin   =&gt; &#34;some data\n&#34;,
      capture =&gt; $defaul_capture,
   &#41;-&gt;get;

ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;WIFEXITED&#40;$exitcode&#41; after perl STDIN-&gt;STDOUT&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 0,     &#39;WEXITSTATUS&#40;$exitcode&#41; after perl STDIN-&gt;STDOUT&#39; &#41;;
is&#40; $stdout, &#34;some data\n&#34;,  &#39;$stdout after perl STDIN-&gt;STDOUT&#39; &#41;;
is&#40; $stderr, &#34;&#34;,             &#39;$stderr after perl STDIN-&gt;STDOUT&#39; &#41;;

# Testing what the future will return by default
my &#40; $future, $proc, $pid &#41;;

$future = $loop-&gt;run_process&#40;
      command =&gt; [ $^X, &#34;-e&#34;, &#39;print STDOUT &#34;output&#34;; print STDERR &#34;error&#34;;&#39; ],
   &#41;;

&#40; $exitcode, $stdout &#41; = $future-&gt;get;

ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;Exit code is correct with default captures&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 0,     &#39;Exit code is correct with default captures&#39; &#41;;
is&#40; $stdout, &#34;output&#34;,       &#39;STDOUT is correct with default captures&#39; &#41;;


# Testing what the future will return with additional captures
&#40; $future, $proc &#41;
   = $loop-&gt;run_process&#40;
      command =&gt; [ $^X, &#34;-e&#34;, &#39;print STDOUT &#34;output&#34;; print STDERR &#34;error&#34;;&#39; ],
      capture =&gt; [qw&#40;pid exitcode stdout stderr&#41;],
   &#41;;


&#40; $pid, $exitcode, $stdout, $stderr &#41; = $future-&gt;get;

my $expected = $proc-&gt;pid;
is&#40; $expected, $pid,        &#39;PID is correct with default captures&#39; &#41;;
ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;Exit code is correct with custom captures&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 0,     &#39;Exit code is correct with custom captures&#39; &#41;;
is&#40; $stdout, &#34;output&#34;,       &#39;STDOUT is correct with custom captures&#39; &#41;;
is&#40; $stderr, &#34;error&#34;,        &#39;STDERR is correct with custom captures&#39; &#41;;

ok&#40; exception { $loop-&gt;run_process&#40;
         command =&gt; [ $^X, &#34;-e&#34;, 1 ],
         some_key_you_fail =&gt; 1
      &#41; },
   &#39;unrecognised key fails&#39;
&#41;;


# Testing what the future will return with additional captures in reverse order
&#40; $future, $proc &#41;
   = $loop-&gt;run_process&#40;
      command =&gt; [ $^X, &#34;-e&#34;, &#39;print STDOUT &#34;output&#34;; print STDERR &#34;error&#34;;&#39; ],
      capture =&gt; [qw&#40;stderr stdout exitcode pid&#41;],
   &#41;;

&#40; $stderr, $stdout, $exitcode, $pid &#41; = $future-&gt;get;

is&#40; $proc-&gt;pid, $pid,        &#39;PID is correct with reversed captures&#39; &#41;;
ok&#40; &#40;$exitcode &#38; 0x7f&#41; == 0, &#39;Exit code is correct with reversed captures&#39; &#41;;
is&#40; &#40;$exitcode &gt;&gt; 8&#41;, 0,     &#39;Exit code is correct with reversed captures&#39; &#41;;
is&#40; $stdout, &#34;output&#34;,       &#39;STDOUT is correct with reversed captures&#39; &#41;;
is&#40; $stderr, &#34;error&#34;,        &#39;STDERR is correct with reversed captures&#39; &#41;;

# Testing error handling
ok&#40; exception { $loop-&gt;run_process&#40;
         command =&gt; [ $^X, &#34;-e&#34;, 1 ],
         some_key_you_fail =&gt; 1
      &#41; },
   &#39;unrecognised key fails&#39;
&#41;;

ok&#40; exception { $loop-&gt;run_process&#40;
         command =&gt; [ $^X, &#34;-e&#34;, 1 ],
         capture =&gt; &#39;pid&#39;
      &#41; },
   &#39;Capture in invapid format&#39;
&#41;;

ok&#40; exception { $loop-&gt;run_process&#40;
         command =&gt; [ $^X, &#34;-e&#34;, 1 ],
         capture =&gt; [&#39;invalid_capture&#39;]
      &#41; },
   &#39;Invalid capture type&#39;
&#41;;

ok&#40; exception { $loop-&gt;run_process&#40;
         command =&gt; [ $^X, &#34;-e&#34;, 1 ],
         on_finish =&gt; sub{ 0 }
      &#41; },
   &#39;Failing when finish callback is passed&#39;
&#41;;

done_testing;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch_lib_IO_Async_Loop_v2.pm</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">1242a1243
&gt; my @process_captures = qw&#40;pid exitcode stdout stderr&#41;;
1250a1252,1314
&gt;    $params{capture} = \@process_captures;
&gt;    
&gt;    my &#40; $future, $process &#41; = $self-&gt;run_process&#40;%params&#41;;
&gt; 
&gt;    $future-&gt;on_ready&#40;sub { $on_finish-&gt;&#40;$future-&gt;get&#41;; undef $future }&#41;;
&gt; 
&gt;    return $process-&gt;pid;
&gt; }
&gt; 
&gt; 
&gt; =head2 run_process
&gt; 
&gt;    $future = $loop-&gt;run_process&#40; %params &#41;
&gt; 
&gt; This creates a new child process to run the given code block or command,
&gt; capturing its STDOUT and STDERR streams. The method returns in scalar context
&gt; future or in list context - future and process object. When the process
&gt; exits, the future will be resolved. The Future will return C&lt;exitcode&gt; and
&gt; captured C&lt;stdout&gt; by default.
&gt; 
&gt; =over 8
&gt; 
&gt; =item command =&gt; ARRAY or STRING
&gt; 
&gt; =item code =&gt; CODE
&gt; 
&gt; The command or code to run in the child process &#40;as per the C&lt;spawn_child&gt;
&gt; method&#41;
&gt; 
&gt; 
&gt; =item capture =&gt; ARRAY
&gt; Optional, the list of value&#39;s names which should be returned by resolving future.
&gt; Values will be returned in the same order as you put them in the array.
&gt; It can contain next values: C&lt;pid&gt;, C&lt;exitcode&gt;, C&lt;stdout&gt;, C&lt;stderr&gt;
&gt; 
&gt; =item stdin =&gt; STRING
&gt; 
&gt; Optional. String to pass in to the child process&#39;s STDIN stream.
&gt; 
&gt; =item setup =&gt; ARRAY
&gt; 
&gt; Optional reference to an array to pass to the underlying C&lt;spawn&gt; method.
&gt; 
&gt; =back
&gt; 
&gt; This method is just a shortcut for run_child method.
&gt; 
&gt; 
&gt; my &#40;$future, $pid&#41; = $loop-&gt;run_process&#40;command =&gt; &#34;command here&#34;&#41;;
&gt; 
&gt; my &#40;$exitcode, $stdout&#41; = $future-&gt;get;
&gt; 
&gt; Z&lt;&gt;
&gt; 
&gt; my &#40;$exitcode, $stdout&#41; = $loop-&gt;run_process&#40;command =&gt; &#34;command here&#34;&#41;-&gt;get&#40;&#41;;
&gt; 
&gt; =cut
&gt; 
&gt; sub run_process
&gt; {
&gt;    my $self = shift;
&gt;    my %params = @_;
&gt; 
1264a1329,1336
&gt; 
&gt;    my $capture = delete $params{capture} // [qw&#40;exitcode stdout&#41;];
&gt;    ref $capture eq ref [] or croak &#34;Expected &#39;capture&#39; to be an array reference&#34;;
&gt; 
&gt;    for my $name &#40; @$capture &#41; {
&gt;       grep { $_ eq $name } @process_captures or croak &#34;Unexpected capture $name&#34;;
&gt;    }
&gt; 
1267,1268c1339,1341
&lt;    require IO::Async::Process;
&lt;    my $process = IO::Async::Process-&gt;new&#40;
---
&gt;    my $future = $self-&gt;new_future;
&gt; 
&gt;    my $process = $self-&gt;open_process&#40;
1274,1275c1347,1351
&lt;          my &#40; $process, $exitcode &#41; = @_;
&lt;          $on_finish-&gt;&#40; $process-&gt;pid, $exitcode, $stdout, $stderr &#41;;
---
&gt;          my &#40; $proc, $exitcode &#41; = @_;
&gt;          my %results;
&gt;          @results{ @process_captures } = &#40; $proc-&gt;pid, $exitcode, $stdout, $stderr &#41;;
&gt; 
&gt;          $future-&gt;done&#40; @results{ @$capture } &#41;;
1281c1357
&lt;    return $process-&gt;pid;
---
&gt;    return wantarray ? &#40; $future, $process &#41; : $future;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;16&nbsp;18:19:41&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Sorry I&#39;ve not got around to giving a proper review/reply of this yet. Been quite busy with some non-perl things of late. I&#39;ll try to make some time either tomorrow or at the weekend though, as this is definitely the sort of thing I&#39;d like to get added.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;10&nbsp;17:45:15&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Having had a look over this, two things come to mind:

1&#41; The patch isn&#39;t in unified diff form, the result you&#39;d get from `diff -u` - can you resend it in that format?

2&#41; I don&#39;t think the method ought to be sensitive to `wantarray` and yield a two-element result in list context, because it would confuse such code as:

  Future-&gt;wait_any&#40;
    $loop-&gt;timeout_future&#40; after =&gt; 10 &#41;,
    $loop-&gt;run_process&#40; ... &#41;,
  &#41;

Thinking further, I can&#39;t see many situations where you&#39;d even need the PID anyhow, so maybe best not to provide that for now. If later a use-case emerges then perhaps a new method with a new name to return that as a two-element list, and this one can become a small wrapper for it.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;12&nbsp;11:11:55&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached patch makes an initial attempt at this. I started with your given code and tests from the first patch, and adjusted it somewhat.

This adds a method

  $f = $loop-&gt;run_process&#40;...&#41;

which doesn&#39;t have the option to return the PID, nor does it allow capturing the PID. I currently don&#39;t think it&#39;s useful to be able to see what the PID of the process had been, because by now it has already exited.

Some features still to think about:

 * Should it `kill&#40;&#41;` the process with a specified signal on `$f-&gt;cancel`?

 * Should it `$f-&gt;fail` on non-zero exit code?

These can both be added in a later version.

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt129225.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== modified file &#39;lib/IO/Async/Loop.pm&#39;
--- lib/IO/Async/Loop.pm	2019-04-18 13:09:41 +0000
+++ lib/IO/Async/Loop.pm	2019-06-12 15:05:59 +0000
@@ -1281,6 +1281,66 @@
    return $process-&gt;pid;
 }
 
+=head2 run_process
+
+   @results = $loop-&gt;run_process&#40; %params &#41;-&gt;get
+
+   &#40; $exitcode, $stdout &#41; = $loop-&gt;run_process&#40; ... &#41;-&gt;get  # by default
+
+I&lt;Since version 0.73.&gt;
+
+Creates a new child process to run the given code block or command, optionally
+capturing its STDOUT and STDERR streams. By default the returned future will
+yield the exit code and content of the STDOUT stream, but the C&lt;capture&gt;
+argument can be used to alter what is requested and returned.
+
+The method is a wrapper of L&lt;/run_child&gt; and accepts the same parameters,
+except C&lt;on_finish&gt;.
+
+Additionally, takes the following named arguments:
+
+=over 8
+
+=item capture =&gt; ARRAY
+
+Optional, a list of names which should be returned by resolving future. Values
+will be returned in the same order as in the list. Valid choices are:
+C&lt;exitcode&gt;, C&lt;stdout&gt;, C&lt;stderr&gt;.
+
+=back
+
+=cut
+
+my @process_captures = qw&#40;exitcode stdout stderr&#41;;
+
+sub run_process
+{
+   my $self = shift;
+   my %params = @_;
+
+   $params{on_finish} and croak &#34;Unrecognised parameter on_finish&#34;;
+
+   my $capture = delete $params{capture} // [qw&#40;exitcode stdout&#41;];
+   ref $capture eq &#34;ARRAY&#34; or croak &#34;Expected &#39;capture&#39; to be an array reference&#34;;
+
+   foreach my $name &#40; @$capture &#41; {
+      grep { $_ eq $name } @process_captures or croak &#34;Unexpected capture $name&#34;;
+   }
+
+   my $future = $self-&gt;new_future;
+   my $pid = $self-&gt;run_child&#40;
+      %params,
+      on_finish =&gt; sub {
+         my %results;
+         @results{qw&#40; pid exitcode stdout stderr &#41;} = @_;
+
+         $future-&gt;done&#40; @results{ @$capture } &#41;;
+      },
+   &#41;;
+
+   return $future;
+}
+
 =head2 resolver
 
    $loop-&gt;resolver

=== added file &#39;t/39loop-runproccess.t&#39;
--- t/39loop-runproccess.t	1970-01-01 00:00:00 +0000
+++ t/39loop-runproccess.t	2019-06-12 15:05:59 +0000
@@ -0,0 +1,131 @@
+#!/usr/bin/perl
+
+use strict;
+use warnings;
+
+use IO::Async::Test;
+
+use Test::More;
+use Test::Fatal;
+
+use IO::Async::Loop;
+use IO::Async::OS;
+
+plan skip_all =&gt; &#34;POSIX fork&#40;&#41; is not available&#34; unless IO::Async::OS-&gt;HAVE_POSIX_FORK;
+
+my $loop = IO::Async::Loop-&gt;new_builtin;
+testing_loop&#40; $loop &#41;;
+
+# run_process capture exitcode
+{
+   my $f;
+
+   $f = $loop-&gt;run_process&#40;
+      code    =&gt; sub { 3 },
+      capture =&gt; [qw&#40; exitcode &#41;],
+   &#41;;
+   is_deeply&#40; [ $f-&gt;get ], [ 3 &lt;&lt; 8 ],
+      &#39;$f-&gt;get from code gives exitcode&#39; &#41;;
+
+   $f = $loop-&gt;run_process&#40;
+      command =&gt; [ $^X, &#34;-e&#34;, &#39;exit 5&#39; ],
+      capture =&gt; [qw&#40; exitcode &#41;],
+   &#41;;
+   is_deeply&#40; [ $f-&gt;get ], [ 5 &lt;&lt; 8 ],
+      &#39;$f-&gt;get from command gives exitcode&#39; &#41;;
+}
+
+# run_process capture stdout
+{
+   my $f;
+
+   $f = $loop-&gt;run_process&#40;
+      code    =&gt; sub { print &#34;hello\n&#34;; 0 },
+      capture =&gt; [qw&#40; stdout &#41;],
+   &#41;;
+   is_deeply&#40; [ $f-&gt;get ], [ &#34;hello\n&#34; ],
+      &#39;$f-&gt;get from code gives stdout&#39; &#41;;
+
+   $f = $loop-&gt;run_process&#40;
+      command =&gt; [ $^X, &#34;-e&#34;, &#39;print &#34;goodbye\n&#34;&#39; ],
+      capture =&gt; [qw&#40; stdout &#41;],
+   &#41;;
+   is_deeply&#40; [ $f-&gt;get ], [ &#34;goodbye\n&#34; ],
+      &#39;$f-&gt;get from command gives stdout&#39; &#41;;
+}
+
+# run_process capture stdout and stderr
+{
+   my $f;
+
+   $f = $loop-&gt;run_process&#40;
+      command =&gt; [ $^X, &#34;-e&#34;, &#39;print STDOUT &#34;output\n&#34;; print STDERR &#34;error\n&#34;;&#39; ],
+      capture =&gt; [qw&#40; stdout stderr &#41;],
+   &#41;;
+   is_deeply&#40; [ $f-&gt;get ], [ &#34;output\n&#34;, &#34;error\n&#34; ],
+      &#39;$f-&gt;get from command gives stdout and stderr&#39; &#41;;
+}
+
+# run_process sending stdin
+{
+   my $f;
+
+   # perl -pe 1 behaves like cat; copies STDIN to STDOUT
+   $f = $loop-&gt;run_process&#40;
+      command =&gt; [ $^X, &#34;-pe&#34;, &#39;1&#39; ],
+      stdin   =&gt; &#34;some data\n&#34;,
+      capture =&gt; [qw&#40; stdout &#41;],
+   &#41;;
+   is_deeply&#40; [ $f-&gt;get ], [ &#34;some data\n&#34; ],
+      &#39;$f-&gt;get from command given stdin gives stdout&#39; &#41;;
+}
+
+# run_process default capture
+{
+   my $f = $loop-&gt;run_process&#40;
+      command =&gt; [ $^X, &#34;-e&#34;, &#39;print STDOUT &#34;output&#34;; print STDERR &#34;error&#34;;&#39; ],
+   &#41;;
+   is_deeply&#40; [ $f-&gt;get ], [ 0, &#34;output&#34; ],
+      &#39;$f-&gt;get from command with default capture&#39; &#41;;
+}
+
+# run_process captures in weird order
+{
+   my $f = $loop-&gt;run_process&#40;
+      command =&gt; [ $^X, &#34;-e&#34;, &#39;print STDOUT &#34;output&#34;; print STDERR &#34;error&#34;;&#39; ],
+      capture =&gt; [qw&#40;stderr exitcode stdout&#41;],
+   &#41;;
+   is_deeply&#40; [ $f-&gt;get ], [ &#34;error&#34;, 0, &#34;output&#34; ],
+      &#39;$f-&gt;get from command with all captures&#39; &#41;;
+}
+
+# Testing error handling
+ok&#40; exception { $loop-&gt;run_process&#40;
+         command =&gt; [ $^X, &#34;-e&#34;, 1 ],
+         some_key_you_fail =&gt; 1
+      &#41; },
+   &#39;unrecognised key fails&#39;
+&#41;;
+
+ok&#40; exception { $loop-&gt;run_process&#40;
+         command =&gt; [ $^X, &#34;-e&#34;, 1 ],
+         capture =&gt; &#39;pid&#39;
+      &#41; },
+   &#39;Capture in capture format&#39;
+&#41;;
+
+ok&#40; exception { $loop-&gt;run_process&#40;
+         command =&gt; [ $^X, &#34;-e&#34;, 1 ],
+         capture =&gt; [&#39;invalid_capture&#39;]
+      &#41; },
+   &#39;Invalid capture type&#39;
+&#41;;
+
+ok&#40; exception { $loop-&gt;run_process&#40;
+         command =&gt; [ $^X, &#34;-e&#34;, 1 ],
+         on_finish =&gt; sub{ 0 }
+      &#41; },
+   &#39;Failing when finish callback is passed&#39;
+&#41;;
+
+done_testing;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;12&nbsp;11:11:55&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;23&nbsp;12:49:32&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This was released in 0.73

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;23&nbsp;12:49:32&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;23&nbsp;12:49:33&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Fixed in 0.73 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
