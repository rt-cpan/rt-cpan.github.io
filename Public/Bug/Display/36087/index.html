<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #36087 for Storable: segfaults when called during global destruction</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #36087 for Storable: segfaults when called during global destruction</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Storable/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Storable/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Storable/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Storable/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="http://rt.perl.org/perlbug/">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Storable">Storable CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">36087</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Storable/Active/">Storable</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dom [...] cpan.org

<br />
martin.ferrari [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-29856-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
2.13</li>
<li>
2.15</li>
<li>
2.18</li>
</ul>
    </td>
  </tr>
  <tr id="CF-29857-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;21&nbsp;22:59:43&nbsp;2008</span>
    <span class="description">martin.ferrari [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> segfaults when called during global destruction</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is apparently an old problem that went under the radar. It was
already reported in May, 2005 in
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.mail-archive.com/perl5-porters@perl.org/msg86928.html">http://www.mail-archive.com/perl5-porters@perl.org/msg86928.html</a></span>, but
nobody could reproduce it at the time. Also it was discussed on
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=651966">http://www.perlmonks.org/?node_id=651966</a></span>.

I have tried the attached test in at least 4 different architectures
&#40;i386, ia64, armel and sparc64&#41; in Debian, and also tried FreeBSD,
RedHat, Mandriva and Gentoo. In every try, I got a segfault like this:


$ perl test.pl 
Destroying Foo=HASH&#40;0x6000000000009630&#41;, bar=baz at test.pl line 17
during global destruction.
Segmentation fault

$ uname -a
Linux merulo 2.6.18-dsa-mckinley #1 SMP Mon Feb 11 09:57:09 MST 2008
ia64 GNU/Linux

This seems to be the cause of -at least-
<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=315669">http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=315669</a></span> 

Thanks.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use warnings;

our $a = new Foo&#40;&#41;;
$a-&gt;{bar} = &#34;baz&#34;;

package Foo;
use Storable;

sub new {
	return bless&#40;{}, &#34;Foo&#34;&#41;;
}
sub DESTROY {
	my $this = shift;
	warn &#34;Destroying $this, bar=$this-&gt;{bar}&#34;;
	my $f = Storable::freeze&#40;$this&#41;;
}

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;20&nbsp;13:14:58&nbsp;2010</span>
    <span class="description">avar [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> perl5-porters [...] perl.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The testcase, for reference:
    
    #!/usr/bin/perl
    
    use strict;
    use warnings;
    
    our $a = new Foo&#40;&#41;;
    $a-&gt;{bar} = &#34;baz&#34;;
    
    package Foo;
    use Storable;
    
    sub new {
    return bless&#40;{}, &#34;Foo&#34;&#41;;
    }
    sub DESTROY {
    my $this = shift;
    warn &#34;Destroying $this, bar=$this-&gt;{bar}&#34;;
    my $f = Storable::freeze&#40;$this&#41;;
    }

Here&#39;s a workaround that Git instated due to this issue:
<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/git/git/commit/8ac3a667">http://github.com/git/git/commit/8ac3a667</a></span>

I investigated it a bit, it&#39;s segfaulting at the very start of 
do_store&#40;&#41;:
        
    here  ==&gt; dSTCXT;
                  int status;

When I manually expand that macro it ends up being:
    
    {
        SV *perinterp_sv = *hv_fetch&#40;PL_modglobal,
                                     MY_VERSION, sizeof&#40;MY_VERSION&#41;-1, 
TRUE&#41;;
        stcxt_t * cxt;
        if &#40;perinterp_sv &#38;&#38; SvIOK&#40;perinterp_sv&#41; &#38;&#38; SvIVX&#40;perinterp_sv&#41;&#41; 
{
            IV x = SvIVX&#40;perinterp_sv&#41;;
            void* ptr = INT2PTR&#40;SV*,x&#41;;
            SV* rv = SvRV&#40;ptr&#41;;
    =&gt;      cxt = &#40;stcxt_t *&#41;SvPVX&#40;rv&#41;;
        } else {
            cxt = &#40;stcxt_t *&#41; 0;
        }
        int status;

ptr is an OK scalar, but its RV slot is NULL. Even if that call hadn&#39;t
failed and cxt was set to 0 it would still segfault later in the
function, e.g. here:

    if &#40;cxt-&gt;s_dirty&#41;
        clean_context&#40;aTHX_ cxt&#41;;

The problem is seemingly that Storable is looking at its own context
during global destruction, but when it gets around to it perl has
already started freeing the variables that it depends on.

Looking at anything during global destruction is dangerous. Storable
should either be fixed to hook into destruction earlier, or this
limitation documented. Maybe there&#39;s also a workaround I haven&#39;t
spotted.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;20&nbsp;13:14:58&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;21&nbsp;09:57:52&nbsp;2010</span>
    <span class="description">twists [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> perl5-porters [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #36087] segfaults when called during global  destruction</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 21 Jul 2010 06:57:41 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Storable [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Joshua ben Jore &lt;twists [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Jul 20, 2010 at 10:14 AM, AEvar Arnfjord Bjarmason via RT
&lt;bug-Storable@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=36087">https://rt.cpan.org/Ticket/Display.html?id=36087</a></span> &gt;
&gt;
&gt; The testcase, for reference:
&gt;
&gt;    #!/usr/bin/perl
&gt;
&gt;    use strict;
&gt;    use warnings;
&gt;
&gt;    our $a = new Foo&#40;&#41;;
&gt;    $a-&gt;{bar} = &#34;baz&#34;;
&gt;
&gt;    package Foo;
&gt;    use Storable;
&gt;
&gt;    sub new {
&gt;    return bless&#40;{}, &#34;Foo&#34;&#41;;
&gt;    }
&gt;    sub DESTROY {
&gt;    my $this = shift;
&gt;    warn &#34;Destroying $this, bar=$this-&gt;{bar}&#34;;
&gt;    my $f = Storable::freeze&#40;$this&#41;;
&gt;    }
&gt;
&gt; Here&#39;s a workaround that Git instated due to this issue:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/git/git/commit/8ac3a667">http://github.com/git/git/commit/8ac3a667</a></span>
&gt;
&gt; I investigated it a bit, it&#39;s segfaulting at the very start of
&gt; do_store&#40;&#41;:
&gt;
&gt;    here  ==&gt; dSTCXT;
&gt;                  int status;
&gt;
&gt; When I manually expand that macro it ends up being:
&gt;
&gt;    {
&gt;        SV *perinterp_sv = *hv_fetch&#40;PL_modglobal,
&gt;                                     MY_VERSION, sizeof&#40;MY_VERSION&#41;-1,
&gt; TRUE&#41;;
&gt;        stcxt_t * cxt;
&gt;        if &#40;perinterp_sv &#38;&#38; SvIOK&#40;perinterp_sv&#41; &#38;&#38; SvIVX&#40;perinterp_sv&#41;&#41;
&gt; {
&gt;            IV x = SvIVX&#40;perinterp_sv&#41;;
&gt;            void* ptr = INT2PTR&#40;SV*,x&#41;;
&gt;            SV* rv = SvRV&#40;ptr&#41;;
&gt;    =&gt;      cxt = &#40;stcxt_t *&#41;SvPVX&#40;rv&#41;;
&gt;        } else {
&gt;            cxt = &#40;stcxt_t *&#41; 0;
&gt;        }
&gt;        int status;
&gt;
&gt; ptr is an OK scalar, but its RV slot is NULL. Even if that call hadn&#39;t
&gt; failed and cxt was set to 0 it would still segfault later in the
&gt; function, e.g. here:
&gt;
&gt;    if &#40;cxt-&gt;s_dirty&#41;
&gt;        clean_context&#40;aTHX_ cxt&#41;;
&gt;
&gt; The problem is seemingly that Storable is looking at its own context
&gt; during global destruction, but when it gets around to it perl has
&gt; already started freeing the variables that it depends on.
&gt;
&gt; Looking at anything during global destruction is dangerous. Storable
&gt; should either be fixed to hook into destruction earlier, or this
&gt; limitation documented. Maybe there&#39;s also a workaround I haven&#39;t
&gt; spotted.
</div>
The problem as you described on IRC is that your Foo object is
destroyed after Storable&#39;s object. There&#39;s relatively little that can
be done with that under the current implementation which is that
-&gt;DESTROY calls have no promised order between objects. We could
possibly however alter Storable&#39;s usage of its global object in
$Storable::Cxt so it can be re-created when needed even during global
destruction.

Josh
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;01&nbsp;08:53:52&nbsp;2012</span>
    <span class="description">dom [...] cpan.org -  Requestor DOM added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;30&nbsp;19:02:30&nbsp;2016</span>
    <span class="description">dom [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This appears &#40;as far as running test.pl is concerned&#41; to have been fixed somewhere between perl 5.14.3 and perl 5.20.1 &#40;ie Storable 2.27 and 2.49&#41;.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
