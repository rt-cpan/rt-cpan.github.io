<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #25073 for Ima-DBI: [PATCH] Don&#39;t return an active statement handle</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #25073 for Ima-DBI: [PATCH] Don&#39;t return an active statement handle</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Ima-DBI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Ima-DBI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Ima-DBI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Ima-DBI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Ima-DBI">Ima-DBI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">25073</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Ima-DBI/Active/">Ima-DBI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mschwern [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
perl-cpan [...] bereft.net

<br />
Dan [...] DWright.Org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-16574-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-16575-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;21&nbsp;20:17:29&nbsp;2007</span>
    <span class="description">mschwern [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] Don&#39;t return an active statement handle</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ima::DBI uses DBI-&gt;prepare_cached&#40;&#41;.  By default the cache is stupid, it
will return an active statement handle.  This is bad if you do something
like...

    my $sth = $obj-&gt;sql_foo;
    $sth-&gt;execute&#40;&#34;foo&#34;&#41;;

    my $another_sth = $different_obj_same_class-&gt;sql_foo;
    $another_sth-&gt;execute&#40;&#34;bar&#34;&#41;;

Currently both calls to sql_foo&#40;&#41; will return the same statement handle.
 DBI will warn but its very dangerous.

Recently &#40;in DBI 1.40&#41; DBI introduced an extra parameter to
prepare_cached&#40;&#41;.  If you set it to 3 &#40;yeah, intuitive&#41; it will Do The
Right Thing which is rather than returning an active statement handle
from the cache it will make a new one.  This makes prepare_cached&#40;&#41; much
safer.

This patch changes Ima::DBI to use that new feature.  It requires
raising the minimum DBI to 1.40.  If that&#39;s undesirable I can make it
optional.

This is required for the CDBI iterator patch in 24959.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> no_cache_if_active.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Auto-merging &#40;0, 27456&#41; /local/Ima-DBI to /vendor/Ima-DBI &#40;base /vendor/Ima-DBI:27454&#41;.
A   t/active_handles.t
U   MANIFEST
U   lib/Ima/DBI.pm
U   Makefile.PL
==== Patch &lt;-&gt; level 1
Source: 9c88509d-e914-0410-b01c-b9530614cbfe:/local/Ima-DBI:27456
Target: 9c88509d-e914-0410-b01c-b9530614cbfe:/vendor/Ima-DBI:27454
Log:
 r27455@windhund:  schwern | 2007-02-21 16:57:36 -0800
 Local copy
 r27456@windhund:  schwern | 2007-02-21 17:11:00 -0800
 Make Ima::DBI use the new &#34;$if_active&#34; parameter to prepare_cached&#40;&#41; to
 avoid returning an active statement handle from the cache.

=== t/active_handles.t
==================================================================
--- t/active_handles.t	&#40;revision 27454&#41;
+++ t/active_handles.t	&#40;patch - level 1&#41;
@@ -0,0 +1,30 @@
+#!/usr/bin/perl -w
+
+package My::DBI;
+
+use strict;
+use base &#39;Ima::DBI&#39;;
+
+use Cwd;
+use Test::More tests =&gt; 4;
+use Test::NoWarnings;
+
+sub new { return bless {}; }
+
+# Test set_db
+__PACKAGE__-&gt;set_db&#40;&#39;test1&#39;, &#39;dbi:ExampleP:&#39;, &#39;&#39;, &#39;&#39;,
+	{ AutoCommit =&gt; 1, Taint =&gt; 0 }&#41;;
+
+__PACKAGE__-&gt;set_sql&#40;&#39;test&#39;, &#39;select mode,size,name from ?&#39;, &#39;test1&#39;&#41;;
+
+my $obj = My::DBI-&gt;new;
+
+my $sth1 = $obj-&gt;sql_test;
+$sth1-&gt;execute&#40;cwd&#41;;
+ok $sth1-&gt;{Active};
+
+my $sth2 = $obj-&gt;sql_test;
+$sth2-&gt;execute&#40;cwd&#41;;
+ok $sth2-&gt;{Active};
+
+isnt $sth1, $sth2;
=== MANIFEST
==================================================================
--- MANIFEST	&#40;revision 27454&#41;
+++ MANIFEST	&#40;patch - level 1&#41;
@@ -6,5 +6,6 @@
 META.yml
 README
 t/DBI.t
+t/active_handles.t
 t/pod-coverage.t
 t/pod.t
=== lib/Ima/DBI.pm
==================================================================
--- lib/Ima/DBI.pm	&#40;revision 27454&#41;
+++ lib/Ima/DBI.pm	&#40;patch - level 1&#41;
@@ -379,7 +379,7 @@
 		# This is to do proper &#39;%%&#39; translation.
 		my $sql = $class-&gt;transform_sql&#40;$statement =&gt; @_&#41;;
 		return $cache
-			? $dbh-&gt;prepare_cached&#40;$sql&#41;
+			? $dbh-&gt;prepare_cached&#40;$sql, {}, 3&#41;
 			: $dbh-&gt;prepare&#40;$sql&#41;;
 	};
 }
=== Makefile.PL
==================================================================
--- Makefile.PL	&#40;revision 27454&#41;
+++ Makefile.PL	&#40;patch - level 1&#41;
@@ -17,10 +17,11 @@
 	NAME         =&gt; &#39;Ima::DBI&#39;,
 	VERSION_FROM =&gt; &#39;lib/Ima/DBI.pm&#39;,
 	PREREQ_PM    =&gt; {
-		&#39;DBI&#39;                      =&gt; 1.20,
+		&#39;DBI&#39;                      =&gt; 1.40,
 		&#39;Class::Data::Inheritable&#39; =&gt; 0.02,
 		&#39;DBIx::ContextualFetch&#39;    =&gt; 1.00,
 		&#39;Test::More&#39;               =&gt; 0.18,
+		&#39;Test::NoWarnings&#39;         =&gt; 0.08,
 	},
 	&#40;
 		$] &gt; 5.005

==== BEGIN SVK PATCH BLOCK ====
Version: svk v2.0.0 &#40;darwin&#41;

eJyNlc1u20YQx3VoEYRA0QcoUGxjBnYC09pdLj+NqHZiKXUTu0bjNkAvzHJ3ZLGmSIWk/BHTB8qO
g/TQQ4Dcihx6LHrpA/Rd8ihdUlEaJ86HIECr3Znfzuz+Z7aXbS+vkLLTwaVOcHnv5zu+v8ULMbhK
WKnbJcioSDPdKmPYg1g3yzjd0VmZ8CGo1TwdZ6IeFDzbgaIeRGIXik6HKJw7xXUbxAzbUENepEmu
ew0+KDIAnZTuileumPU30IlX5qBWGmyQwV6UR2miwqAOs2xlouyJ8k9HkARZmhavl2jtjUsRpzkE
NX7FKtVX2VNdpdQ4yCgDoWI6VLNFQ5p5N4ZsBu5HMehuubG6ud7r3tt+19K6AKmOKArfNXXPQQkp
N/gu1OOlrbvnrJv0rVcJvBkpUbmt2DXLVEFxKV+h3LJoc1FEexAMeCJjyJfqpGig09Ig7+fRKa9Z
5aNRfBgUcFBIiAte7xEEOmsUsdlqtU4v7U70f7pXn3a/rm7PnfTw87s//N3dft6rFiZrD56tVeu9
6pff1+BJt3p49mO1dNKrbqrJP5qFtbXJ50+/++rx7cnmWXdy72ztwaQ7GT7rTeLfvp/sVPcnWXX/
RKs2Tq6cqrmqd8Inc9+0x3nWDqOkPYIsRsa+po242OU7gDYOfX/t5vqypo1zQHmRRaJYDrkaz68P
+fytfbkNeeH7G2kGqFDDHN3oILaZ3udZEiU7ufLMxyFKYB8doQyKcZagUB1bjo6Ol9Gxps2hWnwy
1IJga/XWndXb3SAwOgvzZH4Rzcsw8rsHfDiKYcvXLh+h1XGR3kqHw6ggi2ibRwlGx9eWtfxhnEOs
ThsNUwmLefQIFuuyQf0sHaJvh4dIT8Nf0Q2jowLJiwGph8opWNaMDhyAGBewIPalQqW7Rudotbni
Y0pplCfF4rK2wt6U+lQLShomLSXzwDOpCE3eN2nomba0XdMKbelJLgirL95638WzmmCHfbCZUI7c
9fpm3wPMbJcCZYQ4NlNqtafKeFR98dn1lmj99bYCtaI9SqUh0j3I1K3NJtTvhXE3u1JG3RCwFJYA
DJQSh5pEOLjfN0F4XEzjVtb2BXXn1HXXVgpo6vKj1WS9hjnnK5PNOG0lsqXRsNnuozj7g2fqNNnZ
pE8YFq6koeU5DiYmDh0REiwZUE5181W1VS8G1YtUu9R6edB60vp39PJgUSlzEZkXnlzDxgAm8aRl
UtwnYArLtZjrgGsBc6QVuh+Mzq0JnDIBwDmXHCzLNRntYwaYmh4HZodEt8k0urPrZ1tfzrVOjVbV
2jtd+rNVaY8Ruzw/Lbr/q2wezT6q+vASvjD4ZmvMmWtyrORGQuxZQB1Hqr0ZCRmmQGTTHqlllSir
b8Fa2Y8SORgn0kcoF4N9UPVbIoqxY2BqUIKI7VuOb9rIwC7GGrqbCh4jkY4OtSnC/jjC8QnxMZ4h
6m6NlCia1oPqxlMMoGkhV/SoH0zVfwWNeKZKvIAMFSkaZaD+QyC4GIBcuKbmNMT30ki+6jrqmBBP
0NRZdTJewBCSAk2LaNoo6m0awJKmzsHodGipUzp9Wbeb59H3f0qUf5bz+Kp6Hlg54sVAPUPq1VR/
xuNI1qJux/Uh1Lo2VAYzQeumXXrCdS3sSQM8wgysmr4RYiKM0LNMbBMmVC/oXKPle+FW2d6DRKbZ
W3T2qXTdcj7Jzj+fhN+k8B9l28Pa
==== END SVK PATCH BLOCK ====
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;21&nbsp;20:58:59&nbsp;2007</span>
    <span class="description">mschwern [...] cpan.org -  Dependency by ticket #24959 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;21&nbsp;21:04:15&nbsp;2007</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This revised patch replaces the first one.  It also adds the ability to
pass in parameters to the sql_*&#40;&#41; methods.  It will be handy in the
future but right now this is needed to selectively turn off statement
handle caching.

This is needed for the new CDBI iterators, since they execute on demand
rather than on creation if they use prepare_cached&#40;&#41; they might both be
given the same statement.  So they need to override.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Auto-merging &#40;0, 27458&#41; /local/Ima-DBI to /vendor/Ima-DBI &#40;base /vendor/Ima-DBI:27454&#41;.
A   t/caching.t
U   MANIFEST
U   lib/Ima/DBI.pm
U   Makefile.PL
==== Patch &lt;-&gt; level 1
Source: 9c88509d-e914-0410-b01c-b9530614cbfe:/local/Ima-DBI:27458
Target: 9c88509d-e914-0410-b01c-b9530614cbfe:/vendor/Ima-DBI:27454
Log:
 r27455@windhund:  schwern | 2007-02-21 16:57:36 -0800
 Local copy
 r27456@windhund:  schwern | 2007-02-21 17:11:00 -0800
 Make Ima::DBI use the new &#34;$if_active&#34; parameter to prepare_cached&#40;&#41; to
 avoid returning an active statement handle from the cache.
 r27457@windhund:  schwern | 2007-02-21 17:53:47 -0800
 Rename the &#34;active_handles&#34; test to be &#34;caching&#34; because that&#39;s really what
 its about.
 r27458@windhund:  schwern | 2007-02-21 17:57:09 -0800
 Add a parameter argument to sql_* so we can override its behaviors.  Right
 now its the caching behavior.

=== t/caching.t
==================================================================
--- t/caching.t	&#40;revision 27454&#41;
+++ t/caching.t	&#40;patch - level 1&#41;
@@ -0,0 +1,52 @@
+#!/usr/bin/perl -w
+
+package My::DBI;
+
+use strict;
+use base &#39;Ima::DBI&#39;;
+
+use Cwd;
+use Test::More tests =&gt; 10;
+use Test::NoWarnings;
+
+sub new { return bless {}; }
+
+# Test set_db
+__PACKAGE__-&gt;set_db&#40;&#39;test1&#39;, &#39;dbi:ExampleP:&#39;, &#39;&#39;, &#39;&#39;,
+	{ AutoCommit =&gt; 1, Taint =&gt; 0 }&#41;;
+
+__PACKAGE__-&gt;set_sql&#40;&#39;test&#39;, &#39;select mode,size,name from ?&#39;, &#39;test1&#39;&#41;;
+
+my $obj = My::DBI-&gt;new;
+
+{
+    my $sth1 = $obj-&gt;sql_test;
+    $sth1-&gt;execute&#40;cwd&#41;;
+    ok $sth1-&gt;{Active};
+
+    my $sth2 = $obj-&gt;sql_test;
+    $sth2-&gt;execute&#40;cwd&#41;;
+    ok $sth2-&gt;{Active};
+
+    isnt $sth1, $sth2, &#34;Active statement handles are not cached&#34;;
+}
+
+{
+    my $sth1 = $obj-&gt;sql_test;
+    ok !$sth1-&gt;{Active};
+    
+    my $sth2 = $obj-&gt;sql_test;
+    ok !$sth2-&gt;{Active};
+    
+    is $sth1, $sth2, &#34;Inactive statement handles are cached&#34;;
+}
+
+{
+    my $sth1 = $obj-&gt;sql_test&#40;{ cache =&gt; 0 }&#41;;
+    ok !$sth1-&gt;{Active};
+    
+    my $sth2 = $obj-&gt;sql_test&#40;{ cache =&gt; 0 }&#41;;
+    ok !$sth2-&gt;{Active};
+    
+    isnt $sth1, $sth2, &#34;Override default caching behavior&#34;;
+}
\ No newline at end of file
=== MANIFEST
==================================================================
--- MANIFEST	&#40;revision 27454&#41;
+++ MANIFEST	&#40;patch - level 1&#41;
@@ -6,5 +6,6 @@
 META.yml
 README
 t/DBI.t
+t/caching.t
 t/pod-coverage.t
 t/pod.t
=== lib/Ima/DBI.pm
==================================================================
--- lib/Ima/DBI.pm	&#40;revision 27454&#41;
+++ lib/Ima/DBI.pm	&#40;patch - level 1&#41;
@@ -1,6 +1,6 @@
 package Ima::DBI;
 
-$VERSION = &#39;0.34&#39;;
+$VERSION = &#39;0.34_02&#39;;
 
 use strict;
 use base &#39;Class::Data::Inheritable&#39;;
@@ -369,17 +369,21 @@
 }
 
 sub _mk_sql_closure {
-	my &#40;$class, $sql_name, $statement, $db_meth, $cache&#41; = @_;
+	my &#40;$class, $sql_name, $statement, $db_meth, $cache_default&#41; = @_;
 
 	return sub {
 		my $class = shift;
 		my $dbh   = $class-&gt;$db_meth&#40;&#41;;
 
+		my $params = pop @_ if ref $_[-1] eq &#39;HASH&#39;;
+		my $cache = $cache_default;
+		$cache = $params-&gt;{cache} if defined $params-&gt;{cache};
+
 		# Everything must pass through sprintf, even if @_ is empty.
 		# This is to do proper &#39;%%&#39; translation.
 		my $sql = $class-&gt;transform_sql&#40;$statement =&gt; @_&#41;;
 		return $cache
-			? $dbh-&gt;prepare_cached&#40;$sql&#41;
+			? $dbh-&gt;prepare_cached&#40;$sql, {}, 3&#41;
 			: $dbh-&gt;prepare&#40;$sql&#41;;
 	};
 }
@@ -469,6 +473,7 @@
 
     $sth = $obj-&gt;sql_*;
     $sth = $obj-&gt;sql_*&#40;@sql_pieces&#41;;
+    $sth = $obj-&gt;sql_*&#40;@sql_pieces, \%params&#41;
 
 sql_*&#40;&#41; is a catch-all name for the methods you set up with set_sql&#40;&#41;.
 For instance, if you did:
@@ -492,6 +497,8 @@
     # statement &#39;Select * From Bar&#39;
     $sth = $obj-&gt;sql_Search&#40;&#39;Bar&#39;&#41;;
 
+The optional %params contains parameters to alter the behavior of the method.  Currently the only option is C&lt;cache&gt; which will override the default statement handle caching behavior for this method set when it was created with C&lt;set_sql&gt;.
+
 Be B&lt;very careful&gt; with what you feed this function.  It cannot
 do any quoting or escaping for you, so it is totally up to you
 to take care of that.  Fortunately if you have tainting on you
=== Makefile.PL
==================================================================
--- Makefile.PL	&#40;revision 27454&#41;
+++ Makefile.PL	&#40;patch - level 1&#41;
@@ -17,10 +17,11 @@
 	NAME         =&gt; &#39;Ima::DBI&#39;,
 	VERSION_FROM =&gt; &#39;lib/Ima/DBI.pm&#39;,
 	PREREQ_PM    =&gt; {
-		&#39;DBI&#39;                      =&gt; 1.20,
+		&#39;DBI&#39;                      =&gt; 1.40,
 		&#39;Class::Data::Inheritable&#39; =&gt; 0.02,
 		&#39;DBIx::ContextualFetch&#39;    =&gt; 1.00,
 		&#39;Test::More&#39;               =&gt; 0.18,
+		&#39;Test::NoWarnings&#39;         =&gt; 0.08,
 	},
 	&#40;
 		$] &gt; 5.005

==== BEGIN SVK PATCH BLOCK ====
Version: svk v2.0.0 &#40;darwin&#41;

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
JFpFCv8DaK0SLQ==
==== END SVK PATCH BLOCK ====
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;21&nbsp;21:04:20&nbsp;2007</span>
    <span class="description">mschwern [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;10&nbsp;19:01:51&nbsp;2007</span>
    <span class="description">Dan [...] DWright.Org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dan [...] DWright.Org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am also seeing problems with the way that Ima::DBI is using
prepare_cached.

The fatal error that I&#39;m seeing is:

prepare_cached&#40; SQL query here... &#41;
statement handle DBIx::ContextualFetch::st=HASH&#40;0x99d3418&#41; still Active
at /usr/local/lib/perl5/site_perl/5.8.3/Ima/DBI.pm line 398


I&#39;ve found that this simple patch corrects the problem &#40;borrowed from
Schwern&#39;s patch&#41;:

399c392
&lt;                       ? $dbh-&gt;prepare_cached&#40;$sql&#41;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;                       ? $dbh-&gt;prepare_cached&#40;$sql, {}, 3&#41;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;10&nbsp;19:02:59&nbsp;2007</span>
    <span class="description">Dan [...] DWright.Org -  Cc DWRIGHT added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;17&nbsp;01:54:20&nbsp;2008</span>
    <span class="description">perl-cpan [...] bereft.net -  Cc BOWMANBS added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
