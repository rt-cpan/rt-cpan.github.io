<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #17335 for Cache-FastMmap: Attempt to work with a partially corrupted sharefile leads to a SIGSEGV</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #17335 for Cache-FastMmap: Attempt to work with a partially corrupted sharefile leads to a SIGSEGV</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Cache-FastMmap/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Cache-FastMmap/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Cache-FastMmap/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Cache-FastMmap/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Cache-FastMmap">Cache-FastMmap CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">17335</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Cache-FastMmap/Active/">Cache-FastMmap</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cpan [...] my-e-mail.ru

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-4856-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.09    </td>
  </tr>
  <tr id="CF-4857-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;28&nbsp;17:28:01&nbsp;2006</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Attempt to work with a partially corrupted sharefile leads to a
 SIGSEGV</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Module: Cache-FastMmap-1.09.
Perl version: v5.8.5 built for sun4-solaris
OS version: SunOS 5.8 Generic_108528-19 sun4u sparc SUNW,UltraAX-i2

Problem description:
An attempt to work with a partially corrupted sharefile crashes the 
process.
As far as I could understand during debug of the process, the reason for 
crash is an uninitialised &#34;last_error&#34; variable of the &#34;mmap_cache&#34; 
structure. 
In my case the crash happens after the mmc_lock&#40;&#41; function has revealed 
the corrupted state of some page in the file.
The function returns an error condition &#40;-1&#41; without calling the 
internal _mmc_set_error&#40;&#41; function.
The _mmc_set_error&#40;&#41;, if called, should store the error message in the 
&#34;last_error&#34; variable of the &#34;mmap_cache&#34; structure. If it doesn&#39;t, the 
uninitialized value &#40;which points somewhere beyond the process address 
space&#41; is used as an input for croak&#40;&#41; which leads to a crash.

Proposed patch:
The least proposed patch is to initialise the &#34;last_error&#34; variable in 
the mmc_init&#40;&#41; function with some constant string value like &#34;unknown 
error&#34; or something.
Additionally, it will be a good idea to enrich error code returns from 
mmc_lock&#40;&#41; function with corresponding _mmc_set_error&#40;&#41; calls.

A scratch patch file is included in the attachment.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Cache-FastMmap-1.09-patch.txt</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Cache-FastMmap-CImpl/mmap_cache.c.orig	2006-01-29 00:52:23.099017000 +0300
+++ Cache-FastMmap-CImpl/mmap_cache.c	2006-01-29 01:08:36.075541000 +0300
@@ -83,7 +83,7 @@
 
 
 /* Internal functions */
-void _mmc_set_error&#40;mmap_cache *, int, char *, ...&#41;;
+int _mmc_set_error&#40;mmap_cache *, int, char *, ...&#41;;
 void _mmc_init_page&#40;mmap_cache *, MU32&#41;;
 
 MU32 * _mmc_find_slot&#40;mmap_cache * , MU32 , void *, int &#41;;
@@ -222,6 +222,8 @@
     return -1;
   }
 
+  cache-&gt;last_error = &#34;Unknown error&#34;;
+
   /* Basic cache params */
   c_num_pages = cache-&gt;c_num_pages;
   ASSERT&#40;c_num_pages &gt;= 1 &#38;&#38; c_num_pages &lt;= 1000&#41;;
@@ -449,7 +451,8 @@
     return -1;
   }
 
-  if &#40;!&#40;P_Magic&#40;p_ptr&#41; == 0x92f7e3b1&#41;&#41; return -1;
+  if &#40;!&#40;P_Magic&#40;p_ptr&#41; == 0x92f7e3b1&#41;&#41;
+    return -1 + _mmc_set_error&#40; cache, 0, &#34;magic page start marker not found. p_cur is %u, offset is %u&#34;, p_cur, p_offset&#41;;
 
   /* Copy to cache structure */
   cache-&gt;p_num_slots = P_NumSlots&#40;p_ptr&#41;;
@@ -459,10 +462,10 @@
   cache-&gt;p_free_bytes = P_FreeBytes&#40;p_ptr&#41;;
 
   /* Reality check */
-  if &#40;!&#40;cache-&gt;p_num_slots &gt;= 89 &#38;&#38; cache-&gt;p_num_slots &lt; cache-&gt;c_page_size&#41;&#41; return -1;
-  if &#40;!&#40;cache-&gt;p_free_slots &gt; 0 &#38;&#38; cache-&gt;p_free_slots &lt;= cache-&gt;p_num_slots&#41;&#41; return -1;
-  if &#40;!&#40;cache-&gt;p_old_slots &lt;= cache-&gt;p_free_slots&#41;&#41; return -1;
-  if &#40;!&#40;cache-&gt;p_free_data + cache-&gt;p_free_bytes == cache-&gt;c_page_size&#41;&#41; return -1;
+  if &#40;!&#40;cache-&gt;p_num_slots &gt;= 89 &#38;&#38; cache-&gt;p_num_slots &lt; cache-&gt;c_page_size&#41;&#41; return -1 + _mmc_set_error&#40; cache, 0, &#34;cache num_slots mistmatch&#34;&#41;;
+  if &#40;!&#40;cache-&gt;p_free_slots &gt; 0 &#38;&#38; cache-&gt;p_free_slots &lt;= cache-&gt;p_num_slots&#41;&#41; return -1 + _mmc_set_error&#40; cache, 0, &#34;cache free slots mustmatch&#34;&#41;;
+  if &#40;!&#40;cache-&gt;p_old_slots &lt;= cache-&gt;p_free_slots&#41;&#41; return -1 + _mmc_set_error&#40; cache, 0, &#34;cache old slots mistmatch&#34;&#41;;
+  if &#40;!&#40;cache-&gt;p_free_data + cache-&gt;p_free_bytes == cache-&gt;c_page_size&#41;&#41; return -1 + _mmc_set_error&#40; cache, 0, &#34;cache free data mistmatch&#34;&#41;;
 
   /* Check page header */
   ASSERT&#40;P_Magic&#40;p_ptr&#41; == 0x92f7e3b1&#41;;
@@ -1228,12 +1231,12 @@
 }
 
 /*
- * void _mmc_set_error&#40;mmap_cache *cache, int err, char * error_string, ...&#41;
+ * int _mmc_set_error&#40;mmap_cache *cache, int err, char * error_string, ...&#41;
  *
  * Set internal error string/state
  *
 */
-void _mmc_set_error&#40;mmap_cache *cache, int err, char * error_string, ...&#41; {
+int _mmc_set_error&#40;mmap_cache *cache, int err, char * error_string, ...&#41; {
   va_list ap;
   static char errbuf[1024];
 
@@ -1256,7 +1259,7 @@
 
   va_end&#40;ap&#41;;
 
-  return;
+  return 0;
 }
 
 /*
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;31&nbsp;19:26:20&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the report. I&#39;ll integrate your changes into the next version.

FYI, I&#39;ve been working on and off on a new version of Cache::FastMmap
that will include an additional &#34;has been modified&#34; flag on each page.
Basically before any modification occurs, this flag will be set, and
only after any changes have been made which make the page consistent
will the flag be unset. Basically there is currently a race condition
where if a process is killed while in the middle of making changes to a
page, it can leave the page corrupted &#40;and the OS will release the lock
when the process is killed&#41; and cause other processes attached to it to
crash. While this is very rare, it&#39;s still a possibility that should be
dealt with.

Sorry, no timeframe at the moment, but keep an eye out on CPAN.

Rob
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;31&nbsp;19:26:21&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;10&nbsp;16:49:16&nbsp;2006</span>
    <span class="description">cpan [...] my-e-mail.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #17335] Attempt to work with a partially corrupted sharefile leads to a SIGSEGV </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 11 Feb 2006 00:47:52 +0300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-Cache-FastMmap [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Quonsto&#34; &lt;cpan [...] my-e-mail.ru&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for the answer.
I&#39;ll keep an eye on cpan for the next version.

I just want to notice, that in my case it&#39;s not Cache::FastMmap&#39;s
responsibility for spoiling the cache file.
It&#39;s definitely not a situation you described, that a process is being
killed during page update.
The page gets almost completely corrupted with some un-identifiable garbage.
I have a lot of different modules working together under mod_perl and I
guess some of them could be responsible for it.
The only goal for me was that Cache::FastMmap shouldn&#39;t crash in this case.

Thank you for your work, the module became really useful for me.
I even had to refresh my memory about debugging C programs to keep it with
me :&#41;

Regards, Quonsto.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; -----Original Message-----
&gt; From: Guest via RT [mailto:bug-Cache-FastMmap@rt.cpan.org] 
&gt; Sent: Wednesday, February 01, 2006 3:26 AM
&gt; To: cpan@my-e-mail.ru
&gt; Subject: [rt.cpan.org #17335] Attempt to work with a 
&gt; partially corrupted sharefile leads to a SIGSEGV 
&gt; 
&gt; 
&gt; Thanks for the report. I&#39;ll integrate your changes into the 
&gt; next version.
&gt; 
&gt; FYI, I&#39;ve been working on and off on a new version of 
&gt; Cache::FastMmap that will include an additional &#34;has been 
&gt; modified&#34; flag on each page. Basically before any 
&gt; modification occurs, this flag will be set, and only after 
&gt; any changes have been made which make the page consistent 
&gt; will the flag be unset. Basically there is currently a race 
&gt; condition where if a process is killed while in the middle of 
&gt; making changes to a page, it can leave the page corrupted 
&gt; &#40;and the OS will release the lock when the process is killed&#41; 
&gt; and cause other processes attached to it to crash. While this 
&gt; is very rare, it&#39;s still a possibility that should be dealt with.
&gt; 
&gt; Sorry, no timeframe at the moment, but keep an eye out on CPAN.
&gt; 
&gt; Rob
&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;19&nbsp;19:06:40&nbsp;2006</span>
    <span class="description">robm [...] fastmail.fm -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17335] Attempt to work with a partially corrupted sharefile leads to a SIGSEGV </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 20 Feb 2006 11:06:02 +1100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-Cache-FastMmap [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Rob Mueller&#34; &lt;robm [...] fastmail.fm&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I just want to notice, that in my case it&#39;s not Cache::FastMmap&#39;s
&gt; responsibility for spoiling the cache file.
&gt; It&#39;s definitely not a situation you described, that a process is being
&gt; killed during page update.
&gt; The page gets almost completely corrupted with some un-identifiable 
&gt; garbage.
&gt; I have a lot of different modules working together under mod_perl and I
&gt; guess some of them could be responsible for it.
&gt; The only goal for me was that Cache::FastMmap shouldn&#39;t crash in this 
&gt; case.
</div>
That is quite strange. It sounds like something is randomly trashing memory 
or something? Ouch.

Because of the new &#34;page dirty&#34; flag, I have code to completely clean and 
empty a particular page &#40;eg if a page does get left in an undefined dirty 
state when a process is killed, the next process to try and access that page 
has to completely wipe it&#41;, i&#39;ll make it that if the magic code at the start 
of the page is wrong, it also wipes the page clean. I might also make it log 
something to STDERR since really this should almost never happen, it implies 
that something trashed memory, or that a process was killed in the middle of 
modifying a page.

Rob
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;28&nbsp;23:32:51&nbsp;2010</span>
    <span class="description">cpan [...] robm.fastmail.fm -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I believe this was fixed some time back.

After locking a page, the first thing it checks is that magic page
marker is correct.

  if &#40;!&#40;P_Magic&#40;p_ptr&#41; == 0x92f7e3b1&#41;&#41;
    return -1 + _mmc_set_error&#40;cache, 0, &#34;magic page start marker not
found. p_cur is %u, offset is %u&#34;, p_cur, p_offset&#41;;

It also initialises last_error.

  cache-&gt;last_error = 0;

And the code to get the error does.

char * mmc_error&#40;mmap_cache * cache&#41; {
  if &#40;cache-&gt;last_error&#41;
    return cache-&gt;last_error;
  return &#34;Unknown error&#34;;
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;28&nbsp;23:32:53&nbsp;2010</span>
    <span class="description">cpan [...] robm.fastmail.fm -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
