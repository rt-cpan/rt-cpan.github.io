<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #84073 for Test-Group: TODOs inside test groups do not work properly &#40;Patch included&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #84073 for Test-Group: TODOs inside test groups do not work properly &#40;Patch included&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Test-Group/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Test-Group/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Test-Group/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Test-Group/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Test-Group">Test-Group CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">84073</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Test-Group/Active/">Test-Group</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
otting [...] cpanel.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-39460-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-39461-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;19&nbsp;12:57:18&nbsp;2013</span>
    <span class="description">otting [...] cpanel.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> TODOs inside test groups do not work properly &#40;Patch included&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 19 Mar 2013 11:57:01 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Test-Group [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> James Otting &lt;otting [...] cpanel.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Module: Test::Group 0.18
perl 5.10.1 on Centos 6.4

TODOs inside test groups are not properly marked as such in TAP output,
causing them to show as failures. This is the same issue as reported in
rt by Dvaid Storrs in June of 2011. I&#39;ve found and &#40;I believe&#41; fixed the
issue. A patch is included below.


--- Test/Group.pm       2013-03-14 17:01:39.275840601 -0500
+++ Test/Group.pm       2013-03-14 17:02:43.041718993 -0500
@@ -457,16 +457,9 @@

     no warnings &#34;redefine&#34;;
     my &#40;$OK, $TODO_string&#41; = $subTest-&gt;as_Test_Builder_params;
-    # I tried to put a &#34;local $TODO = &#34; here, but that didn&#39;t work and
-    # I lack the patience to dig up the whole story about
-    # Test::Builder-&gt;caller not doing The Right Thing here &#40;yet
-    # elsewhere it does when it apparently shouldn&#39;t, e.g. in
-    # L&lt;/run&gt;&#41;.  So here goes a sleazy local-method trick to get the
-    # TODO status across to Test::Builder; the trick has an adherence
-    # in L&lt;/ok&gt;, which see.
-    local *Test::Builder::todo = sub { $TODO_string };
-    local $Test::Builder::Level = $Test::Builder::Level + $Level;
+    $Test-&gt;todo_start&#40;$TODO_string&#41;;
     $Test-&gt;ok&#40;$OK, $name&#41;;
+    $Test-&gt;todo_end&#40;&#41;;
     return $OK ? 1 : 0;
 }


This fix appears to work properly for test structures like the following.

#!/usr/bin/perl

use Test::More tests =&gt; 2;
use Test::Group;

test &#34;something&#34; =&gt; sub {
   pass&#40;&#34;Ok&#34;&#41;;
   TODO: {
      local $TODO = &#34;this part does not work yet&#34;;
      fail&#40;&#34;Expected fail&#34;&#41;;
   }
   pass&#40;&#34;Works&#34;&#41;;
};
pass&#40;&#34;Works&#34;&#41;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;23&nbsp;12:05:02&nbsp;2013</span>
    <span class="description">NCLEATON [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Mar 19 12:57:18 2013, otting@cpanel.net wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Module: Test::Group 0.18
&gt; perl 5.10.1 on Centos 6.4
&gt; 
&gt; TODOs inside test groups are not properly marked as such in TAP output,
&gt; causing them to show as failures. This is the same issue as reported in
&gt; rt by Dvaid Storrs in June of 2011. I&#39;ve found and &#40;I believe&#41; fixed the
&gt; issue. A patch is included below.
&gt; 
&gt; 
&gt; --- Test/Group.pm     2013-03-14 17:01:39.275840601 -0500
&gt; +++ Test/Group.pm     2013-03-14 17:02:43.041718993 -0500
&gt; @@ -457,16 +457,9 @@
&gt; 
&gt;      no warnings &#34;redefine&#34;;
&gt;      my &#40;$OK, $TODO_string&#41; = $subTest-&gt;as_Test_Builder_params;
&gt; -    # I tried to put a &#34;local $TODO = &#34; here, but that didn&#39;t work and
&gt; -    # I lack the patience to dig up the whole story about
&gt; -    # Test::Builder-&gt;caller not doing The Right Thing here &#40;yet
&gt; -    # elsewhere it does when it apparently shouldn&#39;t, e.g. in
&gt; -    # L&lt;/run&gt;&#41;.  So here goes a sleazy local-method trick to get the
&gt; -    # TODO status across to Test::Builder; the trick has an adherence
&gt; -    # in L&lt;/ok&gt;, which see.
&gt; -    local *Test::Builder::todo = sub { $TODO_string };
&gt; -    local $Test::Builder::Level = $Test::Builder::Level + $Level;
&gt; +    $Test-&gt;todo_start&#40;$TODO_string&#41;;
&gt;      $Test-&gt;ok&#40;$OK, $name&#41;;
&gt; +    $Test-&gt;todo_end&#40;&#41;;
&gt;      return $OK ? 1 : 0;
&gt;  }
&gt; 
&gt; 
&gt; This fix appears to work properly for test structures like the following.
&gt; 
&gt; #!/usr/bin/perl
&gt; 
&gt; use Test::More tests =&gt; 2;
&gt; use Test::Group;
&gt; 
&gt; test &#34;something&#34; =&gt; sub {
&gt;    pass&#40;&#34;Ok&#34;&#41;;
&gt;    TODO: {
&gt;       local $TODO = &#34;this part does not work yet&#34;;
&gt;       fail&#40;&#34;Expected fail&#34;&#41;;
&gt;    }
&gt;    pass&#40;&#34;Works&#34;&#41;;
&gt; };
&gt; pass&#40;&#34;Works&#34;&#41;;
</div>
Thanks.

There was already a fix for this in the git repo, but it had never been released.  I&#39;ve added your example as a test case and released it to the CPAN Testers as version 0.18_1

You can fetch it from <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/CPAN/authors/id/N/NC/NCLEATON/Test-Group-0.18_1.tar.gz">http://search.cpan.org/CPAN/authors/id/N/NC/NCLEATON/Test-Group-0.18_1.tar.gz</a></span> if you like.

If no issues arise I&#39;ll release it as 0.19 in a couple of days.  I&#39;ll leave this ticket open until then.


Nick
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;23&nbsp;12:05:05&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;25&nbsp;17:29:49&nbsp;2013</span>
    <span class="description">otting [...] cpanel.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #84073] TODOs inside test groups do not work properly &#40;Patch included&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 25 Mar 2013 16:29:33 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Test-Group [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> James Otting &lt;otting [...] cpanel.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 03/23/2013 11:05 AM, NCLEATON via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Thanks.
&gt; 
&gt; There was already a fix for this in the git repo, but it had never been released.  I&#39;ve added your example as a test case and released it to the CPAN Testers as version 0.18_1
&gt; 
&gt; You can fetch it from <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/CPAN/authors/id/N/NC/NCLEATON/Test-Group-0.18_1.tar.gz">http://search.cpan.org/CPAN/authors/id/N/NC/NCLEATON/Test-Group-0.18_1.tar.gz</a></span> if you like.
&gt; 
&gt; If no issues arise I&#39;ll release it as 0.19 in a couple of days.  I&#39;ll leave this ticket open until then.
&gt; 
&gt; 
&gt; Nick
&gt; 
</div>
Sorry, didn&#39;t realize there was a git version to look at, or I would&#39;ve
checked there first. Glad to hear it&#39;s getting fixed and released
though, as that&#39;ll make our deployment easier. I&#39;m running 0.18_1 now on
my development box and it looks to have corrected this issue nicely.
Haven&#39;t run into any other problems with it either. Thanks for being on
this so quickly!

--James
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
