<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #16323 for POE-Component-Server-Syslog: [patch] blocking call in UDP server</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #16323 for POE-Component-Server-Syslog: [patch] blocking call in UDP server</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=POE-Component-Server-Syslog">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=POE-Component-Server-Syslog">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=POE-Component-Server-Syslog">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=POE-Component-Server-Syslog">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE-Component-Server-Syslog">POE-Component-Server-Syslog CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">16323</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=POE-Component-Server-Syslog">POE-Component-Server-Syslog</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">SUNGO [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mike.bristow [...] thus.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-26638-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.03    </td>
  </tr>
  <tr id="CF-26639-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




poe-component-server-syslog.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/150661/45336/poe-component-server-syslog.patch">
Wed Dec 07 06:09:38 2005 (1.5k) by 
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/150659/45273/poe-component-server-syslog.patch">
Tue Dec 06 13:07:59 2005 (2.5k) by 
</a>
</font></li>
</ul>


poe.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/150663/46230/poe.patch">
Mon Dec 19 14:03:08 2005 (22.8k) by 
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/150662/46114/poe.patch">
Sun Dec 18 04:48:11 2005 (9.4k) by 
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=16323">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-150659" href="/Public/Bug/Display.html?id=16323#txn-150659">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;06&nbsp;13:07:59&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [patch] blocking call in UDP server</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/150659/45272/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/45272">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The UDP server has a blocking call in it &#40;gethostbyname&#41;.

This is undesirable in a event driven framework like POE; the whole system freezes while gethostbyname trundles about finding a DNS server and waiting for a response.

The solution attached gives a new option to turn this off; this gives a significant &#40;5 fold, or thereabouts&#41; throughput improvment in my enviroment &#40;syslog sources not in /etc/hosts; dns server on same lan but not on the same host; nscd running&#41;.

A perhaps better solution would be to use POE::Component::Client::DNS to do the lookups &#40;optionally&#41; so that while DNS servers scratch their heads about the answer the rest of the POE system can still run.  However, the quick and dirty &#34;just turn it off!!&#34; option was easier to write.

I imagine that the TCP server has the same problem, but that it is less impactful because I expect you do the gethostbyname on accept and not per-message, but &#40;given I&#39;m doing UDP stuff at the point I ran into the problem&#41; I haven&#39;t checked.

Note:  this patch was written against 1.02; I&#39;ve just imported 1.03 into our CVS repository and done the approprate merge magic.  It builds OK and passess the tests on:

RedHat-3FC-i386
RedHat-3AS-ia32
RedHat-FC.4-i386
RedHat-EL.4-i386

with the vendor perl.  
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/150659/45273/poe-component-server-syslog.patch">Download poe-component-server-syslog.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: package.xml
===================================================================
RCS file: /cvsroot/packages/POE-Component-Server-Syslog/package.xml,v
retrieving revision 1.7
retrieving revision 1.7.2.1
diff -u -r1.7 -r1.7.2.1
--- package.xml	6 Dec 2005 17:51:53 -0000	1.7
+++ package.xml	6 Dec 2005 17:54:50 -0000	1.7.2.1
@@ -1,11 +1,11 @@
 &lt;?xml version=&#34;1.0&#34;?&gt;
-&lt;!-- $Thus: packages/POE-Component-Server-Syslog/package.xml,v 1.7 2005/12/06 17:51:53 michaelb-repoman Exp $ --&gt;
+&lt;!-- $Thus: packages/POE-Component-Server-Syslog/package.xml,v 1.7.2.1 2005/12/06 17:54:50 michaelb Exp $ --&gt;
 
 &lt;Package xmlns=&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.eng.demon.net/XML/pbuild">http://www.eng.demon.net/XML/pbuild</a></span>&#34;&gt;
 	&lt;Class&gt;cpan&lt;/Class&gt;
 	&lt;Name&gt;POE-Component-Server-Syslog&lt;/Name&gt;
 	&lt;Version&gt;1.03&lt;/Version&gt;
-	&lt;Release&gt;1&lt;/Release&gt;
+	&lt;Release&gt;2_BUG_5464_2_RC1&lt;/Release&gt;
 	&lt;Summary&gt;Perl5 library to provide syslog services to POE&lt;/Summary&gt;
 	&lt;Description&gt;
 		This component provides very simple syslog services for POE.
Index: POE-Component-Server-Syslog/lib/POE/Component/Server/Syslog/UDP.pm
===================================================================
RCS file: /cvsroot/upstream/POE-Component-Server-Syslog/lib/POE/Component/Server/Syslog/UDP.pm,v
retrieving revision 1.1.1.1
retrieving revision 1.1.1.1.6.1
diff -u -r1.1.1.1 -r1.1.1.1.6.1
--- POE-Component-Server-Syslog/lib/POE/Component/Server/Syslog/UDP.pm	13 Mar 2005 21:08:42 -0000	1.1.1.1
+++ POE-Component-Server-Syslog/lib/POE/Component/Server/Syslog/UDP.pm	6 Dec 2005 17:54:25 -0000	1.1.1.1.6.1
@@ -10,6 +10,7 @@
 sub BINDPORT        &#40;&#41; { 514 }
 sub DATAGRAM_MAXLEN &#40;&#41; { 1024 }  # syslogd defaults to this. as do most 
                                  # libc implementations of syslog
+sub DNSLOOKUP &#40;&#41; { 1 }
 
 use Params::Validate qw&#40;validate_with&#41;;
 use Carp qw&#40;carp croak&#41;;
@@ -49,6 +50,11 @@
 				optional =&gt; 1,
 				default  =&gt; DATAGRAM_MAXLEN,
 			},
+			DnisLookup	 =&gt; {
+				type     =&gt; &#38;Params::Validate::SCALAR,
+				optional =&gt; 1,
+				default  =&gt; DNSLOOKUP,
+			},
 		},
 	&#41;;
 
@@ -111,10 +117,14 @@
 			if&#40;defined $records and ref $records eq &#39;ARRAY&#39;&#41; {
 				foreach my $record &#40;@$records&#41; {
 					if&#40; &#40; sockaddr_in&#40; $remote_socket &#41; &#41;[1]&#41; {
-						$record-&gt;{host} = gethostbyaddr&#40;
-							&#40; sockaddr_in&#40; $remote_socket &#41; &#41;[1],
-							AF_INET,
-						&#41;;
+						if &#40;$_[HEAP]-&gt;{DnisLookup}&#41; {
+						    $record-&gt;{host} = gethostbyaddr&#40;
+								&#40; sockaddr_in&#40; $remote_socket &#41; &#41;[1],
+								AF_INET,
+						    &#41;;
+						} else {
+							$record-&gt;{host} = inet_ntoa&#40;&#40; sockaddr_in&#40; $remote_socket &#41; &#41;[1]&#41;;
+						}
 					} else {
 						$record-&gt;{host} = &#39;[unknown]&#39;;
 					}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-150660" href="/Public/Bug/Display.html?id=16323#txn-150660">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;06&nbsp;18:36:20&nbsp;2005</span>
    <span class="description">SUNGO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/150660/45300/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/45300">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 898b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">three things.

1&#41; what is package.xml that your patch updates? this patch won&#39;t even
apply because i don&#39;t have or provide that file.

2&#41; you&#39;re right. using POE::Component::Client::DNS is the right way to
go, and as i&#39;m not a fan of doing things half-way, i won&#39;t accept a
patch for this issue unless it implements Client::DNS usage.

3&#41; the TCP implementation does the same call on socket connection. any
patch that addresses this issue has to address it in both
implementations. i understand that you&#39;re only using udp but any patch
to this module set needs to solve and provide tests for fixing the
problem in the general case.

i&#39;m leaving the issue open because i do need to fix this problem. i will
however not be applying this patch. if you provide a patch that
addresses the issues above before i get around to fixing the problem,
i&#39;ll more than happy to apply it.

thanks for your report.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-150661" href="/Public/Bug/Display.html?id=16323#txn-150661">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;07&nbsp;06:09:38&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mike.bristow [...] thus.net</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/150661/45335/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/45335">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[SUNGO - Tue Dec  6 18:36:20 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; three things.
&gt; 
&gt; 1&#41; what is package.xml that your patch updates? this patch won&#39;t even
&gt; apply because i don&#39;t have or provide that file.
</div>
my stupidity, sorry.

FYI: it&#39;s the magic we use to turn source into .rpm&#39;s on RedHat and .pkg
files on Solaris and .depot on HPUX.  The layout in our repository is:

 pkg-POE/
 pkg-POE/package.xml &#38; other magic
 pkg-POE/POE/
 pkg-POE/POE/&lt;stuff in the upstream tarball&gt;

&#40;POE is less to type&#41;.

I typed cvs diff in pkg-POE not pkg-POE/POE, hence the exteranous file.
  Find a better attempt attached.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2&#41; you&#39;re right. using POE::Component::Client::DNS is the right way to
&gt; go, and as i&#39;m not a fan of doing things half-way, i won&#39;t accept a
&gt; patch for this issue unless it implements Client::DNS usage.
</div>
Fair enough.

However, if something like this is done it will &#40;also&#41; have a negative
impact on performance:  instead of POE::Component::Server::Syslog users
generating two &#40;or so&#41; POE events per syslog message, they&#39;ll generate
four &#40;or so&#41;.

ie, one POE::Component::Server::Syslog event, + one client event becomes
two POE::Component::Server::Syslog events &#40;message arrived + DNS lookup
complete&#41;, one POE::Component::DNS::Client event &#40;DNS lookup complete;
I&#39;ll assume that the query is done inline without an event&#41; + one client
event.

In this case it&#39;s still probably worth having a &#34;Don&#39;t do dns lookups&#34;
option for the server because some people don&#39;t care about the name of
the clients, the IP address is good enough for them, and they will still
get a reasonably performance boost for doing so.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 3&#41; the TCP implementation does the same call on socket connection. any
&gt; patch that addresses this issue has to address it in both
&gt; implementations. i understand that you&#39;re only using udp but any patch
&gt; to this module set needs to solve and provide tests for fixing the
&gt; problem in the general case.
</div>
Actually, I flit between udp and tcp fairly often, depending on the
problem of the day.

However, tcp implmentations of syslog that I&#39;ve seen &#40;syslog-ng, and er,
that&#39;s it&#41; seem to hold open the tcp session for long periods of time
and pass multiple messages.  This means that the TCP server will call
gethostbyname once per client reboot, and the UDP server will do so once
per message.

Obviously, though, doing &#39;the right thing&#39; for both is better, but the
TCP problem is tiny in comparison - for me.  

I&#39;m dealing with somewhere about the 10k syslog messages per second for
periods of 5-10 minutes - at peak.  10-20/sec is the average, though. 
The client reboots number in the handful per year, as I only have one
client.

I intend to add the &#34;don&#39;t do DNS lookups&#34; option to the TCP server for
completeness, and update the ticket.  Then I&#39;ll start looking at how to
do the POE::Component::Client::DNS stuff instead.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/150661/45336/poe-component-server-syslog.patch">Download poe-component-server-syslog.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: lib/POE/Component/Server/Syslog/UDP.pm
===================================================================
RCS file: /cvsroot/upstream/POE-Component-Server-Syslog/lib/POE/Component/Server/Syslog/UDP.pm,v
retrieving revision 1.1.1.1
retrieving revision 1.1.1.1.6.1
diff -u -r1.1.1.1 -r1.1.1.1.6.1
--- lib/POE/Component/Server/Syslog/UDP.pm	13 Mar 2005 21:08:42 -0000	1.1.1.1
+++ lib/POE/Component/Server/Syslog/UDP.pm	6 Dec 2005 17:54:25 -0000	1.1.1.1.6.1
@@ -10,6 +10,7 @@
 sub BINDPORT        &#40;&#41; { 514 }
 sub DATAGRAM_MAXLEN &#40;&#41; { 1024 }  # syslogd defaults to this. as do most 
                                  # libc implementations of syslog
+sub DNSLOOKUP &#40;&#41; { 1 }
 
 use Params::Validate qw&#40;validate_with&#41;;
 use Carp qw&#40;carp croak&#41;;
@@ -49,6 +50,11 @@
 				optional =&gt; 1,
 				default  =&gt; DATAGRAM_MAXLEN,
 			},
+			DnisLookup	 =&gt; {
+				type     =&gt; &#38;Params::Validate::SCALAR,
+				optional =&gt; 1,
+				default  =&gt; DNSLOOKUP,
+			},
 		},
 	&#41;;
 
@@ -111,10 +117,14 @@
 			if&#40;defined $records and ref $records eq &#39;ARRAY&#39;&#41; {
 				foreach my $record &#40;@$records&#41; {
 					if&#40; &#40; sockaddr_in&#40; $remote_socket &#41; &#41;[1]&#41; {
-						$record-&gt;{host} = gethostbyaddr&#40;
-							&#40; sockaddr_in&#40; $remote_socket &#41; &#41;[1],
-							AF_INET,
-						&#41;;
+						if &#40;$_[HEAP]-&gt;{DnisLookup}&#41; {
+						    $record-&gt;{host} = gethostbyaddr&#40;
+								&#40; sockaddr_in&#40; $remote_socket &#41; &#41;[1],
+								AF_INET,
+						    &#41;;
+						} else {
+							$record-&gt;{host} = inet_ntoa&#40;&#40; sockaddr_in&#40; $remote_socket &#41; &#41;[1]&#41;;
+						}
 					} else {
 						$record-&gt;{host} = &#39;[unknown]&#39;;
 					}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-150662" href="/Public/Bug/Display.html?id=16323#txn-150662">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;18&nbsp;04:48:11&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mike.bristow [...] thus.net</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/150662/46113/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/46113">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 383b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[SUNGO - Tue Dec  6 18:36:20 2005]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2&#41; you&#39;re right. using POE::Component::Client::DNS is the right way to
&gt; go, and as i&#39;m not a fan of doing things half-way, i won&#39;t accept a
&gt; patch for this issue unless it implements Client::DNS usage.
</div>
See attached patch.  I haven&#39;t tested this as fully as it requires, nor
have I tackled the TCP server so I know it isn&#39;t release-worthy yet.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/150662/46114/poe.patch">Download poe.patch</a><br />
<span class="downloadcontenttype">text/x-diff 9.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">? lib/POE/Component/Server/Syslog/.UDP.pm.swp
Index: META.yml
===================================================================
RCS file: /cvsroot/upstream/POE-Component-Server-Syslog/META.yml,v
retrieving revision 1.1.1.2
retrieving revision 1.1.1.2.2.1
diff -u -r1.1.1.2 -r1.1.1.2.2.1
--- META.yml	20 Nov 2005 22:53:54 -0000	1.1.1.2
+++ META.yml	18 Dec 2005 09:36:26 -0000	1.1.1.2.2.1
@@ -5,6 +5,7 @@
 distribution_type: module
 requires:
   POE: 0.24
+  POE::Component::Client::DNS: 0
   Params::Validate: 0
   IO::Socket: 0
   Time::ParseDate: 0
Index: lib/POE/Component/Server/Syslog/TCP.pm
===================================================================
RCS file: /cvsroot/upstream/POE-Component-Server-Syslog/lib/POE/Component/Server/Syslog/TCP.pm,v
retrieving revision 1.1.1.1
retrieving revision 1.1.1.1.6.4
diff -u -r1.1.1.1 -r1.1.1.1.6.4
--- lib/POE/Component/Server/Syslog/TCP.pm	13 Mar 2005 21:08:42 -0000	1.1.1.1
+++ lib/POE/Component/Server/Syslog/TCP.pm	7 Dec 2005 16:52:42 -0000	1.1.1.1.6.4
@@ -10,6 +10,7 @@
 sub BINDPORT        &#40;&#41; { 514 }
 sub DATAGRAM_MAXLEN &#40;&#41; { 1024 }  # syslogd defaults to this. as do most 
                                  # libc implementations of syslog
+sub DNSLOOKUP &#40;&#41; { 1 }
 
 use Params::Validate qw&#40;validate_with&#41;;
 use Carp qw&#40;carp croak&#41;;
@@ -52,6 +53,11 @@
 				optional =&gt; 1,
 				default  =&gt; DATAGRAM_MAXLEN,
 			},
+			DnsLookup	 =&gt; {
+				type     =&gt; &#38;Params::Validate::SCALAR,
+				optional =&gt; 1,
+				default  =&gt; DNSLOOKUP,
+			},
 		},
 	&#41;;
 
@@ -98,8 +104,13 @@
 	my $handle = $_[ARG0];
 	my $host;
 
-	if&#40; &#40; sockaddr_in&#40; getpeername&#40;$handle&#41; &#41; &#41;[1]&#41; {
-		$host = gethostbyaddr&#40; &#40; sockaddr_in&#40; getpeername&#40;$handle&#41; &#41; &#41;[1], AF_INET &#41;;
+	my $remote = &#40;sockaddr_in&#40;getpeername&#40;$handle&#41;&#41;&#41;[1];
+	if&#40; $remote &#41; {
+		if &#40;$_[HEAP]-&gt;{DnsLookup}&#41; {
+			$host = gethostbyaddr&#40; $remote, AF_INET &#41;;
+		} else {
+			$host = inet_ntoa&#40;$remote&#41;;
+		}
 	} else {
 		$host = &#39;[unknown]&#39;;
 	}
@@ -209,6 +220,13 @@
 called when the component recieves a message it cannot parse. The
 erroneous message is passed in as ARG0.
 
+=item * DnsLookup
+
+An optional boolean value.  If true or unspecified, reverse DNS lookups
+are done for clients connecting and the name is put in the host element
+of the hashref passed to the InputState.  If false, then the IP address
+will be passed instead.
+
 =back
 
 =head2 InputState
Index: lib/POE/Component/Server/Syslog/UDP.pm
===================================================================
RCS file: /cvsroot/upstream/POE-Component-Server-Syslog/lib/POE/Component/Server/Syslog/UDP.pm,v
retrieving revision 1.1.1.1
retrieving revision 1.1.1.1.6.4
diff -u -r1.1.1.1 -r1.1.1.1.6.4
--- lib/POE/Component/Server/Syslog/UDP.pm	13 Mar 2005 21:08:42 -0000	1.1.1.1
+++ lib/POE/Component/Server/Syslog/UDP.pm	18 Dec 2005 09:36:27 -0000	1.1.1.1.6.4
@@ -10,12 +10,14 @@
 sub BINDPORT        &#40;&#41; { 514 }
 sub DATAGRAM_MAXLEN &#40;&#41; { 1024 }  # syslogd defaults to this. as do most 
                                  # libc implementations of syslog
+sub DNSLOOKUP &#40;&#41; { 1 }
 
 use Params::Validate qw&#40;validate_with&#41;;
 use Carp qw&#40;carp croak&#41;;
 
 use POE;
 use POE::Filter::Syslog;
+use POE::Component::Client::DNS;
 
 use Socket;
 use IO::Socket::INET;
@@ -49,6 +51,16 @@
 				optional =&gt; 1,
 				default  =&gt; DATAGRAM_MAXLEN,
 			},
+			DnsLookup	 =&gt; {
+				type     =&gt; &#38;Params::Validate::SCALAR,
+				optional =&gt; 1,
+				default  =&gt; DNSLOOKUP,
+			},
+			Resolver =&gt; {
+				isa		 =&gt; &#39;POE::Component::Client::DNS&#39;,
+				optional =&gt; 1,
+				default  =&gt; undef,
+			},
 		},
 	&#41;;
 
@@ -62,6 +74,7 @@
 
 			select_read    =&gt; \&#38;select_read,
 			shutdown       =&gt; \&#38;shutdown,
+			dns_result	   =&gt; \&#38;dns_result,
 
 			client_input =&gt; $args{InputState},
 			client_error =&gt; $args{ErrorState},
@@ -70,6 +83,15 @@
 		heap =&gt; \%args,
 	&#41;;
 
+    # We need a Resolver only if we are doing DNS lookups
+	if &#40;$args{DnsLookup} and not defined $args{Resolver}&#41; {
+		$args{Resolver} = POE::Component::Client::DNS-&gt;spawn&#40;
+			# need a unique alias in case there are many
+			# ...::Server::Syslog objects in the same program
+			Alias =&gt; &#39;POE::Component::Server::Syslog::&#39; . $sess-&gt;ID&#40;&#41;,
+		&#41;;
+	}
+
 	return $sess;
 }
 
@@ -110,16 +132,31 @@
 		while&#40; &#40;$records = $_[HEAP]-&gt;{filter}-&gt;get_one&#40;&#41;&#41; and &#40;@$records &gt; 0&#41;&#41; {
 			if&#40;defined $records and ref $records eq &#39;ARRAY&#39;&#41; {
 				foreach my $record &#40;@$records&#41; {
-					if&#40; &#40; sockaddr_in&#40; $remote_socket &#41; &#41;[1]&#41; {
-						$record-&gt;{host} = gethostbyaddr&#40;
-							&#40; sockaddr_in&#40; $remote_socket &#41; &#41;[1],
-							AF_INET,
-						&#41;;
+					my &#40;$remote_port, $remote_iaddr&#41; 
+						= sockaddr_in&#40;$remote_socket&#41;;
+					if&#40; $remote_iaddr &#41; {
+						if &#40;$_[HEAP]-&gt;{DnsLookup}&#41; {
+							# we don&#39;t yield:  it&#39;s done 
+							# either when the resolver posts
+							# the dns_result event, or in the
+							# handle_dns_result method
+
+							my $r = $_[HEAP]-&gt;{Resolver}-&gt;resolve&#40;
+								type =&gt; &#39;PTR&#39;,
+								host =&gt; inet_ntoa&#40;$remote_iaddr&#41;,
+								context =&gt; $record,
+								event =&gt; &#39;dns_result&#39;,
+							&#41;;
+							
+							handle_dns_result&#40;$record, $r,$_[KERNEL]&#41; if $r
+						} else {
+							$record-&gt;{host} = inet_ntoa&#40;$remote_iaddr &#41;;
+							$_[KERNEL]-&gt;yield&#40; &#39;client_input&#39;, $record &#41;;
+						}
 					} else {
-						$record-&gt;{host} = &#39;[unknown]&#39;;
+						$record-&gt;{host} = &#39;[&#39; . inet_ntoa&#40;$remote_iaddr&#41; . &#39;]&#39;;
+						$_[KERNEL]-&gt;yield&#40; &#39;client_input&#39;, $record &#41;;
 					}
-
-					$_[KERNEL]-&gt;yield&#40; &#39;client_input&#39;, $record &#41;;
 				}
 			} else {
 				$_[KERNEL]-&gt;yield&#40; &#39;client_error&#39;, $message &#41;;
@@ -128,6 +165,43 @@
 	}
 }
 
+sub dns_result {
+	my $response = $_[ARG0];
+	my $record = $response-&gt;{context};
+	handle_dns_result&#40;$record,$response, $_[KERNEL]&#41;;
+}
+
+sub handle_dns_result {
+	my $record = shift;
+	my $response = shift;
+	my $kernel = shift;
+
+	if &#40;not defined $response-&gt;{response}&#41; {
+		# There was some sort of DNS error; probably
+		# a timeout waiting for a DNS server.
+
+		$response-&gt;{host} = &#39;[&#39; . $response-&gt;{host} . &#39;]&#39;;
+		$_[KERNEL]-&gt;yield&#40; &#39;client_input&#39;, $record &#41;;
+		return;
+	}
+
+	my @ptranswer = grep {$_-&gt;type&#40;&#41; eq &#39;PTR&#39;} $response-&gt;{response}-&gt;answer&#40;&#41;;
+
+	unless &#40;@ptranswer == 1&#41; {
+		# Wrong number of PTR records in the answer.
+		# If there&#39;s zero, the DNS server doesn&#39;t know the answer;
+		# if there&#39;s more than one, we don&#39;t know which one to use
+
+		$response-&gt;{host} = &#39;[&#39; . $response-&gt;{host} . &#39;]&#39;;
+		$_[KERNEL]-&gt;yield&#40; &#39;client_input&#39;, $record &#41;;
+		return;
+	}
+
+    my $rr = $ptranswer[0];
+	$record-&gt;{host} = $rr-&gt;ptrdname;
+	$kernel-&gt;yield&#40; &#39;client_input&#39;, $record &#41;;
+}
+
 sub shutdown {
 	if&#40;$_[HEAP]-&gt;{handle}&#41; {
 		$_[KERNEL]-&gt;select_read&#40;$_[HEAP]-&gt;{handle}&#41;;
@@ -195,6 +269,17 @@
 called when the component recieves a message it cannot parse. The
 erroneous message is passed in as ARG0.
 
+=item * DnsLookup
+
+An optional boolean value.  If true or unspecified, reverse DNS lookups
+are done for clients connecting and the name is put in the host element
+of the hashref passed to the InputState.  If false, then the IP address
+will be passed instead.
+
+=item * Resolver
+
+An optional POE::Component::Client::DNS object to use for DNS lookups.
+
 =back
 
 =head2 InputState
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-150663" href="/Public/Bug/Display.html?id=16323#txn-150663">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;19&nbsp;14:03:08&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mike.bristow [...] thus.net</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/150663/46229/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/46229">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Sun Dec 18 04:48:11 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [SUNGO - Tue Dec  6 18:36:20 2005]:
<div class="message-stanza open">&gt; &gt; 2&#41; you&#39;re right. using POE::Component::Client::DNS is the right way to
&gt; &gt; go, and as i&#39;m not a fan of doing things half-way, i won&#39;t accept a
&gt; &gt; patch for this issue unless it implements Client::DNS usage.
</div>&gt; 
&gt; See attached patch.  I haven&#39;t tested this as fully as it requires, nor
&gt; have I tackled the TCP server so I know it isn&#39;t release-worthy yet.
</div>
This attached still needs more testing, but I think it is complete.

The following behaviour changes will be observed:
  1 bugs I&#39;ve introduced and not noticed 
  2 if there is no reverse DNS for a host, the $msg-&gt;{host} element
    will be the IP address in square brackets &#40;eg: &#39;[10.0.0.1]&#39;&#41;
  3 POE::Component::Client::DNS does not look at /etc/hosts for 
    reverse DNS.  This means that if, for example the syslog clients
    are on a private network with no DNS, then things will go pear
    shaped rapidly
  4 events may be in a differet order from the messages that triggered
    them.

Of these, 3 is rather worrying; it is a sustantial change to the way
this component works, and the change will be detrmental to some users.

4 could be fixed, but there is probably little point.

I&#39;m not to sure if it&#39;s a big deal, and if it is how to fix it. 
Thoughts are welcome...  

One possibility is to &#39;fix&#39; POE::Component::Client::DNS to use
/etc/hosts for reverse DNS.  It already uses it for forward DNS... 
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/150663/46230/poe.patch">Download poe.patch</a><br />
<span class="downloadcontenttype">text/x-diff 22.8k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-155874" href="/Public/Bug/Display.html?id=16323#txn-155874">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;15&nbsp;07:32:28&nbsp;2006</span>
    <span class="description">SUNGO [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-248346" href="/Public/Bug/Display.html?id=16323#txn-248346">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;08&nbsp;11:30:14&nbsp;2006</span>
    <span class="description">SUNGO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/248346/106307/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/106307">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 146b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">As the time line and my previous comments should indicate, I&#39;ve pretty
much rejected this patch and ticket. Finally setting the status to match...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-248347" href="/Public/Bug/Display.html?id=16323#txn-248347">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;08&nbsp;11:30:15&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-248349" href="/Public/Bug/Display.html?id=16323#txn-248349">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;08&nbsp;11:30:15&nbsp;2006</span>
    <span class="description">SUNGO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.486749</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
