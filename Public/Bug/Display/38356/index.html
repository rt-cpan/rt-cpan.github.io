<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #38356 for Log-Log4perl: Weirdness in callerline&#40;&#41;, and_warn&#40;&#41;, and_die&#40;&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #38356 for Log-Log4perl: Weirdness in callerline&#40;&#41;, and_warn&#40;&#41;, and_die&#40;&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Log-Log4perl/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Log-Log4perl/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Log-Log4perl/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Log-Log4perl/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Log-Log4perl">Log-Log4perl CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">38356</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Log-Log4perl/Active/">Log-Log4perl</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
rabbit [...] rabbit.us

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Unimportant    </td>
  </tr>
  <tr id="CF-19484-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.17    </td>
  </tr>
  <tr id="CF-19485-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;09&nbsp;09:51:20&nbsp;2008</span>
    <span class="description">rabbit [...] rabbit.us -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Weirdness in callerline&#40;&#41;, and_warn&#40;&#41;, and_die&#40;&#41;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, 
I am in the process of writing an elaborate layer on top of Log4Perl,
and I came across an inconsistency in
Log::Log4perl::Logger::callerline&#40;&#41;. I was planning to use it the same
way you are, i.e. to construct messages to feed to die&#40;&#41; and warn&#40;&#41;,
since I invoke them in a different manner under different circumstances.
However it does not work for me because instead of using the global
$caller_depth, this subroutine resorts to arcane call-stack scanning in
order to determine the caller. Of course the caller always ends up being
the first package outside of the log4perl namespace. Is there a reason
for this, or is this simply an oversight and $caller_depth would be more
appropriate there? If yes I am willing to submit you a properly tested
patch. 

Additionally I noticed that in and_warn&#40;&#41; and and_die&#40;&#41; and at some
other places you use ...&#40;@_[0 .. $#_]&#41;, which is an extremely elaborate
way to say @_. What is the reason for this?

And last but not least - this is a great module, great concept, great
integration with the perl paradigm. However NOWHERE in the
documentation, tutorials, faqs and pretty much any official text,
NOWHERE does it say that a `category` and a `logger` are in fact ONE AND
THE SAME THING. It took me almost a week of searching testing and
reading code to get to this conclusion. Shame! :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;10&nbsp;22:29:36&nbsp;2008</span>
    <span class="description">MSCHILLI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Aug 09 09:51:20 2008, rabbit@rabbit.us wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I am in the process of writing an elaborate layer on top of Log4Perl,
</div>
Excellent :&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; and I came across an inconsistency in
&gt; Log::Log4perl::Logger::callerline&#40;&#41;. 
</div>
I fiddled with that particular code for a long time until I got it
working. The reason for the stack scanning is, IIRC, that it&#39;s used from
 both within Log4perl and outside and there&#39;s no easy way to determine
the depth &#40;or so I thought at the time&#41;. If you have an idea on how to
replace it with caller_depth, feel free to play with it, the test suite
will complain if there&#39;s a mistake. Patches are definitely welcome.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Additionally I noticed that in and_warn&#40;&#41; and and_die&#40;&#41; and at some
&gt; other places you use ...&#40;@_[0 .. $#_]&#41;, which is an extremely elaborate
&gt; way to say @_. What is the reason for this?
</div>
It&#39;s indeed the same thing, the reason for this is most likely old code
that had a different range but got changed -- should be changed to @_
for better readability.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; And last but not least - this is a great module, great concept, great
&gt; integration with the perl paradigm. However NOWHERE in the
&gt; documentation, tutorials, faqs and pretty much any official text,
&gt; NOWHERE does it say that a `category` and a `logger` are in fact ONE AND
&gt; THE SAME THING.
</div>
I couldn&#39;t find it either :&#41;. I could have sworn this is mentioned
somewhere, but it&#39;s probably buried deeply and deserves a more prominent
place. I&#39;ve added it first thing under the &#34;Category&#34; section. Thanks
for letting me know.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;10&nbsp;22:29:38&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;20&nbsp;22:00:30&nbsp;2008</span>
    <span class="description">rabbit [...] rabbit.us -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #38356] Weirdness in callerline&#40;&#41;, and_warn&#40;&#41;, and_die&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 21 Aug 2008 03:32:31 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Log-Log4perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;rabbit [...] rabbit.us&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Michael_Schilli via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; and I came across an inconsistency in
&gt;&gt; Log::Log4perl::Logger::callerline&#40;&#41;. 
</div>&gt; 
&gt; I fiddled with that particular code for a long time until I got it
&gt; working. The reason for the stack scanning is, IIRC, that it&#39;s used from
&gt;  both within Log4perl and outside and there&#39;s no easy way to determine
&gt; the depth &#40;or so I thought at the time&#41;. If you have an idea on how to
&gt; replace it with caller_depth, feel free to play with it, the test suite
&gt; will complain if there&#39;s a mistake. Patches are definitely welcome.
</div>
Simply replacing it with what you suggest in the comments seems to work.
I read and re-read 024WarnDieCarp.t, and the tests there should be
catching any problems. Yet everything passes with flying colors.

Also the first line of callerline&#40;&#41; was:
my&#40;$message&#41; = @_;
which I changed to
my $message = join &#40;&#39;&#39;, @_&#41;;
for consistency with the rest of the interfaces. Ignore this change if
it breaks some legacy behavior &#40;doubt it&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; Additionally I noticed that in and_warn&#40;&#41; and and_die&#40;&#41; and at some
&gt;&gt; other places you use ...&#40;@_[0 .. $#_]&#41;, which is an extremely elaborate
&gt;&gt; way to say @_. What is the reason for this?
</div>&gt; 
&gt; It&#39;s indeed the same thing, the reason for this is most likely old code
&gt; that had a different range but got changed -- should be changed to @_
&gt; for better readability.
</div>
Fixed.

Also I made some &#40;dubious&#41; optimizations by replacing all possible
local&#40;&#41; invocations by $var++/$var-- whenever this is possible. This
simple proggy shows that local is 10% slower. Not that it really matters
but we are shaving CPU cycles right? :&#41;

use Benchmark qw/cmpthese/;

our $x = 3;

cmpthese &#40;-3, {
    inc_dec =&gt; sub {
        ++$x;
        do {1} for &#40;1 .. 10&#41;;
        --$x;
    },
    localized =&gt; sub {
        local $x = $x + 1;
        do {1} for &#40;1 .. 10&#41;;
    },
}&#41;;


Hope you find the patch useful.

Cheers!
Peter
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">? eg/benchmarks/incdec_vs_local
Index: lib/Log/Log4perl.pm
===================================================================
RCS file: /cvsroot/log4perl/Log-Log4perl/lib/Log/Log4perl.pm,v
retrieving revision 1.241
diff -u -r1.241 Log4perl.pm
--- lib/Log/Log4perl.pm	20 Aug 2008 01:22:25 -0000	1.241
+++ lib/Log/Log4perl.pm	21 Aug 2008 01:30:26 -0000
@@ -100,8 +100,6 @@
 
     if&#40;exists $tags{&#39;:levels&#39;}&#41; {
         # Export log levels &#40;$DEBUG, $INFO etc.&#41; from Log4perl::Level
-        my $caller_pkg = caller&#40;&#41;;
-
         for my $key &#40;keys %Log::Log4perl::Level::PRIORITY&#41; {
             my $name  = &#34;$caller_pkg\::$key&#34;;
                # Need to split this up in two lines, or CVS will
@@ -354,12 +352,12 @@
 
     if&#40;@_ == 0&#41; {
           # 1
-        $category = scalar caller&#40;&#41;;
+        $category = scalar caller&#40;$Log::Log4perl::caller_depth&#41;;
     } elsif&#40;@_ == 1&#41; {
           # 2, 3
         if&#40;$_[0] eq __PACKAGE__&#41; {
               # 2
-            $category = scalar caller&#40;&#41;;
+            $category = scalar caller&#40;$Log::Log4perl::caller_depth&#41;;
         } else {
             $category = $_[0];
         }
Index: lib/Log/Log4perl/Logger.pm
===================================================================
RCS file: /cvsroot/log4perl/Log-Log4perl/lib/Log/Log4perl/Logger.pm,v
retrieving revision 1.88
diff -u -r1.88 Logger.pm
--- lib/Log/Log4perl/Logger.pm	20 Aug 2008 01:16:21 -0000	1.88
+++ lib/Log/Log4perl/Logger.pm	21 Aug 2008 01:30:29 -0000
@@ -833,30 +833,20 @@
 # call me from a sub-func to spew the sub-func&#39;s caller
 #######################################################
 sub callerline {
-  # the below could all be just:
-  # my &#40;$pack, $file, $line&#41; = caller&#40;2&#41;;
-  # but if we every bury this further, it&#39;ll break. So we do this
-  # little trick stolen and paraphrased from Carp/Heavy.pm
-  my&#40;$message&#41; = @_;
-
-  my $i = 0;
-  my &#40;undef, $localfile, undef&#41; = caller&#40;$i++&#41;;
-  my &#40;$pack, $file, $line&#41;;
-  do {
-    &#40;$pack, $file, $line&#41; = caller&#40;$i++&#41;;
-  } while &#40;$file &#38;&#38; $file eq $localfile&#41;;
-
-  my $has_newline;
-
-  $has_newline++ if chomp $message;
-
-  $message .= &#34; at $file line $line&#34; if !$has_newline;
-
-  # Someday, we&#39;ll use Threads. Really.
-  if &#40;defined &#38;Thread::tid&#41; {
-    my $tid = Thread-&gt;self-&gt;tid;
-    $message .= &#34; thread $tid&#34; if $tid and !$has_newline;
+  my $message = join &#40;&#39;&#39;, @_&#41;;
+
+  my &#40;$pack, $file, $line&#41; = caller&#40;$Log::Log4perl::caller_depth + 1&#41;;
+
+  if &#40;not chomp $message&#41; {     # no newline
+    $message .= &#34; at $file line $line&#34;;
+
+    # Someday, we&#39;ll use Threads. Really.
+    if &#40;defined &#38;Thread::tid&#41; {
+      my $tid = Thread-&gt;self-&gt;tid;
+      $message .= &#34; thread $tid&#34; if $tid;
+    }
   }
+
   return &#40;$message, &#34;\n&#34;&#41;;
 }
 
@@ -864,15 +854,14 @@
 sub and_warn {
 #######################################################
   my $self = shift;
-  my $msg = join&#40;&#34;&#34;, @_[0 .. $#_]&#41;;
-  CORE::warn&#40;callerline&#40;$self-&gt;warning_render&#40;@_[0 .. $#_]&#41;&#41;&#41;;
+  CORE::warn&#40;callerline&#40;$self-&gt;warning_render&#40;@_&#41;&#41;&#41;;
 }
 
 #######################################################
 sub and_die {
 #######################################################
   my $self = shift;
-  die&#40;callerline&#40;$self-&gt;warning_render&#40;@_[0 .. $#_]&#41;&#41;&#41;;
+  die&#40;callerline&#40;$self-&gt;warning_render&#40;@_&#41;&#41;&#41;;
 }
 
 ##################################################
@@ -936,11 +925,11 @@
 
   if &#40;$self-&gt;is_warn&#40;&#41;&#41; {
     my $message = Carp::longmess&#40;$msg&#41;;
-    local $Log::Log4perl::caller_depth = 
-          $Log::Log4perl::caller_depth + 1;
+    $Log::Log4perl::caller_depth++;
     foreach &#40;split&#40;/\n/, $message&#41;&#41; {
       $self-&gt;warn&#40;&#34;$_\n&#34;&#41;;
     }
+    $Log::Log4perl::caller_depth--;
     Carp::cluck&#40;$msg&#41;;
   }
 }
@@ -955,11 +944,11 @@
 
   if &#40;$self-&gt;is_warn&#40;&#41;&#41; {
     my $message = Carp::shortmess&#40;$msg&#41;;
-    local $Log::Log4perl::caller_depth = 
-          $Log::Log4perl::caller_depth + 1;
+    $Log::Log4perl::caller_depth++;
     foreach &#40;split&#40;/\n/, $message&#41;&#41; {
       $self-&gt;warn&#40;&#34;$_\n&#34;&#41;;
     }
+    $Log::Log4perl::caller_depth--;
     Carp::carp&#40;$msg&#41; if $Log::Log4perl::LOGDIE_MESSAGE_ON_STDERR;
   }
 }
@@ -974,13 +963,13 @@
   local $Carp::CarpLevel = $Carp::CarpLevel + 1;
   my $msg = $self-&gt;warning_render&#40;@_&#41;;
 
-  my $message = Carp::shortmess&#40;$msg&#41;;
-  local $Log::Log4perl::caller_depth = 
-        $Log::Log4perl::caller_depth + 1;
   if &#40;$self-&gt;is_fatal&#40;&#41;&#41; {
+    my $message = Carp::shortmess&#40;$msg&#41;;
+    $Log::Log4perl::caller_depth++;
     foreach &#40;split&#40;/\n/, $message&#41;&#41; {
       $self-&gt;fatal&#40;&#34;$_\n&#34;&#41;;
     }
+    $Log::Log4perl::caller_depth--;
   }
 
   $Log::Log4perl::LOGDIE_MESSAGE_ON_STDERR ? 
@@ -993,16 +982,16 @@
 ##################################################
   my $self = shift;
 
-  my $msg = $self-&gt;warning_render&#40;@_&#41;;
   local $Carp::CarpLevel = $Carp::CarpLevel + 1;
+  my $msg = $self-&gt;warning_render&#40;@_&#41;;
 
-  my $message = Carp::longmess&#40;$msg&#41;;
-  local $Log::Log4perl::caller_depth = 
-        $Log::Log4perl::caller_depth + 1;
   if &#40;$self-&gt;is_fatal&#40;&#41;&#41; {
+    my $message = Carp::longmess&#40;$msg&#41;;
+    $Log::Log4perl::caller_depth++;
     foreach &#40;split&#40;/\n/, $message&#41;&#41; {
       $self-&gt;fatal&#40;&#34;$_\n&#34;&#41;;
     }
+    $Log::Log4perl::caller_depth--;
   }
 
   $Log::Log4perl::LOGDIE_MESSAGE_ON_STDERR ? 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;10&nbsp;08:10:18&nbsp;2008</span>
    <span class="description">rabbit [...] rabbit.us -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #38356] Weirdness in callerline&#40;&#41;, and_warn&#40;&#41;, and_die&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 10 Sep 2008 14:09:58 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Log-Log4perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;rabbit [...] rabbit.us&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Michael,

Sorry for nagging, but I checked the CVS and the patch I sent a month
ago does not seem to have been applied yet. Please let me know if there
are any objections to the patch, or did it simply fall of the radar.

Thanks!

Peter
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;10&nbsp;12:27:07&nbsp;2008</span>
    <span class="description">MSCHILLI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Peter,

sorry for the slow response, I&#39;ve looked over the patch and it looks
great! Applied to CVS, will be rolled out with 1.19.

Thanks so much.

-- Mike
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;10&nbsp;12:27:09&nbsp;2008</span>
    <span class="description">MSCHILLI [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
