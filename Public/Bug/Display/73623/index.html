<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #73623 for Encode: [perl #107326] perl&#39;s unicode conversion fails when iconv succeeds </title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #73623 for Encode: [perl #107326] perl&#39;s unicode conversion fails when iconv succeeds </h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Encode">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Encode">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Encode">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Encode">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Encode">Encode CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">73623</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Encode">Encode</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
perlbug-followup [...] perl.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-12062-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-12063-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




test.in<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1016689/530073/test.in">
Fri Dec 30 14:00:32 2011 (672b) by perlbug-followup [...] perl.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=73623">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1016689" href="/Public/Bug/Display.html?id=73623#txn-1016689">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;14:00:32&nbsp;2011</span>
    <span class="description">perlbug-followup [...] perl.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> perl5-porters [...] perl.org, bug-Encode [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [perl #107326] perl&#39;s unicode conversion fails when iconv succeeds </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 30 Dec 2011 11:00:23 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;OtherRecipients of perl Ticket #107326&#34;:;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Father Chrysostomos via RT&#34; &lt;perlbug-followup [...] perl.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016689/530072/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530072">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 30 10:41:46 2011, LAWalsh wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; This is a bug report for perl from perl-diddler@tlinx.org,
&gt; generated with the help of perlbug 1.39 running under perl 5.12.3.
&gt; 
&gt; 
&gt; -----------------------------------------------------------------
&gt; [Please describe your issue here]
&gt; 
&gt; Was looking at ways to do upper/lower case compare, and bumped into
&gt; piconv as being a &#39;drop in replacement for &#34;iconv&#34;&#39;.  So I decided to try
&gt; it thinking it would be a &#39;hoot&#39; if it was faster.
&gt; 
&gt; Rather than faster, it choked at the beginning of my 98M test file
&gt; &#40;i.e. I truncated the file to the first few lines, 672 bytes&#41;, which
&gt; reproduces the problem just fine .. Trï¿½s sad...
&gt; 
</div>
Youâ€˜re right:

$ piconv5.15.6 -f utf16 -t utf-8 /Users/sprout/Downloads/test.in
UTF-16:Unrecognised BOM d at
/usr/local/lib/perl5/5.15.6/darwin-thread-multi-2level/Encode.pm line
196, &lt;$ifh&gt; line 2.

The file begins with &lt;FF&gt;&lt;FE&gt;.

If I use utf-16le explicitly, it does the first line correctly, but
quickly switches to Chinese, which means itâ€™s off by one byte.  If I use
utf-16be explicitly, the first line is in Chinese.

This is part of the Encode distribution, for which CPAN is upstream, so
Iâ€™m forwarding this to the CPAN ticket.

-- 

Father Chrysostomos


---
via perlbug:  queue: perl5 status: new
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org:443/rt3/Ticket/Display.html?id=107326">https://rt.perl.org:443/rt3/Ticket/Display.html?id=107326</a></span>
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016689/530073/test.in">Download test.in</a><br />
<span class="downloadcontenttype">application/octet-stream 672b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1016741" href="/Public/Bug/Display.html?id=73623#txn-1016741">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;17:36:19&nbsp;2011</span>
    <span class="description">IKEGAMI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016741/530111/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530111">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 30 14:00:32 2011, perlbug-followup@perl.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Dec 30 10:41:46 2011, LAWalsh wrote:
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; This is a bug report for perl from perl-diddler@tlinx.org,
&gt; &gt; generated with the help of perlbug 1.39 running under perl 5.12.3.
&gt; &gt; 
&gt; &gt; 
&gt; &gt; -----------------------------------------------------------------
&gt; &gt; [Please describe your issue here]
&gt; &gt; 
&gt; &gt; Was looking at ways to do upper/lower case compare, and bumped into
&gt; &gt; piconv as being a &#39;drop in replacement for &#34;iconv&#34;&#39;.  So I decided
</div></div>to try
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; it thinking it would be a &#39;hoot&#39; if it was faster.
&gt; &gt; 
&gt; &gt; Rather than faster, it choked at the beginning of my 98M test file
&gt; &gt; &#40;i.e. I truncated the file to the first few lines, 672 bytes&#41;, which
&gt; &gt; reproduces the problem just fine .. Trï¿½s sad...
&gt; &gt; 
</div>&gt; 
&gt; Youâ€˜re right:
&gt; 
&gt; $ piconv5.15.6 -f utf16 -t utf-8 /Users/sprout/Downloads/test.in
&gt; UTF-16:Unrecognised BOM d at
&gt; /usr/local/lib/perl5/5.15.6/darwin-thread-multi-2level/Encode.pm line
&gt; 196, &lt;$ifh&gt; line 2.
&gt; 
&gt; The file begins with &lt;FF&gt;&lt;FE&gt;.
&gt; 
&gt; If I use utf-16le explicitly, it does the first line correctly, but
&gt; quickly switches to Chinese, which means itâ€™s off by one byte.
</div>
It sounds like it&#39;s reading line-by-line, where a line is a sequence of
bytes ended by 0A. Of course, that&#39;s wrong for UTF-16le &#40;and UTF-16be,
for that matter&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1016744" href="/Public/Bug/Display.html?id=73623#txn-1016744">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;17:36:20&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1016745" href="/Public/Bug/Display.html?id=73623#txn-1016745">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;17:49:01&nbsp;2011</span>
    <span class="description">IKEGAMI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016745/530114/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530114">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 225b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fix:

-    my $need2slurp = $use_bom{ find_encoding&#40;$to&#41;-&gt;name };
+    my $need2slurp = $use_bom{ find_encoding&#40;$from&#41;-&gt;name };
+    if &#40;$Opt{debug}&#41;{
+        printf &#34;Read mode: %s\n&#34;, $need2slurp ? &#39;Slurp&#39; : &#39;Line&#39;;
+    }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1016748" href="/Public/Bug/Display.html?id=73623#txn-1016748">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;18:15:24&nbsp;2011</span>
    <span class="description">pause [...] tlinx.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016748/530117/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530117">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 706b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 30 17:49:01 2011, ikegami wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Fix:
&gt; 
&gt; -    my $need2slurp = $use_bom{ find_encoding&#40;$to&#41;-&gt;name };
&gt; +    my $need2slurp = $use_bom{ find_encoding&#40;$from&#41;-&gt;name };
&gt; +    if &#40;$Opt{debug}&#41;{
&gt; +        printf &#34;Read mode: %s\n&#34;, $need2slurp ? &#39;Slurp&#39; : &#39;Line&#39;;
&gt; +    }
</div>

----
Not to be pushy or anything, but where does one apply that fix?  I
couldn&#39;t find a any need2slurp in my 
/usr/lib/perl5/{5.1{0.0,2.{1,3}}.0,{site,vendor}_perl} library dirs, so
I don&#39;t know that the above lines were responsible for this particular
breakage...but then I may not be searching in the right spots...

As for the lines in the file I submitted-- they looked like they all had
CRLF as line separators...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1016758" href="/Public/Bug/Display.html?id=73623#txn-1016758">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;18:32:00&nbsp;2011</span>
    <span class="description">ikegami [...] adaelis.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> perlbug-followup [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73623] [perl #107326] perl&#39;s unicode conversion fails when iconv succeeds</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 30 Dec 2011 18:31:51 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Encode [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Brine &lt;ikegami [...] adaelis.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016758/530124/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530124">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 896b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Dec 30, 2011 at 6:15 PM, Linda A Walsh via RT &lt;
bug-Encode@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73623">https://rt.cpan.org/Ticket/Display.html?id=73623</a></span> &gt;
&gt;
&gt; On Fri Dec 30 17:49:01 2011, ikegami wrote:
<div class="message-stanza open">&gt; &gt; Fix:
&gt; &gt;
&gt; &gt; -    my $need2slurp = $use_bom{ find_encoding&#40;$to&#41;-&gt;name };
&gt; &gt; +    my $need2slurp = $use_bom{ find_encoding&#40;$from&#41;-&gt;name };
&gt; &gt; +    if &#40;$Opt{debug}&#41;{
&gt; &gt; +        printf &#34;Read mode: %s\n&#34;, $need2slurp ? &#39;Slurp&#39; : &#39;Line&#39;;
&gt; &gt; +    }
</div>&gt;
&gt;
&gt; ----
&gt; Not to be pushy or anything, but where does one apply that fix?  I
&gt; couldn&#39;t find a any need2slurp in my
&gt; /usr/lib/perl5/{5.1{0.0,2.{1,3}}.0,{site,vendor}_perl} library dirs, so
&gt; I don&#39;t know that the above lines were responsible for this particular
&gt; breakage...but then I may not be searching in the right spots...
&gt;
&gt; As for the lines in the file I submitted-- they looked like they all had
&gt; CRLF as line separators...
&gt;
</div>
piconv
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016758/530125/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530125">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1.3k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1016761" href="/Public/Bug/Display.html?id=73623#txn-1016761">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;18:39:23&nbsp;2011</span>
    <span class="description">ikegami [...] adaelis.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> perlbug-followup [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73623] [perl #107326] perl&#39;s unicode conversion fails when iconv succeeds</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 30 Dec 2011 18:39:14 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Encode [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Brine &lt;ikegami [...] adaelis.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016761/530129/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530129">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 397b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Dec 30, 2011 at 6:15 PM, Linda A Walsh via RT &lt;
bug-Encode@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; As for the lines in the file I submitted-- they looked like they all had
&gt; CRLF as line separators...
&gt;
</div>
Probably. And not really relevant.

piconv was treating your file as a series of lines ending with 0A *before
decoding*. LF is not 0A in UTF-16le, and an 0A is not necessarily part of a
LF in UTF-16le.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016761/530130/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530130">with headers</a>
<br />
<span class="downloadcontenttype">text/html 649b</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1016764" href="/Public/Bug/Display.html?id=73623#txn-1016764">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;18:44:35&nbsp;2011</span>
    <span class="description">pause [...] tlinx.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016764/530133/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530133">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 580b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 30 17:49:01 2011, ikegami wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Fix:
&gt; 
&gt; -    my $need2slurp = $use_bom{ find_encoding&#40;$to&#41;-&gt;name };
&gt; +    my $need2slurp = $use_bom{ find_encoding&#40;$from&#41;-&gt;name };
&gt; +    if &#40;$Opt{debug}&#41;{
&gt; +        printf &#34;Read mode: %s\n&#34;, $need2slurp ? &#39;Slurp&#39; : &#39;Line&#39;;
&gt; +    }
</div>=====
Partly works:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; piconv -f UTF-16 -t UTF-8 &lt;test.in &gt;test.out
&gt; iconv -f UTF-16 -t UTF-8 &lt;test.in &gt;testi.out
&gt; cmp testi.out test.out &#38;&#38; echo ok
</div>ok
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; piconv -f UTF-8 -t UTF-16 &lt;test.out &gt;test2.out 
&gt; cmp testi.in test2.out
</div>test.in test2.out differ: byte 1, line 1



test.out was same size 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1016767" href="/Public/Bug/Display.html?id=73623#txn-1016767">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;18:49:46&nbsp;2011</span>
    <span class="description">pause [...] tlinx.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016767/530136/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530136">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 763b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 30 18:44:35 2011, LAWALSH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Dec 30 17:49:01 2011, ikegami wrote:
<div class="message-stanza open">&gt; &gt; Fix:
&gt; &gt; 
&gt; &gt; -    my $need2slurp = $use_bom{ find_encoding&#40;$to&#41;-&gt;name };
&gt; &gt; +    my $need2slurp = $use_bom{ find_encoding&#40;$from&#41;-&gt;name };
&gt; &gt; +    if &#40;$Opt{debug}&#41;{
&gt; &gt; +        printf &#34;Read mode: %s\n&#34;, $need2slurp ? &#39;Slurp&#39; : &#39;Line&#39;;
&gt; &gt; +    }
</div>&gt; =====
&gt; Partly works:
<div class="message-stanza open">&gt; &gt; piconv -f UTF-16 -t UTF-8 &lt;test.in &gt;test.out
&gt; &gt; iconv -f UTF-16 -t UTF-8 &lt;test.in &gt;testi.out
&gt; &gt; cmp testi.out test.out &#38;&#38; echo ok
</div>&gt; ok
<div class="message-stanza open">&gt; &gt; piconv -f UTF-8 -t UTF-16 &lt;test.out &gt;test2.out 
&gt; &gt; cmp testi.in test2.out
</div></div>          ^^^^ typo.. was &#39;test&#39;...

anyway. the piconv doesn&#39;t do round trip, the way iconv does.

Sounds like it might be assuming UTF-16 means BE and not LE?

Just a WAG..
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1016770" href="/Public/Bug/Display.html?id=73623#txn-1016770">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;18:57:52&nbsp;2011</span>
    <span class="description">pause [...] tlinx.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016770/530139/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530139">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 509b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 30 18:49:46 2011, LAWALSH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Dec 30 18:44:35 2011, LAWALSH wrote:
<div class="message-stanza open">&gt;&gt; # piconv -f UTF-8 -t UTF-16 &lt;test.out &gt;test2.out 
&gt;&gt; # cmp test.in test2.out
&gt;&gt; test.in test2.out differ: byte 1, line 1 test.out was same size 
</div>&gt; 
&gt; Sounds like it might be assuming UTF-16 means BE and not LE?
</div>----
Yup:

cmp -l -b test.in test2.out
  1 377 M-^? 376 M-~
  2 376 M-~  377 M-^?
  3 127 W      0 ^@
  4   0 ^@   127 W
  5 151 i      0 ^@
...
671  12 ^J     0 ^@
672   0 ^@   134 \
cmp: EOF on test.in
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1016773" href="/Public/Bug/Display.html?id=73623#txn-1016773">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;19:01:30&nbsp;2011</span>
    <span class="description">ikegami [...] adaelis.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> perlbug-followup [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73623] [perl #107326] perl&#39;s unicode conversion fails when iconv succeeds</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 30 Dec 2011 19:01:22 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Encode [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Brine &lt;ikegami [...] adaelis.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016773/530143/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530143">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 944b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Dec 30, 2011 at 6:44 PM, Linda A Walsh via RT &lt;
bug-Encode@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73623">https://rt.cpan.org/Ticket/Display.html?id=73623</a></span> &gt;
&gt;
&gt; On Fri Dec 30 17:49:01 2011, ikegami wrote:
<div class="message-stanza open">&gt; &gt; Fix:
&gt; &gt;
&gt; &gt; -    my $need2slurp = $use_bom{ find_encoding&#40;$to&#41;-&gt;name };
&gt; &gt; +    my $need2slurp = $use_bom{ find_encoding&#40;$from&#41;-&gt;name };
&gt; &gt; +    if &#40;$Opt{debug}&#41;{
&gt; &gt; +        printf &#34;Read mode: %s\n&#34;, $need2slurp ? &#39;Slurp&#39; : &#39;Line&#39;;
&gt; &gt; +    }
</div>&gt; =====
&gt; Partly works:
<div class="message-stanza open">&gt; &gt; piconv -f UTF-16 -t UTF-8 &lt;test.in &gt;test.out
&gt; &gt; iconv -f UTF-16 -t UTF-8 &lt;test.in &gt;testi.out
&gt; &gt; cmp testi.out test.out &#38;&#38; echo ok
</div>&gt; ok
<div class="message-stanza open">&gt; &gt; piconv -f UTF-8 -t UTF-16 &lt;test.out &gt;test2.out
&gt; &gt; cmp testi.in test2.out
</div>&gt; test.in test2.out differ: byte 1, line 1
&gt;
</div>
C&lt;&lt; decode&#40;&#39;UTF-16&#39;, ...&#41; &gt;&gt; both requires a BOM and removes it
&#40;intentionally&#41;.

If you want to keep the BOM, use UTF-16le &#40;the actual encoding&#41; instead of
UTF-16.

This is unrelated to this ticket.

- Eric
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016773/530144/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530144">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1.6k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1016776" href="/Public/Bug/Display.html?id=73623#txn-1016776">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;19:04:31&nbsp;2011</span>
    <span class="description">ikegami [...] adaelis.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> perlbug-followup [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73623] [perl #107326] perl&#39;s unicode conversion fails when iconv succeeds</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 30 Dec 2011 19:04:22 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Encode [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Brine &lt;ikegami [...] adaelis.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016776/530148/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530148">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Dec 30, 2011 at 7:01 PM, Eric Brine &lt;ikegami@adaelis.com&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri, Dec 30, 2011 at 6:44 PM, Linda A Walsh via RT &lt;
&gt; bug-Encode@rt.cpan.org&gt; wrote:
&gt;
<div class="message-stanza open">&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73623">https://rt.cpan.org/Ticket/Display.html?id=73623</a></span> &gt;
&gt;&gt;
&gt;&gt; On Fri Dec 30 17:49:01 2011, ikegami wrote:
<div class="message-stanza open">&gt;&gt; &gt; Fix:
&gt;&gt; &gt;
&gt;&gt; &gt; -    my $need2slurp = $use_bom{ find_encoding&#40;$to&#41;-&gt;name };
&gt;&gt; &gt; +    my $need2slurp = $use_bom{ find_encoding&#40;$from&#41;-&gt;name };
&gt;&gt; &gt; +    if &#40;$Opt{debug}&#41;{
&gt;&gt; &gt; +        printf &#34;Read mode: %s\n&#34;, $need2slurp ? &#39;Slurp&#39; : &#39;Line&#39;;
&gt;&gt; &gt; +    }
</div>&gt;&gt; =====
&gt;&gt; Partly works:
<div class="message-stanza open">&gt;&gt; &gt; piconv -f UTF-16 -t UTF-8 &lt;test.in &gt;test.out
&gt;&gt; &gt; iconv -f UTF-16 -t UTF-8 &lt;test.in &gt;testi.out
&gt;&gt; &gt; cmp testi.out test.out &#38;&#38; echo ok
</div>&gt;&gt; ok
<div class="message-stanza open">&gt;&gt; &gt; piconv -f UTF-8 -t UTF-16 &lt;test.out &gt;test2.out
&gt;&gt; &gt; cmp testi.in test2.out
</div>&gt;&gt; test.in test2.out differ: byte 1, line 1
&gt;&gt;
</div>&gt;
</div>Correction/elaboration:

C&lt;&lt; decode&#40;&#39;UTF-16&#39;, ...&#41; &gt;&gt; both requires a BOM and removes it
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#40;intentionally&#41;.
&gt;
</div>
...and C&lt;&lt; encode&#40;&#39;UTF-16&#39;, ...&#41; &gt;&gt; adds it back, but uses UTF-16be instead
of UTF-16le.

You need C&lt;&lt; -to UTF-16le &gt;&gt; to use UTF-16le &#40;instead of UTF-16be&#41;, but
that won&#39;t add the BOM, you need to avoid removing it in the first place by
using C&lt;&lt; -from UTF-16le &gt;&gt;.

- Eric
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016776/530149/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530149">with headers</a>
<br />
<span class="downloadcontenttype">text/html 2.3k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1016818" href="/Public/Bug/Display.html?id=73623#txn-1016818">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;21:15:04&nbsp;2011</span>
    <span class="description">pause [...] tlinx.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016818/530175/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530175">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 30 19:04:31 2011, ikegami@adaelis.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri, Dec 30, 2011 at 7:01 PM, Eric Brine &lt;ikegami@adaelis.com&gt; wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; On Fri, Dec 30, 2011 at 6:44 PM, Linda A Walsh via RT &lt;
&gt; &gt; bug-Encode@rt.cpan.org&gt; wrote:
&gt; &gt;
<div class="message-stanza open">&gt; &gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73623">https://rt.cpan.org/Ticket/Display.html?id=73623</a></span> &gt;
&gt; &gt;&gt;
&gt; &gt;&gt; On Fri Dec 30 17:49:01 2011, ikegami wrote:
<div class="message-stanza open">&gt; &gt;&gt; &gt; Fix:
&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt; -    my $need2slurp = $use_bom{ find_encoding&#40;$to&#41;-&gt;name };
&gt; &gt;&gt; &gt; +    my $need2slurp = $use_bom{ find_encoding&#40;$from&#41;-&gt;name };
&gt; &gt;&gt; &gt; +    if &#40;$Opt{debug}&#41;{
&gt; &gt;&gt; &gt; +        printf &#34;Read mode: %s\n&#34;, $need2slurp ? &#39;Slurp&#39; : &#39;Line&#39;;
&gt; &gt;&gt; &gt; +    }
</div>&gt; &gt;&gt; =====
&gt; &gt;&gt; Partly works:
<div class="message-stanza open">&gt; &gt;&gt; &gt; piconv -f UTF-16 -t UTF-8 &lt;test.in &gt;test.out
&gt; &gt;&gt; &gt; iconv -f UTF-16 -t UTF-8 &lt;test.in &gt;testi.out
&gt; &gt;&gt; &gt; cmp testi.out test.out &#38;&#38; echo ok
</div>&gt; &gt;&gt; ok
<div class="message-stanza open">&gt; &gt;&gt; &gt; piconv -f UTF-8 -t UTF-16 &lt;test.out &gt;test2.out
&gt; &gt;&gt; &gt; cmp testi.in test2.out
</div>&gt; &gt;&gt; test.in test2.out differ: byte 1, line 1
</div>&gt; &gt;
&gt; &gt; Sounds like it might be assuming UTF-16 means BE and not LE?
</div></div>---- 
Yup: cmp -l -b test.in test2.out
1 377 M-^? 376 M-~ 
2 376 M-~ 377 M-^? 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt;
</div>&gt; Correction/elaboration:
&gt; 
&gt; C&lt;&lt; decode&#40;&#39;UTF-16&#39;, ...&#41; &gt;&gt; both requires a BOM and removes it
<div class="message-stanza open">&gt; &gt; &#40;intentionally&#41;.
</div></div>---
How is that a correction??


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ...and C&lt;&lt; encode&#40;&#39;UTF-16&#39;, ...&#41; &gt;&gt; adds it back, but uses UTF-16be
</div>instead
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; of UTF-16le.
</div>-----
Ah, then there&#39;s two rubs:

1&#41;...why would encode convert to BE on a LE machine?  Seems like exactly
the wrong decision to make.

2&#41; since piconv states that is &#34;designed to be a drop in replacement for
iconv&#34; and &#34;iconv seems to assume LE&#34;, &#40;maybe it only does so on LE
machines?&#41;... then I would assert there is a still a problem.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1016847" href="/Public/Bug/Display.html?id=73623#txn-1016847">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;23:26:12&nbsp;2011</span>
    <span class="description">ikegami [...] adaelis.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> perlbug-followup [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73623] [perl #107326] perl&#39;s unicode conversion fails when iconv succeeds</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 30 Dec 2011 23:26:02 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Encode [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Brine &lt;ikegami [...] adaelis.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016847/530196/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530196">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 565b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Dec 30, 2011 at 9:15 PM, Linda A Walsh via RT &lt;
bug-Encode@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73623">https://rt.cpan.org/Ticket/Display.html?id=73623</a></span> &gt;
&gt; How is that a correction??
&gt;
</div>
I was correcting what *I* said.

1&#41;...why would encode convert to BE on a LE machine?


What does Encode have to do with your machine?

2&#41; since piconv states that is &#34;designed to be a drop in replacement for
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; iconv&#34; and &#34;iconv seems to assume LE&#34;, &#40;maybe it only does so on LE
&gt; machines?&#41;... then I would assert there is a still a problem.
&gt;
</div>
Yes. Go ahead a file a bug if you want.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016847/530197/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530197">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1.2k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1016872" href="/Public/Bug/Display.html?id=73623#txn-1016872">#</a>      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;31&nbsp;02:39:35&nbsp;2011</span>
    <span class="description">pause [...] tlinx.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016872/530216/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530216">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 30 23:26:12 2011, ikegami@adaelis.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri, Dec 30, 2011 at 9:15 PM, Linda A Walsh via RT &lt;
&gt; bug-Encode@rt.cpan.org&gt; wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73623">https://rt.cpan.org/Ticket/Display.html?id=73623</a></span> &gt;
&gt; &gt; How is that a correction??
&gt; &gt;
</div>&gt; 
&gt; I was correcting what *I* said.
&gt; 
&gt; 1&#41;...why would encode convert to BE on a LE machine?
&gt; 
&gt; 
&gt; What does Encode have to do with your machine?
</div>----
That&#39;s where the test was run.

Data is usually in the machines native format unless you are
specifically trying to export it somewhere &#40;like over the Net, then
&#39;network byte order&#39; is used&#41;.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 2&#41; since piconv states that is &#34;designed to be a drop in replacement for
<div class="message-stanza open">&gt; &gt; iconv&#34; and &#34;iconv seems to assume LE&#34;, &#40;maybe it only does so on LE
&gt; &gt; machines?&#41;... then I would assert there is a still a problem.
&gt; &gt;
</div>&gt; 
&gt; Yes. Go ahead a file a bug if you want.
</div>---

The original test case showed
using iconv 2 directions... for some reason the perlbug SW chopped that
off .. anything after the uuencoded file I included, ws chopped off...
that had a whole explanation and demonstration of the bug using the
above data file &#40;above in the original bug report that seems to have
been corrupted by perl&#39;s bug system&#41;.

The bug was the piconv didn&#39;t work as a drop in for iconv as I took
a simple doc and converted to utf-8 and then back to utf-16, and
original and the twice converted compared identical.

I tried to do the same with piconv, but piconv failed at the first step.

Why the original bug report was truncated at the data point, seems to be
another bug in the perlbug reporting system.

Perhaps it would be better to report that one as this one is still not
fixed as the title perl&#39;;s conversion fails when iconv succeeds is still
true.  That&#39;s why I said &#39;closer&#39;, but not quite there.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1017965" href="/Public/Bug/Display.html?id=73623#txn-1017965">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;03&nbsp;09:00:50&nbsp;2012</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> perlbug-followup [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73623] [perl #107326] perl&#39;s unicode conversion fails when iconv succeeds</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 3 Jan 2012 14:00:37 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Linda A Walsh via RT &lt;bug-Encode [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1017965/530821/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530821">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 252b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Linda A Walsh via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;Data is usually in the machines native format unless you are
&gt;specifically trying to export it somewhere
</div>
That was the case in the 1980s.  Times have changed; machines are more
interconnected than they used to be.

-zefram
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.775705</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
