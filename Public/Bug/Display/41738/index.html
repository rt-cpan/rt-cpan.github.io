<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #41738 for Hash-Merge-Simple: questions and optimizations</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #41738 for Hash-Merge-Simple: questions and optimizations</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Hash-Merge-Simple">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Hash-Merge-Simple">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Hash-Merge-Simple">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Hash-Merge-Simple">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Hash-Merge-Simple">Hash-Merge-Simple CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">41738</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Hash-Merge-Simple">Hash-Merge-Simple</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
uri [...] stemsystems.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-221844-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-221845-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=41738">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-544217" href="/Public/Bug/Display.html?id=41738#txn-544217">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;15&nbsp;20:00:49&nbsp;2008</span>
    <span class="description">uri [...] stemsystems.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> questions and optimizations</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 15 Dec 2008 19:50:59 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-hash-merge-simple [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Uri Guttman &lt;uri [...] stemsystems.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/544217/273619/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/273619">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
hi,

i just found hash::merge::simple and i have some comments.

i think there is a subtle bug in how the hashes are copied/merged. the
left hash is copied at the top level but the lower level refs are the
same as in the left side. so if you modify left deep down after you
merged over it, it will modify both the left and the merged.
the returned hash ref is not the same as left but its guts may be shared
still. so either fix this or document that this is the behavior. you
aren&#39;t actually overlaying on left but it gives the impression you are
getting a complete copy of the merging. below is quick test which shows
this.

i intend to use this but i will have to do deep copies &#40;which i already
have&#41; before i do the merge. my data is filtered later on and if it is
shared between higher level things that could me filtering of filtered
data which is very bad. so knowing whether your module does deep copies
is important.

also i found some minor optimizations. 

        my $hr = &#40;ref $right-&gt;{$key} || &#39;&#39;&#41; eq &#39;HASH&#39;;
        my $hl  = &#40;&#40;exists $left-&gt;{$key} &#38;&#38; ref $left-&gt;{$key}&#41; || &#39;&#39;&#41; eq &#39;HASH&#39;;

        if &#40;$hr and $hl&#41;{

ref works on undef values and doesn&#39;t generate a warning. and accessing
a missing key a the top level of a hash will not autovivify it so you
don&#39;t need the exists call either. the first two lines can be reduced
to:

        my $hr = ref $right-&gt;{$key} eq &#39;HASH&#39;;
        my $hl = ref $left-&gt;{$key} eq &#39;HASH&#39;;

and that can be reduced to:

        my&#40; $hr, $hl &#41; = map ref $_-&gt;{$key} eq &#39;HASH&#39;, $right, $left ;

or not. :&#41;

so i will be copying the guts of this and making sure i do a deep copy
before i merge.

thanx,

uri

# this imported &#40;actually pasted :&#41; merge&#40;&#41;. note the output shows that
# the top level foo hash is copied &#40;the added aaa is only in left&#41; but
# the &#39;bar&#39; sub hash is modified in both left and merged.

use Data::Dumper ;

my $left = { foo =&gt; { bar =&gt; 2 } } ;
my $right = { baz =&gt; 4 } ;

my $merged = merge&#40; $left, $right &#41; ;

print Dumper $left, $merged ;

$left-&gt;{foo}{bar} = 3 ;
$left-&gt;{foo}{aaa} = 5 ;

print Dumper $left, $merged ;


-- 
Uri Guttman  ------  uri@stemsystems.com  --------  <span class="clickylink"><a target="new" rel="nofollow" href="http://www.sysarch.com">http://www.sysarch.com</a></span> --
-----  Perl Code Review , Architecture, Development, Training, Support ------
--------- Free Perl Training --- <span class="clickylink"><a target="new" rel="nofollow" href="http://perlhunter.com/college.html">http://perlhunter.com/college.html</a></span> ---------
---------  Gourmet Hot Cocoa Mix  ----  <span class="clickylink"><a target="new" rel="nofollow" href="http://bestfriendscocoa.com">http://bestfriendscocoa.com</a></span> ---------
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-568630" href="/Public/Bug/Display.html?id=41738#txn-568630">#</a>      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;22&nbsp;02:27:23&nbsp;2009</span>
    <span class="description">rkrimen [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/568630/286834/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/286834">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On Mon Dec 15 20:00:49 2008, uri@stemsystems.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; hi,
&gt; 
&gt; i just found hash::merge::simple and i have some comments.
&gt; 
&gt; i think there is a subtle bug in how the hashes are copied/merged. the
&gt; left hash is copied at the top level but the lower level refs are the
&gt; same as in the left side. so if you modify left deep down after you
&gt; merged over it, it will modify both the left and the merged.
&gt; the returned hash ref is not the same as left but its guts may be
&gt; shared
&gt; still. so either fix this or document that this is the behavior. you
&gt; aren&#39;t actually overlaying on left but it gives the impression you are
&gt; getting a complete copy of the merging. below is quick test which
&gt; shows
&gt; this.
&gt; 
&gt; i intend to use this but i will have to do deep copies &#40;which i
&gt; already
&gt; have&#41; before i do the merge. my data is filtered later on and if it is
&gt; shared between higher level things that could me filtering of filtered
&gt; data which is very bad. so knowing whether your module does deep
&gt; copies
&gt; is important.
&gt; 
&gt; also i found some minor optimizations.
&gt; 
&gt;         my $hr = &#40;ref $right-&gt;{$key} || &#39;&#39;&#41; eq &#39;HASH&#39;;
&gt;         my $hl  = &#40;&#40;exists $left-&gt;{$key} &#38;&#38; ref $left-&gt;{$key}&#41; || &#39;&#39;&#41;
&gt; eq &#39;HASH&#39;;
&gt; 
&gt;         if &#40;$hr and $hl&#41;{
&gt; 
&gt; ref works on undef values and doesn&#39;t generate a warning. and
&gt; accessing
&gt; a missing key a the top level of a hash will not autovivify it so you
&gt; don&#39;t need the exists call either. the first two lines can be reduced
&gt; to:
&gt; 
&gt;         my $hr = ref $right-&gt;{$key} eq &#39;HASH&#39;;
&gt;         my $hl = ref $left-&gt;{$key} eq &#39;HASH&#39;;
&gt; 
&gt; and that can be reduced to:
&gt; 
&gt;       my&#40; $hr, $hl &#41; = map ref $_-&gt;{$key} eq &#39;HASH&#39;, $right, $left ;
&gt; 
&gt; or not. :&#41;
&gt; 
&gt; so i will be copying the guts of this and making sure i do a deep copy
&gt; before i merge.
&gt; 
&gt; thanx,
&gt; 
&gt; uri
&gt; 
&gt; # this imported &#40;actually pasted :&#41; merge&#40;&#41;. note the output shows
&gt; that
&gt; # the top level foo hash is copied &#40;the added aaa is only in left&#41; but
&gt; # the &#39;bar&#39; sub hash is modified in both left and merged.
&gt; 
&gt; use Data::Dumper ;
&gt; 
&gt; my $left = { foo =&gt; { bar =&gt; 2 } } ;
&gt; my $right = { baz =&gt; 4 } ;
&gt; 
&gt; my $merged = merge&#40; $left, $right &#41; ;
&gt; 
&gt; print Dumper $left, $merged ;
&gt; 
&gt; $left-&gt;{foo}{bar} = 3 ;
&gt; $left-&gt;{foo}{aaa} = 5 ;
&gt; 
&gt; print Dumper $left, $merged ;
&gt; 
&gt; 
</div>
Thanks, I&#39;ve incorporated all your suggestions

I&#39;ve kept existing functionality as-is, and added clone_merge and
dclone_merge methods

Rob
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-568631" href="/Public/Bug/Display.html?id=41738#txn-568631">#</a>      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;22&nbsp;02:27:24&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-568632" href="/Public/Bug/Display.html?id=41738#txn-568632">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;22&nbsp;02:27:24&nbsp;2009</span>
    <span class="description">rkrimen [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.277032</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
