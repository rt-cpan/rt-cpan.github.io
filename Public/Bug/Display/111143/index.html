<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #111143 for Log-Dispatch: 08-screen.t fails with PERL_UNICODE and 5.22.1</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #111143 for Log-Dispatch: 08-screen.t fails with PERL_UNICODE and 5.22.1</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Log-Dispatch/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Log-Dispatch/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Log-Dispatch/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Log-Dispatch/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/houseabsolute/Log-Dispatch/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Log-Dispatch">Log-Dispatch CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">111143</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Log-Dispatch/Active/">Log-Dispatch</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cjm [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Unimportant    </td>
  </tr>
  <tr id="CF-19400-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.51    </td>
  </tr>
  <tr id="CF-19401-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;13&nbsp;00:38:40&nbsp;2016</span>
    <span class="description">cjm [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 08-screen.t fails with PERL_UNICODE and 5.22.1</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">With Perl 5.22.1, LANG=en_US.UTF-8, and PERL_UNICODE=SAL, 08-screen.t fails.  It succeeds if I set either LANG=C or PERL_UNICODE=0.

With Perl 5.20.2, the test passes even with PERL_UNICODE=SAL.

I&#39;ve attached the result of running

 perl5.22.1 t/00-report-prereqs.t &#38;&gt;/tmp/00-report-prereqs.txt

along with the results of 00-report-prereqs.t for both 5.20.2 and 5.22.1.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 08-screen.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"># testing
ok 1 - STDOUT layers are not changed when Screen utf8 param is true
    # Subtest: stderr = 0, utf8 = 0
    ok 1 - got expected stdout from Screen output
    ok 2 - got expected stderr from Screen output
    1..2
ok 2 - stderr = 0, utf8 = 0
    # Subtest: stderr = 1, utf8 = 0
    ok 1 - got expected stdout from Screen output
    ok 2 - got expected stderr from Screen output
    1..2
ok 3 - stderr = 1, utf8 = 0
    # Subtest: stderr = 0, utf8 = 1
    not ok 1 - got expected stdout from Screen output
    #   Failed test &#39;got expected stdout from Screen output&#39;
    #   at t/08-screen.t line 97.
    #          got: &#39;test message - á½ &#39;
    #     expected: &#39;test message - ὠ&#39;
    ok 2 - got expected stderr from Screen output
    1..2
    # Looks like you failed 1 test of 2.
not ok 4 - stderr = 0, utf8 = 1
#   Failed test &#39;stderr = 0, utf8 = 1&#39;
#   at t/08-screen.t line 106.
    # Subtest: stderr = 1, utf8 = 1
    ok 1 - got expected stdout from Screen output
    not ok 2 - got expected stderr from Screen output
    #   Failed test &#39;got expected stderr from Screen output&#39;
    #   at t/08-screen.t line 103.
    #          got: &#39;test message - á½ &#39;
    #     expected: &#39;test message - ὠ&#39;
    1..2
    # Looks like you failed 1 test of 2.
not ok 5 - stderr = 1, utf8 = 1
#   Failed test &#39;stderr = 1, utf8 = 1&#39;
#   at t/08-screen.t line 106.
1..5
# Looks like you failed 2 tests of 5.
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;13&nbsp;00:39:29&nbsp;2016</span>
    <span class="description">cjm [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="messagebody">
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 00-report-prereqs-5.20.2.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">1..1
# 
# Versions for all modules listed in static metadata &#40;including optional ones&#41;:
# 
# === Configure Requires ===
# 
#     Module               Want Have
#     -------------------- ---- ----
#     Dist::CheckConflicts 0.02 0.11
#     ExtUtils::MakeMaker   any 6.98
# 
# === Test Requires ===
# 
#     Module              Want     Have
#     ------------------- ---- --------
#     Data::Dumper         any    2.154
#     Exporter             any     5.71
#     ExtUtils::MakeMaker  any     6.98
#     File::Spec           any  3.48_01
#     File::Temp           any   0.2304
#     FindBin              any     1.51
#     Getopt::Long         any     2.42
#     IO::File             any     1.16
#     IPC::Run3            any    0.048
#     PerlIO               any     1.09
#     Test::Fatal          any    0.014
#     Test::More          0.96 1.001014
#     Test::Requires       any     0.08
#     lib                  any     0.63
#     utf8                 any  1.13_01
# 
# === Test Recommends ===
# 
#     Module         Want     Have
#     ---------- -------- --------
#     CPAN::Meta 2.120900 2.143240
# 
# === Runtime Requires ===
# 
#     Module                   Want   Have
#     ------------------------ ---- ------
#     Carp                      any 1.3301
#     Devel::GlobalDestruction  any   0.13
#     Dist::CheckConflicts     0.02   0.11
#     Encode                    any   2.70
#     Fcntl                     any   1.11
#     IO::Handle                any   1.35
#     Module::Runtime           any  0.014
#     Params::Validate         1.03   1.18
#     Scalar::Util              any   1.41
#     Sys::Syslog              0.28   0.33
#     base                      any   2.22
#     strict                    any   1.08
#     warnings                  any   1.23
# 
ok 1
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 00-report-prereqs-5.22.1.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">1..1
# 
# Versions for all modules listed in static metadata &#40;including optional ones&#41;:
# 
# === Configure Requires ===
# 
#     Module               Want    Have
#     -------------------- ---- -------
#     Dist::CheckConflicts 0.02    0.11
#     ExtUtils::MakeMaker   any 7.04_01
# 
# === Test Requires ===
# 
#     Module              Want     Have
#     ------------------- ---- --------
#     Data::Dumper         any    2.158
#     Exporter             any     5.72
#     ExtUtils::MakeMaker  any  7.04_01
#     File::Spec           any     3.56
#     File::Temp           any   0.2304
#     FindBin              any     1.51
#     Getopt::Long         any     2.45
#     IO::File             any     1.16
#     IPC::Run3            any    0.048
#     PerlIO               any     1.09
#     Test::Fatal          any    0.014
#     Test::More          0.96 1.001014
#     Test::Requires       any     0.10
#     lib                  any     0.63
#     utf8                 any     1.17
# 
# === Test Recommends ===
# 
#     Module         Want     Have
#     ---------- -------- --------
#     CPAN::Meta 2.120900 2.150001
# 
# === Runtime Requires ===
# 
#     Module                   Want  Have
#     ------------------------ ---- -----
#     Carp                      any  1.36
#     Devel::GlobalDestruction  any  0.13
#     Dist::CheckConflicts     0.02  0.11
#     Encode                    any  2.72
#     Fcntl                     any  1.13
#     IO::Handle                any  1.35
#     Module::Runtime           any 0.014
#     Params::Validate         1.03  1.21
#     Scalar::Util              any  1.41
#     Sys::Syslog              0.28  0.33
#     base                      any  2.22
#     strict                    any  1.09
#     warnings                  any  1.34
# 
ok 1
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;13&nbsp;01:00:55&nbsp;2016</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">relevant: <span class="clickylink"><a target="new" rel="nofollow" href="http://www.dagolden.com/index.php/1771/why-perl_unicode-makes-me-sad/">http://www.dagolden.com/index.php/1771/why-perl_unicode-makes-me-sad/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;13&nbsp;01:00:56&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;13&nbsp;01:09:39&nbsp;2016</span>
    <span class="description">cjm [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Jan 13, 2016 12:00:55 AM, ETHER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; relevant: <span class="clickylink"><a target="new" rel="nofollow" href="http://www.dagolden.com/index.php/1771/why-perl_unicode-makes-me-sad/">http://www.dagolden.com/index.php/1771/why-perl_unicode-makes-me-sad/</a></span>
</div>
Possibly, although I don&#39;t use D, just S&#40;tandard IO handles&#41; and A&#40;rgv&#41;.  &#40;L means that SA applies only if the locale is UTF-8, which is why LANG=C makes the test pass.&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;13&nbsp;01:16:27&nbsp;2016</span>
    <span class="description">DROLSKY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jan 13 01:09:39 2016, CJM wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed, Jan 13, 2016 12:00:55 AM, ETHER wrote:
<div class="message-stanza open">&gt; &gt; relevant: <span class="clickylink"><a target="new" rel="nofollow" href="http://www.dagolden.com/index.php/1771/why-perl_unicode-">http://www.dagolden.com/index.php/1771/why-perl_unicode-</a></span>
&gt; &gt; makes-me-sad/
</div>&gt; 
&gt; Possibly, although I don&#39;t use D, just S&#40;tandard IO handles&#41; and
&gt; A&#40;rgv&#41;.  &#40;L means that SA applies only if the locale is UTF-8, which
&gt; is why LANG=C makes the test pass.&#41;
</div>
It&#39;d probably the S causing the problem.

That said, I don&#39;t think running arbitrary tests with env vars that change the Perl interpreter&#39;s behavior should be expected to work.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;13&nbsp;01:26:59&nbsp;2016</span>
    <span class="description">cjm [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As xdg mentions in that article, it&#39;s useful to test modules the way they&#39;ll be used.

I&#39;m of the opinion that a test should clean up its environment if it&#39;s doing something tricky that breaks if certain variables are set.  In this case, the attached patch will work.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 08-screen.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- t/08-screen.t	2015-09-19 12:00:02.000000000 -0500
+++ t/08-screen.t	2016-01-13 00:18:10.053658763 -0600
@@ -16,6 +16,8 @@
 use Log::Dispatch;
 use PerlIO;
 
+delete $ENV{PERL_UNICODE};
+
 {
     my @orig_layers = PerlIO::get_layers&#40;STDOUT&#41;;
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;13&nbsp;10:08:48&nbsp;2016</span>
    <span class="description">dagolden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jan 13 01:16:27 2016, DROLSKY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That said, I don&#39;t think running arbitrary tests with env vars that
&gt; change the Perl interpreter&#39;s behavior should be expected to work.
</div>
People put all sorts of stuff in their environment, so tests ought to reset any that cause problems.  This is no different than PERL5LIB, PERL5OPT, etc.  Or setting up a temporary HOME directly to avoid automatically picking up config files.

PERL_UNICODE is just a particularly uncommon one.  :-/
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;13&nbsp;10:11:05&nbsp;2016</span>
    <span class="description">DROLSKY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jan 13 10:08:48 2016, DAGOLDEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Jan 13 01:16:27 2016, DROLSKY wrote:
<div class="message-stanza open">&gt; &gt; That said, I don&#39;t think running arbitrary tests with env vars that
&gt; &gt; change the Perl interpreter&#39;s behavior should be expected to work.
</div>&gt; 
&gt; People put all sorts of stuff in their environment, so tests ought to
&gt; reset any that cause problems.  This is no different than PERL5LIB,
&gt; PERL5OPT, etc.  Or setting up a temporary HOME directly to avoid
&gt; automatically picking up config files.
&gt; 
&gt; PERL_UNICODE is just a particularly uncommon one.  :-/
</div>
This is something that should be done in Test::More or something like that, then. Do we really expect every CPAN module to add boilerplate to every test to reset every possible env var that someone might set?

I&#39;m of course fine with patching this test now that we know the issue and the simple fix, but as a general rule I think that if you run tests with random perl env vars set, you should expect random failures.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;13&nbsp;12:50:36&nbsp;2016</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2016-01-13 07:11:05, DROLSKY wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is something that should be done in Test::More or something like
&gt; that, then. Do we really expect every CPAN module to add boilerplate
&gt; to every test to reset every possible env var that someone might set?
&gt; 
&gt; I&#39;m of course fine with patching this test now that we know the issue
&gt; and the simple fix, but as a general rule I think that if you run
&gt; tests with random perl env vars set, you should expect random
&gt; failures.
</div>
Having Test::More reset the variables entirely defeats the point of
being able to test a CPAN module working with particular variables set --
which is something an application may wish to do &#40;providing, of course,
that all the CPAN modules it uses actually *does* work with those variables,
which is what this patch is about&#41;.

This isn&#39;t a random variable -- it&#39;s one that affects the behaviour of
filehandle operations -- and so it&#39;s not unreasonable to try to make this
module work when the variable is set to various values.

I see it as similar to making a module work in various locales, or with
different filesystems. It may be an implementation variant that the author
hadn&#39;t thought of, or he doesn&#39;t have configured by default on his development
system, but that&#39;s why there are smokers, as well as a large contingent of
helpful users that send patches when edge cases are discovered :D

&#40;I&#39;m also now pondering which of my modules do interesting things with filehandles
that might need testing with PERL_UNICODE...&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;13&nbsp;16:16:21&nbsp;2016</span>
    <span class="description">DROLSKY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jan 13 12:50:36 2016, ETHER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Having Test::More reset the variables entirely defeats the point of
&gt; being able to test a CPAN module working with particular variables set
&gt; --
&gt; which is something an application may wish to do &#40;providing, of
&gt; course,
&gt; that all the CPAN modules it uses actually *does* work with those
&gt; variables,
&gt; which is what this patch is about&#41;.
</div>
Good point, except that this patch explicitly breaks your ability to test this module with the env var in question! In fact, it will mislead you into thinking that this will work when it fact it will not.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This isn&#39;t a random variable -- it&#39;s one that affects the behaviour of
&gt; filehandle operations -- and so it&#39;s not unreasonable to try to make
&gt; this
&gt; module work when the variable is set to various values.
</div>
There&#39;s a limit to how many different environments a module can be expected to work in. An environment that globally messes with every single filehandle is likely to break a lot of CPAN modules. This seems like one of those &#34;use at your own risk or with lots of testing things&#34;.

That said, if someone wants to patch the module &#40;not the test&#41; to make it actually do the right thing here, I would happily apply such a patch. I&#39;m not sure exactly what the right thing is or why it breaks though. I&#39;m guessing there some sort of double encoding issue going on.

Also, this is testing a &#34;utf8&#34; option that you would want to _not_ pass if you set this global env var in all your code. So maybe just a doc patch?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;27&nbsp;11:52:21&nbsp;2016</span>
    <span class="description">MAUKE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jan 13 16:16:21 2016, DROLSKY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Jan 13 12:50:36 2016, ETHER wrote:
<div class="message-stanza open">&gt; &gt;
&gt; &gt; Having Test::More reset the variables entirely defeats the point of
&gt; &gt; being able to test a CPAN module working with particular variables
&gt; &gt; set
&gt; &gt; --
&gt; &gt; which is something an application may wish to do &#40;providing, of
&gt; &gt; course,
&gt; &gt; that all the CPAN modules it uses actually *does* work with those
&gt; &gt; variables,
&gt; &gt; which is what this patch is about&#41;.
</div>&gt; 
&gt; Good point, except that this patch explicitly breaks your ability to
&gt; test this module with the env var in question! In fact, it will
&gt; mislead you into thinking that this will work when it fact it will
&gt; not.
&gt; 
<div class="message-stanza open">&gt; &gt; This isn&#39;t a random variable -- it&#39;s one that affects the behaviour
&gt; &gt; of
&gt; &gt; filehandle operations -- and so it&#39;s not unreasonable to try to make
&gt; &gt; this
&gt; &gt; module work when the variable is set to various values.
</div>&gt; 
&gt; There&#39;s a limit to how many different environments a module can be
&gt; expected to work in. An environment that globally messes with every
&gt; single filehandle is likely to break a lot of CPAN modules. This seems
&gt; like one of those &#34;use at your own risk or with lots of testing
&gt; things&#34;.
&gt; 
&gt; That said, if someone wants to patch the module &#40;not the test&#41; to make
&gt; it actually do the right thing here, I would happily apply such a
&gt; patch. I&#39;m not sure exactly what the right thing is or why it breaks
&gt; though. I&#39;m guessing there some sort of double encoding issue going
&gt; on.
&gt; 
&gt; Also, this is testing a &#34;utf8&#34; option that you would want to _not_
&gt; pass if you set this global env var in all your code. So maybe just a
&gt; doc patch?
</div>
I don&#39;t know about this problen but there&#39;s a kind of similar bug in DBI:
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=71341">https://rt.cpan.org/Ticket/Display.html?id=71341</a></span>

That one is caused by sending binary data over STDIN/STDOUT without calling binmode&#40;&#41; on them. Which breaks with PERL_UNICODE=S because that makes the STD* handles start out as &#34;:utf8&#34;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;13&nbsp;22:35:46&nbsp;2016</span>
    <span class="description">DROLSKY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ticket migrated to GitHub as <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/houseabsolute/Log-Dispatch/issues/32">https://github.com/houseabsolute/Log-Dispatch/issues/32</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;13&nbsp;22:35:53&nbsp;2016</span>
    <span class="description">DROLSKY [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
