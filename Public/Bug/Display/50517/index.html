<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #50517 for Hook-LexWrap: PATCH: memory leak when temp wrapping a named sub</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #50517 for Hook-LexWrap: PATCH: memory leak when temp wrapping a named sub</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Hook-LexWrap/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Hook-LexWrap/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Hook-LexWrap/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Hook-LexWrap/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Hook-LexWrap">Hook-LexWrap CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">50517</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Hook-LexWrap/Active/">Hook-LexWrap</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
NCLEATON [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-15410-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.22    </td>
  </tr>
  <tr id="CF-15411-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;15&nbsp;05:23:57&nbsp;2009</span>
    <span class="description">NCLEATON [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> PATCH: memory leak when temp wrapping a named sub</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">When Hook::LexWrap is used to temporarily wrap a named sub, the wrapper
is disabled rather than removed when the cleanup handle goes out of scope.

This is a big problem if code that will be called many times temporarily
wraps a sub by name.  Each call will leak at least one closure, and
maybe other objects.  The wrapped sub will also get slower and slower,
as each call to it must traverse a long chain of disabled wrappers.

The attached patch causes disabled wrappers around named subs to be
removed when possible.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> hl.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -Nurd Hook-LexWrap-0.22.orig/lib/Hook/LexWrap.pm Hook-LexWrap-0.22/lib/Hook/LexWrap.pm
--- Hook-LexWrap-0.22.orig/lib/Hook/LexWrap.pm	2008-12-18 23:49:46.000000000 +0200
+++ Hook-LexWrap-0.22/lib/Hook/LexWrap.pm	2009-10-15 09:36:26.000000000 +0200
@@ -4,6 +4,7 @@
 use warnings;
 our $VERSION = &#39;0.22&#39;;
 use Carp;
+use Scalar::Util qw&#40;weaken&#41;;
 
 {
 no warnings &#39;redefine&#39;;
@@ -23,6 +24,9 @@
 
 sub import { no strict &#39;refs&#39;; *{caller&#40;&#41;.&#34;::wrap&#34;} = \&#38;wrap }
 
+our %_unwrap_map;
+our $_unwrap_map_prune_countdown = 0;
+
 sub wrap &#40;*@&#41; {  ## no critic Prototypes
 	my &#40;$typeglob, %wrapper&#41; = @_;
 	$typeglob = &#40;ref $typeglob || $typeglob =~ /::/&#41;
@@ -82,7 +86,28 @@
 	        *{$typeglob} = $imposter;
 	}
 	return unless defined wantarray;
-	return bless sub{ $unwrap=1 }, &#39;Hook::LexWrap::Cleanup&#39;;
+	weaken&#40;my $woriginal = $original&#41;;
+	weaken&#40;my $wimposter = $imposter&#41;;
+	return bless sub {
+		$unwrap = 1; 
+		return unless defined $woriginal;
+		return unless defined $wimposter;
+		no strict &#39;refs&#39;;
+		if &#40;*{$typeglob}{CODE} eq $wimposter&#41; {
+			while &#40;$_unwrap_map{&#34;$woriginal&#34;}&#41; {
+				$woriginal = delete $_unwrap_map{&#34;$woriginal&#34;};
+			}
+			*{$typeglob} = $woriginal;
+		} else {
+			if &#40;++$_unwrap_map_prune_countdown &gt; 100&#41; {
+				foreach my $k &#40;keys %_unwrap_map&#41; {
+					defined $_unwrap_map{$k} or delete $_unwrap_map{$k};
+				}
+				$_unwrap_map_prune_countdown = 0;
+			}
+			weaken&#40;$_unwrap_map{&#34;$wimposter&#34;} = $woriginal&#41;;
+		}
+	}, &#39;Hook::LexWrap::Cleanup&#39;;
 }
 
 package Hook::LexWrap::Cleanup;
diff -Nurd Hook-LexWrap-0.22.orig/Makefile.PL Hook-LexWrap-0.22/Makefile.PL
--- Hook-LexWrap-0.22.orig/Makefile.PL	2008-11-06 13:05:25.000000000 +0200
+++ Hook-LexWrap-0.22/Makefile.PL	2009-10-15 09:31:14.000000000 +0200
@@ -10,6 +10,7 @@
     ABSTRACT_FROM       =&gt; &#39;lib/Hook/LexWrap.pm&#39;,
     PL_FILES            =&gt; {},
     PREREQ_PM =&gt; {
+        &#39;Scalar::Util&#39; =&gt; 0,
     },
     &#40;$ExtUtils::MakeMaker::VERSION ge &#39;6.31&#39;? 
      &#40;&#39;LICENSE&#39;		=&gt; &#39;perl&#39;, &#41; : &#40;&#41;&#41;,
diff -Nurd Hook-LexWrap-0.22.orig/t/leak.t Hook-LexWrap-0.22/t/leak.t
--- Hook-LexWrap-0.22.orig/t/leak.t	1970-01-01 02:00:00.000000000 +0200
+++ Hook-LexWrap-0.22/t/leak.t	2009-10-15 10:11:26.000000000 +0200
@@ -0,0 +1,77 @@
+use strict;
+use warnings;
+
+use Test::More;
+use Hook::LexWrap;
+
+$Foo::count = 0;
+sub Foo::new {
+    ++$Foo::count;
+    return bless {}, &#39;Foo&#39;;
+}
+sub Foo::DESTROY {
+    --$Foo::count;
+}
+
+# Install 4 layers of scope limited wrappers around a named sub, then delete
+# the cleanup handles &#40;and maybe the wrapped symbol table entry&#41; and check that
+# all the installed wrappers are cleaned up.
+# Repeat for all possible orderings of deleting the cleanup handles and
+# replacing the symbol table entry.
+
+plan tests =&gt; 6*4*3*2 * runtests_testcount&#40;&#41;;
+
+foreach my $replace_when &#40;0, 1, 2, 3, 4, &#39;never&#39;&#41; {
+    foreach my $blat1 &#40;0, 1, 2, 3&#41; {
+        foreach my $blat2 &#40;0, 1, 2&#41; {
+            foreach my $blat3 &#40;0, 1&#41; {
+                runtests&#40;$replace_when, $blat1, $blat2, $blat3&#41;;
+            }
+        }
+    }
+}
+
+my $wrapme_callcount = 0;
+sub wrapme_real {
+    ++$wrapme_callcount;
+}
+
+sub runtests {
+    my &#40;$replace_when, @blat&#41; = @_;
+    my $name = join &#39;,&#39;, @blat, &#34;r=$replace_when&#34;;
+
+    { no warnings &#39;redefine&#39;; *wrapme = \&#38;wrapme_real }
+    $Foo::count = $wrapme_callcount = 0;
+
+    my &#40;$a, $b&#41;;
+    my @cleanup_handles;
+    foreach my $layer &#40;1 .. 4&#41; {
+        my $foo = new Foo;
+        push @cleanup_handles, wrap &#39;wrapme&#39;,
+            pre  =&gt; sub { ++$a if $foo },
+            post =&gt; sub { ++$b if $foo };
+    }
+
+    my $glob_replaced = 0;
+    my $expect_wrapme_calls = 0;
+    foreach my $layers_installed &#40;4, 3, 2, 1, 0&#41; {
+        if &#40;$replace_when eq $layers_installed&#41; {
+            no warnings &#39;redefine&#39;;
+            *wrapme = sub {};
+            $glob_replaced = 1;
+        }
+        $a = $b = 0;
+        wrapme&#40;&#41;;
+        ++$expect_wrapme_calls unless $glob_replaced;
+        my $expect_prepost_calls = $glob_replaced ? 0 : $layers_installed;
+        is $a, $expect_prepost_calls, &#34;pre sub callcount $name&#34;;
+        is $b, $expect_prepost_calls, &#34;post sub callcount $name&#34;;
+
+        splice @cleanup_handles, shift&#40;@blat&#41;||0, 1 if @cleanup_handles;
+    }
+
+    is $Foo::count, 0, &#34;no closures leaked $name&#34;;
+    is $wrapme_callcount, $expect_wrapme_calls, &#34;wrapme callcount $name&#34;;
+}
+sub runtests_testcount { 5*2 + 2 }
+
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
