<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #29210 for Math-Currency: as_int&#40;&#41; method can return incorrect value</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #29210 for Math-Currency: as_int&#40;&#41; method can return incorrect value</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Math-Currency">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Math-Currency">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Math-Currency">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Math-Currency">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Math-Currency">Math-Currency CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">29210</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Math-Currency">Math-Currency</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">jpeacock [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
rybskej [...] yahoo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-20602-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.44    </td>
  </tr>
  <tr id="CF-20603-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




29210.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/360308/162972/29210.diff">
Mon Sep 10 05:04:36 2007 (1.2k) by zenoparadoxus [...] gmail.com
</a>
</font></li>
</ul>


math_currency_as_int_fp_err.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/359227/162364/math_currency_as_int_fp_err.pl">
Thu Sep 06 12:20:59 2007 (1.1k) by RYBSKEJ [...] cpan.org
</a>
</font></li>
</ul>


perl5_sol9_config.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/359227/162367/perl5_sol9_config.txt">
Thu Sep 06 12:20:59 2007 (3k) by RYBSKEJ [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=29210">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-359227" href="/Public/Bug/Display.html?id=29210#txn-359227">#</a>      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;06&nbsp;12:20:58&nbsp;2007</span>
    <span class="description">RYBSKEJ [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> as_int&#40;&#41; method can return incorrect value</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/359227/162361/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/162361">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Since as_int&#40;&#41; method uses multiplication to express the integer
part of the number, the CPU must translate this to a natural floating
point number and perform the operation.  Unfortunately, this 
introduces floating point approximation errors, leading to as_int
amounts that report *incorrectly* compared to their actual value as
stored in Math::Currency class.

I have attached a script that shows such error.  This script reported
numerous as_int&#40;&#41; floating point errors on 64-bit Perl on Solaris 9. &#40;My
Perl configuration information is attached to this report&#41;.

I found that in order to solve this, I ended up having to greatly
increase the floating point accuracy of the mathematical result
depending on the current value of the the number in the class, and then
shift off the approximation errors.  For example, as a functional patch
for USD currency &#40;2-decimal accuracy&#41;,  I modified my local
Math::Currency class to perform an inverse logarithmetic adjustment
&#40;dependent on the size of the internal integer number&#41; as follows:

sub as_int {    #with extra step to force 1 extra &#40;internal&#41; level of
                #fractional precision
  my $self = shift;

  my $prec_adj = int&#40;7 + &#40;4 / &#40;log&#40;$MBI-&gt;_len&#40; $self-&gt;{_m} &#41;&#41; || 1&#41;&#41;&#41;;
  $prec_adj = $prec_adj &gt; 10 ? 10 : $prec_adj &lt; 2 ? 2 : $prec_adj;

  return &#34;0&#34; unless $MBI-&gt;_len&#40; $self-&gt;{_m} &#41;;
  my $num_str = Math::BigInt-&gt;new&#40;
    $self-&gt;as_float * 10**&#40;$self-&gt;format&#40;&#41;-&gt;{FRAC_DIGITS} +
      $self-&gt;{_prec_adj}&#41;
    &#41;-&gt;bstr;
  return length&#40;$num_str&#41; &gt; 1
    ? substr&#40;$num_str,0, -1 * $self-&gt;{_prec_adj}&#41;
    : $num_str;
}

The mathematical adjustment choice was based on a relatively rough
approximation of the relative level of floating point approximation
error for 64-bit double values, based on the size of the integer and
decimal part together.  I then used truncation to remove the error-prone
decimal part section back to the original value decimal place accuracy.
Using brute-force testing, I have verified that this gives 100% accurate
amount results up to $100,000,000.00 &#40;2-decimal place values, 64-bit
doubles&#41;.  It&#39;s highly likely that this same method would work fine for
3-4 decimal place values.

I recommend additional research be done determine the best level of
floating point accuracy required for portability with 32 and 64 bit
double floats, but for the time being, I strongly recommend integration
of a general solution like the one I presented be done to guarantee that
as_int&#40;&#41; method returns 100% accurate values.

-Eric Rybski &#40;rybskej@yahoo.com&#41;
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> math_currency_as_int_fp_err.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/359227/162364/math_currency_as_int_fp_err.pl">Download math_currency_as_int_fp_err.pl</a><br />
<span class="downloadcontenttype">text/x-perl 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use sigtrap qw&#40;die untrapped normal-signals stack-trace error-signals&#41;;
use Math::Currency;

my $start = shift @ARGV || 0;
my $dollar_range = shift @ARGV || 10000000;

my &#40;$iter, $curr_err_cnt, $curr2_err_cnt&#41; = &#40;0, 0, 0&#41;;
my $time = time&#40;&#41;;
warn &#34;Test range: $start..$dollar_range&#34;;
for my $dollar &#40;$start..$dollar_range&#41; {
        for my $cent &#40;0..99&#41; {
                my $amt = &#34;$dollar.&#34;.&#40;$cent &lt; 10 ? &#34;0$cent&#34; : $cent&#41;;

                my $int = &#40;$dollar ? $dollar : &#34;&#34;&#41;
                        .&#40;$dollar ? $cent &lt; 10 ? &#34;0$cent&#34; : $cent : $cent&#41;;
                my $curr = new Math::Currency $amt;
                my $curr_int = $curr-&gt;as_int;
                if &#40;$curr_int ne $int&#41; {
                        warn &#34;      Math::Currency $curr&#40;&#34;.$curr_int.&#34;&#41; ne $int\n&#34;;
                        $curr_err_cnt++;
                }

                warn &#34;processed $amt so far...\n&#34; if $dollar % 1000 == 0 &#38;&#38; $cent % 100 == 0;
                $iter++;
        }
}

END {
        my $dr = new Math::Currency $dollar_range;
        print &#34;Done! &#40;took &#34;.&#40;time&#40;&#41; - $time&#41;.&#34; seconds&#41;\n&#34;;
        print &#34;From \$0 to $dr &#40;$iter iterations&#41;...\n&#34;;
        warn &#34;\tFound $curr_err_cnt Math::Currency fp errors\n&#34;;
}
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> perl5_sol9_config.txt</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/359227/162367/perl5_sol9_config.txt">Download perl5_sol9_config.txt</a><br />
<span class="downloadcontenttype">text/plain 3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Summary of my perl5 &#40;revision 5 version 8 subversion 7&#41; configuration:
  Platform:
    osname=solaris, osvers=2.9, archname=sun4-solaris-64
    uname=&#39;sunos usadev01 5.9 generic_117171-17 sun4u sparc sunw,sun-fire-v210 &#39;
    config_args=&#39;-Dcc=gcc -Doptimize=-O2 -Duse_large_files -Duse64bitall -Dusemorebits -Accflags=-mcpu=v9 -m64 -I/usr/local/include/v9 -I/usr/local/include -Aldflags=-mcpu=v9 -m64 -L/usr/lib/sparcv9 -L/usr/local/lib/sparcv9 -L/usr/local/BerkeleyDB64/lib -L/usr/lib -L/usr/local/lib -R/usr/lib/sparcv9 -R/usr/local/lib/sparcv9 -R/usr/local/BerkeleyDB64/lib -Alddlflags=-mcpu=v9 -m64 -L/usr/lib/sparcv9 -L/usr/local/lib/sparcv9 -L/usr/local/BerkeleyDB64/lib -L/usr/lib -L/usr/local/lib -R/usr/lib/sparcv9 -R/usr/local/lib/sparcv9 -R/usr/local/BerkeleyDB64/lib&#39;
    hint=recommended, useposix=true, d_sigaction=define
    usethreads=undef use5005threads=undef useithreads=undef usemultiplicity=undef
    useperlio=define d_sfio=undef uselargefiles=define usesocks=undef
    use64bitint=define use64bitall=define uselongdouble=undef
    usemymalloc=n, bincompat5005=undef
  Compiler:
    cc=&#39;gcc&#39;, ccflags =&#39;-mcpu=v9 -m64 -Wa,-xarch=v9 -mcpu=v9 -m64 -I/usr/local/include/v9 -I/usr/local/include -fno-strict-aliasing -pipe -I/usr/local/include -I/usr/local/BerkeleyDB64/include -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64&#39;,
    optimize=&#39;-O2&#39;,
    cppflags=&#39;-mcpu=v9 -m64 -Wa,-xarch=v9 -mcpu=v9 -m64 -I/usr/local/include/v9 -I/usr/local/include -fno-strict-aliasing -pipe -I/usr/local/include -I/usr/local/BerkeleyDB64/include&#39;
    ccversion=&#39;&#39;, gccversion=&#39;3.4.2&#39;, gccosandvers=&#39;solaris2.9&#39;
    intsize=4, longsize=8, ptrsize=8, doublesize=8, byteorder=87654321
    d_longlong=define, longlongsize=8, d_longdbl=define, longdblsize=16
    ivtype=&#39;long&#39;, ivsize=8, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;off_t&#39;, lseeksize=8
    alignbytes=8, prototype=define
  Linker and Libraries:
    ld=&#39;gcc&#39;, ldflags =&#39; -m64 -mcpu=v9 -m64 -L/usr/lib/sparcv9 -L/usr/local/lib/sparcv9 -L/usr/local/BerkeleyDB64/lib -L/usr/lib -L/usr/local/lib -R/usr/lib/sparcv9 -R/usr/local/lib/sparcv9 -R/usr/local/BerkeleyDB64/lib &#39;
    libpth=/usr/lib/sparcv9 /usr/local/lib/sparcv9 /usr/local/BerkeleyDB64/lib
    libs=-lsocket -lnsl -ldb -ldl -lm -lc -lpthread
    perllibs=-lsocket -lnsl -ldl -lm -lc -lpthread
    libc=/usr/lib/sparcv9/libc.so, so=so, useshrplib=true, libperl=libperl.so
    gnulibc_version=&#39;&#39;
  Dynamic Linking:
    dlsrc=dl_dlopen.xs, dlext=so, d_dlsymun=undef, ccdlflags=&#39;  -R /usr/local/lib/perl5/5.8.7/sun4-solaris-64/CORE&#39;
    cccdlflags=&#39;-fPIC&#39;, lddlflags=&#39; -G -m64 -mcpu=v9 -m64 -L/usr/lib/sparcv9 -L/usr/local/lib/sparcv9 -L/usr/local/BerkeleyDB64/lib -L/usr/lib -L/usr/local/lib -R/usr/lib/sparcv9 -R/usr/local/lib/sparcv9 -R/usr/local/BerkeleyDB64/lib&#39;


Characteristics of this binary &#40;from libperl&#41;:
  Compile-time options: USE_64_BIT_INT USE_64_BIT_ALL USE_LARGE_FILES
  Built under solaris
  Compiled at Sep 16 2005 17:16:32
  @INC:
    /usr/local/lib/perl5/5.8.7/sun4-solaris-64
    /usr/local/lib/perl5/5.8.7
    /usr/local/lib/perl5/site_perl/5.8.7/sun4-solaris-64
    /usr/local/lib/perl5/site_perl/5.8.7
    /usr/local/lib/perl5/site_perl
    .
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-359304" href="/Public/Bug/Display.html?id=29210#txn-359304">#</a>      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;06&nbsp;15:53:01&nbsp;2007</span>
    <span class="description">jpeacock [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-359321" href="/Public/Bug/Display.html?id=29210#txn-359321">#</a>      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;06&nbsp;16:30:17&nbsp;2007</span>
    <span class="description">jpeacock [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/359321/162437/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/162437">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Sep 06 12:20:58 2007, RYBSKEJ wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Since as_int&#40;&#41; method uses multiplication to express the integer
&gt; part of the number, the CPU must translate this to a natural floating
&gt; point number and perform the operation.  Unfortunately, this 
&gt; introduces floating point approximation errors, leading to as_int
&gt; amounts that report *incorrectly* compared to their actual value as
&gt; stored in Math::Currency class.
</div>
Um, no, that would just be a symptom of my having done this without
thinking about it carefully enough.  The whole point of using
Math::BigFloat/BigInt as a superclass for Math::Currency is so that I
don&#39;t have to worry about rounding errors &#40;nor play the kind of games
you did to get it to &#34;work&#34;&#41;.

Try this instead:

=== lib/Math/Currency.pm
==================================================================
--- lib/Math/Currency.pm        &#40;revision 647&#41;
+++ lib/Math/Currency.pm        &#40;local&#41;
@@ -304,8 +304,11 @@

 sub as_int {
     my $self = shift;
-    return Math::BigInt-&gt;new&#40;
-        $self-&gt;as_float * 10**$self-&gt;format&#40;&#41;-&gt;{FRAC_DIGITS} &#41;-&gt;bstr;
+    my $format = $self-&gt;format;
+    my $bint = Math::BigInt-&gt;new&#40;$self-&gt;copy-&gt;
+       bfround&#40; -$format-&gt;{FRAC_DIGITS}&#41;-&gt;
+       bmul&#40;10**$format-&gt;{FRAC_DIGITS}&#41;-&gt;SUPER::bstr&#41;;
+    return $bint-&gt;bstr;
 }

 # we override the default here because we only want to compare the
precision of

and let me know if that fixes your problems.

John
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-359322" href="/Public/Bug/Display.html?id=29210#txn-359322">#</a>      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;06&nbsp;16:30:42&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-360225" href="/Public/Bug/Display.html?id=29210#txn-360225">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;09&nbsp;22:27:07&nbsp;2007</span>
    <span class="description">RYBSKEJ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> RYBSKEJ [...] cpan.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/360225/162926/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/162926">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Sep 06 16:30:17 2007, JPEACOCK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Try this instead:
&gt; 
&gt; === lib/Math/Currency.pm
&gt; ==================================================================
&gt; --- lib/Math/Currency.pm        &#40;revision 647&#41;
&gt; +++ lib/Math/Currency.pm        &#40;local&#41;
&gt; @@ -304,8 +304,11 @@
&gt; 
&gt;  sub as_int {
&gt;      my $self = shift;
&gt; -    return Math::BigInt-&gt;new&#40;
&gt; -        $self-&gt;as_float * 10**$self-&gt;format&#40;&#41;-&gt;{FRAC_DIGITS} &#41;-&gt;bstr;
&gt; +    my $format = $self-&gt;format;
&gt; +    my $bint = Math::BigInt-&gt;new&#40;$self-&gt;copy-&gt;
&gt; +       bfround&#40; -$format-&gt;{FRAC_DIGITS}&#41;-&gt;
&gt; +       bmul&#40;10**$format-&gt;{FRAC_DIGITS}&#41;-&gt;SUPER::bstr&#41;;
&gt; +    return $bint-&gt;bstr;
&gt;  }
&gt; 
&gt;  # we override the default here because we only want to compare the
&gt; precision of
&gt; 
&gt; and let me know if that fixes your problems.
&gt; 
</div>
John,

   I appreciate the use of Math::BigFloat methods to solve the problem,
as I also overlooked them when I made my quick patch.  As a precaution,
I tested your patch from $0 to to $1M today with no fp errors, so I can
say with a high degree of confidence that your fix solves the problem
correctly and portably.

The only down side is the extra overhead Math::BigFloat methods
introduce here, as shown in the Benchmark comparisons below: 44% slower
than the semi-kludgy method I used &#40;which was about 10% slower than the
original, buggy as_int method&#41;.  &#40;Performance is an important
consideration for the software I&#39;m using this for, as it handles
millions of financial transactions daily.&#41;  Perhaps this &#40;or
Math::BigFloat&#41; can be optimized to better handle this in the future. 
&#40;Note: I did not yet test if using libgmp with Math::BigInt would
improve on this performance.&#41;

-Eric


$ # unmodified Math::Currency 0.4502
$ perl -MBenchmark=timethis -MMath::Currency -e &#39;timethis&#40;-5, sub {
Math::Currency-&gt;new&#40;$i++.&#39;.&#39;.50&#41;-&gt;as_int&#40;&#41;; }&#41;;&#39;
timethis for 5:  5 wallclock secs &#40; 4.52 usr +  0.48 sys =  5.00 CPU&#41; @
1770.40/s &#40;n=8852&#41;

$ # Math::Currency 0.4502 with Eric&#39;s as_int&#40;&#41; rough approximation error
trim method
$ perl -MBenchmark=timethis -MMath::Currency -e &#39;timethis&#40;-5, sub {
Math::Currency-&gt;new&#40;$i++.&#39;.&#39;.50&#41;-&gt;as_int&#40;&#41;; }&#41;;&#39;
timethis for 5:  5 wallclock secs &#40; 4.80 usr +  0.28 sys =  5.08 CPU&#41; @
1609.02/s &#40;n=8169&#41;

$ # Math::Currency 0.4502 with as_int&#40;&#41; author-recommended changes
$ perl -MBenchmark=timethis -MMath::Currency -e &#39;timethis&#40;-5, sub {
Math::Currency-&gt;new&#40;$i++.&#39;.&#39;.50&#41;-&gt;as_int&#40;&#41;; }&#41;;&#39;
timethis for 5:  5 wallclock secs &#40; 4.67 usr +  0.39 sys =  5.06 CPU&#41; @
905.57/s &#40;n=4584&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-360308" href="/Public/Bug/Display.html?id=29210#txn-360308">#</a>      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;10&nbsp;05:04:28&nbsp;2007</span>
    <span class="description">zenoparadoxus [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #29210] as_int&#40;&#41; method can return incorrect value</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 10 Sep 2007 05:02:27 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Math-Currency [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;John Peacock&#34; &lt;zenoparadoxus [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/360308/162972/29210.diff">Download 29210.diff</a><br />
<span class="downloadcontenttype">text/x-diff 1.2k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/360308/162970/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/162970">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 721b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 9/9/07, via RT &lt;bug-Math-Currency@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; The only down side is the extra overhead Math::BigFloat methods
&gt; introduce here, as shown in the Benchmark comparisons below: 44% slower
&gt; than the semi-kludgy method I used &#40;which was about 10% slower than the
&gt; original, buggy as_int method&#41;.  &#40;Performance is an important
&gt; consideration for the software I&#39;m using this for, as it handles
&gt; millions of financial transactions daily.&#41;
&gt;
</div>
A&#41; You&#39;re making me very nervous talking about using my pathetic little
class to perform millions of financial transactions daily... :-o

B&#41; I had another idea for efficiency - try the attached &#40;which my my
reckoning is even faster than the unpatched version&#41;...

John
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/360308/162971/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/162971">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-364489" href="/Public/Bug/Display.html?id=29210#txn-364489">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;22&nbsp;00:54:04&nbsp;2007</span>
    <span class="description">RYBSKEJ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/364489/165210/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/165210">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Sep 10 05:04:28 2007, zenoparadoxus@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; A&#41; You&#39;re making me very nervous talking about using my pathetic little
&gt; class to perform millions of financial transactions daily... :-o
&gt; 
&gt; B&#41; I had another idea for efficiency - try the attached &#40;which my my
&gt; reckoning is even faster than the unpatched version&#41;...
&gt; 
&gt; John
</div>
John,

   Perhaps we&#39;re approaching this problem too pragmatically.  How about
the following solution:

296,297c296,298
&lt;     return Math::BigInt-&gt;new&#40;
&lt;         $self-&gt;as_float * 10**$self-&gt;format&#40;&#41;-&gt;{FRAC_DIGITS} &#41;-&gt;bstr;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     &#40;my $str = $self-&gt;as_float&#41; =~ s/\.//o;
&gt;     $str =~ s/^&#40;\-?&#41;0+/$1/o;
&gt;     return $str eq &#39;&#39; ? &#39;0&#39; : $str;
</div>
perl -MBenchmark=timethis -MMath::Currency -e &#39;timethis&#40;-5, sub {
Math::Currency-&gt;new&#40;$i++.&#39;.&#39;.50&#41;-&gt;as_int&#40;&#41;; }&#41;;&#39;
timethis for 5:  5 wallclock secs &#40; 4.55 usr +  0.86 sys =  5.41 CPU&#41; @
2155.97/s &#40;n=11653&#41;

It&#39;s the fastest so far, yet still fully integer-accurate &#40;positive and
negative&#41;.  I ran through a quick test of -2000.00 to 2000.00 without
any errors.


For a full performance comparison, I ran an as_int&#40;&#41; comparison test of
Math::BigFloat vs. Math::Currency:

# Math::BigFloat &#40;note: doesn&#39;t round like Math::Currency does&#41;
$ perl -MBenchmark=timethis -MMath::Currency -e &#39;my
$n=Math::BigFloat-&gt;new&#40;&#34;1.50&#34;&#41;; timethis&#40;-5, sub { $n-&gt;as_int&#40;&#41;; }&#41;;&#39;
timethis for 5:  6 wallclock secs &#40; 5.31 usr +  0.00 sys =  5.31 CPU&#41; @
9177.87/s &#40;n=48762&#41;

# with the above-documented patch
$ perl -MBenchmark=timethis -MMath::Currency -e &#39;my
$n=Math::Currency-&gt;new&#40;&#34;1.50&#34;&#41;; timethis&#40;-5, sub { $n-&gt;as_int&#40;&#41;; }&#41;;&#39;
timethis for 5:  5 wallclock secs &#40; 4.36 usr +  0.75 sys =  5.11 CPU&#41; @
3822.27/s &#40;n=19528&#41;

# with your suggested patch
$ perl -MBenchmark=timethis -MMath::Currency -e &#39;my
$n=Math::Currency-&gt;new&#40;&#34;1.50&#34;&#41;; timethis&#40;-5, sub { $n-&gt;as_int&#40;&#41;; }&#41;;&#39;
timethis for 5:  5 wallclock secs &#40; 4.84 usr +  0.33 sys =  5.17 CPU&#41; @
631.74/s &#40;n=3268&#41;


At best, performance is 41.6% of the base class, so there&#39;s still room
for improvement.  To really wanted to maximize performance &#40;and if you
don&#39;t mind using Math::BigInt internal methods instead of public
methods&#41; you could probably emulate Math::BigFloat&#39;s as_int&#40;&#41; &#40;alias for
as_number&#41; method, with currency format-specific rounding.

But for now, if you&#39;re satisfied with the above patch, I&#39;d say go ahead
and integrate it immediately into your next release so that we can get a
reliable as_int&#40;&#41; method.  I&#39;ll continue to research ways to make as_int
even faster.

Thanks,
Eric
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-364838" href="/Public/Bug/Display.html?id=29210#txn-364838">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;23&nbsp;08:01:42&nbsp;2007</span>
    <span class="description">john.peacock [...] havurah-software.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #29210] as_int&#40;&#41; method can return incorrect value</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 23 Sep 2007 08:01:44 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Math-Currency [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Peacock &lt;john.peacock [...] havurah-software.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/364838/165346/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/165346">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Eric Rybski via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;    Perhaps we&#39;re approaching this problem too pragmatically.  How about
&gt; the following solution:
&gt; 
&gt; 296,297c296,298
&gt; &lt;     return Math::BigInt-&gt;new&#40;
&gt; &lt;         $self-&gt;as_float * 10**$self-&gt;format&#40;&#41;-&gt;{FRAC_DIGITS} &#41;-&gt;bstr;
&gt; ---
<div class="message-stanza open">&gt;&gt;     &#40;my $str = $self-&gt;as_float&#41; =~ s/\.//o;
&gt;&gt;     $str =~ s/^&#40;\-?&#41;0+/$1/o;
&gt;&gt;     return $str eq &#39;&#39; ? &#39;0&#39; : $str;
</div></div>
I thought that was going to be cheating, since you aren&#39;t explicitly dealing
with the case where the object as stored might have more accuracy than
FRAC_DIGITS.  But then I realized that as_float already takes care of that.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But for now, if you&#39;re satisfied with the above patch, I&#39;d say go ahead
&gt; and integrate it immediately into your next release so that we can get a
&gt; reliable as_int&#40;&#41; method.  I&#39;ll continue to research ways to make as_int
&gt; even faster.
</div>
I&#39;ll release that to CPAN now &#40;as soon as I can craft a test case that fails
with the old code on a 32-bit platform, so I can prevent regressions later on&#41;.
 Any further performance improvements will need to taget as_float&#40;&#41; now, since
the above is as straightforward as it could be...

John
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-415663" href="/Public/Bug/Display.html?id=29210#txn-415663">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;30&nbsp;21:10:28&nbsp;2008</span>
    <span class="description">jpeacock [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/415663/202935/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/202935">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 60b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This was resolved with 0.46 &#40;but I never closed the ticket&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-415665" href="/Public/Bug/Display.html?id=29210#txn-415665">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;30&nbsp;21:10:33&nbsp;2008</span>
    <span class="description">jpeacock [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.684705</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
