<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #87434 for Carp: feeding decoded utf8, and then passing encoded utf8 to Carp::carp&#40;&#41; produces garbage.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #87434 for Carp: feeding decoded utf8, and then passing encoded utf8 to Carp::carp&#40;&#41; produces garbage.</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Carp">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Carp">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Carp">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Carp">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Carp">Carp CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">87434</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Carp">Carp</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dmaki [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
ether [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-240208-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.26    </td>
  </tr>
  <tr id="CF-240209-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=87434">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1242803" href="/Public/Bug/Display.html?id=87434#txn-1242803">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;30&nbsp;07:08:57&nbsp;2013</span>
    <span class="description">dmaki [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> feeding decoded utf8, and then passing encoded utf8 to
 Carp::carp&#40;&#41; produces garbage.</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1242803/657226/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/657226">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I don&#39;t know if my suggested fix is feasible, but at least it fixed my issue.



&#40;Below code copied from <span class="clickylink"><a target="new" rel="nofollow" href="https://gist.github.com/lestrrat/6112039&#41;">https://gist.github.com/lestrrat/6112039&#41;</a></span>


use strict;
use Encode;
use Carp;

sub feedme_decoded_utf8 {
    my $encoded_utf8 = encode_utf8&#40;$_[0]&#41;;

    # This trace contains the string:
    #   &#34;feedme_decoded_utf8&#40;$decoded_utf8&#41; called at...&#34;
    # which gets concatenated with $encoded_utf8,
    # which causes garbage to be printed
    carp $encoded_utf8;
}

sub feedme_encoded_utf8 {
    my $decoded_utf8 = decode_utf8&#40;$_[0]&#41;;

    # This trace contains the string:
    #   &#34;feedme_encoded_utf8&#40;$encoded_utf8&#41; called at...&#34;
    # which gets concatenated with $decoded_utf8.
    # but $encoded_utf8 is properly printed because
    # Carp::format_arg properly escapes, so no garbage
    # is printed.
    carp $decoded_utf8;
}

# prints out garbage
feedme_decoded_utf8&#40; decode_utf8&#40;&#34;テスト&#34;&#41; &#41;;

# prints out ok
feedme_encoded_utf8&#40; &#34;テスト&#34; &#41;;

# My suggestion to fix this: Steal Data::Dumper::qquote&#40;&#41;, and put it
# right here:
#    <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/ZEFRAM/Carp-1.26/lib/Carp.pm#L201">https://metacpan.org/source/ZEFRAM/Carp-1.26/lib/Carp.pm#L201</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1252976" href="/Public/Bug/Display.html?id=87434#txn-1252976">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;23&nbsp;19:01:27&nbsp;2013</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #87434] feeding decoded utf8, and then passing encoded utf8 to  Carp::carp&#40;&#41; produces garbage.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 24 Aug 2013 00:01:08 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Daisuke Maki via RT &lt;bug-Carp [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1252976/663106/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/663106">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">You have in part brought your problem on yourself.  The line:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;    carp $encoded_utf8;
</div>
is requesting output of the characters corresponding to the octets of
the UTF-8 encoding.  These are characters from the high half of Latin-1,
not the characters that the UTF-8 octets represent.  You have asked for
mojibake, and shouldn&#39;t be surprised that you got it.

However, another part of your situation comes from awkward behaviour
of Perl.  By default, Perl treats a textual I/O handle as using the
Latin-1 encoding.  This means that a string containing non-Latin-1
characters cannot be correctly emitted.  But if an attempt is made to
output such a string, Perl does not treat it as a fatal error; instead, it
treats the output handle as using UTF-8 encoding *just for that string*.
It also emits the warning &#34;Wide character&#34; to tell you it&#39;s doing that.

I think, from your description of the output, that your terminal is
actually expecting UTF-8.  This means that Perl&#39;s default treatment of
output handles &#40;Latin-1, remember&#41; is not correct for you.  Wherever you
use non-ASCII characters, you *should* tell Perl what encoding to use on
I/O handles.  That you do not is a bug: you are not using Perl correctly.

Now, I&#39;ll examine the output you get.  In the feedme_encoded_utf8 case,
the sub&#39;s parameter is a string of 9 octets with their high bit set, and
$decoded_utf8 ends up containing three katakana characters.  When you
try to output that string as a warning, these characters can&#39;t go into
the output stream properly, because they have no encoding in Latin-1.
So Perl issues a warning and then outputs their UTF-8 encoding instead.
The UTF-8 happens to be what your terminal is expecting, so your terminal
shows you the katakana.  The two bugs &#40;yours and Perl&#39;s&#41; cancel out, and
so by accident you see the string Perl was actually trying to show you,
which is the katakana.

In the feedme_decoded_utf8 case, the sub&#39;s parameter is a string of three
katakana characters, and $encoded_utf8 ends up containing 9 octets with
their high bit set, or equivalently 9 characters from the upper half of
Latin-1 &#40;mostly accented Latin letters&#41;.  When you try to output that as
a warning, this 9-character string that you supplied gets concatenated
with the stack trace.  For murky historical reasons, the sub&#39;s parameter
doesn&#39;t get quoted in this case, so the stack trace contains the actual
katakana characters.  So the complete warning string includes those
accented Latin letters, and &#40;further on&#41; three katakana characters.
As before, the katakana won&#39;t fit into Latin-1 encoding for output, so,
as before, Perl outputs the warning message encoded in UTF-8 instead.
This means that, as before, by accident you correctly see the string Perl
was actually trying to show you.  You see the mojibake that you asked for.

If Carp is amended to quote all subroutine arguments, which is essentially
what you suggest, this changes the feedme_decoded_utf8 case.  With the
sub&#39;s parameter represented in ASCII, the complete warning string
now does not contain any katakana.  Of course, it still contains the
9 high-half Latin-1 characters, the mojibake, that you supplied as
the primary message.  Now the entire warning string can be encoded
in Latin-1, so Perl does encode it that way for output, and does not
emit a &#34;Wide character&#34; warning.  But because your terminal&#39;s character
encoding is mismatched with Perl&#39;s treatment of the output handle, you
don&#39;t correctly see the mojibake that you asked for.  Instead, because
your terminal is expecting UTF-8, it accidentally undoes the mojibake,
and shows you the three katakana characters.  Although you preferred
this output, it is not correct.

I think it *is* sensible for Carp to escape all subroutine arguments,
representing them entirely in ASCII.  But this is not for your reasons.

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1252977" href="/Public/Bug/Display.html?id=87434#txn-1252977">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;23&nbsp;19:01:28&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1252980" href="/Public/Bug/Display.html?id=87434#txn-1252980">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;23&nbsp;19:01:41&nbsp;2013</span>
    <span class="description">ZEFRAM [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1252981" href="/Public/Bug/Display.html?id=87434#txn-1252981">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;23&nbsp;19:25:21&nbsp;2013</span>
    <span class="description">dmaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1252981/663109/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/663109">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">What what what?!

No, that&#39;s not what&#39;s happening at all. It has nothing to do with terminal settings.
This is caused by Carp casually assuming that it&#39;s safe to append stacktraces w/o checking if it&#39;s decoded / encoded.

Let&#39;s take this example back

sub feedme_decoded_utf8 {
    my $encoded_utf8 = encode_utf8&#40;$_[0]&#41;;

    # This trace contains the string:
    #   &#34;feedme_decoded_utf8&#40;$decoded_utf8&#41; called at...&#34;
    # which gets concatenated with $encoded_utf8,
    # which causes garbage to be printed
    carp $encoded_utf8;
}

When you pass a decoded utf8 into this sub and carp&#40;&#41; gets called. It tries to generate a stacktrace string.

carp&#40;&#41; got an encoded utf8, and this line, <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/ZEFRAM/Carp-1.26/lib/Carp.pm#L279">https://metacpan.org/source/ZEFRAM/Carp-1.26/lib/Carp.pm#L279</a></span> casually joins the encoded string, and then attempts to generate the rest of the stacktrace.

at L279, $err contains an encoded utf8 string sequence.
However, @_ for feedme_decoded_utf8&#40;&#41; contains a decoded utf8, which doesn&#39;t get escaped because its utf8 flag is on <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/ZEFRAM/Carp-1.26/lib/Carp.pm#L204">https://metacpan.org/source/ZEFRAM/Carp-1.26/lib/Carp.pm#L204</a></span>

so that means we now get $encoded_utf8 + $decoded_utf8 = garbled.

On the second case, $err is made by concatenating $decoded_utf8.
@_ for feedme_encoded_utf8 contains an $encode_utf8, so is_utf8&#40;&#41; is false, and hence the escape mechanism kicks in, making everything latin-1 compatible.
Now you get $decoded_utf8 + $latin1_whetever = printable.

Doesn&#39;t matter what terminal settings I have. the first example will always be a concatenation of encoded bits and decoded octets, so it will never print properly.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1252983" href="/Public/Bug/Display.html?id=87434#txn-1252983">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;23&nbsp;19:25:22&nbsp;2013</span>
    <span class="description">dmaki [...] cpan.org -  Status changed from &#39;rejected&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1252993" href="/Public/Bug/Display.html?id=87434#txn-1252993">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;23&nbsp;19:50:45&nbsp;2013</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #87434] feeding decoded utf8, and then passing encoded utf8 to Carp::carp&#40;&#41; produces garbage.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 24 Aug 2013 00:50:29 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Daisuke Maki via RT &lt;bug-Carp [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1252993/663116/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/663116">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 962b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Daisuke Maki via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;No, that&#39;s not what&#39;s happening at all. It has nothing to do with
&gt;terminal settings.
</div>
Terminal settings are a factor in what you actually see.  Since you didn&#39;t
explicitly say what output you&#39;re getting, but just say whether it&#39;s
&#34;garbage&#34;, I presume that you&#39;re examining the output by sending it to
a terminal.  If you send it through od or something like that, we can talk
about what octets come out.  The rest of the analysis will be the same.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;This is caused by Carp casually assuming that it&#39;s safe to append
&gt;stacktraces w/o checking if it&#39;s decoded / encoded.
</div>
There is no way to check whether some string that Carp finds is intended
to be treated as an octet string &#40;&#34;encoded&#34;&#41; or as a character string
&#40;&#34;decoded&#34;&#41;.  The only exception is the main argument to carp&#40;&#41; &#40;or
cluck&#40;&#41;, etc.&#41;, which, as it&#39;s a message, is implicitly a character
string.  If you pass in an octet string there, you&#39;re asking for mojibake.

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1252996" href="/Public/Bug/Display.html?id=87434#txn-1252996">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;23&nbsp;19:51:20&nbsp;2013</span>
    <span class="description">ZEFRAM [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1252997" href="/Public/Bug/Display.html?id=87434#txn-1252997">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;23&nbsp;20:56:14&nbsp;2013</span>
    <span class="description">dmaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1252997/663119/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/663119">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 250b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Are you suggesting that this is supposed to show up correctly based on my terminal settings?

perl -Mutf8 -MEncode -E &#39;say &#34;日本語&#34;  . Encode::encode_utf8&#40;&#34;日本語&#34;&#41;&#39;

Because that&#39;s what basically what Carp is currently doing to its stacktrace.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1253003" href="/Public/Bug/Display.html?id=87434#txn-1253003">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;23&nbsp;22:26:37&nbsp;2013</span>
    <span class="description">tokuhirom+cpan [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> zefram [...] fysh.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1253003/663125/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/663125">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 790b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The issue is around UTF-8 automatic upgrading while string concatenation.

More concrete code is here:
<span class="clickylink"><a target="new" rel="nofollow" href="http://nopaste.64p.org/entry/0F981E04-0C63-11E3-9DDC-3AC23A9B6EE1">http://nopaste.64p.org/entry/0F981E04-0C63-11E3-9DDC-3AC23A9B6EE1</a></span>

And generated result is here:
<span class="clickylink"><a target="new" rel="nofollow" href="http://gyazo.64p.org/image/a971f9035cd5593ba7840d9dd9e90a41.png">http://gyazo.64p.org/image/a971f9035cd5593ba7840d9dd9e90a41.png</a></span>

Because, &#34;て&#40;flagged string&#41;&#34; is flagged string but it&#39;s not downgraded correctly in format_arg function.
% perl -e &#39;use utf8; $x=&#34;て&#40;flagged string&#41;&#34;; warn utf8::downgrade&#40;$x, 1&#41;;&#39;
Warning: something&#39;s wrong at -e line 1.
% perl -e &#39;use utf8; $x=&#34;て&#40;flagged string&#41;&#34;; warn utf8::downgrade&#40;$x&#41;;&#39;
Wide character in subroutine entry at -e line 1.

.... utf8::downgrade can&#39;t downgrade Japanese characters.

Then, flagged utf8 characters returned from format_arg and other encoded string will concatenate. It makes mojibake.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1253007" href="/Public/Bug/Display.html?id=87434#txn-1253007">#</a>      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;24&nbsp;01:07:05&nbsp;2013</span>
    <span class="description">MIYAGAWA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1253007/663129/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/663129">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Aug 23 19:50:45 2013, zefram@fysh.org wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt;This is caused by Carp casually assuming that it&#39;s safe to append
&gt; &gt;stacktraces w/o checking if it&#39;s decoded / encoded.
</div>&gt; 
&gt; There is no way to check whether some string that Carp finds is intended
&gt; to be treated as an octet string &#40;&#34;encoded&#34;&#41; or as a character string
&gt; &#40;&#34;decoded&#34;&#41;. 
</div>
I agree, and that&#39;s the source of all these problems.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The only exception is the main argument to carp&#40;&#41; &#40;or
&gt; cluck&#40;&#41;, etc.&#41;, which, as it&#39;s a message, is implicitly a character
&gt; string.  
</div>
That&#39;s new to me. I read perldoc Carp and didn&#39;t find any mention to it. Since you said &#34;implicitly&#34;, i guess it&#39;s ... implicit :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If you pass in an octet string there, you&#39;re asking for mojibake.
</div>
I agree with you that if you pass in an octet with/without binmoding STDERR, the semantics for carp&#40;&#41; is kind of undefined.

However, what is annoying here is that when you pass octets &#40;say UTF-8&#41; to Carp::carp&#40;&#41;, what gets printed to STDERR *depends on how the function in question is called*. 

Consider:

    use Encode;
    use Carp;

    sub f {
        my $b = encode_utf8&#40;$_[0]&#41;;
        carp $b;
    }
    
    sub g {
        carp $_[0];
    }
    
    f decode_utf8&#40;&#39;テスト&#39;&#41;;
    g &#39;テスト&#39;;
    warn &#39;テスト&#39;;

We call carp&#40;&#41; twice and warn, all of which with utf-8 octet of テスト as an argument. What will be printed &#40;in UTF-8 terminal&#41; are:

    Wide character in warn at /Users/miyagawa/.plenv/versions/5.18.1/lib/perl5/5.18.1/Carp.pm line 102.
    ãã¹ã at - line 6.
        main::f&#40;&#39;テスト&#39;&#41; called at - line 13
    テスト at - line 10.
        main::g&#40;&#39;\x{e3}\x{83}\x{86}\x{e3}\x{82}\x{b9}\x{e3}\x{83}\x{88}&#39;&#41; called at - line 14
    テスト at - line 15.

Again, I agree that the semantics is specific to the terminal environment, but i think at least the output should be consistent. 

Only the first one &#40;sub f&#41; gets mojibake, precisely because of the reason lestrrat and tokuhirom explained &#40;the strings were concatinated internally inside Carp.pm and gets auto promotion from latin-1 to UTF-8&#41;. 

I wish it would rather print:

    テスト at - line 6
        main::f&#40;&#39;\x{30c6}\x{30b9}\x{30c8}&#39;&#41; called at - line 13

instead - and i believe that&#39;s what original post requested for.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1253010" href="/Public/Bug/Display.html?id=87434#txn-1253010">#</a>      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;24&nbsp;01:38:27&nbsp;2013</span>
    <span class="description">MIYAGAWA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1253010/663132/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/663132">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Aug 24 01:07:05 2013, MIYAGAWA wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Consider:
&gt; 
&gt; use Encode;
&gt; use Carp;
&gt; 
&gt; sub f {
&gt;     my $b = encode_utf8&#40;$_[0]&#41;;
&gt;     carp $b;
&gt; }
&gt; 
&gt; sub g {
&gt;     carp $_[0];
&gt; }
&gt; 
&gt; f decode_utf8&#40;&#39;テスト&#39;&#41;;
&gt; g &#39;テスト&#39;;
&gt; warn &#39;テスト&#39;;
</div>
Compare, by changing &#39;テスト&#39; to &#34;Léon&#34;, saved in UTF-8:

    use strict;
    use Encode;
    use Carp;
    
    sub f {
        my $b = encode_utf8&#40;$_[0]&#41;;
        carp $b;
    }
    
    sub g {
        carp $_[0];
    }
    
    f decode_utf8&#40;&#34;Léon&#34;&#41;;
    g &#34;Léon&#34;;
    warn &#34;Léon&#34;;

prints:

    Léon at tmp/f.pl line 7.
        main::f&#40;&#39;L\x{e9}on&#39;&#41; called at tmp/f.pl line 14
    Léon at tmp/f.pl line 11.
        main::g&#40;&#39;L\x{c3}\x{a9}on&#39;&#41; called at tmp/f.pl line 15
    Léon at tmp/f.pl line 16.

You said &#34;When you feed octet, you&#39;re asking for mojibake&#34; - but we don&#39;t get mojibake here for all three cases, with same code, and it&#39;s not fair :&#41;

I guess you don&#39;t need a technical explanation, but for the record, the actual reason that this works is that downgrade&#40;&#41; in line 201 effectively strips the utf8 flag, and then is_utf8&#40;&#41; in line 211 returns false and replaces all high bit characters with \x{XX} - it doesn&#39;t work that way with wide &#40;non-latin&#41; characters.

    197         # Quote it?
    198         # Downgrade, and use [0-9] rather than \d, to avoid loading
    199         # Unicode tables, which would be liable to fail if we&#39;re
    200         # processing a syntax error.
    201         downgrade&#40;$arg, 1&#41;;
    202         $arg = &#34;&#39;$arg&#39;&#34; unless $arg =~ /^-?[0-9.]+\z/;

This comment somehow lets me me think that the call for downgrade&#40;&#41; &#40;and later is_utf8&#40;&#41; returning false&#41; is accidental.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1254535" href="/Public/Bug/Display.html?id=87434#txn-1254535">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;27&nbsp;12:43:45&nbsp;2013</span>
    <span class="description">ether [...] cpan.org -  Cc ETHER added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.601089</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
