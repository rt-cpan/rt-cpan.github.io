<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #32815 for Schedule-RateLimiter: Feature request: &#34;threshold&#34; limiting</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #32815 for Schedule-RateLimiter: Feature request: &#34;threshold&#34; limiting</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Schedule-RateLimiter">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Schedule-RateLimiter">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Schedule-RateLimiter">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Schedule-RateLimiter">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Schedule-RateLimiter">Schedule-RateLimiter CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">32815</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Schedule-RateLimiter">Schedule-RateLimiter</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
FERRENCY [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-28352-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.01    </td>
  </tr>
  <tr id="CF-28353-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




5_min_iterations.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/424835/207719/5_min_iterations.t">
Wed Feb 20 15:48:45 2008 (988b) by FERRENCY [...] cpan.org
</a>
</font></li>
</ul>


RateLimiter.pm.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/424835/207722/RateLimiter.pm.patch">
Wed Feb 20 15:48:45 2008 (2k) by FERRENCY [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=32815">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-415625" href="/Public/Bug/Display.html?id=32815#txn-415625">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;30&nbsp;16:21:21&nbsp;2008</span>
    <span class="description">FERRENCY [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Feature request: &#34;threshold&#34; limiting</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/415625/202912/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/202912">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I would like to use Schedule::RateLimiter to limit events in an inverse
fashion, which I call &#34;threshold limiting.&#34;

Currently, Rate Limiting allows you to specify, &#34;Allow the event to
happen at most once per hour.&#34;  I would like to be able to specify,
&#34;Allow the event to happen only if it has been triggered at least 3
times in an hour.&#34;

This only makes sense for non-blocking requests, which I would make the
default for this sort of rate limiter object.

The basic functionality is almost, but not quite, the same as returning:
!$limiter-&gt;event&#40;block =&gt; 0&#41;;

The problem is, once the $limiter starts returning 0, it stops counting
the event as having occurred.

One idea on how it might look:

my $limiter = Schedule::RateLimiter-&gt;new&#40;iterations =&gt; 3, seconds =&gt;
1800, threshold =&gt; 1&#41;;

Now, $limiter defaults to block =&gt; 0 when you call $limiter-&gt;event&#40;&#41;;
$limiter-&gt;event&#40;&#41; always counts the current trigger as an event, and
returns the logical negation of what it would return in the
non-threshold version.

Have I missed anything?

Alan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Create even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-417605" href="/Public/Bug/Display.html?id=32815#txn-417605">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;05&nbsp;12:23:46&nbsp;2008</span>
    <span class="description">FERRENCY [...] cpan.org - Ticket #32946:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Feature request: explicit event timestamp</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/417605/203948/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/203948">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1002b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">It would be beneficial if the event&#40;&#41; method of a RateLimiter object
could accept an explicit timestamp for when the event occurred.  This
would replace the use of time&#40;&#41; to get the current timestamp for use
with an incoming event.

I would expect the behavior to be undefined if events arrived out of
order chronologically, and that&#39;s fine with me.  

However, the ability to specify an explicit timestamp with an event
would allow RateLimiter to be used to &#34;replay&#34; a log of events which
happened in the past, with the same behavior it had when the events were
happening in real time.  For this use case, the log of events will
typically be provided in chronological order, so the RateLimiter should
be able to be have identically to the way it would have the first time
around.

This would also be useful to compensate for network or other delays, and
would allow events to be handled at the time we believe they happened
instead of the time when RateLimiter is eventually told they happened.

Alan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-424835" href="/Public/Bug/Display.html?id=32815#txn-424835">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;20&nbsp;15:48:44&nbsp;2008</span>
    <span class="description">FERRENCY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/424835/207716/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/207716">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 876b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached is a patch which implements a variation on threshold limiting:
the &#34;min_iterations&#34; parameter.  It works like this:

- if min_iterations is specified, the rate limiter&#39;s event&#40;&#41; will not
succeed until there have been min_iterations events &#40;including this
one&#41;.  They will stop succeeding as soon as &#34;iterations&#34; events have
occurred, and &#34;iterations&#34; is still required.

- block is implicitly 0 for objects created with min_iterations

This means that if you specify for example &#40;min_iterations =&gt; 4,
iterations =&gt; 4, seconds =&gt; 60&#41;, you should get exactly one successful
event every minute.

I have also included a test file which verifies this behavior.

The patch also implements the &#34;specify event time in the event&#40;&#41; call&#34;
feature request, but I have not tested it.  Using this feature seems
like it would be a good way to speed up your entire test suite.

Alan
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/424835/207719/5_min_iterations.t">Download 5_min_iterations.t</a><br />
<span class="downloadcontenttype">text/x-perl 988b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use Test::More tests =&gt; 26;

use Schedule::RateLimiter;
ok&#40;1, &#39;Did the Schedule::RateLimiter module load?&#39;&#41;; # If we made it this far, we&#39;re ok.

#########################

my $throttle = Schedule::RateLimiter-&gt;new&#40; seconds =&gt; 2, iterations =&gt; 5, min_iterations =&gt; 3 &#41;;
ok &#40; ref&#40; $throttle &#41;, &#39;Did we build an Schedule::RateLimiter with more than one iteration?&#39; &#41;;

ok !$throttle-&gt;event&#40;&#41;;
ok !$throttle-&gt;event&#40;&#41;;
ok $throttle-&gt;event&#40;&#41;;
ok $throttle-&gt;event&#40;&#41;;
ok $throttle-&gt;event&#40;&#41;;
ok !$throttle-&gt;event&#40;&#41;;
ok !$throttle-&gt;event&#40;&#41;;
ok !$throttle-&gt;event&#40;&#41;;
ok !$throttle-&gt;event&#40;&#41;;
ok !$throttle-&gt;event&#40;&#41;;
ok !$throttle-&gt;event&#40;&#41;;
ok !$throttle-&gt;event&#40;&#41;;
ok !$throttle-&gt;event&#40;&#41;;
ok !$throttle-&gt;event&#40;&#41;;
ok !$throttle-&gt;event&#40;&#41;;
ok !$throttle-&gt;event&#40;&#41;;

# Wait until we time out and try again.
sleep 3;
ok !$throttle-&gt;event&#40;&#41;;
ok !$throttle-&gt;event&#40;&#41;;
ok $throttle-&gt;event&#40;&#41;;
ok $throttle-&gt;event&#40;&#41;;
ok $throttle-&gt;event&#40;&#41;;
ok !$throttle-&gt;event&#40;&#41;;
ok !$throttle-&gt;event&#40;&#41;;
ok !$throttle-&gt;event&#40;&#41;;

</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/424835/207722/RateLimiter.pm.patch">Download RateLimiter.pm.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">*** ../Schedule-RateLimiter-0.01-5KjWIV/RateLimiter.pm	Thu Dec  4 18:09:10 2003
--- RateLimiter.pm	Wed Feb 20 15:46:03 2008
***************
*** 142,147 ****
--- 142,148 ----
          current     =&gt; 0,
          list        =&gt; \@list,
          iterations  =&gt; $iterations,
+         min_iterations =&gt; $args{min_iterations},
          seconds     =&gt; $args{seconds},
          block       =&gt; &#40; exists&#40;$args{block}&#41; &#41; ? $args{block} : 1,
      }, $proto;
***************
*** 184,204 ****
      my $self = shift;
      my %args = @_;
  
!     my $t = Time::HiRes::time&#40;&#41;;
  
      my $last = $self-&gt;{list}[$self-&gt;{current}] || 0;
!     my $block = exists&#40; $args{block} &#41; ? $args{block} : $self-&gt;{block};
  
      if &#40; &#40;$t - $last&#41; &lt; $self-&gt;{seconds} &#41; {
          return 0 unless $block;
          Time::HiRes::sleep&#40;$self-&gt;{seconds} - &#40;$t - $last&#41;&#41;;
      }
  
!     $self-&gt;{list}[$self-&gt;{current}] = $t;
! 
!     $self-&gt;{current} = &#40;$self-&gt;{current}+1&#41; % $self-&gt;{iterations};
  
      return 1;
  }
  
  =head1 BUGS
--- 185,219 ----
      my $self = shift;
      my %args = @_;
  
!     my $t = $args{timestamp} || Time::HiRes::time&#40;&#41;;
  
      my $last = $self-&gt;{list}[$self-&gt;{current}] || 0;
!     my $block = &#40;exists&#40; $args{block} &#41; ? $args{block} : $self-&gt;{block}&#41;
!                  &#38;&#38; !$self-&gt;{min_iterations};
! 
!     $self-&gt;_record_event&#40;$t&#41; if $self-&gt;{min_iterations};
! 
!     if &#40; $self-&gt;{min_iterations} &#41; {
!       # Find the nth previous iteration and make sure it&#39;s new enough
!       my $pt = &#40;$self-&gt;{list}[&#40;$self-&gt;{current} - $self-&gt;{min_iterations}&#41; % $self-&gt;{iterations}] || 0&#41;;
!       return 0 if $t &gt; $pt + $self-&gt;{seconds};
!     }
  
      if &#40; &#40;$t - $last&#41; &lt; $self-&gt;{seconds} &#41; {
          return 0 unless $block;
          Time::HiRes::sleep&#40;$self-&gt;{seconds} - &#40;$t - $last&#41;&#41;;
      }
  
!     $self-&gt;_record_event&#40;$t&#41; unless $self-&gt;{min_iterations};
  
      return 1;
+ }
+ 
+ sub _record_event {
+   my &#40;$self, $t&#41; = @_;
+ 
+   $self-&gt;{list}[$self-&gt;{current}] = $t;
+   $self-&gt;{current} = &#40;$self-&gt;{current}+1&#41; % $self-&gt;{iterations};
  }
  
  =head1 BUGS
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-424837" href="/Public/Bug/Display.html?id=32815#txn-424837">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;20&nbsp;15:48:51&nbsp;2008</span>
    <span class="description">FERRENCY [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-424964" href="/Public/Bug/Display.html?id=32815#txn-424964">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;20&nbsp;20:00:12&nbsp;2008</span>
    <span class="description">Dan [...] DWright.Org - Ticket #32946:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/424964/207811/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/207811">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 408b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Feb 05 12:23:46 2008, FERRENCY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It would be beneficial if the event&#40;&#41; method of a RateLimiter object
&gt; could accept an explicit timestamp for when the event occurred.  This
&gt; would replace the use of time&#40;&#41; to get the current timestamp for use
&gt; with an incoming event.
</div>
Since you sent a proposed patch, which included this implementation on
ticket #32815, I&#39;m going to merge the two tickets.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-424965" href="/Public/Bug/Display.html?id=32815#txn-424965">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;20&nbsp;20:00:13&nbsp;2008</span>
    <span class="description">The RT System itself - Ticket #32946:  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-424967" href="/Public/Bug/Display.html?id=32815#txn-424967">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;20&nbsp;20:00:29&nbsp;2008</span>
    <span class="description">Dan [...] DWright.Org - Ticket #32946:  Merged into ticket #32815</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-424968" href="/Public/Bug/Display.html?id=32815#txn-424968">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;20&nbsp;20:00:29&nbsp;2008</span>
    <span class="description">Dan [...] DWright.Org -  Merged into ticket #32815</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-424970" href="/Public/Bug/Display.html?id=32815#txn-424970">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;20&nbsp;20:21:51&nbsp;2008</span>
    <span class="description">Dan [...] DWright.Org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/424970/207813/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/207813">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

  Here&#39;s a few notes on your idea.

  First off, the optional &#39;timestamp&#39; argument seems somewhat
problematic with respect to blocking.   For example... if I have
blocking turned on and I specify an event 10 seconds in the future,
but the next event cannot happen for 20 seconds, how long do we sleep?
Likewise, what if I specified something 10 seconds in the past?   We
could just come up with some arbitrary definition of what is the
&#34;correct&#34; behavior, but I have a feeling somebody else would be able
to argue why that&#39;s wrong.   So, my current thinking is that the
timestamp parameter is incompatible with blocking.

  Second, I tried to rationalize what would be the meaning if
min_iterations existed, but was set to zero.  I couldn&#39;t come up with
anything.   So, my current thinking is that min_iterations must be
greater than zero or else that is the same as having it unset.

  Third, I tried integrating your patch, and then I started looking
it over and re-arranging the code.   And, eventually, I had sub even&#40;&#41;
to the point where it was if &#40;min_iterations&#41; {do this} else {do that}

  That made me think that while min_iterations is a neat feature, it&#39;s
meaning is very contrary to what event&#40;&#41; was intended to do.   So, I
propose let&#39;s not put this in event&#40;&#41; at all.   In fact, I&#39;m proposing
that event&#40;&#41; could even be deprecated, and replaced with three new
methods:  hold_for_event, test_event, and record_event:

hold_for_event:
  &#34;This event has to happen, just tell me when it&#39;s safe to start.&#34;

  hold_for_event does a blocking wait until the next time an event can
  happen.   It does not accept any parameters at all.  It ignores
  min_iterations.  It assumes that upon return, the event happened.

  There would be no return value.

test_event:
  &#34;If I wanted this event to happen at this time, could it?&#34;

  test_event never blocks.   It accepts an optional timestamp
  parameter.  It also honors min_iterations.  

  Returns true if the event could happen, false otherwise.

record_event:
  &#34;An event happened at this time.  Deal with it&#34;

  record_event doesn&#39;t care if an event should have happened.  It only
  knows that the event did happen.   It accepts an optional timestamp
  and records the event.

  There would be no return value.

Although event&#40;&#41; would be deprecated, I&#39;d have to keep it around for
backward compatibility.   I&#39;d just re-implment it so that it calls the
above methods.

I believe this gives you all of the functionality you are looking for,
and them some.   Please let me know if you see anything wrong with
this approach.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-424974" href="/Public/Bug/Display.html?id=32815#txn-424974">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;20&nbsp;20:39:23&nbsp;2008</span>
    <span class="description">alan [...] ferrency.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #32815] Feature request: &#34;threshold&#34; limiting </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 20 Feb 2008 20:47:51 -0500 &#40;EST&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;Daniel J. Wright via RT&#34; &lt;bug-Schedule-RateLimiter [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> alan [...] ferrency.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/424974/207815/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/207815">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;   First off, the optional &#39;timestamp&#39; argument seems somewhat
&gt; problematic with respect to blocking.   For example... if I have
&gt; blocking turned on and I specify an event 10 seconds in the future,
&gt; but the next event cannot happen for 20 seconds, how long do we sleep?
&gt; Likewise, what if I specified something 10 seconds in the past?   We
&gt; could just come up with some arbitrary definition of what is the
&gt; &#34;correct&#34; behavior, but I have a feeling somebody else would be able
&gt; to argue why that&#39;s wrong.   So, my current thinking is that the
&gt; timestamp parameter is incompatible with blocking.
</div>
I don&#39;t personally need support for blocking with timestamp.

However, I don&#39;t think there&#39;s any inherent problem with it, so I
wouldn&#39;t bother purposefully removing support.

Don&#39;t think about $args{timestamp} in relation to real time. It
_defines_ what &#34;now&#34; is, so by definition it is always identical to what
you should think of as the current time.

If your $args{seconds} is 60, and your oldest event is 20 seconds prior
to $args{timestamp}, then you have to wait 40 seconds. Whether the time
stamp is in the past or the future in relation to the real wall clock
doesn&#39;t matter at all. One timestamp is specified, there is no need to
consider time&#40;&#41; whatsoever.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;   Second, I tried to rationalize what would be the meaning if
&gt; min_iterations existed, but was set to zero.  I couldn&#39;t come up with
&gt; anything.   So, my current thinking is that min_iterations must be
&gt; greater than zero or else that is the same as having it unset.
</div>
I&#39;m fine with that interpretation, and I think my patch acts this way.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;   Third, I tried integrating your patch, and then I started looking
&gt; it over and re-arranging the code.   And, eventually, I had sub event&#40;&#41;
&gt; to the point where it was if &#40;min_iterations&#41; {do this} else {do that}
</div>
I&#39;d like to see the code before I interpret this: it&#39;s easy to unfactor
any code to the point where it&#39;s separated into two disparate cases, but
at what cost?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; hold_for_event:
</div>&lt;snip&gt;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; test_event:
</div>&lt;snip&gt;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; record_event:
&gt;   &#34;An event happened at this time.  Deal with it&#34;
</div>
&#40;Is this equivalent to my factored out _record_event, or whatever I called it?&#41;

These seem fine to me overall. I&#39;m not necessarily convinced the
separation is necessary or useful, but I don&#39;t mind it.

Does this separation eliminate the need for the &#40;block =&gt; &#41; parameter to
the constructor?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I believe this gives you all of the functionality you are looking for,
&gt; and them some.   Please let me know if you see anything wrong with
&gt; this approach.
</div>
Seems fine enough to me.

Alan
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.640518</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
