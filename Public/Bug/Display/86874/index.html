<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #86874 for System-Command: System::Command Closing Handles Prematurely</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #86874 for System-Command: System::Command Closing Handles Prematurely</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/System-Command/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/System-Command/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/System-Command/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/System-Command/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/System-Command">System-Command CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">86874</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/System-Command/Active/">System-Command</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
NNUTTER [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-236680-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.01    </td>
  </tr>
  <tr id="CF-236681-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;11&nbsp;22:22:12&nbsp;2013</span>
    <span class="description">NNUTTER [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> System::Command Not Setting Any Exit Code, -1 or Otherwise</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">System::Command is not setting any exit code, not even -1.  This could be a Mac OS X bug; if I get more information I&#39;ll let you know.  I noticed because Git::Repository::Command was not die when Git should be return fatal exit codes, e.g. when trying to push to a remote that doesn&#39;t exist.

$ perl -e &#39;use System::Command; my $c = System::Command-&gt;new&#40;q&#40;false&#41;&#41;; print $c-&gt;exit, qq&#40;\n&#41;;&#39;

$ perl -e &#39;use System::Command; my $c = System::Command-&gt;new&#40;q&#40;true&#41;&#41;; print $c-&gt;exit, qq&#40;\n&#41;;&#39;

$ perl -e &#39;use System::Command; print $System::Command::VERSION, qq&#40;\n&#41;;&#39;
1.101
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> perlv.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Summary of my perl5 &#40;revision 5 version 12 subversion 5&#41; configuration:
   
  Platform:
    osname=darwin, osvers=12.4.0, archname=darwin-2level
    uname=&#39;darwin x 12.4.0 darwin kernel version 12.4.0: wed may 1 17:57:12 pdt 2013; root:xnu-2050.24.15~1release_x86_64 x86_64 &#39;
    config_args=&#39;-de -Dprefix=/Users/nnutter/.perlbrew/perls/perl-5.12.5 -Aeval:scriptdir=/Users/nnutter/.perlbrew/perls/perl-5.12.5/bin&#39;
    hint=recommended, useposix=true, d_sigaction=define
    useithreads=undef, usemultiplicity=undef
    useperlio=define, d_sfio=undef, uselargefiles=define, usesocks=undef
    use64bitint=define, use64bitall=define, uselongdouble=undef
    usemymalloc=n, bincompat5005=undef
  Compiler:
    cc=&#39;cc&#39;, ccflags =&#39;-fno-common -DPERL_DARWIN -fno-strict-aliasing -pipe -fstack-protector -I/usr/local/include&#39;,
    optimize=&#39;-O3&#39;,
    cppflags=&#39;-fno-common -DPERL_DARWIN -fno-strict-aliasing -pipe -fstack-protector -I/usr/local/include&#39;
    ccversion=&#39;&#39;, gccversion=&#39;4.2.1 Compatible Apple LLVM 4.2 &#40;clang-425.0.27&#41;&#39;, gccosandvers=&#39;&#39;
    intsize=4, longsize=8, ptrsize=8, doublesize=8, byteorder=12345678
    d_longlong=define, longlongsize=8, d_longdbl=define, longdblsize=16
    ivtype=&#39;long&#39;, ivsize=8, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;off_t&#39;, lseeksize=8
    alignbytes=8, prototype=define
  Linker and Libraries:
    ld=&#39;env MACOSX_DEPLOYMENT_TARGET=10.3 cc&#39;, ldflags =&#39; -fstack-protector -L/usr/local/lib&#39;
    libpth=/usr/local/lib /usr/lib
    libs=-lgdbm -ldbm -ldl -lm -lutil -lc
    perllibs=-ldl -lm -lutil -lc
    libc=, so=dylib, useshrplib=false, libperl=libperl.a
    gnulibc_version=&#39;&#39;
  Dynamic Linking:
    dlsrc=dl_dlopen.xs, dlext=bundle, d_dlsymun=undef, ccdlflags=&#39; &#39;
    cccdlflags=&#39; &#39;, lddlflags=&#39; -bundle -undefined dynamic_lookup -L/usr/local/lib -fstack-protector&#39;


Characteristics of this binary &#40;from libperl&#41;: 
  Compile-time options: PERL_DONT_CREATE_GVSV PERL_MALLOC_WRAP USE_64_BIT_ALL
                        USE_64_BIT_INT USE_LARGE_FILES USE_PERLIO
                        USE_PERL_ATOF
  Built under darwin
  Compiled at Jun  6 2013 21:51:49
  %ENV:
    PERL5LIB=&#34;/Users/nnutter/lib/perl5&#34;
    PERLBREW_BASHRC_VERSION=&#34;0.64&#34;
    PERLBREW_HOME=&#34;/Users/nnutter/.perlbrew&#34;
    PERLBREW_MANPATH=&#34;/Users/nnutter/.perlbrew/perls/perl-5.12.5/man&#34;
    PERLBREW_PATH=&#34;/Users/nnutter/.perlbrew/bin:/Users/nnutter/.perlbrew/perls/perl-5.12.5/bin&#34;
    PERLBREW_PERL=&#34;perl-5.12.5&#34;
    PERLBREW_ROOT=&#34;/Users/nnutter/.perlbrew&#34;
    PERLBREW_VERSION=&#34;0.64&#34;
  @INC:
    /Users/nnutter/lib/perl5
    /Users/nnutter/.perlbrew/perls/perl-5.12.5/lib/site_perl/5.12.5/darwin-2level
    /Users/nnutter/.perlbrew/perls/perl-5.12.5/lib/site_perl/5.12.5
    /Users/nnutter/.perlbrew/perls/perl-5.12.5/lib/5.12.5/darwin-2level
    /Users/nnutter/.perlbrew/perls/perl-5.12.5/lib/5.12.5
    .
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;11&nbsp;22:23:42&nbsp;2013</span>
    <span class="description">NNUTTER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">OK, I&#39;m guessing this is a waitpid issue:

$ time perl -e &#39;use System::Command; my $c = System::Command-&gt;new&#40;qw&#40;sleep 10&#41;&#41;; print $c-&gt;exit, qq&#40;\n&#41;;&#39;


real    0m0.041s
user    0m0.026s
sys     0m0.008s
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;11&nbsp;22:31:28&nbsp;2013</span>
    <span class="description">NNUTTER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">System::Command::new does not add an exit key to the object but exit is treated as a simple, key-based, attribute.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;11&nbsp;22:34:30&nbsp;2013</span>
    <span class="description">NNUTTER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ugh, this whole thing might be a bad bug report... sorry.  At least the previous usage was wrong so not a waitpid issue.

! time perl -e &#39;use System::Command; $DB::single = 1; my $c = System::Command-&gt;new&#40;qw&#40;sleep 2&#41;&#41;; $c-&gt;close&#40;&#41;; print $c-&gt;exit, qq&#40;\n&#41;;&#39;
0

real    0m2.036s
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;11&nbsp;22:48:36&nbsp;2013</span>
    <span class="description">NNUTTER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">OK, to prove I am not totally insane.  Here&#39;s it failing when I try to debug it and passing when I don&#39;t:

$ perl -d -I lib t/branch.t
main::&#40;t/branch.t:20&#41;:  $push-&gt;close&#40;&#41;;
auto&#40;-1&#41;  DB&lt;1&gt; {{v
  DB&lt;2&gt; c

Died at t/branch.t line 23.
 at t/branch.t line 23.
Debugged program terminated.  Use q to quit or R to restart,
  use o inhibit_exit to avoid stopping after program termination,
  h q, h R or h o to get additional info.  
auto&#40;-1&#41;  DB&lt;2&gt; v
9549    9550    
9551    sub at_exit {
9552==&gt;     &#34;Debugged program terminated.  Use `q&#39; to quit or `R&#39; to restart.&#34;;
9553    }
9554    
9555    package DB;    # Do not trace this 1; below!
  DB&lt;2&gt; q

$ perl -I lib t/branch.t
Name &#34;DB::single&#34; used only once: possible typo at t/branch.t line 18.
ok 1 - got a Branch object
ok 2 - full_name = refs/heads/master
ok 3 - name = master
1..3
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;11&nbsp;22:58:26&nbsp;2013</span>
    <span class="description">NNUTTER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Still trying to work this out but here&#39;s how to make sense of the debug failing but non-debug not; it&#39;s time-based:

# without a sleep before close&#40;&#41; it passes
$ perl -e &#39;use System::Command; my $c = System::Command-&gt;new&#40;qw&#40;git push nowhere master&#41;&#41;; $c-&gt;close&#40;&#41;; print $c-&gt;exit, qq&#40;\n&#41;;&#39;
0

# with a sleep 2 it fails
$ perl -e &#39;use System::Command; my $c = System::Command-&gt;new&#40;qw&#40;git push nowhere master&#41;&#41;; sleep 2; $c-&gt;close&#40;&#41;; print $c-&gt;exit, qq&#40;\n&#41;;&#39;
128
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;11&nbsp;23:27:47&nbsp;2013</span>
    <span class="description">NNUTTER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">In close&#40;&#41;, if I move the $self-&gt;_reap&#40;&#41;; to before the file handle closes then it behaves as expected.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;11&nbsp;23:32:15&nbsp;2013</span>
    <span class="description">NNUTTER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jul 11 23:27:47 2013, NNUTTER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In close&#40;&#41;, if I move the $self-&gt;_reap&#40;&#41;; to before the file handle
&gt; closes then it behaves as expected.
</div>
And now when I think I&#39;ve reverted my changes I can&#39;t even reproduce it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;12&nbsp;00:05:42&nbsp;2013</span>
    <span class="description">NNUTTER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jul 11 23:27:47 2013, NNUTTER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In close&#40;&#41;, if I move the $self-&gt;_reap&#40;&#41;; to before the file handle
&gt; closes then it behaves as expected.
</div>
OK, I think this is part bug and mostly user error.  I made two errors in usage that confused me:

- not calling close&#40;&#41; before checking exit&#40;&#41;
- not checking signal&#40;&#41;

However, I think there is a bug.  My theory is that close&#40;&#41; is closing the STDERR, STDIN, and STDOUT handles while the process is still trying to write to them causing the process to signal.  I may have seen hints of this when debugging where $! was set to Illegal Seek &#40;but I don&#39;t know that it&#39;s not just coincidence&#41;.  I don&#39;t know how to confirm this but if this is the case then close&#40;&#41; should reap the process before calling close on the handles.

This whole thing started because a Git::Repository-&gt;run&#40;&#41; wasn&#39;t failing when I expected it to &#40;trying to push to a remote that didn&#39;t exist&#41; but I can&#39;t reproduce that anymore and run uses Git::Repository::Command::final_output which would avoid the above bug because it waits for STDERR and STDOUT to be closed by the process.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;12&nbsp;00:06:22&nbsp;2013</span>
    <span class="description">NNUTTER [...] cpan.org -  Subject changed from &#39;System::Command Not Setting Any Exit Code, -1 or Otherwise&#39; to &#39;System::Command Closing Handles Prematurely&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;15&nbsp;12:24:29&nbsp;2013</span>
    <span class="description">book [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Many thanks for the detailed report. :-&#41;

On Thu Jul 11 22:58:26 2013, NNUTTER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Still trying to work this out but here&#39;s how to make sense of the
&gt; debug failing but non-debug not; it&#39;s time-based:
&gt; 
&gt; # without a sleep before close&#40;&#41; it passes
&gt; $ perl -e &#39;use System::Command; my $c = System::Command-&gt;new&#40;qw&#40;git
&gt; push nowhere master&#41;&#41;; $c-&gt;close&#40;&#41;; print $c-&gt;exit, qq&#40;\n&#41;;&#39;
&gt; 0
&gt; 
&gt; # with a sleep 2 it fails
&gt; $ perl -e &#39;use System::Command; my $c = System::Command-&gt;new&#40;qw&#40;git
&gt; push nowhere master&#41;&#41;; sleep 2; $c-&gt;close&#40;&#41;; print $c-&gt;exit, qq&#40;\n&#41;;&#39;
&gt; 128
</div>
I think what happens is that the call to close&#40;&#41; happens before the
git command has had a chance to run entirely. Without the sleep, you
basically start the subprocess, and then immediately close all its
communication ports before waiting for it to terminate.

With the sleep, the process has enough time to do its task, and when
the parent process does a waitpid&#40;&#41; it gets the actual exit status.

Actually, it could even be that the call to close happens before the
forked child has had a chance to exec&#40;&#41; into the git command. And the
fact that all pipes are closed fires up something that prevents the
exec&#40;&#41; call to actually be performed. Maybe.

Anyway, you&#39;re only supposed to use close&#40;&#41; when you know the command
is completed.

The most used command in Git::Repository is actually run&#40;&#41;.
The above code example would be written:

    $ perl -MGit::Repository -e &#39;Git::Repository-&gt;new-&gt;run&#40; qw&#40; push nowhere master &#41; &#41;&#39;

Note that you can still access the exit status using $?
&#40;See <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/module/Git::Repository#run-cmd">https://metacpan.org/module/Git::Repository#run-cmd</a></span> for details&#41;.
It&#39;s also possible &#40;in recent versions&#41; to use the &#39;fatal&#39; option to finely control
which exit statuses will cause run&#40;&#41; to die.

command&#40;&#41; &#40;which returns a System:::Command object&#41; is actually
meant for those cases where you want to do more than get the output
of the git command or die trying. In most cases, you won&#39;d need it.

Hoping that helps.

-- BooK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;15&nbsp;12:24:30&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;17&nbsp;23:24:29&nbsp;2013</span>
    <span class="description">NNUTTER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jul 15 12:24:29 2013, BOOK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Many thanks for the detailed report. :-&#41;
</div>
Yeah, I was going crazy. =&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Anyway, you&#39;re only supposed to use close&#40;&#41; when you know the command
&gt; is completed.
</div>
Would it make sense for close to warn or even die then if the child is still running?  Is that not something you can check portability-wise?  Otherwise I think we can just resolve this ticket.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The most used command in Git::Repository is actually run&#40;&#41;.
</div>
I was using run&#40;&#41; but it wasn&#39;t failing at some point that I thought it should have but given how confused I had become who knows what that original problem was.

Thanks!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;18&nbsp;08:26:24&nbsp;2013</span>
    <span class="description">book [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jul 17 23:24:29 2013, NNUTTER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Jul 15 12:24:29 2013, BOOK wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; Anyway, you&#39;re only supposed to use close&#40;&#41; when you know the command
&gt; &gt; is completed.
</div>&gt; 
&gt; Would it make sense for close to warn or even die then if the child is
&gt; still running?  Is that not something you can check portability-wise?
&gt; Otherwise I think we can just resolve this ticket.
</div>
Actually, the goal of close is to stop the process. When stdin/stdout/stderr
are closed the git process gets a SIGPIPE and dies &#40;I think&#41;.

I could very well be that this just creates zombies in many situations.
System::Command is mostly used by Git::Repository, so I didn&#39;t get many reports
about zombies &#40;yet&#41;. <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/requires/distribution/System-Command">https://metacpan.org/requires/distribution/System-Command</a></span>

The easiest way to create zombies with System::Command since v1.03 is to do this:

    my $out = System::Command-&gt;new&#40; ... &#41;-&gt;stdout;

When the System::Command object gets out of scope &#40;right after we get our hands
on the stdout filehandle of the child process&#41;, it is destroyed, and we have
nothing to call waitpid&#40;&#41; on. If you look in the history of System::Command,
you&#39;ll see I have tried several approaches to deal with that.

The best explanation is there:
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/book/Git-Repository/commit/16a03c7d42e17ce66e7051a5cc83c0a8716cc911">https://github.com/book/Git-Repository/commit/16a03c7d42e17ce66e7051a5cc83c0a8716cc911</a></span>

Before that, I used DESTROY to kill the child process and close all filehandles
as soon as the &#40;at the time, before I forked off most of the code into System::Command&#41;
Git::Repository::Command went out of scope. That broke the above technique, since $out
would now point to a closed filehandle. So I delegated reaping the child process to
a reaper object that handled the cleaning up as soon as all objects went out of scope.

Then a friend conviced me that I didn&#39;t need all that complexity, and I removed the
Reaper logic &#40;DESTROY was already gone&#41;. All my tests still passed, and I had forgotten
about the zombie issue. Some details here:
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/book/System-Command/commit/a8d0b1b44814d929bfc6e4a014aa1b2098509434">https://github.com/book/System-Command/commit/a8d0b1b44814d929bfc6e4a014aa1b2098509434</a></span>

I recently found that Git::Repository itself was creating zombies when checking its
git binary, which brought back the whole issue. I fixed the client code in Git::Repository
to not use the above technique.

I might fix the more general zombie issue in System::Command in the future.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; The most used command in Git::Repository is actually run&#40;&#41;.
</div>&gt; 
&gt; I was using run&#40;&#41; but it wasn&#39;t failing at some point that I thought
&gt; it should have but given how confused I had become who knows what that
&gt; original problem was.
&gt; 
</div>
By default run&#40;&#41; only dies when git exits with statuses 128 and 129.
It turns out that this is not enough for all cases, so I added the
&#39;fatal&#39; option:

<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/module/Git::Repository::Tutorial#Finely-control-when-run-dies">https://metacpan.org/module/Git::Repository::Tutorial#Finely-control-when-run-dies</a></span>

You probably want to use this line:

    $r = Git::Repository-&gt;new&#40; { fatal =&gt; &#34;!0&#34; } &#41;;

-- BooK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;27&nbsp;03:11:48&nbsp;2014</span>
    <span class="description">book [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jul 18 08:26:24 2013, BOOK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; The easiest way to create zombies with System::Command since v1.03 is
&gt; to do this:
&gt; 
&gt; my $out = System::Command-&gt;new&#40; ... &#41;-&gt;stdout;
&gt; 
&gt; When the System::Command object gets out of scope &#40;right after we get our hands
&gt; on the stdout filehandle of the child process&#41;, it is destroyed, and we have
&gt; nothing to call waitpid&#40;&#41; on. If you look in the history of System::Command,
&gt; you&#39;ll see I have tried several approaches to deal with that.
</div>
That specific issue is actually fixed since 1.106 &#40;published on 2013-10-12&#41;.

-- BooK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;27&nbsp;03:12:16&nbsp;2014</span>
    <span class="description">book [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
