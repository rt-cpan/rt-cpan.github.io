<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #32122 for CGI: Changes to CGI::Util method escape breaks compatibility to CGI::Compress::Gzip</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #32122 for CGI: Changes to CGI::Util method escape breaks compatibility to CGI::Compress::Gzip</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/CGI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/CGI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/CGI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/CGI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/leejo/CGI.pm/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/CGI">CGI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">32122</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/CGI/Active/">CGI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">LDS [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dietrich.streifert [...] googlemail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-230860-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-230861-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;07&nbsp;04:17:23&nbsp;2008</span>
    <span class="description">dietrich.streifert [...] googlemail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Changes to CGI::Util method escape breaks compatibility to
 CGI::Compress::Gzip</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">We are using CGI and CGI::Compress::Gzip to automatically compress
output of html &#40;Indirectly by using CGI::Application and
CGI::Application::Plugin::CompressGzip&#41;.

After updating to from CGI V 3.29 to V 3.33 the output seemed to be
created as UTF-8 independent from the charset settings in the file or
header. This was for pages adding cookies to the header.

After examining the code it turned out that changes in the method escape
from

$toencode = eval { pack&#40;&#34;C*&#34;, unpack&#40;&#34;U0C*&#34;, $toencode&#41;&#41;} || pack&#40;&#34;C*&#34;,
unpack&#40;&#34;C*&#34;, $toencode&#41;&#41;;
  
to &#40;change from &#34;C*&#34; to &#34;U*&#34; in the first pack call&#41;

$toencode = eval { pack&#40;&#34;U*&#34;, unpack&#40;&#34;U0C*&#34;, $toencode&#41;&#41;} || pack&#40;&#34;C*&#34;,
unpack&#40;&#34;C*&#34;, $toencode&#41;&#41;;

Caused the problem.

I don&#39;t know if this problem can be solved in this module but it caused
the problem. I&#39;ll report this also to the  CGI::Compress::Gzip module RT.

Thank you for your help and your great module. Happy new year.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;07&nbsp;10:05:21&nbsp;2008</span>
    <span class="description">LDS [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;07&nbsp;10:06:34&nbsp;2008</span>
    <span class="description">LDS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ouch! Can you give me any more detail on why the Gzip compression is not
working? I don&#39;t see an obvious dependency between the charset and the
gzip module.

Lincoln

On Mon Jan 07 04:17:23 2008, level420 wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; We are using CGI and CGI::Compress::Gzip to automatically compress
&gt; output of html &#40;Indirectly by using CGI::Application and
&gt; CGI::Application::Plugin::CompressGzip&#41;.
&gt; 
&gt; After updating to from CGI V 3.29 to V 3.33 the output seemed to be
&gt; created as UTF-8 independent from the charset settings in the file or
&gt; header. This was for pages adding cookies to the header.
&gt; 
&gt; After examining the code it turned out that changes in the method escape
&gt; from
&gt; 
&gt; $toencode = eval { pack&#40;&#34;C*&#34;, unpack&#40;&#34;U0C*&#34;, $toencode&#41;&#41;} || pack&#40;&#34;C*&#34;,
&gt; unpack&#40;&#34;C*&#34;, $toencode&#41;&#41;;
&gt;   
&gt; to &#40;change from &#34;C*&#34; to &#34;U*&#34; in the first pack call&#41;
&gt; 
&gt; $toencode = eval { pack&#40;&#34;U*&#34;, unpack&#40;&#34;U0C*&#34;, $toencode&#41;&#41;} || pack&#40;&#34;C*&#34;,
&gt; unpack&#40;&#34;C*&#34;, $toencode&#41;&#41;;
&gt; 
&gt; Caused the problem.
&gt; 
&gt; I don&#39;t know if this problem can be solved in this module but it caused
&gt; the problem. I&#39;ll report this also to the  CGI::Compress::Gzip module RT.
&gt; 
&gt; Thank you for your help and your great module. Happy new year.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;07&nbsp;10:06:41&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;07&nbsp;10:18:22&nbsp;2008</span>
    <span class="description">dietrich.streifert [...] googlemail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dietrich.streifert [...] googlemail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mo. 07. Jan. 2008, 10:06:34, LDS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ouch! Can you give me any more detail on why the Gzip compression is not
&gt; working? I don&#39;t see an obvious dependency between the charset and the
&gt; gzip module.
&gt; 
&gt; Lincoln
&gt; 
</div>
Thank you for your quick answer Lincoln!

Sorry but I can&#39;t give you much information why this is happening. I
found that with CPR.pm 3.29 everything worked and after an upgrade to
CPR.pm 3.33 the problem was there. My pages are encoded in ISO-8859-1
and the accented characters are inserted as is and not as entities.

So on the first page visit &#40;tested in IE7 and FF2&#41; instead of the
accented characters the typical two byte encoding hyroglyphs started
showing up in the page.

But only when I was setting a cookie!

So I investigated some time in testing other CPR.pm versions and having
a look into the cookie handling and found that the escape method from
CGI::Util was used to encode the cookie data.

After detecting the changes I simply reverted the out-commented
pack/unpack line and commented the new one. And voila! It worked again.

Maybe CGI::Compress::Gzip has to be updated to work again with the new
escape implementation but I have to few knowledge to do this.

So I ended up just informing you that there is a problem.

So I&#39;m totaly depending here on your help.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;14&nbsp;09:31:32&nbsp;2008</span>
    <span class="description">dietrich.streifert [...] googlemail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dietrich.streifert [...] googlemail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Any news on this subject?

Regards...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;14&nbsp;10:33:15&nbsp;2008</span>
    <span class="description">LDS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Try applying this patch.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">? CGI-diff
? CGI.diff
? CGI.patch
? CGI.pm-3.29.tar.gz
? CGI.pm-3.30.tar.gz
? CGI.pm-3.31.tar.gz
? CGI.pm-3.32.tar.gz
? CGI.pm-3.33.tar.gz
? CGI.pm-3.34.tar.gz
? CGI.pm.diff
? Carp.pm.patch
? META.yml
? PUT.patch
? TODO
? attributes.patch
? backout.patch
? d.txt
? post_max_bug.txt
? proposed_diff.patch
? tar.gz
? t/.cvsignore
? t/uploadInfo.t
Index: CGI.pm
===================================================================
RCS file: /usr/local/cvs_repository/CGI.pm/CGI.pm,v
retrieving revision 1.242
retrieving revision 1.247
diff -u -r1.242 -r1.247
--- CGI.pm	27 Dec 2007 18:39:38 -0000	1.242
+++ CGI.pm	14 Mar 2008 14:29:36 -0000	1.247
@@ -18,8 +18,8 @@
 # The most recent version and complete docs are available at:
 #   <span class="clickylink"><a target="new" rel="nofollow" href="http://stein.cshl.org/WWW/software/CGI/">http://stein.cshl.org/WWW/software/CGI/</a></span>
 
-$CGI::revision = &#39;$Id: CGI.pm,v 1.242 2007/12/27 18:39:38 lstein Exp $&#39;;
-$CGI::VERSION=&#39;3.32&#39;;
+$CGI::revision = &#39;$Id: CGI.pm,v 1.247 2008/03/14 14:29:36 lstein Exp $&#39;;
+$CGI::VERSION=&#39;3.34&#39;;
 
 # HARD-CODED LOCATION FOR FILE UPLOAD TEMPORARY FILES.
 # UNCOMMENT THIS ONLY IF YOU KNOW WHAT YOU&#39;RE DOING.
@@ -1835,7 +1835,7 @@
     my&#40;$method,$action,$enctype,@other&#41; = 
 	rearrange&#40;[METHOD,ACTION,ENCTYPE],@p&#41;;
 
-    $method  = $self-&gt;escapeHTML&#40;lc&#40;$method&#41; || &#39;post&#39;&#41;;
+    $method  = $self-&gt;escapeHTML&#40;lc&#40;$method || &#39;post&#39;&#41;&#41;;
     $enctype = $self-&gt;escapeHTML&#40;$enctype || &#38;URL_ENCODED&#41;;
     if &#40;defined $action&#41; {
        $action = $self-&gt;escapeHTML&#40;$action&#41;;
@@ -2198,9 +2198,11 @@
          else {
 	     $toencode =~ s{&#34;}{&#38;quot;}gso;
          }
-         my $latin = uc $self-&gt;{&#39;.charset&#39;} eq &#39;ISO-8859-1&#39; ||
-                     uc $self-&gt;{&#39;.charset&#39;} eq &#39;WINDOWS-1252&#39;;
-         if &#40;$latin&#41; {  # bug in some browsers
+         # Handle bug in some browsers with Latin charsets
+         if &#40;$self-&gt;{&#39;.charset&#39;} &#38;&#38;
+             &#40;uc&#40;$self-&gt;{&#39;.charset&#39;}&#41; eq &#39;ISO-8859-1&#39; ||
+              uc&#40;$self-&gt;{&#39;.charset&#39;}&#41; eq &#39;WINDOWS-1252&#39;&#41;&#41;
+         {
                 $toencode =~ s{&#39;}{&#38;#39;}gso;
                 $toencode =~ s{\x8b}{&#38;#8249;}gso;
                 $toencode =~ s{\x9b}{&#38;#8250;}gso;
@@ -2730,6 +2732,7 @@
 
     $url .= $path         if $path_info and defined $path;
     $url .= &#34;?$query_str&#34; if $query     and $query_str ne &#39;&#39;;
+    $url ||= &#39;&#39;;
     $url =~ s/&#40;[^a-zA-Z0-9_.%;&#38;?\/\\:+=~-]&#41;/sprintf&#40;&#34;%%%02X&#34;,ord&#40;$1&#41;&#41;/eg;
     return $url;
 }
@@ -4039,7 +4042,7 @@
     my $filename;
     find_tempdir&#40;&#41; unless -w $TMPDIRECTORY;
     for &#40;my $i = 0; $i &lt; $MAXTRIES; $i++&#41; {
-	last if ! -f &#40;$filename = sprintf&#40;&#34;${TMPDIRECTORY}${SL}CGItemp%d&#34;,$sequence++&#41;&#41;;
+	last if ! -f &#40;$filename = sprintf&#40;&#34;\%s${SL}CGItemp%d&#34;, $TMPDIRECTORY, $sequence++&#41;&#41;;
     }
     # check that it is a more-or-less valid filename
     return unless $filename =~ m!^&#40;[a-zA-Z0-9_\+ \&#39;\&#34;:/.\$\\-]+&#41;$!;
@@ -7685,10 +7688,8 @@
 
 =head1 AUTHOR INFORMATION
 
-Copyright 1995-1998, Lincoln D. Stein.  All rights reserved.  
-
-This library is free software; you can redistribute it and/or modify
-it under the same terms as Perl itself.
+The GD.pm interface is copyright 1995-2007, Lincoln D. Stein.  It is
+distributed under GPL and the Artistic License 2.0.
 
 Address bug reports and comments to: lstein@cshl.org.  When sending
 bug reports, please provide the version of CGI.pm, the version of
Index: Changes
===================================================================
RCS file: /usr/local/cvs_repository/CGI.pm/Changes,v
retrieving revision 1.64
retrieving revision 1.68
diff -u -r1.64 -r1.68
--- Changes	27 Dec 2007 18:39:38 -0000	1.64
+++ Changes	14 Mar 2008 14:29:36 -0000	1.68
@@ -1,3 +1,11 @@
+  Version 3.34
+  1. Handle Unicode %uXXXX  escapes properly -- patch from DANKOGAI@cpan.org
+
+  Version 3.33
+  1. Remove uninit variable warning when calling url&#40;-relative=&gt;1&#41;
+  2. Fix uninit variable warnings for two lc calls
+  3. Fixed failure of tempfile upload due to sprintf&#40;&#41; taint failure in perl 5.10
+
   Version 3.32
   1. Patch from Miguel Santinho to prevent sending premature headers under mod_perl 2.0
 
Index: CGI/Util.pm
===================================================================
RCS file: /usr/local/cvs_repository/CGI.pm/CGI/Util.pm,v
retrieving revision 1.26
retrieving revision 1.27
diff -u -r1.26 -r1.27
--- CGI/Util.pm	30 Nov 2007 19:04:04 -0000	1.26
+++ CGI/Util.pm	14 Mar 2008 14:29:37 -0000	1.27
@@ -7,7 +7,7 @@
 @EXPORT_OK = qw&#40;rearrange make_attributes unescape escape 
 		expires ebcdic2ascii ascii2ebcdic&#41;;
 
-$VERSION = &#39;1.5&#39;;
+$VERSION = &#39;1.5_01&#39;;
 
 $EBCDIC = &#34;\t&#34; ne &#34;\011&#34;;
 # &#40;ord&#40;&#39;^&#39;&#41; == 95&#41; for codepage 1047 as on os390, vmesa
@@ -141,8 +141,12 @@
 
 sub utf8_chr {
         my $c = shift&#40;@_&#41;;
-	return chr&#40;$c&#41; if $] &gt;= 5.006;
-
+	if &#40;$] &gt;= 5.006&#41;{
+	    require utf8;
+	    my $u = chr&#40;$c&#41;;
+	    utf8::encode&#40;$u&#41;; # drop utf8 flag
+	    return $u;
+	}
         if &#40;$c &lt; 0x80&#41; {
                 return sprintf&#40;&#34;%c&#34;, $c&#41;;
         } elsif &#40;$c &lt; 0x800&#41; {
@@ -189,6 +193,17 @@
     if &#40;$EBCDIC&#41; {
       $todecode =~ s/%&#40;[0-9a-fA-F]{2}&#41;/chr $A2E[hex&#40;$1&#41;]/ge;
     } else {
+	# handle surrogate pairs first -- dankogai
+	$todecode =~ s{
+			%u&#40;[Dd][89a-bA-B][0-9a-fA-F]{2}&#41; # hi
+		        %u&#40;[Dd][c-fC-F][0-9a-fA-F]{2}&#41;   # lo
+		      }{
+			  utf8_chr&#40;
+				   0x10000 
+				   + &#40;hex&#40;$1&#41; - 0xD800&#41; * 0x400 
+				   + &#40;hex&#40;$2&#41; - 0xDC00&#41;
+				  &#41;
+		      }gex;
       $todecode =~ s/%&#40;?:&#40;[0-9a-fA-F]{2}&#41;|u&#40;[0-9a-fA-F]{4}&#41;&#41;/
 	defined&#40;$1&#41;? chr hex&#40;$1&#41; : utf8_chr&#40;hex&#40;$2&#41;&#41;/ge;
     }
@@ -200,9 +215,12 @@
   shift&#40;&#41; if @_ &gt; 1 and &#40; ref&#40;$_[0]&#41; || &#40;defined $_[1] &#38;&#38; $_[0] eq $CGI::DefaultClass&#41;&#41;;
   my $toencode = shift;
   return undef unless defined&#40;$toencode&#41;;
+  $toencode = eval { pack&#40;&#34;C*&#34;, unpack&#40;&#34;U0C*&#34;, $toencode&#41;&#41;} || pack&#40;&#34;C*&#34;, unpack&#40;&#34;C*&#34;, $toencode&#41;&#41;;
+
   # force bytes while preserving backward compatibility -- dankogai
-#  $toencode = eval { pack&#40;&#34;C*&#34;, unpack&#40;&#34;U0C*&#34;, $toencode&#41;&#41;} || pack&#40;&#34;C*&#34;, unpack&#40;&#34;C*&#34;, $toencode&#41;&#41;;
-  $toencode = eval { pack&#40;&#34;U*&#34;, unpack&#40;&#34;U0C*&#34;, $toencode&#41;&#41;} || pack&#40;&#34;C*&#34;, unpack&#40;&#34;C*&#34;, $toencode&#41;&#41;;
+  # but commented out because it was breaking CGI::Compress -- lstein
+  # $toencode = eval { pack&#40;&#34;U*&#34;, unpack&#40;&#34;U0C*&#34;, $toencode&#41;&#41;} || pack&#40;&#34;C*&#34;, unpack&#40;&#34;C*&#34;, $toencode&#41;&#41;;
+
     if &#40;$EBCDIC&#41; {
       $toencode=~s/&#40;[^a-zA-Z0-9_.~-]&#41;/uc sprintf&#40;&#34;%%%02x&#34;,$E2A[ord&#40;$1&#41;]&#41;/eg;
     } else {
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;18&nbsp;10:35:40&nbsp;2008</span>
    <span class="description">dietrich.streifert [...] googlemail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dietrich.streifert [...] googlemail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fr. 14. MÃ¤r. 2008, 10:33:15, LDS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Try applying this patch.
</div>
Yes! This solves the bug.

I stumbled first on the fact that the patch is for CGI 3.32, but after
patching the right version the bug is solved.

Please publish a new version ASAP.

Thank you for your support.

Best regards.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;18&nbsp;12:04:18&nbsp;2008</span>
    <span class="description">LDS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in 3.34.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;18&nbsp;12:04:20&nbsp;2008</span>
    <span class="description">LDS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;May&nbsp;23&nbsp;14:28:48&nbsp;2014</span>
    <span class="description">The RT System itself -  Queue changed from CGI.pm to CGI</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
