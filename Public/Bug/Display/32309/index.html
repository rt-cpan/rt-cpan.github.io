<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #32309 for DBI: &#34;DBIS&#34; macro defined incorrectly</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #32309 for DBI: &#34;DBIS&#34; macro defined incorrectly</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DBI">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DBI">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DBI">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DBI">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBI">DBI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">32309</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DBI">DBI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
vandry [...] TZoNE.ORG

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10328-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.601    </td>
  </tr>
  <tr id="CF-10329-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=32309">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-408649" href="/Public/Bug/Display.html?id=32309#txn-408649">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;14&nbsp;17:14:33&nbsp;2008</span>
    <span class="description">PVANDRY [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> &#34;DBIS&#34; macro defined incorrectly</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/408649/199314/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/199314">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The DBIS macro is declared in the &#34;DBIXS.h&#34; header file and used by the
various DBD::xx modules to fetch the state information published by the
DBI module. The definition of this as follows:

# define DBIS &#40;*&#40;INT2PTR&#40;dbistate_t**, &#38;SvIVX&#40;DBISTATE_ADDRSV&#41;&#41;&#41;&#41;

&#40;DBIXH.h line 458&#41;

This definition is incorrect.

This bug requires the following preconditions in order to occur:

- Perl built with threads &#40;MULTIPLICITY is defined&#41;. Without this, a
different definition for the DBIS macro is used, and that definition
does not exhibit a problem.

- Integers and pointers are not the same size. If integers and pointers
are the same size then the macro becomes a no-op and is harmless.

- Big endian platform. On little endian, everything just works out.

NOTE regarding the severity level I have attached to this ticket:
although most Perl users will not be affected by this bug because they
do not have systems that meet the preconditions above, DBI is completely
unusable due to this bug on those platforms that do meet the
preconditions, so it should be regarded as a critical bug.

Why is this macro wrong?

First we fetch the state variable using DBISTATE_ADDRSV, then we get its
integer value using SvIVX. Now we take a pointer to this integer &#40;using
&#38;&#41;. The resulting type is &#40;IV *&#41; but INT2PTR casts it to a
&#40;dbistate_t**&#41;. This cast doesn&#39;t make any sense: this value is not at
all a pointer to a pointer to a structure of type dbistate_t, it&#39;s a
pointer to an integer whose value is the same as the address of a
structure of type dbistate_t.

Here is an example for platform &#34;sun4-solaris-thread-multi-64int&#34; where
the integers are 8 bytes and the pointers are 4 bytes. SvIVX returns an
[8-byte] integer. Now we take a pointer to this integer and cast it to a
&#40;dbistate_t**&#41;. Then we dereference that double pointer. This causes us
to look at the first four bytes of the integer and interpret them as a
pointer. Since these are the most significant 4 bytes of the original
integer, the result is incorrect &#40;we are actually trying to get at the
least significant 4 bytes of the integer&#41;. We are left with a result of
type &#40;dbistate_t *&#41; which is a NULL pointer.

I do not understand why the definition of this macro is so complicated.
It seems to me that what we are trying to do is actually just this:

#define DBIS &#40;INT2PTR&#40;dbistate_t*, SvIVX&#40;DBISTATE_ADDRSV&#41;&#41;&#41;

That is, take the result of SvIVX &#40;which is of type IV&#41; and cast it to a
pointer of type &#40;dbistate_t*&#41;. Because of the different sizes of the two
types, this cast causes the most significant bytes of the value to be
discarded on platforms where integers are bigger than pointers, which is
what we want. The resulting &#40;dbistate_t*&#41; is returned directly.

I am mystified as to why the original macro creates an extra indirection
of the pointer only to dereference it again at the end. It is both
simpler and more correct to not do that. I mention my interrogation on
this point only in case there is some reason for the more complicated
definition that eludes me.

TO REPRODUCE:

- Install DBI normally on platform sun4-solaris-thread-multi-64int.
- Unpack, configure, and make the latest version of DBD::mysql.
- make test will fail

TO PROVE MY ALTERNATE DEFINITON OF DBIS WORKS:

- Edit the mysql.xs file that is part of the DBD::mysql distribution.
- Right after the includes at the top of the file, override the
definition of the DBIS macro by inserting these lines:

#undef DBIS
#define DBIS &#40;INT2PTR&#40;dbistate_t*, SvIVX&#40;DBISTATE_ADDRSV&#41;&#41;&#41;

- rerun make
- make test now passes

RECOMMENDATION FOR FIX:

Change the definition of the DBIS macro in the DBIXS.h file to the one I
suggest. Change also the dbis macro 2 lines below.

-Phil
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-438300" href="/Public/Bug/Display.html?id=32309#txn-438300">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;21&nbsp;20:08:00&nbsp;2008</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/438300/214651/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/214651">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 311b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The macro is complex because &#40;as I recall&#41; it was setup to be an lvalue.
ActiveState supplied the patch many years ago when they added PERL_OBJECT.
The tricky question is: do some drivers still need it to be an lvalue?
I think the answer is no but I&#39;m not sure.
Would you be willing to test alternative fixes?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-438301" href="/Public/Bug/Display.html?id=32309#txn-438301">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;21&nbsp;20:11:19&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-438307" href="/Public/Bug/Display.html?id=32309#txn-438307">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;21&nbsp;20:26:05&nbsp;2008</span>
    <span class="description">vandry [...] TZoNE.ORG -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #32309] &#34;DBIS&#34; macro defined incorrectly</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 21 Mar 2008 20:25:45 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Tim_Bunce via RT &lt;bug-DBI [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Phil Vandry &lt;vandry [...] TZoNE.ORG&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/438307/214657/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/214657">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 319b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Mar 21, 2008 at 08:11:21PM -0400, Tim_Bunce via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The macro is complex because &#40;as I recall&#41; it was setup to be an lvalue.
</div>
Ah, that would explain it!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Would you be willing to test alternative fixes?
</div>
Yes, I can easily test using the same SPARC on which I originally
encountered the problem.

-Phil
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-452559" href="/Public/Bug/Display.html?id=32309#txn-452559">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;22&nbsp;04:48:45&nbsp;2008</span>
    <span class="description">TIMB [...] cpan.org -  Severity Critical changed to Important</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-452560" href="/Public/Bug/Display.html?id=32309#txn-452560">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;22&nbsp;04:49:53&nbsp;2008</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/452560/222459/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/222459">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 173b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve not been able to find time to work on this.
Could you?
Meanwhile I&#39;ve downgraded this from Critical to Important as you&#39;re still the only one to have 
raised the issue.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-464733" href="/Public/Bug/Display.html?id=32309#txn-464733">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;22&nbsp;14:20:57&nbsp;2008</span>
    <span class="description">ranjmis [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ranjmis [...] gmail.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/464733/228861/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/228861">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Perl Gurus,

I have banged into the same problem on solaris-sparc multi-threaded perl
build - for good reasons i guess.
I have been figuring the issue out with DBD-SQLite-1.14 on sparc.
&#40;Raised a bug also there
<span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Bug/Display.html?id=35972">http://rt.cpan.org/Public/Bug/Display.html?id=35972</a></span> but actually it
belongs to DBI&#41;
After wrestling for couple of days with XS and SQLite.c interface I too
 found DBIS is what is causing the problem. I could fix the problem
partially by redefining D_imp_* macros where instead of doing a &#38; then
** and * in INT2PTR, directly worked on the integer casted pointer.

I did :

#ifdef D_imp_dbh
#undef D_imp_dbh
#undef D_imp_drh
#undef D_imp_sth
#define D_imp_dbh&#40;dbh&#41; imp_dbh_t * imp_dbh = &#40; imp_dbh_t * &#41; &#40; &#40; &#40;  &#40; &#40;
dbistate_t *  &#41; &#40; unsigned long&#41; &#40;  &#40; &#40; XPVIV * &#41; &#40; &#40;
 &#40;SV*&#41;Perl_get_sv &#40; &#40; &#40; PerlInterpreter * &#41; pthread_getspecific &#40; &#40; *
Perl_Gthr_key_ptr &#40; &#40;void *&#41;0 &#41; &#41; &#41; &#41; , &#34;DBI::_dbistate
&#34; , 0x05 &#41; &#41; &#41; -&gt; sv_any&#41; -&gt; xiv_iv &#41; &#41; &#41; -&gt; getcom &#40; dbh &#41; &#41; &#41;
#define D_imp_drh&#40;drh&#41; imp_drh_t * imp_drh = &#40; imp_drh_t * &#41; &#40; &#40; &#40;  &#40; &#40;
dbistate_t *  &#41; &#40; unsigned long &#41; &#40;  &#40; &#40; XPVIV * &#41; &#40;
&#40; &#40;SV*&#41;Perl_get_sv &#40; &#40; &#40; PerlInterpreter * &#41; pthread_getspecific &#40; &#40; *
Perl_Gthr_key_ptr &#40; 0 &#41; &#41; &#41; &#41; , &#34;DBI::_dbistate&#34; , 0x0
5 &#41; &#41; &#41; -&gt; sv_any &#41; -&gt; xiv_iv &#41; &#41; &#41; -&gt; getcom &#40; drh &#41; &#41; &#41;;
#define D_imp_sth&#40;sth&#41;    imp_sth_t * imp_sth = &#40; imp_sth_t * &#41; &#40; &#40; &#40;  &#40;
&#40; dbistate_t *  &#41; &#40; unsigned long &#41; &#40;  &#40; &#40; XPVIV * &#41;
 &#40; &#40; &#40;SV*&#41;Perl_get_sv &#40; &#40; &#40; PerlInterpreter * &#41; pthread_getspecific &#40; &#40;
* Perl_Gthr_key_ptr &#40; 0 &#41; &#41; &#41; &#41; , &#34;DBI::_dbistate&#34; ,
0x05 &#41; &#41; &#41; -&gt; sv_any &#41; -&gt; xiv_iv &#41; &#41; &#41; -&gt; getcom &#40; sth &#41; &#41; &#41;
#endif

but stuck when I defined DBIS as it is acting as a lvalue at many places
like dbdimp.c for SQLite: 

void
sqlite_init&#40;dbistate_t *dbistate&#41;
{
    dTHR;
    DBIS = dbistate;
}

so we need &#38; and ** and * there.
&#40;Although I could figure out the problem but PVANDRY has beautifully
explained the issue making it crystal clear. Many thanks.&#41;
If there is any patch lying around for this lvalue or any quick fix
would be very helpful.

On Fri Mar 21 20:08:00 2008, TIMB wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The macro is complex because &#40;as I recall&#41; it was setup to be an lvalue.
&gt; ActiveState supplied the patch many years ago when they added PERL_OBJECT.
&gt; The tricky question is: do some drivers still need it to be an lvalue?
&gt; I think the answer is no but I&#39;m not sure.
&gt; Would you be willing to test alternative fixes?
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-464859" href="/Public/Bug/Display.html?id=32309#txn-464859">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;22&nbsp;18:46:29&nbsp;2008</span>
    <span class="description">ranjmis [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ranjmis [...] gmail.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/464859/228952/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/228952">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Problem fixed as:
In SQLiteXS.h

#undef DBIS
#define DBIS &#40;INT2PTR&#40;dbistate_t*, SvIVX&#40;DBISTATE_ADDRSV&#41;&#41;&#41;
#define DBISV SvIVX&#40;DBISTATE_ADDRSV&#41;

DBISV is ment to be used as lvalue.
So in dbdimp.c

void
sqlite_init&#40;dbistate_t *dbistate&#41;
{
    dTHR;
    DBISV = dbistate;
}

&#40; Updated <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Bug/Display.html?id=35972">http://rt.cpan.org/Public/Bug/Display.html?id=35972</a></span> &#41;

On Thu May 22 14:20:57 2008, ranjmis wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Perl Gurus,
&gt; 
&gt; I have banged into the same problem on solaris-sparc multi-threaded perl
&gt; build - for good reasons i guess.
&gt; I have been figuring the issue out with DBD-SQLite-1.14 on sparc.
&gt; &#40;Raised a bug also there
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Bug/Display.html?id=35972">http://rt.cpan.org/Public/Bug/Display.html?id=35972</a></span> but actually it
&gt; belongs to DBI&#41;
&gt; After wrestling for couple of days with XS and SQLite.c interface I too
&gt;  found DBIS is what is causing the problem. I could fix the problem
&gt; partially by redefining D_imp_* macros where instead of doing a &#38; then
&gt; ** and * in INT2PTR, directly worked on the integer casted pointer.
&gt; 
&gt; I did :
&gt; 
&gt; #ifdef D_imp_dbh
&gt; #undef D_imp_dbh
&gt; #undef D_imp_drh
&gt; #undef D_imp_sth
&gt; #define D_imp_dbh&#40;dbh&#41; imp_dbh_t * imp_dbh = &#40; imp_dbh_t * &#41; &#40; &#40; &#40;  &#40; &#40;
&gt; dbistate_t *  &#41; &#40; unsigned long&#41; &#40;  &#40; &#40; XPVIV * &#41; &#40; &#40;
&gt;  &#40;SV*&#41;Perl_get_sv &#40; &#40; &#40; PerlInterpreter * &#41; pthread_getspecific &#40; &#40; *
&gt; Perl_Gthr_key_ptr &#40; &#40;void *&#41;0 &#41; &#41; &#41; &#41; , &#34;DBI::_dbistate
&gt; &#34; , 0x05 &#41; &#41; &#41; -&gt; sv_any&#41; -&gt; xiv_iv &#41; &#41; &#41; -&gt; getcom &#40; dbh &#41; &#41; &#41;
&gt; #define D_imp_drh&#40;drh&#41; imp_drh_t * imp_drh = &#40; imp_drh_t * &#41; &#40; &#40; &#40;  &#40; &#40;
&gt; dbistate_t *  &#41; &#40; unsigned long &#41; &#40;  &#40; &#40; XPVIV * &#41; &#40;
&gt; &#40; &#40;SV*&#41;Perl_get_sv &#40; &#40; &#40; PerlInterpreter * &#41; pthread_getspecific &#40; &#40; *
&gt; Perl_Gthr_key_ptr &#40; 0 &#41; &#41; &#41; &#41; , &#34;DBI::_dbistate&#34; , 0x0
&gt; 5 &#41; &#41; &#41; -&gt; sv_any &#41; -&gt; xiv_iv &#41; &#41; &#41; -&gt; getcom &#40; drh &#41; &#41; &#41;;
&gt; #define D_imp_sth&#40;sth&#41;    imp_sth_t * imp_sth = &#40; imp_sth_t * &#41; &#40; &#40; &#40;  &#40;
&gt; &#40; dbistate_t *  &#41; &#40; unsigned long &#41; &#40;  &#40; &#40; XPVIV * &#41;
&gt;  &#40; &#40; &#40;SV*&#41;Perl_get_sv &#40; &#40; &#40; PerlInterpreter * &#41; pthread_getspecific &#40; &#40;
&gt; * Perl_Gthr_key_ptr &#40; 0 &#41; &#41; &#41; &#41; , &#34;DBI::_dbistate&#34; ,
&gt; 0x05 &#41; &#41; &#41; -&gt; sv_any &#41; -&gt; xiv_iv &#41; &#41; &#41; -&gt; getcom &#40; sth &#41; &#41; &#41;
&gt; #endif
&gt; 
&gt; but stuck when I defined DBIS as it is acting as a lvalue at many places
&gt; like dbdimp.c for SQLite: 
&gt; 
&gt; void
&gt; sqlite_init&#40;dbistate_t *dbistate&#41;
&gt; {
&gt;     dTHR;
&gt;     DBIS = dbistate;
&gt; }
&gt; 
&gt; so we need &#38; and ** and * there.
&gt; &#40;Although I could figure out the problem but PVANDRY has beautifully
&gt; explained the issue making it crystal clear. Many thanks.&#41;
&gt; If there is any patch lying around for this lvalue or any quick fix
&gt; would be very helpful.
&gt; 
&gt; On Fri Mar 21 20:08:00 2008, TIMB wrote:
<div class="message-stanza open">&gt; &gt; The macro is complex because &#40;as I recall&#41; it was setup to be an lvalue.
&gt; &gt; ActiveState supplied the patch many years ago when they added
</div></div>PERL_OBJECT.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; The tricky question is: do some drivers still need it to be an lvalue?
&gt; &gt; I think the answer is no but I&#39;m not sure.
&gt; &gt; Would you be willing to test alternative fixes?
&gt; &gt; 
</div>&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-466358" href="/Public/Bug/Display.html?id=32309#txn-466358">#</a>      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;27&nbsp;08:30:15&nbsp;2008</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/466358/229851/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/229851">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 187b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think I have fixed this now, as of revision 11329.
I&#39;d be grateful if someone could test it using the version in the repository.
See <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~timb/DBI/DBI.pm#CONTRIBUTING">http://search.cpan.org/~timb/DBI/DBI.pm#CONTRIBUTING</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-466361" href="/Public/Bug/Display.html?id=32309#txn-466361">#</a>      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;27&nbsp;08:30:17&nbsp;2008</span>
    <span class="description">TIMB [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.544218</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
