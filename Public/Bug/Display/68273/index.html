<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #68273 for NetAddr-IP: Problem with -&gt;compactref</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #68273 for NetAddr-IP: Problem with -&gt;compactref</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/NetAddr-IP/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/NetAddr-IP/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/NetAddr-IP/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/NetAddr-IP/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/NetAddr-IP">NetAddr-IP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">68273</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">1 hour (60 min)

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/NetAddr-IP/Active/">NetAddr-IP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">michael [...] bizsystems.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
codebard [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-23470-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
4.043    </td>
  </tr>
  <tr id="CF-23471-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;17&nbsp;16:04:48&nbsp;2011</span>
    <span class="description">codebard [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Problem with -&gt;compactref</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I encountered a problem trying to use -&gt;compactref&#40;\@list&#41; where the &#40;incorrect&#41; results I was 
receiving were closer to an expansion rather than a compaction -- the results were correct 
when using Compact&#40;@list&#41; and -&gt;compact&#40;@list&#41;.  I got consistent results with Perl 5.8.8, 
5.10.1, and 5.12.3 under Linux and Darwin.

When I checked the code, it appeared that -&gt;compactref&#40;&#41; only took into account an array ref 
of NetAddr::IP objects as its only argument, so Compact&#40;@list&#41; and -&gt;compact&#40;@list&#41; worked 
but -&gt;compactref&#40;\@list&#41; did not since the first argument would be a NetAddr::IP object and 
the second would be the array ref.

Here is a patch that should address that.  I also implemented support and POD for 
Compact&#40;\@list&#41;, which made the most sense to me without having to add an export for a 
&#34;Compactref&#34;.

I&#39;ve also included a patch to augment t/v4-compact.t

Thanks.

Rusty
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> compact-t.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- t/v4-compact.t	2008-12-02 12:54:12.000000000 -0800
+++ t/v4-compact-new.t	2011-05-17 12:35:14.000000000 -0700
@@ -18,44 +18,93 @@
     exit 0;
 }
 
-print &#34;1..2\n&#34;;
+print &#34;1..9\n&#34;;
 
-my @ips;
+my @ips1;
 
 for my $ip &#40;&#39;10.0.0.0&#39;, &#39;11.0.0.0&#39;, &#39;12.0.0.0&#39;&#41; {
-    push @ips, NetAddr::IP-&gt;new&#40;$ip, 24&#41;-&gt;split&#40;32&#41;;
+    push @ips1, NetAddr::IP-&gt;new&#40;$ip, 24&#41;-&gt;split&#40;32&#41;;
 }
 
 for my $ip &#40;&#39;20.0.0.0&#39;, &#39;30.0.0.0&#39;, &#39;40.0.0.0&#39;&#41; {
-    push @ips, NetAddr::IP-&gt;new&#40;$ip, 16&#41;-&gt;split&#40;28&#41;;
+    push @ips1, NetAddr::IP-&gt;new&#40;$ip, 16&#41;-&gt;split&#40;28&#41;;
 }
 
-my @c = Compact&#40;@ips&#41;;
-my @m;
+my @ips2;
 
-for my $c &#40;@c&#41; {
-    push @m, grep { $c-&gt;addr eq $_-&gt;[0] and $c-&gt;mask eq $_-&gt;[1] } @r;
+for my $num &#40;0 .. 255&#41; {
+    push @ips2, NetAddr::IP-&gt;new&#40;&#34;192.168.$num.0&#34;, 24&#41;;
 }
+my $ips2_compact = &#39;192.168.0.0/16&#39;;
 
-if &#40;@m == @c&#41; {
-    print &#34;ok 1\n&#34;;
-}
-else {
-    print &#34;not ok 1\n&#34;;
-}
+# Compact&#40;@&#41;
+#
+compact_ips1_check&#40;1, Compact&#40;@ips1&#41;&#41;;
+compact_ips2_check&#40;2, Compact&#40;@ips2&#41;&#41;;
+
+# -&gt;compact&#40;@&#41;
+#
+compact_ips1_check&#40;3, $ips1[0]-&gt;compact&#40;@ips1[1..$#ips1]&#41;&#41;;
+compact_ips2_check&#40;4, $ips2[0]-&gt;compact&#40;@ips2[1..$#ips2]&#41;&#41;;
+
+# Compact&#40;[]&#41;
+#
+compact_ips1_check&#40;5, @{Compact&#40;\@ips1&#41;}&#41;;
+compact_ips2_check&#40;6, @{Compact&#40;\@ips2&#41;}&#41;;
+
+# -&gt;compactref&#40;[]&#41;
+#
+compact_ips1_check&#40;7, @{$ips1[0]-&gt;compactref&#40;[@ips1[1..$#ips1]]&#41;}&#41;;
+compact_ips2_check&#40;8, @{$ips2[0]-&gt;compactref&#40;[@ips2[1..$#ips2]]&#41;}&#41;;
 
-@ips = &#40;&#41;;
+# duplicate IP
+#
+@ips1 = &#40;&#41;;
 
 for my $ip &#40;qw&#40;1.1.1.1 1.1.1.1 1.1.1.1 1.1.1.1&#41;&#41; {
-    push&#40;@ips, NetAddr::IP-&gt;new&#40;$ip&#41;&#41;;
+    push&#40;@ips1, NetAddr::IP-&gt;new&#40;$ip&#41;&#41;;
 }
 
-@c = NetAddr::IP::compact&#40;@ips&#41;;
+@c = NetAddr::IP::compact&#40;@ips1&#41;;
 
 if &#40;@c == 1 and $c[0]-&gt;cidr&#40;&#41; eq &#39;1.1.1.1/32&#39;&#41; {
-    print &#34;ok 2\n&#34;;
+    print &#34;ok 9\n&#34;;
 }
 else {
-    print &#34;not ok 2\n&#34;;
+    print &#34;not ok 9\n&#34;;
 }
 
+
+######################################################################
+sub compact_ips1_check
+{
+    my $num = shift;
+    my @ips = shift;
+
+    my @mips;
+    for my $ip &#40;@ips&#41; {
+        push @mips, grep { $ip-&gt;addr eq $_-&gt;[0] and $ip-&gt;mask eq $_-&gt;[1] } @r;
+    }
+
+    if &#40;@mips == @ips&#41; {
+        print &#34;ok $num\n&#34;;
+    }
+    else {
+        print &#34;not ok $num\n&#34;;
+    }
+}
+
+
+######################################################################
+sub compact_ips2_check
+{
+    my $num = shift;
+    my @ips = shift;
+
+    if &#40;@ips == 1 and $ips[0] eq $ips2_compact&#41; {
+        print &#34;ok $num\n&#34;;
+    }
+    else {
+        print &#34;not ok $num\n&#34;;
+    }
+}
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> compact.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- IP.pm	2011-04-06 11:31:14.000000000 -0700
+++ IP-new.pm	2011-05-17 12:34:21.000000000 -0700
@@ -390,7 +390,10 @@
 }
 
 sub compact {
-    return @{compactref&#40;\@_&#41;};
+    return compactref&#40;$_[0]&#41;
+        if ref $_[0] eq &#39;ARRAY&#39;; # Compact&#40;\@list&#41;
+
+    return @{compactref&#40;\@_&#41;};   # Compact&#40;@list&#41;  or -&gt;compact&#40;@list&#41;
 }
 
 *Compact = \&#38;compact;
@@ -1084,7 +1087,9 @@
 
 =item C&lt;$me-E&lt;gt&gt;compactref&#40;\@list&#41;&gt;
 
-As usual, a faster version of =item C&lt;-E&lt;gt&gt;compact&#40;&#41;&gt; that returns a
+=item C&lt;$compacted_object_list = Compact&#40;\@list&#41;&gt;
+
+As usual, a faster version of C&lt;-E&lt;gt&gt;compact&#40;&#41;&gt; that returns a
 reference to a list. Note that this method takes a reference to a list
 instead.
 
@@ -1097,39 +1102,57 @@
 #	or return [];
 #  return [] unless @r;
 
-  return [] unless &#40;my @unr = @{$_[0]}&#41;;
+  my @r;
+  {
+    my $unr  = [];
+    my $args = $_[0];
+
+    if &#40;ref $_[0] eq __PACKAGE__ and ref $_[1] eq &#39;ARRAY&#39;&#41; {
+      # -&gt;compactref&#40;\@list&#41;
+      #
+      $unr = [$_[0], @{$_[1]}]; # keeping structures intact
+    }
+    else {
+      # Compact&#40;@list&#41; or -&gt;compact&#40;@list&#41; or Compact&#40;\@list&#41;
+      #
+      $unr = $args;
+    }
+
+    return [] unless @$unr;
 
-  foreach&#40;0..$#unr&#41; {
-    $unr[$_]-&gt;{addr} = $unr[$_]-&gt;network-&gt;{addr};
+    for &#40;@$unr&#41; {
+      $_-&gt;{addr} = $_-&gt;network-&gt;{addr};
+    }
+
+    @r = sort @$unr;
   }
-  my @r = sort @unr;
 
   my $changed;
   do {
-	$changed = 0;
-	for&#40;my $i=0; $i &lt;= $#r -1;$i++&#41; {
-	  if &#40;$r[$i]-&gt;contains&#40;$r[$i +1]&#41;&#41; {
-	    splice&#40;@r,$i +1,1&#41;;
-	    ++$changed;
-	    --$i;
-	  }
-	  elsif &#40;&#40;notcontiguous&#40;$r[$i]-&gt;{mask}&#41;&#41;[1] == &#40;notcontiguous&#40;$r[$i +1]-&gt;{mask}&#41;&#41;[1]&#41; {		# masks the same
-	    if &#40;hasbits&#40;$r[$i]-&gt;network-&gt;{addr} ^ $r[$i +1]-&gt;network-&gt;{addr}&#41;&#41; {	# if not the same netblock
-	      my $upnet = $r[$i]-&gt;copy;
-	      $upnet-&gt;{mask} = shiftleft&#40;$upnet-&gt;{mask},1&#41;;
-	      if &#40;$upnet-&gt;contains&#40;$r[$i +1]&#41;&#41; {					# adjacent nets in next net up
-		$r[$i] = $upnet;
-		splice&#40;@r,$i +1,1&#41;;
-		++$changed;
-		--$i;
-	      }
-	    } else {									# identical nets
-	      splice&#40;@r,$i +1,1&#41;;
-	      ++$changed;
-	      --$i;
-	    }
-	  }
-	}
+    $changed = 0;
+    for&#40;my $i=0; $i &lt;= $#r -1;$i++&#41; {
+      if &#40;$r[$i]-&gt;contains&#40;$r[$i +1]&#41;&#41; {
+        splice&#40;@r,$i +1,1&#41;;
+        ++$changed;
+        --$i;
+      }
+      elsif &#40;&#40;notcontiguous&#40;$r[$i]-&gt;{mask}&#41;&#41;[1] == &#40;notcontiguous&#40;$r[$i +1]-&gt;{mask}&#41;&#41;[1]&#41; {		# masks the same
+        if &#40;hasbits&#40;$r[$i]-&gt;{addr} ^ $r[$i +1]-&gt;{addr}&#41;&#41; {	# if not the same netblock
+          my $upnet = $r[$i]-&gt;copy;
+          $upnet-&gt;{mask} = shiftleft&#40;$upnet-&gt;{mask},1&#41;;
+          if &#40;$upnet-&gt;contains&#40;$r[$i +1]&#41;&#41; {					# adjacent nets in next net up
+      $r[$i] = $upnet;
+      splice&#40;@r,$i +1,1&#41;;
+      ++$changed;
+      --$i;
+          }
+        } else {									# identical nets
+          splice&#40;@r,$i +1,1&#41;;
+          ++$changed;
+          --$i;
+        }
+      }
+    }
   } while $changed;
   return \@r;
 }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;17&nbsp;16:08:38&nbsp;2011</span>
    <span class="description">codebard [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Same attachments
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> compact-t-patch.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- t/v4-compact.t	2008-12-02 12:54:12.000000000 -0800
+++ t/v4-compact-new.t	2011-05-17 12:35:14.000000000 -0700
@@ -18,44 +18,93 @@
     exit 0;
 }
 
-print &#34;1..2\n&#34;;
+print &#34;1..9\n&#34;;
 
-my @ips;
+my @ips1;
 
 for my $ip &#40;&#39;10.0.0.0&#39;, &#39;11.0.0.0&#39;, &#39;12.0.0.0&#39;&#41; {
-    push @ips, NetAddr::IP-&gt;new&#40;$ip, 24&#41;-&gt;split&#40;32&#41;;
+    push @ips1, NetAddr::IP-&gt;new&#40;$ip, 24&#41;-&gt;split&#40;32&#41;;
 }
 
 for my $ip &#40;&#39;20.0.0.0&#39;, &#39;30.0.0.0&#39;, &#39;40.0.0.0&#39;&#41; {
-    push @ips, NetAddr::IP-&gt;new&#40;$ip, 16&#41;-&gt;split&#40;28&#41;;
+    push @ips1, NetAddr::IP-&gt;new&#40;$ip, 16&#41;-&gt;split&#40;28&#41;;
 }
 
-my @c = Compact&#40;@ips&#41;;
-my @m;
+my @ips2;
 
-for my $c &#40;@c&#41; {
-    push @m, grep { $c-&gt;addr eq $_-&gt;[0] and $c-&gt;mask eq $_-&gt;[1] } @r;
+for my $num &#40;0 .. 255&#41; {
+    push @ips2, NetAddr::IP-&gt;new&#40;&#34;192.168.$num.0&#34;, 24&#41;;
 }
+my $ips2_compact = &#39;192.168.0.0/16&#39;;
 
-if &#40;@m == @c&#41; {
-    print &#34;ok 1\n&#34;;
-}
-else {
-    print &#34;not ok 1\n&#34;;
-}
+# Compact&#40;@&#41;
+#
+compact_ips1_check&#40;1, Compact&#40;@ips1&#41;&#41;;
+compact_ips2_check&#40;2, Compact&#40;@ips2&#41;&#41;;
+
+# -&gt;compact&#40;@&#41;
+#
+compact_ips1_check&#40;3, $ips1[0]-&gt;compact&#40;@ips1[1..$#ips1]&#41;&#41;;
+compact_ips2_check&#40;4, $ips2[0]-&gt;compact&#40;@ips2[1..$#ips2]&#41;&#41;;
+
+# Compact&#40;[]&#41;
+#
+compact_ips1_check&#40;5, @{Compact&#40;\@ips1&#41;}&#41;;
+compact_ips2_check&#40;6, @{Compact&#40;\@ips2&#41;}&#41;;
+
+# -&gt;compactref&#40;[]&#41;
+#
+compact_ips1_check&#40;7, @{$ips1[0]-&gt;compactref&#40;[@ips1[1..$#ips1]]&#41;}&#41;;
+compact_ips2_check&#40;8, @{$ips2[0]-&gt;compactref&#40;[@ips2[1..$#ips2]]&#41;}&#41;;
 
-@ips = &#40;&#41;;
+# duplicate IP
+#
+@ips1 = &#40;&#41;;
 
 for my $ip &#40;qw&#40;1.1.1.1 1.1.1.1 1.1.1.1 1.1.1.1&#41;&#41; {
-    push&#40;@ips, NetAddr::IP-&gt;new&#40;$ip&#41;&#41;;
+    push&#40;@ips1, NetAddr::IP-&gt;new&#40;$ip&#41;&#41;;
 }
 
-@c = NetAddr::IP::compact&#40;@ips&#41;;
+@c = NetAddr::IP::compact&#40;@ips1&#41;;
 
 if &#40;@c == 1 and $c[0]-&gt;cidr&#40;&#41; eq &#39;1.1.1.1/32&#39;&#41; {
-    print &#34;ok 2\n&#34;;
+    print &#34;ok 9\n&#34;;
 }
 else {
-    print &#34;not ok 2\n&#34;;
+    print &#34;not ok 9\n&#34;;
 }
 
+
+######################################################################
+sub compact_ips1_check
+{
+    my $num = shift;
+    my @ips = shift;
+
+    my @mips;
+    for my $ip &#40;@ips&#41; {
+        push @mips, grep { $ip-&gt;addr eq $_-&gt;[0] and $ip-&gt;mask eq $_-&gt;[1] } @r;
+    }
+
+    if &#40;@mips == @ips&#41; {
+        print &#34;ok $num\n&#34;;
+    }
+    else {
+        print &#34;not ok $num\n&#34;;
+    }
+}
+
+
+######################################################################
+sub compact_ips2_check
+{
+    my $num = shift;
+    my @ips = shift;
+
+    if &#40;@ips == 1 and $ips[0] eq $ips2_compact&#41; {
+        print &#34;ok $num\n&#34;;
+    }
+    else {
+        print &#34;not ok $num\n&#34;;
+    }
+}
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> compact-patch.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- IP.pm	2011-04-06 11:31:14.000000000 -0700
+++ IP-new.pm	2011-05-17 12:34:21.000000000 -0700
@@ -390,7 +390,10 @@
 }
 
 sub compact {
-    return @{compactref&#40;\@_&#41;};
+    return compactref&#40;$_[0]&#41;
+        if ref $_[0] eq &#39;ARRAY&#39;; # Compact&#40;\@list&#41;
+
+    return @{compactref&#40;\@_&#41;};   # Compact&#40;@list&#41;  or -&gt;compact&#40;@list&#41;
 }
 
 *Compact = \&#38;compact;
@@ -1084,7 +1087,9 @@
 
 =item C&lt;$me-E&lt;gt&gt;compactref&#40;\@list&#41;&gt;
 
-As usual, a faster version of =item C&lt;-E&lt;gt&gt;compact&#40;&#41;&gt; that returns a
+=item C&lt;$compacted_object_list = Compact&#40;\@list&#41;&gt;
+
+As usual, a faster version of C&lt;-E&lt;gt&gt;compact&#40;&#41;&gt; that returns a
 reference to a list. Note that this method takes a reference to a list
 instead.
 
@@ -1097,39 +1102,57 @@
 #	or return [];
 #  return [] unless @r;
 
-  return [] unless &#40;my @unr = @{$_[0]}&#41;;
+  my @r;
+  {
+    my $unr  = [];
+    my $args = $_[0];
+
+    if &#40;ref $_[0] eq __PACKAGE__ and ref $_[1] eq &#39;ARRAY&#39;&#41; {
+      # -&gt;compactref&#40;\@list&#41;
+      #
+      $unr = [$_[0], @{$_[1]}]; # keeping structures intact
+    }
+    else {
+      # Compact&#40;@list&#41; or -&gt;compact&#40;@list&#41; or Compact&#40;\@list&#41;
+      #
+      $unr = $args;
+    }
+
+    return [] unless @$unr;
 
-  foreach&#40;0..$#unr&#41; {
-    $unr[$_]-&gt;{addr} = $unr[$_]-&gt;network-&gt;{addr};
+    for &#40;@$unr&#41; {
+      $_-&gt;{addr} = $_-&gt;network-&gt;{addr};
+    }
+
+    @r = sort @$unr;
   }
-  my @r = sort @unr;
 
   my $changed;
   do {
-	$changed = 0;
-	for&#40;my $i=0; $i &lt;= $#r -1;$i++&#41; {
-	  if &#40;$r[$i]-&gt;contains&#40;$r[$i +1]&#41;&#41; {
-	    splice&#40;@r,$i +1,1&#41;;
-	    ++$changed;
-	    --$i;
-	  }
-	  elsif &#40;&#40;notcontiguous&#40;$r[$i]-&gt;{mask}&#41;&#41;[1] == &#40;notcontiguous&#40;$r[$i +1]-&gt;{mask}&#41;&#41;[1]&#41; {		# masks the same
-	    if &#40;hasbits&#40;$r[$i]-&gt;network-&gt;{addr} ^ $r[$i +1]-&gt;network-&gt;{addr}&#41;&#41; {	# if not the same netblock
-	      my $upnet = $r[$i]-&gt;copy;
-	      $upnet-&gt;{mask} = shiftleft&#40;$upnet-&gt;{mask},1&#41;;
-	      if &#40;$upnet-&gt;contains&#40;$r[$i +1]&#41;&#41; {					# adjacent nets in next net up
-		$r[$i] = $upnet;
-		splice&#40;@r,$i +1,1&#41;;
-		++$changed;
-		--$i;
-	      }
-	    } else {									# identical nets
-	      splice&#40;@r,$i +1,1&#41;;
-	      ++$changed;
-	      --$i;
-	    }
-	  }
-	}
+    $changed = 0;
+    for&#40;my $i=0; $i &lt;= $#r -1;$i++&#41; {
+      if &#40;$r[$i]-&gt;contains&#40;$r[$i +1]&#41;&#41; {
+        splice&#40;@r,$i +1,1&#41;;
+        ++$changed;
+        --$i;
+      }
+      elsif &#40;&#40;notcontiguous&#40;$r[$i]-&gt;{mask}&#41;&#41;[1] == &#40;notcontiguous&#40;$r[$i +1]-&gt;{mask}&#41;&#41;[1]&#41; {		# masks the same
+        if &#40;hasbits&#40;$r[$i]-&gt;{addr} ^ $r[$i +1]-&gt;{addr}&#41;&#41; {	# if not the same netblock
+          my $upnet = $r[$i]-&gt;copy;
+          $upnet-&gt;{mask} = shiftleft&#40;$upnet-&gt;{mask},1&#41;;
+          if &#40;$upnet-&gt;contains&#40;$r[$i +1]&#41;&#41; {					# adjacent nets in next net up
+      $r[$i] = $upnet;
+      splice&#40;@r,$i +1,1&#41;;
+      ++$changed;
+      --$i;
+          }
+        } else {									# identical nets
+          splice&#40;@r,$i +1,1&#41;;
+          ++$changed;
+          --$i;
+        }
+      }
+    }
   } while $changed;
   return \@r;
 }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;17&nbsp;16:08:38&nbsp;2011</span>
    <span class="description">codebard [...] gmail.com -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;01:41:20&nbsp;2011</span>
    <span class="description">codebard [...] gmail.com -  Status changed from &#39;open&#39; to &#39;new&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;14:18:40&nbsp;2011</span>
    <span class="description">michael [...] insulin-pumpers.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #68273] Problem with -&gt;compactref </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 May 2011 11:18:35 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-NetAddr-IP [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> michael [...] insulin-pumpers.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Tue May 17 16:04:48 2011: Request 68273 was acted upon.
&gt; Transaction: Ticket created by RBOUR
&gt;        Queue: NetAddr-IP
&gt;      Subject: Problem with -&gt;compactref
&gt;    Broken in: 4.043
&gt;     Severity: Normal
&gt;        Owner: Nobody
&gt;   Requestors: codebard@gmail.com
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=68273">https://rt.cpan.org/Ticket/Display.html?id=68273</a></span> &gt;
&gt; 
&gt; 
</div>
Hi Rusty,

In the patch:

-           if &#40;hasbits&#40;$r[$i]-&gt;network-&gt;{addr} ^ 
        $r[$i +1]-&gt;network-&gt;{addr}&#41;&#41; {  # if not the same netblock


+        if &#40;hasbits&#40;$r[$i]-&gt;{addr} ^ 
        $r[$i +1]-&gt;{addr}&#41;&#41; {   # if not the same netblock

you made a change from comparing the network address to comparing IP 
addresses I would expect this to fail the test every time for 
adjacent addresses, even in the same netblock.

I don&#39;t think this is appropriate, please let me know your thinking 
here.

Best regards,
Michael
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;14:18:41&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;16:14:14&nbsp;2011</span>
    <span class="description">codebard [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Michael,

I might have missed something there.  The objects going into the 
previous sort &#40;and out to @r&#41; are each assigned $_-&gt;{addr} = $_-
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;network-&gt;{addr} .  My thought was that if the objects are the same 
</div>coming out of the sort going into @r, then the fragments &#34;$r[$i]-
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;network-&gt;{addr} ^ $r[$i +1]-&gt;network-&gt;{addr}&#34; and &#34;$r[$i]-&gt;{addr} ^ 
</div>$r[$i +1]-&gt;{addr}&#34; would be equivalent.  It didn&#39;t appear to me that 
$r[$i]-&gt;{addr} needed to change, and the omission of the extra call 
would yield a bit of a speed increase.

If it is correct to squash the object-&gt;{addr} with object-&gt;network-&gt;
{addr} during compaction, then the omission seems ok to me since the the 
algorithm appears to splice out unneeded IP blocks and then shifting the 
masks.

The changes that I&#39;ve made pass the existing tests and the one I added.  
Perhaps there is an additional test that should be added?

Thanks.

Rusty
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;17:57:35&nbsp;2011</span>
    <span class="description">michael [...] insulin-pumpers.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #68273] Problem with -&gt;compactref </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 May 2011 14:57:30 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-NetAddr-IP [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> michael [...] insulin-pumpers.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: NetAddr-IP
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=68273">https://rt.cpan.org/Ticket/Display.html?id=68273</a></span> &gt;
&gt; 
&gt; Hi Michael,
&gt; 
&gt; I might have missed something there.  The objects going into the
&gt; previous sort &#40;and out to @r&#41; are each assigned $_-&gt;{addr} = $_-
<div class="message-stanza open">&gt; &gt;network-&gt;{addr} .  
</div></div>
Nope, I missed it. All along the code fragment you changed has been 
redundant. Good catch! Thanks.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; My thought was that if the objects are the same
&gt; coming out of the sort going into @r, then the fragments &#34;$r[$i]-
<div class="message-stanza open">&gt; &gt;network-&gt;{addr} ^ $r[$i +1]-&gt;network-&gt;{addr}&#34; and &#34;$r[$i]-&gt;{addr} ^
</div>&gt; $r[$i +1]-&gt;{addr}&#34; would be equivalent.  It didn&#39;t appear to me that
&gt; $r[$i]-&gt;{addr} needed to change, and the omission of the extra call
&gt; would yield a bit of a speed increase.
&gt; 
&gt; If it is correct to squash the object-&gt;{addr} with object-&gt;network-&gt;
&gt; {addr} during compaction, then the omission seems ok to me since the
&gt; the algorithm appears to splice out unneeded IP blocks and then
&gt; shifting the masks.
&gt; 
&gt; The changes that I&#39;ve made pass the existing tests and the one I
&gt; added.  Perhaps there is an additional test that should be added?
&gt; 
&gt; Thanks.
&gt; 
&gt; Rusty
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;18:06:11&nbsp;2011</span>
    <span class="description">michael [...] bizsystems.com -  Correspondence added</span>
    <span class="time-taken">60 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">NetAddr::IP v4.044 uploaded to CPAN


On Wed May 18 17:57:35 2011, michael@insulin-pumpers.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt;        Queue: NetAddr-IP
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=68273">https://rt.cpan.org/Ticket/Display.html?id=68273</a></span> &gt;
&gt; &gt; 
&gt; &gt; Hi Michael,
&gt; &gt; 
&gt; &gt; I might have missed something there.  The objects going into the
&gt; &gt; previous sort &#40;and out to @r&#41; are each assigned $_-&gt;{addr} = $_-
<div class="message-stanza open">&gt; &gt; &gt;network-&gt;{addr} .  
</div></div>&gt; 
&gt; Nope, I missed it. All along the code fragment you changed has been 
&gt; redundant. Good catch! Thanks.
&gt; 
<div class="message-stanza open">&gt; &gt; My thought was that if the objects are the same
&gt; &gt; coming out of the sort going into @r, then the fragments &#34;$r[$i]-
<div class="message-stanza open">&gt; &gt; &gt;network-&gt;{addr} ^ $r[$i +1]-&gt;network-&gt;{addr}&#34; and &#34;$r[$i]-&gt;{addr} ^
</div>&gt; &gt; $r[$i +1]-&gt;{addr}&#34; would be equivalent.  It didn&#39;t appear to me that
&gt; &gt; $r[$i]-&gt;{addr} needed to change, and the omission of the extra call
&gt; &gt; would yield a bit of a speed increase.
&gt; &gt; 
&gt; &gt; If it is correct to squash the object-&gt;{addr} with object-&gt;network-&gt;
&gt; &gt; {addr} during compaction, then the omission seems ok to me since the
&gt; &gt; the algorithm appears to splice out unneeded IP blocks and then
&gt; &gt; shifting the masks.
&gt; &gt; 
&gt; &gt; The changes that I&#39;ve made pass the existing tests and the one I
&gt; &gt; added.  Perhaps there is an additional test that should be added?
&gt; &gt; 
&gt; &gt; Thanks.
&gt; &gt; 
&gt; &gt; Rusty
</div>&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;18:06:12&nbsp;2011</span>
    <span class="description">michael [...] bizsystems.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;18:06:13&nbsp;2011</span>
    <span class="description">michael [...] bizsystems.com -  Given to MIKER</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
