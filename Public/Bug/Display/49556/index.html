<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #49556 for DBD-mysql: Foreign_key_info very slow for a large database</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #49556 for DBD-mysql: Foreign_key_info very slow for a large database</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-mysql/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-mysql">DBD-mysql CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">49556</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-mysql/Active/">DBD-mysql</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
gq1 [...] sanger.ac.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10170-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10171-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;09&nbsp;09:05:46&nbsp;2009</span>
    <span class="description">gq1 [...] sanger.ac.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Foreign_key_info very slow for a large database</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 09 Sep 2009 14:05:03 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBD-mysql &#34; [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Guoying Qi &lt;gq1 [...] sanger.ac.uk&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, there.

I am using Fey::ORM to create table classes from MySQL&#40;V5.067&#41;. 
Fey::Loader needs read all the database schema out &#40;get columns, primary 
and foreign keys&#41; and create classes for each table. I have 41 tables in 
this schema.

This works fine against our test database  without  much data inside.

But when I run it against our live database &#40;100G data in total&#41; it 
becomes very slow. This is caused by calling foreign_key_info for each 
table. Each query takes around 15 seconds.

The query DBD::mysql generated for one table is listed below.  I am not 
sure why this query takes so long against the database with large data 
but very quick against the database with less data.  I am not sure this 
is the problem from MySQL or there is other simple way to get foreign 
key information.

If you can give me any suggestion, I will really appreciate it.

Thank you very much!

Guoying Qi




SELECT NULL AS PKTABLE_CAT,
       A.REFERENCED_TABLE_SCHEMA AS PKTABLE_SCHEM,
       A.REFERENCED_TABLE_NAME AS PKTABLE_NAME,
       A.REFERENCED_COLUMN_NAME AS PKCOLUMN_NAME,
       A.TABLE_CATALOG AS FKTABLE_CAT,
       A.TABLE_SCHEMA AS FKTABLE_SCHEM,
       A.TABLE_NAME AS FKTABLE_NAME,
       A.COLUMN_NAME AS FKCOLUMN_NAME,
       A.ORDINAL_POSITION AS KEY_SEQ,
       NULL AS UPDATE_RULE,
       NULL AS DELETE_RULE,
       A.CONSTRAINT_NAME AS FK_NAME,
       NULL AS PK_NAME,
       NULL AS DEFERABILITY,
       NULL AS UNIQUE_OR_PRIMARY
  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE A,
       INFORMATION_SCHEMA.TABLE_CONSTRAINTS B
 WHERE A.TABLE_SCHEMA = B.TABLE_SCHEMA AND A.TABLE_NAME = B.TABLE_NAME
   AND A.CONSTRAINT_NAME = B.CONSTRAINT_NAME AND B.CONSTRAINT_TYPE IS 
NOT NULL
 AND A.REFERENCED_TABLE_SCHEMA = &#39;npgqcp&#39; AND A.REFERENCED_TABLE_NAME = 
&#39;lane_qc&#39; ORDER BY A.TABLE_SCHEMA, A.TABLE_NAME, A.ORDINAL_POSITION


-- 
 The Wellcome Trust Sanger Institute is operated by Genome Research 
 Limited, a charity registered in England with number 1021457 and a 
 company registered in England with number 2742969, whose registered 
 office is 215 Euston Road, London, NW1 2BE. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;09&nbsp;09:09:29&nbsp;2009</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Guoying Qi,

I&#39;m not sure why it would be slow, but I&#39;m thinking that perhaps
obtaining this information from information schema might be a better
way. The only issue with this is that I would have to modify the driver
to discern whether the server is less than or greater than or equal to
version 5.0.

Thank you!

Patrick


On Wed Sep 09 09:05:46 2009, gq1@sanger.ac.uk wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, there.
&gt; 
&gt; I am using Fey::ORM to create table classes from MySQL&#40;V5.067&#41;. 
&gt; Fey::Loader needs read all the database schema out &#40;get columns, primary 
&gt; and foreign keys&#41; and create classes for each table. I have 41 tables in 
&gt; this schema.
&gt; 
&gt; This works fine against our test database  without  much data inside.
&gt; 
&gt; But when I run it against our live database &#40;100G data in total&#41; it 
&gt; becomes very slow. This is caused by calling foreign_key_info for each 
&gt; table. Each query takes around 15 seconds.
&gt; 
&gt; The query DBD::mysql generated for one table is listed below.  I am not 
&gt; sure why this query takes so long against the database with large data 
&gt; but very quick against the database with less data.  I am not sure this 
&gt; is the problem from MySQL or there is other simple way to get foreign 
&gt; key information.
&gt; 
&gt; If you can give me any suggestion, I will really appreciate it.
&gt; 
&gt; Thank you very much!
&gt; 
&gt; Guoying Qi
&gt; 
&gt; 
&gt; 
&gt; 
&gt; SELECT NULL AS PKTABLE_CAT,
&gt;        A.REFERENCED_TABLE_SCHEMA AS PKTABLE_SCHEM,
&gt;        A.REFERENCED_TABLE_NAME AS PKTABLE_NAME,
&gt;        A.REFERENCED_COLUMN_NAME AS PKCOLUMN_NAME,
&gt;        A.TABLE_CATALOG AS FKTABLE_CAT,
&gt;        A.TABLE_SCHEMA AS FKTABLE_SCHEM,
&gt;        A.TABLE_NAME AS FKTABLE_NAME,
&gt;        A.COLUMN_NAME AS FKCOLUMN_NAME,
&gt;        A.ORDINAL_POSITION AS KEY_SEQ,
&gt;        NULL AS UPDATE_RULE,
&gt;        NULL AS DELETE_RULE,
&gt;        A.CONSTRAINT_NAME AS FK_NAME,
&gt;        NULL AS PK_NAME,
&gt;        NULL AS DEFERABILITY,
&gt;        NULL AS UNIQUE_OR_PRIMARY
&gt;   FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE A,
&gt;        INFORMATION_SCHEMA.TABLE_CONSTRAINTS B
&gt;  WHERE A.TABLE_SCHEMA = B.TABLE_SCHEMA AND A.TABLE_NAME = B.TABLE_NAME
&gt;    AND A.CONSTRAINT_NAME = B.CONSTRAINT_NAME AND B.CONSTRAINT_TYPE IS 
&gt; NOT NULL
&gt;  AND A.REFERENCED_TABLE_SCHEMA = &#39;npgqcp&#39; AND A.REFERENCED_TABLE_NAME = 
&gt; &#39;lane_qc&#39; ORDER BY A.TABLE_SCHEMA, A.TABLE_NAME, A.ORDINAL_POSITION
&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;09&nbsp;09:09:29&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;09&nbsp;09:43:37&nbsp;2009</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">To be clear, I mean use information_schema for &#34;foreign_key_info&#34;. I&#39;ll
have to look at the code.

Any chance you could give me a data dump and test code, or is this
proprietary?

On Wed Sep 09 09:09:29 2009, CAPTTOFU wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Guoying Qi,
&gt; 
&gt; I&#39;m not sure why it would be slow, but I&#39;m thinking that perhaps
&gt; obtaining this information from information schema might be a better
&gt; way. The only issue with this is that I would have to modify the driver
&gt; to discern whether the server is less than or greater than or equal to
&gt; version 5.0.
&gt; 
&gt; Thank you!
&gt; 
&gt; Patrick
&gt; 
&gt; 
&gt; On Wed Sep 09 09:05:46 2009, gq1@sanger.ac.uk wrote:
<div class="message-stanza open">&gt; &gt; Hi, there.
&gt; &gt; 
&gt; &gt; I am using Fey::ORM to create table classes from MySQL&#40;V5.067&#41;. 
&gt; &gt; Fey::Loader needs read all the database schema out &#40;get columns,
</div></div>primary 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; and foreign keys&#41; and create classes for each table. I have 41
</div></div>tables in 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; this schema.
&gt; &gt; 
&gt; &gt; This works fine against our test database  without  much data inside.
&gt; &gt; 
&gt; &gt; But when I run it against our live database &#40;100G data in total&#41; it 
&gt; &gt; becomes very slow. This is caused by calling foreign_key_info for each 
&gt; &gt; table. Each query takes around 15 seconds.
&gt; &gt; 
&gt; &gt; The query DBD::mysql generated for one table is listed below.  I am not 
&gt; &gt; sure why this query takes so long against the database with large data 
&gt; &gt; but very quick against the database with less data.  I am not sure this 
&gt; &gt; is the problem from MySQL or there is other simple way to get foreign 
&gt; &gt; key information.
&gt; &gt; 
&gt; &gt; If you can give me any suggestion, I will really appreciate it.
&gt; &gt; 
&gt; &gt; Thank you very much!
&gt; &gt; 
&gt; &gt; Guoying Qi
&gt; &gt; 
&gt; &gt; 
&gt; &gt; 
&gt; &gt; 
&gt; &gt; SELECT NULL AS PKTABLE_CAT,
&gt; &gt;        A.REFERENCED_TABLE_SCHEMA AS PKTABLE_SCHEM,
&gt; &gt;        A.REFERENCED_TABLE_NAME AS PKTABLE_NAME,
&gt; &gt;        A.REFERENCED_COLUMN_NAME AS PKCOLUMN_NAME,
&gt; &gt;        A.TABLE_CATALOG AS FKTABLE_CAT,
&gt; &gt;        A.TABLE_SCHEMA AS FKTABLE_SCHEM,
&gt; &gt;        A.TABLE_NAME AS FKTABLE_NAME,
&gt; &gt;        A.COLUMN_NAME AS FKCOLUMN_NAME,
&gt; &gt;        A.ORDINAL_POSITION AS KEY_SEQ,
&gt; &gt;        NULL AS UPDATE_RULE,
&gt; &gt;        NULL AS DELETE_RULE,
&gt; &gt;        A.CONSTRAINT_NAME AS FK_NAME,
&gt; &gt;        NULL AS PK_NAME,
&gt; &gt;        NULL AS DEFERABILITY,
&gt; &gt;        NULL AS UNIQUE_OR_PRIMARY
&gt; &gt;   FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE A,
&gt; &gt;        INFORMATION_SCHEMA.TABLE_CONSTRAINTS B
&gt; &gt;  WHERE A.TABLE_SCHEMA = B.TABLE_SCHEMA AND A.TABLE_NAME = B.TABLE_NAME
&gt; &gt;    AND A.CONSTRAINT_NAME = B.CONSTRAINT_NAME AND B.CONSTRAINT_TYPE IS 
&gt; &gt; NOT NULL
&gt; &gt;  AND A.REFERENCED_TABLE_SCHEMA = &#39;npgqcp&#39; AND A.REFERENCED_TABLE_NAME = 
&gt; &gt; &#39;lane_qc&#39; ORDER BY A.TABLE_SCHEMA, A.TABLE_NAME, A.ORDINAL_POSITION
&gt; &gt; 
&gt; &gt; 
</div>&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;09&nbsp;10:07:57&nbsp;2009</span>
    <span class="description">gq1 [...] sanger.ac.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #49556] Foreign_key_info very slow for a large database</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 09 Sep 2009 15:07:35 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-mysql [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Guoying Qi &lt;gq1 [...] sanger.ac.uk&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I could give you our database schema but no problems to call 
foreign_key_info with small amount of data.

Our live database is currently around 100G. I don&#39;t think you want this.

When you have your new code, I could run my scripts to test it for you.

Thanks.

Patrick Galbraith via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=49556">https://rt.cpan.org/Ticket/Display.html?id=49556</a></span> &gt;
&gt;
&gt; To be clear, I mean use information_schema for &#34;foreign_key_info&#34;. I&#39;ll
&gt; have to look at the code.
&gt;
&gt; Any chance you could give me a data dump and test code, or is this
&gt; proprietary?
&gt;
&gt; On Wed Sep 09 09:09:29 2009, CAPTTOFU wrote:
&gt;   
<div class="message-stanza open">&gt;&gt; Guoying Qi,
&gt;&gt;
&gt;&gt; I&#39;m not sure why it would be slow, but I&#39;m thinking that perhaps
&gt;&gt; obtaining this information from information schema might be a better
&gt;&gt; way. The only issue with this is that I would have to modify the driver
&gt;&gt; to discern whether the server is less than or greater than or equal to
&gt;&gt; version 5.0.
&gt;&gt;
&gt;&gt; Thank you!
&gt;&gt;
&gt;&gt; Patrick
&gt;&gt;
&gt;&gt;
&gt;&gt; On Wed Sep 09 09:05:46 2009, gq1@sanger.ac.uk wrote:
&gt;&gt;     
<div class="message-stanza open">&gt;&gt;&gt; Hi, there.
&gt;&gt;&gt;
&gt;&gt;&gt; I am using Fey::ORM to create table classes from MySQL&#40;V5.067&#41;. 
&gt;&gt;&gt; Fey::Loader needs read all the database schema out &#40;get columns,
&gt;&gt;&gt;       
</div></div>&gt; primary 
&gt;   
<div class="message-stanza open"><div class="message-stanza open">&gt;&gt;&gt; and foreign keys&#41; and create classes for each table. I have 41
&gt;&gt;&gt;       
</div></div>&gt; tables in 
&gt;   
<div class="message-stanza open"><div class="message-stanza open">&gt;&gt;&gt; this schema.
&gt;&gt;&gt;
&gt;&gt;&gt; This works fine against our test database  without  much data inside.
&gt;&gt;&gt;
&gt;&gt;&gt; But when I run it against our live database &#40;100G data in total&#41; it 
&gt;&gt;&gt; becomes very slow. This is caused by calling foreign_key_info for each 
&gt;&gt;&gt; table. Each query takes around 15 seconds.
&gt;&gt;&gt;
&gt;&gt;&gt; The query DBD::mysql generated for one table is listed below.  I am not 
&gt;&gt;&gt; sure why this query takes so long against the database with large data 
&gt;&gt;&gt; but very quick against the database with less data.  I am not sure this 
&gt;&gt;&gt; is the problem from MySQL or there is other simple way to get foreign 
&gt;&gt;&gt; key information.
&gt;&gt;&gt;
&gt;&gt;&gt; If you can give me any suggestion, I will really appreciate it.
&gt;&gt;&gt;
&gt;&gt;&gt; Thank you very much!
&gt;&gt;&gt;
&gt;&gt;&gt; Guoying Qi
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; SELECT NULL AS PKTABLE_CAT,
&gt;&gt;&gt;        A.REFERENCED_TABLE_SCHEMA AS PKTABLE_SCHEM,
&gt;&gt;&gt;        A.REFERENCED_TABLE_NAME AS PKTABLE_NAME,
&gt;&gt;&gt;        A.REFERENCED_COLUMN_NAME AS PKCOLUMN_NAME,
&gt;&gt;&gt;        A.TABLE_CATALOG AS FKTABLE_CAT,
&gt;&gt;&gt;        A.TABLE_SCHEMA AS FKTABLE_SCHEM,
&gt;&gt;&gt;        A.TABLE_NAME AS FKTABLE_NAME,
&gt;&gt;&gt;        A.COLUMN_NAME AS FKCOLUMN_NAME,
&gt;&gt;&gt;        A.ORDINAL_POSITION AS KEY_SEQ,
&gt;&gt;&gt;        NULL AS UPDATE_RULE,
&gt;&gt;&gt;        NULL AS DELETE_RULE,
&gt;&gt;&gt;        A.CONSTRAINT_NAME AS FK_NAME,
&gt;&gt;&gt;        NULL AS PK_NAME,
&gt;&gt;&gt;        NULL AS DEFERABILITY,
&gt;&gt;&gt;        NULL AS UNIQUE_OR_PRIMARY
&gt;&gt;&gt;   FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE A,
&gt;&gt;&gt;        INFORMATION_SCHEMA.TABLE_CONSTRAINTS B
&gt;&gt;&gt;  WHERE A.TABLE_SCHEMA = B.TABLE_SCHEMA AND A.TABLE_NAME = B.TABLE_NAME
&gt;&gt;&gt;    AND A.CONSTRAINT_NAME = B.CONSTRAINT_NAME AND B.CONSTRAINT_TYPE IS 
&gt;&gt;&gt; NOT NULL
&gt;&gt;&gt;  AND A.REFERENCED_TABLE_SCHEMA = &#39;npgqcp&#39; AND A.REFERENCED_TABLE_NAME = 
&gt;&gt;&gt; &#39;lane_qc&#39; ORDER BY A.TABLE_SCHEMA, A.TABLE_NAME, A.ORDINAL_POSITION
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;       
</div>&gt;&gt;     
</div>&gt;
&gt;
&gt;
&gt;   
</div>

-- 
 The Wellcome Trust Sanger Institute is operated by Genome Research 
 Limited, a charity registered in England with number 1021457 and a 
 company registered in England with number 2742969, whose registered 
 office is 215 Euston Road, London, NW1 2BE. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;27&nbsp;11:33:29&nbsp;2009</span>
    <span class="description">gq1 [...] sanger.ac.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #49556] Foreign_key_info very slow for a large database</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 27 Nov 2009 16:33:04 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-mysql [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Guoying Qi &lt;gq1 [...] sanger.ac.uk&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;01&nbsp;10:06:29&nbsp;2009</span>
    <span class="description">FHOXH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I just wanted to chime in here as well and note that I am also adversely
affected by the same behavior and came to the same conclusion in
tracking the performance issue down to foreign_key_info&#40;&#41;.

In my situation, some of these resulting queries are taking over ten
minutes each. I&#39;d be grateful for anything that could be done to improve
the performance and would be happy to test any potential fix against my
local environment.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;04&nbsp;09:57:42&nbsp;2009</span>
    <span class="description">FHOXH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This appears to be a known issue with MySQL 5. For more information,
visit: <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.mysql.com/bug.php?id=19588">http://bugs.mysql.com/bug.php?id=19588</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;04&nbsp;15:15:46&nbsp;2009</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi all, 

sorry I have been swamped writing a book and some family issues. This
bug has nothing to do with the driver. The foreign key info comes from
information schema. If that query that obtains that info is slow, that
is what is slowing the DBI function. One way that could save you some
headache is to use a cron job to updated memcached with that info about
each table and obtain info like this from memcached. It&#39;s not like you
will alter your tables often, so putting this info in a cache is ideal.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;11&nbsp;09:54:31&nbsp;2010</span>
    <span class="description">paddy [...] firedrake.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Bug appears to be related to the way mysql 5.0 walks the .frm files. On
a large database with default settings these will cause a lot of opening
and closing which was fixed in 5.1.23+ but not sure if it was back ported.

The following settings from the example my-innodb-heavy-4G.cnf may help

# The number of open tables for all threads. Increasing this value
# increases the number of file descriptors that mysqld requires.
# Therefore you have to make sure to set the amount of open files
# allowed to at least 4096 in the variable &#34;open-files-limit&#34; in
# section [mysqld_safe]
table_open_cache = 2048

[mysqld_safe]
# Increase the amount of open files allowed per process. Warning: Make
# sure you have set the global system limit high enough! The high value
# is required for a large number of opened tables
open-files-limit = 8192

I am having no problems on 5.1.39-ndb-7.0.9 with 500 tables using
information_schema but not tested on a low spec server.

mysqld  Ver 5.1.39-ndb-7.0.9-cluster-gpl-log for unknown-linux-gnu on
x86_64 &#40;MySQL Cluster Server &#40;GPL&#41;&#41;

Hope it helps

On Fri Dec 04 09:57:42 2009, FHOXH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This appears to be a known issue with MySQL 5. For more information,
&gt; visit: <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.mysql.com/bug.php?id=19588">http://bugs.mysql.com/bug.php?id=19588</a></span>
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;14&nbsp;10:57:49&nbsp;2010</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi all,

I&#39;m closing this bug since it&#39;s not an issue of the driver. Thanks to
all who gave input on the issue. Also, please refer to the last comment
pertaining to MySQL version 5.1.23 and greater by Patrick Mulvany.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;14&nbsp;10:57:51&nbsp;2010</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
