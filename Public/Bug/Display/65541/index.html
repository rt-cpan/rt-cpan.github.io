<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #65541 for Encode: panic: sv_setpvn called with negative strlen</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #65541 for Encode: panic: sv_setpvn called with negative strlen</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Encode/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Encode/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Encode/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Encode/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Encode">Encode CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">65541</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Encode/Active/">Encode</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
xliosha [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
IKEGAMI [...] cpan.org

<br />
pali [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-12062-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.42    </td>
  </tr>
  <tr id="CF-12063-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;07&nbsp;15:29:11&nbsp;2011</span>
    <span class="description">IKEGAMI [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> IKEGAMI [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> panic: sv_setpvn called with negative strlen</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">==== Original request submitted to perlbug follows ====

Hi!

I try to output unicode stream via &#39;:encoding&#40;cp1250&#41;&#39; layer.
Some symbols doesn&#39;t map to this encoding, so i get warnings:

&#34;\x{0456}&#34; does not map to cp1250 at C:\buf\osm\osm2mp.pl line 2637,
&lt;$_[...]&gt; line 2460557.
&#34;\x{043d}&#34; does not map to cp1250 at C:\buf\osm\osm2mp.pl line 2637,
&lt;$_[...]&gt; line 2460557.
&#34;\x{043d}&#34; does not map to cp1250 at C:\buf\osm\osm2mp.pl line 2637,
&lt;$_[...]&gt; line 2460557.
&#34;\x{0438}&#34; does not map to cp1250 at C:\buf\osm\osm2mp.pl line 2637,
&lt;$_[...]&gt; line 2460557.
&#34;\x{0446}&#34; does not map to cp1250 at C:\buf\osm\osm2mp.pl line 2637,
&lt;$_[...]&gt; line 2460557.
and so on.

And _sometimes_ after few such warnings perl crashes with message:

panic: sv_setpvn called with negative strlen at C:\buf\osm\osm2mp.pl
line 2375, &lt;$_[...]&gt; line 4001961.

==== end ====

The problem appears to be in Encode. &#40;Tested with Encode 2.42.&#41;

#0  Perl_sv_setpvn &#40;sv=0x83b6898, ptr=0x83ab901 &#34;\002\002&#34;,
len=4294967295&#41; at sv.c:4454
#1  0xb7755793 in encode_method &#40;enc=0xb727089c, dir=0xb7272c60,
src=0x83b6898, check=&lt;value optimized out&gt;, offset=0x0, term=0x0,
retcode=0x0, fallback_cb=0x831c628&#41; at Encode.xs:266
#2  0xb77562cf in XS_Encode__XS_encode &#40;cv=0x834c408&#41; at Encode.xs:657
#3  0x08138203 in Perl_pp_entersub &#40;&#41; at pp_hot.c:2931
#4  0x080fe127 in Perl_runops_debug &#40;&#41; at dump.c:2267
#5  0x08083288 in Perl_call_sv &#40;sv=0x83b68a8, flags=130&#41; at perl.c:2614
#6  0xb728492b in PerlIOEncode_flush &#40;f=0x832bdd8&#41; at encoding.xs:424
#7  0x082492e3 in PerlIOBuf_write &#40;f=0x832bdd8, vbuf=0x834fc48, count=1&#41;
at perlio.c:4157
#8  0xb72861f3 in PerlIOEncode_write &#40;f=0x832bdd8, vbuf=0x834fc48,
count=2&#41; at encoding.xs:593
#9  0x08211839 in Perl_do_print &#40;sv=0x83b6838, fp=0x832bdd8&#41; at doio.c:1257
#10 0x08145979 in Perl_pp_print &#40;&#41; at pp_hot.c:773
#11 0x080fe127 in Perl_runops_debug &#40;&#41; at dump.c:2267
#12 0x08084b7b in perl_run &#40;my_perl=0x831d008&#41; at perl.c:2332
#13 0x08062f25 in main &#40;argc=3, argv=0xbfffe034, env=0xbfffe044&#41; at
perlmain.c:120

    if &#40;check &#38;&#38; !&#40;check &#38; ENCODE_LEAVE_SRC&#41;&#41;{
    sdone = SvCUR&#40;src&#41; - &#40;slen+sdone&#41;;
    if &#40;sdone&#41; {
        sv_setpvn&#40;src, &#40;char*&#41;s+slen, sdone&#41;;    &lt;----
    }
    SvCUR_set&#40;src, sdone&#41;;
    }

Test case:

binmode STDOUT, &#39;:encoding&#40;cp1250&#41;&#39;;
print map chr,
1146, 627, 46, 891, 583, 542, 507, 1169, 1162, 663, 577, 518, 223, 526,
1016, 885, 1135, 1077, 16, 774, 802, 623, 1164, 235,
1136, 1027, 1, 502, 1222, 132, 1127, 738, 747, 115, 315, 23, 643, 455,
815, 1026, 140, 725, 405, 12, 208, 511, 680, 906,
816, 392, 103, 71, 1039, 926, 1163, 953, 38, 1175, 335, 1032, 950, 865,
992, 59, 575, 1263, 227, 216, 1265, 1036, 1189, 365,
667, 403, 1157, 548, 150, 415, 7, 1142, 621, 630, 668, 691, 435, 176,
1152, 396, 1015, 236, 1202, 296, 997, 1115, 1206, 910,
997, 621, 8, 173, 455, 481, 7, 342, 448, 744, 417, 46, 19, 280, 608,
466, 169, 1271, 195, 574, 1246, 1213, 777, 473, 169,
806, 382, 232, 304, 1088, 473, 612, 1011, 1248, 986, 284, 1149, 427,
353, 1110, 287, 957, 229, 378, 793, 48, 114, 1173, 767,
673, 769, 869, 368, 348, 663, 665, 1007, 1180, 871, 561, 1267, 501, 255,
734, 1194, 117, 317, 69, 525, 378, 391, 753, 128,
672, 772, 675, 250, 389, 153, 1245, 1141, 419, 1214, 581, 109, 371,
1000, 1241, 1106, 552, 163, 262, 511, 141, 240, 501,
705, 612, 1256, 432, 4, 28, 959, 381, 196, 567, 134, 722, 4, 40, 360,
603, 359, 518, 979, 189, 316, 1054, 1035, 161, 850,
343, 43, 487, 210, 275, 643, 707, 514, 826, 1213, 1123, 773, 1130, 322,
679, 203, 721, 837, 997, 140, 563, 803, 255, 890,
163, 48, 786, 637, 1048, 110, 942, 309, 1015, 398, 603, 903, 387, 449,
814, 700, 544, 477, 436, 794, 631, 1014, 774, 1104,
1164, 703, 1278, 1267, 1216, 678, 88, 932, 861, 629, 669, 772, 314, 880,
128, 263, 130, 739, 799, 790, 871, 1200, 151, 131,
677, 237, 363, 377, 1276, 1275, 69, 1067, 165, 710, 1011, 560, 1239,
316, 1061, 970, 1043, 1035, 241, 634, 1157, 5, 1091,
332, 1252, 1106, 381, 837, 942, 328, 1268, 452, 892, 796, 1183, 282,
666, 1151, 1123, 402, 1109, 1023, 804, 344, 1214, 722,
928, 870, 721, 308, 536, 1048, 820, 217, 1028, 1252, 1054, 438, 66, 999,
1056, 275, 742, 931, 1213, 608, 224, 697, 358, 855,
132, 705, 477, 1222, 570, 424, 324, 28, 759, 963, 193, 150, 1098, 513,
607, 901, 449, 411, 75, 725, 1247, 982, 274, 752, 63,
179, 545, 617, 544, 436, 1086, 1001, 224, 149, 1054, 225, 66, 402, 364,
288, 1156, 76, 1105, 950, 421, 203, 172, 1091, 1230,
498, 632, 954, 296, 1067, 690, 391, 126, 251, 445, 466, 740, 843, 116,
216, 827, 924, 1113, 406, 1211, 1094, 522, 940, 304,
100, 286, 249, 888, 1175, 652, 184, 267, 1168, 231, 668, 323, 1087, 404,
736, 450, 969, 693, 4, 1082, 959, 321, 1017, 892,
16, 1162, 1166, 1271, 578, 209, 48, 913, 1116, 25, 661, 901, 854, 643,
827, 1142, 1261, 289, 998, 45, 743, 1245, 421, 1204,
472, 117, 345, 1013, 1239, 895, 278, 1235, 1097, 730, 539, 628, 863,
327, 137, 1083, 490, 871, 1021, 468, 938, 1022, 553,
903, 677, 109, 1239, 115, 627, 1188, 656, 986, 79, 730, 1270, 168, 1089,
1086, 759, 247, 794, 1210, 340, 138, 226, 1069, 46,
454, 447, 643, 840, 382, 493, 58, 968, 1263, 6, 1058, 567, 647, 747,
252, 888
;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;07&nbsp;15:47:45&nbsp;2011</span>
    <span class="description">IKEGAMI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Simpler test case:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">----- BEGIN TEST CODE -----
binmode STDOUT, &#39;:encoding&#40;cp1250&#41;&#39;;
print&#40; &#40; &#34;a&#34; x 1023 &#41; . &#34;\x{0378}&#34; &#41;;
----- END TEST CODE -----

<div class="message-stanza open">----- BEGIN TEST OUTPUT -----
&#34;\x{0340}&#34; does not map to cp1250 at a.pl line 2.
panic: sv_setpvn called with negative strlen at a.pl line 2.
----- END TEST OUTPUT -----

Note that the problem occurs at the 1K mark.

Note that the warning identifies &#34;\x{0340}&#34; even though there is no such
character in the string.
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;07&nbsp;15:47:46&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;21&nbsp;06:43:45&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Feb 07 15:47:45 2011, ikegami wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Simpler test case:
&gt; 
&gt; ----- BEGIN TEST CODE -----
&gt; binmode STDOUT, &#39;:encoding&#40;cp1250&#41;&#39;;
&gt; print&#40; &#40; &#34;a&#34; x 1023 &#41; . &#34;\x{0378}&#34; &#41;;
&gt; ----- END TEST CODE -----
&gt; 
&gt; ----- BEGIN TEST OUTPUT -----
&gt; &#34;\x{0340}&#34; does not map to cp1250 at a.pl line 2.
&gt; panic: sv_setpvn called with negative strlen at a.pl line 2.
&gt; ----- END TEST OUTPUT -----
&gt; 
&gt; Note that the problem occurs at the 1K mark.
&gt; 
&gt; Note that the warning identifies &#34;\x{0340}&#34; even though there is no 
</div>such
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; character in the string.
</div>
That test case still fails for me up to 5.14.2 but interestingly it 
works in 5.16.0:

$ perlbrew use perl-5.14.2
martin@betdevel:~/bet/tools/modules$ perl -e &#39;binmode STDOUT, 
&#34;:encoding&#40;cp1250&#41;&#34;;print&#40; &#40; &#34;a&#34; x 1023 &#41; . &#34;\x{0378}&#34; &#41;;&#39;
&#34;\x{0340}&#34; does not map to cp1250 at -e line 1.
panic: sv_setpvn called with negative strlen at -e line 1.
$ perlbrew use perl-5.16.0
martin@betdevel:~/bet/tools/modules$ perl -e &#39;binmode STDOUT, 
&#34;:encoding&#40;cp1250&#41;&#34;;print&#40; &#40; &#34;a&#34; x 1023 &#41; . &#34;\x{0378}&#34; &#41;;&#39;
&#34;\x{fffd}&#34; does not map to cp1250 at -e line 1.
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaa\x{fffd}&#34;\x{fffd}&#34; does not map to cp1250.

My only interest was I used to get the same error under Log::Log4perl 
and found this rt.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;03&nbsp;08:22:32&nbsp;2016</span>
    <span class="description">ntyni [...] iki.fi -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ntyni [...] iki.fi</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Sep 21 06:43:45 2012, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Feb 07 15:47:45 2011, ikegami wrote:
<div class="message-stanza open">&gt; &gt; Simpler test case:
&gt; &gt; 
&gt; &gt; ----- BEGIN TEST CODE -----
&gt; &gt; binmode STDOUT, &#39;:encoding&#40;cp1250&#41;&#39;;
&gt; &gt; print&#40; &#40; &#34;a&#34; x 1023 &#41; . &#34;\x{0378}&#34; &#41;;
&gt; &gt; ----- END TEST CODE -----
&gt; &gt; 
&gt; &gt; ----- BEGIN TEST OUTPUT -----
&gt; &gt; &#34;\x{0340}&#34; does not map to cp1250 at a.pl line 2.
&gt; &gt; panic: sv_setpvn called with negative strlen at a.pl line 2.
&gt; &gt; ----- END TEST OUTPUT -----
&gt; &gt; 
&gt; &gt; Note that the problem occurs at the 1K mark.
&gt; &gt; 
&gt; &gt; Note that the warning identifies &#34;\x{0340}&#34; even though there is no 
</div>&gt; such
<div class="message-stanza open">&gt; &gt; character in the string.
</div>&gt; 
&gt; That test case still fails for me up to 5.14.2 but interestingly it 
&gt; works in 5.16.0:
</div>
We&#39;re still seeing this with 5.22 in Debian. The crashes are sporadic, I have no way to reliably reproduce them. I did manage to get some gdb stack traces and valgrind output, though. It looks like it may end up using uninitialized memory. See <span class="clickylink"><a target="new" rel="nofollow" href="https://bugs.debian.org/835989">https://bugs.debian.org/835989</a></span>

Combined with <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=106461">https://rt.cpan.org/Public/Bug/Display.html?id=106461</a></span> in ExtUtils::MakeMaker this makes the build process of some distributions crash when running Makefile.PL, which is rather unfortunate.

Let me know if I can help with this.

-- 
Niko Tyni
ntyni@debian.org
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;29&nbsp;14:18:46&nbsp;2016</span>
    <span class="description">pali [...] cpan.org -  Cc PALI added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;29&nbsp;14:22:23&nbsp;2016</span>
    <span class="description">pali [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> khw [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">No idea if this is bug in Encode.xs or in utf8n_to_uvuni&#40;&#41;, but utf8n_to_uvuni&#40;&#41; set return lenght higher then input lenght and Encode.xs does not handle this situation...

Here is quick hotfix for that:

diff --git a/Encode.xs b/Encode.xs
index 8c990ea..7cf9d4b 100644
--- a/Encode.xs
+++ b/Encode.xs
@@ -193,6 +193,8 @@ encode_method&#40;pTHX_ const encode_t * enc, const encpage_t * dir, SV * src,
         UV ch =
             utf8n_to_uvuni&#40;s+slen, &#40;SvCUR&#40;src&#41;-slen&#41;,
                    &#38;clen, UTF8_ALLOW_ANY|UTF8_CHECK_ONLY&#41;;
+        /* bug in utf8n_to_uvuni when it set clen higher then SvCUR&#40;src&#41;-slen */
+        if &#40;clen &gt; SvCUR&#40;src&#41;-slen&#41; break;
         /* if non-representable multibyte prefix at end of current buffer - break*/
         if &#40;clen &gt; tlen - sdone&#41; break;
         if &#40;check &#38; ENCODE_DIE_ON_ERR&#41; {


Now perl -e &#39;binmode STDOUT, &#34;:encoding&#40;cp1250&#41;&#34;;print&#40; &#40; &#34;a&#34; x 1023 &#41; . &#34;\x{0378}&#34; &#41;;&#39; does not crash anymore.

CCing khw about this problem.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;29&nbsp;15:10:46&nbsp;2016</span>
    <span class="description">khw [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Sep 29 12:22:23 2016, PALI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; No idea if this is bug in Encode.xs or in utf8n_to_uvuni&#40;&#41;, but
&gt; utf8n_to_uvuni&#40;&#41; set return lenght higher then input lenght and
&gt; Encode.xs does not handle this situation...
</div>
I overhauled utf8n_to_uvuni&#40;&#41; for 5.16 which fixed a number of bugs like this.  When run under blead, it does set the return length properly.  I do not know why Niko would find this in 5.22.  Perhaps there is another bug.  In the next month I intend to put the latest utf8_to_uvuni into Devel::PPPort, which would solve the problem that Pali found, and likely others.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;28&nbsp;01:23:19&nbsp;2016</span>
    <span class="description">DANKOGAI [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
