<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #41565 for DBD-Pg: Type-specific quoting functions considered harmful &#40;with bonus SQL-injection&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #41565 for DBD-Pg: Type-specific quoting functions considered harmful &#40;with bonus SQL-injection&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-Pg/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-Pg/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-Pg/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-Pg/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-Pg">DBD-Pg CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">41565</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-Pg/Active/">DBD-Pg</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">greg [...] turnstep.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
andrew [...] tao11.riddles.org.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-10200-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10201-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.14.0    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;09&nbsp;11:04:11&nbsp;2008</span>
    <span class="description">andrew [...] tao11.riddles.org.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Type-specific quoting functions considered harmful &#40;with bonus
 SQL-injection&#41;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">quote.c contains a number of functions for different types; most of
these are broken, as follows:

quote_geom rejects almost all valid geometric values, due to too-strict
limitations on allowed characters &#40;no provision for -, ., E, etc. --
coordinates are floating-point values&#41;

quote_path, quote_circle likewise

quote_bool does what it is supposed to, but the logic is in completely
the wrong place &#40;see below&#41;.

quote_integer seems, fortunately, to be dead code - if it were ever used
it would break all kinds of stuff.

and, to cap it off, the use of null_quote on integer fields can lead to
SQL injection:

$s=$d-&gt;prepare&#40;q[select ? where 1=?], { pg_server_prepare =&gt; 0 }&#41;;
$s-&gt;bind_param&#40;2,undef,SQL_INTEGER&#41;;
$s-&gt;execute&#40;1,&#34;2; drop table x;&#34;&#41;;

because nothing checks that the value is actually an integer.

Putting type-specific logic like that of quote_bool into a quote_*
function only handles half the job; it leaves out the question of what
to do if a parameter of the same type is passed directly to PQexecParams
or PQexecPrepared. This leads to, for example, boolean values other than
exactly &#34;0&#34; or &#34;1&#34; being sometimes rejected and sometimes accepted, e.g.

$s=$d-&gt;prepare&#40;q[select 1 where ? or ?=1], { pg_server_prepare =&gt; 0 }&#41;;
$s-&gt;bind_param&#40;1,undef,SQL_BOOLEAN&#41;;
$s-&gt;execute&#40;&#34;f&#34;,2&#41;;  # errors

$s=$d-&gt;prepare&#40;q[select 1 where ?], { pg_server_prepare =&gt; 0 }&#41;;
$s-&gt;bind_param&#40;1,undef,SQL_BOOLEAN&#41;;
$s-&gt;execute&#40;&#34;f&#34;&#41;;  # &#34;f&#34; treated as false

&#40;also, quote_bool treats perl &#34;true&#34; values, such as &#34;0e0&#34; or &#34;0 but
true&#34; as though they were false, while these produce errors if passed as
real parameters&#41;
 
This whole thing needs a redesign, not just patching up the existing code.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;09&nbsp;13:35:11&nbsp;2008</span>
    <span class="description">rlippan [...] remotelinux.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #41565] Type-specific quoting functions considered harmful &#40;with bonus SQL-injection&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 09 Dec 2008 18:30:40 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Rudolf Lippan &lt;rlippan [...] remotelinux.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">

On Tue, 09 Dec 2008 11:04:16 -0500, &#34;Andrew Gierth via RT&#34;
&lt;bug-DBD-Pg@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; and, to cap it off, the use of null_quote on integer fields can lead to
&gt; SQL injection:
&gt; 
&gt; $s=$d-&gt;prepare&#40;q[select ? where 1=?], { pg_server_prepare =&gt; 0 }&#41;;
&gt; $s-&gt;bind_param&#40;2,undef,SQL_INTEGER&#41;;
&gt; $s-&gt;execute&#40;1,&#34;2; drop table x;&#34;&#41;;
&gt; 
&gt; because nothing checks that the value is actually an integer.
</div>
Am I missing something here or is this not completely obvious? You are not
using server side prepare, and you explicitly telling the driver to treat
the incoming value as an integer.

It is almost as if you were saying, &#39;Hello Mr. Driver, I am passing in a
value into an integer column, please do not try and guess on how to quote
this, but rather quote it as if you had guessed that it were an integer.&#39;
And What does the driver do when it sees an integer? Nothing. So the driver
does nothing, just like you asked.

Or look at it the other way, if the driver did not think that it looked
like an integer, how would it quote it... Like an integer.  Which is by
doing nothing. So you see, you can&#39;t win here. Either way you get nothing
;&#41;  A good old fashioned croaking might be fun, though. 

croak &#34;$value does not look like a number&#34; if !looks_like_number&#40;$value&#41;;
But, alas, with that you loose the ability to use SQL_INTEGER for the of
abuse client side prepared statements &#40;not that I have ever done that
myself... I promise.&#41;

It would be possible, however, to pull off of the IV when something is
bound as SQL_INTEGER, and that would probably make sense.... Except for the
possible complaints of, &#34;when I try to insert this string, I get some weird
number in my database&#34;.

-r 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;09&nbsp;13:35:13&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;09&nbsp;20:12:45&nbsp;2008</span>
    <span class="description">andrew [...] tao11.riddles.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 09 13:35:11 2008, RUDY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 
&gt; On Tue, 09 Dec 2008 11:04:16 -0500, &#34;Andrew Gierth via RT&#34;
&gt; &lt;bug-DBD-Pg@rt.cpan.org&gt; wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; and, to cap it off, the use of null_quote on integer fields can lead to
&gt; &gt; SQL injection:
&gt; &gt; 
&gt; &gt; $s=$d-&gt;prepare&#40;q[select ? where 1=?], { pg_server_prepare =&gt; 0 }&#41;;
&gt; &gt; $s-&gt;bind_param&#40;2,undef,SQL_INTEGER&#41;;
&gt; &gt; $s-&gt;execute&#40;1,&#34;2; drop table x;&#34;&#41;;
&gt; &gt; 
&gt; &gt; because nothing checks that the value is actually an integer.
</div>&gt; 
&gt; Am I missing something here or is this not completely obvious? You are not
&gt; using server side prepare, and you explicitly telling the driver to treat
&gt; the incoming value as an integer.
</div>
The whole point of using placeholders is to guarantee that SQL injection
can NOT occur regardless of whether the data passed in is as the
application expects it or not.

It is the driver&#39;s responsibility to either generate correct SQL or
throw an error.

For example, it would be quite reasonable for an integer placeholder to
be replaced by a string such as &#40;integer &#39;1234&#39;&#41; which is both
type-correct and proof against injection.

As for using server-side prepare; one serious problem with the driver as
it stands is that the application writer can find it _very_ hard to
predict whether any given prepare&#40;&#41;/bind_param&#40;&#41;*/execute&#40;&#41; sequence
will lead to the driver using prepare/execPrepared, execParams, or plain
exec when it comes to the execute call - and the handling of type
information is VERY different between those cases, to the extent that
many queries &#40;especially ones involving function calls&#41; will succeed or
fail according to which choice the driver makes. &#40;There&#39;s also a
performance reason to prefer execParams &#40;one roundtrip&#41; over
prepare/execPrepared &#40;two roundtrips&#41; for statements that are only going
to be executed once.&#41;
 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;25&nbsp;19:34:14&nbsp;2009</span>
    <span class="description">greg [...] turnstep.com -  Severity Critical added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;10&nbsp;20:03:51&nbsp;2009</span>
    <span class="description">greg [...] turnstep.com -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;29&nbsp;03:04:44&nbsp;2009</span>
    <span class="description">bryce2 [...] obviously.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bryce2 [...] obviously.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sounds like this should be assigned a CVE &#40;See <span class="clickylink"><a target="new" rel="nofollow" href="http://cve.mitre.org/">http://cve.mitre.org/</a></span> &#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;12&nbsp;14:45:41&nbsp;2009</span>
    <span class="description">greg [...] turnstep.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Working on solutions for this: see r12857 or later, will be part of the
next release.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;20&nbsp;14:46:03&nbsp;2009</span>
    <span class="description">greg [...] turnstep.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Jul 12 14:45:41 2009, greg@turnstep.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Working on solutions for this: see r12857 or later, will be part of the
&gt; next release.
</div>
Have some quick fixes in place as of r13090
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;28&nbsp;10:44:14&nbsp;2009</span>
    <span class="description">greg [...] turnstep.com -  Fixed in 2.14.0 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;28&nbsp;10:44:14&nbsp;2009</span>
    <span class="description">greg [...] turnstep.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Should be fixed as of 2.14.0. If not, please reopen this ticket or
create a new one. I&#39;ve moved the non-deterministic exec* complaint to
ticket 48272.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;28&nbsp;10:44:15&nbsp;2009</span>
    <span class="description">greg [...] turnstep.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
