<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #108898 for DBIx-Class: find_or_create accorss relationships bug?</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #108898 for DBIx-Class: find_or_create accorss relationships bug?</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBIx-Class/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Class">DBIx-Class CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">108898</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBIx-Class/Active/">DBIx-Class</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
martin.renvoize [...] ptfs-europe.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10410-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10411-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;13&nbsp;07:25:34&nbsp;2015</span>
    <span class="description">martin.renvoize [...] ptfs-europe.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> find_or_create accorss relationships bug?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 13 Nov 2015 12:24:53 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Renvoize, Martin&#34; &lt;martin.renvoize [...] ptfs-europe.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">So, I pasted the above into IRC this morning and castaway at least agreed
he &#39;thinks&#39; it&#39;s likely a bug.. so I thought I&#39;d record it.

I am intending to submit a pull request with at least a failing test
case shortly.


   1 So I&#39;m attempting to populate a bridge table.

   2
   3 The three tables in question are:
   4
   5 Role, Privilege and RolePrivilege.
   6
   7 My code is:
   8
   9 $schema-&gt;resultset&#40;&#39;RolePrivilege&#39;&#41;-&gt;find_or_create&#40;{role =&gt;
{name =&gt; &#39;admin&#39;}, privilege =&gt; {name =&gt; &#39;config-update&#39;}&#41;;
  10
  11 Looking at DBIC_TRACE this gets most of the way there..
  12
  13 SELECT &#34;me&#34;.&#34;id&#34;, &#34;me&#34;.&#34;name&#34;
  14   FROM &#34;roles&#34; &#34;me&#34;
  15 WHERE &#34;me&#34;.&#34;name&#34; = &#39;admin&#39;;
  16
  17 SELECT &#34;me&#34;.&#34;id&#34;, &#34;me&#34;.&#34;name&#34;, &#34;me&#34;.&#34;description&#34;
  18   FROM &#34;privileges&#34; &#34;me&#34;
  19 WHERE &#34;me&#34;.&#34;name&#34; = &#39;config_update&#39;;
  20
  21 But the final insert doesn&#39;t do a &#39;find&#39; before attempting the
create, so I get constraint failures.
  22
  23 INSERT INTO &#34;role_privileges&#34;&#40; &#34;privilege&#34;, &#34;role&#34; &#41;
  24   VALUES&#40; &#39;1&#39;, &#39;20&#39; &#41;
  25
  26 Am I expecting too much of the logic.. bug of feature?



Martin Renvoize
Software Engineer, PTFS Europe Ltd
Content Management and Library Solutions
Skype:
Landline: 0203 286 8685
Mobile: 07725985636

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.ptfs-europe.com">http://www.ptfs-europe.com</a></span>
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;30&nbsp;14:51:51&nbsp;2016</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Nov 13 13:25:34 2015, martin.renvoize@ptfs-europe.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;    7 My code is:
&gt;    8
&gt;    9 $schema-&gt;resultset&#40;&#39;RolePrivilege&#39;&#41;-&gt;find_or_create&#40;{role =&gt;
&gt; {name =&gt; &#39;admin&#39;}, privilege =&gt; {name =&gt; &#39;config-update&#39;}&#41;;
&gt;   10
</div>

There is something specific about your code that makes things fail - please get me the definitions of RolePrivelege and the related classes.

The functionality you described works just fine:

~/devel/dbic$ perl -It/lib -Ilib -MDBICTest -e &#39;
  my $s = DBICTest-&gt;init_schema;
  $s-&gt;storage-&gt;debug&#40;1&#41;;
  $s-&gt;resultset&#40;&#34;CD_to_Producer&#34;&#41;-&gt;find_or_create&#40;{
    cd =&gt; { cdid =&gt; 2 },
    producer =&gt; { producerid =&gt; 1 }
  }&#41;
&#39;

producing

SELECT me.cd, me.producer, me.attribute FROM cd_to_producer me WHERE &#40; &#40; me.cd = ? AND me.producer = ? &#41; &#41;: &#39;2&#39;, &#39;1&#39;
SELECT me.cdid, me.artist, me.title, me.year, me.genreid, me.single_track FROM cd me WHERE &#40; me.cdid = ? &#41;: &#39;2&#39;
SELECT me.producerid, me.name FROM producer me WHERE &#40; me.producerid = ? &#41;: &#39;1&#39;
INSERT INTO cd_to_producer &#40; cd, producer&#41; VALUES &#40; ?, ? &#41;: &#39;2&#39;, &#39;1&#39;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;30&nbsp;14:51:51&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;28&nbsp;12:33:31&nbsp;2018</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Mar 30 20:51:51 2016, RIBASUSHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Nov 13 13:25:34 2015, martin.renvoize@ptfs-europe.com wrote:
<div class="message-stanza open">&gt; &gt; 7 My code is:
&gt; &gt; 8
&gt; &gt; 9 $schema-&gt;resultset&#40;&#39;RolePrivilege&#39;&#41;-&gt;find_or_create&#40;{role =&gt;
&gt; &gt; {name =&gt; &#39;admin&#39;}, privilege =&gt; {name =&gt; &#39;config-update&#39;}&#41;;
&gt; &gt; 10
</div>&gt; 
&gt; 
&gt; There is something specific about your code that makes things fail -
&gt; please get me the definitions of RolePrivelege and the related
&gt; classes.
&gt; 
&gt; The functionality you described works just fine:
</div>

Hi Martin!

You never got back to me way-back-when. Did something come out of this bug, or should I close it as  ¯\_&#40;ツ&#41;_/¯
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;29&nbsp;08:20:58&nbsp;2018</span>
    <span class="description">martin.renvoize [...] ptfs-europe.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #108898] find_or_create accorss relationships bug?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 29 Jan 2018 13:19:37 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Renvoize, Martin&#34; &lt;martin.renvoize [...] ptfs-europe.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think just close it.. I&#39;m afraid that&#39;s long enough ago that&#39;s I&#39;ve
completely forgotten what the issue was and I wasn&#39;t sensible enough to
note it down at the time :&#40;, it&#39;s not causing me problems in my current
codebase so I presume it was my mistake somewhere.

*Martin Renvoize*

Development Manager




*T:* +44 &#40;0&#41; 1483 378728

*F:* +44 &#40;0&#41; 800 756 6384

*E:* martin.renvoize@ptfs-europe.com

www.ptfs-europe.com



&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://www.ptfs-europe.com">https://www.ptfs-europe.com</a></span>&gt;



Registered in the United Kingdom No. 06416372   VAT Reg No. 925 7211 30

The information contained in this email message may be privileged,
confidential and protected from disclosure. If you are not the intended
recipient, any dissemination, distribution or copying is strictly
prohibited. If you think that you have received this email message in
error, please email the sender at info@ptfs-europe.com


On 28 January 2018 at 17:33, Peter Rabbitson via RT &lt;
bug-DBIx-Class@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=108898">https://rt.cpan.org/Ticket/Display.html?id=108898</a></span> &gt;
&gt;
&gt; On Wed Mar 30 20:51:51 2016, RIBASUSHI wrote:
<div class="message-stanza open">&gt; &gt; On Fri Nov 13 13:25:34 2015, martin.renvoize@ptfs-europe.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; 7 My code is:
&gt; &gt; &gt; 8
&gt; &gt; &gt; 9 $schema-&gt;resultset&#40;&#39;RolePrivilege&#39;&#41;-&gt;find_or_create&#40;{role =&gt;
&gt; &gt; &gt; {name =&gt; &#39;admin&#39;}, privilege =&gt; {name =&gt; &#39;config-update&#39;}&#41;;
&gt; &gt; &gt; 10
</div>&gt; &gt;
&gt; &gt;
&gt; &gt; There is something specific about your code that makes things fail -
&gt; &gt; please get me the definitions of RolePrivelege and the related
&gt; &gt; classes.
&gt; &gt;
&gt; &gt; The functionality you described works just fine:
</div>&gt;
&gt;
&gt; Hi Martin!
&gt;
&gt; You never got back to me way-back-when. Did something come out of this
&gt; bug, or should I close it as  ¯\_&#40;ツ&#41;_/¯
&gt;
&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;29&nbsp;09:47:10&nbsp;2018</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jan 29 14:20:58 2018, martin.renvoize@ptfs-europe.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think just close it.. I&#39;m afraid that&#39;s long enough ago that&#39;s I&#39;ve
&gt; completely forgotten what the issue was and I wasn&#39;t sensible enough to
&gt; note it down at the time :&#40;
</div>
¯\_&#40;ツ&#41;_/¯ it is then ;&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;29&nbsp;09:47:11&nbsp;2018</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
