<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #5849 for Module-Install: load_extensions&#40;&#41; causes &#34;Subroutine %s redefined&#34; warnings</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #5849 for Module-Install: load_extensions&#40;&#41; causes &#34;Subroutine %s redefined&#34; warnings</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Module-Install/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Module-Install/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Module-Install/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Module-Install/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Module-Install">Module-Install CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">5849</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Module-Install/Active/">Module-Install</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
steve.hay [...] uk.radan.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21632-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.33    </td>
  </tr>
  <tr id="CF-21633-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;31&nbsp;04:49:07&nbsp;2004</span>
    <span class="description">shay [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> load_extensions&#40;&#41; causes &#34;Subroutine %s redefined&#34; warnings</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve created a module that uses a pair of &#34;private extension&#34; modules, Module::Install::PRIVATE and Module::Install::PRIVATE::Foo.  The latter one inherits from the former one, which in turn inherits from Module::Install::Base.

Each extension has a method with a suitably &#34;unique&#34; name such that the autoloader will correctly find it.  These methods simply return the object on which they were invoked, and the object can then be used to invoke further methods on &#40;which perhaps have less &#34;unique&#34; names and which could not therefore be reliably found by the autoloader&#41;.

An example of this setup is in the attached &#34;Foo.tar.gz&#34; archive.

You will note that running &#34;perl Makefile.PL&#34; produces two &#34;Subroutine %s redefined&#34; warnings:

Subroutine get_private_obj redefined at inc/Module/Install/PRIVATE.pm line 6.
Subroutine greeting redefined at inc/Module/Install/PRIVATE.pm line 7.

I believe that the reason for this is that inc/Module/Install/PRIVATE.pm gets loaded once &#40;by load_extensions&#40;&#41;&#41; in the course of looking for get_private_mymodule_obj&#40;&#41;, and then again &#40;by inc/Module/Install/PRIVATE/Foo.pm&#41; when it is finally located.

The reason that inc/Module/Install/PRIVATE/Foo.pm loads inc/Module/Install/PRIVATE.pm even though it has already been loaded is that load_extensions&#40;&#41; removed the entry for that file from %INC, so Perl &#34;forgets&#34; that is has already been loaded.  This is what causes the warnings.

Is there any particular reason why load_extensions&#40;&#41; removes entries from %INC?

If not, then the following patch &#40;against 0.33&#41; fixes this problem.  It certainly works fine for me:

--- lib/Module/Install.pm.orig  2004-03-11 12:55:22.000000000 +0000
+++ lib/Module/Install.pm       2004-03-31 10:29:25.758297000 +0100
@@ -265,7 +265,7 @@
         next if $self-&gt;{pathnames}{$pkg};
 
         eval { require $file; 1 } or &#40;warn&#40;$@&#41;, next&#41;;
-        $self-&gt;{pathnames}{$pkg} = delete $INC{$file};
+        $self-&gt;{pathnames}{$pkg} = $INC{$file};
         push @{$self-&gt;{extensions}}, $pkg-&gt;new&#40; _top =&gt; $top_obj &#41;;
     }
 }
End of Patch.

There are also some similar deletions in Module::Install::import&#40;&#41;, with the comment &#34;Unregister loader and worker packages so subdirs can use them again&#34;.  I haven&#39;t actually seen any problems from this, but I wonder if it might have the same problem again?

This is all running with Perl 5.8.3 on WinXP.

Cheers,
- Steve
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;23&nbsp;04:21:08&nbsp;2006</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Is this bug still occuring?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;23&nbsp;04:21:09&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;23&nbsp;04:41:12&nbsp;2006</span>
    <span class="description">shay [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Feb 23 04:21:08 2006, ADAMK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Is this bug still occuring?
</div>
Yes.  I just retried with perl-5.8.8 and Module-Install-0.56.  &#40;I
replaced the Module-Install components in the sample Foo.tar.gz with the
updated versions to try this.&#41;

I still get the warnings, and for the same reason.  The same fix still
applies.

In the real world, a module that I have working with this class
hierarchy avoids the warning by having the Module::Install::PRIVATE::Foo
subclass not load its parent class &#40;Module::Install::PRIVATE&#41; since it
has already been loaded by Module::Install::load_extensions&#40;&#41;.  However,
that is clearly an implementation detail that my subclass should not be
relying on, and will break if Module::Install is ever rewritten in such
a way that this no longer happens.

Any subclass should always ensure that its parent class is loaded.  If
it is already loaded then this will just be a no-op, but only if the
entry for the parent class is still in %INC!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;06&nbsp;10:35:03&nbsp;2010</span>
    <span class="description">ishigaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi. Applied other patch in the trunk, and will be fixed in the next 
release. Thanks.

On 2004-3-31 Wed 04:49:07, SHAY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve created a module that uses a pair of &#34;private extension&#34; modules,
&gt;    Module::Install::PRIVATE and Module::Install::PRIVATE::Foo.  The
&gt;    latter one inherits from the former one, which in turn inherits
&gt;    from Module::Install::Base.
&gt; 
&gt; Each extension has a method with a suitably &#34;unique&#34; name such that
&gt;    the autoloader will correctly find it.  These methods simply return
&gt;    the object on which they were invoked, and the object can then be
&gt;    used to invoke further methods on &#40;which perhaps have less &#34;unique&#34;
&gt;    names and which could not therefore be reliably found by the
&gt;    autoloader&#41;.
&gt; 
&gt; An example of this setup is in the attached &#34;Foo.tar.gz&#34; archive.
&gt; 
&gt; You will note that running &#34;perl Makefile.PL&#34; produces two &#34;Subroutine
&gt;    %s redefined&#34; warnings:
&gt; 
&gt; Subroutine get_private_obj redefined at inc/Module/Install/PRIVATE.pm
&gt;    line 6.
&gt; Subroutine greeting redefined at inc/Module/Install/PRIVATE.pm line 7.
&gt; 
&gt; I believe that the reason for this is that
&gt;    inc/Module/Install/PRIVATE.pm gets loaded once &#40;by
&gt;    load_extensions&#40;&#41;&#41; in the course of looking for
&gt;    get_private_mymodule_obj&#40;&#41;, and then again &#40;by
&gt;    inc/Module/Install/PRIVATE/Foo.pm&#41; when it is finally located.
&gt; 
&gt; The reason that inc/Module/Install/PRIVATE/Foo.pm loads
&gt;    inc/Module/Install/PRIVATE.pm even though it has already been
&gt;    loaded is that load_extensions&#40;&#41; removed the entry for that file
&gt;    from %INC, so Perl &#34;forgets&#34; that is has already been loaded.  This
&gt;    is what causes the warnings.
&gt; 
&gt; Is there any particular reason why load_extensions&#40;&#41; removes entries
&gt;    from %INC?
&gt; 
&gt; If not, then the following patch &#40;against 0.33&#41; fixes this problem.
&gt;    It certainly works fine for me:
&gt; 
&gt; --- lib/Module/Install.pm.orig        2004-03-11 12:55:22.000000000 
</div>+0000
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; +++ lib/Module/Install.pm     2004-03-31 10:29:25.758297000 +0100
&gt; @@ -265,7 +265,7 @@
&gt;          next if $self-&gt;{pathnames}{$pkg};
&gt; 
&gt;          eval { require $file; 1 } or &#40;warn&#40;$@&#41;, next&#41;;
&gt; -        $self-&gt;{pathnames}{$pkg} = delete $INC{$file};
&gt; +        $self-&gt;{pathnames}{$pkg} = $INC{$file};
&gt;          push @{$self-&gt;{extensions}}, $pkg-&gt;new&#40; _top =&gt; $top_obj &#41;;
&gt;      }
&gt;  }
&gt; End of Patch.
&gt; 
&gt; There are also some similar deletions in Module::Install::import&#40;&#41;,
&gt;    with the comment &#34;Unregister loader and worker packages so subdirs
&gt;    can use them again&#34;.  I haven&#39;t actually seen any problems from
&gt;    this, but I wonder if it might have the same problem again?
&gt; 
&gt; This is all running with Perl 5.8.3 on WinXP.
&gt; 
&gt; Cheers,
&gt; - Steve
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;06&nbsp;10:35:07&nbsp;2010</span>
    <span class="description">ishigaki [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;09&nbsp;22:50:09&nbsp;2010</span>
    <span class="description">ishigaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi. Module::Install 0.96/0.97 with a fix is out. Thanks.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;09&nbsp;22:50:12&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;09&nbsp;22:50:13&nbsp;2010</span>
    <span class="description">ishigaki [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
