<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #88872 for MIME-tools: Sometimes multipart Content-Type is ignored when parsing</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #88872 for MIME-tools: Sometimes multipart Content-Type is ignored when parsing</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=MIME-tools">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=MIME-tools">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=MIME-tools">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=MIME-tools">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/MIME-tools">MIME-tools CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">88872</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=MIME-tools">MIME-tools</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">dfs+pause [...] roaringpenguin.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
&#39;spro^^*%*^6ut# [...] &#38;$%*c

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21368-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21369-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




sample input.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1265541/670084/sample%20input.txt">
Sat Sep 21 14:14:39 2013 (10.9k) by $_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=88872">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1265541" href="/Public/Bug/Display.html?id=88872#txn-1265541">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;21&nbsp;14:14:39&nbsp;2013</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Sometimes multipart Content-Type is ignored when parsing</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1265541/670083/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/670083">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 609b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is my little ‘one’-liner to reproduce the bug:

$ cat sample\ input.txt | perl -lMMIME::Parser -e &#39;my $p = new MIME::Parser; $p-&gt;output_under&#40;&#34;/tmp&#34;&#41;; $e=$p-&gt;parse&#40;\*STDIN&#41;; print $p-&gt;filer-&gt;output_dir; $e-&gt;dump_skeleton&#39;
/tmp/msg-1379787083-1641-0
Content-type: text/plain

Effective-type: text/plain

Body-file: /tmp/msg-1379787083-1641-0/msg-1641-1.txt

So it has only created one file.  But see the attachment, which I am feeding to it &#40;the output of lwp-request -m GET -e &#39;nntp://nntp.perl.org/000001ceab1a$29aebd20$7d0c3760$@cp.net&#39;&#41;.  It is a multipart document.

Thank you for your attention.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> sample input.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1265541/670084/sample%20input.txt">Download sample input.txt</a><br />
<span class="downloadcontenttype">text/plain 10.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Date: Fri, 6 Sep 2013 17:00:07 +0100
From: meta.support@cp.net &#40;&#34;John Unsworth - CP Meta Support&#34;&#41;
Server: you can post
Content-Language: en-gb
Content-Type: multipart/mixed;boundary=&#34;----=_NextPart_000_0001_01CEAB22.8B73C160&#34;
Approved: news@nntp.perl.org
Client-Date: Sat, 21 Sep 2013 18:08:09 GMT
Delivered-To: mailing list perl5-porters@perl.org
Delivered-To: moderator for perl5-porters@perl.org
Delivered-To: perl5-porters@perl.org
Delivered-To: perlmail-perlbug-followup@onion.perl.org
Delivered-To: perlbug-followup@perl.org
In-Reply-To: &lt;rt-3.6.HEAD-1873-1378423344-99.119617-94-0@perl.org&gt;
Mailing-List: contact perl5-porters-help@perl.org; run by ezmlm
Message-ID: &lt;000001ceab1a$29aebd20$7d0c3760$@cp.net&gt;
MIME-Version: 1.0
Newsgroups: perl.perl5.porters
Path: nntp.perl.org
Received: &#40;qmail 3942 invoked from network&#41;; 6 Sep 2013 16:00:18 -0000
Received: from x1.develooper.com &#40;207.171.7.70&#41;by x6.develooper.com with SMTP; 6 Sep 2013 16:00:18 -0000
Received: &#40;qmail 24824 invoked by uid 225&#41;; 6 Sep 2013 16:00:17 -0000
Received: &#40;qmail 24816 invoked by alias&#41;; 6 Sep 2013 16:00:17 -0000
Received: from x6.develooper.com &#40;HELO x6.develooper.com&#41; &#40;207.171.7.86&#41;by la.mx.develooper.com &#40;qpsmtpd/0.28&#41; with ESMTP; Fri, 06 Sep 2013 09:00:13 -0700
Received: from lists-nntp.develooper.com &#40;localhost.localdomain [127.0.0.1]&#41;by x6.develooper.com &#40;Postfix&#41; with SMTP id 059311778Afor &lt;perl5-porters@perl.org&gt;; Fri,  6 Sep 2013 09:00:08 -0700 &#40;PDT&#41;
Received: &#40;qmail 3153 invoked by uid 514&#41;; 6 Sep 2013 16:00:06 -0000
Received: &#40;qmail 2707 invoked from network&#41;; 6 Sep 2013 16:00:04 -0000
Received: from x1.develooper.com &#40;207.171.7.70&#41;by x6.develooper.com with SMTP; 6 Sep 2013 16:00:04 -0000
Received: &#40;qmail 24769 invoked by uid 225&#41;; 6 Sep 2013 16:00:03 -0000
Received: &#40;qmail 24758 invoked by alias&#41;; 6 Sep 2013 16:00:02 -0000
Received: from mail.criticalpath.net &#40;HELO mail.criticalpath.net&#41; &#40;209.228.128.133&#41;by la.mx.develooper.com &#40;qpsmtpd/0.28&#41; with ESMTP; Fri, 06 Sep 2013 08:59:52 -0700
Received: from JUNSWORTHLT4 &#40;10.128.2.81&#41; by mail.criticalpath.net &#40;8.5.140.03&#41; &#40;authenticated as john.unsworth&#41;id 5208BA720014A825 for perlbug-followup@perl.org; Fri, 6 Sep 2013 16:59:47 +0100
References: &lt;RT-Ticket-119617@perl.org&gt; &lt;006201ceaa29$9fc54610$df4fd230$@cp.net&gt; &lt;rt-3.6.HEAD-1873-1378423344-99.119617-94-0@perl.org&gt;
Return-Path: &lt;meta.support@cp.net&gt;
Subject: RE: [perl #119617] PerlEmbed 5.14: sv_setsv&#40;ERRSV, &#38;PL_sv_undef&#41;; crashes on Linux
Thread-Index: AQFeDSk/g60VTU2FGmRE4gE9KeT5ggG2UFPRAcdl3k2afihKoA==
To: &lt;perlbug-followup@perl.org&gt;
X-Mailer: Microsoft Outlook 15.0
X-Old-Spam-Check-By: la.mx.develooper.com
X-Old-Spam-Status: No, hits=-5.9 required=8.0tests=BAYES_00,PERLBUG_CONF,SPF_PASS
X-Spam-Check-By: la.mx.develooper.com
X-Spam-Status: No, hits=-5.9 required=8.0tests=BAYES_00,PERLBUG_CONF
X-Virus-Checked: Checked
X-Virus-Checked: Checked
Xref: nntp.perl.org perl.perl5.porters:207396

------=_NextPart_000_0001_01CEAB22.8B73C160
Content-Type: text/plain;
	charset=&#34;utf-8&#34;
Content-Transfer-Encoding: quoted-printable

Hi James,

I&#39;m afraid I&#39;m failing miserably with this. I have extracted the calls =
that our code makes into a windows console application but it crashes on =
the call to CLEAR_ERRSV&#40;&#41;. Everything else seems to work OK if I remove =
the call. I can see that vTHX-&gt;Ierrgv returns zero. I have attached the =
code and test script. It is built against 5.14 from ActiveState. Let me =
know what you suggest.

Regards,
John.

Summary of my perl5 &#40;revision 5 version 14 subversion 1&#41; configuration:

  Platform:
    osname=3DMSWin32, osvers=3D5.2, archname=3DMSWin32-x86-multi-thread
    uname=3D&#39;&#39;
    config_args=3D&#39;undef&#39;
    hint=3Drecommended, useposix=3Dtrue, d_sigaction=3Dundef
    useithreads=3Ddefine, usemultiplicity=3Ddefine
    useperlio=3Ddefine, d_sfio=3Dundef, uselargefiles=3Ddefine, =
usesocks=3Dundef
    use64bitint=3Dundef, use64bitall=3Dundef, uselongdouble=3Dundef
    usemymalloc=3Dn, bincompat5005=3Dundef
  Compiler:
    cc=3D&#39;cl&#39;, ccflags =3D&#39;-nologo -GF -W3 -MD -Zi -DNDEBUG -O1 -DWIN32 =
-D_CONSOLE -
DNO_STRICT -DPERL_TEXTMODE_SCRIPTS -DUSE_SITECUSTOMIZE =
-DPERL_IMPLICIT_CONTEXT -
DPERL_IMPLICIT_SYS -DUSE_PERLIO -D_USE_32BIT_TIME_T&#39;,
    optimize=3D&#39;-MD -Zi -DNDEBUG -O1&#39;,
    cppflags=3D&#39;-DWIN32&#39;
    ccversion=3D&#39;12.00.8168&#39;, gccversion=3D&#39;&#39;, gccosandvers=3D&#39;&#39;
    intsize=3D4, longsize=3D4, ptrsize=3D4, doublesize=3D8, =
byteorder=3D1234
    d_longlong=3Dundef, longlongsize=3D8, d_longdbl=3Ddefine, =
longdblsize=3D8
    ivtype=3D&#39;long&#39;, ivsize=3D4, nvtype=3D&#39;double&#39;, nvsize=3D8, =
Off_t=3D&#39;__int64&#39;, lseeksi
ze=3D8
    alignbytes=3D8, prototype=3Ddefine
  Linker and Libraries:
    ld=3D&#39;link&#39;, ldflags =3D&#39;-nologo -nodefaultlib -debug -opt:ref,icf  =
-libpath:&#34;C:
\Perl\lib\CORE&#34;  -machine:x86&#39;
    libpth=3D\lib
    libs=3Doldnames.lib kernel32.lib user32.lib gdi32.lib winspool.lib  =
comdlg32.l
ib advapi32.lib shell32.lib ole32.lib oleaut32.lib  netapi32.lib =
uuid.lib ws2_32
.lib mpr.lib winmm.lib  version.lib odbc32.lib odbccp32.lib comctl32.lib =
msvcrt.
lib
    perllibs=3Doldnames.lib kernel32.lib user32.lib gdi32.lib =
winspool.lib  comdlg
32.lib advapi32.lib shell32.lib ole32.lib oleaut32.lib  netapi32.lib =
uuid.lib ws
2_32.lib mpr.lib winmm.lib  version.lib odbc32.lib odbccp32.lib =
comctl32.lib msv
crt.lib
    libc=3Dmsvcrt.lib, so=3Ddll, useshrplib=3Dtrue, =
libperl=3Dperl514.lib
    gnulibc_version=3D&#39;&#39;
  Dynamic Linking:
    dlsrc=3Ddl_win32.xs, dlext=3Ddll, d_dlsymun=3Dundef, ccdlflags=3D&#39; &#39;
    cccdlflags=3D&#39; &#39;, lddlflags=3D&#39;-dll -nologo -nodefaultlib -debug =
-opt:ref,icf  -
libpath:&#34;C:\Perl\lib\CORE&#34;  -machine:x86&#39;


Characteristics of this binary &#40;from libperl&#41;:
  Compile-time options: MULTIPLICITY PERL_DONT_CREATE_GVSV
                        PERL_IMPLICIT_CONTEXT PERL_IMPLICIT_SYS
                        PERL_MALLOC_WRAP PERL_PRESERVE_IVUV =
PL_OP_SLAB_ALLOC
                        USE_ITHREADS USE_LARGE_FILES USE_PERLIO =
USE_PERL_ATOF
                        USE_SITECUSTOMIZE
  Locally applied patches:
        ActivePerl Build 1401 [294969]
  Built under MSWin32
  Compiled at Jun 16 2011 18:54:40
  @INC:
    C:/Perl514/site/lib
    C:/Perl514/lib

Regards,
John

-----Original Message-----
From: James E Keenan via RT [mailto:perlbug-followup@perl.org]=20
Sent: 06 September 2013 00:22
To: john.unsworth@cp.net
Subject: [perl #119617] PerlEmbed 5.14: sv_setsv&#40;ERRSV, &#38;PL_sv_undef&#41;; =
crashes on Linux

On Thu Sep 05 04:18:28 2013, john.unsworth@cp.net wrote:
&gt; This is a bug report for perl from john.unsworth@cp.net,
&gt;=20
&gt; generated with the help of perlbug 1.39 running under perl 5.10.1.
&gt;=20
&gt; =20
&gt;=20
&gt; The C++ application calling Perl worked correctly up to Perl 5.10.=20
&gt; However when I upgraded to 5.14 it cores on Linux; it continues to=20
&gt; work OK on Windows.
&gt;=20
&gt; =20
&gt;=20
&gt; This is reported just before the core:
&gt;=20
&gt; =20
&gt;=20
&gt; Bizarre copy of UNKNOWN.
&gt;=20
&gt; Segmentation fault &#40;core dumped&#41;
&gt;=20
&gt; =20
&gt;=20
&gt; By adding trace lines I found that the call to sv_setsv&#40;ERRSV,=20
&gt; &#38;PL_sv_undef&#41;; was causing the crash
&gt;=20
&gt; =20
&gt;=20
&gt; I looked into the header files and found a macro CLEAR_ERROR. At 5.10=20
&gt; this is defined as:
&gt;=20
&gt; =20
&gt;=20
&gt; #define ERRSV GvSV&#40;PL_errgv&#41;
&gt;=20
&gt; #define CLEAR_ERRSV&#40;&#41; STMT_START { sv_setpvn&#40;ERRSV,&#34;&#34;,0&#41;; if
&gt; &#40;SvMAGICAL&#40;ERRSV&#41;&#41; { mg_free&#40;ERRSV&#41;; } SvPOK_only&#40;ERRSV&#41;; } STMT_END
&gt;=20
&gt; =20
&gt;=20
&gt; However at 5.14 it is:
&gt;=20
&gt; =20
&gt;=20
&gt; #define ERRSV GvSVn&#40;PL_errgv&#41;
&gt;=20
&gt; #define CLEAR_ERRSV&#40;&#41; STMT_START {                          \
&gt;=20
&gt;     if &#40;!GvSV&#40;PL_errgv&#41;&#41; {                                  \
&gt;=20
&gt;       sv_setpvs&#40;GvSV&#40;gv_add_by_type&#40;PL_errgv, SVt_PV&#41;&#41;, &#34;&#34;&#41;;           =
 \
&gt;=20
&gt;     } else if &#40;SvREADONLY&#40;GvSV&#40;PL_errgv&#41;&#41;&#41; {                      \
&gt;=20
&gt;       SvREFCNT_dec&#40;GvSV&#40;PL_errgv&#41;&#41;;                         \
&gt;=20
&gt;       GvSV&#40;PL_errgv&#41; =3D newSVpvs&#40;&#34;&#34;&#41;;                              \
&gt;=20
&gt;     } else {                                                \
&gt;=20
&gt;       SV *const errsv =3D GvSV&#40;PL_errgv&#41;;                     \
&gt;=20
&gt;       sv_setpvs&#40;errsv, &#34;&#34;&#41;;                                 \
&gt;=20
&gt;       if &#40;SvMAGICAL&#40;errsv&#41;&#41; {                               \
&gt;=20
&gt;           mg_free&#40;errsv&#41;;                                   \
&gt;=20
&gt;       }                                               \
&gt;=20
&gt;       SvPOK_only&#40;errsv&#41;;                                    \
&gt;=20
&gt;     }                                                 \
&gt;=20
&gt;     } STMT_END
&gt;=20
&gt; =20
&gt;=20
&gt; So it seems that the implementation of ERRSV has changed in that at
5.14 it
&gt; is not initially defined, hence I assume that sv_setsv&#40;ERRSV,
&#38;PL_sv_undef&#41;;
&gt; was trying to set an undefined variable and thus causing the error.=20
&gt; The correct fix seems to be to change this to CLEAR_ERRSV&#40;&#41;. Shouldn&#39;t =

&gt; this be mentioned in the embed documentation? There is no mention at=20
&gt; all of how to reset the error variable.
&gt;=20


Would it be possible for you to attach a file which reproduces this =
problem either &#40;a&#41; in a file in a pure Perl format; or &#40;b&#41; in a minimal
C++ program calling a small Perl program?

Thank you very much.
Jim Keenan

------=_NextPart_000_0001_01CEAB22.8B73C160
Content-Type: application/octet-stream;
	name=&#34;test.pl&#34;
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment;
	filename=&#34;test.pl&#34;

package test;
use strict;

sub test
{
   print &#34;Hello\n&#34;;
   fred&#40;&#41;;
   return 7;
}

print &#34;loaded OK\n&#34;;

#test::test&#40;&#41;;

1;

------=_NextPart_000_0001_01CEAB22.8B73C160
Content-Type: text/plain;
	name=&#34;PerlCrash.cpp&#34;
Content-Transfer-Encoding: quoted-printable
Content-Disposition: attachment;
	filename=&#34;PerlCrash.cpp&#34;

// PerlCrash.cpp : Defines the entry point for the console application.=0A=
//=0A=
=0A=
#include &lt;tchar.h&gt;=0A=
=0A=
extern &#34;C&#34;=0A=
{=0A=
=0A=
#define HAS_BOOL 1=0A=
#define WIN32IO_IS_STDIO=0A=
#define HAS_UNION_SEMUN=0A=
=0A=
#include &#34;EXTERN.h&#34;=0A=
#include &#34;perl.h&#34;=0A=
#include &#34;XSUB.h&#34;=0A=
=0A=
} // end extern &#34;C&#34;=0A=
=0A=
int _tmain&#40;int argc, _TCHAR* argv[]&#41;=0A=
{=0A=
    char **perl_argv =3D &#40;char **&#41; calloc&#40;3, sizeof&#40;char *&#41;&#41;;=0A=
    int perl_argc =3D 1;=0A=
=0A=
    perl_argv[0] =3D _strdup&#40;&#34;PerlCrash.exe&#34;&#41;;=0A=
    perl_argv[1] =3D _strdup&#40;&#34;test.pl&#34;&#41;;=0A=
=0A=
    PERL_SYS_INIT&#40;&#38;perl_argc, &#38;perl_argv&#41;;=0A=
=0A=
    PerlInterpreter *my_perl =3D perl_alloc&#40;&#41;;=0A=
=0A=
    perl_construct&#40;my_perl&#41;;=0A=
=0A=
    int iRet =3D perl_parse&#40;my_perl, NULL, perl_argc, perl_argv, NULL&#41;;=0A=
=0A=
    iRet =3D perl_run&#40;my_perl&#41;;=0A=
    SV **sp =3D PL_stack_sp;=0A=
=0A=
    PERL_SET_CONTEXT&#40;my_perl&#41;;=0A=
    SPAGAIN;=0A=
    ENTER;=0A=
    SAVETMPS;=0A=
    PUSHMARK&#40;sp&#41;;=0A=
=0A=
    PUTBACK;=0A=
=0A=
    int ret =3D perl_call_pv&#40;&#34;test::test&#34;, G_SCALAR|G_EVAL&#41;;=0A=
=0A=
    GV* err =3D &#40;vTHX-&gt;Ierrgv&#41;;=0A=
    CLEAR_ERRSV&#40;&#41;;=0A=
=0A=
	return 0;=0A=
}=0A=
=0A=

------=_NextPart_000_0001_01CEAB22.8B73C160
Content-Type: application/octet-stream;
	name=&#34;test.pl&#34;
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment;
	filename=&#34;test.pl&#34;

package test;
use strict;

sub test
{
   print &#34;Hello\n&#34;;
   fred&#40;&#41;;
   return 7;
}

print &#34;loaded OK\n&#34;;

#test::test&#40;&#41;;

1;

------=_NextPart_000_0001_01CEAB22.8B73C160--

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1265778" href="/Public/Bug/Display.html?id=88872#txn-1265778">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;22&nbsp;10:52:35&nbsp;2013</span>
    <span class="description">dfs+pause [...] roaringpenguin.com -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1265779" href="/Public/Bug/Display.html?id=88872#txn-1265779">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;22&nbsp;10:54:34&nbsp;2013</span>
    <span class="description">dfs [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #88872] Sometimes multipart Content-Type is ignored when parsing</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 22 Sep 2013 10:54:17 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David F. Skoll&#34; &lt;dfs [...] roaringpenguin.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1265779/670201/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/670201">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I cannot reproduce the problem.  Here&#39;s the output I get; what version
of MIME-tools and what platform are you testing on?

Regards,

David.

$ perl -Ilib -lMMIME::Parser -e &#39;my $p = new MIME::Parser; $p-&gt;output_under&#40;&#34;/tmp&#34;&#41;; $e=$p-&gt;parse&#40;\*STDIN&#41;; print $p-&gt;filer-&gt;output_dir; $e-&gt;dump_skeleton&#39; &lt; /tmp/sample.txt

/tmp/msg-1379861585-22373-0
Content-type: multipart/mixed

Effective-type: multipart/mixed

Body-file: NONE

Subject: RE: [perl #119617] PerlEmbed 5.14: sv_setsv&#40;ERRSV, &#38;PL_sv_undef&#41;; crashes on Linux

Num-parts: 4

--

    Content-type: text/plain

    Effective-type: text/plain

    Body-file: /tmp/msg-1379861585-22373-0/msg-22373-1.txt

    --

    Content-type: application/octet-stream

    Effective-type: application/octet-stream

    Body-file: /tmp/msg-1379861585-22373-0/test.pl

    Recommended-filename: test.pl

    --

    Content-type: text/plain

    Effective-type: text/plain

    Body-file: /tmp/msg-1379861585-22373-0/PerlCrash.cpp

    Recommended-filename: PerlCrash.cpp

    --

    Content-type: application/octet-stream

    Effective-type: application/octet-stream

    Body-file: /tmp/msg-1379861585-22373-0/test-1.pl

    Recommended-filename: test.pl

    --
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1265780" href="/Public/Bug/Display.html?id=88872#txn-1265780">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;22&nbsp;10:54:35&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1279325" href="/Public/Bug/Display.html?id=88872#txn-1279325">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;25&nbsp;20:43:30&nbsp;2013</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1279325/677865/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/677865">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 460b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Sep 22 10:54:34 2013, dfs@roaringpenguin.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; I cannot reproduce the problem.  Here&#39;s the output I get; what version
&gt; of MIME-tools and what platform are you testing on?
</div>
The system-installed Perl 5.12.4 on Mountain Lion.

I did a force install to clobber the existing MIME-tools installation and the problem went away.

I probably fiddled with something and temporarily sabotaged it.  Sorry for the noise.

Please reject this ticket.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1280282" href="/Public/Bug/Display.html?id=88872#txn-1280282">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;28&nbsp;10:50:07&nbsp;2013</span>
    <span class="description">dfs+pause [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1280282/678444/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/678444">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 54b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Rejecting ticket per request from original requestor.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1280285" href="/Public/Bug/Display.html?id=88872#txn-1280285">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;28&nbsp;10:50:08&nbsp;2013</span>
    <span class="description">dfs+pause [...] roaringpenguin.com -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.426027</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
