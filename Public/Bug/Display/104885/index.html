<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #104885 for rpm-build-perl: FTBFS with perl 5.22</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #104885 for rpm-build-perl: FTBFS with perl 5.22</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/rpm-build-perl/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/rpm-build-perl/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/rpm-build-perl/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/rpm-build-perl/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/rpm-build-perl">rpm-build-perl CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">104885</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/rpm-build-perl/Active/">rpm-build-perl</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
gregoa [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-28030-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-28031-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;02&nbsp;16:33:11&nbsp;2015</span>
    <span class="description">gregoa [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> gregoa [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FTBFS with perl 5.22</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">We have the following bug reported to the Debian package of
rpm-build-perl &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://bugs.debian.org/787461&#41;">https://bugs.debian.org/787461&#41;</a></span>:

It doesn&#39;t seem to be a bug in the packaging, so you may want to take
a look. Thanks!

------8&lt;-----------8&lt;-----------8&lt;-----------8&lt;-----------8&lt;-----

Source: libb-perlreq-perl
Version: 0.82-3
Severity: important
User: debian-perl@lists.debian.org
Usertags: perl-5.22-transition

This package FTBFS with perl 5.22:

PERL_DL_NONLAZY=1 &#34;/usr/bin/perl&#34; &#34;-MExtUtils::Command::MM&#34; &#34;-MTest::Harness&#34; &#34;-e&#34; &#34;undef *Test::Harness::Switches; test_harness&#40;1, &#39;blib/lib&#39;, &#39;blib/arch&#39;&#41;&#34; t/*.t
dying at -e line 1
 at /Â«PKGBUILDDIRÂ»/blib/lib/B/PerlReq.pm line 388.
        B::PerlReq::__ANON__&#40;&#34;Can&#39;t locate object method \&#34;sv\&#34; via package \&#34;B::METHOP\&#34; at /b&#34;...&#41; called at /Â«PKGBUILDDIRÂ»/blib/lib/B/Walker.pm line 25
        B::Walker::const_sv&#40;B::METHOP=SCALAR&#40;0xdec5e8&#41;&#41; called at /Â«PKGBUILDDIRÂ»/blib/lib/B/PerlReq.pm line 307
        B::PerlReq::grok_entersub&#40;B::UNOP=SCALAR&#40;0xdec5b8&#41;&#41; called at /Â«PKGBUILDDIRÂ»/blib/lib/B/Walker.pm line 56
        B::Walker::walk_root&#40;B::UNOP=SCALAR&#40;0xdec5b8&#41;&#41; called at /Â«PKGBUILDDIRÂ»/blib/lib/B/Walker.pm line 65
        B::Walker::walk_root&#40;B::LISTOP=SCALAR&#40;0xdec528&#41;&#41; called at /Â«PKGBUILDDIRÂ»/blib/lib/B/Walker.pm line 65
        B::Walker::walk_root&#40;B::LISTOP=SCALAR&#40;0xd00550&#41;&#41; called at /Â«PKGBUILDDIRÂ»/blib/lib/B/Walker.pm line 65
        B::Walker::walk_root&#40;B::UNOP=SCALAR&#40;0xd00778&#41;&#41; called at /Â«PKGBUILDDIRÂ»/blib/lib/B/Walker.pm line 91
        B::Walker::walk_cv&#40;B::CV=SCALAR&#40;0xe01830&#41;&#41; called at /Â«PKGBUILDDIRÂ»/blib/lib/B/Walker.pm line 77
        B::Walker::walk_av&#40;&#34;BEGIN&#34;, B::AV=SCALAR&#40;0xaf21f8&#41;&#41; called at /Â«PKGBUILDDIRÂ»/blib/lib/B/Walker.pm line 97
        B::Walker::walk_blocks&#40;&#41; called at /Â«PKGBUILDDIRÂ»/blib/lib/B/PerlReq.pm line 390
        B::PerlReq::__ANON__&#40;&#41; called at &#40;eval 2&#41; line 31
        O::CHECK&#40;&#41; called at -e line 0
        eval {...} called at -e line 0
Can&#39;t locate object method &#34;sv&#34; via package &#34;B::METHOP&#34; at /Â«PKGBUILDDIRÂ»/blib/lib/B/Walker.pm line 25.
CHECK failed--call queue aborted.

dying at -e line 1

...

Test Summary Report
-------------------
t/01-B-PerlReq.t &#40;Wstat: 9984 Tests: 78 Failed: 39&#41;
  Failed tests:  1, 4, 20-48, 52-56, 74, 77-78
  Non-zero exit status: 39
t/02-perlreq.t  &#40;Wstat: 256 Tests: 4 Failed: 1&#41;
  Failed test:  2
  Non-zero exit status: 1
Files=3, Tests=112,  8 wallclock secs &#40; 0.06 usr  0.02 sys +  5.34 cusr  1.02 csys =  6.44 CPU&#41;
Result: FAIL

Cheers,
Dominic.


------8&lt;-----------8&lt;-----------8&lt;-----------8&lt;-----------8&lt;-----


Thanks for considering,
  gregor herrmann,
  Debian Perl Group
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;16&nbsp;09:06:33&nbsp;2015</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Út 02.čen.2015 16:33:11, GREGOA napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This package FTBFS with perl 5.22:
&gt; 
&gt; PERL_DL_NONLAZY=1 &#34;/usr/bin/perl&#34; &#34;-MExtUtils::Command::MM&#34; &#34;-
&gt; MTest::Harness&#34; &#34;-e&#34; &#34;undef *Test::Harness::Switches; test_harness&#40;1,
&gt; &#39;blib/lib&#39;, &#39;blib/arch&#39;&#41;&#34; t/*.t
&gt; dying at -e line 1
&gt;  at /Â«PKGBUILDDIRÂ»/blib/lib/B/PerlReq.pm line 388.
&gt;         B::PerlReq::__ANON__&#40;&#34;Can&#39;t locate object method \&#34;sv\&#34; via
&gt; package \&#34;B::METHOP\&#34; at /b&#34;...&#41; called at
&gt; /Â«PKGBUILDDIRÂ»/blib/lib/B/Walker.pm line 25
&gt;         B::Walker::const_sv&#40;B::METHOP=SCALAR&#40;0xdec5e8&#41;&#41; called at
&gt; /Â«PKGBUILDDIRÂ»/blib/lib/B/PerlReq.pm line 307
&gt;         B::PerlReq::grok_entersub&#40;B::UNOP=SCALAR&#40;0xdec5b8&#41;&#41; called at
&gt; /Â«PKGBUILDDIRÂ»/blib/lib/B/Walker.pm line 56
&gt;         B::Walker::walk_root&#40;B::UNOP=SCALAR&#40;0xdec5b8&#41;&#41; called at
&gt; /Â«PKGBUILDDIRÂ»/blib/lib/B/Walker.pm line 65
&gt;         B::Walker::walk_root&#40;B::LISTOP=SCALAR&#40;0xdec528&#41;&#41; called at
&gt; /Â«PKGBUILDDIRÂ»/blib/lib/B/Walker.pm line 65
&gt;         B::Walker::walk_root&#40;B::LISTOP=SCALAR&#40;0xd00550&#41;&#41; called at
&gt; /Â«PKGBUILDDIRÂ»/blib/lib/B/Walker.pm line 65
&gt;         B::Walker::walk_root&#40;B::UNOP=SCALAR&#40;0xd00778&#41;&#41; called at
&gt; /Â«PKGBUILDDIRÂ»/blib/lib/B/Walker.pm line 91
&gt;         B::Walker::walk_cv&#40;B::CV=SCALAR&#40;0xe01830&#41;&#41; called at
&gt; /Â«PKGBUILDDIRÂ»/blib/lib/B/Walker.pm line 77
&gt;         B::Walker::walk_av&#40;&#34;BEGIN&#34;, B::AV=SCALAR&#40;0xaf21f8&#41;&#41; called at
&gt; /Â«PKGBUILDDIRÂ»/blib/lib/B/Walker.pm line 97
&gt;         B::Walker::walk_blocks&#40;&#41; called at
&gt; /Â«PKGBUILDDIRÂ»/blib/lib/B/PerlReq.pm line 390
&gt;         B::PerlReq::__ANON__&#40;&#41; called at &#40;eval 2&#41; line 31
&gt;         O::CHECK&#40;&#41; called at -e line 0
&gt;         eval {...} called at -e line 0
&gt; Can&#39;t locate object method &#34;sv&#34; via package &#34;B::METHOP&#34; at
&gt; /Â«PKGBUILDDIRÂ»/blib/lib/B/Walker.pm line 25.
&gt; CHECK failed--call queue aborted.
&gt; 
</div>Simple reproducer is:

$ perl -Iblib/{arch,lib} -Mblib -MO=PerlReq -e &#39;use Data::Dumper&#39;

This is caused by this perl commit:

commit b46e009d94293e069270690750f6c669c6d0ce22
Author: syber &lt;syber@crazypanda.ru&gt;
Date:   Thu Sep 4 22:08:59 2014 +0400

    Make OP_METHOD* to be of new class METHOP
    
    Introduce a new opcode class, METHOP, which will hold class/method related
    info needed at runtime to improve performance of class/object method
    calls, then change OP_METHOD and OP_METHOD_NAMED from being UNOP/SVOP to
    being METHOP.
    
    Note that because OP_METHOD is a UNOP with an op_first, while
    OP_METHOD_NAMED is an SVOP, the first field of the METHOP structure
    is a union holding either op_first or op_sv. This was seen as less messy
    than having to introduce two new op classes.
    
    The new op class&#39;s character is &#39;.&#39;
    
    Nothing has changed in functionality and/or performance by this commit.
    It just introduces new structure which will be extended with extra
    fields and used in later commits.
    
    Added METHOP constructors:
    - newMETHOP&#40;&#41; for method ops with dynamic method names.
      The only optype for this op is OP_METHOD.
    - newMETHOP_named&#40;&#41; for method ops with constant method names.
      Optypes for this op are: OP_METHOD_NAMED &#40;currently&#41; and &#40;later&#41;
      OP_METHOD_SUPER, OP_METHOD_REDIR, OP_METHOD_NEXT, OP_METHOD_NEXTCAN,
      OP_METHOD_MAYBENEXT
    
    &#40;This commit includes fixups by davem&#41;

And indeed the first encountered B::METHOP object with perl-5.22 was B::SVOP with perl-5.18.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;16&nbsp;09:06:34&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;16&nbsp;12:02:35&nbsp;2015</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Út 02.čen.2015 16:33:11, GREGOA napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This package FTBFS with perl 5.22:
&gt; 
</div>And there is another change for anoncode using srefgen now. See this perl commit:

commit 01762542fcff2d3eb5e0fd287f28e872a0cfd5a4
Author: Father Chrysostomos &lt;sprout@cpan.org&gt;
Date:   Sat Oct 18 10:23:26 2014 -0700

    Use srefgen for anoncode
    
    srefgen is faster than refgen, since it doesn’t have to loop through
    the arguments &#40;there is only one&#41; and there is no pushmark to execute.
    
    OA_RETSCALAR causes scalar context to be applied to anoncode ops, but
    it always returns one item anyway, so that causes no problems.


and similar commits mentioning the srefgen. This causes failures on &#39;use Try::Tiny; try { require Foo } catch { require Bar }&#39; code because it cannot find the try block.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;16&nbsp;12:34:28&nbsp;2015</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Út 02.čen.2015 16:33:11, GREGOA napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This package FTBFS with perl 5.22:
&gt; 
</div>Attached patch makes changes needed for perl 5.22.

-- Petr
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rpm-build-perl-0.82-Adjust-to-perl-5.22.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From fc37d660dd918997669ef2c24cf4098104c6eb89 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Tue, 16 Jun 2015 18:20:20 +0200
Subject: [PATCH] Adjust to perl-5.22
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Perl 5.22 brought changes in class/method opcodes, see perl commit

commit b46e009d94293e069270690750f6c669c6d0ce22
Author: syber &lt;syber@crazypanda.ru&gt;
Date: Thu Sep 4 22:08:59 2014 +0400

    Make OP_METHOD* to be of new class METHOP

and optimizations in anoncode, see perl commit

commit 01762542fcff2d3eb5e0fd287f28e872a0cfd5a4
Author: Father Chrysostomos &lt;sprout@cpan.org&gt;
Date: Sat Oct 18 10:23:26 2014 -0700

    Use srefgen for anoncode

This patch implements the changes to make tests passing with perl
5.22. It does not aim for backward compatibility.

CPAN RT#104885

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 lib/B/PerlReq.pm | 14 ++++++++++----
 lib/B/Walker.pm  |  9 ++++++++-
 2 files changed, 18 insertions&#40;+&#41;, 5 deletions&#40;-&#41;

diff --git a/lib/B/PerlReq.pm b/lib/B/PerlReq.pm
index 303454f..b852f83 100644
--- a/lib/B/PerlReq.pm
+++ b/lib/B/PerlReq.pm
@@ -44,7 +44,7 @@ our @Skip = &#40;
 
 our &#40;$Strict, $Relaxed, $Verbose, $Debug&#41;;
 
-use B::Walker qw&#40;const_sv&#41;;
+use B::Walker qw&#40;const_methop const_sv&#41;;
 
 sub RequiresPerl &#40;$&#41; {
 	my $v = shift;
@@ -273,8 +273,8 @@ my %TryCV;
 sub grok_try {
 	return unless $INC{&#34;Try/Tiny.pm&#34;};
 	my &#40;undef, $op&#41; = @_;
-	return unless $op-&gt;name eq &#34;refgen&#34;;
-	$op = $op-&gt;first-&gt;first-&gt;sibling;
+	return unless $op-&gt;name eq &#34;srefgen&#34;;
+	$op = $op-&gt;first-&gt;first;
 	return unless $op-&gt;name eq &#34;anoncode&#34;;
 	my $cv = padval&#40;$op-&gt;targ&#41;;
 	$TryCV{$$cv} = 1;
@@ -304,7 +304,13 @@ sub grok_entersub &#40;$&#41; {
 		$op = $op-&gt;sibling;
 	}
 	if &#40;$op-&gt;name eq &#34;method_named&#34;&#41; {
-		my $method = const_sv&#40;$op&#41;-&gt;PV;
+		my $method;
+		if &#40;ref&#40;$op&#41; eq &#39;B::METHOP&#39;&#41; {
+			$method = const_methop&#40;$op&#41;;
+		} else {
+			$method = const_sv&#40;$op&#41;;
+		}
+		$method = $method-&gt;PV;
 		return unless $methods{$method};
 		return unless $args-&gt;name eq &#34;const&#34;;
 		my $sv = const_sv&#40;$args&#41;;
diff --git a/lib/B/Walker.pm b/lib/B/Walker.pm
index b71f204..9e3083c 100644
--- a/lib/B/Walker.pm
+++ b/lib/B/Walker.pm
@@ -6,7 +6,7 @@ use strict;
 
 require Exporter;
 our @ISA = qw&#40;Exporter&#41;;
-our @EXPORT_OK = qw&#40;padname padval const_sv walk&#41;;
+our @EXPORT_OK = qw&#40;padname padval const_methop const_sv walk&#41;;
 
 our $CV;
 
@@ -27,6 +27,13 @@ sub const_sv &#40;$&#41; {
 	return $sv;
 }
 
+sub const_methop &#40;$&#41; {
+	my $op = shift;
+	my $sv = $op-&gt;meth_sv;
+	$sv = padval&#40;$op-&gt;targ&#41; unless $$sv;
+	return $sv;
+}
+
 our $Level = 0;
 our $Line;
 our $Sub;
-- 
2.1.0

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;17&nbsp;01:08:53&nbsp;2015</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Út 16.čen.2015 12:34:28, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne Út 02.čen.2015 16:33:11, GREGOA napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; This package FTBFS with perl 5.22:
&gt; &gt; 
</div>&gt; Attached patch makes changes needed for perl 5.22.
&gt; 
</div>This patch replacing the previous one is also compatible with older perls.

-- Petr
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rpm-build-perl-0.82-Adjust-to-perl-5.22.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 7d2911bc4694b272b1ed116bb7c87de644e8e1a0 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Tue, 16 Jun 2015 18:20:20 +0200
Subject: [PATCH] Adjust to perl-5.22
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Perl 5.22 brought changes in class/method opcodes, see perl commit

commit b46e009d94293e069270690750f6c669c6d0ce22
Author: syber &lt;syber@crazypanda.ru&gt;
Date: Thu Sep 4 22:08:59 2014 +0400

    Make OP_METHOD* to be of new class METHOP

and optimizations in anoncode, see perl commit

commit 01762542fcff2d3eb5e0fd287f28e872a0cfd5a4
Author: Father Chrysostomos &lt;sprout@cpan.org&gt;
Date: Sat Oct 18 10:23:26 2014 -0700

    Use srefgen for anoncode

This patch implements the changes to make tests passing with perl
5.22 and previous versions too.

CPAN RT#104885

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 lib/B/PerlReq.pm | 19 +++++++++++++++----
 lib/B/Walker.pm  |  9 ++++++++-
 2 files changed, 23 insertions&#40;+&#41;, 5 deletions&#40;-&#41;

diff --git a/lib/B/PerlReq.pm b/lib/B/PerlReq.pm
index 303454f..4527b2b 100644
--- a/lib/B/PerlReq.pm
+++ b/lib/B/PerlReq.pm
@@ -44,7 +44,7 @@ our @Skip = &#40;
 
 our &#40;$Strict, $Relaxed, $Verbose, $Debug&#41;;
 
-use B::Walker qw&#40;const_sv&#41;;
+use B::Walker qw&#40;const_methop const_sv&#41;;
 
 sub RequiresPerl &#40;$&#41; {
 	my $v = shift;
@@ -273,8 +273,13 @@ my %TryCV;
 sub grok_try {
 	return unless $INC{&#34;Try/Tiny.pm&#34;};
 	my &#40;undef, $op&#41; = @_;
-	return unless $op-&gt;name eq &#34;refgen&#34;;
-	$op = $op-&gt;first-&gt;first-&gt;sibling;
+	if &#40;$op-&gt;name eq &#34;srefgen&#34;&#41; {
+		$op = $op-&gt;first-&gt;first;
+	} elsif &#40;$op-&gt;name eq &#34;refgen&#34;&#41; {
+		$op = $op-&gt;first-&gt;first-&gt;sibling;
+	} else {
+		return;
+	}
 	return unless $op-&gt;name eq &#34;anoncode&#34;;
 	my $cv = padval&#40;$op-&gt;targ&#41;;
 	$TryCV{$$cv} = 1;
@@ -304,7 +309,13 @@ sub grok_entersub &#40;$&#41; {
 		$op = $op-&gt;sibling;
 	}
 	if &#40;$op-&gt;name eq &#34;method_named&#34;&#41; {
-		my $method = const_sv&#40;$op&#41;-&gt;PV;
+		my $method;
+		if &#40;ref&#40;$op&#41; eq &#39;B::METHOP&#39;&#41; {
+			$method = const_methop&#40;$op&#41;;
+		} else {
+			$method = const_sv&#40;$op&#41;;
+		}
+		$method = $method-&gt;PV;
 		return unless $methods{$method};
 		return unless $args-&gt;name eq &#34;const&#34;;
 		my $sv = const_sv&#40;$args&#41;;
diff --git a/lib/B/Walker.pm b/lib/B/Walker.pm
index b71f204..9e3083c 100644
--- a/lib/B/Walker.pm
+++ b/lib/B/Walker.pm
@@ -6,7 +6,7 @@ use strict;
 
 require Exporter;
 our @ISA = qw&#40;Exporter&#41;;
-our @EXPORT_OK = qw&#40;padname padval const_sv walk&#41;;
+our @EXPORT_OK = qw&#40;padname padval const_methop const_sv walk&#41;;
 
 our $CV;
 
@@ -27,6 +27,13 @@ sub const_sv &#40;$&#41; {
 	return $sv;
 }
 
+sub const_methop &#40;$&#41; {
+	my $op = shift;
+	my $sv = $op-&gt;meth_sv;
+	$sv = padval&#40;$op-&gt;targ&#41; unless $$sv;
+	return $sv;
+}
+
 our $Level = 0;
 our $Line;
 our $Sub;
-- 
2.1.0

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;17&nbsp;02:49:48&nbsp;2015</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Út 16.čen.2015 12:34:28, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne Út 02.čen.2015 16:33:11, GREGOA napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; This package FTBFS with perl 5.22:
&gt; &gt; 
</div>&gt; Attached patch makes changes needed for perl 5.22.
&gt; 
</div>The patch is not enough:

$ perl -MO=PerlReq -e &#39;sub foo{} foo&#39;
dying at -e line 1
 at /usr/lib64/perl5/vendor_perl/B/PerlReq.pm line 399.
        B::PerlReq::__ANON__&#40;&#34;Can&#39;t locate object method \&#34;NAME\&#34; via package \&#34;B::IV\&#34; at /usr&#34;...&#41; called at /usr/lib64/perl5/vendor_perl/B/PerlReq.pm line 330
        B::PerlReq::grok_entersub&#40;B::UNOP=SCALAR&#40;0x154c6a0&#41;&#41; called at /usr/lib64/perl5/vendor_perl/B/Walker.pm line 63
        B::Walker::walk_root&#40;B::UNOP=SCALAR&#40;0x154c6a0&#41;&#41; called at /usr/lib64/perl5/vendor_perl/B/Walker.pm line 72
        B::Walker::walk_root&#40;B::LISTOP=SCALAR&#40;0x154c778&#41;&#41; called at /usr/lib64/perl5/vendor_perl/B/Walker.pm line 112
        B::Walker::walk_main&#40;&#41; called at /usr/lib64/perl5/vendor_perl/B/PerlReq.pm line 402
        B::PerlReq::__ANON__&#40;&#41; called at &#40;eval 2&#41; line 31
        O::CHECK&#40;&#41; called at -e line 0
        eval {...} called at -e line 0
Can&#39;t locate object method &#34;NAME&#34; via package &#34;B::IV&#34; at /usr/lib64/perl5/vendor_perl/B/PerlReq.pm line 330.
CHECK failed--call queue aborted.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;17&nbsp;04:13:44&nbsp;2015</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne St 17.čen.2015 02:49:48, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne Út 16.čen.2015 12:34:28, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; Dne Út 02.čen.2015 16:33:11, GREGOA napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; &gt; This package FTBFS with perl 5.22:
&gt; &gt; &gt;
</div>&gt; &gt; Attached patch makes changes needed for perl 5.22.
&gt; &gt;
</div>&gt; The patch is not enough:
&gt; 
&gt; $ perl -MO=PerlReq -e &#39;sub foo{} foo&#39;
&gt; dying at -e line 1
&gt;  at /usr/lib64/perl5/vendor_perl/B/PerlReq.pm line 399.
&gt;         B::PerlReq::__ANON__&#40;&#34;Can&#39;t locate object method \&#34;NAME\&#34; via
&gt; package \&#34;B::IV\&#34; at /usr&#34;...&#41; called at
&gt; /usr/lib64/perl5/vendor_perl/B/PerlReq.pm line 330
&gt;
</div>Attached cumulative patch should fix it.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rpm-build-perl-0.82-Fix-non-deterministic-failures-on-newer-perls.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 428c3feac1e9c39f966cc66c36cc3881d202177c Mon Sep 17 00:00:00 2001
From: Niko Tyni &lt;ntyni@debian.org&gt;
Date: Sat, 18 May 2013 09:41:47 +0300
Subject: [PATCH] Fix non-deterministic failures on newer perls

The hash randomization changes in the Perl 5.17 series
made perl.req to occasionally fail to report the dependencies.

Improved diagnostics report

 Use of each&#40;&#41; on hash after insertion without resetting hash
 iterator results in undefined behavior, Perl interpreter: 0x9e7010 at
 /home/niko/tmp/libb-perlreq-perl-0.82/blib/lib/B/Walker.pm line 122.

so use keys&#40;&#41; instead of each&#40;&#41;, as suggested by perldiag.pod.
---
 lib/B/Walker.pm |    2 +-
 1 file changed, 1 insertion&#40;+&#41;, 1 deletion&#40;-&#41;

diff --git a/lib/B/Walker.pm b/lib/B/Walker.pm
index b71f204..f626043 100644
--- a/lib/B/Walker.pm
+++ b/lib/B/Walker.pm
@@ -119,7 +119,7 @@ sub walk_gv &#40;$&#41; {
 sub walk_stash &#40;$$&#41;;
 sub walk_stash &#40;$$&#41; { # similar to B::walksymtable
 	my &#40;$symref, $prefix&#41; = @_;
-	while &#40;my &#40;$sym&#41; = each %$symref&#41; {
+	for my $sym &#40;keys %$symref&#41; {
 		no strict &#39;refs&#39;;
 		my $fullname = &#34;*main::&#34;. $prefix . $sym;
 		if &#40;$sym =~ /::\z/&#41; {
-- 
1.7.10.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;17&nbsp;11:40:17&nbsp;2015</span>
    <span class="description">gregoa [...] debian.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #104885] FTBFS with perl 5.22</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 17 Jun 2015 17:39:49 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Petr Pisar via RT &lt;bug-rpm-build-perl [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> gregor herrmann &lt;gregoa [...] debian.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, 17 Jun 2015 04:13:45 -0400, Petr Pisar via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=104885">https://rt.cpan.org/Ticket/Display.html?id=104885</a></span> &gt;
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; This package FTBFS with perl 5.22:
</div>&gt; &gt; &gt; Attached patch makes changes needed for perl 5.22.
</div>&gt; &gt; The patch is not enough:
</div>&gt; Attached cumulative patch should fix it.
</div>
Hm, this is ntyni&#39;s &#34;old&#34; patch for perl 5.17+ from 2013.
Did you mean to attach a different patch?


Cheers,
gregor

-- 
 .&#39;&#39;`.  Homepage: <span class="clickylink"><a target="new" rel="nofollow" href="http://info.comodo.priv.at/">http://info.comodo.priv.at/</a></span> - OpenPGP key 0xBB3A68018649AA06
 : :&#39; : Debian GNU/Linux user, admin, and developer -  <span class="clickylink"><a target="new" rel="nofollow" href="https://www.debian.org/">https://www.debian.org/</a></span>
 `. `&#39;  Member of VIBE!AT &#38; SPI, fellow of the Free Software Foundation Europe
   `-   NP: Funny Van Dannen: Tütensuppen
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction other Forward Transaction even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;01&nbsp;14:06:22&nbsp;2015</span>
    <span class="description">gregoa [...] cpan.org -  Forwarded Transaction #1508905 to ppisar@redhat.com</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;02&nbsp;03:15:47&nbsp;2015</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne St 17.čen.2015 11:40:17, gregoa@debian.org napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed, 17 Jun 2015 04:13:45 -0400, Petr Pisar via RT wrote:
<div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; This package FTBFS with perl 5.22:
</div>&gt; &gt; &gt; &gt; Attached patch makes changes needed for perl 5.22.
</div>&gt; &gt; &gt; The patch is not enough:
</div>&gt; &gt; Attached cumulative patch should fix it.
</div>&gt; 
&gt; Hm, this is ntyni&#39;s &#34;old&#34; patch for perl 5.17+ from 2013.
&gt; Did you mean to attach a different patch?
&gt; 
</div>
You are right. I hope this attachment is the desired one.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rpm-build-perl-0.82-Adjust-to-perl-5.22.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From b73a37a7eb615693b5516068360f61d5b4e8f241 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Tue, 16 Jun 2015 18:20:20 +0200
Subject: [PATCH] Adjust to perl-5.22
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Perl 5.22 brought changes in class/method opcodes, see perl commit

commit b46e009d94293e069270690750f6c669c6d0ce22
Author: syber &lt;syber@crazypanda.ru&gt;
Date: Thu Sep 4 22:08:59 2014 +0400

    Make OP_METHOD* to be of new class METHOP

and optimizations in anoncode, see perl commit

commit 01762542fcff2d3eb5e0fd287f28e872a0cfd5a4
Author: Father Chrysostomos &lt;sprout@cpan.org&gt;
Date: Sat Oct 18 10:23:26 2014 -0700

    Use srefgen for anoncode

and GV to IV optimizations when calling some subroutines.

This patch implements the changes to make tests passing with perl
5.22 and previous versions too.

CPAN RT#104885

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 lib/B/PerlReq.pm | 24 +++++++++++++++++++-----
 lib/B/Walker.pm  |  9 ++++++++-
 t/01-B-PerlReq.t |  3 +++
 3 files changed, 30 insertions&#40;+&#41;, 6 deletions&#40;-&#41;

diff --git a/lib/B/PerlReq.pm b/lib/B/PerlReq.pm
index 303454f..2e2a2ba 100644
--- a/lib/B/PerlReq.pm
+++ b/lib/B/PerlReq.pm
@@ -44,7 +44,7 @@ our @Skip = &#40;
 
 our &#40;$Strict, $Relaxed, $Verbose, $Debug&#41;;
 
-use B::Walker qw&#40;const_sv&#41;;
+use B::Walker qw&#40;const_methop const_sv&#41;;
 
 sub RequiresPerl &#40;$&#41; {
 	my $v = shift;
@@ -273,8 +273,13 @@ my %TryCV;
 sub grok_try {
 	return unless $INC{&#34;Try/Tiny.pm&#34;};
 	my &#40;undef, $op&#41; = @_;
-	return unless $op-&gt;name eq &#34;refgen&#34;;
-	$op = $op-&gt;first-&gt;first-&gt;sibling;
+	if &#40;$op-&gt;name eq &#34;srefgen&#34;&#41; {
+		$op = $op-&gt;first-&gt;first;
+	} elsif &#40;$op-&gt;name eq &#34;refgen&#34;&#41; {
+		$op = $op-&gt;first-&gt;first-&gt;sibling;
+	} else {
+		return;
+	}
 	return unless $op-&gt;name eq &#34;anoncode&#34;;
 	my $cv = padval&#40;$op-&gt;targ&#41;;
 	$TryCV{$$cv} = 1;
@@ -304,7 +309,13 @@ sub grok_entersub &#40;$&#41; {
 		$op = $op-&gt;sibling;
 	}
 	if &#40;$op-&gt;name eq &#34;method_named&#34;&#41; {
-		my $method = const_sv&#40;$op&#41;-&gt;PV;
+		my $method;
+		if &#40;ref&#40;$op&#41; eq &#39;B::METHOP&#39;&#41; {
+			$method = const_methop&#40;$op&#41;;
+		} else {
+			$method = const_sv&#40;$op&#41;;
+		}
+		$method = $method-&gt;PV;
 		return unless $methods{$method};
 		return unless $args-&gt;name eq &#34;const&#34;;
 		my $sv = const_sv&#40;$args&#41;;
@@ -316,7 +327,10 @@ sub grok_entersub &#40;$&#41; {
 	elsif &#40;$op-&gt;first-&gt;name eq &#34;gv&#34;&#41; {
 		$op = $op-&gt;first;
 		use B::Walker qw&#40;padval&#41;;
-		my $func = padval&#40;$op-&gt;padix&#41;-&gt;NAME;
+		my $padval = padval&#40;$op-&gt;padix&#41;;
+		# perl 5.22 sometimes optimizes to B::IV
+		return unless ref $padval eq &#39;B::GV&#39;;
+		my $func = $padval-&gt;NAME;
 		return unless $funcs{$func};
 		$funcs{$func}-&gt;&#40;$func, $args&#41;;
 	}
diff --git a/lib/B/Walker.pm b/lib/B/Walker.pm
index b71f204..9e3083c 100644
--- a/lib/B/Walker.pm
+++ b/lib/B/Walker.pm
@@ -6,7 +6,7 @@ use strict;
 
 require Exporter;
 our @ISA = qw&#40;Exporter&#41;;
-our @EXPORT_OK = qw&#40;padname padval const_sv walk&#41;;
+our @EXPORT_OK = qw&#40;padname padval const_methop const_sv walk&#41;;
 
 our $CV;
 
@@ -27,6 +27,13 @@ sub const_sv &#40;$&#41; {
 	return $sv;
 }
 
+sub const_methop &#40;$&#41; {
+	my $op = shift;
+	my $sv = $op-&gt;meth_sv;
+	$sv = padval&#40;$op-&gt;targ&#41; unless $$sv;
+	return $sv;
+}
+
 our $Level = 0;
 our $Line;
 our $Sub;
diff --git a/t/01-B-PerlReq.t b/t/01-B-PerlReq.t
index 7233cb6..6e02759 100644
--- a/t/01-B-PerlReq.t
+++ b/t/01-B-PerlReq.t
@@ -139,4 +139,7 @@ EOF
 
 cmp_ok &#34;perl&#40;Cwd.pm&#41; &gt;= 1.0&#34;,	&#34;eq&#34;, grok q&#40;use Cwd 0==0&#41;;
 
+# perl 5.22 sometimes optimizes to B::IV leading to crash
+cmp_ok &#34;$d&#34;, &#34;eq&#34;, grok qq&#40;sub foo{} foo; require $m;&#41;;
+
 #END { $? = 0; }
-- 
2.1.0

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;20&nbsp;16:38:48&nbsp;2015</span>
    <span class="description">gregoa [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks, this seems to work.

Cheers,
gregor
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
