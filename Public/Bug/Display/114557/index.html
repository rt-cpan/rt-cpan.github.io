<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #114557 for PerlIO-gzip: PerlIO::gzip and Parallel::ForkManager do not play nice together</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #114557 for PerlIO-gzip: PerlIO::gzip and Parallel::ForkManager do not play nice together</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/PerlIO-gzip/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/PerlIO-gzip/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/PerlIO-gzip/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/PerlIO-gzip/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/PerlIO-gzip">PerlIO-gzip CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">114557</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/PerlIO-gzip/Active/">PerlIO-gzip</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Pascal [...] rkfd.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-25450-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.19    </td>
  </tr>
  <tr id="CF-25451-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;21&nbsp;16:44:39&nbsp;2016</span>
    <span class="description">Pascal [...] rkfd.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> PerlIO::gzip and Parallel::ForkManager do not play nice together</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Please note that file reads are always done in the main thread below.  Although other threads are created, nothing is actually done in them.

I&#39;ve tried the below code on a couple different Linux boxes.  They all seem to get data corruption reading the index.  The below works fine if you un-rem the &#39;next&#39; &#40;disabling Parallel::ForkManager&#41; or gunzip the index beforehand and remove the &#39;:gzip&#39; &#40;disabling PerlIO::gzip&#41;.  Number of concurrent threads does not appear to matter.  The corruption appears to always start at about the same line number for each index, but at different line numbers for different indexes.  Running the same thing multiple times will sometimes yield the same exact corruption and sometimes not.  A couple indexes &#40;100K each&#41; you can test with: &lt;a href=&#34;https://aws-publicdatasets.s3.amazonaws.com/common-crawl/crawl-data/CC-MAIN-2015-27/wat.paths.gz&#34;&gt;2015-27&lt;/a&gt; &lt;a href=&#34;https://aws-publicdatasets.s3.amazonaws.com/common-crawl/crawl-data/CC-MAIN-2015-48/wat.paths.gz&#34;&gt;2015-48&lt;/a&gt;

#!/usr/bin/perl

use strict;
use warnings;

use Parallel::ForkManager;
use PerlIO::gzip;

my $pm = Parallel::ForkManager-&gt;new&#40;12&#41;;

open&#40;IN, &#39;&lt;:gzip&#39;, &#39;wat.paths.gz&#39;&#41; or die &#34;can&#39;t open index&#34;;
while &#40;my $file = &lt;IN&gt;&#41; {
    print length&#40;$file&#41; . &#34;:$file\n&#34; if length&#40;$file&#41; &gt; 142;
#next;
    next if $pm-&gt;start;
    $pm-&gt;finish;
}
close IN;
$pm-&gt;wait_all_children;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;21&nbsp;16:48:10&nbsp;2016</span>
    <span class="description">Pascal [...] rkfd.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Pascal [...] rkfd.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Matching Parallel::ForkManager bug: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dluxhu/perl-parallel-forkmanager/issues/11">https://github.com/dluxhu/perl-parallel-forkmanager/issues/11</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;09&nbsp;15:15:28&nbsp;2016</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2016-05-21 16:48:10, Pascal@rkfd.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Matching Parallel::ForkManager bug: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dluxhu/perl-">https://github.com/dluxhu/perl-</a></span>
&gt; parallel-forkmanager/issues/11
</div>
A minimal test setup without Parallel::ForkManager:

First create a gzipped file with sequential numbers:

    perl -e &#39;for&#40;1..100000&#41;{print &#34;$_\n&#34;}&#39; | gzip &gt; /tmp/test.gz 

Run the following modified test script, now doing only a single fork:

#!/usr/bin/perl

use strict;
use warnings;

use PerlIO::gzip;

my $forked;

open&#40;IN, &#39;&lt;:gzip&#39;, &#39;/tmp/test.gz&#39;&#41; or die &#34;can&#39;t open index&#34;;
while &#40;my $line = &lt;IN&gt;&#41; {
    print STDERR $line;
    if &#40;!$forked&#41; {
        if &#40;fork == 0&#41; {
            exit;
            #require POSIX; POSIX::_exit&#40;0&#41;;
        }
        $forked = 1;
    }
}
close IN;

__END__

On my system, the corruption starts at line 3493. Looking in a strace log, this is the point when the 2nd read on the gzipped stream happens.

There&#39;s no problem if POSIX::_exit&#40;&#41; is used instead of perl&#39;s exit&#40;&#41;. So it could be that somehow the global object destruction &#40;which is skipped when POSIX::_exit is used&#41; is causing the problem.

Regards,
    Slaven
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;09&nbsp;15:15:28&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;09&nbsp;16:49:02&nbsp;2016</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2016-05-21 16:44:39, Pascal@rkfd.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please note that file reads are always done in the main thread below.
&gt; Although other threads are created, nothing is actually done in them.
&gt; 
&gt; I&#39;ve tried the below code on a couple different Linux boxes.  They all
&gt; seem to get data corruption reading the index.  The below works fine
&gt; if you un-rem the &#39;next&#39; &#40;disabling Parallel::ForkManager&#41; or gunzip
&gt; the index beforehand and remove the &#39;:gzip&#39; &#40;disabling PerlIO::gzip&#41;.
&gt; Number of concurrent threads does not appear to matter.  The
&gt; corruption appears to always start at about the same line number for
&gt; each index, but at different line numbers for different indexes.
&gt; Running the same thing multiple times will sometimes yield the same
&gt; exact corruption and sometimes not.  A couple indexes &#40;100K each&#41; you
&gt; can test with: &lt;a href=&#34;https://aws-
&gt; publicdatasets.s3.amazonaws.com/common-crawl/crawl-data/CC-MAIN-2015-
&gt; 27/wat.paths.gz&#34;&gt;2015-27&lt;/a&gt; &lt;a href=&#34;https://aws-
&gt; publicdatasets.s3.amazonaws.com/common-crawl/crawl-data/CC-MAIN-2015-
&gt; 48/wat.paths.gz&#34;&gt;2015-48&lt;/a&gt;
&gt; 
&gt; #!/usr/bin/perl
&gt; 
&gt; use strict;
&gt; use warnings;
&gt; 
&gt; use Parallel::ForkManager;
&gt; use PerlIO::gzip;
&gt; 
&gt; my $pm = Parallel::ForkManager-&gt;new&#40;12&#41;;
&gt; 
&gt; open&#40;IN, &#39;&lt;:gzip&#39;, &#39;wat.paths.gz&#39;&#41; or die &#34;can&#39;t open index&#34;;
&gt; while &#40;my $file = &lt;IN&gt;&#41; {
&gt;     print length&#40;$file&#41; . &#34;:$file\n&#34; if length&#40;$file&#41; &gt; 142;
&gt; #next;
&gt;     next if $pm-&gt;start;
&gt;     $pm-&gt;finish;
&gt; }
&gt; close IN;
&gt; $pm-&gt;wait_all_children;
</div>
Can you check if the problem goes away if you add the &#34;unix&#34; layer? 

    open&#40;IN, &#39;&lt;:unix:gzip&#39;, ...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;09&nbsp;17:53:06&nbsp;2016</span>
    <span class="description">Pascal [...] rkfd.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Pascal [...] rkfd.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jun 09 16:49:02 2016, SREZIC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Can you check if the problem goes away if you add the &#34;unix&#34; layer? 
&gt; 
&gt;     open&#40;IN, &#39;&lt;:unix:gzip&#39;, ...
</div>
Yes, that does appear to fix the problem I was having.  Thank you for looking into it.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
