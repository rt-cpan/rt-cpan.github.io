<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #28142 for Imager: new color counting code</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #28142 for Imager: new color counting code</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Imager/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Imager/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Imager/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Imager/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Imager">Imager CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">28142</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Imager/Active/">Imager</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">TONYC [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
TONYC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-16790-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.59    </td>
  </tr>
  <tr id="CF-16791-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;12&nbsp;21:15:43&nbsp;2007</span>
    <span class="description">TONYC [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> new color counting code</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 13 Jul 2007 11:15:06 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Imager [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> tonyc [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">----- Forwarded message from Gabriel Vasseur &lt;gvasseur@messagelabs.com&gt; -----

X-Spam-Checker-Version: SpamAssassin 3.1.7-deb &#40;2006-10-05&#41; on 
        develop-help.com
X-Spam-Level: 
X-VirusChecked: Checked
X-Env-Sender: gvasseur@messagelabs.com
X-Msg-Ref: server-19.tower-48.messagelabs.com!1184257965!3107438!1
X-StarScan-Version: 5.5.12.11; banners=messagelabs.com,-,-
X-Originating-IP: [62.231.131.6]
Date: Thu, 12 Jul 2007 17:32:38 +0100
From: Gabriel Vasseur &lt;gvasseur@messagelabs.com&gt;
To: tony@imager.perl.org
Subject: Re: Imager memory corruption bug
X-OriginalArrivalTime: 12 Jul 2007 16:32:42.0801 &#40;UTC&#41; FILETIME=[45322A10:01C7C4A2]

Hi Tony,

First to answer your last email: &#40;I know I&#39;m a bit late ;-&#41;

So are you saying that you&#39;ve patched the code to refuse to look up a 
colour in the palette if the colour index is outside the range of the 
palette, right?

What does it do if it finds something? It would be useful for me to have 
access to the information, something like &#34;N pixels had a colour index 
lying outside of the range of the palette&#34;.

Second thing is, no I don&#39;t have svn. I checked Imager-0.59, which was 
released recently &#40;I think after I contacted you?&#41;, but didn&#39;t see any 
change relative to the aforementioned problem, compared to version 0.58. 
In case I&#39;m confused, I would be grateful if you can enlighten me. 
Otherwise, can you send to me the actual code?

Third thing, I&#39;m proposing a modest contribution to Imager, that you&#39;ll 
find attached.

In two words, the changes are:

- a faster getcolorcount function &#40;at least it is on my system&#41;
- a new getcolorusagehash function &#40;entirely in perl, using already 
existing Imager tools, because that didn&#39;t happen to be much faster in 
C/XS anyway, I think because of the high volume of data to transfer from 
C to Perl&#41;.
- a new getcolorusage function which basically returns a sorted version 
of the values of the hash returned by getcolorusagehash, but it actually 
do the job in C, this time.

I tried to shape the code in a form that would be useful to you, but 
couldn&#39;t spend too much time on it either... I wrote a very short test 
script. Attached is also the output of a diff -r against Imager-0.59 
&#40;that contains comments that might be useful to figure out what does what&#41;.

It does require some work. You&#39;ll probably want to tidy the code, change 
the names &#40;I didn&#39;t try to figure out the naming convention&#41;, add safety 
checks, etc. I tried to use &#39;color&#39; and not &#39;colour&#39; but I&#39;m afraid I&#39;ve 
been a bit lazy once or twice... ;-&#41;

I hope you&#39;ll find that contribution more useful than bothering, though! 
Any feedback is welcome.

Sorry again if that&#39;s not in a format convenient for you... :-&#40;

Cheers,
Gabriel.



tony@imager.perl.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;On Thu, Jun 21, 2007 at 02:24:21PM +0100, Gabriel Vasseur wrote:
&gt;  
<div class="message-stanza open">&gt;&gt;Cool. Thanks for that.
&gt;&gt;
&gt;&gt;So the fact that it returned a &#34;random&#34; colour explains why the result 
&gt;&gt;would depend on the presence or absence of a line of code... I guess. 
&gt;&gt;Any idea why this instability would only happen in threadless perl? 
&gt;&gt;Maybe it&#39;s wasn&#39;t using the same part of the memory... Strange because 
&gt;&gt;it was quite reproducible. Anyway...
&gt;&gt;    
</div>&gt;
&gt;It was happening, though with less randomness, on both, since you were
&gt;getting 21 colours instead of 20.
&gt;
&gt;As to the variation between the two, they depend on how any previous
&gt;processing has modified the memory, which has presumably been freed
&gt;and then remalloced for use as the palette of the new image.
&gt;
&gt;I suspect if I&#39;d run it under valgrind, I would have seen it complain
&gt;about using uninitialized values.
&gt;
&gt;If you have subversion, you can checkout the fixed version with:
&gt;
&gt;  svn co <span class="clickylink"><a target="new" rel="nofollow" href="http://imager.perl.org/svn/trunk/Imager/">http://imager.perl.org/svn/trunk/Imager/</a></span>
&gt;
&gt;Tony
&gt;
&gt;______________________________________________________________________
&gt;This email has been scanned by the MessageLabs Email Security System.
&gt;For more information please visit <span class="clickylink"><a target="new" rel="nofollow" href="http://www.messagelabs.com/email">http://www.messagelabs.com/email</a></span> 
&gt;______________________________________________________________________
&gt;  
</div>

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">______________________________________________________________________
This email has been scanned by the MessageLabs Email Security System.
For more information please visit <span class="clickylink"><a target="new" rel="nofollow" href="http://www.messagelabs.com/email">http://www.messagelabs.com/email</a></span> 
<div class="message-stanza open">______________________________________________________________________

diff -r Imager-0.59/datatypes.c Imager-0.60/datatypes.c
219c219,220
&lt;   int ci,idx[8];
---
<div class="message-stanza open">&gt;   int ci;
&gt;   /* int idx[8]; */   /* Useless because not used */
</div>224c225
&lt;   ct-&gt;cnt++;
---
<div class="message-stanza open">&gt;   /* ct-&gt;cnt++; */    /* I think this was useless */
</div>231,232c232,233
&lt;     c-&gt;cnt++;
&lt;     idx[i]=ci;
---
<div class="message-stanza open">&gt;     /* c-&gt;cnt++; */  /* I think this was useless */
&gt;     /* idx[i]=ci; */ /* Useless because not used */
</div>233a235
<div class="message-stanza open">&gt;   c-&gt;cnt++;  /* New. The only thing really needed &#40;I think&#41; */
</div>269a272,290
<div class="message-stanza open">&gt; 
&gt; /* This whole function is new */
&gt; /* walk through the tree and for each colour, store its seen count in the
&gt;    space pointed by *col_usage_it_adr */
&gt; void
&gt; octt_histo&#40;struct octt *ct, unsigned int **col_usage_it_adr&#41; {
&gt;     int i,c;
&gt;     c = 0;
&gt;     for&#40;i = 0; i &lt; 8; i++&#41; 
&gt;         if &#40;ct-&gt;t[i] != NULL&#41; { 
&gt;             octt_histo&#40;ct-&gt;t[i], col_usage_it_adr&#41;;
&gt;             c++;
&gt;         }
&gt;     if &#40;!c&#41; {
&gt;         *&#40;*col_usage_it_adr&#41;++ = ct-&gt;cnt;
&gt;     }
&gt; }
&gt; 
&gt; 
</div>diff -r Imager-0.59/image.c Imager-0.60/image.c
1223a1224,1225
<div class="message-stanza open">&gt; /* This function has been changed and is now faster. It&#39;s using
&gt;  * i_gsamp instead of i_gpix */
</div>1228,1229d1229
&lt;   int xsize,ysize;
&lt;   i_color val;
1230a1231,1232
<div class="message-stanza open">&gt;   int maxc = 10000000;
&gt;   i_sample_t * samp;
</div>1232,1242c1234,1251
&lt;   mm_log&#40;&#40;1,&#34;i_count_colors&#40;im 0x%08X,maxc %d&#41;\n&#34;&#41;&#41;;
&lt; 
&lt;   xsize=im-&gt;xsize; 
&lt;   ysize=im-&gt;ysize;
&lt;   ct=octt_new&#40;&#41;;
&lt;  
&lt;   colorcnt=0;
&lt;   for&#40;y=0;y&lt;ysize;y++&#41; for&#40;x=0;x&lt;xsize;x++&#41; {
&lt;     i_gpix&#40;im,x,y,&#38;val&#41;;
&lt;     colorcnt+=octt_add&#40;ct,val.rgb.r,val.rgb.g,val.rgb.b&#41;;
&lt;     if &#40;colorcnt &gt; maxc&#41; { octt_delete&#40;ct&#41;; return -1; }
---
<div class="message-stanza open">&gt;   int xsize = im-&gt;xsize; 
&gt;   int ysize = im-&gt;ysize;
&gt;   int samp_cnt = 3 * xsize;
&gt;   ct = octt_new&#40;&#41;;
&gt; 
&gt;   samp = &#40;i_sample_t *&#41; mymalloc&#40; xsize * 3 * sizeof&#40;i_sample_t&#41;&#41;;
&gt; 
&gt;   colorcnt = 0;
&gt;   for&#40;y = 0; y &lt; ysize; &#41; {
&gt;       i_gsamp&#40;im, 0, xsize, y++, samp, NULL, 3&#41;;
&gt;       for&#40;x = 0; x &lt; samp_cnt; &#41; {
&gt;           colorcnt += octt_add&#40;ct, samp[x], samp[x+1], samp[x+2]&#41;;
&gt;           x += 3;
&gt;           if &#40;colorcnt &gt; maxc&#41; { 
&gt;               octt_delete&#40;ct&#41;; 
&gt;               return -1; 
&gt;           }
&gt;       }
</div>1243a1253
<div class="message-stanza open">&gt;   myfree&#40;samp&#41;;
</div>1247a1258,1343
<div class="message-stanza open">&gt; /* sorts the array ra[0..n-1] into increasing order using heapsort algorithm 
&gt;  * &#40;adapted from the Numerical Recipes&#41;
&gt;  */
&gt; /* Needed by get_anonymous_color_histo */
&gt; void hpsort&#40;unsigned int n, int *ra&#41; {
&gt;     unsigned int i,
&gt;                  ir,
&gt;                  j,
&gt;                  l, 
&gt;                  rra;
&gt; 
&gt;     if &#40;n &lt; 2&#41; return;
&gt;     l = n &gt;&gt; 1;
&gt;     ir = n - 1;
&gt;     for&#40;;;&#41; {
&gt;         if &#40;l &gt; 0&#41; {
&gt;             rra = ra[--l];
&gt;         }
&gt;         else {
&gt;             rra = ra[ir];
&gt;             ra[ir] = ra[0];
&gt;             if &#40;--ir == 0&#41; {
&gt;                 ra[0] = rra;
&gt;                 break;
&gt;             }
&gt;         }
&gt;         i = l;
&gt;         j = 2 * l + 1;
&gt;         while &#40;j &lt;= ir&#41; {
&gt;             if &#40;j &lt; ir &#38;&#38; ra[j] &lt; ra[j+1]&#41; j++;
&gt;             if &#40;rra &lt; ra[j]&#41; {
&gt;                 ra[i] = ra[j];
&gt;                 i = j;
&gt;                 j++; j &lt;&lt;= 1; j--;
&gt;             }
&gt;             else break;
&gt;         }
&gt;         ra[i] = rra;
&gt;     }
&gt; }
&gt; 
&gt; /* This function constructs an ordered list which represents how much the
&gt;  * different colors are used. So for instance &#40;100, 100, 500&#41; means that one
&gt;  * color is used for 500 pixels, another for 100 pixels and another for 100
&gt;  * pixels. It&#39;s tuned for performance. You might not like the way I&#39;ve hardcoded
&gt;  * the maxc ;-&#41; and you might want to change the name... */
&gt; /* Uses octt_histo */
&gt; int
&gt; get_anonymous_color_histo&#40;i_img *im, unsigned int **col_usage&#41; {
&gt;     struct octt *ct;
&gt;     int x,y,i;
&gt;     int colorcnt;
&gt;     int maxc = 10000000;
&gt;     unsigned int *col_usage_it;
&gt;     i_sample_t * samp;
&gt; 
&gt;     int xsize = im-&gt;xsize; 
&gt;     int ysize = im-&gt;ysize;
&gt;     int samp_cnt = 3 * xsize;
&gt;     ct = octt_new&#40;&#41;;
&gt; 
&gt;     samp = &#40;i_sample_t *&#41; mymalloc&#40; xsize * 3 * sizeof&#40;i_sample_t&#41;&#41;;
&gt; 
&gt;     colorcnt = 0;
&gt;     for&#40;y = 0; y &lt; ysize; &#41; {
&gt;         i_gsamp&#40;im, 0, xsize, y++, samp, NULL, 3&#41;;
&gt;         for&#40;x = 0; x &lt; samp_cnt; &#41; {
&gt;             colorcnt += octt_add&#40;ct, samp[x], samp[x+1], samp[x+2]&#41;;
&gt;             x += 3;
&gt;             if &#40;colorcnt &gt; maxc&#41; { 
&gt;                 octt_delete&#40;ct&#41;; 
&gt;                 return -1; 
&gt;             }
&gt;         }
&gt;     }
&gt;     myfree&#40;samp&#41;;
&gt;     /* Now that we know the number of colours... */
&gt;     col_usage_it = *col_usage = &#40;unsigned int *&#41; mymalloc&#40;colorcnt * 2 * sizeof&#40;unsigned int&#41;&#41;;
&gt;     octt_histo&#40;ct, &#38;col_usage_it&#41;;
&gt;     hpsort&#40;colorcnt, *col_usage&#41;;
&gt;     octt_delete&#40;ct&#41;;
&gt;     return colorcnt;
&gt; }
&gt; 
&gt; 
&gt; 
</div>diff -r Imager-0.59/Imager.pm Imager-0.60/Imager.pm
3281a3282,3308
<div class="message-stanza open">&gt; # Returns a reference to a hash. The keys are colour named &#40;packed&#41; and the
&gt; # values are the number of pixels in this colour.
&gt; sub getcolorusagehash {
&gt;     my $self = shift;
&gt;     my $channels= $self-&gt;getchannels;
&gt;     # We don&#39;t want to look at the alpha channel, because some gifs using it
&gt;     # doesn&#39;t define it for every colour &#40;but only for some&#41;
&gt;     $channels -= 1 if $channels == 2 or $channels == 4;
&gt;     my %colour_use;
&gt;     my $height = $self-&gt;getheight;
&gt;     for my $y &#40;0 .. $height - 1&#41; {
&gt;         my $colours = $self-&gt;getsamples&#40;y =&gt; $y, channels =&gt; [ 0 .. $channels - 1 ]&#41;;
&gt;         while &#40;length $colours&#41; {
&gt;             $colour_use{ substr&#40;$colours, 0, $channels, &#39;&#39;&#41; }++;
&gt;         }
&gt;     }
&gt;     return \%colour_use;
&gt; }
&gt; 
&gt; # This will return a ordered array of the colour usage. Kind of the sorted
&gt; # version of the values of the hash returned by getcolorusagehash.
&gt; # You might want to add safety checks and change the names, etc...
&gt; sub getcolorusage {
&gt;   my $self=shift;
&gt;   return get_anonymous_colour_usage &#40;$self&#41;;
&gt; }
&gt; 
</div>diff -r Imager-0.59/Imager.xs Imager-0.60/Imager.xs
2993a2994,3009
<div class="message-stanza open">&gt; void
&gt; get_anonymous_colour_usage&#40;Imager::ImgRaw im&#41;
&gt;     PPCODE:
&gt;         int i;
&gt;         unsigned int ** col_usage = &#40;unsigned int **&#41; mymalloc&#40;sizeof&#40;unsigned int *&#41;&#41;;
&gt;         unsigned int * p;
&gt;         int col_cnt = get_anonymous_color_histo&#40;im, col_usage&#41;;
&gt;         EXTEND&#40;SP, col_cnt&#41;;
&gt;         p = *col_usage;
&gt;         for &#40;i = 0; i &lt; col_cnt; &#41;  {
&gt;             PUSHs&#40;sv_2mortal&#40;newSViv&#40; p[i++]&#41;&#41;&#41;;
&gt;         }
&gt;         myfree&#40;p&#41;;
&gt;         myfree&#40;col_usage&#41;;
&gt;         XSRETURN&#40;col_cnt&#41;;
&gt; 
</div>Only in Imager-0.60/t: t999new.t



<div class="message-stanza open">----- End forwarded message -----
</div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;02&nbsp;23:31:27&nbsp;2007</span>
    <span class="description">TONYC [...] cpan.org -  Severity Normal added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;02&nbsp;23:31:27&nbsp;2007</span>
    <span class="description">TONYC [...] cpan.org -  Broken in 0.59 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;02&nbsp;23:31:35&nbsp;2007</span>
    <span class="description">TONYC [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;02&nbsp;23:31:41&nbsp;2007</span>
    <span class="description">TONYC [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;30&nbsp;04:18:49&nbsp;2007</span>
    <span class="description">TONYC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">applied in 0.60
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;30&nbsp;04:18:51&nbsp;2007</span>
    <span class="description">TONYC [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
