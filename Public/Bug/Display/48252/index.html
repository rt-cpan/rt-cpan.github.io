<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #48252 for XML-LibXML: $parser-&gt;expand_entities&#40;0&#41; allows entity expansion in findvalue&#40;&#41;, elsehwere?</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #48252 for XML-LibXML: $parser-&gt;expand_entities&#40;0&#41; allows entity expansion in findvalue&#40;&#41;, elsehwere?</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=XML-LibXML">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=XML-LibXML">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=XML-LibXML">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=XML-LibXML">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-LibXML">XML-LibXML CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">48252</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=XML-LibXML">XML-LibXML</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
RCAPUTO [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-37350-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.69_1    </td>
  </tr>
  <tr id="CF-37351-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=48252">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-640679" href="/Public/Bug/Display.html?id=48252#txn-640679">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;27&nbsp;18:42:29&nbsp;2009</span>
    <span class="description">RCAPUTO [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> $parser-&gt;expand_entities&#40;0&#41; allows entity expansion in
 findvalue&#40;&#41;, elsehwere?</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/640679/327396/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/327396">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The following malicious RSS exposes the contents of /etc/fstab despite
expand_entities&#40;0&#41; having been called.  $d-&gt;toString&#40;&#41; correctly leaves
the entity unexpanded, but $d-&gt;findvalue&#40;&#41; still expands external
entities.  The RSS example is based on this year-old article:
<span class="clickylink"><a target="new" rel="nofollow" href="http://searchsecuritychannel.techtarget.com/generic/0,295582,sid97_gci1304703,00.html">http://searchsecuritychannel.techtarget.com/generic/0,295582,sid97_gci1304703,00.html</a></span>

#!perl
 
use warnings;
use strict;
 
use XML::LibXML;
my $p = XML::LibXML-&gt;new&#40;&#41;;
 
$p-&gt;expand_entities&#40;0&#41;; 
$p-&gt;no_network&#40;1&#41;; 
 
my $d = $p-&gt;parse_string&#40;do { local $/; &lt;DATA&gt; }&#41;;
print $d-&gt;findvalue&#40;&#34;//description&#34;&#41;, &#34;\n&#34;;
exit;
 
__DATA__
&lt;?xml version=&#34;1.0&#34; encoding=&#34;ISO-8859-1&#34;?&gt;
&lt;!DOCTYPE foo [
&lt;!ENTITY fstab SYSTEM &#34;file:/etc/fstab&#34;&gt;
&lt;!ENTITY fstab2 SYSTEM &#34;file:///etc/fstab&#34;&gt;
]&gt;
&lt;rss version=&#34;2.0&#34;&gt;
&lt;channel&gt;
&lt;title&gt;My attack RSS feed showing /etc/fstab&lt;/title&gt;
&lt;description&gt;this is file:/etc/fstab: &#38;fstab; and this is
file:///etc/fstab: &#38;fstab;&lt;/description&gt;
&lt;item&gt;
&lt;title&gt;/etc/fstab&lt;/title&gt;
&lt;description&gt;file:/etc/fstab: &#38;fstab; file:///etc/fstab:
fstab;&lt;/description&gt;
&lt;link&gt;<span class="clickylink"><a target="new" rel="nofollow" href="http://example.com">http://example.com</a></span>&lt;/link&gt;
&lt;/item&gt;
&lt;/channel&gt;
&lt;/rss&gt; 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-640691" href="/Public/Bug/Display.html?id=48252#txn-640691">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;27&nbsp;20:06:59&nbsp;2009</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/640691/327402/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/327402">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 369b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am currently working around the issue by rejecting documents that
declare entities:

my @entity_declarations = &#40;
  grep { $_-&gt;nodeType&#40;&#41; == XML_ENTITY_DECL }
  map  { $_-&gt;childNodes&#40;&#41; }
  grep { $_-&gt;nodeType&#40;&#41; == XML_DTD_NODE }
  $parsed_document-&gt;childNodes&#40;&#41;
&#41;;
if &#40;@entity_declarations&#41; {
  die &#34;Possible exploit attempt - input file contains declares entities&#34;;
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-640693" href="/Public/Bug/Display.html?id=48252#txn-640693">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;27&nbsp;20:10:46&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/640693/327404/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/327404">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne po 27.čec.2009 18:42:29, RCAPUTO napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The following malicious RSS exposes the contents of /etc/fstab despite
&gt; expand_entities&#40;0&#41; having been called.  $d-&gt;toString&#40;&#41; correctly
&gt; leaves
&gt; the entity unexpanded, but $d-&gt;findvalue&#40;&#41; still expands external
&gt; entities.  The RSS example is based on this year-old article:
&gt;
</div><span class="clickylink"><a target="new" rel="nofollow" href="http://searchsecuritychannel.techtarget.com/generic/0,295582,sid97_gci1304703,00.html">http://searchsecuritychannel.techtarget.com/generic/0,295582,sid97_gci1304703,00.html</a></span>

You are misinterpreting the expand_entities flag. Expanding and loading
entities are two completely different things. An unexpanded entity still
contains data &#40;as a subtree&#41;.

What you need is using XML::LibXML::InputCallback to filter out URLs you
don&#39;t want to parse, as in

my $c = XML::LibXML::InputCallback-&gt;new&#40;&#41;;
$c-&gt;register_callbacks&#40;[
  sub { &#40;$_[0]=~m{^file:/} and $_[0]!~m{^file:///etc/xml/}&#41; ? 1 : 0 },
  sub{}, sub{}, sub{}]&#41;;
$p-&gt;input_callbacks&#40;$c&#41;;

where the file:/ scheme is bypassed to return no data is, except for
file:///etc/xml/* where the parser is allowed to look for catalogs.

-- Petr


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; #!perl
&gt; 
&gt; use warnings;
&gt; use strict;
&gt; 
&gt; use XML::LibXML;
&gt; my $p = XML::LibXML-&gt;new&#40;&#41;;
&gt; 
&gt; $p-&gt;expand_entities&#40;0&#41;;
&gt; $p-&gt;no_network&#40;1&#41;;
&gt; 
&gt; my $d = $p-&gt;parse_string&#40;do { local $/; &lt;DATA&gt; }&#41;;
&gt; print $d-&gt;findvalue&#40;&#34;//description&#34;&#41;, &#34;\n&#34;;
&gt; exit;
&gt; 
&gt; __DATA__
&gt; &lt;?xml version=&#34;1.0&#34; encoding=&#34;ISO-8859-1&#34;?&gt;
&gt; &lt;!DOCTYPE foo [
&gt; &lt;!ENTITY fstab SYSTEM &#34;file:/etc/fstab&#34;&gt;
&gt; &lt;!ENTITY fstab2 SYSTEM &#34;file:///etc/fstab&#34;&gt;
&gt; ]&gt;
&gt; &lt;rss version=&#34;2.0&#34;&gt;
&gt; &lt;channel&gt;
&gt; &lt;title&gt;My attack RSS feed showing /etc/fstab&lt;/title&gt;
&gt; &lt;description&gt;this is file:/etc/fstab: &#38;fstab; and this is
&gt; file:///etc/fstab: &#38;fstab;&lt;/description&gt;
&gt; &lt;item&gt;
&gt; &lt;title&gt;/etc/fstab&lt;/title&gt;
&gt; &lt;description&gt;file:/etc/fstab: &#38;fstab; file:///etc/fstab:
&gt; fstab;&lt;/description&gt;
&gt; &lt;link&gt;<span class="clickylink"><a target="new" rel="nofollow" href="http://example.com">http://example.com</a></span>&lt;/link&gt;
&gt; &lt;/item&gt;
&gt; &lt;/channel&gt;
&gt; &lt;/rss&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-640694" href="/Public/Bug/Display.html?id=48252#txn-640694">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;27&nbsp;20:10:48&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-640697" href="/Public/Bug/Display.html?id=48252#txn-640697">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;27&nbsp;20:10:50&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-640817" href="/Public/Bug/Display.html?id=48252#txn-640817">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;28&nbsp;01:57:26&nbsp;2009</span>
    <span class="description">christian.glahn [...] lo-f.at -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #48252] $parser-&gt;expand_entities&#40;0&#41; allows entity expansion in findvalue&#40;&#41;, elsehwere?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 28 Jul 2009 07:56:51 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-LibXML [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Christian Glahn &lt;christian.glahn [...] lo-f.at&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/640817/327474/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/327474">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">If you want to avoid possible exploits your code is a really bad
solution because it tests for the exploit _after_ it took place. 

What you should consider is to avoid the possible exploit all together. 

Petr&#39;s simple example for the callback system points you towards a
correct solution.

Furthermore, you seem to confuse different document models, namely the
XML concepts, DOM &#40;Level 1,2,and 3&#41;, and the document model of XPath.
Remind that they are not the same. Also note that XML and DOM are aware
of entities, while the XPath document model is not. 

In case you like to expose the entities as text values &#40;namely as
&#34;&#38;amp;entity;&#34;&#41;, you should try your own callback handlers that do the
trick during parsing and document serialization &#40;but be aware that this
is a hairy thing to mess with&#41;. 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Rocco Caputo via RT &lt;bug-XML-LibXML@rt.cpan.org&gt;
Reply-to: bug-XML-LibXML@rt.cpan.org
To: undisclosed-recipients : ;
Subject: [rt.cpan.org #48252] $parser-&gt;expand_entities&#40;0&#41; allows entity
expansion in findvalue&#40;&#41;, elsehwere?
Date: Mon, 27 Jul 2009 20:07:00 -0400

Queue: XML-LibXML
 Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=48252">https://rt.cpan.org/Ticket/Display.html?id=48252</a></span> &gt;

I am currently working around the issue by rejecting documents that
declare entities:

my @entity_declarations = &#40;
  grep { $_-&gt;nodeType&#40;&#41; == XML_ENTITY_DECL }
  map  { $_-&gt;childNodes&#40;&#41; }
  grep { $_-&gt;nodeType&#40;&#41; == XML_DTD_NODE }
  $parsed_document-&gt;childNodes&#40;&#41;
&#41;;
if &#40;@entity_declarations&#41; {
  die &#34;Possible exploit attempt - input file contains declares entities&#34;;
}
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-640818" href="/Public/Bug/Display.html?id=48252#txn-640818">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;28&nbsp;01:57:27&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;rejected&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668158" href="/Public/Bug/Display.html?id=48252#txn-668158">#</a>      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;24&nbsp;10:12:21&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/668158/343191/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343191">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ok, I&#39;m solving this bug having done the following:

1&#41; mentioned this explicitly in the POD for expand_entities

2&#41; documenting ext_end_handler parser flag, which can be used in some
cases to prevent the entities from being expanded

3&#41; mentioned the solution using input callbacks in the documentation

The respective changes are in SVN.

-- Petr

On Tue Jul 28 01:57:26 2009, christian.glahn@lo-f.at wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If you want to avoid possible exploits your code is a really bad
&gt; solution because it tests for the exploit _after_ it took place. 
&gt; 
&gt; What you should consider is to avoid the possible exploit all together. 
&gt; 
&gt; Petr&#39;s simple example for the callback system points you towards a
&gt; correct solution.
&gt; 
&gt; Furthermore, you seem to confuse different document models, namely the
&gt; XML concepts, DOM &#40;Level 1,2,and 3&#41;, and the document model of XPath.
&gt; Remind that they are not the same. Also note that XML and DOM are aware
&gt; of entities, while the XPath document model is not. 
&gt; 
&gt; In case you like to expose the entities as text values &#40;namely as
&gt; &#34;&#38;amp;entity;&#34;&#41;, you should try your own callback handlers that do the
&gt; trick during parsing and document serialization &#40;but be aware that this
&gt; is a hairy thing to mess with&#41;. 
&gt; 
&gt; -----Original Message-----
&gt; From: Rocco Caputo via RT &lt;bug-XML-LibXML@rt.cpan.org&gt;
&gt; Reply-to: bug-XML-LibXML@rt.cpan.org
&gt; To: undisclosed-recipients : ;
&gt; Subject: [rt.cpan.org #48252] $parser-&gt;expand_entities&#40;0&#41; allows entity
&gt; expansion in findvalue&#40;&#41;, elsehwere?
&gt; Date: Mon, 27 Jul 2009 20:07:00 -0400
&gt; 
&gt; Queue: XML-LibXML
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=48252">https://rt.cpan.org/Ticket/Display.html?id=48252</a></span> &gt;
&gt; 
&gt; I am currently working around the issue by rejecting documents that
&gt; declare entities:
&gt; 
&gt; my @entity_declarations = &#40;
&gt;   grep { $_-&gt;nodeType&#40;&#41; == XML_ENTITY_DECL }
&gt;   map  { $_-&gt;childNodes&#40;&#41; }
&gt;   grep { $_-&gt;nodeType&#40;&#41; == XML_DTD_NODE }
&gt;   $parsed_document-&gt;childNodes&#40;&#41;
&gt; &#41;;
&gt; if &#40;@entity_declarations&#41; {
&gt;   die &#34;Possible exploit attempt - input file contains declares entities&#34;;
&gt; }
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668161" href="/Public/Bug/Display.html?id=48252#txn-668161">#</a>      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;24&nbsp;10:12:23&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.429513</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
