<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #13607 for Module-Pluggable: Module fails tests on VMS</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #13607 for Module-Pluggable: Module fails tests on VMS</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Module-Pluggable/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Module-Pluggable/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Module-Pluggable/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Module-Pluggable/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Module-Pluggable">Module-Pluggable CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">13607</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Module-Pluggable/Active/">Module-Pluggable</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">simonw [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ivorw-cpan [...] xemaps.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-21696-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.8    </td>
  </tr>
  <tr id="CF-21697-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;08&nbsp;19:18:14&nbsp;2005</span>
    <span class="description">ivorw-cpan [...] xemaps.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Module fails tests on VMS</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I know that running on VMS may well not be an issue for you. I will have a go at patching it to be VMS portable. &#34;mmk test&#34; &#40;make test&#41; log attached.
</div></div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;09&nbsp;08:22:40&nbsp;2005</span>
    <span class="description">simonw [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;09&nbsp;08:23:47&nbsp;2005</span>
    <span class="description">simonw [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;09&nbsp;08:23:47&nbsp;2005</span>
    <span class="description">simonw [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">More than happy to take patches.

I thought I&#39;d done work to make it filesystem agnostic but I didn&#39;t 
really have any other architectures to test on :&#40;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;12&nbsp;11:50:28&nbsp;2006</span>
    <span class="description">simonw [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Did you ever get anywhere with this?

Also, I note that the log file wasn&#39;t attached.

This may have been solved in the latest svn version of Module::Pluggable

<span class="clickylink"><a target="new" rel="nofollow" href="http://unixbeard.net/svn/simon/Module-Pluggable/">http://unixbeard.net/svn/simon/Module-Pluggable/</a></span>

but let me know.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;28&nbsp;17:34:56&nbsp;2007</span>
    <span class="description">cberry [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] Module::Pluggable port to VMS &#40;was Module fails tests on VMS&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> perl5-porters [...] perl.org</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The attached patch against blead gets Module::Pluggable to pass all tests on VMS &#40;except 
one, which is skipped&#41;.  It had been failing 26 tests, which I think is pretty much all of them.  
I also tested after applying the patch on Mac OS X, where everything still passes.  I have not 
tested on Win32 as I have no build environment available.

The significant changes are all to Module::Pluggable::Object::search_paths.  One minor nit 
was that package names were being passed to File::Spec-&gt;catdir&#40;&#41;.  Package names have 
colons in them. Colons in path specifications are significant on VMS &#40;and Win32 for that 
matter&#41;.  Here&#39;s an example of the kind of nonsense that gets generated:

$ perl -&#34;MFile::Spec&#34; -e &#34;print File::Spec-&gt;catdir&#40;&#39;Foo::Bar&#39;, &#39;Baz&#39;&#41;;&#34;
Foo:[Bar.Baz]

It interpreted Foo as the volume name.  So I split and recombine things a bit differently to 
avoid sending something that&#39;s not a directory to catdir.  &#40;It&#39;s possible we no longer need the 
line that lops the volume name off on Win32.&#41;

The really big issue, though, was the assumption that you can scan the filesystem for .pm 
files and construct case-preserved package names from them &#40;or I guess in this case plugin 
names&#41;.  Even though perlfaq3 more or less tells you to do it that way &#40;though it makes no 
commitment about case preservation&#41; and even though all the cool kids are doing it these 
days &#40;Module::Install comes to mind and there are probably others&#41;, that&#39;s not a very good 
assumption.  

On VMS, case preservation in the C run-time is off by default even when using a volume 
format that supports it, so filenames are all reported in lower case from readdir&#40;&#41; via 
File::Find.  On any OS using any file system that is not case sensitive &#40;including NTFS and HFS
+&#41;, module name case is not significant when using a module, so why should it be significant 
when going the other direction?

But the horse seems to be out of the barn, at least as far as Module::Pluggable is concerned, 
and the only thing I could think of to do was read inside the file for the package declaration 
and correct case based on what I find there.  It&#39;s ugly, but it seems to work.  

There is one test that explicitly makes sure it can find a plugin where the filename has been 
misspelled.  I don&#39;t know why you&#39;d want to support that, but if I can&#39;t get the plugin name 
from the filename and I can&#39;t get it from the package declaration, there&#39;s really nowhere else 
to go, so I skip that test.

I thought I&#39;d see if there was any feedback or alternate suggestions for how to handle this 
before applying it to blead.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- lib/Module/Pluggable/Object.pm;-0	Tue Nov 28 07:51:00 2006
+++ lib/Module/Pluggable/Object.pm	Sat Jan 27 12:49:22 2007
@@ -3,7 +3,7 @@ package Module::Pluggable::Object;
 use strict;
 use File::Find &#40;&#41;;
 use File::Basename;
-use File::Spec::Functions qw&#40;splitdir catdir abs2rel&#41;;
+use File::Spec::Functions qw&#40;splitdir catdir curdir catfile abs2rel&#41;;
 use Carp qw&#40;croak carp&#41;;
 use Devel::InnerPackage;
 use Data::Dumper;
@@ -145,17 +145,48 @@ sub search_paths {
             # untaint the file; accept .pm only
             next unless &#40;$file&#41; = &#40;$file =~ /&#40;.*$file_regex&#41;$/&#41;; 
             # parse the file to get the name
-            my &#40;$name, $directory&#41; = fileparse&#40;$file, $file_regex&#41;;
+            my &#40;$name, $directory, $suffix&#41; = fileparse&#40;$file, $file_regex&#41;;
 
             $directory = abs2rel&#40;$directory, $sp&#41;;
+
+            # If we have a mixed-case package name, assume case has been preserved
+            # correctly.  Otherwise, root through the file to locate the case-preserved
+            # version of the package name.
+            my @pkg_dirs = &#40;&#41;;
+            if &#40; $name eq lc&#40;$name&#41; || $name eq uc&#40;$name&#41; &#41; {
+                my $pkg_file = catfile&#40;$sp, $directory, &#34;$name$suffix&#34;&#41;;
+                open PKGFILE, &#34;&lt;$pkg_file&#34; or die &#34;search_paths: Can&#39;t open $pkg_file: $!&#34;;
+                my $in_pod = 0;
+                while &#40; my $line = &lt;PKGFILE&gt; &#41; {
+                    $in_pod = 1 if $line =~ m/^=\w/;
+                    $in_pod = 0 if $line =~ /^=cut/;
+                    next if &#40;$in_pod || $line =~ /^=cut/&#41;;  # skip pod text
+                    next if $line =~ /^\s*#/;               # and comments
+                    if &#40; $line =~ m/^\s*package\s+&#40;.*::&#41;?&#40;$name&#41;\s*;/i &#41; {
+                        @pkg_dirs = split /::/, $1;
+                        $name = $2;
+                        last;
+                    }
+                }
+                close PKGFILE;
+            }
+
             # then create the class name in a cross platform way
             $directory =~ s/^[a-z]://i if&#40;$^O =~ /MSWin32|dos/&#41;;       # remove volume
+            my @dirs = &#40;&#41;;
             if &#40;$directory&#41; {
                 &#40;$directory&#41; = &#40;$directory =~ /&#40;.*&#41;/&#41;;
+                @dirs = grep&#40;length&#40;$_&#41;, splitdir&#40;$directory&#41;&#41; 
+                    unless $directory eq curdir&#40;&#41;;
+                for my $d &#40;reverse @dirs&#41; {
+                    my $pkg_dir = pop @pkg_dirs; 
+                    last unless defined $pkg_dir;
+                    $d =~ s/\Q$pkg_dir\E/$pkg_dir/i;  # Correct case
+                }
             } else {
                 $directory = &#34;&#34;;
             }
-            my $plugin = join &#34;::&#34;, splitdir catdir&#40;$searchpath, $directory, $name&#41;;
+            my $plugin = join &#39;::&#39;, $searchpath, @dirs, $name;
 
             next unless $plugin =~ m!&#40;?:[a-z\d]+&#41;[a-z\d]!i;
 
--- lib/Module/Pluggable/t/20dodgy_files.t;-0	Tue Nov 28 07:51:00 2006
+++ lib/Module/Pluggable/t/20dodgy_files.t	Sat Jan 27 12:49:23 2007
@@ -1,5 +1,12 @@
 #!perl -w
 
+BEGIN {
+    if &#40;$^O eq &#39;VMS&#39;&#41; {
+        print &#34;1..0 # Skip: can&#39;t handle misspelled plugin names\n&#34;;
+        exit;
+    }
+}
+
 use strict;
 use FindBin;
 use lib &#34;$FindBin::Bin/lib&#34;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;12&nbsp;14:38:08&nbsp;2008</span>
    <span class="description">simonw [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve applied your patch as part of 3.7 which is on its way to CPAN right
now - sorry it took so long.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;12&nbsp;14:38:10&nbsp;2008</span>
    <span class="description">simonw [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
