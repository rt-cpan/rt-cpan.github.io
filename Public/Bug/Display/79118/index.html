<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #79118 for XML-LibXML: Memory leaks in Parser on broken docs with recover =&gt; 2</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #79118 for XML-LibXML: Memory leaks in Parser on broken docs with recover =&gt; 2</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/XML-LibXML/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-LibXML">XML-LibXML CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">79118</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/XML-LibXML/Active/">XML-LibXML</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
andre.lang [...] webrausch.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-37350-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.0004    </td>
  </tr>
  <tr id="CF-37351-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;21&nbsp;16:25:56&nbsp;2012</span>
    <span class="description">andre.lang [...] webrausch.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Memory leaks in Parser on broken docs with recover =&gt; 2</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Shlomi,

I&#39;m using XML::LibXML in an application where I process a lot of HTML
webpages. Some of these don&#39;t contain valid XML, so I set recover =&gt; 2.

Setting this flag causes a lot of memory leaks when calling
LibXML::Parser on an invalid file.

I see this behaviour on
Ubuntu 10.04 LTS
XML:LibXML 2.004
Perl 5.14.2, 5.16.1 and 5.17.3.

Older XML::LibXML versions show the same behaviour. I also compiled
XML::LibXML against different versions of libxml, same problem. On
Windows, also the same.

I attach a test case where the memory bug occurs and is reported by
Devel::Leak. I supply a snipplet of a problematic webpage, containing
unknown tags and higher Unicode characters &#40;which LibXML doesn&#39;t like at
all, but that may be a different bug to report - fixed it converting
them to entities&#41;. Basically, I encounter the leak on any page that is
not parsable.

So, if you run the supplied libxml2.pl you will see several &#34;new&#34; lines
indicating a lot of SVs have been leaked.
If recover is set to 0, there is no leak.

This bug may also relate to similar bug #61507.

If you need any further information, please let me know how I can help.

Besides, thanks for you module - switched from XML::XPath as XML::LibXML
doesn&#39;t leak usually :&#41;

Yours,
Andr√©
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> libxml-trouble-sample.html</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza"><a>‚Äãbundle -‚Äã Mit 2432 Seiten, Alles .‚Äã.‚Äã.‚Äã</a>


</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> libxml2.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"># Feeding XML::LibXML with an invalid file, triggering memory leaks

use strict;
use warnings;
use Devel::Leak;
 
use Encode;
use XML::LibXML; 
 
BEGIN{
     if &#40;$] &lt; 5.008&#41;{
     require utf8;
     utf8-&gt;import&#40;&#41;;
     }
}
if &#40;$] &gt;= 5.008&#41;{
binmode STDOUT, &#39;:encoding&#40;UTF-8&#41;&#39;;}

use Carp;

check_libxml_memory&#40;&#41;;

sub check_libxml_memory {
print &#34;running\n&#34;;
  my $handle;
  my $leaveCount = 0;
  my $enterCount = Devel::Leak::NoteSV&#40;$handle&#41;;
#  print STDERR &#34;ENTER: $enterCount SVs\n&#34;;
  {
    make_trouble&#40;&#41;; # Trace how loading a bad doc affects memory
  }
  $leaveCount = Devel::Leak::CheckSV&#40;$handle&#41;;
#  print STDERR &#34;\nLEAVE: $leaveCount SVs\n&#34;;
}

sub make_trouble {
  # Tries to load a bad XML file into XML::LibXML
  my $filenameIn=&#39;libxml-trouble-sample.html&#39;;
  local $/; #Read whole file
  open&#40;my $FILEIN,&#39;&lt;:utf8&#39;, $filenameIn&#41; or die &#34;Can&#39;t read file &#39;$filenameIn&#39; [$!]\n&#34;;  
  my $str = &lt;$FILEIN&gt;;
  close &#40;$FILEIN&#41;;

  # Feeds the bad file to XML::LibXML.
  my $parser = XML::LibXML-&gt;new;
  my $success=1;
  # if recover is set to 0 or 1, the problem ceases to exist
  my $doc = $parser-&gt;parse_html_string&#40;$str, {recover =&gt; 2, encoding =&gt; &#39;UTF-8&#39;}&#41;;
}

1;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;21&nbsp;16:34:41&nbsp;2012</span>
    <span class="description">andre.lang [...] webrausch.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> andre.lang [...] webrausch.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">One more word: My test case uses :utf8 read from file which I found out
you shouldn&#39;t. Still, changing it to :raw doesn&#39;t make any difference.

Yours,
Andre
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;22&nbsp;03:11:17&nbsp;2012</span>
    <span class="description">christian.glahn [...] lo-f.at -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79118] Memory leaks in Parser on broken docs with recover =&gt; 2 </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 22 Aug 2012 09:10:47 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-LibXML [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Christian Glahn &lt;christian.glahn [...] lo-f.at&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Andr√©,

a brief remark regarding UTF handling problems: 

If you encounter problems with handling UTF characters you should report these issues directly to the libxml2 people, because XML::LibXML simply accepts what is provided by the C-layer. 

Of course this is not related to your report ;-&#41;

Best 
Christian


On 21 Aug 2012, at 22:25, Sierra via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Tue Aug 21 16:25:56 2012: Request 79118 was acted upon.
&gt; Transaction: Ticket created by andre.lang@webrausch.de
&gt;       Queue: XML-LibXML
&gt;     Subject: Memory leaks in Parser on broken docs with recover =&gt; 2
&gt;   Broken in: 2.0004
&gt;    Severity: Important
&gt;       Owner: Nobody
&gt;  Requestors: andre.lang@webrausch.de
&gt;      Status: new
&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=79118">https://rt.cpan.org/Ticket/Display.html?id=79118</a></span> &gt;
&gt; 
&gt; 
&gt; Hi Shlomi,
&gt; 
&gt; I&#39;m using XML::LibXML in an application where I process a lot of HTML
&gt; webpages. Some of these don&#39;t contain valid XML, so I set recover =&gt; 2.
&gt; 
&gt; Setting this flag causes a lot of memory leaks when calling
&gt; LibXML::Parser on an invalid file.
&gt; 
&gt; I see this behaviour on
&gt; Ubuntu 10.04 LTS
&gt; XML:LibXML 2.004
&gt; Perl 5.14.2, 5.16.1 and 5.17.3.
&gt; 
&gt; Older XML::LibXML versions show the same behaviour. I also compiled
&gt; XML::LibXML against different versions of libxml, same problem. On
&gt; Windows, also the same.
&gt; 
&gt; I attach a test case where the memory bug occurs and is reported by
&gt; Devel::Leak. I supply a snipplet of a problematic webpage, containing
&gt; unknown tags and higher Unicode characters &#40;which LibXML doesn&#39;t like at
&gt; all, but that may be a different bug to report - fixed it converting
&gt; them to entities&#41;. Basically, I encounter the leak on any page that is
&gt; not parsable.
&gt; 
&gt; So, if you run the supplied libxml2.pl you will see several &#34;new&#34; lines
&gt; indicating a lot of SVs have been leaked.
&gt; If recover is set to 0, there is no leak.
&gt; 
&gt; This bug may also relate to similar bug #61507.
&gt; 
&gt; If you need any further information, please let me know how I can help.
&gt; 
&gt; Besides, thanks for you module - switched from XML::XPath as XML::LibXML
&gt; doesn&#39;t leak usually :&#41;
&gt; 
&gt; Yours,
&gt; Andr√©
&gt; 
&gt; ‚Äãbundle -‚Äã Mit 2432 Seiten, Alles .‚Äã.‚Äã.‚Äã
&gt; &lt;libxml2.pl&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;22&nbsp;03:11:19&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;22&nbsp;05:58:42&nbsp;2012</span>
    <span class="description">andre.lang [...] webrausch.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> andre.lang [...] webrausch.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Christian,

thanks for clarification. I will further investigate that UTF-8 issue
before reporting it to the libxml2 developers, as I&#39;m not sure if it&#39;s
really a bug. Anyway, as I found a workaround, it&#39;s not a real pain for
me now.

What really bugs me are these memory leaks, as my program is
long-running, processing thousands of documents. If I can&#39;t get rid of
these, I will have a *lot* of work rewriting my program to fork or
restart itself from time to time &#40;which btw I don&#39;t think is really good
programming style...&#41; so any help on this one is really appreciated.

Yours,
Andr√©
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;22&nbsp;08:16:09&nbsp;2012</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Andr√©,

On Tue Aug 21 16:25:56 2012, andre.lang@webrausch.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Shlomi,
&gt; 
&gt; I&#39;m using XML::LibXML in an application where I process a lot of HTML
&gt; webpages. Some of these don&#39;t contain valid XML, so I set recover =&gt; 2.
&gt; 
</div>
thanks for the bug report. I&#39;m going to investigate it now.

Regards,

-- Shlomi Fish

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Setting this flag causes a lot of memory leaks when calling
&gt; LibXML::Parser on an invalid file.
&gt; 
&gt; I see this behaviour on
&gt; Ubuntu 10.04 LTS
&gt; XML:LibXML 2.004
&gt; Perl 5.14.2, 5.16.1 and 5.17.3.
&gt; 
&gt; Older XML::LibXML versions show the same behaviour. I also compiled
&gt; XML::LibXML against different versions of libxml, same problem. On
&gt; Windows, also the same.
&gt; 
&gt; I attach a test case where the memory bug occurs and is reported by
&gt; Devel::Leak. I supply a snipplet of a problematic webpage, containing
&gt; unknown tags and higher Unicode characters &#40;which LibXML doesn&#39;t like at
&gt; all, but that may be a different bug to report - fixed it converting
&gt; them to entities&#41;. Basically, I encounter the leak on any page that is
&gt; not parsable.
&gt; 
&gt; So, if you run the supplied libxml2.pl you will see several &#34;new&#34; lines
&gt; indicating a lot of SVs have been leaked.
&gt; If recover is set to 0, there is no leak.
&gt; 
&gt; This bug may also relate to similar bug #61507.
&gt; 
&gt; If you need any further information, please let me know how I can help.
&gt; 
&gt; Besides, thanks for you module - switched from XML::XPath as XML::LibXML
&gt; doesn&#39;t leak usually :&#41;
&gt; 
&gt; Yours,
&gt; Andr√©
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;22&nbsp;08:37:08&nbsp;2012</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Andr√©,

I&#39;ve ran into a problem running your test program because it uses of a
module called &#34;Devel::Leak&#34; which is nowhere to be found:

<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/module/Devel::Leak">https://metacpan.org/module/Devel::Leak</a></span>

I&#39;m sorry it took me so long to look into it, but can you please clarify
this obstacle now?

Regards,

-- Shlomi Fish
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;22&nbsp;08:44:11&nbsp;2012</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Aug 22 08:37:08 2012, SHLOMIF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Andr√©,
&gt; 
&gt; I&#39;ve ran into a problem running your test program because it uses of a
&gt; module called &#34;Devel::Leak&#34; which is nowhere to be found:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/module/Devel::Leak">https://metacpan.org/module/Devel::Leak</a></span>
&gt; 
&gt; I&#39;m sorry it took me so long to look into it, but can you please clarify
&gt; this obstacle now?
&gt; 
&gt; Regards,
&gt; 
&gt; -- Shlomi Fish
</div>
Oh, I see:

<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/dist/Devel-Leak/">http://search.cpan.org/dist/Devel-Leak/</a></span>

I guess it&#39;s another MetaCPAN bug. :-&#40;

Regards,

-- Shlomi Fish
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;23&nbsp;11:13:53&nbsp;2012</span>
    <span class="description">andre.lang [...] webrausch.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> andre.lang [...] webrausch.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Shlomi,

thank you for investigating the issue. You can find more information on
where exaclty the leaking vars are coming from using the
Test::LeakTrace::Script module from CPAN:

<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~gfuji/Test-LeakTrace-0.14/lib/Test/LeakTrace/Script.pm">http://search.cpan.org/~gfuji/Test-LeakTrace-0.14/lib/Test/LeakTrace/Script.pm</a></span>

From my test script, just remove Devel::Leak by commenting all the
Devel::Leak lines, so that only the leaking function &#39;make_trouble&#39; is
called.

Then, start the script using:

perl -MTest::LeakTrace::Script=-verbose libxml2.pl

This will give you the exact line numbers in the source where the leak
is happening, along with it&#39;s type, last value, and reference count.

Hope this helps.

Yours,
Andr√©
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;23&nbsp;13:25:24&nbsp;2012</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Andr√©,

On Thu Aug 23 11:13:53 2012, andre.lang@webrausch.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Shlomi,
&gt; 
&gt; thank you for investigating the issue. You can find more information
&gt; on
&gt; where exaclty the leaking vars are coming from using the
&gt; Test::LeakTrace::Script module from CPAN:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~gfuji/Test-LeakTrace-">http://search.cpan.org/~gfuji/Test-LeakTrace-</a></span>
&gt; 0.14/lib/Test/LeakTrace/Script.pm
&gt; 
&gt; From my test script, just remove Devel::Leak by commenting all the
&gt; Devel::Leak lines, so that only the leaking function &#39;make_trouble&#39; is
&gt; called.
&gt; 
&gt; Then, start the script using:
&gt; 
&gt; perl -MTest::LeakTrace::Script=-verbose libxml2.pl
&gt; 
&gt; This will give you the exact line numbers in the source where the leak
&gt; is happening, along with it&#39;s type, last value, and reference count.
&gt; 
</div>
The problem with Test::LeakTrace::Script is that it complains about many
things even without a call to make_trouble&#40;&#41; so I don&#39;t know what to
make of it.

Regards,

-- Shlomi Fish

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hope this helps.
&gt; 
&gt; Yours,
&gt; Andr√©
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;24&nbsp;09:04:06&nbsp;2012</span>
    <span class="description">andre.lang [...] webrausch.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> andre.lang [...] webrausch.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Shlomi,

the sad truth is that there are a lot of memory bugs even in the Perl
core libraries which now first show. For example, from somewhere around
Perl 5.8 to 5.14.2 there were leaks in each and every regular expression
using character classes or capturing groups.

Most of the leaks, however, happen only once during the initialization
of the libraries, at the &#34;use&#34; stage. These static ones are not
problematic, but those that are recurring, permanently eating up memory,
are.

To find out those caused by XML::LibXML, just pipe the err output to a
file &#39;... 2&gt; out.txt&#39; and search for lines containing &#34;LibXML&#34; with a
text editor. Another way is just tracing the &#34;make_trouble&#34; function by
calling it with:

use Test::LeakTrace;
...
traceleak {
  make_trouble&#40;&#41;;
} -verbose;

Test::LeakTrace is the base of Test::LeakTrace::Script, and you can use
it to trace only leaks in one block. Downside is that it may give false
alarms when altering varibles in the traceleak block which have defined
been defined before the call to traceleak.

If there is something I can do to help, such as giving you a filtered
output out LeakTrace, please let me know.

Yours,
Andr√©
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;28&nbsp;09:15:56&nbsp;2014</span>
    <span class="description">NWELLNHOF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m a bit puzzled about this bug report. I tried to reproduce the leak with your test script. First of all, I noticed that passing { recover =&gt; 2 } to parse_html_string has the same effect as { recover =&gt; 1 }, i.e. warnings are not suppressed. I filed bug #93429 for this issue:

<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=93429">https://rt.cpan.org/Ticket/Display.html?id=93429</a></span>

I&#39;m pretty sure that this bug is already present in XML::LibXML version 2.004 which you said you were using.

Then your test script has some flaws which makes it report false positives as well as false negatives.

1. When you set { recover =&gt; 0 } in your test script, there won&#39;t be any reported leaks because the script simply dies. You have to catch any exceptions, then clear $@.

2. When an error is generated for the first time, some error classes are initialized which results in the allocation of some global variables. To avoid these reports, you should run the make_trouble&#40;&#41; function once before testing for leaks.

3. It seems that reading the HTML file leaks a few IVs. This doesn&#39;t seem to be related to XML::LibXML.

See the attachment for my version of the test script. When I run it with

- Ubuntu 13.10
- XML::LibXML 2.0010
- libxml2 2.9.1

I get no leaks with &#39;recover&#39; set to 1 or 2, but I get a leak when &#39;recover&#39; is set to 0. I&#39;ll post a separate bug report about the latter issue.

Nick
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> libxml2.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
# Feeding XML::LibXML with an invalid file, triggering memory leaks

use strict;
use warnings;

use Devel::Leak;
use XML::LibXML; 
 
check_libxml_memory&#40;&#41;;

sub check_libxml_memory {
    # Tries to load a bad XML file into XML::LibXML

    my $filenameIn=&#39;libxml-trouble-sample.html&#39;;
    local $/; #Read whole file
    open&#40;my $FILEIN,&#39;&lt;:utf8&#39;, $filenameIn&#41;
        or die &#34;Can&#39;t read file &#39;$filenameIn&#39; [$!]\n&#34;;  
    my $str = &lt;$FILEIN&gt;;
    close &#40;$FILEIN&#41;;

    make_trouble&#40;$str&#41;; # Run once to initialize stuff.

    my $handle;
    my $leaveCount = 0;
    my $enterCount = Devel::Leak::NoteSV&#40;$handle&#41;;
    print STDERR &#34;ENTER: $enterCount SVs\n&#34;;
    make_trouble&#40;$str&#41;; # Trace how loading a bad doc affects memory
    $leaveCount = Devel::Leak::CheckSV&#40;$handle&#41;;
    print STDERR &#34;\nLEAVE: $leaveCount SVs\n&#34;;
}

sub make_trouble {
    my $str = shift;

    my $parser = XML::LibXML-&gt;new&#40;recover =&gt; 2&#41;;
    eval {
        my $doc = $parser-&gt;parse_html_string&#40;$str, {
            encoding =&gt; &#39;UTF-8&#39;,
        }&#41;;
    };
    $@ = undef;
}

1;
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
