<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #15748 for Inline-Java: InlineJavaPerlInterpreter.eval&#40;&#41; hangs when called from another thread</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #15748 for Inline-Java: InlineJavaPerlInterpreter.eval&#40;&#41; hangs when called from another thread</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Inline-Java/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Inline-Java/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Inline-Java/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Inline-Java/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Inline-Java">Inline-Java CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">15748</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Inline-Java/Active/">Inline-Java</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">patl [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
avatar [...] hot.ee

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-16926-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.50    </td>
  </tr>
  <tr id="CF-16927-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.50_90    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;13&nbsp;09:43:45&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> InlineJavaPerlInterpreter.eval&#40;&#41; hangs when called from another
 thread</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">InlineJavaPerlInterpreter.eval&#40;&#41; hangs if called from a thread different from the one where InlineJavaPerlInterpreter.create&#40;&#41; was called.

Program reproducing the bug:
=======================================================================
import org.perl.inline.java.*;

class PerlEvalBug extends Thread 
{
        InlineJavaPerlInterpreter pi;

  PerlEvalBug&#40;&#41; throws InlineJavaPerlException, InlineJavaException
  {
                pi = InlineJavaPerlInterpreter.create&#40;&#41;;
                // if I call print without newline in the end, 
                // nothing happens until a newline is output later
                pi.eval&#40;&#34;print \&#34;called from the constructor\\n\&#34;;&#34;&#41;;
  }

        public void run&#40;&#41; 
        {
                try
                        // this hangs!
                  {pi.eval&#40;&#34;print \&#34;called from the second thread\\n\&#34;;&#34;&#41;;}
                catch&#40;Exception e&#41;
                        {e.printStackTrace&#40;&#41;;}
        }

        public void call&#40;&#41; throws InlineJavaPerlException, InlineJavaException
        {
                // this works
                pi.eval&#40;&#34;print \&#34;called from the main thread\\n\&#34;;&#34;&#41;;
        }

        public void finalize&#40;&#41;
        {
                pi.destroy&#40;&#41;;   
        } 

        public static void main&#40;String[] args&#41; throws InlineJavaPerlException, InlineJavaException
        {
                PerlEvalBug bug = new PerlEvalBug&#40;&#41;;
                bug.call&#40;&#41;;
                bug.start&#40;&#41;;
        }
} 
=======================================================================

Output &#40;with debug level 10&#41;:
=======================================================================
[java][2]  creating temporary JNI InlineJavaServer
[java][2]  temporary JNI InlineJavaServer created
[java][2]  creating InlineJavaPerlInterpreter
[java][2]  loading shared library /usr/lib/perl5/site_perl/5.8.7/i586-linux-thread-multi/auto/Inline/Java/PerlInterpreter/PerlInterpreter.so
[java][2]  shared library /usr/lib/perl5/site_perl/5.8.7/i586-linux-thread-multi/auto/Inline/Java/PerlInterpreter/PerlInterpreter.so loaded
[java][2]  constructing perl interpreter
[java][2]  perl interpreter constructed
called from the constructor
called from the main thread
&#40;hangs...&#41;
=======================================================================

Configuration:
=======================================================================
avatar:~/.cpan/build/Inline-Java-0.50 # perl Makefile.PL

Welcome to the Inline::Java installation procedure.

Default J2SDK for Inline::Java will be &#39;/usr/lib/jvm/java-1.4.2-sun/&#39;.
See module documentation for information on how to use a different J2SDK
or change this default value.


Inline::Java can use a JNI extension that allows the Java Virtual Machine
&#40;JVM&#41; to be dynamically linked with Perl instead of running as a separate
process. The use of this extension is optional, and building it still
allows Inline::Java to run the JVM in the default &#40;separate process&#41;
fashion.
Note: You need a C compiler to build the extension.
Note: You must build the extension if you wish to use PerlNatives or
      PerlInterpreter.
Do you wish to build the JNI extension? [y] y

Building JNI extension.

1&#41; /usr/lib/jvm/java-1.4.2-sun/jre/lib/i386/server
2&#41; /usr/lib/jvm/java-1.4.2-sun/jre/lib/i386/client
Please select from the above list which &#39;libjvm.so&#39; to use: [2] 1

Building with:
  /usr/lib/jvm/java-1.4.2-sun/include/jni.h
  /usr/lib/jvm/java-1.4.2-sun/include/linux/jni_md.h
  /usr/lib/jvm/java-1.4.2-sun/jre/lib/i386/server/libjvm.so

Note: In order for Inline::Java to use the JNI extension, you will need to
use the JNI configuration option or set the PERL_INLINE_JAVA_JNI environment
variable to a true value. You will also need to add the following directories
to your LD_LIBRARY_PATH environment variable:
  /usr/lib/jvm/java-1.4.2-sun/jre/lib/i386/server
  /usr/lib/jvm/java-1.4.2-sun/jre/lib/i386/native_threads
  /usr/lib/jvm/java-1.4.2-sun/jre/lib/i386
See README.JNI for more information.

The PerlNatives extension allows for callbacks to be defined as native
Java methods. It is still EXPERIMENTAL and may not build or work properly
on all platforms. See documentation for more details.
Note: PerlNatives requires J2SDK 1.4 or greater.
Do you wish to build the PerlNatives extension? [n] y

The PerlInterpreter extension allows Inline::Java to be loaded directly from
Java using an embedded Perl interpreter. It is still EXPERIMENTAL and
may not build or work properly on all platforms. See documentation for
more details.
Do you wish to build the PerlInterpreter extension? [n] y

Writing Makefile for Inline::Java::PerlNatives
Writing Makefile for Inline::Java::PerlInterpreter
Writing Makefile for Inline::Java::JNI
Writing Makefile for Inline::Java

You can continue the installation with the following commands:
  % make java
  % make
  % make test
  % make install
=======================================================================

Regards,
  Misha
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;13&nbsp;12:50:19&nbsp;2005</span>
    <span class="description">patl [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;14&nbsp;12:44:08&nbsp;2005</span>
    <span class="description">patl [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Since the perl part of Inline::Java is not thread aware, all callbacks
from threads other than the thread that created the PerlInterpreter
object are queued and dispatched only when the callback loop is in effect.

Apply this patch to your code to get an idea of how it works.

Patrick


*** test.java.ori       2005-11-14 12:37:21.000000000 -0500
--- test.java   2005-11-14 12:40:26.000000000 -0500
***************
*** 16,22 ****
        {
                try
                        // this hangs!
!                 {pi.eval&#40;&#34;print \&#34;called from the second thread\\n\&#34;;&#34;&#41;;}
                catch&#40;Exception e&#41;
                        {e.printStackTrace&#40;&#41;;}
        }
--- 16,26 ----
        {
                try
                        // this hangs!
!                 {
!                       pi.eval&#40;&#34;print \&#34;called from the second
thread\\n\&#34;;&#34;&#41;;
!                       // Return control to the main thread
!                       pi.StopCallbackLoop&#40;&#41;;
!             }
                catch&#40;Exception e&#41;
                        {e.printStackTrace&#40;&#41;;}
        }
***************
*** 37,41 ****
--- 41,49 ----
                PerlEvalBug bug = new PerlEvalBug&#40;&#41;;
                bug.call&#40;&#41;;
                bug.start&#40;&#41;;
+         // Callback will hang until we start the callback loop
+         bug.pi.StartCallbackLoop&#40;&#41; ;
+               // Now this thread is blocked until someone else calls
pi.StopCallbackLoop&#40;&#41;
+               bug.call&#40;&#41;;
        }
  }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;17&nbsp;14:41:22&nbsp;2005</span>
    <span class="description">patl [...] cpan.org -  CustomField 0.50 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;17&nbsp;14:41:22&nbsp;2005</span>
    <span class="description">patl [...] cpan.org -  Broken in 0.50_90 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;17&nbsp;14:42:14&nbsp;2005</span>
    <span class="description">patl [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">BTW, this did not work properly until 0.50_90.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;17&nbsp;14:42:39&nbsp;2005</span>
    <span class="description">patl [...] cpan.org -  Broken in 0.50 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;17&nbsp;14:42:39&nbsp;2005</span>
    <span class="description">patl [...] cpan.org -  Fixed in 0.50_90 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;17&nbsp;14:42:39&nbsp;2005</span>
    <span class="description">patl [...] cpan.org -  CustomField 0.50_90 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;20&nbsp;00:55:16&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> avatar [...] hot.ee</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yes, in 0.50_90 your code works perfectly. Thanks a lot!

Misha
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;20&nbsp;08:26:00&nbsp;2005</span>
    <span class="description">patl [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
