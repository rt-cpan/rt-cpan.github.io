<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #118047 for PDF-API2: Adding 8bpp TIFF results in broken image</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #118047 for PDF-API2: Adding 8bpp TIFF results in broken image</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/PDF-API2/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/PDF-API2">PDF-API2 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">118047</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/PDF-API2/Active/">PDF-API2</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ppisar [...] redhat.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
jffry [...] posteo.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24958-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.028    </td>
  </tr>
  <tr id="CF-24959-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;23&nbsp;08:08:36&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Adding 8bpp TIFF results in broken image</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The following code creates a one-page PDF file and adds a TIFF image into the page:

#!/usr/bin/perl
use strict;
use warnings;
use PDF::API2;

my $pdf = PDF::API2-&gt;new&#40;-file =&gt; &#39;out.pdf&#39;&#41;;
my $page = $pdf-&gt;page;
$page-&gt;mediabox&#40;157, 196&#41;;

my $imgobj = $pdf-&gt;image_tiff&#40;&#39;8.tiff&#39;&#41;;

my $gfx = $page-&gt;gfx;
$gfx-&gt;image&#40;$imgobj, 0, 0, 157, 196&#41;;

$pdf-&gt;save;
$pdf-&gt;end;


The problem is the resulting PDF renderes the image broken if the TIFF image has 8 bit per pixel. It works fine if the image has only 1 bit per pixel. I attached the the two TIFF images and the resulting broken PDF file.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 1.tiff</td>
  </tr>
</table>

<div class="messagebody">
<img alt="1.tiff" title="1.tiff" src="/Ticket/Attachment/1671661/897157/" /></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 8.tiff</td>
  </tr>
</table>

<div class="messagebody">
<img alt="8.tiff" title="8.tiff" src="/Ticket/Attachment/1671661/897158/" /></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> out.pdf</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;07&nbsp;14:49:34&nbsp;2016</span>
    <span class="description">jffry [...] posteo.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It&#39;s another lzw problem. 8.tiff is lzw compressed. If I uncompress it, &#40;tiffcp -c none&#41; PDF::API2 has no problem.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;07&nbsp;14:49:35&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;14&nbsp;11:44:50&nbsp;2017</span>
    <span class="description">jffry [...] posteo.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The attached patch fixed this for me, albeit by adding the dependency Graphics::TIFF, which uses libtiff to do the decompression.

If you were happy with this approach, RT 84665 could be fixed in the same way.

I was unable to come up with a G3-encoded TIFF that the current version of PDF::API2 accepts. If you can find a way of generating one, then I can update the tests.

Alternatively, I can simply implement G3 and G4 support without worrying about the old approach.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Fix-IO-Handle-warnings-from-Debian-bug-622078.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 15d142b167312cf5fa52eda2dcd0a39aa58fc747 Mon Sep 17 00:00:00 2001
From: Jeffrey Ratcliffe &lt;Jeffrey.Ratcliffe@gmail.com&gt;
Date: Tue, 4 Oct 2016 17:49:09 +0200
Subject: [PATCH] Fix IO::Handle warnings from Debian bug #622078

---
 lib/PDF/API2/Resource/XObject/Image/TIFF.pm | 8 ++++++++
 1 file changed, 8 insertions&#40;+&#41;

diff --git a/lib/PDF/API2/Resource/XObject/Image/TIFF.pm b/lib/PDF/API2/Resource/XObject/Image/TIFF.pm
index 154006e..b79a3b4 100644
--- a/lib/PDF/API2/Resource/XObject/Image/TIFF.pm
+++ b/lib/PDF/API2/Resource/XObject/Image/TIFF.pm
@@ -372,6 +372,7 @@ sub new {
   $fh-&gt;seek&#40; $self-&gt;{offset}, 0 &#41;;
 
   # checking byte order of data
+  $self-&gt;{byteOrder} = undef; # suppress warning from IO::Handle
   $fh-&gt;read&#40; $self-&gt;{byteOrder}, 2 &#41;;
   $self-&gt;{byte}=&#39;C&#39;;
   $self-&gt;{short}=&#40;&#40;$self-&gt;{byteOrder} eq &#39;MM&#39;&#41; ? &#39;n&#39; : &#39;v&#39; &#41;;
@@ -379,11 +380,13 @@ sub new {
   $self-&gt;{rational}=&#40;&#40;$self-&gt;{byteOrder} eq &#39;MM&#39;&#41; ? &#39;NN&#39; : &#39;VV&#39; &#41;;;
 
   # get/check version id
+  $self-&gt;{version} = undef; # suppress warning from IO::Handle
   $fh-&gt;read&#40; $self-&gt;{version}, 2 &#41;;
   $self-&gt;{version}=unpack&#40;$self-&gt;{short},$self-&gt;{version}&#41;;
   die &#34;Wrong TIFF Id &#39;$self-&gt;{version}&#39; &#40;should be 42&#41;.&#34; if&#40;$self-&gt;{version} != 42&#41;;
 
   # get the offset to the first tag directory.
+  $self-&gt;{ifdOffset} = undef; # suppress warning from IO::Handle
   $fh-&gt;read&#40; $self-&gt;{ifdOffset}, 4 &#41;;
   $self-&gt;{ifdOffset}=unpack&#40;$self-&gt;{long},$self-&gt;{ifdOffset}&#41;;
 
@@ -457,6 +460,7 @@ sub readTags {
 
   while&#40;$self-&gt;{ifd} &gt; 0&#41; {
     $fh-&gt;seek&#40; $self-&gt;{ifd}, 0 &#41;;
+    $self-&gt;{ifdNum} = undef; # suppress warning from IO::Handle
     $fh-&gt;read&#40; $self-&gt;{ifdNum}, 2 &#41;;
     $self-&gt;{ifdNum}=unpack&#40;$self-&gt;{short},$self-&gt;{ifdNum}&#41;;
     $self-&gt;{bitsPerSample}=1;
@@ -531,12 +535,14 @@ sub readTags {
         # ImageDescription
         my $here=$fh-&gt;tell;
         $fh-&gt;seek&#40;$valOffset,0&#41;;
+        $self-&gt;{imageDescription} = undef; # suppress warning from IO::Handle
         $fh-&gt;read&#40;$self-&gt;{imageDescription},$valLen&#41;;
         $fh-&gt;seek&#40;$here,0&#41;;
       } elsif&#40;$valTag==282&#41; {
         # xRes
         my $here=$fh-&gt;tell;
         $fh-&gt;seek&#40;$valOffset,0&#41;;
+        $self-&gt;{xRes} = undef; # suppress warning from IO::Handle
         $fh-&gt;read&#40;$self-&gt;{xRes},$valLen&#41;;
         $fh-&gt;seek&#40;$here,0&#41;;
         $self-&gt;{xRes}=[unpack&#40;$self-&gt;{rational},$self-&gt;{xRes}&#41;];
@@ -545,6 +551,7 @@ sub readTags {
         # yRes
         my $here=$fh-&gt;tell;
         $fh-&gt;seek&#40;$valOffset,0&#41;;
+        $self-&gt;{yRes} = undef; # suppress warning from IO::Handle
         $fh-&gt;read&#40;$self-&gt;{yRes},$valLen&#41;;
         $fh-&gt;seek&#40;$here,0&#41;;
         $self-&gt;{yRes}=[unpack&#40;$self-&gt;{rational},$self-&gt;{yRes}&#41;];
@@ -598,6 +605,7 @@ sub readTags {
         # imageID
         my $here=$fh-&gt;tell;
         $fh-&gt;seek&#40;$valOffset,0&#41;;
+        $self-&gt;{imageId} = undef; # suppress warning from IO::Handle
         $fh-&gt;read&#40;$self-&gt;{imageId},$valLen&#41;;
         $fh-&gt;seek&#40;$here,0&#41;;
 #      } elsif&#40;$valTag==&#41; {
-- 
2.4.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;14&nbsp;11:46:31&nbsp;2017</span>
    <span class="description">jffry [...] posteo.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry. Attached wrong patch. Please try this.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Use-libtiff-to-decode-image-data-in-TIFF-fixing-RT-1.patch</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;27&nbsp;04:10:03&nbsp;2017</span>
    <span class="description">jffry [...] posteo.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Grrr. My previous patch didn&#39;t apply cleanly to v2.033. This one does.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Use-libtiff-to-decode-image-data-in-TIFF-fixing-RT-1.patch</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;27&nbsp;04:14:51&nbsp;2017</span>
    <span class="description">jffry [...] posteo.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Because of the nature of libTIFF, it is not possible to pass an open filehandle.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;28&nbsp;08:14:56&nbsp;2017</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #118047] Adding 8bpp TIFF results in broken image</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 28 Jul 2017 14:14:58 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jeffrey Ratcliffe via RT &lt;bug-PDF-API2 [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Petr Pisar &lt;ppisar [...] redhat.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Jul 27, 2017 at 04:10:14AM -0400, Jeffrey Ratcliffe via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=118047">https://rt.cpan.org/Ticket/Display.html?id=118047</a></span> &gt;
&gt; 
&gt; Grrr. My previous patch didn&#39;t apply cleanly to v2.033. This one does.
</div>
Thank you for the patch. I tested it successfully. All PDF-API2 tests pass for
me as well as the reproducer I attached to original bug report.

I obtained the TIFF image when debugging gscan2pdf tool. It was produced by
ImageMagic &gt;= 6.9.3-0. The procedure is at
&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/ImageMagick/ImageMagick/issues/277">https://github.com/ImageMagick/ImageMagick/issues/277</a></span>&gt;.

-- Petr
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;05&nbsp;20:09:08&nbsp;2017</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jul 14 11:44:50 2017, RATCLIFFE wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The attached patch fixed this for me, albeit by adding the dependency
&gt; Graphics::TIFF, which uses libtiff to do the decompression.
</div>
Thanks for working on this!

Would it be possible to check whether Graphics::TIFF is installed at runtime, then use it if it&#39;s present?  I&#39;m hesitant to add a dependency that isn&#39;t pure-Perl.  Then, if Graphics::TIFF isn&#39;t present and there&#39;s an attempt to work with a TIFF file that isn&#39;t supported by the existing code in PDF::API2, we could give an error recommending that Graphics::TIFF get installed for broader TIFF support.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;16&nbsp;04:28:15&nbsp;2017</span>
    <span class="description">jffry [...] posteo.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Would it be possible to check whether Graphics::TIFF is installed at
&gt; runtime, then use it if it&#39;s present?  I&#39;m hesitant to add a
&gt; dependency that isn&#39;t pure-Perl.  Then, if Graphics::TIFF isn&#39;t
&gt; present and there&#39;s an attempt to work with a TIFF file that isn&#39;t
&gt; supported by the existing code in PDF::API2, we could give an error
&gt; recommending that Graphics::TIFF get installed for broader TIFF
&gt; support.
</div>
Of course, it is possible to check for Graphics::TIFF. My suggestion, however, would be that if it isn&#39;t present, then to completely disable the TIFF support, as the current code is hopelessly buggy.

Just out of interest, is your problem with non-pure-Perl code Windows support or something else?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;16&nbsp;04:29:31&nbsp;2017</span>
    <span class="description">jffry [...] posteo.net -  Cc RATCLIFFE added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;16&nbsp;12:07:56&nbsp;2017</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Just out of interest, is your problem with non-pure-Perl code Windows
&gt; support or something else?
</div>
Three things:

1&#41; Windows support.

2&#41; Ease of installation on any platform.  Right now, it installs cleanly from CPAN with no additional steps.  I&#39;d prefer not to give that up.

3&#41; Backwards compatibility.  The existing TIFF code is in use and working for some people&#39;s needs &#40;based on bug reports, in any case, which are of the &#34;it doesn&#39;t work in this case&#34; variety vs. &#34;it doesn&#39;t work at all&#34;&#41;.  If those people aren&#39;t in a position to install libtiff, I don&#39;t want the next version to break their code.

Since most TIFF-using people can probably benefit from using Graphics::TIFF, a simpler implementation might be to print a deprecation warning if Graphics::TIFF isn&#39;t installed and then fall back to the current code, and let it error or not as it currently does.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;17&nbsp;04:07:19&nbsp;2017</span>
    <span class="description">jffry [...] posteo.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I can see that I&#39;m on my own here &#40;apart from the OP&#41;, so I&#39;ll stop arguing about non-pure-Perl stuff.

How about this?

If Graphics::TIFF is installed, it uses it, otherwise it prints a warning and uses the legacy code.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> optionally-use-libtiff-for-handling-TIFFs-fixing-RT-1.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/Makefile.PL b/Makefile.PL
index 62e446b..c2bc047 100644
--- a/Makefile.PL
+++ b/Makefile.PL
@@ -18,7 +18,8 @@ my %WriteMakefileArgs = &#40;
   &#34;NAME&#34; =&gt; &#34;PDF::API2&#34;,
   &#34;PREREQ_PM&#34; =&gt; {
     &#34;Compress::Zlib&#34; =&gt; &#34;1.0&#34;,
-    &#34;Font::TTF&#34; =&gt; 0
+    &#34;Font::TTF&#34; =&gt; 0,
+    &#34;Try::Tiny&#34; =&gt; 0,
   },
   &#34;TEST_REQUIRES&#34; =&gt; {
     &#34;Test::Exception&#34; =&gt; 0,
diff --git a/lib/PDF/API2/Resource/XObject/Image/TIFF.pm b/lib/PDF/API2/Resource/XObject/Image/TIFF.pm
index fd283a5..da8a10e 100644
--- a/lib/PDF/API2/Resource/XObject/Image/TIFF.pm
+++ b/lib/PDF/API2/Resource/XObject/Image/TIFF.pm
@@ -15,6 +15,7 @@ use PDF::API2::Basic::PDF::Utils;
 use PDF::API2::Resource::XObject::Image::TIFF::File;
 use PDF::API2::Util;
 use Scalar::Util qw&#40;weaken&#41;;
+use Try::Tiny;
 
 =head1 NAME
 
@@ -32,6 +33,19 @@ Returns a tiff-image object.
 
 sub new {
     my &#40;$class, $pdf, $file, $name&#41; = @_;
+    try {
+        require Graphics::TIFF;
+        require PDF::API2::Resource::XObject::Image::TIFF_XS;
+        return PDF::API2::Resource::XObject::Image::TIFF_XS-&gt;new&#40;$pdf, $file, $name&#41;;
+    }
+    catch {
+        if &#40;/Graphics\/TIFF[.]pm/xsm&#41; {
+            warn &#34;Install Graphics::TIFF for better TIFF support in PDF::API2\n&#34;;
+        }
+        else {
+            die $_;
+        }
+    };
     my $self;
 
     my $tif = PDF::API2::Resource::XObject::Image::TIFF::File-&gt;new&#40;$file&#41;;
diff --git a/t/tiff.t b/t/tiff.t
index b39501c..1cb5fd8 100644
--- a/t/tiff.t
+++ b/t/tiff.t
@@ -1,4 +1,4 @@
-use Test::More tests =&gt; 8;
+use Test::More tests =&gt; 9;
 
 use warnings;
 use strict;
@@ -22,19 +22,6 @@ $gfx-&gt;image&#40;$tiff, 72, 144, 216, 288&#41;;
 like&#40;$pdf-&gt;stringify&#40;&#41;, qr/q 216 0 0 288 72 144 cm \S+ Do Q/,
      q{Add TIFF to PDF}&#41;;
 
-# Filehandle
-
-$pdf = PDF::API2-&gt;new&#40;&#41;;
-open my $fh, &#39;&lt;&#39;, &#39;t/resources/1x1.tif&#39;;
-$tiff = $pdf-&gt;image_tiff&#40;$fh&#41;;
-isa_ok&#40;$tiff, &#39;PDF::API2::Resource::XObject::Image::TIFF&#39;,
-       q{$pdf-&gt;image_tiff&#40;filehandle&#41;}&#41;;
-
-is&#40;$tiff-&gt;width&#40;&#41;, 1,
-   q{Image from filehandle has a width}&#41;;
-
-close $fh;
-
 # LZW Compression
 
 $pdf = PDF::API2-&gt;new&#40;&#41;;
@@ -55,3 +42,72 @@ like&#40;$pdf-&gt;stringify&#40;&#41;, qr/q 216 0 0 432 72 360 cm \S+ Do Q/,
 $pdf = PDF::API2-&gt;new&#40;&#41;;
 eval { $pdf-&gt;image_tiff&#40;&#39;t/resources/this.file.does.not.exist&#39;&#41; };
 ok&#40;$@, q{Fail fast if the requested file doesn&#39;t exist}&#41;;
+
+##############################################################
+
+my $width = 568;
+my $height = 1000;
+$tiff = &#39;test.tif&#39;;
+my $pdfout = &#39;test.pdf&#39;;
+
+SKIP: {
+    skip &#34;tiff2pdf doesn&#39;t deal with the alpha layer properly either in this case&#34;, 1;
+system&#40;sprintf&#34;convert -depth 1 -gravity center -pointsize 78 -size %dx%d caption:&#39;Lorem ipsum etc etc&#39; %s&#34;, $width, $height, $tiff&#41;;
+$pdf = PDF::API2-&gt;new&#40;-file =&gt; $pdfout&#41;;
+my $page = $pdf-&gt;page;
+$page-&gt;mediabox&#40; $width, $height &#41;;
+$gfx = $page-&gt;gfx;
+my $img = $pdf-&gt;image_tiff&#40;$tiff&#41;;
+$gfx-&gt;image&#40; $img, 0, 0, $width, $height &#41;;
+$pdf-&gt;save;
+$pdf-&gt;end;
+
+my $example = `convert $pdfout -depth 1 -resize 1x1 txt:-`;
+my $expected = `convert $tiff -depth 1 -resize 1x1 txt:-`;
+
+is&#40;$example, $expected, &#39;alpha&#39;&#41;;
+}
+
+##############################################################
+
+SKIP: {
+    skip &#34;files created with tiffcp -c g3 previously produced the &#39;message chunked ccitt g4 tif not supported&#39;&#34;, 1;
+system&#40;sprintf&#34;convert -depth 1 -gravity center -pointsize 78 -size %dx%d caption:&#39;Lorem ipsum etc etc&#39; -background white -alpha off %s&#34;, $width, $height, $tiff&#41;;
+system&#40;&#34;tiffcp -c g3 $tiff tmp.tif &#38;&#38; mv tmp.tif $tiff&#34;&#41;;
+$pdf = PDF::API2-&gt;new&#40;-file =&gt; $pdfout&#41;;
+my $page = $pdf-&gt;page;
+$page-&gt;mediabox&#40; $width, $height &#41;;
+$gfx = $page-&gt;gfx;
+my $img = $pdf-&gt;image_tiff&#40;$tiff&#41;;
+$gfx-&gt;image&#40; $img, 0, 0, $width, $height &#41;;
+$pdf-&gt;save;
+$pdf-&gt;end;
+
+my $example = `convert $pdfout -depth 1 -resize 1x1 txt:-`;
+my $expected = `convert $tiff -depth 1 -resize 1x1 txt:-`;
+
+is&#40;$example, $expected, &#39;g3 &#40;not converted to flate&#41;&#39;&#41;;
+}
+##############################################################
+
+system&#40;sprintf&#34;convert -depth 1 -gravity center -pointsize 78 -size %dx%d caption:&#39;Lorem ipsum etc etc&#39; -background white -alpha off %s&#34;, $width, $height, $tiff&#41;;
+system&#40;&#34;tiffcp -c lzw $tiff tmp.tif &#38;&#38; mv tmp.tif $tiff&#34;&#41;;
+$pdf = PDF::API2-&gt;new&#40;-file =&gt; $pdfout&#41;;
+my $page = $pdf-&gt;page;
+$page-&gt;mediabox&#40; $width, $height &#41;;
+$gfx = $page-&gt;gfx;
+my $img = $pdf-&gt;image_tiff&#40;$tiff&#41;;
+$gfx-&gt;image&#40; $img, 0, 0, $width, $height &#41;;
+$pdf-&gt;save;
+$pdf-&gt;end;
+
+my $example = `convert $pdfout -depth 1 -colorspace gray -alpha off -resize 1x1 txt:-`;
+my $expected = `convert $tiff -depth 1 -resize 1x1 txt:-`;
+
+is&#40;$example, $expected, &#39;lzw &#40;converted to flate&#41;&#39;&#41;;
+
+##############################################################
+
+unlink $pdfout, $tiff;
+
+##############################################################
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;17&nbsp;04:10:37&nbsp;2017</span>
    <span class="description">jffry [...] posteo.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Grr. git diff does include newly added files, so it&#39;s missed half the patch. Please try this.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Optionally-use-libtiff-for-handling-TIFFs.patch</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;17&nbsp;11:33:06&nbsp;2017</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Nov 17 04:10:37 2017, RATCLIFFE wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Grr. git diff does include newly added files, so it&#39;s missed half the
&gt; patch.
</div>
I’ve run into that problem myself many times.  What I now do is something like:

$ touch foo/bar
$ git add foo/bar
.... make changes ....
$ git diff
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;04&nbsp;13:43:42&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">FYI, this is fixed in PDF::Builder &#40;requires use of optional Graphics::TIFF library&#41;
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
