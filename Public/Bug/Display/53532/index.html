<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #53532 for XML-LibXML: appendTextChild is sensitive to internal format of text</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #53532 for XML-LibXML: appendTextChild is sensitive to internal format of text</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=XML-LibXML">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=XML-LibXML">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=XML-LibXML">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=XML-LibXML">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-LibXML">XML-LibXML CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">53532</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=XML-LibXML">XML-LibXML</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
IKEGAMI [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-37350-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
1.66</li>
<li>
1.70</li>
</ul>
    </td>
  </tr>
  <tr id="CF-37351-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




test.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/727957/375978/test.pl">
Tue Feb 02 09:54:23 2010 (449b) by CJK [...] cpan.org
</a>
</font></li>
</ul>


test1.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/727961/375984/test1.pl">
Tue Feb 02 10:05:32 2010 (415b) by CJK [...] cpan.org
</a>
</font></li>
</ul>


test2.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/727961/375983/test2.pl">
Tue Feb 02 10:05:32 2010 (416b) by CJK [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=53532">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-717607" href="/Public/Bug/Display.html?id=53532#txn-717607">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;08&nbsp;23:47:13&nbsp;2010</span>
    <span class="description">IKEGAMI [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/717607/370425/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/370425">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 657b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">appendTextChild is sensitive to the internal format Perl is using to
store the string containg its second argument.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">---------- BEGIN CODE ----------
use strict;
use warnings;

use XML::LibXML qw&#40; &#41;;

my $s = &#34;abcd\x{f6}efgh&#34;;

if &#40;$ARGV[0]&#41; {
    # One internal format
    utf8::downgrade&#40;$s&#41;;
} else {
    # Other internal format
    utf8::upgrade&#40;$s&#41;;
}

XML::LibXML::Element-&gt;new&#40;&#39;foo&#39;&#41;-&gt;appendTextChild&#40;&#39;Node&#39;, $s&#41;;

<div class="message-stanza open">---------- END CODE ----------

<div class="message-stanza open">---------- BEGIN OUTPUT ----------
<div class="message-stanza open">&gt;perl test.pl 0
</div>
<div class="message-stanza open">&gt;perl test.pl 1
</div>error : xmlEncodeEntitiesReentrant : char out of range

<div class="message-stanza open">---------- END OUTPUT ----------

Interestingly, the resulting XML is identical.
</div></div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-717610" href="/Public/Bug/Display.html?id=53532#txn-717610">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;08&nbsp;23:47:45&nbsp;2010</span>
    <span class="description">IKEGAMI [...] cpan.org -  Subject changed from &#40;no value&#41; to &#39;appendTextChild is sensitive to internal format of text&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-727957" href="/Public/Bug/Display.html?id=53532#txn-727957">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;02&nbsp;09:54:23&nbsp;2010</span>
    <span class="description">CJK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/727957/375977/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/375977">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 532b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">More seriously, for other Latin-1 characters, the output gets mangled and no warning is 
emitted.

# perl test.pl f6 0
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;foo&gt;&lt;Node&gt;abcdöefgh&lt;/Node&gt;&lt;/foo&gt;

# perl test.pl f6 1
error : xmlEncodeEntitiesReentrant : char out of range
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;foo&gt;&lt;Node&gt;abcdöefgh&lt;/Node&gt;&lt;/foo&gt;

# perl test.pl e1 0
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;foo&gt;&lt;Node&gt;abcdáefgh&lt;/Node&gt;&lt;/foo&gt;

# perl test.pl e1 1
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;foo&gt;&lt;Node&gt;abcdᥦgh&lt;/Node&gt;&lt;/foo&gt;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/727957/375978/test.pl">Download test.pl</a><br />
<span class="downloadcontenttype">text/x-perl 449b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use warnings;

use XML::LibXML qw&#40; &#41;;

my $s = &#34;abcd&#34; . chr&#40;hex&#40;$ARGV[0]&#41;&#41; . &#34;efgh&#34;;

if &#40;$ARGV[1]&#41; {
# One internal format
    utf8::downgrade&#40;$s&#41;;
} else {
# Other internal format
    utf8::upgrade&#40;$s&#41;;
}

my $e = XML::LibXML::Element-&gt;new&#40;&#39;foo&#39;&#41;;
$e-&gt;appendTextChild&#40;&#39;Node&#39;, $s&#41;;

my $d = XML::LibXML::Document-&gt;new&#40;&#34;1.0&#34;,&#34;UTF-8&#34;&#41;;
$d-&gt;setDocumentElement&#40;$e&#41;;

$e-&gt;appendTextChild&#40;&#39;Node&#39;, $s&#41;;

print $d-&gt;toString&#40;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-727960" href="/Public/Bug/Display.html?id=53532#txn-727960">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;02&nbsp;09:54:25&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-727961" href="/Public/Bug/Display.html?id=53532#txn-727961">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;02&nbsp;10:05:31&nbsp;2010</span>
    <span class="description">CJK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/727961/375982/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/375982">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Please disregard previous comment + attachment, it confuses two issues that were to be 
reported seperately.

test1.pl demonstrates how some Latin-1 input characters get silently corrupted:

# perl test1.pl f6 0
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;foo&gt;&lt;Node&gt;abcdöefgh&lt;/Node&gt;&lt;/foo&gt;

# perl test1.pl f6 1
error : xmlEncodeEntitiesReentrant : char out of range
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;foo&gt;&lt;Node&gt;abcdöefgh&lt;/Node&gt;&lt;/foo&gt;

# perl test1.pl e1 0
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;foo&gt;&lt;Node&gt;abcdáefgh&lt;/Node&gt;&lt;/foo&gt;

# perl test1.pl e1 1
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;foo&gt;&lt;Node&gt;abcdᥦgh&lt;/Node&gt;&lt;/foo&gt;


test2.pl demonstrates how invalid utf-8 output can result:

#perl /srv/scratch/test2.pl f6 0
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;foo&gt;&lt;Node&gt;abcdöefgh&lt;/Node&gt;&lt;/foo&gt;

#perl /srv/scratch/test2.pl f6 1
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;foo&gt;&lt;Node&gt;abcd?efgh&lt;/Node&gt;&lt;/foo&gt;

#perl /srv/scratch/test2.pl f6 1 | hexdump -Cv
00000000  3c 3f 78 6d 6c 20 76 65  72 73 69 6f 6e 3d 22 31  |&lt;?xml version=&#34;1|
00000010  2e 30 22 20 65 6e 63 6f  64 69 6e 67 3d 22 55 54  |.0&#34; encoding=&#34;UT|
00000020  46 2d 38 22 3f 3e 0a 3c  66 6f 6f 3e 3c 4e 6f 64  |F-8&#34;?&gt;.&lt;foo&gt;&lt;Nod|
00000030  65 3e 61 62 63 64 f6 65  66 67 68 3c 2f 4e 6f 64  |e&gt;abcd.efgh&lt;/Nod|
00000040  65 3e 3c 2f 66 6f 6f 3e  0a                       |e&gt;&lt;/foo&gt;.|
00000049
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test2.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/727961/375983/test2.pl">Download test2.pl</a><br />
<span class="downloadcontenttype">text/x-perl 416b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use warnings;

use XML::LibXML qw&#40; &#41;;

my $s = &#34;abcd&#34; . chr&#40;hex&#40;$ARGV[0]&#41;&#41; . &#34;efgh&#34;;

if &#40;$ARGV[1]&#41; {
# One internal format
    utf8::downgrade&#40;$s&#41;;
} else {
# Other internal format
    utf8::upgrade&#40;$s&#41;;
}

my $e = XML::LibXML::Element-&gt;new&#40;&#39;foo&#39;&#41;;

my $d = XML::LibXML::Document-&gt;new&#40;&#34;1.0&#34;,&#34;UTF-8&#34;&#41;;
$d-&gt;setDocumentElement&#40;$e&#41;;

$e-&gt;appendTextChild&#40;&#39;Node&#39;, $s&#41;;

print $d-&gt;toString&#40;&#41;;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test1.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/727961/375984/test1.pl">Download test1.pl</a><br />
<span class="downloadcontenttype">text/x-perl 415b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use warnings;

use XML::LibXML qw&#40; &#41;;

my $s = &#34;abcd&#34; . chr&#40;hex&#40;$ARGV[0]&#41;&#41; . &#34;efgh&#34;;

if &#40;$ARGV[1]&#41; {
# One internal format
    utf8::downgrade&#40;$s&#41;;
} else {
# Other internal format
    utf8::upgrade&#40;$s&#41;;
}

my $e = XML::LibXML::Element-&gt;new&#40;&#39;foo&#39;&#41;;
$e-&gt;appendTextChild&#40;&#39;Node&#39;, $s&#41;;

my $d = XML::LibXML::Document-&gt;new&#40;&#34;1.0&#34;,&#34;UTF-8&#34;&#41;;
$d-&gt;setDocumentElement&#40;$e&#41;;

print $d-&gt;toString&#40;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-859966" href="/Public/Bug/Display.html?id=53532#txn-859966">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;25&nbsp;15:09:24&nbsp;2010</span>
    <span class="description">daniel.frett [...] ccci.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> daniel.frett [...] ccci.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/859966/445103/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/445103">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is actually documented behavior, in the XML::LibXML documentation under the 
&#34;ENCODINGS SUPPORT IN XML::LIBXML&#34; section it says:

3. DOM methods also accept binary strings in the original encoding of the document to which 
the node belongs &#40;UTF-8 is assumed if the node is not attached to any document&#41;. Exploiting 
this feature is NOT RECOMMENDED since it is considered a bad practice.

my $doc = XML::LibXML:Document-&gt;new&#40;&#39;1.0&#39;,&#39;iso-8859-2&#39;&#41;;
my $text = $doc-&gt;createTextNode&#40;$some_latin2_encoded_byte_string&#41;;
# WORKS, BUT NOT RECOMMENDED!


I personally would prefer if XML::LibXML would by default treat all strings as character strings 
and automatically convert them, especially since the documented functionality is considered 
&#34;bad practice&#34;. But because it is documented behavior, this will break backwards 
compatability.

Maybe an alternative to help move people away from the bad practice of setting byte strings 
directly and encourage the use of character strings would be to add a global flag that can 
turn on/off treating all strings as character strings. Then through a deprecation schedule 
over several versions, start off with the option disabled by default, then enable it option by 
default, and &#40;maybe?&#41; at some point remove the byte string support.

On Fri Jan 08 23:47:13 2010, ikegami wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; appendTextChild is sensitive to the internal format Perl is using to
&gt; store the string containg its second argument.
&gt; 
&gt; ---------- BEGIN CODE ----------
&gt; use strict;
&gt; use warnings;
&gt; 
&gt; use XML::LibXML qw&#40; &#41;;
&gt; 
&gt; my $s = &#34;abcd\x{f6}efgh&#34;;
&gt; 
&gt; if &#40;$ARGV[0]&#41; {
&gt;     # One internal format
&gt;     utf8::downgrade&#40;$s&#41;;
&gt; } else {
&gt;     # Other internal format
&gt;     utf8::upgrade&#40;$s&#41;;
&gt; }
&gt; 
&gt; XML::LibXML::Element-&gt;new&#40;&#39;foo&#39;&#41;-&gt;appendTextChild&#40;&#39;Node&#39;, $s&#41;;
&gt; ---------- END CODE ----------
&gt; 
&gt; ---------- BEGIN OUTPUT ----------
<div class="message-stanza open">&gt; &gt;perl test.pl 0
</div>&gt; 
<div class="message-stanza open">&gt; &gt;perl test.pl 1
</div>&gt; error : xmlEncodeEntitiesReentrant : char out of range
&gt; ---------- END OUTPUT ----------
&gt; 
&gt; Interestingly, the resulting XML is identical.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-859991" href="/Public/Bug/Display.html?id=53532#txn-859991">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;25&nbsp;16:49:11&nbsp;2010</span>
    <span class="description">ikegami [...] adaelis.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #53532] appendTextChild is sensitive to internal format of text</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Nov 2010 16:49:03 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-LibXML [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Brine &lt;ikegami [...] adaelis.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/859991/445117/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/445117">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 637b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Nov 25, 2010 at 3:09 PM, Daniel Frett via RT
&lt;bug-XML-LibXML@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; especially since the documented functionality is considered
&gt; &#34;bad practice&#34;.
</div>
It&#39;s bad practice because it makes the following two statements not
equivalent even though &#34;é&#34; is Unicode character E9:

use utf8; -&gt;createTextNode&#40;&#34;abcdéf&#34;&#41;;
use utf8; -&gt;createTextNode&#40;&#34;abcd\x{E9}f&#34;&#41;;

Workaround for Perl 5.12+:

use utf8; -&gt;createTextNode&#40;&#34;abcd\N{U+E9}f&#34;&#41;;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But because it is documented behavior, this will break backwards
&gt; compatability.
</div>
That&#39;s unfortunate. Your solution sounds perfectly reasonable, though.

Thanks for having a look,
Eric
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-957991" href="/Public/Bug/Display.html?id=53532#txn-957991">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;20&nbsp;16:11:57&nbsp;2011</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/957991/498444/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/498444">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 67b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Resolving as rejected per the discussion.

Regards,

-- Shlomi Fish
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-957994" href="/Public/Bug/Display.html?id=53532#txn-957994">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;20&nbsp;16:11:58&nbsp;2011</span>
    <span class="description">SHLOMIF [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-958017" href="/Public/Bug/Display.html?id=53532#txn-958017">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;20&nbsp;17:17:33&nbsp;2011</span>
    <span class="description">ikegami [...] adaelis.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> IKEGAMI [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #53532] appendTextChild is sensitive to internal format of text</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 20 Jul 2011 17:17:22 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-LibXML [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Brine &lt;ikegami [...] adaelis.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/958017/498465/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/498465">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 361b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Jul 20, 2011 at 4:11 PM, Shlomi Fish via RT &lt;
bug-XML-LibXML@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=53532">https://rt.cpan.org/Ticket/Display.html?id=53532</a></span> &gt;
&gt;
&gt; Resolving as rejected per the discussion.
&gt;
</div>
The *ticket* shouldn&#39;t be rejected. The only thing that was rejected was
*changing createTextNode*.  That does not preclude adding a function that
actually works.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/958017/498466/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/498466">with headers</a>
<br />
<span class="downloadcontenttype">text/html 747b</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-958020" href="/Public/Bug/Display.html?id=53532#txn-958020">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;20&nbsp;17:17:35&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;rejected&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-958021" href="/Public/Bug/Display.html?id=53532#txn-958021">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;20&nbsp;17:26:29&nbsp;2011</span>
    <span class="description">ikegami [...] adaelis.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> IKEGAMI [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #53532] appendTextChild is sensitive to internal format of text</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 20 Jul 2011 17:26:15 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-LibXML [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Brine &lt;ikegami [...] adaelis.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/958021/498470/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/498470">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 732b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Jul 20, 2011 at 5:17 PM, Eric Brine &lt;ikegami@adaelis.com&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed, Jul 20, 2011 at 4:11 PM, Shlomi Fish via RT &lt;
&gt; bug-XML-LibXML@rt.cpan.org&gt; wrote:
&gt;
<div class="message-stanza open">&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=53532">https://rt.cpan.org/Ticket/Display.html?id=53532</a></span> &gt;
&gt;&gt;
&gt;&gt; Resolving as rejected per the discussion.
&gt;&gt;
</div>&gt;
&gt; The *ticket* shouldn&#39;t be rejected. The only thing that was rejected was
&gt; *changing createTextNode*.  That does not preclude adding a function that
&gt; actually works.
&gt;
</div>
Possible ways forward:

- Adding a note in the documentation that utf8::upgrade must be called on
text passed to createTextNode.
- Adding new function that always treats the argument as text.
- Adding a config option that makes createTextNode always treat the argument
as text.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/958021/498471/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/498471">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1.3k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.725613</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
