<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #87428 for DBD-mysql: data corruption: DBD::mysql ignores the utf8-flag</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #87428 for DBD-mysql: data corruption: DBD::mysql ignores the utf8-flag</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-mysql/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-mysql">DBD-mysql CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">87428</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-mysql/Active/">DBD-mysql</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">CAPTTOFU [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
MLEHMANN [...] cpan.org

<br />
pali [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
DBOOK [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10170-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
4.023    </td>
  </tr>
  <tr id="CF-10171-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
4.041_01    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;29&nbsp;22:45:01&nbsp;2013</span>
    <span class="description">MLEHMANN [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> data corruption: DBD::mysql ignores the utf8-flag</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">perl knows two internal decoding for strings - plain octets and utf-8. which encoding is used is indicated by the so-called utf8 flag. some strings can be encoded in both formats, and some strings cna be encoded only in utf-8 &#40;when they contain character codes &gt;255&#41;.

mysql &#40;at least in the protocol&#41; cannot handle any characters &gt;255. it can handle utf-8, but utf-8 contains only byte values, i.e. &lt;= 255.

unfortunately, DBD::mysql doesn&#39;t understand the internal perl string encoding, and sometimes corrupts data.

here is an example string:

   my $str = &#34;\xaf&#34;;

internally, this string can be encoded either as plain octets with utf-8 flag clear, or as utf-8 string with the utf8 flag set.

when passed to mysql, e.g. to execute, mysql _ignores_ the utf8 flag, which corrupts the value, as the utf8 flag indicates how the in-memory bytes need to be interpreted, and mysql doesn&#39;t have this information anymore.

for example, when $str is internally utf8-encoded, mysql instead receives the string &#34;\xc2\xaf&#34;, which is rather different.

since the string acts identically on the Perl level regardless of the utf8 flag &#40;and indeed compares identically to itself regardless of the flag value&#41;, this is hard-to-debug action at a distance, as two strings that are identical to perl &#40;compare the same, print the same etc.&#41; are passed as two different strings by DBD::mysql.

the obvious fix is to downgrade scalars before passing them to mysql. this has two effects: 1. it ensures the corretc data is always passed, regardless of the internal encoding and 2. it can warn the user when character codes &gt;255 are used, which mysql cannot handle &#40;the user would have to encode them to utf-8 first for example&#41;.

the reason why this is rarely a big issue is that perl currently avoids upgrading the scalar in many cases, and downgrades them when it thinks performance can be helped &#40;for example, different versions of perl encode constant strings differently depending on whether &#34;use utf8&#34; is in use&#41;.

still, it cost me a few hours of debugging today, because I hit exactly that case, and couldn&#39;t believe that DBD::mysql hasn&#39;t been updated since the string model changed in 5.005 :/
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;29&nbsp;22:47:46&nbsp;2013</span>
    <span class="description">MLEHMANN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">a slight addendum: this is a bug in DBD::mysql and not in DBI, as some databases can handle data with character codes &gt;255 &#40;usually unicode&#41;, so it is up to the database driver to correctly encode the data for the database.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;02&nbsp;01:32:18&nbsp;2014</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jul 30 06:45:01 2013, MLEHMANN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; the obvious fix is to downgrade scalars before passing them to mysql.
&gt; this has two effects: 1. it ensures the corretc data is always passed,
&gt; regardless of the internal encoding and 2. it can warn the user when
&gt; character codes &gt;255 are used, which mysql cannot handle &#40;the user
&gt; would have to encode them to utf-8 first for example&#41;.
</div>
This would break code which works with perl character strings and stores it in mysql &#40;with SET NAMES UTF8 option&#41;.

You can argue that such code should be written with DBI option mysql_enable_utf8=1 &#40;and DBI/DBD should skip downgrading strings&#41;, but there would be same problem with binary data - binary data should be downgraded and DBI cannot distinct binary data &#40;for BLOB columns etc&#41; and character data &#40;VARCHAR&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;02&nbsp;01:32:19&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;02&nbsp;14:05:21&nbsp;2014</span>
    <span class="description">schmorp [...] schmorp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> MLEHMANN [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #87428] data corruption: DBD::mysql ignores the utf8-flag</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 2 Apr 2014 20:05:06 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Victor Efimov via RT &lt;bug-DBD-mysql [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marc Lehmann &lt;schmorp [...] schmorp.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Apr 02, 2014 at 01:32:19AM -0400, Victor Efimov via RT &lt;bug-DBD-mysql@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Jul 30 06:45:01 2013, MLEHMANN wrote:
<div class="message-stanza open">&gt; &gt; the obvious fix is to downgrade scalars before passing them to mysql.
&gt; &gt; this has two effects: 1. it ensures the corretc data is always passed,
&gt; &gt; regardless of the internal encoding and 2. it can warn the user when
&gt; &gt; character codes &gt;255 are used, which mysql cannot handle &#40;the user
&gt; &gt; would have to encode them to utf-8 first for example&#41;.
</div>&gt; 
&gt; This would break code which works with perl character strings and stores it in mysql &#40;with SET NAMES UTF8 option&#41;.
</div>
That is incorrect: such code would work fine as well with downgraded
strings &#40;utf-8 is a byte-encoding&#41;.

If you mean code that doesn&#39;t use utf-8, but unicode strings, then it&#39;s
still incorrect: such code currently suffers from the reverse problem,
i.e. sometimes data would be passed as binary or latin1, sometimes as
utf-8. The solution for that would be always upgrading.

No matter how you turn it, DBD::mysql is simply broken w.r.t. perl
strings, because it doesn&#39;t let the user chose the format.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You can argue that such code should be written with DBI option
&gt; mysql_enable_utf8=1 &#40;and DBI/DBD should skip downgrading strings&#41;, but
</div>
No, this option has nothing to do with it - set names utf8 works fine with
binary data &#40;unless DBD::mysql is even more buggy&#41;, as utf8 is binary
data.

The problem is indeed as I reported - DBD::mysql wasn&#39;t updated to the new
string model in perl 5.6, and currently randomly corrupts data.

Since this is apparently a hard to understand problem, and I don&#39;t quite
know which part is unclear, let me assure you I will be happy to explain how
the perl string model works, how utf-8 works and so on, but I need some clues
on where the misunderstanding sits.

As a primer, try to distinguish between Perl and C - in perl, strings are
simply lists of characters, and since perl 5.6, these characters can have
codes &gt; 255.

Internally, as an optimisation, perl has two different and incompatible
representations, utf-8 encoded and byte-encoded.

Both forms can hold unicode and binary data&#40;!&#41;, the utf8 flag _only_
changes how the character codes are represented, it doesn&#39;t change their
interpretation.

On the Perl level, the flag value is essentially random, as semantics are
not supposed toc hange depending on the utf-8 flag, and it&#39;s not specified
when and how this flag changes value, so on the Perl level, you cannot
reliably affect this flag except by version-specific and undocumented
hackery.

A similar problem exists for numbers: perl doesn&#39;t distinguish between
numbers and strings, so mysql has to guess &#40;or the user has to specify a
type, which is possible with bind_param&#41;.

What DBI::mysql currently does is to take perl strings and randomly either
encode them in utf-8 or byte encoding, regardless of what the encoding of
the string really is.

Fixing this might break some code that currently depends on undocumented
and version-specific perl behaviour, but it enables writing code that no
longer depends on such hacks. Right now, it&#39;s impossible to reliably pass
binary &#40;or utf-8&#41; data to mysql&#40;!&#41; - the rules can &#40;and do&#41; change in
every perl version.

-- 
                The choice of a       Deliantra, the free code+content MORPG
      -----==-     _GNU_              <span class="clickylink"><a target="new" rel="nofollow" href="http://www.deliantra.net">http://www.deliantra.net</a></span>
      ----==-- _       generation
      ---==---&#40;_&#41;__  __ ____  __      Marc Lehmann
      --==---/ / _ \/ // /\ \/ /      schmorp@schmorp.de
      -=====/_/_//_/\_,_/ /_/\_\
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;04&nbsp;07:18:14&nbsp;2014</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> schmorp [...] schmorp.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Apr 02 22:05:21 2014, schmorp@schmorp.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed, Apr 02, 2014 at 01:32:19AM -0400, Victor Efimov via RT &lt;bug-
&gt; DBD-mysql@rt.cpan.org&gt; wrote:
<div class="message-stanza open">&gt; &gt; On Tue Jul 30 06:45:01 2013, MLEHMANN wrote:
<div class="message-stanza open">&gt; &gt; &gt; the obvious fix is to downgrade scalars before passing them to
&gt; &gt; &gt; mysql.
&gt; &gt; &gt; this has two effects: 1. it ensures the corretc data is always
&gt; &gt; &gt; passed,
&gt; &gt; &gt; regardless of the internal encoding and 2. it can warn the user
&gt; &gt; &gt; when
&gt; &gt; &gt; character codes &gt;255 are used, which mysql cannot handle &#40;the user
&gt; &gt; &gt; would have to encode them to utf-8 first for example&#41;.
</div>&gt; &gt;
&gt; &gt; This would break code which works with perl character strings and
&gt; &gt; stores it in mysql &#40;with SET NAMES UTF8 option&#41;.
</div>&gt; 
</div>[cut]
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If you mean code that doesn&#39;t use utf-8, but unicode strings, then
&gt; it&#39;s
&gt; still incorrect: such code currently suffers from the reverse problem,
&gt; i.e. sometimes data would be passed as binary or latin1, sometimes as
&gt; utf-8. The solution for that would be always upgrading.
</div>
Yes, I meant character strings &#40;unicode strings&#41;. I told that it would break existing code, and this is correct.

We have such code now, it works fine because downgraded unicode strings are rare and because we use it for Russian text &#40;which cannot be downgraded&#41;. So I would consider it broken in rare cases.

But you proposal will break it in _all_ cases.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; No matter how you turn it, DBD::mysql is simply broken w.r.t. perl
&gt; strings, because it doesn&#39;t let the user chose the format.
</div>
I agree - it&#39;s broken on API level. It should have different API where users can specify where is binary string and where is character string.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt; You can argue that such code should be written with DBI option
&gt; &gt; mysql_enable_utf8=1 &#40;and DBI/DBD should skip downgrading strings&#41;,
&gt; &gt; but
</div>&gt; 
&gt; No, this option has nothing to do with it - set names utf8 works fine
&gt; with
&gt; binary data &#40;unless DBD::mysql is even more buggy&#41;, as utf8 is binary
&gt; data.
&gt; 
</div>
Yes, right. I think you misunderstands me - actually I meant that you _could_ suggest a solution that people should not use unicode character strings without mysql_enable_utf8=1 &#40;and this will make you proposal for downgrading strings valid when mysql_enable_utf8=0&#41;, and I explained why this would not help either - that&#39;s because even in mysql_enable_utf8=1 mode there will be binary data for binary columns that should not be upgraded.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; know which part is unclear, let me assure you I will be happy to
&gt; explain how
&gt; the perl string model works, how utf-8 works and so on, but I need
&gt; some clues
</div>
No, thank you, I think I already know how it works. Also FYI I am not maintainer of this module.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;04&nbsp;07:31:55&nbsp;2014</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jul 30 06:45:01 2013, MLEHMANN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; the obvious fix is to downgrade scalars before passing them to mysql.
&gt; this has two effects: 1. it ensures the corretc data is always passed,
&gt; regardless of the internal encoding and 2. it can warn the user when
&gt; character codes &gt;255 are used, which mysql cannot handle &#40;the user
&gt; would have to encode them to utf-8 first for example&#41;.
</div>
Probably I missed that part - &#34;&#40;the user would have to encode them to utf-8 first for example&#41;&#34; - that would work, but that would too much code to encode each character strings to utf8 before passing to DBI + additionals performance costs. Also a function to encode string could ensure encoded string returned in downgraded form, so there is nothing to fix in DBI - user can implement and use such function by himself &#40;and another one to ensude binary strings are downgraded&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;05&nbsp;15:53:21&nbsp;2014</span>
    <span class="description">schmorp [...] schmorp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #87428] data corruption: DBD::mysql ignores the utf8-flag</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 5 Apr 2014 21:53:08 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Victor Efimov via RT &lt;bug-DBD-mysql [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marc Lehmann &lt;schmorp [...] schmorp.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Apr 04, 2014 at 07:18:15AM -0400, Victor Efimov via RT &lt;bug-DBD-mysql@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Yes, I meant character strings &#40;unicode strings&#41;. I told that it would break existing code, and this is correct.
</div>
It&#39;s not, and nothign you say indicates otherwise.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; We have such code now, it works fine
</div>
It works fine by accident only. It might not work with older or newer perl
versions, because it relies on undocumented behaviour inside the perl
interpreter which can and does change in different versions.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; because downgraded unicode strings are rare
</div>
They are rare because you are lucky - but what happens when you hit that
rare case? Does your code that works fine still work fine in these rare
cases?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; and because we use it for Russian text &#40;which cannot be downgraded&#41;.
</div>
Russian text can easily be downgraded, for example when it&#39;s encoded in
utf-8, as required by mysql.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So I would consider it broken in rare cases.
</div>
The key is that the code in question already is broken, even if you are
lucky and it works except in rare cases.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But you proposal will break it in _all_ cases.
</div>
Not sure, but possible. The key, again, is that the change would allow one to
fix broken code such as yours. Right now, the best you cna achieve is code
that happens to work &#34;most of the time&#34;.

So your proposal is to keep a bug that makes it impossible to write corretc
and working code, because it makes already broken code fail
deterministically.

I would say that&#39;s a ridiculous proposal. Why would anybody want
guaranteed brokenness?

Even you admit that your code already *is* broken.

And so is my own code. And there is no way to fix either until DBD::mysql
is fixed. I can try various workarounds such as utf8::downgrade or
upgrade, but that doesn&#39;t fix the code, it only makes it work with my
current perl binary.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; No matter how you turn it, DBD::mysql is simply broken w.r.t. perl
&gt; &gt; strings, because it doesn&#39;t let the user chose the format.
</div>&gt; 
&gt; I agree - it&#39;s broken on API level. It should have different API where users can specify where is binary string and where is character string.
</div>
Either that, or it should simply offer the same API as mysql, namely use
the same encodign as the underlying c lib, just as basically any other
library does on the planet &#40;compare Compress::Zlib for example, which
doesn&#39;t have this bug, and also doesn&#39;t require extra specificatrion of
whether something is a text string or not&#41;.

I think whoever implemented this utf-8 stuff in DBD::mysql was simply
confused - utf-8 strings aren&#39;t unicode strings.

Fortunately, this is not a situation that created a backwards
compatibility problem, because the behaviour isn&#39;t deterministic, but
effectively random.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; binary data &#40;unless DBD::mysql is even more buggy&#41;, as utf8 is binary
</div>&gt; 
&gt; Yes, right. I think you misunderstands me - actually I meant that you
&gt; _could_ suggest a solution that people should not use unicode character
&gt; strings without mysql_enable_utf8=1 &#40;and this will make you proposal for
&gt; downgrading strings valid when mysql_enable_utf8=0&#41;, and I explained why
&gt; this would not help either - that&#39;s because even in mysql_enable_utf8=1
&gt; mode there will be binary data for binary columns that should not be
&gt; upgraded.
</div>
The documentation of mysql_enable_utf8 says &#34;turning on this flag tells MySQL
that incoming data should be treated as UTF-8&#34;.

I don&#39;t know what the option does &#40;apparently, it doesn&#39;t treat anything as
utf-8 with this flag, right?&#41;, but as documented, yes, it&#39;s quite obvious
that you can&#39;t pass in generic binary data anymore.

&#40;In fact, I suspect when you pass in utf-8 data as expected, it will be
double-encoded, which would intorduce pretty obvious data corruption&#41;.

Of course, this option is marked as experimental &#40;in my copy at least&#41;, so
one shouldn&#39;t be surprised if a bug is found and fixed.

In any case, I don&#39;t see what mysql_enable_utf8 has to do with anything, it&#39;s
clearly a useless option unless all your data is unicode &#40;or utf-8?&#41;, and
even has the potential to corrupt data even more &#40;what happens when i pass
data to a binary column and retrieve it, will it double or even
triple-encoding the data in some cases? As the documentatino stands, it seems
that is the case&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; know which part is unclear, let me assure you I will be happy to
&gt; &gt; explain how
&gt; &gt; the perl string model works, how utf-8 works and so on, but I need
&gt; &gt; some clues
</div>&gt; 
&gt; No, thank you, I think I already know how it works.
</div>
It looks to me as if you keep confusing unicode and utf-8 strings. They are
different in Perl.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Also FYI I am not maintainer of this module.
</div>
I know, but the maintainer of this module could be confused by your wrong
comments, so it&#39;s good to clear up the situation.

Summary: your code is broken, and so is mine. You might not understand it
yet, but you are suffering from this very bug, just in reverse. If this bug
were fixed, we both could fix our code.

-- 
                The choice of a       Deliantra, the free code+content MORPG
      -----==-     _GNU_              <span class="clickylink"><a target="new" rel="nofollow" href="http://www.deliantra.net">http://www.deliantra.net</a></span>
      ----==-- _       generation
      ---==---&#40;_&#41;__  __ ____  __      Marc Lehmann
      --==---/ / _ \/ // /\ \/ /      schmorp@schmorp.de
      -=====/_/_//_/\_,_/ /_/\_\
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;05&nbsp;16:01:33&nbsp;2014</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> schmorp [...] schmorp.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; and because we use it for Russian text &#40;which cannot be downgraded&#41;.
</div>&gt; 
&gt; Russian text can easily be downgraded, for example when it&#39;s encoded
&gt; in
&gt; utf-8, as required by mysql.
&gt; 
</div>
As I told, I meant unicode character strings. By &#34;downgraded&#34; I mean &#34;utf8::downgrade&#34;. So Russian text cannot be utf8::downgrade&#39;d, because all characters are above 255. So perl character strings with Russian letters are always with UTF-8 flag on.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;05&nbsp;16:04:37&nbsp;2014</span>
    <span class="description">schmorp [...] schmorp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> MLEHMANN [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #87428] data corruption: DBD::mysql ignores the utf8-flag</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 5 Apr 2014 22:04:25 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Victor Efimov via RT &lt;bug-DBD-mysql [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marc Lehmann &lt;schmorp [...] schmorp.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Apr 04, 2014 at 07:31:56AM -0400, Victor Efimov via RT &lt;bug-DBD-mysql@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; the obvious fix is to downgrade scalars before passing them to mysql.
&gt; &gt; this has two effects: 1. it ensures the corretc data is always passed,
&gt; &gt; regardless of the internal encoding and 2. it can warn the user when
&gt; &gt; character codes &gt;255 are used, which mysql cannot handle &#40;the user
&gt; &gt; would have to encode them to utf-8 first for example&#41;.
</div>&gt; 
&gt; Probably I missed that part - &#34;&#40;the user would have to encode them to
&gt; utf-8 first for example&#41;&#34; - that would work, but that would too much
&gt; code to encode each character strings
</div>
Any evidence for that claim? I don&#39;t think there is.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; additionals performance costs.
</div>
The data needs to be transformed either inside or outside DBD::mysql, and
somehow the encoding must be specified anyways, so this would not incur any
additional performance costs &#40;but see below&#41;.

The only additional costs are the code that makes the program correct,
which is a required component, not something that could be optimised away.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Also a function to encode string could ensure encoded string returned in
&gt; downgraded form, so there is nothing to fix in DBI
</div>
I am not sure I understand that, but a DBD::mysql that force-accepts only
utf-8 with one option, and otherwise just passes through strings unchanged
would work fine for me &#40;I would simply disable the option and use utf-8
for text, and would never run into a problem&#41;.

An option to allow and return unicode strings for everything
&#34;non-numerical&#34; would probably be of more use overall, as many databases
are non-binary and then it would make it convenient to use unicode strings
in perl where mysql expects utf-8, and vice versa.

&#40;The numericalness can already be specified, and has to, as DBD::mysql
also cannot guess, so one cannot write correct code without specifying
it&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; user can implement and use such function by himself &#40;and another one to
&gt; ensude binary strings are downgraded&#41;.
</div>
AFAIK, there is no way to do that in Perl. The only way to do that
reliably would be in XS code inside the module that uses it, which means
it *has* to be in DBD::mysql &#40;the user cannot implement this on her own&#41;.

You are probably thinking of utf8::upgrade/downgrade or the like, but
these obviously cannot be sued to implement this. Their only use is to
work around broken libraries such as DBD::mysql while keeping your fingers
crossed that the next version of perl might not break your fix.

-- 
                The choice of a       Deliantra, the free code+content MORPG
      -----==-     _GNU_              <span class="clickylink"><a target="new" rel="nofollow" href="http://www.deliantra.net">http://www.deliantra.net</a></span>
      ----==-- _       generation
      ---==---&#40;_&#41;__  __ ____  __      Marc Lehmann
      --==---/ / _ \/ // /\ \/ /      schmorp@schmorp.de
      -=====/_/_//_/\_,_/ /_/\_\
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;05&nbsp;16:08:48&nbsp;2014</span>
    <span class="description">schmorp [...] schmorp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #87428] data corruption: DBD::mysql ignores the utf8-flag</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 5 Apr 2014 22:08:36 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Victor Efimov via RT &lt;bug-DBD-mysql [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marc Lehmann &lt;schmorp [...] schmorp.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, Apr 05, 2014 at 04:01:33PM -0400, Victor Efimov via RT &lt;bug-DBD-mysql@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; utf-8, as required by mysql.
&gt; &gt; 
</div>&gt; 
&gt; As I told, I meant unicode character strings. By &#34;downgraded&#34; I mean &#34;utf8::downgrade&#34;. So Russian text cannot be utf8::downgrade&#39;d, because all characters are above 255. So perl character strings with Russian letters are always with UTF-8 flag on.
</div>
Thanks for the clarification, I understand now what you meant to convey
now. In your original mail, you didn&#39;t say what you refer to.

-- 
                The choice of a       Deliantra, the free code+content MORPG
      -----==-     _GNU_              <span class="clickylink"><a target="new" rel="nofollow" href="http://www.deliantra.net">http://www.deliantra.net</a></span>
      ----==-- _       generation
      ---==---&#40;_&#41;__  __ ____  __      Marc Lehmann
      --==---/ / _ \/ // /\ \/ /      schmorp@schmorp.de
      -=====/_/_//_/\_,_/ /_/\_\
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;05&nbsp;16:23:28&nbsp;2014</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> schmorp [...] schmorp.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Apr 05 23:53:21 2014, schmorp@schmorp.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; The documentation of mysql_enable_utf8 says &#34;turning on this flag
&gt; tells MySQL
&gt; that incoming data should be treated as UTF-8&#34;.
&gt; 
&gt; I don&#39;t know what the option does &#40;apparently, it doesn&#39;t treat
&gt; anything as
&gt; utf-8 with this flag, right?&#41;, but as documented, yes, it&#39;s quite
&gt; obvious
&gt; that you can&#39;t pass in generic binary data anymore.
&gt; 
&gt; &#40;In fact, I suspect when you pass in utf-8 data as expected, it will
&gt; be
&gt; double-encoded, which would intorduce pretty obvious data corruption&#41;.
</div>
Let&#39;s see again what docs tell:
===
When set, a data retrieved from a textual column type &#40;char, varchar, etc&#41; will have the UTF-8 flag turned on if necessary. This enables character semantics on that string
===

that&#39;s correct. you get perl character strings, when reading data from mysql. &#40;except binary columns&#41;

===
Additionally, turning on this flag tells MySQL that incoming data should be treated as UTF-8. This will only take effect if used as part of the call to connect&#40;&#41;. If you turn the flag on after connecting, you will need to issue the command SET NAMES utf8 to get the same effect.
===

That means:
1&#41; it just issues &#34;SET NAMES utf8&#34; command. That&#39;s all. Nothing more.
2&#41; It tells MySQL &#40;mysql server daemon process, not DBD::mysql library&#41;, that data is in UTF-8. If we talk about things on MySQL daemon side, there are no &#34;character strings&#34; &#34;binary strings&#34; etc, no confusion between perl character strings with utf8 flag and data encoded in utf-8 &#40;usually without flag&#41;. so &#34;UTF-8&#34; here means just what it means in MySQL documentation. It&#39;s implemented via &#34;SET NAMES utf8&#34; command &#40;see &#40;1&#41;&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;05&nbsp;16:50:13&nbsp;2014</span>
    <span class="description">schmorp [...] schmorp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #87428] data corruption: DBD::mysql ignores the utf8-flag</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 5 Apr 2014 22:49:56 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Victor Efimov via RT &lt;bug-DBD-mysql [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marc Lehmann &lt;schmorp [...] schmorp.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, Apr 05, 2014 at 04:23:29PM -0400, Victor Efimov via RT &lt;bug-DBD-mysql@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; When set, a data retrieved from a textual column type &#40;char, varchar, etc&#41; will have the UTF-8 flag turned on if necessary. This enables character semantics on that string
&gt; ===
&gt; 
&gt; that&#39;s correct. you get perl character strings, when reading data from mysql. &#40;except binary columns&#41;
</div>
What does &#34;necessary&#34; mean? If it means that the utf-8 flag is turned on
if the mysql string contains characters &gt; 255, it would be correct. This
could be done if mysql ensures that everything is utf-8 encoded, in which
case blindly setting the utf-8 flag would work,

I don&#39;t know enough about libmysqlclient and mysqld to know what really
happens, but I wouldn&#39;t rely on this meaning something correct, given that
DBD::mysql is *known* to have a broken implementation.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Additionally, turning on this flag tells MySQL that incoming data should be treated as UTF-8. This will only take effect if used as part of the call to connect&#40;&#41;. If you turn the flag on after connecting, you will need to issue the command SET NAMES utf8 to get the same effect.
&gt; 
&gt; 1&#41; it just issues &#34;SET NAMES utf8&#34; command. That&#39;s all. Nothing more.
</div>
That&#39;s not what it says. It says if you turn on this flag after connect,
then you need to issue the set names utf8 command.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2&#41; It tells MySQL &#40;mysql server daemon process, not DBD::mysql library&#41;, that data is in UTF-8.
</div>
Do you have evidence for this? The official mysql docs say this only
indicates the encoding used for the sql statement, not the embedded data
&#40;which is usually interpolated, but does not have to be so&#41;.

This also makes sense - numbers are typically passed as strings in
protocol, but still stay numbers &#40;not utf-8 encoded data&#41; when the
statement is interpreted.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If we talk about things on MySQL daemon side, there are no &#34;character
&gt; strings&#34; &#34;binary strings&#34; etc, no confusion between perl character
&gt; strings with utf8 flag and data encoded in utf-8 &#40;usually without flag&#41;.
</div>
The MySQL daemon certainly distinguishes between character strings and
binary! &#34;char&#34; and &#34;binary&#34; are data types and treated differently in
mysql. binary strings compare differently than character strings for
example.

What it doesn&#39;t do is to distinguish between unicode and non-unicode in
the protocol, and that is exactly the problem - DBD::mysql either should not
attempt to distinguish, or should have a _deterministic_ algorithm.

Right now, DBD::mysql sometiems utf-8 encodes data, sometimes not for the
*same* strings on the Perl level.

This is simply a bug - no matter what *we* think DBD::mysql _should_ do,
it doesn&#39;t do it _right now_, because there is no deterministic way to
influence it from the Perl level.

As I have pointed out before, and as you chose to ignore: if you disagree,
tell me a deterministic way to get binary data in mysql, which works
in previous, current, and future versions &#40;as long as perl works as
documented&#41;.

That your program &#40;and now also my program&#41; happens to work with the
version of perl we employ is meaningless. I want a way that works
correctly, even in futrue versions of Perl.

Also, having to downgrade or upgrade every string before passing it to mysql
is clearly something you don&#39;t want to do, but is currently necessary as a
bug workaround.

Again, you are suffering form the sme bug right now, you just don&#39;t realise
it yet. All the drawbacks of the workarounds you think have to be employed
for a fix already have to be employed.

If DBD::mysql were fixed instead, most of these hacks wouldn&#39;t be
required.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; so &#34;UTF-8&#34; here means just what it means in MySQL documentation. It&#39;s
&gt; implemented via &#34;SET NAMES utf8&#34; command &#40;see &#40;1&#41;&#41;
</div>
&#34;just&#34; is a weasel word. As we have just seen, mysql documentation
disagrees with you, so it apparently isn&#39;t that simple :&#41;

-- 
                The choice of a       Deliantra, the free code+content MORPG
      -----==-     _GNU_              <span class="clickylink"><a target="new" rel="nofollow" href="http://www.deliantra.net">http://www.deliantra.net</a></span>
      ----==-- _       generation
      ---==---&#40;_&#41;__  __ ____  __      Marc Lehmann
      --==---/ / _ \/ // /\ \/ /      schmorp@schmorp.de
      -=====/_/_//_/\_,_/ /_/\_\
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;05&nbsp;16:53:47&nbsp;2014</span>
    <span class="description">schmorp [...] schmorp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #87428] data corruption: DBD::mysql ignores the utf8-flag</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 5 Apr 2014 22:53:36 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Victor Efimov via RT &lt;bug-DBD-mysql [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marc Lehmann &lt;schmorp [...] schmorp.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This also makes sense - numbers are typically passed as strings in
&gt; protocol, but still stay numbers &#40;not utf-8 encoded data&#41; when the
&gt; statement is interpreted.
</div>
What I forgot to mention, btw., is that, while the protocol distinguishes
between text &#40;MYSQL_TYPE_STRING&#41; and binary &#40;MYSQL_TYPE_BLOB&#41;, this
doesn&#39;t apply if values are interpolated, which is still, afaik, the
default way of how DBD::mysql operates.

-- 
                The choice of a       Deliantra, the free code+content MORPG
      -----==-     _GNU_              <span class="clickylink"><a target="new" rel="nofollow" href="http://www.deliantra.net">http://www.deliantra.net</a></span>
      ----==-- _       generation
      ---==---&#40;_&#41;__  __ ____  __      Marc Lehmann
      --==---/ / _ \/ // /\ \/ /      schmorp@schmorp.de
      -=====/_/_//_/\_,_/ /_/\_\
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;05&nbsp;18:37:02&nbsp;2014</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Apr 06 00:50:13 2014, schmorp@schmorp.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; As I have pointed out before, and as you chose to ignore: if you
&gt; disagree,
&gt; tell me a deterministic way to get binary data in mysql, which works
&gt; in previous, current, and future versions &#40;as long as perl works as
&gt; documented&#41;.
&gt; 
&gt; That your program &#40;and now also my program&#41; happens to work with the
&gt; version of perl we employ is meaningless. I want a way that works
&gt; correctly, even in futrue versions of Perl.
&gt; 
</div>
1&#41; new flag &#40;let&#39;s say &#34;mysql_enable_unicode&#34;&#41; which turn on new API. without that flag everything works old way &#40;let&#39;s call it &#34;old DBI API&#34;&#41;.

2&#41; when sending data to DBI:

- scalars treated as character strings, thus utf8::upgrad&#39;ed before processing by old DBI API.
- new exported function &#34;binary&#40;&#41;&#34;. binary&#40;$scalar&#41; will return blessed object which contains reference to the scalar.
when this object sent to DBI, DBI will detect the object and scalar will be utf8::downgraded before processing by old DBI API

3&#41; when reading data from DBI:
like now with mysql_enable_utf8 flag:
- &#34;SET NAMES utf8&#34; issued.
- When set, a data retrieved from a textual column type &#40;char, varchar, etc&#41; it will return character string.
- for binary column will return binary string.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;01&nbsp;19:28:13&nbsp;2015</span>
    <span class="description">DBOOK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is still a problem. For example, Spreadsheet::ParseExcel tends to return strings which are not utf8 upgraded, so passing them directly to DBD::mysql with mysql_enable_utf8 enabled results in collation conflicts &#40;Illegal mix of collations &#40;latin1_swedish_ci,IMPLICIT&#41; and &#40;utf8_general_ci,COERCIBLE&#41; ...&#41;. utf8::upgrade on every string being passed &#34;solves&#34; the issue, but this shouldn&#39;t be needed.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;05&nbsp;22:40:53&nbsp;2015</span>
    <span class="description">patg [...] patg.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #87428] data corruption: DBD::mysql ignores the utf8-flag</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 5 Oct 2015 22:40:29 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-mysql [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Patrick Galbraith &lt;patg [...] patg.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">thank you for the report! I will look at the driver and see what is needed to make this not require having to upgrade every string explicitly.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Oct 1, 2015, at 7:28 PM, Dan Book via RT &lt;bug-DBD-mysql@rt.cpan.org&gt; wrote:
&gt; 
&gt;       Queue: DBD-mysql
&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=87428">https://rt.cpan.org/Ticket/Display.html?id=87428</a></span> &gt;
&gt; 
&gt; This is still a problem. For example, Spreadsheet::ParseExcel tends to return strings which are not utf8 upgraded, so passing them directly to DBD::mysql with mysql_enable_utf8 enabled results in collation conflicts &#40;Illegal mix of collations &#40;latin1_swedish_ci,IMPLICIT&#41; and &#40;utf8_general_ci,COERCIBLE&#41; ...&#41;. utf8::upgrade on every string being passed &#34;solves&#34; the issue, but this shouldn&#39;t be needed.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;05&nbsp;22:47:11&nbsp;2015</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;05&nbsp;22:49:07&nbsp;2015</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is an old bug and I&#39;d like to fix it. I&#39;m not an collation expert, so I will need to look at the other drivers to see what they do about this. Sorry for the ticket rot.

On Mon Oct 05 22:40:53 2015, patg@patg.net wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; thank you for the report! I will look at the driver and see what is
&gt; needed to make this not require having to upgrade every string
&gt; explicitly.
&gt; 
<div class="message-stanza open">&gt; &gt; On Oct 1, 2015, at 7:28 PM, Dan Book via RT &lt;bug-DBD-
&gt; &gt; mysql@rt.cpan.org&gt; wrote:
&gt; &gt;
&gt; &gt; Queue: DBD-mysql
&gt; &gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=87428">https://rt.cpan.org/Ticket/Display.html?id=87428</a></span> &gt;
&gt; &gt;
&gt; &gt; This is still a problem. For example, Spreadsheet::ParseExcel tends
&gt; &gt; to return strings which are not utf8 upgraded, so passing them
&gt; &gt; directly to DBD::mysql with mysql_enable_utf8 enabled results in
&gt; &gt; collation conflicts &#40;Illegal mix of collations
&gt; &gt; &#40;latin1_swedish_ci,IMPLICIT&#41; and &#40;utf8_general_ci,COERCIBLE&#41; ...&#41;.
&gt; &gt; utf8::upgrade on every string being passed &#34;solves&#34; the issue, but
&gt; &gt; this shouldn&#39;t be needed.
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;08&nbsp;13:58:12&nbsp;2015</span>
    <span class="description">DBOOK [...] cpan.org -  Cc DBOOK added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;22&nbsp;11:15:09&nbsp;2016</span>
    <span class="description">pali [...] cpan.org -  Requestor PALI added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;22&nbsp;11:15:38&nbsp;2016</span>
    <span class="description">pali [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fix for UTF-8 support in DBD::mysql is in my pull request: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/perl5-dbi/DBD-mysql/pull/67">https://github.com/perl5-dbi/DBD-mysql/pull/67</a></span>
I would like if more people affected by UTF-8 bugs in DBD::mysql could test my changes...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;30&nbsp;16:49:16&nbsp;2016</span>
    <span class="description">schmorp [...] schmorp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> pali [...] cpan.org, DBOOK [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #87428] data corruption: DBD::mysql ignores the utf8-flag</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 30 Oct 2016 21:49:03 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Pali via RT &lt;bug-DBD-mysql [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marc Lehmann &lt;schmorp [...] schmorp.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, Oct 22, 2016 at 11:15:40AM -0400, Pali via RT &lt;bug-DBD-mysql@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=87428">https://rt.cpan.org/Ticket/Display.html?id=87428</a></span> &gt;
&gt; 
&gt; Fix for UTF-8 support in DBD::mysql is in my pull request: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/perl5-dbi/DBD-mysql/pull/67">https://github.com/perl5-dbi/DBD-mysql/pull/67</a></span>
&gt; I would like if more people affected by UTF-8 bugs in DBD::mysql could test my changes...
</div>
Thanks for looking into this - I only had a cursory look into the patch, and
it seems it is wrong in the &#34;other&#34; direction now:

+          else if &#40;is_binary &#38;&#38; SvUTF8&#40;ph-&gt;value&#41;&#41;
+            warn&#40;&#34;UTF-8 encoded binary field %d&#34;, i&#41;;

The UTF8 flag on a scalar does NOT mean the scalar is UTF-8 encoded - the
scalars &#34;\xfc&#34; &#40;no utf8 flag&#41; and &#34;\xc3\xbc&#34; &#40;with utf8 flag&#41; are the same
string, and in binary both encode the octet 0xfc. Emitting a warning is
wrong here, and the message is wrong as well &#40;scalars have no encoding
information on the Perl level&#41;.

The patch thus requires the same workarounds needed for utf-8 for binary
data now - that&#39;s the &#34;wrong in the other direction&#34;.

Basically, when utf-8 encoded data is wanted, then SvPVutf8 is the correct
function, while SvPVbyte is the right function for binary data - the patch
only gets the utf-8 case right &#40;with some optimisations&#41;.

I can&#39;t see whether this is inteded or not - calling str_is_nonascii on an
utf-8 encoded scalar doesn&#39;t seem to make much sense to me &#40;binary data is
8 bit wide, not 7 bit&#41;. On the other hand, this seems to be in the patch
multiple times.

Don&#39;t have time to try it out, and maybe I am overlooking something -
again, this is just a quick scan of the patch really. However, the only
way to succeed, IMHO, is to get the idea of detecting or guessing encoding
from perl scalars - the UTF8 flag _never_ indicates that the string data
is utf-8 encoded.

-- 
                The choice of a       Deliantra, the free code+content MORPG
      -----==-     _GNU_              <span class="clickylink"><a target="new" rel="nofollow" href="http://www.deliantra.net">http://www.deliantra.net</a></span>
      ----==-- _       generation
      ---==---&#40;_&#41;__  __ ____  __      Marc Lehmann
      --==---/ / _ \/ // /\ \/ /      schmorp@schmorp.de
      -=====/_/_//_/\_,_/ /_/\_\
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;30&nbsp;18:26:37&nbsp;2016</span>
    <span class="description">pali [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Ned Okt 30 16:49:16 2016, schmorp@schmorp.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sat, Oct 22, 2016 at 11:15:40AM -0400, Pali via RT &lt;bug-DBD-
&gt; mysql@rt.cpan.org&gt; wrote:
<div class="message-stanza open">&gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=87428">https://rt.cpan.org/Ticket/Display.html?id=87428</a></span> &gt;
&gt; &gt;
&gt; &gt; Fix for UTF-8 support in DBD::mysql is in my pull request:
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/perl5-dbi/DBD-mysql/pull/67">https://github.com/perl5-dbi/DBD-mysql/pull/67</a></span>
&gt; &gt; I would like if more people affected by UTF-8 bugs in DBD::mysql
&gt; &gt; could test my changes...
</div>&gt; 
&gt; Thanks for looking into this - I only had a cursory look into the
&gt; patch, and
&gt; it seems it is wrong in the &#34;other&#34; direction now:
&gt; 
&gt; +          else if &#40;is_binary &#38;&#38; SvUTF8&#40;ph-&gt;value&#41;&#41;
&gt; +            warn&#40;&#34;UTF-8 encoded binary field %d&#34;, i&#41;;
&gt; 
&gt; The UTF8 flag on a scalar does NOT mean the scalar is UTF-8 encoded -
&gt; the
&gt; scalars &#34;\xfc&#34; &#40;no utf8 flag&#41; and &#34;\xc3\xbc&#34; &#40;with utf8 flag&#41; are the
&gt; same
&gt; string, and in binary both encode the octet 0xfc. Emitting a warning
&gt; is
&gt; wrong here, and the message is wrong as well &#40;scalars have no encoding
&gt; information on the Perl level&#41;.
</div>
UTF8 flag tells if internal representation of PV in scalar is stored in utf8 or not. I was thinking that &#34;\xc3\xbc&#34; with utf8 flag is not mean to be binary anymore as it is internally stored as utf8. If you produce binary data which have internal representation in utf8 then I think there is some problem...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The patch thus requires the same workarounds needed for utf-8 for
&gt; binary
&gt; data now - that&#39;s the &#34;wrong in the other direction&#34;.
</div>
I will think about it... But pack/unpack/vec/... functions works also on string &#34;\xc3\xbc&#34; with utf8 flag same as on &#34;\xfc&#34; without utf8 flag...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Basically, when utf-8 encoded data is wanted, then SvPVutf8 is the
&gt; correct
&gt; function, while SvPVbyte is the right function for binary data - the
&gt; patch
&gt; only gets the utf-8 case right &#40;with some optimisations&#41;.
&gt; 
&gt; I can&#39;t see whether this is inteded or not - calling str_is_nonascii
&gt; on an
&gt; utf-8 encoded scalar doesn&#39;t seem to make much sense to me &#40;binary
&gt; data is
&gt; 8 bit wide, not 7 bit&#41;. On the other hand, this seems to be in the
&gt; patch
&gt; multiple times.
</div>
This is just optimization. SvPV returns data buffer in utf8 encoded or byte &#40;latin1&#41; encoded based on SvUTF8 flag. But plain ASCII data are same in both those encodings, so both functions SvPVbyte and SvPVutf8 returns exactly same data in that case. Checking str_is_nonascii is just optimization if SvPVutf8 is really needed to call...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Don&#39;t have time to try it out, and maybe I am overlooking something -
&gt; again, this is just a quick scan of the patch really. However, the
&gt; only
&gt; way to succeed, IMHO, is to get the idea of detecting or guessing
&gt; encoding
&gt; from perl scalars - the UTF8 flag _never_ indicates that the string
&gt; data
&gt; is utf-8 encoded.
</div>
For char* value retrieved by SvPV&#40;&#41; call, UTF8 flag really indicates if that char* value is utf8 encoded or not.

But you are right that it does not tell if perl scalar accessed by pure perl functions are utf8 encoded or are nativelly in perl.

All such guessing is wrong way. Driver should get either binary scalar or string scalar.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;30&nbsp;19:20:48&nbsp;2016</span>
    <span class="description">schmorp [...] schmorp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> MLEHMANN [...] cpan.org, pali [...] cpan.org, DBOOK [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #87428] data corruption: DBD::mysql ignores the utf8-flag</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 31 Oct 2016 00:20:32 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Pali via RT &lt;bug-DBD-mysql [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marc Lehmann &lt;schmorp [...] schmorp.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun, Oct 30, 2016 at 06:26:38PM -0400, Pali via RT &lt;bug-DBD-mysql@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; wrong here, and the message is wrong as well &#40;scalars have no encoding
&gt; &gt; information on the Perl level&#41;.
</div>&gt; 
&gt; UTF8 flag tells if internal representation of PV in scalar is stored in utf8 or not. I was thinking that &#34;\xc3\xbc&#34; with utf8 flag is not mean to be binary anymore as it is internally stored as utf8. If you produce binary data which have internal representation in utf8 then I think there is some problem...
</div>
The problem is mysql not correctly interpreting that flag, and your
patch doesn&#39;t make it better because it fails &#40;similarly to the original
DBD::mysql&#41; to implement the flag as defined by perl itself. It might be a
problem &#40;I don&#39;t think it is&#41;, but that&#39;s how perl currently works, and as
long as DBD::mysql doesn&#39;t handle it as intended, it will be buggy.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; The patch thus requires the same workarounds needed for utf-8 for
&gt; &gt; binary
&gt; &gt; data now - that&#39;s the &#34;wrong in the other direction&#34;.
</div>&gt; 
&gt; I will think about it... But pack/unpack/vec/... functions works also on string &#34;\xc3\xbc&#34; with utf8 flag same as on &#34;\xfc&#34; without utf8 flag...
</div>
The &#34;but&#34; is weird, because your patch doesn&#39;t do that, unlike pack/unpack
&#40;at least they got it right after I fixed them&#41;. The key here is to
understand that your patch does&#39;t work on these two strings the same way,
even though it should.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I can&#39;t see whether this is inteded or not - calling str_is_nonascii
&gt; &gt; on an
&gt; &gt; utf-8 encoded scalar doesn&#39;t seem to make much sense to me &#40;binary
&gt; &gt; data is
&gt; &gt; 8 bit wide, not 7 bit&#41;. On the other hand, this seems to be in the
&gt; &gt; patch
&gt; &gt; multiple times.
</div>&gt; 
&gt; This is just optimization. SvPV returns data buffer in utf8 encoded or byte &#40;latin1&#41; encoded based on SvUTF8 flag. But plain ASCII data are same in both those encodings, so both functions SvPVbyte and SvPVutf8 returns exactly same data in that case. Checking str_is_nonascii is just optimization if SvPVutf8 is really needed to call...
</div>
Are you really telling me that issuing a warning is some kind of
optimisation? Because that&#39;s what the patch does after testing
str_is_nonascii. That doesn&#39;t look like an optimisation to me, in fact, it
is a bug :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt; Don&#39;t have time to try it out, and maybe I am overlooking something -
&gt; &gt; again, this is just a quick scan of the patch really. However, the
&gt; &gt; only
&gt; &gt; way to succeed, IMHO, is to get the idea of detecting or guessing
&gt; &gt; encoding
&gt; &gt; from perl scalars - the UTF8 flag _never_ indicates that the string
&gt; &gt; data
&gt; &gt; is utf-8 encoded.
</div>&gt; 
&gt; For char* value retrieved by SvPV&#40;&#41; call, UTF8 flag really indicates if that char* value is utf8 encoded or not.
</div>
Unfortunately no - the UTF8 flag merely indicates how the perl codepoints are
stored, it doesn&#39;t say anything about whether the char * is utf8 encoded or
not. In generally, utf-8 encoded SVs do _not_ have the UTF8 flag set &#40;but
they might&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But you are right that it does not tell if perl scalar accessed by pure perl functions are utf8 encoded or are nativelly in perl.
</div>
Maybe you mean the right thing, but the patch is wrong and your
explanations are as well.

The UTF8 flag business in perl is really messy, and I wish it wasn&#39;t
called &#34;UTF8&#34;, but it really doesn&#39;t tell you anything about character
encoding or whether the scalar is text or binary, it only tells you how
the codepoints are stored &#40;namely either as plain octets or in a format
similar to utf-8 encoding, without being utf-8&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; All such guessing is wrong way. Driver should get either binary scalar or string scalar.
</div>
Exactly, the driver should handle binary and text correctly - your patch
seedms to go along way towards handling text correctly. It would just be
nice if it wouldn&#39;t break the binary case even more :&#41;

Greetings,

-- 
                The choice of a       Deliantra, the free code+content MORPG
      -----==-     _GNU_              <span class="clickylink"><a target="new" rel="nofollow" href="http://www.deliantra.net">http://www.deliantra.net</a></span>
      ----==-- _       generation
      ---==---&#40;_&#41;__  __ ____  __      Marc Lehmann
      --==---/ / _ \/ // /\ \/ /      schmorp@schmorp.de
      -=====/_/_//_/\_,_/ /_/\_\
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;30&nbsp;19:45:38&nbsp;2016</span>
    <span class="description">pali [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Ned Okt 30 19:20:48 2016, schmorp@schmorp.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun, Oct 30, 2016 at 06:26:38PM -0400, Pali via RT &lt;bug-DBD-
&gt; mysql@rt.cpan.org&gt; wrote:
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; wrong here, and the message is wrong as well &#40;scalars have no
&gt; &gt; &gt; encoding
&gt; &gt; &gt; information on the Perl level&#41;.
</div>&gt; &gt;
&gt; &gt; UTF8 flag tells if internal representation of PV in scalar is stored
&gt; &gt; in utf8 or not. I was thinking that &#34;\xc3\xbc&#34; with utf8 flag is not
&gt; &gt; mean to be binary anymore as it is internally stored as utf8. If you
&gt; &gt; produce binary data which have internal representation in utf8 then I
&gt; &gt; think there is some problem...
</div>&gt; 
&gt; The problem is mysql not correctly interpreting that flag, and your
&gt; patch doesn&#39;t make it better because it fails &#40;similarly to the
&gt; original
&gt; DBD::mysql&#41; to implement the flag as defined by perl itself. It might
&gt; be a
&gt; problem &#40;I don&#39;t think it is&#41;, but that&#39;s how perl currently works,
&gt; and as
&gt; long as DBD::mysql doesn&#39;t handle it as intended, it will be buggy.
&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; The patch thus requires the same workarounds needed for utf-8 for
&gt; &gt; &gt; binary
&gt; &gt; &gt; data now - that&#39;s the &#34;wrong in the other direction&#34;.
</div>&gt; &gt;
&gt; &gt; I will think about it... But pack/unpack/vec/... functions works also
&gt; &gt; on string &#34;\xc3\xbc&#34; with utf8 flag same as on &#34;\xfc&#34; without utf8
&gt; &gt; flag...
</div>&gt; 
&gt; The &#34;but&#34; is weird, because your patch doesn&#39;t do that, unlike
&gt; pack/unpack
&gt; &#40;at least they got it right after I fixed them&#41;. The key here is to
&gt; understand that your patch does&#39;t work on these two strings the same
&gt; way,
&gt; even though it should.
</div>
Yea, driver should work in same way as those functions. You are right and all those warnings are really wrong... I will try to fix code. Thank you for first review!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; I can&#39;t see whether this is inteded or not - calling
&gt; &gt; &gt; str_is_nonascii
&gt; &gt; &gt; on an
&gt; &gt; &gt; utf-8 encoded scalar doesn&#39;t seem to make much sense to me &#40;binary
&gt; &gt; &gt; data is
&gt; &gt; &gt; 8 bit wide, not 7 bit&#41;. On the other hand, this seems to be in the
&gt; &gt; &gt; patch
&gt; &gt; &gt; multiple times.
</div>&gt; &gt;
&gt; &gt; This is just optimization. SvPV returns data buffer in utf8 encoded
&gt; &gt; or byte &#40;latin1&#41; encoded based on SvUTF8 flag. But plain ASCII data
&gt; &gt; are same in both those encodings, so both functions SvPVbyte and
&gt; &gt; SvPVutf8 returns exactly same data in that case. Checking
&gt; &gt; str_is_nonascii is just optimization if SvPVutf8 is really needed to
&gt; &gt; call...
</div>&gt; 
&gt; Are you really telling me that issuing a warning is some kind of
&gt; optimisation? Because that&#39;s what the patch does after testing
&gt; str_is_nonascii. That doesn&#39;t look like an optimisation to me, in
&gt; fact, it
&gt; is a bug :&#41;
</div>
With that description I mean code pattern:

          valbuf= SvPV&#40;ph-&gt;value, vallen&#41;;
          if &#40;enable_utf8 &#38;&#38; !is_binary &#38;&#38; !SvUTF8&#40;ph-&gt;value&#41; &#38;&#38; str_is_nonascii&#40;valbuf, vallen&#41;&#41;
          {
            SV *tmp = sv_2mortal&#40;newSVpvn&#40;valbuf, vallen&#41;&#41;;
            valbuf = SvPVutf8&#40;tmp, vallen&#41;;
          }

About warning, yes... code is wrong.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; Don&#39;t have time to try it out, and maybe I am overlooking something
&gt; &gt; &gt; -
&gt; &gt; &gt; again, this is just a quick scan of the patch really. However, the
&gt; &gt; &gt; only
&gt; &gt; &gt; way to succeed, IMHO, is to get the idea of detecting or guessing
&gt; &gt; &gt; encoding
&gt; &gt; &gt; from perl scalars - the UTF8 flag _never_ indicates that the string
&gt; &gt; &gt; data
&gt; &gt; &gt; is utf-8 encoded.
</div>&gt; &gt;
&gt; &gt; For char* value retrieved by SvPV&#40;&#41; call, UTF8 flag really indicates
&gt; &gt; if that char* value is utf8 encoded or not.
</div>&gt; 
&gt; Unfortunately no - the UTF8 flag merely indicates how the perl
&gt; codepoints are
&gt; stored, it doesn&#39;t say anything about whether the char * is utf8
&gt; encoded or
&gt; not. In generally, utf-8 encoded SVs do _not_ have the UTF8 flag set
&gt; &#40;but
&gt; they might&#41;.
</div>
When utf8 encoded SV do not have the UTF8 flag set? Do you have example? I really thought that UTF8 status flag indicate that char* returned by SvPV&#40;&#41; is utf8 encoded.

Also in perlapi is written:

       SvUTF8  Returns a U32 value indicating whether the SV contains UTF-8 encoded data.  Call this after SvPV&#40;&#41; in case any call to string overloading updates the internal flag.

Which I understood that UTF8 status flag indicates if SvPV&#40;&#41; buffer is utf8 encoded or not.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; But you are right that it does not tell if perl scalar accessed by
&gt; &gt; pure perl functions are utf8 encoded or are nativelly in perl.
</div>&gt; 
&gt; Maybe you mean the right thing, but the patch is wrong and your
&gt; explanations are as well.
&gt; 
&gt; The UTF8 flag business in perl is really messy, and I wish it wasn&#39;t
&gt; called &#34;UTF8&#34;, but it really doesn&#39;t tell you anything about character
&gt; encoding or whether the scalar is text or binary, it only tells you
&gt; how
&gt; the codepoints are stored &#40;namely either as plain octets or in a
&gt; format
&gt; similar to utf-8 encoding, without being utf-8&#41;.
&gt; 
<div class="message-stanza open">&gt; &gt; All such guessing is wrong way. Driver should get either binary
&gt; &gt; scalar or string scalar.
</div>&gt; 
&gt; Exactly, the driver should handle binary and text correctly - your
&gt; patch
&gt; seedms to go along way towards handling text correctly. It would just
&gt; be
&gt; nice if it wouldn&#39;t break the binary case even more :&#41;
&gt; 
&gt; Greetings,
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;04&nbsp;05:11:35&nbsp;2016</span>
    <span class="description">schmorp [...] schmorp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> MLEHMANN [...] cpan.org, pali [...] cpan.org, DBOOK [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #87428] data corruption: DBD::mysql ignores the utf8-flag</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 4 Nov 2016 10:11:21 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Pali via RT &lt;bug-DBD-mysql [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marc Lehmann &lt;schmorp [...] schmorp.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry for the delay, I am quite busy.

On Sun, Oct 30, 2016 at 07:45:44PM -0400, Pali via RT &lt;bug-DBD-mysql@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Are you really telling me that issuing a warning is some kind of
&gt; &gt; optimisation? Because that&#39;s what the patch does after testing
&gt; &gt; str_is_nonascii. That doesn&#39;t look like an optimisation to me, in
&gt; &gt; fact, it
&gt; &gt; is a bug :&#41;
</div>&gt; 
&gt; With that description I mean code pattern:
</div>
Somewhat off-topic: most modules simply use SvPVutf8/SvPVbyte, without
making a copy, so the optimisation should not normally be necessary. This
normally also works, as perl itself makes a temporary copy in those cases
where the scalar is not mutable, and presumably knows better, so the
optimisation is probably a deoptimisation in practise, as perl does not
have to scan the string in general.

It is, however, correct, so you might stay with this approach if you have
a reason to do it differently than other parts of perl.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; not. In generally, utf-8 encoded SVs do _not_ have the UTF8 flag set
&gt; &gt; &#40;but
&gt; &gt; they might&#41;.
</div>&gt; 
&gt; When utf8 encoded SV do not have the UTF8 flag set? Do you have example? I really thought that UTF8 status flag indicate that char* returned by SvPV&#40;&#41; is utf8 encoded.
</div>
You see, that&#39;s the problem with the flag - it simply doesn&#39;t mean anything
like &#34;trhe scalar is utf-8 encoded&#34;. First of all, perl&#39;s &#34;UTF8&#34; encoding
isn&#39;t the same as unicode&#39;s utf-8 encoding, and second, it really only is a
way of representing code points &gt; 255 in a multibyte way.

This scalar is utf-8 encoded, as matter of fact. It is also binary data,
as utf-8 data is always binary:

   my $sv = &#34;\xc3\xbc&#34;;

But it might or might not have the utf8 flag set &#40;this depends on the perl
version and other factors&#41;. Likewise, this scalar is utf-8 encoded:

   utf8::encode $sv;

But it does not have the utf8 flag set.

That&#39;s why it is so dangerous to use &#34;utf8 encoded&#34; to talk about these
things, as it&#39;s never clear whether the actual data is meant or perls
utf-8 like internal encoding.

In my experience, it is much safer to just say upgraded or downgraded, as
thenh it&#39;s much harder to subconsciously fall into this trap.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Also in perlapi is written:
&gt; 
&gt;        SvUTF8  Returns a U32 value indicating whether the SV contains UTF-8 encoded data.  Call this after SvPV&#40;&#41; in case any call to string overloading updates the internal flag.
&gt; 
&gt; Which I understood that UTF8 status flag indicates if SvPV&#40;&#41; buffer is utf8 encoded or not.
</div>
Yeah, it&#39;s not. It&#39;s really a horrible, horrible mess. It means that the
character codes inside the scalar use perls extended multibyte encoding,
confusingly called utf8, but it doesn&#39;t mean the SV contains utf-8 encoded
data AT ALL. And the best thing is, you know this, but let yourself get
confused by the bad documentation.

In case I am not clear enough &#40;it&#39;s ghard to be clear with all these
confusing documentation&#41;, a string with character code 200 &#40;&#34;chr 200&#34;&#41;
can have this flag set or not, but in no case is *the scalar* utf-8
encoded. Just that if the utf-8 flag is set, it means the character codes
use an encoding very similar to utf-8 &#40;for example, chr 0x200000 results
in invalid utf-8 in memory, but is representable in perls encoding&#41;.

So basically, what I am saying is that it isn&#39;t useful to talk about these
utf8 flags in perl as if they indicated utf-8 encoding of the actual data in
some way. Even people who know this regularly confuse themselves, and in my
experience, you get bugs this way.

Otherwise, it&#39;s great to hear that you clearly know your business around
utf-8 and the patch is going to be fixed.

Now the big question is how to proceed in general, as by all appearances,
DBD::mysql is unmaintained and the maintainers do no longer respond to
mail.

-- 
                The choice of a       Deliantra, the free code+content MORPG
      -----==-     _GNU_              <span class="clickylink"><a target="new" rel="nofollow" href="http://www.deliantra.net">http://www.deliantra.net</a></span>
      ----==-- _       generation
      ---==---&#40;_&#41;__  __ ____  __      Marc Lehmann
      --==---/ / _ \/ // /\ \/ /      schmorp@schmorp.de
      -=====/_/_//_/\_,_/ /_/\_\
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;04&nbsp;05:51:49&nbsp;2016</span>
    <span class="description">pali [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Pia Nov 04 05:11:35 2016, schmorp@schmorp.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sorry for the delay, I am quite busy.
&gt; 
&gt; On Sun, Oct 30, 2016 at 07:45:44PM -0400, Pali via RT &lt;bug-DBD-
&gt; mysql@rt.cpan.org&gt; wrote:
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; Are you really telling me that issuing a warning is some kind of
&gt; &gt; &gt; optimisation? Because that&#39;s what the patch does after testing
&gt; &gt; &gt; str_is_nonascii. That doesn&#39;t look like an optimisation to me, in
&gt; &gt; &gt; fact, it
&gt; &gt; &gt; is a bug :&#41;
</div>&gt; &gt;
&gt; &gt; With that description I mean code pattern:
</div>&gt; 
&gt; Somewhat off-topic: most modules simply use SvPVutf8/SvPVbyte, without
&gt; making a copy, so the optimisation should not normally be necessary.
</div>
It is not only for optimisation, it is also because SvPVbyte&#40;&#41; croaks on &#34;wide&#34; characters. I do not want to introduce croaks and instead DBD::mysql show warning. If &#34;wide&#34; character cannot be downgraded to Latin1, then its UTF-8 representation is used. Exactly same behaviour is in print when passing wide character without :utf8 layer.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This
&gt; normally also works, as perl itself makes a temporary copy in those
&gt; cases
&gt; where the scalar is not mutable, and presumably knows better, so the
&gt; optimisation is probably a deoptimisation in practise, as perl does
&gt; not
&gt; have to scan the string in general.
&gt; 
&gt; It is, however, correct, so you might stay with this approach if you
&gt; have
&gt; a reason to do it differently than other parts of perl.
</div>
I think reason, to not crash existing code is really good reason.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; not. In generally, utf-8 encoded SVs do _not_ have the UTF8 flag
&gt; &gt; &gt; set
&gt; &gt; &gt; &#40;but
&gt; &gt; &gt; they might&#41;.
</div>&gt; &gt;
&gt; &gt; When utf8 encoded SV do not have the UTF8 flag set? Do you have
&gt; &gt; example? I really thought that UTF8 status flag indicate that char*
&gt; &gt; returned by SvPV&#40;&#41; is utf8 encoded.
</div>&gt; 
&gt; You see, that&#39;s the problem with the flag - it simply doesn&#39;t mean
&gt; anything
&gt; like &#34;trhe scalar is utf-8 encoded&#34;. First of all, perl&#39;s &#34;UTF8&#34;
&gt; encoding
&gt; isn&#39;t the same as unicode&#39;s utf-8 encoding, and second, it really only
&gt; is a
&gt; way of representing code points &gt; 255 in a multibyte way.
&gt; 
&gt; This scalar is utf-8 encoded, as matter of fact. It is also binary
&gt; data,
&gt; as utf-8 data is always binary:
&gt; 
&gt; my $sv = &#34;\xc3\xbc&#34;;
&gt; 
&gt; But it might or might not have the utf8 flag set &#40;this depends on the
&gt; perl
&gt; version and other factors&#41;. Likewise, this scalar is utf-8 encoded:
&gt; 
&gt; utf8::encode $sv;
&gt; 
&gt; But it does not have the utf8 flag set.
&gt; 
&gt; That&#39;s why it is so dangerous to use &#34;utf8 encoded&#34; to talk about
&gt; these
&gt; things, as it&#39;s never clear whether the actual data is meant or perls
&gt; utf-8 like internal encoding.
&gt; 
&gt; In my experience, it is much safer to just say upgraded or downgraded,
&gt; as
&gt; thenh it&#39;s much harder to subconsciously fall into this trap.
</div>
Now I understand what you mean by your definition &#34;utf8 encoded&#34;.

Basically string scalar in perl contains sequence of numbers, where is each number represent exactly one character. And we have two different internal representation of strings &#40;latin1 and extended utf8 resp. ebcdic and special utfebcdic&#41; in perl and pure perl code does not see any difference between them.

With &#34;utf8 encoded&#34; you mean that &#34;numbers&#34; represent utf8 sequence of octets, right?

I used &#34;utf8 encoded&#34; term in case when macro SvPV&#40;&#41; returns C char* which is &#34;utf8 encoded&#34; &#40;not UTF-8, but perl&#39;s extended utf8&#41;. This is different!

And if SvUTF8&#40;&#41; returns true, then previous SvPV&#40;&#41; call returns C char* which is &#34;utf8 encoded&#34; -- char* contains perl&#39;s extended utf8 string. SvUTF8 is sufficient condition but not necessary. As you pointed utf8::encode&#40;$sv&#41; unset SvUTF8 flag, but SvPV&#40;&#41; still returns char* in perl&#39;s extended utf8 encoding.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Also in perlapi is written:
&gt; &gt;
&gt; &gt; SvUTF8  Returns a U32 value indicating whether the SV contains UTF-8
&gt; &gt; encoded data.  Call this after SvPV&#40;&#41; in case any call to string
&gt; &gt; overloading updates the internal flag.
&gt; &gt;
&gt; &gt; Which I understood that UTF8 status flag indicates if SvPV&#40;&#41; buffer
&gt; &gt; is utf8 encoded or not.
</div>&gt; 
&gt; Yeah, it&#39;s not. It&#39;s really a horrible, horrible mess. It means that
&gt; the
&gt; character codes inside the scalar use perls extended multibyte
&gt; encoding,
&gt; confusingly called utf8, but it doesn&#39;t mean the SV contains utf-8
&gt; encoded
&gt; data AT ALL. And the best thing is, you know this, but let yourself
&gt; get
&gt; confused by the bad documentation.
&gt; 
&gt; In case I am not clear enough &#40;it&#39;s ghard to be clear with all these
&gt; confusing documentation&#41;, a string with character code 200 &#40;&#34;chr 200&#34;&#41;
&gt; can have this flag set or not, but in no case is *the scalar* utf-8
&gt; encoded. Just that if the utf-8 flag is set, it means the character
&gt; codes
&gt; use an encoding very similar to utf-8 &#40;for example, chr 0x200000
&gt; results
&gt; in invalid utf-8 in memory, but is representable in perls encoding&#41;.
&gt; 
&gt; So basically, what I am saying is that it isn&#39;t useful to talk about
&gt; these
&gt; utf8 flags in perl as if they indicated utf-8 encoding of the actual
&gt; data in
&gt; some way. Even people who know this regularly confuse themselves, and
&gt; in my
&gt; experience, you get bugs this way.
&gt; 
&gt; Otherwise, it&#39;s great to hear that you clearly know your business
&gt; around
&gt; utf-8 and the patch is going to be fixed.
</div>
As perl scalars contain sequence of numbers, we can talk about &#34;wide characters&#34; and wide strings &#40;wide character &gt; 0xFF&#41;. I hope this is not confusing.

And in C char* we can talk about &#40;perl&#39;s extended&#41; utf8 encoding. SvUTF8 can be used only in context of that char* data &#40;not in pure perl context&#41;.

Now I&#39;m waiting for new DBD::mysql release because it change some code around parameter parsing &#40;cause conflicts with my patch&#41; and after that I rebase &#38; publish new version of utf8 patches...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Now the big question is how to proceed in general, as by all
&gt; appearances,
&gt; DBD::mysql is unmaintained and the maintainers do no longer respond to
&gt; mail.
</div>
DBD::mysql is still maintained. New versions are periodically releasing, see: <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/DBD::mysql">https://metacpan.org/pod/DBD::mysql</a></span>
Last version is from OCT 20, 2016. Also security fixes &#40;like one for CVE-2016-1246&#41; are delivered...
I do not see any problem, maintainers respond to email and also to pull requests on github.

PS: you do not need to CC me in this RT. I&#39;m automatically CCed by RT, so your explicit CC just cause that I get your emails two times :-&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;08&nbsp;18:45:25&nbsp;2016</span>
    <span class="description">pali [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Pull request is updated: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/perl5-dbi/DBD-mysql/pull/67">https://github.com/perl5-dbi/DBD-mysql/pull/67</a></span>
Now it should handle wide characters correctly. Marc Lehmann, can you look at it?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;06&nbsp;03:56:03&nbsp;2017</span>
    <span class="description">pali [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">UTF-8 and Unicode fixes are now in DBD::mysql devel version 4.041_01. Please test.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;22&nbsp;11:49:03&nbsp;2017</span>
    <span class="description">MICHIELB [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;22&nbsp;11:49:04&nbsp;2017</span>
    <span class="description">MICHIELB [...] cpan.org -  Fixed in 4.041_01 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;01&nbsp;05:17:21&nbsp;2017</span>
    <span class="description">pali [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Reopening, fix was reverted in 4.043.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;01&nbsp;05:17:28&nbsp;2017</span>
    <span class="description">pali [...] cpan.org -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;15&nbsp;02:52:18&nbsp;2017</span>
    <span class="description">MICHIELB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ticket migrated to github as <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/perl5-dbi/DBD-mysql/issues/197">https://github.com/perl5-dbi/DBD-mysql/issues/197</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;15&nbsp;02:52:19&nbsp;2017</span>
    <span class="description">MICHIELB [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
