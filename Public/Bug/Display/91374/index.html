<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #91374 for POE: Patch that will deal with non-ASCII in HTTP headers</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #91374 for POE: Patch that will deal with non-ASCII in HTTP headers</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/POE/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/POE/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/POE/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/POE/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE">POE CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">91374</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/POE/Active/">POE</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
perl [...] pied.nu

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26342-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26343-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;12&nbsp;16:26:04&nbsp;2013</span>
    <span class="description">perl [...] pied.nu -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Patch that will deal with non-ASCII in HTTP headers</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">HTTP::Headers doesn&#39;t handle non-ISO-8859-1 text properly.  Anything that isn&#39;t ISO-8859-1 should be encoded according to RFC2047.

The inclosed patch does just this.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Philip_Gwyn-POE_Filter_HTTP-utf8_headers-01.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/lib/POE/Filter/HTTPD.pm b/lib/POE/Filter/HTTPD.pm
index 25a3a49..05eb50c 100644
--- a/lib/POE/Filter/HTTPD.pm
+++ b/lib/POE/Filter/HTTPD.pm
@@ -17,6 +17,8 @@ $VERSION = &#39;1.358&#39;;
 # NOTE - Should be #.### &#40;three decimal places&#41;
 @ISA = qw&#40;POE::Filter&#41;;
 
+sub DEBUG &#40;&#41; { 0 }
+
 sub BUFFER        &#40;&#41; { 0 } # raw data buffer to build requests
 sub STATE         &#40;&#41; { 1 } # built a full request
 sub REQUEST       &#40;&#41; { 2 } # partial request being built
@@ -39,6 +41,39 @@ my $HTTP_1_0 = _http_version&#40;&#34;HTTP/1.0&#34;&#41;;
 my $HTTP_1_1 = _http_version&#40;&#34;HTTP/1.1&#34;&#41;;
 
 #------------------------------------------------------------------------------
+# Set up some routines for convert wide chars &#40;which aren&#39;t allowed in HTTP headers&#41;
+# into MIME encoded equivalents.
+# See -&gt;headers_as_strings
+BEGIN {
+    eval &#34;use utf8&#34;;
+    if&#40; $@ &#41; {
+        DEBUG and warn &#34;We don&#39;t have utf8.&#34;;
+        *HAVE_UTF8 = sub { 0 };
+    }
+    else {        
+        *HAVE_UTF8 = sub { 1 };
+        my $downgrade = sub {   
+                        my $ret = $_[0];
+                        utf8::downgrade&#40; $ret &#41;;
+                        return $ret 
+                    };
+        eval &#34;use Email::MIME::RFC2047::Encoder&#34;;
+        if&#40; $@ &#41; {
+            DEBUG and warn &#34;We don&#39;t have Email::MIME::RFC2047::Encoder&#34;;
+            *encode_value = sub { Carp::cluck&#40; &#34;Wide characters in HTTP header&#34; &#41;; 
+                                  $downgrade-&gt;&#40; @_ &#41; };
+        }
+        else {
+            my $encoder = Email::MIME::RFC2047::Encoder-&gt;new&#40; encoding =&gt; &#39;iso-8859-1&#39;, 
+                                                              method =&gt; &#39;Q&#39;
+                                                            &#41;;
+            *encode_value = sub { $downgrade-&gt;&#40; $encoder-&gt;encode_text&#40; @_ &#41; &#41; };
+        }
+    }
+}
+
+
+#------------------------------------------------------------------------------
 
 sub new {
   my $type = shift;
@@ -270,14 +305,87 @@ sub put {
 
     my @headers;
     push @headers, $status_line;
-    push @headers, $_-&gt;headers_as_string&#40;&#34;\x0D\x0A&#34;&#41;;
 
-    push @raw, join&#40;&#34;\x0D\x0A&#34;, @headers, &#34;&#34;&#41; . $_-&gt;content;
+    # Perl can magically promote a string to UTF-8 if it is concatinated
+    # with another UTF-8 string.  This behaviour changed between 5.8.8 and
+    # 5.10.1.  This is normaly not a problem, but POE::Driver::SysRW uses
+    # syswrite&#40;&#41;, which sends POE&#39;s internal buffer as-is.  
+    # In other words, if the header contains UTF-8, the content will be
+    # promoted to UTF-8 and syswrite&#40;&#41; will send those wide bytes, which
+    # will corrupt any images.
+    # For instance, 00 e7 ff 00 00 00 05
+    # will become,  00 c3 a7 c3 bf 00 00 00 05
+    #
+    # The real bug is in HTTP::Message-&gt;headers_as_string, which doesn&#39;t respect
+    # the following:
+    # 
+    # &#34;The TEXT rule is only used for descriptive field contents and values
+    #  that are not intended to be interpreted by the message parser.  Words
+    #  of *TEXT MAY contain characters from character sets other than ISO-
+    #  8859-1 [22] only when encoded according to the rules of RFC 2047
+    #  [14]. &#34; -- RFC2616 section 2.2
+    # <span class="clickylink"><a target="new" rel="nofollow" href="http://www.ietf.org/rfc/rfc2616.txt">http://www.ietf.org/rfc/rfc2616.txt</a></span>
+    # <span class="clickylink"><a target="new" rel="nofollow" href="http://www.ietf.org/rfc/rfc2047.txt">http://www.ietf.org/rfc/rfc2047.txt</a></span>
+    my $endl = &#34;\x0D\x0A&#34;;
+    push @headers, $self-&gt;headers_as_strings&#40; $_-&gt;headers, $endl &#41;;
+    push @raw, join&#40; $endl, @headers, &#34;&#34;, &#34;&#34;&#41; . $_-&gt;content;
   }
 
   \@raw;
 }
 
+sub headers_as_strings
+{
+    my&#40; $self, $H, $endl &#41; = @_;
+    my @ret;
+    # $H is a HTTP::Headers object
+    foreach my $name &#40; $H-&gt;header_field_names &#41; {
+        # message-header = field-name &#34;:&#34; [ field-value ]
+        # field-name     = token
+        # RFC2616 section 4.2
+        #
+        # token          = 1*&lt;any CHAR except CTLs or separators&gt;
+        # separators     = &#34;&#40;&#34; | &#34;&#41;&#34; | &#34;&lt;&#34; | &#34;&gt;&#34; | &#34;@&#34;
+        #                  | &#34;,&#34; | &#34;;&#34; | &#34;:&#34; | &#34;\&#34; | &lt;&#34;&gt;
+        #                  | &#34;/&#34; | &#34;[&#34; | &#34;]&#34; | &#34;?&#34; | &#34;=&#34;
+        #                  | &#34;{&#34; | &#34;}&#34; | SP | HT
+        # CHAR           = &lt;any US-ASCII character &#40;octets 0 - 127&#41;&gt;        
+        # CTL            = &lt;any US-ASCII control character
+        #                                &#40;octets 0 - 31&#41; and DEL &#40;127&#41;&gt; 
+        # SP             = &lt;US-ASCII SP, space &#40;32&#41;&gt; 
+        # HT             = &lt;US-ASCII HT, horizontal-tab &#40;9&#41;&gt;
+        # RFC2616 section 2.2 
+
+        # In other words, plain ascii text.  HTTP::Headers doesn&#39;t check for
+        # this, of course.  So if we complain here, the cluck ends up in
+        # the wrong place.  Doing the simplest thing
+        utf8::downgrade&#40; $name &#41; if HAVE_UTF8;
+
+        # Deal with header values
+        foreach my $value &#40; $H-&gt;header&#40; $name &#41; &#41; {
+            if&#40; HAVE_UTF8 and utf8::is_utf8&#40; $value &#41; &#41; {
+                DEBUG and print &#34;Header $name is UTF-8\n&#34;;
+                $value = encode_value&#40; $value &#41;;
+            }
+            
+            push @ret, join &#34;: &#34;, $name, _process_newline&#40; $value, $endl &#41;;
+        }
+    }
+    return @ret;
+}
+
+# This routine is lifted as-is from HTTP::Headers
+sub _process_newline {
+    local $_ = shift;
+    my $endl = shift;
+    # must handle header values with embedded newlines with care
+    s/\s+$//;        # trailing newlines and space must go
+    s/\n&#40;\x0d?\n&#41;+/\n/g;     # no empty lines
+    s/\n&#40;[^\040\t]&#41;/\n $1/g; # initial space for continuation
+    s/\n/$endl/g;    # substitute with requested line ending
+    $_;
+}
+
 #------------------------------------------------------------------------------
 
 sub get_pending {
diff --git a/t/10_units/05_filters/03_http.t b/t/10_units/05_filters/03_http.t
index 7ffbcd9..ad6c8fa 100644
--- a/t/10_units/05_filters/03_http.t
+++ b/t/10_units/05_filters/03_http.t
@@ -24,7 +24,7 @@ BEGIN {
 }
 
 BEGIN {
-  plan tests =&gt; 112;
+  plan tests =&gt; 117;
 }
 
 use_ok&#40;&#39;POE::Filter::HTTPD&#39;&#41;;
@@ -408,6 +408,29 @@ SKIP: { # wishlist for supporting get_pending! {{{
   is&#40;ref&#40;$chunks&#41;, &#39;ARRAY&#39;, &#39;put: returns arrayref&#39;&#41;;
 } # }}}
 
+SKIP:
+{ # make sure the headers are encoded {{{
+    eval &#34;use utf8&#34;;
+    skip &#34;Don&#39;t have utf8&#34;, 5 if $@;
+
+    my $utf8 = &#34;En \xE9t\xE9&#34;;
+    utf8::upgrade&#40; $utf8 &#41;;
+    ok&#40; utf8::is_utf8&#40; $utf8 &#41;, &#34;Make sure this is utf8&#34; &#41;;
+
+    my $resp = HTTP::Response-&gt;new&#40; &#34;200&#34;, &#34;OK&#34; &#41;;
+    $resp-&gt;header&#40; &#34;X-Subject&#34;, $utf8 &#41;;
+    $resp-&gt;content&#40; &#34;\x00\xC3\xE7\xFF\x00&#34; &#41;;
+
+    my $filter = POE::Filter::HTTPD-&gt;new;
+
+    my $chunks = $filter-&gt;put&#40;[$resp]&#41;;
+    is&#40;ref&#40;$chunks&#41;, &#39;ARRAY&#39;, &#39;put: returns arrayref&#39;&#41;;
+    is&#40; $#$chunks, 0, &#34;One chunk&#34; &#41;;
+    ok&#40; !utf8::is_utf8&#40; $chunks-&gt;[0] &#41;, &#34;Header was converted to iso-latin-1&#34; &#41;;
+    like&#40; $chunks-&gt;[0], qr/\x00\xC3\xE7\xFF\x00/, &#34;Content wasn&#39;t corrupted&#34; &#41;;
+} # }}}
+
+
 { # really, really garbage requests get rejected, but goofy ones accepted {{{
   {
     my $filter = POE::Filter::HTTPD-&gt;new;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;07&nbsp;22:41:32&nbsp;2014</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Dec 12 16:26:04 2013, GWYN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; HTTP::Headers doesn&#39;t handle non-ISO-8859-1 text properly.  Anything
&gt; that isn&#39;t ISO-8859-1 should be encoded according to RFC2047.
&gt; 
&gt; The inclosed patch does just this.
</div>
This seems to be already committed, but I&#39;m not closing this ticket yet.  The change and/or test seems to have introduced a warning in the tests:

t/10_units/05_filters/03_http.t .................... 1/137 Wide characters in HTTP header at /Users/troc/projects/poe/poe/blib/lib/POE/Filter/HTTPD.pm line 72.
        POE::Filter::HTTPD::__ANON__&#40;&#39;En \x{e9}t\x{e9}&#39;&#41; called at /Users/troc/projects/poe/poe/blib/lib/POE/Filter/HTTPD.pm line 444
        POE::Filter::HTTPD::headers_as_strings&#40;&#39;POE::Filter::HTTPD=ARRAY&#40;0x7fda34123170&#41;&#39;, &#39;HTTP::Headers=HASH&#40;0x7fda34124430&#41;&#39;, &#39;\x{d}\x{a}&#39;&#41; called at /Users/troc/projects/poe/poe/blib/lib/POE/Filter/HTTPD.pm line 406
        POE::Filter::HTTPD::put&#40;&#39;POE::Filter::HTTPD=ARRAY&#40;0x7fda34123170&#41;&#39;, &#39;ARRAY&#40;0x7fda34109dc8&#41;&#39;&#41; called at t/10_units/05_filters/03_http.t line 426
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;07&nbsp;22:41:32&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;07&nbsp;22:46:55&nbsp;2014</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m altering the message to read

Downgrading wide characters in HTTP header. Consier installing Email::MIME::RFC2047::Encoder

which is a little clearer about what&#39;s happening, and how to fix it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;07&nbsp;22:46:55&nbsp;2014</span>
    <span class="description">RCAPUTO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
