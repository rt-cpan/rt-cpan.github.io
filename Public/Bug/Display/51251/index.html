<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #51251 for Protocol-Modbus: /Library/Perl/5.8.8/Protocol/Modbus/Transport/TCP.pm uninitialized value error</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #51251 for Protocol-Modbus: /Library/Perl/5.8.8/Protocol/Modbus/Transport/TCP.pm uninitialized value error</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Protocol-Modbus/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Protocol-Modbus/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Protocol-Modbus/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Protocol-Modbus/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Protocol-Modbus">Protocol-Modbus CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">51251</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">30 min

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Protocol-Modbus/Active/">Protocol-Modbus</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">cosimo [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
gtp [...] lbl.gov

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-42330-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-42331-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




test43-1430.jpg<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/687634/353956/test43-1430.jpg">
Mon Nov 09 18:00:54 2009 (188.4k) by gtp [...] lbl.gov
</a>
</font></li>
</ul>


test43.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/687634/353955/test43.pl">
Mon Nov 09 18:00:54 2009 (8.8k) by gtp [...] lbl.gov
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;09&nbsp;16:58:43&nbsp;2009</span>
    <span class="description">gtp [...] lbl.gov -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> /Library/Perl/5.8.8/Protocol/Modbus/Transport/TCP.pm uninitialized value error</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 09 Nov 2009 13:57:51 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Protocol-Modbus [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> gtp &lt;gtp [...] lbl.gov&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">My perl script, which is run one time every minute by root&#39;s crontab,  
returned one of these errors to me today. It&#39;s the first I&#39;ve
seen in months of operation.

Use of uninitialized value in concatenation &#40;.&#41; or string at /Library/Perl/5.8.8/Protocol/Modbus/Transport/TCP.pm line 27.
Can&#39;t connect to Modbus server on 128.32.117.40: at /Library/Perl/5.8.8/Protocol/Modbus/Transaction.pm line 63


It&#39;s possible that the error in TCP.pm was induced/caused/exacerbated by 
my modbus module which
occasionally &#40;a couple of times a day&#41;  barfs out hundreds or thousands 
or tens of thousands
of unexpected/unsolicited TCP packets, or ICMP,  or ARP packets.

My guess is that this error path in TCP.pm is taken rarely, and I was 
just  lucky enough to see an occurrence.

I hope you find this helpful for cleaning up the code.

I presume my cron script died when the error occurred and I didn&#39;t get 
my data from the I/O module.
If you revise the package I&#39;d appreciate an email so I can download a 
new version,
assuming it will make my data collection more reliable...

Thank you for your otherwise excellent resource.

Gerald Przybylski
for the Electronics shop of the Physics department
of the University of California, Berkeley
510 642 3834
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;09&nbsp;17:25:57&nbsp;2009</span>
    <span class="description">cosimo [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;09&nbsp;17:27:17&nbsp;2009</span>
    <span class="description">cosimo [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Can you please confirm that you are using the latest CPAN version 
&#40;0.05&#41;? perl is 5.8.8. What platform?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;09&nbsp;17:27:18&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;09&nbsp;18:00:54&nbsp;2009</span>
    <span class="description">gtp [...] lbl.gov -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #51251] /Library/Perl/5.8.8/Protocol/Modbus/Transport/TCP.pm uninitialized value error</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 09 Nov 2009 15:00:24 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Protocol-Modbus [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> gtp &lt;gtp [...] lbl.gov&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,
Perl is 5.8.8
Protocol Modbus is 0.05;  it was installed a couple of months ago, and the
newest version is from late last year, I believe.

The server is a Macintosh Mini running 10.5.8 of the operating system.
The Modbus TCP device that gives me unexpected packets is the Advantech 
ADAM-6050
&#40;which I would never buy again!!&#41;
The server and I/O module are on the same subnet, but on different ports 
of the ethernet 100-Base-T switch.
They&#39;re in the berkeley.edu address space, not on a VLAN.

I was running dumpcap at the time this error occurred, so you can look 
through the capture
file with wireshark if you would find that useful. 
It happened at exactly 2:30pm  today &#40;20091109223011 GMT&#41;, according to 
the emailed report.
The file is <span class="clickylink"><a target="new" rel="nofollow" href="http://ln2.physics.berkeley.edu/log/ws/echo_00067_20091109054027">http://ln2.physics.berkeley.edu/log/ws/echo_00067_20091109054027</a></span>
My reading of the file is that it occurred when the modbus/tcp I/O 
module was misbehaving.

The script &#40;attached&#41; attempts first to ping the device, then opens the 
port &#40;SYN&#41;, then reads the module, then closes &#40;FIN&#41;.
In this case the ICMP response never arrived, and the script attempted 
to connect several times.
A screen snapshot is attached too.

Jerry



Cosimo Streppone via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=51251">https://rt.cpan.org/Ticket/Display.html?id=51251</a></span> &gt;
&gt;
&gt; Can you please confirm that you are using the latest CPAN version 
&gt; &#40;0.05&#41;? perl is 5.8.8. What platform?
&gt;   
</div></div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl
#
# Base on &#39;Modbus/TCP Server query&#39; by Cosimo Feb 1st, 2007
# Issues a read coils request on an IP address / port
# Here Protocol::Modbus is used only to build request
# $Id: read_coils_simple.pl,v 1.2 2007/02/05 11:16:02 cosimo Exp $
#
# UC Berkeley Physics -- Electronics shop -- gtp 3/19/09
# This script runs as a cron job every minute or longer.
# This script creates a three files; a last-read file; a history file; a feature-state file.
# See initialization below.
# The feature-state file is delivered to the user&#39;s browser by a cgi script.
# changes: Nov 4, 2009 migrate from basic read paradigm to general paradigm

use strict;
use warnings;
use carp;
use Protocol::Modbus;
use Net::Domain;
use Sys::Hostname;
use Socket;

my $netdebug = 0;
if &#40; &#40; defined  $ARGV[0] &#41; &#38;&#38; &#40; $ARGV[0] =~ m/debug/ &#41; &#41; { $netdebug=1; } # Turn on the tcp debugging 

my $version = &#39; V1.0&#39; ;
my $modbusHost = q!echo.physics.berkeley.edu!;
#my $ip = join&#40;/./,unpack&#40;&#34;C4&#34;,&#40;gethostbyname&#40;$modbusHost&#41;&#41;[4]&#41;&#41;;
my $ip = &#39;128.32.117.40&#39;;  # the IP of the ethernet input device
my $trials   = 5;
my $datapath = &#34;/var/www/Documents/LN2/snapshot/&#34;; # Where non-cgi files are located
#my $datapath = &#34;/Users/electronicsshop/embedded/&#34;; # Where non-cgi files are located
my $logpath  = &#34;/var/log/&#34; ;
#my $logpath  = &#34;/Users/electronicsshop/embedded/&#34; ;
my $lndata   = $datapath.&#39;lndata&#39;;	# Formatted snapshot of the last device read
my $lnhistory= $logpath.&#39;lnhistory&#39;;	# Ultimately holds date-stamped changes of state.
my $snapshot = $datapath.&#39;last&#39; ;	# bit-pattern
my $reportRoute = &#34;1&#34; ;
my @features = &#40; &#34;Sub-floor Temperature:&#34;, 
		&#34;Sub-floor Water Level state:&#34;, 
		&#34;Atmosphere &#40;per ODM&#41;:&#34;,  # future home of oxygen depletion monitor
		&#34;Scale:&#34;, 
		&#34;Scale BP:&#34;, # bypass switch on interlock system state
		&#34;Chain:&#34;, 
		&#34;Permit:&#34;,
		&#34;VB-Permit:&#34;,# The input pin of the Nitromatic&#39;s controller.
		&#34;START:&#34;,    # Nitromatic &#34;Start&#34; button state
		&#34;Station:&#34;,  # Nitromatic Fill System &#34;Filling&#34; state
		&#34;Station:&#34;,  # Small Dewar Solenoid Valve Status
                &#34;Power:&#34;&#41;;
my @featureStates =&#40; &#34;Normal#&lt;font color=\&#34;blue\&#34;&gt;Subnormal. Clears within 15 min. unless there is a system fault.&lt;/font&gt;&lt;font color=\&#34;black\&#34;&gt;&lt;/font&gt;&#34;,
		&#34;Normal#Flooded. Potential scale sensor damage from immursion.&#34;,
		&#34;Safe#&lt;font color=\&#34;red\&#34;&gt;DANGER!! Anoxic! UNSAFE TO ENTER WHILE ALARM SOUNDS!!&lt;/font&gt;&lt;font color=\&#34;black\&#34;&gt;&lt;/font&gt;&#34;,
		&#34;Fill Permitted#Fill Disallowed&#34;,
		&#34;Bypass Mode#Normal Mode&#34;,
		&#34;Complete#Open Interlock&#34;,
		&#34;Normal#Not Granted&#34;,
		&#34;Permit#STOPPED&#34;,
		&#34;DEPRESSED#Normal&#34;,
		&#34;Filling#Not Filling&#34;,
		&#34;Filling#Not Filling&#34;,
                &#34;On#Off&#34;&#41;;
$| = 1;

my $mylast = q!000000000000!;
if &#40; open&#40; RFH, &#34;&lt;&#34;.$snapshot &#41; &#41; { # Recall data from the preavious pass through the program, if it exists
    $mylast = &lt;RFH&gt;;
    close&#40; RFH &#41;;
}

my $timestamp = localtime&#40;&#41;;  # a time stamp very close to the actual read time.

my $sysstatus = 0;
if &#40;$netdebug&#41; {
     $sysstatus = `/var/www/CGI-Executables/dotcpdump start echo 128.32.117.40`;  # print &#39;started dump at &#39;.localtime&#40;&#41;.&#39;status-&#39;.$sysstatus.&#34;-\n&#34;;
}

# the dotcpdump script runs tcpdump as a bsackground process, and captures the PID of it in a file so it can be killed later
# The &#34;stop&#34; invocation reads the PID from a file, and issues a kill command
# If the &#39;connect&#39; succeeds, the tcp dump file can or should be deleted with the &#34;unsave&#34; invocation of the script
# usage dotcpdump start|stop|unsave [filename [hostname|ip]]


my $areyouthere = `/sbin/ping -qc1 -t1 $ip` ; # ping once to see if there&#39;s a path to the host. Produces a 2 packet ICMP transaction
if &#40; $areyouthere =~ /100%\s+packet\+loss/&#41; { 
    if &#40;$netdebug&#41; { $sysstatus = system&#40;&#34;/var/www/CGI-Executables/dotcpdump stop echo&#34;&#41; ;}
    if &#40; $mylast =~ /path error/ &#41; {   # Still out of service
        exit 0; # exiting cleanly prevents cron from sending emails; die provikes email reports
    } else { open&#40; LOGFH, &#34;&gt;&#34;.$snapshot &#41; or die &#34; can&#39;t open snapshot file after ping failure \n&#34;;  # The beginning of an outage
        print LOGFH &#34;path error &#34;.$timestamp.$version;
        close LOGFH; 
        open&#40; LOGFH, &#34;&gt;&gt;&#34;.$lnhistory &#41; or die &#34;can&#39;t open the log file after ping failure \n&#34;;
        print LOGFH &#34;Ping failed. No network path to I/O module at &#34;.$timestamp;
        close LOGFH;
        die &#34;Ping failed. No network path to $ip at $timestamp \n&#34;;
    }
}

my $name = hostname&#40;&#41;;	# Make a randomizer to avoid collisions if multiple pollers
my $randomizer = &#40;&#40;unpack&#40;&#34;C4&#34;,&#40;gethostbyname&#40;$name&#41;&#41;[4]&#41;&#41;[3]&#41;/16;

# The MODBUS dialog begins here.
my $modbus = Protocol::Modbus-&gt;new&#40;driver=&gt;&#39;TCP&#39;&#41;;
my $req = $modbus-&gt;readInputsRequest&#40;
    address  =&gt; 0,
    quantity =&gt; 12,
&#41;;

# Open a Socket to Device
# use IO::Socket::INET;
my $trial=$trials ;

select&#40;undef, undef, undef, $randomizer &#41;;

# the dotcpdump script runs tcpdump as a bsackground process, and captures the PID of it in a file so it can be killed later
# The &#34;stop&#34; invocation reads the PID from a file, and issues a kill command
# If the &#39;connect&#39; succeeds, the tcp dump file can or should be deleted

my $trs ;
until &#40; defined&#40; $trs = Protocol::Modbus::Transport-&gt;new&#40;
    driver=&gt;&#39;TCP&#39;,
    address =&gt; $ip,
    PeerPort =&gt; 502,
    Timeout  =&gt; 3, &#41;&#41;&#41;  # Even works with ADAM-6050 with Timeout=1... i.e. no connect errors.
{
    if &#40; 0 &lt; --$trial &#41;{
        if &#40; $reportRoute &#38;&#38; &#40; $trials-$trial == 2 &#41; &#41; {
#           $route = system&#40;&#34;/usr/local/bin/lft -SVV echo.physics.berkeley.edu&#34;&#41; ; # Possible place for a diagnostic
#           LFT doesn&#39;t seem to work properly in this context... especially as a cron job
        }
    } else {
        if &#40;$netdebug&#41; { $sysstatus = system&#40; &#34;/var/www/CGI-Executables/dotcpdump stop echo&#34; &#41; ;}
        if &#40; $mylast =~ &#34;connect error&#34; &#41; {
            exit 0 ; # prevents the stream of emails
        } else {
            open&#40; LOGFH, &#39;&gt;&gt;&#39;.$logpath.&#39;ln-mod-error&#39; &#41; or die &#34;Can&#39;t open mod error file: $! while reporting connect error \n&#34;;
            # print &#34;Failed to connect to I/O module at &#34;.$timestamp.&#34;\n&#34;;
            print LOGFH &#34;Can&#39;t connect to I/O module after multiple attempts. $timestamp\n&#34;;
            close LOGFH;
            open&#40; LOGFH, &#39;&gt;&gt;&#39;.$lnhistory &#41; or die &#34;Can&#39;t open history log file: $! while reporting connect error&#34;;
            print LOGFH &#34;Can&#39;t connect to I/O module after multiple attempts. $timestamp\n&#34;;
            close LOGFH; # When the network comes back up, an idle state entr: should be appended to the log file.
            open&#40; XFH, &#39;&gt;&#39;.$snapshot &#41; or die &#34;Can&#39;t open snapshot file $snapshot for write: $!\n&#34;;
            print XFH &#34;connect error &#34;.$timestamp.$version  ;
            close XFH;
            die &#34;Can&#39;t connect to I/O module after $trials attempts. \n&#34; ;
        }
    }
    select&#40; undef, undef, undef, $trials-$trial &#41;;
}
# print &#34;Connected.\n&#34;;
# Should have generated a 3 packet [SYN] transaction

$timestamp = localtime&#40;&#41;;  # a time stamp very close to the actual read time.
my $trn = $modbus-&gt;transaction&#40; $trs, $req &#41;; # $req asks for 12 bytes in the read-coils request. 16 bytes are returned.
my $res = $trn-&gt;execute&#40;&#41;;
my @mypat = @{ $res-&gt;inputs&#40;&#41; }; 
my $mybits = join&#40; &#34;&#34;, @mypat[0..11] &#41;; # Trim the vector to the fields actually returned.
if &#40; 16 !=  @mypat  &#41; { 
    if &#40; $netdebug &#41; { system&#40; &#34;dotcpdump stop echo&#34; &#41;; }
    die &#34;Received @mypat &#34;. @mypat .&#34; bytes. 16 bytes expected. \n&#34;;
}

# print &#34;data bytes: [@mypat] Reading &gt;&#34;.$mybits.&#34;&lt; Last reading %$mylast% at $timestamp \n&#34;;

open&#40; XFH, &#39;&gt;&#39;.$snapshot &#41; or die &#34;Can&#39;t open snapshot file $snapshot for write: $!&#34;;
print XFH &#34;$mybits $timestamp$version&#34;  ;
close XFH;

if &#40; not $mylast =~ $mybits &#41; { # Integrity check. 
    $res = $trn-&gt;execute&#40;&#41;; 
    my $rebits = join&#40; &#34;&#34;, @{ $res-&gt;inputs&#40;&#41; }[0..11] &#41;;
    # print &#34;reading $mybits; check rearad $rebits.\n&#34;;
    if &#40; not $mybits =~ $rebits &#41;{
        open&#40; LOGFH, &#39;&gt;&gt;&#39;.$logpath.&#39;ln-mod-error&#39; &#41; or die &#34;Can&#39;t open mod error file: $!&#34;;
        print LOGFH &#34;pattern $mybits check-pattern $rebits $timestamp\n&#34;;
        close LOGFH;
        carp &#40; &#34;Alert: reading pattern $mybits check-pattern $rebits $timestamp\n&#34; &#41;;
    }
}

# print &#39; mylast &#39;. $mylast. &#39; mybits &#39;.$mybits.&#39; file &#39;.$lnhistory.&#34; \n&#34;;
if &#40; not $mylast =~ $mybits &#41; {  # The place to recognize particular state transitions... like fill ended...
    my $flags = &#40; $mybits =~ &#34;.{9}0.{2}&#34;  &#41; ? &#39;L&#39;:&#39;&#39;;		# Recognize large dewar fill
    $flags   .= &#40; $mybits =~ &#34;.{8}00.{2}&#34; &#41; ? &#39;*&#39;:&#39;&#39;;		# Recognize tape on the start switch! &#39;01&#39; and &#39;10&#39; are normal
    $flags   .= &#40; $mybits =~ &#34;.{10}0.{1}&#34; &#41; ? &#39;S&#39;:&#39;&#39;;		# Recognize small dewar fill
    open&#40; LOGFH, &#39;&gt;&gt;&#39;.$lnhistory &#41; or die &#34;Can&#39;t open history log file: $!&#34;;
    print LOGFH $mybits.&#34; &#34;.$timestamp.$flags.&#34;\n&#34;;
    close LOGFH;
}

open MYFH, &#34;&gt;&#34;.$lndata or die &#34;couldn&#39;t open $!&#34;;
my $index=0;
foreach &#40; @mypat[0..11] &#41; {	# Build record for the CGI script to spit out
    print MYFH $features[$index],&#39;รยง&#39;,&#40;split&#40;/#/,$featureStates[$index]&#41;&#41;[$_],&#34;#&#34;;
    $index++;
}
print MYFH &#39;[&#39;.$timestamp.&#39;]&#39;.&#34;#&#34;;
close MYFH;
 
print &#34;$mybits at $timestamp\n&#34;; 
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/687634/353956/test43-1430.jpg">Download test43-1430.jpg</a><br />
<span class="downloadcontenttype">image/jpeg 188.4k</span>
</div>
<div class="messagebody">
<img alt="test43-1430.jpg" title="test43-1430.jpg" src="/Ticket/Attachment/687634/353956/" /></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;09&nbsp;19:14:49&nbsp;2009</span>
    <span class="description">gtp [...] lbl.gov -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #51251] /Library/Perl/5.8.8/Protocol/Modbus/Transport/TCP.pm uninitialized value error</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 09 Nov 2009 16:14:34 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Protocol-Modbus [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> gtp &lt;gtp [...] lbl.gov&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I found a place where in a match where a &#34;\s+&#34; had become a &#34;\+&#34;
It was in the test after the ping command...
so the script would not have detected an &#39;unreachable&#39; host.

The script then tried to connect to that unreachable host which resulted 
in my
being sent me the line 27 error in .../TCP.pm.

jerry

Cosimo Streppone via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=51251">https://rt.cpan.org/Ticket/Display.html?id=51251</a></span> &gt;
&gt;
&gt; Can you please confirm that you are using the latest CPAN version 
&gt; &#40;0.05&#41;? perl is 5.8.8. What platform?
&gt;   
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;21&nbsp;14:46:46&nbsp;2009</span>
    <span class="description">cosimo [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m glad you use Protocol::Modbus at Berkeley. If I ever come to the 
US, I&#39;d like to see it :&#41;

Sorry, I&#39;m a bit busy right now. As soon as I get some time, I shall 
change the TCP driver to check that the connection has been properly 
established.

Thanks for the feedback.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;21&nbsp;16:06:11&nbsp;2009</span>
    <span class="description">gtp [...] lbl.gov -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #51251]  - - comment</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 21 Nov 2009 13:05:58 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Protocol-Modbus [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> gtp &lt;gtp [...] lbl.gov&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Thanks for providing Protocol::Modbus.  As a Modbus user, I&#39;m a really 
small player
with only 2 I/O modules.     My project went with Perl because I knew 
some Perl
and no JAVA when I started... and I thought I thought it might be easier 
to do the
simple cgi web page stuff with it. &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://ln2.physics.berkeley.edu/status&#41;">http://ln2.physics.berkeley.edu/status&#41;</a></span>

When my network drops out I get errors when attempting to open a 
connections.
That suggests a test condition...  namely attempting to talk to a 
non-existent module. :&#41;

 From here in Berkeley we have a wonderful view of the San Fransisco 
bay, San Fransisco,
Alcatraz island, and Marin county.    If you do come to this part of our 
state,  consider putting
the Muir Woods national park, in Marin County north of San Fransisco,
on your itinerary. We think it&#39;s one of the local treasures. 
UC Berkeley has an art museum, and an exhibits in the anthropology building.

Regards,
Jerry


Cosimo Streppone via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=51251">https://rt.cpan.org/Ticket/Display.html?id=51251</a></span> &gt;
&gt;
&gt; I&#39;m glad you use Protocol::Modbus at Berkeley. If I ever come to the 
&gt; US, I&#39;d like to see it :&#41;
&gt;
&gt; Sorry, I&#39;m a bit busy right now. As soon as I get some time, I shall 
&gt; change the TCP driver to check that the connection has been properly 
&gt; established.
&gt;
&gt; Thanks for the feedback.
&gt;   
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;20&nbsp;09:46:51&nbsp;2009</span>
    <span class="description">cosimo [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">30 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Gerald,

I reviewed the code and from your logs I can see that the TCP 
connection failure is handled &#34;correctly&#34;.

That is, Protocol::Modbus is detecting that the TCP connection to your 
module failed, and it&#39;s reporting the failure through the connect&#40;&#41; 
call down to the $transaction-&gt;execute&#40;&#41; call.

In my opinion, this is the correct behavior. So, what can we do to 
prevent this from happening? I would suggest slightly modifying your 
code:

  $timestamp = localtime&#40;&#41;; # a time stamp very close to the actual 
read time.
  my $trn = $modbus-&gt;transaction&#40; $trs, $req &#41;; # $req asks for 12 
bytes in the read-coils request. 16 bytes are returned.
  my $res = $trn-&gt;execute&#40;&#41;;
  ...

like this:

  $timestamp = localtime&#40;&#41;; # a time stamp very close to the actual 
read time.
  my $trn = $modbus-&gt;transaction&#40; $trs, $req &#41;; # $req asks for 12 
bytes in the read-coils request. 16 bytes are returned.
  my $res = $trn-&gt;execute&#40;&#41;;

  # Connection failed? Try reconnecting and reissuing transaction
  my $retries = 3;
  while &#40;! $res &#38;&#38; $retries--&#41; {
      sleep 1;
      $res = $trn-&gt;execute&#40;&#41;;
  }

  ...

So, you can retry the connection and the transaction issuing code until 
it succeeds. Let me know if this is useful.
If it proves to be useful, maybe it&#39;s a good idea to integrate it in 
the execute&#40;&#41; method itself.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;18&nbsp;11:01:42&nbsp;2010</span>
    <span class="description">cosimo [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> gtp [...] lbl.gov</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Dec 20 09:46:51 2009, COSIMO wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Gerald,
&gt; 
&gt; I reviewed the code and from your logs I can see that the TCP 
&gt; connection failure is handled &#34;correctly&#34;.
&gt; 
&gt; That is, Protocol::Modbus is detecting that the TCP connection to 
</div>your 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; module failed, and it&#39;s reporting the failure through the connect&#40;&#41; 
&gt; call down to the $transaction-&gt;execute&#40;&#41; call.
&gt; 
&gt; In my opinion, this is the correct behavior. So, what can we do to 
&gt; prevent this from happening? I would suggest slightly modifying your 
&gt; code:
&gt; 
&gt;   $timestamp = localtime&#40;&#41;; # a time stamp very close to the actual 
&gt; read time.
&gt;   my $trn = $modbus-&gt;transaction&#40; $trs, $req &#41;; # $req asks for 12 
&gt; bytes in the read-coils request. 16 bytes are returned.
&gt;   my $res = $trn-&gt;execute&#40;&#41;;
&gt;   ...
&gt; 
&gt; like this:
&gt; 
&gt;   $timestamp = localtime&#40;&#41;; # a time stamp very close to the actual 
&gt; read time.
&gt;   my $trn = $modbus-&gt;transaction&#40; $trs, $req &#41;; # $req asks for 12 
&gt; bytes in the read-coils request. 16 bytes are returned.
&gt;   my $res = $trn-&gt;execute&#40;&#41;;
&gt; 
&gt;   # Connection failed? Try reconnecting and reissuing transaction
&gt;   my $retries = 3;
&gt;   while &#40;! $res &#38;&#38; $retries--&#41; {
&gt;       sleep 1;
&gt;       $res = $trn-&gt;execute&#40;&#41;;
&gt;   }
&gt; 
&gt;   ...
&gt; 
&gt; So, you can retry the connection and the transaction issuing code 
</div>until 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; it succeeds. Let me know if this is useful.
&gt; If it proves to be useful, maybe it&#39;s a good idea to integrate it in 
&gt; the execute&#40;&#41; method itself.
</div>
Ping?

Did you have a chance to try this?
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
