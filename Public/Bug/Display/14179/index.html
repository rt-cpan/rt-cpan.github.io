<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #14179 for DateTime-Format-W3CDTF: Module doesn&#39;t parse times that include fractions of a second</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #14179 for DateTime-Format-W3CDTF: Module doesn&#39;t parse times that include fractions of a second</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DateTime-Format-W3CDTF/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DateTime-Format-W3CDTF/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DateTime-Format-W3CDTF/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DateTime-Format-W3CDTF/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DateTime-Format-W3CDTF">DateTime-Format-W3CDTF CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">14179</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">patched</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DateTime-Format-W3CDTF/Active/">DateTime-Format-W3CDTF</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
gwilliams [...] cpan.org

<br />
TURNERA [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-9920-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-9921-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;15&nbsp;21:20:27&nbsp;2005</span>
    <span class="description">TURNERA [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Module doesn&#39;t parse times that include fractions of a second</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As described here: <span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/TR/NOTE-datetime">http://www.w3.org/TR/NOTE-datetime</a></span>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt;   Complete date plus hours, minutes, seconds and a decimal fraction of a second
&gt;      YYYY-MM-DDThh:mm:ss.sTZD &#40;eg 1997-07-16T19:20:30.45+01:00&#41;
&gt; where:
&gt;     s    = one or more digits representing a decimal fraction of a second
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;29&nbsp;11:16:26&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here&#39;s a patch.  &#40;This also changes the handful of tabs located in the source into spaces.&#41;
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">These do the following:
    Change all tabs to spaces.
    Add support for parsing and generating dates with fractional seconds.
    Add support for parsing time zones with seconds &#40;which the generator
      was capable of generating&#41;.
    Add a test for parsing dates with fractional seconds.

diff -ru DateTime-Format-W3CDTF-0.04/lib/DateTime/Format/W3CDTF.pm DateTime-Format-W3CDTF-Fixed/lib/DateTime/Format/W3CDTF.pm
--- DateTime-Format-W3CDTF-0.04/lib/DateTime/Format/W3CDTF.pm	2003-11-23 21:09:56.000000000 -0500
+++ DateTime-Format-W3CDTF-Fixed/lib/DateTime/Format/W3CDTF.pm	2005-08-29 11:08:46.000000000 -0400
@@ -7,6 +7,7 @@
 $VERSION = &#39;0.04&#39;;
 
 use DateTime;
+use DateTime::TimeZone;
 
 sub new
 {
@@ -15,92 +16,69 @@
     return bless {}, $class;
 }
 
-# key is string length
-my %valid_formats =
-    &#40; 19 =&gt;
-      { params =&gt; [ qw&#40; year month day hour minute second&#41; ],
-        regex  =&gt; qr/^&#40;\d{4}&#41;-&#40;\d\d&#41;-&#40;\d\d&#41;T&#40;\d\d&#41;:&#40;\d\d&#41;:&#40;\d\d&#41;$/,
-        zero   =&gt; {},
-      },
-      16 =&gt;
-      { params =&gt; [ qw&#40; year month day hour minute&#41; ],
-        regex  =&gt; qr/^&#40;\d{4}&#41;-&#40;\d\d&#41;-&#40;\d\d&#41;T&#40;\d\d&#41;:&#40;\d\d&#41;$/,
-        zero   =&gt; { second =&gt; 0 },
-      },
-      10 =&gt;
-      { params =&gt; [ qw&#40; year month day &#41; ],
-        regex  =&gt; qr/^&#40;\d{4}&#41;-&#40;\d\d&#41;-&#40;\d\d&#41;$/,
-        zero   =&gt; { hour =&gt; 0, minute =&gt; 0, second =&gt; 0 },
-      },
-      7 =&gt;
-      { params =&gt; [ qw&#40; year month &#41; ],
-        regex  =&gt; qr/^&#40;\d{4}&#41;-&#40;\d\d&#41;$/,
-        zero   =&gt; { day =&gt; 1, hour =&gt; 0, minute =&gt; 0, second =&gt; 0 },
-      },
-	  4 =&gt;
-      { params =&gt; [ qw&#40; year &#41; ],
-        regex  =&gt; qr/^&#40;\d\d\d\d&#41;$/,
-        zero   =&gt; { month =&gt; 1, day =&gt; 1, hour =&gt; 0, minute =&gt; 0, second =&gt; 0 }
-      }
-    &#41;;
-
 sub parse_datetime
 {
     my &#40; $self, $date &#41; = @_;
 
-    # save for error messages
-    my $original = $date;
-
-	my %p;
-    if &#40; $date =~ s/&#40;[+-]\d\d:\d\d&#41;$// &#41;
-    {
-        $p{time_zone} = $1;
+    my @fields = qw/ year month day hour minute second fraction time_zone /;
+    my @values = 
+        &#40; $date =~ /^&#40;\d\d\d\d&#41; # Year
+                     &#40;?:-&#40;\d\d&#41; # -Month
+                      &#40;?:-&#40;\d\d&#41; # -Day
+                       &#40;?:T
+                        &#40;\d\d&#41;:&#40;\d\d&#41; # Hour:Minute
+                        &#40;?:
+                           :&#40;\d\d&#41;     # :Second
+                           &#40;\.\d+&#41;?    # .Fractional_Second
+                        &#41;?
+                        &#40; Z          # UTC
+                        | [+-]\d\d:\d\d    # Hour:Minute TZ offset
+                          &#40;?::\d\d&#41;?       # :Second TZ offset
+                        &#41;?&#41;?&#41;?&#41;?$/x &#41;
+          or die &#34;Invalid W3CDTF datetime string &#40;$date&#41;&#34;;
+    my %p;
+    for &#40; my $i=0; $i &lt; @values; $i++ &#41; {  # Oh how I wish Perl had zip
+        next unless defined $values[$i];
+        $p{$fields[$i]} = $values[$i];
     }
-    # Z at end means UTC
-    elsif &#40; $date =~ s/Z$// &#41;
-    {
-        $p{time_zone} = &#39;UTC&#39;;
+    if &#40; !$p{time_zone} &#41; {
+        $p{time_zone} = &#39;floating&#39;;
     }
-    else
+    elsif &#40; $p{time_zone} eq &#39;Z&#39; &#41;
     {
-        $p{time_zone} = &#39;floating&#39;;
+        $p{time_zone} = &#39;UTC&#39;;
     }
 
-    my $format = $valid_formats{ length $date }
-        or die &#34;Invalid W3CDTF datetime string &#40;$original&#41;&#34;;
-
-    @p{ @{ $format-&gt;{params} } } = $date =~ /$format-&gt;{regex}/;
+    if &#40; $p{fraction} &#41; {
+        $p{nanosecond} = $p{fraction} * 1_000_000_000;
+        delete $p{fraction}
+    }
 
-    return DateTime-&gt;new&#40; %p, %{ $format-&gt;{zero} } &#41;;
+    return DateTime-&gt;new&#40; %p &#41;;
 }
 
 sub format_datetime
 {
     my &#40; $self, $dt &#41; = @_;
 
-    # removed in 0.4 as it behaved improperly at midnight - kellan 2003/11/23
-    #my $base =
-    #    &#40; $dt-&gt;hour || $dt-&gt;min || $dt-&gt;sec ?
-    #      sprintf&#40; &#39;%04d-%02d-%02dT%02d:%02d:%02d&#39;,
-    #               $dt-&gt;year, $dt-&gt;month, $dt-&gt;day,
-    #               $dt-&gt;hour, $dt-&gt;minute, $dt-&gt;second &#41; :
-    #      sprintf&#40; &#39;%04d-%02d-%02d&#39;, $dt-&gt;year, $dt-&gt;month, $dt-&gt;day &#41;
-    #    &#41;;
-    
-	my $base = sprintf&#40; &#39;%04d-%02d-%02dT%02d:%02d:%02d&#39;,
-		$dt-&gt;year, $dt-&gt;month, $dt-&gt;day,
+    my $base = sprintf&#40; &#39;%04d-%02d-%02dT%02d:%02d:%02d&#39;,
+        $dt-&gt;year, $dt-&gt;month, $dt-&gt;day,
         $dt-&gt;hour, $dt-&gt;minute, $dt-&gt;second &#41;;
-
+    if &#40; $dt-&gt;nanosecond &#41; {
+        my $secs = sprintf &#34;%f&#34;, $dt-&gt;nanosecond / 1_000_000_000;
+        $secs =~ s/^0//;
+        $base .= $secs;
+    }
 
     my $tz = $dt-&gt;time_zone;
 
     return $base if $tz-&gt;is_floating;
 
-	return $base . &#39;Z&#39; if $tz-&gt;is_utc;
+    return $base . &#39;Z&#39; if $tz-&gt;is_utc;
 
-	if &#40;my $offset = $dt-&gt;offset&#40;&#41;&#41; {
-		return $base . offset_as_string&#40;$offset &#41;;
-	}
+    if &#40;my $offset = $dt-&gt;offset&#40;&#41;&#41; {
+        return $base . offset_as_string&#40; $offset &#41;;
+    }
 }
 
 sub format_date
@@ -108,7 +86,7 @@
     my &#40; $self, $dt &#41; = @_;
 
     my $base = sprintf&#40; &#39;%04d-%02d-%02d&#39;, $dt-&gt;year, $dt-&gt;month, $dt-&gt;day &#41;;
-	return $base; 
+    return $base; 
 }
 
 # minor offset_as_string variant w/ :
diff -ru DateTime-Format-W3CDTF-0.04/t/01parse.t DateTime-Format-W3CDTF-Fixed/t/01parse.t
--- DateTime-Format-W3CDTF-0.04/t/01parse.t	2003-11-23 21:09:56.000000000 -0500
+++ DateTime-Format-W3CDTF-Fixed/t/01parse.t	2005-08-29 11:07:37.000000000 -0400
@@ -1,5 +1,5 @@
 #!/usr/bin/perl -w
-use Test::More tests =&gt; 17;
+use Test::More tests =&gt; 18;
 use strict;
 use vars qw&#40; $class &#41;;
 
@@ -9,15 +9,16 @@
 }
 
 my @tests = &#40;
-    &#39;2003-02-10T15:23:45&#39;	=&gt; &#39;2003-02-10T15:23:45&#39;,
-    &#39;1997-04-11T09:34&#39;		=&gt; &#39;1997-04-11T09:34:00&#39;,
-    &#39;2002-05-12&#39;		=&gt; &#39;2002-05-12T00:00:00&#39;,
-    &#39;1985-06&#39;			=&gt; &#39;1985-06-01T00:00:00&#39;,
-    &#39;1988&#39;			=&gt; &#39;1988-01-01T00:00:00&#39;,
-  #  &#39;2001-02-30&#39;		=&gt; &#39;2001-03-02T00:00:00&#39;,
-    &#39;2005-03-10T20:14:34+09:30&#39;	=&gt; &#39;2005-03-10T10:44:34&#39;,
-    &#39;2000-06-12T14:12:33Z&#39;	=&gt; &#39;2000-06-12T14:12:33&#39;,
-    &#39;1994-11-05T08:15:30-05:00&#39;	=&gt; &#39;1994-11-05T13:15:30&#39;,
+    &#39;2003-02-10T15:23:45&#39;          =&gt; &#39;2003-02-10T15:23:45&#39;,
+    &#39;1997-04-11T09:34&#39;             =&gt; &#39;1997-04-11T09:34:00&#39;,
+    &#39;2002-05-12&#39;                   =&gt; &#39;2002-05-12T00:00:00&#39;,
+    &#39;1985-06&#39;                      =&gt; &#39;1985-06-01T00:00:00&#39;,
+    &#39;1988&#39;                         =&gt; &#39;1988-01-01T00:00:00&#39;,
+  #  &#39;2001-02-30&#39;                   =&gt; &#39;2001-03-02T00:00:00&#39;,
+    &#39;2005-03-10T20:14:34+09:30&#39;    =&gt; &#39;2005-03-10T10:44:34&#39;,
+    &#39;2000-06-12T14:12:33Z&#39;         =&gt; &#39;2000-06-12T14:12:33&#39;,
+    &#39;1994-11-05T08:15:30-05:00&#39;    =&gt; &#39;1994-11-05T13:15:30&#39;,
+    &#39;2004-07-01T15:00:13.17-05:00&#39; =&gt; &#39;2004-07-01T20:00:13&#39;,
 &#41;;
 
 while &#40;@tests&#41;
diff -ru DateTime-Format-W3CDTF-0.04/t/02bugs.t DateTime-Format-W3CDTF-Fixed/t/02bugs.t
--- DateTime-Format-W3CDTF-0.04/t/02bugs.t	2003-11-23 21:09:56.000000000 -0500
+++ DateTime-Format-W3CDTF-Fixed/t/02bugs.t	2005-08-29 11:08:30.000000000 -0400
@@ -1,7 +1,7 @@
 #!/usr/bin/perl -w
 
 # test bug 3766 
-#	<span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/NoAuth/Bug.html?id=3766">http://rt.cpan.org/NoAuth/Bug.html?id=3766</a></span>
+#   <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/NoAuth/Bug.html?id=3766">http://rt.cpan.org/NoAuth/Bug.html?id=3766</a></span>
 #   returns undef when you pass it a DateTime object 
 #   whose timezone has been explicitly set.
 
@@ -17,26 +17,26 @@
 use DateTime::Format::W3CDTF;
 
 my @dates = &#40;
-	{ date   =&gt; { year =&gt; 1977, month =&gt; 11, day =&gt; 11, hour =&gt; 1, minute =&gt; 12, time_zone =&gt; &#39;America/Los_Angeles&#39; },
-	  w3cdtf =&gt; &#39;1977-11-11T01:12:00-08:00&#39;,
-	  msg	 =&gt; &#39;formatter works with explicit timezone&#39;,
-	},
-	{ date   =&gt; { year =&gt; 1977, month =&gt; 4, day =&gt; 7, time_zone =&gt; &#39;America/Los_Angeles&#39; },
-	  w3cdtf =&gt; &#39;1977-04-07T00:00:00-08:00&#39;,
-	  msg	 =&gt; &#39;formatter works without timestamp&#39;,
-	},
-	{ date   =&gt; { year =&gt; 2003, month =&gt; 4, day =&gt; 7, hour =&gt; 2, time_zone =&gt; &#39;America/Los_Angeles&#39; },
-	  w3cdtf =&gt; &#39;2003-04-07T02:00:00-07:00&#39;,
-	  msg	 =&gt; &#39;formatter properly recognizing daylights saving&#39;
-	},
-	{ date   =&gt; { year =&gt; 2003, month =&gt; 12, day =&gt; 25, hour =&gt; 0, minute =&gt; 00, second =&gt; 00, time_zone =&gt; &#39;America/Montreal&#39; },
-	  w3cdtf =&gt; &#39;2003-12-25T00:00:00-05:00&#39;,
-	  msg	 =&gt; &#39;formatter properly formats midnight&#39;
-	}
+   { date   =&gt; { year =&gt; 1977, month =&gt; 11, day =&gt; 11, hour =&gt; 1, minute =&gt; 12, time_zone =&gt; &#39;America/Los_Angeles&#39; },
+     w3cdtf =&gt; &#39;1977-11-11T01:12:00-08:00&#39;,
+     msg    =&gt; &#39;formatter works with explicit timezone&#39;,
+   },
+   { date   =&gt; { year =&gt; 1977, month =&gt; 4, day =&gt; 7, time_zone =&gt; &#39;America/Los_Angeles&#39; },
+     w3cdtf =&gt; &#39;1977-04-07T00:00:00-08:00&#39;,
+     msg    =&gt; &#39;formatter works without timestamp&#39;,
+   },
+   { date   =&gt; { year =&gt; 2003, month =&gt; 4, day =&gt; 7, hour =&gt; 2, time_zone =&gt; &#39;America/Los_Angeles&#39; },
+     w3cdtf =&gt; &#39;2003-04-07T02:00:00-07:00&#39;,
+     msg    =&gt; &#39;formatter properly recognizing daylights saving&#39;
+   },
+   { date   =&gt; { year =&gt; 2003, month =&gt; 12, day =&gt; 25, hour =&gt; 0, minute =&gt; 00, second =&gt; 00, time_zone =&gt; &#39;America/Montreal&#39; },
+     w3cdtf =&gt; &#39;2003-12-25T00:00:00-05:00&#39;,
+     msg    =&gt; &#39;formatter properly formats midnight&#39;
+   }
 &#41;;
 my $f = DateTime::Format::W3CDTF-&gt;new&#40;&#41;;
 
 foreach my $d &#40; @dates &#41; {
-	my $dt = DateTime-&gt;new&#40; %{ $d-&gt;{date} } &#41;;
-	is &#40; $f-&gt;format_datetime&#40;$dt&#41;, $d-&gt;{w3cdtf}, $d-&gt;{msg}&#41;;
-}
\ No newline at end of file
+   my $dt = DateTime-&gt;new&#40; %{ $d-&gt;{date} } &#41;;
+   is &#40; $f-&gt;format_datetime&#40;$dt&#41;, $d-&gt;{w3cdtf}, $d-&gt;{msg}&#41;;
+}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;29&nbsp;11:17:03&nbsp;2005</span>
    <span class="description">TURNERA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">That patch is from me.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Create even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;24&nbsp;21:06:02&nbsp;2010</span>
    <span class="description">gwilliams [...] cpan.org - Ticket #61623:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> parse_datetime fails on valid W3C DTF strings</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">W3CDTF allows sub-second accuracy with the format


YYYY-MM-DDThh:mm:ss.sTZD

where,

     ss   = two digits of second &#40;00 through 59&#41;
     s    = one or more digits representing a decimal fraction of a second

The DateTime::Format::W3CDTF module seems to base parsing on the fixed length of the string 
to parse which makes it think valid datetimes such as &#34;1997-07-16T19:20:30.45+01:00&#34;, an 
example used on the W3CDTF page at

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/TR/NOTE-datetime">http://www.w3.org/TR/NOTE-datetime</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;25&nbsp;16:37:20&nbsp;2010</span>
    <span class="description">DROLSKY [...] cpan.org - Ticket #61623:  Merged into ticket #14179</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;25&nbsp;16:37:20&nbsp;2010</span>
    <span class="description">DROLSKY [...] cpan.org -  Merged into ticket #14179</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;16&nbsp;16:28:36&nbsp;2010</span>
    <span class="description">DROLSKY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m not really using this module. Would someone like to take it over?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;16&nbsp;16:28:37&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;16&nbsp;16:31:52&nbsp;2010</span>
    <span class="description">greg [...] evilfunhouse.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> TURNERA [...] cpan.org, gwilliams [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #14179] Module doesn&#39;t parse times that include fractions of a second </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 16 Oct 2010 16:31:38 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DateTime-Format-W3CDTF [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Gregory Williams &lt;greg [...] evilfunhouse.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Oct 16, 2010, at 4:28 PM, Dave Rolsky via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=14179">https://rt.cpan.org/Ticket/Display.html?id=14179</a></span> &gt;
&gt; 
&gt; I&#39;m not really using this module. Would someone like to take it over?
</div>
I&#39;ve got the code patched locally, and intend to release a new version to CPAN as soon as I can find some time to do so.

thanks,
.greg
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;16&nbsp;16:48:03&nbsp;2010</span>
    <span class="description">autarch [...] urth.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #14179] Module doesn&#39;t parse times that include fractions of a second </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 16 Oct 2010 15:47:54 -0500 &#40;CDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;greg [...] evilfunhouse.com via RT&#34; &lt;bug-DateTime-Format-W3CDTF [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dave Rolsky &lt;autarch [...] urth.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, 16 Oct 2010, greg@evilfunhouse.com via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       Queue: DateTime-Format-W3CDTF
&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=14179">https://rt.cpan.org/Ticket/Display.html?id=14179</a></span> &gt;
&gt;
&gt; On Oct 16, 2010, at 4:28 PM, Dave Rolsky via RT wrote:
&gt;
<div class="message-stanza open">&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=14179">https://rt.cpan.org/Ticket/Display.html?id=14179</a></span> &gt;
&gt;&gt;
&gt;&gt; I&#39;m not really using this module. Would someone like to take it over?
</div>&gt;
&gt; I&#39;ve got the code patched locally, and intend to release a new version to CPAN as soon as I can find some time to do so.
</div>
Ah, you already have maint status. I was just going through the bugs that 
show up for me in RT, and I forgot about this.


-dave

/*============================================================
<span class="clickylink"><a target="new" rel="nofollow" href="http://VegGuide.org">http://VegGuide.org</a></span>               <span class="clickylink"><a target="new" rel="nofollow" href="http://blog.urth.org">http://blog.urth.org</a></span>
Your guide to all that&#39;s veg      House Absolute&#40;ly Pointless&#41;
============================================================*/
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;31&nbsp;10:28:46&nbsp;2010</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached is an up-to-date patch against the trunk:

<span class="clickylink"><a target="new" rel="nofollow" href="https://perl-date-time.svn.sourceforge.net/svnroot/perl-date-time/modules/DateTime-Format-W3CDTF/trunk">https://perl-date-time.svn.sourceforge.net/svnroot/perl-date-time/modules/DateTime-Format-W3CDTF/trunk</a></span>
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> DateTime-Format-W3CDTF.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: t/02bugs.t
===================================================================
--- t/02bugs.t	&#40;revision 4459&#41;
+++ t/02bugs.t	&#40;working copy&#41;
@@ -1,7 +1,7 @@
 #!/usr/bin/perl -w
 
 # test bug 3766
-#	<span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/NoAuth/Bug.html?id=3766">http://rt.cpan.org/NoAuth/Bug.html?id=3766</a></span>
+#   <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/NoAuth/Bug.html?id=3766">http://rt.cpan.org/NoAuth/Bug.html?id=3766</a></span>
 #   returns undef when you pass it a DateTime object
 #   whose timezone has been explicitly set.
 
Index: t/01parse.t
===================================================================
--- t/01parse.t	&#40;revision 4459&#41;
+++ t/01parse.t	&#40;working copy&#41;
@@ -1,5 +1,5 @@
 #!/usr/bin/perl -w
-use Test::More tests =&gt; 17;
+use Test::More tests =&gt; 18;
 use strict;
 use vars qw&#40; $class &#41;;
 
@@ -17,6 +17,7 @@
     &#39;2005-03-10T20:14:34+09:30&#39; =&gt; &#39;2005-03-10T10:44:34&#39;,
     &#39;2000-06-12T14:12:33Z&#39;      =&gt; &#39;2000-06-12T14:12:33&#39;,
     &#39;1994-11-05T08:15:30-05:00&#39; =&gt; &#39;1994-11-05T13:15:30&#39;,
+    &#39;2004-07-01T15:00:13.17-05:00&#39; =&gt; &#39;2004-07-01T20:00:13&#39;,
 &#41;;
 
 while &#40;@tests&#41; {
Index: lib/DateTime/Format/W3CDTF.pm
===================================================================
--- lib/DateTime/Format/W3CDTF.pm	&#40;revision 4459&#41;
+++ lib/DateTime/Format/W3CDTF.pm	&#40;working copy&#41;
@@ -7,6 +7,7 @@
 $VERSION = &#39;0.05&#39;;
 
 use DateTime;
+use DateTime::TimeZone;
 
 sub new {
     my $class = shift;
@@ -14,80 +15,65 @@
     return bless {}, $class;
 }
 
-# key is string length
-my %valid_formats = &#40;
-    19 =&gt; {
-        params =&gt; [qw&#40; year month day hour minute second&#41;],
-        regex  =&gt; qr/^&#40;\d{4}&#41;-&#40;\d\d&#41;-&#40;\d\d&#41;T&#40;\d\d&#41;:&#40;\d\d&#41;:&#40;\d\d&#41;$/,
-        zero   =&gt; {},
-    },
-    16 =&gt; {
-        params =&gt; [qw&#40; year month day hour minute&#41;],
-        regex  =&gt; qr/^&#40;\d{4}&#41;-&#40;\d\d&#41;-&#40;\d\d&#41;T&#40;\d\d&#41;:&#40;\d\d&#41;$/,
-        zero   =&gt; { second =&gt; 0 },
-    },
-    10 =&gt; {
-        params =&gt; [qw&#40; year month day &#41;],
-        regex  =&gt; qr/^&#40;\d{4}&#41;-&#40;\d\d&#41;-&#40;\d\d&#41;$/,
-        zero   =&gt; { hour =&gt; 0, minute =&gt; 0, second =&gt; 0 },
-    },
-    7 =&gt; {
-        params =&gt; [qw&#40; year month &#41;],
-        regex  =&gt; qr/^&#40;\d{4}&#41;-&#40;\d\d&#41;$/,
-        zero   =&gt; { day =&gt; 1, hour =&gt; 0, minute =&gt; 0, second =&gt; 0 },
-    },
-    4 =&gt; {
-        params =&gt; [qw&#40; year &#41;],
-        regex  =&gt; qr/^&#40;\d\d\d\d&#41;$/,
-        zero =&gt; { month =&gt; 1, day =&gt; 1, hour =&gt; 0, minute =&gt; 0, second =&gt; 0 }
-    }
-&#41;;
-
 sub parse_datetime {
     my &#40; $self, $date &#41; = @_;
 
     # save for error messages
     my $original = $date;
 
+    my @fields = qw/ year month day hour minute second fraction time_zone /;
+    my @values = 
+        &#40; $date =~ /^&#40;\d\d\d\d&#41; # Year
+                     &#40;?:-&#40;\d\d&#41; # -Month
+                      &#40;?:-&#40;\d\d&#41; # -Day
+                       &#40;?:T
+                        &#40;\d\d&#41;:&#40;\d\d&#41; # Hour:Minute
+                        &#40;?:
+                           :&#40;\d\d&#41;     # :Second
+                           &#40;\.\d+&#41;?    # .Fractional_Second
+                        &#41;?
+                        &#40; Z          # UTC
+                        | [+-]\d\d:\d\d    # Hour:Minute TZ offset
+                          &#40;?::\d\d&#41;?       # :Second TZ offset
+                        &#41;?&#41;?&#41;?&#41;?$/x &#41;
+          or die &#34;Invalid W3CDTF datetime string &#40;$date&#41;&#34;;
     my %p;
-    if &#40; $date =~ s/&#40;[+-]\d\d:\d\d&#41;$// &#41; {
-        $p{time_zone} = $1;
+    for &#40; my $i=0; $i &lt; @values; $i++ &#41; {  # Oh how I wish Perl had zip
+        next unless defined $values[$i];
+        $p{$fields[$i]} = $values[$i];
     }
 
     # Z at end means UTC
-    elsif &#40; $date =~ s/Z$// &#41; {
+    if &#40; !$p{time_zone} &#41; {
+        $p{time_zone} = &#39;floating&#39;;
+    }
+    elsif &#40; $p{time_zone} eq &#39;Z&#39; &#41; {
         $p{time_zone} = &#39;UTC&#39;;
     }
-    else {
-        $p{time_zone} = &#39;floating&#39;;
+
+    if &#40; $p{fraction} &#41; {
+        $p{nanosecond} = $p{fraction} * 1_000_000_000;
+        delete $p{fraction}
     }
 
-    my $format = $valid_formats{ length $date }
-        or die &#34;Invalid W3CDTF datetime string &#40;$original&#41;&#34;;
-
-    @p{ @{ $format-&gt;{params} } } = $date =~ /$format-&gt;{regex}/;
-
-    return DateTime-&gt;new&#40; %p, %{ $format-&gt;{zero} } &#41;;
+    return DateTime-&gt;new&#40; %p &#41;;
 }
 
 sub format_datetime {
     my &#40; $self, $dt &#41; = @_;
 
-    # removed in 0.4 as it behaved improperly at midnight - kellan 2003/11/23
-    #my $base =
-    #    &#40; $dt-&gt;hour || $dt-&gt;min || $dt-&gt;sec ?
-    #      sprintf&#40; &#39;%04d-%02d-%02dT%02d:%02d:%02d&#39;,
-    #               $dt-&gt;year, $dt-&gt;month, $dt-&gt;day,
-    #               $dt-&gt;hour, $dt-&gt;minute, $dt-&gt;second &#41; :
-    #      sprintf&#40; &#39;%04d-%02d-%02d&#39;, $dt-&gt;year, $dt-&gt;month, $dt-&gt;day &#41;
-    #    &#41;;
-
     my $base = sprintf&#40;
         &#39;%04d-%02d-%02dT%02d:%02d:%02d&#39;,
         $dt-&gt;year, $dt-&gt;month,  $dt-&gt;day,
         $dt-&gt;hour, $dt-&gt;minute, $dt-&gt;second
     &#41;;
 
+    if &#40; $dt-&gt;nanosecond &#41; {
+        my $secs = sprintf &#34;%f&#34;, $dt-&gt;nanosecond / 1_000_000_000;
+        $secs =~ s/^0//;
+        $base .= $secs;
+    }
+
     my $tz = $dt-&gt;time_zone;
 
     return $base if $tz-&gt;is_floating;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;29&nbsp;17:01:06&nbsp;2012</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Oct 31 10:28:46 2010, SHLOMIF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Attached is an up-to-date patch against the trunk:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://perl-date-time.svn.sourceforge.net/svnroot/perl-date-">https://perl-date-time.svn.sourceforge.net/svnroot/perl-date-</a></span>
&gt; time/modules/DateTime-Format-W3CDTF/trunk
</div>
Can you please look into applying this patch?

Regards,

-- Shlomi Fish
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;29&nbsp;19:52:19&nbsp;2012</span>
    <span class="description">gwilliams [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Jul 29 17:01:06 2012, SHLOMIF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Can you please look into applying this patch?
</div>
I believe this was applied for version 0.06. However, it seems this ticket was never closed. Can 
you please confirm, and I&#39;ll close the ticket?

thanks,
.greg
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;29&nbsp;19:52:20&nbsp;2012</span>
    <span class="description">gwilliams [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
