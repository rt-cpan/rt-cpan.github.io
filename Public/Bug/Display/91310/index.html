<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #91310 for Net-SSLeay: heap-buffer-overflow with RSA_generate_key with valid callback and userdata</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #91310 for Net-SSLeay: heap-buffer-overflow with RSA_generate_key with valid callback and userdata</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-SSLeay/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SSLeay">Net-SSLeay CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">91310</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-SSLeay/Active/">Net-SSLeay</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">MIKEM [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
rurban [...] x-ray.at

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-44414-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.55    </td>
  </tr>
  <tr id="CF-44415-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;10&nbsp;16:33:29&nbsp;2013</span>
    <span class="description">rurban [...] x-ray.at -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> heap-buffer-overflow with RSA_generate_key with valid callback
 and userdata</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">perl5.19.6d-nt-asan &#40;address-sanitizer, DEBUGGING, not threaded&#41; reported the following heap-buffer-overflow

# Testing Net::SSLeay 1.55, Perl 5.019006, /usr/local/bin/perl5.19.6d-nt-asan
# OpenSSL version:  &#39;OpenSSL 1.0.1e 11 Feb 2013&#39;
# OpenSSL platform: &#39;platform: debian-amd64&#39;

t/local/31_rsa_generate_key.t .......... 1/14 
==7114==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x622000019688 at pc 0x7f56b1bde73a bp 0x7fff0f2fb2f0 sp 0x7fff0f2fb2e8
WRITE of size 8 at 0x622000019688 thread T0
    #0 0x7f56b1bde739 in ssleay_RSA_generate_key_cb_invoke /home/rurban/.cpan/build/Net-SSLeay-1.55-098c6e/SSLeay.xs:994
    #1 0x7f56b15dc7d6 in BN_GENCB_call ??:?
    #2 0x7f56b15dd1b0 in BN_generate_prime_ex ??:?
    #3 0x7f56b1605b59 in RSA_generate_key_ex ??:?
    #4 0x7f56b1608f15 in RSA_generate_key ??:?
    #5 0x7f56b1c55f3d in XS_Net__SSLeay_RSA_generate_key /home/rurban/.cpan/build/Net-SSLeay-1.55-098c6e/SSLeay.xs:4255
    #6 0x7f56b6297919 in Perl_pp_entersub /home/rurban/Perl/src/build-5.19.6d-nt-asan/pp_hot.c:2760
    #7 0x7f56b5fcf64b in Perl_runops_debug /home/rurban/Perl/src/build-5.19.6d-nt-asan/dump.c:2270
    #8 0x7f56b59dea00 in S_run_body /home/rurban/Perl/src/build-5.19.6d-nt-asan/perl.c:2428
    #9 0x7f56b59dab59 in perl_run /home/rurban/Perl/src/build-5.19.6d-nt-asan/perl.c:2349
    #10 0x42c2c7 in main /home/rurban/Perl/src/build-5.19.6d-nt-asan/perlmain.c:112
    #11 0x7f56b4860994 in __libc_start_main /home/aurel32/eglibc/eglibc-2.17/csu/libc-start.c:276
    #12 0x42bc6c in _start ??:?
0x622000019688 is located 0 bytes to the right of 5512-byte region [0x622000018100,0x622000019688&#41;
==7114==AddressSanitizer CHECK failed: /tmp/buildd/llvm-toolchain-3.3-3.3/projects/compiler-rt/lib/asan/asan_allocator2.cc:218 &#34;&#40;&#40;id&#41;&#41; != &#40;0&#41;&#34; &#40;0x0, 0x0&#41;
    #0 0x42301f in _ZN6__asanL15AsanCheckFailedEPKciS1_yy asan_rtl.o:?
    #1 0x4247f1 in _ZN11__sanitizer11CheckFailedEPKciS1_yy ??:?
    #2 0x40e5d1 in _ZN6__asan13AsanChunkView13GetAllocStackEPN11__sanitizer10StackTraceE ??:?
    #3 0x420286 in _ZN6__asan19DescribeHeapAddressEmm ??:?
    #4 0x4212f2 in __asan_report_error ??:?
    #5 0x422509 in __asan_report_store8 ??:?
    #6 0x7f56b1bde739 in ssleay_RSA_generate_key_cb_invoke /home/rurban/.cpan/build/Net-SSLeay-1.55-098c6e/SSLeay.xs:994
    #7 0x7f56b15dc7d6 in BN_GENCB_call ??:?
    #8 0x7f56b15dd1b0 in BN_generate_prime_ex ??:?
    #9 0x7f56b1605b59 in RSA_generate_key_ex ??:?
    #10 0x7f56b1608f15 in RSA_generate_key ??:?
    #11 0x7f56b1c55f3d in XS_Net__SSLeay_RSA_generate_key /home/rurban/.cpan/build/Net-SSLeay-1.55-098c6e/SSLeay.xs:4255
    #12 0x7f56b6297919 in Perl_pp_entersub /home/rurban/Perl/src/build-5.19.6d-nt-asan/pp_hot.c:2760
    #13 0x7f56b5fcf64b in Perl_runops_debug /home/rurban/Perl/src/build-5.19.6d-nt-asan/dump.c:2270
    #14 0x7f56b59dea00 in S_run_body /home/rurban/Perl/src/build-5.19.6d-nt-asan/perl.c:2428
    #15 0x7f56b59dab59 in perl_run /home/rurban/Perl/src/build-5.19.6d-nt-asan/perl.c:2349
    #16 0x42c2c7 in main /home/rurban/Perl/src/build-5.19.6d-nt-asan/perlmain.c:112
    #17 0x7f56b4860994 in __libc_start_main /home/aurel32/eglibc/eglibc-2.17/csu/libc-start.c:276
    #18 0x42bc6c in _start ??:?

Failed 2/14 subtests 

on test 13
RSA_generate_key with valid callback and userdata

The error is rarely reproducible.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;10&nbsp;20:57:33&nbsp;2013</span>
    <span class="description">MIKEM [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;10&nbsp;20:59:15&nbsp;2013</span>
    <span class="description">MIKEM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, 
hmmm can you confirm that on your test machine, 
/home/rurban/.cpan/build/Net-SSLeay-1.55-098c6e/SSLeay.xs:994
is this line:

        XPUSHs&#40;sv_2mortal&#40; newSViv&#40;i&#41; &#41;&#41;;

if not, exactly which line of code is it for you?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;10&nbsp;20:59:15&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;15&nbsp;16:57:31&nbsp;2013</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #91310] heap-buffer-overflow with RSA_generate_key with valid callback  and userdata</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 16 Dec 2013 07:57:18 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

did you see my earlier reply to your report? Nothing heard here.

Cheers.

On Tuesday, December 10, 2013 04:33:30 PM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Tue Dec 10 16:33:29 2013: Request 91310 was acted upon.
&gt; Transaction: Ticket created by rurban@x-ray.at
&gt;        Queue: Net-SSLeay
&gt;      Subject: heap-buffer-overflow with RSA_generate_key with valid callback
&gt; and userdata
&gt;    Broken in: 1.55
&gt;     Severity: &#40;no value&#41;
&gt;        Owner: Nobody
&gt;   Requestors: rurban@x-ray.at
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=91310">https://rt.cpan.org/Ticket/Display.html?id=91310</a></span> &gt;
&gt; 
&gt; 
&gt; perl5.19.6d-nt-asan &#40;address-sanitizer, DEBUGGING, not threaded&#41; reported
&gt; the following heap-buffer-overflow
&gt; 
&gt; # Testing Net::SSLeay 1.55, Perl 5.019006,
&gt; /usr/local/bin/perl5.19.6d-nt-asan # OpenSSL version:  &#39;OpenSSL 1.0.1e 11
&gt; Feb 2013&#39;
&gt; # OpenSSL platform: &#39;platform: debian-amd64&#39;
&gt; 
&gt; t/local/31_rsa_generate_key.t .......... 1/14
&gt; ==7114==ERROR: AddressSanitizer: heap-buffer-overflow on address
&gt; 0x622000019688 at pc 0x7f56b1bde73a bp 0x7fff0f2fb2f0 sp 0x7fff0f2fb2e8
&gt; WRITE of size 8 at 0x622000019688 thread T0
&gt;     #0 0x7f56b1bde739 in ssleay_RSA_generate_key_cb_invoke
&gt; /home/rurban/.cpan/build/Net-SSLeay-1.55-098c6e/SSLeay.xs:994 #1
&gt; 0x7f56b15dc7d6 in BN_GENCB_call ??:?
&gt;     #2 0x7f56b15dd1b0 in BN_generate_prime_ex ??:?
&gt;     #3 0x7f56b1605b59 in RSA_generate_key_ex ??:?
&gt;     #4 0x7f56b1608f15 in RSA_generate_key ??:?
&gt;     #5 0x7f56b1c55f3d in XS_Net__SSLeay_RSA_generate_key
&gt; /home/rurban/.cpan/build/Net-SSLeay-1.55-098c6e/SSLeay.xs:4255 #6
&gt; 0x7f56b6297919 in Perl_pp_entersub
&gt; /home/rurban/Perl/src/build-5.19.6d-nt-asan/pp_hot.c:2760 #7 0x7f56b5fcf64b
&gt; in Perl_runops_debug
&gt; /home/rurban/Perl/src/build-5.19.6d-nt-asan/dump.c:2270 #8 0x7f56b59dea00
&gt; in S_run_body /home/rurban/Perl/src/build-5.19.6d-nt-asan/perl.c:2428 #9
&gt; 0x7f56b59dab59 in perl_run
&gt; /home/rurban/Perl/src/build-5.19.6d-nt-asan/perl.c:2349 #10 0x42c2c7 in
&gt; main /home/rurban/Perl/src/build-5.19.6d-nt-asan/perlmain.c:112 #11
&gt; 0x7f56b4860994 in __libc_start_main
&gt; /home/aurel32/eglibc/eglibc-2.17/csu/libc-start.c:276 #12 0x42bc6c in
&gt; _start ??:?
&gt; 0x622000019688 is located 0 bytes to the right of 5512-byte region
&gt; [0x622000018100,0x622000019688&#41; ==7114==AddressSanitizer CHECK failed:
&gt; /tmp/buildd/llvm-toolchain-3.3-3.3/projects/compiler-rt/lib/asan/asan_alloc
&gt; ator2.cc:218 &#34;&#40;&#40;id&#41;&#41; != &#40;0&#41;&#34; &#40;0x0, 0x0&#41; #0 0x42301f in
&gt; _ZN6__asanL15AsanCheckFailedEPKciS1_yy asan_rtl.o:? #1 0x4247f1 in
&gt; _ZN11__sanitizer11CheckFailedEPKciS1_yy ??:?
&gt;     #2 0x40e5d1 in
&gt; _ZN6__asan13AsanChunkView13GetAllocStackEPN11__sanitizer10StackTraceE ??:?
&gt; #3 0x420286 in _ZN6__asan19DescribeHeapAddressEmm ??:?
&gt;     #4 0x4212f2 in __asan_report_error ??:?
&gt;     #5 0x422509 in __asan_report_store8 ??:?
&gt;     #6 0x7f56b1bde739 in ssleay_RSA_generate_key_cb_invoke
&gt; /home/rurban/.cpan/build/Net-SSLeay-1.55-098c6e/SSLeay.xs:994 #7
&gt; 0x7f56b15dc7d6 in BN_GENCB_call ??:?
&gt;     #8 0x7f56b15dd1b0 in BN_generate_prime_ex ??:?
&gt;     #9 0x7f56b1605b59 in RSA_generate_key_ex ??:?
&gt;     #10 0x7f56b1608f15 in RSA_generate_key ??:?
&gt;     #11 0x7f56b1c55f3d in XS_Net__SSLeay_RSA_generate_key
&gt; /home/rurban/.cpan/build/Net-SSLeay-1.55-098c6e/SSLeay.xs:4255 #12
&gt; 0x7f56b6297919 in Perl_pp_entersub
&gt; /home/rurban/Perl/src/build-5.19.6d-nt-asan/pp_hot.c:2760 #13
&gt; 0x7f56b5fcf64b in Perl_runops_debug
&gt; /home/rurban/Perl/src/build-5.19.6d-nt-asan/dump.c:2270 #14 0x7f56b59dea00
&gt; in S_run_body /home/rurban/Perl/src/build-5.19.6d-nt-asan/perl.c:2428 #15
&gt; 0x7f56b59dab59 in perl_run
&gt; /home/rurban/Perl/src/build-5.19.6d-nt-asan/perl.c:2349 #16 0x42c2c7 in
&gt; main /home/rurban/Perl/src/build-5.19.6d-nt-asan/perlmain.c:112 #17
&gt; 0x7f56b4860994 in __libc_start_main
&gt; /home/aurel32/eglibc/eglibc-2.17/csu/libc-start.c:276 #18 0x42bc6c in
&gt; _start ??:?
&gt; 
&gt; Failed 2/14 subtests
&gt; 
&gt; on test 13
&gt; RSA_generate_key with valid callback and userdata
&gt; 
&gt; The error is rarely reproducible.
</div>-- 
Mike McCauley           VK4AMM                   mikem@airspayce.com
Airspayce Pty Ltd 9 Bulbul Place Currumbin Waters QLD 4223 Australia   
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.airspayce.com">http://www.airspayce.com</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;15&nbsp;19:16:45&nbsp;2013</span>
    <span class="description">RURBAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 10 20:59:15 2013, MIKEM wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, 
&gt; hmmm can you confirm that on your test machine, 
&gt; /home/rurban/.cpan/build/Net-SSLeay-1.55-098c6e/SSLeay.xs:994
&gt; is this line:
&gt; 
&gt;         XPUSHs&#40;sv_2mortal&#40; newSViv&#40;i&#41; &#41;&#41;;
</div>
Yes, it&#39;s 1.55 pure.
It&#39;s obviously a wrong stack pointer. debugging it now...

-- 
Reini Urban
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;21&nbsp;17:42:00&nbsp;2013</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #91310] heap-buffer-overflow with RSA_generate_key with valid callback and userdata</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 22 Dec 2013 08:41:49 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Any luck?

On Sunday, December 15, 2013 07:16:46 PM Reini Urban via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=91310">https://rt.cpan.org/Ticket/Display.html?id=91310</a></span> &gt;
&gt; 
&gt; On Tue Dec 10 20:59:15 2013, MIKEM wrote:
<div class="message-stanza open">&gt; &gt; Hi,
&gt; &gt; hmmm can you confirm that on your test machine,
&gt; &gt; /home/rurban/.cpan/build/Net-SSLeay-1.55-098c6e/SSLeay.xs:994
&gt; &gt; 
&gt; &gt; is this line:
&gt; &gt;         XPUSHs&#40;sv_2mortal&#40; newSViv&#40;i&#41; &#41;&#41;;
</div>&gt; 
&gt; Yes, it&#39;s 1.55 pure.
&gt; It&#39;s obviously a wrong stack pointer. debugging it now...
</div>-- 
Mike McCauley           VK4AMM                   mikem@airspayce.com
Airspayce Pty Ltd 9 Bulbul Place Currumbin Waters QLD 4223 Australia   
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.airspayce.com">http://www.airspayce.com</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;30&nbsp;12:10:38&nbsp;2013</span>
    <span class="description">rurban [...] x-ray.at -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rurban [...] x-ray.at</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Dec 21 17:42:00 2013, mikem@airspayce.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Any luck?
</div>
I could reproduce SEGVs at test 7 and test 13 again with latest blead non-threaded.
This is for test 6:

$ gdb --args /usr/local/bin/perl5.19.8d-nt@91fc0422 -Mblib t/local/31_rsa_generate_key.t
GNU gdb &#40;GDB&#41; 7.6.1 &#40;Debian 7.6.1-1&#41;
/usr/local/bin/perl5.19.8d-nt@91fc0422...done.
&#40;gdb&#41; r
Starting program: /usr/local/bin/perl5.19.8d-nt@91fc0422 -Mblib t/local/31_rsa_generate_key.t
1..14
ok 1 - RSA_generate_key with valid callback
ok 2 - RSA_generate_key with invalid callback
ok 3 - RSA_generate_key callback is executed in void context
ok 4 - userdata will be undef if no userdata was given
ok 5 - first argument is defined
ok 6 - second argument is defined

Program received signal SIGSEGV, Segmentation fault.
0x000000000058f8b2 in Perl_pp_entersub &#40;&#41; at pp_hot.c:2689
2689                        if &#40;SvPADTMP&#40;*MARK&#41; &#38;&#38; !IS_PADGV&#40;*MARK&#41;&#41;
&#40;gdb&#41; bt
#0  0x000000000058f8b2 in Perl_pp_entersub &#40;&#41; at pp_hot.c:2689
#1  0x0000000000458e9e in Perl_call_sv &#40;sv=0xded890, flags=5&#41; at perl.c:2733
#2  0x00007ffff68784db in ssleay_RSA_generate_key_cb_invoke &#40;i=0, n=65, data=0xe37dc0&#41; at SSLeay.xs:1000
#3  0x00007ffff62b1327 in BN_GENCB_call &#40;&#41; from /usr/lib/x86_64-linux-gnu/libcrypto.so.1.0.0
#4  0x00007ffff62b1cf1 in BN_generate_prime_ex &#40;&#41; from /usr/lib/x86_64-linux-gnu/libcrypto.so.1.0.0
#5  0x00007ffff62da5b7 in RSA_generate_key_ex &#40;&#41; from /usr/lib/x86_64-linux-gnu/libcrypto.so.1.0.0
#6  0x00007ffff62ddaf6 in RSA_generate_key &#40;&#41; from /usr/lib/x86_64-linux-gnu/libcrypto.so.1.0.0
#7  0x00007ffff68a3d55 in XS_Net__SSLeay_RSA_generate_key &#40;cv=&lt;optimized out&gt;&#41; at SSLeay.xs:4255
#8  0x0000000000590091 in Perl_pp_entersub &#40;&#41; at pp_hot.c:2769
#9  0x00000000005312d3 in Perl_runops_debug &#40;&#41; at dump.c:2308
#10 0x0000000000457c84 in S_run_body &#40;oldscope=1&#41; at perl.c:2428
#11 0x00000000004572b0 in perl_run &#40;my_perl=0x9f1010&#41; at perl.c:2349
#12 0x000000000041cf32 in main &#40;argc=3, argv=0x7fffffffe678, env=0x7fffffffe698&#41; at perlmain.c:112

wrong mark stack:
&#40;gdb&#41; p *MARK
$2 = &#40;SV *&#41; 0xfff9ae1400000128
&#40;gdb&#41; p **MARK
Cannot access memory at address 0xfff9ae1400000128

&#40;gdb&#41; up
#1  0x0000000000458e9e in Perl_call_sv &#40;sv=0xded890, flags=5&#41; at perl.c:2733
2733            CALL_BODY_SUB&#40;&#40;OP*&#41;&#38;myop&#41;;
&#40;gdb&#41; p myop
$3 = {op_next = 0x0, op_sibling = 0x0, op_ppaddr = 0x0, op_targ = 0, op_type = 0, op_opt = 0, op_slabbed = 0, 
  op_savefree = 0, op_static = 0, op_folded = 0, op_spare = 0, op_flags = 65 &#39;A&#39;, op_private = 0 &#39;\000&#39;, op_first = 0x0, 
  op_other = 0x0}
&#40;gdb&#41; p Perl_sv_dump&#40;sv&#41;
SV = IV&#40;0xded880&#41; at 0xded890
  REFCNT = 2
  FLAGS = &#40;TEMP,ROK&#41;
  RV = 0xd47a90
    SV = PVCV&#40;0xdba708&#41; at 0xd47a90
      REFCNT = 4
      FLAGS = &#40;&#41;
      COMP_STASH = 0x9f2e30     &#34;main&#34;
      START = 0xc8ac60 ===&gt; 1
      ROOT = 0xd3e578
      GVGV::GV = 0xd47bc8       &#34;main&#34; :: &#34;cb&#34;
      FILE = &#34;t/local/31_rsa_generate_key.t&#34;
      DEPTH = 1
      FLAGS = 0x0
      OUTSIDE_SEQ = 2170
      PADLIST = 0xc8a6d0
        PADNAME = 0xd47a60&#40;0xc8a5f0&#41; PAD = 0xd47a78&#40;0xc8b7a0&#41;
             1. 0xd47a30&lt;1&gt; &#40;2170,2173&#41; &#34;$i&#34;
             2. 0xd47a00&lt;1&gt; &#40;2170,2173&#41; &#34;$n&#34;
             3. 0xd479d0&lt;1&gt; &#40;2170,2173&#41; &#34;$d&#34;
             6. 0xd47ca0&lt;2&gt; FAKE &#34;$called&#34; flags=0x0 index=11
      OUTSIDE = 0x9f3670 &#40;MAIN&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;30&nbsp;12:19:33&nbsp;2013</span>
    <span class="description">rurban [...] x-ray.at -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rurban [...] x-ray.at</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">and the args av is invalid like this:

&#40;gdb&#41; do
#0  0x000000000058f8b2 in Perl_pp_entersub &#40;&#41; at pp_hot.c:2689
2689                        if &#40;SvPADTMP&#40;*MARK&#41; &#38;&#38; !IS_PADGV&#40;*MARK&#41;&#41;
&#40;gdb&#41; l
2684            
2685                MARK = AvARRAY&#40;av&#41;;
2686                while &#40;items--&#41; {
2687                    if &#40;*MARK&#41;
2688                    {
2689                        if &#40;SvPADTMP&#40;*MARK&#41; &#38;&#38; !IS_PADGV&#40;*MARK&#41;&#41;
2690                            *MARK = sv_mortalcopy&#40;*MARK&#41;;
2691                        SvTEMP_off&#40;*MARK&#41;;
2692                    }
2693                    MARK++;
&#40;gdb&#41; p av
$11 = &#40;AV * const&#41; 0xd47820
&#40;gdb&#41; p *av
$12 = {sv_any = 0xd7e660, sv_refcnt = 3, sv_flags = 2147483659, sv_u = {
    svu_pv = 0xe1b930 &#34;\270&#34;, &lt;incomplete sequence \324&gt;, svu_iv = 14793008, svu_uv = 14793008, svu_rv = 0xe1b930, 
    svu_rx = 0xe1b930, svu_array = 0xe1b930, svu_hash = 0xe1b930, svu_gp = 0xe1b930, svu_fp = 0xe1b930}}
&#40;gdb&#41; p Perl_sv_dump&#40;av&#41;
SV = PVAV&#40;0xd7e660&#41; at 0xd47820
  REFCNT = 3
  FLAGS = &#40;&#41;
  ARRAY = 0xe1b930
  FILL = 2
  MAX = 2
  ARYLEN = 0x0
  FLAGS = &#40;REIFY&#41;
$13 = void
&#40;gdb&#41; p items
$14 = 1
&#40;gdb&#41; p mark
$15 = &#40;SV **&#41; 0xe1b938
&#40;gdb&#41; p Perl_sv_dump&#40;0xe1b930&#41;
SV = UNKNOWN&#40;0x14&#41; &#40;0xd476b8&#41; at 0xe1b930
  REFCNT = 296
  FLAGS = &#40;TEMP,OBJECT,GMG,SMG,RMG,NOK,POK,ROK,WEAKREF,OOK,FAKE,READONLY,IsCOW,BREAK,OVERLOAD,pNOK,PCS_IMPORTED,EVALED,UTF8&#41;
$16 = void
&#40;gdb&#41; p Perl_sv_dump&#40;0xe1b938&#41;
SV = NULL&#40;0xfff9ae1400000128&#41; at 0xe1b938
  REFCNT = 13924816
  FLAGS = &#40;&#41;
$17 = void
&#40;gdb&#41; p PAD_SVl&#40;0&#41;
$18 = &#40;SV *&#41; 0xd47820
&#40;gdb&#41; p Perl_sv_dump&#40;PAD_SVl&#40;0&#41;&#41;
SV = PVAV&#40;0xd7e660&#41; at 0xd47820
  REFCNT = 3
  FLAGS = &#40;&#41;
*** Error in `/usr/local/bin/perl5.19.8d-nt@91fc0422&#39;: free&#40;&#41;: invalid next size &#40;normal&#41;: 0x00000000009f5b80 ***
^C
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;30&nbsp;13:12:48&nbsp;2013</span>
    <span class="description">rurban [...] x-ray.at -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rurban [...] x-ray.at</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached patch fixes the problems.

You mixed up PUTBACK with SPAGAIN in ssleay_RSA_generate_key_cb_invoke&#40;&#41;
A final PUTBACK is needed here.

A second issue is also fixed:
cb-&gt;data defaults to &#38;PL_sv_undef but throught the code you do not check against &#38;PL_sv_undef, just NULL. To avoid passing the 3rd optional arg at all, do not create it. This fixes all the 
cb-&gt;data checks and wrong refcounts on &#38;PL_sv_undef.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Fix-91310-and-PL_sv_undef-cb-data-checks.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From c78d63e428d3041e2253c90cdd218c3865921a91 Mon Sep 17 00:00:00 2001
From: Reini Urban &lt;rurban@cpanel.net&gt;
Date: Mon, 30 Dec 2013 12:11:50 -0600
Subject: [PATCH] Fix #91310 and &#38;PL_sv_undef cb-&gt;data checks

You mixed up PUTBACK with SPAGAIN in ssleay_RSA_generate_key_cb_invoke&#40;&#41;
A final PUTBACK is needed here.

cb-&gt;data defaults to &#38;PL_sv_undef but throughout the code you do not check against
&#38;PL_sv_undef, just NULL. To avoid passing the 3rd optional arg at all, do not create it.
This fixes all the cb-&gt;data checks and wrong refcounts on &#38;PL_sv_undef.
---
 SSLeay.xs | 4 ++--
 1 file changed, 2 insertions&#40;+&#41;, 2 deletions&#40;-&#41;

diff --git a/SSLeay.xs b/SSLeay.xs
index fa51e22..2ed8508 100644
--- a/SSLeay.xs
+++ b/SSLeay.xs
@@ -424,7 +424,7 @@ simple_cb_data_t* simple_cb_data_new&#40;SV* func, SV* data&#41;
         SvREFCNT_inc&#40;func&#41;;
         SvREFCNT_inc&#40;data&#41;;
         cb-&gt;func = func;
-        cb-&gt;data = data;
+        cb-&gt;data = &#40;data == &#38;PL_sv_undef&#41; ? NULL : data;
     }
     return cb;
 }
@@ -955,7 +955,7 @@ void ssleay_RSA_generate_key_cb_invoke&#40;int i, int n, void* data&#41;
             croak &#40;&#34;Net::SSLeay: ssleay_RSA_generate_key_cb_invoke &#34;
                    &#34;perl function did return something in void context.\n&#34;&#41;;
 
-        PUTBACK;
+        SPAGAIN;
         FREETMPS;
         LEAVE;
     }
-- 
1.8.5.2

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;30&nbsp;14:50:39&nbsp;2013</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #91310] heap-buffer-overflow with RSA_generate_key with valid callback and userdata</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 31 Dec 2013 05:50:26 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Thanks for the patch.
It is now in SVN 390.

Cheers.

On Monday, December 30, 2013 01:12:49 PM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=91310">https://rt.cpan.org/Ticket/Display.html?id=91310</a></span> &gt;
&gt; 
&gt; Attached patch fixes the problems.
&gt; 
&gt; You mixed up PUTBACK with SPAGAIN in ssleay_RSA_generate_key_cb_invoke&#40;&#41;
&gt; A final PUTBACK is needed here.
&gt; 
&gt; A second issue is also fixed:
&gt; cb-&gt;data defaults to &#38;PL_sv_undef but throught the code you do not check
&gt; against &#38;PL_sv_undef, just NULL. To avoid passing the 3rd optional arg at
&gt; all, do not create it. This fixes all the cb-&gt;data checks and wrong
&gt; refcounts on &#38;PL_sv_undef.
</div>-- 
Mike McCauley           VK4AMM                   mikem@airspayce.com
Airspayce Pty Ltd 9 Bulbul Place Currumbin Waters QLD 4223 Australia   
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.airspayce.com">http://www.airspayce.com</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;24&nbsp;03:07:05&nbsp;2014</span>
    <span class="description">MIKEM [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
