<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #40047 for Text-CSV_XS: doc idea</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #40047 for Text-CSV_XS: doc idea</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Text-CSV_XS/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Text-CSV_XS/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Text-CSV_XS/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Text-CSV_XS/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Text-CSV_XS">Text-CSV_XS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">40047</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Text-CSV_XS/Active/">Text-CSV_XS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
me [...] evancarroll.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-31868-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-31869-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.54    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;14&nbsp;17:43:46&nbsp;2008</span>
    <span class="description">melazyboy [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> doc idea</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think that this is slightly deceptive
 my $csv = Text::CSV_XS-&gt;new &#40;{ binary =&gt; 1, eol =&gt; $/ }&#41;;
 open my $io, &#34;&lt;&#34;, $file or die &#34;$file: $!&#34;;
 while &#40;my $row = $csv-&gt;getline &#40;$io&#41;&#41; {
     my @fields = @$row;

Because sometimes minor errors, like 2023, 2034 which only render one
row void will cause the whole app to cease. And, that isn&#39;t especially
clear in the docs. It seems like -&gt;eof was created to give us something
useful to test against. It should be made clear in the docs, that if you
loop over testing for eof you can deal with errors, if you loop over
testing for errors you&#39;ll have to exclude EOF which is a type of error.
And, if you loop through as you do in the docs, testing for a row,
you&#39;ll finish on the *first* error or EOF which probably is never wanted.

I think something like this is more useful:

 my $fh = IO::File-&gt;new&#40;&#39;file.csv&#39;, &#39;r&#39;&#41;;
 while &#40; not $csv-&gt;eof &#41; {
   my $row = $csv-&gt;getline_hr&#40;$fh&#41;;
   if &#40; $csv-&gt;error_diag &#41; {
     last if $csv-&gt;eof; ## test again since last read.
     printf &#40; &#34;ErrorCode: [%s], Meaning: [%s]\n&#34;, $csv-&gt;error_diag &#41;;
     $csv-&gt;SetDiag&#40;0&#41;;
     next;
   }


Thanks again for Text::CSV_XS &#40;this just can give you some grief&#41;. I
think an alt route would be use a tied hash that evaluates to true in
scalar context and stores the meta data about the errors inside.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;15&nbsp;05:54:41&nbsp;2008</span>
    <span class="description">h.m.brand [...] xs4all.nl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #40047] doc idea</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 15 Oct 2008 11:54:14 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Text-CSV_XS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;H.Merijn Brand&#34; &lt;h.m.brand [...] xs4all.nl&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, 14 Oct 2008 17:43:51 -0400, &#34;Evan Carroll via RT&#34;
&lt;bug-Text-CSV_XS@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think that this is slightly deceptive
&gt;  my $csv = Text::CSV_XS-&gt;new &#40;{ binary =&gt; 1, eol =&gt; $/ }&#41;;
</div>
Hey, that line is from the previous example. Don&#39;t mix parsing and
generation. Parsing doesn&#39;t need eol &#40;though it is allowed&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  open my $io, &#34;&lt;&#34;, $file or die &#34;$file: $!&#34;;
&gt;  while &#40;my $row = $csv-&gt;getline &#40;$io&#41;&#41; {
&gt;      my @fields = @$row;
</div>
Maybe more &#39;generic&#39; than &#39;deceptive&#39;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Because sometimes minor errors, like 2023, 2034 which only render one
&gt; row void will cause the whole app to cease.
</div>
True. But remember that eof only works on streams. In this example, it
might be the better way to do, but not using your example.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; And, that isn&#39;t especially clear in the docs. It seems like -&gt;eof was
&gt; created to give us something useful to test against. It should be made
&gt; clear in the docs, that if you loop over testing for eof you can deal
&gt; with errors, if you loop over testing for errors you&#39;ll have to exclude
&gt; EOF which is a type of error.
</div>
Yes, agree, more or less.
If one expects getline &#40;&#41; to be true for parse success, eof *is* a
parse error. It also indicates the end-of-stream, which is a signal to
the parsing process that it is safe to stop.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; And, if you loop through as you do in the docs, testing for a row,
&gt; you&#39;ll finish on the *first* error or EOF which probably is never wanted.
&gt; 
&gt; I think something like this is more useful:
&gt; 
&gt;  my $fh = IO::File-&gt;new&#40;&#39;file.csv&#39;, &#39;r&#39;&#41;;
</div>
I&#39;m opposed to promoting other modules, like IO::File or IO::Handle
from within the documentation. Not that I have anything against them,
but IMHO the docs should restrict to Text::CSV_XS unless absolutely
needed to explain, like with autoloading IO::Handle

 while &#40;not $csv-&gt;eof&#41; {
     if &#40;my $row = $csv-&gt;getline_hr &#40;$fh&#41;&#41; {
         # do something useful
         }
     else {
         $csv-&gt;eof or $csv-&gt;error_diag;
         }
     }

You can&#39;t always continue after a parsing error. If a parse was broken,
the next parse is very likely to be broken too. SetDiag &#40;0&#41; is almost
always a bad idea, unless you specifically test for specific errors
that you expect.

  my $csv = Text::CSV_XS-&gt;new &#40;{ binary =&gt; 1, eol =&gt; $/ }&#41;;
  open my $io, &#34;&lt;&#34;, $file or die &#34;$file: $!&#34;;
  while &#40;my $row = $csv-&gt;getline &#40;$io&#41;&#41; {
      my @fields = @$row;
      # Do something with fields
      }
  $csv-&gt;eof or $csv-&gt;error_diag;

Would seem to me the ultimate clear extension to the documentation to
be a catch-all including your griefs. &#40;Now added, see below&#41;

So, if your CSV is allowed to have empty lines, and/or you expect
certain errors, your suggested approach is fine, but in the generic
case, I think that the false return of getline &#40;&#41; is enough reason to
stop parsing. parse-xs.pl has special rules for errors 2010, 2027,
2031, and 2032. If you have a good suggestion for 2023 and 2034, I will
consider adding those to parse-xs.pl example.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks again for Text::CSV_XS &#40;this just can give you some grief&#41;. I
&gt; think an alt route would be use a tied hash that evaluates to true in
&gt; scalar context and stores the meta data about the errors inside.
</div>
The alternate route is to fortify examples/parse-xs.pl, which uses this:

print STDERR &#34;Reading $file with Text::CSV_XS $Text::CSV_XS::VERSION\n&#34;;
while &#40;1&#41; {
    my $row = $csv-&gt;getline &#40;$fh&#41;;

    unless &#40;$row&#41; {     # Parsing failed

        # Could be end of file
        $csv-&gt;eof and last;

        # Diagnose and show what was wrong
        my @diag = $csv-&gt;error_diag;
        print STDERR &#34;$file line $./$diag[2] - $diag[0] - $diag[1]\n&#34;;

So, I&#39;ll have another look at a possible extension to the docs you
refer to, and point to parse-xs.pl for safe parsing with continuation
possibilities.

parse-xs.pl parses with *two* parsers in the same stream.

--8&lt;--- doc change
index a1081e7..e7f52d8 100644
--- a/CSV_XS.pm
+++ b/CSV_XS.pm
@@ -1244,11 +1244,12 @@ Reading a CSV file line by line:
   while &#40;my $row = $csv-&gt;getline &#40;$fh&#41;&#41; {
       # do something with @$row
       }
-  close $fh or die &#34;file.csv: $!&#34;;;
+  $csv-&gt;eof or $csv-&gt;error_diag;
+  close $fh or die &#34;file.csv: $!&#34;;

 For more extended examples, see the C&lt;examples/&gt; subdirectory in the
 original distribution. Included is C&lt;examples/parser-xs.pl&gt;, that could
-be used to `fix&#39; bad CSV
+be used to `fix&#39; bad CSV and parse beyond errors.

   perl examples/parser-xs.pl bad.csv &gt;good.csv

--&gt;8---

-- 
H.Merijn Brand          Amsterdam Perl Mongers  <span class="clickylink"><a target="new" rel="nofollow" href="http://amsterdam.pm.org/">http://amsterdam.pm.org/</a></span>
using &#38; porting perl 5.6.2, 5.8.x, 5.10.x, 5.11.x on HP-UX 10.20, 11.00,
11.11, 11.23, and 11.31, SuSE 10.1, 10.2, and 10.3, AIX 5.2, and Cygwin.
<span class="clickylink"><a target="new" rel="nofollow" href="http://mirrors.develooper.com/hpux/">http://mirrors.develooper.com/hpux/</a></span>           <span class="clickylink"><a target="new" rel="nofollow" href="http://www.test-smoke.org/">http://www.test-smoke.org/</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://qa.perl.org">http://qa.perl.org</a></span>      <span class="clickylink"><a target="new" rel="nofollow" href="http://www.goldmark.org/jeff/stupid-disclaimers/">http://www.goldmark.org/jeff/stupid-disclaimers/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;15&nbsp;05:54:47&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;15&nbsp;11:43:52&nbsp;2008</span>
    <span class="description">HMBRAND [...] cpan.org -  Severity Normal changed to Wishlist</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;15&nbsp;11:43:53&nbsp;2008</span>
    <span class="description">HMBRAND [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;08&nbsp;16:02:38&nbsp;2009</span>
    <span class="description">HMBRAND [...] cpan.org -  Fixed in 0.54 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;08&nbsp;16:02:38&nbsp;2009</span>
    <span class="description">HMBRAND [...] cpan.org -  Broken in 0.54 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
