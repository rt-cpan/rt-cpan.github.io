<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #83749 for Mail-Box-Parser-C: Long header lines parsed improperly</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #83749 for Mail-Box-Parser-C: Long header lines parsed improperly</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Mail-Box-Parser-C/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Mail-Box-Parser-C/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Mail-Box-Parser-C/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Mail-Box-Parser-C/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-Box-Parser-C">Mail-Box-Parser-C CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">83749</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Mail-Box-Parser-C/Active/">Mail-Box-Parser-C</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jik [...] kamens.brookline.ma.us

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-19882-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
3.006    </td>
  </tr>
  <tr id="CF-19883-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
3.007    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;04&nbsp;08:53:06&nbsp;2013</span>
    <span class="description">jik [...] kamens.brookline.ma.us -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Long header lines parsed improperly</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Header lines longer than 1023 characters cause Mail::Box::Parser::C to
parse the header improperly and corrupt the message.

Yes, I realize that nothing is supposed to generate header lines that
long, and yet, there are things that do, and &#34;Be generous in what you
accept&#34; dictates that this could should do its best to parse them
successfully.

The attached patch implements a dynamic buffer for reading message
lines, which is reallocated as needed to make enough space for the
longest line in the mailbox, and freed when the mailbox is freed.

I considered putting an upper limit on the line length to prevent memory
exhaustion DoS attacks against the application running the code, but I
decided not to because there is no length check on folded header lines
in the existing code, which means the DoS potential is already there.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Mail-Box-Parser-C-3.006-long-lines.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- C.xs.orig	2004-09-22 03:31:51.000000000 -0400
+++ C.xs	2013-03-04 08:41:08.083279924 -0500
@@ -12,8 +12,8 @@
 #define TRACE_NOTICES   2
 #define TRACE_DEBUG     1
 
-#ifndef MAX_LINE
-#define MAX_LINE        1024
+#ifndef DFLT_LINE
+#define DFLT_LINE        1024
 #endif
 
 #ifndef NULL
@@ -53,8 +53,9 @@
     int         strip_gt;
     int         keep_line;         /* unget line */
 
-    char        line[MAX_LINE+2];  /* one more for missing newline on *
-                                    * last line of file on Windows    */
+    char      * line;
+    int         line_buf_size;
+
     long        line_start;
 } Mailbox;
 
@@ -78,6 +79,9 @@
     New&#40;0, box-&gt;filename, strlen&#40;filename&#41;+1, char&#41;;
     strcpy&#40;box-&gt;filename, filename&#41;;
 
+    New&#40;0, box-&gt;line, DFLT_LINE, char&#41;;
+    box-&gt;line_buf_size = DFLT_LINE;
+
     return box;
 }
 
@@ -144,8 +148,24 @@
     }
 
     box-&gt;line_start = &#40;long&#41;ftell&#40;box-&gt;file&#41;;
-    if&#40;!fgets&#40;box-&gt;line, MAX_LINE, box-&gt;file&#41;&#41;
-        return NULL;
+
+    int already_read = 0;
+    while &#40;fgets&#40;box-&gt;line + already_read, box-&gt;line_buf_size - already_read,
+		 box-&gt;file&#41;&#41;
+      {
+	int len = strlen&#40;box-&gt;line&#41;;
+	already_read += len;
+	if &#40;len == box-&gt;line_buf_size - 1 &#38;&#38; box-&gt;line[len-1] != &#39;\n&#39;&#41; {
+	  int new_size = box-&gt;line_buf_size * 2;
+	  Renew&#40;box-&gt;line, new_size, char&#41;;
+	  box-&gt;line_buf_size = new_size;
+	  continue;
+	}
+	break;
+      }
+
+    if &#40;! already_read&#41;
+      return NULL;
 
     if&#40;box-&gt;dosmode&#41;
     {   int len = strlen&#40;box-&gt;line&#41;;
@@ -640,6 +660,7 @@
     }
 
     Safefree&#40;box-&gt;filename&#41;;
+    Safefree&#40;box-&gt;line&#41;;
     Safefree&#40;box&#41;;
 
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;04&nbsp;09:18:56&nbsp;2013</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83749] Long header lines parsed improperly</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 4 Mar 2013 15:18:29 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jonathan Kamens via RT &lt;bug-Mail-Box-Parser-C [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Jonathan Kamens via RT &#40;bug-Mail-Box-Parser-C@rt.cpan.org&#41; [130304 13:53]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Mon Mar 04 08:53:06 2013: Request 83749 was acted upon.
&gt; Transaction: Ticket created by JIK
&gt;        Queue: Mail-Box-Parser-C
&gt;      Subject: Long header lines parsed improperly
&gt;    Broken in: 3.006
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=83749">https://rt.cpan.org/Ticket/Display.html?id=83749</a></span> &gt;
&gt; 
&gt; 
&gt; Header lines longer than 1023 characters cause Mail::Box::Parser::C to
&gt; parse the header improperly and corrupt the message.
</div>
The latest email spec, RFC5322 section 2.1.1 says:

     There are two limits that this specification places on the number of
     characters in a line.  Each line of characters MUST be no more than
     998 characters, and SHOULD be no more than 78 characters, excluding
     the CRLF.

   The 998 character limit is due to limitations in many implementations
   that send, receive, or store IMF messages which simply cannot handle
   more than 998 characters on a line.  Receiving implementations would
   do well to handle an arbitrarily large number of characters in a line
   for robustness sake.  However, there are so many implementations that
   &#40;in compliance with the transport requirements of [RFC5321]&#41; do not
   accept messages containing more than 1000 characters including the CR
   and LF per line, it is important for implementations not to create
   such messages.

So it partially agrees with you: &#34;robustness&#34;.  On the other hand,
it complicates the code significantly.

I will increase the max header line length to 4094.
&#40;I did not expect people still use the C parser version ;-&#41;
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;04&nbsp;09:18:57&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;04&nbsp;09:28:03&nbsp;2013</span>
    <span class="description">jik [...] kamens.us -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83749] Long header lines parsed improperly</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 4 Mar 2013 09:27:48 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-Box-Parser-C [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jonathan Kamens &lt;jik [...] kamens.us&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am not sure I agree that my change complicates the code &#34;significantly&#34;, and I don&#39;t really see the virtue in replacing one unnecessarily hard-coded constant with another, especially since the RFC recommends being able to handle arbitrarily long lines and I&#39;ve given you a patch that does just that.

I will, however, concede that I&#39;ve seen far fewer messages with lines longer than 4094 characters than 1022, so if all you&#39;re willing to do is increase the constant, that&#39;s better than doing nothing.

  Jik

Sent from my Android device
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;04&nbsp;09:35:29&nbsp;2013</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83749] Long header lines parsed improperly</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 4 Mar 2013 15:35:07 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jonathan Kamens via RT &lt;bug-Mail-Box-Parser-C [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Jonathan Kamens via RT &#40;bug-Mail-Box-Parser-C@rt.cpan.org&#41; [130304 14:28]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I will, however, concede that I&#39;ve seen far fewer messages with lines
&gt; longer than 4094 characters than 1022, so if all you&#39;re willing to do
&gt; is increase the constant, that&#39;s better than doing nothing.
</div>
What kind of broken application does produce header lines of more than
two screen-pages?  I cannot imagin that this is a valid use of MIME
in the first place.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;04&nbsp;10:10:13&nbsp;2013</span>
    <span class="description">jik [...] kamens.us -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83749] Long header lines parsed improperly</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 04 Mar 2013 10:09:53 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-Box-Parser-C [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jonathan Kamens &lt;jik [...] kamens.us&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 03/04/2013 09:35 AM, Mark Overmeer via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What kind of broken application does produce header lines of more than 
&gt; two screen-pages? I cannot imagin that this is a valid use of MIME in 
&gt; the first place. 
</div>Mark, you&#39;ve been doing Internet standards programming long enough to 
know that&#39;s a silly question. :-&#41; Trying to anticipate all the stupid 
things that other programmers will do that violate standards is an 
exercise in futility.

Having said that, the most common case I see of this problem is spam 
messages. While you could argue that correctly parsing spam messages is 
not terribly important, I would counter that my spam filters are 
hampered in their work if they can&#39;t parse messages properly.

Another point I want to bring up... Does the Perl parser handle 
arbitrarily long header lines. If so, it seems difficult to justify 
preserving different, incorrect behavior in the C parser for the sake of 
saving a few lines of code.

I did a scan of the messages in my IMAP folders on my server &#40;only 
legitimate emails I&#39;ve saved, not spam&#41; and found two legitimate 
messages with long header lines. One of them was a DKIM-Signature line 
in a message from att.net, and the other was an X-Brightmail-Tracker 
line generated by convio.net. So it&#39;s not just the small guys who are 
doing stupid things with headers.

   jik
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;04&nbsp;10:37:05&nbsp;2013</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83749] Long header lines parsed improperly</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 4 Mar 2013 16:36:36 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jonathan Kamens via RT &lt;bug-Mail-Box-Parser-C [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Jonathan Kamens via RT &#40;bug-Mail-Box-Parser-C@rt.cpan.org&#41; [130304 15:10]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Mail-Box-Parser-C
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=83749">https://rt.cpan.org/Ticket/Display.html?id=83749</a></span> &gt;
&gt; 
&gt; Another point I want to bring up... Does the Perl parser handle 
&gt; arbitrarily long header lines. If so, it seems difficult to justify 
&gt; preserving different, incorrect behavior in the C parser for the sake of 
&gt; saving a few lines of code.
</div>
This is a convincing argument.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I did a scan of the messages in my IMAP folders on my server &#40;only 
&gt; legitimate emails I&#39;ve saved, not spam&#41; and found two legitimate 
&gt; messages with long header lines. One of them was a DKIM-Signature line 
&gt; in a message from att.net, and the other was an X-Brightmail-Tracker 
&gt; line generated by convio.net. So it&#39;s not just the small guys who are 
&gt; doing stupid things with headers.
</div>
Hum... in stupidity, size doesn&#39;t matter ;-&#41;
Those lines are larger than 4k???  Or larger than 1k?

What about this:

    int already_read = 0;
    while&#40;fgets&#40;box-&gt;line + already_read, box-&gt;line_buf_size - already_read,
                box-&gt;file&#41;&#41;
    {   int len = strlen&#40;box-&gt;line&#41;;
        already_read += len;

        if&#40;len &lt; box-&gt;line_buf_size-1 || box-&gt;line[len-1]==&#39;\n&#39;&#41;
            break;

        /* Extend header line buffer to contain more than DFLT_SIZE
         * chars.  Rfc5322 restricts size to 998 octets, but larger
         * headers are encountered in the wild.
         */
        box-&gt;line_buf_size *= 2;
        Renew&#40;box-&gt;line, box-&gt;line_buf_size, char&#41;;
    }


-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
drs Mark A.C.J. Overmeer                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;04&nbsp;10:47:02&nbsp;2013</span>
    <span class="description">jik [...] kamens.us -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83749] Long header lines parsed improperly</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 04 Mar 2013 10:46:48 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-Box-Parser-C [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jonathan Kamens &lt;jik [...] kamens.us&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 03/04/2013 10:37 AM, Mark Overmeer via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hum... in stupidity, size doesn&#39;t matter ;-&#41;
&gt; Those lines are larger than 4k???  Or larger than 1k?
</div>Larger than 1k, not 4k. I did not find any larger than 4k. But for the 
DKIM-Signature line, at least, it could theoretically be, since its 
length is dependent on the headers that are signed, and an email message 
could have an arbitrary number of signed headers.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What about this:
</div>I think that looks fine. Thanks.

   jik
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;04&nbsp;10:50:16&nbsp;2013</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83749] Long header lines parsed improperly</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 4 Mar 2013 16:50:02 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jonathan Kamens via RT &lt;bug-Mail-Box-Parser-C [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* MARKOV Solutions &#40;solutions@overmeer.net&#41; [130304 16:36]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     int already_read = 0;
&gt;     while&#40;fgets&#40;box-&gt;line + already_read, box-&gt;line_buf_size - already_read,
&gt;                 box-&gt;file&#41;&#41;
&gt;     {   int len = strlen&#40;box-&gt;line&#41;;
&gt;         already_read += len;
</div>
Shouldn&#39;t that be
          already_read = len;

I think the loop is flawed.
This is probably better:

    box-&gt;line_start = &#40;long&#41;ftell&#40;box-&gt;file&#41;;
    int bufsize     = box-&gt;line_buf_size;
    int bytes       = 0;

    while&#40;1&#41;
    {   fgets&#40;box-&gt;line + bytes, bufsize - bytes, box-&gt;file&#41;
           or break;

        bytes = strlen&#40;box-&gt;line&#41;;
        if&#40;bytes &lt; bufsize-1 || box-&gt;line[bufsize-1]==&#39;\n&#39;&#41;
            break;

        /* Extend header line buffer to contain more than DFLT_SIZE
         * chars.  Rfc5322 restricts size to 998 octets, but larger
         * headers are encountered in the wild.
         */
        bufsize = box-&gt;line_buf_size *= 2;
        Renew&#40;box-&gt;line, bufsize, char&#41;;
    }

    if&#40;!bytes&#41;
        return NULL;


-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
drs Mark A.C.J. Overmeer                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;04&nbsp;10:53:19&nbsp;2013</span>
    <span class="description">jik [...] kamens.us -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83749] Long header lines parsed improperly</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 04 Mar 2013 10:53:03 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-Box-Parser-C [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jonathan Kamens &lt;jik [...] kamens.us&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yes, that&#39;s right, sorry.

   jik
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;04&nbsp;16:41:22&nbsp;2013</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83749] Long header lines parsed improperly</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 4 Mar 2013 22:41:05 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jonathan Kamens via RT &lt;bug-Mail-Box-Parser-C [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Jonathan Kamens via RT &#40;bug-Mail-Box-Parser-C@rt.cpan.org&#41; [130304 13:53]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Mon Mar 04 08:53:06 2013: Request 83749 was acted upon.
&gt; Transaction: Ticket created by JIK
&gt;        Queue: Mail-Box-Parser-C
&gt;      Subject: Long header lines parsed improperly
&gt;    Broken in: 3.006
</div>
released as 3.007
Hopefully I did not introduce other bugs.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;17&nbsp;03:36:23&nbsp;2015</span>
    <span class="description">MARKOV [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;17&nbsp;03:36:29&nbsp;2015</span>
    <span class="description">MARKOV [...] cpan.org -  Fixed in 3.007 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
