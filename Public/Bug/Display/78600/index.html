<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #78600 for Win32API-File: refactoring Win32API-File&#39;s XS code</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #78600 for Win32API-File: refactoring Win32API-File&#39;s XS code</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Win32API-File/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Win32API-File/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Win32API-File/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Win32API-File/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Win32API-File">Win32API-File CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">78600</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Win32API-File/Active/">Win32API-File</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
BULKDD [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-35826-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.1200    </td>
  </tr>
  <tr id="CF-35827-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;26&nbsp;19:35:03&nbsp;2012</span>
    <span class="description">BULKDD [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> refactoring Win32API-File&#39;s XS code</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I see numerous problems in the XS code of Win32API::File. Does anyone
have objections to me refactoring the XS code in Win32API::File? I dont
plan do any changes in ::File&#39;s public API and very minor changes in
::File&#39;s internal API.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;30&nbsp;15:21:47&nbsp;2012</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">::File uses a tremendous amount of macros and uses Perl_get_context&#40;&#41; 
Try running it through the C preprocessor and then through a code
formatter, and it will go 2-3 pages off to the left. Under -O1 with VS
2003 32 bit code, I got a 49 KB DLL with Perl 5.17.2. My ActivePerl 5.10
32 bits stock ::File DLL is 85 KB. Two &#40;A and W variants&#41; XS functions
were ~0x9D0 bytes long each of machine code on my Perl 5.17.2, nearly a
whole page. A C compiler can not optimize away ST&#40;X&#41; between function
calls, how can the C compiler know the Perl stack slot &#40;SV **&#41; or
my_perl-&gt;base_of_stack didn&#39;t change between function calls? A macro is
always equal to its full expansion, and I dont think any compiler will
automatically function call a macro &#40;maybe GCC will with a C89/C99
breaking -O level, IDK, VC absolutely wont&#41;.

I am around 60% done in my cleanup as of today. The ::File DLL is
currently at 21 KB &#40;at 60% done&#41;. I have decided to move the macros into
function calls, AKA typemap helpers. Each typemap helper is a static of
course, and does not call any other functions in ::File DLL. Each
typemap helper, in the ideal branch taken,  makes no function calls to
the perl interp, or 2nd best branch, 1 function call &#40;2uv, 2iv, av_len,
etc&#41;. The macros inside of each typemap helper were not split off into
their own calls so the compiler can optimize by merging all the
different flag and SV type checks and reordering them in the SV head
together &#40;checked by looking at the disassembly code&#41;. There was also a
checking of return of SvPV_nolen for a null PV check that was
questionable &#40;with 2 2pv&#40;&#41; calls as a result of the SvPV_nolen macro
being used twice&#41;.

Another optimization is, saving the SV *s on the C stack/to a register.
rather than writing ST&#40;X&#41; multiple times in the CODE: section. The old
::File often uses INPUT: and OUTPUT: section initializers that override
the typemap. In this case, I will use the C stack SV * rather than the
ST&#40;X&#41;. The ST&#40;X&#41; for $arg in the OUTPUT: boilerplate code &#40;not typemap
override initializer&#41;, and when using the native typemap code, I have no
control over it.

To save the SV *s on the C stack, I have some design difficulty, I
thought of 4 ways to do it, case 4 is my preferred. I will assume that
the croak parameter names, and their C hungarion prefixes, must stay the
same, the croak parameter names are determined from the INPUT/XSUB
prototype names. If someone thinks that the parameter names can change
and loose their C side hungarian prefixes, tell me and I will do that. 

case 1:
If the INPUT: section, for example, is changed

        DWORD   uShare

to
        SV *    uShare

So that in a usage croak, it still tells the user that Share is an
unsigned integer, what will the real C auto DWORD var be called?
_uShare? real_uShare? uuShare? 

case 2:
        DWORD   uShare

to
        SV *    svShare
or
        SV *    Share

Now the usage croak doesn&#39;t say what Share is, just a confusing &#34;sv&#34;
prefix. DWORD uShare is now in a PREINIT: section.

case 3:
Use &#40;...&#41;, write usage croak check against items by hand &#40;copy paste
from File.c&#41; and process all in parameters by hand in C &#40;copy paste from
File.c&#41;, not using XS&#39;s typemap system.  I dislike this approach, since
I am trying to keep XS sub definition changes to a minimum to reduce the
number of bugs. Also increased maintenance difficulty in the future.
 
case 4:
This is what I hacked together which solves the usage croak parameter
name problem, I need to clear this with p5p/ParseXS&#39;s authors to make
sure that this will remain forwards compatible indefinitely somehow.

This is the typemap definition, it will save the SV * on the C stack and
allows the C var to be the usage croak parameter.

T_UV
    &#34;.&#40;unshift&#40;$ExtUtils::ParseXS::VERSION &gt;= 3.01 ? $self-&gt;{line} :
@{eval&#40;&#39;\@line&#39;&#41;}, &#40;
    &#39;PREINIT:&#39;,
    &#39;    SV * sv&#39;.$var.&#39;;&#39;,
    &#39;INPUT:&#39;&#41;&#41;,&#39;&#39;&#41;.
    &#34;{sv${\$var} = $arg;
    $var= INT2PTR&#40;$type, IntIn&#40;aTHX_ sv${\$var}, 1&#41;.uv&#41;;}

It works fine at the moment &#40;the SV is called &#34;svuShare&#34;, slightly
awkward, but it makes sense, SV and a unsigned int&#41;, but as you see, it
is using undocumented data of ParseXS and it subject to breakage, the
commit responsible was
<span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/commit/879310359dd0a26e227299023420b4cc6501f6b0">http://perl5.git.perl.org/perl.git/commit/879310359dd0a26e227299023420b4cc6501f6b0</a></span>
which is part of a large series of commit in 2011 to cleanup of ParseXS
to be OOP instead of functions with globals. Worst case, the PREINIT
sections are written by hand in every XSUB to declare the SV * autos,
but then the XSUBs change which is something I am trying to keep the a
minimum as I said before.

In some places, ::File declared a return type just for the C RETVAL, but
never used it in the OUTPUT section and instead did a XS_RETURN* with
the RETVAL, that was fixed to be a void CODE: and a PREINIT: RETVAL. If
the XS_RETURN line is ever removed, a freed scalar will appear as the
return value in Perl language and subsequent bizarre copy panic/crash.
&#34;ST&#40;0&#41; = sv_newmortal&#40;&#41;;&#34; is not placed by XSPP if RETVAL isn&#39;t in OUTPUT:.

I also will also research if its possible to merge some of the A and W
calls into ALIAS XSUBs with no Perl language side, side effects.

I currently have my code as a fork of
<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/chorny/Win32API-File">http://github.com/chorny/Win32API-File</a></span> . Is this correct? I plan to put
all the changes into 1 git patch. Do you want the patch as a git patch
against github or a git patch against perl interp blead or something
else? do you want a 60% done patch just for review and comments right
now, or a 60% done patch to apply to some git rep? Any other comments?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;30&nbsp;15:21:49&nbsp;2012</span>
    <span class="description">BULKDD [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;31&nbsp;13:46:12&nbsp;2012</span>
    <span class="description">tyemq [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for providing detailed information so an informed reply is possible.

The numerous problems appear to mostly boil down to optimization of the
resulting machine code.  Most of these changes sound reasonable.

The macros were likely slightly easier to reuse in other modules but the
cost there is surely very minor.  So changing to functions sounds
worthwhile, especially since some improvements in correctness are likely
also included.

In general, I am not against optimizations but am very wary about
adopting optimizations that decrease code clarity and will usually just
reject optimizations that decrease correctness.

In this particular case, Win32API::File is a thunk layer between a
full-sized interpreter and calls that mostly deal with file systems &#40;and
not the most commonly used calls&#41;.  So there is relatively little real
benefit to optimizing the flea so it doesn&#39;t weigh down the dog,
especially when this flea is usually used only a relatively few times
and mostly only when the dog needs to wait for something relatively slow.

So I&#39;m most appreciative of any improvements to correctness that you
offer.  Please be careful to not become too focused on efficiency and
end up reducing correctness &#40;it doesn&#39;t sound like you have&#41;.

On Mon Jul 30 15:21:47 2012, BULKDD wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; To save the SV *s on the C stack, I have some design difficulty
</div>
All of your proposed approaches to this particular aspect appear to pose
significant problems to code clarity.  I think these optimizations
clearly fail to justify such a cost.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; T_UV
&gt;     &#34;.&#40;unshift&#40;$ExtUtils::ParseXS::VERSION &gt;= 3.01 ? $self-&gt;{line} :
&gt; @{eval&#40;&#39;\@line&#39;&#41;}, &#40;
&gt;     &#39;PREINIT:&#39;,
&gt;     &#39;    SV * sv&#39;.$var.&#39;;&#39;,
&gt;     &#39;INPUT:&#39;&#41;&#41;,&#39;&#39;&#41;.
&gt;     &#34;{sv${\$var} = $arg;
&gt;     $var= INT2PTR&#40;$type, IntIn&#40;aTHX_ sv${\$var}, 1&#41;.uv&#41;;}
</div>
I don&#39;t really care how ugly or bloated the machine code ends up
compared to making the code the human must read bloated and ugly.  The
uncertainty of the long-term validity of the approach makes it even less
desirable.

Perhaps you can work on changes to the XS pre-parser to make it simple
to override the usage message without such complexity.

Perhaps a 5th approach would be to just append &#34;...&#34; to the list of
svBlah arguments &#40;if XS supports such, I haven&#39;t dived into such details
recently&#41; so code readability is only slightly reduced while allowing
argument parsing to pull out each SV* for you while also allowing a
custom usage message to preserve the current information.

I quite often use several of these routines interactively for ad-hoc
things where I will call one with no arguments to see how I need to use
it.  So I want the usage message to continue to be enough to convey how
to call the method correctly.

I don&#39;t find the cost of a few C array look-ups per file system access
to be enough to justify more than the most trivial in reductions of code
readability, if that.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I also will also research if its possible to merge some of the A and W
&gt; calls into ALIAS XSUBs with no Perl language side, side effects.
</div>
I&#39;m not sure what you are describing there.  I see value if having raw
access to the A and W calls separately, even if there is some kind of
smart wrapper that gives the power of the W calls in a relatively modern
Perl.  I have versions of such wrappers in versions of the module code
that I have not brought to a point of release, so such is desired, just
not at the expense of raw access.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I currently have my code as a fork of
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/chorny/Win32API-File">http://github.com/chorny/Win32API-File</a></span> . Is this correct?
</div>
Yes.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I plan to put
&gt; all the changes into 1 git patch.
</div>
You mean a single commit?  It would be more useful as a collection of
commits, breaking the work into cohesive chunks of work, especially
since some changes may be immediately accepted and others might not.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Do you want the patch as a git patch
&gt; against github or a git patch against perl interp blead or something
&gt; else?
</div>
A pull request on github would be most useful because you don&#39;t have to
generate patches and I &#40;or chorny&#41; don&#39;t need to convert the patch into
commits.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; do you want a 60% done patch just for review and comments right now
</div>
Sure.  That&#39;d be useful.

Thanks,
Tye
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;04&nbsp;14:32:15&nbsp;2012</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jul 31 13:46:12 2012, TYEMQ wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; do you want a 60% done patch just for review and comments right now
</div>&gt; 
&gt; Sure.  That&#39;d be useful.
&gt; 
&gt; Thanks,
&gt; Tye
</div>
This is my preliminary patch, its broken, dont apply it. I will delete
the commit and repush it when I fix it. I have a feeling there is a bug
in NumOut on x64 when in the caller it casts a DWORD * as a un/signed
__int64 * &#40;64 bit  UV/IV&#41; without 32 to 64 bit promotion with sign
honoring as an argument before passing it to NumOut. The fix will
probably be &#40;psuedocode&#41; &#34;sizeof&#40;$type&#41; == 8 ? NUMOUT_SZ8B :
sizeof&#40;$type&#41; == 4 ? NUMOUT_SZ4B : croak&#40;&#34;impossible&#34;&#41; |
NUMOUT_OTHERFLAGS&#34; which will constant fold away unless its an assert
fail, with I32 and U32 union members added somewhere.

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/bulk88/Win32API-File/commit/af1fc142d311cc3cd36e91b39fa81776cb5b66b2">https://github.com/bulk88/Win32API-File/commit/af1fc142d311cc3cd36e91b39fa81776cb5b66b2</a></span>

Also DeviceIoControl&#39;s fixes were scrapped because they were too
radically different and too large &#40;maintainability as you call it&#41; &#40;I
converted it to a PPCODE and manually updating all @_ SV&#41;. I will try
something with less patch lines on DeviceIoControl eventually.

Comments?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;04&nbsp;14:46:49&nbsp;2012</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Even with the promotion bug, it passes all its tests on x64 &#40;probably a
bad thing, not enough testing&#41;. The existing test files do not test
every last ::File XSUB. I can&#39;t write tests for all the XSUBs due to
time reasons, and some of the XSUBs can be quite dangerous
&#40;DeviceIoControl for example&#41;. But any tests I write for my own testing
or my own curiosity I will publish. I already made 1 XSUB test in the
1st commit.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;04&nbsp;15:07:55&nbsp;2012</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jul 31 13:46:12 2012, TYEMQ wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I also will also research if its possible to merge some of the A and W
&gt; &gt; calls into ALIAS XSUBs with no Perl language side, side effects.
</div>&gt; 
&gt; I&#39;m not sure what you are describing there.  I see value if having raw
&gt; access to the A and W calls separately, even if there is some kind of
&gt; smart wrapper that gives the power of the W calls in a relatively modern
&gt; Perl.  I have versions of such wrappers in versions of the module code
&gt; that I have not brought to a point of release, so such is desired, just
&gt; not at the expense of raw access.
</div>The XSUBs for the A and W calls are exactly the same number of machine
code bytes on ASM level and are identical on C and XS levels except for
the function call/macro names &#40;typemap helpers and the final call to
kernel32&#41;. The only difference is a * 1 &#40;CHAR&#41; or a * 2 &#40;WCHAR&#41; in
argument processing/buffer growing, to convert from bytes to characters
and back. ::File does not do automatic UTF16 conversion for W functions.
I dont plan to add that. There is also the problem of massive API
breakage for existing people who already pass encoded UTF16 strings to
::File, so if automatic utf16 conversion from Perl UTF8 SVs or Perl ANSI
SVs is added, it can&#39;t break existing PMs that use ::File internally and
Encode themselves but the caller or another PM in the perl process does
want to use AutoWide. That would have to be solved before any kind of
AutoWide is introduced.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
