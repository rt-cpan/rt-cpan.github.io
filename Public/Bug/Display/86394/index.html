<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #86394 for Module-Runtime: use_package_optimistically fails to report a failure in the module itself to load a different module</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #86394 for Module-Runtime: use_package_optimistically fails to report a failure in the module itself to load a different module</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Module-Runtime">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Module-Runtime">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Module-Runtime">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Module-Runtime">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Module-Runtime">Module-Runtime CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">86394</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Module-Runtime">Module-Runtime</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
DOY [...] cpan.org

<br />
ether [...] cpan.org

<br />
haarg [...] haarg.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
NNUTTER [...] cpan.org

<br />
ribasushi [...] leporine.io

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21732-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21733-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




0001-only-ignore-direct-module-missing-errors-in-use_pack.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1314260/696648/0001-only-ignore-direct-module-missing-errors-in-use_pack.patch">
Sat Jan 18 22:37:58 2014 (1.4k) by haarg [...] haarg.org
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1303030/690423/0001-only-ignore-direct-module-missing-errors-in-use_pack.patch">
Tue Dec 17 16:34:24 2013 (1.3k) by haarg [...] haarg.org
</a>
</font></li>
</ul>


upo.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1228006/648825/upo.patch">
Mon Jun 24 18:33:27 2013 (1.2k) by DOY [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=86394">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1228006" href="/Public/Bug/Display.html?id=86394#txn-1228006">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;24&nbsp;18:33:27&nbsp;2013</span>
    <span class="description">DOY [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> use_package_optimistically fails to report a failure in the
 module itself to load a different module</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1228006/648824/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/648824">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 290b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">If you use use_package_optimistically to attempt to load a module with an error, that error is typically reported, except if the error is due to a failure in that module to load another module. This is because the regex used in use_package_optimistically is too lax. See attached for a fix.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> upo.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1228006/648825/upo.patch">Download upo.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -uNr a/lib/Module/Runtime.pm b/lib/Module/Runtime.pm
--- a/lib/Module/Runtime.pm	2012-02-16 15:11:34.000000000 -0500
+++ b/lib/Module/Runtime.pm	2013-06-24 18:24:05.251462576 -0400
@@ -381,8 +381,9 @@
 	my&#40;$name, $version&#41; = @_;
 	check_module_name&#40;$name&#41;;
 	eval { local $SIG{__DIE__}; require_module&#40;$name&#41;; };
+	my $file = module_notional_filename&#40;$name&#41;;
 	die $@ if $@ ne &#34;&#34; &#38;&#38;
-		$@ !~ /\ACan&#39;t locate .+ at \Q@{[__FILE__]}\E line/s;
+		$@ !~ /\ACan&#39;t locate \Q$file\E .+ at \Q@{[__FILE__]}\E line/s;
 	$name-&gt;VERSION&#40;$version&#41; if defined $version;
 	return $name;
 }
diff -uNr a/t/upo.t b/t/upo.t
--- a/t/upo.t	2012-02-16 15:11:34.000000000 -0500
+++ b/t/upo.t	2013-06-24 18:23:21.651491626 -0400
@@ -1,7 +1,7 @@
 use warnings;
 use strict;
 
-use Test::More tests =&gt; 30;
+use Test::More tests =&gt; 31;
 
 BEGIN { use_ok &#34;Module::Runtime&#34;, qw&#40;use_package_optimistically&#41;; }
 
@@ -87,4 +87,8 @@
 ok defined&#40;$t::Context::VERSION&#41;;
 ok $INC{&#34;t/Context.pm&#34;};
 
+# loads a module which doesn&#39;t exist
+test_use_package_optimistically&#40;&#34;t::WithDep&#34;&#41;;
+like $err, qr/Can&#39;t locate Dep\.pm in \@INC/;
+
 1;
diff -uNr a/t/WithDep.pm b/t/WithDep.pm
--- a/t/WithDep.pm	1969-12-31 19:00:00.000000000 -0500
+++ b/t/WithDep.pm	2013-06-24 18:22:15.438202381 -0400
@@ -0,0 +1 @@
+use Dep;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1278186" href="/Public/Bug/Display.html?id=86394#txn-1278186">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;23&nbsp;10:58:30&nbsp;2013</span>
    <span class="description">haarg [...] haarg.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1278186/677200/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/677200">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 51b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Any chance of getting this fixed and released soon?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1278187" href="/Public/Bug/Display.html?id=86394#txn-1278187">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;23&nbsp;10:58:30&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1278217" href="/Public/Bug/Display.html?id=86394#txn-1278217">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;23&nbsp;12:47:14&nbsp;2013</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1278217/677215/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/677215">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 171b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2013-10-23 07:58:30, haarg wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Any chance of getting this fixed and released soon?
</div>
This bug is exposed by the new Moose TRIAL release. CALL THE NATIONAL GUARD! :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1278221" href="/Public/Bug/Display.html?id=86394#txn-1278221">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;23&nbsp;12:47:30&nbsp;2013</span>
    <span class="description">ether [...] cpan.org -  Requestor ETHER added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1278816" href="/Public/Bug/Display.html?id=86394#txn-1278816">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;24&nbsp;15:49:16&nbsp;2013</span>
    <span class="description">ribasushi [...] leporine.io -  Cc RIBASUSHI added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1280967" href="/Public/Bug/Display.html?id=86394#txn-1280967">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;30&nbsp;03:02:34&nbsp;2013</span>
    <span class="description">haarg [...] haarg.org -  Requestor haarg added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1298009" href="/Public/Bug/Display.html?id=86394#txn-1298009">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;03&nbsp;15:16:54&nbsp;2013</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #86394] use_package_optimistically fails to report a failure in the  module itself to load a different module</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 3 Dec 2013 20:16:38 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jesse Luehrs via RT &lt;bug-Module-Runtime [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1298009/687578/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/687578">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Jesse Luehrs via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;If you use use_package_optimistically to attempt to load a module with an
&gt;error, that error is typically reported, except if the error is due to a
&gt;failure in that module to load another module.
</div>
That certainly is a problem with use_package_optimistically&#40;&#41;.  However,
this function is &#40;and always was&#41; documented to mostly match base.pm,
and base.pm exhibits the same problem for the same reason.  So while
both modules would be improved by making the module-not-found detection
tighter, I&#39;m dubious about changing Module::Runtime first.  I see
that base.pm&#39;s RT queue does not contain any mention of this problem,
so I can&#39;t even make the change in anticipation of base.pm imminently
adopting the same change.  I&#39;m not absolutely ruling out making a
change independently of base.pm, but I&#39;d need some convincing to make
them diverge.

As for the specific patch, I&#39;m not entirely happy that it solves the
problem.  It&#39;ll certainly catch most cases that the current logic gets
wrong, and I believe the notional filename is used for the &#34;Can&#39;t locate&#34;
message regardless of platform, so that much is OK.  But if it&#39;s going to
be made more specific then I&#39;d rather it be made as specific as possible.
The regexp could be made further specific about which line &#40;of M/R.pm&#41;
the error is signalled on.  However, it&#39;s still a hack; the failure
to find the module is not being distinctively signalled by require&#40;&#41;.
I wonder about using a magic object in @INC to detect require&#40;&#41;&#39;s
iteration, but worry about this being visible to other code.

Overall, the missing-module detection is a hack that can&#39;t possibly
be entirely reliable.  This shouldn&#39;t be a dire problem, as it&#39;s in a
function that&#39;s labelled &#34;optimistic&#34;, and the failure mode is that it&#39;s
a bit more optimistic than you&#39;d like.  What are you doing that relies
on such a fragile mechanism?

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1298050" href="/Public/Bug/Display.html?id=86394#txn-1298050">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;03&nbsp;16:44:57&nbsp;2013</span>
    <span class="description">NNUTTER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1298050/687601/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/687601">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">For what it&#39;s worth we were about to submit this same bug report.  Our use case is that we are loading configuration modules using a hierarchy so modules do not have to exist but if they do we want to know if they fail to load.

I think at the very least the documents should clarify the behavior as it currently says,

&#34;If the module cannot be found then it is assumed that the package was actually already loaded by other means, and no error is signalled.&#34;

and should maybe say, &#34;If the module cannot be loaded&#34;, or, &#34;If the module cannot be found, or fails to compile,&#34;.

Keeping consistency with base.pm, while kind of saddening, does make sense.  I don&#39;t know if it would be sufficient to check $@ ourselves as I am concerned about checking $@ when I can&#39;t see the eval beside it.

By the way, the check we use currently is:

  if &#40;$@ and $@ !~ m/^Can&#39;t locate $filename in \@INC/&#41; {                                                                                                                       
        Carp::croak&#40;$@&#41;;                                                                                                                                                          
  }

So clearly ours needs improvement.  Also base.pm&#39;s is:

  die if $@ &#38;&#38; $@ !~ /^Can&#39;t locate .*? at \&#40;eval /;

which is also different.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1298053" href="/Public/Bug/Display.html?id=86394#txn-1298053">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;03&nbsp;16:59:02&nbsp;2013</span>
    <span class="description">haarg [...] haarg.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1298053/687604/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/687604">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 949b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I don&#39;t really think trying to keep 100% compatibility with base.pm is a good idea.  base.pm has the incredible weight of backwards compatibility to deal with, which isn&#39;t the case for Module::Runtime.  I&#39;ve tried to make improvements to base.pm in the past, but was basically told by p5p that &#34;heuristics can&#39;t be perfect, so we won&#39;t improve them&#34;.  And given that the intention of the code clearly doesn&#39;t match the implementation, I don&#39;t think being help back by base.pm is good.  base.pm also has the extra &#40;although buggy&#41; check of the symbol table to reduce the odds of silent failures.

As for what was hitting this issue, Moose is attempting to move towards more reliable checks for module loading.  However, backwards compatibility concerns means it still has to make allowances for inline packages.  In the course of developing the latest dev releases, this issue was masking a bug in the new Moose code, hampering the debugging process.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1298056" href="/Public/Bug/Display.html?id=86394#txn-1298056">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;03&nbsp;17:09:36&nbsp;2013</span>
    <span class="description">rt-cpan [...] trout.me.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1298056/687607/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/687607">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 906b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Key reason I care about such a thing:

If I have an optional dependency of some sort, I tend to want to &#40;a&#41; not care if said module isn&#39;t installed at all &#40;b&#41; throw an exception if it&#39;s present but fails to load, because that probably indicates a problem in need of fixing.

At least during development, having code automatically fall back to &#34;eh, I don&#39;t have it&#34; tends to hide compilation failures, and during production it tends to hide things like library compatibility issues, and I think it&#39;s reasonable to assume that if the .pm file is there at all the user intended it to work and it not doing so should die&#40;&#41;.

This is, of course, not the same as the base.pm use case and I&#39;d be perfectly happy with a different function for that.

I also suspect you&#39;re right that base.pm should be changed as well though, and would encourage somebody more awake than I am right now to file something over there.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1298059" href="/Public/Bug/Display.html?id=86394#txn-1298059">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;03&nbsp;17:12:11&nbsp;2013</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #86394] use_package_optimistically fails to report a failure in the module itself to load a different module</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 3 Dec 2013 22:12:00 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Graham Knop via RT &lt;bug-Module-Runtime [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1298059/687610/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/687610">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 732b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Graham Knop via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;As for what was hitting this issue, Moose is attempting to move towards
&gt;more reliable checks for module loading.  However, backwards compatibility
&gt;concerns means it still has to make allowances for inline packages.
</div>
I expect Moose could use some more reliable heuristic to detect inline
packages.  If this is specifically about Moose classes, surely there&#39;s a
reliable way to detect whether a package has had the Moose magic applied,
then you can use the non-optimistic use_module&#40;&#41; on anything that&#39;s not
already a Moose class.

Even if the non-existence of a module were reliably detectable, the
optimistic heuristics suck.  This is not a good thing to be building
into any modern framework.

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1298062" href="/Public/Bug/Display.html?id=86394#txn-1298062">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;03&nbsp;17:15:35&nbsp;2013</span>
    <span class="description">DOY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> ether [...] cpan.org, haarg [...] haarg.org, ribasushi [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #86394] use_package_optimistically fails to report a failure in the module itself to load a different module</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 3 Dec 2013 17:15:26 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Zefram via RT &lt;bug-Module-Runtime [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jesse Luehrs &lt;DOY [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1298062/687613/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/687613">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Dec 03, 2013 at 05:12:11PM -0500, Zefram via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=86394">https://rt.cpan.org/Ticket/Display.html?id=86394</a></span> &gt;
&gt; 
&gt; Graham Knop via RT wrote:
<div class="message-stanza open">&gt; &gt;As for what was hitting this issue, Moose is attempting to move towards
&gt; &gt;more reliable checks for module loading.  However, backwards compatibility
&gt; &gt;concerns means it still has to make allowances for inline packages.
</div>&gt; 
&gt; I expect Moose could use some more reliable heuristic to detect inline
&gt; packages.  If this is specifically about Moose classes, surely there&#39;s a
&gt; reliable way to detect whether a package has had the Moose magic applied,
&gt; then you can use the non-optimistic use_module&#40;&#41; on anything that&#39;s not
&gt; already a Moose class.
&gt; 
&gt; Even if the non-existence of a module were reliably detectable, the
&gt; optimistic heuristics suck.  This is not a good thing to be building
&gt; into any modern framework.
</div>
Yes, I made Moose stop using these heuristics entirely once I ran into
this bug - it&#39;s no longer an issue there. That said, it does make
debugging things quite a bit more confusing, as mst pointed out.

-doy
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1298065" href="/Public/Bug/Display.html?id=86394#txn-1298065">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;03&nbsp;17:18:25&nbsp;2013</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #86394] use_package_optimistically fails to report a failure in the module itself to load a different module</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 3 Dec 2013 22:18:14 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> MSTROUT via RT &lt;bug-Module-Runtime [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1298065/687616/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/687616">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 643b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">MSTROUT via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;This is, of course, not the same as the base.pm use case and I&#39;d be
&gt;perfectly happy with a different function for that.
</div>
I&#39;d also be happier with providing a separate function that attempts a
cleaner &#34;optional module&#34; semantic.  Detecting non-existent module would
still be a hack, but if it&#39;s separate from the base.pm-alike function then
I&#39;d be willing to make it hackier to get closer to the target semantic.

Would this be usable for the Moose use case?  It wouldn&#39;t detect inline
modules, but I think Moose shouldn&#39;t be applying heuristics for that.
And if it does want heuristics, it should use its own.

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1298078" href="/Public/Bug/Display.html?id=86394#txn-1298078">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;03&nbsp;17:54:03&nbsp;2013</span>
    <span class="description">haarg [...] haarg.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1298078/687627/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/687627">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 03 17:12:11 2013, zefram@fysh.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Graham Knop via RT wrote:
<div class="message-stanza open">&gt; &gt;As for what was hitting this issue, Moose is attempting to move towards
&gt; &gt;more reliable checks for module loading.  However, backwards compatibility
&gt; &gt;concerns means it still has to make allowances for inline packages.
</div>&gt; 
&gt; I expect Moose could use some more reliable heuristic to detect inline
&gt; packages.  If this is specifically about Moose classes, surely there&#39;s a
&gt; reliable way to detect whether a package has had the Moose magic applied,
&gt; then you can use the non-optimistic use_module&#40;&#41; on anything that&#39;s not
&gt; already a Moose class.
&gt; 
&gt; Even if the non-existence of a module were reliably detectable, the
&gt; optimistic heuristics suck.  This is not a good thing to be building
&gt; into any modern framework.
&gt; 
&gt; -zefram
</div>
Inline packages declared elsewhere can be assumed to be in a consistent state, because they would have already thrown errors otherwise.  So checking for Moose&#39;s magic on the classes is reliable.

But a half-compiled module can be in an inconsistent state.  Moose&#39;s magic may be applied, even though the module failed to load.  So the compile failure needs to be detected before checking for the magic.

These needs exactly match the behavior described in the use_package_optimistically docs &#40;aside from the &#34;matches base.pm&#34; bit&#41;.

As a separate note, base.pm is blead upstream.  Unfortunately that isn&#39;t reflected in the dist&#39;s metadata.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1298085" href="/Public/Bug/Display.html?id=86394#txn-1298085">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;03&nbsp;18:06:47&nbsp;2013</span>
    <span class="description">NNUTTER [...] cpan.org -  Cc NNUTTER added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1298237" href="/Public/Bug/Display.html?id=86394#txn-1298237">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;04&nbsp;05:50:48&nbsp;2013</span>
    <span class="description">haarg [...] haarg.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1298237/687708/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/687708">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 525b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">So I just went to look at fixing base.pm, and realized that it doesn&#39;t suffer from this bug &#40;mostly&#41;.  The check it uses looks like this:

die if $@ &#38;&#38; $@ !~ /^Can&#39;t locate .*? at \&#40;eval /;

The key difference is that it lacks a /s flag on the regex.  So it will only ignore missing modules directly in an eval.

I&#39;m still going to file an issue about making base.pm more strict, but I think that&#39;s shows that this definitely needs to change in some way.

I&#39;d say that the /s flag should be removed in addition to this patch.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1298240" href="/Public/Bug/Display.html?id=86394#txn-1298240">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;04&nbsp;06:03:47&nbsp;2013</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #86394] use_package_optimistically fails to report a failure in the module itself to load a different module</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 4 Dec 2013 11:03:36 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Graham Knop via RT &lt;bug-Module-Runtime [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1298240/687711/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/687711">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 366b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Graham Knop via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;So I just went to look at fixing base.pm, and realized that it doesn&#39;t
&gt;suffer from this bug &#40;mostly&#41;.
</div>
It&#39;ll show up in a different set of places, that&#39;s a good point.  It does
fundamentally have the problem that a fairly broad set of &#34;Can&#39;t locate&#34;
errors will be interpreted as the particular module of interest being
missing.

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1298243" href="/Public/Bug/Display.html?id=86394#txn-1298243">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;04&nbsp;06:07:59&nbsp;2013</span>
    <span class="description">haarg [...] haarg.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1298243/687714/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/687714">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 105b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Filed a ticket for making base.pm&#39;s check more strict:

<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/Ticket/Display.html?id=120685">https://rt.perl.org/Ticket/Display.html?id=120685</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1298290" href="/Public/Bug/Display.html?id=86394#txn-1298290">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;04&nbsp;08:56:18&nbsp;2013</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #86394] use_package_optimistically fails to report a failure in the module itself to load a different module</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 4 Dec 2013 13:56:06 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Graham Knop via RT &lt;bug-Module-Runtime [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1298290/687734/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/687734">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 225b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Graham Knop via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;I&#39;d say that the /s flag should be removed in addition to this patch.
</div>
Not so simple.  See [perl #120687].  Parsing error messages that have
had filenames interpolated into them is *hard*.

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1303030" href="/Public/Bug/Display.html?id=86394#txn-1303030">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;17&nbsp;16:34:24&nbsp;2013</span>
    <span class="description">haarg [...] haarg.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1303030/690422/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/690422">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 49b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is an updated patch based on perl rt#120685.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-only-ignore-direct-module-missing-errors-in-use_pack.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1303030/690423/0001-only-ignore-direct-module-missing-errors-in-use_pack.patch">Download 0001-only-ignore-direct-module-missing-errors-in-use_pack.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">From f71ba1707c4cfb979004ea81d1f069ba47442db5 Mon Sep 17 00:00:00 2001
From: Graham Knop &lt;haarg@haarg.org&gt;
Date: Tue, 17 Dec 2013 16:33:13 -0500
Subject: [PATCH] only ignore direct module missing errors in
 use_package_optimistically

---
 lib/Module/Runtime.pm | 15 ++++++++++++---
 1 file changed, 12 insertions&#40;+&#41;, 3 deletions&#40;-&#41;

diff --git a/lib/Module/Runtime.pm b/lib/Module/Runtime.pm
index 5217a8c..93a6c97 100644
--- a/lib/Module/Runtime.pm
+++ b/lib/Module/Runtime.pm
@@ -317,6 +317,14 @@ sub require_module&#40;$&#41; {
 		return scalar&#40;require&#40;&#38;module_notional_filename&#41;&#41;;
 	}
 }
+BEGIN {
+	my $line = __LINE__ - 4;
+	$line -= 4
+		if _WORK_AROUND_BROKEN_MODULE_STATE;
+	my $location = __FILE__ . &#34; line $line&#34;;
+	*_REQUIRE_LOCATION = sub &#40;&#41; { $location };
+}
+
 
 =back
 
@@ -379,10 +387,11 @@ function work just like L&lt;/use_module&gt;.
 
 sub use_package_optimistically&#40;$;$&#41; {
 	my&#40;$name, $version&#41; = @_;
-	check_module_name&#40;$name&#41;;
+	my $file = module_notional_filename&#40;$name&#41;;
 	eval { local $SIG{__DIE__}; require_module&#40;$name&#41;; };
-	die $@ if $@ ne &#34;&#34; &#38;&#38;
-		$@ !~ /\ACan&#39;t locate .+ at \Q@{[__FILE__]}\E line/s;
+	die $@ if $@ ne &#34;&#34;
+		&#38;&#38; $@ !~ /^Can&#39;t locate \Q$file\E .*? at \Q@{[_REQUIRE_LOCATION]}\E\.\n\z/s
+		|| $@ =~ /Compilation failed in require at \Q@{[_REQUIRE_LOCATION]}\E\.\n\z/;
 	$name-&gt;VERSION&#40;$version&#41; if defined $version;
 	return $name;
 }
-- 
1.8.5

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1314181" href="/Public/Bug/Display.html?id=86394#txn-1314181">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;18&nbsp;15:20:58&nbsp;2014</span>
    <span class="description">ether [...] cpan.org -  Dependency by ticket #92246 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1314260" href="/Public/Bug/Display.html?id=86394#txn-1314260">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;18&nbsp;22:37:58&nbsp;2014</span>
    <span class="description">haarg [...] haarg.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1314260/696647/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/696647">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 50b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Another patch update per updated base.pm in blead.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-only-ignore-direct-module-missing-errors-in-use_pack.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1314260/696648/0001-only-ignore-direct-module-missing-errors-in-use_pack.patch">Download 0001-only-ignore-direct-module-missing-errors-in-use_pack.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">From b9b9cd2d4b57b228c238bd7c444c56d4a92d40a3 Mon Sep 17 00:00:00 2001
From: Graham Knop &lt;haarg@haarg.org&gt;
Date: Sat, 18 Jan 2014 22:36:23 -0500
Subject: [PATCH] only ignore direct module missing errors in
 use_package_optimistically

---
 lib/Module/Runtime.pm | 17 ++++++++++++++---
 1 file changed, 14 insertions&#40;+&#41;, 3 deletions&#40;-&#41;

diff --git a/lib/Module/Runtime.pm b/lib/Module/Runtime.pm
index 5217a8c..7919de5 100644
--- a/lib/Module/Runtime.pm
+++ b/lib/Module/Runtime.pm
@@ -317,6 +317,16 @@ sub require_module&#40;$&#41; {
 		return scalar&#40;require&#40;&#38;module_notional_filename&#41;&#41;;
 	}
 }
+my $require_error_location_rx;
+{
+	my $line = __LINE__ - 5;
+	$line -= 4
+		if _WORK_AROUND_BROKEN_MODULE_STATE;
+	my $location = &#39; at &#39; . __FILE__ . &#34; line $line&#34;;
+	$require_error_location_rx =
+		qr/\Q$location\E&#40;?:, &lt;[^&gt;]*&gt; &#40;?:line|chunk&#41; [0-9]+&#41;?\.\n/;
+}
+
 
 =back
 
@@ -379,10 +389,11 @@ function work just like L&lt;/use_module&gt;.
 
 sub use_package_optimistically&#40;$;$&#41; {
 	my&#40;$name, $version&#41; = @_;
-	check_module_name&#40;$name&#41;;
+	my $file = module_notional_filename&#40;$name&#41;;
 	eval { local $SIG{__DIE__}; require_module&#40;$name&#41;; };
-	die $@ if $@ ne &#34;&#34; &#38;&#38;
-		$@ !~ /\ACan&#39;t locate .+ at \Q@{[__FILE__]}\E line/s;
+	die $@ if $@ ne &#34;&#34;
+		&#38;&#38; $@ !~ /^Can&#39;t locate \Q$file\E .*?$require_error_location_rx\z/s
+		|| $@ =~ /Compilation failed in require$require_error_location_rx\z/;
 	$name-&gt;VERSION&#40;$version&#41; if defined $version;
 	return $name;
 }
-- 
1.8.5.2

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1323048" href="/Public/Bug/Display.html?id=86394#txn-1323048">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;05&nbsp;22:01:50&nbsp;2014</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1323048/701705/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/701705">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 221b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2014-01-18 19:37:58, haarg wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Another patch update per updated base.pm in blead.
</div>
Is this patch acceptable? it would be really good to get this out, as we&#39;ve had another ticket reported against Moose due to this.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1323052" href="/Public/Bug/Display.html?id=86394#txn-1323052">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;05&nbsp;22:02:12&nbsp;2014</span>
    <span class="description">ether [...] cpan.org -  Dependency by ticket #92770 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1323132" href="/Public/Bug/Display.html?id=86394#txn-1323132">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;06&nbsp;05:32:41&nbsp;2014</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #86394] use_package_optimistically fails to report a failure in the module itself to load a different module</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 6 Feb 2014 10:32:29 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Karen Etheridge via RT &lt;bug-Module-Runtime [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1323132/701736/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/701736">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 228b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Karen Etheridge via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;Is this patch acceptable? it would be really good to get this out,
&gt;as we&#39;ve had another ticket reported against Moose due to this.
</div>
Will look this evening.  I think I can resolve it now.

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1323309" href="/Public/Bug/Display.html?id=86394#txn-1323309">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;06&nbsp;17:27:07&nbsp;2014</span>
    <span class="description">ZEFRAM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1323309/701832/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/701832">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 43b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in Module-Runtime-0.014, now on CPAN.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1323312" href="/Public/Bug/Display.html?id=86394#txn-1323312">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;06&nbsp;17:27:08&nbsp;2014</span>
    <span class="description">ZEFRAM [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 1.118228</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
