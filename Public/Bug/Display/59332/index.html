<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #59332 for Net-SSH2: Handling LIBSSH2_ERROR_EAGAIN</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #59332 for Net-SSH2: Handling LIBSSH2_ERROR_EAGAIN</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Net-SSH2">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Net-SSH2">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Net-SSH2">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Net-SSH2">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SSH2">Net-SSH2 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">59332</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Net-SSH2">Net-SSH2</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dwheeler [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-23280-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-23281-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=59332">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-803483" href="/Public/Bug/Display.html?id=59332#txn-803483">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;13&nbsp;18:48:54&nbsp;2010</span>
    <span class="description">dwheeler [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> libssh2 development &lt;libssh2-devel [...] cool.haxx.se&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Handling LIBSSH2_ERROR_EAGAIN</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 13 Jul 2010 15:48:44 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-net-ssh2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David E. Wheeler&#34; &lt;dwheeler [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/803483/416544/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/416544">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dear Net::SSH2 Maintainers,

With help from the deniznes of #libssh2 on Freenode &#40;Bagder and CareBear\&#41;, I got a bug fixed in Net::SSH2&#39;s scp_put&#40;&#41; method. The bug in two parts, as far as I can tell.

The first, in SSH2.xs, is that it doesn&#39;t properly handle LIBSSH2_ERROR_EAGAIN spinning in net_ch_write&#40;&#41;. The patch is here:

<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/theory/net-ssh2/commit/9c9ced9984ce7891a1a001b84c846d2425137049">http://github.com/theory/net-ssh2/commit/9c9ced9984ce7891a1a001b84c846d2425137049</a></span>

The second, in the scp_put&#40;&#41; method of Net::SSH2, is that it didn&#39;t handle partial writes. So assuming a failure on a partial write, it was failing with whatever error was left in libssh2, which happened to be LIBSSH2_ERROR_EAGAIN. So this patch checks for partial writes and does the right thing:

<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/theory/net-ssh2/commit/d053f28a35d1f0454d2155145d54c600a2f41447">http://github.com/theory/net-ssh2/commit/d053f28a35d1f0454d2155145d54c600a2f41447</a></span>

It looks like there might be similar bugs throughout Net::SSH2. In particular, I&#39;m told that, when  blocking is enabled &#40;as it is by default&#41;, Net::SSH2 should ignore LIBSSH2_ERROR_EAGAIN. In many places, it&#39;s either failing to account for partial writes &#40;or, perhaps, reads, as in scp_get&#40;&#41;&#41;, and thinks there is an error because it finds LIBSSH2_ERROR_EAGAIN. So there may be a bunch of places it fails. Another, I&#39;ve noticed, is when connecting to some hosts with:

    my $ssh2 = Net::SSH2-&gt;new;
    $ssh2-&gt;connect&#40;&#39;test.example.com&#39;&#41;;
    my $ret = $ssh2-&gt;auth&#40;
        username   =&gt; &#39;theory&#39;,
        password   =&gt; &#39;*****&#39;,
        publickey  =&gt; &#34;$ENV{HOME}id_rsa.pub&#34;,
        privatekey =&gt; &#34;$ENV{HOME}id_rsa&#34;,
    &#41;;

    die $ssh2-&gt;error unless $ret &#38;&#38; $ssh2-&gt;auth_ok;

So I think there might need to be some refactoring with regard to handling LIBSSH2_ERROR_EAGAIN when blocking is enabled and with regard to partial reads and writes.

Thanks,

David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-803504" href="/Public/Bug/Display.html?id=59332#txn-803504">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;13&nbsp;19:32:34&nbsp;2010</span>
    <span class="description">peter [...] stuge.se -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #59332] AutoReply: Handling LIBSSH2_ERROR_EAGAIN</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 14 Jul 2010 01:32:20 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Bugs in Net-SSH2 via RT &lt;bug-Net-SSH2 [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Stuge &lt;peter [...] stuge.se&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/803504/416553/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/416553">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">It seems there&#39;s a bit of misunderstanding about the _EAGAIN error
code. I&#39;ll try to clarify.

Bugs in Net-SSH2 via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The bug in two parts, as far as I can tell.
</div>
It&#39;s two distinct bugs, actually.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The first, in SSH2.xs, is that it doesn&#39;t properly handle
&gt; LIBSSH2_ERROR_EAGAIN spinning in net_ch_write&#40;&#41;. The patch is here:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/theory/net-ssh2/commit/9c9ced9984ce7891a1a001b84c846d2425137049">http://github.com/theory/net-ssh2/commit/9c9ced9984ce7891a1a001b84c846d2425137049</a></span>
</div>
Although I am the author, this is not neccessarily the appropriate
fix. I can&#39;t say what is best because I know little about perl and
less about Net:SSH2.

libssh2 offers an API which can optionally be used completely
non-blocking. When non-blocking mode is enabled, any libssh2 function
call that would block will instead return LIBSSH2_ERROR_EAGAIN, and
the same function should be called again. Just like other
non-blocking calls.

A blocking mode can also be enabled, in this case there are internal
wrappers in libssh2 for all functions which spin efficiently if
_EAGAIN should occur within the library.

The libssh2 error code is set proactively in many places within the
library and if one tries to read the last error code when in fact
there was no error, then it is very likely that _EAGAIN will be
returned. It is important that the libssh2 caller does not check for
an error code unless there was in fact an error condition.

How to deal with this first patch depends on how Net:SSH2 wants to
deal with the blocking/non-blocking issue, and what the &#34;perl way&#34;
is. The patch makes Net:SSH2 behave in a blocking mode, and does so a
little inefficiently. I recommend reworking this patch before a
release.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The second, in the scp_put&#40;&#41; method of Net::SSH2, is that it didn&#39;t
&gt; handle partial writes.
</div>
This patch also needs consideration. Again the patch makes Net:SSH2
behave in a blocking fashion, it will loop calling libssh2 until all
data is sent. This is not neccessarily the best way to implement
Net:SSH2 and it may not be the &#34;perl way&#34; - I have no idea, I just
fixed this one particular case for one particular application which
makes assumptions about Net:SSH2 which I know to be neither true nor
false.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So assuming a failure on a partial write,
</div>
This is the problem. libssh2 can return fewer bytes than requested
both when reading and writing, including 0, and this must not be
considered an error. This means that libssh2 has processed some of
the data, but not all. The caller must deal with this. As the man
pages describe, return codes are always negative if there was an
error. Anything equal to, or greater than, 0 is a successful call to
libssh2. Net:SSH2 should decide how to expose this property of
libssh2 to callers.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; it was failing with whatever error was left in libssh2, which
&gt; happened to be LIBSSH2_ERROR_EAGAIN.
</div>
The code assumed that the only successful case was when libssh2 took
care of *all* requested data, and assumed that everything else was an
error. This is wrong. That&#39;s why there was a nonsense error code.
&#40;See above, the error code is set internally in many places where it
*might* be returned, if libssh2 is being used in non-blocking mode.&#41;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So this patch checks for partial writes and does the right thing:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/theory/net-ssh2/commit/d053f28a35d1f0454d2155145d54c600a2f41447">http://github.com/theory/net-ssh2/commit/d053f28a35d1f0454d2155145d54c600a2f41447</a></span>
</div>
It is one solution, but again it is not neccessarily the appropriate
one. Net:SSH2 needs to decide how to deal with the possibility of
libssh2 to offer a non-blocking API. If that should be hidden, and
Net:SSH2 users must always expect and receive a fully blocking API
&#40;simpler, but less flexible&#41; then this patch is correct.

If instead Net:SSH2 users should have an option to use libssh2 in
non-blocking mode, then the patch needs to be reworked, to pass the
_EAGAIN &#34;error code&#34; up to the caller, so that the caller can decide
what/when to perform the next action.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It looks like there might be similar bugs throughout Net::SSH2.
</div>
This is quite likely, since the bug indicates a misunderstanding or
misinterpretation of the libssh2 API, so it&#39;s probably present
throughout the binding.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In particular, I&#39;m told that, when  blocking is enabled &#40;as it is
&gt; by default&#41;, Net::SSH2 should ignore LIBSSH2_ERROR_EAGAIN.
</div>
Not ignore, but spin on. Call the same function again with the same
parameters. _EAGAIN is returned as if it was an error code &#40;it&#39;s a
negative number&#41; but in fact it&#39;s not really an error - it is just a
way for libssh2 to clearly indicate that this API call would block,
and the application doesn&#39;t want that to happen.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In many places, it&#39;s either failing to account for partial writes
&gt; &#40;or, perhaps, reads, as in scp_get&#40;&#41;&#41;, and thinks there is an error
&gt; because it finds LIBSSH2_ERROR_EAGAIN.
</div>
It thinks that there is an error because not all bytes were handled
by libssh2. This is a false assumption. Anything to do with _EAGAIN
in this situation comes as a consequence of that false assumption.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So there may be a bunch of places it fails. Another, I&#39;ve noticed,
&gt; is when connecting to some hosts with:
</div>
This is basically true for every single function in the libssh2 API.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So I think there might need to be some refactoring with regard to
&gt; handling LIBSSH2_ERROR_EAGAIN when blocking is enabled and with
&gt; regard to partial reads and writes.
</div>
Yes, Net:SSH2 basically needs to be fixed to use the libssh2 API
correctly.


//Peter
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-803507" href="/Public/Bug/Display.html?id=59332#txn-803507">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;13&nbsp;19:32:35&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-810197" href="/Public/Bug/Display.html?id=59332#txn-810197">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;28&nbsp;19:51:55&nbsp;2010</span>
    <span class="description">dwheeler [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> schwern [...] pobox.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/810197/420024/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/420024">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 71b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hey Caelum,

Any thoughts on how to address this issue?

Thanks!

David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-811243" href="/Public/Bug/Display.html?id=59332#txn-811243">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;30&nbsp;11:09:38&nbsp;2010</span>
    <span class="description">rkitover@cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #59332] Handling LIBSSH2_ERROR_EAGAIN</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 30 Jul 2010 11:09:41 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> David Wheeler via RT &lt;bug-Net-SSH2 [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Rafael Kitover &lt;rkitover [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/811243/420500/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/420500">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 479b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Jul 28, 2010 at 07:51:55PM -0400, David Wheeler via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSH2
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=59332">https://rt.cpan.org/Ticket/Display.html?id=59332</a></span> &gt;
&gt; 
&gt; Hey Caelum,
&gt; 
&gt; Any thoughts on how to address this issue?
&gt; 
&gt; Thanks!
&gt; 
&gt; David
</div>
I&#39;m probably going to add the eagain spin hacks so that they are only
activated with -&gt;blocking&#40;1&#41; and add the -&gt;disconnect on DESTROY in the
next release.

You&#39;re always disconnecting from irc so I can&#39;t leave you messages :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-811257" href="/Public/Bug/Display.html?id=59332#txn-811257">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;30&nbsp;13:01:33&nbsp;2010</span>
    <span class="description">dwheeler [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Peter Stuge &lt;peter [...] stuge.se&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #59332] Handling LIBSSH2_ERROR_EAGAIN</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 30 Jul 2010 10:01:23 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSH2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David E. Wheeler&#34; &lt;dwheeler [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/811257/420505/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/420505">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 831b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Jul 30, 2010, at 8:09 AM, rkitover@cpan.org via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=59332">http://rt.cpan.org/Ticket/Display.html?id=59332</a></span> &gt;
&gt; 
&gt; On Wed, Jul 28, 2010 at 07:51:55PM -0400, David Wheeler via RT wrote:
<div class="message-stanza open">&gt;&gt;       Queue: Net-SSH2
&gt;&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=59332">https://rt.cpan.org/Ticket/Display.html?id=59332</a></span> &gt;
&gt;&gt; 
&gt;&gt; Hey Caelum,
&gt;&gt; 
&gt;&gt; Any thoughts on how to address this issue?
&gt;&gt; 
&gt;&gt; Thanks!
&gt;&gt; 
&gt;&gt; David
</div>&gt; 
&gt; I&#39;m probably going to add the eagain spin hacks so that they are only
&gt; activated with -&gt;blocking&#40;1&#41; and add the -&gt;disconnect on DESTROY in the
&gt; next release.
</div>
Peter, does that sound right to you?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You&#39;re always disconnecting from irc so I can&#39;t leave you messages :&#41;
</div>
Yeah, time zone issues, I guess. You can always leave a message for me with purl:

theory:purl, message for Caelum S’up?
purl:Message for caelum stored.

Best,

David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-821124" href="/Public/Bug/Display.html?id=59332#txn-821124">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;23&nbsp;08:07:00&nbsp;2010</span>
    <span class="description">sisyphus [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/821124/425427/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/425427">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jul 13 18:48:54 2010, DWHEELER wrote:
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The second, in the scp_put&#40;&#41; method of Net::SSH2, is that it didn&#39;t
&gt;    handle partial writes. So assuming a failure on a partial write, it
&gt;    was failing with whatever error was left in libssh2, which happened
&gt;    to be LIBSSH2_ERROR_EAGAIN. So this patch checks for partial writes
&gt;    and does the right thing:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/theory/net-">http://github.com/theory/net-</a></span>
&gt;    ssh2/commit/d053f28a35d1f0454d2155145d54c600a2f41447
</div>
This patch solved a long-running problem I&#39;ve had trying to upload ~7MB 
binary files via scp_put&#40;&#41; from my Windows Vista box to a linux box 
over a sluggish internet connection. Over a fast connection &#40;from the 
same Windows Vista box&#41; to a linux box on my local network, there was 
never any problem. &#40;Btw, I&#39;ve as yet found no need to apply the first 
patch that David linked to.&#41;

The problem was simply that the upload would bail out &#40;no error 
messages&#41; at some random point - usually before 0.5 MB had been 
uploaded, and it was bailing out because the condition:
$chan-&gt;write&#40;$buf&#41; == $count
was not true.  The fact that the error was going unreported led me to 
also rewrite the error handling. The patch &#40;against version 0.33 of 
SSH2.pm&#41; that I&#39;ve used is:

#########################
--- C:\perl5121_M/site/lib/Net/SSH2.pm_orig     Mon Aug 23 20:06:32 2010
+++ C:\perl5121_M/site/lib/Net/SSH2.pm  Mon Aug 23 20:36:30 2010
@@ -373,8 +373,18 @@
       $self-&gt;error&#40;0, &#34;want $block, have $count&#34;&#41;, return
        unless $count == $block;
       die &#39;sysread mismatch&#39; unless length $buf == $count;
-      $self-&gt;error&#40;0, &#34;error writing $count bytes to channel&#34;&#41;, return
-       unless $chan-&gt;write&#40;$buf&#41; == $count;
+      my $wrote = 0;
+      while &#40;$wrote &gt;= 0 &#38;&#38; $wrote &lt; $count&#41; {
+        my $wr = $chan-&gt;write&#40;$buf&#41;;
+        last if $wr &lt; 0;
+        $wrote += $wr;
+        $buf = substr $buf, $wr;
+      }
+      unless&#40;$wrote == $count&#41; {
+        my @error = $self-&gt;error&#40;&#41;;
+        warn &#34;Error writing $count bytes to channel: @error\n&#34;;
+        return;
+      }
     }

     # send/receive SCP acknowledgement
#########################

Given that the code

 $self-&gt;error&#40;0, &#34;error writing $count bytes to channel&#34;&#41;, return
    unless $chan-&gt;write&#40;$buf&#41; == $count;

was failing to produce any error message when it should have, I also 
wonder if

 $self-&gt;error&#40;$!, $!&#41;, return unless defined $count;
 $self-&gt;error&#40;0, &#34;want $block, have $count&#34;&#41;, return
  unless $count == $block;

&#40;from a few lines earlier&#41; would likewise fail to produce error 
messages.

Finally, the libssh2 documentation states that libssh2_scp_send_ex&#40;&#41; is 
deprecated, and should be replaced with libssh2_scp_send64&#40;&#41;, yet 
SSH2.xs still uses the former.

Thanks, guys !!

Cheers,
Rob
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-821434" href="/Public/Bug/Display.html?id=59332#txn-821434">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;23&nbsp;18:16:52&nbsp;2010</span>
    <span class="description">sisyphus [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/821434/425600/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/425600">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 778b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Aug 23 08:07:00 2010, SISYPHUS wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; +      my $wrote = 0;
&gt; +      while &#40;$wrote &gt;= 0 &#38;&#38; $wrote &lt; $count&#41; {
&gt; +        my $wr = $chan-&gt;write&#40;$buf&#41;;
&gt; +        last if $wr &lt; 0;
&gt; +        $wrote += $wr;
&gt; +        $buf = substr $buf, $wr;
&gt; +      }
</div>
Is there a possibility that the while loop could loop forever ?

Should there be a mechanism that breaks the loop after a set number of 
iterations ? Something like

 +      my &#40;$wrote, $safety, $max&#41; = &#40;0, 0, 100&#41;;
 +      while &#40;$wrote &gt;= 0 &#38;&#38; $wrote &lt; $count&#41; {
 +        $safety++;
 +        last if $safety &gt; $max;
 +        my $wr = $chan-&gt;write&#40;$buf&#41;;
 +        last if $wr &lt; 0;
 +        $wrote += $wr;
 +        $buf = substr $buf, $wr;
 +      }

What would be a reasonable value for $max ?

Cheers,
Rob
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1529167" href="/Public/Bug/Display.html?id=59332#txn-1529167">#</a>      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;26&nbsp;09:36:42&nbsp;2015</span>
    <span class="description">salva [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1529167/815827/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/815827">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 148b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">write has been fixed to handle buffers of any size correctly in the development version.

The bugs referenced in this report should all be gone now.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1529170" href="/Public/Bug/Display.html?id=59332#txn-1529170">#</a>      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;26&nbsp;09:36:50&nbsp;2015</span>
    <span class="description">salva [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.509581</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
