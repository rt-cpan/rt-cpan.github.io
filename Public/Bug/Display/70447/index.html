<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #70447 for Net-Z3950-SimpleServer: Modifications needed for launching server on Win2008R2 with Strawberry Perl</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #70447 for Net-Z3950-SimpleServer: Modifications needed for launching server on Win2008R2 with Strawberry Perl</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-Z3950-SimpleServer/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-Z3950-SimpleServer/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-Z3950-SimpleServer/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-Z3950-SimpleServer/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-Z3950-SimpleServer">Net-Z3950-SimpleServer CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">70447</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-Z3950-SimpleServer/Active/">Net-Z3950-SimpleServer</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
julian.esteves [...] janium.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-23464-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.14    </td>
  </tr>
  <tr id="CF-23465-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.14    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




files_and_patches.zip<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/969996/504727/files_and_patches.zip">
Tue Aug 23 19:40:43 2011 (33.6k) by jesteves [...] janium.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;23&nbsp;19:40:43&nbsp;2011</span>
    <span class="description">jesteves [...] janium.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Modifications needed for launching server on Win2008R2 with
 Strawberry Perl</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

I&#39;ve managed to launch a server via Net::Z3950::SimpleServer &#40;NZS&#41; on Windows 
with Strawberry Perl!!

I hope you find any of the following information useful and consider it for
inclusion in next releases of NZS.

First things first.  I guess I must supply some context here.  I&#39;m sure I&#39;ll
tell you some things you already know but please, bear with me, it&#39;s just for procedure&#39;s 
clarity sake.

  * Strawberry Perl &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://strawberryperl.com/&#41;">http://strawberryperl.com/&#41;</a></span> is our distribution of 
    choice.  The following was done on 5.12.1.0.

  * Among other things, Strawberry Perl includes MinGW GCC C/C++ compiler and 
    Dmake &#34;make&#34; tool
    &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://win32.perl.org/wiki/index.php?title=Strawberry_Perl#Description&#41;">http://win32.perl.org/wiki/index.php?title=Strawberry_Perl#Description&#41;</a></span>.

  * But, unfortunately, that is not enough to have NZS compiled with a clean 
    &#34;perl Makefile.PL; make; make test; make install&#34;.

  * This is primarily because YAZ distribution does not include an &#34;import 
    library&#34; in the format GCC expects it;  it certainly includes a &#34;.lib&#34; 
    library, but not a &#34;.a&#34;.

  * But also some minor changes are needed in some NZS files to.

So, off my two cents go...

I.  On having a libyaz.a usable with MinGW:

  1.  Install YAZ.  Binaries and development are needed.  Let&#39;s say they are 
      installed on &lt;YAZPATH&gt;.

      [ Note: The following has been proved to work only on 4.2.6 for win64. 
      but I guess it&#39;ll be the same on next releases. ]

  and

  2.  From a DOS command line, enter &lt;YAZPATH&gt;\bin and do:

      pexports yaz4.dll &gt;yaz4.def

      [ Also a note here.  This could of course be done on a PowerShell
      command line, but I&#39;ve found that the resulting yaz4.def is encoded in
      UTF-16 and it then can&#39;t be used by &#34;dlltool&#34; in the next step without
      being decoded. ]

      and then do:

      dlltool.exe --input-def yaz4.def --dllname yaz4.dll --output-lib 
      ../lib/libyaz.a

      It is essential that this two commands run without any error.

  3.  ** IMPORTANT ** In order to run any program linked against libyaz.a,
      &lt;YAZPATH&gt;\bin must be included in the PATH.

[
  - Sidebar -

  I guess it is possible to compile all of the YAZ suite &#34;a la UNIX&#34; with 
  MinGW.  For example, I&#39;ve tested recompiling and launching the server
  included in &#34;yaz-ztest.exe&#34;.  Compilation went like this, with a command 
  line in &lt;YAZPATH&gt;/ztest  &#40;for this it&#39;s necessary to install also YAZ 
  source&#41;:

  gcc -c ztest.c -I ../include
  gcc -c read-marc.c -I ../include
  gcc -c dummy-opac.c -I ../include
  gcc -c read-grs.c -I ../include
  gcc -o yaz-ztest_mingw.exe ztest.o read-marc.o dummy-opac.o read-grs.o 
  -L../lib -lyaz 
]

II.  On having NZS usable with Strawberry Perl:

  1. Download NZS from CPAN and enter the temporary folder containing it&#39;s
     source files:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">      cpan&gt; get Net::Z3950::SimpleServer
      cpan&gt; look Net::Z3950::SimpleServer
</div>
  2. Edit Makefile.PL to set $yazinc and $yazlibs.

     [ Note: I&#39;m attaching a modified Makefile.PL and a patch for your
     consideration. ]

  3. Edit SimpleServer.xs so the correction needed to deal with &#34;the
     PerlLIO_open issue&#34; is done *before* the inclusion of yaz headers.

     [ Note: I&#39;m also attaching a modified xs and a patch for it. ]

  3.5 ;-&#41;  same as I.3 above...

  4. Now compilation and installation can proceed as usual.

       perl Makefile.PL
       dmake
       dmake test
       dmake install

     [ Note: Testing phase on Windows will succeed with a modified version of
     test.pl.  I&#39;m attaching it and it&#39;s corresponding patch for your
     consideration as well.  During that phase some info is required from the
     user. ]

Thanks for reading up to here.  I hope I&#39;ve made myself &#40;and my English&#41; 
clear.

Please let me know if you have any questions or comments.

Regards,

Julián Esteves
&lt;julian.esteves@janium.com&gt;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> files_and_patches.zip</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/969996/504727/files_and_patches.zip">Download files_and_patches.zip</a><br />
<span class="downloadcontenttype">application/zip 33.6k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;23&nbsp;20:09:26&nbsp;2011</span>
    <span class="description">jesteves [...] janium.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jesteves [...] janium.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello again,

Geez!  I guess I pressed the &#34;send&#34; button too early...

I forgot to call your attention to two things.  In my particular case they were vital to have my
Z39 server running on Windows.

The first thing is noticeable in the modified version of &#34;test.pl&#34;.  It seems that for these 
programs to run under Windows &#40;with Strawberry Perl&#41; it is mandatory to declare the
callback functions like this:

    INIT =&gt; &#34;main::init_handler&#34;,
    FETCH =&gt; &#34;main::fetch_handler&#34;

and *not* like this:

    INIT =&gt; \&#38;main::init_handler,
    FETCH =&gt; \&#38;main::fetch_handler

With references the server seems not pass correct arguments to any of the handlers.
As far as I saw, handlers received the arguments sent to launch_server&#40;&#41; instead of the
hashref was supposed to.

And the second thing is *not* noticeable in test.pl.  In the case of my server I was
passing a global hash on GHANDLE during the call of new&#40;&#41;, but it&#39;s value wasn&#39;t
being supplied to handlers as supposed to.   This issue was very difficult to debug.
In fact, during some debugger &#40;perl -d&#41; sessions the GHANDLE returned as it should
and everything went fine, but out of the debugger it was failure after failure...

In some part it was this comment on SimpleServer.pm the one that made the hint for me:

    sub launch_server {
        my $self = shift;
        my @args = @_;
    
        ### This modal internal interface, in which we set a bunch of
        #   globals and then call start_server&#40;&#41;, is asking for
        #   trouble.  Instead, we should just pass the $self object
        #   as a parameter into start_server&#40;&#41;.
        if &#40;defined&#40;$self-&gt;{GHANDLE}&#41;&#41; {
                set_ghandle&#40;$self-&gt;{GHANDLE}&#41;;
        }

I&#39;ve just changed my code from

    my $global_hashref = {...};

    my $zserver = new Net::Z3950::SimpleServer&#40;
        GHANDLE =&gt; $global_hashref,
        
        INIT =&gt; &#39;main::init_handle&#39;,

        #...
    &#41;;

    sub init_handle {
        my $args = shift;

        my $_hashref = $args-&gt;{GHANDLE};

        #...
    }

which was working perfectly well on Unix, to something like

    my $global_hashref = {...};

    my $zserver = new Net::Z3950::SimpleServer&#40;
        INIT =&gt; &#39;main::init_handle&#39;,

        #...
    &#41;;

    sub init_handle {
        my $args = shift;

        my $_hashref = $main::global_hashref;

        #...
    }

which seems to work fine both on Unix and Windows.

Regards,

Julián

El Mar Ago 23 19:40:43 2011, jesteves@janium.com escribió:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello,
&gt; 
&gt; I&#39;ve managed to launch a server via Net::Z3950::SimpleServer &#40;NZS&#41; on
&gt; Windows
&gt; with Strawberry Perl!!
&gt; 
</div>
[...]
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;23&nbsp;20:09:27&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
