<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #66786 for Parser-MGC: Performance: where&#40;&#41; called by fail&#40;&#41; when backtracking</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #66786 for Parser-MGC: Performance: where&#40;&#41; called by fail&#40;&#41; when backtracking</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Parser-MGC/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Parser-MGC/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Parser-MGC/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Parser-MGC/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Parser-MGC">Parser-MGC CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">66786</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Parser-MGC/Active/">Parser-MGC</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
PSCUST [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-236072-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.07    </td>
  </tr>
  <tr id="CF-236073-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.08    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;22&nbsp;16:04:09&nbsp;2011</span>
    <span class="description">PSCUST [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Performance: where&#40;&#41; called by fail&#40;&#41; when backtracking</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The fail&#40;&#41; method calls where&#40;&#41; to extract the current line number and 
the whole line where the error occurred. This information is needed for 
showing an error message to the user, but most times the error raised by 
fail&#40;&#41; is captured and used for backtracking.

The fact that where&#40;&#41; is called unnecessarily causes a performance hit. 
There is a huge performance increase by postponing where&#40;&#41; to when an 
error message needs to be generated.

On a test program parsing a real program file of about 128K bytes, I got 
the following elapsed times:

13.97 s in the original 0.07 version of the module
 1.77 s with the attached modification


The patch also adds the file name to the error message, in case 
from_file&#40;&#41; was called. This seams to be the intent of the &#39;filename&#39; 
attribute, but it is not used. The xxerror.t tests this feature.


Please feel free to include the patch in a next version of the module, 
or to do something completely different.

Best regards,
Paulo Custodio
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Parser-MGC-0.07_02.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">*** Parser-MGC-0.07_01\lib\Parser\MGC.pm	2011-03-19 14:20:16.000000000 +0000
--- Parser-MGC-0.07_02\lib\Parser\MGC.pm	2011-03-22 19:36:16.165379000 +0000
***************
*** 257,275 ****
     my $pos = pos $self-&gt;{str};
     my $str = $self-&gt;{str};
  
!    my $sol = $pos;
!    $sol-- if $sol &gt; 0 and substr&#40; $str, $sol, 1 &#41; =~ m/^[\r\n]$/;
!    $sol-- while $sol &gt; 0 and substr&#40; $str, $sol-1, 1 &#41; !~ m/^[\r\n]$/;
! 
!    my $eol = $pos;
!    $eol++ while $eol &lt; length&#40;$str&#41; and substr&#40; $str, $eol, 1 &#41; !~ m/^[\r\n]$/;
! 
!    my $line = substr&#40; $str, $sol, $eol - $sol &#41;;
! 
!    my $col = $pos - $sol;
!    my $lineno = &#40; &#40;&#41; = substr&#40; $str, 0, $pos &#41; =~ m/\n/g &#41; + 1;
! 
!    return &#40; $lineno, $col, $line &#41;;
  }
  
  =head2 $parser-&gt;fail&#40; $message &#41;
--- 257,263 ----
     my $pos = pos $self-&gt;{str};
     my $str = $self-&gt;{str};
  
!    return _where&#40;$str, $pos&#41;;
  }
  
  =head2 $parser-&gt;fail&#40; $message &#41;
***************
*** 285,291 ****
     my $self = shift;
     my &#40; $message &#41; = @_;
  
!    die Parser::MGC::Failure-&gt;new&#40; $message, $self-&gt;where &#41;;
  }
  
  =head2 $eos = $parser-&gt;at_eos
--- 273,280 ----
     my $self = shift;
     my &#40; $message &#41; = @_;
  
!    die Parser::MGC::Failure-&gt;new&#40; $message, $self-&gt;{str}, pos&#40;$self-&gt;{str}&#41;,
! 								  $self-&gt;{filename} &#41;;
  }
  
  =head2 $eos = $parser-&gt;at_eos
***************
*** 880,885 ****
--- 869,893 ----
     return $kw;
  }
  
+ sub _where {
+    my&#40;$str, $pos&#41; = @_;
+ 
+    my $sol = $pos;
+    $sol-- if $sol &gt; 0 and substr&#40; $str, $sol, 1 &#41; =~ m/^[\r\n]$/;
+    $sol-- while $sol &gt; 0 and substr&#40; $str, $sol-1, 1 &#41; !~ m/^[\r\n]$/;
+ 
+    my $eol = $pos;
+    $eol++ while $eol &lt; length&#40;$str&#41; and substr&#40; $str, $eol, 1 &#41; !~ m/^[\r\n]$/;
+ 
+    my $line = substr&#40; $str, $sol, $eol - $sol &#41;;
+ 
+    my $col = $pos - $sol;
+    my $lineno = &#40; &#40;&#41; = substr&#40; $str, 0, $pos &#41; =~ m/\n/g &#41; + 1;
+ 
+    return &#40; $lineno, $col, $line &#41;;
+ }
+ 
+ 
  package # hide from indexer
     Parser::MGC::Failure;
  
***************
*** 887,893 ****
  {
     my $class = shift;
     my $self = bless {}, $class;
!    @{$self}{qw&#40; message linenum col text &#41;} = @_;
     return $self;
  }
  
--- 895,901 ----
  {
     my $class = shift;
     my $self = bless {}, $class;
!    @{$self}{qw&#40; message str pos filename &#41;} = @_;
     return $self;
  }
  
***************
*** 895,910 ****
  sub STRING
  {
     my $self = shift;
  
     # Column number only counts characters. There may be tabs in there.
     # Rather than trying to calculate the visual column number, just print the
     # indentation as it stands.
  
!    my $indent = substr&#40; $self-&gt;{text}, 0, $self-&gt;{col} &#41;;
     $indent =~ s/[^ \t]/ /g; # blank out all the non-whitespace
  
!    return &#34;$self-&gt;{message} on line $self-&gt;{linenum} at:\n&#34; . 
!           &#34;$self-&gt;{text}\n&#34; . 
            &#34;$indent^\n&#34;;
  }
  
--- 903,927 ----
  sub STRING
  {
     my $self = shift;
+    
+    # compute where only when generating the error message, not when fail&#40;&#41;
+    # is called, as it is an expensive operation and not needed if we are just
+    # backtracking
+    
+    my&#40;$linenum, $col, $text&#41; = Parser::MGC::_where&#40;@{$self}{qw&#40; str pos &#41;}&#41;;
  
     # Column number only counts characters. There may be tabs in there.
     # Rather than trying to calculate the visual column number, just print the
     # indentation as it stands.
  
!    my $indent = substr&#40; $text, 0, $col &#41;;
     $indent =~ s/[^ \t]/ /g; # blank out all the non-whitespace
  
!    return &#34;$self-&gt;{message} on &#34;.
!           &#40;defined&#40;$self-&gt;{filename}&#41; &#38;&#38; ! ref&#40;$self-&gt;{filename}&#41;
! 				? $self-&gt;{filename}.&#34; &#34; : &#34;&#34;&#41;.
! 		  &#34;line $linenum at:\n&#34; . 
!           &#34;$text\n&#34; . 
            &#34;$indent^\n&#34;;
  }
  
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> xxerror.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w

use strict;

use Test::More tests =&gt; 7;

package TestParser;
use base qw&#40; Parser::MGC &#41;;

sub parse
{
   my $self = shift;

   return $self-&gt;token_int;
}

package main;

my $parser = TestParser-&gt;new;

isa_ok&#40; $parser, &#34;TestParser&#34;, &#39;$parser&#39; &#41;;
isa_ok&#40; $parser, &#34;Parser::MGC&#34;, &#39;$parser&#39; &#41;;

my $value = $parser-&gt;from_string&#40; &#34;\t123&#34; &#41;;

is&#40; $value, 123, &#39;-&gt;from_string&#39; &#41;;

eval { $parser-&gt;from_string&#40; &#34;\t123.&#34; &#41; };
is&#40; $@, &#34;Expected end of input on line 1 at:\n&#34;.
        &#34;\t123.\n&#34;.
		&#34;\t   ^\n&#34;, &#39;error with no file&#39; &#41;;

eval { $parser-&gt;from_file&#40; \*DATA &#41; };
is&#40; $@, &#34;Expected end of input on line 1 at:\n&#34;.
        &#34; 123.\n&#34;.
		&#34;    ^\n&#34;, &#39;error with glob file&#39; &#41;;

my $tmpfile = &#34;test_error.tmp&#34;;
ok&#40; open&#40;my $fh, &#34;&gt;&#34;, $tmpfile&#41;, &#34;create $tmpfile&#34; &#41;;
print $fh &#34; 123.\n&#34;;
close $fh;

eval { $parser-&gt;from_file&#40; $tmpfile &#41; };
is&#40; $@, &#34;Expected end of input on $tmpfile line 1 at:\n&#34;.
        &#34; 123.\n&#34;.
		&#34;    ^\n&#34;, &#39;error with glob file&#39; &#41;;

__DATA__
 123.
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;22&nbsp;16:12:57&nbsp;2011</span>
    <span class="description">PSCUST [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">xxerror.t had a bug... temp file not removed. Fixed.

On Tue Mar 22 16:04:09 2011, PSCUST wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  The xxerror.t tests this feature.
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> xxerror.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w

use strict;

use Test::More tests =&gt; 7;

package TestParser;
use base qw&#40; Parser::MGC &#41;;

sub parse
{
   my $self = shift;

   return $self-&gt;token_int;
}

package main;

my $parser = TestParser-&gt;new;

isa_ok&#40; $parser, &#34;TestParser&#34;, &#39;$parser&#39; &#41;;
isa_ok&#40; $parser, &#34;Parser::MGC&#34;, &#39;$parser&#39; &#41;;

my $value = $parser-&gt;from_string&#40; &#34;\t123&#34; &#41;;

is&#40; $value, 123, &#39;-&gt;from_string&#39; &#41;;

eval { $parser-&gt;from_string&#40; &#34;\t123.&#34; &#41; };
is&#40; $@, &#34;Expected end of input on line 1 at:\n&#34;.
        &#34;\t123.\n&#34;.
		&#34;\t   ^\n&#34;, &#39;error with no file&#39; &#41;;

eval { $parser-&gt;from_file&#40; \*DATA &#41; };
is&#40; $@, &#34;Expected end of input on line 1 at:\n&#34;.
        &#34; 123.\n&#34;.
		&#34;    ^\n&#34;, &#39;error with glob file&#39; &#41;;

my $tmpfile = &#34;test_error.tmp&#34;;
ok&#40; open&#40;my $fh, &#34;&gt;&#34;, $tmpfile&#41;, &#34;create $tmpfile&#34; &#41;;
print $fh &#34; 123.\n&#34;;
close $fh;

eval { $parser-&gt;from_file&#40; $tmpfile &#41; };
is&#40; $@, &#34;Expected end of input on $tmpfile line 1 at:\n&#34;.
        &#34; 123.\n&#34;.
		&#34;    ^\n&#34;, &#39;error with glob file&#39; &#41;;

unlink $tmpfile;

__DATA__
 123.
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;22&nbsp;16:12:58&nbsp;2011</span>
    <span class="description">PSCUST [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;23&nbsp;07:02:42&nbsp;2011</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Mar 22 16:04:09 2011, PSCUST wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The fail&#40;&#41; method calls where&#40;&#41; to extract the current line number and 
&gt; the whole line where the error occurred. This information is needed 
</div>for 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; showing an error message to the user, but most times the error raised 
</div>by 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; fail&#40;&#41; is captured and used for backtracking.
&gt; 
&gt; The fact that where&#40;&#41; is called unnecessarily causes a performance 
</div>hit. 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There is a huge performance increase by postponing where&#40;&#41; to when an 
&gt; error message needs to be generated.
&gt; 
&gt; On a test program parsing a real program file of about 128K bytes, I 
</div>got 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; the following elapsed times:
&gt; 
&gt; 13.97 s in the original 0.07 version of the module
&gt;  1.77 s with the attached modification
</div>
Ah yes, an excellent idea.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The patch also adds the file name to the error message, in case 
&gt; from_file&#40;&#41; was called. This seams to be the intent of the &#39;filename&#39; 
&gt; attribute, but it is not used. The xxerror.t tests this feature.
</div>
Also noted.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please feel free to include the patch in a next version of the module, 
&gt; or to do something completely different.
</div>
Thanks for those.

I&#39;ve found a slightly neater way to do the first bit of logic, but 
should be mostly the same in practice. Have also included your second 
change.

Find attached the actual patch now committed, which will be in 0.08.

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt66786.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== modified file &#39;Build.PL&#39;
--- Build.PL	2010-12-12 15:34:23 +0000
+++ Build.PL	2011-03-23 10:58:40 +0000
@@ -9,6 +9,7 @@
       &#39;File::Slurp&#39; =&gt; 0,
    },
    build_requires =&gt; {
+      &#39;File::Temp&#39; =&gt; 0,
       &#39;Test::More&#39; =&gt; 0,
    },
    license =&gt; &#39;perl&#39;,

=== modified file &#39;lib/Parser/MGC.pm&#39;
--- lib/Parser/MGC.pm	2011-03-23 10:45:43 +0000
+++ lib/Parser/MGC.pm	2011-03-23 10:50:45 +0000
@@ -287,7 +287,7 @@
    my $self = shift;
    my &#40; $message &#41; = @_;
 
-   die Parser::MGC::Failure-&gt;new&#40; $message, $self, pos&#40;$self-&gt;{str}&#41; &#41;;
+   die Parser::MGC::Failure-&gt;new&#40; $message, $self, pos&#40;$self-&gt;{str}&#41;, $self-&gt;{filename} &#41;;
 }
 
 =head2 $eos = $parser-&gt;at_eos
@@ -897,7 +897,7 @@
 {
    my $class = shift;
    my $self = bless {}, $class;
-   @{$self}{qw&#40; message parser pos &#41;} = @_;
+   @{$self}{qw&#40; message parser pos filename &#41;} = @_;
    return $self;
 }
 
@@ -915,7 +915,11 @@
    my $indent = substr&#40; $text, 0, $col &#41;;
    $indent =~ s/[^ \t]/ /g; # blank out all the non-whitespace
 
-   return &#34;$self-&gt;{message} on line $linenum at:\n&#34; . 
+   my $in_file = &#40; defined $self-&gt;{filename} and !ref $self-&gt;{filename} &#41;
+                 ? &#34;in $self-&gt;{filename} &#34;
+                 : &#34;&#34;;
+
+   return &#34;$self-&gt;{message} ${in_file}on line $linenum at:\n&#34; . 
           &#34;$text\n&#34; . 
           &#34;$indent^\n&#34;;
 }

=== added file &#39;t/32exception.t&#39;
--- t/32exception.t	1970-01-01 00:00:00 +0000
+++ t/32exception.t	2011-03-23 10:58:19 +0000
@@ -0,0 +1,57 @@
+#!/usr/bin/perl -w
+
+use strict;
+
+use Test::More tests =&gt; 9;
+use File::Temp qw&#40; tempfile &#41;;
+
+package TestParser;
+use base qw&#40; Parser::MGC &#41;;
+
+sub parse
+{
+   my $self = shift;
+
+   return $self-&gt;token_int;
+}
+
+package main;
+
+my $parser = TestParser-&gt;new;
+
+isa_ok&#40; $parser, &#34;TestParser&#34;, &#39;$parser&#39; &#41;;
+isa_ok&#40; $parser, &#34;Parser::MGC&#34;, &#39;$parser&#39; &#41;;
+
+my $value = $parser-&gt;from_string&#40; &#34;\t123&#34; &#41;;
+
+is&#40; $value, 123, &#39;-&gt;from_string&#39; &#41;;
+
+ok&#40; !eval { $parser-&gt;from_string&#40; &#34;\t123.&#34; &#41; }, &#39;Trailing input on string fails&#39; &#41;;
+is&#40; $@,
+    qq[Expected end of input on line 1 at:\n].
+    qq[\t123.\n].
+    qq[\t   ^\n],
+    &#39;Exception from trailing input on string&#39; &#41;;
+
+ok&#40; !eval { $parser-&gt;from_file&#40; \*DATA &#41; }, &#39;Trailing input on glob filehandle fails&#39; &#41;;
+is&#40; $@,
+    qq[Expected end of input on line 1 at:\n].
+    qq[ 123.\n].
+    qq[    ^\n],
+    &#39;Exception from trailing input on glob filehandle&#39; &#41;;
+
+my &#40; $fh, $filename &#41; = tempfile&#40; &#34;tmpfile.XXXXXX&#34;, UNLINK =&gt; 1 &#41;;
+END { defined $filename and unlink $filename }
+
+print $fh &#34; 123.\n&#34;;
+close $fh;
+
+ok&#40; !eval { $parser-&gt;from_file&#40; $filename &#41; }, &#39;Trailing input on named file fails&#39; &#41;;
+is&#40; $@,
+    qq[Expected end of input in $filename on line 1 at:\n].
+    qq[ 123.\n].
+    qq[    ^\n],
+    &#39;Exception from trailing input on named file&#39; &#41;;
+
+__DATA__
+ 123.

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;23&nbsp;07:02:43&nbsp;2011</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;23&nbsp;07:04:01&nbsp;2011</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Mar 23 07:02:42 2011, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Find attached the actual patch now committed, which will be in 0.08.
</div>
Er.. lets try that again with all the changes this time ;&#41;

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt66786.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== modified file &#39;Build.PL&#39;
--- Build.PL	2010-12-12 15:34:23 +0000
+++ Build.PL	2011-03-23 10:58:40 +0000
@@ -9,6 +9,7 @@
       &#39;File::Slurp&#39; =&gt; 0,
    },
    build_requires =&gt; {
+      &#39;File::Temp&#39; =&gt; 0,
       &#39;Test::More&#39; =&gt; 0,
    },
    license =&gt; &#39;perl&#39;,

=== modified file &#39;lib/Parser/MGC.pm&#39;
--- lib/Parser/MGC.pm	2011-03-20 20:17:25 +0000
+++ lib/Parser/MGC.pm	2011-03-23 10:50:45 +0000
@@ -253,8 +253,10 @@
 sub where
 {
    my $self = shift;
-
-   my $pos = pos $self-&gt;{str};
+   my &#40; $pos &#41; = @_;
+
+   defined $pos or $pos = pos $self-&gt;{str};
+
    my $str = $self-&gt;{str};
 
    my $sol = $pos;
@@ -285,7 +287,7 @@
    my $self = shift;
    my &#40; $message &#41; = @_;
 
-   die Parser::MGC::Failure-&gt;new&#40; $message, $self-&gt;where &#41;;
+   die Parser::MGC::Failure-&gt;new&#40; $message, $self, pos&#40;$self-&gt;{str}&#41;, $self-&gt;{filename} &#41;;
 }
 
 =head2 $eos = $parser-&gt;at_eos
@@ -895,7 +897,7 @@
 {
    my $class = shift;
    my $self = bless {}, $class;
-   @{$self}{qw&#40; message linenum col text &#41;} = @_;
+   @{$self}{qw&#40; message parser pos filename &#41;} = @_;
    return $self;
 }
 
@@ -904,15 +906,21 @@
 {
    my $self = shift;
 
+   my &#40; $linenum, $col, $text &#41; = $self-&gt;{parser}-&gt;where&#40; $self-&gt;{pos} &#41;;
+
    # Column number only counts characters. There may be tabs in there.
    # Rather than trying to calculate the visual column number, just print the
    # indentation as it stands.
 
-   my $indent = substr&#40; $self-&gt;{text}, 0, $self-&gt;{col} &#41;;
+   my $indent = substr&#40; $text, 0, $col &#41;;
    $indent =~ s/[^ \t]/ /g; # blank out all the non-whitespace
 
-   return &#34;$self-&gt;{message} on line $self-&gt;{linenum} at:\n&#34; . 
-          &#34;$self-&gt;{text}\n&#34; . 
+   my $in_file = &#40; defined $self-&gt;{filename} and !ref $self-&gt;{filename} &#41;
+                 ? &#34;in $self-&gt;{filename} &#34;
+                 : &#34;&#34;;
+
+   return &#34;$self-&gt;{message} ${in_file}on line $linenum at:\n&#34; . 
+          &#34;$text\n&#34; . 
           &#34;$indent^\n&#34;;
 }
 

=== added file &#39;t/32exception.t&#39;
--- t/32exception.t	1970-01-01 00:00:00 +0000
+++ t/32exception.t	2011-03-23 10:58:19 +0000
@@ -0,0 +1,57 @@
+#!/usr/bin/perl -w
+
+use strict;
+
+use Test::More tests =&gt; 9;
+use File::Temp qw&#40; tempfile &#41;;
+
+package TestParser;
+use base qw&#40; Parser::MGC &#41;;
+
+sub parse
+{
+   my $self = shift;
+
+   return $self-&gt;token_int;
+}
+
+package main;
+
+my $parser = TestParser-&gt;new;
+
+isa_ok&#40; $parser, &#34;TestParser&#34;, &#39;$parser&#39; &#41;;
+isa_ok&#40; $parser, &#34;Parser::MGC&#34;, &#39;$parser&#39; &#41;;
+
+my $value = $parser-&gt;from_string&#40; &#34;\t123&#34; &#41;;
+
+is&#40; $value, 123, &#39;-&gt;from_string&#39; &#41;;
+
+ok&#40; !eval { $parser-&gt;from_string&#40; &#34;\t123.&#34; &#41; }, &#39;Trailing input on string fails&#39; &#41;;
+is&#40; $@,
+    qq[Expected end of input on line 1 at:\n].
+    qq[\t123.\n].
+    qq[\t   ^\n],
+    &#39;Exception from trailing input on string&#39; &#41;;
+
+ok&#40; !eval { $parser-&gt;from_file&#40; \*DATA &#41; }, &#39;Trailing input on glob filehandle fails&#39; &#41;;
+is&#40; $@,
+    qq[Expected end of input on line 1 at:\n].
+    qq[ 123.\n].
+    qq[    ^\n],
+    &#39;Exception from trailing input on glob filehandle&#39; &#41;;
+
+my &#40; $fh, $filename &#41; = tempfile&#40; &#34;tmpfile.XXXXXX&#34;, UNLINK =&gt; 1 &#41;;
+END { defined $filename and unlink $filename }
+
+print $fh &#34; 123.\n&#34;;
+close $fh;
+
+ok&#40; !eval { $parser-&gt;from_file&#40; $filename &#41; }, &#39;Trailing input on named file fails&#39; &#41;;
+is&#40; $@,
+    qq[Expected end of input in $filename on line 1 at:\n].
+    qq[ 123.\n].
+    qq[    ^\n],
+    &#39;Exception from trailing input on named file&#39; &#41;;
+
+__DATA__
+ 123.

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;23&nbsp;07:04:01&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;23&nbsp;07:05:03&nbsp;2011</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;23&nbsp;16:43:55&nbsp;2011</span>
    <span class="description">pauloscustodio [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66786] Performance: where&#40;&#41; called by fail&#40;&#41; when backtracking</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 23 Mar 2011 20:40:11 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Parser-MGC [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Paulo Custodio &lt;pauloscustodio [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks, it worked. It is even quicker than my patch, the same test now takes
1.32 seconds. I think the reason is that I was passing the big &#39;str&#39; as
argument to Parser::MGC::Failure-&gt;new&#40;&#41;. Passing just the reference to the
Parser object is quicker.

BTW, why did you pass also &#39;filename&#39; to the Failure constructor? It is also
available at the parser object.

Best regards,
Paulo Custodio
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;23&nbsp;16:43:56&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;23&nbsp;18:14:51&nbsp;2011</span>
    <span class="description">pauloscustodio [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66786] Performance: where&#40;&#41; called by fail&#40;&#41; when backtracking</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 23 Mar 2011 22:14:22 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Parser-MGC [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Paulo Custodio &lt;pauloscustodio [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Another note: the time spent in wkip_ws can be reduced to about half
by computing a &#39;skip&#39; pattern at the constructor that combines the
&#39;ws&#39; and &#39;comment&#39; patterns, and replace the &#39;1 while m//&#39; by just a
match on &#39;skip&#39;.

In a test script it reduced the time spent in the skip_ws method
&#40;exclusive time&#41; from 4.57s to 2.59s, as reported by Devel::NYTProf.

Best regards,
Paulo Custodio
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;08&nbsp;09:50:37&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Mar 23 18:14:51 2011, pauloscustodio@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Another note: the time spent in wkip_ws can be reduced to about half
&gt; by computing a &#39;skip&#39; pattern at the constructor that combines the
&gt; &#39;ws&#39; and &#39;comment&#39; patterns, and replace the &#39;1 while m//&#39; by just a
&gt; match on &#39;skip&#39;.
</div>
I&#39;ve moved this comment into a new bug

  <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=74779">https://rt.cpan.org/Ticket/Display.html?id=74779</a></span>

I can now close this one.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;08&nbsp;09:50:39&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;08&nbsp;09:51:23&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Fixed in 0.08 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
