<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #80395 for XML-LibXML: removeChild&#40;&#41; segfaults when not expanding entities</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #80395 for XML-LibXML: removeChild&#40;&#41; segfaults when not expanding entities</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/XML-LibXML/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-LibXML">XML-LibXML CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">80395</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/XML-LibXML/Active/">XML-LibXML</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
GUIDO [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-37350-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
1.90</li>
<li>
1.91</li>
<li>
1.92</li>
<li>
1.93</li>
<li>
1.94</li>
<li>
1.95</li>
<li>
1.96</li>
<li>
1.97</li>
<li>
1.98</li>
<li>
1.99</li>
<li>
2.0000</li>
<li>
2.0001</li>
<li>
2.0002</li>
<li>
2.0003</li>
<li>
2.0004</li>
<li>
2.0005</li>
<li>
2.0006</li>
<li>
2.0007</li>
<li>
2.0008</li>
</ul>
    </td>
  </tr>
  <tr id="CF-37351-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;25&nbsp;12:46:36&nbsp;2012</span>
    <span class="description">GUIDO [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> removeChild&#40;&#41; segfaults when not expanding entities</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"># This script segfaults:

use strict;

use XML::LibXML;

my $xml = &lt;&lt;EOF;
&lt;!DOCTYPE bug [
&lt;!ENTITY myent &#34;xyz&#34;&gt;
]&gt;
&lt;bug&gt;
  &lt;elem&gt;&#38;myent;&lt;/elem&gt;
&lt;/bug&gt;
EOF

my $dom = XML::LibXML-&gt;load_xml &#40;string =&gt; $xml,
                                 expand_entities =&gt; 0&#41;;
my $root = $dom-&gt;documentElement;

my @nodes = $root-&gt;childNodes;
foreach my $node &#40;@nodes&#41; {
    next if $node-&gt;nodeType != XML_ELEMENT_NODE;
    next if $node-&gt;nodeName ne &#39;elem&#39;;

    $root-&gt;removeChild &#40;$node&#41;;
}
__END__

The script doesn&#39;t crash if you do one of the following:

- set expand_entities to 1
- do not use the entity &#38;myent;
- instead of &#38;myent; use &#38;amp; &#40;or &#38;lt;, &#38;gt; ...&#41;

In dom.c, at one point the function _domReconileNS&#40;&#41; gets called with a
tree argument where tree-&gt;ns is not NULL but tree-&gt;ns-&gt;prefix is either
NULL or points to lala-land.

In the above script, the pointer is NULL.  But with a more complicated
XML document, tree-&gt;ns-&gt;prefix pointed to an address beyond the end of
the virtual RAM.  That means that it is not sufficient to extend the
check to

    if &#40;tree-&gt;ns != NULL &#38;&#38; tree-&gt;ns-&gt;prefix != NULL&#41;

That just fixes the test case but the crash still happens with my &#34;real&#34;
data.

The bug occurred on Gentoo x86_64 with version 1.9000 but also with
version 2.0008.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;27&nbsp;06:59:25&nbsp;2012</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi GUIDO,

On Thu Oct 25 12:46:36 2012, GUIDO wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; # This script segfaults:
&gt; 
&gt; use strict;
&gt; 
&gt; use XML::LibXML;
&gt; 
&gt; my $xml = &lt;&lt;EOF;
&gt; &lt;!DOCTYPE bug [
&gt; &lt;!ENTITY myent &#34;xyz&#34;&gt;
&gt; ]&gt;
&gt; &lt;bug&gt;
&gt;   &lt;elem&gt;&#38;myent;&lt;/elem&gt;
&gt; &lt;/bug&gt;
&gt; EOF
&gt; 
&gt; my $dom = XML::LibXML-&gt;load_xml &#40;string =&gt; $xml,
&gt;                                  expand_entities =&gt; 0&#41;;
&gt; my $root = $dom-&gt;documentElement;
&gt; 
&gt; my @nodes = $root-&gt;childNodes;
&gt; foreach my $node &#40;@nodes&#41; {
&gt;     next if $node-&gt;nodeType != XML_ELEMENT_NODE;
&gt;     next if $node-&gt;nodeName ne &#39;elem&#39;;
&gt; 
&gt;     $root-&gt;removeChild &#40;$node&#41;;
&gt; }
&gt; __END__
&gt; 
&gt; The script doesn&#39;t crash if you do one of the following:
&gt; 
&gt; - set expand_entities to 1
&gt; - do not use the entity &#38;myent;
&gt; - instead of &#38;myent; use &#38;amp; &#40;or &#38;lt;, &#38;gt; ...&#41;
&gt; 
</div>
I can reproduce it here.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In dom.c, at one point the function _domReconileNS&#40;&#41; gets called with a
&gt; tree argument where tree-&gt;ns is not NULL but tree-&gt;ns-&gt;prefix is either
&gt; NULL or points to lala-land.
</div>
Why is this the case? Do you know whether it&#39;s a bug in XML::LibXML or
in libxml2?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; In the above script, the pointer is NULL.  But with a more complicated
&gt; XML document, tree-&gt;ns-&gt;prefix pointed to an address beyond the end of
&gt; the virtual RAM.  That means that it is not sufficient to extend the
&gt; check to
&gt; 
&gt;     if &#40;tree-&gt;ns != NULL &#38;&#38; tree-&gt;ns-&gt;prefix != NULL&#41;
&gt; 
&gt; That just fixes the test case but the crash still happens with my &#34;real&#34;
&gt; data.
</div>
Doing this both neither fixes the test case, and also introduces a
regression in a previous test in the test suite:

t/10ns.t                           &#40;Wstat: 256 Tests: 129 Failed: 1&#41;
  Failed test:  110
  Non-zero exit status: 1

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; The bug occurred on Gentoo x86_64 with version 1.9000 but also with
&gt; version 2.0008.
</div>
OK.

Regards,

-- Shlomi Fish
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;27&nbsp;06:59:28&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;29&nbsp;03:49:50&nbsp;2012</span>
    <span class="description">GUIDO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Shlomi,

thanks for the quick reaction.

On Sat Oct 27 06:59:25 2012, SHLOMIF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi GUIDO,
&gt; 
&gt; On Thu Oct 25 12:46:36 2012, GUIDO wrote:
<div class="message-stanza open">&gt; &gt; In dom.c, at one point the function _domReconileNS&#40;&#41; gets called with a
&gt; &gt; tree argument where tree-&gt;ns is not NULL but tree-&gt;ns-&gt;prefix is either
&gt; &gt; NULL or points to lala-land.
</div>&gt; 
&gt; Why is this the case? Do you know whether it&#39;s a bug in XML::LibXML or
&gt; in libxml2?
</div>
Hard to say, when removeChild&#40;&#41; is not present in libxml2.  But it&#39;s
definetely one that has to be debugged in XML::LibXML first.  Even if it
is a bug in libxml2, we still don&#39;t know which usage in XML::LibXML
causes it.

Regards,
Guido
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;29&nbsp;11:43:21&nbsp;2012</span>
    <span class="description">GUIDO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The problem is that _domReconcileNs&#40;&#41; unreferences the ns member of
xmlNodePtr for all node types it encounters but it is only valid for
element and attribute nodes.

The attached patch fixes that.  All tests succeded here with the patch
applied.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> xml-libxml-reconcile-ns.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ur XML-LibXML-2.0008.orig/dom.c XML-LibXML-2.0008.gfl/dom.c
--- XML-LibXML-2.0008.orig/dom.c	2012-08-09 10:43:13.000000000 +0300
+++ XML-LibXML-2.0008.gfl/dom.c	2012-10-29 16:55:04.000000000 +0200
@@ -172,7 +172,9 @@
 void
 _domReconcileNs&#40;xmlNodePtr tree, xmlNsPtr * unused&#41;
 {
-        if&#40; tree-&gt;ns != NULL &#41;
+        if&#40; tree-&gt;ns != NULL
+           &#38;&#38; &#40;tree-&gt;type == XML_ELEMENT_NODE 
+               || tree-&gt;type == XML_ATTRIBUTE_NODE&#41;&#41;
         {
                 xmlNsPtr ns = xmlSearchNs&#40; tree-&gt;doc, tree-&gt;parent, tree-&gt;ns-&gt;prefix &#41;;
                 if&#40; ns != NULL &#38;&#38; ns-&gt;href != NULL &#38;&#38; tree-&gt;ns-&gt;href != NULL &#38;&#38;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;07&nbsp;16:11:43&nbsp;2012</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

sorry for the late response - I was preoccupied with other things. I
have applied a variation of your patch now in the Mercurial repository,
and it will be part of a new release &#40;with a test&#41;. I&#39;ll make the new
release - XML-LibXML-2.0011 &#40;or maybe XML-LibXML-2.0100&#41; once I have
looked at this bug report:

<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=80521">https://rt.cpan.org/Ticket/Display.html?id=80521</a></span>

Regards,

-- Shlomi Fish
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;07&nbsp;18:02:43&nbsp;2012</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Nov 07 16:11:43 2012, SHLOMIF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; sorry for the late response - I was preoccupied with other things. I
&gt; have applied a variation of your patch now in the Mercurial repository,
&gt; and it will be part of a new release &#40;with a test&#41;. I&#39;ll make the new
&gt; release - XML-LibXML-2.0011 &#40;or maybe XML-LibXML-2.0100&#41; once I have
&gt; looked at this bug report:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=80521">https://rt.cpan.org/Ticket/Display.html?id=80521</a></span>
&gt; 
&gt; Regards,
&gt; 
&gt; -- Shlomi Fish
</div>
Fixed in 2.0011, which was uploaded to CPAN. Thanks!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;07&nbsp;18:02:45&nbsp;2012</span>
    <span class="description">SHLOMIF [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
