<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #93307 for JSON-XS: Locale problem with JSON::XS in bleadperl</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #93307 for JSON-XS: Locale problem with JSON::XS in bleadperl</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=JSON-XS">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=JSON-XS">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=JSON-XS">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=JSON-XS">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/JSON-XS">JSON-XS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">93307</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=JSON-XS">JSON-XS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
calle [...] lysator.liu.se

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
ether [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-42890-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-42891-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




bugtest.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1344286/713364/bugtest.pl">
Fri Mar 28 03:41:15 2014 (360b) by calle [...] lysator.liu.se
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=93307">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1330248" href="/Public/Bug/Display.html?id=93307#txn-1330248">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;24&nbsp;05:38:44&nbsp;2014</span>
    <span class="description">calle [...] lysator.liu.se -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Locale problem with JSON::XS in bleadperl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1330248/705666/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/705666">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 485b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Commit bc8ec7cc020d0562094a551b280fd3f32bf5eb04 to Perl &#40;included in versions 5.19.8 and 5.19.9&#41; causes JSON::XS to emit JSON that is affected by the setting of the LC_NUMERIC environment variable. With the variable set to, for example, sv_SE.UTF-8 on OSX the produced JSON has commas instead of points in floating-point numbers. This, obviously, results in invalid JSON that cannot later be decoded.

I&#39;m not sure if this is a bug in Perl, or a change that JSON::XS needs to adapt to.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1343497" href="/Public/Bug/Display.html?id=93307#txn-1343497">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;26&nbsp;12:46:27&nbsp;2014</span>
    <span class="description">wyant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1343497/712961/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/712961">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Feb 24 05:38:44 2014, CDYBED wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Commit bc8ec7cc020d0562094a551b280fd3f32bf5eb04 to Perl &#40;included in
&gt; versions 5.19.8 and 5.19.9&#41; causes JSON::XS to emit JSON that is
&gt; affected by the setting of the LC_NUMERIC environment variable. With
&gt; the variable set to, for example, sv_SE.UTF-8 on OSX the produced JSON
&gt; has commas instead of points in floating-point numbers. This,
&gt; obviously, results in invalid JSON that cannot later be decoded.
&gt; 
&gt; I&#39;m not sure if this is a bug in Perl, or a change that JSON::XS needs
&gt; to adapt to.
</div>
Just to cross-reference: The Perl ticket you submitted is <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/Ticket/Display.html?id=121317">https://rt.perl.org/Ticket/Display.html?id=121317</a></span>

And to note the problem still exists in 5.19.10.

Thing is, discussion there &#40;which is still going on&#41; seems to be whether JSON::XS is using an undocumented interface &#40;which divides into two sub-groups, &#34;... and they shouldn&#39;t do that&#34; and &#34;... but we shouldn&#39;t break existing code&#34;&#41;, or whether JSON::XS was broken all along and the change to Perl only exposed the problem.

Wish I had enough XS-fu to come up with a patch to JSON::XS. I&#39;d feel a lot better about the whole situation.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1343498" href="/Public/Bug/Display.html?id=93307#txn-1343498">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;26&nbsp;12:46:28&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1343520" href="/Public/Bug/Display.html?id=93307#txn-1343520">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;26&nbsp;13:44:04&nbsp;2014</span>
    <span class="description">calle [...] lysator.liu.se -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1343520/712976/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/712976">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thing is, discussion there &#40;which is still going on&#41; seems to be
&gt; whether JSON::XS is using an undocumented interface &#40;which divides
&gt; into two sub-groups, &#34;... and they shouldn&#39;t do that&#34; and &#34;... but we
&gt; shouldn&#39;t break existing code&#34;&#41;, or whether JSON::XS was broken all
&gt; along and the change to Perl only exposed the problem.
</div>
Here is a summary of the situation, as I&#39;ve understood it from following p5p:

* JSON::XS is one of a number of CPAN modules that use the macro Gconvert.

* Gconvert is semi-public, in that it is not in perlapi but it is in some other API documentation.

* Gconvert is implemented by calling system functions that on most platforms obey locale rules. This means that it has always had the potential to produce strings with decimal-comma instead of decimal-point.

* What happened in the commit mentioned in my bug report was that Perl started calling setlocale&#40;&#41; predictably at startup. That means that when run in locales with decimal-comma Gconvert will emit such strings all the time rather than very rarely.

* This is listed as a blocking bug for the Perl 5.20 release.

* The suggested solution is to split Gconvert into two macros, one that follows locale rules and one that ignores them. These macros will be documented in perlapi as parts of the public XS API. Backwards compatibility will be provided via ppport.h

* For JSON::XS this means that after Perl 5.20 is released, a new version of JSON::XS should be released the uses the new, documented interface instead of Gconvert. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1343902" href="/Public/Bug/Display.html?id=93307#txn-1343902">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;27&nbsp;11:04:25&nbsp;2014</span>
    <span class="description">schmorp [...] schmorp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #93307] Locale problem with JSON::XS in bleadperl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 27 Mar 2014 16:04:11 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Tom Wyant via RT &lt;bug-JSON-XS [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marc Lehmann &lt;schmorp [...] schmorp.de&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1343902/713185/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/713185">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Mar 26, 2014 at 12:46:28PM -0400, Tom Wyant via RT &lt;bug-JSON-XS@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; And to note the problem still exists in 5.19.10.
&gt; 
&gt; Thing is, discussion there &#40;which is still going on&#41; seems to be whether JSON::XS is using an undocumented interface &#40;which divides into two sub-groups, &#34;... and they shouldn&#39;t do that&#34; and &#34;... but we shouldn&#39;t break existing code&#34;&#41;, or whether JSON::XS was broken all along and the change to Perl only exposed the problem.
</div>
It&#39;s part of the public external interface. If you could only use the
documented interface then most XS modules would be impossible to write, as
perl&#39;s documentation was and always has been incomplete.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Wish I had enough XS-fu to come up with a patch to JSON::XS. I&#39;d feel a lot better about the whole situation.
</div>
I wish it were possible to patch JSON::XS.

The talk about undocumented interfaces is bullshit, of course - the real
issue is perl breaking backwards compatibility, as guaranteed by perlpolicy
and common sense.

p5p *need* to stop breaking large parts of CPAN in every relase, or at
least update perlpolicy to honestly say that backwards compatibility is
a non-goal, in which I will happily stop supporting newer perl versions
in my modules, something that I am close to do, because I simply cannot
keep up with the breakage introduced by p5p and the dishonest claims of
backwards compatibility when every regression I report is effectively
ignored.

-- 
                The choice of a       Deliantra, the free code+content MORPG
      -----==-     _GNU_              <span class="clickylink"><a target="new" rel="nofollow" href="http://www.deliantra.net">http://www.deliantra.net</a></span>
      ----==-- _       generation
      ---==---&#40;_&#41;__  __ ____  __      Marc Lehmann
      --==---/ / _ \/ // /\ \/ /      schmorp@schmorp.de
      -=====/_/_//_/\_,_/ /_/\_\
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1344286" href="/Public/Bug/Display.html?id=93307#txn-1344286">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;28&nbsp;03:41:15&nbsp;2014</span>
    <span class="description">calle [...] lysator.liu.se -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1344286/713363/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/713363">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 253b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is a short script that demonstrates the problem &#40;you may have to edit it to use a suitable locale for your machine&#41;. A quick test with the Perl versions I have installed at the moment shows the problem appearing somewhere between 5.14.4 and 5.16.3.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> bugtest.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1344286/713364/bugtest.pl">Download bugtest.pl</a><br />
<span class="downloadcontenttype">text/x-perl 360b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl

use strict;
use warnings;

use POSIX qw[setlocale LC_NUMERIC];
BEGIN { setlocale&#40; LC_NUMERIC, &#39;sv_SE.UTF-8&#39; &#41; }
use JSON::XS;

my $json = encode_json&#40;{ foo =&gt; 1.23}&#41;;

if &#40;$json eq &#39;{&#34;foo&#34;:1.23}&#39;&#41; {
    print &#34;OK\n&#34;;
    exit 1;
}
elsif &#40;$json eq &#39;{&#34;foo&#34;:1,23}&#39;&#41; {
    print &#34;NOT OK\n&#34;;
    exit 0;
}
else {
    print &#34;Weird: $json\n&#34;;
}

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1344445" href="/Public/Bug/Display.html?id=93307#txn-1344445">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;28&nbsp;11:14:23&nbsp;2014</span>
    <span class="description">schmorp [...] schmorp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #93307] Locale problem with JSON::XS in bleadperl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 28 Mar 2014 16:14:12 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Calle Dybedahl via RT &lt;bug-JSON-XS [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marc Lehmann &lt;schmorp [...] schmorp.de&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1344445/713453/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/713453">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Mar 28, 2014 at 03:41:16AM -0400, Calle Dybedahl via RT &lt;bug-JSON-XS@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Here is a short script that demonstrates the problem &#40;you may have to edit it to use a suitable locale for your machine&#41;. A quick test with the Perl versions I have installed at the moment shows the problem appearing somewhere between 5.14.4 and 5.16.3.
</div>
That&#39;s not the real problem. At least up to 5.18, calling POSIX::setlocale
enabling LC_NUMERIC causes a lot of issues with perl itself &#40;and the
effect on JSON::XS is documented&#41;. For example, in 5.18, this would not
work as expected by a lot of code, printing 1 instead of 1.2:

   my $x = 0.2;
   print &#34;$x&#34;+1;

So locale breaking perl code is not a new thing. Superficially, the above
is a bug in perl, as there is no such thing as a string type or a number
type, so the stringified form must work correctly as a number.

And it&#39;s quite obvious, some vague statements to the contrary, that perl
numbers must stringify with &#34;.&#34;, as witnessed by perlfaq4 for example,
which also breaks down:

   when&#40; /^-?&#40;?:\d+\.?|\.\d&#41;\d*\z/ &#41;
       { say &#34;\tis a real number&#34;; continue }
   when&#40; /^[+-]?&#40;?=\.?\d&#41;\d*\.?\d*&#40;?:e[+-]?\d+&#41;?\z/i&#41;
       { say &#34;\tis a C float&#34; }

The assumption that numbers stringify in a way compatible to source code
is deeply ingrained, and also very useful.

Of course, it&#39;s understandable that perl worked like this for, like 20+
years: changing the locale around stringifying numbers is not thread safe,
and very slow &#40;I hope perl doesn&#39;t try to do that in 5.20, thraeds are too
useful to be ruled out by perl&#41;, and converting floating point numbers
yourself is not possible in portable code, so you are stuck with the libc,
which heeds the locale.

So while the real problem is the unusability if locales to solve real
problems, this problem cannot be solved.

That leaves us with perl creating such problems on it&#39;s own, and that is
perl enabling the LC_NUMERIC category with &#34;use locale&#34; now apparently. Or
something else to the extent. I mean, perl itself didn&#39;t work correctly
for all of its life, so why not enable it, because surely, everybody elses
code is magically going to cope with the very same problem that perl
didn&#39;t for decades.

In fact, I do not care much about what causes the problem, I do care that
basically all my bugreports about such regressions are met with either
uncivil and/or bullshit answers, or outright denial that the problem even exists.

While I will happily explain problems and report bugs, I have given up on
trying to reason with p5pers, as they have clearly given up on backwards
compatibility &#40;and in fact, some of the former p5pers have done so, too&#41;.

So, the *real* problem is not that this happens - bugs happen. The *real*
problem is that the bug isn&#39;t immediately fixed, but instead it&#39;s always
such a fight to get regressions acknowledged, so they often end up in
releases, which is then used to argue that backwards compatibility is not
relevant anymore &#40;which gave us, among other things, the unicode mess in
perl&#41;.

-- 
                The choice of a       Deliantra, the free code+content MORPG
      -----==-     _GNU_              <span class="clickylink"><a target="new" rel="nofollow" href="http://www.deliantra.net">http://www.deliantra.net</a></span>
      ----==-- _       generation
      ---==---&#40;_&#41;__  __ ____  __      Marc Lehmann
      --==---/ / _ \/ // /\ \/ /      schmorp@schmorp.de
      -=====/_/_//_/\_,_/ /_/\_\
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1346831" href="/Public/Bug/Display.html?id=93307#txn-1346831">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;04&nbsp;12:44:43&nbsp;2014</span>
    <span class="description">ether [...] cpan.org -  Cc ETHER added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1436299" href="/Public/Bug/Display.html?id=93307#txn-1436299">#</a>      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;24&nbsp;13:46:31&nbsp;2014</span>
    <span class="description">MLEHMANN [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.512089</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
