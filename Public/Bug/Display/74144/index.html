<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #74144 for RT-Extension-LDAPImport: LDAP values should be decoded as UTF-8 upon fetch</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #74144 for RT-Extension-LDAPImport: LDAP values should be decoded as UTF-8 upon fetch</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/RT-Extension-LDAPImport/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/RT-Extension-LDAPImport/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/RT-Extension-LDAPImport/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/RT-Extension-LDAPImport/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/RT-Extension-LDAPImport">RT-Extension-LDAPImport CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">74144</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/RT-Extension-LDAPImport/Active/">RT-Extension-LDAPImport</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
BHEISIG [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-44500-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.31    </td>
  </tr>
  <tr id="CF-44501-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;19&nbsp;04:34:05&nbsp;2012</span>
    <span class="description">BHEISIG [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello everyone,

I&#39;ve found an encoding problem inside this extension. Whenever it
receives user information from database, special characters like German
umlauts are not UTF-8 encoded. This causes that each field which
contains special characters will be updated.

After the update there is no encoding problem because the data from LDAP
is encoded in UTF-8, but there is a huge database pollution in the
transaction table. My LDAP synchronization includes ~ 2000 users, most
of them are located in &#34;Düsseldorf&#34; &#40;field &#34;City&#34;&#41;, cron job runs every
15 minutes---imagine how many inserts have been made in the last few
weeks ;-&#41;

Here is what
/opt/rt4/local/plugins/RT-Extension-LDAPImport/bin/rtldapimport --debug
wrote:

City    D�sseldorf =&gt; Düsseldorf

I couldn&#39;t resolv the problem within the extension. So I patched
/opt/rt4/lib/RT/Record.pm &#40;see my attachment&#41;. This works, but looks
like an ugly workaround.

More information about my system:

* RT 4.0.2
* Perl 5.10.1
* Linux debian 2.6.32-5-686 #1 SMP Fri Sep 9 20:51:05 UTC 2011 i686
GNU/Linux

Thank you very much for you help!

    Benjamin Heisig
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Record.pm.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- a/Record.pm	2012-01-19 09:53:56.802582265 +0100
+++ b/Record.pm	2012-01-19 10:00:38.203170994 +0100
@@ -887,10 +887,14 @@
                 my $name = $self-&gt;$object-&gt;Name;
                 next if $name eq $value || $name eq &#40;$value || 0&#41;;
             };
-            next if $value eq $self-&gt;$attribute&#40;&#41;;
-            next if &#40;$value || 0&#41; eq $self-&gt;$attribute&#40;&#41;;
-        };
 
+            my $existing = $self-&gt;$attribute&#40;&#41;;
+            my $current = Encode::encode&#40;&#34;utf8&#34;, $existing&#41;;
+
+            next if Encode::encode&#40;&#34;utf8&#34;, $value&#41; eq $current;
+            next if &#40;$value || 0&#41; eq $current;
+        };
+        
         $new_values{$attribute} = $value;
     }
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;19&nbsp;05:27:18&nbsp;2012</span>
    <span class="description">BHEISIG [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;19&nbsp;09:29:45&nbsp;2012</span>
    <span class="description">BHEISIG [...] cpan.org -  Subject changed from &#40;no value&#41; to &#39;Bad encoded data from database&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;19&nbsp;09:29:45&nbsp;2012</span>
    <span class="description">BHEISIG [...] cpan.org -  Status changed from &#39;open&#39; to &#39;new&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;19&nbsp;13:56:58&nbsp;2012</span>
    <span class="description">tsibley [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #74144]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 19 Jan 2012 13:56:34 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-RT-Extension-LDAPImport [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Thomas Sibley &lt;tsibley [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 01/19/2012 04:34 AM, Benjamin Heisig via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve found an encoding problem inside this extension. Whenever it
&gt; receives user information from database, special characters like German
&gt; umlauts are not UTF-8 encoded. This causes that each field which
&gt; contains special characters will be updated.
&gt; 
&gt; After the update there is no encoding problem because the data from LDAP
&gt; is encoded in UTF-8, but there is a huge database pollution in the
&gt; transaction table. My LDAP synchronization includes ~ 2000 users, most
&gt; of them are located in &#34;Düsseldorf&#34; &#40;field &#34;City&#34;&#41;, cron job runs every
&gt; 15 minutes---imagine how many inserts have been made in the last few
&gt; weeks ;-&#41;
&gt; 
&gt; Here is what
&gt; /opt/rt4/local/plugins/RT-Extension-LDAPImport/bin/rtldapimport --debug
&gt; wrote:
&gt; 
&gt; City    D�sseldorf =&gt; Düsseldorf
</div>
It is very strange to me that RT&#39;s normal API would be returning values
which aren&#39;t utf8.  If that was the case, I wouldn&#39;t expect unicode to
work at all in RT &#40;yet it does just fine&#41;.  I suspect the actual issue
is with the value provided by Net::LDAP.

Can you use Devel::Peek on the two values printed by rtldapimport
--debug and send the output?

Thomas
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;19&nbsp;13:56:59&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;20&nbsp;11:17:23&nbsp;2012</span>
    <span class="description">BHEISIG [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for your reply, Thomas!
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It is very strange to me that RT&#39;s normal API would be returning values
&gt; which aren&#39;t utf8.  If that was the case, I wouldn&#39;t expect unicode to
&gt; work at all in RT &#40;yet it does just fine&#41;.  I suspect the actual issue
&gt; is with the value provided by Net::LDAP.
</div>
Yes, it *is* strange... I could reproduce it on two different systems
&#40;Debian and SLES&#41; with two different LDAP servers &#40;AD&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Can you use Devel::Peek on the two values printed by rtldapimport
&gt; --debug and send the output?
</div>
Here is the output for a user&#39;s &#34;Address1&#34;:

        Address1        H�henstr. 87 =&gt; Höhenstr. 87

The first dump is from $old_value, the second from $user-&gt;{$key}:

SV = PV&#40;0xaae0b80&#41; at 0x9d8f710
  REFCNT = 1
  FLAGS = &#40;PADMY,POK,pPOK,UTF8&#41;
  PV = 0xb6328f0 &#34;H\303\266henstr. 87&#34;\0 [UTF8 &#34;H\x{f6}henstr. 87&#34;]
  CUR = 13
  LEN = 16
SV = PV&#40;0xaae4670&#41; at 0xb664fb8
  REFCNT = 1
  FLAGS = &#40;POK,pPOK&#41;
  PV = 0xb6342d0 &#34;H\303\266henstr. 87&#34;\0
  CUR = 13
  LEN = 16

I hope it helps!

    Benjamin
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;22&nbsp;06:23:58&nbsp;2012</span>
    <span class="description">ruz [...] bestpractical.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #74144] Bad encoded data from database</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 22 Jan 2012 15:23:50 +0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-RT-Extension-LDAPImport [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ruslan Zakirov &lt;ruz [...] bestpractical.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I think from LDAP we get octets, but in RT we should store strings and
get strings from API calls. To get correct comparison we should
upgrade data we get from LDAP to perl strings. Google suggests that
LDAPv3 sends UTF-8, v2 uses some specific format. We can enforce v3 on
anything that has not ASCII data.

On Fri, Jan 20, 2012 at 20:17, Benjamin Heisig via RT
&lt;bug-RT-Extension-LDAPImport@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       Queue: RT-Extension-LDAPImport
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=74144">https://rt.cpan.org/Ticket/Display.html?id=74144</a></span> &gt;
&gt;
&gt; Thanks for your reply, Thomas!
&gt;
<div class="message-stanza open">&gt;&gt; It is very strange to me that RT&#39;s normal API would be returning values
&gt;&gt; which aren&#39;t utf8.  If that was the case, I wouldn&#39;t expect unicode to
&gt;&gt; work at all in RT &#40;yet it does just fine&#41;.  I suspect the actual issue
&gt;&gt; is with the value provided by Net::LDAP.
</div>&gt;
&gt; Yes, it *is* strange... I could reproduce it on two different systems
&gt; &#40;Debian and SLES&#41; with two different LDAP servers &#40;AD&#41;.
&gt;
<div class="message-stanza open">&gt;&gt; Can you use Devel::Peek on the two values printed by rtldapimport
&gt;&gt; --debug and send the output?
</div>&gt;
&gt; Here is the output for a user&#39;s &#34;Address1&#34;:
&gt;
&gt;        Address1        H�henstr. 87 =&gt; Höhenstr. 87
&gt;
&gt; The first dump is from $old_value, the second from $user-&gt;{$key}:
&gt;
&gt; SV = PV&#40;0xaae0b80&#41; at 0x9d8f710
&gt;  REFCNT = 1
&gt;  FLAGS = &#40;PADMY,POK,pPOK,UTF8&#41;
&gt;  PV = 0xb6328f0 &#34;H\303\266henstr. 87&#34;\0 [UTF8 &#34;H\x{f6}henstr. 87&#34;]
&gt;  CUR = 13
&gt;  LEN = 16
&gt; SV = PV&#40;0xaae4670&#41; at 0xb664fb8
&gt;  REFCNT = 1
&gt;  FLAGS = &#40;POK,pPOK&#41;
&gt;  PV = 0xb6342d0 &#34;H\303\266henstr. 87&#34;\0
&gt;  CUR = 13
&gt;  LEN = 16
&gt;
&gt; I hope it helps!
&gt;
&gt;    Benjamin
&gt;
&gt;
</div>


-- 
Best regards, Ruslan.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;23&nbsp;12:04:32&nbsp;2012</span>
    <span class="description">trs [...] bestpractical.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> bug-RT-Authen-ExternalAuth [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #74144] Bad encoded data from database</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 23 Jan 2012 12:04:31 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-RT-Extension-LDAPImport [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Thomas Sibley &lt;trs [...] bestpractical.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 01/22/2012 06:24 AM, Ruslan Zakirov via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think from LDAP we get octets, but in RT we should store strings and
&gt; get strings from API calls. To get correct comparison we should
&gt; upgrade data we get from LDAP to perl strings. Google suggests that
&gt; LDAPv3 sends UTF-8, v2 uses some specific format. We can enforce v3 on
&gt; anything that has not ASCII data.
</div>
This concurs with what I expected was happening.  It&#39;s not RT that needs
encoding, it&#39;s LDAP that needs decoding.

I do wonder if this problem is present in RT-Authen-ExternalAuth as well.

Thomas
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;23&nbsp;12:04:32&nbsp;2012</span>
    <span class="description">trs [...] bestpractical.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> bug-RT-Authen-ExternalAuth [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #74144] Bad encoded data from database</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 23 Jan 2012 12:04:31 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-RT-Extension-LDAPImport [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Thomas Sibley &lt;trs [...] bestpractical.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 01/22/2012 06:24 AM, Ruslan Zakirov via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think from LDAP we get octets, but in RT we should store strings and
&gt; get strings from API calls. To get correct comparison we should
&gt; upgrade data we get from LDAP to perl strings. Google suggests that
&gt; LDAPv3 sends UTF-8, v2 uses some specific format. We can enforce v3 on
&gt; anything that has not ASCII data.
</div>
This concurs with what I expected was happening.  It&#39;s not RT that needs
encoding, it&#39;s LDAP that needs decoding.

I do wonder if this problem is present in RT-Authen-ExternalAuth as well.

Thomas
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;23&nbsp;12:07:48&nbsp;2012</span>
    <span class="description">tsibley [...] cpan.org -  Reference by ticket #74267 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;08&nbsp;04:29:13&nbsp;2012</span>
    <span class="description">BHEISIG [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Mo 23. Jan 2012, 12:04:32, trs@bestpractical.com schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This concurs with what I expected was happening.  It&#39;s not RT that needs
&gt; encoding, it&#39;s LDAP that needs decoding.
</div>
Do you have any idea how to fix this? If there is something I can do
please let me know. &#40;I&#39;m currently working on a little feature to
privilege and/or disable users &#40;and vice versa&#41; when syncing.&#41;

    Benjamin
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;08&nbsp;09:14:17&nbsp;2012</span>
    <span class="description">tsibley [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #74144] Bad encoded data from database</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 08 Feb 2012 09:13:49 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-RT-Extension-LDAPImport [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Thomas Sibley &lt;tsibley [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 02/08/2012 04:29 AM, Benjamin Heisig via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Am Mo 23. Jan 2012, 12:04:32, trs@bestpractical.com schrieb:
<div class="message-stanza open">&gt;&gt; This concurs with what I expected was happening.  It&#39;s not RT that needs
&gt;&gt; encoding, it&#39;s LDAP that needs decoding.
</div>&gt; 
&gt; Do you have any idea how to fix this? If there is something I can do
&gt; please let me know. &#40;I&#39;m currently working on a little feature to
&gt; privilege and/or disable users &#40;and vice versa&#41; when syncing.&#41;
</div>
Yes, the fix is to decode the LDAP data we receive &#40;i.e. upgrading it to
Perl strings&#41;.  Ruslan noted that LDAPv3 seems to guarantee UTF-8
octets, which means we can run decode_utf8&#40;&#41; on it &#40;see perldoc Encode&#41;.

If you want to write a patch for this bug, please first start by writing
tests that trigger the failure case.

Cheers,
Thomas
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;25&nbsp;13:56:34&nbsp;2013</span>
    <span class="description">tsibley [...] cpan.org -  Subject changed from &#39;Bad encoded data from database&#39; to &#39;LDAP values should be decoded as UTF-8 upon fetch&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;25&nbsp;13:56:34&nbsp;2013</span>
    <span class="description">tsibley [...] cpan.org -  Severity Important added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;25&nbsp;19:12:36&nbsp;2013</span>
    <span class="description">craig [...] 2ndquadrant.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #74144] Bad encoded data from database</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 26 Feb 2013 08:12:17 +0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-RT-Extension-LDAPImport [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Craig Ringer &lt;craig [...] 2ndquadrant.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m working on a test case to demonstrate this bug now.

-- 
 Craig Ringer                   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.2ndQuadrant.com/">http://www.2ndQuadrant.com/</a></span>
 PostgreSQL Development, 24x7 Support, Training &#38; Services
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
