<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #79901 for Monkey-Patch: Monkey::Patch causes &#34;Prototype mismatch&#34; warnings</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #79901 for Monkey-Patch: Monkey::Patch causes &#34;Prototype mismatch&#34; warnings</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Monkey-Patch/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Monkey-Patch/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Monkey-Patch/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Monkey-Patch/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Monkey-Patch">Monkey-Patch CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">79901</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Monkey-Patch/Active/">Monkey-Patch</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
niels [...] thykier.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-233944-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-233945-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;28&nbsp;04:31:45&nbsp;2012</span>
    <span class="description">niels [...] thykier.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Monkey::Patch causes &#34;Prototype mismatch&#34; warnings</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 28 Sep 2012 10:31:25 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Monkey-Patch [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Niels Thykier &lt;niels [...] thykier.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi

I happened to notice #677145[1] in the Debian bug tracker and decided to
forward it upstream.

Jakub Wilk &#40;the original reporter&#41; found that when monkey patching a
prototyped sub, it causes warnings &#40;similar to the &#34;sub redefined&#34;
warning that Monkey::Patch also suppresses&#41;.

I have attached the test script and that patch submitted by Jakub, which
silences the warning.

I was thinking it might be prudent if the &#34;patching&#34; sub automatically
got the prototype of the original sub.  Just in case code loaded &#34;later&#34;
depends on this prototype.  Though I have no idea of how to determine
the prototype of the original sub.

The bug was filed against 0.03 in the Debian bug tracker.  Perl 5.14.2
was installed on the system from where it was reported.  If you want, I
can give you the output of &#34;perl -V&#34;, but the bug does not really seem
to be system specific.

If you need any additional information, let me know.

~Niels

[1] <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=677145">http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=677145</a></span>

You can submit information to the Debian bug by mailing
  677145@bugs.debian.org

Though the submitter will not see that by default, so if you want the
submitter to see it, ALSO mail
  677145-submitter@bugs.debian.org

PS: I am not auto CC&#39;ed to the Debian bug &#40;I am not the maintainer of
your package in Debian&#41; nor am I the submitter, so please CC me directly
if needed.
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;28&nbsp;11:17:40&nbsp;2012</span>
    <span class="description">FRODWITH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This warning should be emitted if you overwrite a sub with a sub with a 
different prototype. If you don&#39;t want the warning, use a sub with the 
correct prototype, or squelch the warning yourself. I&#39;d recommend the 
former, since using subs with mismatching prototypes can &#40;and often does&#41; 
significantly alter the way the sub is called.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;28&nbsp;11:17:41&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;28&nbsp;11:17:41&nbsp;2012</span>
    <span class="description">FRODWITH [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;25&nbsp;04:28:31&nbsp;2013</span>
    <span class="description">niels [...] thykier.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79901] Monkey::Patch causes &#34;Prototype mismatch&#34; warnings</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 25 Sep 2013 10:28:14 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Monkey-Patch [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Niels Thykier &lt;niels [...] thykier.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2012-09-28 17:17, Paul Driver via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=79901">https://rt.cpan.org/Ticket/Display.html?id=79901</a></span> &gt;
&gt; 
&gt; This warning should be emitted if you overwrite a sub with a sub with a 
&gt; different prototype. If you don&#39;t want the warning, use a sub with the 
&gt; correct prototype, or squelch the warning yourself. I&#39;d recommend the 
&gt; former, since using subs with mismatching prototypes can &#40;and often does&#41; 
&gt; significantly alter the way the sub is called.
&gt; 
</div>
Hi,

First off, sorry for the very late reply.

Secondly, your recommendation does not appear to work.  The warning is
not triggered by the sub to Monkey::Patch, but by the wrapper generated
by Monkey::Patch.  Consider the &#34;install&#34; and the &#34;wrapper&#34; sub here for
a moment:

&#34;&#34;&#34;
sub install {
    my $self = shift;
    my $name  = $self-&gt;name;
    my $stack = $self-&gt;stack;

    [...]
    my $code = $self-&gt;wrapper;

    no warnings &#39;redefine&#39;;
    *$name = $code;
    push&#40;@$stack, $code&#41;;

    return $self;
}


sub wrapper {
    my $self = shift;
    unless &#40;$self-&gt;{wrapper}&#41; {
        weaken&#40;$self&#41;;
        $self-&gt;{wrapper} = sub {
            [...]
        };
    }
    return $self-&gt;{wrapper};
}

&#34;&#34;&#34;

The sub generated in &#34;wrapper&#34; does not have a prototype &#40;regardless of
whether $self-&gt;{code} has one and &#34;install&#34; does not &#34;fix&#34; that problem.
 So Monkey::Patch causes a &#34;Prototype mismatch&#34; here, even if I gave a
properly prototyped sub.

Btw, I think fixing the prototype problem in Monkey::Patch is &#34;just&#34;
something like:

  use Scalar::Util qw&#40;set_prototype&#41;;

  my $wrapper = sub {
     [...]
  };
  my $prototype = prototype&#40;$self-&gt;{code}&#41;;
  if &#40;defined $prototype&#41; {
    set_prototype&#40;\&#38;$wrapper&#41;;
  }
  $self-&gt;{wrapper} = $wrapper;

~Niels
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;25&nbsp;05:37:03&nbsp;2013</span>
    <span class="description">niels [...] thykier.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79901] Monkey::Patch causes &#34;Prototype mismatch&#34; warnings</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 25 Sep 2013 11:36:43 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Monkey-Patch [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Niels Thykier &lt;niels [...] thykier.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2013-09-25 10:28, Niels Thykier wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 2012-09-28 17:17, Paul Driver via RT wrote:
<div class="message-stanza open">&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=79901">https://rt.cpan.org/Ticket/Display.html?id=79901</a></span> &gt;
&gt;&gt;
&gt;&gt; This warning should be emitted if you overwrite a sub with a sub with a 
&gt;&gt; different prototype. If you don&#39;t want the warning, use a sub with the 
&gt;&gt; correct prototype, or squelch the warning yourself. I&#39;d recommend the 
&gt;&gt; former, since using subs with mismatching prototypes can &#40;and often does&#41; 
&gt;&gt; significantly alter the way the sub is called.
&gt;&gt;
</div>&gt; 
&gt; Hi,
&gt; 
&gt; [...]
&gt; Btw, I think fixing the prototype problem in Monkey::Patch is &#34;just&#34;
&gt; something like:
&gt; 
&gt;   use Scalar::Util qw&#40;set_prototype&#41;;
&gt; 
&gt;   my $wrapper = sub {
&gt;      [...]
&gt;   };
&gt;   my $prototype = prototype&#40;$self-&gt;{code}&#41;;
&gt;   if &#40;defined $prototype&#41; {
&gt;     set_prototype&#40;\&#38;$wrapper&#41;;
&gt;   }
&gt;   $self-&gt;{wrapper} = $wrapper;
&gt; 
&gt; ~Niels
&gt; 
&gt; 
</div>
Okay, I was reminded that the fix cannot be quite as simple, since the
sub provided to monkey patch has to accept an extra &#34;initial&#34; argument
&#40;the $original or &#34;previous&#34; sub&#41;.  So the sub given to Monkey::Patch
cannot have the correct prototype[1].

~Niels

[1] Well, technically, it could because I think Monkey::Patch&#39;s call to
it bypasses prototype checking.  However, I am pretty sure most people
would be surprised with code like:

  Monkey::Patch::patch_packagee &#39;pkg&#39; =&gt; &#39;orig_sub&#39; =&gt; sub &#40;$&#41; {
     my &#40;$code, $arg&#41; = @_;
     ...;
  };
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
