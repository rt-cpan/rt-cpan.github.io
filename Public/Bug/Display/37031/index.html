<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #36982 for File-Path: rmtree&#40;&#41; makes symlink targets world-writable</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #36982 for File-Path: rmtree&#40;&#41; makes symlink targets world-writable</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=File-Path">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=File-Path">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=File-Path">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=File-Path">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/File-Path">File-Path CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">36982</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=File-Path">File-Path</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">dland [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
david [...] landgren.net

<br />
ntyni [...] iki.fi

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-43556-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.04    </td>
  </tr>
  <tr id="CF-43557-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




rmtree.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/490170/242579/rmtree.patch">
Sat Jul 26 05:12:04 2008 (1.8k) by GAAS [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=36982">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-476913" href="/Public/Bug/Display.html?id=36982#txn-476913">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;21&nbsp;02:11:56&nbsp;2008</span>
    <span class="description">ntyni [...] iki.fi -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rmtree&#40;&#41; makes symlink targets world-writable</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/476913/235477/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/235477">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 756b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

as reported in &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/487319">http://bugs.debian.org/487319</a></span>&gt;, when rmtree&#40;&#41; encounters
a symlink, it will change the permissions of the link target to the
permissions of the link, usually 0777.

% touch foo
% ln -s foo bar
% ls -l foo bar
lrwxrwxrwx 1 niko niko 3 2008-06-21 09:06 bar -&gt; foo
-rw-r--r-- 1 niko niko 0 2008-06-21 09:06 foo
% perl -e &#39;use File::Path rmtree; rmtree bar&#39;
% ls -l foo bar                              
ls: cannot access bar: No such file or directory
-rwxrwxrwx 1 niko niko 0 2008-06-21 09:06 foo

This is with Perl 5.10.0, containing File-Path 2.04, but I have verified
it with the 2.06_04 CPAN version too.

There&#39;s a proposed patch by Ben Hutchings in the Debian report linked
above, please have a look.
-- 
Niko Tyni
ntyni@debian.org
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-477807" href="/Public/Bug/Display.html?id=36982#txn-477807">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;23&nbsp;14:44:19&nbsp;2008</span>
    <span class="description">ntyni [...] debian.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #36982]: rmtree&#40;&#41; makes symlink targets world-writable</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 23 Jun 2008 21:43:49 +0300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Bugs in File-Path via RT &lt;bug-File-Path [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Niko Tyni &lt;ntyni [...] debian.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/477807/235952/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/235952">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 994b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, Jun 21, 2008 at 02:11:57AM -0400, Bugs in File-Path via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; as reported in &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/487319">http://bugs.debian.org/487319</a></span>&gt;, when rmtree&#40;&#41; encounters
&gt; a symlink, it will change the permissions of the link target to the
&gt; permissions of the link, usually 0777.
</div>
For the record, this has now been assigned a CVE id:

 Name: CVE-2008-2827
 Status: Candidate
 URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2008-2827">http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2008-2827</a></span>
 Reference: MISC:<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=487319">http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=487319</a></span>
 Reference: MISC:<span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Bug/Display.html?id=36982">http://rt.cpan.org/Public/Bug/Display.html?id=36982</a></span>

 The rmtree function in lib/File/Path.pm in Perl 5.10 does not properly
 check permissions before performing a chmod, which allows local users
 to modify the permissions of arbitrary files via a symlink attack, a
 different vulnerability than CVE-2005-0448 and CVE-2004-0452.

Sorry about the triplicate report on the p5p list, I wasn&#39;t aware the
CPAN ticket submissions get forwarded there too.
-- 
Niko Tyni   ntyni@debian.org
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-477808" href="/Public/Bug/Display.html?id=36982#txn-477808">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;23&nbsp;14:44:25&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Create even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-477848" href="/Public/Bug/Display.html?id=36982#txn-477848">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;23&nbsp;15:57:25&nbsp;2008</span>
    <span class="description">david [...] landgren.net - Ticket #37031:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> perl5-porters [...] perl.org, bug-File-Path [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: File::Path::rmtree makes symlink targets world-writable</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 23 Jun 2008 21:56:33 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Niko Tyni &lt;ntyni [...] debian.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> David Landgren &lt;david [...] landgren.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/477848/235972/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/235972">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Niko Tyni wrote, some time around 21/06/2008 08:58:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi p5p,
&gt; 
&gt; as reported in &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/487319">http://bugs.debian.org/487319</a></span>&gt; and
&gt; &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Bug/Display.html?id=36982">http://rt.cpan.org/Public/Bug/Display.html?id=36982</a></span>&gt;, when
&gt; File::Path::rmtree&#40;&#41; encounters a symlink, it will change the permissions
&gt; of the link target to the permissions of the link, usually 0777. This is
&gt; obviously a Bad Thing with security implications. The &#39;safe&#39; parameter
&gt; doesn&#39;t seem to help here.
&gt; 
&gt; There&#39;s a proposed patch by Ben Hutchings in the Debian report.  The bug
&gt; is present &#40;at least&#41; in File-Path-2.04, in both 5.10.0 and blead.
</div>
Just to follow up for the list &#40;not quite sure how to CC: RT@perl.org 
but I&#39;ve taken the ticket there&#41;, I&#39;ll have a fix for this in 2.07. The 
latter is currently stalled for lack of tuits; I&#39;ve fixed up the new/old 
interface issues for mkpath&#40;&#41;, now I just have to do the same for rmtree&#40;&#41;.

I&#39;m just slightly curious: this problem must have always been present in 
previous versions, the essence of the rmtree&#40;&#41; function remains the 
same, I only added an alternate error reporting channel into the code. 
If someone can find the time to prove or disprove that this behaviour 
has crept in since 2.x it would be of great help. That will allow me to 
figure out if code needs to be added or removed/reverted...

Thanks,
David
-- 
stubborn tiny lights vs. clustering darkness forever ok?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-490170" href="/Public/Bug/Display.html?id=36982#txn-490170">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;26&nbsp;05:11:41&nbsp;2008</span>
    <span class="description">GAAS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/490170/242576/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/242576">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 76b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached is the patch with test case I&#39;ve applied to ActivePerl to fix this.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/490170/242579/rmtree.patch">Download rmtree.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">commit 678079171cdf9cb8f6c2cfe937949f08d644ef81
Author: Gisle Aas &lt;gisle@aas.no&gt;
Date:   Sat Jul 26 11:05:52 2008 +0200

    rmtree symlink attack CVE-2004-0452

diff --git a/MANIFEST b/MANIFEST
index f58018c..1366f97 100644
--- a/MANIFEST
+++ b/MANIFEST
@@ -7,6 +7,7 @@ Path.pm
 README
 TODO
 eg/setup-extra-tests
+t/CVE-2008-2827.t
 t/Path.t
 t/pod.t
 t/taint.t
diff --git a/Path.pm b/Path.pm
index 5508b4e..f2c99ea 100644
--- a/Path.pm
+++ b/Path.pm
@@ -359,9 +359,9 @@ sub _rmtree {
                 next ROOT_DIR;
             }
 
-            my $nperm = $perm &#38; 07777 | 0600;
-            if &#40;$nperm != $perm and not chmod $nperm, $root&#41; {
-                if &#40;$Force_Writeable&#41; {
+            if &#40;$Force_Writeable&#41; {
+                my $nperm = $perm &#38; 07777 | 0600;
+                if &#40;$nperm != $perm and not chmod $nperm, $root&#41; {
                     _error&#40;$arg, &#34;cannot make file writeable&#34;, $canon&#41;;
                 }
             }
diff --git a/t/CVE-2008-2827.t b/t/CVE-2008-2827.t
new file mode 100644
index 0000000..19fa451
--- /dev/null
+++ b/t/CVE-2008-2827.t
@@ -0,0 +1,39 @@
+#!perl -w
+
+# Test case derived from <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=487319">http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=487319</a></span>
+
+my $foo = &#34;foo-$$&#34;;
+my $bar = &#34;bar-$$&#34;;
+
+die &#34;Not clean [$foo] [$bar]&#34; if -e $foo || -e $bar;
+
+eval {
+    symlink&#40;$foo, $bar&#41; || die &#34;Can&#39;t symlink $foo --&gt; $bar&#34;;
+};
+if &#40;$@&#41; {
+    print &#34;1..0 # Skipped: Only systems that can do symlinks are affected\n&#34;;
+    print &#34;$@\n&#34;;
+    exit;
+}
+
+use Test;
+plan tests =&gt; 5;
+
+umask&#40;0027&#41;;
+
+# touch foo
+open&#40;my $fh, &#34;&gt;&#34;, $foo&#41; || die &#34;Can&#39;t create $foo\n&#34;;
+close&#40;$fh&#41;;
+
+my $m = &#40;stat $foo&#41;[2];
+ok&#40;defined $m&#41;;
+
+require File::Path;
+ok&#40;File::Path::rmtree&#40;$bar&#41;&#41;;
+ok&#40;!-e $bar&#41;;
+
+# If the mode of $foo changed as a result of removing $bar then we are vulnerable
+ok&#40;$m, &#40;stat $foo&#41;[2]&#41;;
+
+unlink&#40;$foo&#41;;
+ok&#40;!-e $foo&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-492230" href="/Public/Bug/Display.html?id=36982#txn-492230">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;01&nbsp;10:19:49&nbsp;2008</span>
    <span class="description">steve [...] purkis.ca -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/492230/243569/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/243569">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 284b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Jul 26 05:11:41 2008, GAAS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Attached is the patch with test case I&#39;ve applied to ActivePerl to fix
</div>this.

Thanks Niko, Gisle - this issue has been affecting me too.  Security
nightmare come true!  Fortunately we caught it before releasing to
production.

Cheers,
-Steve
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-517973" href="/Public/Bug/Display.html?id=36982#txn-517973">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;09&nbsp;16:51:14&nbsp;2008</span>
    <span class="description">dland [...] cpan.org - Ticket #37031:  Merged into ticket #36982</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-517974" href="/Public/Bug/Display.html?id=36982#txn-517974">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;09&nbsp;16:51:15&nbsp;2008</span>
    <span class="description">dland [...] cpan.org -  Merged into ticket #36982</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-526159" href="/Public/Bug/Display.html?id=36982#txn-526159">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;29&nbsp;10:54:08&nbsp;2008</span>
    <span class="description">dland [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/526159/263230/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/263230">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Jun 21 02:11:56 2008, ntyni@iki.fi wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; as reported in &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/487319">http://bugs.debian.org/487319</a></span>&gt;, when rmtree&#40;&#41; encounters
&gt; a symlink, it will change the permissions of the link target to the
&gt; permissions of the link, usually 0777.
&gt; 
&gt; % touch foo
&gt; % ln -s foo bar
&gt; % ls -l foo bar
&gt; lrwxrwxrwx 1 niko niko 3 2008-06-21 09:06 bar -&gt; foo
&gt; -rw-r--r-- 1 niko niko 0 2008-06-21 09:06 foo
&gt; % perl -e &#39;use File::Path rmtree; rmtree bar&#39;
&gt; % ls -l foo bar                              
&gt; ls: cannot access bar: No such file or directory
&gt; -rwxrwxrwx 1 niko niko 0 2008-06-21 09:06 foo
&gt; 
&gt; This is with Perl 5.10.0, containing File-Path 2.04, but I have verified
&gt; it with the 2.06_04 CPAN version too.
&gt; 
&gt; There&#39;s a proposed patch by Ben Hutchings in the Debian report linked
&gt; above, please have a look.
</div>
Hello,

I must apologise for this problem and the grief it caused. It was a case
of refactoring that went wrong. I have fixed this up as per the original
Debian bug report and it is available in version 2.06_07, which will
soon become 2.07

Thanks,
David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Give even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-526161" href="/Public/Bug/Display.html?id=36982#txn-526161">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;29&nbsp;10:54:40&nbsp;2008</span>
    <span class="description">dland [...] cpan.org -  Given to DLAND</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-531174" href="/Public/Bug/Display.html?id=36982#txn-531174">#</a>      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;10&nbsp;11:24:58&nbsp;2008</span>
    <span class="description">dland [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/531174/266157/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/266157">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 29b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in 2.07.

Thanks,
David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-531176" href="/Public/Bug/Display.html?id=36982#txn-531176">#</a>      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;10&nbsp;11:25:01&nbsp;2008</span>
    <span class="description">dland [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.413039</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
