<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #66294 for HTML-FormHandler-Model-DBIC: &#39;form-&gt;process&#39; dies when updating has_many relations with Select-fields</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #66294 for HTML-FormHandler-Model-DBIC: &#39;form-&gt;process&#39; dies when updating has_many relations with Select-fields</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/HTML-FormHandler-Model-DBIC/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/HTML-FormHandler-Model-DBIC/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/HTML-FormHandler-Model-DBIC/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/HTML-FormHandler-Model-DBIC/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/HTML-FormHandler-Model-DBIC">HTML-FormHandler-Model-DBIC CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">66294</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/HTML-FormHandler-Model-DBIC/Active/">HTML-FormHandler-Model-DBIC</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
LUKAST [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-228614-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.14    </td>
  </tr>
  <tr id="CF-228615-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




HFH-hasmany-select-test.tar.bz2<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/905777/469869/HFH-hasmany-select-test.tar.bz2">
Wed Mar 02 08:38:32 2011 (2.8k) by LUKAST [...] cpan.org
</a>
</font></li>
</ul>


hfh_model_dbic_hasmany.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/905212/469553/hfh_model_dbic_hasmany.patch">
Tue Mar 01 12:33:20 2011 (962b) by LUKAST [...] cpan.org
</a>
</font></li>
</ul>


process_hasmany.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/905212/469552/process_hasmany.t">
Tue Mar 01 12:33:20 2011 (1.3k) by LUKAST [...] cpan.org
</a>
</font></li>
</ul>


with_m2m.tar.gz<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/906767/470379/with_m2m.tar.gz">
Fri Mar 04 16:31:18 2011 (4.2k) by gerda.shank [...] gmail.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;01&nbsp;12:33:20&nbsp;2011</span>
    <span class="description">LUKAST [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> &#39;form-&gt;process&#39; dies when updating has_many relations with
 Select-fields</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

I noticed that HFH::Model::DBIC is not able to update has_many relations
when using Select-fields.
The reason is that the data provided by the form is not compatible with
DBIx::Class::ResultSet::RecursiveUpdate., which  is used to update the
database.

My first idea was to fix this issue within RecursiveUpdate, but the
patch was not accepted due to several rational reasons.

Take a look at this discussion:  
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=65565">https://rt.cpan.org/Ticket/Display.html?id=65565</a></span>

I have created a patch which solves this problem for single-keyed
has_many relations. 

As far as I can see, multi-keyed has_many-relations are not supported 
by HFH-Model-DBIC at all &#40;due to the line 
&#39;my &#40;$primary_key&#41; = $source-&gt;primary_columns;&#39;
in the &#34;lookup_options&#34; -subroutine. This will not work for multiple
pks, is this right?&#41;.

I also attached a testcase fro this bug...

Best regards, Lukas
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> process_hasmany.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use warnings;
use Test::More tests =&gt; 6;
use Test::Exception;
use lib &#39;t/lib&#39;;

###########################################################################
{
	# Testform for updating has_many relations with Select-fields 
	package BookDB::Form::User4;

	use HTML::FormHandler::Moose;
	extends &#39;HTML::FormHandler::Model::DBIC&#39;;
	with &#39;HTML::FormHandler::Render::Simple&#39;;


	has &#39;+item_class&#39; =&gt; &#40; default =&gt; &#39;User&#39;&#41;;

	has_field &#39;addresses&#39; =&gt; &#40; type =&gt; &#39;Select&#39;, multiple =&gt; 1&#41;;

	# HFH does not now how to fetch the options for &#39;addresses&#39; from database
	# -&gt; providing options
	sub options_addresses{
		my $self = shift;
		my $schema = $self-&gt;schema;
		my $addr_rs = $schema-&gt;resultset&#40;&#39;Address&#39;&#41;;
		return [map { {label =&gt; $_-&gt;country_iso . &#39;/&#39; . $_-&gt;city . &#39;/&#39; . $_-&gt;street, value =&gt; $_-&gt;address_id} } $addr_rs-&gt;all];
	}

	no HTML::FormHandler::Moose;
	1;
}
###########################################################################

use_ok&#40; &#39;HTML::FormHandler&#39; &#41;;
use_ok&#40; &#39;BookDB::Schema&#39;&#41;;

my $schema = BookDB::Schema-&gt;connect&#40;&#39;dbi:SQLite:t/db/book.db&#39;&#41;;
ok&#40;$schema, &#39;get db schema&#39;&#41;;

my $user = $schema-&gt;resultset&#40;&#39;User&#39;&#41;-&gt;find&#40;&#39;1&#39;&#41;;
my $form = BookDB::Form::User4-&gt;new&#40;item =&gt; $user, &#41;;
ok&#40; $form, &#39;form creation&#39; &#41;;

my $orig = $form-&gt;values;
ok&#40; $orig, &#39;extracting values&#39; &#41;;

lives_ok {$form-&gt;process&#40;params =&gt; $orig&#41;} &#39;running form-&gt;process with has_many relation&#39; ;

</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> hfh_model_dbic_hasmany.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- lib/HTML/FormHandler/TraitFor/Model/DBIC.pm	2011-03-01 17:46:05.000000000 +0100
+++ lib/HTML/FormHandler/TraitFor/Model/DBIC.pm.patched	2011-03-01 17:46:56.000000000 +0100
@@ -89,6 +89,23 @@
     return $self-&gt;item;
 }
 
+around values =&gt; sub{
+	my $orig = shift;
+	my $self = shift;
+	my $source = $self-&gt;source;
+	my $values = $self-&gt;$orig;
+	foreach my $key &#40;keys %$values&#41;{
+		if&#40; $self-&gt;guess_field_type&#40;$key&#41; eq &#39;Multiple&#39;&#41;{
+			my $ids = $values-&gt;{$key};
+			croak &#34;updates for has_many relations has to be a ARRAYREF&#34; unless ref&#40;$ids&#41; eq &#39;ARRAY&#39;;
+			my @primaries = $self-&gt;_get_related_source&#40;$source, $key&#41;-&gt;primary_columns;
+			croak &#34;multi-key has_many relations are not supported&#34; unless  @primaries &#38;&#38; @primaries == 1;
+			$values-&gt;{$key} = [map {ref&#40;$_&#41; &#38;&#38; ref&#40;$_&#41; eq &#39;HASH&#39; ? $_ : {$primaries[0] =&gt; $_}} @$ids];
+		}
+	}
+	return $values;
+};
+
 # undocumented because this is going to be replaced
 # by a better method
 sub guess_field_type
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;01&nbsp;14:09:34&nbsp;2011</span>
    <span class="description">gerda.shank [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66294] &#39;form-&gt;process&#39; dies when updating has_many relations with  Select-fields</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 01 Mar 2011 14:09:24 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-HTML-FormHandler-Model-DBIC [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Gerda Shank &lt;gerda.shank [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Lukas:

I don&#39;t think that this form and its relationship to the database is 
structured properly. The &#39;Multiple&#39; select field type is used for 
many_to_many relationships. &#40;The &#39;single&#39; select is for has_many 
relationships.&#41; What you&#39;re doing here is a mixture of two different 
types of relationships, and doesn&#39;t make a lot of sense to me.

I&#39;m guessing that you have a static list of addresses that you want the 
user to select from. For that case, you would need a different &#39;address&#39; 
table that doesn&#39;t include the foreign key &#40;user_id&#41; of the user table, 
plus a user_address mapping table, which contains user_id and address_id 
columns. You would still have to create the options, unless the address 
table has a single column that you would want to use as a label. And the 
name of the field would be the &#39;many_to_many&#39; relation, not the 
&#39;has_many&#39; relation.

If what you have is a &#39;has_many&#39; relationship to a number of addresses 
that ARE specific to this user, and this form is trying to select 
particular addresses for some other purpose, you still ought to have a 
many_to_many relationship in there somewhere, and a &#39;has_many&#39; 
relationship to a mapping table.

Possibly what you are trying to do has been obscured by using the 
existing example. If this is the case, I suggest that you provide the 
pertinent information for the tables and the form, so that I can 
understand what you&#39;re trying to do.

Gerda
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;01&nbsp;14:09:35&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;08:38:32&nbsp;2011</span>
    <span class="description">LUKAST [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Gerda,

First of all: Thanks for the very quick answer!

I think it was a bad Idea to use the existing example to demonstrate my
issue. Sorry for the confusion.
I have created a very simple example for this bug.  I hope this helps to
understand my problem.

Im am using &#39;multiple-select&#39; fields for &#39;has_many&#39; relations, because I
think using &#39;single-select&#39; fields for &#39;has_many&#39; relations
is not usefull at all &#40;at least in my application&#41;.
Why should I create a &#34;has_many&#34; relation, when it is not possible to
select multiple entries? This would be the same as creating
a &#39;has_one&#39; relation. I am using &#39;has_many&#39; relations because I need to
select multiple items!

Using &#39;many_to_many&#39; instead of &#39;has_many&#39; is not possible for me. And
even if it would be possible, it would have some negative side-effects.

But take a look at my example. A short description is included at the
top of &#39;hasmany_select.t&#39;

Cheers, Lukas
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> HFH-hasmany-select-test.tar.bz2</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/905777/469869/HFH-hasmany-select-test.tar.bz2">Download HFH-hasmany-select-test.tar.bz2</a><br />
<span class="downloadcontenttype">application/x-bzip2 2.8k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;04&nbsp;16:31:18&nbsp;2011</span>
    <span class="description">gerda.shank [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66294] &#39;form-&gt;process&#39; dies when updating has_many relations with Select-fields</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 04 Mar 2011 16:31:06 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-HTML-FormHandler-Model-DBIC [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Gerda Shank &lt;gerda.shank [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Lukas:

I looked at your example, and the way you&#39;re using a select is 
non-standard and is not supported by the FormHandler select field. I&#39;ve 
attached a version of your example with how it would work with a 
many_to_many. Which doesn&#39;t &#39;take away&#39; a tool from somebody who has 
selected it.

It&#39;s currently not possible to automatically do the kind of processing 
that you want. I suggest that you look in the FormHandler cookbook:
<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~gshank/HTML-FormHandler-0.33002/lib/HTML/FormHandler/Manual/Cookbook.pod#Example_of_a_form_with_custom_database_interface">http://search.cpan.org/~gshank/HTML-FormHandler-0.33002/lib/HTML/FormHandler/Manual/Cookbook.pod#Example_of_a_form_with_custom_database_interface</a></span>

That example is similar to what you&#39;re trying to do. It might be 
possible to generalize that kind of operation, but it&#39;s not a trivial 
problem, and the work hasn&#39;t been done.

Gerda
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/906767/470379/with_m2m.tar.gz">Download with_m2m.tar.gz</a><br />
<span class="downloadcontenttype">application/x-gzip 4.2k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;04&nbsp;19:34:44&nbsp;2011</span>
    <span class="description">gerda.shank [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66294] &#39;form-&gt;process&#39; dies when updating has_many relations with Select-fields</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 04 Mar 2011 19:34:34 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-HTML-FormHandler-Model-DBIC [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Gerda Shank &lt;gerda.shank [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Lukas:

I took another look at your patch and this issue. Fixing the general 
case is complicated, but your particular case seems doable.

I&#39;m not sure that I like putting the around on values in the model 
though. I think I&#39;d rather do something explicitly in the field. I 
should have something available in the next couple of days.

Gerda
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;08&nbsp;06:42:19&nbsp;2011</span>
    <span class="description">LUKAST [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Gerda,

I totaly agree that my patch is far from being a perfect solution. It is
a quick fix which solved the problem for me, without detailed knowledge
of how the fields work. And it does not seem to disturb the original
Formhandlers functionality &#40;at least the tests included in the module
still look good...&#41;.
I also prefere the idea to fix the problem where it originated &#40;in  the
field&#41; and not where it appeared &#40;as the &#39;around&#39;-solution does&#41;.

I realy appreciate your work. Let me know if you need any assistance.

Thanks a lot, Lukas
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;08&nbsp;09:35:17&nbsp;2011</span>
    <span class="description">gerda.shank [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #66294] &#39;form-&gt;process&#39; dies when updating has_many relations with Select-fields</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 08 Mar 2011 09:35:06 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-HTML-FormHandler-Model-DBIC [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Gerda Shank &lt;gerda.shank [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Lukas:

There&#39;s code in the github repo &#40;for FormHandler, not the DBIC model&#41; 
right now which you can try. It&#39;s not totally satisfactory--this is one 
of those problems where there is no completely satisfying solution, 
unfortunately. And the change will handle your specific situation, but 
not a number of others that I can imagine.

You would define your tools field like this:

has_field &#39;tools&#39; =&gt; &#40; type =&gt; &#39;Select&#39;, multiple =&gt; 1, has_many =&gt; &#39;id&#39; &#41;;

...where the &#39;has_many&#39; attribute of the field is the primary key name 
of the related table. The code has been changed to do the equivalent of 
an inflation of the value from something like [2,3,4] to [{ id =&gt; 2}, 
{id =&gt; 3}, {id =&gt; 4}]. And deflates it into the fill-in-form value if 
necessary.

I&#39;m curious about the real-world use of this kind of a select. The 
ToolBox thing shows the issue but doesn&#39;t make real sense to me. You 
have a pool of resources that can be acquired... Then my mind boggles.

Gerda
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;08&nbsp;11:25:31&nbsp;2011</span>
    <span class="description">LUKAST [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">hi Gerda,

I just took a look at the code in the github. It seems to address my
problem quite well, at least better than my patch.

I will take a closer look at it tomorrow morning.

You are right, the &#39;Toolbox&#39; is not my real world example. I constructed
it to show what i need. The real example comes from a more complex and
quite special software for physical measurements. The real-world example
has tons of dependencies and is hardly documented, thats why I decided
to create an &#39;artificial&#39; example which demonstrates my needs.

The real-world example is about silicium-structures which consist of
several substructures. These parent-structures are created, split and
rearanged all the time, resulting in structures without substructures,
structures with substructures, substructures without or with
parent-structures, but NEVER substructures with more than one parent
structure.

To make things even more complicated, structures and substructures are
defined in a recursive way... I am not happy with this database-model at
all, but I am not in the position to change it. I just have to provide
the software which operates on this crazy database-structure...

I think providing an artificial example was a good Idea :&#41;

Tell me if you are still interested  in the real-world example. I will
send you a copy as soon as the documentation is &#40;almost&#41; finished.

thanks again, Lukas
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;19&nbsp;13:13:05&nbsp;2011</span>
    <span class="description">gshank [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Closing ticket that was handled quite a while back...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;19&nbsp;13:13:06&nbsp;2011</span>
    <span class="description">gshank [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
