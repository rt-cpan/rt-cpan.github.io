<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #30729 for Class-Trigger: Patch to allow caching of triggers</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #30729 for Class-Trigger: Patch to allow caching of triggers</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Class-Trigger">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Class-Trigger">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Class-Trigger">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Class-Trigger">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Class-Trigger">Class-Trigger CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">30729</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Class-Trigger">Class-Trigger</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cpan [...] chmrr.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-7348-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-7349-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




Class-Trigger.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/383234/175616/Class-Trigger.patch">
Wed Nov 14 10:52:37 2007 (6.3k) by cpan [...] chmrr.net
</a>
</font></li>
</ul>


fetch_all_triggers_cache.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/425764/208239/fetch_all_triggers_cache.patch">
Fri Feb 22 17:12:45 2008 (2.1k) by mschwern [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=30729">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-383234" href="/Public/Bug/Display.html?id=30729#txn-383234">#</a>      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;14&nbsp;10:52:37&nbsp;2007</span>
    <span class="description">cpan [...] chmrr.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Patch to allow caching of triggers</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/383234/175613/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/175613">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 198b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Heya,
  Walking the @ISA stack on every trigger call can be expensive. 
Attached is a patch which provides -&gt;finalize_triggers, which will cache
the triggers for either an object or a class.
 - Alex
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Class-Trigger.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/383234/175616/Class-Trigger.patch">Download Class-Trigger.patch</a><br />
<span class="downloadcontenttype">text/x-diff 6.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ruN Class-Trigger-0.12/lib/Class/Trigger.pm Class-Trigger-0.12-modified/lib/Class/Trigger.pm
--- Class-Trigger-0.12/lib/Class/Trigger.pm	2007-08-20 19:08:20.000000000 -0400
+++ Class-Trigger-0.12-modified/lib/Class/Trigger.pm	2007-11-14 09:59:18.000000000 -0500
@@ -16,7 +16,7 @@
 
     # export mixin methods
     no strict &#39;refs&#39;;
-    my @methods = qw&#40;add_trigger call_trigger last_trigger_results&#41;;
+    my @methods = qw&#40;add_trigger call_trigger last_trigger_results finalize_triggers&#41;;
     *{&#34;$pkg\::$_&#34;} = \&#38;{$_} for @methods;
 }
 
@@ -63,7 +63,21 @@
 
     $result_store-&gt;{&#39;_class_trigger_results&#39;} = [];
 
-    if &#40;my @triggers = __fetch_all_triggers&#40;$self, $when&#41;&#41; { # any triggers?
+    my @triggers;
+    # Check cache first
+    if &#40;ref $self and $self-&gt;{_class_trigger_cache}&#41; {
+        @triggers = @{$self-&gt;{_class_trigger_cache}{$when} || []};
+    } elsif &#40;ref $self and ${Class::Trigger::_trigger_cache}-&gt;{ref $self}&#41; {
+        @triggers = @{${Class::Trigger::_trigger_cache}-&gt;{ref $self}{$when} || []};
+        push @triggers, @{$self-&gt;{__triggers}{$when} || []};
+    } elsif &#40;not ref $self and ${Class::Trigger::_trigger_cache}-&gt;{$self}&#41; {
+        @triggers = @{${Class::Trigger::_trigger_cache}-&gt;{$self}{$when} || []};
+    } else {
+        @triggers = __fetch_all_triggers&#40;$self, $when&#41;;
+    }
+
+
+    if &#40;@triggers&#41; { # any triggers?
         for my $trigger &#40;@triggers&#41; {
             my @return = $trigger-&gt;[0]-&gt;&#40;$self, @_&#41;;
             push @{$result_store-&gt;{&#39;_class_trigger_results&#39;}}, \@return;
@@ -80,6 +94,52 @@
     return scalar @{$result_store-&gt;{&#39;_class_trigger_results&#39;}};
 }
 
+sub __finalize_all_triggers {
+    my&#40;$class, $store&#41; = @_;
+    return ${Class::Trigger::_trigger_cache}-&gt;{$class}
+      if ${Class::Trigger::_trigger_cache}-&gt;{$class};
+
+    $store ||= {};
+    $store-&gt;{$class} = {};
+
+    no strict &#39;refs&#39;;
+    my @classes = @{$class . &#39;::ISA&#39;};
+
+    foreach my $c &#40;@classes&#41; {
+        next unless UNIVERSAL::can&#40;$c, &#39;call_trigger&#39;&#41;;
+
+        # Finalize that class
+        my $t = $store-&gt;{$c} || __finalize_all_triggers&#40;$c, $store&#41;;
+
+        # Push its final&#39;d ones onto ours
+        for my $when &#40;keys %{$t}&#41; {
+            push @{$store-&gt;{$class}{$when}}, @{$t-&gt;{$when}};
+        }
+    }
+
+    # Add self triggers to cache
+    for my $when &#40;keys %{$Triggers{$class}}&#41; {
+        push @{$store-&gt;{$class}{$when}}, @{$Triggers{$class}{$when}};
+    }
+    
+    return $store-&gt;{$class};
+}
+
+sub finalize_triggers {
+    my $obj = shift;
+
+    if &#40;ref $obj&#41; {
+        $obj-&gt;{_class_trigger_cache} = __finalize_all_triggers&#40;ref $obj&#41;;
+        for my $when &#40;keys %{$obj-&gt;{__triggers} || {}}&#41; {
+            push @{$obj-&gt;{_class_trigger_cache}{$when}}, @{$obj-&gt;{__triggers}{$when}};
+        }
+        return $obj-&gt;{_class_trigger_cache};
+    } else {
+        ${Class::Trigger::_trigger_cache}-&gt;{$obj} = __finalize_all_triggers&#40;$obj&#41;;
+        return ${Class::Trigger::_trigger_cache}-&gt;{$obj};
+    }
+}
+
 sub __fetch_all_triggers {
     my &#40;$obj, $when, $list, $order&#41; = @_;
     my $class = ref $obj || $obj;
@@ -248,6 +308,17 @@
 for the last trigger point. Results are ordered in the same order the triggers
 were run.
 
+=item finalize_triggers
+
+  Foo-&gt;finalize_triggers;
+
+Inspecting the inheritance tree to determine all of the possible
+triggers on a class &#40;as call_trigger does&#41; can add up.  Calling this
+method will inspect and cache the set of triggers, saving this time
+later.  This method can be called on a class, or on an instance.  If
+called on a class, triggers can still be added to instances of the
+class, and will still be respected.  If called on an instance, it only
+finalizes that instance, not the entire class.
 
 =back
 
diff -ruN Class-Trigger-0.12/t/04_object.t Class-Trigger-0.12-modified/t/04_object.t
--- Class-Trigger-0.12/t/04_object.t	2006-03-18 06:48:00.000000000 -0500
+++ Class-Trigger-0.12-modified/t/04_object.t	2007-11-13 19:22:27.000000000 -0500
@@ -1,5 +1,5 @@
 use strict;
-use Test::More tests =&gt; 5;
+use Test::More tests =&gt; 6;
 
 use IO::Scalar;
 
@@ -37,6 +37,14 @@
 {
     my $foo = Foo-&gt;new;
     tie *STDOUT, &#39;IO::Scalar&#39;, \my $out;
+    $foo-&gt;add_trigger&#40;before_foo =&gt; sub { print &#34;before_foo1\n&#34; }&#41;;
+    $foo-&gt;foo;
+    is $out, &#34;before_foo\nbefore_foo1\nfoo\n&#34;;
+}
+
+{
+    my $foo = Foo-&gt;new;
+    tie *STDOUT, &#39;IO::Scalar&#39;, \my $out;
     $foo-&gt;foo;
     is $out, &#34;before_foo\nfoo\n&#34;;
 }
diff -ruN Class-Trigger-0.12/t/09_finalize.t Class-Trigger-0.12-modified/t/09_finalize.t
--- Class-Trigger-0.12/t/09_finalize.t	1969-12-31 19:00:00.000000000 -0500
+++ Class-Trigger-0.12-modified/t/09_finalize.t	2007-11-13 19:42:29.000000000 -0500
@@ -0,0 +1,72 @@
+use strict;
+use Test::More tests =&gt; 12;
+
+use IO::Scalar;
+
+use lib &#39;t/lib&#39;;
+use Foo;
+use Foo::Bar;
+
+ok&#40;Foo-&gt;add_trigger&#40;before_foo =&gt; sub { print &#34;before_foo\n&#34; }&#41;,
+   &#39;add_trigger in Foo&#39;&#41;;
+ok&#40;Foo::Bar-&gt;add_trigger&#40;after_foo  =&gt; sub { print &#34;after_foo\n&#34; }&#41;,
+   &#39;add_trigger in Foo::Bar&#39;&#41;;
+ok&#40;Foo::Bar-&gt;add_trigger&#40;before_foo  =&gt; sub { print &#34;before_foo2\n&#34; }&#41;,
+   &#39;add_trigger in Foo::Bar&#39;&#41;;
+ok&#40;Foo-&gt;add_trigger&#40;before_foo =&gt; sub { print &#34;before_foo3\n&#34; }&#41;,
+   &#39;add_trigger in Foo&#39;&#41;;
+
+{
+    my $foo = Foo::Bar-&gt;new;
+    tie *STDOUT, &#39;IO::Scalar&#39;, \my $pre;
+    $foo-&gt;foo;
+    is $pre, &#34;before_foo\nbefore_foo3\nbefore_foo2\nfoo\nafter_foo\n&#34;;
+
+    Foo::Bar-&gt;finalize_triggers;
+
+    tie *STDOUT, &#39;IO::Scalar&#39;, \my $post;
+    $foo-&gt;foo;
+    is $post, $pre;
+}
+
+{
+    my $foo = Foo::Bar-&gt;new;
+    $foo-&gt;add_trigger&#40;before_foo =&gt; sub { print &#34;before_foo4\n&#34; }&#41;;
+
+    tie *STDOUT, &#39;IO::Scalar&#39;, \my $pre;
+    $foo-&gt;foo;
+    is $pre, &#34;before_foo\nbefore_foo3\nbefore_foo2\nbefore_foo4\nfoo\nafter_foo\n&#34;;
+
+    $foo-&gt;finalize_triggers;
+
+    tie *STDOUT, &#39;IO::Scalar&#39;, \my $post;
+    $foo-&gt;foo;
+    is $post, $pre;
+}
+
+{
+    my $foo_parent = Foo-&gt;new;
+    tie *STDOUT, &#39;IO::Scalar&#39;, \my $pre;
+    $foo_parent-&gt;foo;
+    is $pre, &#34;before_foo\nbefore_foo3\nfoo\n&#34;, &#39;Foo not affected&#39;;
+
+    Foo-&gt;finalize_triggers;
+
+    tie *STDOUT, &#39;IO::Scalar&#39;, \my $post;
+    $foo_parent-&gt;foo;
+    is $post, $pre;
+}
+
+{
+    my $foo_parent = Foo-&gt;new;
+    $foo_parent-&gt;add_trigger&#40;before_foo =&gt; sub { print &#34;before_foo4\n&#34; }&#41;;
+    tie *STDOUT, &#39;IO::Scalar&#39;, \my $pre;
+    $foo_parent-&gt;foo;
+    is $pre, &#34;before_foo\nbefore_foo3\nbefore_foo4\nfoo\n&#34;, &#39;Foo not affected&#39;;
+
+    $foo_parent-&gt;finalize_triggers;
+
+    tie *STDOUT, &#39;IO::Scalar&#39;, \my $post;
+    $foo_parent-&gt;foo;
+    is $post, $pre;
+}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-425764" href="/Public/Bug/Display.html?id=30729#txn-425764">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;22&nbsp;17:12:45&nbsp;2008</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/425764/208236/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/208236">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1007b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Nov 14 10:52:37 2007, ALEXMV wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;   Walking the @ISA stack on every trigger call can be expensive. 
&gt; Attached is a patch which provides -&gt;finalize_triggers, which will cache
&gt; the triggers for either an object or a class.
</div>
I observed that __fetch_all_triggers&#40;&#41; was sucking down a lot of CPU
with Class::DBI and I independently also wrote a trigger cache.  Then I
found this ticket.

I prefer mine because it requires no action on the part of the user.  It
only caches class triggers, object triggers are cheap to get, and it
will clear the cache when a new class trigger is added.

It could be more intelligent about how it clears the cache, doing some
sort of remembering what class inherited triggers from who, but since
one rarely adds new class triggers after the initial startup just
blowing away the cache on each add should be sufficient.

Since @ISA is effectively cached along with the triggers it will go
wonky if @ISA changes after a trigger is called.  Personally, I&#39;m ok
with that.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/425764/208239/fetch_all_triggers_cache.patch">Download fetch_all_triggers_cache.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- lib/Class/Trigger.pm	&#40;revision 54556&#41;
+++ lib/Class/Trigger.pm	&#40;local&#41;
@@ -7,6 +7,7 @@
 use Carp &#40;&#41;;
 
 my &#40;%Triggers, %TriggerPoints&#41;;
+my %Fetch_All_Triggers_Cache;
 
 sub import {
     my $class = shift;
@@ -43,6 +44,11 @@
     Carp::croak&#40;&#39;add_trigger&#40;&#41; needs coderef&#39;&#41; unless ref&#40;$code&#41; eq &#39;CODE&#39;;
     push @{ $triggers-&gt;{$when} }, [ $code, $abortable ];
 
+    # Clear the cache when class triggers are added.  Because triggers are 
+    # inherited adding a trigger to one class may effect others.  Simplest
+    # thing to do is to clear the whole thing.
+    %Fetch_All_Triggers_Cache = &#40;&#41; unless ref $proto;
+
     1;
 }
 
@@ -84,6 +90,11 @@
     my &#40;$obj, $when, $list, $order&#41; = @_;
     my $class = ref $obj || $obj;
     my $return;
+    my $when_key = defined $when ? $when : &#39;&#39;;
+    
+    return __cached_triggers&#40;$obj, $when&#41;
+        if $Fetch_All_Triggers_Cache{$class}{$when_key};
+    
     unless &#40;$list&#41; {
         # Absence of the $list parameter conditions the creation of
         # the unrolled list of triggers. These keep track of the unique
@@ -114,14 +125,34 @@
         foreach my $class &#40;@$order&#41; {
             push @triggers, @{ $list-&gt;{$class} };
         }
-        if &#40;ref $obj &#38;&#38; defined $when&#41; {
-            my $obj_triggers = $obj-&gt;{__triggers}{$when};
-            push @triggers, @$obj_triggers if $obj_triggers;
-        }
-        return @triggers;
+
+        # Only cache the class triggers, object triggers would
+        # necessitate a much larger cache and they&#39;re cheap to
+        # get anyway.
+        $Fetch_All_Triggers_Cache{$class}{$when_key} = \@triggers;
+
+        return __cached_triggers&#40;$obj, $when&#41;;
     }
 }
 
+
+sub __cached_triggers {
+    my&#40;$proto, $when&#41; = @_;
+    my $class = ref $proto || $proto;
+    
+    return @{ $Fetch_All_Triggers_Cache{$class}{$when || &#39;&#39;} },
+           @{ __object_triggers&#40;$proto, $when&#41; };
+}
+
+
+sub __object_triggers {
+    my&#40;$obj, $when&#41; = @_;
+    
+    return [] unless ref $obj &#38;&#38; defined $when;
+    return $obj-&gt;{__triggers}{$when} || [];
+}
+
+
 sub __validate_triggerpoint {
     return unless my $points = $TriggerPoints{ref $_[0] || $_[0]};
     my &#40;$self, $when&#41; = @_;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-425765" href="/Public/Bug/Display.html?id=30729#txn-425765">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;22&nbsp;17:12:48&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.354398</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
