<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #63493 for DBIx-Class: _dbh_last_insert_id</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #63493 for DBIx-Class: _dbh_last_insert_id</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBIx-Class/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Class">DBIx-Class CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">63493</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBIx-Class/Active/">DBIx-Class</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">abraxxa [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mwiesen [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-10410-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.08124    </td>
  </tr>
  <tr id="CF-10411-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.08125    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;01&nbsp;04:22:49&nbsp;2010</span>
    <span class="description">mwiesen [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> _dbh_last_insert_id</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Pre-conditions:
*Oracle 11g database
*Insert row into a table with auto-increment id
*2 or more database schemas &#40;e.g. sym10 and sym30&#41;
*Authentication with sym30 user -&gt; default schema is sym30

Attention: Bug is not present in version 0.08115 of DBIx::Class and the
module DBIx::Class::Storage::DBI::Oracle::Generic didn&#39;t change between
the two versions.

Code snippet that fails:
$dbh-&gt;resultset&#40;&#39;Cfgproperty&#39;&#41;-&gt;create&#40; $data_entry &#41;;

Module DBIx::Class::Storage::DBI::Oracle::Generic determines the maximum
sequence number of the auto-increment column &#40;_dbh_last_insert_id&#41;.

The auto-increment trigger is defined as follows:

create or replace trigger ai_cfgproperty
  BEFORE INSERT
  ON cfgproperty

  for each row

DECLARE NUMROWS INTEGER;
BEGIN
select cfgid.nextval
into :NEW.cfgid
FROM dual;
END;


_dbh_get_autoinc_seq fetches two records. One for each schema. 
The column owner will not be considered if the schema name is not given
at the insert statement.

Hence, the database command
insert into cfgproperty ... &#40;sym30, because default schema of the user&#41;
instead of 
insert into sym30.cfgproperty 
is created.

Because of the declaration of the trigger, the schema of the table is
still unknown.

The following statement then fails:

Eval hat eine Exception abgefangen: &#39;DBIx::Class::ResultSet::create&#40;&#41;:
DBI Exception: DBD::Oracle::db selectrow_array failed: ORA-00942: table
or view does not exist &#40;DBD ERROR: error possibly near &lt;*&gt; indicator at
char 13 in &#39;SELECT SYM10.&lt;*&gt;cfgid.currval FROM DUAL&#39;&#41; [for Statement
&#34;SELECT SYM10.cfgid.currval FROM DUAL&#34;] at ....

The statement is addressing the cfgid column of the schema sym10, but
the insert should be done on the table within sym30.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;01&nbsp;06:30:47&nbsp;2010</span>
    <span class="description">abraxxa [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is already fixed in the git repo:
<span class="clickylink"><a target="new" rel="nofollow" href="http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=dbsrgits/DBIx-Class.git;a=commitdiff;h=6f5f880dacae5dcad72178f33916cce0e662a9f9">http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=dbsrgits/DBIx-Class.git;a=commitdiff;h=6f5f880dacae5dcad72178f33916cce0e662a9f9</a></span>

Please test if git master works for you.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;01&nbsp;06:30:48&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;01&nbsp;06:31:00&nbsp;2010</span>
    <span class="description">abraxxa [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;01&nbsp;08:50:44&nbsp;2010</span>
    <span class="description">mwiesen [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mwiesen [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Mi 01. Dez 2010, 06:30:47, ABRAXXA schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is already fixed in the git repo:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=dbsrgits/DBIx-">http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=dbsrgits/DBIx-</a></span>
&gt; Class.git;a=commitdiff;h=6f5f880dacae5dcad72178f33916cce0e662a9f9
&gt; 
&gt; Please test if git master works for you.
</div>

Still doesn&#39;t work.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;01&nbsp;08:58:26&nbsp;2010</span>
    <span class="description">mwiesen [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mwiesen [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry, here is the exception:

Eval hat eine Exception abgefangen: &#39;DBIx::Class::ResultSet::create&#40;&#41;:
Unable to reliably select a BEFORE INSERT trigger for column
CFGPROPERTY.cfgid &#40;possibilities: &#39;AI_CFGPROPERTY&#39;, &#39;AI_CFGPROPERTY&#39;&#41;.
You need to specify the correct &#39;sequence&#39; explicitly in &#39;cfgid&#39;s
column_info. at ...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;13&nbsp;11:09:43&nbsp;2010</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, sorry for not replying sooner.

On Wed Dec 01 04:22:49 2010, mwiesen wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Pre-conditions:
&gt; *Oracle 11g database
&gt; *Insert row into a table with auto-increment id
&gt; *2 or more database schemas &#40;e.g. sym10 and sym30&#41;
&gt; *Authentication with sym30 user -&gt; default schema is sym30
&gt; 
&gt; Attention: Bug is not present in version 0.08115 of DBIx::Class and the
&gt; module DBIx::Class::Storage::DBI::Oracle::Generic didn&#39;t change between
&gt; the two versions.
</div>
Of course it did :&#41;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Code snippet that fails:
&gt; $dbh-&gt;resultset&#40;&#39;Cfgproperty&#39;&#41;-&gt;create&#40; $data_entry &#41;;
&gt; 
&gt; Module DBIx::Class::Storage::DBI::Oracle::Generic determines the maximum
&gt; sequence number of the auto-increment column &#40;_dbh_last_insert_id&#41;.
&gt; 
&gt; The auto-increment trigger is defined as follows:
&gt; 
&gt; create or replace trigger ai_cfgproperty
&gt;   BEFORE INSERT
&gt;   ON cfgproperty
&gt; 
&gt;   for each row
&gt; 
&gt; DECLARE NUMROWS INTEGER;
&gt; BEGIN
&gt; select cfgid.nextval
&gt; into :NEW.cfgid
&gt; FROM dual;
&gt; END;
&gt; 
&gt; 
&gt; _dbh_get_autoinc_seq fetches two records. One for each schema. 
&gt; The column owner will not be considered if the schema name is not given
&gt; at the insert statement.
&gt; 
&gt; Hence, the database command
&gt; insert into cfgproperty ... &#40;sym30, because default schema of the user&#41;
&gt; instead of 
&gt; insert into sym30.cfgproperty 
&gt; is created.
&gt; 
&gt; Because of the declaration of the trigger, the schema of the table is
&gt; still unknown.
</div>
^^ I am a bit confused here. Are you saying that you have identically
named sequences in two schemas, and dbic gets back the wrong one? And
are you saying that it *did* work correctly on 08115? You are sure it
wasn&#39;t silently reading from the wrong sequence?

My main question remaining after reading your report is &#34;if I do not
know the schema, how can I possibly select the correct sequence?&#34; Maybe
I am overlooking something obvious, please share :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;14&nbsp;02:53:05&nbsp;2010</span>
    <span class="description">mwiesen [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mwiesen [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Mo 13. Dez 2010, 11:09:43, RIBASUSHI schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, sorry for not replying sooner.
&gt; 
&gt; On Wed Dec 01 04:22:49 2010, mwiesen wrote:
<div class="message-stanza open">&gt; &gt; Pre-conditions:
&gt; &gt; *Oracle 11g database
&gt; &gt; *Insert row into a table with auto-increment id
&gt; &gt; *2 or more database schemas &#40;e.g. sym10 and sym30&#41;
&gt; &gt; *Authentication with sym30 user -&gt; default schema is sym30
&gt; &gt; 
&gt; &gt; Attention: Bug is not present in version 0.08115 of DBIx::Class and the
&gt; &gt; module DBIx::Class::Storage::DBI::Oracle::Generic didn&#39;t change between
&gt; &gt; the two versions.
</div>&gt; 
&gt; Of course it did :&#41;
&gt; 
&gt; 
<div class="message-stanza open">&gt; &gt; Code snippet that fails:
&gt; &gt; $dbh-&gt;resultset&#40;&#39;Cfgproperty&#39;&#41;-&gt;create&#40; $data_entry &#41;;
&gt; &gt; 
&gt; &gt; Module DBIx::Class::Storage::DBI::Oracle::Generic determines the maximum
&gt; &gt; sequence number of the auto-increment column &#40;_dbh_last_insert_id&#41;.
&gt; &gt; 
&gt; &gt; The auto-increment trigger is defined as follows:
&gt; &gt; 
&gt; &gt; create or replace trigger ai_cfgproperty
&gt; &gt;   BEFORE INSERT
&gt; &gt;   ON cfgproperty
&gt; &gt; 
&gt; &gt;   for each row
&gt; &gt; 
&gt; &gt; DECLARE NUMROWS INTEGER;
&gt; &gt; BEGIN
&gt; &gt; select cfgid.nextval
&gt; &gt; into :NEW.cfgid
&gt; &gt; FROM dual;
&gt; &gt; END;
&gt; &gt; 
&gt; &gt; 
&gt; &gt; _dbh_get_autoinc_seq fetches two records. One for each schema. 
&gt; &gt; The column owner will not be considered if the schema name is not given
&gt; &gt; at the insert statement.
&gt; &gt; 
&gt; &gt; Hence, the database command
&gt; &gt; insert into cfgproperty ... &#40;sym30, because default schema of the user&#41;
&gt; &gt; instead of 
&gt; &gt; insert into sym30.cfgproperty 
&gt; &gt; is created.
&gt; &gt; 
&gt; &gt; Because of the declaration of the trigger, the schema of the table is
&gt; &gt; still unknown.
</div>&gt; 
&gt; ^^ I am a bit confused here. Are you saying that you have identically
&gt; named sequences in two schemas, and dbic gets back the wrong one? And
&gt; are you saying that it *did* work correctly on 08115? You are sure it
&gt; wasn&#39;t silently reading from the wrong sequence?
&gt; 
&gt; My main question remaining after reading your report is &#34;if I do not
&gt; know the schema, how can I possibly select the correct sequence?&#34; Maybe
&gt; I am overlooking something obvious, please share :&#41;
</div>
Hi, yes that might be right. The sequence could be determined out of the
wrong schema. We didn&#39;t mention that, because the schemas are used for
versioning. I.E. Verison 1 sym10, version 2 sym20 and version 3 sym30.
The data will be migrated to the new schema and the write access to the
old one will be removed. Hence we didn&#39;t mention the bug in 80115.

I don&#39;t know, if I&#39;m right, but you can determine the schema by the
default schema of the user which is logged in. The user name is the
default schema, if nothing other is defined.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;15&nbsp;06:46:47&nbsp;2010</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 14 02:53:05 2010, mwiesen wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Am Mo 13. Dez 2010, 11:09:43, RIBASUSHI schrieb:
<div class="message-stanza open">&gt; &gt; Hi, sorry for not replying sooner.
&gt; &gt; 
&gt; &gt; On Wed Dec 01 04:22:49 2010, mwiesen wrote:
<div class="message-stanza open">&gt; &gt; &gt; Pre-conditions:
&gt; &gt; &gt; *Oracle 11g database
&gt; &gt; &gt; *Insert row into a table with auto-increment id
&gt; &gt; &gt; *2 or more database schemas &#40;e.g. sym10 and sym30&#41;
&gt; &gt; &gt; *Authentication with sym30 user -&gt; default schema is sym30
&gt; &gt; &gt; 
&gt; &gt; &gt; Attention: Bug is not present in version 0.08115 of DBIx::Class
</div></div></div>and the
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; &gt; module DBIx::Class::Storage::DBI::Oracle::Generic didn&#39;t change
</div></div>between
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; the two versions.
</div>&gt; &gt; 
&gt; &gt; Of course it did :&#41;
&gt; &gt; 
&gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; Code snippet that fails:
&gt; &gt; &gt; $dbh-&gt;resultset&#40;&#39;Cfgproperty&#39;&#41;-&gt;create&#40; $data_entry &#41;;
&gt; &gt; &gt; 
&gt; &gt; &gt; Module DBIx::Class::Storage::DBI::Oracle::Generic determines the
</div></div></div>maximum
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; &gt; sequence number of the auto-increment column &#40;_dbh_last_insert_id&#41;.
&gt; &gt; &gt; 
&gt; &gt; &gt; The auto-increment trigger is defined as follows:
&gt; &gt; &gt; 
&gt; &gt; &gt; create or replace trigger ai_cfgproperty
&gt; &gt; &gt;   BEFORE INSERT
&gt; &gt; &gt;   ON cfgproperty
&gt; &gt; &gt; 
&gt; &gt; &gt;   for each row
&gt; &gt; &gt; 
&gt; &gt; &gt; DECLARE NUMROWS INTEGER;
&gt; &gt; &gt; BEGIN
&gt; &gt; &gt; select cfgid.nextval
&gt; &gt; &gt; into :NEW.cfgid
&gt; &gt; &gt; FROM dual;
&gt; &gt; &gt; END;
&gt; &gt; &gt; 
&gt; &gt; &gt; 
&gt; &gt; &gt; _dbh_get_autoinc_seq fetches two records. One for each schema. 
&gt; &gt; &gt; The column owner will not be considered if the schema name is not
</div></div>given
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; &gt; at the insert statement.
&gt; &gt; &gt; 
&gt; &gt; &gt; Hence, the database command
&gt; &gt; &gt; insert into cfgproperty ... &#40;sym30, because default schema of the
</div></div>user&#41;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; instead of 
&gt; &gt; &gt; insert into sym30.cfgproperty 
&gt; &gt; &gt; is created.
&gt; &gt; &gt; 
&gt; &gt; &gt; Because of the declaration of the trigger, the schema of the table is
&gt; &gt; &gt; still unknown.
</div>&gt; &gt; 
&gt; &gt; ^^ I am a bit confused here. Are you saying that you have identically
&gt; &gt; named sequences in two schemas, and dbic gets back the wrong one? And
&gt; &gt; are you saying that it *did* work correctly on 08115? You are sure it
&gt; &gt; wasn&#39;t silently reading from the wrong sequence?
&gt; &gt; 
&gt; &gt; My main question remaining after reading your report is &#34;if I do not
&gt; &gt; know the schema, how can I possibly select the correct sequence?&#34; Maybe
&gt; &gt; I am overlooking something obvious, please share :&#41;
</div>&gt; 
&gt; Hi, yes that might be right. The sequence could be determined out of the
&gt; wrong schema. We didn&#39;t mention that, because the schemas are used for
&gt; versioning. I.E. Verison 1 sym10, version 2 sym20 and version 3 sym30.
&gt; The data will be migrated to the new schema and the write access to the
&gt; old one will be removed. Hence we didn&#39;t mention the bug in 80115.
&gt; 
&gt; I don&#39;t know, if I&#39;m right, but you can determine the schema by the
&gt; default schema of the user which is logged in. The user name is the
&gt; default schema, if nothing other is defined.
</div>
This is indeed a sane way forward:
<span class="clickylink"><a target="new" rel="nofollow" href="http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=dbsrgits/DBIx-Class.git;a=commit;h=676705fafba4d0006ca1ced87a071bb403b3182c">http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=dbsrgits/DBIx-Class.git;a=commit;h=676705fafba4d0006ca1ced87a071bb403b3182c</a></span>

I expect this to release some time this week, but you can test it
immediately by checking out
git://git.shadowcat.co.uk/dbsrgits/DBIx-Class.git branch
people/abraxxa/oracle_returning &#40;which also requires an unreleased
git://git.shadowcat.co.uk/dbsrgits/SQL-Abstract.git master to run&#41;.

Cheers
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;15&nbsp;06:46:48&nbsp;2010</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;27&nbsp;05:30:42&nbsp;2010</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;27&nbsp;05:30:43&nbsp;2010</span>
    <span class="description">ribasushi [...] leporine.io -  Fixed in 0.08125 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
