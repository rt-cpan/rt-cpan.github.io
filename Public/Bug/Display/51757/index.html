<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #51757 for Finance-Quote: New module to fetch the value of Romanian Mutual Funds</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #51757 for Finance-Quote: New module to fetch the value of Romanian Mutual Funds</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Finance-Quote">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Finance-Quote">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Finance-Quote">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Finance-Quote">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Finance-Quote">Finance-Quote CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">51757</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Finance-Quote">Finance-Quote</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
strainu10 [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-13576-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-13577-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




ROFunds.pm<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/696329/359087/ROFunds.pm">
Mon Nov 23 15:23:06 2009 (4.5k) by strainu10 [...] gmail.com
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/693640/357435/ROFunds.pm">
Thu Nov 19 16:47:46 2009 (4.3k) by strainu10 [...] gmail.com
</a>
</font></li>
</ul>


ROFUNDS.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/693640/357438/ROFUNDS.t">
Thu Nov 19 16:47:46 2009 (1k) by strainu10 [...] gmail.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=51757">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-693640" href="/Public/Bug/Display.html?id=51757#txn-693640">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;19&nbsp;16:47:46&nbsp;2009</span>
    <span class="description">strainu10 [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> New module to fetch the value of Romanian Mutual Funds</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/693640/357432/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/357432">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 425b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I made a new module to fetch the values for some Romanian Mutual Funds
from the www.kmarket.ro site. Only the funds listed at
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.kmarket.ro/fonduri/fonduri.php">http://www.kmarket.ro/fonduri/fonduri.php</a></span> are covered. Because this is
not an exchange, there are no symbols and instead, you have to use the
name of the funds as they are mentioned at the above location. The case
is not relevant.

I&#39;m attaching the module and the test file.

Thanks,
   Andrei
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ROFunds.pm</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/693640/357435/ROFunds.pm">Download ROFunds.pm</a><br />
<span class="downloadcontenttype">text/x-perl 4.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w
#    This modules is based on the Finance::Quote::ASEGR module
#
#    The code has been modified by Andrei Cipu &lt;strainu@strainu.ro&gt; to be able to
#    retrieve stock information from the Bucharest Exchange in Romania.
#
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    &#40;at your option&#41; any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program; if not, write to the Free Software
#    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
#    02111-1307, USA
require 5.005;

use strict;

package Finance::Quote::ROFunds;

use vars qw&#40;$VERSION $ROFUNDS_URL&#41;;

use LWP::UserAgent;
use HTTP::Request::Common;
use HTML::TableExtract;

$VERSION=&#39;0.1&#39;;

my $ROFUNDS_URL = &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.kmarket.ro/fonduri/sumare/sumarfonduri12112009.htm&#39;">http://www.kmarket.ro/fonduri/sumare/sumarfonduri12112009.htm&#39;</a></span>;


sub methods { return &#40; romania =&gt; \&#38;rofunds,
			rofunds =&gt; \&#38;rofunds,
			europe =&gt; \&#38;rofunds&#41;; }
{ 
	my @labels = qw/name last date isodate p_change currency method exchange/;

	sub labels { return &#40;romania =&gt; \@labels,
			     rofunds =&gt; \@labels,
			     europe =&gt; \@labels&#41;; } 
}

sub rofunds {

	my $quoter = shift;
	my @stocks = @_;
	my &#40;%info,$reply,$url,$te,$ts,$row,@cells, $ce&#41;;
    my&#40;$my_date,$my_last,$my_p_change&#41;;
	my $ua = $quoter-&gt;user_agent&#40;&#41;;

	$url = $ROFUNDS_URL;
	
	foreach my $stocks &#40;@stocks&#41;
	{
		$reply = $ua-&gt;request&#40;GET $url&#41;;

		if &#40;$reply-&gt;is_success&#41; 
		{
			
			$te = new HTML::TableExtract&#40;&#41;;

			$te-&gt;parse&#40;$reply-&gt;content&#41;;

			unless &#40; $te-&gt;tables&#41;
			{
				$info {$stocks,&#34;success&#34;} = 0;
				$info {$stocks,&#34;errormsg&#34;} = &#34;Stock name $stocks not found&#34;;
				next;
			}
            
            $ts = $te-&gt;first_table_found&#40;&#41;;
            
            foreach $row &#40;$ts-&gt;rows&#41; {
                @cells = @$row;
				
				$ce = $cells[1];
				#we found the date
				if&#40;substr&#40;$ce, 0, 4&#41; eq &#34;Data&#34;&#41;
				{
					$my_date = $cells[2];
				}
				
				#the fund name is in the second column
				if&#40;substr&#40;lc&#40;$ce&#41;, 0, length&#40;$stocks&#41;&#41; eq lc&#40;$stocks&#41;&#41;
				{
					$my_last = $cells[3];
					$my_p_change = $cells[4];
                }
            }
			
			$info{$stocks, &#34;success&#34;}   =1;
			$info{$stocks, &#34;exchange&#34;}  =&#34;Romanian Funds&#34;;
			$info{$stocks, &#34;method&#34;}    =&#34;rofunds&#34;;
			$info{$stocks, &#34;name&#34;}      =$stocks;
			$info{$stocks, &#34;last&#34;}      =$my_last;
			$info{$stocks, &#34;close&#34;}     =$my_last;
			$info{$stocks, &#34;p_change&#34;}  =$my_p_change;

            $quoter-&gt;store_date&#40;\%info, $stocks, {eurodate =&gt; $my_date}&#41;;

			$info{$stocks,&#34;currency&#34;} = &#34;RON&#34;;#TODO this will not work when funds denominated in EUR will appear.

		} else {
   			$info{$stocks, &#34;success&#34;}=0;
			$info{$stocks, &#34;errormsg&#34;}=&#34;Error retreiving $stocks &#34;;	
		}
	}
	return wantarray&#40;&#41; ? %info : \%info;
	return \%info;
}

=head1 NAME

Finance::Quote::ROFUNDS Obtain weekly values for the Romanian open Mutual Funds

=head1 SYNOPSIS

    use Finance::Quote;

    $q = Finance::Quote-&gt;new;

    %info = Finance::Quote-&gt;fetch&#40;&#34;rofunds&#34;,&#34;bt index&#34;&#41;;  # Only query ROFUNDS
    %info = Finance::Quote-&gt;fetch&#40;&#34;romania&#34;,&#34;simfonia 1&#34;&#41;; # Failover to other sources OK. 

=head1 DESCRIPTION

This module fetches information from the Kmarket site, <span class="clickylink"><a target="new" rel="nofollow" href="http://www.kmarket.ro">http://www.kmarket.ro</a></span>. 
Only the funds listed at <span class="clickylink"><a target="new" rel="nofollow" href="http://www.kmarket.ro/fonduri/fonduri.php">http://www.kmarket.ro/fonduri/fonduri.php</a></span> are available.

This module is loaded by default on a Finance::Quote object. It&#39;s 
also possible to load it explicity by placing &#34;ROFUNDS&#34; in the argument
list to Finance::Quote-&gt;new&#40;&#41;.

This module provides both the &#34;rofunds&#34; and &#34;romania&#34; fetch methods.
Please use the &#34;romania&#34; fetch method if you wish to have failover
with future sources for Romanian stocks. Using the &#34;rofunds&#34; method will
guarantee that your information only comes from the kmarket site.
 
Information obtained by this module may be covered by www.kmarket.ro 
terms and conditions See <span class="clickylink"><a target="new" rel="nofollow" href="http://www.kmarket.ro/">http://www.kmarket.ro/</a></span> for details.

=head1 LABELS RETURNED

The following labels may be returned by Finance::Quote::BSERO :
name, last, date, p_change, currency, method, exchange.

=head1 SEE ALSO

Kmarket, <span class="clickylink"><a target="new" rel="nofollow" href="http://www.kmarket.ro">http://www.kmarket.ro</a></span>

=cut

	
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ROFUNDS.t</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/693640/357438/ROFUNDS.t">Download ROFUNDS.t</a><br />
<span class="downloadcontenttype">text/x-perl 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w
use strict;
use Test;
use Data::Dumper;
BEGIN {plan tests =&gt; 26};

use Finance::Quote;

# Test BSERO functions.

my $q      = Finance::Quote-&gt;new&#40;&#41;;
my @stocks = &#40;&#34;BT Index&#34;, &#34;SIMFONIA 1&#34;, &#34;OPORTUNITATI NATIONALE&#34;&#41;;

my %regexps = &#40;
	&#34;BT Index&#34;  =&gt; qr/\bBT Index\b/,
	&#34;SIMFONIA 1&#34; =&gt; qr/\bSIMFONIA 1\b/,
	&#34;OPORTUNITATI NATIONALE&#34; =&gt; qr/\bOPORTUNITATI NATIONALE\b/,
&#41;;


my %quotes = $q-&gt;fetch&#40;&#34;rofunds&#34;, @stocks&#41;;
ok&#40;%quotes&#41;;
foreach my $stock &#40;@stocks&#41; {

	print $quotes{$stock, &#34;date&#34;}.&#34;\n&#34;;
	my $name = $quotes{$stock, &#34;name&#34;};
	print &#34;#Testing $stock: $name\n&#34;;

	my $regexp = $regexps{$stock};
	ok&#40;$name =~ /$regexp/i&#41;;

	ok&#40;$quotes{$stock, &#34;exchange&#34;} eq &#39;Romanian Funds&#39;&#41;;
	ok&#40;$quotes{$stock, &#34;method&#34;} eq &#39;rofunds&#39;&#41;;

	ok&#40;$quotes{$stock, &#34;last&#34;} &gt; 0&#41;;
	ok&#40;$quotes{$stock, &#34;p_change&#34;} =~ /^-?\d+\.\d+$/&#41;;
	ok&#40;$quotes{$stock, &#34;success&#34;}&#41;;
}


# Check that a bogus stock returns no-success.
%quotes = $q-&gt;fetch&#40;&#34;tsx&#34;, &#34;BOGUS&#34;&#41;;
ok&#40;! $quotes{&#34;BOGUS&#34;,&#34;success&#34;}&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-696329" href="/Public/Bug/Display.html?id=51757#txn-696329">#</a>      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;23&nbsp;15:23:06&nbsp;2009</span>
    <span class="description">strainu10 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/696329/359084/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/359084">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 66b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just realised I had put a static URL. Uploading the new version...
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/696329/359087/ROFunds.pm">Download ROFunds.pm</a><br />
<span class="downloadcontenttype">text/x-perl 4.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w
#    This modules is based on the Finance::Quote::ASEGR module
#
#    The code has been modified by Andrei Cipu &lt;strainu@strainu.ro&gt; to be able to
#    retrieve stock information from the Bucharest Exchange in Romania.
#
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    &#40;at your option&#41; any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program; if not, write to the Free Software
#    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
#    02111-1307, USA
require 5.005;

use strict;

package Finance::Quote::ROFunds;

use vars qw&#40;$VERSION $ROFUNDS_URL&#41;;

use LWP::UserAgent;
use HTTP::Request::Common;
use HTML::TableExtract;
use Date::Manip;
Date::Manip::Date_Init&#40;&#34;TZ=GMT&#34;&#41;;

$VERSION=&#39;0.1&#39;;

my $ROFUNDS_URL = &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.kmarket.ro/fonduri/sumare/sumarfonduri&#39;">http://www.kmarket.ro/fonduri/sumare/sumarfonduri&#39;</a></span>;


sub methods { return &#40; romania =&gt; \&#38;rofunds,
			rofunds =&gt; \&#38;rofunds,
			europe =&gt; \&#38;rofunds&#41;; }
{ 
	my @labels = qw/name last date isodate p_change currency method exchange/;

	sub labels { return &#40;romania =&gt; \@labels,
			     rofunds =&gt; \@labels,
			     europe =&gt; \@labels&#41;; } 
}

sub rofunds {

	my $quoter = shift;
	my @stocks = @_;
	my &#40;%info,$reply,$url,$te,$ts,$row,@cells, $ce, $last_date&#41;;
    my&#40;$my_date,$my_last,$my_p_change&#41;;
	my $ua = $quoter-&gt;user_agent&#40;&#41;;

	$url = $ROFUNDS_URL;
	$last_date = UnixDate&#40; ParseDate&#40;&#34;last Thursday&#34;&#41;, &#34;%d%m%Y&#34; &#41;;
	
	foreach my $stocks &#40;@stocks&#41;
	{
		$reply = $ua-&gt;request&#40;GET $url.join&#40;&#39;&#39;,$last_date,&#34;.htm&#34;&#41;&#41;;

		if &#40;$reply-&gt;is_success&#41; 
		{
			
			$te = new HTML::TableExtract&#40;&#41;;

			$te-&gt;parse&#40;$reply-&gt;content&#41;;

			unless &#40; $te-&gt;tables&#41;
			{
				$info {$stocks,&#34;success&#34;} = 0;
				$info {$stocks,&#34;errormsg&#34;} = &#34;Stock name $stocks not found&#34;;
				next;
			}
            
            $ts = $te-&gt;first_table_found&#40;&#41;;
            
            foreach $row &#40;$ts-&gt;rows&#41; {
                @cells = @$row;
				
				$ce = $cells[1];
				#we found the date
				if&#40;substr&#40;$ce, 0, 4&#41; eq &#34;Data&#34;&#41;
				{
					$my_date = $cells[2];
				}
				
				#the fund name is in the second column
				if&#40;substr&#40;lc&#40;$ce&#41;, 0, length&#40;$stocks&#41;&#41; eq lc&#40;$stocks&#41;&#41;
				{
					$my_last = $cells[3];
					$my_p_change = $cells[4];
                }
            }
			
			$info{$stocks, &#34;success&#34;}   =1;
			$info{$stocks, &#34;exchange&#34;}  =&#34;Romanian Funds&#34;;
			$info{$stocks, &#34;method&#34;}    =&#34;rofunds&#34;;
			$info{$stocks, &#34;name&#34;}      =$stocks;
			$info{$stocks, &#34;last&#34;}      =$my_last;
			$info{$stocks, &#34;close&#34;}     =$my_last;
			$info{$stocks, &#34;p_change&#34;}  =$my_p_change;

            $quoter-&gt;store_date&#40;\%info, $stocks, {eurodate =&gt; $my_date}&#41;;

			$info{$stocks,&#34;currency&#34;} = &#34;RON&#34;;#TODO this will not work when funds denominated in EUR will appear.

		} else {
   			$info{$stocks, &#34;success&#34;}=0;
			$info{$stocks, &#34;errormsg&#34;}=&#34;Error retreiving $stocks &#34;;	
		}
	}
	return wantarray&#40;&#41; ? %info : \%info;
	return \%info;
}

=head1 NAME

Finance::Quote::ROFUNDS Obtain weekly values for the Romanian open Mutual Funds

=head1 SYNOPSIS

    use Finance::Quote;

    $q = Finance::Quote-&gt;new;

    %info = Finance::Quote-&gt;fetch&#40;&#34;rofunds&#34;,&#34;bt index&#34;&#41;;  # Only query ROFUNDS
    %info = Finance::Quote-&gt;fetch&#40;&#34;romania&#34;,&#34;simfonia 1&#34;&#41;; # Failover to other sources OK. 

=head1 DESCRIPTION

This module fetches information from the Kmarket site, <span class="clickylink"><a target="new" rel="nofollow" href="http://www.kmarket.ro">http://www.kmarket.ro</a></span>. 
Only the funds listed at <span class="clickylink"><a target="new" rel="nofollow" href="http://www.kmarket.ro/fonduri/fonduri.php">http://www.kmarket.ro/fonduri/fonduri.php</a></span> are available.

This module is loaded by default on a Finance::Quote object. It&#39;s 
also possible to load it explicity by placing &#34;ROFUNDS&#34; in the argument
list to Finance::Quote-&gt;new&#40;&#41;.

This module provides both the &#34;rofunds&#34; and &#34;romania&#34; fetch methods.
Please use the &#34;romania&#34; fetch method if you wish to have failover
with future sources for Romanian stocks. Using the &#34;rofunds&#34; method will
guarantee that your information only comes from the kmarket site.
 
Information obtained by this module may be covered by www.kmarket.ro 
terms and conditions See <span class="clickylink"><a target="new" rel="nofollow" href="http://www.kmarket.ro/">http://www.kmarket.ro/</a></span> for details.

=head1 LABELS RETURNED

The following labels may be returned by Finance::Quote::BSERO :
name, last, date, p_change, currency, method, exchange.

=head1 SEE ALSO

Kmarket, <span class="clickylink"><a target="new" rel="nofollow" href="http://www.kmarket.ro">http://www.kmarket.ro</a></span>

=cut

	
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-696331" href="/Public/Bug/Display.html?id=51757#txn-696331">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;23&nbsp;15:23:07&nbsp;2009</span>
    <span class="description">strainu10 [...] gmail.com -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.450029</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
