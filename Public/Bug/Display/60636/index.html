<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #60636 for DBD-DB2: bug</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #60636 for DBD-DB2: bug</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-DB2/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-DB2/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-DB2/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-DB2/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-DB2">DBD-DB2 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">60636</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-DB2/Active/">DBD-DB2</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
henrytu [...] us.ibm.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10084-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10085-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;23&nbsp;09:56:18&nbsp;2010</span>
    <span class="description">henrytu [...] us.ibm.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> bug</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 23 Aug 2010 09:55:58 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-DB2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Henry Turco &lt;henrytu [...] us.ibm.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Praveen,

We are in the process of migrating from DB2 v8 to DB2 v9.5 on an s390x 
GNU/Linux system. I installed the latest DBD module &#40;DBD-DB2-1.79&#41; and we 
are running perl v5.8.8.

One of the problems I ran into was with LOB data. If you select a LOB 
column in an outer loop and then do another query inside the loop, the LOB 
ID was getting invalidated. It worked for the first row fetched, then all 
subsequent rows were messed up &#40;i.e. the LOB data was coming back 
undefined but the other non-LOB columns were coming back fine.&#41; After much 
trial and error, I decided to switch all the LOB processing to work like 
you had the XML processing. So I used SQLGetData&#40;&#41; instead of 
SQLGetLength&#40;&#41; and SQLGetSubString&#40;&#41;. That way I eliminated using the LOB 
IDs altogether. But I was wondering if that was a bad approach? It seems 
to be working ok in our initial tests. But I was wondering why you didn&#39;t 
do it this way from the start.

static SQLRETURN bind_lob_column_helper&#40; imp_fbh_t *fbh, SQLINTEGER 
col_num &#41; {
  switch&#40; fbh-&gt;dbtype &#41; {
    case SQL_CLOB:
      fbh-&gt;ftype = SQL_C_CHAR;
      break;

    case SQL_BLOB:
      fbh-&gt;ftype = SQL_C_BINARY;
      break;

    case SQL_DBCLOB:
      fbh-&gt;ftype = SQL_C_CHAR;
      break;

    case SQL_XML:
      fbh-&gt;ftype = SQL_C_BINARY;
      break;
  }
  fbh-&gt;rlen  = fbh-&gt;bufferSize = fbh-&gt;dsize = 0;
  return SQL_SUCCESS;
}

in static int dbd_describe&#40;&#41;
I removed this:
                  else if&#40;SQL_BLOB == fbh-&gt;dbtype || 
                                SQL_CLOB == fbh-&gt;dbtype ||
                                SQL_DBCLOB == fbh-&gt;dbtype&#41; {
                        fbh-&gt;ftype = fbh-&gt;dbtype;
                        fbh-&gt;rlen = bufferSizeRequired = fbh-&gt;dsize = 
fbh-&gt;prec;
                  }
                  else if &#40;SQL_XML == fbh-&gt;dbtype&#41; {
                        fbh-&gt;ftype = SQL_C_BINARY;
                        fbh-&gt;rlen = bufferSizeRequired = fbh-&gt;dsize = -1;
                  }
and replaced it with this:
          else if&#40;SQL_CLOB == fbh-&gt;dbtype||
                    SQL_DBCLOB == fbh-&gt;dbtype&#41; {
                fbh-&gt;ftype = SQL_C_CHAR;
                fbh-&gt;rlen = bufferSizeRequired = fbh-&gt;dsize = -1;
          }
          else if &#40;SQL_XML == fbh-&gt;dbtype ||
                    SQL_BLOB == fbh-&gt;dbtype&#41; {
                fbh-&gt;ftype = SQL_C_BINARY;
                fbh-&gt;rlen = bufferSizeRequired = fbh-&gt;dsize = -1;
          }


static SQLRETURN get_lob_length&#40; imp_fbh_t *fbh, SQLINTEGER col_num, 
SQLHANDLE hdbc &#41;{
  SQLHANDLE        new_hstmt;
  SQLRETURN        rc;

  if&#40; fbh-&gt;loc_ind == SQL_NULL_DATA &#41; { /* If column value is NULL then 
set rlen to -1 and return SQL_SUCCESS */
    fbh-&gt;rlen = -1;
    return SQL_SUCCESS;
  }

  switch&#40; fbh-&gt;dbtype &#41; {
    case SQL_CLOB:
      fbh-&gt;ftype    =  SQL_C_CHAR;
      break;

    case SQL_BLOB:
      fbh-&gt;ftype    =  SQL_C_BINARY;
      break;

    case SQL_DBCLOB:
      fbh-&gt;ftype    =  SQL_C_CHAR;
      break;

    case SQL_XML:
      fbh-&gt;ftype = SQL_C_BINARY;
  }

  rc = SQLGetData&#40; fbh-&gt;imp_sth-&gt;phstmt,
                   col_num,
                   fbh-&gt;ftype,
                   NULL,
                   0,
                   &#38;fbh-&gt;rlen &#41;;

  return rc;
}

static SQLRETURN get_lob_data&#40; imp_fbh_t *fbh, SQLINTEGER col_num, 
SQLHANDLE hdbc &#41;{
  SQLRETURN        rc;
  SQLINTEGER       out_length = 0;

  switch&#40; fbh-&gt;dbtype &#41; {
    case SQL_CLOB:
      fbh-&gt;ftype    =  SQL_C_CHAR;
      break;

    case SQL_BLOB:
      fbh-&gt;ftype    =  SQL_C_BINARY;
      break;

    case SQL_DBCLOB:
      fbh-&gt;ftype    =  SQL_C_CHAR;
      break;

    case SQL_XML:
      fbh-&gt;ftype = SQL_C_BINARY;
  }

  rc = SQLGetData&#40; fbh-&gt;imp_sth-&gt;phstmt,
                   col_num,
                   fbh-&gt;ftype,
                   fbh-&gt;buffer,
                   fbh-&gt;bufferSize+1,
                   &#38;out_length &#41;;
  fbh-&gt;rlen = out_length;

  return rc;
}


I was wondering if anybody else ran into this problem? I know it&#39;s a bit 
obscure...

-Henry
</div></div>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;25&nbsp;02:12:41&nbsp;2010</span>
    <span class="description">opendev [...] us.ibm.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Henry,

Check this bug report <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=57614">https://rt.cpan.org/Ticket/Display.html?id=57614</a></span>

The issue you are facing is same as logged in ticket 57614. Make changes
as per the suggestion in the ticket and your problem should be resolved.

-- 
Thanks
Praveen
IBM OpenSource Application Development Team
India Software Labs, Bangalore &#40;India&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;25&nbsp;02:12:42&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;11&nbsp;04:02:15&nbsp;2011</span>
    <span class="description">opendev [...] us.ibm.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Marking the defect resolved.
-- 
Thanks
Praveen
IBM OpenSource Application Development Team
India Software Labs, Bangalore &#40;India&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;11&nbsp;04:02:16&nbsp;2011</span>
    <span class="description">opendev [...] us.ibm.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
