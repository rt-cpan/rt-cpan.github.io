<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #88822 for IPC-Open3-Callback: refactoring in IPC::Open3::Callback</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #88822 for IPC-Open3-Callback: refactoring in IPC::Open3::Callback</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/IPC-Open3-Callback/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/IPC-Open3-Callback/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/IPC-Open3-Callback/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/IPC-Open3-Callback/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IPC-Open3-Callback">IPC-Open3-Callback CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">88822</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/IPC-Open3-Callback/Active/">IPC-Open3-Callback</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
arfreitas [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Unimportant    </td>
  </tr>
  <tr id="CF-251412-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.01    </td>
  </tr>
  <tr id="CF-251413-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;19&nbsp;15:37:47&nbsp;2013</span>
    <span class="description">arfreitas [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> refactoring in IPC::Open3::Callback</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Greetings,

I started making a refactoring of the class IPC::Open3::Callback:

1 - forced the class to use an hash reference as parameter during the new&#40;&#41; method invoke to avoid errors like &#34;Odd number of elements in hash assignment at C:/strawberry/perl/site/lib/IPC/Open3/Callback.pm&#34;. That should help with memory utilization too.
2 - Initialization of all attributes during new&#40;&#41;, ans restricting the hash ref keys to those names with lock_keys&#40;&#41; to avoid autovification.
3 - created an separated method to terminate the child process &#40;useful if the program is still executing when the Perl code is aborted&#41; and using it both in DESTROY and run_command&#40;&#41; methods.
4 - created a new attribute: buffer_size. Increasing/decreasing this attribute will affect performance &#40;CPU&#41; and memory utilization.
5 - fixed tests due interface changes
6 - added usage of Test::Most to make test easier to understand &#40;Makefile.PL updated as well&#41;.

All modified files are attached &#40;sorry for not generating patches on them&#41;.

Regards,
Alceu
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Callback.pm</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

package IPC::Open3::Callback::NullLogger;
{
  $IPC::Open3::Callback::NullLogger::VERSION = &#39;1.01&#39;;
}

use AutoLoader;

our $LOG_TO_STDOUT = 0;

sub AUTOLOAD {
    shift;
    print&#40; &#34;IPC::Open3::Callback::NullLogger: @_\n&#34; &#41; if $LOG_TO_STDOUT;
}

sub new {
    return bless&#40; {}, shift &#41;;
}

no AutoLoader;

package IPC::Open3::Callback;
{
  $IPC::Open3::Callback::VERSION = &#39;1.01&#39;;
}

use strict;
use warnings;

use Exporter qw&#40;import&#41;;
our @EXPORT_OK = qw&#40;safe_open3&#41;;

use Data::Dumper;
use IO::Select;
use IO::Socket;
use IPC::Open3;
use Symbol qw&#40;gensym&#41;;
use Hash::Util qw&#40;lock_keys&#41;;

my $logger;
eval {
    require Log::Log4perl;
    $logger = Log::Log4perl-&gt;get_logger&#40; &#39;IPC::Open3::Callback&#39; &#41;;
};
if &#40; $@ &#41; {
    $logger = IPC::Open3::Callback::NullLogger-&gt;new&#40;&#41;;
}

sub new {
    my $prototype = shift;
    my $class = ref&#40; $prototype &#41; || $prototype;

	my $self = { out_callback =&gt; undef, err_callback =&gt; undef, buffer_output =&gt; undef, select_timeout =&gt; undef, buffer_size =&gt; undef, pid =&gt; undef, last_cmd =&gt; undef, input_buffer =&gt; undef };
    bless&#40; $self, $class &#41;;

    my $args_ref = shift;

	if &#40;defined&#40;$args_ref&#41;&#41; {

		$logger-&gt;logdie&#40;&#39;parameters must be an hash reference&#39;&#41; unless&#40;&#40;ref&#40;$args_ref&#41;&#41; eq &#39;HASH&#39;&#41;;
		$self-&gt;{out_callback} = $args_ref-&gt;{out_callback};
		$self-&gt;{err_callback} = $args_ref-&gt;{err_callback};
		$self-&gt;{buffer_output} = $args_ref-&gt;{buffer_output};
		$self-&gt;{select_timeout} = $args_ref-&gt;{select_timeout} || 3;
		$self-&gt;{buffer_size} = $args_ref-&gt;{buffer_size} || 1024;

	} else {

		$self-&gt;{select_timeout} = 3;
		$self-&gt;{buffer_size} = 1024;

	}

	lock_keys&#40;%{$self}&#41;;

    return $self;
}

sub append_to_buffer {
    my $self = shift;
    my $buffer_ref = shift;
    my $data = $$buffer_ref . shift;
    my $flush = shift;

    my @lines = split&#40; /\n/, $data, -1 &#41;;

    # save the last line in the buffer as it may not yet be a complete line
    $$buffer_ref = $flush ? &#39;&#39; : pop&#40; @lines &#41;;
    
    # return all complete lines
    return @lines;
}

sub nix_open3 {
    my @command = @_;

    my &#40;$in_fh, $out_fh, $err_fh&#41; = &#40;gensym&#40;&#41;, gensym&#40;&#41;, gensym&#40;&#41;&#41;;
    return &#40; open3&#40; $in_fh, $out_fh, $err_fh, @command &#41;,
        $in_fh, $out_fh, $err_fh &#41;;
}

sub run_command {

    my $self = shift;
    my @command = @_;
    my $options = {};
    
    # if last arg is hashref, its command options not arg...
    if &#40; ref&#40; $command[-1] &#41; eq &#39;HASH&#39; &#41; {
        $options = pop&#40;@command&#41;;
    }
    
    my &#40;$out_callback, $out_buffer_ref, $err_callback, $err_buffer_ref&#41;;
    $out_callback = $options-&gt;{out_callback} || $self-&gt;{out_callback};
    $err_callback = $options-&gt;{err_callback} || $self-&gt;{err_callback};
    if &#40; $options-&gt;{buffer_output} || $self-&gt;{buffer_output} &#41; {
        $out_buffer_ref = \&#39;&#39;;
        $err_buffer_ref = \&#39;&#39;;
    }

	$self-&gt;{last_cmd} = join&#40;&#39; &#39;, @command&#41;;
    $logger-&gt;debug&#40; &#39;Running &#34;&#39; . $self-&gt;{last_cmd} . &#34;&#39;&#34; &#41; if &#40;$logger-&gt;is_debug&#40;&#41;&#41;;
    my &#40;$pid, $in_fh, $out_fh, $err_fh&#41; = safe_open3&#40; @command &#41;;
	$self-&gt;{pid} = $pid;

    my $select = IO::Select-&gt;new&#40;&#41;;
    $select-&gt;add&#40; $out_fh, $err_fh &#41;;

    while &#40; my @ready = $select-&gt;can_read&#40; $self-&gt;{select_timeout} &#41; &#41; {
        if &#40; $self-&gt;{input_buffer} &#41; {
            syswrite&#40; $in_fh, $self-&gt;{input_buffer} &#41;;
            delete&#40; $self-&gt;{input_buffer} &#41;;
        }
        foreach my $fh &#40; @ready &#41; {
            my $line;
            my $bytes_read = sysread&#40; $fh, $line, $self-&gt;{buffer_size} &#41;;
            if &#40; ! defined&#40; $bytes_read &#41; &#38;&#38; !$!{ECONNRESET} &#41; {
                $logger-&gt;error&#40; &#34;sysread failed: &#34;, sub { Dumper&#40; %! &#41; } &#41; if &#40;$logger-&gt;is_error&#40;&#41;&#41;;
                $logger-&gt;logdie&#40; &#34;error in running &#39;&#34; . $self-&gt;{last_cmd} . &#34;&#39;: $!&#34; &#41;;
            }
            elsif &#40; ! defined&#40; $bytes_read&#41; || $bytes_read == 0 &#41; {
                $select-&gt;remove&#40; $fh &#41;;
                next;
            }
            else {
                if &#40; $fh == $out_fh &#41; {
                    $self-&gt;write_to_callback&#40; $out_callback, $line, $out_buffer_ref, 0, $pid &#41;;
                }
                elsif &#40; $fh == $err_fh &#41; {
                    $self-&gt;write_to_callback&#40; $err_callback, $line, $err_buffer_ref, 0, $pid &#41;;
                }
                else {
                    $logger-&gt;logdie&#40; &#39;Impossible... somehow got a filehandle I dont know about!&#39; &#41;;
                }
            }
        }
    }

    # flush buffers
    $self-&gt;write_to_callback&#40; $out_callback, &#39;&#39;, $out_buffer_ref, 1, $pid &#41;;
    $self-&gt;write_to_callback&#40; $err_callback, &#39;&#39;, $err_buffer_ref, 1, $pid &#41;;
	return $self-&gt;destroy_child&#40;&#41;;

}

sub DESTROY {

	my $self = shift;
	$self-&gt;destroy_child&#40;&#41;;

}

sub destroy_child {

	my $self = shift;

    waitpid&#40; $self-&gt;{pid}, 0 &#41; if &#40;$self-&gt;{pid}&#41;;
    my $exit_code = $? &gt;&gt; 8;

    $logger-&gt;debug&#40; &#34;exited &#39;&#34; . $self-&gt;{last_cmd} . &#34;&#39; with code $exit_code&#34; &#41; if &#40;$logger-&gt;is_debug&#40;&#41;&#41;;
	$self-&gt;{pid} = undef;
    return $exit_code;

}

sub safe_open3 {
    return &#40; $^O =~ /MSWin32/ &#41; ? win_open3&#40; @_ &#41; : nix_open3&#40; @_ &#41;;
}

sub send_input {
    my $self = shift;
    $self-&gt;{input_buffer} = shift;
}

sub win_open3 {
    my @command = @_;

    my &#40;$in_read, $in_write&#41; = win_pipe&#40;&#41;;
    my &#40;$out_read, $out_write&#41; = win_pipe&#40;&#41;;
    my &#40;$err_read, $err_write&#41; = win_pipe&#40;&#41;;
    
    my $pid = open3&#40; &#39;&gt;&#38;&#39;.fileno&#40;$in_read&#41;, 
        &#39;&lt;&#38;&#39;.fileno&#40;$out_write&#41;, 
        &#39;&lt;&#38;&#39;.fileno&#40;$err_write&#41;,
         @command &#41;;
    
    return &#40; $pid, $in_write, $out_read, $err_read &#41;;
}

sub win_pipe {
    my &#40;$read, $write&#41; = IO::Socket-&gt;socketpair&#40; AF_UNIX, SOCK_STREAM, PF_UNSPEC &#41;;
    $read-&gt;shutdown&#40; SHUT_WR &#41;;  # No more writing for reader
    $write-&gt;shutdown&#40; SHUT_RD &#41;;  # No more reading for writer

    return &#40;$read, $write&#41;;
}

sub write_to_callback {
    my $self = shift;
    my $callback = shift;
    my $data = shift;
    my $buffer_ref = shift;
    my $flush = shift;
    my $pid = shift;
    
    return if &#40; ! defined&#40; $callback &#41; &#41;;
    
    if &#40; ! defined&#40; $buffer_ref &#41; &#41; {
        &#38;{$callback}&#40; $data, $pid &#41;;
        return;
    }
    
    &#38;{$callback}&#40; $_ &#41; foreach &#40; $self-&gt;append_to_buffer&#40; $buffer_ref, $data, $flush &#41; &#41; ;
}

1;
__END__
=head1 NAME

IPC::Open3::Callback - An extension to IPC::Open3 that will feed out and err to callbacks instead of requiring the caller to handle them.

=head1 VERSION

version 1.01

=head1 SYNOPSIS

  use IPC::Open3::Callback;
  my $runner = IPC::Open3::Callback-&gt;new&#40; 
      out_callback =&gt; sub {
          my $data = shift;
          my $pid = shift;

          print&#40; &#34;$pid STDOUT: $data\n&#34; &#41;;
      },
      err_callback =&gt; sub {
          my $data = shift;
          my $pid = shift;

          print&#40; &#34;$pid STDERR: $data\n&#34; &#41;;
      } &#41;;
  my $exit_code = $runner-&gt;run_command&#40; &#39;echo Hello World&#39; &#41;;

  use IPC::Open3::Callback qw&#40;safe_open3&#41;;
  my &#40;$pid, $in, $out, $err&#41; = safe_open3&#40; &#34;echo&#34;, &#34;Hello&#34;, &#34;world&#34; &#41;; 
  $buffer = &#39;&#39;;
  my $select = IO::Select-&gt;new&#40;&#41;;
  $select-&gt;add&#40; $out &#41;;
  while &#40; my @ready = $select-&gt;can_read&#40; 5 &#41; &#41; {
      foreach my $fh &#40; @ready &#41; {
          my $line;
          my $bytes_read = sysread&#40; $fh, $line, 1024 &#41;;
          if &#40; ! defined&#40; $bytes_read &#41; &#38;&#38; !$!{ECONNRESET} &#41; {
              die&#40; &#34;error in running &#40;&#39;echo $echo&#39;&#41;: $!&#34; &#41;;
          }
          elsif &#40; ! defined&#40; $bytes_read&#41; || $bytes_read == 0 &#41; {
              $select-&gt;remove&#40; $fh &#41;;
              next;
          }
          else {
              if &#40; $fh == $out &#41; {
                  $buffer .= $line;
              }
              else {
                  die&#40; &#34;impossible... somehow got a filehandle i dont know about!&#34; &#41;;
              }
          }
      }
  } 
  waitpid&#40; $pid, 0 &#41;;
  my $exit_code = $? &gt;&gt; 8;
  print&#40; &#34;$pid exited with $exit_code: $buffer\n&#34; &#41;; # 123 exited with 0: Hello World
  
=head1 DESCRIPTION

This module feeds output and error stream from a command to supplied callbacks.  
Thus, this class removes the necessity of dealing with L&lt;IO::Select&gt; by hand and
also provides a workaround for Windows systems.

=head1 FUNCTIONS

=head2 safe_open3&#40; $command, $arg1, ..., $argN &#41;

Passes the command and arguments on to C&lt;open3&gt; and returns a list containing:

=over 4

=item pid

The process id of the forked process

=item stdin

An L&lt;IO::Handle&gt; to STDIN for the process

=item stdout

An L&lt;IO::Handle&gt; to STDOUT for the process

=item stderr

An L&lt;IO::Handle&gt; to STDERR for the process

=back

As with C&lt;open3&gt;, it is the callers responsibility to waitpid to
ensure forked processes do not become zombies.

This method works for both *nix and Windows sytems.  On a windows system,
it will use sockets per L&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/index.pl?node_id=811150">http://www.perlmonks.org/index.pl?node_id=811150</a></span>&gt;.

=head1 CONSTRUCTOR

=head2 new&#40; \%options &#41;

The constructor creates a new Callback object and optionally sets global 
callbacks for C&lt;STDOUT&gt; and C&lt;STDERR&gt; streams from commands that will get run by 
this object &#40;can be overridden per call to 
L&lt;run_command|/&#34;run_command&#40; $command, $arg1, ..., $argN, \%options &#41;&#34;&gt;&#41;.

=over 4

=item out_callback

A subroutine to call for each chunk of text written to C&lt;STDOUT&gt;. This subroutine
will be called with 2 arguments:

=over 4

=item data

A chunk of text written to the stream

=item pid

The pid of the forked process

=back

=item err_callback

A subroutine to call for each chunk of text written to C&lt;STDERR&gt;. This subroutine
will be called with the same 2 arguments as C&lt;out_callback&gt;

=item buffer_output

A boolean value, if true, will buffer output and send to callback one line
at a time &#40;waits for &#39;\n&#39;&#41;.  Otherwise, sends text in the same chunks returned
by L&lt;sysread&gt;.

=item select_timeout

The timeout, in seconds, provided to C&lt;IO::Select&gt;, by default 0 meaning no
timeout which will cause the loop to block until output is ready on either
C&lt;STDOUT&gt; or C&lt;STDERR&gt;.

=back

=head1 METHODS

=head2 run_command&#40; $command, $arg1, ..., $argN, \%options &#41;

Will run the specified command with the supplied arguments by passing them on 
to L&lt;safe_open3|/&#34;safe_open3&#40; $command, $arg1, ..., $argN &#41;&#34;&gt;.  Arguments can be embedded in the command string and 
are thus optional.

If the last argument to this method is a hashref &#40;C&lt;ref&#40;@_[-1]&#41; eq &#39;HASH&#39;&gt;&#41;, then
it is treated as an options hash.  The supported allowed options are the same
as the constructor and will be used in preference to the values set in the 
constructor for this call.

Returns the exit code from the command.

=head1 AUTHOR

Lucas Theisen &#40;lucastheisen@pastdev.com&#41;

=head1 COPYRIGHT

Copyright 2013 pastdev.com.  All rights reserved.

This library is free software; you can redistribute it and/or
modify it under the same terms as Perl itself.

=head1 SEE ALSO

L&lt;IPC::Open3&gt;
L&lt;IPC::Open3::Callback::Command&gt;
L&lt;IPC::Open3::Callback::CommandRunner&gt;
L&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/lucastheisen/ipc-open3-callback">https://github.com/lucastheisen/ipc-open3-callback</a></span>&gt;
L&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://stackoverflow.com/q/16675950/516433">http://stackoverflow.com/q/16675950/516433</a></span>&gt;

=cut
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Callback.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"># Before `make install&#39; is performed this script should be runnable with
# `make test&#39;. After `make install&#39; it should work as `perl Silly-Proj.t&#39;

#########################

# change &#39;tests =&gt; 1&#39; to &#39;tests =&gt; last_test_to_print&#39;;

use strict;
use warnings;

use Test::More tests =&gt; 7;

BEGIN { use_ok&#40;&#39;IPC::Open3::Callback&#39;&#41; };

#########################

# Insert your test code below, the Test::More module is use&#40;&#41;ed here so read
# its man page &#40; perldoc Test::More &#41; for help writing this test script.

use IPC::Open3::Callback qw&#40;safe_open3&#41;;
my $echo = &#39;Hello World&#39;;
my $echo_result_regex = qr/^$echo[\r\n]?[\r\n]?$/;
my $buffer = &#39;&#39;;
my $err_buffer = &#39;&#39;;
my $runner = IPC::Open3::Callback-&gt;new&#40;{
    out_callback =&gt; sub {
        $buffer .= shift;
    },
    err_callback =&gt; sub {
        $err_buffer .= shift;
    } 
}&#41;;
is&#40;$runner-&gt;run_command&#40; &#34;echo $echo&#34; &#41;, 0, &#39;run_command&#40;&#41; method child process returns zero &#40;success&#41;&#39;&#41;;
is&#40; $err_buffer, &#39;&#39;, &#34;errbuffer&#34; &#41;;
like&#40; $buffer, $echo_result_regex, &#34;outbuffer&#34; &#41;;

$buffer = &#39;&#39;;
$runner = IPC::Open3::Callback-&gt;new&#40;&#41;;
$runner-&gt;run_command&#40; &#34;echo&#34;, &#34;Hello&#34;, &#34;World&#34;, {
    out_callback =&gt; sub {
        $buffer .= shift;
    }
} &#41;;
like&#40; $buffer, $echo_result_regex, &#34;out_callback as command option&#34; &#41;;

my &#40;$pid, $in, $out, $err&#41; = safe_open3&#40; &#34;echo $echo&#34; &#41;; 
$buffer = &#39;&#39;;
my $select = IO::Select-&gt;new&#40;&#41;;
$select-&gt;add&#40; $out &#41;;
while &#40; my @ready = $select-&gt;can_read&#40; 5 &#41; &#41; {
    foreach my $fh &#40; @ready &#41; {
        my $line;
        my $bytes_read = sysread&#40; $fh, $line, 1024 &#41;;
        if &#40; ! defined&#40; $bytes_read &#41; &#38;&#38; !$!{ECONNRESET} &#41; {
            die&#40; &#34;error in running &#40;&#39;echo $echo&#39;&#41;: $!&#34; &#41;;
        }
        elsif &#40; ! defined&#40; $bytes_read&#41; || $bytes_read == 0 &#41; {
            $select-&gt;remove&#40; $fh &#41;;
            next;
        }
        else {
            if &#40; $fh == $out &#41; {
                $buffer .= $line;
            }
            else {
                die&#40; &#34;impossible... somehow got a filehandle i dont know about!&#34; &#41;;
            }
        }
    }
} 
like&#40; $buffer, $echo_result_regex, &#34;safe_open3 read out&#34; &#41;;
waitpid&#40; $pid, 0 &#41;;
my $exit_code = $? &gt;&gt; 8;
ok&#40; !$exit_code, &#34;safe_open3 exited $exit_code&#34; &#41;;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Callback_CommandRunner.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use warnings;

use Test::Most tests =&gt; 5;

BEGIN { use_ok&#40;&#39;IPC::Open3::Callback::CommandRunner&#39;&#41; };

use IPC::Open3::Callback::CommandRunner; 

my $echo = &#39;Hello World&#39;;
my $echo_result_regex = qr/^$echo[\r\n]?[\r\n]?$/;
my $command_runner = IPC::Open3::Callback::CommandRunner-&gt;new&#40;&#41;;
my $exit_code = $command_runner-&gt;run&#40; &#34;echo $echo&#34;, {out_buffer=&gt;1} &#41;;
is&#40; $exit_code, 0, &#39;echo exit code means success&#39; &#41;;
like&#40; $command_runner-&gt;out_buffer&#40;&#41;, $echo_result_regex, &#39;echo out match&#39; &#41;;

lives_ok  { $command_runner-&gt;run_or_die&#40; &#34;echo $echo&#34;, {out_buffer=&gt;1} &#41; } &#39;expected to live&#39;;

dies_ok { $command_runner-&gt;run_or_die&#40; &#34;THIS_IS_NOT_A_COMMAND&#34; &#41; } &#39;expected to die&#39;;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Makefile.PL</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use warnings;
use ExtUtils::MakeMaker 6.30;

my %WriteMakefileArgs = &#40;
    ABSTRACT =&gt;
&#39;An extension to IPC::Open3 that will feed out and err to callbacks instead of requiring the caller to handle them.&#39;,
    AUTHOR             =&gt; &#39;Lucas Theisen &lt;lucastheisen@pastdev.com&gt;&#39;,
    BUILD_REQUIRES     =&gt; {},
    CONFIGURE_REQUIRES =&gt; {
        &#39;ExtUtils::MakeMaker&#39; =&gt; 6.30
    },
    DISTNAME      =&gt; &#39;IPC-Open3-Callback&#39;,
    EXE_FILES     =&gt; [],
    LICENSE       =&gt; &#39;perl&#39;,
    NAME          =&gt; &#39;IPC::Open3::Callback&#39;,
    PREREQ_PM     =&gt; {},
    TEST_REQUIRES =&gt; { &#39;Test::Most&#39; =&gt; 0.31 },
    VERSION       =&gt; 1.01,
    test          =&gt; {
        TESTS =&gt; &#39;t/*.t&#39;
    }
&#41;;

unless &#40; eval { ExtUtils::MakeMaker-&gt;VERSION&#40;6.63_03&#41; } &#41; {
    my $tr = delete $WriteMakefileArgs{TEST_REQUIRES};
    my $br = $WriteMakefileArgs{BUILD_REQUIRES};
    for my $mod &#40; keys %$tr &#41; {
        if &#40; exists $br-&gt;{$mod} &#41; {
            $br-&gt;{$mod} = $tr-&gt;{$mod} if $tr-&gt;{$mod} &gt; $br-&gt;{$mod};
        }
        else {
            $br-&gt;{$mod} = $tr-&gt;{$mod};
        }
    }
}

unless &#40; eval { ExtUtils::MakeMaker-&gt;VERSION&#40;6.56&#41; } &#41; {
    my $br = delete $WriteMakefileArgs{BUILD_REQUIRES};
    my $pp = $WriteMakefileArgs{PREREQ_PM};
    for my $mod &#40; keys %$br &#41; {
        if &#40; exists $pp-&gt;{$mod} &#41; {
            $pp-&gt;{$mod} = $br-&gt;{$mod} if $br-&gt;{$mod} &gt; $pp-&gt;{$mod};
        }
        else {
            $pp-&gt;{$mod} = $br-&gt;{$mod};
        }
    }
}

delete $WriteMakefileArgs{CONFIGURE_REQUIRES}
  unless eval { ExtUtils::MakeMaker-&gt;VERSION&#40;6.52&#41; };

WriteMakefile&#40;%WriteMakefileArgs&#41;;

</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
