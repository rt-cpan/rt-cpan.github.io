<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #42205 for DBD-SQLite: Long running: database is locked&#40;5&#41; at dbdimp.c line 218</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #42205 for DBD-SQLite: Long running: database is locked&#40;5&#41; at dbdimp.c line 218</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DBD-SQLite">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DBD-SQLite">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DBD-SQLite">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DBD-SQLite">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-SQLite">DBD-SQLite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">42205</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DBD-SQLite">DBD-SQLite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
perl-cpan [...] bereft.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
TJC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-10248-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.14    </td>
  </tr>
  <tr id="CF-10249-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




db_locked.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/551283/277715/db_locked.pl">
Wed Jan 07 20:44:10 2009 (1.4k) by TJC [...] cpan.org
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/551067/277575/db_locked.pl">
Wed Jan 07 03:05:46 2009 (1.2k) by perl-cpan [...] bereft.net
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=42205">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-551067" href="/Public/Bug/Display.html?id=42205#txn-551067">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;07&nbsp;03:05:46&nbsp;2009</span>
    <span class="description">perl-cpan [...] bereft.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Long running: database is locked&#40;5&#41; at dbdimp.c line 218</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/551067/277572/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/277572">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have an ugly and not very well isolated test case that reliably 
fails with a &#34;database is locked&#34; on some platforms with 
DBD::SQLite 1.14 and it&#39;s default sqlite version.

Failures have been encountered on Debian Etch, Windows XP.
&#40;Ubuntu 8.10, with perl: 5.10.0 64bit succeeded&#41;

There&#39;s a writer process, adding rows to a database, intermixing
transactions and autocommit &#40;seemingly required?&#41; and a read-only
process doing selects.  It uses fork&#40;&#41; to launch the reader
&#40;pseudo-processes on windows xp&#41;.

The writer process seems to be the one failing, as the reader&#39;s
prints continue with old values.

The failure occurs at slightly different points in processing,
around 280000 count on windows, 204000 count on etch.

The numbers vary, but the windows output looks like:

276000
DBD::SQLite::db commit failed: database is locked&#40;5&#41; at dbdimp.c line
218 at db_
locked.pl line 36.
DBD::SQLite::db commit failed: database is locked&#40;5&#41; at dbdimp.c line
218 at db_
locked.pl line 36.
99
277000
99
277000
99

The .db file produced by the test grows to around 500 Mb
on windows before failing.  &#40;Runs without errors grow even larger&#41;

WinXP perl5.8.8, both ActiveState and Strawberry.

I&#39;ll try to clarify the problem later if I can,

Brad
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> db_locked.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/551067/277575/db_locked.pl">Download db_locked.pl</a><br />
<span class="downloadcontenttype">text/x-perl 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl 

use strict;
use warnings;
use DBI;
use DBD::SQLite;

my $db_file = &#34;test-$$.db&#34;;

#print &#34;DBI vers: $DBI::VERSION\n&#34;;
print &#34;DBD::SQLite vers: $DBD::SQLite::VERSION\n&#34;;

if &#40;my $child = fork&#41; {
    print &#34;Parent $$\n&#34;;
    print &#34;Child $child\n&#34;;
    writer&#40;$db_file&#41;;
    print &#34;Killing child $child\n&#34;;
    kill 9, $child;
} else {
    sleep&#40;2&#41;;
    reader&#40;$db_file&#41;;
}

sub writer {
    my $dbh = DBI-&gt;connect&#40;&#34;dbi:SQLite:dbname=$db_file&#34;,&#39;&#39;,&#39;&#39;,
                            { RaiseError =&gt; 1 }&#41;;
    $dbh-&gt;do&#40;&#39;create table t1 &#40;a&#41;&#39;&#41;;
    $dbh-&gt;do&#40;&#39;create table t2 &#40;b&#41;&#39;&#41;;
    for &#40;1..1000&#41; {
        $dbh-&gt;begin_work&#40;&#41;;
        for &#40;1..1000&#41; {
            # s/rand&#40;&#41; x 100/1/ ran to completion
            $dbh-&gt;do&#40;&#39;insert into t1 &#40;a&#41; values &#40;?&#41;&#39;, {}, rand&#40;&#41; x 100&#41;;
        }
        sleep&#40;1&#41;;
        $dbh-&gt;commit&#40;&#41;;
        $dbh-&gt;do&#40;&#39;insert into t2 &#40;b&#41; values &#40;?&#41;&#39;, {}, $_&#41;;
    }
}

sub reader {
    my $dbh = DBI-&gt;connect&#40;&#34;dbi:SQLite:dbname=$db_file&#34;,&#39;&#39;,&#39;&#39;,
                            { RaiseError =&gt; 1 }&#41;;
    while &#40;1&#41; {
        print $dbh-&gt;selectrow_array&#40;&#39;select count&#40;*&#41; from t1&#39;&#41;, &#34;\n&#34;;
        print $dbh-&gt;selectrow_array&#40;&#39;select max&#40;b&#41; from t2&#39;&#41;, &#34;\n&#34;;
        sleep&#40;1&#41;;
    }
}

END {
    #unlink $db_file;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-551070" href="/Public/Bug/Display.html?id=42205#txn-551070">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;07&nbsp;03:08:27&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Cc TJC added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-551071" href="/Public/Bug/Display.html?id=42205#txn-551071">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;07&nbsp;03:21:36&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/551071/277578/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/277578">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 669b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Below are my experiences of various combinations of perl, 32/64bit,
operating system, and sqlite compiled with the internal version vs an
external sqlite..
Note all were tested with a vanilla DBD-SQLite, not the vendor-supplied one.

Perl 5.10.0 | Ubuntu 8.10 64bit | DBD::SQLite 1.14 = Good.

Perl 5.10.0 | Ubuntu 8.10 64bit | DBD::SQLite 1.14 compiled against
SQLite 3.6.6.3 = Good.

Perl 5.8.8 | Debian Etch 32bit | DBD::SQLite 1.14 = bad.

Perl 5.8.8 | Debian Etch 32bit | DBD::SQLite 1.14 w/SQLite 3.6.6.3 = good.

Strawberry Perl 5.8.8 | Win32 XP 32bit | DBD::SQLite 1.14 = Bad.

Strawberry Perl 5.8.8 | Win32 XP 32bit | DBD::SQLite 1.14 w/SQLite
3.6.6.3 = bad.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-551072" href="/Public/Bug/Display.html?id=42205#txn-551072">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;07&nbsp;03:21:37&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-551277" href="/Public/Bug/Display.html?id=42205#txn-551277">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;07&nbsp;19:41:57&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/551277/277705/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/277705">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 181b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Further tests, both with:
Strawberry Perl 5.10.0 | Win32 XP 32bit | SQLite 1.14

With both standard sqlite and with a version compiled against 3.6.6.3,
it failed Brad&#39;s test script.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-551283" href="/Public/Bug/Display.html?id=42205#txn-551283">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;07&nbsp;20:44:09&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/551283/277712/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/277712">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 929b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I attach a modified version of your db_locked.pl script.

In this version, the transactions are wrapped in an eval {} block, and
so a failure is reported, but is not fatal.
Note that I attempt to rollback the DB handle in the exception handler too.

This script demonstrates a more serious problem!

Initially it will fail, then keep going for a while, then fail again.
The failures occur more regularly as time goes by and DB grows.

However after a bit, instead of recovering, the following error occurs:
DBD::SQLite::Db begin_work failed: Already in a transaction at
db_locked.pl line 33.

So, it seems that the transaction cannot be rolled back, but can also
not be started again- thus halting any future work.


For the record, I&#39;ve noticed that if I load up the test machines with
heavier I/O from other processes, then the db_locked script fails
earlier than without, which implies some kind of I/O race condition I think?
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/551283/277715/db_locked.pl">Download db_locked.pl</a><br />
<span class="downloadcontenttype">text/x-perl 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl 

use strict;
use warnings;
use DBI;
use DBD::SQLite;

my $db_file = &#34;test-locked.db&#34;;

#print &#34;DBI vers: $DBI::VERSION\n&#34;;
print &#34;DBD::SQLite vers: $DBD::SQLite::VERSION\n&#34;;

if &#40;my $child = fork&#41; {
    print &#34;Parent $$\n&#34;;
    print &#34;Child $child\n&#34;;
    writer&#40;$db_file&#41;;
    print &#34;Killing child $child\n&#34;;
    kill 9, $child;
} else {
    sleep&#40;2&#41;;
    reader&#40;$db_file&#41;;
}

sub writer {
    my $dbh = DBI-&gt;connect&#40;&#34;dbi:SQLite:dbname=$db_file&#34;,&#39;&#39;,&#39;&#39;,
                            { RaiseError =&gt; 1 }&#41;;
    $dbh-&gt;do&#40;&#39;create table t1 &#40;a&#41;&#39;&#41;;
    $dbh-&gt;do&#40;&#39;create table t2 &#40;b&#41;&#39;&#41;;
    for &#40;1..1000&#41; {
  	  eval {
		$dbh-&gt;begin_work;
		for &#40;1..1000&#41; {
		    # s/rand&#40;&#41; x 100/1/ ran to completion
		    $dbh-&gt;do&#40;&#39;insert into t1 &#40;a&#41; values &#40;?&#41;&#39;, {}, rand&#40;&#41; x 100&#41;;
		}
		sleep&#40;1&#41;;
		$dbh-&gt;commit;
		$dbh-&gt;do&#40;&#39;insert into t2 &#40;b&#41; values &#40;?&#41;&#39;, {}, $_&#41;;
	  };
	  if &#40;$@&#41; {
          print &#34;Transaction failed &#40;writer&#41;: $@\n&#34;;
	  $dbh-&gt;rollback;
          sleep 1;
      }
    }
}

sub reader {
    my $dbh = DBI-&gt;connect&#40;&#34;dbi:SQLite:dbname=$db_file&#34;,&#39;&#39;,&#39;&#39;,
                            { RaiseError =&gt; 1 }&#41;;
    while &#40;1&#41; {
        eval {
            print $dbh-&gt;selectrow_array&#40;&#39;select count&#40;*&#41; from t1&#39;&#41;, &#34;\n&#34;;
            print $dbh-&gt;selectrow_array&#40;&#39;select max&#40;b&#41; from t2&#39;&#41;, &#34;\n&#34;;
        };
        if &#40;$@&#41; {
            print &#34;Transaction failed &#40;reader&#41;: $@\n&#34;;
        }
        sleep&#40;1&#41;;
    }
}

END {
    # unlink $db_file;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-552584" href="/Public/Bug/Display.html?id=42205#txn-552584">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;11&nbsp;20:34:01&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/552584/278433/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/278433">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 514b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hmm.
Some more thoughts on this.

DBD::SQLite sets the busy timeout period to 30 seconds by default.

I would say that the db locked problem we&#39;re seeing is because, after
the DB is big enough and/or the general disk i/o is high enough, that
one of the processes needs more than 30 seconds to complete its transaction.

However there is definitely a bigger problem, as seen by the case above
where the process continues to retry, and gets into a state where it is
impossible to rollback OR start a new transaction.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-565548" href="/Public/Bug/Display.html?id=42205#txn-565548">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;11&nbsp;06:18:25&nbsp;2009</span>
    <span class="description">reply-2009 [...] mgn.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/565548/285586/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/285586">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 918b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Seems that working with transactions and AutoCommit is tricky.
Here&#39;s some code that works with debian/lenny. The commented items
produce an error:
#!/usr/bin/perl -w

use DBI;

my $dbh =
DBI-&gt;connect&#40;&#34;dbi:SQLite:dbname=test.sqlite&#34;,&#39;&#39;,&#39;&#39;,{AutoCommit=&gt;0}&#41; or
die $DBI::errstr;

#$dbh-&gt;commit;
$dbh-&gt;do&#40;&#39;COMMIT&#39;&#41;; #!!! Required as AutoCommit=&gt;0 leaves a flapping
transaction
#$dbh-&gt;begin_work;

print &#39;Version: &#39;.$dbh-&gt;{sqlite_version}.&#34;\n&#34;; # Version: 3.5.9

$dbh-&gt;func&#40;10000,&#39;busy_timeout&#39;&#41;;

$dbh-&gt;do&#40;&#39;BEGIN EXCLUSIVE TRANSACTION&#39;&#41;;

$dbh-&gt;do&#40;&#34;delete from test&#34;&#41;;

$dbh-&gt;do&#40;&#34;insert into test values &#40;3&#41;&#34;&#41;;

$dbh-&gt;commit;
#$dbh-&gt;do&#40;&#39;COMMIT&#39;&#41;;

$dbh-&gt;disconnect;


I think that SQLite&#39;s auto-commit uses an implied &#34;BEGIN TRANSACTION&#34; or
something similar. If I don&#39;t use the line marked !!!, varoius errors
ensue, including &#34;database is locked&#34; and &#34;cannot start a transaction
within a transaction&#34;.

Hope this helps?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-565679" href="/Public/Bug/Display.html?id=42205#txn-565679">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;11&nbsp;14:36:11&nbsp;2009</span>
    <span class="description">reply-2009 [...] mgn.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> reply-2009 [...] mgn.org.uk</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/565679/285663/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/285663">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 446b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Further reading reveals that SQLite3 has _NO_ mechanism to explicitly
change AutoCommit. It is on at the start of a connection. The only way
to disable it is to issue a &#34;BEGIN...&#34; command. It is then re-enabled by
the matching &#34;COMMIT&#34; or &#34;ROLLBACK&#34;.

I&#39;d recommend avoiding $dbh-&gt;begin_work, $dbh-&gt;commit etc. Instead use: 
$dbh-&gt;do&#40;&#39;BEGIN TRANSACTION&#39;&#41;; and $dbh-&gt;do&#40;&#39;COMMIT&#39;&#41;. This, I believe
will avoid the strange errors people see.

Cheers.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-756303" href="/Public/Bug/Display.html?id=42205#txn-756303">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;31&nbsp;02:28:04&nbsp;2010</span>
    <span class="description">ishigaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/756303/391056/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/391056">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi. A new &#34;sqlite_use_immediate_transaction&#34; dbh attribute introduced 
in DBD::SQLite 1.30_02 would fix your issue. This deadlock issue is 
explained in &#34;The Definitive Guide to SQLite&#34; &#40;Apress&#41;, and http://
www.sqlite.org/lockingv3.html to some extent. If you still have the 
same issue &#40;even with the above attribute or issuing &#34;BEGIN 
IMMEDIATE&#34; &#40;or &#34;BEGIN EXCLUSIVE&#34;&#41; transaction&#41;, please reopen this 
ticket with a failing test/script. Thanks.

On 2009-1-07 Wed 03:05:46, BOWMANBS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have an ugly and not very well isolated test case that reliably 
&gt; fails with a &#34;database is locked&#34; on some platforms with 
&gt; DBD::SQLite 1.14 and it&#39;s default sqlite version.
&gt; 
&gt; Failures have been encountered on Debian Etch, Windows XP.
&gt; &#40;Ubuntu 8.10, with perl: 5.10.0 64bit succeeded&#41;
&gt; 
&gt; There&#39;s a writer process, adding rows to a database, intermixing
&gt; transactions and autocommit &#40;seemingly required?&#41; and a read-only
&gt; process doing selects.  It uses fork&#40;&#41; to launch the reader
&gt; &#40;pseudo-processes on windows xp&#41;.
&gt; 
&gt; The writer process seems to be the one failing, as the reader&#39;s
&gt; prints continue with old values.
&gt; 
&gt; The failure occurs at slightly different points in processing,
&gt; around 280000 count on windows, 204000 count on etch.
&gt; 
&gt; The numbers vary, but the windows output looks like:
&gt; 
&gt; 276000
&gt; DBD::SQLite::db commit failed: database is locked&#40;5&#41; at dbdimp.c line
&gt; 218 at db_
&gt; locked.pl line 36.
&gt; DBD::SQLite::db commit failed: database is locked&#40;5&#41; at dbdimp.c line
&gt; 218 at db_
&gt; locked.pl line 36.
&gt; 99
&gt; 277000
&gt; 99
&gt; 277000
&gt; 99
&gt; 
&gt; The .db file produced by the test grows to around 500 Mb
&gt; on windows before failing.  &#40;Runs without errors grow even larger&#41;
&gt; 
&gt; WinXP perl5.8.8, both ActiveState and Strawberry.
&gt; 
&gt; I&#39;ll try to clarify the problem later if I can,
&gt; 
&gt; Brad
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-756306" href="/Public/Bug/Display.html?id=42205#txn-756306">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;31&nbsp;02:28:05&nbsp;2010</span>
    <span class="description">ishigaki [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.645255</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
