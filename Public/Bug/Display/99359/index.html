<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #99359 for IP-Country: 165.201.nnn.nnn is US, not EU</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #99359 for IP-Country: 165.201.nnn.nnn is US, not EU</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/IP-Country/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/IP-Country/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/IP-Country/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/IP-Country/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IP-Country">IP-Country CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">99359</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/IP-Country/Active/">IP-Country</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
m.grau [...] kcc.state.ks.us

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-17308-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-17309-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;07&nbsp;15:57:56&nbsp;2014</span>
    <span class="description">m.grau [...] kcc.state.ks.us -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 165.201.nnn.nnn is US, not EU</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 07 Oct 2014 14:57:44 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-IP-Country [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike Grau &lt;m.grau [...] kcc.state.ks.us&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">165.201.nnn.nnn is US, not EU
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;16&nbsp;12:41:07&nbsp;2014</span>
    <span class="description">developers [...] linuxmagic.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #99359] Possible solution for incorrect countries for IPs</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 16 Oct 2014 09:40:55 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-IP-Country [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> LinuxMagic Development Team &lt;developers [...] linuxmagic.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

I ran into this problem as well for certain IPs, and I believe I have an 
explanation and a solution to it.


Cause:

In the RIPE file used when building the database, there are blocks 
listed in this way:

inetnum:        158.48.0.0 - 158.48.255.255
netname:        NON-RIPE-NCC-MANAGED-ADDRESS-BLOCK
descr:          IPv4 address block not managed by the RIPE NCC
[..snip..]

This is apparently causing such blocks to be listed as EU when building 
the database, though they are not.


Solution:

ipcc_loader.pl should ignore these blocks in the RIPE file. Once 
modified, rebuilding the database should no longer show such IPs as EU.


Here is the patch I applied to ignore them:

--- ipcc_loader.pl_2.28 2014-10-14 09:32:50.000000000 -0700
+++ ipcc_loader.pl      2014-10-14 09:32:50.000000000 -0700
@@ -324,34 +324,54 @@
  {
      print STDERR &#34;loading data from ripe.db.inetnum\n&#34;;
      my $ripe_inet_line = qr/^inetnum:\s+&#40;\S+&#41;\s*-\s*&#40;\S+&#41;/o;
+    # NOTE: /o means compile only once.
+    my $ripe_non_managed_line = 
qr/^netname:\s+NON-RIPE-NCC-MANAGED-ADDRESS-BLOCK/o;
      my $ripe_cc_line = qr/^country:\s+&#40;\S\S&#41;/o;
      open &#40;REG,&#34;&lt; $reg_dir/ripe.db.inetnum&#34;&#41; or die&#40;&#34;can&#39;t open 
$reg_dir/ripe.db.inetnum: $!&#34;&#41;;
      binmode REG, &#39;:crlf&#39;;
      {
-       my $start;
-       my $end;
-       my $cc;
-       my $status;
-       while &#40;my $line = &lt;REG&gt;&#41;{
-           if &#40;defined $start&#41;{
-               next unless $line =~ $ripe_cc_line;
-               $cc = uc $1;
-               $cc = &#39;GB&#39; if &#40;$cc eq &#39;UK&#39;&#41;;
-               insert_raw&#40;$start,$end-$start+1,$cc,$end-$start+1&#41;;
-               $start = undef;
-               $end = undef;
-           } elsif &#40;$line =~ $ripe_inet_line&#41;{
-               my &#40;$a_start,$a_end&#41; = &#40;$1,$2&#41;;
-               if &#40;$a_start =~ $ip_match&#41;{
-                   $start = &#40;$1 * 16777216&#41; + &#40;$2 * 65536&#41; + &#40;$3 * 256&#41; + $4;
-               }
-               if &#40;$a_end =~ $ip_match&#41;{
-                   $end = &#40;$1 * 16777216&#41; + &#40;$2 * 65536&#41; + &#40;$3 * 256&#41; + $4;
-               }
-               die&#40;$line&#41; unless &#40;&#40;defined $start&#41; &#38;&#38; &#40;defined $end&#41;&#41;;
-           } else {
-           }
-       }
+        my $start;
+        my $end;
+        my $cc;
+        my $status;
+        my $non_managed = 0;
+        while &#40;my $line = &lt;REG&gt;&#41; {
+            if &#40;defined $start&#41; {
+                # sometimes we have blocks indicating the block is not 
managed.
+                # e.g.
+                # inetnum:        158.48.0.0 - 158.48.255.255
+                # netname:        NON-RIPE-NCC-MANAGED-ADDRESS-BLOCK
+                if &#40;$line =~ $ripe_non_managed_line&#41; {
+                    $non_managed = 1;
+                    next;
+                }
+                next unless $line =~ $ripe_cc_line;
+                # not managed, don&#39;t insert!
+                if &#40;$non_managed&#41; {
+                    $start = undef;
+                    $end = undef;
+                    print &#34;skipping non-managed...\n&#34;;
+                    next;
+                }
+                $cc = uc $1;
+                $cc = &#39;GB&#39; if &#40;$cc eq &#39;UK&#39;&#41;;
+                insert_raw&#40;$start,$end-$start+1,$cc,$end-$start+1&#41;;
+                $start = undef;
+                $end = undef;
+            } elsif &#40;$line =~ $ripe_inet_line&#41; {
+                my &#40;$a_start,$a_end&#41; = &#40;$1,$2&#41;;
+                if &#40;$a_start =~ $ip_match&#41;{
+                    $start = &#40;$1 * 16777216&#41; + &#40;$2 * 65536&#41; + &#40;$3 * 
256&#41; + $4;
+                }
+                if &#40;$a_end =~ $ip_match&#41;{
+                    $end = &#40;$1 * 16777216&#41; + &#40;$2 * 65536&#41; + &#40;$3 * 256&#41; 
+ $4;
+                }
+                die&#40;$line&#41; unless &#40;&#40;defined $start&#41; &#38;&#38; &#40;defined $end&#41;&#41;;
+                # non-managed line is after inetnum line. so reset here.
+                $non_managed = 0;
+            } else {
+            }
+        }
      }
      close REG || warn&#40;&#34;can&#39;t close $reg_dir/ripe.db.inetnum, but 
continuing: $!&#34;&#41;;
  }


-- 
&#34;Catch the Magic of Linux...&#34;
www.linuxmagic.com
--------------------------------------------
Development Services - LinuxMagic Inc.
A Wizard IT company - For More Info
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.wizard.ca">http://www.wizard.ca</a></span>
&#34;LinuxMagic&#34; is a Registered TradeMark of
Wizard Tower TechnoServices Ltd.
&#34;Wizard IT&#34; is a company TradeMark of
Wizard Tower TechnoServices Ltd.
-------------------------------------------
604-682-0300 Beautiful British Columbia, Canada

This email and any electronic data contained are confidential and
intended solely for the use of the individual or entity to which
they are addressed. Please note that any views or opinions presented
in this email are solely those of the author and are not intended
to represent those of the company.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;16&nbsp;12:41:07&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;29&nbsp;21:11:52&nbsp;2019</span>
    <span class="description">todd.richmond [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I can confirm this patch works with the latest gif files from mailfud. otherwise there are numerous erroneous EU results. Any change of a new release? We&#39;ll patch in the meantime

214.24.26.84 56.0.84.93  56.0.84.98  56.0.143.47 34.208.149.229 107.150.62.250
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
