<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #129215 for Future-AsyncAwait: Erroneous foreach&#40;LIST&#41; items</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #129215 for Future-AsyncAwait: Erroneous foreach&#40;LIST&#41; items</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Future-AsyncAwait">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Future-AsyncAwait">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Future-AsyncAwait">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Future-AsyncAwait">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Future-AsyncAwait">Future-AsyncAwait CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">129215</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Future-AsyncAwait">Future-AsyncAwait</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
leonerd-cpan [...] leonerd.org.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-267710-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.23</li>
<li>
0.25</li>
</ul>
    </td>
  </tr>
  <tr id="CF-267711-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.26    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




rt129215.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1843906/990977/rt129215.patch">
Thu Apr 18 12:56:09 2019 (3.5k) by leonerd-cpan [...] leonerd.org.uk
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=129215">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1843731" href="/Public/Bug/Display.html?id=129215#txn-1843731">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;17&nbsp;14:16:26&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Erroneous foreach&#40;LIST&#41; items</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1843731/990863/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/990863">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1012b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Example by Tom Molesworth:

$ perl -v

This is perl 5, version 28, subversion 1 &#40;v5.28.1&#41; built for x86_64-linux-gnu-thread-multi&#40;with 61 registered patches, see perl -V for more detail&#41;
...

$ perl -Mblib -e&#39;use Future::AsyncAwait; use IO::Async::Loop; my $loop = IO::Async::Loop-&gt;new; &#40;async sub { for my $k &#40;qw&#40;one two three four&#41;&#41; { print &#34;$k\n&#34;; await $loop-&gt;delay_future&#40;after =&gt; 0.01&#41;; print &#34;$k\n&#34; } }&#41;-&gt;&#40;&#41;-&gt;get&#39;
one
one
0
1
one
one
two
two
three
three
four
four
Bizarre copy of CODE in eval {block} exit at -e line 1.


I don&#39;t think this is a repeat of RT128619 as it doesn&#39;t involve stack temporaries, all the values here are const.

It also fails on pre-5.24 perls, in a somewhat similar way:

$ perl5.22.2 -Mblib -e&#39;use Future::AsyncAwait; use IO::Async::Loop; my $loop = IO::Async::Loop-&gt;new; &#40;async sub { for my $k &#40;qw&#40;one two three four&#41;&#41; { print &#34;$k\n&#34;; await $loop-&gt;delay_future&#40;after =&gt; 0.01&#41;; print &#34;$k\n&#34; } }&#41;-&gt;&#40;&#41;-&gt;get&#39;
one
one
0
1
1
1
one
one
two
two
three
three
four
four


-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1843733" href="/Public/Bug/Display.html?id=129215#txn-1843733">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;17&nbsp;14:56:59&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1843733/990865/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/990865">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 674b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Most awkwardly, this appears to actually require IO::Async to break.

I tried rewriting the example using just Future::IO, to make a smaller-dependency test case, but that passes:

# RT#129215
SKIP: {
   skip &#34;Future::IO not available&#34;, 1 unless eval { require Future::IO; };

   my $out = &#34;&#34;;

   &#40;async sub {
      foreach my $k &#40;qw&#40; one two three four &#41;&#41; {
         $out .= &#34;$k\n&#34;;
         await Future::IO-&gt;sleep&#40;0.01&#41;;
         $out .= &#34;$k\n&#34;;
      }
   }&#41;-&gt;&#40;&#41;-&gt;get;

   is&#40; $out, &#34;one\none\ntwo\ntwo\nthree\nthree\nfour\nfour\n&#34;,
      &#39;Output from sleepy foreach&#40;LIST&#41;&#39;
   &#41;;
}


But breaks as above if replaced with the $loop-&gt;delay_future&#40;&#41; call.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1843869" href="/Public/Bug/Display.html?id=129215#txn-1843869">#</a>      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;18&nbsp;07:47:54&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1843869/990949/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/990949">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 469b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This from perlguts might also be relevant:

       Most callers of &#34;cx_pushblock&#34; simply set the new args stack floor to
       the top of the previous stack frame, but for &#34;CXt_LOOP_LIST&#34; it stores
       the items being iterated over on the stack, and so sets &#34;blk_oldsp&#34; to
       the top of these items instead. Note that, contrary to its name,
       &#34;blk_oldsp&#34; doesn&#39;t always represent the value to restore &#34;PL_stack_sp&#34;
       to on scope exit.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1843904" href="/Public/Bug/Display.html?id=129215#txn-1843904">#</a>      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;18&nbsp;11:30:25&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1843904/990974/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/990974">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think there&#39;s still multiple bugs here. The one above might be one.

Another is that I&#39;m not accounting for the change in stack height between original and resumed functions.

Almost every bit of perl context in the context stack stores either SV pointers directly, or operates implicitly relative to PL_stack_sp at the time, so is immune to minor stack height differences. Not so the fields in CXt_LOOP_LIST. These fields are all I32 values that store the _absolute_ stack index, i.e. the index of PL_stack_base[ix] at which items are found:

  cx-&gt;blk_oldsp  == just beyond the list of items
  cx-&gt;blk_loop.state_u.stack.basesp == 1 before the first item in the list &#40;&#40;I&#39;ve no idea why it&#39;s 1 before...&#41;&#41;
  cx-&gt;blk_loop.state_u.stack.ix == current iteration item

When the `async sub` is first suspended, the stack includes the arguments it was called with, as well as the height of all its callers. When we resume, the stack height might be quite different. These absolute indices will need adjusting.

At suspend time we&#39;ll have to measure them relative to some point we can ensure we put back in place later on. At that point of execution, I *think* PL_stack_sp should be stable enough that we can measure them backwards, down from the top.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1843906" href="/Public/Bug/Display.html?id=129215#txn-1843906">#</a>      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;18&nbsp;12:56:09&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1843906/990976/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/990976">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 466b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; At suspend time we&#39;ll have to measure them relative to some point we
&gt; can ensure we put back in place later on. At that point of execution,
&gt; I *think* PL_stack_sp should be stable enough that we can measure them
&gt; backwards, down from the top.
</div>
Attached patch does this.

Tests now pass on 5.24+, but still fail on the previous versions of perl - which don&#39;t use CXt_LOOP_LIST. I suspect they&#39;ll have some other, analogous bug in their handling.

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt129215.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1843906/990977/rt129215.patch">Download rt129215.patch</a><br />
<span class="downloadcontenttype">text/x-diff 3.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== modified file &#39;lib/Future/AsyncAwait.xs&#39;
--- lib/Future/AsyncAwait.xs	2019-04-18 16:16:19 +0000
+++ lib/Future/AsyncAwait.xs	2019-04-18 16:22:03 +0000
@@ -126,6 +126,10 @@
     } eval;
     struct block_loop loop;
   } el;
+
+  /* for debugging purposes */
+  SV *loop_list_first_item;
+
 #ifdef HAVE_ITERVAR
   SV *itervar;
 #endif
@@ -749,6 +753,25 @@
            */
           if&#40;frame-&gt;stacklen || frame-&gt;marklen&#41;
             panic&#40;&#34;ARGH CXt_LOOP_LIST frame tried to steal stack values or marks&#34;&#41;;
+
+          /* The various fields in the context structure store absolute stack
+           * heights as offsets from PL_stack_base directly. When we get
+           * resumed the stack will probably not be the same absolute height
+           * at this point, so we&#39;ll have to store them relative to something
+           * fixed.
+           * We&#39;ll adjust them to be upside-down, counting -backwards- from
+           * the current stack height.
+           */
+          I32 height = PL_stack_sp - PL_stack_base;
+
+          if&#40;cx-&gt;blk_oldsp != height&#41;
+            panic&#40;&#34;ARGH suspending CXt_LOOP_LIST frame with blk_oldsp != stack height&#34;&#41;;
+
+          /* First item is at [1] oddly, not [0] */
+          frame-&gt;loop_list_first_item = PL_stack_base[cx-&gt;blk_loop.state_u.stack.basesp+1];
+
+          frame-&gt;el.loop.state_u.stack.basesp = height - frame-&gt;el.loop.state_u.stack.basesp;
+          frame-&gt;el.loop.state_u.stack.ix     = height - frame-&gt;el.loop.state_u.stack.ix;
           break;
 #endif
       }
@@ -1225,6 +1248,33 @@
     Safefree&#40;frame-&gt;mortals&#41;;
     frame-&gt;mortals = NULL;
   }
+
+  switch&#40;frame-&gt;type&#41; {
+#if HAVE_PERL_VERSION&#40;5, 24, 0&#41;
+    case CXt_LOOP_LIST: {
+      I32 height = PL_stack_sp - PL_stack_base;
+
+      cx-&gt;blk_loop.state_u.stack.basesp = height - cx-&gt;blk_loop.state_u.stack.basesp;
+      cx-&gt;blk_loop.state_u.stack.ix     = height - cx-&gt;blk_loop.state_u.stack.ix;
+
+      /* For consistency; check that the first SV in the list is in the right
+       * place. If so we presume the others are
+       */
+      if&#40;PL_stack_base[cx-&gt;blk_loop.state_u.stack.basesp+1] == frame-&gt;loop_list_first_item&#41;
+        break;
+
+      /* First item is at [1] oddly, not [0] */
+      fprintf&#40;stderr, &#34;F:AA: consistency check resume LOOP_LIST with first=%p:&#34;,
+        frame-&gt;loop_list_first_item&#41;;
+      debug_sv_summary&#40;frame-&gt;loop_list_first_item&#41;;
+      fprintf&#40;stderr, &#34; stackitem=%p:&#34;, PL_stack_base[frame-&gt;el.loop.state_u.stack.basesp + 1]&#41;;
+      debug_sv_summary&#40;PL_stack_base[frame-&gt;el.loop.state_u.stack.basesp]&#41;;
+      fprintf&#40;stderr, &#34;\n&#34;&#41;;
+      panic&#40;&#34;ARGH CXt_LOOP_LIST consistency check failed&#34;&#41;;
+      break;
+    }
+#endif
+  }
 }
 
 #define suspendedstate_resume&#40;state, cv&#41;  MY_suspendedstate_resume&#40;aTHX_ state, cv&#41;

=== modified file &#39;t/22context-foreach.t&#39;
--- t/22context-foreach.t	2018-01-20 14:09:54 +0000
+++ t/22context-foreach.t	2019-04-18 16:22:03 +0000
@@ -119,6 +119,24 @@
    is&#40; scalar $fret-&gt;get, &#34;awaited twice&#34;, &#39;$fret now ready after foreach with two awaits&#39; &#41;;
 }
 
+# RT#129215
+{
+   my @F = map { Future-&gt;new } 0, 1, 2;
+   my $fret = &#40;async sub {
+      foreach my $idx &#40; 0, 1, 2 &#41; {
+         await $F[$idx];
+      }
+      return &#34;OK&#34;;
+   }&#41;-&gt;&#40;&#41;;
+
+   # Arrange for the stack to be at different heights on each resume
+   my $tmp = do { 1 + &#40; $F[0]-&gt;done // 0 &#41; };
+   $tmp = [ 2, 3, [ $F[1]-&gt;done ] ];
+   $tmp = 4 * &#40; 6 + &#40; $F[2]-&gt;done // 0 &#41; &#41;;
+
+   is&#40; scalar $fret-&gt;get, &#34;OK&#34;, &#39;$fret now ready after differing stack resumes&#39; &#41;;
+}
+
 # TODO:
 #   This ought to be a compiletime check. That&#39;s hard right now so for now
 #   it&#39;s a runtime check

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1843998" href="/Public/Bug/Display.html?id=129215#txn-1843998">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;19&nbsp;06:42:38&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1843998/991018/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/991018">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 72b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This plus another fix for pre-5.24 was released in 0.24

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1843999" href="/Public/Bug/Display.html?id=129215#txn-1843999">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;19&nbsp;06:42:39&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1844000" href="/Public/Bug/Display.html?id=129215#txn-1844000">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;19&nbsp;06:42:39&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Fixed in 0.24 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1845236" href="/Public/Bug/Display.html?id=129215#txn-1845236">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;26&nbsp;10:02:33&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1845236/991636/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/991636">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 186b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">It&#39;s back. Turns out to be the cause of both

  <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=129319">https://rt.cpan.org/Ticket/Display.html?id=129319</a></span>
  <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=129320">https://rt.cpan.org/Ticket/Display.html?id=129320</a></span>

in different ways.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1845237" href="/Public/Bug/Display.html?id=129215#txn-1845237">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;26&nbsp;10:02:33&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1845238" href="/Public/Bug/Display.html?id=129215#txn-1845238">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;26&nbsp;10:02:43&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Fixed in 0.24 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1845239" href="/Public/Bug/Display.html?id=129215#txn-1845239">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;26&nbsp;10:02:43&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Broken in 0.25 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1845895" href="/Public/Bug/Display.html?id=129215#txn-1845895">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;29&nbsp;04:44:54&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1845895/991984/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/991984">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 280b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Apr 26 10:02:33 2019, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It&#39;s back. Turns out to be the cause of both
&gt; 
&gt;   <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=129319">https://rt.cpan.org/Ticket/Display.html?id=129319</a></span>
&gt;   <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=129320">https://rt.cpan.org/Ticket/Display.html?id=129320</a></span>
</div>
Those two are fixed, I think we can close this one again now.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1845896" href="/Public/Bug/Display.html?id=129215#txn-1845896">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;29&nbsp;04:44:55&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1845897" href="/Public/Bug/Display.html?id=129215#txn-1845897">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;29&nbsp;04:44:55&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Fixed in 0.26 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.502597</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
