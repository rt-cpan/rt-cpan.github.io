<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #18265 for Workflow: [PATCH] enable dynamic loading of config files</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #18265 for Workflow: [PATCH] enable dynamic loading of config files</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Workflow/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Workflow/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Workflow/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Workflow/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/jonasbn/perl-workflow/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Workflow">Workflow CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">18265</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Workflow/Active/">Workflow</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">jonasbn [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
andrewo [...] oriel.com.au

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-35958-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-35959-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<ul>
<li>
1.33_2</li>
<li>
1.33</li>
</ul>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;21&nbsp;03:11:58&nbsp;2006</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] enable dynamic loading of config files</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I was unable to subclass Workflow::Factory to allow me to dynamically
load configs at runtime so here&#39;s a patch to the core that allows just that.

I&#39;ve added a new section to the docs and added an
_initialize_workflow_config function which calls a user-specified
callback located in the factory accessor &#34;get_workflow_config_func&#34;.
Example usage in the pod.

I haven&#39;t added full details to the function list nor have I added an
external &#34;initialize_workflow_config&#34; wrapper as I&#39;m not sure if this is
useful or wanted. And no, there is no test for this yet :&#41;

Comments, flames and requests for changes welcome.

Thanks for the module!
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dynamically_loaded_configs.0.17.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -rBbu Workflow-0.17.orig/lib/Workflow/Factory.pm Workflow-0.17/lib/Workflow/Factory.pm
--- Workflow-0.17.orig/lib/Workflow/Factory.pm	2006-03-16 13:03:23.000000000 +1100
+++ Workflow-0.17/lib/Workflow/Factory.pm	2006-03-21 18:56:49.000000000 +1100
@@ -7,6 +7,7 @@
 use DateTime;
 use Log::Log4perl       qw&#40; get_logger &#41;;
 use Workflow::Exception qw&#40; configuration_error workflow_error &#41;;
+use Oriel::WF::Config &#40;&#41;;
 
 $Workflow::Factory::VERSION  = sprintf&#40;&#34;%d.%02d&#34;, q$Revision: 1.16 $ =~ /&#40;\d+&#41;\.&#40;\d+&#41;/&#41;;
 
@@ -51,7 +52,7 @@
 
 my $INITIAL_STATE = &#39;INITIAL&#39;;
 
-my @FIELDS = qw&#40;&#41;;
+my @FIELDS = qw&#40;get_workflow_config_func&#41;;
 __PACKAGE__-&gt;mk_accessors&#40; @FIELDS &#41;;
 
 sub new {
@@ -80,6 +81,30 @@
 
 my %CONFIG = &#40; &#39;Workflow::Config&#39; =&gt; 1 &#41;;
 
+####################################
+#### Oriel functions start here ####
+####################################
+
+sub _dump_instances {
+  my $class = shift;
+  $class = ref&#40;$class&#41; || $class;
+  require Data::Dumper;
+  warn Data::Dumper::Dumper&#40; $class, \%INSTANCES &#41;;
+}
+sub _initialize_workflow_config {
+  my $self = shift;
+  my $wf_type = shift;
+  $log ||= get_logger&#40;&#41;;
+  if &#40; ref&#40;$self-&gt;get_workflow_config_func&#41; eq &#39;CODE&#39; &#41; {
+    my $args = &#38;{ $self-&gt;get_workflow_config_func }&#40; $wf_type &#41;;
+    $self-&gt;add_config_from_file&#40; %$args &#41; if $args &#38;&#38; %$args;
+  }
+}
+
+##################################
+#### Oriel functions end here ####
+##################################
+
 sub add_config_from_file {
     my &#40; $self, %params &#41; = @_;
     return unless &#40; scalar keys %params &#41;;
@@ -321,6 +346,7 @@
 
 sub _get_workflow_config {
     my &#40; $self, $wf_type &#41; = @_;
+    $self-&gt;_initialize_workflow_config&#40; $wf_type &#41; unless $self-&gt;{_workflow_config}{ $wf_type };
     return $self-&gt;{_workflow_config}{ $wf_type };
 }
 
@@ -803,6 +829,39 @@
 
 Returns: nothing
 
+=head1 DYNAMIC CONFIG LOADING
+
+If you have either a large set of config files or a set of large
+config files then you may not want to incur the overhead of loading
+each and every one on startup if you cannot predict which set you will
+use in that instance of your application.
+
+To combat this you can specify a callback that the factory will use to
+retrieve batched hashes of config_declarations. Whenever an unknown
+workflow name is encountered the factory will first try to load your
+config declarations then continue.
+
+The callback takes one argument which is the workflow type. It should
+return a reference to a hash of arguments in a form suitable for
+C&lt;add_config_from_file&gt;.
+
+For example:
+
+ use Workflow::Factory qw&#40;FACTORY&#41;;
+ use My::Config::System;
+
+ sub my_application_init {
+   my $self = shift;
+ 
+   FACTORY-&gt;get_workflow_config_func&#40;
+     sub {
+       my $wf_type = shift;
+       my %ret = My::Config::System-&gt;get_files_for_wf&#40; $wf_type &#41; || &#40;&#41;;
+       return \%ret;
+     }
+   &#41;;
+ }
+
 =head1 SUBCLASSING
 
 =head2 Implementation and Usage
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;03&nbsp;11:28:48&nbsp;2006</span>
    <span class="description">chris [...] cwinters.com -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Steal odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;04&nbsp;03:08:10&nbsp;2006</span>
    <span class="description">jonasbn [...] cpan.org -  Stolen from CWINTERS</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;07&nbsp;14:55:47&nbsp;2006</span>
    <span class="description">jonasbn [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jonasbn [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Mar 21 03:11:58 2006, guest wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I was unable to subclass Workflow::Factory to allow me to dynamically
&gt; load configs at runtime so here&#39;s a patch to the core that allows just that.
&gt; 
&gt; I&#39;ve added a new section to the docs and added an
&gt; _initialize_workflow_config function which calls a user-specified
&gt; callback located in the factory accessor &#34;get_workflow_config_func&#34;.
&gt; Example usage in the pod.
&gt; 
&gt; I haven&#39;t added full details to the function list nor have I added an
&gt; external &#34;initialize_workflow_config&#34; wrapper as I&#39;m not sure if this is
&gt; useful or wanted. And no, there is no test for this yet :&#41;
&gt; 
&gt; Comments, flames and requests for changes welcome.
&gt; 
&gt; Thanks for the module!
</div>
Hello,

I am very keen on the feature, but do you have some tests to accompagny this?

jonasbn
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;07&nbsp;14:55:48&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;21&nbsp;16:02:50&nbsp;2006</span>
    <span class="description">jonasbn [...] cpan.org -  Status changed from &#39;open&#39; to &#39;new&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;28&nbsp;17:59:33&nbsp;2009</span>
    <span class="description">andrewo [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">See attached for an updated patch against 1.32. This new patch includes
documentation and tests but does not modify the Changes file.

Hope this is helpful!
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -rNu Workflow-1.32.orig/MANIFEST Workflow-1.32/MANIFEST
--- Workflow-1.32.orig/MANIFEST	2009-01-27 02:07:31.000000000 +1100
+++ Workflow-1.32/MANIFEST	2009-01-28 18:50:30.000000000 +1100
@@ -92,6 +92,7 @@
 t/context.t
 t/exception.t
 t/factory.t
+t/factory_callback_config.t
 t/factory_subclass.t
 t/FactorySubclass.pm
 t/history.t
@@ -112,6 +113,7 @@
 t/TestApp/Action/TicketCreate.pm
 t/TestApp/Action/TicketCreateType.pm
 t/TestApp/Action/TicketUpdate.pm
+t/TestApp/Condition/AlwaysTrue.pm
 t/TestApp/Condition/HasUser.pm
 t/TestApp/Condition/HasUserType.pm
 t/TestApp/Ticket.pm
@@ -129,14 +131,17 @@
 t/workflow.xml
 t/workflow_action.perl
 t/workflow_action.xml
+t/workflow_action_callback.xml
 t/workflow_action_type.perl
 t/workflow_action_type.xml
 t/workflow_autorun.xml
 t/workflow_cached_condition.xml
 t/workflow_cached_condition_action.xml
 t/workflow_cached_condition_condition.xml
+t/workflow_callback.xml
 t/workflow_condition.perl
 t/workflow_condition.xml
+t/workflow_condition_callback.xml
 t/workflow_condition_type.perl
 t/workflow_condition_type.xml
 t/workflow_errorprone.perl
diff -rNu Workflow-1.32.orig/lib/Workflow/Factory.pm Workflow-1.32/lib/Workflow/Factory.pm
--- Workflow-1.32.orig/lib/Workflow/Factory.pm	2009-01-27 02:07:31.000000000 +1100
+++ Workflow-1.32/lib/Workflow/Factory.pm	2009-01-28 17:18:42.000000000 +1100
@@ -56,7 +56,7 @@
 
 my $INITIAL_STATE = &#39;INITIAL&#39;;
 
-my @FIELDS = qw&#40;&#41;;
+my @FIELDS = qw&#40;config_callback&#41;;
 __PACKAGE__-&gt;mk_accessors&#40;@FIELDS&#41;;
 
 sub new {
@@ -405,8 +405,19 @@
     $wf-&gt;add_observer&#40;$_&#41; for &#40; @{$observers} &#41;;
 }
 
+sub _initialize_workflow_config {
+    my $self = shift;
+    my $wf_type = shift;
+    $log ||= get_logger&#40;&#41;;
+    if &#40; ref&#40;$self-&gt;config_callback&#41; eq &#39;CODE&#39; &#41; {
+        my $args = &#38;{ $self-&gt;config_callback }&#40; $wf_type &#41;;
+        $self-&gt;add_config_from_file&#40; %$args &#41; if $args &#38;&#38; %$args;
+    }
+}
+
 sub _get_workflow_config {
     my &#40; $self, $wf_type &#41; = @_;
+    $self-&gt;_initialize_workflow_config&#40; $wf_type &#41; unless $self-&gt;{_workflow_config}{ $wf_type };
     return $self-&gt;{_workflow_config}{$wf_type};
 }
 
@@ -1001,6 +1012,44 @@
 
 L&lt;/instance&gt; should be called or the imported &#39;FACTORY&#39; should be utilized.
 
+=head1 DYNAMIC CONFIG LOADING
+
+If you have either a large set of config files or a set of very large
+config files then you may not want to incur the overhead of loading
+each and every one on startup if you cannot predict which set you will
+use in that instance of your application.
+
+This approach doesn&#39;t make much sense in a persistent environment such
+as mod_perl but it may lower startup costs if you have regularly
+scheduled scripts that may not need to touch all possible types of
+workflow.
+
+To do this you can specify a callback that the factory will use to
+retrieve batched hashes of config declarations. Whenever an unknown
+workflow name is encountered the factory will first try to load your
+config declarations then continue.
+
+The callback takes one argument which is the workflow type. It should
+return a reference to a hash of arguments in a form suitable for
+C&lt;add_config_from_file&gt;.
+
+For example:
+
+ use Workflow::Factory qw&#40;FACTORY&#41;;
+ use My::Config::System;
+
+ sub init {
+   my $self = shift;
+
+   FACTORY-&gt;config_callback&#40;
+     sub {
+       my $wf_type = shift;
+       my %ret = My::Config::System-&gt;get_files_for_wf&#40; $wf_type &#41; || &#40;&#41;;
+       return \%ret;
+     }
+   &#41;;
+ }
+
 =head1 SUBCLASSING
 
 =head2 Implementation and Usage
diff -rNu Workflow-1.32.orig/t/TestApp/Condition/AlwaysTrue.pm Workflow-1.32/t/TestApp/Condition/AlwaysTrue.pm
--- Workflow-1.32.orig/t/TestApp/Condition/AlwaysTrue.pm	1970-01-01 10:00:00.000000000 +1000
+++ Workflow-1.32/t/TestApp/Condition/AlwaysTrue.pm	2009-01-28 17:41:33.000000000 +1100
@@ -0,0 +1,19 @@
+package TestApp::Condition::AlwaysTrue;
+
+# $Id$
+
+use strict;
+use base qw&#40; Workflow::Condition &#41;;
+use Log::Log4perl       qw&#40; get_logger &#41;;
+use Workflow::Exception qw&#40; condition_error &#41;;
+
+$TestApp::Condition::AlwaysTrue::VERSION = &#39;0.01&#39;;
+
+sub evaluate {
+    my &#40; $self, $wf &#41; = @_;
+    my $log = get_logger&#40;&#41;;
+    $log-&gt;debug&#40; &#34;Trying to execute condition &#34;, ref&#40; $self &#41; &#41;;
+    $log-&gt;debug&#40; &#39;Condition met ok&#39; &#41;;
+}
+
+1;
diff -rNu Workflow-1.32.orig/t/factory_callback_config.t Workflow-1.32/t/factory_callback_config.t
--- Workflow-1.32.orig/t/factory_callback_config.t	1970-01-01 10:00:00.000000000 +1000
+++ Workflow-1.32/t/factory_callback_config.t	2009-01-29 09:39:39.000000000 +1100
@@ -0,0 +1,39 @@
+# -*-perl-*-
+
+# $Id$
+
+use strict;
+use lib &#39;t&#39;;
+use TestUtil;
+use Test::More tests =&gt; 7;
+use Test::Exception;
+
+require_ok&#40; &#39;Workflow::Factory&#39; &#41;;
+
+my $factory = Workflow::Factory-&gt;instance&#40;&#41;;
+my $wf;
+
+lives_ok { TestUtil-&gt;init_mock_persister }
+  &#39;Loading test persister succeeds&#39;;
+
+dies_ok { $wf = $factory-&gt;create_workflow&#40; &#39;CallbackTest&#39; &#41; }
+  &#39;Attempt to create new workflow without loading its config first dies&#39;;
+
+can_ok&#40; $factory, &#39;config_callback&#39; &#41;;
+
+lives_ok { $factory-&gt;config_callback&#40; sub {
+					my $type = shift;
+					if &#40;$type eq &#39;CallbackTest&#39;&#41; {
+					  return { workflow =&gt; &#39;workflow_callback.xml&#39;,
+						   action =&gt; &#39;workflow_action_callback.xml&#39;,
+						   condition =&gt; &#39;workflow_condition_callback.xml&#39; };
+					}
+					return {};
+				      } &#41; }
+  &#39;Setting callback function succeeds&#39;;
+
+dies_ok { $wf = $factory-&gt;create_workflow&#40; &#39;CallbackTestBogus&#39; &#41; }
+  &#39;Attempt to create unknown workflow still dies&#39;;
+
+lives_ok { $wf = $factory-&gt;create_workflow&#40; &#39;CallbackTest&#39; &#41; }
+  &#39;Attempt to create known workflow via callback succeeds&#39;;
diff -rNu Workflow-1.32.orig/t/workflow_action_callback.xml Workflow-1.32/t/workflow_action_callback.xml
--- Workflow-1.32.orig/t/workflow_action_callback.xml	1970-01-01 10:00:00.000000000 +1000
+++ Workflow-1.32/t/workflow_action_callback.xml	2009-01-28 18:18:45.000000000 +1100
@@ -0,0 +1,8 @@
+&lt;actions&gt;
+  &lt;type&gt;CallbackTest&lt;/type&gt;
+  &lt;description&gt;Actions for the CallbackTest workflow only&lt;/description&gt;
+
+  &lt;action name=&#34;CALLBACK_CLOSE&#34; class=&#34;Workflow::Action::Null&#34;&gt;
+    &lt;description&gt;Dummy close a callback test workflow&lt;/description&gt;
+  &lt;/action&gt;
+&lt;/actions&gt;
\ No newline at end of file
diff -rNu Workflow-1.32.orig/t/workflow_callback.xml Workflow-1.32/t/workflow_callback.xml
--- Workflow-1.32.orig/t/workflow_callback.xml	1970-01-01 10:00:00.000000000 +1000
+++ Workflow-1.32/t/workflow_callback.xml	2009-01-29 09:40:17.000000000 +1100
@@ -0,0 +1,17 @@
+&lt;workflow&gt;
+  &lt;type&gt;CallbackTest&lt;/type&gt;
+  &lt;description&gt;This is a sample workflow used to test loading config on demand&lt;/description&gt;
+  &lt;persister&gt;TestPersister&lt;/persister&gt;
+  &lt;state name=&#34;INITIAL&#34;&gt;
+    &lt;description&gt;This is the state the workflow enters when
+      instantiated. It&#39;s like a &#39;state zero&#39; but since we&#39;re
+      using names rather than IDs we cannot assume&lt;/description&gt;
+    &lt;action name=&#34;CALLBACK_CLOSE&#34; resulting_state=&#34;Callback_Closed&#34;&gt;
+      &lt;condition name=&#34;CallbackAlwaysTrue&#34;/&gt;
+    &lt;/action&gt;
+  &lt;/state&gt;
+
+  &lt;state name=&#34;Callback_Closed&#34;&gt;
+    &lt;description&gt;Placeholder closed state&lt;/description&gt;
+  &lt;/state&gt;
+&lt;/workflow&gt;
diff -rNu Workflow-1.32.orig/t/workflow_condition_callback.xml Workflow-1.32/t/workflow_condition_callback.xml
--- Workflow-1.32.orig/t/workflow_condition_callback.xml	1970-01-01 10:00:00.000000000 +1000
+++ Workflow-1.32/t/workflow_condition_callback.xml	2009-01-28 17:38:24.000000000 +1100
@@ -0,0 +1,4 @@
+&lt;conditions&gt;
+  &lt;type&gt;CallbackTest&lt;/type&gt;
+  &lt;condition name=&#34;CallbackAlwaysTrue&#34; class=&#34;TestApp::Condition::AlwaysTrue&#34;/&gt;
+&lt;/conditions&gt;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;28&nbsp;17:59:34&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;23&nbsp;18:07:51&nbsp;2009</span>
    <span class="description">jonasbn [...] cpan.org -  Fixed in 1.33_2 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;23&nbsp;18:08:24&nbsp;2009</span>
    <span class="description">jonasbn [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This patch is currently under evaluation, please see release 1.33_2

jonasbn
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;23&nbsp;18:08:25&nbsp;2009</span>
    <span class="description">jonasbn [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;27&nbsp;09:17:08&nbsp;2012</span>
    <span class="description">jonasbn [...] cpan.org -  Fixed in 1.33 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
