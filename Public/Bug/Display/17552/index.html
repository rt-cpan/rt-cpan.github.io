<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #17552 for Net-FTPSSL: On redhat linux ftps session hangs afte USER xxx command is sent</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #17552 for Net-FTPSSL: On redhat linux ftps session hangs afte USER xxx command is sent</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-FTPSSL/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-FTPSSL/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-FTPSSL/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-FTPSSL/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-FTPSSL">Net-FTPSSL CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">17552</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-FTPSSL/Active/">Net-FTPSSL</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">kral [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dong.yan [...] morganstanley.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-22628-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.04    </td>
  </tr>
  <tr id="CF-22629-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;09&nbsp;10:16:21&nbsp;2006</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> On redhat linux ftps session hangs afte USER xxx command is sent</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">While testing on redhat linux my ftps session consistantly hangs after
the &#34;USER xxx&#34; command is sent. The error condition is 100% reproduceable.

On the server side, the &#34;331 Enter password&#34; response has already been
sent. On the client side, the Net::FTPSSL module is stuck in sysread in
sub response.

Since the same sysread works just a moment before, against the same
socket in clear text, I suspect the clear-to-ssl switch has something to
do with it, and the fault lies not in Net::FTPSSL, but one of the
underlying SSL modules.

I have found a workaround in Net::FTPSSL, by having Net::FTPSSL read the
server response one character at a time. Although this workaround seems
to solve the problem, I am hesitate to call it a patch, because it may
not be fixing the real thing. In any case, I am attaching the workaround
for your review. &#40;Although you can&#39;t apply this workaround and the patch
for bug 16751 at the same time, this workaround also handles long,
multi-line response correctly.&#41;

Oddly enough, the data channels, which are also SSL, continue to be read
chunks at a time, and yet I never run into any hung situation...

Here is the details of my test environment:

perl version: 5.8.4
$IO::Socket::SSL:VERSION = 0.97
$Net::SSLeay::VERSION = 1.25
$Net::FTPSSL::VERSION = 0.04
openssl library version: 0.9.7

The client and server are on different hosts, on the same network, with
the same OS type/revision.

sysinfo output of client host:

        G E N E R A L   I N F O R M A T I O N
 
Host Name is                   pi119c2n13
Host Address&#40;es&#41; is            144.14.14.73
Host ID is                     0e90490e
Serial Number is               KPGPZ36
Manufacturer is                IBM
Manufacturer &#40;Short&#41; is        IBM
Manufacturer &#40;Full&#41; is         IBM
System Model is                eServer BladeCenter HS20 -[88323EX]-
Main Memory is                 8.0 GB
Virtual Memory is              12 GB
Number of CPUs &#40;Physical&#41; is   2
Number of CPUs &#40;Virtual&#41; is    4
Number of CPUs Online is       4
CPU Type is                    i686
CPU Model is                   Xeon
CPU Speed is                   3.1 GHz
App Architecture is            x86
Kernel Architecture is         i686
Kernel Bit Size is             32
OS Name is                     Linux
OS Version is                  2.4.21-32.0.1.ELhugemem
OS Distribution is             Red Hat Enterprise Linux AS release 3
&#40;Taroon Update 4&#41;
OS Distribution Name is        Red Hat Enterprise Linux
OS Distribution Short Name is  rhel
OS Distribution Version is     3
Libc Version is                2.3.2
Kernel Version is              Linux version 2.4.21-32.0.1.ELhugemem
&#40;bhcompile@bugs.build.redhat.com&#41; &#40;gcc version 3.2.3 20030502 &#40;Red Hat
Linux 3.2.3-52&#41;&#41; #1 SMP Tue May 17 17:43:22 EDT 2005
Boot Time is                   Sat Jul 16 23:56:29 2005 EDT
Current Time is                Thu Feb  9 09:20:59 2006 EST
Time Zone is                   EST
Primary User Login is          dong
Primary User Name is           Dong Yan

sysinfo output of server host is very similar &#40;difference being
hostname, ip address, etc&#41;.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> workaround.txt</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- FTPSSL.pm.ORIG	2006-02-08 15:01:01.000000000 -0500
+++ FTPSSL.pm.PATCH	2006-02-09 09:19:39.000000000 -0500
@@ -657,29 +657,31 @@
   my $self = shift;
   my &#40; $data, $code &#41;;
 
-	my $read = sysread&#40; $self, $data, 4096&#41;;
-	unless&#40; defined $read &#41; {
-		croak &#34;Can&#39;t read on socket: $!&#34;;
-	}
-
-	my @lines = split&#40; &#34;\015\012&#34;, $data &#41;;
-		
-  foreach my $line &#40; @lines &#41; {
-
-# 	$data = $self-&gt;getline&#40;&#41;;	
-#   $data =~ m/^&#40;\d+&#41;&#40;\-?&#41;&#40;.*&#41;$/s;
-    $line =~ m/^&#40;\d+&#41;&#40;\-?&#41;&#40;.*&#41;$/s;
-
-    $code = $1;
-    print STDERR &#34;&lt;&lt;&lt; &#34; . $line .&#34;\n&#34;
-      if ref&#40;$self&#41; eq &#34;Net::FTPSSL&#34; &#38;&#38; ${*$self}{&#39;debug&#39;};
-
-    if &#40; ref&#40;$self&#41; eq &#34;Net::FTPSSL&#34; &#41; {
-      ${*$self}{&#39;last_ftp_msg&#39;} = $line;
+  $code = &#39;000&#39;;
+  my $line = &#39;&#39;;
+  my $all_lines = &#39;&#39;;
+  while &#40;1&#41; {
+    my $read = sysread&#40; $self, $data, 1 &#41;;
+    unless&#40; defined $read &#41; {
+      next if $! == EINTR;
+      croak &#34;Can&#39;t read on socket: $!&#34;;
     }
+    $line .= $data;
+    if &#40;$data eq &#34;\012&#34; &#41; {
+      $line =~ s/\015//g;
+      $all_lines .= $line;
+      print STDERR &#34;&lt;&lt;&lt; &#34; . $line
+        if ref&#40;$self&#41; eq &#34;Net::FTPSSL&#34; &#38;&#38; ${*$self}{&#39;debug&#39;};
+      if &#40; $line =~ /^\d{3} / &#41; {
+        $code = substr&#40; $line, 0, 3 &#41;;
+        last;
+      }
+      $line = &#39;&#39;;
+    }
+  }
 
-    last if $2 ne &#39;-&#39;;
-
+  if &#40; ref&#40;$self&#41; eq &#34;Net::FTPSSL&#34; &#41; {
+    ${*$self}{&#39;last_ftp_msg&#39;} = $all_lines;
   }
 
   return substr&#40; $code, 0, 1 &#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;11&nbsp;16:11:25&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> swistak &#40;marcin.raczkowski [...] gmail.com&#41;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I had same problem,
my box is ubuntu, destination box - few various servers - all react same
way :/
patch submited here helped :D

another problem is 
&#34;SSL connect attempt failed
error:1408F10B:SSL routines:SSL3_GET_RECORD:wrong version number&#34;
that i get when i try to turn on implicit ssl :&#40;
no idea how to fix it, tried changing TLSv1 to SSLv2, SSLv3 etc, but it
didn&#39;t work, any idea how to fix it ?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;11&nbsp;16:11:26&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;12&nbsp;03:02:09&nbsp;2006</span>
    <span class="description">kral [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;12&nbsp;03:14:15&nbsp;2006</span>
    <span class="description">kral [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mar. 11 Apr. 2006 16:11:25, guest wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I had same problem,
&gt; my box is ubuntu, destination box - few various servers - all react 
</div>same
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; way :/
&gt; patch submited here helped :D
</div>
Yes, I know it helps but I don&#39;t think that is the better way to solve 
the problem.
I&#39;m rewriting part of the module, but I have no time, so a new version 
will not be released in short time. I&#39;m so sorry.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; another problem is 
&gt; &#34;SSL connect attempt failed
&gt; error:1408F10B:SSL routines:SSL3_GET_RECORD:wrong version number&#34;
&gt; that i get when i try to turn on implicit ssl :&#40;
&gt; no idea how to fix it, tried changing TLSv1 to SSLv2, SSLv3 etc, but 
</div>it
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; didn&#39;t work, any idea how to fix it ?
</div>
It seems to be an openssl error when Net::SSLeay tries to establish a 
connection with the server.
Does your ftp server work with certificates? Cause they currently not 
supported by Net::FTPSSL.

-- 
kral
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;04&nbsp;12:00:45&nbsp;2006</span>
    <span class="description">kral [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m working on the 0.05 version of Net::FTPSSL. If everything goes well,
I&#39;m going to release the new version on this week. The new version
requires at least IO::Socket::SSL 0.997, which resolves the hanging
problems.

Ciao,
-- 
kral
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;04&nbsp;12:00:46&nbsp;2006</span>
    <span class="description">kral [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
