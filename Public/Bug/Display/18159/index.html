<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #18159 for Workflow: Workflow::Factory subclassing not supported?</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #18159 for Workflow: Workflow::Factory subclassing not supported?</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Workflow/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Workflow/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Workflow/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Workflow/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/jonasbn/perl-workflow/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Workflow">Workflow CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">18159</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Workflow/Active/">Workflow</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">jonasbn [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
andrewo [...] oriel.com.au

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
alech [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-35958-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.17    </td>
  </tr>
  <tr id="CF-35959-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.34_3    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;14&nbsp;03:31:14&nbsp;2006</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Workflow::Factory subclassing not supported?</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Subclassing Workflow::Factory just plain doesn&#39;t work, unless I&#39;m
missing the main thrust of the idea :&#41; Please let me know what obvious
thing I&#39;m missing here &#40;after spending a few hours looking at it I&#39;m
sure I must be missing something!&#41;


The two attached files demonstrate the problem when used with the ticket
example. Place Factory.pm in the App subdir and then run
subclass_test.pl in the root. subclass_test.pl is basically just a
drastically cut down ticket.pl

Detail:

When you use a custom factory class in your app and call
FACTORY-&gt;add_config_from_file&#40;&#41; it initialises structures in
$Workflow::Factory::INSTANCES{$custom_class}. Cool, no problem. Until
the core code, eg Workflow::State, does a &#34;use Workflow::Factory
qw&#40;FACTORY&#41;;&#34; which causes all the local-to-Workflow::State FACTORY
function accesses to look for configs in the &#39;Workflow::Factory&#39; hash
entry &#40;which is empty&#41; rather than the $custom_class entry. So things die.

Obviously there are several ways around this:

1. Use $custom_class-&gt;instance-&gt;new_method and
Workflow::Factory-&gt;instance-&gt;for_everything_else&#40;&#41; in your code but that
sorta defeats the purpose of subclassing.

2. Add custom functions directly into Workflow::Factory

3. Not actually subclass in $custom_class but instead act as a proxy for
all methods and actually call Workflow::Factory-&gt;some_method for
everything in, eg, an AUTOLOAD situation. Not nice.

4. What am I missing? :&#41;

All I&#39;m attempting to do is to override methods like create_workflow&#40;&#41;
and fetch_workflow&#40;&#41; so that I can dynamically load workflows at runtime
rather than have to preload a large set of XML on startup.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Factory.pm</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
package App::Factory;

use strict;
use base qw&#40;Workflow::Factory&#41;;

sub some_cool_method { print shift,&#34;: Wheee\n&#34;; }

1;
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> subclass_test.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use Log::Log4perl     qw&#40; get_logger &#41;;
use App::Factory      qw&#40; FACTORY &#41;;

$| = 1;

Log::Log4perl::init&#40; &#39;log4perl.conf&#39; &#41;;
my $log = get_logger&#40;&#41;;

$log-&gt;info&#40; &#34;Starting: &#34;, scalar&#40; localtime &#41; &#41;;

FACTORY-&gt;add_config_from_file&#40; workflow  =&gt; &#39;workflow.xml&#39;,
                               action    =&gt; &#39;workflow_action.xml&#39;,
                               validator =&gt; &#39;workflow_validator.xml&#39;,
                               condition =&gt; &#39;workflow_condition.xml&#39;,
                               persister =&gt; &#39;workflow_persister.xml&#39; &#41;;
$log-&gt;info&#40; &#34;Finished configuring workflow factory&#34; &#41;;

exit;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;04&nbsp;03:09:04&nbsp;2006</span>
    <span class="description">jonasbn [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;22&nbsp;03:51:57&nbsp;2007</span>
    <span class="description">alech [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> alech [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Mar 14 03:31:14 2006, guest wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Subclassing Workflow::Factory just plain doesn&#39;t work, unless I&#39;m
&gt; missing the main thrust of the idea :&#41; Please let me know what obvious
&gt; thing I&#39;m missing here &#40;after spending a few hours looking at it I&#39;m
&gt; sure I must be missing something!&#41;
</div>I believe you are not missing it, unfortunately. Subclassing
Workflow::Factory seems to be broken.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $Workflow::Factory::INSTANCES{$custom_class}. Cool, no problem. Until
&gt; the core code, eg Workflow::State, does a &#34;use Workflow::Factory
&gt; qw&#40;FACTORY&#41;;&#34; which causes all the local-to-Workflow::State FACTORY
&gt; function accesses to look for configs in the &#39;Workflow::Factory&#39; hash
&gt; entry &#40;which is empty&#41; rather than the $custom_class entry. So things die.
&gt; 
&gt; Obviously there are several ways around this:
</div>[...]
5. Hacking the symbol table. Not exactly the nicest way, but it is
quick and easy.

my $workflow_factory = OpenXPKI::Workflow::Factory-&gt;instance&#40;&#41;;
local *Workflow::State::FACTORY = sub { return $workflow_factory }; 

before adding the config does the trick for us. At least for the
creation. Before actually using it, we need to do this &#40;without the
local, unfortunately&#41; for Workflow::State, Workflow::Action,
Workflow::Factory, Workflow and our custom observer.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; All I&#39;m attempting to do is to override methods like create_workflow&#40;&#41;
&gt; and fetch_workflow&#40;&#41; so that I can dynamically load workflows at runtime
&gt; rather than have to preload a large set of XML on startup.
</div>Why would you need to override them? Isn&#39;t having a workflow
factory that has already been initialized with the config enough?
This is how we deal with it at the OpenXPKI project.

Best regards,
  Alex
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;22&nbsp;03:51:58&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;22&nbsp;03:52:59&nbsp;2007</span>
    <span class="description">alech [...] cpan.org -  Cc ALECH added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;28&nbsp;05:57:12&nbsp;2012</span>
    <span class="description">jonasbn [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">In the release: 1.34_3 this particular issue is addressed in a new patch.

Checked up on the issue and got the following response from Martin Bartosch:

###
The comment Alex wrote on this ticket was referring to exactly the same problem which Oli has 
solved with his contribution. With this patch we were able to get rid of a very nasty code 
&#40;&#34;hacking the symbol table, again...&#34;&#41; fragment in the workflow API of OpenXPKI.

So from the perspective of OpenXPKI this issue can be closed as fixed now. Including this patch 
was immensely helpful for us - thanks a lot for accepting Olis submission!
###

We are closing the issue for now.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;28&nbsp;05:57:14&nbsp;2012</span>
    <span class="description">jonasbn [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;28&nbsp;05:57:25&nbsp;2012</span>
    <span class="description">jonasbn [...] cpan.org -  Fixed in 1.34_3 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
