<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #68526 for Class-Singleton: Singleton objects are not always destroyed properly</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #68526 for Class-Singleton: Singleton objects are not always destroyed properly</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Class-Singleton/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Class-Singleton/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Class-Singleton/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Class-Singleton/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Class-Singleton">Class-Singleton CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">68526</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Class-Singleton/Active/">Class-Singleton</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
shay [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-7286-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.4    </td>
  </tr>
  <tr id="CF-7287-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;28&nbsp;13:32:11&nbsp;2011</span>
    <span class="description">shay [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Singleton objects are not always destroyed properly</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The attached program is a greatly simplified version of a problem that
I&#39;ve been having in which Class::Singleton objects are not always
destroyed as I would expect.

The program creates the instance of the singleton class called One,
giving it an attribute called attr which is an instance of a simple
class called Attr, and then exits, at which point the singleton object
will be destroyed.

The problem is that although the DESTROY method of One does indeed get
called at the expected time &#40;just after the END subroutine of One has
been called&#41;, the object that it is destroying seems to have been
partially destroyed already: the attr attribute is now the undefined
value, rather than the Attr object. The output from the program shows this:

  RUNNING: attr =&gt; Attr=HASH&#40;0x1839a68&#41;
  OK
  EXITING
  ENDING: attr =&gt; Attr=HASH&#40;0x1839a68&#41;
  DESTROYING: attr =&gt; &lt;undef&gt;

showing that the Attr was still there when One&#39;s END subroutine was
entered, but is gone by the time One&#39;s DESTROY method is entered.

In my real software this is a problem because One&#39;s DESTROY method
actually needs to do something with Attr before setting it to the
undefined value itself.

The strange thing is that it seems rather unpredictable whether Attr
will be there or not. For example, if I change the line:

  $a = One-&gt;instance&#40;attr =&gt; Attr-&gt;new&#40;&#41;&#41;;

to:

  $a = One-&gt;instance&#40;&#41;;
  $a-&gt;{attr} = Attr-&gt;new&#40;&#41;;

then the output is now:

  RUNNING: attr =&gt; Attr=HASH&#40;0x1839af8&#41;
  OK
  EXITING
  ENDING: attr =&gt; Attr=HASH&#40;0x1839af8&#41;
  DESTROYING: attr =&gt; Attr=HASH&#40;0x1839af8&#41;

showing that the Attr is still there this time! I don&#39;t understand how
that change can have made any difference.

And if I now additionally override _new_instance&#40;&#41; in One with this
simple method which just delegates to the base class method:

  sub _new_instance {
      shift-&gt;SUPER::_new_instance&#40;@_&#41;;
  }

then the output is now:

  RUNNING: attr =&gt; Attr=HASH&#40;0x18464f8&#41;
  OK
  EXITING
  ENDING: attr =&gt; Attr=HASH&#40;0x18464f8&#41;
  DESTROYING: attr =&gt; &lt;undef&gt;

once again! Again, I don&#39;t understand how that change can have made that
difference.

Is this actually an issue with perl, rather than Class::Singleton?
Perhaps the order in which it cleans up different packages and the
variables in them is dependent to some extent on what&#39;s been loaded
where in memory, or maybe it&#39;s walking through a hash, whose key/value
pairs are returned in seemingly random orders which are affected by the
insertion of new subroutines into symbol tables etc?...

Either way, I find the result is that Class::Singleton objects are not
always ideal to work with, and if anything can be done to make the
destruction of these objects behave in a more predictable manner then
that would be a great help.

This problem may be related to the trouble reported on CPAN RT #23568. I
haven&#39;t yet checked whether using the patch from that bug report would
solve the problem, but it does seem like Class::Singleton taking
explicit steps to clean up objects derived from it, rather than leaving
everything to the perils of later &#34;automatic&#34; clean up, might be the answer.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use warnings;

package Attr;
sub new { bless {}, shift }

package One;
use parent qw&#40;Class::Singleton&#41;;
sub DESTROY {
    print &#34;DESTROYING: attr =&gt; &#34;, &#40;shift-&gt;{attr} // &#39;&lt;undef&gt;&#39;&#41;, &#34;\n&#34;;
}
sub END {
    if &#40;my $a = One-&gt;has_instance&#40;&#41;&#41; {
        print &#34;ENDING: attr =&gt; &#34;, &#40;$a-&gt;{attr} // &#39;&lt;undef&gt;&#39;&#41;, &#34;\n&#34;;
    }
    else {
        print &#34;ENDING: No instance\n&#34;;
    }
}

package main;
my $a;
{
    if &#40;eval {
        local $SIG{__DIE__};
        $a = One-&gt;instance&#40;attr =&gt; Attr-&gt;new&#40;&#41;&#41;;
        print &#34;RUNNING: attr =&gt; &#34;, &#40;$a-&gt;{attr} // &#39;&lt;undef&gt;&#39;&#41;, &#34;\n&#34;;
        1;
    }&#41; {
        print &#34;OK\n&#34;;
    }
    else {
        print &#34;ERROR: $@&#34;;
    }
}
print &#34;EXITING\n&#34;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;07&nbsp;04:09:09&nbsp;2014</span>
    <span class="description">shay [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve been testing this some more with different versions of perl &#40;5.16.1 and 5.21.0&#41; and it is still a problem. It surely boils down to the unpredictable order of destruction of objects during the global destruction phase when perl shuts down at the end of a program. With different versions of perl I get different results, but with both versions there is always some permutation of the changes to the original test program that I pointed out in my original bug report that doesn&#39;t work &#34;correctly&#34;.

I have also now tested with the patch from #23568 and that does indeed fix the problem by making the order of destruction more predictable. All permutations of the test script now work correctly with both versions of perl.

So please can you release a new version of Class-Singleton with this problem fixed?

&#40;If you aren&#39;t maintaining it any more then I will very gladly take it over and do the honours myself.&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;07&nbsp;07:57:44&nbsp;2014</span>
    <span class="description">abw [...] wardley.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #68526] Singleton objects are not always destroyed properly</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 07 Nov 2014 12:57:33 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Class-Singleton [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Andy Wardley &lt;abw [...] wardley.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 07/11/2014 09:09, Steve Hay via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#40;If you aren&#39;t maintaining it any more then I will very gladly take it over and do the honours myself.&#41;
</div>
Hi Steve,

Many thanks for your efforts.  Unfortunately I don&#39;t have the time to 
give it the proper attention it deserves, so I&#39;ll gladly take you up on 
your offer.  I&#39;ve added you as a co-maintainer of the module so you 
should be good to go.

All the best
Andy
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;07&nbsp;07:57:45&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;07&nbsp;16:51:58&nbsp;2014</span>
    <span class="description">shay [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Nov 07 07:57:44 2014, abw@wardley.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 07/11/2014 09:09, Steve Hay via RT wrote:
<div class="message-stanza open">&gt; &gt; &#40;If you aren&#39;t maintaining it any more then I will very gladly take
&gt; &gt; it over and do the honours myself.&#41;
</div>&gt; 
&gt; Hi Steve,
&gt; 
&gt; Many thanks for your efforts.  Unfortunately I don&#39;t have the time to
&gt; give it the proper attention it deserves, so I&#39;ll gladly take you up
&gt; on
&gt; your offer.  I&#39;ve added you as a co-maintainer of the module so you
&gt; should be good to go.
&gt; 
&gt; All the best
&gt; Andy
</div>
Thanks, Andy. I&#39;ve just uploaded version 1.5 which has this problem fixed now :-&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;07&nbsp;16:51:58&nbsp;2014</span>
    <span class="description">shay [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
