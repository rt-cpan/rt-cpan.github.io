<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #29909 for Geo-Gpx: Garmin POILoader rejects Geo::Gpx files as invalid. Hack-fix attached.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #29909 for Geo-Gpx: Garmin POILoader rejects Geo::Gpx files as invalid. Hack-fix attached.</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Geo-Gpx/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Geo-Gpx/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Geo-Gpx/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Geo-Gpx/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Geo-Gpx">Geo-Gpx CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">29909</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">30 min

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Geo-Gpx/Active/">Geo-Gpx</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">andy [...] hexten.net
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
gyles19 [...] visi.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-41638-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.15</li>
<li>
0.18</li>
</ul>
    </td>
  </tr>
  <tr id="CF-41639-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;10&nbsp;18:48:03&nbsp;2007</span>
    <span class="description">gyles19 [...] visi.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Garmin POILoader rejects Geo::Gpx files as invalid. Hack-fix
 attached.</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve found that while EasyGPX can read Geo::Gpx&#39;s xml okay, Garmin&#39;s 
POILoader rejects it as invalid.  I tried running several online XML 
Validators against both Geo::Gpx&#39;x xml, and EasyGPX&#39;s xml, and they are 
both invalid against the GPX 1.1 and 1.0 DTDs.  I didn&#39;t investigate how 
EasyGPX&#39;s files are invalid since POILoader accepts them, so I concentrated 
on Geo::Gpx.

I have found that the basic problem is that Geo::Gpx is not following the 
xml sequence specified in the GPX specification.  I subclassed Geo::Gpx and 
overrode the xml method with a decorator that re-parses the output string 
and re-orders the &lt;wpt&gt; elements into the correct order.  POILoader accepts 
this file and the custom POIs now show up fine in my StreetPilot c330.

Here&#39;s the validator I used, and the GPX schema I found success with:

<span class="clickylink"><a target="new" rel="nofollow" href="http://tools.decisionsoft.com/schemaValidate/">http://tools.decisionsoft.com/schemaValidate/</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.topografix.com/GPX/1/1/gpx.xsd">http://www.topografix.com/GPX/1/1/gpx.xsd</a></span>

The basic problem within Geo::Gpx is that it&#39;s using a &#39;sort keys...&#39; 
ordering for processing the waypoint elements in the generic token handler.  
It should probably have at least a specific handler for the wpt type to 
preserve the order in the specification.  I suspect the route and track 
specifications are also ordered, but I didn&#39;t look at them.

Here&#39;s the guts of the change in my hack:

 my @correct_order = &#40;
             &#39;ele&#39;,&#39;time&#39;,&#39;magvar&#39;,&#39;geoidheight&#39;, &#39;name&#39;,
             &#39;cmt&#39;,&#39;desc&#39;,&#39;src&#39;,&#39;link&#39;,&#39;sym&#39;,
             &#39;type&#39;,&#39;fix&#39;,&#39;sat&#39;,&#39;hdop&#39;,&#39;vdio&#39;,
             &#39;pdop&#39;,&#39;ageofdgpsdata&#39;,&#39;dgpsid&#39;,&#39;extensions&#39;&#41;;

 $result .= 
    sprintf &#34;&lt;wpt lat=\&#34;%s\&#34; lon=\&#34;%s\&#34;&gt;\n&#34;, $attr-&gt;{lat},$attr-&gt;{lon};
 
 foreach my $key &#40;@correct_order&#41; {
   $result .= &#34;&lt;$key&gt;&#34; . &#38;Geo::Gpx::_enc&#40; $wpt-&gt;{$key}&#41; . 
              &#34;&lt;/$key&gt;\n&#34; if defined $wpt-&gt;{$key};
 }
 $result .= &#34;&lt;/wpt&gt;\n&#34;;


Since the StreetPilot c330 doesn&#39;t support either routes or tracks, the hack 
I have isn&#39;t suitable for public consumption.  In fact, it&#39;s an ugly thing I 
threw together to see if the ordering was the only problem POILoader had 
with the xml... but it works for me for files which contain only waypoints.  
The proper fix is to provide a better handler for the wpt elements.

I&#39;ve attached my subclass hack for your amusement.  I&#39;ve also attached a 
sample gpx file generated with it and which POILoader processes successfully.

I would suggest that Geo::Gpx would be much more valuable if the xml it 
produces is compatible with POILoader and other xml-based tools without 
having to be reparsed and rewritten by other applications like EasyGPS 
first, which is a manual process on windows.

I&#39;m presently running perl 5.8.8 on an old Red Hat 7.3 linux laptop.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> GUITruckstops.gpx</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Gpx.pm</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">$Trucker::Gpx::VERSION = sprintf &#34;%d.%03d&#34;, q$Revision: 1.1 $ =~ /&#40;\d+&#41;/g;

package Trucker::Gpx;

use base Geo::Gpx;

use HTML::Entities qw&#40;encode_entities encode_entities_numeric&#41;;
use XML::Descent;

sub xml {
  my $self = shift;
  my $xml = $self-&gt;SUPER::xml&#40;@_&#41;;
  my &#40;$header&#41; = &#40;$xml =~ /^&#40;.+?&#41;&lt;metadata&gt;/s&#41;;

  my $result = &#34;&#34;;
  $result .= $header;

  my $p = XML::Descent-&gt;new&#40;{
          Input   =&gt; \$xml, 
          Namespaces =&gt; 0
      }&#41;;


  $p-&gt;on&#40;&#39;gpx&#39; =&gt;   # gpx handler
    sub {
      my &#40;$elem, $attr, $ctx&#41; = @_;

      $p-&gt;on&#40;&#39;*&#39; =&gt; # everything else handler
         sub {
          my &#40;$elem, $attr, $ctx&#41; = @_;
          $result .= &#34;&lt;$elem&gt;&#34; . $p-&gt;xml . &#34;&lt;/$elem&gt;\n&#34;;
         }
      &#41;;

      $p-&gt;on&#40;&#39;wpt&#39; =&gt;   # waypoint handler within gpx handler
        sub {
          my &#40;$elem, $attr, $ctx&#41; = @_;
          my $wpt = {};
          $p-&gt;context&#40;$wpt&#41;; 
          $p-&gt;on&#40; &#39;*&#39; =&gt; 
            sub {
              my &#40;$elem, $attr, $ctx&#41; = @_;
              my $text = $p-&gt;text;
              $ctx-&gt;{$elem}=$text;
              $ctx-&gt;{attribs} = $attr;
            }
          &#41;;
          $p-&gt;walk;
          my @correct_order = &#40;
             &#39;ele&#39;,&#39;time&#39;,&#39;magvar&#39;,&#39;geoidheight&#39;, &#39;name&#39;,
             &#39;cmt&#39;,&#39;desc&#39;,&#39;src&#39;,&#39;link&#39;,&#39;sym&#39;,
             &#39;type&#39;,&#39;fix&#39;,&#39;sat&#39;,&#39;hdop&#39;,&#39;vdio&#39;,
             &#39;pdop&#39;,&#39;ageofdgpsdata&#39;,&#39;dgpsid&#39;,&#39;extensions&#39;&#41;;

          $result .= sprintf &#34;&lt;wpt lat=\&#34;%s\&#34; lon=\&#34;%s\&#34;&gt;\n&#34;, $attr-&gt;{lat},$attr-&gt;{lon};
          foreach my $key &#40;@correct_order&#41; {
             $result .= &#34;&lt;$key&gt;&#34; . &#38;Geo::Gpx::_enc&#40; $wpt-&gt;{$key}&#41; . &#34;&lt;/$key&gt;\n&#34; if defined $wpt-&gt;{$key};
          }
          $result .= &#34;&lt;/wpt&gt;\n&#34;;
        }
      &#41;;   # end of waypoint handler

      $p-&gt;walk;
    }
  &#41;;
  $p-&gt;walk;
  $result .= &#34;&lt;/gpx&gt;\n&#34;;
  return $result;
}

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;11&nbsp;05:47:39&nbsp;2007</span>
    <span class="description">andy [...] hexten.net -  Correspondence added</span>
    <span class="time-taken">30 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks! I&#39;ve just released 0.19 which should fix the problem :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;11&nbsp;05:47:45&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;11&nbsp;05:48:05&nbsp;2007</span>
    <span class="description">andy [...] hexten.net -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;11&nbsp;05:48:18&nbsp;2007</span>
    <span class="description">andy [...] hexten.net -  Given to ANDYA</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
