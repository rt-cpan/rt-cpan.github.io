<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #20118 for SOAP-Lite: memory ineficiencies on http transport</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #20118 for SOAP-Lite: memory ineficiencies on http transport</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/SOAP-Lite/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/SOAP-Lite/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/SOAP-Lite/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/SOAP-Lite/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/SOAP-Lite">SOAP-Lite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">20118</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/SOAP-Lite/Active/">SOAP-Lite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
carlo.caputo [...] corp.globo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-29122-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.67    </td>
  </tr>
  <tr id="CF-29123-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;26&nbsp;15:15:51&nbsp;2006</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> memory ineficiencies on http transport</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Large XML responses soon get 10 fold larger being passed by value
through the various layers from transport to deserialization. Here is a
summary of the increase in memory use and it&#39;s positions in the module
code, commented by the virtual memory usage of the perl process, with a
xml soap response 27,285,916 bytes long.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">------------- begin of debug session -------------
# 16Mb perl
SOAP::Transport::HTTP::Client::send_receive&#40;/usr/lib/perl5/site_perl/5.8.8/SOAP/Transport/HTTP.pm:199&#41;:
199:   $self-&gt;http_response&#40;$self-&gt;SUPER::request&#40;$self-&gt;http_request&#41;&#41;;
# 44Mb perl
200:   SOAP::Trace::transport&#40;$self-&gt;http_response&#41;;
# 44Mb perl
201:   SOAP::Trace::debug&#40;$self-&gt;http_response-&gt;as_string&#41;;
# 139Mb perl
233:   ? die &#34;Can&#39;t understand returned Content-Encoding
&#40;@{[$self-&gt;http_response-&gt;content_encoding]}&#41;\n&#34;
234:    : $self-&gt;http_response-&gt;content;
# 188Mb perl
235:  $self-&gt;http_response-&gt;content_type =~ m!^multipart/!i ?
236:   join&#40;&#34;\n&#34;, $self-&gt;http_response-&gt;headers_as_string, $content&#41; 
237:    : $content;
# 212Mb perl
SOAP::Lite::call&#40;/usr/lib/perl5/site_perl/5.8.8/SOAP/Lite.pm:3382&#41;:
3382:  return $response if $self-&gt;outputxml;
# 236Mb perl
------------- end of debug session -------------

When the SOAP starts deserializing it the usage progressively becomes
more than 450Mb, the system trashes to a slow death and never ends
processing.

My workaround was to make a SAX-style user-agent, using the exported
SOAP::Transport::HTTP::Client::USERAGENT_CLASS &#40;possible thanks to the
fact that it is only evaluated on the SOAP::Transport::HTTP::Client::new&#40;&#41;&#41;

------------- begin of UASAX.pm -------------
package UASAX;
use strict;
use warnings;
use XML::Parser;
use SOAP::Transport::HTTP;
use vars qw&#40;@ISA&#41;;
eval&#40;&#34;require $SOAP::Transport::HTTP::Client::USERAGENT_CLASS&#34;&#41; 
        or die &#34;Could not load UserAgent: $@&#34;; 
push @ISA, $SOAP::Transport::HTTP::Client::USERAGENT_CLASS;
$SOAP::Transport::HTTP::Client::USERAGENT_CLASS = __PACKAGE__;

# example settings 
our $CAPTURE = &#39;^&#40;?:element1|element2|element3&#41;$&#39;;
our $EXPAND = &#39;^&#40;?:subelement1|subelement2&#41;$&#39;;

sub request
{
        my &#40;$self, $request, $arg, @other&#41; = @_;

        my $base_parser = new XML::Parser&#40; NoExpand =&gt; 1, Handlers =&gt; {
                Init =&gt; sub {
                        my $self = shift; 
#                       print &#34;xml parsing started\n&#34;; 
                        $self-&gt;{response} = [];
                },
                Final =&gt; sub {
#                       print &#34;xml parsing ended\n&#34;; 
                },
                Start =&gt; sub {
                        my $self = shift; 
                        $self-&gt;{element} = shift; 
                        my %attr = @_;
#                       printf &#34;id %d\n&#34;,
                                 $self-&gt;{id} = substr $attr{id}, 2 
                                        if $self-&gt;{element} eq &#39;multiRef&#39;;
                       
$self-&gt;{response}-&gt;[$self-&gt;{id}]-&gt;{$self-&gt;{element}} = 
                                $self-&gt;{response}-&gt;[substr $attr{href},
3] ||= {} 
                                        if $EXPAND and $self-&gt;{element}
=~ /$EXPAND/;
                },
                Char  =&gt; sub {
                        my $self = shift; 
                       
$self-&gt;{response}-&gt;[$self-&gt;{id}]-&gt;{$self-&gt;{element}} = shift 
                                if $CAPTURE and $self-&gt;{element} =~
/$CAPTURE/;
                },
                End =&gt; sub { 
                        my $self = shift;
                        undef $self-&gt;{element};
                },
        } &#41;;
        $request-&gt;{parser} = $base_parser-&gt;parse_start&#40;&#41;;

        my $response = $self-&gt;SUPER::request&#40;$request, sub {
                my &#40;$chunk, $response, $protocol&#41; = @_;
#               print length&#40;$chunk&#41;, &#34;\n&#34;;
                $response-&gt;request-&gt;{parser}-&gt;parse_more&#40;$chunk&#41;;
#               $response-&gt;{total} += length $chunk;
#               open O, &#34;&gt;&gt; data.xml&#34; and print O $chunk;
        }, @other&#41;;
        $request-&gt;{parser}-&gt;parse_done&#40;&#41;;

        $response-&gt;content&#40; $request-&gt;{parser}-&gt;{response} &#41;;
        $response
}

1;
------------- end of UASAX.pm -------------

and the call to the service keeps the same for me, with two small
changes, commented below:

<div class="message-stanza open">------------- begin of the SOAP call changes -------------
use UASAX; ### replace LWP::UserAgent on SOAP::Transport::HTTP

my $response = eval { 
    my $service = SOAP::Lite
      -&gt;uri &#40;&#34;urn:MyService&#34;&#41;
      -&gt;proxy &#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://myserver.com/MyObject">http://myserver.com/MyObject</a></span>&#34;&#41;;
    $service-&gt;outputxml &#40;1&#41;; ### avoid reprocessing response
    $service-&gt;mycall&#40;&#41;
};  

<div class="message-stanza open">------------- end of the SOAP call changes -------------

I don&#39;t know how my solution could help you, on the general problem, but
I hope to have cast a light on the strong inefficiency of the UserAgent
memory usage; the worst thing is that most of this memory is not freed
after the communication, even after undefining the soap service and
response references, possibly for the use of global variables or, who
knows, cyclic-references.
</div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;22&nbsp;05:55:57&nbsp;2008</span>
    <span class="description">kutterma [...] users.sourceforge.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Carlo,

the memory leaks should be fixed as of 0.71.04.

Thanks for the example of a SAX-Style UA - maybe I include something
like this in a future release.

Martin
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;22&nbsp;05:56:00&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;22&nbsp;05:56:03&nbsp;2008</span>
    <span class="description">kutterma [...] users.sourceforge.net -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
