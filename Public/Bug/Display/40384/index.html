<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #40384 for DateTime-Format-DateParse: Default time zone overriding explicit time zone &#40;includes solution&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #40384 for DateTime-Format-DateParse: Default time zone overriding explicit time zone &#40;includes solution&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DateTime-Format-DateParse/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DateTime-Format-DateParse/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DateTime-Format-DateParse/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DateTime-Format-DateParse/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DateTime-Format-DateParse">DateTime-Format-DateParse CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">40384</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DateTime-Format-DateParse/Active/">DateTime-Format-DateParse</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
MIKO [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-9856-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.04    </td>
  </tr>
  <tr id="CF-9857-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;25&nbsp;20:34:16&nbsp;2008</span>
    <span class="description">MIKO [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Default time zone overriding explicit time zone &#40;includes solution&#41;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The bug involves the situation in which the first argument for
parse_datetime includes an explicit time zone, and the second argument
is a default timezone.

Consider the following code.  A $zone argument is sent but the date
string already has an explicit timezone.

$date = &#39;2008-01-04T00:00:00-0800&#39;;
$zone = &#39;-0500&#39;;
$dt = DateTime::Format::DateParse-&gt;parse_datetime&#40;$date, $zone&#41;;

In situations like that, Date::Parse returns the zone that was set in
the date/time string, not the default zone.  Currently
DateTime::Format::DateParse returns the default zone.

I&#39;ve attached a test script that demonstrates the situation.  I&#39;ve also
attached a modified DateParse.pm that fixes the problem.  Look for the
string &#34;# FIX&#34; in the code.  The fix is to simply check if $offset is
defined.  If it is, the script uses
DateTime::TimeZone-&gt;offset_as_string&#40;$offset&#41; to produce an offset
string compatible with DateTime-&gt;new.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> DateParse.pm</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">package DateTime::Format::DateParse;

# Copyright &#40;C&#41; 2005-6  Joshua Hoblitt
#
# $Id: DateParse.pm 3517 2006-09-17 23:10:10Z jhoblitt $

use strict;

use vars qw&#40;$VERSION&#41;;
$VERSION = &#39;0.04&#39;;

use DateTime;
use DateTime::TimeZone;
use Date::Parse qw&#40; strptime &#41;;
use Time::Zone qw&#40; tz_offset &#41;;

sub parse_datetime {
    my &#40;$class, $date, $zone&#41; = @_;

    # str2time&#40;&#41; calls strptime&#40;&#41; internally so it&#39;s more efficent to use
    # strptime&#40;&#41; directly.  However, the extra validation done by using
    # DateTime-&gt;new&#40;&#41; instad of DateTime-&gt;from_epoch&#40;&#41; may make it into a net
    # loss.  In the end, it turns out that strptime&#40;&#41;&#39;s offset information is
    # needed anyways.
    my @t = strptime&#40; $date, $zone &#41;;

    return undef unless @t;

    my &#40;$ss, $mm, $hh, $day, $month, $year, $offset&#41; = @t;

    my %p;
    if &#40; $ss &#41; {
        my $fraction = $ss - int&#40; $ss &#41;;
        $p{ nanosecond } = $fraction * 1e9 if $fraction;
        $p{ second } = int $ss;
    }
    $p{ minute }    = $mm if $mm;
    $p{ hour }      = $hh if $hh;
    $p{ day }       = $day if $day;
    $p{ month }     = $month + 1 if $month;
    $p{ year }      = $year ? $year + 1900 : DateTime-&gt;now-&gt;year;

    # unless there is an explict ZONE, Date::Parse seems to parse date only
    # formats, eg. &#34;1995-01-24&#34;, as being in the &#39;local&#39; timezone.
    unless &#40; defined $zone || defined $offset &#41; {
        return DateTime-&gt;new&#40;
            %p,
            time_zone   =&gt; &#39;local&#39;,
        &#41;;
    }
    
    # FIX
    if &#40; defined $offset &#41; {
        return DateTime-&gt;new&#40;
            %p,
            time_zone =&gt; DateTime::TimeZone-&gt;offset_as_string&#40;$offset&#41;,
        &#41;;
    }
    
    if &#40; $zone &#41; {
        if &#40; DateTime::TimeZone-&gt;is_valid_name&#40; $zone &#41; &#41; {
            return DateTime-&gt;new&#40;
                %p,
                time_zone   =&gt; $zone,
            &#41;;
        } else {
            # attempt to convert Time::Zone tz&#39;s into an offset
            return DateTime-&gt;new&#40;
                %p,
                time_zone   =&gt;
                    # not an Olson timezone, no DST info
                    DateTime::TimeZone::offset_as_string&#40; tz_offset&#40; $zone &#41; &#41;,
            &#41;;
        }
    }

    return DateTime-&gt;new&#40;
        %p,
        time_zone   =&gt; 
            # not an Olson timezone, no DST info
            DateTime::TimeZone::offset_as_string&#40; $offset &#41;,
    &#41;;
}

1;

__END__
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> default-timezone.4posting.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w
use strict;
use DateTime::Format::DateParse;

# variables
my &#40;$dt, $date_str, $default_tz&#41;;

$date_str = &#39;2008-01-04T00:00:00-0800&#39;;
$default_tz = &#39;-0500&#39;;
$dt = DateTime::Format::DateParse-&gt;parse_datetime&#40;$date_str, $default_tz&#41;;

# SHOULD return -0800, actually returns -0500
print &#39;parsed tz: &#39;, $dt-&gt;strftime&#40;&#39;%z&#39;&#41;,  &#34;\n&#34;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;12&nbsp;20:23:17&nbsp;2012</span>
    <span class="description">jhoblitt [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
