<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #37297 for Text-Markdown: coredumps on various inputs in Perl 5.8.5</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #37297 for Text-Markdown: coredumps on various inputs in Perl 5.8.5</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Text-Markdown/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Text-Markdown/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Text-Markdown/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Text-Markdown/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="http://github.com/bobtfish/text-markdown/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Text-Markdown">Text-Markdown CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">37297</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Text-Markdown/Active/">Text-Markdown</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">bobtfish [...] bobtfish.net
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jflack [...] math.purdue.edu

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-32118-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
1.0.16</li>
<li>
1.0.17</li>
<li>
1.0.18</li>
<li>
1.0.19</li>
</ul>
    </td>
  </tr>
  <tr id="CF-32119-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.0.20    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;01&nbsp;11:04:37&nbsp;2008</span>
    <span class="description">jflack [...] math.purdue.edu -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> coredumps on various inputs in Perl 5.8.5</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 01 Jul 2008 11:03:43 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Text-Markdown [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> J Chapman Flack &lt;jflack [...] math.purdue.edu&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
This is not a duplicate of 36203, but 36203 could turn out to be a
special case of this.

I have an installation of IkiWiki, which you can think of as a wrapper
that runs Markdown on a whole bunch of files in sequence within a single
Perl instance. It has been rock solid with an older version of
Text::Markdown for over a year. I upgraded to IkiWiki 2.50 last week
&#40;without changing the Text::Markdown version&#41; - still rock solid.
Yesterday, I upgraded to Text::Markdown 1.0.19 to make the MultiMarkdown
features available. &#40;Currently, nothing in my wiki /uses/ any
MultiMarkdown features, and the multimarkdown option is off in
ikiwiki.setup, so the only change is upgrading the module to 1.0.19 and
using it on a bunch of existing Markdown files that caused no problems
before.&#41;

Now I get coredumps when rebuilding the wiki. I first noticed that the
coredump always occurred on the same wiki page, so I looked for
something in the content of that page, but nothing I changed made a
difference. I then added a shuffle&#40;&#41; in IkiWiki::Render just to shake up
the order of rendering pages, and now it doesn&#39;t dump on the same page
every time, but it alwsys dumps on some page a ways into the list. So
I don&#39;t think any specific page content has anything to do with it. It
acts like some small cumulative data structure damage might be happening
with every page rendered until the process finally falls on its face.

When I upgraded to Text::Markdown 1.0.19 I noticed that List::MoreUtils
got installed as a new prerequisite, and includes native code - a prime
suspect when coredumps are involved. But according to the
List::MoreUtils docs, you can set LIST_MOREUTILS_PP in the environment
to have it use pure Perl implementations instead, and that doesn&#39;t
change my results, so the trouble seems to be elsewhere &#40;or the
environment variable doesn&#39;t really do what the docs say, which I
haven&#39;t tried very hard to check&#41;.

Before I added the shuffle&#40;&#41;, the symptom was always the same
Segmentation fault on the same file. After the shuffle, not only
does the failure occur on different files, but it can be a segfault,
a bus error, or even panic messages from Perl &#40;nice because they&#39;ll
give a location in the Perl source&#41;.  Here&#39;s a sample:

Attempt to free unreferenced scalar: SV 0xa98f18 at
.../lib/site_perl/5.8.5/Text/Markdown.pm line 997.

panic: regfree data code &#39;&#39; at
.../lib/site_perl/5.8.5/Text/Markdown.pm line 997.

Bus Error&#40;coredump&#41;
&#40;gdb&#41; info stack
#0  0x0008d370 in Perl_pp_entersub &#40;&#41;
#1  0x000843a8 in Perl_runops_standard &#40;&#41;
#2  0x00028ed0 in S_call_body &#40;&#41;
#3  0x00028bc8 in Perl_call_sv &#40;&#41;
#4  0x0002cbf8 in S_call_list_body &#40;&#41;
#5  0x0002c7e4 in Perl_call_list &#40;&#41;
#6  0x00058f58 in Perl_newATTRSUB &#40;&#41;
#7  0x00055724 in Perl_utilize &#40;&#41;
#8  0x0004d544 in Perl_yyparse &#40;&#41;
#9  0x000bb2d0 in S_doeval &#40;&#41;
#10 0x000bd1f0 in Perl_pp_entereval &#40;&#41;
#11 0x000843a8 in Perl_runops_standard &#40;&#41;
#12 0x000283d8 in S_run_body &#40;&#41;
#13 0x00027fe0 in perl_run &#40;&#41;
#14 0x00024c08 in main &#40;&#41;

Segmentation Fault&#40;coredump&#41;
&#40;gdb&#41; info stack
#0  0x0006d0a4 in Perl_pregfree &#40;&#41;
#1  0x000b2a18 in Perl_pp_regcomp &#40;&#41;
#2  0x000843a8 in Perl_runops_standard &#40;&#41;
#3  0x00028ed0 in S_call_body &#40;&#41;
#4  0x00028bc8 in Perl_call_sv &#40;&#41;
#5  0x0002cbf8 in S_call_list_body &#40;&#41;
#6  0x0002c7e4 in Perl_call_list &#40;&#41;
#7  0x00058f58 in Perl_newATTRSUB &#40;&#41;
#8  0x00055724 in Perl_utilize &#40;&#41;
#9  0x0004d544 in Perl_yyparse &#40;&#41;
#10 0x000bb2d0 in S_doeval &#40;&#41;
#11 0x000bd1f0 in Perl_pp_entereval &#40;&#41;
#12 0x000843a8 in Perl_runops_standard &#40;&#41;
#13 0x000283d8 in S_run_body &#40;&#41;
#14 0x00027fe0 in perl_run &#40;&#41;
#15 0x00024c08 in main &#40;&#41;

I haven&#39;t found any workaround so it looks like I&#39;ll have to downgrade
to get operational again.

Chapman Flack
Dept. of Mathematics
Purdue University
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;01&nbsp;11:53:13&nbsp;2008</span>
    <span class="description">bobtfish [...] bobtfish.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #37297] coredumps on various inputs in Perl 5.8.5 </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 1 Jul 2008 16:52:40 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Text-Markdown [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tomas Doran &lt;bobtfish [...] bobtfish.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On 1 Jul 2008, at 16:04, Chapman Flack via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; I haven&#39;t found any workaround so it looks like I&#39;ll have to downgrade
&gt; to get operational again.
&gt;
</div>
Thanks for the detailed bug report.

I&#39;d guess that the coredumps are due to the regex engine &#40;as that  
seems to be where most of the other problems lie&#41;, and have a feeling  
that perl 5.10 would fix your issues as the regex engine has become  
renterant.

If there is any possibility that you can try with perl 5.10 and see  
if the issue has gone away for you?

Also, would you be prepared to try some of the older releases:
<span class="clickylink"><a target="new" rel="nofollow" href="http://svn.kulp.ch/cpan/text_multimarkdown/tags/">http://svn.kulp.ch/cpan/text_multimarkdown/tags/</a></span>

I&#39;d specifically be interested in:

1.0.5 &#40;very close to original MultiMarkdown - may point if the issue  
is in Markdown itself, or MultiMarkdown&#41;

1.0.5 vs 1.0.6 &#40;merge of Markdown 1.28b&#41;

1.0.16 vs 1.0.17 &#40;refactor _DeTab regexes&#41;

Cheers
Tom
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;01&nbsp;11:53:14&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;01&nbsp;14:04:50&nbsp;2008</span>
    <span class="description">jflack [...] math.purdue.edu -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #37297] coredumps on various inputs in Perl 5.8.5</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 01 Jul 2008 12:56:57 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Text-Markdown [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> J Chapman Flack &lt;jflack [...] math.purdue.edu&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Tomas Doran via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If there is any possibility that you can try with perl 5.10 and see  
&gt; if the issue has gone away for you?
&gt; 
&gt; Also, would you be prepared to try some of the older releases:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://svn.kulp.ch/cpan/text_multimarkdown/tags/">http://svn.kulp.ch/cpan/text_multimarkdown/tags/</a></span>
</div>
Hi,

I hope you&#39;ll forgive my trying to be as helpful as possible within
time constraints. :&#41;  On the box where I&#39;m testing, our web guy has
a carefully tweaked Perl build that only gets changed with great
ceremony, and I don&#39;t have a handy 5.10 to replicate the setup in.

I did try a very simple hack to Markdown.pm that actually gets my
wiki rebuild to complete successfully. I fear it works only by
reducing the probability of failure, not by correcting the issue,
but I just did 5 complete rebuilds in a row, so the probability
might be low enough to limp on for the time being.

I simply duplicated the subroutine _ProcessListItems into two
identical copies named _ProcessListItemsUL and _ProcessListItemsOL
and added the o &#40;compile once only&#41; option to the s{}{} in each one.
Then I changed _DoLists so that the two call sites of _ProcessListItems
passing $marker_ul actually call _ProcessListItemsUL and likewise for
the two sites that pass $marker_ol.

This way, the regex engine is still being used reentrantly &#40;which is
still like driving the wrong way down the freeway on purpose, when
it was in the pre-5.10 docs not to do that, and 5.10 is still new enough
that a lot of people, especially on commercial OSes or in production
environments, aren&#39;t going to have it right away&#41;, but at least it&#39;s
not reentrantly compiling and freeing regex objects on every call
&#40;so it&#39;s like driving the wrong way on the freeway in a Volvo&#41;. That
seems to lower the risk a bit.

The Right Thing To Do is probably to rework the reentrant uses of the
regex engine so they aren&#39;t. For example, _ProcessListItems can use the
regex to parse out a list of items, and then in a separate step iterate
over the list and recursively process the items. That should be a
perfectly safe way to do it in 5.8 and in 5.10.  If the reentrant
version proves to be a lot faster in 5.10, maybe it can be used
conditionally when running on 5.10.

Regards,
Chapman Flack
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;03&nbsp;20:05:26&nbsp;2008</span>
    <span class="description">bobtfish [...] bobtfish.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #37297] coredumps on various inputs in Perl 5.8.5</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 3 Jul 2008 16:40:42 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Text-Markdown [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tomas Doran &lt;bobtfish [...] bobtfish.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On 1 Jul 2008, at 19:04, Chapman Flack via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I hope you&#39;ll forgive my trying to be as helpful as possible within
&gt; time constraints. :&#41;
</div>
Of course - this is the real world after all, and it&#39;s awesome to  
hear from people who are using my code in production. ;&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On the box where I&#39;m testing, our web guy has
&gt; a carefully tweaked Perl build that only gets changed with great
&gt; ceremony, and I don&#39;t have a handy 5.10 to replicate the setup in.
&gt;
</div>
That&#39;s totally fair


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I did try a very simple hack to Markdown.pm that actually gets my
&gt; wiki rebuild to complete successfully. I fear it works only by
&gt; reducing the probability of failure, not by correcting the issue,
&gt; but I just did 5 complete rebuilds in a row, so the probability
&gt; might be low enough to limp on for the time being.
&gt;
&gt; I simply duplicated the subroutine _ProcessListItems into two
&gt; identical copies named _ProcessListItemsUL and _ProcessListItemsOL
&gt; and added the o &#40;compile once only&#41; option to the s{}{} in each one.
&gt; Then I changed _DoLists so that the two call sites of  
&gt; _ProcessListItems
&gt; passing $marker_ul actually call _ProcessListItemsUL and likewise for
&gt; the two sites that pass $marker_ol.
</div>
Can you send me the code for this, even if it&#39;s not &#39;the correct  
solution&#39;, as &#40;given it still passes the test suite&#41;, I&#39;ll push out a  
point release to fix this issue for anyone else who&#39;s seeing it..

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; This way, the regex engine is still being used reentrantly &#40;which is
&gt; still like driving the wrong way down the freeway on purpose, when
&gt; it was in the pre-5.10 docs not to do that, and 5.10 is still new  
&gt; enough
&gt; that a lot of people, especially on commercial OSes or in production
&gt; environments, aren&#39;t going to have it right away&#41;, but at least it&#39;s
&gt; not reentrantly compiling and freeing regex objects on every call
&gt; &#40;so it&#39;s like driving the wrong way on the freeway in a Volvo&#41;. That
&gt; seems to lower the risk a bit.
&gt;
&gt; The Right Thing To Do is probably to rework the reentrant uses of the
&gt; regex engine so they aren&#39;t. For example, _ProcessListItems can use  
&gt; the
&gt; regex to parse out a list of items, and then in a separate step  
&gt; iterate
&gt; over the list and recursively process the items. That should be a
&gt; perfectly safe way to do it in 5.8 and in 5.10.  If the reentrant
&gt; version proves to be a lot faster in 5.10, maybe it can be used
&gt; conditionally when running on 5.10.
&gt;
</div>
I agree that this is a more correct approach to getting round the  
problem, and I&#39;d like to fix this, but unfortunately Markdown is a  
spare time, not a paid time activity, and so I don&#39;t have as much  
time to hack on it as I&#39;d like..

Cheers
Tom
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;07&nbsp;09:55:49&nbsp;2008</span>
    <span class="description">jflack [...] math.purdue.edu -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #37297] coredumps on various inputs in Perl 5.8.5</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 07 Jul 2008 09:55:13 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Text-Markdown [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> J Chapman Flack &lt;jflack [...] math.purdue.edu&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Tomas Doran via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Can you send me the code for this, even if it&#39;s not &#39;the correct  
&gt; solution&#39;, as &#40;given it still passes the test suite&#41;, I&#39;ll push out a  
&gt; point release to fix this issue for anyone else who&#39;s seeing it..
</div>
Sure, I&#39;ll phrase it in the form of a patch against 1.0.19. :&#41;

One caution: it might not fix the issue for anyone else who&#39;s seeing
it: it&#39;s not just &#39;not the correct solution&#39;, it&#39;s really not a solution
at all. The regex engine is still used re-entrantly, only not as
heavily, so the probability of failure is lower. It&#39;s low enough that
my own application manages to complete now without failing, but anybody
else&#39;s mileage may still vary.

Regards,
-Chap
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Markdown.pm_1.0.19	Tue Apr 22 13:39:11 2008
+++ Markdown.pm	Mon Jul  7 09:38:17 2008
@@ -930,8 +930,8 @@
                 # paragraph for the last item in a list, if necessary:
                 $list =~ s/\n{2,}/\n\n\n/g;
                 my $result = &#40; $list_type eq &#39;ul&#39; &#41; ?
-                    $self-&gt;_ProcessListItems&#40;$list, $marker_ul&#41;
-                  : $self-&gt;_ProcessListItems&#40;$list, $marker_ol&#41;;
+                    $self-&gt;_ProcessListItemsUL&#40;$list, $marker_ul&#41;
+                  : $self-&gt;_ProcessListItemsOL&#40;$list, $marker_ol&#41;;
                 $result = &#34;&lt;$list_type&gt;\n&#34; . $result . &#34;&lt;/$list_type&gt;\n&#34;;
                 $result;
             }egmx;
@@ -947,8 +947,8 @@
                 # paragraph for the last item in a list, if necessary:
                 $list =~ s/\n{2,}/\n\n\n/g;
                 my $result = &#40; $list_type eq &#39;ul&#39; &#41; ?
-                    $self-&gt;_ProcessListItems&#40;$list, $marker_ul&#41;
-                  : $self-&gt;_ProcessListItems&#40;$list, $marker_ol&#41;;
+                    $self-&gt;_ProcessListItemsUL&#40;$list, $marker_ul&#41;
+                  : $self-&gt;_ProcessListItemsOL&#40;$list, $marker_ol&#41;;
                 $result = &#34;&lt;$list_type&gt;\n&#34; . $result . &#34;&lt;/$list_type&gt;\n&#34;;
                 $result;
             }egmx;
@@ -958,9 +958,9 @@
     return $text;
 }
 
-sub _ProcessListItems {
+sub _ProcessListItemsOL {
 #
-#   Process the contents of a single ordered or unordered list, splitting it
+#   Process the contents of a single ordered list, splitting it
 #   into individual list items.
 #
 
@@ -1017,9 +1017,74 @@
         }
 
         &#34;&lt;li&gt;&#34; . $item . &#34;&lt;/li&gt;\n&#34;;
-    }egmx;
+    }egmxo;
 
     $self-&gt;{_list_level}--;
+    return $list_str;
+}
+
+sub _ProcessListItemsUL {
+#
+#   Process the contents of a single unordered list, splitting it
+#   into individual list items.
+#
+
+    my &#40;$self, $list_str, $marker_any&#41; = @_;
+
+
+    # The $self-&gt;{_list_level} global keeps track of when we&#39;re inside a list.
+    # Each time we enter a list, we increment it; when we leave a list,
+    # we decrement. If it&#39;s zero, we&#39;re not in a list anymore.
+    #
+    # We do this because when we&#39;re not inside a list, we want to treat
+    # something like this:
+    #
+    #       I recommend upgrading to version
+    #       8. Oops, now this line is treated
+    #       as a sub-list.
+    #
+    # As a single paragraph, despite the fact that the second line starts
+    # with a digit-period-space sequence.
+    #
+    # Whereas when we&#39;re inside a list &#40;or sub-list&#41;, that line will be
+    # treated as the start of a sub-list. What a kludge, huh? This is
+    # an aspect of Markdown&#39;s syntax that&#39;s hard to parse perfectly
+    # without resorting to mind-reading. Perhaps the solution is to
+    # change the syntax rules such that sub-lists must start with a
+    # starting cardinal number; e.g. &#34;1.&#34; or &#34;a.&#34;.
+
+    $self-&gt;{_list_level}++;
+
+    # trim trailing blank lines:
+    $list_str =~ s/\n{2,}\z/\n/;
+
+
+    $list_str =~ s{
+        &#40;\n&#41;?                           # leading line = $1
+        &#40;^[ \t]*&#41;                       # leading whitespace = $2
+        &#40;$marker_any&#41; [ \t]+            # list marker = $3
+        &#40;&#40;?s:.+?&#41;                       # list item text   = $4
+        &#40;\n{1,2}&#41;&#41;
+        &#40;?= \n* &#40;\z | \2 &#40;$marker_any&#41; [ \t]+&#41;&#41;
+    }{
+        my $item = $4;
+        my $leading_line = $1;
+        my $leading_space = $2;
+
+        if &#40;$leading_line or &#40;$item =~ m/\n{2,}/&#41;&#41; {
+            $item = $self-&gt;_RunBlockGamut&#40;$self-&gt;_Outdent&#40;$item&#41;&#41;;
+        }
+        else {
+            # Recursion for sub-lists:
+            $item = $self-&gt;_DoLists&#40;$self-&gt;_Outdent&#40;$item&#41;&#41;;
+            chomp $item;
+            $item = $self-&gt;_RunSpanGamut&#40;$item&#41;;
+        }
+
+        &#34;&lt;li&gt;&#34; . $item . &#34;&lt;/li&gt;\n&#34;;
+    }egmxo;
+
+    $self-&gt;{_list_level}--;
     return $list_str;
 }
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;11&nbsp;18:44:43&nbsp;2008</span>
    <span class="description">bobtfish [...] bobtfish.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #37297] coredumps on various inputs in Perl 5.8.5</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 11 Jul 2008 23:44:12 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Text-Markdown [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tomas Doran &lt;bobtfish [...] bobtfish.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On 7 Jul 2008, at 14:55, Chapman Flack via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Text-Markdown
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=37297">http://rt.cpan.org/Ticket/Display.html?id=37297</a></span> &gt;
&gt;
&gt; Tomas Doran via RT wrote:
<div class="message-stanza open">&gt;&gt; Can you send me the code for this, even if it&#39;s not &#39;the correct
&gt;&gt; solution&#39;, as &#40;given it still passes the test suite&#41;, I&#39;ll push out a
&gt;&gt; point release to fix this issue for anyone else who&#39;s seeing it..
</div>&gt;
&gt; Sure, I&#39;ll phrase it in the form of a patch against 1.0.19. :&#41;
&gt;
&gt; One caution: it might not fix the issue for anyone else who&#39;s seeing
&gt; it: it&#39;s not just &#39;not the correct solution&#39;, it&#39;s really not a  
&gt; solution
&gt; at all. The regex engine is still used re-entrantly, only not as
&gt; heavily, so the probability of failure is lower. It&#39;s low enough that
&gt; my own application manages to complete now without failing, but  
&gt; anybody
&gt; else&#39;s mileage may still vary.
</div>
Totally agree, and I&#39;ve presented it as such in the Changelog..

1.0.20 just went to CPAN, many thanks for the patch.

It should be on your CPAN mirror in the next day or two. I&#39;d be  
grateful if you could try it out, and see if it works ok for you.

Tom
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;12&nbsp;06:16:14&nbsp;2008</span>
    <span class="description">bobtfish [...] bobtfish.net -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;12&nbsp;06:16:59&nbsp;2008</span>
    <span class="description">bobtfish [...] bobtfish.net -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;12&nbsp;06:16:59&nbsp;2008</span>
    <span class="description">bobtfish [...] bobtfish.net -  Fixed in 1.0.20 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;12&nbsp;06:16:59&nbsp;2008</span>
    <span class="description">bobtfish [...] bobtfish.net -  Severity Critical added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;12&nbsp;06:17:00&nbsp;2008</span>
    <span class="description">bobtfish [...] bobtfish.net -  Broken in 1.0.16 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;12&nbsp;06:17:00&nbsp;2008</span>
    <span class="description">bobtfish [...] bobtfish.net -  Broken in 1.0.17 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;12&nbsp;06:17:00&nbsp;2008</span>
    <span class="description">bobtfish [...] bobtfish.net -  Broken in 1.0.18 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;12&nbsp;06:17:00&nbsp;2008</span>
    <span class="description">bobtfish [...] bobtfish.net -  Broken in 1.0.19 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;12&nbsp;06:17:58&nbsp;2008</span>
    <span class="description">bobtfish [...] bobtfish.net -  Reference to ticket #36203 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;12&nbsp;06:18:29&nbsp;2008</span>
    <span class="description">bobtfish [...] bobtfish.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This does also fix RT#32603 :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;12&nbsp;06:18:31&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;12&nbsp;06:18:32&nbsp;2008</span>
    <span class="description">bobtfish [...] bobtfish.net -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
