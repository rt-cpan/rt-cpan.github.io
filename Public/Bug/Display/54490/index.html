<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #54490 for Digest-SHA-PurePerl: unicode problems</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #54490 for Digest-SHA-PurePerl: unicode problems</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Digest-SHA-PurePerl/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Digest-SHA-PurePerl/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Digest-SHA-PurePerl/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Digest-SHA-PurePerl/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Digest-SHA-PurePerl">Digest-SHA-PurePerl CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">54490</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time estimated">
    <td class="label">Estimated:</td>
    <td class="value">1 hour (60 min)

</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">1 hour (60 min)

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Digest-SHA-PurePerl/Active/">Digest-SHA-PurePerl</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">mshelor [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cr2005 [...] u-club.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-11548-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
5.48    </td>
  </tr>
  <tr id="CF-11549-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
5.81    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;10&nbsp;13:10:31&nbsp;2010</span>
    <span class="description">cr2005 [...] u-club.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> unicode problems</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi!

The PurePerl has got problems with adding unicode strings. It&#39;s 
similar to:

<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=54369">https://rt.cpan.org/Public/Bug/Display.html?id=54369</a></span>

Funny, this is not an .xs issue. 

Fixing SHA/PurePerl.pm is easy:

use bytes;


PS:

Your Digest::SHA works correct!

;&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;14&nbsp;20:10:42&nbsp;2013</span>
    <span class="description">mshelor [...] cpan.org -  TimeEstimated changed from &#40;no value&#41; to &#39;60&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;14&nbsp;20:10:42&nbsp;2013</span>
    <span class="description">mshelor [...] cpan.org -  TimeWorked changed from &#40;no value&#41; to &#39;60&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;14&nbsp;20:10:42&nbsp;2013</span>
    <span class="description">mshelor [...] cpan.org -  Given to MSHELOR</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;14&nbsp;20:10:43&nbsp;2013</span>
    <span class="description">mshelor [...] cpan.org -  Severity Normal added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;14&nbsp;20:10:43&nbsp;2013</span>
    <span class="description">mshelor [...] cpan.org -  Fixed in 5.81 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;14&nbsp;20:29:53&nbsp;2013</span>
    <span class="description">mshelor [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Feb 10 13:10:31 2010, chr wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The PurePerl has got problems with adding unicode strings. It&#39;s 
&gt; similar to:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=54369">https://rt.cpan.org/Public/Bug/Display.html?id=54369</a></span>
&gt; 
&gt; Fixing SHA/PurePerl.pm is easy:
&gt; 
&gt; use bytes;
&gt; 
&gt; Your Digest::SHA works correct!
</div>

Note that &#34;adding Unicode strings&#34; to digest objects is a meaningless
concept: SHA algorithms operate on sequences of bytes, whereas Unicode
strings contain wide characters.

By convention &#40;ref. Digest::SHA1 and Digest::MD5&#41;, the appropriate
response upon receiving a wide character is for the digest function to
croak.  So, this is what Digest::SHA and Digest::SHA::PurePerl now do
as of 5.74 and 5.81, respectively.

Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;14&nbsp;20:29:54&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;14&nbsp;20:29:54&nbsp;2013</span>
    <span class="description">mshelor [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;15&nbsp;09:38:51&nbsp;2013</span>
    <span class="description">cr2005 [...] u-club.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> cr2005 [...] u-club.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Mo 14. Jan 2013, 20:29:53, MSHELOR schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Note that &#34;adding Unicode strings&#34; to digest objects is a meaningless
</div>
What is meaningless? Adding unicode|iso-8859|whatever strings,
adding a sequence of image data? Adding any data?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; concept: SHA algorithms operate on sequences of bytes, whereas 
&gt; Unicode strings contain wide characters.
</div>
Yes, SHA should operate on bytes and not on chars. A Digest shall not
care about what those bytes are.

It&#39;s perl who must handle unicode encoded strings in a special manner
on string operations e.g. &#34;length&#40;&#41;, substr&#40;&#41;&#34;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; By convention &#40;ref. Digest::SHA1 and Digest::MD5&#41;, the appropriate
&gt; response upon receiving a wide character is for the digest function 
&gt; to croak.  So, this is what Digest::SHA and Digest::SHA::PurePerl
&gt; now do as of 5.74 and 5.81, respectively.
&gt; 
</div>
I don&#39;t see a convention not using strings for a digest message.

From &#34;Digest::MD5&#34;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Since the MD5 algorithm is only defined for strings of bytes, it can 
&gt; not be used on strings that contains chars with ordinal number above
&gt; 255.
</div>
That is a mistake! 

Perl got the &#34;use bytes&#34; pragma to force byte semantics
rather than character semantics &#40;see perldoc bytes&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;15&nbsp;09:38:52&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;15&nbsp;20:04:24&nbsp;2013</span>
    <span class="description">mshelor [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jan 15 09:38:51 2013, chr wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Am Mo 14. Jan 2013, 20:29:53, MSHELOR schrieb:
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; Note that &#34;adding Unicode strings&#34; to digest objects is a meaningless
</div>&gt; 
&gt; What is meaningless? Adding unicode|iso-8859|whatever strings,
&gt; adding a sequence of image data? Adding any data?
</div>
A Unicode string is a sequence of wide characters.  This is not the same
thing as a sequence of bytes since the wide characters can have ordinal
values larger than 255.

There are many different ways to encode a Unicode string into a sequence
of bytes.  UTF-8 is only one of them.  Therefore the digest of a Unicode
string is ambiguous.

Whereas image data, binary files, ordinary strings, etc. are sequences
of bytes &#40;unless otherwise specified&#41; and hence can be added to digest
objects.

 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Perl got the &#34;use bytes&#34; pragma to force byte semantics
&gt; rather than character semantics &#40;see perldoc bytes&#41;
</div>

Yes, but that&#39;s just a reflection of the way Perl handles Unicode
strings internally, viz. by encoding them in UTF-8.  That&#39;s why &#34;use
bytes&#34; is generally discouraged: it assumes the rest of the world is
handling Unicode strings exactly the way Perl does internally, which is
not always true.

A Unicode string is a larger and more powerful abstraction than a byte
sequence.  If you choose to view it as a UTF-8 encoded sequence of bytes
for the purpose of your application, that&#39;s certainly fine.  But you&#39;ll
have to be explicit by first saying &#34;utf8::encode&#40;$string&#41;&#34; before
sending it to the digest routines.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;15&nbsp;20:04:25&nbsp;2013</span>
    <span class="description">mshelor [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;20&nbsp;12:27:06&nbsp;2013</span>
    <span class="description">cr2005 [...] u-club.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> cr2005 [...] u-club.de</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry, one thing remains ...

When I filed this bug report, 3 years ago, the bug was different:

Digest::SHA worked fine for me
Digest::SHA::PurePerl produced different results on the same data &#40;if
feed w utf8&#41;.

Digest::MD5 calculated right but silently dropped the &#34;is_utf8&#34; flag
from $value.
That screwed up further processing of $value which caused the bug I was
originally hunting for.

I was expecting the Digest:: would to the right thing regardless of the
mess I feed them. And some seemed to do so.

My mistake.

I hoped that can be fixed. From the source:

$bitstr = substr&#40;$bitstr, $numbits &gt;&gt; 3, _BYTECNT&#40;$bitcnt&#41;&#41;;

substr&#40;&#41; operates on chars not on bytes unless you &#34;use bytes&#34; in that
scope
or use pack/unpack
or presume $bitstr is a byte string and pray that I used utf8::encode&#40;&#41;

... otherwise croak.

I looked into that stuff again and there is one issue remaining: 
it does not croak as expected.

I attach a test file.

1. It passes fine, if you uncomment and use utf8::encode.

2. It fails as expected not using utf8::encode
This is how you want me, isn&#39;t it?
It used to work with Digest::SHA 3 years ago.

3. but it does not croak as expected:

string #1 no croak but just works

string #3 croaks fine

string #2 no croak - wrong result
And the string was &#34;touched&#34;:
is_utf8=0 length=8
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ttest-digest-sha-utf8.pl.gz</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;20&nbsp;12:27:07&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;20&nbsp;22:03:43&nbsp;2013</span>
    <span class="description">mshelor [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Jan 20 12:27:06 2013, chr wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; When I filed this bug report, 3 years ago, the bug was different:
&gt; 
&gt; Digest::SHA worked fine for me
&gt; Digest::SHA::PurePerl produced different results on the same data &#40;if
&gt; feed w utf8&#41;.
&gt; 
&gt; I was expecting the Digest:: would to the right thing regardless of the
&gt; mess I feed them. And some seemed to do so.
</div>

Thanks, Chris, for the comment and very readable test script.  My
response, briefly summarized, is that both Digest::SHA and
Digest::SHA::PurePerl now handle Unicode strings properly.  This was not
the case 3 years ago, when you felt that Digest::SHA was working fine.

For example, let&#39;s take the case of your second test vector where the
input is &#34;blödsinn&#34;.  This string is the same as: 

    &#34;bl&#34; . chr&#40;246&#41; . &#34;dsinn&#34;

which is a perfectly acceptable 8-character string, and can be digested
straight away.  Its expected SHA-1 digest value is

    c77a16d028753a1ae761ad8eb33f5bc307364a24

not

    bd0f217087566043ca73d9e9ce81f7c9a4311872.

The latter is the digest value of the UTF-8 encoding of &#34;blödsinn&#34;:

    &#34;bl&#34;.chr&#40;195&#41;.chr&#40;182&#41;.&#34;dsinn&#34;

Note that the string &#34;blödsinn&#34; contains no wide characters &#40;i.e. no
chars with ordinal values greater than 255&#41;, so there&#39;s no reason to
croak on such input.

Admittedly this is all rather confusing.  I&#39;ve added a section to the
documentation of the next version explaining the rule for handling
Unicode input.  But I expect confusion will linger.  That&#39;s
understandable given that even Perl 5.6 was fatally confused when it
came to Unicode.  This makes using the &#34;pack&#34; function with C-C0-U-U0
templates highly unpredictable and inconsistent across Perl versions.

Right now I&#39;m revising both Digest::SHA modules to function consistently
across all Perls, from 5.6 onwards.  This isn&#39;t straightforward because
of the need to work around Perl 5.6 bugs in the SvPVbyte macro and other
Unicode-related operations.

Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;20&nbsp;22:03:45&nbsp;2013</span>
    <span class="description">mshelor [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;21&nbsp;13:32:00&nbsp;2013</span>
    <span class="description">cr2005 [...] u-club.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> cr2005 [...] u-club.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Right now I&#39;m revising both Digest::SHA modules to function
&gt; consistently across all Perls, from 5.6 onwards.  This isn&#39;t
&gt; straightforward because of the need to work around Perl 5.6 bugs in
&gt; the SvPVbyte macro and other Unicode-related operations.
</div>
I think we do agree on most of this stuff. What to simply add to the
documentation?

&#34;This Digest operates on bytes not with strings. Strings must be
presented as bytes within a desired Encoding.&#34;

&#40;In contrast to this, here comes music-fingerprints in mind, which
operates on the sound data&#41;.



As you are now reviewing the stuff, I&#39;ll talk about it&#39;s side effects
to keep in mind.

But where to start. This stuff effects all Digest:: modules.

If I recall the original bug using Digest::MD5, it had this side
effect:

my $s; # a string may be is_utf8&#40;&#41;;
my $t; # a string may be is_utf8&#40;&#41;;

$digest_md5-&gt;add&#40;$s&#41;; # my mistake: adds a string

# now $s is wasted, it&#39;s no more a valid string value
# is_itf8&#40;&#41; is now 0, length&#40;&#41; is wrong
# your mistake?
# croak at least? I see, not easy: no types in script&#39;s values
# die &#39;rtfm&#39; if &#40;is_utf8&#40;$data&#41;&#41;;

$t .= &#34;The value of s is $s&#34;;

now $s has tainted $t ... somewhere else you _may_ get garbled output.
In case of Digest::SHA, $s is still a valid and usable string but it&#39;s
no longer is_utf8.

I regard it as a bug, if add&#40;&#41; garbles my data.


1st workaround:

$digest_md5-&gt;add&#40;&#34;$s&#34;&#41;; # still a mistake

So I have to wrap around this anyhow. Adding strings like:

$digest-&gt;add_string&#40;$encoding, $string&#41; or use utf8::encode&#40;&#41;

So, I just read the Digest docu about add&#40;&#41; and addfile&#40;&#41; ... they can
use some clarification about strings. And the $io_handle should be
opened with &#39;:raw&#39;, set to binary, shouldn&#39;t it?


About my test script:

I&#39;m expecting bd0f217087566043ca73d9e9ce81f7c9a4311872 as the correct
result because I want a Digest of it&#39;s utf-8 bytes encoding, because
I&#39;m going to store my string data as utf8 in my database, filesystem
or output to the web.

I calculated the test values by storing the strings to utf8 encoded
files, verified them with hexdump -C and run

openssl dgst -sha &lt; nonsense ...

So what else can go wrong? Oh, yes, a utf8 file may start with a BOM
...



Confusion about &#39;use utf8&#39;

The test script source is a utf8 encoded file. Run hexdump on it:

000003f0  64 38 31 39 30 62 0a 62  6c c3 b6 64 73 69 6e 6e
|d8190b.bl..dsinn|

Great headache if you write a test script about unicode etc: perl&#39;s
runtime configuration of STDOUT is usually not utf8 but most
linux-terminals are.  So if it looks wrong, it may be ok and if it
looks ok, it may be wrong.

This is about &#39;use utf8&#39; and the binmode stuff ... or use -CSDL
switch.  I do believe, I did that the right way &#40;assuming your
terminal is utf8 too&#41;.  This bug is for the packagers who delivers
perl runtime and terminals without setting $ENV{PERL_UNICODE}
according to $LANG ?!

So I may rewrite the test so it reads the strings from files instead.
This will outline the problem by using open&#40;&#41; a correct way. To add
confusion I can create the string test files with some other
encodings.


However, I reagard this bug report is solved by adding a section to
the general Digest documentation.

chris
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;21&nbsp;13:32:02&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;21&nbsp;20:38:37&nbsp;2013</span>
    <span class="description">mshelor [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jan 21 13:32:00 2013, chr wrote:
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think we do agree on most of this stuff. What to simply add to the
&gt; documentation?
&gt; 
&gt; &#34;This Digest operates on bytes not with strings. Strings must be
&gt; presented as bytes within a desired Encoding.&#34;
&gt; ...
&gt; However, I reagard this bug report is solved by adding a section to
&gt; the general Digest documentation.
</div>

OK.

I too am bothered by the fact that the digest routines &#34;alter&#34; data
that&#39;s fed to them.  But that alteration is really only seen by Perl
&#40;and by inspection functions like utf8::is_utf8&#41; and never alters the
meaning of the data when using the default &#40;viz. character&#41; semantics.

Here&#39;s the new section on Unicode I&#39;m adding to both of the Digest::SHA
modules.  Comments are welcomed:

=head1 UNICODE

Perl supports Unicode strings as of version 5.6.  Such strings may
contain wide characters, namely, characters whose ordinal values are
greater than 255.  This can cause problems for digest algorithms such
as SHA that are specified to operate on sequences of bytes.

The rule by which Digest::SHA handles a Unicode string is easy to
state, but potentially confusing to grasp: the string is interpreted
as a sequence of bytes, where each byte is equal to the ordinal value
&#40;viz. code point&#41; of its corresponding Unicode character.  That way,
the Unicode version of the string &#39;abc&#39; has exactly the same digest
value as the ordinary string &#39;abc&#39;.

Since a wide character does not fit into a byte, the Digest::SHA
routines croak if they encounter one.  Whereas if a Unicode string
contains no wide characters, the module accepts it quite happily.  The
following code illustrates the two cases:

        $str1 = pack&#40;&#39;U*&#39;, &#40;0..255&#41;&#41;;
        print sha1_hex&#40;$str1&#41;;          # ok

        $str2 = pack&#40;&#39;U*&#39;, &#40;0..256&#41;&#41;;
        print sha1_hex&#40;$str2&#41;;          # croaks

=head1 NIST STATEMENT ON SHA-1


Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;21&nbsp;20:38:38&nbsp;2013</span>
    <span class="description">mshelor [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
