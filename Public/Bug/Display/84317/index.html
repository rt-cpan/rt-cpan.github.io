<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #84317 for Class-Prototyped: Random test results with bleadperl</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #84317 for Class-Prototyped: Random test results with bleadperl</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Class-Prototyped/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Class-Prototyped/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Class-Prototyped/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Class-Prototyped/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Class-Prototyped">Class-Prototyped CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">84317</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Class-Prototyped/Active/">Class-Prototyped</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">TEVERETT [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ANDK [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-7224-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.11    </td>
  </tr>
  <tr id="CF-7225-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.12    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;31&nbsp;06:23:05&nbsp;2013</span>
    <span class="description">ANDK [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Random test results with bleadperl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As per subject. Sample fail report:

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/78cec3e4-90d7-11e2-8f16-fa053b384401">http://www.cpantesters.org/cpan/report/78cec3e4-90d7-11e2-8f16-fa053b384401</a></span>

Canonical ticket for the issue is <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/rt3//Public/Bug/Display.html?id=117313">https://rt.perl.org/rt3//Public/Bug/Display.html?id=117313</a></span>

HTH &#38;&#38; Regards,
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;18&nbsp;04:35:56&nbsp;2013</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Ne 31.b≈ôe.2013 06:23:05, ANDK napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; As per subject. Sample fail report:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/78cec3e4-90d7-11e2-8f16-">http://www.cpantesters.org/cpan/report/78cec3e4-90d7-11e2-8f16-</a></span>
&gt; fa053b384401
&gt; 
&gt; Canonical ticket for the issue is
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/rt3//Public/Bug/Display.html?id=117313">https://rt.perl.org/rt3//Public/Bug/Display.html?id=117313</a></span>
&gt; 
</div>
And this happens despite $Data::Dumper::Sortkeys=1 in the failing t/autoload.t.

Would Test::Deep help?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;18&nbsp;04:35:56&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;10&nbsp;03:56:55&nbsp;2013</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2013-07-18 04:35:56, ppisar wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne Ne 31.b≈ôe.2013 06:23:05, ANDK napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; As per subject. Sample fail report:
&gt; &gt;
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/78cec3e4-90d7-11e2-8f16-">http://www.cpantesters.org/cpan/report/78cec3e4-90d7-11e2-8f16-</a></span>
&gt; &gt; fa053b384401
&gt; &gt;
&gt; &gt; Canonical ticket for the issue is
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/rt3//Public/Bug/Display.html?id=117313">https://rt.perl.org/rt3//Public/Bug/Display.html?id=117313</a></span>
&gt; &gt;
</div>&gt; 
&gt; And this happens despite $Data::Dumper::Sortkeys=1 in the failing
&gt; t/autoload.t.
&gt; 
&gt; Would Test::Deep help?
</div>
No.

The problem can be reproduced with the following script:

use Class::Prototyped qw&#40;:NEW_MAIN&#41;;
$p10 = new&#40;[qw&#40;b FIELD autoload 1 wantarray 1&#41;] =&gt; sub { }&#41;;
warn join&#40;&#34;\n&#34;, @{ &#40;$p10-&gt;reflect-&gt;getSlots&#41;[0] }&#41;, &#34;\n&#34;;

With perl 5.18.0, the output is either

b
FIELD
wantarray
1
autoload
1

or

b
FIELD
autoload
1
wantarray
1

that is, autoload and wantarray may be swapped.

The problem is caused by getSlot and getSlots creating a data structure like this:

    [$slot, $type, %$attribs]

Because of hash randomization, the order of the keys in %$attribs is random. And because the hash is interpolated into an array, there&#39;s no way to fix this afterwards &#40;e.g. using Sortkeys=1 or Test::Deep or so&#41;.

I see the following possible solutions:

* In getSlot and getSlots, make sure that the interpolation is done with a sorted hash, i.e. do something like this &#40;untested&#41;: [$slot, $type, &#40;map { &#40;$_=&gt;$attribs-&gt;{$_}&#41; } sort keys %$attribs&#41;]

* In the autoload.t test, do the comparison &#34;manually&#34; for the failing test, e.g. checking element by element.

* getSlot and getSlots have the &#34;rotated&#34; format option, which looks like it&#39;s returning something which may be compared, as the %$attribs hash stays a hash.

Regards,
    Slaven
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;10&nbsp;03:56:56&nbsp;2013</span>
    <span class="description">SREZIC [...] cpan.org -  Fixed in 1.11 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;10&nbsp;04:01:21&nbsp;2013</span>
    <span class="description">SREZIC [...] cpan.org -  Fixed in 1.11 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;22&nbsp;20:01:35&nbsp;2013</span>
    <span class="description">TEVERETT [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Aug 10 03:56:55 2013, SREZIC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The problem can be reproduced with the following script:
&gt; 
&gt; use Class::Prototyped qw&#40;:NEW_MAIN&#41;;
&gt; $p10 = new&#40;[qw&#40;b FIELD autoload 1 wantarray 1&#41;] =&gt; sub { }&#41;;
&gt; warn join&#40;&#34;\n&#34;, @{ &#40;$p10-&gt;reflect-&gt;getSlots&#41;[0] }&#41;, &#34;\n&#34;;
&gt; 
&gt; With perl 5.18.0, the output is either
&gt; 
&gt; b
&gt; FIELD
&gt; wantarray
&gt; 1
&gt; autoload
&gt; 1
&gt; 
&gt; or
&gt; 
&gt; b
&gt; FIELD
&gt; autoload
&gt; 1
&gt; wantarray
&gt; 1
&gt; 
&gt; that is, autoload and wantarray may be swapped.
&gt; 
&gt; The problem is caused by getSlot and getSlots creating a data
&gt; structure like this:
&gt; 
&gt; [$slot, $type, %$attribs]
&gt; 
&gt; Because of hash randomization, the order of the keys in %$attribs is
&gt; random. And because the hash is interpolated into an array, there&#39;s no
&gt; way to fix this afterwards &#40;e.g. using Sortkeys=1 or Test::Deep or
&gt; so&#41;.
&gt; 
&gt; I see the following possible solutions:
&gt; 
&gt; * In getSlot and getSlots, make sure that the interpolation is done
&gt; with a sorted hash, i.e. do something like this &#40;untested&#41;: [$slot,
&gt; $type, &#40;map { &#40;$_=&gt;$attribs-&gt;{$_}&#41; } sort keys %$attribs&#41;]
&gt; 
&gt; * In the autoload.t test, do the comparison &#34;manually&#34; for the failing
&gt; test, e.g. checking element by element.
&gt; 
&gt; * getSlot and getSlots have the &#34;rotated&#34; format option, which looks
&gt; like it&#39;s returning something which may be compared, as the %$attribs
&gt; hash stays a hash.
</div>
First, let me offer my abject apologies for neglecting this over the last few months.  For better or worse, I&#39;ve been pivoting to Ruby and my Perl skills are definitely getting rusty.  My module releasing skills weren&#39;t much to begin with, and started atrophying years ago, which definitely contributed to my fear of attacking this.

Second, let me thank Slaven Rezic for the in depth investigation and handing me an almost complete solution!  I&#39;ll take what&#39;s behind door three!  That has the advantage of no changes to the code itself, just to the test suite, which reduces the chance that I&#39;ll introduce an issue.  Since the attribs hash wasn&#39;t sorted to begin with &#40;it&#39;s just that we were assuming in the test suite that identical hashes would sort identically&#41;, I doubt that leaving the code itself as is will cause issues in production code.

With that in mind, I&#39;ve gone through the test suite and changed almost all of the calls to getSlots to use rotated as the output format.  The two exceptions are in situations where there should never be more than one key in the hash.  I&#39;ve also verified that all of the calls to getSlot are either in scalar contexts &#40;where only the value is returned&#41; or in scenarios where the will never be more than one key in the hash.

I&#39;d like to release, but I&#39;m not particularly excited about trying to get bleadperl compiled for my box.  Is there any chance that if I package up the directory, there might be someone to whom I could send it for verification that it tests fine against 5.18?  It&#39;s testing fine against 5.16, and the only changes are to the t directory &#40;and versions numbers&#41;.

Thanks!

I have to say it never ceases to amaze me that code that does this much symbol table manipulation and generally evil envelope boundary pushing has made it from 5.10 through 5.12, 5.14, and 5.16 without any updates!

--Toby Ovod-Everett
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;29&nbsp;09:46:11&nbsp;2013</span>
    <span class="description">TEVERETT [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I went ahead and released 1.12, only to discover that changes somewhere in Module::Build and/or the CPAN indexer were complaining about the lack of version numbers on the subpackages, so I cleaned that up and released 1.13.  It appears to be testing fine with 5.18.* and 5.19.*.  Given that the previous test failure rate was around 50% &#40;due to randomization of the hashes&#41; and given that 31 tests have run &#40;including both 1.12 and 1.13&#41; against &gt;=5.18.0, I&#39;d say it&#39;s pretty likely this fixes it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;29&nbsp;09:46:12&nbsp;2013</span>
    <span class="description">TEVERETT [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;29&nbsp;09:46:12&nbsp;2013</span>
    <span class="description">TEVERETT [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;29&nbsp;09:46:12&nbsp;2013</span>
    <span class="description">TEVERETT [...] cpan.org -  Fixed in 1.12 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
