<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #122919 for Net-SSH2-Cisco: Bug/improvement Net::SSH2::Cisco</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #122919 for Net-SSH2-Cisco: Bug/improvement Net::SSH2::Cisco</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-SSH2-Cisco/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-SSH2-Cisco/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-SSH2-Cisco/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-SSH2-Cisco/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SSH2-Cisco">Net-SSH2-Cisco CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">122919</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">6 hours (360 min)

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-SSH2-Cisco/Active/">Net-SSH2-Cisco</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">VINSWORLD [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
eric [...] amerca.nl

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-262132-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-262133-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.04    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




Cisco.pm<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1746879/939626/Cisco.pm">
Thu Aug 31 10:33:08 2017 (82.8k) by VINSWORLD [...] cpan.org
</a>
</font></li>
</ul>


Cisco.pm.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1746705/939528/Cisco.pm.patch">
Tue Aug 29 19:08:17 2017 (3.1k) by VINSWORLD [...] cpan.org
</a>
</font></li>
</ul>


Cisco.pm.patch_0v4_to_0v41<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1746861/939612/Cisco.pm.patch_0v4_to_0v41">
Thu Aug 31 01:58:41 2017 (2k) by eric [...] amerca.nl
</a>
</font></li>
</ul>


compare.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1746879/939627/compare.pl">
Thu Aug 31 10:33:08 2017 (945b) by VINSWORLD [...] cpan.org
</a>
</font></li>
</ul>


dotest.bat<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1746879/939628/dotest.bat">
Thu Aug 31 10:33:08 2017 (338b) by VINSWORLD [...] cpan.org
</a>
</font></li>
</ul>


dotest.sh<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1746879/939629/dotest.sh">
Thu Aug 31 10:33:08 2017 (317b) by VINSWORLD [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;29&nbsp;01:32:35&nbsp;2017</span>
    <span class="description">eric [...] amerca.nl -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Bug/improvement Net::SSH2::Cisco</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 29 Aug 2017 07:32:14 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSH2-Cisco [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Smid &lt;eric [...] amerca.nl&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Michael,

First I want to thank you for the great work for the Net::SSH2::Cisco
module.

When using this module I found that the output of the cmd sub differed
from the output of the cmd sub of the Net::Telnet::Cisco module.
I ran into two problems:

The cmd sub of Net::Telnet::Cisco returns \n at the end of the line,
while the same devices return \r\n at the and of the line when using
Net::SSH2::Cisco.
I solved this by adding the red lines below, which 
    my &#40;$lines, $last_prompt&#41;;
    {
        local $self-&gt;{errormode} = &#34;return&#34;;

        #send
        $self-&gt;put&#40;$string . $ors&#41;;

        #wait
        select&#40;undef,undef,undef,$pause&#41;; # sleep

        #read
        &#40;$lines, $last_prompt&#41; = $self-&gt;waitfor&#40;$prompt&#41;;
    }

    # Added by Eric Smid to make output the same as Net::Telnet::Cisco
     if &#40; defined $lines&#41; {
         $lines =~ s/\r\n/\n/mg; # Replace \r\n by \n
     }

    return $self-&gt;error&#40;&#34;command timed-out&#34;&#41; if $self-&gt;timed_out;
    return $self-&gt;error&#40;$self-&gt;errmsg&#41; if $self-&gt;errmsg ne &#34;&#34;; 

The second issue is that the normalize sub puts the \n character at the
end of the line at the beginning of the next line. This is also an issue
with Net::Telnet::Cisco.
I didn&#39;t see this behaviour earlier with Net::Telnet::Cisco, because I
normally set terminal length to 0. With Net::Telnet:Cisco _normalize is
only executed when there is a &#34;more: prompt. In Net::SSH2:Cisco it is
always executed. 

So: 

Line 1\n 
Line 2\n 

Changes to 
Line 1 
\n Line 2 
\n 

I replaced _normalize with this sub. I also use HEX character matching
to make the code more readable. 

# Changed by Eric Smid. This Solves the problem where \n is at the
beginning of the next line instead of
# at the end of the current line.
sub _normalize {
    foreach &#40;@_&#41; {
      1 while s/[^\x08\x7F][\x08\x7F]//g; # Remove combination of non BS
or DEL character followed by BS or DEL character, check again after
removal
      s/^.*[\x15]//g;                    # Remove all characters before
and including NAK character
    }

    return wantarray ? @_ : join &#34;&#34;, @_; # ORS instead?
} 

Is it possible to add these improvements to your code at CPAN? 

Best Regards, 

Eric Smid
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;29&nbsp;19:08:17&nbsp;2017</span>
    <span class="description">VINSWORLD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">180 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think I have a fix.  The _normalize routine does always run - you&#39;re right - and it shouldn&#39;t.  The cmd&#40;&#41; architecture of N::T::C and N::S::C are a bit different due to the underlying modules, Net::Telnet and Net::SSH2 respectively.  The solution is to move _normalize&#40;&#41; to when I do the autopaging - similar as in N::T::C.  I do that in waitfor&#40;&#41;.

Also, not sure where / how Net::Telnet / Net::Telnet::Cisco clips the \015\012 to just \012, but it does indeed somewhere.  The actual return from the router if you use dump log is \015\012 so Net::SSH2::Cisco reports it correctly, but to keep consistent with Net::Telnet::Cisco, I&#39;ve added a fix.

Note, the &#34;\nLine1&#34; issue is a Net::Telnet::Cisco &#34;bug&#34;.  I believe it&#39;s fixed now in Net::Telnet::Cisco, but output after the first autopage will be different between the two now; N::T::C doing:

Line1\n
Line2\n
up to the first autopage, then switching to:
\nLine5
\nLine5
...

Net::SSH2::Cisco will always use &#34;Line1\n&#34;.

If you please, patch your version with this and let me know if it suits you.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Cisco.pm.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- lib\Net\SSH2\Cisco.pm	2016-10-13 14:28:44.000000000 -0400
+++ lib\Net\SSH2\Cisco.pm	2017-08-29 18:53:01.757873100 -0400
@@ -29,7 +29,7 @@
 use strict;
 use warnings;
 
-our $VERSION = &#39;0.03&#39;;
+our $VERSION = &#39;0.04&#39;;
 our @ISA;
 
 use version;
@@ -309,7 +309,10 @@
         select&#40;undef,undef,undef,$pause&#41;; # sleep
 
         #read
-        &#40;$lines, $last_prompt&#41; = $self-&gt;waitfor&#40;$prompt&#41;;
+        &#40;$lines, $last_prompt&#41; = $self-&gt;waitfor&#40;
+                                     match =&gt; $prompt,
+                                     normalize_cmd =&gt; $normal
+                                 &#41;;
     }
 
     return $self-&gt;error&#40;&#34;command timed-out&#34;&#41; if $self-&gt;timed_out;
@@ -326,6 +329,13 @@
         push @$output, substr&#40;$lines, $firstpos&#41;
     }
 
+    # behave like Net::Telnet&#40;::Cisco&#41; CRLF
+    if &#40;!$self-&gt;{bin_mode}&#41; {
+        for &#40;0..$#$output&#41; {
+            $output-&gt;[$_] =~ s/\015\012$/\012/;
+        }
+    }
+
     # clean up
     if &#40;$rm eq &#34;auto&#34;&#41; {
         if &#40;&#40;defined @$output[0]&#41; and &#40;@$output[0] =~ /^$string&#40;?:\r&#41;?&#40;?:\n&#41;?/&#41;&#41; {
@@ -372,10 +382,6 @@
         }
     }
 
-    if &#40;$normal&#41; {
-        @$output = _normalize &#40;@$output&#41;;
-    }
-
     ## Return command output via named arg, if requested.
     if &#40;defined $output_ref&#41; {
         if &#40;ref&#40;$output_ref&#41; eq &#34;SCALAR&#34;&#41; {
@@ -1018,6 +1024,11 @@
         &#38;_log_print&#40;$self-&gt;{outputlog}, $buf&#41;;
     }
 
+    ## Convert native newlines to CR LF.
+#    if &#40;!$self-&gt;{bin_mode}&#41; {
+#        $buf =~ s&#40;\n&#41;&#40;\015\012&#41;g;
+#    }
+
     &#38;_put&#40;$self, \$buf, &#34;print&#34;&#41;;
 }
 
@@ -1075,6 +1086,11 @@
         &#38;_log_print&#40;$self-&gt;{outputlog}, $buf&#41;;
     }
 
+    ## Convert native newlines to CR LF.
+#    if &#40;!$self-&gt;{bin_mode}&#41; {
+#        $buf =~ s&#40;\n&#41;&#40;\015\012&#41;g;
+#    }
+
     &#38;_put&#40;$self, \$buf, &#34;put&#34;&#41;;
 }
 
@@ -1126,6 +1142,7 @@
     my $chan    = $self-&gt;{_SSH_CHAN_};
     my $clear   = $self-&gt;{waitfor_clear};
     my $cmd     = $self-&gt;{last_cmd};
+    my $normal  = $self-&gt;{normalize_cmd};
     my $rm      = $self-&gt;{cmd_rm_mode};
     my $timeout = $self-&gt;{time_out};
 
@@ -1160,6 +1177,8 @@
                 $errmode = &#38;_parse_errmode&#40;$self, $arg&#41;;
             } elsif &#40;/^-?match$/i&#41; {
                 push @matches, _prep_regex&#40;$arg&#41;
+            } elsif &#40;/^-?normalize_cmd$/i&#41; {
+                $normal = $arg
             } elsif &#40;/^-?string$/i&#41; {
                 $arg =~ s/&#39;/\\&#39;/g;  # quote ticks
                 push @matches, $arg
@@ -1214,9 +1233,17 @@
                     }
                 }
                 # autopage
-                if &#40;$ap and &#40;$buf =~ /&#40;$MORE&#41;/&#41;&#41; {
-                    #$buf =~ s/$MORE//g;
-                    $self-&gt;put&#40;&#34; &#34;&#41;;
+                if &#40;$ap&#41; {
+                    if &#40;$buf =~ /&#40;$MORE&#41;/&#41; {
+                        $self-&gt;put&#40;&#34; &#34;&#41;;
+                    }
+                    if &#40;$normal&#41; {
+                        $buf =~ s/$MORE\s*//g;
+#                        $buf = _normalize&#40;$buf&#41;;
+                        $buf =~ s/\s*\010.*\010\s*//g;
+                        $buf =~ s/\177//g;
+                        $buf =~ s/^.*\025//mg;
+                    }
                 }
                 $buffer .= $buf
             }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;29&nbsp;19:08:17&nbsp;2017</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;29&nbsp;19:08:17&nbsp;2017</span>
    <span class="description">VINSWORLD [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;30&nbsp;15:32:02&nbsp;2017</span>
    <span class="description">eric [...] amerca.nl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #122919] Bug/improvement Net::SSH2::Cisco</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 30 Aug 2017 21:30:11 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSH2-Cisco [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Smid &lt;eric [...] amerca.nl&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Michael,

Tnx for your quick response!

I did some tests. But stille had some issues.
I already have a solution, and will let you know tomorrow.

I&#39;m wondering why you added a test for binmode to the replacement pf 
CRLF by LF.
If I understand correctly, binmode is only used for the login procedure. 
I couldn&#39;t find waitfor is used for the login procedure.

Shouldn&#39;t it be better to add te replacement of CRLF by LF to sub waitfor?

Regards,

Eric


On 30-8-2017 01:08, Michael Vincent via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=122919">https://rt.cpan.org/Ticket/Display.html?id=122919</a></span> &gt;
&gt;
&gt; I think I have a fix.  The _normalize routine does always run - you&#39;re right - and it shouldn&#39;t.  The cmd&#40;&#41; architecture of N::T::C and N::S::C are a bit different due to the underlying modules, Net::Telnet and Net::SSH2 respectively.  The solution is to move _normalize&#40;&#41; to when I do the autopaging - similar as in N::T::C.  I do that in waitfor&#40;&#41;.
&gt;
&gt; Also, not sure where / how Net::Telnet / Net::Telnet::Cisco clips the \015\012 to just \012, but it does indeed somewhere.  The actual return from the router if you use dump log is \015\012 so Net::SSH2::Cisco reports it correctly, but to keep consistent with Net::Telnet::Cisco, I&#39;ve added a fix.
&gt;
&gt; Note, the &#34;\nLine1&#34; issue is a Net::Telnet::Cisco &#34;bug&#34;.  I believe it&#39;s fixed now in Net::Telnet::Cisco, but output after the first autopage will be different between the two now; N::T::C doing:
&gt;
&gt; Line1\n
&gt; Line2\n
&gt; up to the first autopage, then switching to:
&gt; \nLine5
&gt; \nLine5
&gt; ...
&gt;
&gt; Net::SSH2::Cisco will always use &#34;Line1\n&#34;.
&gt;
&gt; If you please, patch your version with this and let me know if it suits you.
&gt;
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;31&nbsp;01:58:41&nbsp;2017</span>
    <span class="description">eric [...] amerca.nl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #122919] Bug/improvement Net::SSH2::Cisco</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 31 Aug 2017 07:58:15 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSH2-Cisco [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Smid &lt;eric [...] amerca.nl&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Michael,

Attached you can find my patch from your version 0v4 to my version 0v41.

The replacement of the substitutions in sub _normalize by the 
substitutions for $buf in sub waitfor are not correct.
The new substitutions cause whitespace for the first line after -- More 
-- to disappear.
After a character is send to the device the device returns backspaces to 
remove the more prompt.
Example:
$buf with more: &#34;Serial1/0:10\r\n --More-- &#34;
$buf after the character is send: &#34;\b\b\b\b\b\b\b\b\b        
\b\b\b\b\b\b\b\b\b description To&#34;

When doing the normalize for $buffer instead of $buf, the whole output 
is in one string.
By running the sub _normalize for $buffer, the output is correct.

The old _normalize produces the same output for strings, which applies 
to $buffer.
To let sub _normalize also produce the correct output for arrays, i 
changed _normalize.
I&#39;ll also contact the Net::Telnet::Cisco develloper to change the 
_normalize routine the same way.

I moved the substitution of CRLF to LF to sub waitfor. And removed the 
check for binmode, because i think binmode is not used at all in sub 
waitfor.

Regards,

Eric


On 2017-08-30 21:30, Eric Smid wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Michael,
&gt; 
&gt; Tnx for your quick response!
&gt; 
&gt; I did some tests. But stille had some issues.
&gt; I already have a solution, and will let you know tomorrow.
&gt; 
&gt; I&#39;m wondering why you added a test for binmode to the replacement pf 
&gt; CRLF by LF.
&gt; If I understand correctly, binmode is only used for the login
&gt; procedure. I couldn&#39;t find waitfor is used for the login procedure.
&gt; 
&gt; Shouldn&#39;t it be better to add te replacement of CRLF by LF to sub 
&gt; waitfor?
&gt; 
&gt; Regards,
&gt; 
&gt; Eric
&gt; 
&gt; 
&gt; On 30-8-2017 01:08, Michael Vincent via RT wrote:
<div class="message-stanza open">&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=122919">https://rt.cpan.org/Ticket/Display.html?id=122919</a></span> &gt;
&gt;&gt; 
&gt;&gt; I think I have a fix.  The _normalize routine does always run - you&#39;re 
&gt;&gt; right - and it shouldn&#39;t.  The cmd&#40;&#41; architecture of N::T::C and 
&gt;&gt; N::S::C are a bit different due to the underlying modules, Net::Telnet 
&gt;&gt; and Net::SSH2 respectively.  The solution is to move _normalize&#40;&#41; to 
&gt;&gt; when I do the autopaging - similar as in N::T::C.  I do that in 
&gt;&gt; waitfor&#40;&#41;.
&gt;&gt; 
&gt;&gt; Also, not sure where / how Net::Telnet / Net::Telnet::Cisco clips the 
&gt;&gt; \015\012 to just \012, but it does indeed somewhere.  The actual 
&gt;&gt; return from the router if you use dump log is \015\012 so 
&gt;&gt; Net::SSH2::Cisco reports it correctly, but to keep consistent with 
&gt;&gt; Net::Telnet::Cisco, I&#39;ve added a fix.
&gt;&gt; 
&gt;&gt; Note, the &#34;\nLine1&#34; issue is a Net::Telnet::Cisco &#34;bug&#34;.  I believe 
&gt;&gt; it&#39;s fixed now in Net::Telnet::Cisco, but output after the first 
&gt;&gt; autopage will be different between the two now; N::T::C doing:
&gt;&gt; 
&gt;&gt; Line1\n
&gt;&gt; Line2\n
&gt;&gt; up to the first autopage, then switching to:
&gt;&gt; \nLine5
&gt;&gt; \nLine5
&gt;&gt; ...
&gt;&gt; 
&gt;&gt; Net::SSH2::Cisco will always use &#34;Line1\n&#34;.
&gt;&gt; 
&gt;&gt; If you please, patch your version with this and let me know if it 
&gt;&gt; suits you.
&gt;&gt; 
&gt;&gt; 
</div></div></div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;31&nbsp;10:33:08&nbsp;2017</span>
    <span class="description">VINSWORLD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">180 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Eric,

Thanks for you help on this.  As you can imagine, blending 2 modules &#40;Net::Telnet::Cisco with Net::SSH2&#41; while using the API from yet a third &#40;Net::Telnet to keep consistent&#41; comes with its own set of challenges.

1&#41;
&#34;The new substitutions cause whitespace for the first line after -- More-- to disappear.&#34;

Yes, you&#39;re correct, I noticed that last night too.  I had a fix, but yours is more elegant; running on $buffer once all output is collected versus on each fill of $buf.

2&#41;
&#34;The old _normalize produces the same output for strings, which applies to $buffer. 
 To let sub _normalize also produce the correct output for arrays, i changed _normalize.&#34;

Not sure this is needed.  We pass in a string &#40;$buffer&#41;.  The original _normalize&#40;&#41; converts it to a string with the join&#40;&#41;, which I think we can both agree is a bit redundant / useless, but nonetheless.  I&#39;m trying to keep consistency between the subs I &#34;borrow&#34; from Net::Telnet and Net::Telnet::Cisco.  The only change I made to _normalize&#40;&#41; is to remove the g-modifier in the return&#40;&#41; as it generates a warning &#40;&#34;Use of /g modifier is meaningless in split&#34;&#41; - note, Net::Telnet::Cisco does not &#39;use warnings&#39; so you don&#39;t see it there.  For me, with the other changes, original _normalize&#40;&#41; works so I keep it.

Keeping with the logic flow from Net::Telnet::Cisco, _normalize should only run it autopage&#40;&#41; is enabled so I have that as an if&#40;&#41; condition along with checking the $normal variable.


3&#41;
&#34;I moved the substitution of CRLF to LF to sub waitfor.&#34;

Yes, I agree that&#39;s where it should be.  Again, to keep as consistent as possible with Net::Telnet and Net::Telnet::Cisco, I use the _interpret_cr&#40;&#41; sub and add it into the module.  This relates to -binmode.

I mistakenly ported my use of binmode from another module to this one.  Enabling binmode on the SSH channel doesn&#39;t seem to have an effect.  Reading the perldoc for Net::Telnet &#40;on which Net::Telnet::Cisco is based&#41;, binmode controls the CR LF translations.  It&#39;s enabled by default.

I removed the binmode setting on the SSH Channel from login&#40;&#41; - it has no effect.  Looking at the logic from Net::Telnet, CR LF translations are done on the input channel &#40;from the device to our computer&#41; only if !binmode &#40;it&#39;s counter-intuitive to me, but that&#39;s how it&#39;s done&#41;.  I emulate that behavior by enclosing my translation in a logical if&#40;&#41; test for binmode.

Note Net::Telnet also does translation on the output channel &#40;from our computer to the device&#41;, but this breaks SSH2 &#40;at least for me&#41;, so the translation routines are in print&#40;&#41; and put&#40;&#41;, but commented out.  I also updated the POD for binmode to reflect the same as Net::Telnet, excluding the output channel translation.

--

I also took some time to fix a small bug in enable&#40;&#41; and change put&#40;&#41; to print&#40;&#41; to be more consistent with Net::Telnet::Cisco behavior.

TESTING ALL OF THIS:
Attached, you&#39;ll find my test programs along with version 0.04_2 of the module &#40;rather than a patch&#41;.  Probably should have used better versioning, as the update we agree on will be on CPAN as 0.04, but anyway ...

I created some scripts to cycle through all combinations of autopage, binmode and normalize_cmd and ran the tests on both Windows 10 x64 / Strawberry Perl 5.24.1 MSWin32-x64-multi-thread and Ubuntu 16.04 64-bit / Perl 5.22.1 x86_64-linux-gnu-thread-multi.

Note:  On Windows, you&#39;ll need xxd.exe and diff.exe.

I&#39;m running against Cisco ISR4351 with IOS XE 16.03.03.

Structure:
compare.pl
dotest.bat
dotest.sh
Net-SSH2-Cisco-0.04/

From Net-SSH2-Cisco-0.04/:

&#40;Windows&#41;
../dotest.bat

&#40;Linux&#41;
bash ../dotest.sh

I got no differences &#40;good&#41; on any combination on either Windows or Linux platforms.  Note, you may see a diff on the &#39;show version&#39; output on the system uptime line depending on how the test runs fall; example:

[...]
diffs &#40;AP=0 BM=1 NC=1&#41;:
67c67
&lt; 0000420: 732c 2031 3820 6d69 6e75 7465 730d 0d0a  s, 18 minutes...
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 0000420: 732c 2031 3920 6d69 6e75 7465 730d 0d0a  s, 19 minutes...
</div>[...]

This can be safely ignored.

Please give this Cisco.pm a test in your environment and let me know results.

Thanks again!
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Cisco.pm</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> compare.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!perl

use strict;
use warnings;

my $HOST = &#39;1.1.1.1&#39;;
my $USER = &#39;cisco&#39;;
my $PASS = &#39;cisco&#39;;
my $ENPS = $PASS;

my $TYPE = $ARGV[0];
my $AP = $ARGV[1];
my $BM = $ARGV[2];
my $NC = $ARGV[3];

use Net::SSH2::Cisco;
use Net::Telnet::Cisco;

my $c = &#40;&#39;Net::&#39; . $TYPE . &#39;::Cisco&#39;&#41;-&gt;new&#40;
    host =&gt; $HOST,
    dump_log =&gt; &#39;dump-&#39; . $TYPE . &#39;.txt&#39;,
    input_log =&gt; &#39;in-&#39; . $TYPE . &#39;.txt&#39;,
    output_log =&gt; &#39;out-&#39; . $TYPE . &#39;.txt&#39;,
&#41;;
$c-&gt;login&#40;$USER, $PASS&#41;;

$c-&gt;autopage&#40;$AP&#41;;
$c-&gt;binmode&#40;$BM&#41;;
$c-&gt;normalize_cmd&#40;$NC&#41;;

my &#40;@out, $fh&#41;;
if &#40;!$AP&#41; {
    $c-&gt;cmd&#40;&#39;term len 0&#39;&#41;;
}
@out = $c-&gt;cmd&#40;&#39;show version&#39;&#41;;
open $fh, &#34;&gt;&#34;, $TYPE . &#34;-ver.log&#34;;
for &#40;@out&#41; {
    print $fh $_;
}
@out = $c-&gt;cmd&#40;&#39;disable&#39;&#41;;
@out = $c-&gt;enable&#40;$ENPS&#41;;
@out = $c-&gt;cmd&#40;&#39;show run&#39;&#41;;
open $fh, &#34;&gt;&#34;, $TYPE . &#34;-run.log&#34;;
for &#40;@out&#41; {
    print $fh $_;
}
close $fh;
$c-&gt;close;

system&#40;&#34;xxd $TYPE-run.log $TYPE-run.log.xxd&#34;&#41;;
system&#40;&#34;xxd $TYPE-ver.log $TYPE-ver.log.xxd&#34;&#41;;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dotest.bat</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1746879/939628/dotest.bat">Download dotest.bat</a><br />
<span class="downloadcontenttype">application/octet-stream 338b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dotest.sh</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1746879/939629/dotest.sh">Download dotest.sh</a><br />
<span class="downloadcontenttype">application/octet-stream 317b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;31&nbsp;11:06:14&nbsp;2017</span>
    <span class="description">eric [...] amerca.nl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #122919] Bug/improvement Net::SSH2::Cisco</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 31 Aug 2017 17:05:07 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSH2-Cisco [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Smid &lt;eric [...] amerca.nl&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Vincent,

Thanks for your explanation.
I&#39;ll do some tests next week.
I&#39;ll let you know the results.

For your information I&#39;m using the module on a Solaris system and query 
different Cisco devices.
For some reason I have trouble with commands that time-out at Cisco 
SG300 devices.
Login seems to work, but when I send a command I get no response and 
session times out.
I&#39;m not sure if the command is received at the SG300.

Not important for my current project, but if possible I want to solve 
this too.

Regards,

Eric


On 31-8-2017 16:33, Michael Vincent via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=122919">https://rt.cpan.org/Ticket/Display.html?id=122919</a></span> &gt;
&gt;
&gt; Eric,
&gt;
&gt; Thanks for you help on this.  As you can imagine, blending 2 modules &#40;Net::Telnet::Cisco with Net::SSH2&#41; while using the API from yet a third &#40;Net::Telnet to keep consistent&#41; comes with its own set of challenges.
&gt;
&gt; 1&#41;
&gt; &#34;The new substitutions cause whitespace for the first line after -- More-- to disappear.&#34;
&gt;
&gt; Yes, you&#39;re correct, I noticed that last night too.  I had a fix, but yours is more elegant; running on $buffer once all output is collected versus on each fill of $buf.
&gt;
&gt; 2&#41;
&gt; &#34;The old _normalize produces the same output for strings, which applies to $buffer.
&gt;   To let sub _normalize also produce the correct output for arrays, i changed _normalize.&#34;
&gt;
&gt; Not sure this is needed.  We pass in a string &#40;$buffer&#41;.  The original _normalize&#40;&#41; converts it to a string with the join&#40;&#41;, which I think we can both agree is a bit redundant / useless, but nonetheless.  I&#39;m trying to keep consistency between the subs I &#34;borrow&#34; from Net::Telnet and Net::Telnet::Cisco.  The only change I made to _normalize&#40;&#41; is to remove the g-modifier in the return&#40;&#41; as it generates a warning &#40;&#34;Use of /g modifier is meaningless in split&#34;&#41; - note, Net::Telnet::Cisco does not &#39;use warnings&#39; so you don&#39;t see it there.  For me, with the other changes, original _normalize&#40;&#41; works so I keep it.
&gt;
&gt; Keeping with the logic flow from Net::Telnet::Cisco, _normalize should only run it autopage&#40;&#41; is enabled so I have that as an if&#40;&#41; condition along with checking the $normal variable.
&gt;
&gt;
&gt; 3&#41;
&gt; &#34;I moved the substitution of CRLF to LF to sub waitfor.&#34;
&gt;
&gt; Yes, I agree that&#39;s where it should be.  Again, to keep as consistent as possible with Net::Telnet and Net::Telnet::Cisco, I use the _interpret_cr&#40;&#41; sub and add it into the module.  This relates to -binmode.
&gt;
&gt; I mistakenly ported my use of binmode from another module to this one.  Enabling binmode on the SSH channel doesn&#39;t seem to have an effect.  Reading the perldoc for Net::Telnet &#40;on which Net::Telnet::Cisco is based&#41;, binmode controls the CR LF translations.  It&#39;s enabled by default.
&gt;
&gt; I removed the binmode setting on the SSH Channel from login&#40;&#41; - it has no effect.  Looking at the logic from Net::Telnet, CR LF translations are done on the input channel &#40;from the device to our computer&#41; only if !binmode &#40;it&#39;s counter-intuitive to me, but that&#39;s how it&#39;s done&#41;.  I emulate that behavior by enclosing my translation in a logical if&#40;&#41; test for binmode.
&gt;
&gt; Note Net::Telnet also does translation on the output channel &#40;from our computer to the device&#41;, but this breaks SSH2 &#40;at least for me&#41;, so the translation routines are in print&#40;&#41; and put&#40;&#41;, but commented out.  I also updated the POD for binmode to reflect the same as Net::Telnet, excluding the output channel translation.
&gt;
&gt; --
&gt;
&gt; I also took some time to fix a small bug in enable&#40;&#41; and change put&#40;&#41; to print&#40;&#41; to be more consistent with Net::Telnet::Cisco behavior.
&gt;
&gt; TESTING ALL OF THIS:
&gt; Attached, you&#39;ll find my test programs along with version 0.04_2 of the module &#40;rather than a patch&#41;.  Probably should have used better versioning, as the update we agree on will be on CPAN as 0.04, but anyway ...
&gt;
&gt; I created some scripts to cycle through all combinations of autopage, binmode and normalize_cmd and ran the tests on both Windows 10 x64 / Strawberry Perl 5.24.1 MSWin32-x64-multi-thread and Ubuntu 16.04 64-bit / Perl 5.22.1 x86_64-linux-gnu-thread-multi.
&gt;
&gt; Note:  On Windows, you&#39;ll need xxd.exe and diff.exe.
&gt;
&gt; I&#39;m running against Cisco ISR4351 with IOS XE 16.03.03.
&gt;
&gt; Structure:
&gt; compare.pl
&gt; dotest.bat
&gt; dotest.sh
&gt; Net-SSH2-Cisco-0.04/
&gt;
&gt;  From Net-SSH2-Cisco-0.04/:
&gt;
&gt; &#40;Windows&#41;
&gt; ../dotest.bat
&gt;
&gt; &#40;Linux&#41;
&gt; bash ../dotest.sh
&gt;
&gt; I got no differences &#40;good&#41; on any combination on either Windows or Linux platforms.  Note, you may see a diff on the &#39;show version&#39; output on the system uptime line depending on how the test runs fall; example:
&gt;
&gt; [...]
&gt; diffs &#40;AP=0 BM=1 NC=1&#41;:
&gt; 67c67
&gt; &lt; 0000420: 732c 2031 3820 6d69 6e75 7465 730d 0d0a  s, 18 minutes...
&gt; ---
<div class="message-stanza open">&gt;&gt; 0000420: 732c 2031 3920 6d69 6e75 7465 730d 0d0a  s, 19 minutes...
</div>&gt; [...]
&gt;
&gt; This can be safely ignored.
&gt;
&gt; Please give this Cisco.pm a test in your environment and let me know results.
&gt;
&gt; Thanks again!
&gt;
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;31&nbsp;11:07:53&nbsp;2017</span>
    <span class="description">eric [...] amerca.nl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #122919] Bug/improvement Net::SSH2::Cisco</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 31 Aug 2017 17:07:39 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSH2-Cisco [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Smid &lt;eric [...] amerca.nl&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">By the way, regarding the normalize bug:

<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=118170">https://rt.cpan.org/Public/Bug/Display.html?id=118170</a></span>


On 31-8-2017 17:05, Eric Smid wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Vincent,
&gt;
&gt; Thanks for your explanation.
&gt; I&#39;ll do some tests next week.
&gt; I&#39;ll let you know the results.
&gt;
&gt; For your information I&#39;m using the module on a Solaris system and 
&gt; query different Cisco devices.
&gt; For some reason I have trouble with commands that time-out at Cisco 
&gt; SG300 devices.
&gt; Login seems to work, but when I send a command I get no response and 
&gt; session times out.
&gt; I&#39;m not sure if the command is received at the SG300.
&gt;
&gt; Not important for my current project, but if possible I want to solve 
&gt; this too.
&gt;
&gt; Regards,
&gt;
&gt; Eric
&gt;
&gt;
&gt; On 31-8-2017 16:33, Michael Vincent via RT wrote:
<div class="message-stanza open">&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=122919">https://rt.cpan.org/Ticket/Display.html?id=122919</a></span> &gt;
&gt;&gt;
&gt;&gt; Eric,
&gt;&gt;
&gt;&gt; Thanks for you help on this.  As you can imagine, blending 2 modules 
&gt;&gt; &#40;Net::Telnet::Cisco with Net::SSH2&#41; while using the API from yet a 
&gt;&gt; third &#40;Net::Telnet to keep consistent&#41; comes with its own set of 
&gt;&gt; challenges.
&gt;&gt;
&gt;&gt; 1&#41;
&gt;&gt; &#34;The new substitutions cause whitespace for the first line after -- 
&gt;&gt; More-- to disappear.&#34;
&gt;&gt;
&gt;&gt; Yes, you&#39;re correct, I noticed that last night too.  I had a fix, but 
&gt;&gt; yours is more elegant; running on $buffer once all output is 
&gt;&gt; collected versus on each fill of $buf.
&gt;&gt;
&gt;&gt; 2&#41;
&gt;&gt; &#34;The old _normalize produces the same output for strings, which 
&gt;&gt; applies to $buffer.
&gt;&gt;   To let sub _normalize also produce the correct output for arrays, i 
&gt;&gt; changed _normalize.&#34;
&gt;&gt;
&gt;&gt; Not sure this is needed.  We pass in a string &#40;$buffer&#41;.  The 
&gt;&gt; original _normalize&#40;&#41; converts it to a string with the join&#40;&#41;, which 
&gt;&gt; I think we can both agree is a bit redundant / useless, but 
&gt;&gt; nonetheless.  I&#39;m trying to keep consistency between the subs I 
&gt;&gt; &#34;borrow&#34; from Net::Telnet and Net::Telnet::Cisco.  The only change I 
&gt;&gt; made to _normalize&#40;&#41; is to remove the g-modifier in the return&#40;&#41; as 
&gt;&gt; it generates a warning &#40;&#34;Use of /g modifier is meaningless in split&#34;&#41; 
&gt;&gt; - note, Net::Telnet::Cisco does not &#39;use warnings&#39; so you don&#39;t see 
&gt;&gt; it there.  For me, with the other changes, original _normalize&#40;&#41; 
&gt;&gt; works so I keep it.
&gt;&gt;
&gt;&gt; Keeping with the logic flow from Net::Telnet::Cisco, _normalize 
&gt;&gt; should only run it autopage&#40;&#41; is enabled so I have that as an if&#40;&#41; 
&gt;&gt; condition along with checking the $normal variable.
&gt;&gt;
&gt;&gt;
&gt;&gt; 3&#41;
&gt;&gt; &#34;I moved the substitution of CRLF to LF to sub waitfor.&#34;
&gt;&gt;
&gt;&gt; Yes, I agree that&#39;s where it should be.  Again, to keep as consistent 
&gt;&gt; as possible with Net::Telnet and Net::Telnet::Cisco, I use the 
&gt;&gt; _interpret_cr&#40;&#41; sub and add it into the module.  This relates to 
&gt;&gt; -binmode.
&gt;&gt;
&gt;&gt; I mistakenly ported my use of binmode from another module to this 
&gt;&gt; one.  Enabling binmode on the SSH channel doesn&#39;t seem to have an 
&gt;&gt; effect.  Reading the perldoc for Net::Telnet &#40;on which 
&gt;&gt; Net::Telnet::Cisco is based&#41;, binmode controls the CR LF 
&gt;&gt; translations.  It&#39;s enabled by default.
&gt;&gt;
&gt;&gt; I removed the binmode setting on the SSH Channel from login&#40;&#41; - it 
&gt;&gt; has no effect.  Looking at the logic from Net::Telnet, CR LF 
&gt;&gt; translations are done on the input channel &#40;from the device to our 
&gt;&gt; computer&#41; only if !binmode &#40;it&#39;s counter-intuitive to me, but that&#39;s 
&gt;&gt; how it&#39;s done&#41;.  I emulate that behavior by enclosing my translation 
&gt;&gt; in a logical if&#40;&#41; test for binmode.
&gt;&gt;
&gt;&gt; Note Net::Telnet also does translation on the output channel &#40;from 
&gt;&gt; our computer to the device&#41;, but this breaks SSH2 &#40;at least for me&#41;, 
&gt;&gt; so the translation routines are in print&#40;&#41; and put&#40;&#41;, but commented 
&gt;&gt; out.  I also updated the POD for binmode to reflect the same as 
&gt;&gt; Net::Telnet, excluding the output channel translation.
&gt;&gt;
&gt;&gt; -- 
&gt;&gt;
&gt;&gt; I also took some time to fix a small bug in enable&#40;&#41; and change put&#40;&#41; 
&gt;&gt; to print&#40;&#41; to be more consistent with Net::Telnet::Cisco behavior.
&gt;&gt;
&gt;&gt; TESTING ALL OF THIS:
&gt;&gt; Attached, you&#39;ll find my test programs along with version 0.04_2 of 
&gt;&gt; the module &#40;rather than a patch&#41;.  Probably should have used better 
&gt;&gt; versioning, as the update we agree on will be on CPAN as 0.04, but 
&gt;&gt; anyway ...
&gt;&gt;
&gt;&gt; I created some scripts to cycle through all combinations of autopage, 
&gt;&gt; binmode and normalize_cmd and ran the tests on both Windows 10 x64 / 
&gt;&gt; Strawberry Perl 5.24.1 MSWin32-x64-multi-thread and Ubuntu 16.04 
&gt;&gt; 64-bit / Perl 5.22.1 x86_64-linux-gnu-thread-multi.
&gt;&gt;
&gt;&gt; Note:  On Windows, you&#39;ll need xxd.exe and diff.exe.
&gt;&gt;
&gt;&gt; I&#39;m running against Cisco ISR4351 with IOS XE 16.03.03.
&gt;&gt;
&gt;&gt; Structure:
&gt;&gt; compare.pl
&gt;&gt; dotest.bat
&gt;&gt; dotest.sh
&gt;&gt; Net-SSH2-Cisco-0.04/
&gt;&gt;
&gt;&gt;  From Net-SSH2-Cisco-0.04/:
&gt;&gt;
&gt;&gt; &#40;Windows&#41;
&gt;&gt; ../dotest.bat
&gt;&gt;
&gt;&gt; &#40;Linux&#41;
&gt;&gt; bash ../dotest.sh
&gt;&gt;
&gt;&gt; I got no differences &#40;good&#41; on any combination on either Windows or 
&gt;&gt; Linux platforms.  Note, you may see a diff on the &#39;show version&#39; 
&gt;&gt; output on the system uptime line depending on how the test runs fall; 
&gt;&gt; example:
&gt;&gt;
&gt;&gt; [...]
&gt;&gt; diffs &#40;AP=0 BM=1 NC=1&#41;:
&gt;&gt; 67c67
&gt;&gt; &lt; 0000420: 732c 2031 3820 6d69 6e75 7465 730d 0d0a  s, 18 minutes...
&gt;&gt; ---
<div class="message-stanza open">&gt;&gt;&gt; 0000420: 732c 2031 3920 6d69 6e75 7465 730d 0d0a  s, 19 minutes...
</div>&gt;&gt; [...]
&gt;&gt;
&gt;&gt; This can be safely ignored.
&gt;&gt;
&gt;&gt; Please give this Cisco.pm a test in your environment and let me know 
&gt;&gt; results.
&gt;&gt;
&gt;&gt; Thanks again!
&gt;&gt;
&gt;&gt;
</div>&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;31&nbsp;13:01:57&nbsp;2017</span>
    <span class="description">VINSWORLD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Aug 31 11:07:53 2017, eric@amerca.nl wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; By the way, regarding the normalize bug:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=118170">https://rt.cpan.org/Public/Bug/Display.html?id=118170</a></span>
&gt; 
&gt; 
</div>
I looked at that and applied the fix in a test version of Net::SSH2::Cisco - it also works for me.  So if Net::Telnet::Cisco ever fixes the bug &#40;note some tickets in that queue are *very* old&#41; I can apply the same fix to Net::SSH2::Cisco and it should still work.  Note that the current version of _normalize&#40;&#41; in Net::SSH2::Cisco copied from Net::Telnet::Cisco fixes the g-modifier and seems to work fine for me.

The Net::Telnet::Cisco bug may stem from the way it handles autopaging, using:
    ...SUPER::cmd&#40;String =&gt; &#34; &#34; ...
instead of just:
    ...put&#40;&#39; &#39;&#41; ...
like I do in Net::SSH2::Cisco since I&#39;m blending a few modules and put my autopaging in waitfor&#40;&#41;.

For the SG300 issue, try enabling dump_log:

my $session = Net::SSH2::Cisco-&gt;new&#40;
    host =&gt; &#39;sg300.domaind.com&#39;,
    dump_log =&gt; &#39;sg300-dump.log&#39;,
&#41;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;11&nbsp;09:52:45&nbsp;2017</span>
    <span class="description">VINSWORLD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Updated version 0.04 published to CPAN.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;11&nbsp;09:52:46&nbsp;2017</span>
    <span class="description">VINSWORLD [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;11&nbsp;09:52:46&nbsp;2017</span>
    <span class="description">VINSWORLD [...] cpan.org -  Fixed in 0.04 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
