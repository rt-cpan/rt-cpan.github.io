<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #37510 for DBIx-Class-Fixtures: Fixtures fails to dump related class if class already seen through prior relationship</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #37510 for DBIx-Class-Fixtures: Fixtures fails to dump related class if class already seen through prior relationship</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBIx-Class-Fixtures/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBIx-Class-Fixtures/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBIx-Class-Fixtures/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBIx-Class-Fixtures/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Class-Fixtures">DBIx-Class-Fixtures CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">37510</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBIx-Class-Fixtures/Active/">DBIx-Class-Fixtures</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
JJSCHUTZ [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-221070-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.001000    </td>
  </tr>
  <tr id="CF-221071-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;08&nbsp;02:42:14&nbsp;2008</span>
    <span class="description">JJSCHUTZ [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Fixtures fails to dump related class if class already seen
 through prior relationship</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Suppose A belongs to B, B might have C, C has many D.

I want to specify a particular A and naturally expect to have all its
related B, C, D dumped as well.

So json config would be:

                         has_many: {
                                   fetch: &#39;1&#39;,
                                   quantity: &#39;all&#39;
                                   },
                         might_have: {
                                   fetch: &#39;1&#39;
                                   },
                         belongs_to: {
                                   fetch: &#39;1&#39;
                                   },
        sets: [{
              class: &#39;A&#39;,
              ids: [ &#39;1&#39; ]
              }]

A, B, C get dumped; A is in &#39;sets&#39; so gets dumped first, then B gets
processed as a relationship of A, then C as a rel of B &#40;since recursive
dump options &#40;_inherited_attributes&#41; include might_have&#41; but not C&#39;s
relationships, since &#39;has_many&#39; is not an inherited attribute.  That D
is not automatically dumped is an annoyance, but not the main issue in
this bug report.

&#40;Sidenote: Adding has_many and belongs_to to _inherited_attributes
causes deep recursion - perhaps there is a better way to detect which
objects have already been processed, such as a hash of class name and
primary key, so recursion stops immediately on an already processed
object?  Then all types of relationships could be followed, maybe?&#41;


To work around this behaviour, I added &#39;C&#39; to the sets:

        sets: [{
              class: &#39;A&#39;,
              ids: [ &#39;1&#39; ]
              }, {
              class: &#39;C&#39;,
              ids: [ &#39;7&#39; ]
              }]

But still C&#39;s relationship D does not get dumped, because C has already
been dumped &#40;the &#39;exists&#39; file test in dump_object causes the
relationship recursion to be bypassed&#41;. That&#39;s the bug.

If I just specify C:

        sets: [{
              class: &#39;C&#39;,
              ids: [ &#39;7&#39; ]
              }]

then D is dumped as expected.  If C was processed first, the result
would be different, but as classes are processed in alphabetical order,
D is never dumped regardless of the ordering in &#39;sets&#39;.  Asymmetrical
behaviour!

The workaround appears to be that a rule must exist for the problem class:

        rules: {
               C: {
                       fetch: [{
                              rel: &#39;D&#39;,
                              quantity: &#39;all&#39;
                              }]
                        }
                }

but that is not obvious &#40;took me several hours to work out&#41; and not
desirable - it would be nice if it just &#34;worked&#34;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;09&nbsp;01:16:09&nbsp;2008</span>
    <span class="description">JJSCHUTZ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Please find suggested patch attached.

This implements breadth-first recursion instead of depth-first, so all
the top level items listed in &#39;sets&#39; get processed first, then related
items.

This also solved deep recursion problems that I was seeing when setting
rules to follow has_many type relationships.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- DBIx-Class-Fixtures-1.001000/lib/DBIx/Class/Fixtures.pm	2008-07-09 14:25:50.000000000 +0930
+++ DBIx-Class-Fixtures-1.001000.orig/lib/DBIx/Class/Fixtures.pm	2008-04-26 02:02:53.000000000 +0930
@@ -494,7 +494,6 @@
   $config-&gt;{rules} ||= {};
   my @sources = sort { $a-&gt;{class} cmp $b-&gt;{class} } @{delete $config-&gt;{sets}};
   my %options = &#40; is_root =&gt; 1 &#41;;
-  $self-&gt;{queue} = [];
   foreach my $source &#40;@sources&#41; {
     # apply rule to set if specified
     my $rule = $config-&gt;{rules}-&gt;{$source-&gt;{class}};
@@ -540,10 +539,6 @@
     }
   }
 
-  while &#40;my $entry = shift @{$self-&gt;{queue}}&#41; {
-      $self-&gt;dump_object&#40;@$entry&#41;;
-  }
-
   foreach my $dir &#40;$output_dir-&gt;children&#41; {
     next if &#40;$dir eq $tmp_output_dir&#41;;
     $dir-&gt;remove || $dir-&gt;rmtree;
@@ -581,8 +576,6 @@
 
   # write file
   my $exists = &#40;-e $file-&gt;stringify&#41; ? 1 : 0;
-  return if $exists;
-
   unless &#40;$exists&#41; {
     $self-&gt;msg&#40;&#39;-- dumping &#39; . $file-&gt;stringify, 2&#41;;
     my %ds = $object-&gt;get_columns;
@@ -647,7 +640,7 @@
         #		use Data::Dumper; print &#39; -- &#39; . Dumper&#40;$c_params{set}, $rule-&gt;{fetch}&#41; if &#40;$rule &#38;&#38; $rule-&gt;{fetch}&#41;;
         $c_params{set} = merge&#40; $c_params{set}, $rule&#41; if &#40;$rule &#38;&#38; $rule-&gt;{fetch}&#41;;
         #		use Data::Dumper; print &#39; -- &#39; . Dumper&#40;\%c_params&#41; if &#40;$rule &#38;&#38; $rule-&gt;{fetch}&#41;;
-        $self-&gt;_queue_object&#40;$_, \%c_params&#41; foreach $related_rs-&gt;all;	  
+        $self-&gt;dump_object&#40;$_, \%c_params&#41; foreach $related_rs-&gt;all;	  
       }	
     }
   }
@@ -675,16 +668,10 @@
     $related_rs = $related_rs-&gt;search&#40;$fetch-&gt;{cond}, { join =&gt; $fetch-&gt;{join} }&#41; if &#40;$fetch-&gt;{cond}&#41;;
     $related_rs = $related_rs-&gt;search&#40;{}, { rows =&gt; $fetch-&gt;{quantity} }&#41; if &#40;$fetch-&gt;{quantity} &#38;&#38; $fetch-&gt;{quantity} ne &#39;all&#39;&#41;;
     $related_rs = $related_rs-&gt;search&#40;{}, { order_by =&gt; $fetch-&gt;{order_by} }&#41; if &#40;$fetch-&gt;{order_by}&#41;;
-    $self-&gt;_queue_object&#40;$_, { %{$params}, set =&gt; $fetch }&#41; foreach $related_rs-&gt;all;
+    $self-&gt;dump_object&#40;$_, { %{$params}, set =&gt; $fetch }&#41; foreach $related_rs-&gt;all;
   }
 }
 
-sub _queue_object {
-    my &#40;$self, $object, @params&#41; = @_;
-
-    push&#40;@{$self-&gt;{queue}}, [ $object, @params ]&#41;;
-}
-
 sub _generate_schema {
   my $self = shift;
   my $params = shift || {};
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;09&nbsp;01:16:12&nbsp;2008</span>
    <span class="description">JJSCHUTZ [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;18&nbsp;16:23:26&nbsp;2008</span>
    <span class="description">LSAUNDERS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jul 09 01:16:09 2008, JJSCHUTZ wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please find suggested patch attached.
&gt; 
&gt; This implements breadth-first recursion instead of depth-first, so all
&gt; the top level items listed in &#39;sets&#39; get processed first, then related
&gt; items.
&gt; 
&gt; This also solved deep recursion problems that I was seeing when setting
&gt; rules to follow has_many type relationships.
</div>
Thanks for the patch. However I don&#39;t think it is acceptable to simply
return if the object already exists as the relationship settings may be
different on subsequent passes. So we still need to look at its
relations each time it&#39;s attempted to be dumped. For example:

A has_many B
B has_many C
B has_many D

sets: [{
  class: &#39;A&#39;,
  ids: [ &#39;1&#39; ],
  fetch: [{
    rel: &#39;b&#39;,
    quantity: &#39;all&#39;,
    fetch: [{
      rel: &#39;c&#39;,
      quantity: &#39;all&#39;
    }]
  }]
}, {
  class: &#39;B&#39;,
  quantity: &#39;all&#39;,
  fetch: [{
    rel: &#39;d&#39;,
    quantity: &#39;all&#39;
  }]
}]

The first set here dumps some &#39;B&#39; objects and all of their &#39;C&#39;
relations. The second set dumps all &#39;B&#39; objects and all of their &#39;D&#39;
relations. If we skip processing of an object that has already been
dumped then the &#39;B&#39; objects from the first set wouldn&#39;t have both their
&#39;c&#39; and &#39;d&#39; relations dumped as is expected.

I think the problem you illustrate is that the general has_many,
belongs_to and might_have relations are ignored if an object has already
been dumped whereas the &#39;fetch&#39; relations are processed anyway. However
allowing these rels to be processed repeatedly is going to cause even
more recursion problems I suspect.

I agree entirely that it would be nice if the has_many setting were
inherited, but we need to be smart about it. I think the solution is
that instead of just returning if the object exists, some extra check
should be made to determine if there&#39;s anything new in the set config
and if so just process the new rels, otherwise return. 

I hope that makes sense. And I&#39;m sorry that you had to go digging around
to such a degree.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
