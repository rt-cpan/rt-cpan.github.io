<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #115697 for Net-SSLeay: generate EC keys  with Net::SSLeay, similar to RSA keys - working patch included</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #115697 for Net-SSLeay: generate EC keys  with Net::SSLeay, similar to RSA keys - working patch included</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-SSLeay/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SSLeay">Net-SSLeay CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">115697</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-SSLeay/Active/">Net-SSLeay</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">MIKEM [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Steffen_Ullrich [...] genua.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-44414-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-44415-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.75    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;28&nbsp;11:23:28&nbsp;2016</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> generate EC keys  with Net::SSLeay, similar to RSA keys - working
 patch included</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,
Given that ECDSA certificates get more important it would be nice if Net::SSLeay has an easy way to create the necessary keys, similar to how it works with RSA keys. 

The attached patch implements a function EC_KEY_generate_key similar to RSA_generate_key and a function EVP_PKEY_assign_EC_KEY similar to EVP_PKEY_assign_RSA. Using these functions it is easy to create and use EC keys in the same way as RSA keys.

Support for this functionality based on this patch is already included in a pre-release of IO::Socket::SSL::Utils and it makes it possible to easily create EC keys and ECDSA certificates on the fly: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/noxxi/p5-io-socket-ssl/commit/781c5a54">https://github.com/noxxi/p5-io-socket-ssl/commit/781c5a54</a></span>. 

It would be nice if the patch would be included in the next version of Net::SSLeay.
Regards,
Steffen
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SSLeay.xs.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: SSLeay.xs
===================================================================
--- SSLeay.xs	&#40;revision 466&#41;
+++ SSLeay.xs	&#40;working copy&#41;
@@ -4640,10 +4640,51 @@
     EC_KEY * key
 
 long
-SSL_CTX_set_tmp_ecdh&#40;ctx,ecdh&#41;;
+SSL_CTX_set_tmp_ecdh&#40;ctx,ecdh&#41;
      SSL_CTX *	ctx
      EC_KEY  *	ecdh
 
+int
+EVP_PKEY_assign_EC_KEY&#40;pkey,key&#41;
+    EVP_PKEY *  pkey
+    EC_KEY *    key
+
+
+EC_KEY *
+EC_KEY_generate_key&#40;curve&#41;
+	SV *curve;
+    CODE:
+	EC_GROUP *group = NULL;
+	EC_KEY *eckey = NULL;
+	int nid;
+
+	RETVAL = 0;
+	if &#40;SvIOK&#40;curve&#41;&#41; {
+	    nid = SvIV&#40;curve&#41;;
+	} else {
+	    nid = OBJ_sn2nid&#40;SvPV_nolen&#40;curve&#41;&#41;;
+	    if &#40;!nid&#41; nid = EC_curve_nist2nid&#40;SvPV_nolen&#40;curve&#41;&#41;;
+	    if &#40;!nid&#41; croak&#40;&#34;unkown curve %s&#34;,SvPV_nolen&#40;curve&#41;&#41;;
+	}
+
+	group = EC_GROUP_new_by_curve_name&#40;nid&#41;;
+	if &#40;!group&#41; croak&#40;&#34;unkown curve nid=%d&#34;,nid&#41;;
+	EC_GROUP_set_asn1_flag&#40;group,OPENSSL_EC_NAMED_CURVE&#41;;
+
+	eckey = EC_KEY_new&#40;&#41;;
+	if &#40; eckey
+	    &#38;&#38; EC_KEY_set_group&#40;eckey, group&#41;
+	    &#38;&#38; EC_KEY_generate_key&#40;eckey&#41;&#41; {
+	    RETVAL = eckey;
+	} else {
+	    if &#40;eckey&#41; EC_KEY_free&#40;eckey&#41;;
+	}
+	if &#40;group&#41; EC_GROUP_free&#40;group&#41;;
+
+    OUTPUT:
+	RETVAL
+
+
 #endif
 
 void *
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;28&nbsp;19:30:18&nbsp;2016</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #115697] generate EC keys  with Net::SSLeay, similar to RSA keys - working  patch included</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 29 Jun 2016 09:30:03 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Steffen,

thanks for your patch.

If you can send a patch with documentation and a test suite it will make it 
easier to consider adding.

BTW, have you see my Crypt-OpenSSL-ECDSA? Would it suit your needs instead?

Cheers.


On Tuesday, June 28, 2016 11:23:29 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Tue Jun 28 11:23:28 2016: Request 115697 was acted upon.
&gt; Transaction: Ticket created by SULLR
&gt;        Queue: Net-SSLeay
&gt;      Subject: generate EC keys  with Net::SSLeay, similar to RSA keys -
&gt; working patch included
&gt;    Broken in: &#40;no value&#41;
&gt;     Severity: Wishlist
&gt;        Owner: Nobody
&gt;   Requestors: Steffen_Ullrich@genua.de
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=115697">https://rt.cpan.org/Ticket/Display.html?id=115697</a></span> &gt;
&gt; 
&gt; 
&gt; Hi,
&gt; Given that ECDSA certificates get more important it would be nice if
&gt; Net::SSLeay has an easy way to create the necessary keys, similar to how it
&gt; works with RSA keys.
&gt; 
&gt; The attached patch implements a function EC_KEY_generate_key similar to
&gt; RSA_generate_key and a function EVP_PKEY_assign_EC_KEY similar to
&gt; EVP_PKEY_assign_RSA. Using these functions it is easy to create and use EC
&gt; keys in the same way as RSA keys.
&gt; 
&gt; Support for this functionality based on this patch is already included in a
&gt; pre-release of IO::Socket::SSL::Utils and it makes it possible to easily
&gt; create EC keys and ECDSA certificates on the fly:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/noxxi/p5-io-socket-ssl/commit/781c5a54">https://github.com/noxxi/p5-io-socket-ssl/commit/781c5a54</a></span>.
&gt; 
&gt; It would be nice if the patch would be included in the next version of
&gt; Net::SSLeay. Regards,
&gt; Steffen
</div>
-- 
Mike McCauley           VK4AMM                   mikem@airspayce.com
Airspayce Pty Ltd 9 Bulbul Place Currumbin Waters QLD 4223 Australia   
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.airspayce.com">http://www.airspayce.com</a></span>
Phone +61 7 5598-7474
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;28&nbsp;19:30:19&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;29&nbsp;02:12:33&nbsp;2016</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Di 28. Jun 2016, 19:30:18, mikem@airspayce.com schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Steffen,
&gt; 
&gt; thanks for your patch.
&gt; 
&gt; If you can send a patch with documentation and a test suite it will
&gt; make it
&gt; easier to consider adding.
</div>
You are damn right :&#41;
The attached new patch adds test and documentation. It contains also fixes for the documentation of EVP_PKEY_assign_RSA which referred to EVP_PKEY_set1_RSA instead of EVP_PKEY_assign_RSA and thus suggested that the reference counter got increased.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; BTW, have you see my Crypt-OpenSSL-ECDSA? Would it suit your needs
&gt; instead?
</div>
Yes, I&#39;ve had a look and Crypt::OpenSSL::ECDSA does not offer the functionality. But Crypt::OpenSSL::EC offers at least the functionality to create a EC_KEY but misses a way to make a EVP_PKEY out of it which is needed to use this key for creating a certificate or for direct use in IO::Socket::SSL.  
Apart from that Crypt::OpenSSL::EC creates objects which gets automatically destroyed when out of scope. While this is definitely a nice thing it does not fit well when used together with Net::SSLeay where everything must be explicitly freed. So this would get very confusing for a developer in which case a XXX_dup call is needed and when not.

That&#39;s why I suggest to make a simple way to create a EC_KEY in Net::SSLeay. For the more complex setups Crypt::OpenSSL::EC is the right choice and when combining Crypt::OpenSSL::EC::dup with the new Net::SSLeay::EVP_PKEY_assign_EC_KEY one could even use the more complex EC key setups together with Net::SSLeay. 

Regards,
Steffen
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SSLeay.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: SSLeay.xs
===================================================================
--- SSLeay.xs	&#40;revision 466&#41;
+++ SSLeay.xs	&#40;working copy&#41;
@@ -4640,10 +4640,51 @@
     EC_KEY * key
 
 long
-SSL_CTX_set_tmp_ecdh&#40;ctx,ecdh&#41;;
+SSL_CTX_set_tmp_ecdh&#40;ctx,ecdh&#41;
      SSL_CTX *	ctx
      EC_KEY  *	ecdh
 
+int
+EVP_PKEY_assign_EC_KEY&#40;pkey,key&#41;
+    EVP_PKEY *  pkey
+    EC_KEY *    key
+
+
+EC_KEY *
+EC_KEY_generate_key&#40;curve&#41;
+	SV *curve;
+    CODE:
+	EC_GROUP *group = NULL;
+	EC_KEY *eckey = NULL;
+	int nid;
+
+	RETVAL = 0;
+	if &#40;SvIOK&#40;curve&#41;&#41; {
+	    nid = SvIV&#40;curve&#41;;
+	} else {
+	    nid = OBJ_sn2nid&#40;SvPV_nolen&#40;curve&#41;&#41;;
+	    if &#40;!nid&#41; nid = EC_curve_nist2nid&#40;SvPV_nolen&#40;curve&#41;&#41;;
+	    if &#40;!nid&#41; croak&#40;&#34;unkown curve %s&#34;,SvPV_nolen&#40;curve&#41;&#41;;
+	}
+
+	group = EC_GROUP_new_by_curve_name&#40;nid&#41;;
+	if &#40;!group&#41; croak&#40;&#34;unkown curve nid=%d&#34;,nid&#41;;
+	EC_GROUP_set_asn1_flag&#40;group,OPENSSL_EC_NAMED_CURVE&#41;;
+
+	eckey = EC_KEY_new&#40;&#41;;
+	if &#40; eckey
+	    &#38;&#38; EC_KEY_set_group&#40;eckey, group&#41;
+	    &#38;&#38; EC_KEY_generate_key&#40;eckey&#41;&#41; {
+	    RETVAL = eckey;
+	} else {
+	    if &#40;eckey&#41; EC_KEY_free&#40;eckey&#41;;
+	}
+	if &#40;group&#41; EC_GROUP_free&#40;group&#41;;
+
+    OUTPUT:
+	RETVAL
+
+
 #endif
 
 void *
Index: lib/Net/SSLeay.pod
===================================================================
--- lib/Net/SSLeay.pod	&#40;revision 466&#41;
+++ lib/Net/SSLeay.pod	&#40;working copy&#41;
@@ -1395,8 +1395,8 @@
 
 Set the key referenced by $pkey to $key
 
-B&lt;NOTE:&gt; In accordance with the OpenSSL naming convention the $key assigned
-to the $pkey using the &#34;1&#34; functions must be freed as well as $pkey.
+B&lt;NOTE:&gt; No reference counter will be increased, i.e. $key will be freed if
+$pkey is freed.
 
  my $rv = Net::SSLeay::EVP_PKEY_assign_RSA&#40;$pkey, $key&#41;;
  # $pkey - value corresponding to openssl&#39;s EVP_PKEY structure
@@ -1404,8 +1404,26 @@
  #
  # returns: 1 on success, 0 on failure
 
-Check openssl doc L&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/EVP_PKEY_set1_RSA.html">http://www.openssl.org/docs/crypto/EVP_PKEY_set1_RSA.html</a></span>|<span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/EVP_PKEY_set1_RSA.html">http://www.openssl.org/docs/crypto/EVP_PKEY_set1_RSA.html</a></span>&gt;
+Check openssl doc L&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/EVP_PKEY_assign_RSA.html">http://www.openssl.org/docs/crypto/EVP_PKEY_assign_RSA.html</a></span>|<span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/EVP_PKEY_assign_RSA.html">http://www.openssl.org/docs/crypto/EVP_PKEY_assign_RSA.html</a></span>&gt;
 
+=item * EVP_PKEY_assign_EC_KEY
+
+B&lt;COMPATIBILITY:&gt; not available in Net-SSLeay-1.74 and before
+
+Set the key referenced by $pkey to $key
+
+B&lt;NOTE:&gt; No reference counter will be increased, i.e. $key will be freed if
+$pkey is freed.
+
+ my $rv = Net::SSLeay::EVP_PKEY_assign_EC_KEY&#40;$pkey, $key&#41;;
+ # $pkey - value corresponding to openssl&#39;s EVP_PKEY structure
+ # $key - value corresponding to openssl&#39;s EC_KEY structure
+ #
+ # returns: 1 on success, 0 on failure
+
+Check openssl doc L&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/EVP_PKEY_assign_EC_KEY.html">http://www.openssl.org/docs/crypto/EVP_PKEY_assign_EC_KEY.html</a></span>|<span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/EVP_PKEY_assign_EC_KEY.html">http://www.openssl.org/docs/crypto/EVP_PKEY_assign_EC_KEY.html</a></span>&gt;
+
+
 =item * EVP_PKEY_bits
 
 B&lt;COMPATIBILITY:&gt; not available in Net-SSLeay-1.45 and before
@@ -7995,6 +8013,23 @@
 
 TBA
 
+=item * EC_KEY_generate_key
+
+Generates a EC key and returns it in a newly allocated EC_KEY structure.
+The EC key then can be used to create a PKEY which can be used in calls
+like X509_set_pubkey.
+
+ my $key = Net::SSLeay::EVP_PKEY_new&#40;&#41;;
+ my $ec  = Net::SSLeay::EC_KEY_generate_key&#40;$curve&#41;;
+ Net::SSLeay::EVP_PKEY_assign_EC_KEY&#40;$key,$ec&#41;;
+
+ # $curve - curve name like &#39;secp521r1&#39; or the matching Id &#40;integer&#41; of the curve
+ #
+ # returns: value corresponding to openssl&#39;s EC_KEY structure &#40;0 on failure&#41;
+
+This function has no equivalent in OpenSSL but combines multiple OpenSSL
+functions for an easier interface.
+
 =back
 
 
Index: t/local/63_ec_key_generate_key.t
===================================================================
--- t/local/63_ec_key_generate_key.t	&#40;nonexistent&#41;
+++ t/local/63_ec_key_generate_key.t	&#40;working copy&#41;
@@ -0,0 +1,36 @@
+#!/usr/bin/perl
+
+use strict;
+use warnings;
+use Test::More;
+use Net::SSLeay;
+
+if &#40;!defined &#38;Net::SSLeay::EC_KEY_generate_key&#41; {
+    plan skip_all =&gt; &#34;no suport for ECC in your OpenSSL&#34;;
+    exit&#40;0&#41;;
+}
+
+plan tests =&gt; 4;
+
+Net::SSLeay::randomize&#40;&#41;;
+Net::SSLeay::load_error_strings&#40;&#41;;
+Net::SSLeay::ERR_load_crypto_strings&#40;&#41;;
+Net::SSLeay::SSLeay_add_ssl_algorithms&#40;&#41;;
+
+my $ec = Net::SSLeay::EC_KEY_generate_key&#40;&#39;prime256v1&#39;&#41;;
+ok&#40;$ec,&#39;EC key created&#39;&#41;;
+
+if &#40;$ec&#41; {
+    my $key = Net::SSLeay::EVP_PKEY_new&#40;&#41;;
+    my $rv = Net::SSLeay::EVP_PKEY_assign_EC_KEY&#40;$key,$ec&#41;;
+    ok&#40;$rv,&#39;EC key assigned to PKEY&#39;&#41;;
+
+    my $pem = Net::SSLeay::PEM_get_string_PrivateKey&#40;$key&#41;;
+    ok&#40; $pem =~m{^---.* PRIVATE KEY}m, &#34;output key as PEM&#34;&#41;;
+
+    my $bio = Net::SSLeay::BIO_new&#40; Net::SSLeay::BIO_s_mem&#40;&#41;&#41;;
+    Net::SSLeay::BIO_write&#40;$bio,$pem&#41;;
+    my $newkey = Net::SSLeay::PEM_read_bio_PrivateKey&#40;$bio&#41;;
+    ok&#40;$newkey,&#34;read key again from PEM&#34;&#41;;
+}
+
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;29&nbsp;20:33:15&nbsp;2016</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #115697] generate EC keys  with Net::SSLeay, similar to RSA keys - working patch included</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 30 Jun 2016 10:32:59 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Steffen,

thanks for the full patch.
But:

I dont think the conditionals around EC_KEY_generate_key and friends are 
correct:

#if OPENSSL_VERSION_NUMBER &gt; 0x10000000L &#38;&#38; !defined OPENSSL_NO_EC

but when I build your patch with OpenSSL 1.0.1k 8 Jan 2015
I get:

SSLeay.xs:4666:6: warning: implicit declaration of function 
‘EC_curve_nist2nid’ [-Wimplicit-function-declaration]
      if &#40;!nid&#41; nid = EC_curve_nist2nid&#40;SvPV_nolen&#40;curve&#41;&#41;;

and a subsequent link error on the same symbol

and indeed EC_curve_nist2nid is not present in my 1.0.1k headers and library.

It builds OK and tests OK with 1.0.2x

According to this:
<span class="clickylink"><a target="new" rel="nofollow" href="http://permalink.gmane.org/gmane.comp.encryption.openssl.cvs/13181">http://permalink.gmane.org/gmane.comp.encryption.openssl.cvs/13181</a></span>

EC_curve_nist2nid was added in 1.0.2

Is there a better/different solution? Or does it really need to be conditional 
on 1.0.2, not 1.0


Cheers.

On Wednesday, June 29, 2016 02:12:35 AM Steffen Ullrich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=115697">https://rt.cpan.org/Ticket/Display.html?id=115697</a></span> &gt;
&gt; 
&gt; Am Di 28. Jun 2016, 19:30:18, mikem@airspayce.com schrieb:
<div class="message-stanza open">&gt; &gt; Hi Steffen,
&gt; &gt; 
&gt; &gt; thanks for your patch.
&gt; &gt; 
&gt; &gt; If you can send a patch with documentation and a test suite it will
&gt; &gt; make it
&gt; &gt; easier to consider adding.
</div>&gt; 
&gt; You are damn right :&#41;
&gt; The attached new patch adds test and documentation. It contains also fixes
&gt; for the documentation of EVP_PKEY_assign_RSA which referred to
&gt; EVP_PKEY_set1_RSA instead of EVP_PKEY_assign_RSA and thus suggested that
&gt; the reference counter got increased.
<div class="message-stanza open">&gt; &gt; BTW, have you see my Crypt-OpenSSL-ECDSA? Would it suit your needs
&gt; &gt; instead?
</div>&gt; 
&gt; Yes, I&#39;ve had a look and Crypt::OpenSSL::ECDSA does not offer the
&gt; functionality. But Crypt::OpenSSL::EC offers at least the functionality to
&gt; create a EC_KEY but misses a way to make a EVP_PKEY out of it which is
&gt; needed to use this key for creating a certificate or for direct use in
&gt; IO::Socket::SSL. Apart from that Crypt::OpenSSL::EC creates objects which
&gt; gets automatically destroyed when out of scope. While this is definitely a
&gt; nice thing it does not fit well when used together with Net::SSLeay where
&gt; everything must be explicitly freed. So this would get very confusing for a
&gt; developer in which case a XXX_dup call is needed and when not.
&gt; 
&gt; That&#39;s why I suggest to make a simple way to create a EC_KEY in Net::SSLeay.
&gt; For the more complex setups Crypt::OpenSSL::EC is the right choice and when
&gt; combining Crypt::OpenSSL::EC::dup with the new
&gt; Net::SSLeay::EVP_PKEY_assign_EC_KEY one could even use the more complex EC
&gt; key setups together with Net::SSLeay.
&gt; 
&gt; Regards,
&gt; Steffen
</div>
-- 
Mike McCauley           VK4AMM                   mikem@airspayce.com
Airspayce Pty Ltd 9 Bulbul Place Currumbin Waters QLD 4223 Australia   
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.airspayce.com">http://www.airspayce.com</a></span>
Phone +61 7 5598-7474
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;30&nbsp;03:57:25&nbsp;2016</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Is there a better/different solution? Or does it really need to be
&gt; conditional
&gt; on 1.0.2, not 1.0
</div>
It looks like that EC_curve_nist2nid was added with 1.0.2 but that the code works too, if EC_curve_nist2nid is not used, only that it will not know about the NIST curves. I&#39;ve updated the patch so that it will use EC_curve_nist2nid with 1.0.2 and skip it otherwise. Tested with OpenSSL 1.0.1 too.

Regards,
Steffen
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SSLeay.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: SSLeay.xs
===================================================================
--- SSLeay.xs	&#40;revision 466&#41;
+++ SSLeay.xs	&#40;working copy&#41;
@@ -4640,12 +4640,55 @@
     EC_KEY * key
 
 long
-SSL_CTX_set_tmp_ecdh&#40;ctx,ecdh&#41;;
+SSL_CTX_set_tmp_ecdh&#40;ctx,ecdh&#41;
      SSL_CTX *	ctx
      EC_KEY  *	ecdh
 
+int
+EVP_PKEY_assign_EC_KEY&#40;pkey,key&#41;
+    EVP_PKEY *  pkey
+    EC_KEY *    key
+
+
+EC_KEY *
+EC_KEY_generate_key&#40;curve&#41;
+	SV *curve;
+    CODE:
+	EC_GROUP *group = NULL;
+	EC_KEY *eckey = NULL;
+	int nid;
+
+	RETVAL = 0;
+	if &#40;SvIOK&#40;curve&#41;&#41; {
+	    nid = SvIV&#40;curve&#41;;
+	} else {
+	    nid = OBJ_sn2nid&#40;SvPV_nolen&#40;curve&#41;&#41;;
+#if OPENSSL_VERSION_NUMBER &gt; 0x10002000L
+	    if &#40;!nid&#41; nid = EC_curve_nist2nid&#40;SvPV_nolen&#40;curve&#41;&#41;;
 #endif
+	    if &#40;!nid&#41; croak&#40;&#34;unkown curve %s&#34;,SvPV_nolen&#40;curve&#41;&#41;;
+	}
 
+	group = EC_GROUP_new_by_curve_name&#40;nid&#41;;
+	if &#40;!group&#41; croak&#40;&#34;unkown curve nid=%d&#34;,nid&#41;;
+	EC_GROUP_set_asn1_flag&#40;group,OPENSSL_EC_NAMED_CURVE&#41;;
+
+	eckey = EC_KEY_new&#40;&#41;;
+	if &#40; eckey
+	    &#38;&#38; EC_KEY_set_group&#40;eckey, group&#41;
+	    &#38;&#38; EC_KEY_generate_key&#40;eckey&#41;&#41; {
+	    RETVAL = eckey;
+	} else {
+	    if &#40;eckey&#41; EC_KEY_free&#40;eckey&#41;;
+	}
+	if &#40;group&#41; EC_GROUP_free&#40;group&#41;;
+
+    OUTPUT:
+	RETVAL
+
+
+#endif
+
 void *
 SSL_get_app_data&#40;s&#41;
      SSL *	s
Index: inc/Module/Install/PRIVATE/Net/SSLeay.pm
===================================================================
--- inc/Module/Install/PRIVATE/Net/SSLeay.pm	&#40;revision 466&#41;
+++ inc/Module/Install/PRIVATE/Net/SSLeay.pm	&#40;working copy&#41;
@@ -1,5 +1,6 @@
 #line 1
 #line 1
+#line 1
 package Module::Install::PRIVATE::Net::SSLeay;
 
 use strict;
@@ -68,7 +69,7 @@
     for &#40;&#34;$prefix/include&#34;, &#34;$prefix/inc32&#34;, &#39;/usr/kerberos/include&#39;&#41; {
       push @{$opts-&gt;{inc_paths}}, $_ if -f &#34;$_/openssl/ssl.h&#34;;
     }
-    for &#40;$prefix, &#34;$prefix/lib64&#34;, &#34;$prefix/lib&#34;, &#34;$prefix/out32dll&#34;&#41; {
+    for &#40;$prefix, &#34;$prefix/lib&#34;, &#34;$prefix/out32dll&#34;&#41; {
       push @{$opts-&gt;{lib_paths}}, $_ if -d $_;
     }
 
@@ -96,10 +97,11 @@
         @pairs = &#40;[&#39;libeay32&#39;,&#39;ssleay32&#39;],[&#39;libeay32MD&#39;,&#39;ssleay32MD&#39;],[&#39;libeay32MT&#39;,&#39;ssleay32MT&#39;]&#41; if $Config{cc} =~ /cl/;
         for my $dir &#40;@{$opts-&gt;{lib_paths}}&#41; {
           for my $p &#40;@pairs&#41; {
-            $found = 1 if &#40;$Config{cc} =~ /gcc/ &#38;&#38; -f &#34;$dir/lib$p-&gt;[0].a&#34; &#38;&#38; -f &#34;$dir/lib$p-&gt;[1].a&#34;&#41;;
-            $found = 1 if &#40;$Config{cc} =~ /cl/ &#38;&#38; -f &#34;$dir/$p-&gt;[0].lib&#34; &#38;&#38; -f &#34;$dir/p-&gt;[1].lib&#34;&#41;;
+            my &#40;$s_lib_found, $s_lib_found&#41;;
+            $found = 1 if $Config{cc} =~ /gcc/ &#38;&#38; -f &#34;$dir/lib$p-&gt;[0].a&#34; &#38;&#38; -f &#34;$dir/lib$p-&gt;[1].a&#34;;
+            $found = 1 if $Config{cc} =~ /cl/ &#38;&#38; -f &#34;$dir/$p-&gt;[0].lib&#34; &#38;&#38; -f &#34;$dir/$p-&gt;[1].lib&#34;;
             if &#40;$found&#41; {
-              $opts-&gt;{lib_links} = [$p-&gt;[0], $p-&gt;[1], &#39;crypt32&#39;]; # Some systems need this system lib crypt32 too
+              $opts-&gt;{lib_links} = [$p-&gt;[0], $p-&gt;[1]];
               $opts-&gt;{lib_paths} = [$dir];
               last;
             }
@@ -107,7 +109,7 @@
         }
         if &#40;!$found&#41; {
           #fallback to the old behaviour
-          push @{ $opts-&gt;{lib_links} }, qw&#40; libeay32MD ssleay32MD libeay32 ssleay32 libssl32 crypt32&#41;;
+          push @{ $opts-&gt;{lib_links} }, qw&#40; libeay32MD ssleay32MD libeay32 ssleay32 libssl32&#41;;
         }
     }
     elsif &#40;$^O eq &#39;VMS&#39;&#41; {
@@ -138,12 +140,7 @@
             $opts-&gt;{cccdlflags} .= &#39;-fPIC&#39;;
         }
     }
-    # From HMBRAND to handle multple version of OPENSSL installed
-    if &#40;my $lp = join &#34; &#34; =&gt; map { &#34;-L$_&#34; } @{$opts-&gt;{lib_paths} || []}&#41; 
-    {
-	my $mma = $self-&gt;makemaker_args;
-	&#40;$mma-&gt;{uc $_} = $Config{$_}&#41; =~ s/-L/$lp -L/ for qw&#40; lddlflags ldflags &#41;;
-    }
+
     return $opts;
 }
 
@@ -179,23 +176,19 @@
     }
 
     my @guesses = &#40;
-	&#39;/usr/local/opt/openssl/bin/openssl&#39; =&gt; &#39;/usr/local/opt/openssl&#39;, # OSX homebrew openssl
-	&#39;/usr/local/bin/openssl&#39;         =&gt; &#39;/usr/local&#39;, # OSX homebrew openssl
-	&#39;/opt/local/bin/openssl&#39;         =&gt; &#39;/opt/local&#39;, # Macports openssl
-	&#39;/usr/bin/openssl&#39;               =&gt; &#39;/usr&#39;,
-	&#39;/usr/sbin/openssl&#39;              =&gt; &#39;/usr&#39;,
-	&#39;/opt/ssl/bin/openssl&#39;           =&gt; &#39;/opt/ssl&#39;,
-	&#39;/opt/ssl/sbin/openssl&#39;          =&gt; &#39;/opt/ssl&#39;,
-	&#39;/usr/local/ssl/bin/openssl&#39;     =&gt; &#39;/usr/local/ssl&#39;,
-	&#39;/usr/local/openssl/bin/openssl&#39; =&gt; &#39;/usr/local/openssl&#39;,
-	&#39;/apps/openssl/std/bin/openssl&#39;  =&gt; &#39;/apps/openssl/std&#39;,
-	&#39;/usr/sfw/bin/openssl&#39;           =&gt; &#39;/usr/sfw&#39;, # Open Solaris
-	&#39;C:\OpenSSL\bin\openssl.exe&#39;     =&gt; &#39;C:\OpenSSL&#39;,
-	&#39;C:\OpenSSL-Win32\bin\openssl.exe&#39;        =&gt; &#39;C:\OpenSSL-Win32&#39;,
-	$Config{prefix} . &#39;\bin\openssl.exe&#39;      =&gt; $Config{prefix},           # strawberry perl
-	$Config{prefix} . &#39;\..\c\bin\openssl.exe&#39; =&gt; $Config{prefix} . &#39;\..\c&#39;, # strawberry perl
-	&#39;/sslexe/openssl.exe&#39;            =&gt; &#39;/sslroot&#39;,  # VMS, openssl.org
-	&#39;/ssl$exe/openssl.exe&#39;           =&gt; &#39;/ssl$root&#39;, # VMS, HP install
+            &#39;/usr/bin/openssl&#39;               =&gt; &#39;/usr&#39;,
+            &#39;/usr/sbin/openssl&#39;              =&gt; &#39;/usr&#39;,
+            &#39;/opt/ssl/bin/openssl&#39;           =&gt; &#39;/opt/ssl&#39;,
+            &#39;/opt/ssl/sbin/openssl&#39;          =&gt; &#39;/opt/ssl&#39;,
+            &#39;/usr/local/ssl/bin/openssl&#39;     =&gt; &#39;/usr/local/ssl&#39;,
+            &#39;/usr/local/openssl/bin/openssl&#39; =&gt; &#39;/usr/local/openssl&#39;,
+            &#39;/apps/openssl/std/bin/openssl&#39;  =&gt; &#39;/apps/openssl/std&#39;,
+            &#39;/usr/sfw/bin/openssl&#39;           =&gt; &#39;/usr/sfw&#39;, # Open Solaris
+            &#39;C:\OpenSSL\bin\openssl.exe&#39;     =&gt; &#39;C:\OpenSSL&#39;,
+            $Config{prefix} . &#39;\bin\openssl.exe&#39;      =&gt; $Config{prefix},           # strawberry perl
+            $Config{prefix} . &#39;\..\c\bin\openssl.exe&#39; =&gt; $Config{prefix} . &#39;\..\c&#39;, # strawberry perl
+            &#39;/sslexe/openssl.exe&#39;            =&gt; &#39;/sslroot&#39;,  # VMS, openssl.org
+            &#39;/ssl$exe/openssl.exe&#39;           =&gt; &#39;/ssl$root&#39;, # VMS, HP install
     &#41;;
 
     while &#40;my $k = shift @guesses
Index: lib/Net/SSLeay.pod
===================================================================
--- lib/Net/SSLeay.pod	&#40;revision 466&#41;
+++ lib/Net/SSLeay.pod	&#40;working copy&#41;
@@ -1395,8 +1395,8 @@
 
 Set the key referenced by $pkey to $key
 
-B&lt;NOTE:&gt; In accordance with the OpenSSL naming convention the $key assigned
-to the $pkey using the &#34;1&#34; functions must be freed as well as $pkey.
+B&lt;NOTE:&gt; No reference counter will be increased, i.e. $key will be freed if
+$pkey is freed.
 
  my $rv = Net::SSLeay::EVP_PKEY_assign_RSA&#40;$pkey, $key&#41;;
  # $pkey - value corresponding to openssl&#39;s EVP_PKEY structure
@@ -1404,8 +1404,26 @@
  #
  # returns: 1 on success, 0 on failure
 
-Check openssl doc L&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/EVP_PKEY_set1_RSA.html">http://www.openssl.org/docs/crypto/EVP_PKEY_set1_RSA.html</a></span>|<span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/EVP_PKEY_set1_RSA.html">http://www.openssl.org/docs/crypto/EVP_PKEY_set1_RSA.html</a></span>&gt;
+Check openssl doc L&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/EVP_PKEY_assign_RSA.html">http://www.openssl.org/docs/crypto/EVP_PKEY_assign_RSA.html</a></span>|<span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/EVP_PKEY_assign_RSA.html">http://www.openssl.org/docs/crypto/EVP_PKEY_assign_RSA.html</a></span>&gt;
 
+=item * EVP_PKEY_assign_EC_KEY
+
+B&lt;COMPATIBILITY:&gt; not available in Net-SSLeay-1.74 and before
+
+Set the key referenced by $pkey to $key
+
+B&lt;NOTE:&gt; No reference counter will be increased, i.e. $key will be freed if
+$pkey is freed.
+
+ my $rv = Net::SSLeay::EVP_PKEY_assign_EC_KEY&#40;$pkey, $key&#41;;
+ # $pkey - value corresponding to openssl&#39;s EVP_PKEY structure
+ # $key - value corresponding to openssl&#39;s EC_KEY structure
+ #
+ # returns: 1 on success, 0 on failure
+
+Check openssl doc L&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/EVP_PKEY_assign_EC_KEY.html">http://www.openssl.org/docs/crypto/EVP_PKEY_assign_EC_KEY.html</a></span>|<span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/EVP_PKEY_assign_EC_KEY.html">http://www.openssl.org/docs/crypto/EVP_PKEY_assign_EC_KEY.html</a></span>&gt;
+
+
 =item * EVP_PKEY_bits
 
 B&lt;COMPATIBILITY:&gt; not available in Net-SSLeay-1.45 and before
@@ -7995,6 +8013,23 @@
 
 TBA
 
+=item * EC_KEY_generate_key
+
+Generates a EC key and returns it in a newly allocated EC_KEY structure.
+The EC key then can be used to create a PKEY which can be used in calls
+like X509_set_pubkey.
+
+ my $key = Net::SSLeay::EVP_PKEY_new&#40;&#41;;
+ my $ec  = Net::SSLeay::EC_KEY_generate_key&#40;$curve&#41;;
+ Net::SSLeay::EVP_PKEY_assign_EC_KEY&#40;$key,$ec&#41;;
+
+ # $curve - curve name like &#39;secp521r1&#39; or the matching Id &#40;integer&#41; of the curve
+ #
+ # returns: value corresponding to openssl&#39;s EC_KEY structure &#40;0 on failure&#41;
+
+This function has no equivalent in OpenSSL but combines multiple OpenSSL
+functions for an easier interface.
+
 =back
 
 
Index: t/local/63_ec_key_generate_key.t
===================================================================
--- t/local/63_ec_key_generate_key.t	&#40;nonexistent&#41;
+++ t/local/63_ec_key_generate_key.t	&#40;working copy&#41;
@@ -0,0 +1,36 @@
+#!/usr/bin/perl
+
+use strict;
+use warnings;
+use Test::More;
+use Net::SSLeay;
+
+if &#40;!defined &#38;Net::SSLeay::EC_KEY_generate_key&#41; {
+    plan skip_all =&gt; &#34;no suport for ECC in your OpenSSL&#34;;
+    exit&#40;0&#41;;
+}
+
+plan tests =&gt; 4;
+
+Net::SSLeay::randomize&#40;&#41;;
+Net::SSLeay::load_error_strings&#40;&#41;;
+Net::SSLeay::ERR_load_crypto_strings&#40;&#41;;
+Net::SSLeay::SSLeay_add_ssl_algorithms&#40;&#41;;
+
+my $ec = Net::SSLeay::EC_KEY_generate_key&#40;&#39;prime256v1&#39;&#41;;
+ok&#40;$ec,&#39;EC key created&#39;&#41;;
+
+if &#40;$ec&#41; {
+    my $key = Net::SSLeay::EVP_PKEY_new&#40;&#41;;
+    my $rv = Net::SSLeay::EVP_PKEY_assign_EC_KEY&#40;$key,$ec&#41;;
+    ok&#40;$rv,&#39;EC key assigned to PKEY&#39;&#41;;
+
+    my $pem = Net::SSLeay::PEM_get_string_PrivateKey&#40;$key&#41;;
+    ok&#40; $pem =~m{^---.* PRIVATE KEY}m, &#34;output key as PEM&#34;&#41;;
+
+    my $bio = Net::SSLeay::BIO_new&#40; Net::SSLeay::BIO_s_mem&#40;&#41;&#41;;
+    Net::SSLeay::BIO_write&#40;$bio,$pem&#41;;
+    my $newkey = Net::SSLeay::PEM_read_bio_PrivateKey&#40;$bio&#41;;
+    ok&#40;$newkey,&#34;read key again from PEM&#34;&#41;;
+}
+
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;30&nbsp;04:54:36&nbsp;2016</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #115697] generate EC keys  with Net::SSLeay, similar to RSA keys - working patch included</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 30 Jun 2016 18:54:14 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks Steffen that looks good.

Your patch is now in SVN 467.

I would appreciate it if you can test it.

SVN also currently includes support for the forthcoming version of openssl 
1.1, and Im keen to have some people test that too before the next release.

Cheers.

On Thursday, June 30, 2016 03:57:27 AM Steffen Ullrich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=115697">https://rt.cpan.org/Ticket/Display.html?id=115697</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt; &gt; Is there a better/different solution? Or does it really need to be
&gt; &gt; conditional
&gt; &gt; on 1.0.2, not 1.0
</div>&gt; 
&gt; It looks like that EC_curve_nist2nid was added with 1.0.2 but that the code
&gt; works too, if EC_curve_nist2nid is not used, only that it will not know
&gt; about the NIST curves. I&#39;ve updated the patch so that it will use
&gt; EC_curve_nist2nid with 1.0.2 and skip it otherwise. Tested with OpenSSL
&gt; 1.0.1 too.
&gt; 
&gt; Regards,
&gt; Steffen
</div>
-- 
Mike McCauley           VK4AMM                   mikem@airspayce.com
Airspayce Pty Ltd 9 Bulbul Place Currumbin Waters QLD 4223 Australia   
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.airspayce.com">http://www.airspayce.com</a></span>
Phone +61 7 5598-7474
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;08&nbsp;11:10:26&nbsp;2018</span>
    <span class="description">chrisn [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;08&nbsp;11:10:27&nbsp;2018</span>
    <span class="description">chrisn [...] cpan.org -  Given to MIKEM</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;08&nbsp;11:10:27&nbsp;2018</span>
    <span class="description">chrisn [...] cpan.org -  Fixed in 1.75 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
