<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #7599 for DateTime: DateTime: Bugs in documentation and strftime</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #7599 for DateTime: DateTime: Bugs in documentation and strftime</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DateTime/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DateTime/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DateTime/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DateTime/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/houseabsolute/DateTime.pm/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/DateTime">DateTime CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">7599</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DateTime/Active/">DateTime</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">DROLSKY [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
J2N-FORGET [...] orange.fr

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-9734-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-9735-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;09&nbsp;16:25:37&nbsp;2004</span>
    <span class="description">J2N-FORGET [...] orange.fr -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> DateTime: Bugs in documentation and strftime</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/local/bin/perl

use strict;
use warnings;
use DateTime;

my $dt = DateTime-&gt;new&#40;year =&gt; 2004, month =&gt; 8, day =&gt; 16, hour =&gt; 15,
minute =&gt; 30
                   , nanosecond =&gt; 123456789, locale =&gt; &#39;en&#39;&#41;;
# Should print &#39;%{day_name}&#39;, prints &#39;30onday&#39;!
print $dt-&gt;strftime&#40;&#39;%%{day_name}%n&#39;&#41;;
# Should print &#39;%6N&#39;, prints &#39;123456&#39;
print $dt-&gt;strftime&#40;&#39;%%6N%n&#39;&#41;;

__END__

The included patch fixes some bugs in the documentation. It does
not fix the strftime bugs. Rather, here are some propositions
to fix strftime.

The problem is that the string is scanned three times and the 2nd
scan is done after the first substitution, the 3rd scan is done
after the first and second substitutions.

        $f =~ s/%{&#40;\w+&#41;}/1st subs/sgex;
        # regex from Date::Format - thanks Graham!
        $f =~ s/%&#40;[%a-zA-Z]&#41;/2nd subst/sgex;
        # %3N
        $f =~ s/%&#40;\d+&#41;N/3rd subst/sgex;

There are three ways to fix it. The first comes from
DT::C::FrenchRevolutionary
the recently released version 0.07, which deals with 
C&lt;%{method}&gt; specifiers. I have simplified it to discard the
specifiers like C&lt;%EY&gt; and C&lt;%Oj&gt; and I have not introduced
nanosecond support.

      $f =~ s/
                %&#40;[%a-zA-Z]&#41; # $1 stores plain specifier &#40;possibly &#34;%%&#34;&#41;
              | %{&#40;\w+&#41;}     # $2 stores method name
             /
              $2 ? &#40;$self-&gt;can&#40;$2&#41; ? $self-&gt;$2&#40;&#41; : &#34;\%{$2}&#34;&#41;
                 : &#40;$formats{$1} ? $formats{$1}-&gt;&#40;$self&#41; : $1&#41;
             /sgex;

With this method, the string is scanned once and the substitution string
does the dispatch. Supporting nanoseconds is left as an exercise...

The second way uses a gimmick inspired from DT::F::Strptime, version
1.05

        my $str =
&#39;some#peculiar@string=which$does:not!appear-in+the+format&#39;;
        $f =~ s/%%/$str/g;
        $f =~ s/%{&#40;\w+&#41;}/1st subs/sgex;     # %{method}
        $f =~ s/%&#40;[a-zA-Z]&#41;/2nd subst/sgex; # %x, *not* including %%
        $f =~ s/%&#40;\d+&#41;N/3rd subst/sgex;     # %3N
        $f =~ s/$str/%/g;

A third version, not tested, would be:

    $f = join &#39;%&#39;, map {
                         s/%{&#40;\w+&#41;}/1st subs/sgex;     # %{method}
                         s/%&#40;[a-zA-Z]&#41;/2nd subst/sgex; # %x
                         s/%&#40;\d+&#41;N/3rd subst/sgex;     # %3N
                       } split /%%/, $f;

Note that if somebody writes a
DateTime::Locale::Fiction::Rodenburry::Klingon 
module in which Monday is &#34;krf%Ysq!&#34; and January is &#34;psek%3Nvtdl#&#34;,
the second and third versions will still give wrong results
with a format such as &#34;%{day_name} %B&#34;. I have not found any
pathological 
situation which would give wrong results with the first version.

I have even imagined a paranoid variant of the second way:

    my $str;
    do { $str = generate_random_string&#40;&#41; } until index&#40;$f, $str&#41; &lt; 0
                                             &#38;&#38; index&#40;$str, &#39;%&#39;&#41; &lt; 0;
    # etc.

to fix the obvious bug of the &#34;sane&#34; variant of the second way, but it
fails in funny ways, depending on which random string is
generated. Example:

   $f = &#39;xy%%xy%%xy%%&#39; and $str = &#39;xyxyxy&#39;

Anyhow, both the paranoid and the sane versions fails with the
&#34;Klingon locale&#34;.

Jean Forget
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- /home/p80/modules/DateTime-0.22/lib/DateTime.pm	Tue Jul 20 22:47:46 2004
+++ /var/tmp/DateTime.new	Thu Sep  9 21:19:53 2004
@@ -1695,10 +1694,6 @@
 Invalid parameter types &#40;like an array reference&#41; will cause the
 constructor to die.
 
-DateTime does not check if second values greater than 59 are valid
-based on current leap seconds, and invalid values simply cause an
-overflow.
-
 All of the parameters are optional except for &#34;year&#34;.  The &#34;month&#34; and
 &#34;day&#34; parameters both default to 1, while the &#34;hour&#34;, &#34;minute&#34;, and
 &#34;second&#34;, and &#34;nanosecond&#34; parameters all default to 0.
@@ -2456,7 +2451,7 @@
 There are other subtract/delta methods in DateTime.pm to generate
 different types of durations.  These methods are
 C&lt;subtract_datetime&#40;&#41;&gt;, C&lt;subtract_datetime_absolute&#40;&#41;&gt;,
-C&lt;delta_md&#40;&#41;&gt;, L&lt;delta_days&#40;&#41;&gt;, and C&lt;delta_ms&#40;&#41;&gt;.
+C&lt;delta_md&#40;&#41;&gt;, C&lt;delta_days&#40;&#41;&gt;, and C&lt;delta_ms&#40;&#41;&gt;.
 
 =head2 Overloading
 
@@ -2532,7 +2527,7 @@
 
 The ISO 8601 year with century as a decimal number.  The 4-digit year
 corresponding to the ISO week number &#40;see %V&#41;.  This has the same
-format and value as %y, except that if the ISO week number belongs to
+format and value as %Y, except that if the ISO week number belongs to
 the previous or next year, that year is used instead. &#40;TZ&#41;
 
 =item * %g
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Give even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;22&nbsp;14:02:47&nbsp;2004</span>
    <span class="description">DROLSKY [...] cpan.org -  Given to DROLSKY</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;03&nbsp;01:09:01&nbsp;2005</span>
    <span class="description">DROLSKY [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
