<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #75743 for Term-ReadLine-Perl: rl_scroll_nextline inserts line full of spaces into the output before the prompt</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #75743 for Term-ReadLine-Perl: rl_scroll_nextline inserts line full of spaces into the output before the prompt</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Term-ReadLine-Perl">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Term-ReadLine-Perl">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Term-ReadLine-Perl">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Term-ReadLine-Perl">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Term-ReadLine-Perl">Term-ReadLine-Perl CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">75743</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Term-ReadLine-Perl">Term-ReadLine-Perl</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
steven.singer [...] csr.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-31192-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-31193-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=75743">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1049850" href="/Public/Bug/Display.html?id=75743#txn-1049850">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;13&nbsp;14:29:26&nbsp;2012</span>
    <span class="description">steven.singer [...] csr.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rl_scroll_nextline inserts line full of spaces into the output before the prompt</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 13 Mar 2012 18:29:12 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Term-ReadLine-Perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steven Singer &lt;Steven.Singer [...] csr.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1049850/548858/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/548858">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think there&#39;s a bug in the implementation of rl_scroll_nextline in
Term::ReadLine::Perl.

The effect of the bug is that a full line of spaces is placed into the
output before the prompt is written. Since there is no newline at the
end of this, copy and paste from some terminal emulators then ends up
with the prompt displaced across the screen &#40;more details about which
terminals are affected later&#41;. When users copy and paste logs from
programs using Term::ReadLine::Perl the results are messy.

Visually, you get a blank line before the prompt. Although this does
not look unattractive, this is different from Term::ReadLine::Stub, the
behaviour with rl_scroll_nextline turned off and the behaviour on
unaffected terminal emulators.

I think the bug is in the latest version &#40;1.0303&#41; and has been there
since the code came in &#40;version 1.0204&#41;. I can see the problems in
various versions of Perl 5.8 and in Linux versions ranging from 2.4 to
2.6. So, I don&#39;t think this is OS or Perl version related.

I think the bug is caused by two spaces between \b and \r in the line
that implements rl_scroll_nextline. Removing those two spaces fixes the
problem.

Since the two spaces start in column 80 of the line, my suspicion is that
someone was indenting this section of code by two spaces in an 80 column
wide editor and moved down a screen line but not a physical line.

Here&#39;s my proposed diff:

--------------------------------------------------------------------------------
--- readline-orig.pm    2012-03-13 15:06:15.044848000 +0000
+++ readline.pm 2012-03-13 15:06:48.996220000 +0000
@@ -1531,7 +1531,7 @@

     # on XTerm one needs to increase the number by 1.

-    print $term_OUT &#39; &#39; x &#40;$rl_screen_width - !$rl_last_pos_can_backspace&#41; . &#34;\b  \r&#34;
+    print $term_OUT &#39; &#39; x &#40;$rl_screen_width - !$rl_last_pos_can_backspace&#41; . &#34;\b\r&#34;
       if $rl_scroll_nextline;

     if &#40;$dumb_term&#41; {
--------------------------------------------------------------------------------

Here&#39;s a test case and reference output. In each case, I&#39;ve copied and
pasted the output out of a PuTTY window or one of the other affected
terminal emulators and then replaced spaces with dots in the output. I&#39;m
starting with the current Stub implementation as a reference followed by
the current code and then the output with my proposed fix.

In case the long lines in the following examples get mangled, here&#39;s the
test Perl code formatted more normally:

  use Term::ReadLine;
  my $term = new Term::ReadLine &#34;test&#34;;
  for&#40;;;&#41; {
    print $term-&gt;readline&#40;&#34;prompt&gt; &#34;&#41;, &#34;\n&#34;;
  }

================================================================================
Stub implementation
-------------------

$ PERL_RL=Stub perl -e &#39;use Term::ReadLine; my $term = new Term::ReadLine &#34;test&#34;; for&#40;;;&#41; { print $term-&gt;readline&#40;&#34;prompt&gt; &#34;&#41;, &#34;\n&#34;; }&#39;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">prompt&gt;.foo
</div>foo
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">prompt&gt;.bar
</div>bar
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">prompt&gt;
</div>
Current Perl implementation
---------------------------

$ PERL_RL=Perl perl -e &#39;use Term::ReadLine; my $term = new Term::ReadLine &#34;test&#34;; for&#40;;;&#41; { print $term-&gt;readline&#40;&#34;prompt&gt; &#34;&#41;, &#34;\n&#34;; }&#39;
................................................................................prompt&gt;.foo
foo
................................................................................prompt&gt;.bar
bar
................................................................................prompt&gt;

[In case the previous lines have got mangled, the lines containing the
prompts have 80 dots before the prompt. Note that on screen, with an 80
column terminal the prompts appear in the left hand column with blank
lines above them.]

Perl implementation with proposed patch
---------------------------------------

$ PERL_RL=Perl perl -e &#39;use Term::ReadLine; my $term = new Term::ReadLine &#34;test&#34;; for&#40;;;&#41; { print $term-&gt;readline&#40;&#34;prompt&gt; &#34;&#41;, &#34;\n&#34;; }&#39;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">prompt&gt;.foo
</div>foo
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">prompt&gt;.bar
</div>bar
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">prompt&gt;
</div>================================================================================

Really, any test should also make sure that rl_scroll_newline works as
intended even if just one character has been output before the prompt.
Something like this might be suitable:

  use Term::ReadLine;
  my $term = new Term::ReadLine &#34;test&#34;;
  select&#40;$term-&gt;OUT&#41;;
  for&#40;;;&#41; {
    print &#34;*&#34;;
    print $term-&gt;readline&#40;&#34;prompt&gt; &#34;&#41;, &#34;\n&#34;;
  }

The problem shows in:

  PuTTY &#40;version 0.62&#41;
  gnome-terminal &#40;version 2.16.0&#41;
  Terminal &#40;version 0.2.8 from xfce 4.4&#41;
  screen &#40;versions 3.09.15 &#40;FAU&#41; 13-Mar-03 and 4.00.03 &#40;FAU&#41; 23-Oct-06&#41;
  konsole &#40;Qt: 3.3.6; KDE: 3.5.4-22.el5_3 Red Hat; Konsole: 1.6.4&#41;
  xterm with reverse wraparound enabled &#40;not default?&#41;

The problem does not show in:

  xterm with reverse wraparound disabled &#40;default?&#41;

I&#39;ve marked default with a question mark as xterm&#39;s settings are at the
mercy of lots of configuration files. It&#39;s what I get on my systems on
the two versions of xterm I&#39;ve tried &#40;XFree86 4.3.99.5&#40;179&#41; and
XTerm&#40;215&#41;&#41;.

I think the difference in behaviour is to do with how the various
terminals deal with reaching the right hand column. To simplify the
example, I will assume an 80 character display. I will number the
columns with column 1 being the left hand edge of the screen and
column 80 being the right hand edge. If I say the cursor is in column
N then the next character will be output in column N.

All terminal emulators agree that after 79 spaces have been output,
the cursor is in column 80. When the 80th character is output, many
terminals now say the cursor is in column 81. If another character
is output, the terminals go to column 1 on the next line, then output
the character. If, on the other hand, with the cursor in column 81,
a backspace is received the cursor goes back to column 80.

With xterm &#40;with reverse wraparound disabled&#41; things are slightly
different. With the cursor in column 80 when the next character is
output, it appears that xterm places the character in column 80,
leaves the cursor in column 80 and sets a flag to say the line is
full. If another character is output then xterm goes to column 1 of
the next line then outputs the character. If, on the other hand, a
backspace is received then the cursor goes to column 79.

The difference is easy to see by outputting the following sequences:

  79 spaces, dot
  79 spaces, backspace, dot
  80 spaces, dot
  80 spaces, backspace, dot

All terminals agree that the first sequence puts a dot in the right
hand column. All terminals agree that the second sequence puts a dot
in the second column from the right. All terminals agree that the
third sequence puts a dot in the left hand column of the next line.

It&#39;s only the last sequence where there&#39;s a disagreement. Terminal
emulators except xterm with reverse wraparound disabled put the dot
in the right hand column &#40;that is the positioning for 80 spaces plus
backspace is equal to the positioning for 79 spaces&#41;. Xterm with reverse
wraparound puts the dot in the second column from the right.

Actually, the sample code in the comments above the rl_scroll_nextline
shows the problem quite well:

  perl -we &#34;print 1 x shift, qq&#40;\b2\r3&#41;; sleep 2&#34; 80

&#40;I find I need to set $| to 1 to get that example to work&#41;.

All the terminals except xterm with reverse wraparound disabled
display:

31111111111111111111111111111111111111111111111111111111111111111111111111111112

xterm with reverse wraparound disabled displays:

31111111111111111111111111111111111111111111111111111111111111111111111111111121

I know enough about terminal emulation to know that handling the last
column is tricky. So, I&#39;m not going to say xterm&#39;s behaviour is wrong.
All I&#39;m going to say is that Term::ReadLine::Perl appears to be
relying on behaviour that&#39;s peculiar to xterm with some options.
-- 
Steven Singer
Software Engineer
Cambridge Silicon Radio Ltd. Tel: +44 &#40;0&#41;1223 692000 Fax: +44 &#40;0&#41;1223 692001
Churchill House, Cambridge Business Park, Cowley Road, Cambridge CB4 0WZ, UK




Member of the CSR plc group of companies. CSR plc registered in England and Wales, registered number 4187346, registered office Churchill House, Cambridge Business Park, Cowley Road, Cambridge, CB4 0WZ, United Kingdom
More information can be found at www.csr.com. Follow CSR on Twitter at <span class="clickylink"><a target="new" rel="nofollow" href="http://twitter.com/CSR_PLC">http://twitter.com/CSR_PLC</a></span> and read our blog at www.csr.com/blog
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1051509" href="/Public/Bug/Display.html?id=75743#txn-1051509">#</a>      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;17&nbsp;18:31:10&nbsp;2012</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75743] rl_scroll_nextline inserts line full of spaces into the output before the prompt</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 17 Mar 2012 15:30:59 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Steven Singer via RT &lt;bug-Term-ReadLine-Perl [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1051509/549822/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/549822">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Mar 13, 2012 at 02:29:26PM -0400, Steven Singer via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Tue Mar 13 14:29:26 2012: Request 75743 was acted upon.
&gt; Transaction: Ticket created by steven.singer@csr.com
&gt;        Queue: Term-ReadLine-Perl
&gt;      Subject: rl_scroll_nextline inserts line full of spaces into the output before the prompt
&gt;    Broken in: &#40;no value&#41;
&gt;     Severity: &#40;no value&#41;
&gt;        Owner: Nobody
&gt;   Requestors: steven.singer@csr.com
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75743">https://rt.cpan.org/Ticket/Display.html?id=75743</a></span> &gt;
&gt; 
&gt; 
&gt; I think there&#39;s a bug in the implementation of rl_scroll_nextline in
&gt; Term::ReadLine::Perl.
&gt; 
&gt; The effect of the bug is that a full line of spaces is placed into the
&gt; output before the prompt is written. Since there is no newline at the
&gt; end of this, copy and paste from some terminal emulators then ends up
&gt; with the prompt displaced across the screen &#40;more details about which
&gt; terminals are affected later&#41;. When users copy and paste logs from
&gt; programs using Term::ReadLine::Perl the results are messy.
</div>
Thank you for your wonderfully detailed, clear and concise bug report.
Just to make this story yet shorter, do you say that removing two
spaces &#34;fixes this&#34; on all the terminals?  And when I say &#34;fixes this&#34;, I mean
the following target:

The intent of the code is:

  a&#41; we want to use only spaces, tabs, \b, \t, \r, \n;
  b&#41; when the cursor is at start of line, we want it to remain where it is;
  c&#41; when the cursor is not at start of line, we want it to go to the
     beginning of the following line.

I know that the code works in xterm, and in DOSISH consoles I use.  I
know that most terminal emulators are very buggy &#40;when the quality
stardard is set by xterm and DOSISH consoles&#41;.  I&#39;d love to have the
code work even on buggy terminals, and it looks like you are in
position to ameliorate this ;-&#41;.

Right now I&#39;m very limited in my time and QA abilities, but it would
be great if we could resolve this together.

Thanks again,
Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1051512" href="/Public/Bug/Display.html?id=75743#txn-1051512">#</a>      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;17&nbsp;18:31:11&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1053601" href="/Public/Bug/Display.html?id=75743#txn-1053601">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;22&nbsp;15:08:50&nbsp;2012</span>
    <span class="description">steven.singer [...] csr.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75743] rl_scroll_nextline inserts line full of spaces into the output before the prompt</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 22 Mar 2012 19:08:24 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Term-ReadLine-Perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steven Singer &lt;Steven.Singer [...] csr.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1053601/551082/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/551082">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Just to make this story yet shorter, do you say that removing two
&gt; spaces &#34;fixes this&#34; on all the terminals?  And when I say &#34;fixes this&#34;, I mean
&gt; the following target:
&gt; 
&gt; The intent of the code is:
&gt; 
&gt;   a&#41; we want to use only spaces, tabs, \b, \t, \r, \n;
&gt;   b&#41; when the cursor is at start of line, we want it to remain where it is;
&gt;   c&#41; when the cursor is not at start of line, we want it to go to the
&gt;      beginning of the following line.
</div>
With the information I had when I posted my last message, I can confirm
that the fix satisfies all of a through c. I hadn&#39;t tested my fix in a
DOS window.

What puzzles me is why the \b is in the original code. I can&#39;t work out
why it&#39;s necessary or even why the original author thought that it might
be necessary. That makes me nervous that there&#39;s something I&#39;ve missed.

So, I&#39;ve tried again with and without the \b, just by using cat or
type.

As far as I can tell, the \b makes no difference. On an 80 column
screen:

  80 spaces + cr or 80 spaces + bs + cr does the right thing in
  xterm &#40;with and without reverse wraparound&#41;, gnome-terminal, konsole,
  Terminal &#40;part of xfce 4.4&#41;, dtterm, screen and PuTTY.

  79 spaces + cr or 79 spaces + bs + cr does the right thing in a
  DOS &#40;well, Windows 7&#41; command prompt.

By &#34;the right thing&#34; I mean the code meets condition a and, visually, b
and c are satisfied.

When cutting and pasting out of terminals there&#39;s some difference as to
what is copied and pasted even when terminals agree visually.

When the previous output leaves the cursor at the start of the line,
some terminals copy and paste the spaces that were used to clear the
line as being after the prompt. Other terminals ignore them.

When the previous output does not leave the cursor at the start of the
line, X terminals other than xterm with reverse wraparound disabled
copy and paste the partial line, a bunch of spaces and then the prompt
as a single line.

I don&#39;t consider either of these to be significant problems and I
can&#39;t see a way to fix them.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I know that the code works in xterm, and in DOSISH consoles I use.  I
&gt; know that most terminal emulators are very buggy &#40;when the quality
&gt; stardard is set by xterm and DOSISH consoles&#41;.  I&#39;d love to have the
&gt; code work even on buggy terminals, and it looks like you are in
&gt; position to ameliorate this ;-&#41;.
</div>
I think calling the other terminals buggy with regard to this specific
issue is probably excessive. It depends on whether you think terminals
should be perfect VT100 emulations. Since you&#39;re avoiding VT100 specific
escape sequences relying on behaviour peculiar to VT100 for erasing
lines seems odd.

If you think terminals should generally be helpful to programs then
the behaviour of most terminals is understandable. It allows, for
example, programs to erase the last character typed by sending
&#34;\b \b&#34; without knowing the width of the terminal &#40;provided the line
hasn&#39;t wrapped&#41;. Using that sequence on an xterm leads to odd
behaviour at the last column.

If you think terminals just need to be ECMA 48 compliant rather than
precise VT100 emulations then both behaviours are valid. Section 6.1.6
of the ECMA 48 spec leaves the behaviour of writing a character into
the last character position up to the implementation.

Termcap&#39;s description of the xn flag is equally vague.

Actually, I&#39;m assuming VT100s do what xterm does. I don&#39;t have a real
VT100 to test.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Right now I&#39;m very limited in my time and QA abilities, but it would
&gt; be great if we could resolve this together.
</div>
I&#39;m very limited in my time too but hopefully we can get this sorted.
-- 
Steven Singer
Software Engineer
Cambridge Silicon Radio Ltd. Tel: +44 &#40;0&#41;1223 692000 Fax: +44 &#40;0&#41;1223 692001
Churchill House, Cambridge Business Park, Cowley Road, Cambridge CB4 0WZ, UK



Member of the CSR plc group of companies. CSR plc registered in England and Wales, registered number 4187346, registered office Churchill House, Cambridge Business Park, Cowley Road, Cambridge, CB4 0WZ, United Kingdom
More information can be found at www.csr.com. Follow CSR on Twitter at <span class="clickylink"><a target="new" rel="nofollow" href="http://twitter.com/CSR_PLC">http://twitter.com/CSR_PLC</a></span> and read our blog at www.csr.com/blog
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.352935</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
