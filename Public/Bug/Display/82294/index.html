<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #82294 for Net-DNS: Gratuitous laundering &#40;untaining&#41; data from the wild</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #82294 for Net-DNS: Gratuitous laundering &#40;untaining&#41; data from the wild</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-DNS/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-DNS">Net-DNS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">82294</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-DNS/Active/">Net-DNS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Mark.Martinec [...] ijs.si

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-22454-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.71    </td>
  </tr>
  <tr id="CF-22455-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;27&nbsp;20:15:58&nbsp;2012</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Gratuitous laundering &#40;untaining&#41; data from the wild</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Data from the question section and from resource records derived
from DNS packets as received &#39;from the wild&#39; should be kept tainted.

While it is probably acceptable to return untainted simple
fields like answer-&gt;type and counters from the header, it is
unacceptable to just blindly untaint fields like rdatastr
and txtdata, or qname from the question section. A remote
server or someone in between could be placing almost arbitrary
text in such DNS packets.

The Net::DNS 0.68 was still reasonable in this respect &#40;leaving
resource records tainted, although it should not have untainted
the qname&#41;, but versions 0.69 .. 0.71 unwarrantedly also untaint
strings in TXT records &#40;possibly also in SPF and HINFO, perhaps
elsewhere&#41;.

Here is a demonstration:

$ perl -T -MNet::DNS::Resolver -MScalar::Util -e &#39;
  sub pr{my&#40;$p,$m&#41;=@_;
    $p-&gt;can&#40;$m&#41; &#38;&#38; printf&#40;&#34;%s %-4s %-8s: %s\n&#34;,
      Scalar::Util::tainted&#40;$p-&gt;$m&#41;?&#34;tainted   &#34;:&#34;LAUNDERED!&#34;,
      $p-&gt;can&#40;&#34;type&#34;&#41; ? $p-&gt;type : &#34;&#34;,
      $m, $p-&gt;$m&#40;&#41;&#41;;
  };
  $p=Net::DNS::Resolver-&gt;new-&gt;send&#40;&#34;2.0.0.127.bl.spamcop.net&#34;,&#34;ANY&#34;&#41;;
  for &#40;$p-&gt;question&#41;{pr&#40;$_,&#34;qname&#34;&#41;};
  for &#40;$p-&gt;answer&#41;
    {pr&#40;$_,&#34;rdatastr&#34;&#41;; pr&#40;$_,&#34;txtdata&#34;&#41;; pr&#40;$_,&#34;address&#34;&#41;}&#39;

0.68:
LAUNDERED! ANY  qname   : 2.0.0.127.bl.spamcop.net
tainted         rdatastr: 127.0.0.2
tainted         rdatastr: &#34;Blocked - see <span class="clickylink"><a target="new" rel="nofollow" href="http://www.spamcop.net/">http://www.spamcop.net/</a></span>
bl.shtml?127.0.0.2&#34;
tainted         txtdata : Blocked - see <span class="clickylink"><a target="new" rel="nofollow" href="http://www.spamcop.net/bl.shtml">http://www.spamcop.net/bl.shtml</a></span>?
127.0.0.2

0.69 .. 0.71:
LAUNDERED! ANY  qname   : 2.0.0.127.bl.spamcop.net
tainted    A    rdatastr: 127.0.0.2
tainted    A    address : 127.0.0.2
LAUNDERED! TXT  rdatastr: &#34;Blocked - see <span class="clickylink"><a target="new" rel="nofollow" href="http://www.spamcop.net/">http://www.spamcop.net/</a></span>
bl.shtml?127.0.0.2&#34;
LAUNDERED! TXT  txtdata : Blocked - see <span class="clickylink"><a target="new" rel="nofollow" href="http://www.spamcop.net/bl.shtml">http://www.spamcop.net/bl.shtml</a></span>?
127.0.0.2

The attached patch addresses the problem - by two approaches:
- by adding a global &#34;use re &#39;taint&#39;;&#34; to most if not all packages
  while overriding its affect selectively only where untaining
  is intentional;
- by passing taintedness flag from the argument of Encode::decode
  to its result - the Encode::decode is guilty of laundering too,
  but is not the only culprit.


Here is my text from an old SpamAssassin problem report
  <span class="clickylink"><a target="new" rel="nofollow" href="https://issues.apache.org/SpamAssassin/show_bug.cgi?id=5645">https://issues.apache.org/SpamAssassin/show_bug.cgi?id=5645</a></span>
explaining the situation:

======
The implicit untainting mechanism offered by Perl in a form
of regexp matching has its good and its undesired sides.
The good side is that in some cases it does the right thing
when a programmer is careful to use it carefully.
The down side is that regexp matching is also used for other
purposes, and the untainting action is more often than not
unintentional, leading to data laundering as a side effect,
defeating the taint checking safety net.

The SA module Util already provides routines for explicit
untainting of variables, but so far the untaint_var&#40;&#41; has
only rarely been used. On the other front, Perl provides
a pragma &#40;already in 5.6.1, possibly earlier&#41;:
   use re &#39;taint&#39;;
which allows turning off the implicit untainting.

Combining both offers us best of both worlds, allowing
a programmer to explicitly untaint data when required,
and avoid implicit untainting when just thinking of
program&#39;s functionality.
[...]
Letting tainted data propagate to a final consumer as much as
is practical, is a general policy to be followed here - is my 
suggestion.

This may smoke out some additional Perl taint bugs regarding the
global variables $1, $2, ... which sometimes get mysteriously tainted.
Localizing these variables is a good practice anyway &#40;avoiding horrible
Perl practice to let subroutines use global temporary variables&#41;.
I already added local&#40;$1,$2,...&#41; where I stumbled across; it is
possible that some more will be needed or desired.
======


See also:
  <span class="clickylink"><a target="new" rel="nofollow" href="https://issues.apache.org/SpamAssassin/show_bug.cgi?id=3838#c11">https://issues.apache.org/SpamAssassin/show_bug.cgi?id=3838#c11</a></span>

Regarding the tainting of $1, $2, etc and propagating the
taintedness bug, this was addressed in
  [perl #67962] spamassassin and tainted mode
which I can no longer find in the bug tracker,
but here is a relevant section:

Re: [perl #67962] spamassassin and tainted mode
From: Dave Mitchell &lt;davem@iabyn.com&gt;
To: Mark Martinec &lt;Mark.Martinec@ijs.si&gt;
CC: demerphq &lt;demerphq@gmail.com&gt;, perlbug-followup@perl.org
Date: Thu, 25 Mar 2010 11:10:10 +0000

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Yves,
&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; I&#39;m running 5.10.1 on our mailers now. I suppose I could
&gt; &gt; &gt; remove these localizations of $1,$2,etc and see what happens.
&gt; &gt; &gt; Will let you know if I can reproduce it on 5.10.1.
</div></div>&gt; 
&gt; Done. And I believe I have it distilled now to a small test case.
&gt; 
<div class="message-stanza open">&gt; &gt; Also it would be really nice to get to the bottom of this.
&gt; &gt; 
&gt; &gt; I have looked at the regex code and i have looked at the $1 fetch
&gt; &gt; logic and i dont see how it possibly could ever be tainted.
&gt; &gt; 
&gt; &gt; At the very least we should assert that it isnt.
</div>&gt; 
&gt; #!/usr/bin/perl -T
&gt; 
&gt;   use strict;
&gt;   use re &#39;taint&#39;;
&gt;   use Scalar::Util qw&#40;tainted&#41;;
&gt; 
&gt;   my $mailbox = &#39;abc@example.com&#39;;
&gt;   $mailbox .= substr&#40;$ENV{PATH},0,0&#41;;  # make it tainted
&gt; 
&gt;   # $1 and $2 become tainted
&gt;   my&#40;@r&#41; = $mailbox =~ /^&#40;.*?&#41;&#40;\@.*&#41;$/ ? &#40;$1,$2&#41; : &#40;$mailbox,&#39;&#39;&#41;;
&gt;   printf&#40;&#34;%d %d\n&#34;, tainted&#40;$1&#41;, tainted&#40;$2&#41;&#41;;
&gt; 
&gt;   my&#40;$nm&#41; = &#39;aaa-ccc&#39;;  # not tainted
&gt;   printf&#40;&#34;%d\n&#34;, tainted&#40;$nm&#41;&#41;;
&gt; 
&gt;   $nm =~ s/^aaa-&#40;.*&#41;$/$1/;  # $nm becomes tainted
&gt;   printf&#40;&#34;%d\n&#34;, tainted&#40;$nm&#41;&#41;;
</div>
Now fixed by commit 447ee1343739cf8e34c4ff1ba9b30eae75c3f1ab
in branch davem/post-5.12, which should be merged back into blead
once 5.12 has been released, and thus appear in 5.13 onwards:

commit 447ee1343739cf8e34c4ff1ba9b30eae75c3f1ab
Author:     David Mitchell &lt;davem@iabyn.com&gt;
AuthorDate: Thu Mar 25 10:56:35 2010 +0000
Commit:     David Mitchell &lt;davem@iabyn.com&gt;
CommitDate: Thu Mar 25 10:56:35 2010 +0000

    RT #67962: $1 treated as tainted in untainted match
    
    Fix the issue in the following:
    
        use re &#39;taint&#39;;
        $tainted =~ /&#40;...&#41;/;
        # $1 now correctly tainted
        $untainted =~ s/&#40;...&#41;/$1/;
        # $untainted now incorrectly tainted
    
    The problem stems from when $1 is updated.
    
    pp_substcont, which is called after the replacement expression has 
been
    evaluated, checks the returned expression for taintedness, and if 
so,
    taints the variable being substituted. For a substitution like
    s/&#40;...&#41;/x$1/ this works fine: the expression &#34;x&#34;.$1 causes $1&#39;s get 
magic
    to be called, which sets $1 based on the recent match, and is 
marked as
    not tainted.  Thus the returned expression is untainted. In the 
variant
    s/&#40;...&#41;/$1/, the returned value on the stack is $1 itself, and its 
get
    magic hasn&#39;t been called yet. So it still has the tainted flag from 
the
    previous pattern.
    
    The solution is to mg_get the returned expression before testing for
    taintedness.


Affected files ...
    
    M   pp_ctl.c
    M   t/op/taint.t
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net-DNS-0.71.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- DNS.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS.pm	2012-12-27 18:52:43.000000000 +0100
@@ -113,4 +113,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 use Carp;
 use Net::DNS::RR;
@@ -226,4 +227,5 @@
     return $typesbyname{$name} if defined $typesbyname{$name};
 
+    local $1;
     confess &#34;unknown type $name&#34; unless $name =~ m/TYPE&#40;\d+&#41;/o;
 
@@ -273,4 +275,5 @@
     return $classesbyname{$name} if defined $classesbyname{$name};
 
+    local $1;
     confess &#34;unknown class $name&#34; unless $name =~ m/CLASS&#40;\d+&#41;/o;
 
@@ -451,4 +454,5 @@
     my $presentation=shift; # Really wire...
 
+    local $1;
     # Prepend these with a backslash
     $presentation =~ s/&#40;[&#34;$&#40;&#41;;@.\\]&#41;/\\$1/g;
@@ -490,4 +494,5 @@
     my  $wire=&#34;&#34;;
 
+    local&#40;$1,$2&#41;;
     while &#40;$presentation =~ /\G&#40;[^.\\]*&#41;&#40;[.\\]?&#41;/g&#41;{
         $wire .= $1 if defined $1;
--- DNS/Domain.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/Domain.pm	2012-12-27 18:52:43.000000000 +0100
@@ -38,4 +38,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 use integer;
 use Carp;
@@ -176,5 +177,7 @@
 
 	my $self = shift;
-	return $self-&gt;{xname} ||= UTF8-&gt;decode&#40; Net::LibIDN::idn_to_unicode&#40; $name, &#39;utf-8&#39; &#41; || $name &#41;;
+
+	# preserve taintedness, Encode::decode drops it!
+	return $self-&gt;{xname} ||= substr&#40;$name,0,0&#41;.UTF8-&gt;decode&#40; Net::LibIDN::idn_to_unicode&#40; $name, &#39;utf-8&#39; &#41; || $name &#41;;
 }
 
@@ -214,4 +217,5 @@
 sub string {
 	my $name = &#38;name;
+	local $1;
 	$name =~ s/^&#40;[&#39;&#34;\$;@]&#41;/\\$1/;				# escape leading special char
 	return $name =~ /[$dot]$/o ? $name : $name . $dot;	# append trailing dot
@@ -263,5 +267,6 @@
 sub _decode_ascii {
 
-	return ASCII-&gt;decode&#40;shift&#41; if ASCII;
+	# preserve taintedness, Encode::decode drops it!
+	return substr&#40;$_[0],0,0&#41; . ASCII-&gt;decode&#40;$_[0]&#41;  if ASCII;
 
 	unless &#40;ASCII&#41; {
@@ -320,4 +325,5 @@
 sub _escape {				## Insert escape sequences in string
 	my $s = shift;
+	local $1;
 	$s =~ s/&#40;[^\055\101-\132\141-\172\060-\071]&#41;/$esc{$1}/eg;
 	return $s;
@@ -340,4 +346,5 @@
 sub _unescape {				## Remove escape sequences in string
 	my $s = shift;
+	local $1;
 	$s =~ s/\134&#40;[\060-\062][\060-\071]{2}&#41;/$unesc{$1}/eg;	# numeric escape
 	$s =~ s/\134\066\066\066/\134\134/g;			# reveal escaped escape
--- DNS/DomainName.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/DomainName.pm	2012-12-27 18:52:43.000000000 +0100
@@ -42,4 +42,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 use integer;
 use Carp;
--- DNS/Header.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/Header.pm	2012-12-27 18:52:43.000000000 +0100
@@ -28,4 +28,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 use integer;
 use Carp;
--- DNS/Mailbox.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/Mailbox.pm	2012-12-27 18:52:43.000000000 +0100
@@ -29,4 +29,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 use Carp;
 
@@ -50,4 +51,5 @@
 	my $class = shift;
 	local $_ = shift;
+	local&#40;$1,$2&#41;;
 	confess &#39;undefined mail address&#39; unless defined $_;
 
@@ -84,4 +86,5 @@
 	my @label = shift-&gt;label;
 	local $_ = shift&#40;@label&#41; || return &#39;&lt;&gt;&#39;;
+	local $1;
 	s/\\\./\./g;						# unescape dots
 	s/\\032/ /g;						# unescape space
--- DNS/Nameserver.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/Nameserver.pm	2012-12-27 18:52:43.000000000 +0100
@@ -34,4 +34,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 use integer;
 use Carp qw&#40;cluck&#41;;
--- DNS/Packet.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/Packet.pm	2012-12-27 18:52:43.000000000 +0100
@@ -32,4 +32,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 use integer;
 use Carp;
--- DNS/Parameters.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/Parameters.pm	2012-12-27 18:52:43.000000000 +0100
@@ -22,4 +22,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 use integer;
 use Carp;
--- DNS/Question.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/Question.pm	2012-12-27 18:52:43.000000000 +0100
@@ -27,4 +27,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 use integer;
 use Carp;
@@ -282,4 +283,5 @@
 
 	# arg looks like IPv4 address: map to in-addr.arpa space
+	local&#40;$1,$2,$3,$4,$5&#41;;
 	if &#40;m#&#40;^|:.*:&#41;&#40;&#40;^|\d+\.&#41;+\d+&#41;&#40;/&#40;\d+&#41;&#41;?$#&#41; {
 		return undef if new Net::DNS::DomainName&#40;&#39;@&#39;&#41;-&gt;label;
--- DNS/RR/AAAA.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/RR/AAAA.pm	2012-12-27 18:52:43.000000000 +0100
@@ -17,4 +17,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 use integer;
 
@@ -76,4 +77,5 @@
 
 sub address_short {
+	local $1;
 	for &#40; sprintf &#39;:%x:%x:%x:%x:%x:%x:%x:%x:&#39;, unpack &#39;n8&#39;, shift-&gt;{address} &#41; {
 		s/&#40;:0[:0]+:&#41;&#40;?!.+:0\1&#41;/::/;			# squash longest zero sequence
--- DNS/RR/APL.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/RR/APL.pm	2012-12-27 18:52:43.000000000 +0100
@@ -17,4 +17,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 use integer;
 
@@ -74,4 +75,5 @@
 	my $self = shift;
 
+	local&#40;$1,$2&#41;;
 	while &#40;@_&#41; {						# parse apitem strings
 		last unless $_[0] =~ m|^&#40;!?&#41;&#40;\d+&#41;:&#40;.+&#41;/&#40;\d+&#41;$|;
--- DNS/RR/SSHFP.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/RR/SSHFP.pm	2012-12-27 18:52:43.000000000 +0100
@@ -17,4 +17,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 use integer;
 
@@ -45,4 +46,5 @@
 	my $babble	= $self-&gt;babble;
 	my $fingerprint = $self-&gt;fp;
+	local $1;
 	$fingerprint =~ s/&#40;\S{64}&#41;/$1\n/g;
 	$fingerprint = &#34;&#40;\n$fingerprint &#41;&#34; if length $fingerprint &gt; 40;
--- DNS/RR/TLSA.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/RR/TLSA.pm	2012-12-27 18:52:43.000000000 +0100
@@ -16,4 +16,7 @@
 
 
+use strict;
+use re &#39;taint&#39;;
+
 
 sub decode_rdata {			## decode rdata from wire-format octet string
@@ -43,4 +46,5 @@
 	my @params = map $self-&gt;$_, qw&#40;usage selector matchingtype&#41;;
 	my $certificate = $self-&gt;cert;
+	local $1;
 	$certificate =~ s/&#40;\S{64}&#41;/$1\n/g;
 	$certificate = &#34;&#40;\n$certificate &#41;&#34; if length $certificate &gt; 40;
--- DNS/RR/TXT.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/RR/TXT.pm	2012-12-27 18:52:43.000000000 +0100
@@ -19,4 +19,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 use integer;
 
--- DNS/RR.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/RR.pm	2012-12-27 18:52:43.000000000 +0100
@@ -36,4 +36,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 use integer;
 use Carp;
--- DNS/Resolver/Base.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/Resolver/Base.pm	2012-12-27 18:52:43.000000000 +0100
@@ -5,4 +5,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 
 BEGIN {
@@ -242,4 +243,5 @@
 	local $/ = &#34;\n&#34;;
 	local $_;
+	local $1;
 
 	while &#40;&lt;FILE&gt;&#41; {
@@ -249,4 +251,8 @@
 		next unless m/\S/;
 
+		# allow automatic untainting for compatibility,
+		# trying not to break applications
+		no re &#39;taint&#39;;
+
 		SWITCH: {
 			/^\s*domain\s+&#40;\S+&#41;/ &#38;&#38; do {
@@ -400,4 +406,5 @@
 	my @addr;
 	my @names = @{$names};
+	local $1;
 
 	my $oct2 = &#39;&#40;?:2[0-4]\d|25[0-5]|[0-1]?\d\d|\d&#41;&#39;;
--- DNS/Resolver/MSWin32.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/Resolver/MSWin32.pm	2012-12-27 18:52:43.000000000 +0100
@@ -16,4 +16,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 use Win32::IPHelper;
 use Win32::TieRegistry qw&#40;KEY_READ REG_DWORD&#41;;
@@ -77,4 +78,5 @@
 		my @a;
 		my %h;
+		local $1;
 		foreach my $entry &#40; split&#40; m/[\s,]+/, lc $searchlist &#41; &#41; {
 			push&#40; @a, $entry &#41; unless $h{$entry}++;
--- DNS/Resolver/Recurse.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/Resolver/Recurse.pm	2012-12-27 18:52:43.000000000 +0100
@@ -4,4 +4,5 @@
 #
 use strict;
+use re &#39;taint&#39;;
 use Net::DNS::Resolver;
 
@@ -290,4 +291,5 @@
        } elsif &#40;my @authority = $packet-&gt;authority&#41; {
 	 my %auth = &#40;&#41;;
+	 local $1;
 	 foreach my $rr &#40;@authority&#41; {
 	   if &#40;$rr-&gt;type =~ /^&#40;NS|SOA&#41;$/&#41; {
--- DNS/Resolver/UNIX.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/Resolver/UNIX.pm	2012-12-27 18:52:43.000000000 +0100
@@ -16,4 +16,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 
 
--- DNS/Resolver/cygwin.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/Resolver/cygwin.pm	2012-12-27 18:52:43.000000000 +0100
@@ -16,4 +16,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 
 
@@ -119,4 +120,5 @@
 		my @a;
 		my %h;
+		local $1;
 		foreach my $entry &#40; split&#40; m/[\s,]+/, $searchlist &#41; &#41; {
 			push&#40; @a, $entry &#41; unless $h{$entry}++;
--- DNS/Resolver/os2.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/Resolver/os2.pm	2012-12-27 18:52:43.000000000 +0100
@@ -16,4 +16,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 
 
--- DNS/Resolver.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/Resolver.pm	2012-12-27 18:52:43.000000000 +0100
@@ -15,4 +15,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 
 use vars qw&#40;@ISA&#41;;
--- DNS/Text.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/Text.pm	2012-12-27 18:52:43.000000000 +0100
@@ -37,4 +37,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 use integer;
 use Carp;
@@ -78,4 +79,5 @@
 	local $_ = &#38;_encode_utf8;
 
+	local&#40;$1,$2&#41;;
 	s/^&#40;[\042\047]&#41;&#40;.*&#41;\1$/$2/;				# strip paired quotes
 
@@ -201,7 +203,8 @@
 sub _decode_utf8 {
 
-	return UTF8-&gt;decode&#40;shift&#41; if UTF8;
+	# preserve taintedness, Encode::decode drops it!
+	return substr&#40;$_[0],0,0&#41; . UTF8-&gt;decode&#40;$_[0]&#41; if UTF8;
 
-	return ASCII-&gt;decode&#40;shift&#41; if ASCII &#38;&#38; not UTF8;
+	return substr&#40;$_[0],0,0&#41; . ASCII-&gt;decode&#40;$_[0]&#41; if ASCII &#38;&#38; not UTF8;
 
 	unless &#40;ASCII&#41; {
--- DNS/Update.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/Update.pm	2012-12-27 18:52:43.000000000 +0100
@@ -33,4 +33,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 use Net::DNS;
 
--- DNS/ZoneFile.pm	2012-12-15 12:15:26.000000000 +0100
+++ DNS/ZoneFile.pm	2012-12-27 18:52:43.000000000 +0100
@@ -45,4 +45,5 @@
 
 use strict;
+use re &#39;taint&#39;;
 use integer;
 use Carp;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;28&nbsp;12:03:14&nbsp;2012</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Dec 27 20:15:58 2012, Mark.Martinec@ijs.si wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The Net::DNS 0.68 was still reasonable in this respect &#40;leaving
&gt; resource records tainted,
</div>No deliberate steps were taken to make it so.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; the qname&#41;, but versions 0.69 .. 0.71 unwarrantedly also untaint
&gt; strings in TXT records &#40;possibly also in SPF and HINFO, perhaps
&gt; elsewhere&#41;.
</div>0.69+ imposes a separation of the external wire-format ASCII speaking
world from the Perl internal character string world.

The traffic crosses the boundary using the methods inside the Domain and
Text packages. These have been very carefully coded to eliminate
concatenation of external ASCII/UTF8 strings with internal Perl
character strings, which implicitly &#34;upgrades&#34; &#40;screws up&#41; the encoding.
Your proposed solution &#40;which involves a concatenation&#41; might work on
your platform, but is unlikely to be portable across all Perl versions
from 5.6 .. 5.17, which 0.72 now is.

There is an additional complication which arises because much of the
internal data is stored in wire-format, even if generated from untainted
internal sources. Careful analysis of the impact and realistic
assessment of the likely benefits will be needed before the far-reaching
changes outlined in your patch can be considered.  
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;28&nbsp;12:03:15&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;13&nbsp;09:28:41&nbsp;2013</span>
    <span class="description">NLNETLABS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is fixed in the upcoming 0.73 release
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;13&nbsp;09:28:42&nbsp;2013</span>
    <span class="description">NLNETLABS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
