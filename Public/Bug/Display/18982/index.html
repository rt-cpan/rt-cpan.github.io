<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #18982 for POE: Memory leak</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #18982 for POE: Memory leak</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=POE">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=POE">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=POE">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=POE">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE">POE CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">18982</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=POE">POE</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
allend [...] Zoo.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26342-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26343-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




pfr_memleak.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/214599/85308/pfr_memleak.pl">
Tue Jun 27 22:00:14 2006 (291b) by Guest
</a>
</font></li>
</ul>


YClientNoKernel.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/191157/69315/YClientNoKernel.pl">
Sat Apr 29 23:51:46 2006 (2.2k) by Guest
</a>
</font></li>
</ul>


YServ.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/191157/69312/YServ.pl">
Sat Apr 29 23:51:46 2006 (999b) by Guest
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=18982">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-191151" href="/Public/Bug/Display.html?id=18982#txn-191151">#</a>      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;29&nbsp;20:32:40&nbsp;2006</span>
    <span class="description">allend [...] Zoo.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Memory leak</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 27 Apr 2006 21:06:50 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;poe [...] perl.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Donovan Allen&#34; &lt;allend [...] Zoo.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/191151/69303/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/69303">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">After much hair loss, I have narrowed down one of several POE related  
memory leaks in a project I am working on &#40;on both AS Win32 and linux  
perls, 5.8.x&#41;:

POE::Filter::Reference

The culprit code seems to be:

delete $INC{$package . &#34;.pm&#34;};

eval {
         local $^W=0;
         require &#34;$package.pm&#34;;
         import $freezer &#40;&#41;;
};
carp $@ if $@;

Simply commenting out the delete line removed a very serious leak  
using POE::Wheel::SocketFactory + POE::Wheel::ReadWrite + filter.

To note, I had also tested the cookbook code @ <span class="clickylink"><a target="new" rel="nofollow" href="http://poe.perl.org/">http://poe.perl.org/</a></span>? 
POE_Cookbook/Application_Servers &#40;slightly altered to use YAML, to  
keep socket open and listen to a stress test version of the client  
that kept calling into the server&#41;, which also demonstrated the leak  
&#40;both client and server&#41;.

A non-POE YAML client, however didn&#39;t demonstrate the leak.  So then  
I tried storable, which also leaked in all but a non-POE version of  
the client.

So I started to look into this package, and hand calling  
POE::Filter::Reference outside of any POE framework showed that the  
leak was indeed in the new&#40;&#41; method.

I can&#39;t think of many serious problems with this change...anyone else  
have a thought on what badness removing the delete could cause.

Still some testing to do, but so far my code and the cookbook based  
version appear to be much much happier.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-191154" href="/Public/Bug/Display.html?id=18982#txn-191154">#</a>      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;29&nbsp;20:36:09&nbsp;2006</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/191154/69306/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/69306">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Could you send your test case?  It&#39;s sufficiently different from the
cookbook recipe that I can&#39;t re-create it myself.  Not for trying, but
my tries don&#39;t leak the way yours does.

On Sat Apr 29 20:32:40 2006, allend@Zoo.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; After much hair loss, I have narrowed down one of several POE related  
&gt; memory leaks in a project I am working on &#40;on both AS Win32 and linux  
&gt; perls, 5.8.x&#41;:
&gt; 
&gt; POE::Filter::Reference
&gt; 
&gt; The culprit code seems to be:
&gt; 
&gt; delete $INC{$package . &#34;.pm&#34;};
&gt; 
&gt; eval {
&gt;          local $^W=0;
&gt;          require &#34;$package.pm&#34;;
&gt;          import $freezer &#40;&#41;;
&gt; };
&gt; carp $@ if $@;
&gt; 
&gt; Simply commenting out the delete line removed a very serious leak  
&gt; using POE::Wheel::SocketFactory + POE::Wheel::ReadWrite + filter.
&gt; 
&gt; To note, I had also tested the cookbook code @ <span class="clickylink"><a target="new" rel="nofollow" href="http://poe.perl.org/">http://poe.perl.org/</a></span>? 
&gt; POE_Cookbook/Application_Servers &#40;slightly altered to use YAML, to  
&gt; keep socket open and listen to a stress test version of the client  
&gt; that kept calling into the server&#41;, which also demonstrated the leak  
&gt; &#40;both client and server&#41;.
&gt; 
&gt; A non-POE YAML client, however didn&#39;t demonstrate the leak.  So then  
&gt; I tried storable, which also leaked in all but a non-POE version of  
&gt; the client.
&gt; 
&gt; So I started to look into this package, and hand calling  
&gt; POE::Filter::Reference outside of any POE framework showed that the  
&gt; leak was indeed in the new&#40;&#41; method.
&gt; 
&gt; I can&#39;t think of many serious problems with this change...anyone else  
&gt; have a thought on what badness removing the delete could cause.
&gt; 
&gt; Still some testing to do, but so far my code and the cookbook based  
&gt; version appear to be much much happier.
&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-191155" href="/Public/Bug/Display.html?id=18982#txn-191155">#</a>      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;29&nbsp;20:36:11&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-191157" href="/Public/Bug/Display.html?id=18982#txn-191157">#</a>      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;29&nbsp;23:51:46&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> allend [...] zoo.org</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/191157/69309/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/69309">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">First, I only have some of the components left as bite size test 
scripts, but I have included those below.  I will try to recreate more 
as I have time, which is none atm.

Now, I have narrowed a couple things down and have an explanation as 
to why you don&#39;t see the leak.

Here is a break down of my findings so far:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">1&gt; 0.29 POE does not have the leak, it also does not try to delete the 
</div>serialization package from INC within POE::Filter::Reference.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">2&gt; Post version 0.29 POE, the leak only occurs when 
</div>POE::Filter::Reference-&gt;new&#40;&#41; is called.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">3&gt; 0.331 POE &#40;the one I was running until today now that 0.34 is 
</div>available via ppm&#41; has the leak when using POE::Component::Server::TCP.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">4&gt; 0.34 POE no longer leaks when using POE::Component::Server::TCP.  I 
</div>haven&#39;t verified, but my guess is that the filter is created once and 
then re-used.  I don&#39;t know how deep in this fix goes &#40;ie., 
Client::TCP, SocketFactory + Wheels w/filter&#41;.

While this means that POE::Component::Server might be ok &#40;now - and 
some yet to be determined by me subset of packages&#41;, there is the 
possibility that people will be bitten by this leak using 
POE::Filter::Reference outside of POE::Component::Server::TCP.  

It also means that anyone doing something like the following will have 
serious problems &#40;which includes me of course...&#41;:

POE::Session-&gt;create&#40; 
      inline_states =&gt;
      { _start          =&gt; sub { &#38;server_start&#40;$self,@_&#41;;       },
        server_accepted =&gt; sub { &#38;server_accepted&#40;$self,@_&#41;;    },
        server_error    =&gt; sub { &#38;server_error&#40;$self,@_&#41;;       },
        client_input    =&gt; sub { &#38;client_input&#40;$self,@_&#41;;       },
        client_error    =&gt; sub { &#38;client_error&#40;$self,@_&#41;;       },
        client_flush    =&gt; sub { &#38;client_error&#40;$self,@_&#41;;       },
      }, 
&#41;;

sub server_start {
    my $self = shift;
    $_[HEAP]-&gt;{server} = POE::Wheel::SocketFactory-&gt;new&#40; 
        BindPort        =&gt; $self-&gt;{port},
        SuccessEvent    =&gt; &#34;server_accepted&#34;,
        FailureEvent    =&gt; &#34;server_error&#34;,
    &#41;;
}

sub server_accepted {
  my $wheel = POE::Wheel::ReadWrite-&gt;new&#40;
       Handle           =&gt; $client_socket,
       InputEvent       =&gt; &#34;client_input&#34;,
       ErrorEvent       =&gt; &#34;client_error&#34;,
  &#41;;
  $wheel-&gt;set_filter&#40; POE::Filter::ReferenceFix-&gt;new&#40;&#34;YAML&#34;&#41; &#41;;
}

I have attached two test files, but they are now of limited use since:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">1&gt; version 0.34 appears to have done some corrections to the component 
</div>server.  The only one that should leak now is the client in &#34;filter&#34; 
test mode.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">2&gt; I don&#39;t have a POE kernel version of the client anymore...seems I 
</div>accidentaly cleaned it up.  


The real question is why is this delete happening anyway and is that 
worth anyone using POE::Filter::Reference running the risk of memory 
leaking?  

It isn&#39;t exactly helping with cleanup, it slows down the filter by 
forcing a reload of the package, and then challenging the universe to 
break something because your re-BEGINing a module &#40;which, at a minimum 
is causing warnings to spew out on packages like YAML&#41;.

Why is the the delete from INC there?

On Sat Apr 29 20:36:09 2006, RCAPUTO wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Could you send your test case?  It&#39;s sufficiently different from the
&gt; cookbook recipe that I can&#39;t re-create it myself.  Not for trying, 
</div>but
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; my tries don&#39;t leak the way yours does.
&gt; 
&gt; On Sat Apr 29 20:32:40 2006, allend@Zoo.org wrote:
<div class="message-stanza open">&gt; &gt; After much hair loss, I have narrowed down one of several POE 
</div></div>related  
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; memory leaks in a project I am working on &#40;on both AS Win32 and 
</div></div>linux  
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; perls, 5.8.x&#41;:
&gt; &gt; 
&gt; &gt; POE::Filter::Reference
&gt; &gt; 
&gt; &gt; The culprit code seems to be:
&gt; &gt; 
&gt; &gt; delete $INC{$package . &#34;.pm&#34;};
&gt; &gt; 
&gt; &gt; eval {
&gt; &gt;          local $^W=0;
&gt; &gt;          require &#34;$package.pm&#34;;
&gt; &gt;          import $freezer &#40;&#41;;
&gt; &gt; };
&gt; &gt; carp $@ if $@;
&gt; &gt; 
&gt; &gt; Simply commenting out the delete line removed a very serious leak  
&gt; &gt; using POE::Wheel::SocketFactory + POE::Wheel::ReadWrite + filter.
&gt; &gt; 
&gt; &gt; To note, I had also tested the cookbook code @ 
</div></div><span class="clickylink"><a target="new" rel="nofollow" href="http://poe.perl.org/">http://poe.perl.org/</a></span>? 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; POE_Cookbook/Application_Servers &#40;slightly altered to use YAML, 
</div></div>to  
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; keep socket open and listen to a stress test version of the 
</div></div>client  
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; that kept calling into the server&#41;, which also demonstrated the 
</div></div>leak  
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; &#40;both client and server&#41;.
&gt; &gt; 
&gt; &gt; A non-POE YAML client, however didn&#39;t demonstrate the leak.  So 
</div></div>then  
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I tried storable, which also leaked in all but a non-POE version 
</div></div>of  
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; the client.
&gt; &gt; 
&gt; &gt; So I started to look into this package, and hand calling  
&gt; &gt; POE::Filter::Reference outside of any POE framework showed that 
</div></div>the  
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; leak was indeed in the new&#40;&#41; method.
&gt; &gt; 
&gt; &gt; I can&#39;t think of many serious problems with this change...anyone 
</div></div>else  
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; have a thought on what badness removing the delete could cause.
&gt; &gt; 
&gt; &gt; Still some testing to do, but so far my code and the cookbook 
</div></div>based  
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; version appear to be much much happier.
&gt; &gt; 
&gt; &gt; 
</div>&gt; 
&gt; 
</div></div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/191157/69312/YServ.pl">Download YServ.pl</a><br />
<span class="downloadcontenttype">text/x-perl 999b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use warnings;
use strict;
use Storable;
use YAML;
use POE;
use POE::Filter::Reference;
use POE::Component::Server::TCP;
use Time::HiRes qw&#40;time&#41;;
use Data::Dumper;

our $DEBUG = 0;

POE::Component::Server::TCP-&gt;new
  &#40; Alias 	 =&gt; &#34;sum_server&#34;,
    Address      =&gt; &#34;localhost&#34;,
    Port         =&gt; 54321,
    ClientFilter =&gt; [ &#34;POE::Filter::Reference&#34;,&#34;YAML&#34; ],

    # Handle client requests here.

    ClientInput =&gt; sub {
        my &#40; $heap, $ref &#41; = @_[ HEAP, ARG0 ];

	$DEBUG &#38;&#38; print &#34;D: &#34;.Dumper&#40;$ref&#41;.&#34;\n&#34;;

	my $inc 	= $ref-&gt;[0]-&gt;{&#39;Inc&#39;};
	my $ctime 	= $ref-&gt;[0]-&gt;{&#39;Time&#39;};

	print &#34;Client said: $inc , $ctime \n&#34;;
	
        $heap-&gt;{client}-&gt;put&#40;{
		Inc  		=&gt; $inc ,
            	ClientTime  	=&gt; $ctime ,
            	ServerTime  	=&gt; time&#40;&#41; ,		       
	}&#41;;
    },

    ClientDisconnected =&gt; sub {
        my $kernel = $_[KERNEL];
	print &#34;ClientDisconnected\n&#34;;
        $kernel-&gt;yield&#40;&#34;shutdown&#34;&#41;;
    },
&#41;;

$poe_kernel-&gt;run&#40;&#41;;
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/191157/69315/YClientNoKernel.pl">Download YClientNoKernel.pl</a><br />
<span class="downloadcontenttype">text/x-perl 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use warnings;

use YAML;
use IO::Socket;
use Data::Dumper;
use Time::HiRes qw&#40;time&#41;;
use POE::Filter::Reference;

$testcase = &#39;raw&#39;;

for &#40;1 .. 100000&#41; {

  if &#40;$testcase = &#39;raw&#39;&#41; {
    my &#40;@resp&#41; = callYAML&#40;&#39;127.0.0.1&#39;, 
	      {
		&#39;Inc&#39;	=&gt; $_,
        	&#39;Time&#39; 	=&gt; time&#40;&#41;,
	      }
    &#41;;
  }
  else {
    my &#40;@resp&#41; = callFilter&#40;&#39;127.0.0.1&#39;,
	      {
		&#39;Inc&#39;	=&gt; $_,
        	&#39;Time&#39; 	=&gt; time&#40;&#41;,
	      }
    &#41;;
  }
  print &#34;Response $_ : &#34;.Dumper&#40;\@resp&#41;.&#34;\n&#34;;
}

sub callYAML {
#=============================================================================
#|
#| Use:    $response = $o-&gt;call&#40;action,@params&#41;;
#| Info:   Call into an zPlay RPC interface.  @params is determined by the
#|         format required by the function you are calling.
#|
#=============================================================================
  my $host	= shift;

  my $sock = IO::Socket::INET-&gt;new&#40;
	  PeerAddr 	=&gt; $host,
          PeerPort 	=&gt; 54321,
          Proto    	=&gt; &#39;tcp&#39;,
	  Timeout	=&gt; 3, 
  &#41;;
  if &#40;! defined $sock&#41; {
    warn&#40;&#34;Unable to create socket to yaml server&#34;&#41;;
    return undef;
  }
  $sock-&gt;autoflush&#40;1&#41;;

  my $y = YAML::Dump&#40;[@_]&#41;;

  $sock-&gt;print&#40;length&#40;$y&#41;.chr&#40;0&#41;.$y&#41;; 

  my $r = $sock-&gt;getline&#40;&#41;;
  my $null = chr&#40;0&#41;;
  my &#40;@lp&#41; = split /$null\-\-\-/,$r;
  $lp[0]  = &#40;$lp[0]*1&#41;-length&#40;$r&#41;+length&#40;$lp[0]&#41;+1; # futz with read lengths...guess here

  my $buf;
  $sock-&gt;read&#40;$buf,$lp[0]&#41;;
  $sock-&gt;shutdown&#40;2&#41;;

  return &#40;&#39;RawYaml&#39;,YAML::Load&#40;$buf&#41;&#41;;
}

sub callFilter {
  my $host	= shift;

  my $sock = IO::Socket::INET-&gt;new&#40;
	  PeerAddr 	=&gt; $host,
          PeerPort 	=&gt; 54321,
          Proto    	=&gt; &#39;tcp&#39;,
	  Timeout	=&gt; 3, 
  &#41;;
  if &#40;! defined $sock&#41; {
    warn&#40;&#34;Unable to create socket to yaml server&#34;&#41;;
    return undef;
  }
  $sock-&gt;autoflush&#40;1&#41;;

  my $filter = POE::Filter::Reference-&gt;new&#40;&#34;YAML&#34;&#41;;

  my $y = $filter-&gt;put&#40;[\@_]&#41;;

  $sock-&gt;print&#40;$y-&gt;[0]&#41;; 
  my $r = $sock-&gt;getline&#40;&#41;;
  my $null = chr&#40;0&#41;;
  my &#40;@lp&#41; = split /$null\-\-\-/,$r;
  $lp[0]  = &#40;$lp[0]*1&#41;-length&#40;$r&#41;+length&#40;$lp[0]&#41;+1; # futz with read lengths...guess here

  my $buf;
  $sock-&gt;read&#40;$buf,$lp[0]&#41;;
  $sock-&gt;shutdown&#40;2&#41;;
  return &#40;&#39;Poe::Filter&#39;,$r&#41;;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-191160" href="/Public/Bug/Display.html?id=18982#txn-191160">#</a>      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;29&nbsp;23:57:40&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> allend [...] zoo.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/191160/69318/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/69318">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 324b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hmm....never used RT before, but it seems to have eaten part of the 
message in the web interface, but emailed the message in a complete 
form.

Probably choked on my number scheme....urg.

Anyway, be sure to read to read my bug update message in the mailing 
list, not in the RT interface.

- Donovan Allen &#40;allend@zoo.org&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-214599" href="/Public/Bug/Display.html?id=18982#txn-214599">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;27&nbsp;22:00:13&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Donovan Allen &#40;allend [...] zoo.org&#41;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/214599/85305/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/85305">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The problem and the solution are dead simple...

However, I haven&#39;t found a decent way to detect this memory leak from
within the running process itself, especially in an OS neutral way &#40;if
there really is one&#41;, so while I have an example of the problem
&#40;attached&#41; I don&#39;t have a proper test case atm.  

Any suggestions are welcome, although due to the simplicity of the
problem &#40;AND SOLUTION&#41;, I really think this might be overkill anyway.

As it stands, you have to let it run and use top or task manager to
watch the memory top the charts of &#34;Greatest Memory Hits of 2006&#34;.

The code in question is:

POE/Filter/Reference.pm

100:      $package =~ s&#40;::&#41;&#40;\/&#41;g;
101:      delete $INC{$package . &#34;.pm&#34;};
102:
103:      eval {
104:        local $^W=0;
105:        require &#34;$package.pm&#34;;
106:        import $freezer &#40;&#41;;
107:      };
109:      carp $@ if $@;

Since this chunk of code is in the new method, I presume it is being
done to force a reload of the module, rather than memory savings.

The problem, as I guess at it, is that simply removing the package name
from the %INC table &#40;which is just a &#34;record&#34; keeping device...no?&#41; is
not cleaning up any or all of the associated Symbol table data for the
module &#40;and who knows what else&#41;.

Every time a new POE::Filter::Reference is created, regardless if we
have already used that Reference Filter, it is forced to reload the
underlying module without the deep vodoo of the perl guts noticing that
it needs to clean up something &#40;if it even can&#41;.

The solution is simple!  We delete line 101, which reads as:
101:      delete $INC{$package . &#34;.pm&#34;};

100:      $package =~ s&#40;::&#41;&#40;\/&#41;g;
101: # LINE DELETED
102:
103:      eval {
104:        local $^W=0;
105:        require &#34;$package.pm&#34;;
106:        import $freezer &#40;&#41;;
107:      };
109:      carp $@ if $@;

Viola, memory leak is gone!  

If forcing a module reload is that vital, I suggest following in the
footsteps of others:

* Symbol.pm using delete_package
* ModPerl::Util::unload_module &#40;maybe they did something magic&#41;
* <span class="clickylink"><a target="new" rel="nofollow" href="http://cpan.uwinnipeg.ca/search?query=reload&#38;mode=dist">http://cpan.uwinnipeg.ca/search?query=reload&#38;mode=dist</a></span>

However, unless having a running &#40;and possibly even running in
production&#41; script being able to load updated modules on the fly is an
important requirement, I would lose it.  
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/214599/85308/pfr_memleak.pl">Download pfr_memleak.pl</a><br />
<span class="downloadcontenttype">text/x-perl 291b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use warnings;
use Time::HiRes qw&#40;sleep time&#41;;
use POE::Filter::Reference;

for &#40;1 .. 10000&#41; {
  my $filter = POE::Filter::Reference-&gt;new&#40;&#34;Storable&#34;&#41;;
  my $f = $filter-&gt;put&#40;[ [&#39;Freeze&#39;,&#39;Me&#39;] ]&#41;;
  my $t = $filter-&gt;get&#40;$f&#41;;
  sleep&#40;0.01&#41;;
  next;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-230445" href="/Public/Bug/Display.html?id=18982#txn-230445">#</a>      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;06&nbsp;17:55:18&nbsp;2006</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/230445/96209/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/96209">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 593b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, Allen.  Apologies for the delay.  I&#39;ve committed this fix as
revision 2021, and it&#39;ll be in the next CPAN release.  Thanks for
hunting it down and recommending a solution.

You&#39;re right about reloading the module, and I&#39;m not really sure which
direction I want to go with this.  I think ultimately it might be best
if the user also uses the appropriate serializer module rather than
relying on POE::Filter::Reference to do so.  As I mentioned in the
change log: It&#39;s better to have a noisy error than a silent but deadly one.

Let me know if you run into any other problems.

Thanks again.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-230448" href="/Public/Bug/Display.html?id=18982#txn-230448">#</a>      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;06&nbsp;17:55:20&nbsp;2006</span>
    <span class="description">RCAPUTO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.603395</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
