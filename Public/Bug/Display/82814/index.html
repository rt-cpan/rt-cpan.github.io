<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #82814 for Class-DBI-DATA-Schema: </title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #82814 for Class-DBI-DATA-Schema: </h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Class-DBI-DATA-Schema/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Class-DBI-DATA-Schema/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Class-DBI-DATA-Schema/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Class-DBI-DATA-Schema/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Class-DBI-DATA-Schema">Class-DBI-DATA-Schema CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">82814</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Class-DBI-DATA-Schema/Active/">Class-DBI-DATA-Schema</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
wftk [...] vivtek.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-6718-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-6719-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;18&nbsp;16:04:57&nbsp;2013</span>
    <span class="description">wftk [...] vivtek.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">After some flabbergasted investigation, I finally figured out what the 
problem is that prevents the test from passing.

Your scheme of translating only those statements that SQLFairy 
understands, and passing through the rest unchanged, is a great one - 
except it looks as though about 2005 or 2006, SQLFairy started *parsing* 
INSERT commands without *handling* them.  The result is that it returns 
a BEGIN TRANSACTION and COMMIT TRANSACTION wrapped around a blank 
statement for the SQLite insert, and your pass-through code therefore 
doesn&#39;t emit an INSERT, and the test for having the right number of rows 
in the table thus fails.

The cheap fix is to use REPLACE INTO in the test, which isn&#39;t picked up 
by the SQLFairy parser but has the same effect in the test, and allows a 
pass.  A better fix would be to avoid sending INSERT to SQLFairy in the 
first place, which is sadly less elegant than your solution but has the 
advantage of working when schemas include INSERT to load the tables.

The reason CPANtesters list passing tests, by the way, is that the tests 
don&#39;t run on machines where SQLite isn&#39;t installed.  Apparently about 
half of the testing machines don&#39;t have SQLite installed in the test 
environment unless you specify it as a dependency &#40;which clearly 
wouldn&#39;t be the right thing to do&#41;.

Incidentally, I learned a lot from reading your code.  It&#39;s really 
cleverly written.

This module is a prerequisite for Email::Storage, which is how I came 
across it.  I&#39;d appreciate it if you could update - or I can if you 
don&#39;t want to bother.  I want to use Email::Storage, possibly eventually 
in a product even.  &#40;Although at the speed I work, we&#39;ll all have brain 
interfaces to the cloud by then and email will be long obsolete.&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;16&nbsp;15:54:54&nbsp;2013</span>
    <span class="description">wftk [...] vivtek.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> More information and patch</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> modules [...] perl.org</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">A little more information about this long-standing bug &#40;RT ticket 
#82814&#41;.

First, the change in behavior in SQL::Translator probably happened about 
2008 and involved wrapping transaction commit statements around the 
return value.  The problem was that if SQL::Translator&#39;s SQLite output 
module didn&#39;t find any actionable statements, it would still return 
begin transaction/commit statements, so your groovy fall-back code that 
would just use the INSERT didn&#39;t get a chance to work - it made it 
appear that SQL::Translator had translated them.

I didn&#39;t like the idea of cluttering your code with an explicit INSERT 
detector, so I&#39;ve submitted a patch to the SQLite output module &#40;with 
the agreement of the SQL::Translator maintainers&#41; and hopefully that 
will be cleared up next time they post a new version to CPAN.

Once that was working, though, it revealed another problem with the 
tests - your scheme of letting the error for reinvocation of the setup 
fall through to the caller doesn&#39;t work any more.  I added a flag 
&#40;already_called&#41; and an explicit check for the flag, which also allows 
us to return a better error message.  Once the SQL::Translator patch is 
in the CPAN distro, this patch will allow Class::DBI::DATA::Schema to 
install cleanly again.

I&#39;ve attached a patch to this bug report; alternatively, I&#39;ve also set 
up a version update to 1.01 on Github at 
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/Vivtek/Class-DBI-DATA-Schema">https://github.com/Vivtek/Class-DBI-DATA-Schema</a></span> if you don&#39;t want to 
mess with it &#40;in other words, I&#39;m offering to take over co-maintainer 
status, which shouldn&#39;t make much difference, since honestly very little 
should ever need much maintenance in this module.&#41;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Class-DBI-patch.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">*** Class-DBI-DATA-Schema-1.00/lib/Class/DBI/DATA/Schema.pm	2005-09-03 22:19:23.000000000 +0200
--- Class-DBI-DATA-Schema/lib/Class/DBI/DATA/Schema.pm	2013-03-16 20:39:41.744198600 +0100
***************
*** 120,134 ****
--- 120,139 ----
  		chomp&#40;my $sql = &lt;$h&gt;&#41;;
  		return grep /\S/, split /;/, $translating ? $transform-&gt;&#40;$sql&#41; : $sql;
  	};
  
  	my %cache;
+ 	
+ 	my $already_run = 0;
  
  	no strict &#39;refs&#39;;
  	*{&#34;$caller\::run_data_sql&#34;} = sub {
  		my $class = shift;
+ 		die &#34;Data SQL already run&#34; if $already_run;
  		no strict &#39;refs&#39;;
  		$cache{$class} ||= [ $get_statements-&gt;&#40;*{&#34;$class\::DATA&#34;}{IO}&#41; ];
  		$class-&gt;db_Main-&gt;do&#40;$_&#41; foreach @{ $cache{$class} };
+ 		$already_run = 1;
  		return 1;
  		}
  
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;16&nbsp;15:54:55&nbsp;2013</span>
    <span class="description">wftk [...] vivtek.com -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;16&nbsp;16:31:09&nbsp;2013</span>
    <span class="description">wftk [...] vivtek.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Argh - disregard that last patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">That patch won&#39;t work, as it&#39;s just checking whether 
Class::DBI::Data::Schema has *ever* been imported.  That was stupid.

Back to the ol&#39; drawing board.  I shall keep you posted.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;16&nbsp;16:39:56&nbsp;2013</span>
    <span class="description">wftk [...] vivtek.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> A patch that actually works as intended</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Obviously, the flag needs to be kept *per class*, just like the SQL 
statements.  Sorry about that.  The patch attached not only passes tests, 
it also works when used with *other* modules - much better!

On Sat Mar 16 16:31:09 2013, Michael wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That patch won&#39;t work, as it&#39;s just checking whether 
&gt; Class::DBI::Data::Schema has *ever* been imported.  That was stupid.
&gt; 
&gt; Back to the ol&#39; drawing board.  I shall keep you posted.
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Class-DBI-patch.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">*** Class-DBI-DATA-Schema-1.00/lib/Class/DBI/DATA/Schema.pm	2005-09-03 22:19:23.000000000 +0200
--- Class-DBI-DATA-Schema/lib/Class/DBI/DATA/Schema.pm	2013-03-16 21:34:46.556223000 +0100
***************
*** 122,134 ****
--- 122,137 ----
  	};
  
  	my %cache;
+ 	my %already_run;
  
  	no strict &#39;refs&#39;;
  	*{&#34;$caller\::run_data_sql&#34;} = sub {
  		my $class = shift;
+ 		die &#34;Data SQL already run&#34; if $already_run{$class};
  		no strict &#39;refs&#39;;
  		$cache{$class} ||= [ $get_statements-&gt;&#40;*{&#34;$class\::DATA&#34;}{IO}&#41; ];
  		$class-&gt;db_Main-&gt;do&#40;$_&#41; foreach @{ $cache{$class} };
+ 		$already_run{$class} = 1;
  		return 1;
  		}
  
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
