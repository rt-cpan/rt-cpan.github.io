<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #77647 for Excel-Template: Non-Unicode encoding support &#40;patches included&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #77647 for Excel-Template: Non-Unicode encoding support &#40;patches included&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Excel-Template/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Excel-Template/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Excel-Template/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Excel-Template/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Excel-Template">Excel-Template CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">77647</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Excel-Template/Active/">Excel-Template</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
eflitman [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-12352-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.31</li>
<li>
0.31_1</li>
<li>
0.32</li>
<li>
0.33</li>
<li>
0.34</li>
</ul>
    </td>
  </tr>
  <tr id="CF-12353-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;05&nbsp;19:20:41&nbsp;2012</span>
    <span class="description">eflitman [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Non-Unicode encoding support &#40;patches included&#41;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Proposal for non-Unicode encoding support &#40;included patches for
v.0.31..0.34&#41;.

If we need to use non-Unicode/non-Latin encodings, we have to support it
in 2 ways:

1&#41; Template file in non-Unicode encoding - this is easily achieved by
proper heading in XML file, e.g.:

&lt;?xml version=&#39;1.0&#39; encoding=&#39;windows-1251&#39;?&gt;

This requires no code changes, it is handled by XML parser transparently.

2&#41; Support for variable substitution if variables contain strings in
non-Unicode encodings.

To solve this task the patches are proposed:
Var.pm.patch - to support variable substitution &lt;VAR NAME=&#39;param&#39;/&gt; if
it contains text in specific encoding
Context.pm - to similarly handle implicit substitution like &lt;WORKSHEET
NAME=&#39;$VaraibleName&#39;/&gt;

To use new functionality, we need to specify attribute
VAR_ENC=&#39;&lt;encoding-name&gt;&#39; somewhere within the current context &#40;from
this variable up to entire worksheet&#41;. I personally work with Cyrillic
windows-1251 encoding both in template files and variables, so my
typical template starts with:

&lt;?xml version=&#39;1.0&#39; encoding=&#39;windows-1251&#39;?&gt;
&lt;workbook&gt;
  &lt;worksheet name=&#39;SomeExcelTable&#39; var_enc=&#39;windows-1251&#39;&gt;
  ......

The attribute name is not too pretty but reminds of what is actually
encoded.

The patch for Var.pm is tested and works for me. The patch for
Context.pm probably needs some testing &#40;I&#39;m not sure I&#39;ve tested it&#41;.

Decoding itself is performed by Encode, so I suppose Perl versions 5.6+
and probably earlier should support it. The &#39;use Encode&#39; line should
probably be placed somewhere else and made dependent of Perl version
&#40;the patches are actually just a quick hack to minimize patching&#41;.

Would be great to include this support into next release.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Var.pm.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">12c12,22
&lt; sub resolve { &#40;$_[1]&#41;-&gt;param&#40;$_[1]-&gt;resolve&#40;$_[0], &#39;NAME&#39;&#41;&#41; }
---
&gt; sub resolve {                                                     # - support for VAR value encoding
&gt;   my $self = shift ;                                              #
&gt;   my &#40;$context&#41; = @_ ;                                            #
&gt;   my $val = $context-&gt;param&#40;$context-&gt;resolve&#40;$self, &#39;NAME&#39;&#41;&#41;;    #
&gt;   my $enc = $context-&gt;get&#40;$self, &#34;VAR_ENC&#34;&#41; ;                     #
&gt;   if &#40;$enc&#41; {                                                     #
&gt;     require Encode ;                                              #
&gt;     $val = Encode::decode&#40; $enc, $val &#41; ;                         #
&gt;   }                                                               #
&gt;   return $val ;                                                   #
&gt; }                                                                 #
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Context.pm.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">100,101c100,107
&lt;     $obj_val = $self-&gt;param&#40;$1&#41;
&lt;         if $obj_val =~ /^\$&#40;\S+&#41;$/o;
---
&gt;     if &#40;$obj_val =~ /^\$&#40;\S+&#41;$/o&#41; {                       #  - to support variable substitution
&gt;         $obj_val = $self-&gt;param&#40;$1&#41; ;                     #  - in constructions like this:
&gt;         my $enc = $self-&gt;get&#40;$obj, &#34;VAR_ENC&#34;&#41; ;           #     &lt;var name=&#34;$SomeParam&#34;/&gt;                 
&gt;         if &#40;$enc&#41; {                                       #  - &#40;in case the variable contains text in non-Unicode encoding&#41;
&gt;           require Encode ;                                #
&gt;           $obj_val = Encode::decode&#40; $enc, $obj_val &#41; ;   #
&gt;         }                                                 #
&gt;     }                                                     #
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
