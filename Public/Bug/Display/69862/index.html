<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #69862 for namespace-clean: t/author-07-debugger.t fails with 5.14.1</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #69862 for namespace-clean: t/author-07-debugger.t fails with 5.14.1</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/namespace-clean/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/namespace-clean/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/namespace-clean/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/namespace-clean/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/namespace-clean">namespace-clean CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">69862</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/namespace-clean/Active/">namespace-clean</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
paul [...] city-fan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-42514-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.20    </td>
  </tr>
  <tr id="CF-42515-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.22    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;28&nbsp;10:23:35&nbsp;2011</span>
    <span class="description">paul [...] city-fan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> t/author-07-debugger.t fails with 5.14.1</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Not sure if you&#39;re aware of this, or if it&#39;s a problem with the test or
the module itself, so I thought I&#39;d better report it:

$ make test AUTHOR_TESTING=1 RELEASE_TESTING=1
PERL_DL_NONLAZY=1 /usr/bin/perl &#34;-MExtUtils::Command::MM&#34; &#34;-e&#34;
&#34;test_harness&#40;0, &#39;blib/lib&#39;, &#39;blib/arch&#39;&#41;&#34; t/*.t
t/00-basic.t .............. ok
t/01-function-wipeout.t ... ok
t/02-inheritance.t ........ ok
t/03-unimport.t ........... ok
t/04-except.t ............. ok
t/05-explicit-cleanee.t ... ok
t/06-other-types.t ........ ok
t/08-const-sub.t .......... ok
Loading DB routines from perl5db.pl version 1.33
Editor support available.
Enter h or `h h&#39; for help, or `man perldebug&#39; for more help.
main::&#40;t/author-07-debugger.t:21&#41;:          package Foo;
Undefined subroutine &#38;Foo::foo called at /usr/share/perl5/perl5db.pl
line 3737.
 at /usr/share/perl5/perl5db.pl line 3737
        Foo::bar&#40;&#39;Foo&#39;&#41; called at t/author-07-debugger.t line 37
# Tests were run but no plan was declared and done_testing&#40;&#41; was not seen.
t/author-07-debugger.t ....
Dubious, test returned 255 &#40;wstat 65280, 0xff00&#41;
All 3 subtests passed
t/release-eol.t ........... ok
t/release-no-tabs.t ....... ok
t/release-pod-coverage.t .. ok
t/release-pod-syntax.t .... ok
Test Summary Report
-------------------
t/author-07-debugger.t  &#40;Wstat: 65280 Tests: 3 Failed: 0&#41;
  Non-zero exit status: 255
  Parse errors: No plan found in TAP output
Files=13, Tests=128,  0 wallclock secs &#40; 0.05 usr  0.02 sys +  0.59 cusr
 0.09 csys =  0.75 CPU&#41;
Result: FAIL
Failed 1/13 test programs. 0/128 subtests failed.

This is with perl 5.14.1 in Fedora&#39;s current development branch.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;14&nbsp;18:48:15&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jul 28 10:23:35 2011, paul@city-fan.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Not sure if you&#39;re aware of this, or if it&#39;s a problem with the test or
&gt; the module itself, so I thought I&#39;d better report it:
&gt; 
&gt; $ make test AUTHOR_TESTING=1 RELEASE_TESTING=1
&gt; PERL_DL_NONLAZY=1 /usr/bin/perl &#34;-MExtUtils::Command::MM&#34; &#34;-e&#34;
&gt; &#34;test_harness&#40;0, &#39;blib/lib&#39;, &#39;blib/arch&#39;&#41;&#34; t/*.t
&gt; t/00-basic.t .............. ok
&gt; t/01-function-wipeout.t ... ok
&gt; t/02-inheritance.t ........ ok
&gt; t/03-unimport.t ........... ok
&gt; t/04-except.t ............. ok
&gt; t/05-explicit-cleanee.t ... ok
&gt; t/06-other-types.t ........ ok
&gt; t/08-const-sub.t .......... ok
&gt; Loading DB routines from perl5db.pl version 1.33
&gt; Editor support available.
&gt; Enter h or `h h&#39; for help, or `man perldebug&#39; for more help.
&gt; main::&#40;t/author-07-debugger.t:21&#41;:          package Foo;
&gt; Undefined subroutine &#38;Foo::foo called at /usr/share/perl5/perl5db.pl
&gt; line 3737.
&gt;  at /usr/share/perl5/perl5db.pl line 3737
&gt;         Foo::bar&#40;&#39;Foo&#39;&#41; called at t/author-07-debugger.t line 37
&gt; # Tests were run but no plan was declared and done_testing&#40;&#41; was not seen.
&gt; t/author-07-debugger.t ....
&gt; Dubious, test returned 255 &#40;wstat 65280, 0xff00&#41;
&gt; All 3 subtests passed
&gt; t/release-eol.t ........... ok
&gt; t/release-no-tabs.t ....... ok
&gt; t/release-pod-coverage.t .. ok
&gt; t/release-pod-syntax.t .... ok
&gt; Test Summary Report
&gt; -------------------
&gt; t/author-07-debugger.t  &#40;Wstat: 65280 Tests: 3 Failed: 0&#41;
&gt;   Non-zero exit status: 255
&gt;   Parse errors: No plan found in TAP output
&gt; Files=13, Tests=128,  0 wallclock secs &#40; 0.05 usr  0.02 sys +  0.59 cusr
&gt;  0.09 csys =  0.75 CPU&#41;
&gt; Result: FAIL
&gt; Failed 1/13 test programs. 0/128 subtests failed.
&gt; 
&gt; This is with perl 5.14.1 in Fedora&#39;s current development branch.
</div>
I haven’t looked very far, but I wonder whether this is related to 
&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/rt3/Ticket/Display.html?id=48332">https://rt.perl.org/rt3/Ticket/Display.html?id=48332</a></span>&gt;, since the test is skipped in 5.8.8.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;14&nbsp;18:48:16&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;14&nbsp;21:04:25&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> andreas.koenig.7os6VVqR [...] franz.ak.mind.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Nov 14 18:48:15 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Jul 28 10:23:35 2011, paul@city-fan.org wrote:
<div class="message-stanza open">&gt; &gt; Not sure if you&#39;re aware of this, or if it&#39;s a problem with the test
</div>&gt; or
<div class="message-stanza open">&gt; &gt; the module itself, so I thought I&#39;d better report it:
&gt; &gt;
&gt; &gt; $ make test AUTHOR_TESTING=1 RELEASE_TESTING=1
&gt; &gt; PERL_DL_NONLAZY=1 /usr/bin/perl &#34;-MExtUtils::Command::MM&#34; &#34;-e&#34;
&gt; &gt; &#34;test_harness&#40;0, &#39;blib/lib&#39;, &#39;blib/arch&#39;&#41;&#34; t/*.t
&gt; &gt; t/00-basic.t .............. ok
&gt; &gt; t/01-function-wipeout.t ... ok
&gt; &gt; t/02-inheritance.t ........ ok
&gt; &gt; t/03-unimport.t ........... ok
&gt; &gt; t/04-except.t ............. ok
&gt; &gt; t/05-explicit-cleanee.t ... ok
&gt; &gt; t/06-other-types.t ........ ok
&gt; &gt; t/08-const-sub.t .......... ok
&gt; &gt; Loading DB routines from perl5db.pl version 1.33
&gt; &gt; Editor support available.
&gt; &gt; Enter h or `h h&#39; for help, or `man perldebug&#39; for more help.
&gt; &gt; main::&#40;t/author-07-debugger.t:21&#41;:          package Foo;
&gt; &gt; Undefined subroutine &#38;Foo::foo called at /usr/share/perl5/perl5db.pl
&gt; &gt; line 3737.
&gt; &gt;  at /usr/share/perl5/perl5db.pl line 3737
&gt; &gt;         Foo::bar&#40;&#39;Foo&#39;&#41; called at t/author-07-debugger.t line 37
&gt; &gt; # Tests were run but no plan was declared and done_testing&#40;&#41; was not
</div>&gt; seen.
<div class="message-stanza open">&gt; &gt; t/author-07-debugger.t ....
&gt; &gt; Dubious, test returned 255 &#40;wstat 65280, 0xff00&#41;
&gt; &gt; All 3 subtests passed
&gt; &gt; t/release-eol.t ........... ok
&gt; &gt; t/release-no-tabs.t ....... ok
&gt; &gt; t/release-pod-coverage.t .. ok
&gt; &gt; t/release-pod-syntax.t .... ok
&gt; &gt; Test Summary Report
&gt; &gt; -------------------
&gt; &gt; t/author-07-debugger.t  &#40;Wstat: 65280 Tests: 3 Failed: 0&#41;
&gt; &gt;   Non-zero exit status: 255
&gt; &gt;   Parse errors: No plan found in TAP output
&gt; &gt; Files=13, Tests=128,  0 wallclock secs &#40; 0.05 usr  0.02 sys +  0.59
</div>&gt; cusr
<div class="message-stanza open">&gt; &gt;  0.09 csys =  0.75 CPU&#41;
&gt; &gt; Result: FAIL
&gt; &gt; Failed 1/13 test programs. 0/128 subtests failed.
&gt; &gt;
&gt; &gt; This is with perl 5.14.1 in Fedora&#39;s current development branch.
</div>&gt; 
&gt; I haven’t looked very far, but I wonder whether this is related to
&gt; &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/rt3/Ticket/Display.html?id=48332">https://rt.perl.org/rt3/Ticket/Display.html?id=48332</a></span>&gt;, since the test
&gt; is skipped in 5.8.8.
</div>
I’m now not so sure it is, but this will be much easier to track down with a binary search.  I’m 
cc’ing Andreas König, since he has everything set up to do that already.

Andreas, is it easy enough for you to do a binary search that runs

    perl -Mblib xt/author/07-debugger.t

after building namespace::clean?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;16&nbsp;02:04:37&nbsp;2011</span>
    <span class="description">ANDK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">v5.13.5-258-gbe1cc45

commit be1cc4519b5ba35ec8c5b8a2b4a62c72cff05a2e
Author: Father Chrysostomos &lt;sprout@cpan.org&gt;
Date:   Thu Sep 30 23:48:56 2010 -0700

    [perl #48332] Debugger corrupts symbol table munging


Yes, it is easy enough:&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;17&nbsp;19:21:42&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Nov 16 02:04:37 2011, ANDK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; v5.13.5-258-gbe1cc45
&gt; 
&gt; commit be1cc4519b5ba35ec8c5b8a2b4a62c72cff05a2e
&gt; Author: Father Chrysostomos &lt;sprout@cpan.org&gt;
&gt; Date:   Thu Sep 30 23:48:56 2010 -0700
&gt; 
&gt;     [perl #48332] Debugger corrupts symbol table munging
&gt; 
&gt; 
&gt; Yes, it is easy enough:&#41;
</div>
So it’s my fault. All I did was restore the previous behaviour by undoing a refactoring &#40;which 
was only supposed to be a refactoring, but actually changed the logic&#41;, in order to fix a bug 
introduced by that refactoring.

That would explain why 5.8.8 and 5.14.0 behave exactly the same way.

Now I need to learn more about the debugger....
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;17&nbsp;19:40:07&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Nov 17 19:21:42 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Nov 16 02:04:37 2011, ANDK wrote:
<div class="message-stanza open">&gt; &gt; v5.13.5-258-gbe1cc45
&gt; &gt;
&gt; &gt; commit be1cc4519b5ba35ec8c5b8a2b4a62c72cff05a2e
&gt; &gt; Author: Father Chrysostomos &lt;sprout@cpan.org&gt;
&gt; &gt; Date:   Thu Sep 30 23:48:56 2010 -0700
&gt; &gt;
&gt; &gt;     [perl #48332] Debugger corrupts symbol table munging
&gt; &gt;
&gt; &gt;
&gt; &gt; Yes, it is easy enough:&#41;
</div>&gt; 
&gt; So it’s my fault. All I did was restore the previous behaviour by
&gt; undoing a refactoring &#40;which
&gt; was only supposed to be a refactoring, but actually changed the
&gt; logic&#41;, in order to fix a bug
&gt; introduced by that refactoring.
&gt; 
&gt; That would explain why 5.8.8 and 5.14.0 behave exactly the same way.
&gt; 
&gt; Now I need to learn more about the debugger....
&gt; 
</div>


When DB::sub&#40;&#41; is about to be called &#40;to handle a sub call under the debugger&#41;, $DB::sub is 
set to the name of the sub or a reference to the sub.

Every CV &#40;subroutine&#41; has a pointer to the GV &#40;typeglob&#41; it was defined in.  Every GV obviously 
has a CV slot.  ‘entersub’ refers to the subroutine-call operator &#40;&#38;foo or foo&#40;&#41;&#41;.  Usually the 
argument to entersub is a GV &#40;as in foo&#40;&#41;&#41; or a CV ref &#40;&#40;\&#38;foo&#41;-&gt;&#40;&#41;&#41;.

The logic in 5.8.8 and 5.14.0 is &#40;from util.c:Perl_get_db_sub&#41;:

If the subroutine
       is anonymous
    or is named END
    or &#40;
         is not being called from the glob it was defined in
         and
         &#40;
             the argument to entersub is not a GV
          or the CV in the GV argument to entersub is not the current CV
               &#40;e.g., autoloading&#41;
         &#41;
       &#41;
then put a code reference in $DB::sub
else put the name of the GV argument to entersub in $DB::sub

In 5.8.9-5.12, the else is:

else put the name of the CV’s GV in $DB::sub

That inadvertent change in 5.8.9 made *a = \&#38;b effectively substitute b&#40;&#41; for a&#40;&#41;, causing 
bugs, which is why I reverted it.

That would explain why changing the subroutine’s name &#40;which I believe entails creating a 
glob with that name and changing the CV’s GV pointer to point to it&#41; works.

I think that initial logic is faulty in all Perl versions.  Now I just need to think of a workaround.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;17&nbsp;20:55:24&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Nov 17 19:40:07 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The logic in 5.8.8 and 5.14.0 is &#40;from util.c:Perl_get_db_sub&#41;:
&gt; 
&gt; If the subroutine
&gt;        is anonymous
&gt;     or is named END
&gt;     or &#40;
&gt;          is not being called from the glob it was defined in
</div>
Actually, that bit is ‘does not reside in the glob in which it was defined’.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;          and
&gt;          &#40;
&gt;              the argument to entersub is not a GV
&gt;           or the CV in the GV argument to entersub is not the current
&gt; CV
&gt;                &#40;e.g., autoloading&#41;
&gt;          &#41;
&gt;        &#41;
&gt; then put a code reference in $DB::sub
&gt; else put the name of the GV argument to entersub in $DB::sub
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;17&nbsp;21:23:03&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Nov 17 19:40:07 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think that initial logic is faulty in all Perl versions.  Now I just
&gt; need to think of a workaround.
</div>
I believe that renaming the GV itself &#40;the one bound to the ops&#41; and inserting it into the symbol 
table under its new name will solve the problem. I don’t know whether there are any CPAN 
modules that do that already. If I can’t find a way to do it in pure Perl, would you be willing to 
maintain an XS module? I have enough modules already. :-&#41;

That code in perl is *so* buggy. There are so many things wrong with that logic. You shouldn’t 
have to do any of these workarounds. You probably won’t have to in 5.16. :-&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;17&nbsp;21:26:17&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Nov 17 21:23:03 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Nov 17 19:40:07 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; I think that initial logic is faulty in all Perl versions.  Now I
</div>&gt; just
<div class="message-stanza open">&gt; &gt; need to think of a workaround.
</div>&gt; 
&gt; I believe that renaming the GV itself &#40;the one bound to the ops&#41; and
&gt; inserting it into the symbol
&gt; table under its new name will solve the problem. I don’t know whether
&gt; there are any CPAN
&gt; modules that do that already. If I can’t find a way to do it in pure
&gt; Perl....
</div>
Actually, it’s easy.  The C code in perl is using gv_efullname:

            gv_efullname3&#40;dbsv, gv, NULL&#41;;

&#40;with an e before fullname&#41;, so assigning another glob to it &#40;after saving the slots&#41; should do 
the trick &#40;and then restore the slots&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;18&nbsp;08:35:14&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Nov 17 21:26:17 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Nov 17 21:23:03 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; On Thu Nov 17 19:40:07 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; &gt; I think that initial logic is faulty in all Perl versions.  Now I
</div>&gt; &gt; just
<div class="message-stanza open">&gt; &gt; &gt; need to think of a workaround.
</div>&gt; &gt;
&gt; &gt; I believe that renaming the GV itself &#40;the one bound to the ops&#41; and
&gt; &gt; inserting it into the symbol
&gt; &gt; table under its new name will solve the problem. I don’t know
</div>&gt; whether
<div class="message-stanza open">&gt; &gt; there are any CPAN
&gt; &gt; modules that do that already. If I can’t find a way to do it in pure
&gt; &gt; Perl....
</div>&gt; 
&gt; Actually, it’s easy.  The C code in perl is using gv_efullname:
&gt; 
&gt;           gv_efullname3&#40;dbsv, gv, NULL&#41;;
&gt; 
&gt; &#40;with an e before fullname&#41;, so assigning another glob to it &#40;after
&gt; saving the slots&#41; should do
&gt; the trick &#40;and then restore the slots&#41;.
</div>
I have a patch for you. It fixes #72368 as well in 5.14.

BTW, you need to increase the required version of Package::Stash, as you are using methods 
added in 0.14.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> open_JVPLmVXt.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -rup namespace-clean-0.21-Lkbz_J-orig/lib/namespace/clean.pm namespace-clean-0.21-Lkbz_J/lib/namespace/clean.pm
--- namespace-clean-0.21-Lkbz_J-orig/lib/namespace/clean.pm	2011-08-03 14:46:30.000000000 -0700
+++ namespace-clean-0.21-Lkbz_J/lib/namespace/clean.pm	2011-11-18 05:17:45.000000000 -0800
@@ -219,11 +219,16 @@ it is your responsibility to make sure i
 
 =cut
 
+# Constant to optimise away the unused code branches
+use constant RENAME_SUB =&gt; $] &gt; 5.0080089 &#38;&#38; $] &lt; 5.0130061;
+{ no strict; delete ${__PACKAGE__.&#34;::&#34;}{RENAME_SUB} }
+
 my $sub_utils_loaded;
 my $DebuggerRename = sub {
   my &#40;$f, $sub, $cleanee_stash, $deleted_stash&#41; = @_;
 
-  if &#40;! defined $sub_utils_loaded &#41; {
+  if &#40;RENAME_SUB&#41; {
+   if &#40;! defined $sub_utils_loaded &#41; {
     $sub_utils_loaded = do {
       my $sn_ver = 0.04;
       eval { require Sub::Name; Sub::Name-&gt;VERSION&#40;$sn_ver&#41; }
@@ -235,12 +240,16 @@ my $DebuggerRename = sub {
 
       1;
     } ? 1 : 0;
-  }
+   }
 
-  if &#40; Sub::Identify::sub_fullname&#40;$sub&#41; eq &#40;$cleanee_stash-&gt;name . &#34;::$f&#34;&#41; &#41; {
+   if &#40; Sub::Identify::sub_fullname&#40;$sub&#41; eq &#40;$cleanee_stash-&gt;name . &#34;::$f&#34;&#41; &#41; {
     my $new_fq = $deleted_stash-&gt;name . &#34;::$f&#34;;
     Sub::Name::subname&#40;$new_fq, $sub&#41;;
     $deleted_stash-&gt;add_symbol&#40;&#34;&#38;$f&#34;, $sub&#41;;
+   }
+  }
+  else {
+    $deleted_stash-&gt;add_symbol&#40;&#34;&#38;$f&#34;, $sub&#41;;
   }
 };
 
@@ -259,12 +268,24 @@ my $RemoveSubs = sub {
         my $sub = $cleanee_stash-&gt;get_symbol&#40;&#34;&#38;$f&#34;&#41;
           or next SYMBOL;
 
-        if &#40;$^P and ref&#40;\$cleanee_stash-&gt;namespace-&gt;{$f}&#41; eq &#39;GLOB&#39;&#41; {
+        my $debugger_fixup =
+          $^P &#38;&#38; ref&#40;my $globref = \$cleanee_stash-&gt;namespace-&gt;{$f}&#41;
+                  eq &#39;GLOB&#39;;
+
+        if &#40;$debugger_fixup&#41; {
             # convince the Perl debugger to work
-            # it assumes that sub_fullname&#40;$sub&#41; can always be used to find the CV again
+            # In perl 5.8.9-5.12, it assumes that sub_fullname&#40;$sub&#41; can
+            # always be used to find the CV again.
+            # In perl 5.8.8 and 5.14, it assumes that the name of the glob
+            # passed to entersub can be used to find the CV.
             # since we are deleting the glob where the subroutine was originally
-            # defined, that assumption no longer holds, so we need to move it
-            # elsewhere and point the CV&#39;s name to the new glob.
+            # defined, those assumptions no longer hold.
+            #
+            # So in 5.8.9-5.12 we need to move it elsewhere and point the
+            # CV&#39;s name to the new glob.
+            #
+            # In 5.8.8 and 5.14 we move it elsewhere and rename the
+            # original glob by assigning the new glob back to it.
             $DebuggerRename-&gt;&#40;
               $f,
               $sub,
@@ -281,6 +302,10 @@ my $RemoveSubs = sub {
 
         $cleanee_stash-&gt;remove_glob&#40;$f&#41;;
 
+        if &#40;!RENAME_SUB &#38;&#38; $debugger_fixup&#41; {
+            *$globref = $deleted_stash-&gt;namespace-&gt;{$f};
+        }
+
         $cleanee_stash-&gt;add_symbol&#40;@$_&#41; for @symbols;
     }
 };
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;18&nbsp;08:36:58&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Nov 18 08:35:14 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; BTW, you need to increase the required version of Package::Stash, as
&gt; you are using methods
&gt; added in 0.14.
</div>
I must be going insane. When I ran Makefile.PL with a perl that had an older Package::Stash 
installed, I completely missed the EUMM warning. So disregard that.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;18&nbsp;08:40:04&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Nov 18 08:35:14 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Nov 17 21:26:17 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; On Thu Nov 17 21:23:03 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; &gt; On Thu Nov 17 19:40:07 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; I think that initial logic is faulty in all Perl versions.  Now
</div></div></div>&gt; I
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; just
<div class="message-stanza open">&gt; &gt; &gt; &gt; need to think of a workaround.
</div>&gt; &gt; &gt;
&gt; &gt; &gt; I believe that renaming the GV itself &#40;the one bound to the ops&#41;
</div></div>&gt; and
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; inserting it into the symbol
&gt; &gt; &gt; table under its new name will solve the problem. I don’t know
</div>&gt; &gt; whether
<div class="message-stanza open">&gt; &gt; &gt; there are any CPAN
&gt; &gt; &gt; modules that do that already. If I can’t find a way to do it in
</div></div>&gt; pure
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; Perl....
</div>&gt; &gt;
&gt; &gt; Actually, it’s easy.  The C code in perl is using gv_efullname:
&gt; &gt;
&gt; &gt;         gv_efullname3&#40;dbsv, gv, NULL&#41;;
&gt; &gt;
&gt; &gt; &#40;with an e before fullname&#41;, so assigning another glob to it &#40;after
&gt; &gt; saving the slots&#41; should do
&gt; &gt; the trick &#40;and then restore the slots&#41;.
</div>&gt; 
&gt; I have a patch for you. It fixes #72368 as well in 5.14.
</div>
And I have just confirmed that it works in 5.8.8, too, so you can remove the skip from 07-
debugger.t.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;18&nbsp;12:12:27&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Nov 18 08:40:04 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Nov 18 08:35:14 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; On Thu Nov 17 21:26:17 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; &gt; On Thu Nov 17 21:23:03 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; On Thu Nov 17 19:40:07 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; I think that initial logic is faulty in all Perl versions.
</div></div></div></div>&gt; Now
<div class="message-stanza open">&gt; &gt; I
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; just
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; need to think of a workaround.
</div>&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; I believe that renaming the GV itself &#40;the one bound to the ops&#41;
</div></div>&gt; &gt; and
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; inserting it into the symbol
&gt; &gt; &gt; &gt; table under its new name will solve the problem. I don’t know
</div>&gt; &gt; &gt; whether
<div class="message-stanza open">&gt; &gt; &gt; &gt; there are any CPAN
&gt; &gt; &gt; &gt; modules that do that already. If I can’t find a way to do it in
</div></div>&gt; &gt; pure
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; Perl....
</div>&gt; &gt; &gt;
&gt; &gt; &gt; Actually, it’s easy.  The C code in perl is using gv_efullname:
&gt; &gt; &gt;
&gt; &gt; &gt;       gv_efullname3&#40;dbsv, gv, NULL&#41;;
&gt; &gt; &gt;
&gt; &gt; &gt; &#40;with an e before fullname&#41;, so assigning another glob to it
</div></div>&gt; &#40;after
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; saving the slots&#41; should do
&gt; &gt; &gt; the trick &#40;and then restore the slots&#41;.
</div>&gt; &gt;
&gt; &gt; I have a patch for you. It fixes #72368 as well in 5.14.
</div>&gt; 
&gt; And I have just confirmed that it works in 5.8.8, too, so you can
&gt; remove the skip from 07-
&gt; debugger.t.
</div>
And you should be able to skip the workarounds in 5.15.5. I haven’t merged the perl fixes 
yet, but they are attached here in case you want to try things out before I get to that.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> open_vGuQ3tHH.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From e9b078c829d964f27a86eb40c84e74e44918e01c Mon Sep 17 00:00:00 2001
From: Father Chrysostomos &lt;sprout@cpan.org&gt;
Date: Fri, 18 Nov 2011 09:08:32 -0800
Subject: [PATCH] Make sure $DB::sub is callable
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

When DB::sub is about to be called &#40;to handle a subroutine call under
the debugger&#41;, $DB::sub is set to the name of the subroutine or a ref-
erence to it.

Sometimes $DB::sub is set to the name when the subroutine is not call-
able under that name.  That should not happen.

This logic in util.c:Perl_get_db_sub decides whether a reference
should be used:

	if &#40; svp &#38;&#38; &#40;&#40;CvFLAGS&#40;cv&#41; &#38; &#40;CVf_ANON | CVf_CLONED&#41;&#41;
	     || strEQ&#40;GvNAME&#40;gv&#41;, &#34;END&#34;&#41;
	     || &#40;&#40;GvCV&#40;gv&#41; != cv&#41; &#38;&#38; /* Could be imported, and old sub redefined. */
		 !&#40; &#40;SvTYPE&#40;*svp&#41; == SVt_PVGV&#41;
		    &#38;&#38; &#40;GvCV&#40;&#40;const GV *&#41;*svp&#41; == cv&#41;
		    &#38;&#38; &#40;gv = &#40;GV *&#41;*svp&#41;
		  &#41;
		&#41;
	&#41;&#41; {
	    /* Use GV from the stack as a fallback. */

&#40;That comment about using the GV from the stack as a fallback applies
to the assignment to gv, but was mistakenly divorced from it in commit
3de9ffa12.&#41;

This logic &#40;introduced in 71be2cbc7 [inseparable changes from
perl5.003_13 to perl5.003_14] and integrated into blead in 491527d02&#41;
tries to find a GV that points to the CV, trying the CV’s own GV
first, and falling back to what is on the stack.  But it does not
account for GVs that are not found under their names, which can hap-
pen when a glob is copied and the original is undefined &#40;$foo = *bar;
undef *bar; &#38;$foo&#41; or when a stash element or package is deleted, such
as via Symbol::delete_package.

If the subroutine is not locatable under its own name or the name
under which it was called &#40;the name of the GV argument to entersub&#41;,
then a reference should be passed.  Otherwise a name that can access
the sub should be passed.

So this commit adds more &#40;no, not more!&#41; conditions to make sure the
gv is actually reachable under its name before using a string.

Since, for effiency, those conditions do not perform an actual symbol
lookup, but simply look inside the GV’s stash, we can no longer rely
on gv_efullname &#40;or even gv_fullname&#41;, as the stash may have been
moved around, but use HvENAME and construct the GV name ourselves.

diff --git a/t/run/switchd.t b/t/run/switchd.t
index 3ea4681..9246b35 100644
--- a/t/run/switchd.t
+++ b/t/run/switchd.t
@@ -9,7 +9,7 @@ BEGIN { require &#34;./test.pl&#34;; }
 
 # This test depends on t/lib/Devel/switchd*.pm.
 
-plan&#40;tests =&gt; 5&#41;;
+plan&#40;tests =&gt; 6&#41;;
 
 my $r;
 
@@ -78,3 +78,19 @@ like&#40;
   qr &#34;1\r?\n2\r?\n&#34;,
  &#39;Subroutine redefinition works in the debugger [perl #48332]&#39;,
 &#41;;
+
+# [rt.cpan.org #69862]
+like&#40;
+  runperl&#40;
+   switches =&gt; [ &#39;-Ilib&#39;, &#39;-d:switchd_empty&#39; ],
+   progs    =&gt; [
+    &#39;sub DB::sub { goto &#38;$DB::sub }&#39;,
+    &#39;sub foo { print qq _1\n_ }&#39;,
+    &#39;sub bar { print qq _2\n_ }&#39;,
+    &#39;delete $::{foo}; eval { foo&#40;&#41; };&#39;,
+    &#39;my $bar = *bar; undef *bar; eval { &#38;$bar };&#39;,
+   ],
+  &#41;,
+  qr &#34;1\r?\n2\r?\n&#34;,
+ &#39;Subroutines no longer found under their names can be called&#39;,
+&#41;;
diff --git a/util.c b/util.c
index 221dee5..866565a 100644
--- a/util.c
+++ b/util.c
@@ -6523,6 +6523,19 @@ long _ftol&#40; double &#41;; /* Defined by VC6 C libs. */
 long _ftol2&#40; double dblSource &#41; { return _ftol&#40; dblSource &#41;; }
 #endif
 
+PERL_STATIC_INLINE bool
+S_gv_has_usable_name&#40;pTHX_ GV *gv&#41;
+{
+    GV **gvp;
+    return GvSTASH&#40;gv&#41;
+	&#38;&#38; HvENAME&#40;GvSTASH&#40;gv&#41;&#41;
+	&#38;&#38; &#40;gvp = &#40;GV **&#41;hv_fetch&#40;
+			GvSTASH&#40;gv&#41;, GvNAME&#40;gv&#41;,
+			GvNAMEUTF8&#40;gv&#41; ? -GvNAMELEN&#40;gv&#41; : GvNAMELEN&#40;gv&#41;, 0
+	   &#41;&#41;
+	&#38;&#38; *gvp == gv;
+}
+
 void
 Perl_get_db_sub&#40;pTHX_ SV **svp, CV *cv&#41;
 {
@@ -6543,21 +6556,28 @@ Perl_get_db_sub&#40;pTHX_ SV **svp, CV *cv&#41;
 
 	if &#40; svp &#38;&#38; &#40;&#40;CvFLAGS&#40;cv&#41; &#38; &#40;CVf_ANON | CVf_CLONED&#41;&#41;
 	     || strEQ&#40;GvNAME&#40;gv&#41;, &#34;END&#34;&#41;
-	     || &#40;&#40;GvCV&#40;gv&#41; != cv&#41; &#38;&#38; /* Could be imported, and old sub redefined. */
+	     || &#40; /* Could be imported, and old sub redefined. */
+		 &#40;GvCV&#40;gv&#41; != cv || !S_gv_has_usable_name&#40;aTHX_ gv&#41;&#41;
+		 &#38;&#38;
 		 !&#40; &#40;SvTYPE&#40;*svp&#41; == SVt_PVGV&#41;
 		    &#38;&#38; &#40;GvCV&#40;&#40;const GV *&#41;*svp&#41; == cv&#41;
-		    &#38;&#38; &#40;gv = &#40;GV *&#41;*svp&#41; 
+		    /* Use GV from the stack as a fallback. */
+		    &#38;&#38; S_gv_has_usable_name&#40;gv = &#40;GV *&#41;*svp&#41; 
 		  &#41;
 		&#41;
 	&#41;&#41; {
-	    /* Use GV from the stack as a fallback. */
 	    /* GV is potentially non-unique, or contain different CV. */
 	    SV * const tmp = newRV&#40;MUTABLE_SV&#40;cv&#41;&#41;;
 	    sv_setsv&#40;dbsv, tmp&#41;;
 	    SvREFCNT_dec&#40;tmp&#41;;
 	}
 	else {
-	    gv_efullname3&#40;dbsv, gv, NULL&#41;;
+	    sv_sethek&#40;dbsv, HvENAME_HEK&#40;GvSTASH&#40;gv&#41;&#41;&#41;;
+	    sv_catpvs&#40;dbsv, &#34;::&#34;&#41;;
+	    sv_catpvn_flags&#40;
+	      dbsv, GvNAME&#40;gv&#41;, GvNAMELEN&#40;gv&#41;,
+	      GvNAMEUTF8&#40;gv&#41; ? SV_CATUTF8 : SV_CATBYTES
+	    &#41;;
 	}
     }
     else {
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;18&nbsp;19:14:51&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Nov 18 12:12:27 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Nov 18 08:40:04 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; On Fri Nov 18 08:35:14 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; &gt; On Thu Nov 17 21:26:17 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; On Thu Nov 17 21:23:03 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; On Thu Nov 17 19:40:07 2011, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; I think that initial logic is faulty in all Perl versions.
</div></div></div></div>&gt; &gt; Now
<div class="message-stanza open">&gt; &gt; &gt; I
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; just
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; need to think of a workaround.
</div>&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; I believe that renaming the GV itself &#40;the one bound to the
</div></div></div>&gt; ops&#41;
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; and
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; inserting it into the symbol
&gt; &gt; &gt; &gt; &gt; table under its new name will solve the problem. I don’t know
</div>&gt; &gt; &gt; &gt; whether
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; there are any CPAN
&gt; &gt; &gt; &gt; &gt; modules that do that already. If I can’t find a way to do it
</div></div></div></div>&gt; in
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; pure
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; Perl....
</div>&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Actually, it’s easy.  The C code in perl is using gv_efullname:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;             gv_efullname3&#40;dbsv, gv, NULL&#41;;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &#40;with an e before fullname&#41;, so assigning another glob to it
</div></div>&gt; &gt; &#40;after
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; saving the slots&#41; should do
&gt; &gt; &gt; &gt; the trick &#40;and then restore the slots&#41;.
</div>&gt; &gt; &gt;
&gt; &gt; &gt; I have a patch for you. It fixes #72368 as well in 5.14.
</div>&gt; &gt;
&gt; &gt; And I have just confirmed that it works in 5.8.8, too, so you can
&gt; &gt; remove the skip from 07-
&gt; &gt; debugger.t.
</div>&gt; 
&gt; And you should be able to skip the workarounds in 5.15.5. I haven’t
&gt; merged the perl fixes
&gt; yet, but they are attached here in case you want to try things out
&gt; before I get to that.
</div>
The perl fixes are now integrated into blead as a7999c089, and will be in 5.15.5.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;19&nbsp;02:58:35&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #69862] t/author-07-debugger.t fails with 5.14.1</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 19 Nov 2011 08:58:22 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-namespace-clean [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;ribasushi [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Father Chrysostomos via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; The perl fixes are now integrated into blead as a7999c089, and will be in 5.15.5.
</div>
Thank you for the amazing and efficient work. I should bug core
p5p devs with random perl bugs more often :&#41;

Cheers!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;04:46:17&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">After 80e4e267 the debugger correctly works on all perl versions from
5.8.1 onwards. FC++
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;04:46:18&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;16:19:57&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 21 04:46:17 2011, RIBASUSHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; After 80e4e267 the debugger correctly works on all perl versions from
&gt; 5.8.1 onwards. FC++
</div>
BTW, you can skip the debugger fixup altogether if $] &gt; 5.015_004_9.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;16:19:58&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;22&nbsp;04:44:00&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 21 16:19:57 2011, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Dec 21 04:46:17 2011, RIBASUSHI wrote:
<div class="message-stanza open">&gt; &gt; After 80e4e267 the debugger correctly works on all perl versions from
&gt; &gt; 5.8.1 onwards. FC++
</div>&gt; 
&gt; BTW, you can skip the debugger fixup altogether if $] &gt; 5.015_004_9.
</div>
Good point, thanks!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;22&nbsp;04:44:17&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;26&nbsp;13:38:43&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Fixed in 0.22 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;26&nbsp;13:38:43&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
