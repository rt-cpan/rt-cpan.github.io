<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #28617 for POE: POE::Wheel::Run not deleting stdout file handle on child exit</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #28617 for POE: POE::Wheel::Run not deleting stdout file handle on child exit</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=POE">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=POE">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=POE">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=POE">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE">POE CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">28617</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=POE">POE</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
MSHIBLA [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-26342-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.38</li>
<li>
0.9989</li>
</ul>
    </td>
  </tr>
  <tr id="CF-26343-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




poe_leak.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/350307/157458/poe_leak.pl">
Wed Aug 01 13:38:07 2007 (9.2k) by MSHIBLA [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=28617">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-350307" href="/Public/Bug/Display.html?id=28617#txn-350307">#</a>      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;01&nbsp;13:38:07&nbsp;2007</span>
    <span class="description">MSHIBLA [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> POE::Wheel::Run not deleting stdout file handle on child exit</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/350307/157455/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/157455">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 6.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am seeing a problem in POE::Wheel::Run for at least POE versions
0.9989 and 0.38.  When using POE::Wheel::Run to spawn an external
command, POE is properly setting up two pipes &#40;using the default &#39;pipe&#39;
Conduit via POE::Pipe::TwoWay&#41;, one for stdout and one for stderr.  It
seems that when the child process terminates, the stderr pipe is
selected, it is removed from the POE kernel, and the file handle is
deleted.  The stdout pipe is selected, it is removed from the POE
kernel, but the file handle is never deleted.  This causes the wheel to
hang around forever &#40;as well as the enclosing session&#41;.  In a
long-running application, this behavior eventually eats up all the
available file descriptors.

I wrote a test program to illustrate.  It simply invokes
[ &#39;/bin/echo&#39;, &#39;hi&#39; ].  When run &#34;normally&#34;, the problem is illustrated.
I can &#34;solve&#34; the problem by calling

$kernel-&gt;_data_handle_clear_session&#40;$session&#41;

from the CloseEvent handler of the wheel.  When that internal method is
used, &#40;in the below trace&#41; fileno &#40;6&#41; is removed, removed again, and
deleted &#40;and then a warning is generated that fileno &#40;6&#41; is not
registered with POE::Kernel&#41;.  The session is then removed and the
program terminates properly.  See the attached poe_leak.pl for the
demonstration code.  Set $CLEAN_HANDLES appropriately &#40;boolean&#41;.

Here is the relevant trace:

&lt;fh&gt; adding fd &#40;6&#41; in mode &#40;1&#41; at
//ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Resource/FileHandles.pm
line 324
&lt;rc&gt; incrementing refcount for session 2 &#40;POE::Session=ARRAY&#40;0x8559a90&#41;&#41;
at //ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Resource/Sessions.pm
line 358
&lt;fh&gt; pause test: fileno&#40;6&#41; mode&#40;1&#41; count&#40;0&#41; at
//ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Resource/FileHandles.pm
line 706
&lt;fh&gt; adding fd &#40;7&#41; in mode &#40;0&#41; at
//ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Resource/FileHandles.pm
line 324
&lt;rc&gt; incrementing refcount for session 2 &#40;POE::Session=ARRAY&#40;0x8559a90&#41;&#41;
at //ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Resource/Sessions.pm
line 358
...
&lt;rc&gt; +----- GC test for session 2 &#40;POE::Session=ARRAY&#40;0x8559a90&#41;&#41;
&#40;POE::Session=ARRAY&#40;0x8559a90&#41;&#41; -----
&lt;rc&gt; | total refcnt  : 7
&lt;rc&gt; | event count   : 2
&lt;rc&gt; | post count    : 2
&lt;rc&gt; | child sessions: 0
&lt;rc&gt; | handles in use: 2
&lt;rc&gt; | aliases in use: 0
&lt;rc&gt; | extra refs    : 0
&lt;rc&gt; | pid count     : 1
&lt;rc&gt; +---------------------------------------------------
...
&lt;fh&gt; decrementing event count in mode &#40;0&#41; for fileno &#40;7&#41; from count &#40;1&#41;
at //ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Resource/FileHandles.pm
line 195
&lt;ev&gt; dispatching event 7 ``POE::Wheel::Run&#40;1&#41; -&gt; select stderr&#39;&#39; to
session 2 &#40;POE::Session=ARRAY&#40;0x8559a90&#41;&#41; at
//ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Kernel.pm line 972
2 -&gt; POE::Wheel::Run&#40;1&#41; -&gt; select stderr &#40;from
//ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Resource/FileHandles.pm at
254&#41;
2 -&gt; error_event &#40;from
//ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Wheel/Run.pm at 776&#41;
&lt;fh&gt; removing handle &#40;GLOB&#40;0x84c52d8&#41;&#41; fileno &#40;7&#41; mode &#40;0&#41; at
//ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Resource/FileHandles.pm
line 528
&lt;fh&gt; deleting handle &#40;GLOB&#40;0x84c52d8&#41;&#41; fileno &#40;7&#41; entirely at
//ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Resource/FileHandles.pm
line 609
&lt;rc&gt; decrementing refcount for session 2 &#40;POE::Session=ARRAY&#40;0x8559a90&#41;&#41;
at //ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Resource/Sessions.pm
line 331
&lt;ev&gt; event 7 ``POE::Wheel::Run&#40;1&#41; -&gt; select stderr&#39;&#39; returns &#40;undef&#41;
&lt;rc&gt; +----- GC test for session 2 &#40;POE::Session=ARRAY&#40;0x8559a90&#41;&#41;
&#40;POE::Session=ARRAY&#40;0x8559a90&#41;&#41; -----
&lt;rc&gt; | total refcnt  : 4
&lt;rc&gt; | event count   : 1
&lt;rc&gt; | post count    : 1
&lt;rc&gt; | child sessions: 0
&lt;rc&gt; | handles in use: 1
&lt;rc&gt; | aliases in use: 0
&lt;rc&gt; | extra refs    : 0
&lt;rc&gt; | pid count     : 1
&lt;rc&gt; +---------------------------------------------------
...
&lt;fh&gt; decrementing event count in mode &#40;0&#41; for fileno &#40;6&#41; from count &#40;1&#41;
at //ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Resource/FileHandles.pm
line 195
&lt;ev&gt; dispatching event 8 ``POE::Wheel::Run&#40;1&#41; -&gt; select stdout&#39;&#39; to
session 2 &#40;POE::Session=ARRAY&#40;0x8559a90&#41;&#41; at
//ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Kernel.pm line 972
2 -&gt; POE::Wheel::Run&#40;1&#41; -&gt; select stdout &#40;from
//ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Resource/FileHandles.pm at
254&#41;
2 -&gt; error_event &#40;from
//ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Wheel/Run.pm at 676&#41;
2 -&gt; task_done &#40;from
//ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Wheel/Run.pm at 681&#41;
&lt;rc&gt; decrementing refcount for session 2 &#40;POE::Session=ARRAY&#40;0x8559a90&#41;&#41;
at //ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Resource/Sessions.pm
line 331
&lt;rc&gt; decrementing refcount for session 2 &#40;POE::Session=ARRAY&#40;0x8559a90&#41;&#41;
at //ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Resource/Sessions.pm
line 331
&lt;fh&gt; removing handle &#40;GLOB&#40;0x81577d4&#41;&#41; fileno &#40;6&#41; mode &#40;0&#41; at
//ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Resource/FileHandles.pm
line 528
&lt;ev&gt; event 8 ``POE::Wheel::Run&#40;1&#41; -&gt; select stdout&#39;&#39; returns &#40;undef&#41;
&lt;rc&gt; +----- GC test for session 2 &#40;POE::Session=ARRAY&#40;0x8559a90&#41;&#41;
&#40;POE::Session=ARRAY&#40;0x8559a90&#41;&#41; -----
&lt;rc&gt; | total refcnt  : 2
&lt;rc&gt; | event count   : 0
&lt;rc&gt; | post count    : 0
&lt;rc&gt; | child sessions: 0
&lt;rc&gt; | handles in use: 1
&lt;rc&gt; | aliases in use: 0
&lt;rc&gt; | extra refs    : 0
&lt;rc&gt; | pid count     : 1
&lt;rc&gt; +---------------------------------------------------
...
&lt;sg&gt; POE::Kernel detected SIGCHLD &#40;pid=2711; exit=0&#41; at
//ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Resource/Signals.pm line 493
&lt;ev&gt; enqueued event 9 ``sig_child&#39;&#39; from session
piias1358-46b0a87000000a96 &#40;POE::Kernel=ARRAY&#40;0x8342170&#41;&#41; to session 2
&#40;POE::Session=ARRAY&#40;0x8559a90&#41;&#41; at
1185982577.61384 at
//ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Resource/Events.pm
line 73
...
&lt;ev&gt; Dispatching event 9 ``sig_child&#39;&#39; &#40;CHLD 2711 0&#41; from session
piias1358-46b0a87000000a96 &#40;POE::Kernel=ARRAY&#40;0x8342170&#41;&#41; to session 2
&#40;POE::Session=ARRAY&#40;0x8559a90&#41;&#41; at
//ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Kernel.pm line 846
&lt;ev&gt; dispatching event 9 ``sig_child&#39;&#39; to session 2
&#40;POE::Session=ARRAY&#40;0x8559a90&#41;&#41; at
//ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Kernel.pm line 972
2 -&gt; sig_child &#40;from
//ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Resource/Signals.pm at 506&#41;
&lt;ev&gt; event 9 ``sig_child&#39;&#39; returns &#40;undef&#41;
...
&lt;rc&gt; +----- GC test for session 2 &#40;POE::Session=ARRAY&#40;0x8559a90&#41;&#41;
&#40;POE::Session=ARRAY&#40;0x8559a90&#41;&#41; -----
&lt;rc&gt; | total refcnt  : 1
&lt;rc&gt; | event count   : 0
&lt;rc&gt; | post count    : 0
&lt;rc&gt; | child sessions: 0
&lt;rc&gt; | handles in use: 1
&lt;rc&gt; | aliases in use: 0
&lt;rc&gt; | extra refs    : 0
&lt;rc&gt; | pid count     : 0
&lt;rc&gt; +---------------------------------------------------
...
&lt;rc&gt; ,----- Kernel Activity -----
&lt;rc&gt; | Events : 1
&lt;rc&gt; | Files  : 1
&lt;rc&gt; | Extra  : 0
&lt;rc&gt; | Procs  :
&lt;rc&gt; `---------------------------
&lt;rc&gt; ... at //ms/dist/perl5/PROJ/POE/0.9989/lib/perl5/POE/Kernel.pm line 596
&lt;ev&gt; Kernel::run&#40;&#41; iterating.  now&#40;1.6166&#41; timeout&#40;28.9307&#41; then&#40;30.5473&#41;
&lt;fh&gt; ,----- SELECT BITS IN -----
&lt;fh&gt; | READ    : 00000000
&lt;fh&gt; | WRITE   : 00000000
&lt;fh&gt; | EXPEDITE: 00000000
&lt;fh&gt; `--------------------------
...
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> poe_leak.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/350307/157458/poe_leak.pl">Download poe_leak.pl</a><br />
<span class="downloadcontenttype">text/x-perl 9.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/ms/dist/perl5/bin/perl5.8

use strict;
use warnings;
use MSDW::Version
  &#39;POE&#39;                 =&gt; &#39;0.9989&#39;,
#  &#39;POE&#39;                 =&gt; &#39;0.38&#39;,
;
use vars qw&#40;
  $CLEAN_HANDLES
  $DELAY
  $TIMEOUT
  $VERBOSE
&#41;;
sub POE::Kernel::TRACE_DEFAULT    &#40;&#41; { 1 }
sub POE::Kernel::TRACE_DESTROY    &#40;&#41; { 1 }
sub POE::Kernel::TRACE_EVENTS     &#40;&#41; { 1 }
sub POE::Kernel::TRACE_FILES      &#40;&#41; { 1 }
sub POE::Kernel::TRACE_PROFILE    &#40;&#41; { 1 }
sub POE::Kernel::TRACE_REFCNT     &#40;&#41; { 1 }
sub POE::Kernel::TRACE_RETVALS    &#40;&#41; { 1 }
sub POE::Kernel::TRACE_SESSIONS   &#40;&#41; { 1 }
sub POE::Kernel::TRACE_SIGNALS    &#40;&#41; { 1 }
sub POE::Kernel::ASSERT_EVENTS    &#40;&#41; { 1 }
sub POE::Kernel::ASSERT_FILES     &#40;&#41; { 1 }
sub POE::Kernel::CATCH_EXCEPTIONS &#40;&#41; { 1 }
use POE qw&#40;
  Wheel::Run
  Filter::Reference
  Filter::Line
&#41;;

sub log_it {
  my $mesg   = shift;
  my $retval = print STDOUT &#40;$mesg&#41;;
  return&#40;$retval&#41;;
};

{
  $CLEAN_HANDLES = 1;
  $DELAY         = 5;
  $TIMEOUT       = 30;
  $VERBOSE       = 5;

  my $session    = POE::Session-&gt;create&#40;
    &#39;inline_states&#39; =&gt; {
      &#39;_start&#39;      =&gt; sub {
        my $kernel       = $_[KERNEL];
        my $heap         = $_[HEAP];
        my $session      = $_[SESSION];
        my $alias        = $heap-&gt;{&#39;alias&#39;};
        my $session_id   = $session-&gt;ID&#40;&#41;;
        &#40;$VERBOSE &gt; 2&#41;
          &#38;&#38; log_it&#40;
               &#34;$alias: do_system_session: started session: &#39;$session_id&#39;&#34;
                 . &#34;\n&#34;
             &#41;;
        $kernel-&gt;yield&#40;&#39;next_task&#39;&#41;;
      },
      &#39;_stop&#39;       =&gt; sub {
        my $kernel       = $_[KERNEL];
        my $heap         = $_[HEAP];
        my $session      = $_[SESSION];
        my $alias        = $heap-&gt;{&#39;alias&#39;};
        my $session_id   = $session-&gt;ID&#40;&#41;;
        &#40;$VERBOSE &gt; 2&#41;
          &#38;&#38; log_it&#40;
               &#34;${alias}: do_system_session: stopped session: &#34;
                 . &#34;&#39;$session_id&#39;\n&#34;
             &#41;;
      },
      &#39;_child&#39;      =&gt; sub {
        my $kernel       = $_[KERNEL];
        my $heap         = $_[HEAP];
        my $session      = $_[SESSION];
        my $alias        = $heap-&gt;{&#39;alias&#39;};
        my $session_id   = $session-&gt;ID&#40;&#41;;
        &#40;$VERBOSE &gt; 2&#41;
          &#38;&#38; log_it&#40;
               &#34;${alias}: do_system_session: sigchld session: &#34;
                 . &#34;&#39;$session_id&#39;\n&#34;
             &#41;;
      },
      &#39;_parent&#39;     =&gt; sub {
        my $kernel       = $_[KERNEL];
        my $heap         = $_[HEAP];
        my $session      = $_[SESSION];
        my $alias        = $heap-&gt;{&#39;alias&#39;};
        my $session_id   = $session-&gt;ID&#40;&#41;;
        &#40;$VERBOSE &gt; 2&#41;
          &#38;&#38; log_it&#40;
               &#34;${alias}: do_system_session: child session &#39;$session_id&#39; &#34;
                 . &#34;has new parent\n&#34;
             &#41;;
      },
      &#39;_default&#39;      =&gt; sub {
        my $kernel       = $_[KERNEL];
        my $heap         = $_[HEAP];
        my $session      = $_[SESSION];
        my $alias        = $heap-&gt;{&#39;alias&#39;};
        my $session_id   = $session-&gt;ID&#40;&#41;;
        &#40;$VERBOSE &gt; 2&#41;
          &#38;&#38; log_it&#40;
               &#34;${alias}: do_system_session: default caught an unhandled &#34;
                 . &#34;&#39;$_[ARG0]&#39; event.  These &#39;$_[ARG1]&#39; parameters were &#34;
                 . &#34;sent.  session: &#39;$session_id&#39;\n&#34;
             &#41;;
      },
      &#39;sig_child&#39;   =&gt; sub {
        my $kernel       = $_[KERNEL];
        my $heap         = $_[HEAP];
        my $session      = $_[SESSION];
        my $alias        = $heap-&gt;{&#39;alias&#39;};
        my $session_id   = $session-&gt;ID&#40;&#41;;
        my $pid          = $_[ARG1];
        my $rc           = $_[ARG2];
        my $id           = $heap-&gt;{&#39;ids&#39;}{$pid} || &#34;&#34;;
        &#40;$VERBOSE &gt; 3&#41;
          &#38;&#38; log_it&#40;
               &#34;sig_child&#40;&#41;: session = $session_id, wheel = $id, entered &#34;
                 . &#34;sig_child, pid = $pid, rc = $rc, alias = $alias\n&#34;
             &#41;;
        # child death signals are issued by the OS and sent to all
        # sessions; we want to handle only our own children
        if &#40;$id&#41; {
          &#40;$POE::VERSION &gt;= 0.20&#41;
            &#38;&#38; $kernel-&gt;sig_handled&#40;&#41;;
          my %args = &#40;&#39;id&#39; =&gt; $id, &#39;rc&#39; =&gt; $rc&#41;;
          if &#40;$heap-&gt;{&#39;closed&#39;}{$id}&#41; {
            delete&#40;$heap-&gt;{&#39;ids&#39;}{$pid}&#41;;
            delete&#40;$heap-&gt;{&#39;pids&#39;}{$id}&#41;;
          }
          &#40;$VERBOSE &gt; 2&#41;
            &#38;&#38; log_it&#40;
                &#34;sig_child&#40;&#41;: session = $session_id, wheel = $id, &#34;
                  . &#34;pid = $pid, rc = $rc\n&#34;
               &#41;;
        }
      },
      &#39;_kill&#39;       =&gt; sub {
        my $kernel       = $_[KERNEL];
        my $heap         = $_[HEAP];
        my $session      = $_[SESSION];
        my $alias        = $heap-&gt;{&#39;alias&#39;};
        my $session_id   = $session-&gt;ID&#40;&#41;;
        &#40;$VERBOSE &gt; 2&#41;
          &#38;&#38; log_it&#40;
               &#34;${alias}: do_system_session: _kill timeout: &#39;$TIMEOUT&#39; &#34;
                 . &#34;session: &#39;$session_id&#39;\n&#34;
             &#41;;
        ID:
        foreach my $id &#40;keys&#40;%{ $heap-&gt;{&#39;dss_task&#39;} }&#41;&#41; {
          $heap-&gt;{&#39;dss_task&#39;}{$id}-&gt;kill&#40;9&#41;;
        }
      },
      &#39;next_task&#39;   =&gt; sub {
        my $kernel       = $_[KERNEL];
        my $heap         = $_[HEAP];
        my $session      = $_[SESSION];
        my $alias        = $heap-&gt;{&#39;alias&#39;};
        my $session_id   = $session-&gt;ID&#40;&#41;;
        &#40;$VERBOSE &gt; 2&#41;
          &#38;&#38; log_it&#40;
               &#34;${alias}: do_system_session: next_task session: &#34;
                 . &#34;&#39;$session_id&#39;\n&#34;
             &#41;;
        $heap-&gt;{&#39;task&#39;} = POE::Wheel::Run-&gt;new&#40;
          &#39;Program&#39;      =&gt; [ &#39;/bin/echo&#39;, &#39;hi&#39; ],
          &#39;CloseEvent&#39;   =&gt; &#39;task_done&#39;,
          &#39;StdoutEvent&#39;  =&gt; &#39;task_result&#39;,
          &#39;StderrEvent&#39;  =&gt; &#39;task_debug&#39;,
          &#39;StdinEvent&#39;   =&gt; &#39;task_debug&#39;,
          &#39;ErrorEvent&#39;   =&gt; &#39;error_event&#39;,
          &#39;StdoutFilter&#39; =&gt; POE::Filter::Line-&gt;new&#40;&#41;,
#          &#39;Conduit&#39;      =&gt; &#39;socketpair&#39;,
        &#41;;
        $heap-&gt;{&#39;task&#39;}
          || die&#40;&#34;$0: can&#39;t POE::Wheel::Run-&gt;new&#34;&#41;;
        my $pid = $heap-&gt;{&#39;task&#39;}-&gt;PID&#40;&#41;;
        &#40;$VERBOSE &gt; 3&#41;
          &#38;&#38; log_it&#40;
               &#34;$alias: do_system_session: successfully started task &#34;
                 . &#34;pid: &#39;$pid&#39; in session: &#39;$session_id&#39;\n&#34;
             &#41;;
        $kernel-&gt;delay_set&#40;&#39;_kill&#39;, $TIMEOUT&#41;;
        $kernel-&gt;sig_child&#40;$pid, &#39;sig_child&#39;&#41;;
        my $id = $heap-&gt;{&#39;task&#39;}-&gt;ID&#40;&#41;;
        $heap-&gt;{&#39;pids&#39;}{$id}          = $pid;
        $heap-&gt;{&#39;ids&#39;}{$pid}          = $id;
        $heap-&gt;{&#39;dss_task&#39;}{$id}      = $heap-&gt;{&#39;task&#39;};
        $heap-&gt;{&#39;pid_to_wheel&#39;}{$pid} = $heap-&gt;{&#39;task&#39;};
        $heap-&gt;{&#39;id_to_wheel&#39;}{$id}   = $heap-&gt;{&#39;task&#39;};
      },
      &#39;task_result&#39; =&gt; sub {
        my $kernel       = $_[KERNEL];
        my $heap         = $_[HEAP];
        my $session      = $_[SESSION];
        my $alias        = $heap-&gt;{&#39;alias&#39;};
        my $txt          = $_[ARG0];
        my $wheel        = $_[ARG1];
        my $session_id   = $session-&gt;ID&#40;&#41;;
        log_it&#40;
          &#34;$alias: txt: &#39;$txt&#39;, wheel: &#39;$wheel&#39;, &#34;
            . &#34;session: &#39;$session_id&#39; stdout\n&#34;
        &#41;;
      },
      &#39;task_done&#39;   =&gt; sub {
        my $kernel       = $_[KERNEL];
        my $heap         = $_[HEAP];
        my $session      = $_[SESSION];
        my $alias        = $heap-&gt;{&#39;alias&#39;};
        my $wheel        = $_[ARG0];
        my $session_id   = $session-&gt;ID&#40;&#41;;
        $kernel-&gt;delay&#40;&#39;_kill&#39;&#41;;
        log_it&#40;
          &#34;$alias: wheel: &#39;$wheel&#39; session: &#39;$session_id&#39; has finished\n&#34;
        &#41;;
        my $wheel_run    = $heap-&gt;{&#39;task&#39;};
        $heap-&gt;{&#39;closed&#39;}{$wheel} = 1;
        $heap-&gt;{&#39;task&#39;}  = 2;
        $wheel_run-&gt;kill&#40;&#41;;
        &#40;$CLEAN_HANDLES&#41;
          &#38;&#38; $kernel-&gt;_data_handle_clear_session&#40;$session&#41;;
      },
      &#39;task_debug&#39;  =&gt; sub {
        my $kernel       = $_[KERNEL];
        my $heap         = $_[HEAP];
        my $session      = $_[SESSION];
        my $alias        = $heap-&gt;{&#39;alias&#39;};
        my $op           = $_[ARG0];
        my $errno        = $_[ARG1];
        my $error        = $_[ARG2];
        my $wheel        = $_[ARG3];
        my $fh           = $_[ARG4];
        my $session_id   = $session-&gt;ID&#40;&#41;;
        &#40;$VERBOSE &gt; 3&#41;
          &#38;&#38; log_it&#40;
               &#34;$alias: error op: &#39;$op&#39;, errno: &#39;$errno&#39;, error: &#34;
                 . &#34;&#39;error&#39;, wheel: &#39;$wheel&#39;, fh: &#39;$fh&#39; stderr &#34;
                 . &#34;session: &#39;$session_id&#39;\n&#34;
             &#41;;
      },
      &#39;error_event&#39; =&gt; sub {
        my $kernel       = $_[KERNEL];
        my $heap         = $_[HEAP];
        my $session      = $_[SESSION];
        my $alias        = $heap-&gt;{&#39;alias&#39;};
        my $op           = $_[ARG0];
        my $errno        = $_[ARG1];
        my $error        = $_[ARG2];
        my $wheel        = $_[ARG3];
        my $fh           = $_[ARG4];
        my $session_id   = $session-&gt;ID&#40;&#41;;
        if &#40; &#40;$op eq &#39;read&#39;&#41; &#38;&#38; &#40;$errno eq &#39;0&#39;&#41; &#38;&#38; &#40;$error eq &#39;&#39;&#41; &#41; {
          # POE network components seem to emit read &#34;errors&#34; at shutdown
        } else {
          log_it&#40;
            &#34;$alias: error op: &#39;$op&#39;, errno: &#39;$errno&#39;, error: &#39;$error&#39;, &#34;
              . &#34;wheel: &#39;$wheel&#39;, fh: &#39;$fh&#39;, session: &#39;$session_id&#39;\n&#34;
          &#41;;
          $heap-&gt;{&#39;txt&#39;}{&#39;out&#39;} = [
            &#34;failed: $alias: error op: &#39;$op&#39;, errno: &#39;$errno&#39;, error: &#34;
              . &#34;&#39;$error&#39;, wheel: &#39;$wheel&#39;, fh: &#39;$fh&#39; error event &#34;
              . &#34;session: &#39;$session_id&#39;&#34;
          ];
        }
      },
    },
    &#39;heap&#39; =&gt; {
      &#39;alias&#39;       =&gt; &#34;do_system_session&#34;,
    },
    &#39;options&#39; =&gt; {
      &#39;trace&#39;             =&gt; &#40;$VERBOSE &gt; 3&#41; ? 1 : 0,
      &#39;debug&#39;             =&gt; &#40;$VERBOSE &gt; 1&#41; ? 1 : 0,
    },
  &#41;;

  POE::Kernel-&gt;run&#40;&#41;;

  log_it&#40;&#34;Program ended.\n&#34;&#41;;

  exit&#40;0&#41;;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-438573" href="/Public/Bug/Display.html?id=28617#txn-438573">#</a>      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;22&nbsp;17:18:44&nbsp;2008</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/438573/214777/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/214777">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 536b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is working as designed.

In your &#34;task_done&#34; handler, please remove this statement:

  &#40;$CLEAN_HANDLES&#41; &#38;&#38; $kernel-&gt;_data_handle_clear_session&#40;$session&#41;;

and replace it with:

  delete $heap-&gt;{dss_task}{$wheel_run-&gt;ID};
  delete $heap-&gt;{pid_to_wheel}{$wheel_run-&gt;PID};
  delete $heap-&gt;{id_to_wheel}{$wheel_run-&gt;ID};

You should find that the session exits normally.

The problem is that you are not triggering POE::Wheel::Run&#39;s
destruction.  The object is stored in four heap structures, and
&#34;task_done&#34; only cleans it from three.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-438574" href="/Public/Bug/Display.html?id=28617#txn-438574">#</a>      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;22&nbsp;17:18:49&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-438577" href="/Public/Bug/Display.html?id=28617#txn-438577">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;22&nbsp;17:18:53&nbsp;2008</span>
    <span class="description">RCAPUTO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.344186</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
