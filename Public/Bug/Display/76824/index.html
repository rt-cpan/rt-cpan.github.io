<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #76824 for Encode: [perl #112608] panic: sv_setpvn called with negative strlen -1 </title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #76824 for Encode: [perl #112608] panic: sv_setpvn called with negative strlen -1 </h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Encode/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Encode/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Encode/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Encode/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Encode">Encode CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">76824</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Encode/Active/">Encode</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
perlbug-followup [...] perl.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
pali [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-12062-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-12063-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;26&nbsp;12:46:55&nbsp;2012</span>
    <span class="description">perlbug-followup [...] perl.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> perl5-porters [...] perl.org, bug-Encode [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [perl #112608] panic: sv_setpvn called with negative strlen -1 </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 26 Apr 2012 09:46:45 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;OtherRecipients of perl Ticket #112608&#34;:;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Father Chrysostomos via RT&#34; &lt;perlbug-followup [...] perl.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Apr 26 08:35:07 2012, sprout wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Apr 26 01:20:30 2012, Steve.Hay@verosoftware.com wrote:
<div class="message-stanza open">&gt; &gt; Father Chrysostomos via RT wrote on 2012-04-26:
<div class="message-stanza open">&gt; &gt; &gt; I get the same result on a Mac, both
</div>&gt; &gt;    threaded and unthreaded.
</div>&gt; 
&gt; I should have read Leon Timmerman’s message more closely.  If I use
&gt; :crlf:encoding&#40;...&#41; I get the panic, but not with :crlf after.
&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; 
&gt; &gt; &gt; A C backtrace would help.
&gt; &gt; &gt;
</div>&gt; &gt;    Those messages are, of course, expected given what the program is
&gt; &gt;    being asked to do. I get them first too, but then followed by a
&gt; &gt;    crash &#40;panic&#41;.
&gt; &gt; 
&gt; &gt; Is it an EOL issue? &#40;I&#39;m running on Windows
&gt; &gt;    here.&#41; Leon mentioned it only happening when :crlf was combined
&gt; &gt;    with :encoding. I still see the crash with
&gt; &gt; 
&gt; &gt; open my $rh,
&gt; &gt;    &#39;&lt;:encoding&#40;UTF-8&#41;:crlf&#39;, &#39;utf8.txt&#39; or die $!;
&gt; &gt; open my $wh,
&gt; &gt;    &#39;&gt;:encoding&#40;ISO-8859-1&#41;:crlf&#39;, &#39;iso88591.txt&#39; or die $!;
&gt; &gt; 
&gt; &gt; but not
&gt; &gt;    with
&gt; &gt; 
&gt; &gt; open my $rh, &#39;&lt;:raw:encoding&#40;UTF-8&#41;&#39;, &#39;utf8.txt&#39; or die $!;
&gt; &gt;    open my $wh, &#39;&gt;:raw:encoding&#40;ISO-8859-1&#41;&#39;, &#39;iso88591.txt&#39; or die
&gt; &gt;    $!;
&gt; &gt; 
&gt; &gt; Also, when I download the utf8.txt attachment I find that it
&gt; &gt;    has got mangled somehow from what I uploaded: the line endings are
&gt; &gt;    now \r\r\n rather than the \r\n original which I uploaded.
&gt; &gt;    Furthermore, the program doesn&#39;t crash for me if I leave it like
&gt; &gt;    that -- I have to convert it back to \r\n before I see the crash
&gt; &gt;    again.
</div>&gt; 
&gt; I think your browser is trying to convert \n to \r\n when you download
&gt; it.  I downloaded the file and it has \r\n line breaks in it.
&gt; 
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; I will try to get a backtrace.
</div>&gt; 
&gt; I see your backtrace has Encode’s XS code in it.  I will try to dig
</div>deeper.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
</div>
This is probably a bug in Encode.  I’ve reduced it to a standalone
script &#40;with no input file&#41;, attached as foo.text.  &#40;I know, it’s not
much smaller, but it’s easier to handle.&#41;

This code in cpan/Encode/Encode.xs:encode_method:

 ENCODE_SET_SRC:
    if &#40;check &#38;&#38; !&#40;check &#38; ENCODE_LEAVE_SRC&#41;&#41;{
    sdone = SvCUR&#40;src&#41; - &#40;slen+sdone&#41;;
    if &#40;sdone&#41; {
        sv_setpvn&#40;src, &#40;char*&#41;s+slen, sdone&#41;;
    }

calls sv_setpvn with 4294967295 for the length argument.

Before this chunk of code is reached, sdone has a value of 1025, but src
is only 1024 octets long.  slen is 0.  So the sdone assignment sets it
to -1, which becomes 4294967295 because sdone is unsigned.

So somehow Encode is losing track of how far it is through the string.

-- 

Father Chrysostomos


---
via perlbug:  queue: perl5 status: open
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org:443/rt3/Ticket/Display.html?id=112608">https://rt.perl.org:443/rt3/Ticket/Display.html?id=112608</a></span>
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">@_ = &#40;
          &#34;\x{feff}\x{39f}\x{3af} \x{3a3}\x{3c5}\x{3bd}\x{3ad}\x{3bd}\x{3bf}\x{3c7}\x{3bf}\x{3b9}\n&#34;,
          &#34;\x{39f}\x{3b9} \x{393}\x{3b5}\x{3bd}\x{3bd}\x{3b1}\x{3af}\x{3bf}\x{3b9} \x{3c4}\x{3b7}\x{3c2} \x{3a3}\x{3b1}\x{3bc}\x{3bf}\x{3b8}\x{3c1}\x{3ac}\x{3ba}\x{3b7}\x{3c2}\n&#34;,
          &#34;\x{39f}\x{3b9} \x{393}\x{3b5}\x{3c1}\x{3bc}\x{3b1}\x{3bd}\x{3bf}\x{3af} \x{3be}\x{3b1}\x{3bd}\x{3ac}\x{3c1}\x{3c7}\x{3bf}\x{3bd}\x{3c4}\x{3b1}\x{3b9}...\n&#34;,
          &#34;\x{39f}\x{3b9} \x{395}\x{3c1}\x{3b1}\x{3c3}\x{3c4}\x{3ad}\x{3c2} \x{3a4}\x{3bf}\x{3c5} \x{391}\x{3b9}\x{3b3}\x{3b1}\x{3af}\x{3bf}\x{3c5}\n&#34;,
          &#34;\x{39f}\x{3b9} \x{39a}\x{3c5}\x{3bd}\x{3b7}\x{3b3}\x{3bf}\x{3af}\n&#34;,
          &#34;\x{39f}\x{3b9} \x{3a0}\x{3b1}\x{3bd}\x{3ba}\x{3c2} \x{3a4}\x{3b1} \x{39a}\x{3ac}\x{3bd}\x{3bf}\x{3c5}\x{3bd} \x{38c}\x{3bb}\x{3b1}\n&#34;,
          &#34;\x{39f}\x{3b9} \x{3a6}\x{3b1}\x{3bd}\x{3c4}\x{3b1}\x{3c1}\x{3af}\x{3bd}\x{3b5}\x{3c2}\n&#34;,
          &#34;\x{39f}\x{3b9}\x{3ba}\x{3bf}\x{3b3}\x{3ad}\x{3bd}\x{3b5}\x{3b9}\x{3b1} \x{3a0}\x{3b1}\x{3bd}\x{3c4}\x{3c1}\x{3b5}\x{3c5}\x{3cc}\x{3bc}\x{3b1}\x{3c3}\x{3c4}\x{3b5}\n&#34;,
          &#34;\x{39f}\x{3bb}\x{3b1} \x{3b5}\x{3af}\x{3bd}\x{3b1}\x{3b9} \x{3b4}\x{3c1}\x{3cc}\x{3bc}\x{3bf}\x{3c2}\n&#34;,
          &#34;\x{39f}\x{3bc}\x{3b7}\x{3c1}\x{3bf}\x{3c2}\n&#34;,
          &#34;\x{39f}\x{3be}\x{3c5}\x{3b3}\x{3cc}\x{3bd}\x{3bf}\n&#34;,
          &#34;\x{39f}\x{3c1}\x{3b1}\x{3c4}\x{3cc}\x{3c4}\x{3b7}\x{3c2} \x{3bc}\x{3b7}\x{3b4}\x{3ad}\x{3bd}\n&#34;,
          &#34;\x{3c0}\n&#34;,
          &#34;\x{3c0}\x{3ac}\x{3bd}\x{3c9}, \x{3ba}\x{3ac}\x{3c4}\x{3c9} \x{3ba}\x{3b1}\x{3b9} \x{3c0}\x{3bb}\x{3b1}\x{3b3}\x{3af}\x{3c9}\x{3c2}\n&#34;,
          &#34;\x{3a4}\x{3bf} \x{39a}\x{3b1}\x{3ba}\x{3cc}\n&#34;,
          &#34;\x{3a4}\x{3bf} \x{39a}\x{3b1}\x{3ba}\x{3cc} - \x{3a3}\x{3c4}\x{3b7}\x{3bd} \x{395}\x{3c0}\x{3bf}\x{3c7}\x{3ae} \x{3c4}\x{3c9}\x{3bd} \x{397}\x{3c1}\x{3ce}\x{3c9}\x{3bd}\n&#34;,
          &#34;\x{3a4}\x{3bf} \x{3ba}\x{3bb}\x{3ac}\x{3bc}\x{3b1} \x{3b2}\x{3b3}\x{3ae}\x{3ba}\x{3b5} \x{3b1}\x{3c0}&#39;\x{3c4}\x{3bf}\x{3bd} \x{3c0}\x{3b1}\x{3c1}\x{3ac}\x{3b4}\x{3b5}\x{3b9}\x{3c3}\x{3bf}\n&#34;,
          &#34;\x{3a4}\x{3bf} \x{3ba}\x{3bf}\x{3c1}\x{3af}\x{3c4}\x{3c3}\x{3b9} \x{3bc}\x{3b5} \x{3c4}\x{3b1} \x{3bc}\x{3b1}\x{3cd}\x{3c1}\x{3b1}\n&#34;,
          &#34;\x{3a4}\x{3bf} \x{3ba}\x{3bf}\x{3c1}\x{3af}\x{3c4}\x{3c3}\x{3b9} \x{3c4}\x{3bf}\x{3c5} \x{3bb}\x{3bf}\x{3cd}\x{3bd}\x{3b1} \x{3c0}\x{3b1}\x{3c1}\x{3ba}\n&#34;,
          &#34;\x{3a4}\x{3bf} \x{39e}\x{3cd}\x{3bb}\x{3bf} \x{3b2}\x{3b3}\x{3ae}\x{3ba}\x{3b5} \x{3b1}\x{3c0}\x{3cc} \x{3c4}\x{3bf}\x{3bd} \x{3c0}\x{3b1}\x{3c1}\x{3ac}\x{3b4}\x{3b5}\x{3b9}\x{3c3}\x{3bf}\n&#34;,
          &#34;\x{3a4}\x{3bf} \x{3c0}\x{3b9}\x{3bf} \x{3bb}\x{3b1}\x{3bc}\x{3c0}\x{3c1}\x{3cc} \x{3b1}\x{3c3}\x{3c4}\x{3ad}\x{3c1}\x{3b9}\n&#34;,
          &#34;\x{3a4}\x{3bf} \x{3a1}\x{3b5}\x{3bc}\x{3b1}\x{3bb}\x{3b9} \x{3a4}\x{3b7}\x{3c2} \x{391}\x{3b8}\x{3b7}\x{3bd}\x{3b1}\x{3c2}\n&#34;,
          &#34;\x{3a4}\x{3bf} \x{3a4}\x{3b1}\x{3bd}\x{3b3}\x{3ba}\x{3cc} \x{3c4}\x{3c9}\x{3bd} \x{3a7}\x{3c1}\x{3b9}\x{3c3}\x{3c4}\x{3bf}\x{3c5}\x{3b3}\x{3ad}\x{3bd}\x{3bd}\x{3c9}\x{3bd}\n&#34;,
          &#34;\x{3a4}\x{3bf} \x{3c4}\x{3b5}\x{3bb}\x{3b5}\x{3c5}\x{3c4}\x{3b1}\x{3af}\x{3bf} \x{3c8}\x{3ad}\x{3bc}\x{3bc}\x{3b1}\n&#34;,
          &#34;\x{3a4}\x{3bf} \x{3c6}\x{3b9}\x{3bb}\x{3af} \x{3c4}\x{3b7}\x{3c2}... \x{396}\x{3c9}\x{3ae}\x{3c2}\n&#34;,
          &#34;\x{3a4}\x{3bf} \x{3c7}\x{3ce}\x{3bc}\x{3b1} \x{3b2}\x{3ac}\x{3c6}\x{3c4}\x{3b7}\x{3ba}\x{3b5} \x{3ba}\x{3cc}\x{3ba}\x{3ba}\x{3b9}\x{3bd}\x{3bf}\n&#34;,
          &#34;\x{3a4}\x{3bf}\x{3c0}\x{3af}\x{3bf} \x{3c3}\x{3c4}\x{3b7}\x{3bd} \x{3bf}\x{3bc}\x{3af}\x{3c7}\x{3bb}\x{3b7}\n&#34;,
          &#34;\x{3a4}\x{3c1}\x{3b9}\x{3bb}\x{3bf}\x{3b3}\x{3af}\x{3b1} 1: \x{3a4}\x{3bf} \x{39b}\x{3b9}\x{3b2}\x{3ac}\x{3b4}\x{3b9} \x{3c0}\x{3bf}\x{3c5} \x{3b4}\x{3b1}\x{3ba}\x{3c1}\x{3cd}\x{3b6}\x{3b5}\x{3b9}\n&#34;
        &#41;;
open my $wh, &#39;&gt;:crlf:encoding&#40;ISO-8859-1&#41;&#39;, \$out or die $!;
print $wh $_ for @_;
close $wh;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;17&nbsp;21:09:29&nbsp;2013</span>
    <span class="description">DANKOGAI [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;08&nbsp;08:21:15&nbsp;2016</span>
    <span class="description">pali [...] cpan.org -  Cc PALI added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;08&nbsp;08:33:55&nbsp;2016</span>
    <span class="description">pali [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> khw [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Problem is still there also with blead perl. No crash or sv_setpvn panic anymore but valgrind show this error message:

==17627== Conditional jump or move depends on uninitialised value&#40;s&#41;
==17627==    at 0x51E0AA: Perl_utf8n_to_uvchr &#40;utf8.c:858&#41;
==17627==    by 0x663CA14: encode_method &#40;Encode.xs:193&#41;
==17627==    by 0x663CCF9: XS_Encode__XS_encode &#40;Encode.xs:785&#41;

Problem is again in this code from Encode.xs:

        STRLEN clen;
        UV ch =
            utf8n_to_uvuni&#40;s+slen, &#40;SvCUR&#40;src&#41;-slen&#41;,
                   &#38;clen, UTF8_ALLOW_ANY|UTF8_CHECK_ONLY&#41;;

I suspect that &#40;SvCUR&#40;src&#41;-slen&#41; is really incorrect and something like &#40;tlen-sdone-slen&#41; should be passed.

IIRC s is pointer to first C char which is not yet processed in dst, slen is number of characters processed by last do_encode&#40;&#41; call &#40;in case of problems it can be just one or zero&#41; and SvCUR&#40;src&#41; is length of original input string. &#40;tlen-sdone&#41; should be number of remaining characters in src, not processed in dst.

With change &#40;SvCUR&#40;src&#41;-slen&#41; to &#40;tlen-sdone-slen&#41; valgrind does not show error message anymore...

CCing khw, can you recheck this?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;18&nbsp;15:44:49&nbsp;2016</span>
    <span class="description">khw [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Oct 08 06:33:55 2016, PALI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Problem is still there also with blead perl. No crash or sv_setpvn
&gt; panic anymore but valgrind show this error message:
&gt; 
&gt; ==17627== Conditional jump or move depends on uninitialised value&#40;s&#41;
&gt; ==17627==    at 0x51E0AA: Perl_utf8n_to_uvchr &#40;utf8.c:858&#41;
&gt; ==17627==    by 0x663CA14: encode_method &#40;Encode.xs:193&#41;
&gt; ==17627==    by 0x663CCF9: XS_Encode__XS_encode &#40;Encode.xs:785&#41;
&gt; 
&gt; Problem is again in this code from Encode.xs:
&gt; 
&gt; STRLEN clen;
&gt; UV ch =
&gt;     utf8n_to_uvuni&#40;s+slen, &#40;SvCUR&#40;src&#41;-slen&#41;,
&gt;            &#38;clen, UTF8_ALLOW_ANY|UTF8_CHECK_ONLY&#41;;
&gt; 
&gt; I suspect that &#40;SvCUR&#40;src&#41;-slen&#41; is really incorrect and something
&gt; like &#40;tlen-sdone-slen&#41; should be passed.
&gt; 
&gt; IIRC s is pointer to first C char which is not yet processed in dst,
&gt; slen is number of characters processed by last do_encode&#40;&#41; call &#40;in
&gt; case of problems it can be just one or zero&#41; and SvCUR&#40;src&#41; is length
&gt; of original input string. &#40;tlen-sdone&#41; should be number of remaining
&gt; characters in src, not processed in dst.
&gt; 
&gt; With change &#40;SvCUR&#40;src&#41;-slen&#41; to &#40;tlen-sdone-slen&#41; valgrind does not
&gt; show error message anymore...
&gt; 
&gt; CCing khw, can you recheck this?
</div>
The current code is wrong.  

The 2nd parameter to utf8n_to_uvuni&#40;&#41; is the upper limit of how far it is permissible to look beyond the first byte of the string pointed to by the first parameter.  The typical way that the core code uses to handle this type of thing is to save s as s0 upon entrance to the function, and then it&#39;s easy to get it right.  In this case, one could set s0 after s is adjusted for *offset. 

s0 = s;

before the loop.  tlen has been calculated to be the number of bytes available in s0, it should be used instead of SvCUR.

Because at the time of the function call, s is slen bytes behind the sequence you want to convert, adjustments have to be made.  You could write.

utf8n_to_uvuni&#40;s+slen, tlen - &#40;s + slen - s0&#41;, ...

I think this is the most foolproof and maintainable method. 

Note that

slen = tlen - sdone

so pali&#39;s solution

&#40;tlen-sdone-slen&#41;

can be rewritten as

tlen - sdone - &#40;tlen -sdone&#41; == 0

which is wrong.  Another option would be to calculate and use sleft
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;18&nbsp;15:58:40&nbsp;2016</span>
    <span class="description">pali [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Uto Okt 18 15:44:49 2016, khw wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Note that
&gt; 
&gt; slen = tlen - sdone
</div>
I do not think this is truth. slen is always modified by do_encode&#40;&#41; before utf8n_to_uvuni&#40;&#41; call. And do_encode&#40;&#41; set it to number of processed bytes.in that one do_encode&#40;&#41; call. Not to tlen - sdone.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; so pali&#39;s solution
&gt; 
&gt; &#40;tlen-sdone-slen&#41;
&gt; 
&gt; can be rewritten as
&gt; 
&gt; tlen - sdone - &#40;tlen -sdone&#41; == 0
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;18&nbsp;16:31:08&nbsp;2016</span>
    <span class="description">pali [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Now I run all unit tests in Encode plus crash test from first post and compared &#40;tlen-sdone-slen&#41; and &#40;tlen - &#40;s + slen - s0&#41;&#41; values. Values are before every utf8n_to_uvuni&#40;&#41; call exactly same.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;28&nbsp;01:23:01&nbsp;2016</span>
    <span class="description">DANKOGAI [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
