<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #18157 for CGI-Application-Plugin-AnyTemplate: CAP::AnyTemplate uses huge amounts of memory with HTML::Template::Expr</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #18157 for CGI-Application-Plugin-AnyTemplate: CAP::AnyTemplate uses huge amounts of memory with HTML::Template::Expr</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=CGI-Application-Plugin-AnyTemplate">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=CGI-Application-Plugin-AnyTemplate">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=CGI-Application-Plugin-AnyTemplate">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=CGI-Application-Plugin-AnyTemplate">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/CGI-Application-Plugin-AnyTemplate">CGI-Application-Plugin-AnyTemplate CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">18157</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=CGI-Application-Plugin-AnyTemplate">CGI-Application-Plugin-AnyTemplate</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dan.horne [...] redbone.co.nz

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-5450-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.17    </td>
  </tr>
  <tr id="CF-5451-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.18    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=18157">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-176583" href="/Public/Bug/Display.html?id=18157#txn-176583">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;13&nbsp;21:19:49&nbsp;2006</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CAP::AnyTemplate uses huge amounts of memory with HTML::Template::Expr</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/176583/60513/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/60513">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello

CGI::Application::Plugin::Anytemplate with HTML::Template::Expr uses a
heck of a lot of memory - growing to 100s MB when outputting templates
in loop. My environment:

Parse::RecDescent 1.94
HTML::Template 2.8
HTML::Template::Expr 0.06
CGI::Application::Plugin::AnyTemplate 0.17

Test case:

TestExpr.pm
===========

package  TestExpr;
use base &#39;CGI::Application&#39;;
use CGI::Application::Plugin::AnyTemplate;
use Data::Dumper;
use strict;

sub cgiapp_init {
    my $self = shift;
    $self-&gt;template-&gt;config&#40;
        default_type                =&gt; &#39;HTMLTemplateExpr&#39;,
    &#41;;
}

sub setup {
    my $self = shift;
    $self-&gt;start_mode&#40;&#39;test_case&#39;&#41;;
    $self-&gt;run_modes&#40;[&#39;test_case&#39;]&#41;;
}

sub test_publish {
    my $self = shift;
    my $template = $self-&gt;template-&gt;load&#40;file =&gt; &#39;test&#39;&#41;;
    $template-&gt;param&#40;&#39;title&#39;, &#39;This is my title&#39;&#41;;
    $template-&gt;param&#40;&#39;summary&#39;, &#39;Just some summary text&#39;&#41;;
    
    # not required, but this illustrates what I&#39;m doing ... publishing
    # to the filsystem
    open &#40;my $fh, &#39;&gt;&#39;, &#39;/tmp/output.html&#39;&#41;;
    print $fh ${$template-&gt;output};
    close $fh;    
    1;
}

sub test_case {
    my $self = shift;
    foreach my $j &#40;0..50000&#41; {
        $self-&gt;test_publish&#40;&#41;;
    }
    
    return &#39;ok&#39;;
}

1;

instance.pl - run from the command line
===========

#!/usr/local/bin/perl -w
use strict;
use CGI::Carp qw&#40;fatalsToBrowser&#41;;
use CGI::Application::Dispatch;

CGI::Application::Dispatch-&gt;dispatch&#40;
    CGIAPP_DISPATCH_DEFAULT =&gt; &#39;test_case&#39;,
    CGIAPP_DISPATCH_RM =&gt; 1,
    TABLE                   =&gt; {
        test_case        =&gt; &#39;TestExpr&#39;,
    }
&#41;;

test.html
=========

&lt;!DOCTYPE HTML PUBLIC &#34;-//W3C//DTD HTML 4.01 Transitional//EN&#34;&gt;
&lt;html lang=&#34;en&#34;&gt; 
&lt;head&gt;
    &lt;title&gt;HTML::Template::Expr Test&lt;/title&gt; 
&lt;/head&gt;
&lt;body&gt;
        Title: &lt;tmpl_var title&gt;
        Summary: &lt;tmpl_var summary&gt;
&lt;/body&gt;
&lt;/html&gt;

regards

Dan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-176588" href="/Public/Bug/Display.html?id=18157#txn-176588">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;13&nbsp;22:31:01&nbsp;2006</span>
    <span class="description">magog [...] the-wire.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #18157] CAP::AnyTemplate uses huge amounts of memory with HTML::Template::Expr</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 13 Mar 2006 22:36:13 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI-Application-Plugin-AnyTemplate [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michael Graham &lt;magog [...] the-wire.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/176588/60516/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/60516">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Hi Dan,

Thanks for the CAP::AnyTemplate request.  Just to let you know - I&#39;m not
ignoring your ticket, but I&#39;m swamped at work for the next few weeks 
and I won&#39;t have the time to investigate this very quickly.  Sorry
about that!

For my purposes, I mostly use TT and a custom driver for a legacy
templating system we use where I work.  I don&#39;t experience any crazy
memory usage &#40;that I know of&#41;.

The TT driver uses a cache so that it doesn&#39;t call Template-&gt;new all the
time.  The HT and HT::Expr drivers don&#39;t do this.  But that&#39;s because in
TT land, the workflow is:

    $tt = Template-&gt;new;
    $tt-&gt;process&#40;$file1, \%params, \$output1&#41;;
    $tt-&gt;process&#40;$file2, \%params, \$output2&#41;;
    $tt-&gt;process&#40;$file3, \%params, \$output3&#41;;

Whereas in HT land, the workflow is:

    $tmpl = HTML::Template::Expr-&gt;new&#40;filename =&gt; $file1&#41;;
    $tmpl-&gt;param&#40;%params&#41;;
    $output1 = $tmpl-&gt;output;

    $tmpl = HTML::Template::Expr-&gt;new&#40;filename =&gt; $file2&#41;;
    $tmpl-&gt;param&#40;%params&#41;;
    $output1 = $tmpl-&gt;output;

    $tmpl = HTML::Template::Expr-&gt;new&#40;filename =&gt; $file3&#41;;
    $tmpl-&gt;param&#40;%params&#41;;
    $output1 = $tmpl-&gt;output;

So CAP::AnyTemplate does indeed create a new HTML::Template::Expr object
for each filename.  Which is good and proper.  I don&#39;t believe there&#39;s
any way of avoiding this, since you can&#39;t change the filename of an
HTML::Template object after the fact.

What is probably happening is that AnyTemplate&#39;s object is failing to go
out of scope &#40;due to a circular reference somewhere&#41;, and so unused
HTML::Template parser objects are piling up in memory without being
garbage collected.

It would be interesting to see if you can reproduce the memory leak with
the TT driver.  Even if the leak is smaller, it would still shed some
light.

I will look into this when I have some time, but, as I say, it will take
me a while.  In the meantime, if you are able to make any headway,
please let me know



Michael




---
Michael Graham &lt;magog@the-wire.com&gt;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-176589" href="/Public/Bug/Display.html?id=18157#txn-176589">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;13&nbsp;22:31:05&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-176654" href="/Public/Bug/Display.html?id=18157#txn-176654">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;14&nbsp;04:55:30&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dan Horne</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/176654/60555/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/60555">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Michael,

thanks for the update. Like yourself, I&#39;m also pretty snowed under with
work for the next few weeks, so there isn&#39;t much that I am able to do
beyond trying to track down the memory leak. I have had a hunt for
circular references, but alas, nothing has jumped out at me.

I have determined that the memory usage is most prevalent in
HTML::Template::Expr as it assigns a Parse::RecDescent object to a
global variable &#40;$HTML::Template::Expr::PARSER&#41;, and this seems to take
up a lot of memory. Neither HTML::Template nor HTML::Template::Pluggable
exhibit the extremes of the memory issue, but unfortunately, I can&#39;t
seem to get them to work with all of my embedded templates &#40;thanks for
the embed feature â€“ it is used extensively&#41;

I the meantime, I seem to have a workaround â€“ I just undef
$template-&gt;{driver} in my scripts prior to $template going out of scope.
It&#39;s an ugly solution, but I&#39;m trying to avoid switching to TT as we
have too many templates to change at the moment, and I think the HTML
designers would throttle me if I introduced a new template system to them.

Anyway, once my deadlines have passed in early April, I&#39;ll have some
more time to devote to this.

Regards

Dan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-176912" href="/Public/Bug/Display.html?id=18157#txn-176912">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;14&nbsp;15:25:01&nbsp;2006</span>
    <span class="description">magog [...] the-wire.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #18157] CAP::AnyTemplate uses huge amounts of memory with HTML::Template::Expr</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 14 Mar 2006 15:30:19 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI-Application-Plugin-AnyTemplate [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michael Graham &lt;magog [...] the-wire.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/176912/60691/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/60691">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Hi Dan,

I&#39;m glad you have found a workaround - that takes some of the pressure
off for now.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; exhibit the extremes of the memory issue, but unfortunately, I can&#39;t
&gt; seem to get them to work with all of my embedded templates
</div>
Hmmm...  If this leak only manifests itself when the embed feature is
extensively used, that might point to the source of the circular
reference.  In fact, looking closer, I bet that&#39;s it.

In ComponentHandler.pm:

    sub new {
        my $proto = shift;
        my $class = ref $proto || $proto;

        my %args = @_;

        my $self = {};
        bless $self, $class;

        $self-&gt;{&#39;webapp&#39;}              = $args{&#39;webapp&#39;};
        $self-&gt;{&#39;containing_template&#39;} = $args{&#39;containing_template&#39;};

        weaken $self-&gt;{&#39;webapp&#39;};

        return $self;
    }


The $self-&gt;{&#39;webapp&#39;} reference is weakened but the
$self-&gt;{&#39;contaning_template&#39;} reference isn&#39;t.  It probably should be.
I&#39;ll have to try weakening it and seeing if all the tests still pass.



Michael


---
Michael Graham &lt;magog@the-wire.com&gt;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-176924" href="/Public/Bug/Display.html?id=18157#txn-176924">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;14&nbsp;17:11:52&nbsp;2006</span>
    <span class="description">dan.horne [...] redbone.co.nz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #18157] CAP::AnyTemplate uses huge amounts of memory with HTML::Template::Expr</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 15 Mar 2006 11:11:31 +1300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-CGI-Application-Plugin-AnyTemplate [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Dan Horne&#34; &lt;dan.horne [...] redbone.co.nz&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/176924/60697/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/60697">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 528b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Michael

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hmmm...  If this leak only manifests itself when the embed feature is
&gt; extensively used, that might point to the source of the circular
&gt; reference
</div>
Alas, the test I logged with the ticket exhibits this issue, but does not
use embed. My problem was that I couldn&#39;t switch to the HTML::Template or
HTML::Template::Pluggable drivers, as they had problems with my extensive
use of the embed functionality. I will try weakening
$self-&gt;{&#39;containing_template&#39;} however, and see what happens

Thanks for you help

Dan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-176963" href="/Public/Bug/Display.html?id=18157#txn-176963">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;14&nbsp;20:13:18&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dan Horne</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/176963/60733/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/60733">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 403b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Michael

FYI, I added 

weaken $self-&gt;{&#39;containing_template&#39;}; 

to ComponentHandler.pm as per your last note, and both the test case
without any embeds and our system with embeds seem to be working as
expected, but without consuming huge amounts of memory. There may need
to be some more through testing involved, but as far as we can tell, the
problem has disappeared with this change.

Thanks

Dan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-678725" href="/Public/Bug/Display.html?id=18157#txn-678725">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;18&nbsp;15:10:05&nbsp;2009</span>
    <span class="description">mag-perl [...] occamstoothbrush.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/678725/349293/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/349293">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 306b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Hi Dan,

This is a response to your &#40;very old&#41; ticket regarding CAP-AnyTemplate.  For 
this new release &#40;0.18&#41;, I made the recommended change to the 
ComponentHandler module.  

Hopefully this resolves the memory issues with HTML::Template::Expr.

Thank you for your report and your patience! :&#41;


Michael
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-678727" href="/Public/Bug/Display.html?id=18157#txn-678727">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;18&nbsp;15:10:09&nbsp;2009</span>
    <span class="description">mag-perl [...] occamstoothbrush.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-679223" href="/Public/Bug/Display.html?id=18157#txn-679223">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;19&nbsp;09:56:33&nbsp;2009</span>
    <span class="description">mag-perl [...] occamstoothbrush.com -  Fixed in 0.18 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.437449</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
