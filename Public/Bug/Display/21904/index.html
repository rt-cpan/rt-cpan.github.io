<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #21904 for perl-ldap: Trouble reading entrys from *.LDIF files with /n/r line endings</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #21904 for perl-ldap: Trouble reading entrys from *.LDIF files with /n/r line endings</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/perl-ldap/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/perl-ldap/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/perl-ldap/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/perl-ldap/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/perl-ldap">perl-ldap CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">21904</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/perl-ldap/Active/">perl-ldap</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jjn1056 [...] yahoo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-25226-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.33    </td>
  </tr>
  <tr id="CF-25227-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;04&nbsp;17:53:17&nbsp;2006</span>
    <span class="description">jjn1056 [...] yahoo.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Trouble reading entrys from *.LDIF files with /n/r line endings</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m not sure if this is within the specification or not but when I
export my addressbook from Mozilla Thunderbird under WindowsXP the LDIF
file it makes contains DOS style line terminators.  Several other LDIF
addressbook exporters do this as well, included the one from Yahoo
Email.  If I try to read that file using Net::LDAP::LDIF it sees
everything as one big entry, however if I convert the file to Unix style
line terminiators it goes back to working correctly.

Sorry, I&#39;m not smart enough to offer a patch, but I believe something is
up in the _read_lines subroutine for Net::LDAP::LDIF

This is an example of how I&#39;m using the code &#40;It&#39;s running under a
recent Linux and Perl 5.8.7&#41;

my $ldif = Net::LDAP::LDIF-&gt;new&#40; $fhandle &#41;;

my @contacts;

while&#40; not $ldif-&gt;eof &#41;
{
   my $entry = $ldif-&gt;read_entry;
        
   push @contacts, {
        
      email =&gt; [&#40;$entry-&gt;get_value&#40;&#39;mail&#39;&#41;&#41;],
      name  =&gt; [&#40;$entry-&gt;get_value&#40;&#39;cn&#39;&#41;&#41;],
   };
}

The variable $fhandle is a IO::File object.

In this case if the file has DOS style line terminators then @contacts
has a length of 1 no matter how many entries in the LDIF file.

I attached a test case for this.  There are three files in the test
case, two LDIF files that have 7 entries and are identical except one
uses DOS style linefeeds.  Also there is a .t test that runs against
these two files.  Right now the test fails when reading the DOS style feeds.

Sorry I tried to write a test case that would integrate with your
testing system but I&#39;m not that great at making tests.  So this is a
stand alone test.  Please let me know how I can improve this for you.

I know I can work around this by writing the file out to disk, filtering
it and then making a new IO::File handle &#40;what I&#39;m doing as a work
around now&#41; but that solution scales poorly.

Thank you.  

John Napiorkowski
jjn1056@yahoo.com
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> tests.tar.gz</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;04&nbsp;18:40:04&nbsp;2006</span>
    <span class="description">jjn1056 [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jjn1056 [...] yahoo.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">BTW,

I found a better workaround.  If you are on a modern Perl there is the
excellent module &#34;PerlIO::eol&#34; which is a IO layer to normalize line
terminators.

You can do something like:

use PerlIO::eol;

my $fh = IO::File-&gt;new&#40;&#41;;
fh-&gt;open&#40;&#34;&lt; dos_lf.ldif&#34;&#41;
binmode $fh, &#34;:raw:eol&#40;LF&#41;&#34;;    
        
my $ldif = Net::LDAP::LDIF-&gt;new&#40; $fh &#41;;

And everything just works.  I think this would work with Mac style line
terms as well.

I created a new test against the preceeding attached files that shows
this in action. It doesn&#39;t screw things up if the LF are already unix
style but fixes up any trouble with DOS style. Not sure if this will
help updating this module since PerlIO::eol only works on modern perls
and I think you might want Net::LDAP::LDIF to work on older perls as
well.  But maybe could help others running into this problem.

Thank you for making my job easier :&#41;

--John
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!perl

use strict;
use warnings;

use Test::More tests =&gt; 12;

use_ok&#40;&#39;Net::LDAP::LDIF&#39;&#41;;
use_ok&#40;&#39;IO::File&#39;&#41;;
use_ok&#40;&#39;PerlIO::eol&#39;&#41;;


CHECK_UNIX: {

	my $fh = IO::File-&gt;new&#40;&#41;;
	
	ok&#40; $fh-&gt;open&#40;&#34;&lt; unix_lf.ldif&#34;&#41;, &#34;Openning the unix test file.&#34;&#41;;

	my $ldif = Net::LDAP::LDIF-&gt;new&#40; $fh &#41;;
	
	my @contacts;
	
	while&#40; not $ldif-&gt;eof &#41;
	{
		my $entry = $ldif-&gt;read_entry;
		
		push @contacts, {
		
			email =&gt; [&#40;$entry-&gt;get_value&#40;&#39;mail&#39;&#41;&#41;],
			name  =&gt; [&#40;$entry-&gt;get_value&#40;&#39;cn&#39;&#41;&#41;],
		};
	}
	
	is&#40; $#contacts, 7, &#34;Checking to make sure we get the correct number of entries.&#34;&#41;;
	
	$fh-&gt;close;
}

CHECK_UNIX_WITH_CONVERT: {

	my $fh = IO::File-&gt;new&#40;&#41;;
	
	ok&#40; $fh-&gt;open&#40;&#34;&lt; unix_lf.ldif&#34;&#41;, &#34;Openning the unix test file.&#34;&#41;;
	
	binmode $fh, &#34;:raw:eol&#40;LF&#41;&#34;;
	
	my $ldif = Net::LDAP::LDIF-&gt;new&#40; $fh &#41;;
	
	my @contacts;
	
	while&#40; not $ldif-&gt;eof &#41;
	{
		my $entry = $ldif-&gt;read_entry;
		
		push @contacts, {
		
			email =&gt; [&#40;$entry-&gt;get_value&#40;&#39;mail&#39;&#41;&#41;],
			name  =&gt; [&#40;$entry-&gt;get_value&#40;&#39;cn&#39;&#41;&#41;],
		};
	}
	
	is&#40; $#contacts, 7, &#34;Checking to make sure we get the correct number of entries.&#34;&#41;;
	
	$fh-&gt;close;
}

CHECK_DOS_WITH_CONVERT: {

	my $fh = IO::File-&gt;new&#40;&#41;;
	
	ok&#40; $fh-&gt;open&#40;&#34;&lt; dos_lf.ldif&#34;&#41;, &#34;Openning the unix test file with the eol&#40;LF&#41; converted.&#34;&#41;;
	
	binmode $fh, &#34;:raw:eol&#40;LF&#41;&#34;;	
	
	my $ldif = Net::LDAP::LDIF-&gt;new&#40; $fh &#41;;
	
	my @contacts;
	
	while&#40; not $ldif-&gt;eof &#41;
	{
		my $entry = $ldif-&gt;read_entry;
		
		push @contacts, {
		
			email =&gt; [&#40;$entry-&gt;get_value&#40;&#39;mail&#39;&#41;&#41;],
			name  =&gt; [&#40;$entry-&gt;get_value&#40;&#39;cn&#39;&#41;&#41;],
		};
	}
	
	is&#40; $#contacts, 7, &#34;Checking to make sure we get the correct number of entries&#34;&#41;;
}


CHECK_DOS: {

	my $fh = IO::File-&gt;new&#40;&#41;;
	
	ok&#40; $fh-&gt;open&#40;&#34;&lt; dos_lf.ldif&#34;&#41;, &#34;Openning the dos test file, no preconversion attempted.&#34;&#41;;
	
	my $ldif = Net::LDAP::LDIF-&gt;new&#40; $fh &#41;;
	
	my @contacts;
	
	while&#40; not $ldif-&gt;eof &#41;
	{
		my $entry = $ldif-&gt;read_entry;
		
		push @contacts, {
		
			email =&gt; [&#40;$entry-&gt;get_value&#40;&#39;mail&#39;&#41;&#41;],
			name  =&gt; [&#40;$entry-&gt;get_value&#40;&#39;cn&#39;&#41;&#41;],
		};
	}
	
	is&#40; $#contacts, 7, &#34;Checking to make sure we get the correct number of entries&#34;&#41;;
	
	$fh-&gt;close;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;04&nbsp;23:56:58&nbsp;2006</span>
    <span class="description">gbarr [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #21904] Trouble reading entrys from *.LDIF files with /n/r line endings </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 4 Oct 2006 22:56:43 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-perl-ldap [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Graham Barr &lt;gbarr [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the workaround.

I do not want to put this dependancy in the module, but it is good to  
know. The LDIF parser needs to be re-written to not be dependent on  
local line endings but until it is done, we now have a workaround to  
tell others,

Thanks,
Graham.

On Oct 4, 2006, at 5:40 PM, jjn1056@yahoo.com via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I found a better workaround.  If you are on a modern Perl there is the
&gt; excellent module &#34;PerlIO::eol&#34; which is a IO layer to normalize line
&gt; terminators.
&gt;
&gt; You can do something like:
&gt;
&gt; use PerlIO::eol;
&gt;
&gt; my $fh = IO::File-&gt;new&#40;&#41;;
&gt; fh-&gt;open&#40;&#34;&lt; dos_lf.ldif&#34;&#41;
&gt; binmode $fh, &#34;:raw:eol&#40;LF&#41;&#34;;  
&gt;       
&gt; my $ldif = Net::LDAP::LDIF-&gt;new&#40; $fh &#41;;
&gt;
&gt; And everything just works.  I think this would work with Mac style  
&gt; line
&gt; terms as well.
&gt;
&gt; I created a new test against the preceeding attached files that shows
&gt; this in action. It doesn&#39;t screw things up if the LF are already unix
&gt; style but fixes up any trouble with DOS style. Not sure if this will
&gt; help updating this module since PerlIO::eol only works on modern perls
&gt; and I think you might want Net::LDAP::LDIF to work on older perls as
&gt; well.  But maybe could help others running into this problem.
&gt;
&gt; Thank you for making my job easier :&#41;
&gt;
&gt; --John
&gt;
&gt;
&gt; &lt;dos_line_terms.t&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;04&nbsp;23:56:59&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;11&nbsp;21:44:05&nbsp;2010</span>
    <span class="description">GBARR [...] CPAN.ORG -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
