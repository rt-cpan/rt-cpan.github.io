<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #70659 for Test-Harness: prove -b is iniconsistent with perl -Mblib</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #70659 for Test-Harness: prove -b is iniconsistent with perl -Mblib</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Test-Harness/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Test-Harness/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Test-Harness/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Test-Harness/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Test-Harness">Test-Harness CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">70659</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Test-Harness/Active/">Test-Harness</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ZEEK [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-31430-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
3.17    </td>
  </tr>
  <tr id="CF-31431-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;31&nbsp;21:14:29&nbsp;2011</span>
    <span class="description">ZEEK [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> prove -b is iniconsistent with perl -Mblib</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">When running `prove -b ...` blib dirs are not added @INC the way they
are in the blib.pm module.  The blib.pm module &#34;searches&#34; for the blib
in up to 5 parent directories.  This is handy when blib/ and t/ are not
in the same directory.

I tried to workaround this using `prove -Mblib ...` but it appears that
the changes blib.pm makes to @INC are not propagated across the fork&#40;&#41;
that prove does.


App::Prove.pm:
530   if &#40; $self-&gt;blib &#41; {
531        push @libs, &#39;blib/lib&#39;, &#39;blib/arch&#39;;
532   }

blib.pm:
70  my $i = 5;
71  my&#40;$blib, $blib_lib, $blib_arch&#41;;
72  while &#40;$i--&#41;
73   {
74    $blib = File::Spec-&gt;catdir&#40;$dir, &#34;blib&#34;&#41;;
75    $blib_lib = File::Spec-&gt;catdir&#40;$blib, &#34;lib&#34;&#41;;
76 
77    if &#40;$^O eq &#39;MacOS&#39;&#41;
78     {
79      $blib_arch = File::Spec-&gt;catdir&#40;$blib_lib, $MacPerl::Architecture&#41;;
80     }
81    else
82     {
83      $blib_arch = File::Spec-&gt;catdir&#40;$blib, &#34;arch&#34;&#41;;
84     }
85 
86    if &#40;-d $blib &#38;&#38; -d $blib_arch &#38;&#38; -d $blib_lib&#41;
87     {
88      unshift&#40;@INC,$blib_arch,$blib_lib&#41;;
89      warn &#34;Using $blib\n&#34; if $Verbose;
90      return;
91     }
92    $dir = File::Spec-&gt;catdir&#40;$dir, File::Spec-&gt;updir&#41;;
93   }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;01&nbsp;12:40:22&nbsp;2011</span>
    <span class="description">ZEEK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I made an attempt to fix by patching the logic from blib.pm into
Prove.pm.  Note this patch also changes the ordering of &#34;blib/arch
blib/lib&#34; to be consistent with the normal Perl search order.

This fixes my use case, I would appreciate any comments on problems this
may have.

--- App/Prove.pm~       2011-09-01 09:21:04.959380204 -0700
+++ App/Prove.pm        2011-09-01 09:28:57.519380050 -0700
@@ -527,7 +527,26 @@
         push @libs, &#39;lib&#39;;
     }
     if &#40; $self-&gt;blib &#41; {
-        push @libs, &#39;blib/lib&#39;, &#39;blib/arch&#39;;
+       my $i = 5;
+       my&#40;$blib, $blib_lib, $blib_arch&#41;;
+       my $dir = File::Spec-&gt;rel2abs&#40;&#34;.&#34;&#41;;
+       while &#40;$i--&#41; {
+           $blib = File::Spec-&gt;catdir&#40;$dir, &#34;blib&#34;&#41;;
+           $blib_lib = File::Spec-&gt;catdir&#40;$blib, &#34;lib&#34;&#41;;
+
+           if &#40;$^O eq &#39;MacOS&#39;&#41; {
+               $blib_arch = File::Spec-&gt;catdir&#40;$blib_lib,
$MacPerl::Architecture&#41;;
+           }
+           else {
+               $blib_arch = File::Spec-&gt;catdir&#40;$blib, &#34;arch&#34;&#41;;
+           }
+
+           if &#40;-d $blib &#38;&#38; -d $blib_arch &#38;&#38; -d $blib_lib&#41; {
+               push @libs, $blib_arch, $blib_lib;
+               last;
+           }
+           $dir = File::Spec-&gt;catdir&#40;$dir, File::Spec-&gt;updir&#41;;
+       }
     }
     if &#40; @{ $self-&gt;includes } &#41; {
         push @libs, @{ $self-&gt;includes };
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;01&nbsp;12:40:23&nbsp;2011</span>
    <span class="description">ZEEK [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;01&nbsp;12:42:01&nbsp;2011</span>
    <span class="description">ZEEK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Opps, didn&#39;t mean to change the status to Open.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;01&nbsp;12:42:01&nbsp;2011</span>
    <span class="description">ZEEK [...] cpan.org -  Status changed from &#39;open&#39; to &#39;new&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;21&nbsp;17:20:59&nbsp;2011</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Sep 01 12:42:01 2011, ZEEK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Opps, didn&#39;t mean to change the status to Open.
</div>
Don&#39;t worry, it just happens.

There&#39;s two issues here.  One is scanning parent directories for blib. 
The other is the order in which blib/lib and blib/arch get added.

prove -b doesn&#39;t try to emulate the behavior of blib.pm.  The docs are
pretty clear that it &#34;adds &#39;blib/lib&#39; and &#39;blib/arch&#39; to the path for
your tests&#34;.  So before we change the behavior we should talk about the
behavior.  I hold that tests running predictably is important.  If prove
gropes its way up the filesystem it could encounter an unrelated blib
and use that with no indication to the user what went wrong.

The minor and uncommon inconvenience of blib being in another directory
can be eliminated with as little as a symlink.

To the second problem... the order of blib/lib and blib/arch is correct
in that it matches what ExtUtils::MakeMaker and Module::Build do when
they run the tests.  It is incorrect in that it is opposite what perl
does.  It&#39;s interesting that it hasn&#39;t really bitten anyone, it should
probably match what perl does.  I don&#39;t think it&#39;s actually
consequential, and if it is changed that should be coordinated. 
Meanwhile, prove should follow what &#34;make test&#34; and &#34;build test&#34; do in
order to prevent adding mysterious bugs.

I&#39;d talk about it with the Module::Build folks, see what they want to do.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;21&nbsp;17:21:01&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
