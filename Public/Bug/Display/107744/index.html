<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #107744 for Net-HTTP: Net::HTTP::NB bug with chunked responses when there is a delay around the chunk header</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #107744 for Net-HTTP: Net::HTTP::NB bug with chunked responses when there is a delay around the chunk header</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-HTTP/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-HTTP/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-HTTP/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-HTTP/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-HTTP">Net-HTTP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">107744</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-HTTP/Active/">Net-HTTP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
rogerluc [...] cisco.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
oleg [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-237444-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-237445-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;13&nbsp;03:51:31&nbsp;2015</span>
    <span class="description">rogerluc [...] cisco.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net::HTTP::NB bug with chunked responses when there is a delay around the chunk header</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 13 Oct 2015 07:50:53 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Net-HTTP [...] rt.cpan.org&#34; &lt;bug-Net-HTTP [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Roger Lucas &#40;rogerluc&#41;&#34; &lt;rogerluc [...] cisco.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Net::HTTP::NB v6.09
Net::HTTP::Methods v6.09
OS: RedHat 6.7 on x86_64

Dear Net::HTTP developers,

I have discovered a bug in Net::HTTP::NB if the server it connects to responds with chunked data and the client cannot read the chunk length field *and* at least 1 byte of the data in a single call to read_entity_body&#40;&#41;.

The details of the bug are as follows:

When Net::HTTP::NB::read_entity_body&#40;&#41; calls Net::HTTP::Methods::read_entity_body&#40;&#41; for the first time, the Transfer-Encoding headers are inspected.  If chunked mode is to be used, the chunk length is read &#40;line 534&#41; and the data is read &#40;line 571&#41;.  This all works fine if the data buffer has sufficient data already within it for both reads.  If there is insufficient data to complete either or both reads then a second call is made to Net::HTTP::NB::sysread&#40;&#41; and this causes the &#34;Multi-Read&#34; die&#40;&#41; on line 16 after restoring the original data buffer from &#34;httpnb_save&#34;.

When Net::HTTP::NB::read_entity_body&#40;&#41; is retried, the call to Net::HTTP::Methods::read_entity_body&#40;&#41; skips the header inspection because &#34;http_first_body&#34; was reset to zero on the first attempt.  This means that it assumes that the data is not chunked and just reads all the data as the content, ignoring any chunked encoding.

I believe that the solution is to preserve and restore &#34;http_first_body&#34; and &#34;http_request_method&#34; around the &#34;eval { }&#34; block in Net::HTTP::NB::read_entity_body&#40;&#41; so that subsequent retry attempts to Net::HTTP::Methods::read_entity_body&#40;&#41; correctly restore its state if an error occurs.

I have attached two test utilities that trigger the bug and validate the patch.

The first, test-http-server.pl, is a small web server that can chunk its response into configurable sizes and can also flush and pause its output at configurable data positions.  This is used to cause specific jitter patterns in the web server response so that we can reliably exercise the various paths through the client.

The second, test-http-async-2.pl, is a small client using HTTP::Async that performs a set of tests against the web server with different chunked/non-chunked encodings and with different delay patterns.  The client knows what web response to expect so it uses a SHA-1 digest to validate the response.

I have also attached a patch for Net::HTTP::NB which causes all tests to pass on my machine.

I apologise for renaming all files with a .txt extension but our email uses Microsoft Outlook and this often blocks extensions that it doesn&#39;t think are safe.  Renaming files to .txt means that they always get through.

As an FYI, this bug was original spotted with Net::HTTPS::NB when working with an HTTPS connection.  That part of the code in Net::HTTPS::NB was copied from Net::HTTP::NB and the investigation continued to find the root cause as described above.  I&#39;ll be offering an similar patch to the Net::HTTPS::NB developers.

Best regards, 

Roger Lucas
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;13&nbsp;07:32:24&nbsp;2015</span>
    <span class="description">oleg [...] cpan.org -  Cc OLEG added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;14&nbsp;01:10:10&nbsp;2015</span>
    <span class="description">oleg [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Oct 13 03:51:31 2015, rogerluc@cisco.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Net::HTTP::NB v6.09
&gt; Net::HTTP::Methods v6.09
&gt; OS: RedHat 6.7 on x86_64
&gt; 
&gt; Dear Net::HTTP developers,
&gt; 
&gt; I have discovered a bug in Net::HTTP::NB if the server it connects to
&gt; responds with chunked data and the client cannot read the chunk length
&gt; field *and* at least 1 byte of the data in a single call to
&gt; read_entity_body&#40;&#41;.
&gt; 
&gt; The details of the bug are as follows:
&gt; 
&gt; When Net::HTTP::NB::read_entity_body&#40;&#41; calls
&gt; Net::HTTP::Methods::read_entity_body&#40;&#41; for the first time, the
&gt; Transfer-Encoding headers are inspected.  If chunked mode is to be
&gt; used, the chunk length is read &#40;line 534&#41; and the data is read &#40;line
&gt; 571&#41;.  This all works fine if the data buffer has sufficient data
&gt; already within it for both reads.  If there is insufficient data to
&gt; complete either or both reads then a second call is made to
&gt; Net::HTTP::NB::sysread&#40;&#41; and this causes the &#34;Multi-Read&#34; die&#40;&#41; on
&gt; line 16 after restoring the original data buffer from &#34;httpnb_save&#34;.
&gt; 
&gt; When Net::HTTP::NB::read_entity_body&#40;&#41; is retried, the call to
&gt; Net::HTTP::Methods::read_entity_body&#40;&#41; skips the header inspection
&gt; because &#34;http_first_body&#34; was reset to zero on the first attempt.
&gt; This means that it assumes that the data is not chunked and just reads
&gt; all the data as the content, ignoring any chunked encoding.
&gt; 
&gt; I believe that the solution is to preserve and restore
&gt; &#34;http_first_body&#34; and &#34;http_request_method&#34; around the &#34;eval { }&#34;
&gt; block in Net::HTTP::NB::read_entity_body&#40;&#41; so that subsequent retry
&gt; attempts to Net::HTTP::Methods::read_entity_body&#40;&#41; correctly restore
&gt; its state if an error occurs.
&gt; 
&gt; I have attached two test utilities that trigger the bug and validate
&gt; the patch.
&gt; 
&gt; The first, test-http-server.pl, is a small web server that can chunk
&gt; its response into configurable sizes and can also flush and pause its
&gt; output at configurable data positions.  This is used to cause specific
&gt; jitter patterns in the web server response so that we can reliably
&gt; exercise the various paths through the client.
&gt; 
&gt; The second, test-http-async-2.pl, is a small client using HTTP::Async
&gt; that performs a set of tests against the web server with different
&gt; chunked/non-chunked encodings and with different delay patterns.  The
&gt; client knows what web response to expect so it uses a SHA-1 digest to
&gt; validate the response.
&gt; 
&gt; I have also attached a patch for Net::HTTP::NB which causes all tests
&gt; to pass on my machine.
&gt; 
&gt; I apologise for renaming all files with a .txt extension but our email
&gt; uses Microsoft Outlook and this often blocks extensions that it
&gt; doesn&#39;t think are safe.  Renaming files to .txt means that they always
&gt; get through.
&gt; 
&gt; As an FYI, this bug was original spotted with Net::HTTPS::NB when
&gt; working with an HTTPS connection.  That part of the code in
&gt; Net::HTTPS::NB was copied from Net::HTTP::NB and the investigation
&gt; continued to find the root cause as described above.  I&#39;ll be offering
&gt; an similar patch to the Net::HTTPS::NB developers.
&gt; 
&gt; Best regards,
&gt; 
&gt; Roger Lucas
</div>
With Roger we found that his patch doesn&#39;t cover all cases. This test server and client demonstrates problem: <span class="clickylink"><a target="new" rel="nofollow" href="https://gist.github.com/olegwtf/c4dc83711c03a66ba07a">https://gist.github.com/olegwtf/c4dc83711c03a66ba07a</a></span>
So, I reworked his patch a little and now it seems it looks good for both of us.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net-HTTP-NB.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- NB.pm.orig	2015-10-13 23:47:37.624399544 +0600
+++ NB.pm	2015-10-13 23:43:58.775329636 +0600
@@ -42,12 +42,25 @@
     my $self = shift;
     ${*$self}{&#39;httpnb_read_count&#39;} = 0;
     ${*$self}{&#39;httpnb_save&#39;} = ${*$self}{&#39;http_buf&#39;};
+    
+    my $chunked = ${*$self}{&#39;http_chunked&#39;};
+    my $bytes   = ${*$self}{&#39;http_bytes&#39;};
+    my $first_body = ${*$self}{&#39;http_first_body&#39;};
+    my @request_methods = @{${*$self}{&#39;http_request_method&#39;}}; 
+    
     # XXX I&#39;m not so sure this does the correct thing in case of
     # transfer-encoding transforms
     my $n = eval { $self-&gt;SUPER::read_entity_body&#40;@_&#41;; };
     if &#40;$@&#41; {
-	$_[0] = &#34;&#34;;
-	return -1;
+        if &#40;$@ eq &#34;Multi-read\n&#34;&#41; {
+            # Reset some internals of Net::HTTP::Methods
+            ${*$self}{&#39;http_chunked&#39;} = $chunked;
+            ${*$self}{&#39;http_bytes&#39;} = $bytes;
+            ${*$self}{&#39;http_first_body&#39;} = $first_body;
+            ${*$self}{&#39;http_request_method&#39;} = \@request_methods;
+        }
+        $_[0] = &#34;&#34;;
+        return -1;
     }
     return $n;
 }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;14&nbsp;01:10:11&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;16&nbsp;15:20:42&nbsp;2019</span>
    <span class="description">olaf [...] wundersolutions.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ticket migrated to github as <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/libwww-perl/Net-HTTP/issues/63">https://github.com/libwww-perl/Net-HTTP/issues/63</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;16&nbsp;15:20:43&nbsp;2019</span>
    <span class="description">olaf [...] wundersolutions.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
